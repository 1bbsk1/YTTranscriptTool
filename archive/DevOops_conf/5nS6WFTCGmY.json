{
  "video_id": "5nS6WFTCGmY",
  "channel": "DevOops_conf",
  "title": "",
  "views": 0,
  "duration": 0,
  "published": "",
  "text": "привет всем меня зовут игнат и сегодня мы поговорим о том как строить песочницей на операционных системах linux и обезопасить свой код не добавляя и никакого исходного кода ваши продолжаю немного о себе я занимаюсь производительности безопасностью системы wilfer я также люблю криптографию и низ коварные программирование люблю ковыряться и одре загрузчика любом низкоуровневым секо не может и немножко сендер и так при чем мы начнем я просто хочу сказать что это сессия записано заранее потому что мне не очень хороший интернет дома поэтому livestream бы не получился но я должен быть сейчас онлайн и готов ответить на все ваши вопросы которые у вас возникают или походы этой презентации или может быть конце если вдруг по каким-либо причинам вы не сможете со мной связаться во время этой презентации на каждом слайде внизу правом углу есть мой twitter handle поэтому можете потом связаться со мной через twitter и я буду рад ответить на все ваши вопросы которые воссоздать и так вперед основной темой сегодняшнего доклада будет песочнице операционной системе linux и основной инструмент разработки таких песочниц это so come поэтому мы в основном будем говорить про linux таком технологию но чтобы понять что такое соком давайте просто изначально досмотрим а что же такое вообще системные вызовы и операционной системы и потом частности как он как они связаны современном мире мы не запускаем наше приложение непосредственно на каком-либо железе да то есть теперь мы используем операционной системы linux мин давался и макрос это самые популярные из них то есть на непосредственно железе мы допускаем некую придуманную систему а уже только потом на этой операционной системе мы запускаем свои предложения на и причем ни одно этих приложений может быть несколько все современные операционные системы многозадачны что же такое системные вызовы то есть допустим у вас есть какое-то приложение и она работает на какой-то операционной системе опять же если мы помним что приложение не имеют прямого ду модель операционных систем приложения не имеет прямого доступа к непосредственно к аппаратному обеспечению и но иногда им нужно допустим каким-то образом выполнить какую-то задачу связано с аппаратном обеспечении допустим записать какие-то данные на диске ли отправить данные пасеки поэтому предложение будет обращаться к ядру операционной системой и просить его сделать это место самого приложения что же такое системные вызовы это просто некий интерфейс который представляет ядро операционной системой чтобы с ним могли через него приложение могли делать те или иные задачи на то есть приложение использует этот интерфейс чтобы просить ядро делать те или иные функции которые необходимо потому что они не имеют на крыму доступ к аппаратном обеспечении то есть этот системный вызова это просто абстрактная высоко уровне интерфейс между предложениями ядром операционной системы он еще хорош тем что в этой модели ядро предоставляет некой высоко уровня интерфейс который не зависит от непосредственно аппаратном обеспечении которые установлены в данной конкретной системе то есть нашим приложением принципе не важно знать когда они записывают файл будем записывать мы фауна магнитный носитель или твердотельный носитель вообще в оперативную память то есть и просто у них есть некий сервис операционной системе запись файлов они иногда обращаются инфляционных стена знают его как непосредственно работать с конкретным обратным из печенье то есть он систему вызова ядра операционной системе представляет некие такие базовые об уровне и сервисы как запись и чтение файлов доступ по сети дополнительный вроде как время звуки и так далее также в модель операционной системы и ядро операционной системы может реализовывать некий политики безопасности то есть ядро операционной системы также может давать приложениями уровней доступа кому-то запрещать или разрешать где делать что-то и сортировать приложение к уровня доступа и так далее но и также ядро операционной системы занимается распределением ресурсов что из за того что у нас приложение теперь много у нас мультизадачность то есть ядро должно обеспечить что когда-то даже не и получает необходимо рисую чтобы оно могло выполняться то есть системные вызовы это просто интерфейс ядра операционной системой для пользовательских и ларьку что же такое всяком таком на линуксе это просто один из системах вызова в linux но он немного особенный so come un особенно тем чтобы с помощью этого системного вызова он позволяет приложение видами ядро какие другие системные вызовы данное приложение собирается использовать будущее и может быть какие приложения точной использовать не будет после этого ядро имеет право так обеспечить политику безопасности предоставлены самим приложением то есть приложение говорит какие системные вызовы она собирается использовать ядро может это обещание посреди чтобы это обещание было выполнено в итоге и в итоге что такое закон это инструмент которые могут использоваться продолжение на построение песочниц самих для себя или так сказать будет самоизоляция это очень популярная из-за современные пандемии то есть предложение с помощью so come могут сама изолироваться и и быть более безопасны и сколько там дед на практике опять же у нас есть приложение виду открытом системы и системные вызовы то есть как вам под еще один системный вызов ну что он позволяет делать он позволяет составить некий договор между бедром и приложения и приложения просто обещает кедру использовать только какую-то часть системных вызовов и может быть обещает не использовать какие то другие системные вы тоже будет если приложение нарушит договор ну тогда не ядро может применить санкции и скорее всего немедленно прекратить выполнение данного приложения вопрос тогда следующий а зачем тогда приложению составлять этот договор потому что ну допустим если не использовать этот системный за косяком и не обещайте и другие чего-то в принципе приложение может быть использовать нему и системные вызовы без всяких либо последствий другой стороны если приложение составит этот договор синдром и потом случайно его нарушен то ядро не применит санкции что затем вообще-то да это все нужно и ответ это то что он заключается в том что для обычного нормального приложения смысл конечно не но это поход оказывается очень эффективной для защиты от уязвимости к выполнению произвольного кода давайте рассмотрим пример допустим из разработчик приложений решили написать самое простое приложение часы его на все так мы рассматриваем c комп si completo функция системы linux поэтому вы написали решили написать программу часы для linux что в принципе нужно часа какие данные нужно через часами программе часам нужно просто знать текущее время до поэтому если вы решили каким-то образом самое изолировать ваше приложение вы можете составить с помощью соком составить этот договор между бедром и у видами кедра что и я просто приложение часы и все что мне надо для моего нормального санкционированных изначальная поэтому вы можете пообещать ядру использовать только один системный вызов где time after ну и скажем так ваше предложение продолжает выполняться и в какой то момент времени вашего приложения нужно время поэтому она делает систему в итоге time потому что это системный вызов был частью контракта частью вашего договора и дров принципе разрешает этот системный вызов и возвращает вам текущее время марки не предоставите у пользователей и так далее но допустим вы написали ваше приложение часы на низкоуровневым а сам билли и компании безопасно msi языке и к книге злоумышленник смог найти уязвимость вашим корм и он смог найти уязвимости и снова получить произвольное выполнение кода вашем приложении что ты злоумышленник в это скорее всего сделает помошник возможно попробую использовать этот код вашу программу чтобы у красники важные данные важную информацию с вашего с вашей системы и пароли и так далее ну и скорее всего замуж ней находиться удаленно то есть что он сделает он попросит вашу программу отправить украденные данные ему постите то есть он чтобы отправить данные по сети ваша программа должна делать сделать из анд системный вызов и то есть она сделает сам системный вызов гидру операционной системы но здесь операционная система увидит что цент системный вызов sand не был частью заранее оговоренного контракта и поэтому примет санкции и немедленно прекратить выполнение all продажами то есть с помощью такой простой схемы мы не только предотвратили утечку информации а и вообще исключили нашего злоумышленника из нашей системы потому что код которым он управлял нужен более не выполняется вот и все давайте посмотрим как же использоваться к на примерах кода то есть давайте напишем простую маленькую программку простую ти летку если вы работаете с unix операционных систем и вы наверное слышали про командой гюнеем которая просто выводит информацию о текущей операционной системе то есть мы напишем похоже утилитку только немного упрощённая эта утилитка использует системный вызов с кем же именем бью на инсту получить эту информацию к рациона и система и выводит текущую порционную систему пользования берем эту это предложение допустимую мы увидим что мы наше приложение исполняется на ленте что хорошо потому что мы теперь можем экспериментировать со компот ужаса комната функция только протон на steam или давайте посмотрим как это приложение можно обезопасить и добавив поддержку секунд так называемая самоизоляции наше приложение то есть перед основной логикой мы просто добавим одну функцию и реализуемые вот примерно как будет выглядеть функции немного страшно я согласен но тут в принципе важная деталь это наша политика самоизоляция да то есть она тоже большая и не очень понятная на все что нужно сейчас здесь понять это наш целях наглядности мы определим такую политику себе что мы разрешим нашему приложению использовать любые системные вызовы кроме одного и то есть если наше приложение будет использовать системный вызов вины мы просим бедро не разрешать этот системный вызов и вместо этого вернуть и код ошибки и не отдам нашему приложению конечно в реальном мире такая политика имеет смысла потому что мы знаем что нашему приложению нужно использовать иные места палату зачем нам его запрещать но в целях посмотреть как это все работает то есть мы делаем такую неправильную политику лесового коллажи первая часть нашей функции вторая часть нашей функции это в принципе просто передать данную политику у ядру и с этого момента если этот с помощью системного вызова cq и с этого момента если это груза завершится успешно то наша полиция ядро будет обеспечивать нашу политику которую мы запросили у него для всего последующего кода который будет исполняться в этом процессе давайте перес берем наше приложение с новым кодом и попробуем его запустить и теперь мы видим что наше предложение вернула нам сообщить сообщалось что системными замены совершился неудачные вернула нам код ошибки на творческом то есть возвращаясь к нашему исходному коду мы с помощью нашей политики безопасности мы заставили предложение пойти вот вот этой ветке то есть обработать код ошибки и вернуть код ошибки пользователям что мы тут знаем что you name завершился с ошибкой не потому что что то не так пошло в ведре а именно потому что из-за наших плитки безопасности потому что если вы посмотрите документацию на системной мы за гиней принципе you name не может вернуть код ошибки сет недоступны потому что в принципе чтобы прочитать какие-то данные слова с вашего локального ядра операционной системы вам сети но но мы описали такую политику таком и мы точно знаем что код ошибки мы получили из-за нашей политики со ком мы получил такой непонятный код ошибки который в принципе мы получить не должна плюс мы так же знаем что другие системные вызовы разрешены потому что даже чтобы вывести код ошибки пользователю на экран вам единый файл вот эта функция его она тоже должна использовать некий системный вызов это системный вызов white и так как мы видим код ошибки от нашего приложения мы знаем что как минимум light системный вызов он aggression вот так now- как вы уже наверное видели предыдущего примера есть недостатки да то есть вот это правило я тайком была политика с и ком она пишется на низко уровнем языке программирования бпф который очень принципе похож на ассемблер и изначально использовался для сетевых фаерболов но писать правилам к музыке вручную достаточно сложный и писать из сложно отлаживать их сложно потом обновлять если там логика вашего приложения меняется и вы даже видели что листинг для нашего простого примера был достаточно большое представьте крик как как акт листинг будет выглядеть для какого-нибудь cemera реального приложения и также нам нужно чтобы использовать о ком нам нужно знать другие низком уровне детали например порядковый номер системных вызовов потому что ядро понимает системной вызове не по именам а по порядковым номерам что понимать порядковые номера нам также надо учитывать архитектуру на которой мы исполняется наше продвижение потому что одни и те же системные вызовы на разных архитектурах имеют разные порядковые номера ну и и всякие дополнительные нюансы которые описаны на моей странице системного голоса к сейчас тут когда есть что-то низкого уровня и сложная чтобы сделать это легче как правило кто-то берется и пишет более высокую для тегу который абстрагируется все вот эти страшные детали дает нам более удобный интерфейс и частью такая политика есть и мясо компа называется не пса ком и они кстати даже рекомендовано на мой странице системного вызова cq рекомендую использовать эту библиотеку не писать правило вручную поэтому давайте посмотрим как мы можем переписать нашу функцию самоизоляции с ручного страшного бпв кода на с помощью ты более высоком уровне библиотеки тут код практически та же политика выглядит намного проще мы можем заметить от весь страшный dpf код просто двумя строчками это первая строчка мы определяем и действия по умолчанию то есть здесь мы говорим что по умолчанию мы на нашему приложению мы разрешаем делать любые системные выборах ну и добавляем наше конкретное правило то есть по умолчанию любой системы вызове но конкретно для системного вызова гюнея мы просим ведро немедленно прекратить выполнение нашего приложения и не разрешать этот систем нравится причем обратите внимание что здесь нет нам теперь не надо заботиться о порядковых номерах системные вызовы мы можем указывать системные вызовы по их именам и библиотека их переведет в крайней порядке виноград для нас также стоит отметить что мы здесь немножко поменяли политику в нашем первом примере мы просили ядро не прекращать выполнение нашего приложения немедленно просто возвращать код ошибки это более удобно но другой стороны потому что мы видели код ошибки на это не свойственно менее безопасно потому что представьте что если ваше приложение уже скомпрометирована мы даже возвращай код ошибки но не прекращай выполнение приложением прием возможность злоумышленникам попробовать какую нибудь другой способ и как-нибудь отправителями или отправить данные или атаковать на 6-м каким-либо другим образом более безопасный вариант который мы используем здесь если приложения нарушает ранее установленные правила нарушают наш контракту мы просим ядро немедленно прекратить выполнение этого приложения ну и опять же мы передаем нашу желаемую политику ведро и после этого него начинает обеспечить эту политику на нас давайте посмотрим как это работает давайте пересоберём опять наше приложение пользуя библиотеку и нашу новую политику и причем так как мы используем для те q нам нужно не забыть сильно кого-то с этой библиотекой когда насобираем продолжение и когда мы запустим увидим вот это причем интересно заметить что в отличие от предыдущего примера мы больше уже не виден код ошибки а вот нашего приложения потому что наше приложение просто не успела его вывести предыдущем примере я хочу напомнить что мы просто вернули код ошибки продолжению предложения просто илоном сумел напечатать здесь мы попросили ядро немедленно прекратить выполнение приложения то есть как только наше приложение у пыталась вызвать системным whether you name она была немедленно прекращено и никакого вывода вот это сообщение бойцы с ним кол это вообще мы будет это наш наш наша командная строка потому что она заметила что исполняемое приложение было прекращено будущее ядра операционной системы но опять же у предыдущих двух примеров есть некие недостатки и главный недостаток заключается в том что чтобы добавить поддержку самоизоляции или добавить поддержку песочнице наше продолжение нам в обоих случаях приходилось менять исходный код предложения то есть нам непосредственно приходилось ходить песочницу в нашем приложении здесь напрашивается вопрос то есть представьте себя разработчикам программного продукта у вас есть какие-то задачи и сроки его запускаете это как много разработчиков начинают новый продукт со следующей мысли что скорее всего в моем коде будут ошибки и уязвимости поэтому первую очередь что я должен подумать это каким образом я добавлю поддержку самоизоляции песочница в свой вклад сколько таких разработчиков вы знаете подумали бы так конечно мало и здесь сразу видно проблем с закон то есть сам системный сами правила секунд они имеют эффект только на вызывающим процессе и всех его последователей то есть сама модель соком подразумевает то что разработчики будут добавлять поддержку в самоизоляции в свой код на этапе разработки проекта и не существует никакого внешнего интерфейса с помощью которого можно опосля вставить эти правила стэком блуза существующий код другой стороны у нас есть операторы или сисадмины или с арией у которых нет практически никакого контроля над политикой секунд но в тоже время они отвечают за код которые написаны и разработчики ранее которые хочется продакшен не конечно им бы хотелось чтобы этот код бы более безопасно на не еще есть третий вариант что не весь к одному пишем даже сами то есть и есть очень много вариант когда мы покупаем уже готовые программные решения где-то у сторонних разработчиков и как правило имеют доступ к исходному коду и нам бы конечно тоже бы хотелось добавить поддержку изолят изолировать этот код каким-то образом и добавить туда поддержку правило всяком у нас нету дыма знать есть здесь мы видим есть несостыковка ожидания с одной стороны у нас есть разработчики кода которые могут и должны были бы добавить поддержку изоляции в свой код но у них они не очень заинтересованы кому то есть у них это не на первом приоритете как правило потому что на 1 5 тыс это какой-то функционал и и так далее это всегда фаза откладывается на потом то вообще пронизывается то есть немного реальных приложений для же о комфортно которые из коробки вам позволяет добавлять какие-то правила сетку свой процесс другой сторон у нас есть операторы кода операторы сисадмины и сырые которые отвечают за коды production а и они очень заинтересованы чтобы этот код был безопасной но у них нет никаких возможностей инструментом добавить поддержку с соком существующие процессы ну и а когда есть еще 2 как от сторонних разработчиков поэтому тут остро встает проблема каким же образом все таки хотелось бы добавлять вот эти правила секунд но не через код а не изменяя не изменяя исходного кода самообразования то есть мы не хотим писать код код самоизоляции не потому что нам лень а потому что у нас просто нет такой возможности потому как же делать по-другому ну и здесь один из способов представлен с помощью менеджера процессов системе дней если вы используете system backup менеджер процессов вашей операционной системе если почитайте документацию не есть такая директива систем колфилд и где можно указать список системных вызовов которые разрешены для приложения к которым управляется стене можно почитать здесь документации давайте посмотрим как это работает то есть давайте вернёмся к нашему первому варианту нашего приложения которые сама по себе не имеет никакой поддержки кода самоизоляции то есть это наше простое приложение которое просто выводит тип нашей операционной системы ну и это же приложение мы можем запустить с помощью системы и мы можем симулировать сказать между представить что это приложение как будто как сервис систем где и запустить это приложение нашей командной строке мы видим что она работает так же хорошо то есть мы видим наш вывод и еще с ист-энде нам говорит что приложение завершилась успешно код ошибки на все хорошо теперь мы можем попросить и стенде запустить акаде это приложение на этот раз за преследовал приложению использовать системной незабвенной используемых эту директиву и запускаем наше приложение и причем здесь нам не нужно исход доступ к исходному коду самом приложении используем тот же исполняемый файл и теперь мы видим что мы не видим нашего ожидаемого вывода то есть приложение в принципе не вывела нам тип нашей операционной системы и систем делам говорит что продолжение было выполнении приложения была прекращена ведром с помощью сигнала сексист потому что она нарушила нашу политику 100 ком получить стенде мы также можем симулировать политику которую мы описали нашем самом первом варианте где мы не прекращаем выполнении приложения а просто просим недра вернуть код ошибки на ней разрешенный системный вызов то есть мы можем использовать дополнительными директе не систем коломбо принципе мы теперь видим что как и в самом нашем первом примере самоизоляции приложения успевает вывести код ошибки она нам говорит стране пхукет таун и и завершается с кодом ошибки не и потому что мы его так запоминание то есть классно да в принципе мы теперь можем с помощью системы мы можем иметь любые правила секунд любой процесс нам не нужны никакие доступ к исходным кодом но у этого подхода есть конечно свой недостаток если вы почитаете документацию более детально вы заметите что некоторые системные вызовы независимости того как вы сканируете вашу политику всегда разрешено и они в принципе все из них неважные кроме одного что сист индии всегда будет разрешать вашей политике системными зигзаг ли чем он такой чем он такой плохой так давайте вернемся к нашему примеру программу числом анализа то есть допустим злоумышленник нашел уязвимость нашей программы и теперь получил контроль может исполнять какой не получил контроль на наши программы первую очередь что злоумышленник хочет получить это возможность выполнять любой код и как правило все равно наша программа на очень минимальные там не будет всех возможных артефактов для того чтобы злоумышленник мог выполнять любой ход потому что злоумышленник попытается сделать он попытается направить нашу программу сделать системный вызов игроками и поменять нашу код нашей программы на просто на командную строку и тогда в командной строке уже злоумышленник может выполнять все что он хочет потому что он просто выполняет команду да то есть это самый самый типичный способ получения произвольного кода выполнения польза некую уязвимость программе то есть мы и опять же secam это один из самых эффективных способов для защиты от подобной агрессивности но сожалению систем де оставляет нам большую дырку и не разрешают блокировать утан системный вызов экзо кве и так сказать она позволяет злоумышленнику худо-бедно может быть иметь больше возможностей по получению произвольного кода в поле этому в класс форум и решили немножко доработать этот подход и мы разработали набор инструментов свой набор инструментов чтобы вставлять правило соком практически в любой процесс не доступа к исходному коду этого пространства за пример мы использовали подход систем где мы его решили немного расширить то есть и наш набор инструментов состоит из двух компонент это динамическая библиотека для работы с приложениями которые динамической которую или сын кованый с помощью динамической линковки и некий специальный лаунчер для работы с приложениями которые были слинг о ван эстетически ну и особенность нашего набора инструментов что она не имеет недостатка систем где с помощью него можно заблокировать любой системный вызов включает заклей и этот набор инструмента потому что нам не нужен доступ к исходному коду этот амур инструмент оперируют на исполняемых файлах и процессах то есть это подход работает на любом бинарники на любой программе которые написаны на любом языке программирования и даже если у вас нет доступа к исходным кодом самое интересное что это все набор инструментов у концертной с открытым кодом и вы можете найти у нас на гитхабе сейчас мы затем один из компонентов динамическая библиотека мы же вроде рассматриваем подходы без необходимости писать дополнительный код разный динамик если использовать какой-либо динамической америку не надо ли ее интегрировать свое предложение с помощью какого так он нет она немножко особенной давайте рассмотрим пример как она работа давайте опять вернемся к нашему первому варианту нашей утилиты которые не имеют собственного кода самой нации и теперь попробуем запретите из системный вызов данным с помощью нашего нашего набора у кирико то есть чтобы сделать это мы его запускаем вот таким образом что мы делаем здесь мы с помощью специальные перемены уже не алгебру прелат мы подгружаем нашу библиотеку из нашего набора инструментов приложение которое мы пытаемся изолировать и с помощью другой переменной дженни мы определяем нашу политику клуба лада здесь мы говорим что мы просим ведро разрешить любые системные вызовы кроме одного гиней и опять допустил это приложение мы уже видим что как только приложение попыталась использовать иные и системным и зам она была остановлена ядром немедленно непреложны то конечно удобные но это специальные переменная уже и не всегда работает на есть некоторые нюансы которые можно почитать на моем странице когда это переменное окружение не работает и хочу заметить здесь для опять то есть хоть мы используем нашу динамическую библиотеку с нашего набор инструментов мы нам не надо было менять исходный код нашего приложения нам просто надо было каким-то образом обеспечить чтобы наши библиотека была погружена в адресное пространство нашего приложения и поэтому мы использовали деньги привело от работает не всегда есть узкий набор исключение когда один пилот использовать нельзя поэтому есть второй способ как это сделать мы можем непосредственно мина изменить сам бинарник сам исполняемый файл нашего приложения и добавить нашу библиотеку как постоянную завестись то есть опять же здесь я прошу заметить мимимими исходным кодом и просто меня бинарных исполняемого файла и теперь после этой команды мы видим что наша библиотека есть теперь посты частью нашего исполняемого приложения и теперь всегда будет загружена когда будет загружена наше приложение поэтому теперь нам нужен можно не использовать специальный переменную я не лгу пилот просто нужно использовать переменную окружении которое понимает наш на мои инструментов и определить политику секунд для нашего приложения это были приложений которые были стрелковыми динамически если мы пересоберём наше приложение и слинг у него статически то мы увидим что на статических приложениях этот подход уже не работает попытаемся запустить метанию но мы видим что наша политика не имеет здесь никакой силы то есть все равно спокойно выполняется почему потому что сама переменное окружение одни плод не имеет никакого смысла для статической на кованных приложений потому что приложение уже не запускается с помощью динамического загрузка операционной системы а напрямую ядром погиб пилот не подгружает наш код в адресное пространство нашего предложения поэтому нашем наборе инструментов есть вторая часть второй компонент наша специальный лаунчер для статические мин кованых предложений то есть чтобы ставить нашу политику сиком в такое приложение нам нужно его просто запустить через наш специальный лаунчер используя ту же переменную окружения для определения политики с итого набор инструментов flowers in box конфигурировать его достаточно просто то есть он понимает политику можно сконфигурировать с помощью двух переменных окружений первое это соком сыскала low это список разрешенных системных вызовов если его использовать то все системными зубы в этом списке будут разрешены а все системные вызовы которые не в этом списке был по умолчанию запрещены иногда такую политику определить сложно поэтому менее безопасный но иногда и есть на возможные варианты ко второй подход то есть другой список список запрещенных системных вызовов то есть тогда все системные которые в этом списке запрещены а все остальные системные вызовы по умолчанию разрешения и еще есть интересное третье переменное окружение действие по умолчанию то есть если мы ее не укажем то из всех примерах которые мы видели если мы нарушим нашу политику таком если приложение нарушить нашу политику секунд его выполнение быть немедленно прекращено ведро с помощью вот это переменные окружения мы можем попросить ядро не прекращать наш процесс и даже разрешать системный вызов но просто логировать что это приложение пробовала сделать системным и за которую мы не разрешили ранее когда это удобно и это удобно если у вас есть новое приложение которое вы не знаете даже как работает у вас нет доступа к исходным кодом и вы даже не знаете какие системные вызовы это приложение использовать то есть вы можете его запустить некоторое время в этой такой и сочности которая в принципе ничего не делает только лагер uid запрещенные вызовы и вы можете составить себе список системных вызовов которые нужны вашему приложению потом перевести ее более строгую песочницу где ядро прекращает выполнение приложения при нарушении правил сайта ну и наш набор инструментов состоит из двух компонент как я уже говорил раньше это динамическая библиотека она должна использоваться для того чтобы вставлять правило so come приложения которые свин кованые и динамические и нам нужно убедиться что это библиотека подгружена в адресное пространство нашего процесса то есть это можно использовать или переменную окружения не preload или можно непосредственно про плачется бинарный файл исполняемый файл приложения и второй компонент это наш специальный лаунчер с помощью его можно вставлять правило секунд и статические slim кованые приложения и динамических или кованые приложений что для этого нужно это просто нужно запустить положение через наш специальный лаунчер здесь опять появляется вопрос если наш лаунчер позволяет вставлять правило эстетическое ленкова на и предложения и динамическими головками для не зачем нам тогда динамическая библиотека нужно не просто выбросить чтобы ответить на этот вопрос показать преимущества динамические библиотеки давайте рассмотрим очень высоко уровней точки зрения как запускается любой процесс на открытую систему то есть когда вы запускаете исполняемый файл есть грубо говоря две стадии первая стадия это инициализация никого runtime а и вторая стадия это основная логика программы основная логика это код который пишет разработчик и которые грубо говоря начинается когда выполняется функция main так вот если использовать наш набор набор утилит то если вы используете лончер правило секунд будет будут вставлены вот на этом этапе перед инициализации ran to me а если вы используете динамическую библиотеку правило всяком будет вставлен и после инициализации какая же разница здесь и вообще что такое этот инициализация оранта инициализация ran to me это некий код который непосредственно как правило разработчики не shit он генерируется компилятором непосредственно того языка программирования на котором было написано программы и у разных языков это инициализация рахма на общее эти всех antonov то что они просто делают некие служебные действия чтобы подготовить программу выполнение и для этого они используют очень много разных системных вызовов которые в принципе потом скорее всего не будут использоваться в основные логике то есть эти системные вызовы используются 1 или 2 и принципе у вас на логике они не нужны и так разработчик не пишет этот код выкать даже как разработчик программ можете даже не знать что ваша программа использует здесь мы видим преимуществе динамической библиотеки наши из нашего набора инструмента потому что сами правила вставляются немножко позже все что нам нужно разрешить на этом этапе это системные вызовы из это по основной логике но нам не нужно думать про этап инициализация рантала если мы же используем все таки лаунчер нам нужно разрешить все системные вызовы как цвет опасной и логики так и сами медитации runtime а то есть нам нужно грубо говоря разрешить намного больше системных вызовов и большая часть из них принципе не нужно наш с аналогий давайте рассмотрим на примере опять вернемся к нашему любимому приложению пересоберём его из линкуем динамических экономил раньше и но теперь мы поменяем политику безопасности политику циклом давайте сделаем и раньше выделяли какую-то неправильную политику мы запрещали приложению системный вызов которые мы в принципе был нужен теперь давайте сделаем минимально допустимую правильную политику то есть давайте разрешим приложению все системные вызове которые ему необходимы для работы и сократим все остальные то есть если мы будем использовать динамическую библиотеку здесь нам нужно для нашего положения всего лишь разрешить 4 системных вызовов там она нормально работала если выбираете какой-то стену низом отсюда она работает перестанет если вы добавите конечно но все равно будет работать на мыс будет такое безопасно потому что вы разрешаете приложению больше системных вызовов чем надо да то есть четыре системных вызовов если мы грубо говоря запустим и то же предложение на ничью с помощью динамической библиотеки через нас лончер так как а нужно разрешить все системные вызовы и специализации runtime а наш список намного больше здесь и в итоге нам нужно разрешить 13 системных вызовов они 4 и в итоге если них 7 системных вызовов в принципе нам нужны в основном логике но не теперь бы навсегда разрешены этому приложению пока она будет выполняться фух это грубо говоря все что я хотел на сегодня рассказать вот немножко ссылок ссылки на ресурсы которые я упоминал этой презентации 1 отсылка на man страницу самого системного вызова cq трассе эта ссылка на библиотеку липси ком которые мы упоминали в презентации который кстати используется как нашем наборе утилит la force in box 3 ссылка это список эта ссылка на документацию систем гей которой описывать каким образом можно сокращать разрешать системные вызовы с помощью систем 2 и 4 ссылка это ссылка на наш набор утилит и club was in box надеемся что он вам понравится и вы будете его использовать и ждем от вас фидбэк а может даже и полный класс спасибо сейчас я готов ответить на все ваши вопросы спасибо за внимание вот такие дела спасибо игнат я переместился в другое пространстве во времени не за находишься другой комнате это замечание удобное кресло да как говорится в анекдоте отвечать мой шофер собственно у меня есть у самого несколько вопросов по поводу этой штуки потому что крайне интересное уже думаю как можно это применить вопрос 1 используйте сами эту утилиту библиотеку у себя в компании насколько обширно вообще или это такой крупа в концепт и вы его просто расшарить для людей ну это библиотека она достаточно новое интересными и только недавно сделали нам показалось что она будет очень полезна и но конечно перед тем как мы ее выглядели мы ее попробовали на нескольких сервисов то есть уже несколько новых таких экспериментальных сервисов которые крутятся у нас продакшене мы и зале изолировали с помощью вот этой библиотеки под понятно слушая что если злоумышленник перед подключением lips in box через ld брелок по мере через запотел подключить мне другую библиотеку как я гарри могу гарантировать то что вот liebe sonne бокс будет загружен первым и залинкованы первым соответственно перед lips on боксом не выполнится какой-то другой плохой код ну кстати очень частый вопрос который спрашивают если мы рассмотрим немножко в более широком смысле то есть вот эта утилита это не есть там решение ко всем проблемам это не есть универсальная синяя таблетка от всего да то есть это какая-то часть какая-то кусочек системы безопасности которые закрывают какую-то одну функцию надо помнить про песочницы и простаком в частности что циклом это способ сама изолировать ваше приложение и защититься от эксплойтов кода от ошибок вашем коде да то есть если ваш код написание безопасное его кто-то позже смог каким-то образом склоне это может защитить этот способ не позволяет то есть это позволяет защитить ваш плохой код программы от источников которые могут воздействовать на ваш код когда она уже выполняется в продакшн то что мы обещаем а вдруг кто-то раньше загрузит а вдруг кто-то допустим даже может пропатчить наш бинарник и вообще поменять этот код это уже проблемы не безопасной окружающей среды то есть эта система хороша настолько насколько вы уверены в безопасности вашей окружающей сре если уже злоумышленник сидит ваши окружающей среде за компом не поможет да вам надо я не знаю там включать какие-то уже линуксе тюльки mobius вам надо домой наполнять сикер but чтобы вы убедились что замуж не канет вашей системы и так далее так далее то есть самый главный самое главное требование что мы доверяли своей песочницы и построены на лексикон что у вас уже безопасная операционной системе есть у вас питомец темы небезопасной там уже себе замуж никто как бы вы уже проиграли эту битву по крайней мере с точки зрения сайков слушай используйте вы какие-то другие уровни защиты то есть но да я понимаю что если комп это грубо говоря прослойкой безопасности между applications ядром но есть же еще другие прослойки то есть например тот же up or more linux capabilities которые работают немного на другом уровне и уже представляют немножко другую защиту то есть дальше до файловой системы и куда-то все эти так далее а используйте вы что-то такое тоже т.е. да то есть первое что мы пытаемся обеспечить чтобы включить любую систему защиты которые обеспечивается ядром linux надо в первую очередь убедиться что твоя само ядро linux ему можно доверять и для этого мы используем в принципе стандартное решение secure boot уефа secure boot то есть у нас вся цепочка загрузки когда загружается сервер она подписана то есть bios и и five фермент проверяет подпись на нашем загрузчики загрузчик проверяет подпись на операционной системе и как в ноябре и на пользовательской части когда это все загружается можем доверять игру это мы включаем какие-то другие дополнительные защиты в ядре у нас включена допустим проверка подписи драйверов гидрантов все внешние драйверы гидра не тоже подписаны и они загрузятся туда с точки зрения а по мороси linux это линок security модус мы еще только экспериментируем в этом плане просто еще не очень понятно какое из этих решений взять и достоинства и недостатки с и linux но допустим очень очень гибкая и очень позволяет все очень гибкой тоненько настраивает на другой стороны сами политики с индексами очень сложной их надо каким-то образом потом mini jack up or more на другой стороны немножко легче но опять же она не такая гибкая поэтому еще на этапе вот решение linux capabilities мы используем то есть на стараемся не гонять процессы от рута если просто процессора socket мы даем определенные capability также но я бы стандартные разграничения операционной системы linux то есть там не гонять сервисы от рута отгонять их от специальных сервисных пользователей и так далее то есть это у нас ну и сейчас дополнительно вот мы интегрируем библиотеку то есть это грубо говоря мы идем к разработчикам которые отвечают за конкретный какой-то сервис наши операционные в нашем в нашем подавший говорим вот если у вас там нет времени и самим писать политики ссср комп хотя бы вот возьмите вот эту утилиту быстренько ее там погоняйте в лагерном режиме составьте себе список системных выдам которые вам надо и и просто пропишите то политику в конфигурационной наши confirm она же у вас будет все намного лучше особенно для сервисов которые смотрят наружу в интернет слушай ну ещё у нас есть вопрос в чате пропатчил и статически дент кованые приложения собственно вопрос состоит из двух первый вопрос это по тел не поможет для статические лин кованых приложений по той же причине что эти было рынке бинарники запускаются ядро manele de asa и собственно про laughter про ваш по сути ваш laughter это тот же л д с а тот который чает один лишь lips in box немножко нет то есть теоретически теоретически с помощью патча рф можно переделать статически ленкова на и приложение перепачкать его и сделать его динамик телефона у меня так это не получилось сделать сделать потому что ну динамически ленкова и но и там не только прописан список динамических библиотек которые надо там также прописан путь к интерпретатору я могу и как правило зависимости от языка программирования на ленку и цапа своим видом в принципе почаев очень легко добавить новую библиотеку как зависимости существующие динамическое приложение но полностью переделать статическое и динамическое без последствий тяжело возможно на тяжело то есть наш лончер немножко делает не так наш launcher это он больше похож не на просто и нефти библиотеку в процесс а он больше похож на то как работает систем де то есть он запускает приложение сам он просто как будто занимает место систем где он запускает приложение как child процесс и но он ещё использует всякие новые фишки операционную операционной системы linux то есть он его сначала запускает как бы под дебаггер ом и как только запускаем а и приложение начинает выполняться она как бы попадает на нашу так называемую точку остановки и в этой точке включается дебаггер вставляет необходимые правила сеткам и потом отключается и все дальше приложение уже выполняется с правилами таком то есть сам подход немножко разные здесь я хочу напомнить ребятам кто у нас смотрит что вы можете задавать вопросы в telegram канале телеграм-канал у нас вот тут вот снизу 1 видео справа есть две иконки 1 с камеры другая с конвертом собственно просто кликните попадете в telegram канал и задавайте нам вопросы пока из чата вопросов больше нет не интересно какие у вас дальнейшие планы на эту утилиту и вообще как бы вы ее будете использовать у нас как обширного и и дальше будете использовать ну первое применение утилиты у нас лично показала положительные результаты то есть наши команды которые которые бы хотели делать секунд на них или нету времени или не туда же знаний или они там даже пишут все таки допустим таком достаточно легко подключить если ты пишешь на языке си или но если of программа там на каком-то интерпретатор это надо опять искать сторонние библиотеки и так далее то есть как это такой легкий путь и хотя бы поставить базовую песочницу свой процесс у нас оказался очень успешным поэтому мы будем продолжать ее использовать и будем более более больше сервисов адаптив в эту модель то есть это программа теперь хоть часть нашей операционки и любой сервис owner который хочет просто использовать может сделать простой простое изменение в конфиг менеджменте и сразу получить свои правила мы снимаем что допустим мы и делали под себя и мы возможно не учли все возможные из кейсы именно поэтому мы решили ее открытие как бы может быть комьюнити публика нам подскажет чтобы еще можно было интересно с ней сделать как бы ее немножко улучшить ноги скажем так потом мы бы тоже этим вы пользовались у нас в поношении да я смотрю у вас очень активно на самом деле камень 30 дальше в этот проект и даже последний камень был буквально сегодня это очень круто слушай об или используйте какие-то новомодные хайповые слова типа но вы это уже не такое хиповое слова докер может быть дальше более хайповой кубе r'nessa используйте любые внутри контейнере zero ван их приложений вот эти же штуки или вы запускаете все на голом железе на то есть ваших вот этих песочек песочниц как она там работает и да и нет то есть у нас архитектура примерно следующее у нас если зайти на наш сайт и можно посмотреть где находится наши дата-центры у нас их очень много но эти все дата-центры это которые сад делают нашу сеть клаусура edge так вот вклад for each у нас архитектура достаточно простая то есть у нас распределение идет по машинам и по дата-центром но не вертик вертикальной вертикальном программном стэки у нас все очень простенько то есть у нас нет никаких контейнеров у нас нет и никаких виртуальных машин это каждый сервер это просто операционной системы linux где крутятся какие-то сервисы включая этот они могут быть за сэндбокс он и они могут быть безопасно в принципе никакого этих контейнеров у нас там нету и в принципе и каждый сервер он такой же как и другой он имеет полностью идентичной программный стек никакой разницы у нас нет есть у нас пару дата-центров которые нет на этой карте который мы называем инфаркта это дата центры которые не обрабатывают пользовательский трафик это наши личные дата-центре где мы храним нашу личную информацию то есть там крутятся наши служебные сервисы там крутятся допустим какой-то там наши логин pipeline деметра собираем logis продакшена крутится там всякие дайте analytics и так далее так далее но и на сервис и наши внутренние так вот там ситуация немножко другая этих дата-центром намного меньше но сами сервера они более разнородные то есть у нас разные сервера есть кластер и которые делают разные вещи у нас есть ютубер notice кластер и дали несколько где просто любые разработчика любая команда мода запустите свой внутренний сервис у нас есть crack house у нас есть допустим кафка кластера у нас есть что еще ластик сара ну и так далее то есть вот вот так и там уже у нас есть docker и у нас там есть контейнер и понятно на 100 миску вернитесь и там архитектура немножко другом слушай вот хорошо но ведь приложения обычно большие и как обычно обычно в нашем современном мире особенно на современных ремарках написаны и приложение еще и используют 3d форквут процессы отдельные так далее что если я хочу например чтобы мой мастер процесс имел одни ограничения но при этом форматы какие-то под процессы или отдельный трек имел другие ограничения то есть есть моего приложение так устроена что вот этот конкретный трек я знаем что его я хочу очень сильно ограничить ты потенциально какой-то опасный явно не понимаю что если я использую просто боксе фай launch of the я не могу это сделать потому что я на весь процесс навешиваю сразу вот эти системные вызовы ограничения контрактов а если я использую библиотеку и внутри кода могу ли я уже как то более гибко разруливать права или все-таки это на уровне ядра происходит на 1 prm процессы ниже я уже ничего не могу дать сами правила secam они просто то есть если модель 1 процессы много отрада в ту политику прекрасно нельзя сделать если модель торрент процесс и чел просто на каждый процесс можно поместить свою политику скажем так тут уже для более вот это само решение сэндбокс она для начальной простой но не очень гибкой политики да то есть это такой quickstart куда вы можете так сказать быстро за sandboxie любое положение они очень хорошая утилита для того чтобы настраивать очень тонкие гибкие политики и скорее всего чем тоньше вы хотите это сделать тем скорее все это придется писать заминку часть своего предложение и в принципе с о ком бы то можно сделать потому что допустим 99 процентов кейсы которые покрывают александр со комп мы можем ну это же что делает систем где например мы можем просто определить список системных вызовов которые разрешены запрещено но на самом деле если вы начнете писать свои правила с account на языке бпф или с помощью lips обком там можно допустим настроить более гибкие правила допустим можно не запрещать полностью какой-то конкретной системный вызов а там еще с помощью этого бпв кода можно анализировать именно параметры этого системного то есть можно допустить не полностью запретить опыт системного за можно запретить опыт всех файлов кроме одного файла дартмур на более такие гибкие по ночам гибче вы хотите тем больше вам придется писать ценным и в принципе эта же модель можно применить и если у вас есть сложный процесс ему хитро давай в зависимости от родов можете пробовать так сказать написать такие гибкие правила которые работают в одних странах и работают другие страны но опять же это уже более сложная разработка а если я хочу не блокировать и white листика хочу например лакировать что у меня приложением скажем это стороннее приложение для меня это blackbox я не знаю что она там внутри использует я хочу посмотреть что аналоги рует могу ли я использовать как то вот это вот ваши утилиты для того чтобы это сделать да вот там есть 3 переменное окружение которые я упоминал на слайде то есть сейчас наша утилита поддерживает два режима работы то есть первые режимы работы немедленно прикрыть ну такой жесткий sandbox немедленно прекратить выполнение приложения если она нарушила правило второе это ею месси в дни вы можете поменять этот экшен просто на логирование то есть не и этим и кстати очень часто пользуемся то есть мы берем вот недавно мы там экспериментировали вы ск с cockroach тебе допустим и для эксперимента никто сильно не хотел разбираться какие конкретные ему там системные вызовы надо мы просто запустили его в этой лагер у и мы и песочницы и просто смотрели налоги какие системные вызовы она используя до и после этого составили себе список и потом перевели из вот этого повысим более информа то есть если мы будем надеяться что пока мы экспериментировали его в форме сигма никто его не взломал то в принципе после этого уже ее будет труднее взломать потому что мы только разрешили те системные вызовы которые хотел делать какое тебе до то есть есть вот этот переменное окружение тискал дефолта экшн и если ее поставить флаг то ядро будет разрешать все системные вызовы но те что не будут определены и нашей политики она будет писать или в де мяско если у вас но у нас допустим продакшене еще крутится такой демон как у детей он собирает эти все винты отправляют нам в наш центральный логин pipeline и я там допустим даже если запустила сервис по всему всей нашей сети под 200 до центра в я там захарова этот центральный логин под лайн и еще вот эти вот нарушения правил и могу по процессам их про сортировать и посмотреть что вот этот сервис который меня сейчас интересует вот делал такие такие нарушения и потом я могу посмотреть разрешать им действительно это кит их таким же образом мы исследуем вот эти вот black box приложение то есть я упоминал в презентации про про это рио причин цвета в принципе для продакшена такие не используем но мы используем этот подход для вот всяких таких вен данных приложений для работы железо местности сервер там нам нужно обновить bios на нем там и как правило получаем бинарник от american мега тренд который flushed эти bios и и туда страшно вообще заглядывать поэтому его тут же может песочница загоняем и хотя бы смотрим что он делает то что он должен делать и не лежит никуда в другое место интересно слушали но просто у меня сейчас на моей работе в планах прохождения различных компаний штук и там среди прочего нам прекрасных оберните интересно как сделать так чтобы за удирать разные вызовы и получается я правильно понимаю что я могу просто у себя в контейнерах добавить там скажем sandboxie fly в режиме логирования каких-то вызовов и в идее я получу в аудите то есть если у меня в системе на на ноги хардварные настроенного di-d я получу в аудите записи о том как в моем мои приложения в контейнерах использовали эти системные вызывают деланья там были попытки их зеков где у меня там были попытки изменения каких-нибудь логов поскольку у меня внутри контейнера только одно приложение получает я могу очень гибко вот эти вещи логировать с этой точки зрения мне очень нравится вот это вот ваша вещь ваши утилиты библиотека и наверное мы будем смотреть на это штука у нас остается давайте люк обернитесь и хотел сказать если главный контейнеры джонс кубер найтись используется докер докер тоже поддерживает правила секса на уровне создания контейнера то есть может даже если именно конкретно кубер нить из контейнер кейси может даже нет смысла использовать нашу утилиту может надо просто посмотреть каким образом когда вы определяете когда вы запускаете этот контейнер и левку бернет если вы определяете под template там скорее всего тоже есть возможность указать вот этот вот правило соком какие системные вызовы какие разрешены какие запрещены я не могу точно сказать можно ли там настроить так чтобы запрещенной системные вызовы не убивали контейнера просто лагера вали результат но это стоит в ту сторону тоже посмотреть потому что докер он поддерживается ком тоже умел даже какая то есть начальная начальный по умолчанию правило циклом которые он определяет для каждого контейнера очень круто это ее до джад юта джаз спасибо ребят за вопрос зато доклад я думаю что мы и дальше продолжим дискуссионной зоне ну точнее как мы вы продолжите наши слушатели если у вас остались вопросы о том когда стоит из секунд использовать когда вообще не стоит ни в каком случае то приходите в дискуссионную зону и задавайте эти вопросы игнату он с радостью ответит пока пока"
}