{
  "video_id": "j2mkEfNlcFE",
  "channel": "DevOops_conf",
  "title": "",
  "views": 0,
  "duration": 0,
  "published": "",
  "text": "Всем привет Это депс Меня зовут Константин с нами спикер Максим кунов по теме Его доклад использования прокси для балансировки нагрузки между локациями Максима Я знаю давно мы с ним работали ещё в Яндексе Максим занимался сре всем маркетом управлением трафика сейчас он всем известно из социальной сети на букву ф и у меня такой вопрос да к Максиму я сам Да знакомился с докладом и мы тоже с чего-то начинали И вопрос такой почему вот твой доклад будет интересен нашим коллегам которые только-только начинают понятно что у тебя уже ну опыт стаж там больше там 10 лет работы в и сырье ты работаешь в крупных очень крупных компаниях твой доклад очень интересен В чём он будет помогать вот таким начинающим инженерам каких-то таких больших компаниях как-то расти двигаться улучшать сырья Всем привет Спасибо Константин за вопрос что касается того чем будет мой доклад полезен начинающем СР Я хочу м сказать следующее балансировка трафика - это очень интересное направление которое позволяет Изучить и работать с проектами начиная от самого маленького размера и заканчивая самыми крупными поэтому вы можете проу рает баров познать Что такое нагрузка Как с ней жить как с ней бороться И постепенно вы разов до более крупных экспертов Вы сможете работать с какими-то распределённые системами и при этом Как вы сегодня увидите в целом Вы можете использовать ВС те же инструменты они пригодятся вам всю вашу профессиональную жизнь и СБО мни пси работает на конференции чат Вы можете сразу не задумываясь как только у вас возник какой-то вопрос по докладу пишите сразу в чат в чатик я эти вопросы все просмотрю и если останется в конце время Ясь что останется мы их зададим Максиму А всё передаю слово Максим Спасибо Константин Ну что ж Давайте начнём А ещё раз кратце представлюсь Меня зовут Максим куприянов а тема нашего сегодняшнего доклада - это использование хо прокси для балансировки нагрузки между локациями тема хардкорная хочу сразу предупредить мы будем говорить о вещах довольно продвинутых мы не будем рассказывать о том как начать с нуля и я думаю запись данного доклада вам очень Пригодится в дальнейшем если тема вам действительно вас заинтересует и какие-то мысли которые я буду говорить здесь пригодятся для ваших будущих проектов Ну что ж Сначала мы посмотрим на то о чём мы сегодня будем разговаривать мы будем говорить о внешнем балансировке точнее работе балансировщика в режиме внешнего реверс прокси Почему именно так Почему не Игрес контролер не кубернетес и так далее Дело в том что мир которого мы знали Ну последние там 10 лет довольно сильно поменялся если несколько лет тому назад вы были предположим представителем какой-то Ну либо крупной компании либо крупного проекта быстро растущего с высокой надёжностью с высокой нагрузкой географически распределённого а вы скорее всего пошли бы в aws или какой-то из похожих облаков и все ваши вопросы по доставке трафика все ваши вопросы по масштабированию и по предоставляемым сервисом были бы легко непринуждённо закрыты но а сейчас картина несколько иная и скорее всего вы будете работать с кем-то скорее всего с несколькими российскими сервис провайдерами и это уже совсем другая история потому что вы должны быть мобильны а вы можете менять провайдеров у вас может меняться бюджет Вы должны быстро разворачивать сервис Вы должны точно также быстро его сдувать в случае необходимости экономии ресурсов а далее внешний балансировщик поможет вам в вопросах масштабирования сервиса Ну то есть предположим завтра вам срочно необходимо открыть запустить сервера где-нибудь например во Владивостоке А например тот сервис провайдер с которым вы работаете У него там нет возможности разместить оборудование вы просто идёте какому-то другому провайдеру запускаете и имея внешние балансировщик вы совершенно спокойно перенаправляет часть трафика между локациями так как вам это необходимо ну и наконец отказоустойчивость время сложное и вы все знаете что сервис провайдеры легко и непринуждённо могут оказаться жертвами какой-то Ну либо атаки специально либо возможно просто какой-то неудачного стечения обстоятельств и А так как Несмотря на то что у облачного провайдера может быть несколько дата-центров А ну по сути центр управления точка управления как правило всё-таки одна и может так случиться что а именно она подвергнется атаке и э сложится всё как Карточный домик такие случаи известны это бывает Особенно для инцидентов связанных с сетью поэтому имея какую-то резервную локацию либо хотя бы возможность очень быстро запуститься в резервной локации А для этого нужны как раз внешние балансировщик вы повышаете свою отказоустойчивость ну и наконец безопасность безопасность важна в том смысле что на внешнем балансировщик Вы можете как минимум Термини криптографию Вы можете проводить какие-то базовые Ну или даже не базовые Более серьёзные какие-то вещи по защите от от Атак от не злонамеренный там от не зло намеренных перегрузок например на почве каких-то новостей к Вам пришло очень много клиентов и хотите как-то их ограничить В общем все эти вещи позволяют решить и закрыть внешний балансировщик трафика и мы сегодня будем говорить о ха прокси А почему мы будем говорить опси во-первых Этот балансировщик очень производительный очень заботится о ресурсах по данным тестов их официальные тесты они выдерживают до 2 млн rps rps - это запросы в секунду request и до 100 гиби На одном сервере Ну тот кто занимается доставкой сетевого трафика прекрасно понимает что такое 100 Гигабит На одном сервере если у вас Ну не какой-то 100 Гигабит На одном сервере обработать очень тяжело это требует грамотного распределения прерывание по ядрам И множество других вещей к позволяет это достичь его он довольно я не буду использовать слово старый потому что он прекрасен И очень современный но появился он очень давно ещё в де дем году был его прообраз интересный момент что КСИ создавался как раз для того чтобы подстраховать не выдерживающие нагрузки аппаратные фик балансе фик балансе вышел он в 2001 году как прокси или проси его называют и так и так текущая стабильная версия 3.0 то есть вот за 203 года третья версия и третья версия собственно появилась в связи сфи поддержкой Ну фактически с официальной поддержкой hp3 написано на языке C но это не должно пугать потому что автор его профессиональный разработчик на KC Он входит в Linux carnal stable Team в Linux carnal Security Team и он знает что делать там большая команда последние несколько лет поддержкой занимается есть коммерческая реализация более миллиарда загрузок на dockerhub и конечно же он очень многими используется очень крупные компании здесь представлены многие Российские компании безусловно используют его Ну что значит по поводу того как КСИ относится к оптимизации ресурсов я Вам чуть дальше покажу один очень интересный пример А пока Ну давайте начнём Итак первая глава начинает называется учимся падать Почему Потому что в этой главе мы будем с вами говорить о ситуации перегруза мы с вами сначала разберёмся как мы как в КСЕ бороться с большим количеством трафика потом мы с вами посмотрим как работать с несколькими ха прокси инстанса одновременно И в последней третьей главе мы с вами разберёмся с тем как это всё собрать воедино как умным образом перераспределять трафик между локациями используя несколько инстан сов ха прокси и в качестве бонуса посмотрим как мы можем а взаимодействовать с Кэн дами передавая им информацию о том что творится сейчас значит на уровне балансировки Итак наш сайт на картинке а мы видим здесь в центре tls Gateway Proxy иногда tls снимают отдельным сервисом иногда это делает тот же самый H Proxy поэтому здесь такой оранжевый прорывист контур это может быть оди может быть два итак у вас есть предположим например новостной сайт у вас есть какие-то бэнды это можно будет кубес кластера например или отдельные серверы даже неважно это может быть какой-то гибридный набор кэндо И у вас есть пользователи так вот в какой-то момент Ну например выборы да идут в какой-то стране и всем людям стало очень интересно посмотреть А что же там происходит-то и к Вам пришло в пять раз больше пользователей и как вы видите нагрузка на Application сервера на бэнды пять раз собственно вырастает предположим мы знаем что это для нас слишком много н не выдерживает Давайте подумаем чтоб с этим посмотрим как с этим бороться но для начала мы введём Ну наверное самый мы уже упоминали термин rps Давайте его зафиксируем потому что это будет наша самое главный показатель нагрузки в принципе если вы работаете с доставкой трафика это вообще ну главный показатель нагрузки и количество запросов в секунду либо Ну в минуту обычно в секунду все остальные вещи связаны уже с качеством работы вашего нагрузочный показатель именно о м мы сегодня и будем всегда упоминать имея в виду дополнительную повышенную нагрузку Итак вот простейший ко который Предлагается в документации для того чтобы зау сайт от перегрузки он скажем так оставляет желать лучшего в некоторых местах он не очень РОНО ВМ три основные вещи которые мы должны изучить для того чтобы уметь работать с перегрузкой в ха прокси я ещё раз Напоминаю что так как наш доклад имеет Хардкорный уровень мы не будем с вами говорить о том как настраиваться frontend Бэн секции вха прокси мы будем говорить о самых а интересных и слабо Ну точнее они документированной всегда очень понятно плюс есть некоторые проблемы с нейминга Я постараюсь объяснить Итак давайте разберёмся что же на этом простейшем конфиге присутствует а присутствуют Здесь три главные вещи первое Stick Table Ну липкая таблица можно назвать Так а что это такое Это Ну в принципе это хш Map А и он чем-то похож на кэш потому что А у него есть у каждой записи есть Time to Leave То есть через какое-то время она исчезает в данном случае мы видим что ключ У этого хэш мапа IP адрес IP вче адрес я хочу отметить и это первый момент который не очень хорош в этом в этой конфигурации А sze 1 млн записей А запись устаревает через 10 секунд и для каждой записи мы хотим посчитать количество http запросов среднее за последние 10 секунд Ну вот как раз за время устаревания А разобрались с таблицей вторая интересная строчка http request TR sc0 в этой строчке переменная sc0 она называется sticky Counter вот плохое название sck Counter У вас есть Counter в Стик таблице и sck Counter из c0 В общем sc0 на самом деле Это всего-навсего связка которая позволяет привязать запрос впрок текущий выполняющиеся к Стик таблице по какому-то ключу в данном случае у нас вот здесь нет поля по поси а и третья строчка которая нас интересует - это http request Den If Вот это называется AC то есть тоже странный нейминг AC это Access Control L обычно в hxy в AC - Это обычно какие-то действия которые выполняются по каким-то условиям в данном случае если посмотреть на условия условия следующее если количество записей если количество обращений с какого-то IP адреса превышает 100 в среднем за последние 10 секунд то запрос отбрасывается три основные позиции Чем плоха эта конфигурация тем что у вас е ваш сервис работает он обрабатывает запросы и если предположим происходит кратковременное превышение числа запросов не стоит убивать их все нужно убить лишь те которые превышают лимиты вашего сервиса Ну и последняя строчка она просто переключает вас на какой-то Кэн я вам обещал показать как КСИ относится к оптимизации ресурсов например как эффективности так вот давайте сейчас посмотрим на комментарий из кода Это последняя версия просто комментарий сейчас сразу скажу в своём проекте Я бы наверное не хотел видеть подобные оптимизации но так как речь идёт об эффективности и люди много-много лет сопровождают и этот продукт и довольно делают его довольно надёжным здесь это приемлемо посмотрите как они подходят например composit Address что это такое а вернёмся на один слайд назад как я говорил sc0 - это переменная это переменная sck Counter а она связывает ваш запрос с со ки таблицей на самом деле эта переменная хранит два указателя это структура в си хранящая два указателя один на таблицу второй на информацию о текущем запросе указатель в современных архитектура Это обычно 8 бай и того эта переменная занимает 16 байт а но а так как мы знаем что в современных архитектура что в x86 что в ARM А все данные выровнены по границе 4 байт как минимум это подразумевает собой что последние два бита у каждого указателя всегда будут нулевыми и Ну вот ребята из прокси подумали а Поче пропадать двум битам Давайте нам там ещё два флага нужно хранить и вместо того чтобы добавить два Булин поля в эту структуру они используют два последних бита для хранения этих флагов кажется что это смешно И это мизер Но на самом деле не совсем потому что два Булин поля в структуре это два байта а д байта с учётом выравнивания на самом деле приведут к тому что структура будет занимать бай Точнее не 16 + 2 не 18 А 20 байт А таких переменных три по умолчанию на каждый запрос это конфигурируется кстати говоря и таким образом при миллионах запросов в секунду вы получаете уже мегабайты оперативной памяти сэкономлено просто вот на таком подходе и это лишь один маленький пример Обратите внимание как Ну ещё раз говорю я не поддерживаю подобных оптимизаций в проектах которые не направлены на вот настоль высокое настоль аккуратное и бережное отношение к памяти конечно Итак давайте посмотрим на более хороший способ защиты от перегрузки где мы немножко подумали о том как нам жить с пользователями более красиво более вежливо Ну во-первых во-первых мы заводим Стик таблицу которую теперь уже не миллион записей а всего-навсего одна запись потому что нам на самом деле нет необходимости в том чтобы отслеживать каждого конкретного пользователя по его исходному IP адресу за I адреса может скрываться сколько угодно много пользователей Это неправильный подход мы не должны так делать пользователь может мигрировать между IP адресами поэтому Давайте смотреть на всю систему в целом у всей системы есть некоторая ёмкость она у нас ну мы договорились что мы считаем эту ёмкость в запросах в секунду предложим в нашем случае тема все наши бэнды вытаскивают Ну в среднем 100 запросов в секунду на всех больше они уже не справляются примем это как нашу верхнюю планку Итак что мы здесь делаем мы заводим Стик таблицу которая хранит одно единственное целое число это целое число устаревает каждую на каждую секунду и мы держим один-единственный счётчик по нему количество запросов в 1 секунду То есть в принципе это всё что мы считаем число у нас будет единицей и таблица содержит просто одну за и в третьей строчке http requ Always мы собственно так и привязываем мы говорим что переменная у нас равна на самом деле единице это число будет оди и она смотрит на к таблицу которая единственная в этом фронтенде Стик таблица может быть только одна на фронтенд секцию или эн секцию хорошая новость о том что вы можете заводить отдельные и секции на под каждую таблиц только для этого это вполне позволяется но есть более красивый способ Я потом его покажу Итак мы заводим переменную rps - это ско переменной это requ переменные могут быть в скопе txn - это вся транзакция целиком Ну либо в целом персистентные то есть это переменная Мы в переменную складываем текущее количество запросов всех в секунду далее следующим этапом мы берм считаем некоторое случайное число Обратите внимание R - это Converter есть большое количество converters в настройки которые вы можете использовать Там вся арифметика и Ну некоторые базовые вещи типа вот генерации случайных чисел для чего мы используем здесь а для того что следующей следующим конвертером RS остаток отделения на текущее число rps Да и таким образом мы получаем некоторое случайное число которое находится в диапазоне от нуля до количества текущих запросов в секунду на сервис далее подключается AC Мы в AC указываем что мы считаем систему перегруженной если текущее число запросов в секунду превышает 100 а следующей строчкой unlucky мы сравниваем наше случайное число больше или равно устано или нет И таким образом предположим у нас 150 запросов в секунду сейчас на нас летит 100 запросов наш предел если случайное число это оно между нулём и числом и 150 получилось выше или равно 100 мы считаем что ой данный запрос неудачный и этот запрос мы с помощью следующей команды можно на самом деле сделать чуть проще я показал более расширенный вариант который позволит вам сделать отдельную кн секцию Возможно с какой-то красивой страницей Возможно с перенаправления на какой-то дополнительный сайт где вы сможете клиенту попросить подождать Ну записать какую-то информацию оть всё что угодно ну и наконец все те клиенты которые Обратите внимание в условии If overload Lucky подразумевает и все Дан случае и мы используем 429 Если система сейчас перегружена и если только если запрос оказался Ну не столь удачным и соответственно мы большую часть клиентов продолжаем обслуживать как обычно Итак мы разобрались с первой из трёх частей основа всей методики основа это не очень уда но надеюсь вы поняли о ЧМ собственно говоря о не если нет я готов ответить на ваши вопросы чуть позже второе это не они используются в доступе Да но это скорее некие внутренние переменные которые вводятся по условиям Вы можете их использовать в в условных выражениях и собственно сами переменные переменные напомню бывает в нескольких скоупа это запрос ответ транзакции там более крупные скопы более персистентные в нашем случае нам достаточно Скопа request Ну это обычная перемена можете называть её как хотите вы можете хранить в ней что хотите и выполнять любые операции с помощью каких-то функций предоставляемых а прокси Давайте перейдём ко второму шагу а командная работа а давайте а о чём мы будем говорить Во на второй главе Мы немножко поменяем нашу схему А я убрал все лишние кружочки с IP Gateway и прочим и прочим я ставил H прокси бэнды и добавил второй H Проси Ну скорее всего у вас и будет какая-то приблизительно такая конфигурация для одного сайта потому что один балансер - это ненадёжно он машина может выйти из строя или вам просто не необходимо производить какие-то технологические действия у вас будет два-три возможно больше а Итак у нас есть два hpy Мы хотим всё так же ограничивать трафик не допустить перегрузку кэндо но а два Давайте посмотрим как к этому подойти для того чтобы работать с несколькими инстанциями в H Proxy есть а так называемая пер секция конфигурация РС секции что это такое вы прописывает РС секцию с их адресами Обратите внимание что в данном случае я первый сервер tb1 S1 S1 - Это первый сайт у нас будет второй сайт Т третьем разделе он его у него можно не указывать адрес можно указывать Ну подскажу в принципе вы сами прекрасно понимаете что все эти конфигурации конечно генерируются автоматически должны генерироваться автоматически вряд ли вы будете руками прописывать все адреса но тем не менее для примера мы прописываем руками и в эту перс секцию мы прописываем несколько серверов а также прописываем две стики Стик таблицы tlb 1 S1 и tlb 2 S1 эти Стик таблицы очень похоже на то что мы видели на предыдущем шаге с разницей ли то что они будут хранить не од секунду число а 5 секунд потому что есть некоторая задержка синхронизации между инстанса Давайте просто немножко усредни эту скажем так снизим эффект работы по сети между ними и будем хранить среднее собственно говоря средний request за последние 5 секунд То есть это как бы не rps а каждые 5 секунд О'кей разобрались на самом деле здесь есть два очень важных момента первый важный момент а H Proxy Север когда сохраняет новое когда обновляет Стик таблицу отправляет всем Пирам уведомления о том что Стик таблица обновлена и новое значение такое если у вас несколько инстан сов hpy Проси серверов будут обновлять одну и ту же Стик таблицу они будут перезаписывать друг друга Ни о какой синхронизации на самом деле здесь речи не идт здесь речь идт Ну точнее идт она односторонняя здесь система и тот HP который обновил таблицу уведомляет всех остальных Именно поэтому таблицы две а не одна и второй момент Обратите внимание что обе таблицы находятся в рамках одной секции то есть уже не обязательно использовать отдельные н секции по одной Стик таблице на секцию здесь Всё в рамках pce Вот это тот самый момент который я обещал показать чуть ранее Итак как это выглядит в конфигурации фронтенда Посмотрите пожалуйста Ну во-первых то что изменилось - Это адрес таблицы да то есть мы делали http request TR sc0 Always True и всё сейчас мы добавили куда конкретно С какой таблицей мы связываемся это table tlb pierce tb11 для второго балансера здесь будет соответственно вторая таблица опять же повторюсь а конфигурации для данной методики лучше генерировать Ну в джинджи или в чём угодно как-то Так дальше мы опять же устанавливаем переменное кружение Обратите внимание их уже две а и Обратите внимание что мы делим на пять чтобы снова вернуть нас к нашему rps запроса в секунду То есть 5 секунд среднее мы храним делим на пять получаем среднее в 1 секунду и опять же мы считаем суммарный rps в третьей строчке как совокупность переменной первой и переменной второй и опять же мы находим остаток отделения случайного числа на этот суммарный rps для того чтобы определить Ну какой-то неудачный Запрос который нам придётся отбросить в случае необходимости всё остальное точно такое же то есть важные моменты какие первое значит я показывал что там есть секции обратите пожалуйста на это внимание лучше всегда его указывать потому что иногда возможно Ну некоторые Странности и лучше вам с ними не сталкиваться второе между балансера можно включить tls то есть в нашей конфигурации обмен между балансера проходит по формате Я даже не знаю на самом деле что там внутри какой-то свой проприетарный формат но он не шифрованный Если вы обменивает Балан которые находятся вне локальной сети или вне доверенной участ сети пожалуйста Пользуйтесь это можно сконфигурировать Посмотрите документации там об этом подробно расписано и третий момент балансер не синхронизируют перезаписывает таблицы это самое важное тот кто поменял отправляет всем своим соседям и они просто меняют значение дава перем сказать саву а лбк на второй сайт в данной главе мы а ведём совершенно уже сложную конфигурацию вот столько много стрелочек у нас появляется второй сайт на втором сайте ровно такая же картина как на Первом сайте Но предположим что наши сайты находятся в разных регионах Ну например один там в Питере второй например в том же Владивостоке да под ними лежат одни и те же Ну не одни и те же но одного и того же типа бэнды и в принципе мы можем распределять трафик между этими бэнда Ну конечно мы так делать не хотим потому что зачем пользователям из Москвы идти во Владивосток а пользователям из Владивостока идти в Москву когда это довольно странная идея они быт быстрее обслужены локальными сервисами но могут возникнуть ситуации как мы говорили нас у нас новостной сайт Да вот новостная какая-то А на фоне новых новостей поля пришло в п раз больше людей и да в этой ситуации наши местные сервера не справляются и мы бы хотели Мы бы хотели воспользоваться ресурсами удалённой площадки потому что ну она простая это может быть также очень сильно связано с часовым поясом например в одной локации у вас все люди ещё спят во второй уже проснулись и читают новости и вы Хоти эв оче хорошая методика потому что она позволяет вам не доплачивать дополнительные какие-то деньги сервис провайдеру а просто использовать ресурсы в разных площадках которые у вас всё равно есть потому что вам нужна географическая отка устойчивость вам нужна Надёжность Итак давайте посмотрим как мы можем подойти к этому вопросу наша Пирс секция вообще ничего нового практически также всё выглядит как в нашем предыдущем разделе просто добавляются два новых сервера которые на S2 tb1 S2 and tb2 S2 всё остальное ровно точно такое же смотреть наверное здесь нечего ещё раз напоминаю про Local секции эн секция это первый раз наверное Ну почти первый раз кроме 429 энда который показали для примера где мы е умина здесь у нас их появляется несколько Почему Давайте посмотрим сначала на нижнюю секцию backend be All sites в ней перечислены все наши сервера кластера а или сервисы Неважно как это назвать доступные нам в обоих сайтах одновременно то есть эта секция у вас будет идентично на всех H Proxy всех сайтов в ней перечислено просто всё для чего эта секция нужна вот там важный момент default Check указан это говорит о том что у вас включены проверки доступности всех этих серверов эта секция нужна для того чтобы проверять доступность для того чтобы вы знали сколько серверов у вас сейчас живо доступность может проверяться очень по-разному в КСЕ это конфигурируется множествами способов Вы можете а написать какие-то свои кастомные а респондентом будут отвечать я не знаю кастомными лисами ещё чем-то чем угодно здесь очень много опций но вы должны знать сколько серверов у вас действительно доступно и отвечает И они все в одной секции А вот вторая секция более интересная B Local Site в нашем случае мы смотрим на сайт один в качестве примера и мы видим что у нас здесь указано всего лишь два Ну кластера или сервера или сервиса и указано к backend секция имя сервера Таким образом мы проверяем живость доступность сервера только в секции All S а используем этот сервер уже в другой секции а его статус Ну автоматически будет привязан вам не придётся множество раз ходить и опрашивать сервера потому что с этим как раз может могут быть проблемы если у вас предположим десятки тысяч серверов один инстанс балансировщика и так будет делать много работы потому что проверять живы они или нежи и лучше сэкономить это время итак у вас есть секции одна смотрит на живые сервера текущего сайта вторая на все сервера И как мы это используем во фронтенде сейчас Прошу прощения немножко длинно здесь Но на самом деле ничего сложного а длинно потому что пришлось вместить все четыре инстанса прокси логика вся та же самая Обратите внимание мы всё также сохраняем информацию о текущем уровне запросов текущего инстанса в таблицу tlb pierce tb1 S1 То есть это таблица текущего инса H Proxy второе а мы считаем четыре переменные четыре переменные привязанные к запросу из каждой из четырёх таблиц а далее пятое мы считаем rps One Это rps на первый сайт в данном случае складываем две Да потому что мы знаем нару текущего сайта второй сайт посмотрим как мы это дальше используем и также мы считаем суммарный rss плю rps второго сайта опять же если у вас будет больше сайтов больше HP генератор вам в помощь писать эти файлы руками совершенно нет никакой большой необходимости и далее мы считаем в переменную говорит сколько живых серверов доступ то есть на данном локальном сайте сколько у нас сейчас здесь живых серверов считаем среднюю нагрузку в rps на один живой сервер доступный на текущем сайте и А вот далее подсвеченный синим очень интересный момент который я упоминал в самом начале за заголовок как он называться будет неважно здесь он назван xbps с указанием текущего rps на систему так вот этот заголовок будет добавлен каждому запросу и улетит на бэнды и бэнды будут знать текущую нагрузку на систему целиком Вы можете конечно более детально предоставлять это лишь в качестве примера для чего это эн энды могут управля деградировать под нагрузкой если они видят руз очень высокая если они видят что сайт нагружен по самою катушку они могут начать отключать какие-то ненужные На текущий момент функции какие-то рюшечки или там пореже опрашивать какие-то свои уже дальнейшие бэнды снижать частоту опроса или просто хотя бы каким-то образом логировать для себя что это был момент повышенной нагрузки на сайт целиком Очень полезная нужная функция Так мы посчитали среднюю нагрузку на локальные среднюю нагрузку в запросах в секунду на сервера на один сервер находящийся локально на данном сайте и опять же у нас два Да это мы сравниваем сколько нам необходимо серверов живых локально предположим у вас Ну например там 10 серверов есть из них живы наверно вы не хотите всю нагрузку кидать натри остав сервера может и хотите в нашем случае мы считаем что нужен хотя бы оди ВТО у на счи сравнивает количество среднее количество на сервер с некоторым числом скорым лимитом нашем случае это 50 у нас было как бы два кластера Мы считали Ну так до примера и нагрузка на сайт Ну 100 запросов в секунду и мы посчитали что хоро на один ластер на один сервер мы в этом случае идм на Local на на локального сайта То есть если всё хорошо если нагрузка ниже нормы ниже предельной нормы ниже предела скажем так если количество серверов достаточно мы используем только сервера локального Пула если это не так то первая строка Обратите внимание can All S Это означает что в этом случае мы говорим ой всё А вот у нас там есть все сервера Ну делай что-то иди туда как-нибудь на какие-нибудь живые распределять это на самом деле конечно а упрощение конечно в этом случае вам нужно будет добавить ещё результаты из наших предыдущих глав и А Начать сбрасывать трафик превышающий нагрузку Я не стал добавлять это сюда во-первых к вам как домашнее задание во-вторых Ну просто на экран уже всё это плохо входит и плохо читается но тем не менее Вот посмотрите что получается в данном случае а если у вас на сайт один летит маленькая нагрузка он всегда обслуживает все вещи локально если нагрузка превышает допустимые пределы Либо вы просто выключили там сервера например или кластера погасили на этом сайте у вас нагрузка автоматически улетит на соседний сайт вы ничего для этого не делаете У вас вся у вас везде работает автоматика и таким образом на самом деле секции может быть конечно же не две их Ну как минимум три интересно держать и интересно работать с Весами то есть Если в рамках первого секции вы работаете только с локальными серверами в рамках второй секции Вы можете начать подмешивать сервера из соседних недалеко находящихся локаций и в рамках трети или я даже не знаю какой-то послед Вы можете держать их все от ва как вы будете распределять нагрузку по каким параметрам тоже зависит только от вас важно знать значит ещё раз может быть несколько н секций как я сказал заголовки которые я показал Пожалуйста вот в качестве домашнего задание Добавьте к заголовки с какими-нибудь интересными показателями работы вашего балансера Вам самим же будет интересно это смотреть на энде это очень полезно и вы можете их отправлять в журнал в том числе как так И Наде какм будет угодно Ну и все данные можно отправить в логи да то есть очень хорошо конфигурируется в форматы журналов они сейчас есть разные jy и его родные пожалуйста Добавляйте все нужные вычисления туда и вы будете знать текущую нагрузку на вашу систему целиком и как она распределена между сайтами на этом У меня Пожалуй что и всё теперь я жду пожалуйста ваших вопросов Всем привет ещ раз посмотрел какие-то интересные вопросы в чатике я ну по теме доклада честно я ничего не увидел поэтому я задам вопрос сам а вы всё ещё можете задать вопросы Да я продолжу тему про начинающих сырье Вот и как мне кажется Э тема была полезна тем компаниям которые в России Ита както прово проблема Я услышал что можно как-то перенаправлять трафик между локациями Да если у вас их несколько в современном мире их должно быть несколько и очень понравилась Киллер сича которая позволяет сообщить э бэнде с настрой разработки что к нам пришёл какой-то большой трафик чтобы они попытались что-то с этим сделать вот я правильно понял Максим что Это хороший инструмент Вот наси получается можно на программировать очень много сценарий включая вот борьбу как бы такой кирпичик борьбы с последствиями ддоса да Безусловно на самом деле можно строить даже шало нерону систему ну некоторой такой защиты от deos с помощью Proxy потому что как я с самого начала сказал система очень быстрая она требует мало ресурсов поэтому она позволяет обработать большое количество трафика Вы можете строить условно Эшелон где На первом этапе у вас будет какая-то конфигурация которая предположим либо задерживает либо блокирует излишних клиентов и уведомляет о текущем состоянии Ну скажем так нижележащий прокси или энд А и Ну в общем да то есть здесь можно наворотил использовать в качестве условий именно количество запросов в секунду Вы можете более того А вы можете например использовать количество запросов Но для каких-то конкретных а URL например Так тоже можно Например если у вас есть какие-то тяжёлые ручки на которые пользователи ходят но а при этом резко появилася какая-то атака и эту ручку начали активно эксплуатировать при этом весь остальной трафик у вас не меняется Вы можете например выхватить только этот кусочек и уже по результатам вот этих замеров проводить какие-то действия с блокировкой пользователей либо с деградацией сервиса Если необходимо хорошо Ещё раз огромное спасибо что ты пришёл подготовил для нас такой замечательный доклад и давай вот простенький вопросик вот мы все любим и умеем пользоваться Проси там есть понятные настройки он по-моему на 7 да то есть он может у нас балансировать не только htp но и там РПЦ Там сокеты и так далее В общем как вот я не увидел вот команд Как реализовано именно переход в случае ошибки на экстрим То есть он классен тем что там есть чеки А между чеками Как происходит переключение трафика в случае если мы можем как-то увидеть Като ответа то есть получается нам нужно увидеть а чеки на самом деле в в ха прокс существует двух типов он может просто задавать какие-то Если мы говорим про http сервисы Ну в целом да то есть на самом деле H Proxy Он ведь работает не только с http но он в целом может работать с любыми tcp сервисами Ну для для простоты мы говорим про http и в http с одной стороны чеки Могут просто дёргать какой-то адрес какой-то ручку и смотреть на статус ответа или на текст ответа и уводить сервис сервер в статус да Или вверх и на самом деле не только так у сервера же ещё есть вес в любом Ну у любого балансера при распределении трафика у каждого сервера либо кластера Ну какого-то бэнда у неё есть веса и вот эти ручки проверки живости они могут в том числе сообщать и вес текущего бэнда То есть например если сервер чувствует перегрузку он может понизить свой вес до чтобы получать поменьше трафик эта динамика тоже работает но единственный совет Что с этим нужно быть очень аккуратным потому что в случае больших перегрузок случай когда приходит много пользователей А все серверы норовят себя тут же сделать свой вес равным нулю и на этом как бы работа всего сервис останавливается полностью потому что ну ну всё всё сломалось А и есть ещё второй вариант Когда вы пишете прямо свой собственный респондент быть Сколь угодно сложное приложение и Сколь угодно часто вы можете взаимодействовать с балансера и оно будет сообщать о том Ну о текущем статусе там энда и даже ещё один есть интересный момент появившийся в третьей версии я его в жизни честно скажу не пробовал но читал что у них это появилось один КСИ может регистрироваться в другом пкс самостоятельно динамически есть это очень хоро помогает в современных системах вы можеть которые при этом ещё и одна в другой автоматически регистрируются супер а большое спасибо за ответы Котин Большое спасибо тебе за роль эксперта"
}