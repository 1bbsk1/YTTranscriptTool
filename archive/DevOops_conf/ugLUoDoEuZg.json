{
  "video_id": "ugLUoDoEuZg",
  "channel": "DevOops_conf",
  "title": "",
  "views": 0,
  "duration": 0,
  "published": "",
  "text": "а Всем привет Меня зовут Вадим цычко Я ведущий разработчиков платформе Одноклассников и хочу представить Ивана Буйнова Иван Мой коллега он ведущий системный администратор в Одноклассниках в Одноклассниках он уже больше пяти лет видел всякое Ваня большой пропонент питона го любят все автоматизировать фанат механических клавиатур Какая у тебя любимая но мне любимых Пока нет я 87 и сегодня Ваня расскажет про Волк в котором мы храним секрет в Одноклассниках и больше даже не про сам волк про то как мы его сделали надежно масштабируемым Да все так отлично что и передайте слово спасибо да Давайте тогда начинать расскажу еще раз про себя Всем привет Меня зовут Иван Я работаю в it уже порядка 10 лет последние четыре года из них в Одноклассниках Ну Вадим посчитал что 5 возможно 5 занимаюсь люблю заниматься различные автоматизацией пишу на pythony немного пишу на Go и на вот этой фотке чиню Production на одном из корпоративов в другой компании чем мы сегодня будем говорить Сначала я расскажу про то как построена в целом глобально в Одноклассниках инфраструктура чтобы Мы понимали были в одном контексте Потом расскажу как мы построили интеграцию Валта с нашими системами всеми которые у нас есть расскажу про отказ содов И масштабирование как мы научили волт переживать все это и научили его масштабироваться про проблемы с которыми сталкивались во время все этой процедуры И что в итоге получилось Ну и Конечно отвечу на вопросы надеюсь на них останется время значит что сегодня из себя представляют Одноклассники это десятки тысяч контейнеров в нашем собственном облаке Ван Клауд про которые есть кстати отличный доклад на этой же самой конференции в семнадцатом году Олег анастасиев очень рекомендую посмотреть у нас свое облако не кубернетис также у нас порядка 10 тысяч железных Huawei серверов и все это расположено в семи разных центрах мы придерживаемся довольно жестких стандартов для запуска всех наших сервисов как правило все сервисы запускаются с Application фактором 3 как минимум Да в разных содах это нужно для того чтобы мы могли спокойно переживать отказы до центров вот на моих четырех годах уже были пожары в целых было что-то еще то есть отказ соды это не такая уж редкая вещь как может показаться центры спокойно полностью выключается Да и мы можем спокойно все это переживать Потому что когда мы запускаем Новый сервис У нас есть обязательно тестирование отказа цода сервис часть сервиса в одном цеде выключается Полностью мы смотрим Что хватает ресурсов Час пик и что все все переключения отрабатывают штатные и так далее также важный момент то что все изменения которые происходят в продакшене это касается выкладки новых версий на софта обновлений нового кода и всего чего угодно оно происходит плавно то есть Сначала мы выкатываем какое-то изменение на один контейнер либо на один сервер Потом на группу контейнеров потом на целиком этот центр и только после этого все это уходит на все цода то есть это помогает нам какие-то проблемы замечать на раннем этапе а не положить весь Продакшен и про это кстати тоже есть доклад мы вообще делаем много докладов можно почитать статью Дима Самсонова о том как вообще работаем с изменениями а какие переходя уже квалту Да какие у нас были требования к системе для хранения секретов когда мы ее выбирали несколько лет назад Ну во-первых это конечно шифрование аудит удобный доступ нужен был для людей машин то есть чтобы был UI для человека чтобы было пи консольная утилита нужно было версионирование и мы хотели интеграцию конечно со всеми нашими системами которые у нас есть в Одноклассниках это наше облако ansibles Engine система конфигурации и самое Да такая важная вещь мы хотели Ну не хотели Мы должны были соблюсти Вот все наши стандарты про которые я рассказывал то есть переживать сот плавные изменения и вот эта вся история походив посмотрев по рынку Да мы выбрали волт на самом деле не то чтобы у него были альтернативы он де-факто стандартам индустрии Да там есть хорошая поддержка стороннего по написано плагины подо все что угодно там Сити поденсе был немаловажно то что это Open Source мы любим код править я про это расскажу под себя Ну и также там отличные есть и консольные утилита и все остальное в общем это все здорово дано нам будет собственно чего-то не хватало просто я буду рассказывать Нам не хватало естественно интеграции с нашими системами чтобы мы не взяли нужно было бы написать какую-то интеграцию совсем что у нас уже есть мы хотели использовать World также для выписки сертификатов нам нужно было каким-то образом научить Уолт переживать отказ содов и нужно было сделать масштабирование давайте начнем с самого начала да что вообще нужно для того чтобы прочитать из Валта секрет Для этого вам нужен World Talking как Ball токен получить чтобы получить vall Talking Вам нужно пройти каким-то образом World модификацию и здесь так возникает вопрос как же нам пройти аутентификацию то есть некая проблема курицы яйца Да Нам уже нужен какой-то секрет чтобы получить доступ к секретам в World как правило это задача решается выбором какой-то доверенное какого-то доверенного источника это как правило себя Сиди там какой-нибудь лап который раскладывает Вам секреты по хостам либо конфигурация менеджмент который там приносит тоже какие-то секреты на хост уже а вот это архитектура World картинка с их сайта здесь можно заметить Да что она модульная у них довольно классная архитектура она построена модулями и каждый из этих кирпичиков мы можем менять под себя там есть много аус плагинов написанных много сторож Back and плагинов и вы можете их менять использовать много готовых или писать свои мы сейчас остановимся на кирпичике аусмет от это вот как аутентифицируется клиенты болт у нас есть клиентов можно разделить на два типа это люди разработчики я программе администраторы Да и какие-то роботы То есть это контейнеры скрипты какой-то код с людьми Все просто Понятно У них есть логин пароль от их учеткивал Да Пилот ходит велдап люди от инфицируются и получают токен Что же нам делать с роботами И серверами для этого в хашикорп Есть огромное количество плагинов Вот они все есть на картинке Да Возможно со временем когда я делал слайды появилась еще какие-то а мы рассмотрим сейчас метод gvt который мы у себя использовали и расскажу Да почему буквально пару слов про то что такое jvt Джейсон токен я буду говорить gvty token Ничего страшного два раза будет токен значит это строчка разделенная точками да она стоит из трех частей заголовок в котором мы описываем как шифруем данные по его вот это полезная нагрузка Где мы можем передать любую информацию и подпись который мы этот токен подписываем Значит как-то все работает мы хотим какие-то данные передать шифруем их приватным ключом Алиса Боб значит Боб может своим публичным ключом проверить подпись и убедиться что вам это все отправил именно Алиса причем здесь Сами данные никак не шифруются то есть в открытом виде но вы можете проверить подпись что это именно Алиса отправила эти данные посмотрим да по сторонам что у нас было Вот когда мы все начинали строить и выбирали Почему мы взяли jvt Да посмотрели по сторонам что у нас сейчас есть в нашей инфраструктуре глобально она делится на две большие части это железные сервера Хв и это наше облако oncloud контейнеры что у нас есть на Хв У нас есть огромное количество серверов и у нас есть 7dbit аббревиатура известная думаю да конфигуречный менеджмент Database это какая-то база в которой у вас хранится информация про ваш инфраструктуру там какие-то набор сетей сервера в каких серверах эти группы В каких группах эти сервера Да и так далее какие-то настройки это может быть табличка у вас хоть какая-то Фишка в сферы если у вас в январе база с которой Можете получать информацию о хостах рассмотрим как мы вообще состоите диплом у нас это делается тоже через и ставится наливается операционная система Здесь есть такой интересный момент что во время диплои у нас на серверах уже генерируется для ssh приватные ключи то есть они там уже были всегда Да так работает тепло и мы всегда сохраняли все индивид в личную часть ключа соответственно Как происходит в анклауд там где никакого нету там запускаются просто контейнеры их диплоить как операционку не нужно поэтому у них готового секрета нет Да там Клауд мастер есть который управляет всем жизненным циклом контейнеров и там через команды под Монро он запускает контейнеры и также во время запуска Мы можем поставить какие-то переменные окружения передать при запуске В контейнере когда мы все на все это посмотрели да оказалось так что у нас для использования gvt Все уже готово то есть нам не нужно делать вообще ничего нового У нас на всех серверах уже есть вот те самые секреты приватные ключи от ssh которые можем пользоваться И также у нас есть публичные ключи которые можно эту подпись проверять они все лежат Биби И также у нас есть полезная нагрузка то что мы можем передать falload эта информация о серверах которых он относится к группе что это за хвост какие у него сети и так далее сервер может себе такой же ребятишку легко создать у него есть доступ к приватному ключу ssh и он может себе сгенерировать желети облака так сделать не могут поэтому мы решили что мастера облака будут выписывать gvt для контейнеров и класть их на запуске соответственно нас для этого все было да и секрет для доступа к секретам в нашем случае это jvt Talking доверенными источниками мы здесь выбрали 7db и мастера Ван клауда у нас не появилось никаких новых сущностей Да и нам не нужно поддерживать никакие новые решения то есть мы взяли все готовое и использовали Это для того чтобы через gvt проходить аутентификацию клиентов в алте Поэтому соответственно мы выбрали именно вот этот метод Как работает gvt World с коробки Да этот метод как вот я показывал слайд он уже готовый Да но там не все так просто Включите любой метод можно вот через команду enable Да по какому-то пути вы включаете способ аутентификации Клиент заходит но конкретно gvt есть три способа которыми проверяется подпись ключа это кстати кейс да чем он плохо там все ключи публичные которые происходят проверка нужно хранить непосредственно в конфиге То есть Вам нужно прямо в World записывать прям конфиг вот эти все у нас там сотни тысяч серверов до нужно хранить в одном месте все эти тысячи ключей как-то их обновлять за этим всем следить не очень удобно есть также ВКС это в принципе та же самая история только Вам теперь нужно этот огромный список ключей пихать не сам волк А давайте по какому-то любому урлу то есть что здесь плохо да также нужно список поддерживать каким-то образом за ним следить и здесь даже еще хуже Да потому что это список нужно постоянно гонять по сети то есть у вас на каждую авторизацию клиента аутентификацию должен полететь запрос туда в игры вытащить огромный список Там могут быть мегабайты данных вот этих вот ключей Да и плюс там в обоих этих способах очень сомнительный механизм проверки для подписи это код из Валта до который у них используется то есть там берется просто весь этот список на наши сотни тысяч ключей и по ним просто бегает цикл пока не найдет нужный ключ но это там не просто for и там криптография то есть нам вот это всё не очень понравилось а да и Последний Метод это IDC Discovery это в принципе уже что-то получше мы его рассматривали изначально как основное решение там нет проблем с тем что мы бегаем по сотням ключей что мы их должны где-то хранить И поддерживать Да все хорошо но там была проблема с тем что во-первых нужно написать это топа Найди сервер у нас же все свое естественно мы не можем там через github использовать Open ID или что-то ещё и здесь нужен клиент то есть его по Найди работает таким образом что клиенту отдается ссылка Клиент по ней переходит и таким образом происходит аутентификация умного клиента Мы тоже Делать не хотели соответственно так как все равно нужно было что-то писать вот в этом случае сервер то мы решили что мы можем собственно написать все сами А ну и да минусы всех вот этих трех способов это очень важно что Заранее нужно создавать роли у нас в Алтея есть ролик на которые выписываются политики и все эти роли они создаются заранее их нужно руками создавать Да и политики в эти роли вшиты То есть вы создаете роль вы не вшиваете набор конкретной политик и все это нужно тоже поддерживать Мы решили что мы сделаем все это сами так как модуль это сделать позволяет И вот блок решили сделать свой немножко расскажу про политики тоже быстро чуть-чуть теории Да Уолт есть токен и в этом токене лежат две важные вещи которые нам интересны вот жирным текстом выделены это политики набор политик и метаданные здесь важно то что вот эти вот политики и метаданные Можно потом использовать в аудите можно использовать их шаблонах для выдачи прав то есть это нужные хорошие полезные данные и мы бы хотели эти данные иметь возможность задавать какие нам нужны во время выписки токена то есть не брать их хардкодные из роли а управлять ими динамически а в политиках там есть собственно пути и права да политика очень простая вот возьмем какую-то политику для сервера У нас есть сервер какой-то срвд 134 и у него есть политика с именем с РВД 1 3 4 Ямал здесь мы видим да что мы хотим дать просто серверу доступ к всем секретам по пути вот этого сервера там с РВД слэш и там какие-то секреты лежат и мы хотим чтобы сервер мог читать все эти секреты Но когда у нас появляется там еще еще сервера какие-то 10100 мы очевидно Не хотим для каждого сервера писать новую политику собственно хашикор всё это уже за нас решил и можно использовать шаблоны как раз таки в шаблонах мы можем брать информацию из метаданных из политик которые стоки то есть использовать переменные Мы можем взять допустим переменную hostname назвать да метаданные положить и у нас все наши сервера можно смотреть на одну политику которую мы там назовем например хвост и нам уже достаточно будет одной политики и каждый сервер сможет считать секреты из конкретного своей директории а вот да Так это выглядит То есть у нас вот видно оранжевым что хосным метаданных есть и Мы это можем использовать но как бы Когда вы берете просто готовый gvt плагин вас там ничего данных не будет вам нужно каким-то образом доставить внимательные слушатели мог заметить Да что у меня примеры политик на ямле написано но хаш-корп использует хз или Ямал Почему мы взяли Ямал мы посмотрели доклад Юрия шуткина вот ниже ссылочка про World тоже и нам понравилось их идея что они все хранят в Лям Ли они в цели а потом просто конвертируют во время раскатки политик чем это хорошо во-первых тем что у нас Ямал уже всю индустрию так захватил до вас везде Ямал там где угодно везде Ямал поэтому людям Они все привыкли и мне нужно еще один новый индекс осваивать плюс Ямал выглядит гораздо компактнее если вот внизу есть пример Да когда слева это четыре строчки справа одна строчка у нас как правило почти все доступы которые мы даем это чтение соответственно мы можем сделать так что дефолту Если только пас указан победите 100 это будет право на чтение и мы можем в одну строчку выдавать такие доступы они в четыре строчки на цель Как работает собственно схема аутентификации стандартная и наша стандартная схема даст gvt плагином дефолтным есть клиент он присылает волт Живите токен на какой-то энпоинт gvt-login вот ему сразу же отдает готовый токен вот при этом политиками здесь занимается Уолт и он их берет из захардкоженного списка в роль То есть у вас есть какая-то роль которая вживите улетает и вы получаете вот конкретно за хардкоженный список политик если Вам их нужно поменять вам нужно делать новую роль либо это роль редактировать в нашем случае да у нас также клиент посылает gvt только это все улетает не на штатный плагин а на наш плагин дальше наш плагин ничего не делает он просто проектирует запросик в наш сервис который мы написали для валидации этот сервис проверяет девятишку Как я рассказывал приватным публичным ключом db до проверяет что это тот самый хост который прислал с Индией тоже сверяется эта информация и дает набор политик причем здесь мы во время того как наш сервис Это только eudiation Service он может всю информацию все метаданные все политики вот все что мы хотим имя Хоста группа там все что угодно подставить в политике то есть мы получим динамический на лету наш сервис эти политики может генерировать по любым нашим правилам а что такое собственно этот плагин Это кот на Go небольшой бинарник соответственно вот еще классно работает с плагинами там все сделано секьюрно в том плане что вы не можете просто на файловую систему подложить другой бинарник и чтобы ну то есть там злоумышленник захочет Да написать какой-то бинарник положить его чтобы он там все вам разрешал делать Увал там вшит США конкретного бинаря в конфиг и чтобы туда записать США нужно уже аутентифицироваться то есть нельзя сделать со стороны и наш этот плагин основан на штатном валтовом плагине мы там написали буквально немножко до кода собственно сейчас покажу пример Ну да там код просто который проксирует Что такое сервис валидации это код на pythony он проверяет подпись gvt сверяет все данные с mdb генерирует политики и передает все это обратно в World да вот собственно Так выглядит код который мы добавили в штатный плагин там вот 33 метода про которые рассказывал опыта найти там статики сет мы добавили просто еще одну функцию вот она это прям Весь код практически Да там просто делается токен который получает волк Сам он просто отправляется вот обычным запросом можете теперь наш сервис и в ответ этого сервиса мы получаем набор политик вот это вот самый важный момент который мы хотели получить что мы вот здесь политики можем сгенерировать какие угодно в этом сервисе по любым правилам то есть если мы захотим чтобы у нас там все сервера у которых первая буква А например получили доступ к какому-то секрету мы там допишем небольшой блок кода и у нас сразу же заработает нам не нужны никакие новые роли создавать ничего делать Я очень много про дживити рассказываю Да Откуда же эти gvt вообще у нас появляются на хостах мы сделали свою библиотеку небольшую для работы с World она основана полностью на хвок это дефолтная либо для Python которую opensort Да мы добавили там совсем немножко логики туда поверх хвака дописали механизм для того чтобы генерировать gvt то есть там с помощью Вити просто подписывается приватным ключом 9-шка и на Хосте получается Файлик с gvt также мы там придумали написали механизм для того чтобы можно было токены продлевать и мы эту либо ставим сейчас на все наши сервера во все контейнеры и собственно благодаря тому что у нас есть это либо на пайтане мы это используем абсолютно повсеместно то есть мы написали локап плагины для энце было мы написали для CF Engine поддержку кстати кто-нибудь знает что такое CF Engine О да две две руки в зале Это неплохой результат CF Engine это система управления конфигурациями что-то вроде Пап это только намного старше Мы у себя Да мы у себя еще его используем в каком-то виде Ну и также любые скрипты то есть любой разработчик он там Если хочет написать вы пишите просто какой-то скрипт вам нужно там секрет сертификацию что угодно вы делаете там импорт логин все то есть разработчик не должен сделать вообще ничего У него все готово вся логика по тандефикации она уже библиотеке наша есть а как же до jvt появляется на хостах и Ну еще раз мы посмотрим Просто Как это работает от paywalt наша либо она подписывает животишку приватным ключом который на каждом Хосте уже есть и у вас скорее всего тоже у всех такой Файлик на хостах лежит мы набираем волт логин вот логин это часть библиотеки от paywalt Значит она читает просто приватный ключ генерит Джейсон для полезной нагрузки для jvt и собственно отправляется Это Волк и мы получаем в ответ от волка набор политик причем вот этот набор политик мы получаем динамический для конкретного Хоста в него уже входит конкретная группа в которой он стоит там дата-центр что это железный хост и так далее То есть куча полезной информации которую мы можем потом использовать в выдаче доступа и вы увидите мы получаем токен в случае с облаком то же самое все только девятишку генерит не сам сервер а Ван Клауд мастера мастера это тоже железные сервера у них тоже самое история у них есть приватные ключи и на старте контейнера мы кладем просто в переменную Cloud gvt Talking готовы gvt-шку и дальше все то же самое Да получаем токен значит как это все работает в итоге для клиентов есть контейнеры сервера они отправляют 9-шку в World с полезной нагрузкой до дальше наш сервис генерит наши нужные нам политики по нашим правилам отдает все это обратно и клиент получает токен со всеми политиками которые мы получили динамически как мы раскатываем политики по серверам все модно стильно молодежно Значит у нас там все лежит где правит политики админы безопасников есть доступ к изменению политик все это кладется в Гид после этого естественно нужно какой-то опрос получить от тех людей которые могут отправить У нас тоже все обменные безопасники потом Сити видит изменения в бите и разливает все это по болту значит что у нас получилось в итоге вот с этой схемой с нашей аутентификацией у нас полностью отсутствуют какие-то ручные операции по созданию ролей то есть мы когда ставим новую группу серверов новые контейнеры появляются в Облаке все что угодно новое Да мы не идем не создаем новую роль руками в волте чтобы выдать права у нас это все происходит автоматом то есть политики приезжают автоматом с любыми там именами которыми новых серверов сделали также у нас Наши все приложения которые используют секреты они никак не то есть разработчикам не нужно никак модифицировать код приложений потому что все болтовые токены они уже сразу же лежат на хостах то есть в контейнерах на серверах и так далее То есть приложение стартует у него уже там Готовы а также у нас вот до динамические политики мы получили удобный аудит потому что мы подставляем свои метаданные и мы получили за счет библиотеки вот этого вот интеграцию Со всеми нашими системами эмсиблами и прочим таким образом вот собственно мы проблема с интеграцией порешали и аутентификации дальше расскажу Про выписку сертификатов болт умеет все это из коробки Let's cript всех нас научил что сертификаты можно выписывать очень быстро удобно Да мы захотели у себя то же самое сделать через волт там все это да Есть такие Engine который позволяет описывать сертификаты как мы жили до того как у нас это появилось были разработчики которые хотели себе какие-то сертификаты на серверах они писали запросы в жиру потом админ генерил за них CSS специальную потом безопасник это CSS подписывал потом получался сертификат потом админ забирал жиры Потом значит клал это все в Гид и потом только гид все это раскатывал по серверам соответственно здесь в этой схеме все плохо да Тут участвует три человека здесь куча рыночных операций и естественно на каждом этапе это может занять определенное количество времени хорошо то что волк сертификаты выписывать умеет сам по себе Для этого ничего не нужно модифицировать просто включаете Engine можете выписывать сертификаты также хорошо то что вы можете использовать вот шаблоны до про которые говорил в путях секретам но оказалось внезапно когда мы начали все это внедрять что вот эти вот шаблоны которые вы можете использовать путях для секретов вы не можете использовать шаблоны доменов непонятно почему да то есть мы хотели бы выписать не на там можно использовать звездочки Вот как на слайде зеленым а то что красным так использовать нельзя Мы бы хотели не ставить звездочку О круто выписывает на конкретные имена потому что у нас есть конкретно мы можем идти переменные там DC сервис Да у нас это лежит метаданных Мы эти переменные можем использовать но почему-то волк позволяет делать это на доменов и вот такие вот вещи выписывать было нельзя только со звездочкой нас не устроило И вообще было довольно удивительно что это так потому что там механизм Один и тот же Казалось бы мы пошли поискать решение мы не сразу все пишем сами Мы конечно смотрим Если что-то готовы да и мы нашли похоже квест болте Он уже был помогли много за этот квест боролись там пинали автора В итоге все сами поправили как надо вот Артем Александров да это еще было в далеком 2020 Это был первый наш квест и теперь собственно фича его смёрзли приняли Да теперь можно выписывать вот использовать переменные Везде они только в путях но и в именах доменов это фича всем понравилась она оказалась востребована и хаш-корд даже порнули ее в прошлой версии соответственно Вот Вы сейчас можете тоже этой фичи пользоваться и использовать не только звездочки но и подставлять переменные Да мы это используем абсолютно повсеместно Вот пример там какой-то политики Да у нас абсолютно все контейнеры когда стартуют они сразу же на старте получают себе сертификат на полностью свое имя на там имя сервиса еще какие-то имена то есть Там есть целый набор сертификатов И для этого абсолютно ничего делать не нужно соответственно всю эту схему мы выбрасываем да у нас теперь есть просто контейнеры и сервера они хотят сертификат просто твоего болте и вместо часов дней мы получаем сертификат за миллисекунды и без ручных операций таким образом сертификатами тоже У нас все стало хорошо дальше с теории Наверное мы заканчиваем остается самое интересное на мой взгляд часть это про отказ содов И про масштабирование что мы с этим сделали посмотрим на стандартный кластер который вот если открыть просто сайт Там будет такая картинка сейчас там уже по моему не консула что-то другое но не имеет значения У вас есть несколько нот до вал там и у них есть какое-то хранилище в данном случае это консулу вы можете поднять сколько угодно НОД они образуют у себя кластер то есть там как будто бы ха из коробки Казалось бы но что здесь на что важно обратить внимание что плохо здесь всегда Вот в этой схеме будет активным только одна нода То есть вы можете поднять 3 болта 5 болтов сколько угодно активный будет только одна нода и стендбай которая здесь желтеньким Да они запросы никак абсолютно не обрабатывают на стендбай ноды исключительно запросы проксируют на Мастер и все То есть у вас вся нагрузка все приходится только на одну единственную активную ноду то есть здесь ни о каком масштабировании речь идти не может Ну и также здесь непонятно что делать с нашей системой когда мы хотим обновлять что-то плавно То есть если мы хотим версию болта обновить мы не сможем это сделать плавно потому что у нас одна активная нода если мы обновляем то как бы все Да у нас сразу же все клиенты идут вот в эту ноду которые мы Обновили если мы что-то сломали то это затронет сразу же всех нас это не устраивало С чего мы начали Да но мы начали Давайте просто поставим вот как есть потом что-то придумаем мы поставили один один кластер Да у нас был активный кластер в него ходили какие-то первые смелые клиенты которые были готовы что что-то сломается но так жить было нельзя нам нужно было переживать отказывать содов и мы поставили рядом Просто пока что тоже ничего особо не придумывая еще один кластер и у нас получился активный кластер и standby кластер между ними нам нужно было каким-то образом данные синхронизировать да и у нас там был консоль Кейт то есть периодически мы просто синкали данные во второй стендбайк кластер и стала уже получше да то есть мы в принципе теперь можем потерять первый цод и переключить нагрузку на стенбай это получше да но все равно плохо то есть здесь нету честного отказывать сода то есть для того чтобы переключиться на стенбай на стендбай нужно Он сильнуть нужно обратно переключить реплику сама репликация тоже это штука не бесплатная да И нужно мониторить она может ломаться за этим всем нужно следить Ну и также у нас сам Консул был некой проблемой потому что мы у себя в нашем большом проде у нас консула нету И мы не хотели ради только болта притаскивать целую новую технологию там ходить по всем кораблям то есть Консул тоже использовать не хотелось Ну и да масштабирование обновления вот в этом случае со стенбами активным кластером и тоже никакого не получили Мы получили просто возможность хотя бы как-то выжить да если нет сода Пошли мы опять искать по интернету Да если какое-то решение сходили в хэши корм погуглили В общем по решению тоже есть они говорят что можно купить Enterprise версию там все это хорошо там значит есть или заставили центр в общем все здорово оказалось что это стоит очень дорого мы на это от этой идеи сразу же отказались и там еще значит мало того что это стоит дорого они еще в довесок заставляют купить Enterprise consl который нам вообще даром не нужен вот поэтому пошли дальше Да что нам вообще хотелось нам хотелось несколько кластеров и мы хотели вот чтобы у нас было много кластеров и чтобы каждым была активная нода чтобы мы это могли как-то скейлить и чтобы могли спокойно обновлять только часть какую-то и также нам нужно было что-то естественно там были одинаковые данные в этих мастерах потому что секрет это у всех одни и те же их нужно с разных содов получать клиентов и это все должно быть для клиентов прозрачно когда мы говорим вот про какое-то такое масштабирование и разделение да В первую очередь мы должны отталкиваться от того как данные лежат физические где-то на серверах потому что запускать States приложение очень просто сколько угодно где угодно Да там нет проблем но когда у нас речь идет про storage вот здесь нужно разобраться как все можно сделать и давайте я расскажу как волк вообще данные хранит внутри формат зависит полностью от реализации сторож бык-энда и свои бэкенды писать очень просто вот опять же вернемся к этой картинке модульной вот этот кирпичик Stories Back and он тоже отдельно его можно реализовать самостоятельно или взять кучу готовых соответственно у них там все сделано классно есть очень простой интерфейс вот как вы видите у него всего 4 метода если вы реализуете вот эти четыре метода это путь положить секрет до ГЭТ взять удалить и лист 4 метода Вы можете реализовать 4 метода и хранить данные для болта вообще на чем вам угодно Хоть файлах хоть на бересте То есть просто реализуете 4 методы и храните очень просто Давайте посмотрим да внутри что здесь лежит как это лежит на под капотом если взять самый простейший пример сторожа то есть там есть всякие мыс Q или Кассандры консулы все что угодно самое простое что есть это файловая система То есть просто на диске данные это вот кусочек конфига до storage файл и какой-то путь Можете написать у тебя там докер ран указать storage файл и посмотреть как лежат данные вы увидите Примерно вот такую картинку данные разложены по каким-то директориям здесь интересный момент заключается в том что мы эти данные поделили для себя условно на разные части то есть такие данные которые мы будем называть приватными это Например данном случае вот counters и папка Лидер условно папка Что это значит То есть у нас каунтеры и информация о том кто текущий активный Лидер кластеры она для каждого кластера Валта уникальна То есть если у вас есть один кластер и второй да у них у каждого есть свой Лидер это записано вот эта информация в директории у каждого там свои счетчики какие-то количество прочитанных секретов и так далее ну то есть второго кластера эта информация совершенно разные но при этом есть такая директория лоджиков и в ней волк хранит непосредственно сами секреты их значения То есть это то что мы хотим чтобы было общим и вот эти данные будем называть общими и вот это вот директория она как бы должна быть доступна обоим кластерам то есть мы хотим чтобы у нас когда секрет обновился в одном месте он был доступен всем кластерам Болта И что же нам собственно мешает сделать два активных кластера да то что возникает тоже такой парадокс что разным кластерам нужны как бы данные одинаковые но и разные вот мы оказалось что не первые с таким вопросом то есть кто хотел делать масштабирование да и мы нашли ишью на githubby тоже который называется вот Bat истории мультиплета центр сценария с она очень старая 2015 года и здесь пост товарища из хаши-корп я не смогу прочитать его ник но там ребята в Иж ее спрашивали Можно ли как-то у них был Консул и они хотели реплицировать тоже данные кусочками то есть переносить только секреты и оставлять вот уникальные данные да уникальными Вот и вот значит ребята из хаш-корпа подсказывали с решением этой проблемы Они как раз описали здесь в этом посте там ниже можно по ссылочкам походить почитать потом Какие конкретно данные реплицировать нужно Какие не нужно то есть какие там являются приватными какими общими прошло некоторое время когда уже Мы дошли до это ишью и оказалось что она уже закрыта с комментарием о том что теперь эта часть Enterprise и в общем если вы хотите реплицировать то покупайте Enterprise тот же самый человек написал Да который помогал с решением но Значит нам эта идея очень понравилась Мы за нее зацепились и решили что-то такое сделать идея оказалась Вообще супер простая Да мы просто будем возьмем базу данных какую-то любую и будем хранить вот эти вот данные которые мы считаем приватными в разных табличках те которые мы считаем общем в одной табличке мы естественно взяли кассандру Потому что мы Кассандра очень любим умеем готовить все отлично и очень много в продакшене Да и также для Кассандры написан уже готовый Кент даже в алте Ну собственно мы взяли готовые сторож быка для Кассандры дописали там буквально несколько строчек для выбора логики что если у нас это приватный путь то мы кладем в приватную табличку если публичный путь кладем в общую табличку и внезапно это все сработало То есть это работает вот буквально Да мы создаем там кейспейсы создаем кейс например Рен тресс который будет общим и создаем на каждый цод еще по точно таком же кейспейсу но вот там dc-1 до C2 dcm точно такие же точно такие же Таблицы с той же структурой и вот это все изменения которые вот прям Весь код который для этого потребовался то есть мы там где у нас тут просто перед тем как делать базу мы просто проверяем Какое в какую часть пути волк хочет сделать если мы видим что у нас прямо захардкожена там вот эти вот пути если мы видим что это путь приватный то мы пишем табличку отдельно если будет публичный мы пишем табличку общую Ну и то же самое там на get list и так далее То есть это вот весь код буквально несколько строк это все до сработало то есть Теперь мы можем использовать несколько активных мастеров У нас есть каждый кластер может работать с клиентами их обслуживать мы отказались от консула у нас теперь Кассандра которую мы любим и умеем То есть вы можете на самом деле взять любую абсолютно базу данных для нее реализовать такой же вот несколько строк написать кода мы теперь спокойно переживаем отказываться потому что у нас валты абсолютно независимые Да и можем работать с кластерами тоже Независимо обновлять проверять новые функции то есть мы можем один кластер обновить поднять его вторые остальные кластера Никак это не затронет доклад Наверное был бы неполным если я не рассказал бы кучу проблем которые мы походу с которыми столкнулись и которые порешали да самое первое что было еще там в далеком году 2018 или 19 Да когда мы только начинали волк не умел работать солдат нормально То есть если у вас валдапе было Сен написано не капсом а как-то по-другому то это все не работало то есть наш самый первый комит это тоже вот одна строчка от Артема ее тоже приняли это все уже в австриме давно то есть мы починили Элементарно аутентификацию а затем было довольно много проблем вокруг библиотеки госакоэль это единственная либо на гона сколько я знаю которая умеет работать с кассандрой и у них прямо вот на сайте написано большими буквами что она нестабильная Under development оказалось что они не обманывали Да там значит мы починили много чего в кассандре накрутили Для начала просто версию Элементарно в болте которая в зависимости потому что с нашей версии это не работал и со старыми кассандрами со всеми не работала это все тоже smartion да также у этого плагина была для Кассандры очень нескучная документация там документация этого сайта хашикорпа тоже да Connection Timeout и в скобочках у них указано значение по умолчанию Если вы не указываете здесь вот ноль Да есть варианты какой-то тайм-аут если указано у кого-нибудь Вот мои два варианта про бесконечность Да это Отличный вариант Мы тоже так думали что бесконечный Но оказалось что 600 миллисекунд вот ну там буквально это значение прямо за хардко жена да то есть ну у нас был довольно интересный инцидент на самом деле про это мы в один из дней Обновили волк у нас Работал долго кластер да и когда мы его Обновили после старта первой ноды она обратно уже не поднялась оказалось что у нас когда кластер работал долго там появилось много-много данных Да на старте вал то он читает все Лизы и там оказалось что лизов уже много И вот он не укладывался в тайм-ау 600 миллисекунд пришлось раскапывать В итоге все это пересобирать фиксить Это все тоже пофикшена нашими комитами сейчас в австриме также были разные отложенные сюрпризы Да Кассандра сама по себе база распределенная Она прекрасно переживает отказы not все хорошо но тоже в один из дней мы решили обновить наш кластер Кассандра просто на новую версию и оказалось что после рестарта последние ноды волк работать перестал что же произошло Да оказалось что болт не умел возвращать ноду Кассандры обратно в кластер То есть если у вас много умерла да то как бы все Он про не забывал и обратно не возвращалась точно такая же история была энцикломе уиксом точно также фиксиликсом не умел обратно возвращать ноды брокеры а да и Значит мы мы очевидно проверяли да Раньше что все переживает рестарты нот Но вот мы прям Весь кластер не рестартере и оказалось что это все жило до того когда последняя живая нода не перезапустилась также в один из дней мы столкнулись с такой историей что вот это время World request Core handle request Да это время в секундах сколько обрабатывается запрос от клиента здесь вот есть пики до 30 секунд соответственно в это время у нас фактически вал не работал то есть там ну это все вставало колом да Когда у вас запрос один обрабатывается 30 секунд это случалось в те моменты когда приходило много клиентов одновременно при этом у нас CPU никак на ногах не вырос ничего не изменилось Да мы смотрели метрики в кассандру там тоже всё было отлично то есть не очень было понятно что происходит оказалось что волт работает Так что он на каждый запрос захватывает Лог и ходит в базу данных под локом То есть вы берете Лог И ходите в базу причем этот блок глобальный он распространяется на все То есть у вас каждый запрос если пришел один клиент все остальные ждут освобождения этого лока но здесь есть небольшой нюанс Да так это работает когда отключен кэш если у вас включен кэш то все это сначала через кэш проходит локальные тогда проблемы нет но если кэш отключить то есть глобальные Локи и все очень плохо кэш у нас был отключен осознанно Да вот так под этим блоком все работает мы поняли что жить без США у нас не получится отключали Мы конечно осознанно мы вспомним да Что у нас там значит какие-то Хаки мы пишем в разные таблички Мы в принципе думали что наверное будут скашог какие-то проблемы когда его Ну если его оставить потому что он кэширует все локально Ну мы поняли что без кэша жить не получится и нужно как-то это все решать и включили кэш обратно собственно проблема решена Но оказалось что нет После включения кэша мы действительно столкнулись с рядом проблем начали жаловаться люди Да что админа говорили что они добавляют новые политики доступ не появляется и разработчики Даже Говорили что мы болты поменяли пароль а нам волк отдает старые значения Ну логично Да как работает кэш Давайте глянем Вы когда пишите что-то волк делаете путь туда волк сначала сохраняет это все у себя локально в Memory cash И после этого записывается storage какой бы он ни был А если у вас болтов активных вот как у нас несколько да то у них стоит что общий вот эта база Кассандры но Memory cash у каждого Алтай свой и запись вы делаете в конкретный instance и на нем кэш обновляется она всех остальных нет соответственно когда клиент читает уже из другого до центра другой волк приходит запрос там кэш протухший он получает старое значение а как же мы это все починили да Или как мука какие были варианты это починить Ну во-первых мы могли писать делать запись во все кластера То есть можно вместо одного раза писать во все 10 раз во всех мастерах будет актуальный кэш но решение согласитесь довольно странное то есть нужно заставлять как-то клиентов писать во всех кластера и плюс если у вас какой-то кластер будет в это время недоступен во время записи то в нем все равно это не появится Ну да вот непонятно как консистентности быть а можно также периодически делать такую штуку как оператор Step Down Кто знает это valte команда которая позволяет сменить мастера то есть вас много нот вот этих вот одна активная команда Step Down переключает активный на следующую во время переключения ноды там кэш естественно обновляется и все будет хорошо да мастер будет чистый кэш все будет нормально но смена мастера Это довольно тяжелая операция Я вот про это как раз рассказывал что когда на старте Уолт опрашивает все Лиза из базы он проверяет Надо ли отдавать какие-то токины что-то еще пока он был недоступен соответственно эта операция тяжелая это может занимать там 2-3 секунды и в это время клиенты будут получать ошибки Ну мы так тоже не хотели делать постоянно а мы пришли к довольно элегантному решению Да мы просто сейчас решили дропать кэш в болте нет функционала такого то есть вы не можете сбросить кэша ноды кроме как сделав Step Down поменяв мастера и вот очередные 5 строчек Да мы просто взяли и Раз в пять минут дропаем кэш То есть у нас сейчас у нас это абсолютно устраивает это прекрасно работает то есть у нас прекрасно работает кэш при этом 5 минут это ну пять минут для нас Это отличный срок когда там клиент может получить старые данные довольно на самом деле редко вменяются какие-то пароли что-то еще элегантное решение оно работает Ну да Побочный эффект 5 минут могут быть данные старыми и с чем мы в итоге сейчас живем да мы собираем болт с исходников потому что у нас есть вот там несколько строчек тут несколько строчек мы собираем Сами бинарники мы собираем отдельно свой плагин для идентификации потому что плагины отдельно собираются обновлять волк у нас немножко сложнее да чем обычно то есть Нам нужно теперь накладывать наши патчи проверять что все работает но несколько раз мы уже обновляли проблем пока не встретили Ну и также в этой схеме есть некоторые риск что волк может в какой-то момент как-то кардинально поменять у себя структуру хранения данных и тогда наша вся эта история тоже работает перестанет вот что же у нас Получилось Да у нас есть кластер Кассандры и у нас по всем цодам размазаны размазанные ноды Кассандры также у нас есть несколько кластеров болта и все эти кластера ходят в одну и ту же базу То есть у нас есть одна большая база Кассандра которая классная распределенная переживает все отказы и все кластера в котором В каждом классе есть активные активный мастер который выходит клиент и обслуживает запросы они все ходят одну базу если у нас выходит этот центр у нас прекрасно остаются работать другие да как это выглядит с точки зрения клиентов у нас есть Клиенты люди сервера контейнеры и есть куча кластеров с валтом в разных цодах они все заведены за имена Дейл волк ДП Волк и так далее эти имена на них навешаны виртуальная фишка это виртуальная фишка за ней там Есть конкретные инстансы а дальше виртуальная фишка балансирует трафик на уже конкретные ноды в Алтайск кластера и клиенты уходят в запросы клиентские уходят на конкретные ноды Да если у нас сломается дата-центр какой-то да то Hell Check и в DNS проходить перестают на один из адресов мы начинаем в DNS отдавать другую айпишку у клиента меняется и фишка дальше все то же самое да Они получают новые адреса и запросы прозрачно уходят в другой кластер соответственно отказ сода Мы тоже победили Ну и смасштабированием наверное уже все понятно да то есть если мы можем поднять три кластера то мы можем поднять их и 4 и 5 сколько угодно то есть сейчас у нас такой проблемы нет мы можем поднимать кластера в любом количестве создав там новую табличку в базе покажу немножко цифр которые получились цифры Все любят у нас сейчас Walt выписывают порядка полутора тысяч сертификатов в сутки порядка 500 тысяч чтение секретов в сутки популярность Валта растет то есть разработчикам все нравится да работать просто удобно никаких проблем не испытываем это наши местные графики Они немного странные Но здесь вот эти линии разных цветов это время по месяцам то есть мы видим что Чем выше линия там больше число это разные месяца то есть популярность сервиса у нас этого растет люди пользуются больше волт обрабатывает запросы очень быстро порядка там 3 миллисекунд из Кассандра и тоже все отлично мы никаких проблем не испытывали что я хотела сказать завершая доклад Да Walt отличный продукт он классно сделан он модульный он опенсорсный Вы можете писать довольно просто свои модули он нам помог решить огромную кучу проблем с безопасностью также мы получили классно удобно сертификаты и от себя еще до хотел добавить что не бойтесь смотреть код продуктов с которыми работаете Это иногда приносит очень много пользы и не бойтесь что-то править под себя мы так делаем очень часто и получаем очень хорошие результаты То есть это не страшно и жить с этим не так больно как может показаться Вот на этом У меня все хотел бы еще поблагодарить ребят которые тоже участвовали вот в этом всем Проекте в первую очередь Артем Александров и Олег анастасьев и в 11:00 который вот тоже в зале сидит Да у меня все спасибо Спасибо за отличный доклад так пишите вопросы был qr-код вот он так вот и там парочку так пока кто-то пишет уже так давай пока пишут вопрос от меня Слушая почему зачем вот отдельные кластера болтов разных центрах почему вот один большой не растянуть то есть один instance в каждом дата центре болта или несколько там же куча фолловеров Да я на самом деле про это Да я понял я на самом деле про это немного говорил это решит решить проблему с х То есть если у вас в одном один сот умирает в нем стояло надо болта то мастер переключится сам на другие и все будет нормально но здесь не решается проблема с масштабированием во-первых Потому что если один кластер то все равно 1 надо всегда активная и здесь решает за проблема с плавным обновлением потому что ну Все упирается в общем в одну активную ноду кластер можно растягивать как угодно но будет одна активная надо да то есть только с её скоростью будем работать на самом деле кстати с этим как бы тоже проблем нет но мы всегда на будущее закладываем сюда то есть мы сегодня там у нас 7000 может быть 70.000 серверов рано или поздно когда у тебя одна вопрос времени когда она кончится Да так о в чате появились вопросы Интересно так вот про последние слайд у тебя был вопрос Наследие VIP DNS Health Check до конкретных IP то есть хотят уточнить используется ли DNS балансировка у нас почему такая технология выполнена с балансировка точно используется там у нас же очень большой продакшн сервисы все очень разные и какая там конкретно какой тип балансировки используется зависит сильно от сервиса используется и DNS балансировка и потом сначала DNS балансировка а потом под ней еще одна балансировка То есть вы сначала балансируете обычно под Содом на уровень DNS а потом уже конкретная фишка цода она уже балансируется еще по инстансом через loss через балансировщики это адрес так А еще вопрос насколько доверяете по exe XE а диплой не знаю что значит доверяем Ну там Наша сеть наш px е все наше то есть там диплоид тоже У нас написано и немного доверяем зашифровано подписано как не готов ответить сходу не знаю да так я буду повторять ПЭК съеже не аутентифицируется Middle устроить налить что-то другое не готов ответить по-моему У нас там ну не знаю честно говоря не готов можем в кулуарах пообсуждать я могу спросить у коллег или посмотреть как устроено Ну да это хорошо мы на самом деле периодически У нас есть механизм который вот эти вот ключи которые во время диплоя были разложены в 7dby там есть история которая по крону условному ходят и проверяют что информация на хостах соответствует информации которая то есть она там ну то есть если допустим на кости ключ изменится или хост впереди плавится там загорятся какие-то лампочки что что-то не так так и ну такой не совсем по теме доклада но видимо от вас же вопрос Когда вместо РС и эллиптические кривые где у нас ну есть сертификаты значит электрическими кривыми они отличаются тем что на эллиптических кривых вы нагрузку по расшифровке на клиента переносите то есть там прикол электрических кривых в том что ключ короче и на сервере Нужно меньше считать там клиент считает с другой стороны ключ длиннее мне просто шифрование упомянули видимо электрические кривые У нас есть Ну да то есть мы используем Да у нас сертификатыптическими не везде надо так вот возвращаясь к валту чуть-чуть времени у нас есть вопрос видимо вот картинка требовала пояснения с кассандрой где размещается кластер Кассандры в одном дата-центре в нескольких как сам болт Кассандра масштабируется очень просто Ну конкретно у нас болт это во-первых волк стоит на железных серверах потому что мы не можем поставить Volt в облако потому что ну это будет завязка такая циклическая то есть если волк поставить в облако у нас вообще вся инфраструктура инфраструктура которая критичная она стоит на железе Потому что если это ставить в облако то когда сломается мы не сможем поднять саму инфраструктуру которая нужна для запуска облака друг от друга зависимость поэтому во-первых волк стоит на железе и так как сам волк потребляет очень мало ресурсов У нас вот конкретно у нас прямо на этих же самых железках они по всем содам расставлены эти кластера болта и у нас вот на этих же самых железках стоят и валты и для них Кассандра и там же еще из-за Кибер который нужен для Валта Ну там отдельная история могу сказать потом там есть сторожи которые поддерживают Хай которые не поддерживают если у вас тоже чихание поддерживает а Кассандра не поддерживает потому что там транзакции нет Нужен еще какой-то любой там вам маленький любая система что угодно что может мастер собрать то есть нас там еще за киперы которые нужны только для сборки кластера для голосований у нас все это стоит на одних желез когда то есть Кассандра стоит там же предстоит волк это сейчас прямо у нас 30 разных и там по три сервера железных на каждый волос и того 9 серверов то есть Кассандры тоже это 9 серверов в ринге Я чуть добавил бы что ну Кассандра поддерживает malt ddc из коробки и то есть можно настроить сколько сколько реплик сколько копий данных в каждом центре держать там уровне консистентности обеспечивать и так далее то есть ну Для нее это на этих удобно из коробки сама по себе Так у нас время подходит концу вопросы еще есть на самом деле поэтому Давайте все переместимся в дискуссионную зону кто Кто желает подискутировать про эллиптические кривые Ну да спасибо спасибо Ваня Спасибо"
}