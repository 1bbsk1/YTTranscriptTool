{
  "video_id": "biD1uMryYsI",
  "channel": "DevOops_conf",
  "title": "",
  "views": 0,
  "duration": 0,
  "published": "",
  "text": "коллеги Привет меня зовут Максим Моисеев Я вобщем фролит поздних Technologies коллега Максим залысин хедовс позитива мы сегодня подготовили небольшой доклад про антибал про наши скажем так попытки сделать его удобным много чего еще предстоит сделать но это выжимка за наши ближайшие наверное пару лет работы сансе бы он передаю слово Максима еще момент забыл про наш чат присоединяйся к нашему чату пишите вопросы Думаю что после доклада ответить Спасибо Всем привет Макс меня уже представил Да я тоже в компании пользу технолоджус о слайды появились у меня всего полчаса вот поэтому Там первые несколько слайдов это такая некая Прелюдия и сейчас прям пробегу максимально быстро кто захочет поподробнее узнать что-то Приходите на стенд Мы вчера весь день сегодня весь день Приходите и через Да мессенджер тоже можем общаться в двух словах про меня возглавляю его в компании против technols уже пол жизни войти много где побывал вот последние пять лет в основном руковожу но технику ни в коем случае не отпускаю чтобы не закостенеть а в двух словах про Позитив компании уже 21 год так вот естественно водилочка 2000 сотрудников примерно в компании из них 250 это эксперты в области исследования информационной безопасности наша инфраструктура девапсулы вокруг которой как расстроится вся машинерия с нюансы былом это больше 500 разных серваков за все это время мы находили так или иначе там плюс-минус 100 разных ролей и собираем их в проектах как мы это делаем Я как раз сейчас расскажу начало Маленький вопрос зал похлопайте Кто здесь Окей почти вязал хлопает Вопрос такой А как правильно установить здесь знакомые команды для установки антиба к похлопайте похлопайте этому слайдом это все неправильно забудьте про них правильные команды по установке было на самом деле написаны в доке Очень неплохо И вот как раз пип это один из рекомендуемых пакетных менеджеров по сути пайтона трансе был это модуль и пайтон Ну или исполняемый пакет пайтона поэтому пи-пин стал Вот лучше в юзерский namespace users virman тогда не будет конфликта ни с какими системными системными пакетами которые Apple приносит например илию зависит от операционки Но если еще прям сегодня залезть в документе было то появилась новая утилита она называется пипец Вот это как раз утилита на последних версиях ос которые позволяют приносить в систему не конфликтующие но при этом исполняемые там пакеты Ну это просто выдержка из стоки Хотя как оказалось далеко не все всегда правильно ставить танцы был это просто маленькая рекомендация хотите актуальная версия был ставьте так Следующий вопрос небольшой зал небольшой интерактивчик антибал или антибалкор кто знает отличие это прям два пакета пипа впрочем антибал Core это исключительно runtime ansiblo вот ставится только исполняемые файлы и больше ничего Поэтому если нужно получать удовольствие от использования антибаставим именно пакет ansible к нему еще конечно есть вспомогательные пакетики типа линтера еще чего-нибудь полезного но в общем хотим полноценные нормальные ансы был со всеми зависимостями нужными коллекциями на основе которых будут писаться дальше все таски и плейбуки ставим антибил коллекции Одна из таких важных сущностей по сути которые нам в основном поставляет комьюнити Мы у себя тоже стараемся их разрабатывать пробуем в разных ипостасиях и вот когда начали такую достаточно плотную разработку поняли что нам не хватает шаблонов шаблонов для ролей для проектов три основные сущности для себя выделили там за последние пару лет как раз и первое С чего начинается любой шаблон любой гид репозитории будет хороший а тут стоит обратить внимание что имена коллекций по без практису они пишутся через нижнее подчеркивание как и именно ролей и вот дальше такая небольшая выдержка как раз из нашего из нашего шаблонного redmi это рассказать пользователю этой коллекции о том что же данная коллекция делает то есть буквально в два-три предложения полезные ссылочки здесь показать о том Ну как бы что коллекция реализует что можно про это почитать в Интернете примеры использования этой коллекции Ну и тудушка как раз как такие некоторые пункты дальнейшего развития коллекции дальше по нашему шаблону Galaxy Ямал с ним достаточно сложно он задает требования к версии они коллекции здесь же указывается имя коллекции вот те жирные поля которые я выделил жирным ярким цветом это то самое необходимое что нужно обязательно указать при создании новой коллекции Лично у нас позитивных технологий на этом живем description тоже будет не лишним просто расписать в одно предложение для чего эта коллекция дальше что остальные части по сути шаблона плейбуки мы их используем у себя для захоронения вспомогательной таких плейбуков Ну а-ля то что можно за импортировать в дальше в тосках Ну прям конкретно в проектах вот Главная задача что PlayBook должен реализовывать в рамках одной коллекции реализовывать какую-то свою узкую специализированную атомарную функциональность все То есть он не должен делать сразу все Лучше тогда положить несколько плейблоков но мы плюс-минус от этой истории уже отходим Макс меня потом скорректирует он Намного ближе ко всем этим вещам дальше что коллекции подходит очень хорошо для разработки плагинов в частности модулей Ну по сути это все то чем мы пользуемся из комьюнити среды как раз модули на Python то есть и мы экспериментируем со своими модулями на Python честно говоря хотим сейчас написать одну из историй по интеграции с API Яндекс клаудом обойти немножечко функциональности реформы и реализовать все что нам нужно на ансебе Вот это такой маленький сброс Ну и конечно в коллекции так или иначе можно написать небольшие локальные роли локальные они потому что используются не только в плейбуках чтобы плейбук не превращать в портянку вот пишем небольшие роли сразу подключаем их используем локальных в рамках коллекций и уже Обращаемся к PlayBook через импорт в самом проекте из коллекции его за импортили вот примерно такой команды роли просто помогают не создавать огромное количество вермишели и портянки в рамках Ну и вот они по сути те самые правила основные правила по которым мы ведем разработку коллекций новая коллекция только из этого шаблона gitlab только из этого да его можно дальше расширять но Стартовая точка создания коллекции у нас только из этого шаблона разделители имени в коллекции Это только нижнее подчеркивание это без практис и во многом уже некоторые стандарты он не только коллекциям применим вот но здесь третий пункт который говорит про версия нервнивание коллекции здесь на самом деле огромное количество плясок с этим происходит и коллекция версионируется и удобно разрабатывается только тогда когда она достаточно атомарная и изменения в нее вносятся не часто Для чего используем опять же собственные модули на Python вспомогательные плейбуки и какие-то роли которые используются только вспомогательных то есть Главная задача коллекции быть атомарной с точки зрения своей функциональности Вот она задач реализуется он и переносится дальше самая объемная история и один из часто используемых наших шаблонов сто процентов часто используемых у нас более сотни уже всяких ролей написано это как раз шаблон опять же ритми но он чуть-чуть побогаче снова указывает на то Как написать правильно имя имя роли если оно из нескольких слов состоит точно также просим указывать 2-3 предложения в описании роли полезные ссылочки Ну например если роль отвечает за развёртывание постгальца какого-нибудь то здесь полезные ссылочки на докер к докер образ по адреса Его документацию можете вспомогательные статьи Как его правильно потянуть вот третья История это переменные Мы перечисляем в каждый ролик прям мишки те переменные которыми управляется роль и если вы заметите здесь на слайде то переменные любая переменная роль начинается с имени роли таким образом чтобы никогда в жизни не перепутать Для чего конкретные переменные была написана у каждой убежала вот у каждой переменной есть описание ее типа и обязательность мандатрей или дефолтное значение соответственно дефолтное значение есть только в том случае если данная переменной уже объявлено в каталоге дефолтс дополнительно сюда докидываем например Требования по использованию этой роли Ну например именно для этой роли на серваке для пост или для манги на серваке нужно подтюнить ciscotl что-нибудь там по работе с tcp стеком может быть что-то по работе с памятью вот опять же примеры использования этой роли вот прям реальный живой пример то как роль использовался на каком-нибудь из проектов и снова тудушка что-нибудь полезное Куда дальше можно развивать роль когда на то будет время или технический второй основной файл который тоже надо всегда на старте заполнить шаблоне это Мета Ямал через него именно через него Galaxy ansible Galaxy утилита помогают правильно сейчас ansible Galaxy может правильно с использованием этот метод яблок использовать роль ссылаться на неё и в частности проверять ее dependence вот здесь тоже из пунктов Какие самая первая строчка dps мы ее всегда держим пустую мы ни в коем случае У себя не допускаем связывание зависимости между ролями роль исключительно функционально атомарная сущность все Она не должна ни за какие dependence отвечать все что нужно используется в этой роли из публичных коллекций из комьюнити коллекций минимальная версия была она у нас постоянно апается потому что мы из пипа всегда ставим и поддерживаем актуальную версию была Ну и по сути с точки зрения платформы перечисляем только нам что нам нужно Linux или Windows У нас есть достаточно там интересная наработка что мы не завязываемся на то какой Нам нужен дистрибутив потому что практически весь наш софт приносим видео оберток System dashion юнитов над контейнерами работает везде одинаково поэтому мы сразу знаем что дженерик Linux как платформа нам достаточно для 99 процентов наших ролей дальше основные каталоги это просто пустые файликимал уже заранее объявлены в шаблоне репозитории роли по сути здесь мы пишем все самое полезное в дефолтах складываем как раз дефолтные значения переменных которые приезжают в хендлерсах Ну Мы все знаем они про какое-то завершающую тоску когда роль отработала или playbox целиком отработал тоскьянул соответственно вся вся самая важная машинерия роли и Варс Ямал он у нас используется исключительно только для управления приватными переменными ролей вот а приватные переменные роли мы объявляем указывая нижнее подчеркивание потом имя роли и потом уже сам ключ переменной очень удобно никогда не всегда защищает от того что кто-то запутается где Какая переменная В общем бар схема у нас живут только объявлены приватные переменные приватные перемены можно использовать Ну например для какого-нибудь статического значения то что неудобно перечислять явно в каждом плейбуке или когда нужны там из двух-трех дефолтных из двух трех внешних переменных собрать какую-нибудь красивую через регулярку полезную приватную переменную типа вычленить какую-то версию какой-нибудь имя пакета еще что-нибудь и все это в приватную переменную падает Library исключительно вспомогательный каталог мы его практически у себя не используем но существует в интернете интересное решение типа есть комьюнити на гитхабе есть очень неплохая библиотека как раз которая инклюзится в роли по управлению Power DNS API там где нам нужно например именно опишки Power DNS управляется создавать записи удалять их каким-то образом обновлять мы просто питание код кладем вот прям и все работает безотказно и ни в коем случае фокус-роли и как это ее атомарность не расползается по всему проекту в целом Ну и небольшая подводка опять же роли все создаем только из шаблона тот который я сейчас показал разделители в имени роли должны быть только исключительно нижние подчёркивание это без практики во многом уже стандартация была версионирование роли это прям отдельный сахар это очень полезная история очень хорошо реализована в отличие от коллекции Она очень хорошо реализована в для ролей вот именование публичных ролей как я сказал оно начинается все с имени роли всегда только с имени роли и а приватные переменные точно также с имени роли но с нижней подчеркиванием указывающий на то что Это приват и вот по сути подбираемся к самому мясу самый ценности коллекции написали функциональность в роли описали все что нам нужно делать дальше задачи это все по сути приносить в инвентарь то есть на серваки через инвентарь через конфиги Вот пример шаблона как раз это шаблон нашего проекта ansible У нас их много мы их разделяем специальным образом разделяем По разным продуктам проектам внутри одного проекта живет множество окружения ролей таким образом на каждом своем слое соблюдается определенная атомарность атомарность и ответственность Анси была за те или иные настройки которые приедут на сервак на один на 10 на 20 больше мы стараемся не делать 20 это условное число но когда Анти был работает с ограниченным количеством хостов он работает Быстро если его натравить на сотню хостов можно идти пить кофе здесь Какое отличие опять же от коллекции и ролей имя проекта пишется через дефис не через нижнее подчеркивание требования одно fqdrfc потому что имя проекта Мы у себя используем в связывании с доменами зонами то есть у нас какой-нибудь проект например кипсе мы выделяем под него зону третьего уровня и полностью проект отвечает за все что будет настраиваться вот в этой доменной зоне поэтому если он был проекта соответствующее название путаницы в разы меньше сразу легко понять какой проект К какому продукту или проект К какому продукту относится вот дальше что здесь точно также присутствует описание проекта в 2-3 предложения полезные ссылочки на него может быть где-то на Вики почитать и вот такие основные вспомогательные команды которые я например в своей практике когда пишу какой-то проект Я их даже не пытаюсь запомнить Я просто как redmi делаю и копипашью вот эту команду ansible Galaxy Install Force RAW файл рекоррен схема это как раз чтобы подтянуть все необходимые роли и коллекции если они нужны именно в этом проекте Ну и самая последняя строчка про то как мы управляем болтом он у нас есть он объявленков и сейчас это покажу и явным образом ссылается на то где мы храним наш антибол Вольт секрет причем этот секрет используется именно для подключения кэше корпусу то есть секретов храним в проекте очень мало все вытаскиваемовский Вольт антивольт позволяет лишь безопасно подключаться соответственно этот файл обязательно объявлен антибалка ф.г вот здесь Самый сок мы его очень долго выпиливали и периодически еще что-нибудь туда подбрасываем вот как раз тот самый Вольт Password файл вот он и в Гид игноре тоже ни в коем случае не за комментится ну и парольницы нашей корпоративной ролл спас эту строчку запомните я к ней вернусь буквально через три минуты и расскажу Самый сок этой строчки логи танцы был Лог это файл тоже У нас гитаре и он помогает нам всю историю которая могла не поместиться в консоль Да за время вызова куча разных плейбуков сохранить в один файл Но точно также в Гид оно не попадет не будет меньше ой стыда позволяет все форматирование дебаг информации выводить формате Ямала это удобно читать Спасибо Максу подсказал неделю назад я не знал раньше ну и плюс мы еще стараемся профилировать всякие колбеки обязательно выводим количество времени потраченные на каждую из тасок то есть сколько она работала сколько скачивался какой-нибудь пакет или контейнер или еще что-нибудь на серваке на конкретном и в конце мы просто все подключаем что лимит у нас нет профилирование профилируется буквально все даже дальше побежали гид игнор тот самый коротенький скромный гид игнор по-хорошему его нигде больше ни в одном проекте не расширяли вот тот самый с Ямал который использовался вреднышке и через него именно подтягивается все необходимые функции которые дальше применится сконфигурируются на инвентаре и применяется к конкретным хостам это пустой рекламу А вот полная реклама с ямом это реальный ритуальная одного из проектов и Какая здесь история вот те самые коллекции есть стараюсь поподробнее разъяснить первое на что стоит обратить внимание Как в коллекциях Так и в ролях это на путь до скачивания коллекции из репозитории или роли из репозитории Видите Там самом начале нестандартная такая строка СССР снова гит собака вот это вот история была высчитана опытным путем позволяет работать работать усилитель ansible Galaxy прям точно так же скачивая репозиторий с ролью в как короче скачивать репозиторий Один в один как это делает утилита гид таким образом если на своем компе гид может правильно работает и клонирует роль то вот эта команда позволяет сделать все то же самое и она ни в коем случае не упадет Когда вы запустили утилиту был Galaxy такое написание строки по сути был Galaxy вызывает git Клон дальше что из версионирования коллекции здесь очень сложная пляска Как вы помните версию коллекции нужно указать файлики Galaxy Ямал дальше подоткнуть это еще гитэгом синхронизировать это сложно и самая большая сложность что даже через Force заставить коллекцию с первого раза свою собственную коллекцию с первого раза подтянуться у себя под капот чтобы ее запускать эту пляски с бубном еще те вот поэтому мы с коллекциями живем очень аккуратно Вот очень аккуратно но с ролями мы живем очень прям объемно и разрабатываем их много И вот если Обратите внимание Я прямо сейчас выделяю как раз кружочком Вот например роль джинса их здесь Две версии 011 и версия 0.2.0 и Они между собой не конфликтуют у нас действительно в проекте на проданном контуре версия джингса пока 011 доходили небольшой функционал докинули зарели версию 0.20 и силу того что здесь src строка указывает на путь до роли а вершин указывает на gettek этой роли и этот же вершин используется в имени роли Эти роли никогда не конфликтуют между собой в проекте в принципе никогда не друг другу не помешают и ошибиться нельзя Дальше что Ну такая же история здесь есть про постгрыз и вот там например роли со сложносочиненными названиями Ну из двух слов над экспортер Вот они всегда пишутся через нижнее подчеркивание Поехали дальше боевые каталоги файлс используем ой убежал файл используем только для статичных файлов проекта ни в коем случае не кладем туда ни шаблоны Ничего туда можно положить Мы у себя по сути две практики возвели это социальные сертификаты и файлики терраформы социальные приватные ключи при этом можно еще зашифровать их без проблем был распакует Что нужно если контент этого статичного файла нужно передать в роль Что нужно для этого сделать но по сути прям на уровне плейбука вызвать утилиту лукап и сказать какой контент какого файла прочитать и дальше этот контент можно передавать в любую роль переиспользовать многократно сколько хотите если он был зашифрован расшифрует потому что указано каким пальто она зашифровано плейбуки Ну это соответственно самый основной каталог не буду на нем останавливаться там у нас живут множество плейбуков в основном мы их разделяем по функциональности нужно на Хосты принести постгры постгрысу какой-нибудь exporter Там как спорте рукой настроечку все это описывается в одном плейбук и плейбуки скромненькие чаще всего на 2-3 таски Ну наверное самое массивная PlayBook которая у нас есть она про губернатор там 2000 приседаний утрирую Вот Но тем не менее все плейбуки очень скромные они легко читаются ну и соответственно роли вот допускаем использование так называемых локальных ролей То есть у нас есть понятие публичные роли и локальные Ну или приватные роли то есть роли приземленные в конкретный проект не требующий версионирования скорее всего не переиспользуемые ни в каких других проектах например кастомное теплоечка специально на скорую руку написано писать и опять же плейбук там как и коллекции писать портянку в виде плейбука там на 20-30 задач не интересно еще когда-нибудь люди нужны просто вытаскиваем это в небольшую роль она живет вместе с проектом Если вдруг понадобится ее вытащить в публичные роли только сделаем Просто по шаблону перетащим обычно вопрос на 5-10 минут инвентарь это вот как раз та история что я вначале рассказал У нас есть некая доменная зона доменной зоне прибит проект у проекта ансибла это доменная зона отвечает за несколько контуров одного продукта и вот как раз те самые все контура они и описываются в инвентаре продавый контур тестовый контур стоит живый контур integration контур еще какой-нибудь контур тут просто генерация каталоги с одним и тем же наполнением примерно одним и тем же наполнением Ну один тот же формат как минимум все окружения Да как живут в этом каталоги инвентаре инвентарей шестые Мы у себя перечисляем в простом максимально легко читаемым и не формате потому что я мог пробовали он сразу подкидывает идея давать до переменных набросаем А давайте там в группы сложно соберем он стоит становится сложный даже когда у тебя плюс-минус 10-20 начинается пляски и беготня по вот этому большому файлику поэтому хост у нас исключительно только в формате и не указание переменных вот где мы задаем переменной в рамках инвентаря это как раз на уровне ход но только исключительно чтобы сказать антиблог как Достучаться до этого Хоста Ну например переменная ansible Host там где ее айпишник лежит потому что доменного имени еще не приехала например раньше было Саша Спорт или что-то такое или где ключик найти или с каким явно юзер Ром сходить но это скорее всего легасе история Потому что так или иначе серваки примерно одним большим сходство с используем Кто пользуется антиблонд знаем чтобы чтобы прибить конкретные переменные к определенному хосту группа для тех хостов которые объединили файлики хост группы Ну например кластер он состоит там из трех пяти машинок и так далее вот у них есть какие-то общие переменные мы их прям приносим группа дальше возникает некоторый момент в том как же быть с переменными которые нужны в нескольких окружениях сразу то есть одна переменная одно значение но в нескольких окружениях сразу вот когда-то давно придумали для себя обходной маршрут это группа Wars в нем каталог All в нем в нем кладем с нижним подчеркиванием Global яму потому что он читает переменные из файлов по алфавиту и софт линком просто прокидываем его на корень выше Прямо в лоб был Ямал корневой для всех инвентарей Вот поэтому можно работать с любым Global Ямала это просто Link Вот сам пример инвентарь с файлика Глобал яму вот так вот он объявляется и специально красным цветом выделил чтобы Здесь было видно например коктейльный какие-то полезные настройки ipv6 выключить там привели джетт порцию выкрутить в ноль потому что они мешают а птшные пакетики принести или Например сконфигурить сразу на всех остальных одинаково чтобы ни в коем случае не не поломать наш логирование наш сервак потому что логики у него сожрали место а уже подхожу к финалу 30 секунд не хватит дальше что опять же есть правила у проектов Это не все новые проекты опять же только из этого шаблона мы делаем периодически шаблон дорабатываем все что от него отстает как Техническая ипотека потихонечку разгребаем разделители в имени проекта только дефисы потому что это эвкуденовский рфц и в проекте возможно использование локальных ролей но они ни в коем случае не должны быть пере использованы в каких-то других проектах либо выносится в общие в обще каталог одну большую группу со всеми публичными ролями финал время у меня кончилось отлично маленькая уточнение ролл спас Я просил запомнить есть такая фишка вот структура наших проектов и ролей прям в гитлабе она отрисована и таким же образом клонируется на тачке админов если увидите проекты и роли на одном уровне дальше ролл спас у него самый первый путь указывает на asible Galaxy Rose это то куда утилита ansible Galaxy будет по умолчанию вытягивать все свои ролики Galaxy работает именно с первым каталогом указанным в ролл спас но так как у нас все роли версионируются они никогда не пересекаются не конфликтуют сколько бы ролей Из каких бы проектов мы туда не подтянули и дальше есть небольшой сахар Роллс и два каталога назад снова Роллс это фича удобная прям помогающие нереально безболезненно разрабатывая роли давайте так я это оставлю подходите На наш стенд я прям подробности покажу и расскажу кому интересно если вот таким образом Перечислите свой ролл спас то можно одновременно разрабатывать локальные роли публичные роли Когда нужно публичную роль комитить и уже протаскивать ее в рекламе Но вот этот спасет и необычайное удовольствие от разработки ролей контроль качества у нас везде направлены линтеры есть даже небольшой самописный линтер который так и называется Project линз и projeclinter и он в основном следит за рекламном за порядок за порядком файлики requardence Ямал Потому что есть проекты в которых там под сотню разных ролей подключается большие проекты тестирование молекулы мы не используем вот Тестируем на реальные инфраструктуре Как вы могли видеть по проекту У нас есть всегда безопасная среда где можно прям погонять роли Ну например какой-нибудь стоит стейджевый тестовый integration контур где можно все сделать безболезненно в какой-то момент приглядывались к решению от команды один из бывших коллег не порекомендовал это докер образы которые полностью эмулируют себя операционную систему у них под капотом запускается System D запускается США и ты фактически можешь ролик натравливать в рамках сияя прям на целевую чи стую машину и прогонять по ней смотрели но пока не досмотрели смотрим на что-то другое ребята заморозились решения все а коллеги Всем спасибо мы постарались очень плотно собрать много информации достаточно ограниченное время многие вещи сюда не вошли Я видел вопрос в чате протестирования Максим тоже ответил про то чтобы не использовали мы поднимаем виртуальные машины интеграционное тестирование у нас непосредственно на живом железе Мы научились поднимать очень быстро инфраструктуру чтобы протестировать прямо на ней и обкатать прямо на реальный занимает секунды максимум Для нас это быстро процесс и был второй вопрос про хранение файлз и почему мы хорошо и в локальных храним но проектов много так как мы делим Анти был по проектам и у нас не одна большая монаре по достаточно много там мелких атомарных то не все проекты еще въезжают корпусов есть те которые живут локально есть те которые уже Прямо полноценно работают хорошо поэтому Ну ответ всё всё постепенно Да это много Legacy и отчасти мы с этим боремся достаточно Спасибо еще раз Приглашаю всех на стенд"
}