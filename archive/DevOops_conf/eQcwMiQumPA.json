{
  "video_id": "eQcwMiQumPA",
  "channel": "DevOops_conf",
  "title": "",
  "views": 0,
  "duration": 0,
  "published": "",
  "text": "Приветствую всех участников и слушателей конференции devoops Меня зовут георга Я сегодня приглашенный эксперт на докладе по губернаторсу Юрия Медведева сразу хотел бы поговорить о регламенте нашего мероприятия во-первых У нас есть Telegram канал в котором вы сможете задавать вопросы очень хорошо задавать вопросы Я постараюсь ответить на большую часть вопросов в самом чате но вероятно если у нас останется время после доклада мы попробуем часть вопросов разобрать онлайн все остальные вопросы мы разберем дистанционном клубе который будет после доклада после доклада обязательно Поставьте пожалуйста свою оценку это нам помогает доклад лучше И как я уже сказал после доклада можно будет пообщаться жилом режиме с докладчиками со мной и обсудить тему доклада тема доклада сегодня это оператор Это очень пищущая тема потому что есть много способов доставки все мы знаем как можно вставлять программы надо через те лапла и личико схем или еще какими-то другими способами Но конечно же наиболее продвинутыми наиболее технологичным способом является описание пиратов сожалению на текущий момент времени хороших операторов достаточно мало их можно практически считать по пальцам одной руки Это может быть всем известный комиссию с оператором или стремимся для установки Кафки и сегодня мы разберем Как можно написать оператор самостоятельно внести свой вклад в развитие индустрии докладчик Юра Медведев я с ним давно знаком Может быть вы его видели он очень хороший эксперт по данной тематике и прошел полный путь инженера буквально до архитектора Поэтому ему есть чем сегодня с нами поделиться знаниями и я передаю ему слово привет Всем привет да меня зовут Медведев Юрий прошел долгий путь сетевого безопасника занимался многими проектами называется Димаш только не была и Сегодня поговорим и я попытаюсь вам показать что на самом с одной стороны писать операторы действительно достаточно просто с другой стороны это отчасти титанический труд как сказал Георг действительно операторов и это бич операторов не так уж много хороших прометеос оператор Да прекрасензии отличные А там если посмотреть какие-нибудь допустим патроне оператора Ну он своеобразен скажем так ну чтобы сильно уж не углубляться софистику давайте наверное перейдем к слайдам и почапаем посмотрим вот а собственно Почему Через тернии это как на латыни Через тернии к звездам и на самом деле операторы как я уже сказал либо просто либо очень сложно сегодня мы поговорим об одной из итераций операторов и об одной из реализации в частности поговорим о когти и да оператор Он офигенен он классный вообще хороший язык сам себе но у многих то пугает то что-то там неудобно любителю ходит в какие-то прострации Вот одна из проблем еще операторов в том что люди не до конца понимают что такое оператор Я часто видел вообще что такое операторы Вот вы видите на экране это цитата одного из авторов операторов фреймворк если кто помнит операторов появился из того до покупки и Объединение в Red hata поглощение Да оператор фактически этот же контроллер только для User Space все знают там грейс-контроллер или любой другой контроллер но была основная проблема чтобы сделать такой же функционал Но для пользователя вот собственно об этом отчасти мы говорим сегодня на самом деле что такое вот оператор Это благо не появились есть контроллер плюс Application это все у нас оборачивается называется оператор кастом ресурсе финишина Если вы знаете достаточно новый скажем функционал но в разрезе cubernetics очень сложно сказать что новое что старое наверное там докер можно сказать используем докер именно Докера в кубери Это старое так исторически сложилось обычный лайфсай оператора это мы либо через скуп сети либо через чего-то там применяем либо тем же хелмом мы применяем Файлик который описывает у нас оператор отслеживает состояние и на основе кастом начинает что-то выполнять зависимости от логики приложений Ну а логику вы описываете как бы сами сами решаете Какие события вы отслеживаете Как вы с ними поступаете собственно Почему И зачем изначально вышел из заланда и появился несколько лет назад это очень простая простой фреймворк для реализации операторов с одной стороны это круто да вы можете создать оператор буквально несколькими строчками Но с другой стороны на это накладывает на вас большую ответственность как вы будете следить за изменениями потому что в принципе оператора это стоит я не думаю что нужно объяснять что такое stateful для приложений и как стоит влияет и работает в чем разница между строительств собственно коп очень прост реально прост ну и плюс это Питон как ни крути питон по вхождению достаточно имеет меньший порог чем тот же но опять же говорю оператор можно писать на чем угодно тут главный основной принцип он везде один и работает примерно одинаково и будет работать примерно одинаково язык реализации это дело 3 я не топлю чтобы прям вот берем коп и пишем только на нем у меня позиция всегда такая что использовать в команде тот язык путь технологию Где у вас есть экспертиза собственно если в команде инженеров или у вас гибридная команда где есть программисты которых можно привлечь и они и знаний больше по голлангу то операторов и все к тому же оператор фреймворк это не только И нисколько гуллинг достаточно расширение и сейчас развитие операторов ко мне напоминает как раньше в те допустим были банты что можно было и фактически разворачивать приложение с помощью Вот едем дальше как и все фреймворки как и все фреймворки для операторов У нас есть определенные количество обработчиков которые выполняются на той или иной стадии на работу в частности Я указываю буду рассматривать только основные которые нам в принципе Важны и нужны для работы это база чем хорош там в принципе из коробки идет осинок Нужен ли вам осинк этот на этот вопрос может ответить не знаю кто на самом деле я не большой фанат Осинка и в моей практике именно полная синхронично для операторов она была крайне но опять же зависимость от того что вы доставляете также когда нужно писать оператор вот операторы нужно писать не потому что это модно молодежно а потому что вы хотите гибкость я не скрываю что я не особый фанат хелма но опять же если быть объективны любая технология имеет право на жизнь собственно Хилл имеет право на жизнь Лично у меня осадочек после сел на второго и некоторые вещи в хиллами Мне не нравится как реализовано можно это исправить Да можно скорее всего рано или поздно многие неудобные вещи разработчики приведут порядок опять же если сравнить второй это небо и земля Ну возвращаясь к теме и возвращаясь к нашим операторам катимся дальше собственно самый первый который у нас обработчик запускается это На старт То есть когда начинается выполнение кода собственно этот оператор этот Извините оператор Это обработчик можно использовать если и нужно использовать если вам нужно подождать например какого-то события в интернете убедиться что у вас зависимости уже стартовали и отчасти сделать можно сделать отсроченный Старт вашего оператора следующий оператор Мы прям идем по тому как оператор начинает выполнение работ собственно логин тут не надо сильно объяснять это именно как мы авторизую авторизируемся в губернатик кластеры собственно тут есть несколько видов Если вы запускаете оператор локально собственно у вас будет использоваться ваш текущий контекст и конфигурация для вашего коллайнта консольного если мы запускаем в кластере Значит у нас будет использоваться сервис аккаунт от которого мы запустились собственно при тепло и операторов нужно позаботиться что у вас ваш сервис аккаунт для оператора который Вы будете использовать имеет нужные для вас Перми и собственно Если вы заботитесь о безопасности о настоящий инженер не только должен страдать но и заботиться о безопасности потому что Security onion И безопаска это для всех не только для безопасников собственно заботьтесь что у вас есть определенный сервис аккаунт также есть возможность использовать внешние сервисы неплохо интегрируются например или с но в любом случае как у вас будет осуществляться именно авторизация в вашем классе Решаете вы в большинстве случаев для локальной разработки используются именно проверяется что у вас он запущен локальный и пытается подключить и пытаемся подключить ваш собственный в классе 99 процентов случаев 9 ну большинстве своем будет использовать сервисный это как раз вот дальше мы переходим к основному основному событию которое у нас есть это на создание собственно когда оператор запускается он начинает отслеживать что у него происходит в губернете и пытаться найти кастом ресурс дефинишн который соответствует ему который вы задали То есть если у вас оператор называется и у него версия 1 то есть будет мы начинаем отслеживать что у вас появляется кастом ресурсе с таким названием и используют версию для вашего оператора следующий и не менее важный это на обновление ресурсов то есть этот обработчик отслеживает то есть после того как вы создали у вас отработал логика например вы создали дипломинг дипломинту сделали сервис накрутили создали и что-то еще оператор записывает состояние Что происходит в кластере на основе этого состояния мы записались Все мы считаем что наше дело выполнено если в процессе создания Я имею ввиду предыдущего именно обработчика что-то пошло не так мы ставим на паузу и попытаемся опять же накатиться и довести до состояния которое описано в кастом Собственно как только вы меняете поле Например у вас был докер образ версии 1 Viva и вы меняете на версию V2 собственно обработчик отхватывает выхватывает предыдущее состояние с новым состоянием и он вам в принципе показывает состояние и на основе этого дифа что было И что будет Вы можете применить изменения не перенакатывать все сохранять ресурсы время это достаточно удобно в том плане Когда у вас большие развесистые операторы Ну и не забываем что многие ресурсы Ну не многие есть ресурсы в cubernetic которые нельзя просто так проапдейтить я семью Это был ресурсы даже конфиг вам можно делать И тогда только пересоздание Ну логично Мы создали мы Обновили дальше нам что-то нужно делать Мы за тепло или приложение пользователи решил что все оператор мне не нужен дипломинг который совершён не нужен что происходит Дальше он говорит там к примеру тогда из нашего кластера удаляется И не только бой оператор фреймворк выхватывает это событие и на основе логики начинает вычищать все созданные ресурсы как родительские так и дочерние Ну и один из последних по завершению мы можем перехватывать исключения мы можем делать очистки дополнительные он клинап обычно используется просто чтобы погасить и очиститься после того как мы все сделали уже удалили У нас полный Лайф сайта оператор прошел Ну а теперь немного того что мы можем делать как я уже говорил кофф это поддерживает асинхронность и примеру когда ваш оператор стартует бывает что операторы может стартовать намного быстрее чем дочерние ресурсы уже нужные ресурсы уже создались И для этого На старт вешают как раз асинг слип или просто слип что мы подождем либо через API проверяет что у нас есть дальше на логин по большому счету мы вешаем что какая логика у нас налоги как я уже сказал это может быть либо ваш конфиг либо именно сервис аккаунт будем использовать Ну и банально рассмотрим Как мы можем что мы можем создавать И как мы можем создавать самый веселые моменты наступают когда во многих во многих документации либо в чем-то в каких-нибудь пабликах либо медиум либо еще где-то пишут мы начинаем создавать оператора хорошо мы начинаем описывать диплоимент используют только допустим библиотеку куберовскую Но на самом деле чтобы создать через куб чем удобный просто можно использовать template templating тоже и по большому счету после рендеринга теплейта для простоты можно использовать это достаточно очень интересный Он одно время умирал сейчас воскресили и по большому счету для создания каких-то объектов в кубернайтисе пайкуп очень прост там если Вот видите пайку мы создаем просто под Что делает данная функция Мы загружаем наш template делаем адаптацию под оператор оптимизацию дальше мы получаем куб конфиг в данном случае из январентов и на основе данных которые мы получили из template и авторизация мы создаем пот А дальше говорим что мы его создали и закрываем сессию опять же важно важный момент всегда при разработке операторов сессии лучше закрывать много открытых сессий чревато хорошим последствиям И как вы видите он крейт Я жду что у меня будет определенные вещи дальше собственно то что я говорил это про обновление у меня что-то было я за тепло и тот же допустим из предыдущего слайда под у меня создался под Я записал точнее коп записал непосредственно состояние потом я меняю поле с пеки говорю и плай У меня меняется и в на апдейт у меня прилетает Ну и здесь как легкий пример банальный принтинг листа что было между тем что было И что будет как я уже говорил то есть мы здесь также допустим самый банальный самый простой пример Мы также подгружаем нужный нам тимплейт рендеринг template говорим через пайку Что у нас там есть допустим вот мы и потом говорим что собственно Надо ли тогда у нас прилетает непосредственно уже полное очистка тех что мы сделали из-за тепло наш оператор Вот и самый банальный пример так же как он стартап он клинаб мы делаем ждем что у нас все успокоилось устаканилось и спокойно выходит вот какая непосредственно группа у меня ну и мой кастомный ресурс для оператора просто дыма банально написан самое что важное мы делаем это описание Что это у нас именно как я уже говорил описываем имя описываем спеку это шапка которую нужно создать всегда дальше мы должны описать именно спеку вашего оператора Какая версия Open API система Например у меня есть properties у меня есть имя тип у него string и по умолчанию но дефолтный велью можно указать абсолютно любой на ваше усмотрение плюс типы бывают от объектов бурины и же с ними и от того как вы Опишите схему непосредственно будем и плясать при создании нашего оператора все отлично мы пишем операторы мы уже знаем операторы поперекся шире просто крутые Ну всегда Я спрашиваю а что у нас тестированием Я правда очень люблю тестирование одной простой причине я не люблю тратить свое время Просто и в разрезе операторов есть классика по имени тест очень простые тесты это все покажу и покажу как это описывается в операторе почти реально самый самый простой N тун тестирование и ручное но ручное это прямо большие вопросы не всегда ручной тестирование прям позволяет покрыть все что нужно по мне обычно для себя и в пайплане на пиары и с ними должны быть как минимум два вида тестирования это Unit тесты банальные энтуем тестирование с операторами тестирования достаточно просто реализовывается для тестирования достаточно использовать камень опять же я не скрываю как я не люблю minique И что он абсолютно не нужен для использования не локально тем более для разработки и собственно Это две вещи которые в принципе работает так как нужно проблем с ним таких прям уж серьезных у меня не было поддерживает Ingress и можно задеплоить все что угодно и катул собственно утилита для entuen тестирования Ну тут стоит оговориться что на самом деле с помощью катал можно устраивать и делать тестирование не только для операторов но и для сел спокойно и Тула достаточно легко встраиваются все сиди пайплайны на моем моей память у меня были проблемы только с рандерами для потому что их встроенные раннеры которые Ну докер там своеобразно построили там можно собирать но чтобы полноценно запустить кайнд пришлось делать свои кастомные вот собственно мы поговорили бегленько да потому что чтобы глубоко копнуть в операторы это нужно не 40 Там пять минут это нужно устроить софистику на не знаю несколько часов и А лучше пару недель чтобы глубоко копать Ну теперь вот перейдем непосредственно к операторам Итак я создал структуру у меня большому счету оператора достаточно просто я использую обычный питон версия 3.8 Я точно помню у меня есть простенький makefile из-за того что у меня платформа m1 и ARM собственно для простоты для оператора достаточно как всегда докер и основное что у меня есть в Пираты Теперь мы пройдемся что есть операторе и непосредственно посмотрим что мы делаем собственно У меня есть хелперы которые мне помогают на самом деле 2 это на создание и на удаление то есть на создание что мы делаем у меня тут очень простой я взял enginex банальный New Engine X вот у меня создается сервис меня создается дипломинг у меня создается сервис аккаунт на удаление то же самое на самом деле для оптимизации не обязательно это все выносить непосредственно создание удаления можно программными средствами с помощью определенных грязных хаков сделать что на вход функцию вас подается непосредственно какой метод нужно создание удаления и какой именно метод из пайкуба использовать я использую для простоты для скорости именно разработки подключение клиента собственно я это использую если у меня в зависимости от того либо у меня есть я запускаю точнее Извините я спускаю мой оператор локально либо запускаю оператор непосредственно в кубе это что касается хелперов это не столь интересно опять же как я говорил можно использовать template для упрощения тогда по большому счету берете готовый Ямал дипломинка делаю задаете переменные а потом рендерите переменные как например банально Как готовить вот эту я взял не поверите для джинса обычного обычные демо который создается задал ему определенные переменной в данном случае имя количество репликации образ и потом на основе этих темплейтов непосредственно тепло и оператор также чисто по привычке что делаю рендеринг каждого тимплейта опять же не обязательно делать рендеринг template прям вот для каждого проходимся циклом рендерим template до входных переменных будет больше но будет меньше файликов будет меньше кода опять же собственно на логин на клинаб и конечно же не обязательно прям структурировать что у нас сначала логин потом по большому счету это вообще без разницы В какой последовательности вы создадите вот самое главное это вот создание собственно у меня группа собственно на создание ресурсов я и спике получаю имя Я испеки получаю образ который за диплоить на основе этого рендерил template и говорил что ребятки давайте-ка мы создадим по очереди сначала дипломинг потом сервис опять же мы сейчас рассматриваем пример в реальных операторах это немного сложнее конечно Ну и на удаление мы опять же должны удалить непосредственно по очередности а то придет слой фенолайзер собственно лазер конечно же и вы будете вы немного застрянете это что касается прям как видите прям очень очень ваза прям очень просто это все конечно прекрасно но теперь тестирование мои любимые тестирование опять же можем писать Unit тесты что по большому счету пройтись по лайфсайку сделать объекты сделать а Surf Что у нас там Мы вышли с нулем Мы вышли там у нас количество репликаций мы поставили там 2 1 и так далее и тому подобное но Юнит тесты не особо интересные Теперь мы перейдем непосредственно к ntn тестированию для перед тем как сделать тестирование нам нужно создать два файлика большому счету два конфига данный момент видите первый это описывает конфиг в моем случае я использую версию 1.25 то есть соответствие версии губернации версии 1.25 я расширяю память и при подготавливаю для использования в данном не показывается Как тестировать именно что мы в паблик наши создали Ingress Но на самом деле это достаточно просто исполняется и второе это именно настройка непосредственно коту собственно мы здесь должны указать используем ли мы kind или не используем startcoin тут есть два момента Вы можете использовать тестирование с помощью коту на реальном кластере То есть просто котл возьмет текущий контекст подключиться с вашими кредами и начнет выполнять либо непосредственно развернет в моем случае я еще кэширования указываю где у меня конфликт находится каинда где у меня будут лежать артефакты после билда и результаты тестирования в данном в данном случае я использую храню в джейсоне можно в xml и по большому счету можно потом агрегировать и смотреть уже непосредственно через во времени скажем так собственно Я указываю должен указать всегда где у меня хранятся тесты из контейнерс Это такой небольшой грязный Хак собственно не секрет что у нас оператор нужно откуда-то стягивать но зачем мне использовать какой-то еще regis 3 я могу на старте собрать образ и запустить его непосредственно запихнуть его в и использовать и я буду делать параллели как один по большому счету зависимости опять же от оператора Вы можете использовать фактически трейды и параллели в параллели запускать по количеству ваших процессов процессоров ядер вот ну и рассмотрим самый простой тест Это полный диплоид Здесь также у нас есть непосредственно assert который я делаю У меня должен быть дипломин укатал описывается как то есть вы применили сделали Play вы за диплоили допустим тот же Джинкс у вас там взлетела одна репликация и соответственно для ассертов Вы описываете то есть когда подключается к кластеру получает ваш дипломмент и начинает проверять что разницу между тем что за диплоина перед тем что у него есть данном случае катал будет проверять что у меня есть дипломе с названием и лейблы приложения будет собственно на основе этого делается вывод на соответствие что мы за тепло или ждем что нам нужно Но перед тем как это проверять мы должны создать непосредственно что мы будем проверять И у меня есть именно сам дипломинг для оператора и сам диплом дальше Я создаю именно кастом ресурс который называю что он меня кайнд Джеймс опевершен который у меня Family и непосредственно вот namespace испека У меня всего лишь как я показывал до этого в templay То есть всего лишь две переменные это имя и образ я буду диплоить 116 инжикс версии собственно это все конечно хорошо Ну а теперь как это выглядит Когда мы все-таки это запускаем сейчас будет нет красиво Извините что у меня собирается образ образ запихивается так скажем грубо говоря в контейнер вот далее мы стартуем kind и соответственно дальше начинаем диплоить оператор вот увидите что у нас добавился образ Мы создали Мы создали непосредственно объекты которые нам нужны начинаем прогонять тестирование вот И теперь мы ждем пока у нас все создастся и провериться вот собственно немножко и получите вещей тест должен сейчас завалиться по крайней мере надеюсь он кажется Ну ладно это собственно тестирование пока идет вот а на самом деле последнее что мы посмотрели и как можем сделать вывод что в принципе написать оператор просто тестирование Написать ему достаточно тоже просто но структурировать и непосредственно сделать правильный оператор Это титанический труд Надеюсь что базовую базу я показал и продемонстрировал вот на этом У меня в принципе все немножко меньше чем планировалось но надеюсь на хорошую продуктивную дискуссию Юра большой тебе спасибо Юра большое тебе спасибо за доклад очень было интересно наверное смотрю у меня есть один вопрос Лично от меня вот скажи пожалуйста как ты считаешь какой момент времени все-таки необходимо начинать писать оператору потому что ребята считают что если у нас предложение достаточно простое нам достаточно просто его фильм стал пластырь И зачем нам операторы вообще нужны где вот граница когда написание операторов становится выгоднее написанием оператором операторов становится выгодно когда нужно более оптимально диплоид приложения например плюс это один из примеров вторая вещь Когда нужна дополнительная логика к операторам например чем мне не нравится тот же хел при теплое у нас достаточно худцы и функционал incription собственно при написании оператора генерация определенных вещей создания тех же паролей будет немножко оптимальным в этом плане плюс операторы достаточно хороши Когда у нас еще идет дополнительная логика взаимодействия с другими операторами например приложение нужен Бакет допустим в амазоне приложение нужно ходить в создать базу данных тогда это будет немножко проще в управлении будет все из одного места также многие используют операторы на самом деле губернатиз как единую точку входа такой для управления облаками У нас есть наш оператор который управляет нашим зоопарком облаков и нам проще пользователю грубо говоря выдать маленький манифестик на основе этого манифеста в зависимости инфраструктура определенному и нужен менеджмент через оператор Да Большое тебе спасибо я думаю что вопрос отвечу И я предлагаю наверное перемещаться в дискуссионную комнату где мы могли бы более подробно обсудить все хитрости написания тестирования"
}