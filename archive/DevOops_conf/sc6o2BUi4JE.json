{
  "video_id": "sc6o2BUi4JE",
  "channel": "DevOops_conf",
  "title": "",
  "views": 0,
  "duration": 0,
  "published": "",
  "text": "Всем привет Меня зовут каржоев Дмитрий компания VK сегодня с нами Дмитрий Рыбалко он отвечает за инфраструктуру сбермаркете Дим привет Привет Как говорит сам Дима за время работы в компании он пережил несколько этапов бурного роста один из них был в 11 раз Дима расскажи как получилось получилось очень просто Наша компания бурно развивается Из года в год и по моему предыдущий год как раз таки мы вышли на рынок всей России соответственно это спровоцировал бурный рост за время которого было пересмотрено и может быть сделано много информационных вещей какие-то были сделаны продуманы какие-то непродуманные И сейчас мы переходим на рельсы уже подумала управления и одним из таким кейсов Я бы хотел поделиться своей презентациями соответственно управление ТВ сертификатами в инфраструктуре как мы пришли от хаосного управления к тому процессному управлению отлично давай перейдем доклады тогда для зрителей хотел напомнить что у нас работает чат во время доклада можете задавать вопросы в конце обязательно их обсудим если не успеем в блоке вопросов и ответов то после доклада будет еще в дискуссия в кулорах Дим тебе слово мне Меня зовут Дима Я работаю в компании сбермаркет На позиции старший инженер инфраструктуры проживаю в прекрасном прекрасной области Калининградской области сейчас у нас очень тепло захватить последние теплые деньки причем Всем привет начнем из моего доклада Сегодня вы узнаете как мы управляем сертификатами Какие центра выдачи сертификатов используя используем раскроем вопрос безопасности в частности раскрытие информации через сертификаты расскажем о тех операторах и дополнительных средств по управлению сертификатами среди губернации в целом опишем наш опыт с чего Мы начинали к чему Мы пришли и возможно к чему пойдем дальше прежде всего хотелось бы рассказать о том что такое инфраструктура сбермакета сейчас прежде всего она базируется по направлению губернатор звезд Это означает что все что можно все что мы делаем Мы в первую очередь пытаемся за диплоить развернуть внутри губернации инфраструктура себя представляет выделенные дата-центра расположенная 6 зон доступности и Пару десятков губернаторских мастеров чтобы понятно было что такое кластер среднем Это около 200 нот на которых в среднем базируется 10 тысяч кодов и в каждом кластере в районе 5000 сертификатов присутствует для начала чтобы говорить на общем языке хотелось бы немножко теорию окунуться соответственно у всех на слуху кто-то видит кто-то слышит есть реально у нас уже не прикиньте технология все это протокол криптографические защиты обеспечивают защиту передачи данных самым верным самым емким определением как мне показалось дала амазон Что такое то есть сертификаты Давайте сертификаты в первую очередь нам позволяет проверить подлинность наших веб-сайтов устанавливать с ними зашифрованный сетевые соединения в целевом кластере для нас ТВ сертификат выглядит как ресурс секрет типа купернета своего твс с набором двух полей всего лишь RT в котором находится цепочка сертификатов от соответственно центр выдачи промежуточный какой-то сертификат может быть и конечно наш сертификат и также приватный ключ что касается МТС сертификата то это тот же секрет с измененным типом уже в который добавляется дополнительное поле это все секты может состоять Как из одного сертификата так из множества сертификатов удаленной системы 5 10 может быть в нашей компании мы разделяем все сертификаты на 4 вида в первую очередь краткосрочные сертификаты которые мы используем преимущество для среды разработки центром выдачи для них является лиценскрипт Почему именно он Расскажу чуть дальше в наших изысканиях и поисках и также мы используем только вилка Карцев сертификаты тоже чуть позже дальше долгосрочные сертификатывает сертификат сертификаты которые передают нам контрагенты для для создания был портала соответственно такие сертификаты долгосрочные был мы используем как среди разработки для тестирования и продакшн среде издатель может быть здесь любой абсолютно и для долгосрочных своих сертификатов Мы также используем может быть Окей управление сертификатами самое очевидное и самый простой путь которого в принципе возможно все начинались которого мы начали рассматривать это диплоид ингрессов губернатос нужной аннотация для всех менеджера который идет уже в летний скрипт соответственно получается сертификат и наш начинает обрабатывать квс подключением в этом подходе все хорошо здесь появляется некая автоматизация есть такой примитивный мониторинг на базе всех менеджера который она может подсказать что сертификатом что-то не так сам пойти его обновить но данный подход Мне кажется обладает рядом минусов которые для нас не подходит здесь отсутствует управление в том виде которая Мы представляем и которые я буду декларировать в моем докладе также данный подход подходит на 1-2 кластера при большем количестве у нас появляется дубль сертификатов что может негативно повлиять на лимиты для санскрипта у нас начнет банить соответственно есть проблемы с безопасностью и так как мы использовали транскрипт то возможно что все сертификаты будут 90 дней нам нужно например годовой хорошо холевар конечно но как мы пришли к карцертификатам для себя мы задали три вопроса Первый из них это количество сертификатов так как каждый сертификат представляет себя секрет среде губернатос то конечно один секрет один вилка сертификатов смотрится намного выигрыше чем множество секретов сертификатами для каждого Хоста второй вопрос который мы для себя задали это раскрытие информации например на нашем же примере используя публичные сайты попробую раскрыть вопрос раскрытия информации прежде всего мы обратимся в такой замечательный сайт DNS donster который умеет делать dump-зоны проверять шаринг IP рисовать прекрасные схемы по которым можно понять Какими дата-центрами какими ресурсами мы пользуемся возьмем наш один из старых доменов раньше компания Сбербанк называлась сделаем при помощи данного сайта дам данные зоны и пойдем проверять шаринкой на первом же Хосте на первом же IP адресе мы увидели список дополнительных доменов служебных доменов это мы запишем и запомним чтобы воспользоваться этим списком на втором портале второй портал называется сердце а преимущество ее главная функциональность данного сайта то что он хранит информацию себя по всем всем сертификатам изданных как лицен скрипт так и другими издателями у себя У него есть прекрасный поиск даже SQL поиск есть И если вы где-то ошиблись например в одном сертификате включили несколько других доменов он это также все выведет и покажет на примере собрана ранее информация соответственно соберем информацию по супермаркетчу Увидим что информация есть 2021 20-х годов где были как раз таки использованы сертификаты perfost и они позволяют узнать какими сервисами мы пользуемся внутри какими пользовались соответственно их стоит и прочую информацию на базе двух открытых порталов мы можем собрать информацию о внутренних сервисах компании а поэтому вилкарт смотрится предпочтительнее так как он все скрывает за звездочкой и нельзя уже собрать информацию третий вопрос который мы себе задали это масштаб компрометации Согласитесь что если у нас ведь еще от вилка сертификат со звездочка его ключ то звоночник может сделать очень много вещей когда утекает один сертификат на один конкретный хост то его можно очень быстро заменить хост изменить и как-то митинговать ситуацию данный риск Мы приняли и решили как решили чуть позже в моем докладе естественно выбор что мы выбрали и сделали из него используем сертификаты хорошо с типом сертификатов мы определились Какие бы мы использовать будешь найти того идеального издателя который будет поддерживать все наши хотелки автоматизацию поддержки чтобы они были бесплатные авторизация через DNS поддерживать различные количество дней выдачи сертификатов поддерживать очень важная технология которая также дальше расскажу и соответственно мы начали делать анализ топ компаний которые занимаются и могут создать бесплатно сертификат Очень бы хотелось здесь видеть конечно Российские компании в будущем Что есть то есть наш анализ показал что есть пока две компании которые удовлетворяют нашим требованиям скрипты разница между ними в том что есть платные тарифные планы которые позволяют решить все лимиты присутствующие бесплатно тарифном плане только бесплатный тарифный план и он этим выигрывает то что он бесплатен то что Он позволяет бесплатно тариф компании создавать достаточно много сертификатов К сожалению такого нет и с преимуществ Еще хотелось бы отметить что у него есть поддержка Sun для веллдхардов есть поддержка нескольких типов шифрования для сертификатов Конечно есть какая-то лимит который можно отнести в минусы но при грамотном подходе к техподдержке лимиты можно увеличить и конечно есть поддержка delegation domain Из минусов как я говорил ранее есть лимиты которые можно ли очень легко опереться и так как это западные издатель то возможно станцию текущее время для наших нужд подошел летом скрипт Вернемся из мира теории в мир прикладных решений Начнем с того с чего Мы начинали создавать нашу инфраструктуру управления сертификатами для начала как И большинство мы используем heum для диплоиров каких-то сущностей в губернатос соответственно при помощи него мы диплоим сущность сертификат Давилка сертификата для серф-менеджер sect Manager уже идет в лиценскрипт и издает сертификат Все выглядит красиво и просто но что делать когда у тебя доменов не каждому есть прямой доступ и каждому есть прямой доступ даже к его DNS первый вопрос был поставлены перед нами соответственно первое обходной путь которую мы можем использовать это DNS Challenge и второй путь это его дополнение как мы делегирование домена хотелось бы сказать очень классная функция Она позволяет делегировать третьему домену авторизоваться авторизовываться для подтверждения нашего домена который мы хотим проверить на которой мы хотим издать сертификат То есть получается что у нас есть сотни доменов которые необходимо выпустить сертификат и для этих целей У нас есть один маленький служебный домен который у нас есть доступ безопасности к нам предоставила создала создала дополнительные записи и вся автоматизация проходит фоне получается что делегирование домена очень важно и нужно использовать когда мы хотим выпускать сертификаты но у нас нет доступа корневой зоне того домена который мы хотим выпустить сертификат либо же наш хостинг оператор наш хостинг провайдер не поддерживает интеграцию всех менеджером автоматизировать очень хочется соответственно менеджер является скрипт поддерживает данную технологию и Можно ей пользоваться на примере данного слайда я показываю Как выглядит запись в DNS зоне для делегации также если мы хотим сделать для вилка сертификатов записи записи идентичны и либо сертификаты также записи идентичны хорошо по краткосрочному сертификатом понятно как мы их используем Что касаемо долгосрочных сертификатов А их путь не такой интересный автоматизированный Потому что есть сотрудник информационной безопасности которая получает сертификат выпускает этот сертификат и дальше размещает его хранилище вал там из золота данный сертификат уже попадает в губернация чтобы эта магия произошла мы использовали автоматически получить сертификат для этого мы все используем тот же самый Home публикуем секрет в секрете необходимо указать в первую очередь важный блок в аннотациях это путь до болта соответственно путь внутри Валта и ролик который необходимо для авторизации дальше дата поле у нас размещена b64 закодированы полный путь до того места внутри кивала хранилище Где расположены наши данные если есть доступ у данной роли по данному пути наш наша заготовка секрета заполняется валютными данными изолта Далее для того чтобы секрет растиражировать во многие у него есть понятие как секрет источник в котором указывается аннотации что данный секрет позволяет себя реплицировать второе поле задает темный экспрессы куда можно его реплицировать и уже в name Space в которых мы реплицируем я их называю секрет приемник также создается пустой секрет с двумя аннотациями первая аннотация говорит нам что необходимо сходить с реплицировать секрет из нужного нам спейса материнского можно сказать спейса и нужно секрет второе поле это обязательный Костыль без которого а при диплои через схему либо кастомайз Секрет будет всегда пустым так как hem он обнуляет то есть он диплоид получается апд делает и ТВ скейтс RT они будут пустыми репликейшн вешен аннотация сопоставляется самим оператором губернацией репликатор если она будет пустая Этот триггерет сам оператор дополнительно синхронизируется если я не поставит то Костыль которому много много лет и до которой висит еще тем не менее он работает плюс подходы плюс подхода мы получаем уже декоративный подход то есть мы фиксируем Какие сертификаты куда нужны куда они нужны все это хранится в гите у нас появляется мониторинг состояния сертификатов минуса данного подхода заключается в сложности сложность обновления Вот именно из-за работы банзайклауда чтобы обновить данные из Валта необходимо обновлять секрет через Force я вам Great for сделать тогда данные будут забираться и актуализируется без этого ключа данные будут не изменяться и можно получить ситуацию когда сертификат уже истечет и дополнительно у нас появляется такой минус как наличие копия сертификатов в каждом чему же мы пришли сейчас и сейчас используем сейчас все запросы абсолютно все запросы на создание отзывы сертификата фиксируется в гите дальше используя detops-технологии происходит публикация данных запросов специальной инфа классе которые для краткосрочных сертификатов Используйте те же технологии Set managerscript и запрашивает либо обновлять сертификаты после чего они автоматически публикуются в кровавых хранилище вал там долгосрочными сертификатами был сертификатами история повторяется сотрудник информационной безопасности берет выкладывает сертификаты в кивала хранилище дальше же после того как сертификаты появились нам их необходимо разместить в нужных мастерах нужных нам спейсов также автоматически Для этого нам позволяет сделать бекингах плюс у него очень хороший мониторинг каждого движения каждого каждый синхронизации мы можем увидеть позволяет выборочно копировать в секрет необходимые данные из вал там делать составные шаблонизированные различные варианты использования благодаря такому подходу У нас появился мониторинг каждого шага реально каждого шага появился контроль целостности сертификатов так как у нас появилась единое место хранения то у нас появляется версионность и благодаря этому возможность быстро и массовой замены сертификатов плюс так как мы используем секрет вместо банзаев то у нас появляется постоянный периодическая автоматическая синхронизация там уже не нужно думать о том что минусы данного подхода как мне кажется остается остается вопрос в том что у нас в некоторых нам спейсах сертификаты еще дублируются и к ним есть доступ и кажется что это все еще сложно процесс которым можно облегчить и сделать быстрее дальше для управления сертификаторы хотелось бы отсудить вопрос мониторинга в первую очередь для мониторинга мы используем Такой оператор как x5 x 509 сертификат exporter основной функционал заключается в том что он может мониторить наши секреты заданных типов и полей проверим проводить валидацию инвалидность как чтение так и время и время их использования также из коробки имеет простой и понятный по которому можно все увидеть второй exporter который мы используем это sslix Sport основное функционал для чего мы его используем Это проверка на проверка на отзыв сертификаты из коробки К сожалению данный экспорт имеет только о CSP но небольшой патч из пару строк который Возможно скоро во льет основную ветку это дает ему поддержку списков доступа отзывов Прошу прощения и третий экспорт который мы написали сами которые ждем одобрение для публичной публикации это позволяющий мониторить наши сертификаты расположены соответственно также проверяет на валидность сертификаты на время их использования и случае чего дает метрики для которых строится уже управление было бы не полное если бы мы не позаботились о чистоте частота в первую очередь чтобы наш кластер не захламлялся старыми сертификатами секретами которые уже не нужны так как у нас используется за основу берется для всех менеджера необходимо включать аргумент сертификатный РФ это простой аргумент который позволяет серф-менеджеру автоматически удалять секрет при удалении сертификата кастом ресурсы сертификат последний hyuncharted начиная по моему с 12 версии появилась опция которую мы можем включить и менеджер будет это делать У нас если не сделать то у нас появляется большое количество сертификатов секретов Прошу прощения уже не использовались сертификатов которые не обновляются и наш мониторинг Может начать сходить с ума для секрета оператора решается Все намного проще секрет используется билет по лесу билет и соответственно после того как нам не нужен автоматически чистится Подводя итоги моего доклада совокупность таких подходов как декоративный контроль шагов ответственность за безопасность мониторинг получается всех этапов дает нам простое управление на этом я хотел закончить свой доклад Если есть вопросы прошу задавать писать их чат Буду рад ответить Дима Большое спасибо за доклад было очень интересно наблюдать эволюционный процесс который происходил внутри компании Давай перейдем к вопросам так первый вопрос почему для сертификатов не Используйте pki а именно криволили если вопрос про на самом деле мы его используем используем чисто для истин для других целей нам не подходит потому что у нас большое количество внешних интеграции где внешний интеграции там боль сама подписанными сертификатами центрами выдачи поэтому мы решили использовать получается внешние сертификаты и продолжаем их использовать Раз уж заговорили про именно вот Следующий вопрос насколько знаю хешкорд ушел из России какие есть адекватные альтернативы для ЛК шикорд ушел из России соответственно больше не предоставляет Enterprise подписки но комьюнити Edition как было так и работает Так и живет соответственно можно пользоваться есть прекрасная конечно альтернатива ему но она также Западной разработки компании которые также ушла и здесь сейчас подвешенный вопрос что же лучше да что же не ушел из России может быть стоит задумываться разработке собственного подобного продукта насколько времени Это займет тоже в целом учитывая ситуации возможные санкции рассматривайте вопрос что-то написано мы изначально не используем решение которое до сих пор поддерживается доступно и доступно у нас в России в этом плане рисков так Следующий вопрос Какие сертификаты еще покупаете кроме ledsencrypt сертификаты покупаем долгосрочные сертификаты которые сдаются на год покупает их много плюс к этому У нас есть White Label сертификаты которые передают нам Наши партнеры они также бывают двух видов либо летом скрипта но зачастую это сертификаты куплены на год Чтобы не мучиться с их сдачей и обновлением поэтому данный процесс есть данный процесс учитывается мониторится Спасибо ты вот сказал что написали exporter для ЛД Следующий вопрос как узнать о публикации когда поступит в Open Source У вас есть какое-то официальный канал Как следить за этим Да у нас есть собственная получается проект компании сбербанкет там мы выкладываем Все наработки как в области инфраструктуры так и в области продуктовых решений соответственно какие-то наработки на Голландии Точно не скажу что ребята из продукта выкладывают за инфраструктуру отвечу что Мы только начали путь движения соответственно проходим сейчас все согласования чтобы свои наработки туда также начать выкладывать и делиться сообществом поэтому можно подписаться И как только появится новый репозитории с нашим кодом все есть вопрос как работает а как она работает соответственно у нас есть сертификат одной стороны сие файл с другой стороны либо полный сертификат соответственно с нашей стороны происходит При установлении tls сессии одна сторона подтверждает что это наша сторона с другой стороны приходит также сертификат подписанный сейф файлом получается сертификатом другой стороны наша страна понимает что с другой стороны также доверенный хвост доверенный клиент которому с которым мы можем установить самое надежная система для Подскажи вот сколько времени в целом заняла эта эволюция исследования различных решений в районе полугода заняла причем большая часть времени была затрачена на внедрение перехода на них наших мастеров после того как гитовс был внедрен то автоматизация уже пошла как по маслу и достаточно быстро разошлась по всем костям это у вас выделенная rnd-команда какая-то этим занималась или как Или это в рамках это занималась наша команда базовой инфраструктуры соответственно в рамках приведения данного процесса в порядок создания процесса Спасибо так в чате вопросов пока нет хотел напомнить нашим зрителям что после завершения блока вопросов и ответов мы еще перейдем в дискуссионную зону если появится вопросы можно будет обсудить там и в целом У вас есть возможность также оценивать доклад это очень важно для организации конференции прошу ставить ваши оценки Дима Подскажи еще вот в текущих схемах что там удалось увидеть ты озвучивал Да выглядит что вал становится таким узким местом как бы обеспечиваете отказоустойчивость Валта учитывая мульти DC вот все эти вот изначально развернулся соответственно присутствует в нескольких зонах доступности которая также развернут инсталляции также присутствует во многих зонах плюс вот по существу Как таковой не становится узким местом единая точка отказа потому что у нас нет синхронность действий у нас получается все действия синхронность нужна только в момент создания нового сертификата Да и его публикации в каком-либо кластер когда сертификат уже создан то периодическое обновление Это примерно 10 часов она по таймеру совершается если даже вот момент будет недоступен то за 10 часов мы его конечно же реанимировать но пока такого не было Надеюсь не будет потому что те решения от самого кошельков а для его или были решением пока не позволяли нам На тестах сложить а вы проводите какие-то учения там с этим пока такой постоянной практики Нет ну да поэтому возможности Подскажи Вот были вопросы Да звучит это возможные санкции уход из России некоторых вендоров в целом сертификатыми цифры не рассматривали не тестировали они тестировали Но со стороны управления вообще сертификатами Понятно спасибо так но в целом наше время в эфире заканчивается призываю всех Да Предлагаю перейти в дискуссионную зону и там уже более расслабленные обстановки пообсуждать какие-то вопросы Всем спасибо не забывайте ставить оценки До новых встреч до новых встреч"
}