{
  "video_id": "b8e5_4pg6B4",
  "channel": "HighLoadChannel",
  "title": "",
  "views": 0,
  "duration": 0,
  "published": "",
  "text": "Всем привет кто в столь ранний час добрался досюда Всем спасибо Меня зовут Женя веретенников можно просто Женя Да и я в Яндекс вертикале руковожу командой которая делает инструменты для разработчиков Короче говоря мы пишем код чтобы другие программисты могли быстрее и эффективнее писать код наш главный продукт - это моно репозиторий для так называется собственно э За что мы в нём отвечаем за инструментарий для сборки для запуска тестов и за многое другое и Сегодня я расскажу как мы в этом самом монорельсы в режиме blackbox то есть мы не заглядывали в то там Какой код в этих тестах Какие конкретно там с ними проблемы возникают А мы находили такие флаки тесты просто по тому там запускаются они с успехами или с ошибками и дальше проводили определенные действия с ними может возникнуть вопрос А в чём вообще у нас была проблема с флаки Проблема была в том что разработчики из разных команд регулярно натыкались на флаке тесты и сообщали нам что вот там-то там-то тесты Упали в одном сервисе В другом сервисе причём Что может быть больнее чем тест твоей команды который флаг у тебя где-нибудь в порек весте Ну пожалуй только тест чужой команды это вообще неимоверно бесит когда такое происходит и такое бывало частенько Мы живём в норе разные команды живут совместно В общем такая проблема была и в какой-то момент я спросил у наших разработчиков А что нового вы бы хотели у нас в манаре увидеть какую-нибудь автоматизацию Может быть там автообновление зависимостей или там авторелив продакшн на что я получил ответ э в общем пожалуйста научитесь автоматически наказывать за флаки тесты И как мы это сделали Я сегодня и расскажу а для начала чтобы на одной волне быть расскажу какими терминами буду пользоваться в какой-то момент при подготовке доклада Я впал в такую степень прокрастинации что Зачем ты полез в яндекс-переводчик смотреть А что такое флаки тест он мне почему-то сказал что это слоёная тесто Google переводчик тоже не сильно лучше мне в этом помог но мы будем флаки тестом называть такой тест который возвращает то успех то ошибку Даже при том что изменений в коде никаких не было То есть это такой нестабильный тест Это самый бесячий вид тестов в общем-то который наверное только есть транком Я буду называть основную ветку разработки из которой разработчик создаёт новые бранчи в которую он потом ржет свой код си чеком я буду называть проверку кода в реквест которая проверяет весь код каким-то образом и возвращает тоже либо успех либо ошибку и хочется чтобы опять же такие C чеки были как можно более консистентные компилирует код и запускает тесты именно эти тесты мы и будем лечить от флагов немножко контекста про нас Мы живём в манаре в ней живут 15 команд это порядка 100 разработчиков 4 млн строк кода логично предположить что чем больше кода тем больше тестов нужно чтобы этот код покрыть и надёжно с ним работать вот у нас это десятки тысяч тестов причём ну можно так сказать что все тесты запускаются в порек весте то есть может быть такое что ты там изменил код одного сервиса А код другого сервиса который от него например зависит каким-то образом э тоже проверяется в этом же самом реквест А это конечно же там упрощается для разработчиков с помощью Шей То есть если тест если То от чего тест зависит никак не поменялось то тест на пол реквест Не перезапустите результат возьмётся из каша А И при этом всём Мы хотим чтобы у нас транк был зелёным то есть чтобы тесты в транки всегда были зелёными и чтобы разработчики могли на них качественно опираться потому что это позволяет делать более качественные продукт и вместе с тем мы хотим чтобы прогон тестов в среднем занимал 3-5 минут э это достигается за счёт Шей в первую очередь и за счёт распределённой сборки то есть у нас тесты запускаются на кластере из машин это работает с помощью системы сборки Базель которым мы пользуемся а ещё немножко контекста конкретно про нашу команду ещё раз мы делаем именно инструменты для разработчиков то есть мы не отвечаем за вот эти вот все десятки тысяч тестов мы предоставляем инструментарий чтобы разработчики могли эти тесты запускать локально в квестах неважно И в общем-то мы не хотим ходить и всем чинить тесты Потому что часто мы не разбираемся А что там за логика внутри ну это просто слишком дорого для нас Но вместе с тем мы видим что разные команды натыкаются на проблемы и хотим чтобы эта проблема один раз для всех где-то на уровне инфраструктуры решилось что ж я думаю теперь контекст задачи понятен Давайте начнём её решать так как это делали мы мы начали с банальной вещи воткнули ретра на C То есть если тест падает мы его один раз ретра и если второй прогон был зелёным то мы считаем что тест не должен фейли наш c это дало два последствия позитивных первое очевидно с Рами сборки стали падать реже второе очевидно помните определение флаки теста которые мы в начале давали это тест который упал который может упасть А может быть зелёным на одном и том же коде вот здесь ровно это и происходит то есть у нас типа в одном и том же реквест на одном и том же коде тест упал потом поднялся Значит мы его можем считать флака уим вот такое событие мы считаем событием флака Ну или просто Флам как мы его называли и по таким событиям мы начали строить статистику мы сделали дашборд по флаке тестам Там было два таких основных графика первый - это график в разрезе по дню и тесту То есть каждый столбик здесь это день например там самый левый столбик на этом графике это флаки события флагов за десятое июля а каждый столбик каждая полосочка вернее вот в этом вот столбике это там конкретный тест какой-то Вот то есть здесь видно например что Изо дня в день какой-то тест который помечен зелёным цветом флака ет больше чем другие То есть чем шире полосочка тем чаще тест флака второй график который у нас был на этом дашборде более очевидный Пожалуй это топ тестов по флагам Вот То есть можно было выбрать интервал времени здесь выбрана та же самая неделя за который был прошлый график и видно что там был один тест который был Прямо супер в топе который лакал гораздо чаще чем другие все остальные флако или пореже как этот дашборд работает когда разработчик создаёт requ как мы уже знаем на C запускаются тесты и логи этих тестов Мы складываем в S3 потом асинхронным процессом перекладываем их вха бы можно было Быстро строить аналитику по этим тестам и график делает запрос уже напрямую в кликхаус ничего сильно сложного что мы ещё сделали мы позалини позалини транк и вообще ожидание было что в большинстве случаев то тесты будут зелёными там стабильно реальность не совпала с ожиданиями вот мы пару дней здесь каждая точка - Это один прогон C билда Она зелёная если сибил на ранке отработал успешно Красная если неуспешно вот и в 25% случаев мы по факту имели красный транк Что это значит что разработчики в своих рекхи натыкались на какие-то левые проблемы не связанные с их изменениями вот это довольно-таки комарно там было две основных причины падений Первая - это собственно флаг тесты вторая - это там какие-то проблемы с инфраструктурой вот мы решали обе из этих проблем я расскажу про то как решали проблему с флаки проблемы с инфраструктурными изменениями решались проще и менее интересно поэтому про это я рассказывать не буду А ещё кстати важный момент прямо минимальная минимальная оценка сколько там падало от флаки как бы как правило 5-10 про сборок порой бывало и больше что ж мы статистику собрали что же с ней делать дальше возникла такая очевидная идея можно тить тесты Мы даже сделали механизм который это делает но представили себе что через год-два у нас в море Огромное огромное количество зам тестов на которые никто никогда не смотрит и в общем эту идею мыли Так мы негу ложили эту задачу и в какой-то момент я просто шл от метро в офис и придумал такую концепцию как карантин что это такое это отдельный C чек в который мы отправляем проблемные тесты Ну Казалось бы вот у нас был один C чек в котором была сборная солянка стало дваче в котором всё также все тесты запускаются в ЧМ разница Казалось бы Разница в том что вот на основной C Build который мы хотим оптимизировать в плане его зелёно Он для межа обязателен то есть разработчик по сути не может смр с красным си билдом А вот этот отдельный карантинный чек он для межа не обязателен То есть в принципе если флака ущипнуть может его проигнорировать и спокойно мержить код в тран э как бы вот эту концепцию я придумал по сути Вот пока шёл к офису и затем уже мы нашли где-то В недрах сайта Мартина фаулера что ну в общем-то это Придумано Придумано до нас и у этого есть такое ёмкое название как карантин которое мы использовали по факту там буквально абзац текста где-то я расскажу куда более подробно что он даёт и какие проблемы с ним могут быть Итак что он даёт сибил очевидно становится стабильным потому что проблемные тест то мы оттуда убрали а при этом флаки тесты по-прежнему запускаются в этом качественное отличие от мьюта и проблемы с тестами всё ещё видны то есть разработчик может увидеть красные карантинный Билд и посмотреть А что это там такое и может быть даже починить сразу но вместе с тем сидеть в карантине всё-таки некомфортно потому что разработчик может по неосторожности сломать логику теста и он вместо флака щего станет совсем красным и бы это должно быть мотивацией что разработчики свои тесты всё-таки будут оперативно чинить что ж Профит понятен пошли делать как делаем каждый день в одно и то же время тут написано по крону такое условное упрощение Мы выбираем из того самого кликхаус со статистикой тестов в которые у на графики ходят Мы оттуда выбираем все тесты которые за день флаг нули больше двух раз такой вот порог мы выбрали затем мы в конфигах нашей системы сборки помечает как за карантине просто Ставим на него тег по сути на C билде мы такие тесты не запускаем Но запускаем их в отдельном си чеке и делаем его необязательным для ме Но этим мы не ограничились естественно когда тест попадает в карантин это такое инвазивное достаточно изменение и нужно чтобы разработчики об этом узнали у нашей норе есть коммьюнити чат в котором есть все наши 100 разработчиков и мы решили отправлять сообщение о том что какие-то тесты были отправлены в карантин в этот чат Там же прямо в сообщении можно было нажать на кнопку меры флагов ээ которая переводила вот на страничку которую вы уже видели там можно было нажать на красную кнопку посмотреть логи упавшего теста что должно было помогать при де баге этим Мы тоже не ограничились была гипотеза Что такое разовое уведомление можно легко пропустить и тогда тест наверное останется в карантине на вечно поэтому Каждую пятницу Там ближе к вечеру мы отправляли текущий слепок тестов в карантине в тот же самый чат таким образом если тест из карантина долго не выходит вот эти вот уведомления приходят каждую неделю и это опять же напоминает разработчикам что у них есть такая вот проблема кстати в какой-то момент нам сказали что Пятница вечер - Это так себе время для такого для получения такого уведомления и лучше бы это делать Ну например в понедельник утром перед планированием Так мы в итоге и сделали ещё мы сделали крайне важную кнопку которая в общем-то полезна даже и без карантина на самом деле это провер кнопка проверки теста на флаке Супер простой механизм вбиваем тест который мы хотим проверить на флаке Ну то есть Его имя вбиваем число раз которое мы его хотим в подряд запустить э по дефолту мы подставляли сотню э и затем можно было после запуска и после завершения работы посмотреть вот такую вот красивую картинку э как часто тест флака ет то есть вот этот тест явно проблемный он флака в 20% запусков что очевидно будет разработчиков раздражать и эта кнопка она ещё и даёт по сути пайплайн фикса теста в карантине для разработчика То есть когда тест попал в карантин что разработчик может сделать и Обычно люди так и делали он может запустить проверку теста на ранке и посмотреть лакает ли тест в тран или нет иногда бывало что тест на самом деле в транки не флака тогда проблема была в одном из двух либо это была какая-то временная проблема которая потом ушла но такое было на самом деле крайне редко либо что было чуть чаще проблема могла быть в соседстве тестов то есть два теста запускались одновременно например и там конфликтовать как-то друг с другом за один и тот же ресурс из-за Чего один падал потом перезапуска успешно и вот получался флаг но в общем если не падает в тра получается нужно скорее не на сам Тест смотреть а на то что там происходит снаружи него Вот Но это был достаточно редкий кейс на самом деле чаще тест действительно фла тогда разработчику нужно пофиксить тест создать рест с этим фиксом и ещё раз запустить проверку кнопка проверки разработчик тест пофиксить даже с фиксом потому что не всегда можно очевидно найти Почему тест флака вот в таком случае нужно фиксить тест пока его не пофиксить окончательно по сути Когда наконец проверка Зелёная целиком можно спокойно выводить тест из карантина с помощью снятия тега карантин и вмешивать по request всё проблему решили наконец мы анонсировали вот эти вот изменения в нашем коммьюнити чате это было 29 сентября в пятницу Ну и сказали что вот в понедельник включим вот это вот всё вот этот вот весь механизм Итак запускаем карантин и сразу же получаем Профит вот буквально сразу после запуска флагов стало куда меньше это график такой упрощённый в разрезе только по дню без разбивки ещё по тестам Ну в принципе можно предположить где именно здесь на графике карантин включили вот синяя стрелочка - это момент включения то есть там до неё флагов было там в несколько раз больше чем после неё При этом если вот вернуть разбивку по тестам видно что до включения карантина были тесты как вот например тест помеченный жл на графике которые там Изо дня в день постоянно терроризировать разработчиков а После включения карантина Каждый раз когда такой тест появлялся он быстро достаточно переставал портить жизнь ещё такой неожиданный Профит можно было отправлять проблемные тесты вручную то есть бывали тесты которые флака не так как наша карантине на то что она задумано реагирует а о немножко по-другому То есть он либо всегда на одном билде отрабатывает успешно либо всегда падает Вот и такое было редко но иногда бывало э такое мы вручную могли отправлять э более интересный кейс иногда разработчики умудрялись ломать тест в транки там какими-нибудь параллельными изменениями в разных порек Веста например э и карантин в таком случае был таким быстрым способом починить тест не афект всех красных можно было бы конечно доклад на этом закончить но естественно была куча проблем о которых тоже хочется рассказать Первый из них Ну вот я говорил что разработчики будут чинить свои тесты Да все дела Вот реальность оказалась более Суровой чинили не всегда сразу по крайней мере и В таких случаях тесты ломались напрочь что приводило к тому что теперь надо чинить две проблемы поломанный тест и флака тест по сути занимательно Что быстрее всех свои тесты чинили команды про деньги видимо ребята максимально хорошо понимают ценность тестов И зачем они нужны В общем Почему не чинили одна из причин была до банального глупость что ли можно сказать они не всегда знали про карантин вот мы такие думали вот мы там в чат написали запили сообщение всем там всё отправили э вот был второй день работы карантина там отправилось сообщение что вот такие-то тесты отправились в карантин Ну я думаю на всякий случай нгану ответственных за эти тесты А ну ответ был весьма неожиданным на мой Пинг А что такое карантин у меня спросили Вот в этот момент Мне стало понятно что как-то мы не очень видимо классно ском и что на самом деле про карантин знают Не все как бы это такая простая мис коммуникация надо её фиксить у нас всё-таки 15 команд они там стоили 1.000 в Яндекс вертикале и это даёт возможность пойти и лично просто рассказать людям то есть типа 15 команд из них ещё тесты далеко не всех попали в карантин из них ещё часть там всё-таки про карантин узнали и нормально всё сделали В итоге рассказывать лично надо было мало кому на самом деле Ну это сделали объяснили что это и зачем ещё был момент когда мы просто пошли и завели тикеты то есть опять же там проще было вручную это сделать чем накручивать какую-то автоматизацию вокруг этого пошли завели тикеты на всех кто был В карантине такой момент тоже был и это помогло тоже пропу то есть тикеты - это лучший пуш чем пуш телеги и наконец вот э вот отправка сообщения в комьюнити чат это такой очень простой способ можно сказать отправки то есть мы про все тесты рассказываем всем что они попали в карантин гораздо лучше отправлять сообщение конкретной команде про конкретно попадание их тестов вот мы это назвали алерта на карантин То есть как алер про проблему в продакшене например приходит там в чат дежурного и он на неё реагирует вот Ну также и проблему с карантином тоже можно назвать алертом в общем-то как это работало после того как любой код в общем-то жил в тран для каждого теста в карантине мы находили владельцев этого теста и собственно отправляли им алертс один раз когда тест отправлялся в карантин то есть там на последующих комита алертность можно в папке своей команды Например там в папке команды биллинга сделать файл Build в нём указать за него отвечает команда биллинга в нашей системе мониторинга есть связка команды с чатом дежурного Ну и собственно туда мы отправляли что ж вот этими всеми способами мы сделали Так что теперь все про карантин знают ещё была вторая проблема что разработчики и так загружены у них там большой продуктовый клок А вы Т ещё со своим карантином В общем починим когда-нибудь что мы с этим делали по факту мы снижали нагрузку от карантина то есть разработчикам было жить с ним проще и у нас по факту были возможности для снижения первое заключалось в том что мы отправляли в карантин лишние тесты на самом деле Вот я всё время для упрощение говорил что мы в карантин отправляем тест это ну упрощение именно что на самом деле мы в карантин отправляли целый тест тоже для нас так было проще то есть что такое это Ну Такая сущность в которой тестов может быть много например там может быть Целая папка в которой тестов Там могут быть десятки сотни и если среди них есть один флака то в карантин отправляется всё как бы это проблема у нас было два подхода к лечению этого первый - это разбиение на несколько то СВ Таким образом мы выделяли сломанные тесты выделяли ла которые в этом те есть выделяли также тесты которые тестами в принципе не являются это библиотечные всякие файлы типа замок Нава клиента зачем их выделяли сейчас будет понятно и из основного Юта мы убирали сломанные тесты и флаки тесты и могли теперь снять тест карантин то есть вот эта вот вся гора тестов в карантине больше её не было также делали второй со сломанными тестами туда добавляли тест которые не являлись потому что они нужны для запуска сломанных и почали их как карантинные и аналогичный те делали для флаки тестов такое мы сделали буквально пару раз это такая механическая не очень приятная работа Ну мы это сделали потому что отправились в карантин достаточно важные тесты и нужно было срочно с этим что-то сделать вот более такой правильный подход который у нас уже дальше был это автоматическое разбиение на много юв то есть из одного большого мы делали много маленьких с помощью такой утилиты как Газель для базеля А И после этого проблема решилась у нас карантини ось то что реально флако в таких местах вот наконец у нас получилось практически совсем там близко к нулю сделать нагрузку от карантина э это было 30 ноября то есть спустя 2 месяца после того как мы карантин включили за это время разработчики там почти все свои тесты там оставалось уже прям немного и при этом лаков было уже мало то есть они не особо офек разработчиков мы это видели по Метрика сборок видели по количеству жалоб То есть раньше жаловались там порой ежедневно Ну или как минимум еженедельно с карантином жаловаться перестали в общем-то и тут 30 ноября раз и куча тестов опять отправились в Камы поре ВМ дело Поли сотни раз в день э посмотрели как они теперь флака то есть вот прошлый слайд - это август до введения карантина здесь ноябрь уже после ээ то есть они там флака прямо реально мало но был один день в который э там были инфра проблемы из-за которых много тестов немножечко по флака Вот и мы вспомнили что у нас в общем-то порог попадания в карантин очень низкий То есть если помните в самом начале Я сказал что мы отправляем в карантин если тест флаг нул два раза за день больше ДХ раз за день и по историческим данным на самом деле видно было что это чере жёсткое такое поведение почилить порог 10 флагов Вот то есть после этого у нас действительно проблемные тесты продолжали попадать в карантин а тесты которые в общем-то не особо кому-то и мешают с учётом того что они ретра на они в карантин не попадали и разработчиков помню с чего Мы начинали то есть Мы начинали там с четверти падений сборок Что произошло то есть вот если посмотреть уже спустя несколько месяцев там после ноября э ну такая же картинка была и в декабре например То есть если если взять там три рандомных дня в апреле за них C Build упал всего один раз на транки типа из 150 это уже куда более приятно вот если посмотреть на там интервал побольше Я здесь брал с начала апреля до середины мая там было 42 падения причём большая часть падений была какие-то там временные проблемы там видно такие красные полосочки То есть это просто какие-то временные проблемы были никак не связанные с флаки то есть в общем-то флаки почилить там что е у нас произошло помимо того что число фла сильно снизили у нас ещё и карантин пуст стабильно Ну то есть вот прямо сейчас он пуст например туда периодически попадают какие-то новые проблемные тесты разработчики их лечит и опять же то есть Прошло уже там полгода у нас есть механизм для поддержания этого состояния То есть это была не разовая акция вот мы один раз всё почи А прям такой механизм чтобы так и продолжалось Ну и при этом этот механизм много кушать не просит то есть в поддержке особой боли он у нас не вызывает Хочется ещё про эффективность карантина подсветить то есть в нашем случае больше половина тестов которые мы в карантин отправляли реально надо было фиксить там порядка дву Трей ещё амнистию вот нам приходилось Частова вводить то есть в четверти случаев мы тесты выводили из карантина без фикса по сути если бы мы более грамотно продумали порог в самом начале то этой проблемы удалось бы избежать Ну и часть тестов выходили из карантина через распил то есть ну вот это вот разбиение на больших тест сюдов на маленькие можно спорить насколько это можно считать выходом из карантина потому что часть тестов всё-таки в нём оставались Ну такое Мы тоже немножко делали если говорить про то как быстро сами разработчики чинили тесты треть тестов чинили вообще за день 70% тестов чинили за 2 недели рабочих это Вполне себе клёво То есть это этого достаточно чтобы в большинстве кейсов тесты не ломались а бывали э то есть более долгие случаи э но важно подсветить что у нас не было ни разу что тест чинили больше чем 2 месяца э у нас на самом деле там в голове Это было такое строгое ограничение что вот больше этого срока наверное тест в карантине Уже не надо держать то есть уже какие-то дальнейшие меры надо предпринимать но у нас до этого не доходило если по итогам этого доклада вы хотите попробовать у себя такое внедрить бы что нужно сделать нужно научиться находить проблемные тесты отправлять их в карантин э затем нужно организовать выход из карантина То есть у нас первый этап был с помощью запросов кликхаус и постановки тегов второй этап с помощью снятия тегов плюс там кнопка проверки на флаке помогала с пайплайн для разработчиков как это делать нужно рассказать естественно про карантин людям что это такое с чем его едят и рассказывать отправлять сообщения какие-либо алерты в идеале пр автоматизированные про попадание в карантин Ну и после этого реагировать на проблемы То есть они могут быть такие же как у нас были могут быть какие-то другие Ну они будут и это нормально тем не менее они такие короче карантин стоит того в общем-то и важно что каждый из этих пунктов можно делать вообще как-то по-другому А не так как делали мы то есть это такой паттерн по сути Для внедрения можно сказать по-любому у вас другие вводные скорее всего у вас не морепарк Ну скорее всего их будет проще реализовать и будет проще с коммуникацией очевидно потому что просто меньшему количеству людей надо рассказать про это всё если обратная ситуация то есть там 1.000 программистов э Главное отличие в том что можно позволить себе меньше ручных действий и там ещё больше автоматики делать чем мы делали а возможно у вас не Unit не в Юнит тестах проблема а там в интеграционных или в n2n тестах А тогда скорее всего нужно смотреть Не на флаки а на статистику падений потому что она больше интересует пожалуй в таких сложных тестах и ещё более аккуратными надо быть с порогами чтобы у вас вообще все тесты в карантин не ушли а и по-любому у вас другой туринг Ну в общем-то это неважно Вот вот что у вас есть Вы можете взять и использовать То есть это такой процессный паттерн ещё раз как я говорил на прошлом слайде А что может помешать во внедрении может помешать нехватка культуры работы с тестами То есть если разработчики там не знаю забивают на тесты вряд ли карантин будет сильно эффективным в таком случае и пожалуй Надо сначала эту проблему починить Что является пожалуй Темой вообще отдельного какого-нибудь доклада потом уже приступать к лечению флаки у разработчиков может не хватать времени это важно помнить что они тоже Живые люди с ограниченными ресурсами И нужно им помогать и там более грамотно выставлять пороги например чем мы Это в самом начале сделали ну и очень могут мешать мес коммуникации про карантин потому что это такая потенциально взрывоопасная Тука В общении с людьми люди могут там не понимать что это и зачем стоит объяснять наконец хочется сказать Спасибо Оля борзенкова это разработчик из моей команды которая там большую часть кода писала Я здесь выступал как такой идейный вдохновитель можно сказать этой штуки и отдельное спасибо всем разработчикам из наших команд которые свои тесты починили без них это всё было бы невозможно на этом У меня всё голосуйте за мой доклад и задавайте вопрос Спасибо Евгений Большое спасибо за доклад очень интересно прежде чем мы приступим к сессии вопросов и ответов я хотел бы напомнить что у нас у онлайн участников есть возможность задавать вопросы с портала если вам не хочется задавать вопрос в микрофон также есть чат зала можно написать вопрос свой туда поставить тег в идеале вопрос я его зачитаю и наверное властью данной мне онтика я воспользуюсь этой возможностью и маленький вопрос пожалуйста не обижайтесь в брошу потому что любые изменения они провоцируют какое-то сопротивление Вот и как Наре карантин реагировали и были ли какие-то возражения у разработчиков Да возражения были Ну базовое возражение было в том что А зачем вы это всё вот мы нормально раньше не в манаре жили без всякого карантина у нас тесты флака и это неважно А вот теперь вдруг стало важно Вот по факту когда показываешь людям статистику сборок на которые они сами же натыкаются и им самим же приходится это всё ретра ить люди это могут воспринимать Вот это первый момент второй момент были вопросы к эффективности именно того как мы это внедряем то есть там было например предложение А давайте мы на сий билде будем карантинные тесты по 10 раз запускать например И вот тогда они не будут ломаться Вот Но это то есть было такое например предложение мы его в итоге не стали реализовывать Потому что так себе компромисс получался Особенно с учётом того что Флае тесты часто ещё и долго работают Вот и здесь было важно всё-таки донести до людей что это им же в итоге самим и поможет в конечном счёте у нас достаточно такие френдли отношения с разработчиками что ли можно сказать то есть мы стараемся очень позитивно сво видение того как э там строить инфру до них доносить и это тоже очень помогает то есть когда-то там понял мир Дружбы жвачка да да-да да когда ты не вычес на людей это помогает Отлично тогда я напомню ещё раз что у нас надо будет выбрать самый лучший вопрос мой вопрос не участвует Вот и мы начинаем э первый ряд правая часть зала спасибо а День добрый хотелось бы просто услышать то есть точнее Так вы показывали там когда Список тестов которые там валились там можно заметить что прям очень крупные теке сют кейсы получаются допустим Дао двоеточия тест то есть там все тесты на Дао может быть стоило командам подходить более ответственно Просто сразу дробить как-то это во-первых вот вот здесь вот да то есть прям видно что прям целиком здоровенний тест-кейсы то есть валится хотя бы один тест и валится сразу весь тест-кейс и типа мы говорим что это ничего не работает и во-вторых вы там в самом начале говорили что у вас есть кэширование тестов То есть если тест прошёл то он уже считается как будто он тут если он при этом как бы мог кнуть то есть никогда не узнаем что он был кнуты на самом деле так про первый вопрос на самом деле бывают небольшие сервисы в которых Да может быть да вот это может быть не таким уж и большим на самом деле это первый момент второй момент часто это издержки изначально много сервисов были не в моно Репе и потом они переезжали ну не всегда мы дроби прямо на гранулярный Ээ таргеты это называется ну короче на гранулярный юниты сборки э это порой было слишком дорого Просто вот ну то есть это такой трейдов можно сказать а но после внедрения карантина мы сделали как раз тузу которая автоматически позволяет это делать Вот и Это помогало вот вторая часть а а ещё один Ну у меня просто ещё вопрос был А исследования были То есть если у вас падает тест вот не А у меня второй вопрос был именно про вот эти вот каширование результатов просто ещё треть хотел задать вопрос именно были какие-то исследования то есть вот именно в той статье на которую вы ссылались фаулера он Ну достаточно много написал стену текста про не детерминизм В чём его ну опасность вообще говоря для вот продакшена грубо говоря потому что у вас если самолёт не будет 10 раз в день летать но это будет совсем печально Ну или там де чтобы не проходить порог Вот Но короче Просто я хотел именно спросить а были какие-то исследования именно откуда берётся вот этот не детерминизм источников в источник не детерминизма при запуске тестов Угу На самом деле часто он у нас брался из такой библиотеки как сла чек которая генерирует тестовые данные для тестов А ну она рандомом видимо с рандомным сидом да да то есть часто проблемы были там вот и конкретно в нашем случае вот на тему вопроса про кэш А после зелёного прогона тест широва Вот то есть то что он флаг это оставалось в логе тестов которые мы перекладывать в хаус и там уже можно было посмотреть но в целом в идеале после зелёного прогона тест флаг не должен но проблема в том что код меняется типа кото изменили тест перезапустил опять флаг нул и Вот ребята ещё вопросы у кого так Ну вот есть левая теперь часть зала вот там можно два человека сначала кто поближе спасибо спасибо за доклад А вопрос такой Сколько в процентах у вас до введения дожимает не лакала Вообще никогда Ну на самом деле большая часть Вот то есть я говорил что у нас там десятки тысяч тестов Да в карантине в сумме было порядка сотни за всю его историю то есть на самом деле это вот прям принцип паре в действии Даже даже не 20% Вот то есть не так было много тестов которые флака но не отправлялись в карантин потому что ну проще жить с лаками чем их чинить условно говоря потому что они не так уж онот и с учётом таких флагов Ну у меня прямо сечас нетки большая сть те неп помогают на самом деле с этим То есть если тест находится в какой-нибудь там какой-нибудь общей библиотеке которая редко меняется и редко трогается он один раз зашивал когда-то давно и остаётся зелёным потому что результат из каша просто берётся Вот но бывают кейсы когда мы трогаем эту библиотеку и тест начинает лакать Окей спасибо и быстренько ещё второй вопрос почему как ты думае такая проблема возникла с тестами вобще это Рандомные данные в тестах ещё ребята микрофон Да сейчас буквально секунду Потому что думаю может на записи быть не видно скажи что-нибудь пока нет Окей у нас небольшая Техническая заминка и предлагаю всем написать своим родственникам как сильно вы их любите вот а мы очень быстро поднимем и быстро поднято упавшим не считается А у нас есть такой микрофон раз раз хорошо слышно Нет не два раза второй источник флагов был наверно самый такой частый это разные проблемы там при поднятии докер контейнеров то есть там не знаю что что-то пошло не так он упал потом поднялся на другом сте и вот получился флаг такой тоже бывало вот и это часто на самом деле было связано с проблемами как люди с дором работали есть ме когда базу поднимали на диске а диск Там был какой-нибудь медленный на тачке И решалось УВО дом базы для тестов в МФС например есть вопрос первый ряд у нас ещё микрофона да спасибо Евгений Спасибо за доклад было очень интересно Понятно У меня вопрос связан с временем работы тестов вы сказали что у вас используется около 10.000 тестов или там десятки тысяч вот в нашей же команде их всего тысяча но они также запускаются за 5 минут Вот мне интересно как вы добились такой скорости что у вас десятки тысяч прогоняют всего за 5 минут добились тем что используется кэш то есть в большинстве реквест запускается буквально несколько тестов на самом деле а всё остальное берётся из кэша потому что там реквест тест не трогает Ну и то же самое можно про локальную разработку сказать в а можно уточнить ш кэш тест - это Что значит не кэш же результата да э кэш Ну по сути результата То есть он короче Как это работает тест зависит от там кучи кучи Кода да ээ от этого кода берёт Ну если упрощённой кода берётся хэш э и если он не поменялся и у нас уже есть успешный результат теста мы просто берём его так какие-то юниты прямо маленькие тесты да то есть любые на самом деле Да ну интеграционные это тоже так можно вот там правда Свои приколы с интеграционными есть но так тоже можно в принципе А сколько у вас один Тест проходит Ну зависит от теста то есть бывают тесты которые работают не знаю Там меньше секунды бывают какие-то более сложные тесты которые там минуту две ээ бывают Ну ещё более сложные но на самом деле мы стараемся их заменять на там более простые всё-таки в большинстве случаев нуно ещё раз это C Build То есть он именно про Юнит тесты Ну под Юни тестами мы на самом деле понимаем и те которые там докер какой-нибудь могут поднять но локально То есть те которые не выходят за предел своей машины для тех которые выходят за пределы своей машины куда-то там пости ходят для них отдельный Билд есть СБО ещё вопрос Центральная часть вот мужчина спасибо спасибо за доклад было очень интересно у меня такой вопрос вот из рассказа Я понял что латест когда в карантине его разработчик его пофиксили он оттуда выходит а была ли обратная ситуация когда тест стал флака попал в карантин разработчик не успел его ещё пофиксить но он стал падать прям совсем в 100% случаях роняла ли это пайплайн блокировала МЖ А такое бывало это не блокировала МЖ и это было как раз проблемой которую мы в основном решали через вот этот вот распил огромных там тестов на маленькие в маленьких тестах у нас такой проблемо ну в маленьких те сюх В смысле у нас такой проблемы не возникало Ну типа в принципе в теории она могла бы быть но просто вероятность меньше почему не блокировали м то есть падает тест всегда и мы такие Ну в принципе ну потому что то есть если тест в карантине уже и он начинает падать мы не блокировали merge потому что типа как мы блокировали merge мы блокируем ме на C билде А на карантине мы вообще его не блокируем то есть если он из ла теста и мы не хотим разработчика оть в этот момент в общем-то Это и было целью чтобы флаки теста не раздражали разработчиков Это была первая цель она решилась внедрением карантина потом появилась вторая цель обратное то есть чтобы карантин не приводил к тому что там к снижению Короче говоря стабильности тестов Вот и пошли угореть вопрос У нас есть время на один вопрос была рука нет вроде рук больше нет сейчас я быстро проверю ещё раз онлайн до этого не было Но мало ли так там вопросов тоже У нас нет самое приятное выбрать самый лучший вопрос на самом деле все вопросы были классные Я в восторге от вас ребят очень классная команда Да мне понравился вопрос про кши и типа как как нам Ну вернее он не про кши там ответ был про кши Но вопрос как вообще сборки такие быстрые получаются всё отлично Ещё раз спасибо нашему спикеру и от нас также есть подарок от конференции Э мы тебя поздравляем Спасибо большое Евгений Большое спасибо"
}