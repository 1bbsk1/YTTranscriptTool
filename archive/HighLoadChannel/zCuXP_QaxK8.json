{
  "video_id": "zCuXP_QaxK8",
  "channel": "HighLoadChannel",
  "title": "",
  "views": 0,
  "duration": 0,
  "published": "",
  "text": "Здравствуйте коллеги Меня зовут чуриков Михаил и я сегодня буду рассказывать как мы на устройствах Сбер девайсов делаем обработку звука То есть как у нас устроено всё воспроизведение и какие последствия соответственно это за собой влечёт вот в первую же очередь будем рассказывать Так а в первую очередь что-то Не не перелистывается А я буду рассказывать про устройство Сбер девайсов это колонки а Сбер Boom и Сбер Boom Mini а соответственно А на них у нас в общем-то это обычные пользовательские колонки которые задач которых классно воспроизводить звук Соответственно что нам нужно обеспечить То есть у нас мы имеем такое достаточно посредственное железо потому что нам нужно попасть в Вот вы их видите на экране соответственно про как раз вот эти колонки мы и сегодня и конкретно разговариваем Вот так нам нужно попасть сонно в ценник по рынку вот поэтому мы имеем достаточно посредственное железо и нам соответственно нужно сделать классный User experi а для этого приходится использовать обработки звукового потока который мы воспроизводит и озвучка там кнопок и в первую очередь конечно же музыка Вот а если говорить про а параметры которые мы оптимизируем соответственно Мы оптимизируем в первую очередь э это как выглядит наша амплитудно-частотная характеристика устройства а соответственно Здесь вы видите примерно то Как оно выглядит А да в процессе настройки я замеряют ветственно амплитудно частотную характеристику и стараюсь оптимизировать некоторые её параметры а Первый параметр - это соответственно неравномерность частотные характеристики это достаточно важный параметр Потому что когда мы берём и уменьшаем неравномерность оч внезапно оказывается что колонка начинает звучать хорошо на большом количестве музыки на большом количестве стилей Вот и ещё достаточно важная вещь Это частотный диапазон потому что у нас как Мы помним достаточно слабое железо Это касается и процессора и динамиков и усилителей соответственно мы не можем физически просто воспроизводить такой полновесный широкий частотный диапазон соответственно приходится прибегать к некоторым лайфхакам о которым поговорим дальше Вот соответственно и Конечно же Конечно же мы минимизируем искажени потому что чем меньше искажений у на нашем звуке с устройства то у нас как бы оно звучит приятнее и с помощью цифровой обработки сигналов мы можем Вот делать Вот такие прикольные вещи соответственно немножко срезать низкие частоты где уже большое количество искажений и колонка начинает звучать приятнее Так а в основном вся обработка цифрового потока воспроизведения происходит с помощью биквадратных фильтров а здесь на слайде соответственно у нас частотные характеристики некоторых биквадратных фильтров которые я использую в своей работе в настройке они могут быть реализованы как на центральном процессоре так и на а ДСП на усилителях но в принципе вот ээ то как частотный отклик Они показывают это вот выглядит Вот так вот соответственно А кроме того мы же хотим получить классный User Experience Вот и существуют исследования товарищей флетчера и масона а которые собственно говоря показали что по психоакустика А у нас есть кривые равных громкостей соответственно это у нас а на слайде графиком соответственно у нас по оси X у нас чистота А по Y у нас звуковое давление Но вот эти вот красные кривые показывают то как человеческое ухо в зависимости от уровня громкости воспринимает наши частоты соответственно мы как бы ухо - это самое нелинейное вообще в принципе то что у нас тут есть Вот и нам приходится это компенсировать чтобы получить что на Тихой громкости чтобы колонка звучала полнос чтобы у нас частотный диапазон соответственно был достаточно полный вот и это даёт классный эффект когда мы пытаемся вот это вот со оптимизировать соответственно блок-схема на блок-схеме показано то как можно реализовать вот такую коррекцию Вот и здесь же в блок схеме видно что мы Для этого можем использовать те же самые наши биквадратные фильтры вот Аа ещё одним э таким лайфхаком который я использую это эффект Virtual BZ а соответственно мы берём отрезаем нижние частоты Аа и у нас остаётся как бы тот частотный диапазон который колонка в принципе не может играть то есть допустим мы там у нас колонка не играет ниже чем 70 гц это достаточно высоко и мы не получим хороший звук соответственно мы берём отрезаем нижние частоты возводим в квадрат и получаем кучу гармоник и дальше из этих гармоник полосовым фильтрам тем же квадратным выбираем те там гармоники вторую и третью допустим вот и смешиваем это обратно с исходным сигналом соответственно Мы у нас колонка не может воспроизводить те частоты которые соответственно дают много искажений а мы их двигаем выше и добавляем обратно же то есть мы не потеряли таким образом информацию в сигнале звуковом Так а ну в принципе немножко хватит наверное про говорить про там звук и физику немножко Вот поговорим про железо соответственно у нас есть две колонки сбм и сбм сбм у нас достаточно как бы такой по железу там сильно всё приятнее То есть у нас там четыре ядра Ар 256 память как оперативной так и флеша и у нас там есть Классная штука это цифровые усилители у них на борту есть блоки цифровой обработки сигналов но как бы они фиксированные то есть умеют там определённое количество алгоритмов и всё вот а вот сбе там у нас достаточно напряженно и там у нас только два ядра Арма Вот и 128 памяти и такого счастья как у нас цифровые усилители у нас там нету у нас чисто аналоговый вот прямо вот тупой усилитель который играет то что в него послали в аналоговом виде и собственно говоря динамик Вот но и в случае СБ иши набора инструкций армо это Неон это векторное расширение о котором мы дальше собственно говоря и будем говорить Вот Но а соответственно ещё раз Для того чтобы сделать классный звук Чтобы удовлетворить пользователей нам нужны Примерно вот такие вот эффекты То есть это Virtual B V эквалайзер и компрессор соответственно про него я не говорил но мне кажется там достаточно всё просто Вот первая оптимизация которую мы можем сделать соответственно у нас есть какие-то железные блоки давайте мы вынесем всю обработку туда которую можем соответственно Сбер буме она вынесена на усилитель То есть у нас там работает в эквалайзер и компрессор А с на сберб было на самом деле достаточно тяжело потому что а эти усилители как бы из коробки поддерживают вле То есть зашите это написано Вот но на самом деле Мы первые Кто поднял на этих усилителях вле потому что даже вендор этих усилителей в Кореи нам сказал что типа не ребята вот с этим у нас никто не работал Давайте как-нибудь Сами мы вам даже помогать не будем Потому что ну типа заказ у вас не очень большой как бы Разбирайтесь сами Ну в общем разобрались и оно работает в общем-то уже давно в продакшене Вот а если говорить про сберб Min соответственно у нас там есть другой лайфхак железный это у нас есть у нас звуковой карте блок цифровой обработки соответственно мы туда выносим все эквалайзеры там те же самые биквадратные фильтры только реализованные в железе уже вот и соответственно ихр Вот Но конечно же нам этого мало Поэтому приходится обходиться сотовыми обработками которые у нас работают как в виде плагина для альс То есть у нас все наши устройства работают на линуксе там линус ядро и наши алике - это по сути вся вот э вот работа ассистента озвучивание кнопок Дале тому подобное этоке вот дальше есть а библиотека в которой можно сделать Вот соответственно наши вот эти вот плагины чтобы на чтобы они были системные чтобы все приложения Наши в системе могли пользоваться соответственно результатом этих обработок вот Ну и дальше уже у нас Linux ядро и выходим уже в железо это усилители аналоговые ровы Вот соответственно у нас на у нас на входе вот в алике в ассистенте у нас ассистент скачивает музыку в формате флаг и воспроизводит прямо напрямую в вальсу соответственно у нас есть звуковой поток который мы дальше обрабатываем Вот если говорить про обработки Наши все они устроены вот в Валь плагине как бы вот примерно по таким требованиям и вычисление у нас в первую очередь происходит в плаву одинарной точности а почему плаву одинарной точности Потому что если мы идём в фиксированную точку там 32 бита даже то у нас там начинаются проблемы Проблемы с искажениями соответственно как Мы помним мы пытаемся минимизировать вс-таки эти искажения вот поэтому вс-таки Ловушка 32 бита и мы от неё как бы уйти не можем Но звуковой поток Аса нам отдаёт в фиксированной точке и соответственно у нас на входе должно быть преобразование Из фиксированной точки то есть там 16 бит 32 бита в нашу плаву Вот и Понятное дело что нам нельзя тратить сильно много потому что у нас работает Ассистент ему нужно много перформанса для того чтобы слышать и распознавать соответственно как-то с пользователем работать и так далее и тому подобное вот поэтому как бы появился вот этот доклад так всё хватит про звук по соответственно нашим операциям То есть у нас в основном тут есть биквадратные фильтры умножение сложение и возведение в квадрат так быстро пробежимся то есть начинаем профилировать наше приложение и оказывается что действительно Да у нас 46% занимают биквадратные фильтры поехали их оптимизировать в первую очередь мы переходим то есть нам Аса отдаёт поток аудио в формате смешанном это мы переходим от смешанного формата в последователь То есть у нас есть два канала стерео мы их располагаем по буфера последовательно вот и это уже даёт хороший Профит так а дальше биквадратные фильтры сами у них есть две каноничные формы соответственно Я здесь выделил операции которые на которые мы тратим время основное и есть соответственно обратная связь мы просто двигаем буфер каждый раз и это занимает тоже время вот есть вторая форма каноничная она считается более производительной Но это из мира микропроцессоров оказывается что в микропроцессорах очень важна там память А у нас же как бы ДД и как бы в наших масштабах ДД всё-таки не сильно приходится экономить на вот такую вот маленькую обратную связь вот поэтому используем всё-таки первую квадратную форму Вот и я когда разрабатывал очень много времени потра чтобы понять для Какой формы там у нас допустим в матлабе или гно окв есть соответственно генерируются коэффициенты Вот и оказывается что они просто для формы и они для той и той формы одни и те же вот а дальше что можно попробовать сделать это оптимизировать вот это вот передвижение по обратной связи мы теперь не двигаем сэмплы А мы просто добавляем В конец фифо вот и Обращаемся по индексам вот сравниваем воспроизводимое что самое действенное - это у нас не оптимизация индекса а просто переход к последовательному формату потока данных Вот соответственно выбираем форму первую биквадратных фильтров и дальше с ней будем работать вот что е можно сделать можно е исполь соответственно компиляторы у нас достаточно умные они умеют автовектор и можно вот такими флагами её включить Классно Классно и оно даже работает вот дальше увидим по результатам и самое-самое главное на самом деле в моём докладе это рассказ про библиотечку как Мы помним в наших ядрах У нас есть расширение нен мы можем его Как использовать напрямую дергая эти инструкции Можно даже писать на ассемблере функции которые дёргают эти инструкции Неон вполне я когда-то так делал Вот но гораздо проще для обработок это использовать готовые обработки потому что кто как не вендер ядра лучше знает как нам обработать быстро сигнал соответственно это знает а и а сделали CMC с DSP для того чтобы мы все этим приятнее если мы это всё хотим собрать то там есть два варианта есть Make и Cake вот вй ходить не надо Там счастья нет вот удобно собрать соответственно это всё мейком и нужно Передать ему что чтобы он сделал впер на питон соответственно можно это дёргать как из питона вот если у вас допустим на на ноутбуке А с расширением Neon то можно собрать этот CMC с DSP с с врам на Python и использовать соответственно и обязательно передать что у нас математика у нас не Вот и в этой библиотеке У нас есть соответственно Все наши вот обработки математические операции как биквадратные фильтры сложение вычитание умножение на константу там X квадрат и так далее и тому подобное просто берёшь и пользуешься Вот но без ложки дёгтя соответственно не обошлось когда я поднимал на CMC с ДСП биквадратные фильтры оказалось что коэффициенты половину коэффициентов нужно было сделать обратную умножить на минус единицу иначе у меня просто не работало Ну точнее оно работало оно обрабатывал но результат был около нуля так а и вот у нас есть некоторые вот методы оптимизации которые мы прошли и Давайте сравним соответственно в нашей палай обработки у нас была м соответственно биквадратные фильтры viral B и vle наш любимый Вот и Если смотреть то изначально если мы пытаемся обрабатывать час звукового сигнала то на вот сбе Boom Mini конкретно прямо на железе час звукового сигнала обрабатывал 6 минут вот если мы используем автовектор заю то Ну всё классно мы в три раза ускорились Вот Но переход на от звукового потока смешанного на последовательный по каналам соответственно нам даёт примерно такое же ускорение соответственно у нас там буфера начинают лучше укладываться в кши вот меньше у нас процессор ходит в память соответственно мы получаем ускорение Вот а если мы ещё все операции биквадратные фильтры умножение сложение соответственно скейлинг заменяем на функции которые у нас э предоставляет CC DSP то мы получаем ускорение ещё в два раза соответственно мы ускорились по факту В шесть раз соответственно классный результат А я честно говоря сам не очень ожидал что так будет Вот в общем-то Давайте поговорим немножко про инструкции Неон поподробнее потому что то что у нас соответственно у меня ке что мне нужно ускорить обработку цифрового сигнала А такое такая задача она возникает Ну как бы она у меня возникла Вот а если вы хотите использовать соответственно наши инструкции неона на каких-то своих железка часто это бывает на ноутбуках каких-то сейчас ВС больше появляется ноутбуков на арми где-то на серверах на пи банально это всё Тоже есть В чём у нас инструкция не это Такой разряд расширения S Single instruction multiple Data Вот как это всё работает и читается соответственно есть базовый в процессоре базовый регистр файл который у нас 64 Бита Вот и его мы можем соответственно побить на базовые типы данных То есть если мы хотим обрабатывать плаву 32 бита соответственно 64 Бита у нас бьётся на пополам и мы можем с помощью этих инструкций Neon обрабатывать за одну инструкцию два две тридцати двух битных выборки в общем-то что здесь и на слайде отображено собственно говоря умножение у нас почему FL 32 X2 это вот то самое разбитие нашего одного регистра на пополам соответственно за эту инструкцию мы обработаем две выборки вот а дальше там есть ещё куча других типов данных которые мы можем использовать то есть мы можем использовать как инты тридцати двух битные соответственно Мы тоже будем обрабатывать две выборки за раз и вплоть до интов восьмибитные как бы достаточно релевантная вещь которая относится к мангу соответственно мы можем использовать операции быстрым расширени за одну инструкцию обработает восемь а соответственно интов Вот и соответственно мы можем получить за счёт этого ускорение в э операциях которые относятся к машин ленгу Так а ну соответственно всю все инструкции э Можно прочитать на гитхабе оттуда же можно скачать э CMC с DSP и собрать вот с ней слинковать либо дёргать из питона вот конкретно на слайде это интри сики То есть это обв ассемблерные которые можно у себя в коде дёргать на си напрямую но можно и писать ассемблерные вставки которые я очень люблю полезно соответственно понимать про архитектуру современных процессоров Я 5 лет до того как занялся звуком занимался разработкой процессоров я занимался risk 5 Вот Но тем не менее на Арме устроено всё примерно так же вот если крупными блоками оно выглядит вот так у нас есть наше вычислительное ядро будь то ARM risk 5S там ещё что-то не помню по-моему на Эльбрусе всё-таки чуть по-другому но тоже около того А у нас есть э вычислительное логическое устройство и какой-то контроллер памяти Ну за ним ещё там кши L1 L2 Вот и у нас э соответственно все данные которые мы обрабатываем в первую очередь попадают в кши и оттуда быстро тягают в алуш вот а а дальше у нас в современных соках э у нас идёт шина AX 4 А эта шина изначально начала использовать компания ARM Да у меня конечно нету документации на микроархитектура там конкретных соков amlogic которые мы используем Вот Но поскольку это у нас использует компания ARM это шина там есть вот а и по своей природе а Аси 4 - это потоковый интерфейс соответственно Все транзакции выходят на эту шину Аси 4 можно в принципе даже зайти в интернет посмотреть как работают соответственно транзакции в акси 4 Вот и можно увидеть что там самое такое То есть у нас допустим разрядность шины Может быть там 64 Бита А может быть даже 128 бит То есть если у нас процессор 64 Бита то у нас шина даже может быть больше и до 256 бит по-моему Я тоже видел в этой жизни соответственно когда мы начинаем использовать наши операции нен соответственно мы начинаем запрашивать большое сразу количество данных и вот это вот если у нас эти инструкции Neon идут подряд соответственно блоками то сейчас контроллеры памяти достаточно умные они умеют вот такие транзакции сэмплов и это будет достаточно быстро это гораздо быстрее чем у нас в ДД мы будем ходить по четыре соответственно сэмпла забирать а соответственно за счёт этого будет у нас в любом случае ускорение у меня на опыте соответственно Был Была задача ускорение мко просто банальный мко оптимизировать по тат архитектуру вот да там у меня был доступ соответственно к этой шино акси я мог прямо посмотреть какие транзакции там гуляют Вот и в итоге оказалось что самое быстрое было написать на ассемблере пачку плавучих запросов в память то есть убит запросы мы их подряд пишем ф вот прямо на ассемблере вот если мы вот такое используем то у нас контроллер памяти эти транзакции буферизованный за вот ну и собственно хочется немножко сделать такие подвести итоги конкретно в современном мире у нас очень часто нету смысла гонять какие-то обработки на бэнде вот у нас всё чаще будут появляться задачи э компью соответственно у меня здесь Да у меня Маши у меня обработка цифровая обработка сигналов но мне пришлось её ускорять для того чтобы отдать больше перформанса для машин ленга потому что девайсы слабые откровенно слабые нам нужно попасть в рынок по ценнику иначе как бы эта вся история не имеет смысла в принципе вот а очень часто с современными компилятора то есть там у нас есть очень то я изначально оптимизировано конечно там всё печальнее Вот и есть там всякие автовектор зации и так далее и тому подобное кучу флагов можно поиграться и получить прям заметные ускорение Вот но оказывается что оптимизировать под конкретную архитектуру архитектуру процессора архитектуру системы команд есть оно Дат очень часто самый большой Профит Поэтому вот полезно Это ВС дело понимать И использовать То есть у нас там есть кши там АК 4 Там в ДД У нас очень часто есть какие-то буферизации это всё Сделано для того чтобы конечно упростить жизнь программисту и чтобы всё из коробки работало быстро но кода поем Т просо сделать удобно ВС начинает работать быстро вот ну и соответственно я сделал небольшой экскурс в расширение системы команд Ne которое я честно я бы использовал Везде где оно только есть то есть на самом деле на тех же процессорах Intel есть тоже расширения такие же как эксплуатировать использовать и так далее и тому подобное Вот и всем этого желаю Вот А ну и в принципе на этом У меня всё вот Меня зовут чуриков Михаил соответственно есть у Сбер девайсов Telegram канал salute Group где обсуждаются всё что связано с машин ленго и так далее тому подобное технологиями Вот и пожалуйста оставляйте обратную связь на мой доклад Вот Всем спасибо спасибо Михаил Давайте перейдём к вопросам у нас несколько вариантов того как можно задать вопрос если вы смотрите нас онлайн то есть кнопочка с возможностью задать вопрос онлайн Если нет то вы можете поднять руку или перейти в чат за также не забывайте голосовать за доклад обратная связь важна как для спикера так и для организаторов конференции мы обязательно используем её чтобы стать лучше за вопросы у нас будет два приза один от сбе Devices второй та самая супрематическая матрёшка которую анонсировал Олег на открытии Итак из онлайна у нас пока нет вопросов из зала Давайте молодой человек Привет меня зовут Дима твой коллега по компью смотри во-первых Спасибо за доклад на самом деле круто интересно но меня вот такой вопрос возник ты показывал слайд Где вы замеряли перформанс обработки час звука и у Вас получалось что вот без всех оптимизаций у вас 6 минут обрабатывал час То есть это 10 и Реал тайма Откуда появилась вообще необходимость это оптимизировать то есть в чём была проблема смотри на самом деле как бы оптимизировали мы у нас получается бы показатель какой то есть мы воспроизводит и смотрим Какую нагрузку на потопу именно даёт на процессор вот 6 минут соответственно Вот обработка часа времени это такой синтетический тест который полностью показывает как бы наше ускорение вот а по вот обра с 9% цпу до 3% а получается то есть это в контексте вот устройства которое от розетки работает всё равно важно оказывается Да это очень важно потому что у нас там есть соответственно ассистент и нам нельзя ему мешать То есть если у нас будет заикаться ассистент эту колонку тоже не будут покупать а Понятно Окей спасибо Не стесняйтесь задавать вопросы у нас пока один вопрос и целых два подарка Давайте Девушка во втором ряду Привет Миш Спасибо за доклад было очень интересно послушать У меня такое более бизнесом вопрос понятно что ваш основной конкурент сейчас - это Яндекс Алиса Ну да как вы может быть сравниваете свои колонки с колонками от Яндекса Вот почему мне как потенциальному покупателю нужно выбрать вашу колонку А смотри у нас есть в принципе два метода сравнения а субъективный и объективный соответственно если мы мы говорим про субъективный то конечно у нас есть там слепые прослушивания Вот соответственно мы собираем фокус группу и За закрытой шторой соответственно включаем там Яндекс включаем ВК включаем свои колонки и смотрим какой результат уже по среднему отзывам людей вот а объективный соответственно мы берём и измерительным микрофоном замеряем то как ведут себя колонки соответственно Я показывал на слайде амплитудно-частотная все эти параметры мы оптимизируем и мы Ну сравниваем с тем что у нас воспроизводит Яндекс и мы соответственно и все вот эти вот приколы с цифровой обработкой сигналов они и нужны для того чтобы оптимизировать параметры лучше чем у Яндекса и у ВК вот там на самом деле очень много приколов по искажениям Вот это на самом деле те грабли которые я прол и как бы я про это могу ещ Долго рассказывать Спасибо за вопрос молодой человек на первом ряду спасибо спасибо за доклад был интересный поит про оптимизации там умножение на константу квадратные фильтры и так далее эти все фильтры они последовательно друг за другом применяются да нет варианта оптимизации всё это в единую сврт схлопнуть и сначала фильтры помножить а потом их за один прогон применить Возможно на уровне математической оптимизации ещё больше гейн в производительности будет а мы к сожалению не можем так сделать потому что у нас результат работы одного фильтра используется сразу в следующем То есть у нас есть прямая зависимость по данным к сожалению нуфт свки это Линейная операция их можно схлопнуть в один фильтр все свёртки одной сврт применить можно но часто как бы у нас используется в том числе вот тот же viral B он в принципе нелинейный вот если мы там его начинаем схлопывается Вот Но те же самые биквадратные фильтры Да мы можем их вместе схлопнуть и сразу как бы свёртка обработать это да это будет работать быстрее Спасибо Есть ещё вопросы в зале Да здравствуйте Спасибо за доклад и такой вопрос У вас по сути станция работает с каким-то большим трафиком сети Какие в оптимизации с точки зрения сетевой обработки применяете возможно используете что-то наподобие байса обработки расскажите пожалуйста по соответственно сетевому стеку я к сожалению особо не могу подсказать Ну я знаю что у нас как бы буферизация идёт в апликейшн который звук воспроизводит Вот и у нас на самом деле достаточно много проблем с перформанс именно сетевых устройств Ну вот я про это и спрашивал вы в принципе знаете обработка идт сего трафика в тузами рла или юзер спейса а рла окей спасибо да да спасибо за вопросы у нас есть ещё один Давайте Спасибо за доклад а тоже вопрос который интересует меня как специалиста по операционным системам вот насколько хорошо Linux голы подходит для таких вот Soft realtime задач и используете ли вы более-менее какой-то голый Linux или модификации именно для вот обработки Таких потоковых данных какие-то специальные А мы не используем конкретно realtime сборки вот Linux ядра вот а на самом деле вот тех оптимизаций которые я сегодня рассказал их в принципе достаточно вот а нам в первую очередь как бы ну особо нету проблемы в соответственно в каких-то а затупок именно в Linux ядре а нам нужно быстро обработать именно сделать быструю молотилка данных в конкретном случае это звукового потока соответственно мы как бы а мы не используем голое Linux ядро потому что нам А у нас есть вендер ядро У нас есть там астрим нае ядра Вот но мы их не собираем с опциями риал тайма Вот спасибо а следующие вопросы предлагаю вынести в дискуссионную секцию после доклада А сейчас давай выберем э Два лучших вопроса Первый который получат приз от Сбер девайсов так Ну наверное вот девушки за каверзный вопрос про конкурентов Спасибо и второй наша эксклюзивная супрематическая матрёшка которой больше не будет ни на одной из конференций А так Ну наверное вот молодому человеку а и конечно же у нас есть подарок для самого докладчика а всех вас я жду в 11:10 на следующем докладе этой секции оптимизации инфе нейронных сетей а коллеги из Яндекса расскажут про то как они всё коллеги Всем спасибо да"
}