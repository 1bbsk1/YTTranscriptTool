{
  "video_id": "bc5DGJKcuME",
  "channel": "DevOops_conf",
  "title": "Виталий Ерофеев (MTC Digital) — Единый подход к CI/CD Store",
  "views": 457,
  "duration": 1630,
  "published": "2022-11-02T15:02:07-07:00",
  "text": "ребят Всем привет рады приветствовать вас на нашем тиктоке на тему единый подход мы с компанией Digital направление Big Data для понимания зачем нам нужна эта активность я немного расскажу о структуре нашей компании Так у нас много отдельных продуктов и много фруктовых досок решили унифицировать Виталий как руководитель центр компетенции расскажет более подробно об этой активности в конце Виталик Всем привет спасибо Влад Меня зовут Виталий Ерофеев я совместитель также работаю на продукте обычным делопсом соответственно у нас много разных команд в которых есть продуктовые опции и они в принципе больные делают все что хотят вот в самом продукте вот ну мы решили все-таки объединиться и сделать какой-то единый подход Итак тема сегодняшнего доклада затем мы создавали единой сессии расскажу выбор между инструментами дженкинс против gitlab siler какие инструменты какую выбрали архитектуру для реализации всей сидя раннеров Зачем использовали вообще использовать BG на проекте какая-то этого польза Какие шаблоны уже реализовали В общем как собирать статистику по работе шаблонов графа она плюс ластик Search может быть ко всему этому и так зачем мы создавали единой сессии distore Какие проблемы мы здесь решаем отсутствие унификации по решению тепловых задач То есть каждый продуктовый на своем продукте одну и ту же задачу решал по разным и на это тратилось очень много времени на создание всей семьи если продукт новый или какой-то новый приходил то Ему приходилось все с нуля делать соответственно Когда он ходил на больничный или переходить с продуктовый продукт или кто-то увольняется для того чтобы это поддерживать не всегда хватало документации написано продуктовым поэтому сложность поддержки Ну естественно когда возникают проблемы все сети коллективные всегда проще и быстрее решить есть накопленный уже опыт Ну и у нас есть продукты где нет devops И следовательно у них нет всей сети хотелось тоже эту проблему решить Итак у нас исторически в компании был дженкинс потом чуть позже пару лет назад появился gitlabsi и мы между этими двумя инструментами решили сделать выбор где будем их все что и представлять все сиди как сервис Итак что нам нужно было от инструмента понятной документация вот открывали там был с каким-то инструментом незнаком и здесь по нашему субъективному мнению нас порядка Вот и мы соответственно делали опрос Мы пытались шумонизировать и там дженкин сидит вот здесь у нас побеждает лапся важно было удобнее версионирование шаблонов Вот соответственно в дженкинсе есть шарит либо их не очень удобно версионировать нежели просто в gitlaby ввести версия нервами бренджей или там тегами здесь у нас тоже побеждает лапся важный момент для того чтобы команда могла воспользоваться всей сети без использования каких-то специальных знаний Здесь должна быть простота использования шаблонов чтобы можно было одной строчкой включить и собственно говоря продукты сети Здесь нам удалось добиться успеха немаловажный фактор фактор ролевая модель то есть приходит разработчик в команду ему нужно выдать права на нужные репозитории вот в дженкинсе тоже есть ролевая модель но не очень удобно потому что приходилось идти в команду которая поддерживает этот сервис и уже там подавать по запросу в gitlaby это все намного проще реализовано группа проектов каждый довод сможет управлять этой группы проектов либо какой-нибудь разработчик у кого достаточно прав Это намного упрощает жизнь по их выдаче поэтому это очень много у нас сборок было прометризированных то есть необходимо ввести какие-то параметры название ветки какой-то путь там имя вот также необходимо было сделать шаблоны уже пред забиты выбрать для того приложение версию указать и здесь проанализированные сборки из коробки конечно и немаловажный фактор скорость работы агентов чем быстрее раннеры работают тем конечно же лучше будет для продукта вот как мы не старались здесь побеждает дженкинс скорость работы агентов и так мы видим что у нас больше плюсов Вот он у нас побеждает и бонусы при том что мы выбираем этот инструмент у нас для хранения кода используется и один инструмент для хранения и для себя Вот и полностью сервер где можно публиковать какую-либо документацию статические странички кода Так у нас осталось две проблемы это параметризированная сборка и скорость работы агентов вот параметризированную сборку Мы решили чуть дальше я расскажу как Но по скорости работы агентов К сожалению проблема осталась чуть удалось ускорить но выйти на ту же скоростью дженкин К сожалению нет поэтому Это конечно минус но не критичный оказался для нас Ну Выбери для Выбери Выбери инструмент Итак вот мы видим стандартную форму где все поля являются строковыми и нельзя как-то их проанализировать То есть можно предзаполнить эти поля но нельзя никакие значения так скажем провалидировать списки раскрывающиеся сделать это очень неудобно на помощь нам приходит в ujs у нас соседняя команда сделал страничку на view.js где можно рисовать также через Ямал config параметризированную сборку Вот то есть мы здесь видим что можно выбрать шаблон список какие-то кнопки реализовать вот тем самым мы решаем проблемы параметризированной сборки и так по инфраструктуре То есть у нас есть gitlab к нему мы подключаем раннеры все раннеры работают в докере соответственно при завершении джабы докер удаляется нет необходимости как дженкинсе за собой очищать но нам нужен какой-то кэш где общий шара Где хранить конечно при сборке пакетов соответственно мы используем себя для этого меню выделен отдельный багет на раннерах и собственно говоря его можно использовать То есть у нас несколько рандеров тем самым решаем доступность отказоустойчивости агентов по распределению нагрузки мы здесь настроили конкурентный запуск То есть у нас Сначала был он равен 32 это когда слишком много что каждый нода может загружаться 32 одновременно Но при этом другие раны будут отдыхать Поэтому уменьшили до 4 Итак Идем дальше Зачем использовать бить G то есть приходит разработчик и очень часто задают вопросы пакет нужно показать посмотреть версии старые новые пришли ссылку на документацию с приложением где у нас установлен сонаркут да это же там ссылочку какой покрытие тестами проекта посмотреть какой путь до образа с приложением есть версии в registry вот так выглядит принципе быть G и они помогают ответить на все эти вопросы и подсветить где там есть проблемы нет проблем быстро перейти в общем-то разработчики это очень оценили и активно этим пользуются у нас так Какие шаблоны Мы реализовали в рамках нашей инфраструктуры Вольт он используется для хранения секретов докер соответственно для сборки образов основной язык разработки у нас питоны Java соответственно для питона и для шаблоны для статического анализатора кода мы используем у себя артефакторе для хранения артефакторов и попробовали шаболизировать интеграционные тесты но они слишком кастомизированные в каждом продукте поэтому скажем развитие сильного это не получилось 7 вверх семантическое версионирование стандартно по getflow соответственно если у нас идет диплоид на серверах где не кубер все мы хотим через Ну а для губернии либо ямки либо публикация собственно говоря статический страничек документации это уведомление по почте допустим отработал им нужно брать сообщение или какую-то статистику собранную и в плане этот реализовано этим шаблон авточень шлок формирование чеченцев файла здесь по сути реализована тестирование веб-сервисов то есть установили веб-сервис и если это не куберту проверить что все поднимается отработали это можно использовать здесь пример уже готовых есть в templace тоже уже собраны шаблоны готовы Ну есть у нас проект на но Джес Поэтому соответственно Мы берем Итак как выглядит вот мы видим что мы заканчили ветку мастер по мессенджу данном случае печь необходимо обновить патчевую версию секреты чек проверяем дальше собираем тестовый образ и выпускаем версию соответственно учится так в репозитории в данном случае 1272 то есть это был 1271 и запускается уже релизная сборка с автоматическим диплом на тест и на провод уже по кнопке вот так выглядит коммит в проект где есть кулер то есть мы уделял ветку также закомителя получили секреты манифесты дальше чек проверили линтера файлы если нужно конечно DF то есть так никакой не ставится дальше все это билдица запускается питоновский тест Тестируем манифесты что у нас все хорошо автоматически пушим так за собой очищаем артефакторе если необходимо и так давайте тогда мы здесь рассмотрим файл где мы собираем таким образ с нашим внутренний То есть у нас есть базовые образы где включены там все уже сертификаты компании и необходимые пакеты Ну и построены на базе уже утвержденного утвержденной операционной системы здесь у нас соответственно моим клубе подключение шаблона идет Project путь реф здесь может быть указан Как брендж так и так мы захотим дальше здесь будет плюсом что мы линтером проверяем сам докер файл просто очень часто докер файлы описались без какой-либо проверки без практики не использовались поэтому было принято решение сделать линтер обязательно но настраиваемый Trash Hold вот там соответственно если исправить в ордлинги по желанию можно исправлять и соответственно у нас здесь экстенс это расширение что мы хотим взять из шаблона Stage шаг чек Ну и уже через переменные мы определяем где-то файл лежит на экстра аргументы соответственно уровень которому проверяется и он ли Чен Это означает что если в этой папке произошли изменения файлах то Запускай проверку не менялся то проверка в целом не нужна так дальше собственно говоря здесь мы уже производим сборку вот вершин дир директория потом путь до этого файла важный момент здесь Image Take и соответственно Edition это текущая версия Основная это дополнительная версия если мы не знаем какой тег образа хотим скачать не знаю уже какой был там 29 указатели и соответственно скачается как-то будет выглядеть у нас артефакторе Мы видим что место больше это не занимает вот пользу приносит И так дальше провалимся сам шаблон базовый по сборке Докера и здесь у нас сейчас мы видим переменные которые мы управляем дойки рыночные он у нас всегда равен пути в детлабе то есть мы знаем Какой образ где Исходный код какого образа лежит у нас мы взяли за стандарт что как и в реджестре один и тот же путь и особо не нужно понимать искать так дефолтная тег на постановку в репозитории дополнительные теги нокер Билд экстра аргумент можно любой дополнительный аргумент показать при сборке если есть необходимость в этом докер файла стандарта Exist проверка что уже образ существует артефакторе и тогда соответственно не пройдет Всегда практически используем его потому что сборка значительно дольше идет дебаг режим и соответственно стратегия копирование репетитория всегда при сборке клонируется Исходный код скрипт здесь мы ее Составляем с кирпичиков используем референс эта тема для того чтобы можно было по желанию его кастомизировать не всем все шаги всегда нужны и был запрос на то что необходимо поменять иногда если скрипте это менять то это очень получалось и непонятно что за что где отвечает слишком длинный код неудобно его читать и кастомизировать как-то поэтому было принято решение выделить все разные кусочки Давайте подробнее рассмотрим сами кирпичи вот для примера есть у нас докер Build 1 торте Factory то есть мы логинимся в registry потом у нас есть проверка что уже существует если перемены у нас указано еще важный момент что мы использовали лаур-кейс позволяет верхнем регистре указывать путь до репозитория но доки реджетами этого не позволяет поэтому надо всегда использовать лаур-кейс то есть чтобы ошибок не было при сборке мы с этим столкнулись и тоже на это сделали отдельный кирпичик Итак у нас работает и нам нужно себя статистику где Какой установлен вот лабе у нас сейчас не работает полноценный поиск по всем репозиториям вот на текущий момент И для нас проблема выяснить где же все-таки используется старый шаблоны обновить у нас еще Кстати шаблоны версионируется бренчи То есть это не ставим и каждый брендж у нас 12 В3 И тем самым мы сохраняем обратно совместимость и можем носить Вот Но это статистика нам все равно нужно то есть нам важно понимать Сколько уже продуктов перешло у нас проекты в одном продукте может быть много много проектов а получаем статистику мы используем версиям шаблонов Какая версия более популярна мы знаем какой есть баки где нет обратно совместимости и задача где продукта можно там с артефакта или на Харбор перейти и для того чтобы произошло нужно посмотреть какими шаблонами пользуется продукт тоже важно понимать сколько жабов там запускается на каждой нонде есть инфраструктурная нагрузка Еще хотелось бы видеть нагрузку по самому по сравнению гитара понимаете Правильно ли у нас он нагружен Итак как у нас встроена встроенный сбор статистики У нас есть шаблоны Соответственно по ристопии мы это все сохраняем эластик То есть у нас скрипт есть отдельно опять же кирпичик который отправляет рез запрос в ластик формате json со всеми нам необходимыми переменными данными дальше у нас есть графа на визуализации всего этого подключаем его как источник но также есть необходимость там настроить alerting хранить 06 исторические данные для этого можно подключить Прометей 17 используют компании Прометей соответственно в нем Alert Manager Есть но то что писать нам нужно установить экспортеров То есть можно написать какой-то обычный экспортер который будет из ластика эти данные спирать и уже формате это прометает давайте может настроить свой alerting и так начали мы там 2021 году в середине даже ближе к концу изначально занималась там несколько человек семей этим контрибьюторов всего сейчас мы видим 10 Хотя продуктовый 20 человек нас несколько активности есть Поэтому одновременно работает максимум 10 человек и даже есть разработчики которые подключились к этому процессу вот группы проектов видим как растет растут Они что это значит у нас она у нас нет шариных раннеров нас у каждого продукта группы проектов и свои раннеры зарегистрированы вот поэтому группа проектов это равно там самому продукту мы где-то здесь там процентов 80 уже план выполнили осталось немножко перевести в группе проектов обычно Может быть там от 5 до 20-30 проектов активных Спасибо за внимание может приступить к вопросам так Владислав туда сейчас технические проблемы сейчас переподключится давайте так Ну давайте Может тогда я почитаю что падает каждый день женькинс нет каждый день не падает на своего хорошо поддержит но естественно это чаще происходит джинке своей говорит лапы любой модели возможности в теории может быть да но у нас вернулся накидали много вопросов используется ли вы функциональному целевой модель доступа Когда нужно запускать дочерних проектах на про так есть только контейнеры раздавать всем доступным тренер Да некоторые продукты его используют себя Как ощущение мультипайплайны своеобразные Лично мне это не очень зашло но есть продукты без этого не обойтись так вас есть шалитранеры для всех команд или вы делаете использовать проблемы с рулевым доступом проектах есть только мы тренера Ну тут в каждом проекте Но на самом деле такие проблемы Да могут быть но проблем сильных не испытываем Потому что всегда есть команда на связи которые могут оперативно подключиться если нужно выдать права на параметризированную сборку но чаще всего мы стараемся чтобы прикормить и весь полноценно запускался и не было необходимости что-то делать руками для всех команд или вы делаете раннер охранеров У нас нет мы от них полностью отказались от компании только у каждого свои раны регистрируются были сравнения раннеров сравнение 4 агенты дженкинс сидит лап только статистический или динамический тоже так хотелось раскрыть побольше вопросов может быть уже в комнате да давайте действительно уже перейдем в комнату время закончилось Всем спасибо за то что сегодня были с нами видали Спасибо большое за презентация и ждем вас всех уже дискуссионной комнате чтобы дальше общаться Приходите в комнату"
}