{
  "video_id": "V1dVPYwPV6M",
  "channel": "DevOops_conf",
  "title": "Александр Кожемякин — 7 раз отмерь, а потом переделай: как мы храним сетевые политики",
  "views": 308,
  "duration": 2451,
  "published": "2024-09-06T01:34:51-07:00",
  "text": "Всем привет Меня зовут Михаил я с Александром работаю в компании VK в отделе единого облака и у нас много куперов также у нас много сетевых политик и несколько сеянаев и за время их эксплуатации Мы поели много всего интересного и сильная скуперами и даже семинованием политик и про это Саша сегодня хочет и рассказать Спасибо Всем привет Меня зовут Александр собственно занимаемся мы купирами и хочется немножко поделиться нашими наработками нашим опытом о чем будет сегодняшняя презентация хочется рассказать На какие грабли мы наступали в процессе вообще эксплуатации куберов с политиками Да как их храним как именуем как мы боролись со сложностями в процессе прихода к политикам и почему несколько раз все переделывали из этого будет видно как эволюционировал наш подход и что у нас получилось в итоге такие мы смогли для себя выделить плюсы и минусы собственно почему это презентация появилась мы довольно быстро пришли к тому что нам нужно включить политики в режим но мы это проделывали силимом в первый раз потому что сильным появился относительно недавно и по ходу этого дела Мы очень много узнали интересного как В целом работе политик и выяснили много новых интересных моментов работе собственных приложений и работе сети меня кстати сразу вопрос есть а Поднимите руки Кто политиками сетевыми пользуется есть кто-то Круто А есть у кого-нибудь дефолт Дина и включенный Вот уже лучше собственно для кого кажется будет презентация полезной Если Вы только начинаете пользоваться политиками Да она поможет вам разобраться в организации и не столкнуться с нашими проблемами вот если вы уже опытный пользователь у вас там тысячи политик написано лежат в репозитории Надеюсь вы откроете для себя какие-то новые моменты немножко для начала хочется накинуть контекста как у нас в принципе все устроено у нас везде плоская 3 сеть нас у всех кодов выбирать реальные адреса сил пока что 1123 вот глобальный доступ а правила для приложения регулируем уже непосредственно в кластерах всего у нас сейчас 27 кластеров они все разные в самом большом тысячу с чем-то нот Да в самом маленьком 30 И еще у нас на самом деле используется как Калик это касилиум вот поэтому я еще немного расскажу как собственно подружить при использовании политики эти два сена и Почему мы начали использовать в принципе силлиум основная фишкой которую мы хотели получить Это был кластер Мэш силиум позволяет объединять ваши кластера в единую сеть на уровне сенай и таким образом у вас в каждом классе остается свое сетевое пространство но появляется сетевая связанность между сущностями и наши кластера связаны сетевом уровне это дает много интересных фишек например даже отказа устойчивость Да допустим у вас есть какой-то сервис который вы очень хотите прибить к нодам конкретного кластера потому что он может жить только в одном классе не знаю что-нибудь и Мыльные сгпушками оно может жить там вот только в классе но при этом если у вас серия по какой-то причине перестанет приходить трафик там упадут все игры ваш сервис все равно продолжит работать поскольку трафик на него зайдет через соседний кластер вот Одна из таких причин была для нас довольно важной поэтому выбрал выбор был сделан в пользу силёма Почему мы пользуемся политиками во-первых за счет гранулярного и гибкого управления сетевыми доступами также за счет того что мы смогли очень сильно снизить время открытия сетевых доступов для наших приложений поскольку делать это на глобальных файерволах занимала какое-то время пока вы отправите заявку там согласование все это пропишется когда вы это делаете на уровне кластера у вас все довольно просто вы написали политику доступ открылся также с политиками удобно работать в плане отслеживания изменения сетевых доступов поскольку у вас всегда есть единая точка Правды это ваш репозиторий и в случае если вы хотите убедиться Все ли у вас класть или хорошо Все ли там идет как надо вы нажимаете Одну кнопку запускается div и вы видите соответствует ли ваш кластер ожидаемом состоянии собственно что мы используем мы пользуемся практически всеми типами политик мы пользуемся как L3 так L7 стараемся писать понятные правила но при этом используем много разных фишек с лейблами Вот и все политики пишем для уровня приложений за время того как мы пользуемся сильвиумом получилось отметить в основном Что написать хорошую простую в то же время лаконичную политику на самом деле достаточно сложно также В некоторых случаях у нас не получается переиспользовать наши политики и под другие кластера их приходится переписывать еще мы активно пользуемся шаблонизацией просто Как пример Да мы храним все политики в одном репозитории пользуемся фильмом и мы привыкли Как видно по скриншоту потому что у нас вместо списка IP адресов просто какие-то буквы которые где-то задаются в переменных в нужные нам рынке а как это все положить в классе нас есть paypeline сделанный gitlapsi который собственно может вносить изменения в классе Мы можем выбрать какой-то кластер точечно вот еще на самом деле мы умеем выбирать не только кластерную какую-нибудь конкретное приложение и сделать выкатку ровно только для него 1 вот поэтому устроен таким образом что проверить соответствие мастеру мы можем одной кнопкой нажали Одну кнопку У вас высветился div либо там зеленые галочка либо красный крестик либо все классно либо не очень если там все классно не обязательно прокатывать не очень классно Надо наверное прокатить и убрать расхождение Вот и таким образом нажатии одной кнопки можно быстро убрать расхождение как это выглядит с точки зрения инженера как-то у нас устроено на инженер пытается написать новую политику или поправить старую он делает это локально тестирует по необходимости репозиторий мы обязательно пользуемся review то есть мы зовем кого-нибудь еще из команды и просим если все хорошо я не буду лишний раз нажимать кнопку и если все хорошо этот МР можно раскатывать в кластер вот если не очень соответственно придется инженеру поработать немножко больше мы таким образом пытаемся избегать каких-то очевидных ошибок простых опечаток Ну и в принципе уменьшать влияние человеческого Фактора Что произошло после вот хочется рассказать что первое что у нас было Да вот все классно все круто у нас получилось мы никогда этого не делали и никогда этого не делали сидиуму и мы взяли и сделали все классно Вот мы стали добавлять политики вообще для всех приложений Ну потому что мы же теперь Крутые мы прокачали свой скилл мы теперь можем мы умеем давайте для всего напишем политики нас будет безопасность у нас будет весело что было на самом деле по съемкам все красиво главный вопрос что же происходило в репозитории вот процесс на Было ли Все хорошо да А вот в репозитории к сожалению не так все хорошо так на картинках вначале и сейчас расскажу почему первое решение которое мы пришли то есть что мы начали делать Мы решили У нас есть какое-то приложение нам нужно создать файл положить туда сетевые политики кажется что это очевидно одно приложение один файл с политиками Так мы делали в самом начале Когда в классе мало всего это очень удобно у вас нету какого-то огромного количества файлов там что-то запутываться это вот все не надо и когда вы тоже только начинаете пользоваться политиками это тоже удобно потому что вы еще толком не разобрались вас один файл все знаете где поправить супер и договариваться о чем там всякие именования какая-то иерархия все вообще не нужно вот все понятно есть где искать но основные минусы то когда у вас появляется больше одной политики на самом деле Почему Вот пример Да скриншоте это две простеньких политики для силима они у нас для ipv6 чтобы работало cmp потому что не работает приложение и прям вот на примере силиума Да чтобы он у нас работал и собираем для него какую-то политику кладем ее файл делаем вторую политику Да там игра собрали потом Andreas тоже кладем в этот файл блин классно Круто вас файл он наполняется политиками все понятно все в одном месте дальше мы начинаем делать еще политики потому что ну нашему очевидно Не хватит политик только для СМП Да у него еще куча разных компонентов у него есть Ха был ему для кластер мыша надо какие-то там трафики свои запускать видеть сходить зарегистрироваться Вот и мы начинаем это все тоже описывать и продолжаем складывать в один и тот же файл потом мы сделали и получили файл на полторы тысячи строк практически В общем Ну кажется это не очень хороший результат Вот и мы пришли к выводу что это удобно это просто это понятно Если вы хотите только поиграться с политиками Если вы будете использоваться этим подходом в реальном проводе будет довольно сложно вот и шанс того что ваши инженеры просто увольцы там или с ума подходит очень сильно повышается и политики тогда в принципе некому будет писать вот чтобы этого избежать Мы начали что-то менять и Мы научились хранить политике в двух файлах Мы решили что в двух файлах строк будет меньше чем в одном Вот это очень логично и было решение правда и мы стали делить политики по направлениям У нас получились файлы вида там application namegress что было с этим подходом нам кажется что мы строим светлое будущее потому что мы тоже улучшаемся У нас улучшилась структура репозитория у нас улучшилось понимание кода потому что и время на поиски изменения на самом деле тоже поскольку все политики лежат в одном файле как это происходит соответственно когда это в двух файлах хотя бы по направлениям Это хорошо разделено мы начинаем понимать что движемся в каком-то правильном направлении Вот но нас все равно не покидало чувство что где-то еще будет проблема и вот мы опять сделали и опять получилось очень много поскольку Не прокатило надо делать как-то иначе поскольку объем файла все такой же большой В итоге вас все равно падает читаемость у вас возникает еще две отсюда интересных проблемы откуда я расскажу дальше о которых я расскажу дальше Вот и мы стали просто делать больше файлов мы договорились что будем пользоваться шаблонами для именования Да и принимать его как Application компонент и направление для политики наши файлы стали выглядеть Чуть более длинными например да и его что это во-первых репозиторий стал гораздо более упорядоченным у нас перестали появляться огромные файлы изначально были опасения что большое количество файлов может внести какую-то путаницу но как ни странно поиск в итоге стал гораздо удобнее под поиском я имею ввиду поиск какой-то конкретной политики при этом у вас очень сильно будет расти количество файлов а также потребуется от инженеров всегда четкое понимание Какой компонент они сейчас хотят поправить поскольку в одном файле можно поправить посмотреть прикинуть Когда нужно знать точные компонент сначала подумал поправил потом только видел дальше мы столкнулись с интересной проблемой в этом подходе назовем ее курицей яйцо нас Давайте предположим что мы хотим только там поиграться с политиками поиграться с кластером Мы берем какой-нибудь Hello World of джинса контейнер Да и запускаем его в кластере для того чтобы в принципе понять что он будет делать как-то понять его результат Мы хотим поднять Ingress и в браузере открывать смотреть Hello world красиво красиво Если у вас есть политики вам потребуются две простеньких политики Да чтобы разрешить два простых правила чтобы разрешить трафик Первое правило будет необходимо для ингресс-контроллера вот второе правило будет необходимо собственно для вашего приложения вот у вас есть две политики куда мы будем складывать можно сложить все приложению в этом случае будет довольно удобно все выкатывать и удобно правильно самом деле То есть как это происходит Да вот как я рассказывал по нашему Раньше у вас инженер добавляет политику и игры политику добавляет новое приложение что происходит он идет запускает нажимает Одну кнопку и вместе с приложением у него выкатываются политики к этому приложению очень удобно хорошо довольно быстро происходит при этом все политики от конкретного приложения у вас будут находиться в одном месте их все так же хорошо искать быстро никакой путаницы но при этом мы теряем возможность в принципе отслеживать политики для ингрессов какие там написали да для своих angress контроллеров поскольку они будут разбросаны по какому-то вообще огромному количеству приложений особенно если у вас много приложений которые собственно требуют энгресса у вас таких политики могут быть десятки сотни или даже тысячи Вот и в таком подходе также у нас начнет ломаться принцип того что политики какого-то компонента они должны находиться в одном месте потому что фактически политика для истины ингресса из примера я опять кнопки зачем-то нажимаю она будет вас лежать не возле игресса А уже возле какого-то другого приложения можно разнести политики отдельно что мы делаем мы ингрыз политику положим к нашему приложению поскольку он должно принимать какой-то трафик а игры с политикам истинга с контроллера таким образом получится что все лежит Казалось бы на своих местах такую политику можно тоже довольно легко поправить Потому что ты знаешь что там лежит одни тут другие Но такую политику очень легко потерять смотрите у вас приходит инженер Особенно если это новый инженер или он не работал с вашей инфрой и вот ему надо для того чтобы запустить Казалось бы простенькое приложение и пустить на него трафик ему надо написать политику для приложения пойти в другое место разобраться где вообще у вас для этого ингресс что-то лежит написать политику положить ее туда разобраться как это все выкатить всей пачкой вот становится сложно отсутствие консистентных выкаток это как раз опять-таки отсылка в том что для того чтобы у вас опять запустить потребуется уже не одну кнопку нажать да чтобы выключить приложение вам потребуется выпустить ваше приложение в котором выкатиться политики и следом еще прокатить полностью Чтобы на него тоже накатились новые политики таким образом принцип одной кнопки Мы очень быстро теряем нам на помощь пришли лейбла что мы сделали мы стали вешать лейблы на нем спейсы например какой-нибудь возьмем админстру Да и мы стали писать политику довольно простую мы стали писать ее один раз и выглядит это таким образом Да что вы своей политике указываете что она просто должна мать с каким-то нужным вам лейблом указываете что этот лейбл Будет нам спейсе вот и делаете эту политику уже для своего ингресс-контроллера и таким образом на всех пейсах на которые вы повесите правильный лейбл автоматически будет открыть доступ со стороны ингресса и ваше приложение будет автоматически получать трафик просто получая лейбл на нем Space что получилось мы перестали создавать лишние политики и наших приложения сразу стали получать но при этом стоит отметить что Мы открываем таким образом доступ сразу же и выдавать доступ для гранулярный доступ Я имею для таких приложений становится немножечко все-таки сложнее чем при прямых политиках порог вхождения выше Что это значит усилиума довольно замороченный синтаксис лейблингом по Expression Вот и когда у вас вот с такими типами лейблов начинают получаться довольно громоздкие конструкции опять же к вам приходит Новый человек в команду он на это все смотрит ему становится плохо он не понимает потому что он пытается поправить она ломается Вот и сам себе синтаксис и сложность конструкций они гораздо выше Давайте немножечко вспомним про что мы уже поговорили во-первых мы разобрались с файлами как их можно именовать складывать поняли как жизнь и пока что выглядит что это удобно Если у вас только один кластер если у вас кластеров много нужно будет все шаблонизировать Давайте посмотрим как мы пользуемся активной переменными в своих шаблонах в принципе стараемся как можно больше использовать шаблонов для политики почему это хорошо хельм Он сам будет подставлять все необходимые значения Если вы договоритесь о именовании конкретно политик да то вас везде будут нормальные хорошие нам разные имена и выглядеть это все в репозитории будет довольно красиво и одинаково поскольку у вас все одинаково все единообразно если инженер пойдет потрогать класть руками он в принципе да понимая ваше соглашение именование он понимает что это Зачем это надо и не удалить например Потому что не будет править это руками а здесь При таком вот глобальном именовании особенно немножко вернусь используя переменные релизные Space Release name которыми мы активно пользовались в начале Да возникает сложность в том случае если у вас есть какой-то чат и в нем больше чем одно приложение либо Если ваше приложение умеет порождать дочерние контейнеры Объясню почему вот например есть пока что шаблон политики да то есть у вас есть имя у вас есть правила для того чтобы он автоматически Достал из репозитория адрес и подставил себе нужные там для вашего окружения дев протест что там неважно и повесил себе какие-то красивые правильные лейблы подтянул их сразу же из релиза все подставиться автоматически все хорошо но при этом именно едва праймер нам все Изначально и сломал смотрите если у вас в классе будет больше одного ранера или если это будут разные ранее а особенно если эти раннеры умеют порождать какие-то дочерние процессы которые требуют иного доступа Ну например у нас есть в paypeline в другом кнопочка Билд кнопочка Билд она должна собрать какое-то приложение да Что она делает она запускает на котором там делают и этот код складывается например в канику Да потому что это кошечка и каникабилдер он запускается тоже раннером но другим контейнером этот контейнер вас запускается рядом но у него будут другие лейблы и ему Скорее всего будет необходим уже какой-то другой доступ именно здесь у нас случилось небольшая трагедия что мы стали делать мы начали использовать больше понятных имен Вот и поменяли соглашение обменование стали пользоваться saprocess что это нам дало случаи когда мы просто подставляли релиз нейм релизным спейс у вас и для вашего основного ранера и для порожденного подставиться одинаковое значение и эта политика отработает в классе средней корректно вот поэтому придется добавить дополнительные лейблы пока что это выглядит так на самом деле Ну кажется что это не самое крутое решение которое можно придумать все равно думаем как это можно улучшить пока не получилось на самом деле и основные моменты Да хочется обсудить Стоит ли все шаблонизировать в целом во-первых это читаемо это понятно у вас убирается какое-то огромное количество там опечаток ошибок Вот это вот всего после того как глаза начнут привыкать к структуре в кластере тоже становится довольно удобно все это искать вы это делали в репозитории Заходите в классе такие же имена все понятно Вот И основная Хорошая вещь из этого всего то что вы получаете именно единообразие во всех своих кластерах Ну и минусы как я уже упоминал это приложение с дочерними процессами или если у вас их несколько здесь стоит быть аккуратными просто Что у нас получилось во всех кластерах одинаковые именования и файлы осталось разобраться одно Как хранить в репозитории Какие сложности мы для себя отмечали во-первых у нас несколько как я уже упоминал это и Карика и сильно мы разные и политики для них соответственно выглядят разным образом должно быть удобно всем что я здесь имею в виду поскольку кластеров много его эксплуатируют больше чем одна команда но репозиторий для приложений политику на общей и пользоваться здесь мы старались сделать так чтобы всем кто будет это использовать было удобно хорошо они там не передались между собой не дай Бог после работы где-нибудь Вот потому что битый инженеры неплохо работают Вот и в кластер не должны попадать лишние элементы поскольку что имеется виду опять же вы не должны потащить с собой какие-то вещи для которых у вас попросту нет поскольку если вы кластер с каликой потащите силу умную политику вас просто ошибка и скажет Ну нет таких crd ничего не могу применить что мы стали делать во-первых немножечко еще занудствую на тему как у нас организован сам репозитории у нас есть три уровня переменных Да вылился и переменные уровня кластера Что здесь происходит в кластера Да в уровень кластерс мы добавляем какие-то значения которые специфичны для конкретного кластера и не могут быть при использованы где-либо еще на уровень выше в час мы добавляем те значения которые могут быть использованы чартом во всех своих кластерах и таким образом мы утащили наши политики чуть выше чем уровень кластеров чарт и у нас для этого Получилось отдельная структура каталогов Как видно из второго скриншота допустим на примереть менеджера Да у нас есть папка Network policys и в ней еще два сапфолдера Калика и силем вот таким образом политики для колики складываются соответствующую папку для силлионов свою вот основным минусом который здесь стоит отметить это то что Вам в таком случае придется для каждого кластера заранее указать которые в нем используются шанс получилось Мы подружили политики Синай разных Да чтобы они стали жить в одном репозитории и научились их править Независимо и соответственно один раз вы выбрали как я уже сказал политику на уровне кластера и в него будут ехать приложение только с нужным типом полить при этом у вас не будет гарантии одинаковости ваших политик Как легасе так в новом кластере что имею ввиду под одинаковости вот смотрите у вас есть инженеры которые обслуживают кластер скайрикой и сил и пример Да как sirt Manager например ребятам в классе с каликой нужно добавить какой-то доступ поменять они это берут и меняют но они поменяют Это только для калики потому что они знают калику и потому что им на самом деле нужно только для калики А что там с кластерах на самом деле Ну наверное не столько интересно и вас там сильные политику они трогать не будут Поэтому рано или поздно политики для разных типов все на они могут начать разъезжаться вот ну И также вам нужны дополнительные переменные тоже там в некоем роде усложняет анбординг новых инженеров Ну и в принципе понимание того как У вас встроен репозиторий как У вас все хранится Давайте потихоньку начнем подводить итоги хочется рассказать с чего Мы начинали Да когда только использовали взяли силиум и начали делать политики Мы создали в своем репозитории бардак у нас были сложности шаблонизацией не было никакого единого именования что тоже оказалось важно потому что поначалу Всем пока учились писать политики именовали Короче как Кому нравится Вот и вы открываете файл у вас там какой-нибудь Ingress for DNS туда-то следующая игра с политика вообще по-другому называется становится страшно и непонятно глазах инженеров Понятно новая штука она непонятная еще и запутанная что мы получили пройдя весь этот путь мы его шли наверное Мне кажется уже чуть дольше чем год мы все привели в Единый вид Ну упорядочили структуру файлов упорядочили структуру каталогов разложили все по репозиторию Как нам нравится вот инженеры стали больше улыбаться Ну по крайней мере даже если не стали то работать с политиками Им стало гораздо удобнее вот еще есть такой слайды интересный что точно можно порекомендовать это какие-то моменты которые взяли Из своего опыта Если Вы только начинаете пользоваться политиками обязательно договорились о том как вы будете именовать и Какая у вас будет структура файлов и репозитория кажется если бы это было у нас в начале все было бы гораздо проще и легче Если вы уже пользуетесь политиками сведите себе какую-нибудь страничку там в ношене в конфликте на самом деле абсолютно не важно любая система которая вы пользуетесь куда инженер сможет зайти и когда у него подгорела при работе с политиками с кластером он зайдет туда и напишет об этом нам это тоже очень помогло потому что в таком случае вы можете проводить ревью того что там написано раз в месяц или раз в пару месяцев понимать где плохо и становиться лучше поскольку просто проводить ревью тоже плохо я объясню почему вот что-то не понравилось человеку его бомбануло от того как все плохо сделано он вас через неделю это все забыл у него другие задачи А так он записал и потом еще и хорошенько набросить на этой встрече и благодаря такому подходу У нас тоже улучшились процессы Вот и улучшилась работа с политиками много взяли оттуда Пользуйтесь политиками делайте кластера безопасными Спасибо если у вас давайте начнем Спасибо за доклад Но вопрос простой А вот в процессе разработки этого решения вам не приходило скажем так идея да шаблонизировать те же политики на уровне хелма и допустим генерировать и для силиума и для ханника из одного тимплейта до сразу там все политики укоротить размеры файлов сразу же шапки там все убрать Ну то есть Дописать какой-то сверху еще свой warhead получается да который бы подставлял за тебя шаблон на все шапки то есть в хелме написать template которые из некоего хорошего формата который Вам нравится будет генерить политики примерно к тому и пришли Вот то есть и нарезали шаблоны сейчас таким образом чтобы формат нам нравился наверное имеется ввиду что вот есть я был файл для всех а потом из него разъезжается на каликается сложности с этим неудобно того что вот у нас есть например политика которая должна быть в одном классе нет в другом нам надо ее написать и подумать то есть постоянный процесс думать Думать Думать о том что надо ли в одном кластере Надо ли в другом нам проще На данном этапе нашего развития написать отдельно для цели мы отдельно для калитки возможно потом мы придем уже красиво Если еще вопросы Спасибо за доклад Меня зовут Борис было очень интересно и у меня прямо Аналогично на самом деле вопрос он почему созрел Вот вы раза три или четыре переделали Все я честно говоря не представляю сколько усиленно это потребность потому что опять же Это же чарты наверно разработчиков и либо нужна саму всем пол реквест принестись переделыванием либо всех как-то покушать чтобы это произошло Но точно сложно У меня возникла идея Почему не сделать оператор в котором в котором будет crd-шка с универсальной политикой и уже Оператор будет генерировать политики в зависимости от типа кластера То есть у людей будет в чарте сердечко там стандартные формы Ну то есть откуда куда порты и тип трафика оператор уже сам генерирует что надо плюс там дефолты какие-то добавляет опять же они по любому есть Ну именно межсервисное взаимодействие иногда не нужно было бы менять это не думали ли вы в эту сторону то есть именно на cubernetis переложить деятельность вот эту по генерации можно генерировать в коде в репозитории А можно уже потом создавать по сути шаблонизировать не было ли такое идеи Вот вы наняты Идея хорошая Вот Но к ней мы пока тоже не пришли я думаю если бы пришли рассказали бы сейчас я хочу добавить в каждой команде есть определенный уровень зрелости наверное и вот до уровня написания Купера операторов Для сетевых политик мы еще не дошли Если еще вопрос задавали вопрос в чате он не совсем про политики но я его наверное зачитаю Борис это вы как мы обновляем целиум если он мультикластерный у нас есть 3G где мы сначала это проверяем есть DF потом есть провод но общая идея в том что мы выгоняем из одного кластера всех обновляем там потом переливаем трафик и как бы обновляем другое если что убираем все взад и второй вопрос почему не оверлеи я если честно не вижу их пользу именно в нашей сетевой конфигурации поскольку у нас доступен и GPS экспортируем сирот Зачем нам оверлей вообще в данном случае"
}