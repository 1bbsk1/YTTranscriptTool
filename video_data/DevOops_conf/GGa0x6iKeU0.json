{
  "video_id": "GGa0x6iKeU0",
  "channel": "DevOops_conf",
  "title": "Илья Савин — Airflow в кровавом энтерпрайзе",
  "views": 310,
  "duration": 2721,
  "published": "2024-06-28T07:00:06-07:00",
  "text": "Здравствуйте коллеги Очень приятного сегодня здесь приветствовать особенно на открывающем докладе который близок не Давайте немножко познакомимся Меня зовут Дима Зуев я из компании Тинькофф и я сыр флоу знаком Давненько немножко с другой стороны Поэтому мне очень приятно что меня позвали экспертом доклад Ильи Илья Савин из супермаркета сегодня вам расскажет как со стороны инженеров и вопс обращаться с airflow потому что Тема горячая он есть уже наверное у всех и вот как раз таки тема это фразе очень отображает реально суть делал Что это состоявшийся технология Илья Скажи пожалуйста как вы докатились до того что он вам Понадобился Всем привет Меня зовут Илья Понадобился пришли заказчики в данном случае это были аналитики которые очень захотели чтобы они были прозрачные чтобы они всегда были хорошие прекрасно Илья ходе доклада расскажет про это больше а основное смотрите есть ссылочка на чат Там мы с Ильёй присутствуем будет неплохо Если вы туда вступите после доклада будет дискуссия Ну сначала будет входить в зале потом идем в помещение чтобы пообщались на этот ТЕТ Вот Но если у вас возникает вопросы чтобы не забыть вы можете написать Сразу в чат но и после доклада мы будем их задавать Ну что Илья давай мочи немного мне Я инженер инфраструктура в компании сбермаркет и на текущий момент я занимаюсь поддержкой airflow в нескольких инсталляциях для разных направлений в одном из направлении есть несколько команд до 10 примерно соответственно это аналитика контент Начнем с того что такое Как нам подсказывает Википедия это открытый программное обеспечение для создания выполнения мониторинга регистровки потоков операции по обработке данных если своими словами это очень классный на питание для выполнения кода на питание Он классно масштабируется его можно легко модернизировать собственно потому что на питание основные компоненты airflow это скедуллер Триггер воркер и веб-сервер соответственно скидлер это основной главный компонент который рулит собственно планированием также тем чтобы все таски все выполнялись вовремя и корректно Триггер это компонент который следит за склонением собственно триггеров это один из это функционал Как из названия следует это курочек который по каким-либо событиям запускает какие-то таски задачи worker это основная среда исполнения кода соответственно это именно то что загружает разработчики и то что исполняется и веб-сервер это для визуализации отрисовки и управления следующий слайд Что такое etel Я думаю что все здесь присутствует все кто присоединился знают что это это экстракт трансформеры это обычно это процесс когда мы берем какие-либо данные что-то с ними делаем агрегируем очищаем и куда-то перенаправляем например чтобы были у нас красивые графики о том что у нас очень крутая выручка или что-то в этом духе Что такое это направленные циклический Граф его основной основное отличие любого другого графов в том что он направленный То есть он не может быть зациклен он всегда идет в этом направлении на этой картинке вы видите как это может происходить точку б все данные идут в этом направлении нет такого что есть точка б и точка б обращается обратной точки вот такого счастью быть не может соответственно у нас всегда данные будут в порядке дальше покажу общий вид интерфейса и Flow скорее всего все видели на данном слайде вы видите примеры дагов их запуске кто их запускал точнее кто их огнет время в которое они выполняются когда он последний раз выполнялся последний доски их статус выполненные либо на паузе стоят либо с ними что-то происходит а там кстати все хорошо также здесь можно управлять ногами То есть их можно удалять перезапускать или запускать или полностью на этом сайте мы видим конкретный так и здесь видим в какие статусы конкретные таски Какое количество успешных когда запускались запускались соответственно это Граф ев здесь показаны зависимости дагов Как было на предыдущем слайде одном из них там были точечки просто здесь уже они подписаны Мы видим что в рам автолуп можно попасть из раны ноль ран ни один равными 2 одна таска всегда будет пропущена и одна будет запущена одновременно рано на данном слайде вы видите то как у нас сейчас устроена airflow то есть то к чему Мы пришли на текущий момент это не окончательная версия здесь еще много есть доработок но тем не менее то есть Казалось бы один маленький продукт приложение Но для того чтобы стабильно и хорошо работал нужно очень-очень много обвязки вам всем понятны здесь описаны плюсы и минусы скорее всего все их знаете если нет Ладно не буду читать разделим все вот эти вот компоненты эти сервисы дополнительные по нескольким направлениям мы все срубились Security hillity и CS и остановимся подробнее на каждом из них и для чего он нужен в эксплуатации высокая доступность собственно здесь у нас присутствует четыре компонента два из них появились вследствие инцидентов Как вы знаете или не знаете есть несколько видов чартов для инсталляции в интернете и официальный чат плюс еще Некоторое количество форков основные два Для чего использовать комьюнити чарт либо официальный чарт исключительно для того чтобы снизить нагрузку на инженеров чтобы инженеры Не сами писали каждый раз новый чарт а потом следующий инженеры которые приходят очень долго и трудно разбирали что написал человек предыдущий а сразу могли посмотреть и на документацию написано контрибейтесь код Source либо просто обновляться соответственно мы выбрали если комьюнити чарт инсталлировать с дефолтными настройками то все компоненты поднимаются в одном спейсе с предложением в том числе базы данных после одного инцидента все подняли красиво развернули написали развернули это все в клубе лежал рядом с предложением и в один из не прекрасных дней одна из нот умерла вот после этого было принято решение что нужно держать отдельно от приложения чтобы при любых инцидентах база навсегда осталась живой вот мы выбрали менеджмент решения но также можно поднять локальное Никто не запрещает в данном случае это менеджерт решения от Яндекса 3 над балансер плюс в самом есть компонентный балансер который поднимается с чатом И этого достаточно для стабильной работы который здесь нарисован это тоже один из студентов Если ставить или официальный чат синхронизация то есть кода который исполняется с идет посредством к сожалению не всегда этот сингл отрабатывает корректно не всегда getlab доступен в отличие от бакетов бакетов более высокий слон и мы переключились на бакеты для чего для того чтобы нас всегда код был доступен если например у нас умрет iPhone если у нас умрет ламп у нас кот хранится на бакете и соответственно при запуске новых датов либо при старте самого приложения у нас код всегда есть Если бы не было макета и например были какие-то перебои почти либо хотя бы немножечко которые запускает при попытке забрать код из либо из гитхаба подвисает и начинают копиться зомби зомби таски что очень хорошо и соответственно это трудно улавливается если плохо настроены они настроены плохо почти всегда если у вас нет фабрики дагов чтобы сделать фабрику дагов нужно чтобы у вас разработчики стремились к этому такого нет Поэтому лучше предохраниться обезопаситься и добавить S3 в этой секции у нас все хранятся в GTA V у нас инсталляции приложение и при попытке выкатить что-то нехорошее например кто-то решил руками что-то закатить можно всегда легко откатиться нажав условную кнопку на предыдущую версию при этом не лезть словами руками они а также расскажу про то как мы строим счастье Ну и собственно Здесь тоже описаны плюсы и минусы что кодеков приложениях версия нервы проверяется можно разработку беспорядки что-то сломать минусы что код медленнее попадает наоборот усложняется поддержка приложения следующий наблюдаемость Здесь тоже видите 4 пиктограммы Это exporter здесь прометиусом спрятался Елка стек центре и графана для отображения того что он собирает нос да собственно плюсы использования данных инструментов то что у нас метрики отдаются и логи отдаются системам получаем наблюдаемость и нормальный дубак минусы естественно это поддержка этих сервисов требует внимание то есть нет такого что подняли условно центре и он всегда у нас работает К сожалению так не работает нельзя поднять ЛК и думает что всегда будет работать это тоже требует внимания о Секьюрити Здесь три компонента это секрет бэканд для airflow ssot у нас доступа чтобы пользователи могли приходя на работу авторизовываться под одной четкой и ходить куда им нужно где у них есть данном случае это который хранит себе переменная именно сяо также ограничивает доступ исполнению вся и репозиториев с исполняемым ходом и кодом приложения соответственно плюсы тоже описано что секреты отслеживается кто их изменял появляется возможность автоматического давления секретов например произошла какая-то утечка какой-то пароль изменился мы нажимаем кнопку и например написанный так идет меняет пароль в базе данных а потом этот базы данных подкидывает в Connection который используется и все которые были зависимы от этого Они использовали продолжают идти в том же по тому же времени как и шли при этом у них поменялся пароль базы данных То есть получается что разработчики не знают этих паролей и они не волнуются них То есть например так наверное здесь надо пояснить про коннекшены у РФ есть такая штука называется connaction соответственно из названия звучит в нем описывается подключение к чему-либо например базе данных Прогресс он содержит себе хвост логин пароль название базы данных вот разработчик может использовать его не зная ничего из того что я перечислил ему нужен только ID этого Connection то есть взял код написал и соответственно может обращаться к этой базе данных Посредством своего кода ему не нужно знать что внутри Великолепный Вот и соответственно в такой ситуации то что происходит за кулисами тоже никого не интересует Вы спокойно меняете Пароли у вас все работает приложение работает безопасность безопасная Ага Так минусы соответственно тоже есть что система требует поддержки это нужно поднимать волк надо его настраивать sso соответственно тоже настраивать Мы например используем актив в директоре кто-то использует сторонние либо свое что-то поднимает минусы что система требует поддержки и медленное изменение конечно по сравнению Вы можете спокойно создать новый Connection быстрому нужно его сразу работает здесь такой подход не работает Нужно чтобы Connection был создан кем-то после этого вы прописываете себя и у вас начинается работать Здесь вы видите для встреч ветки Так у нас сейчас происходит Здесь наверное ничего сложного Здесь ничего сложного здесь в левой части прямо квадратика вы видите Да и рекласти и докер файл вот при изменении каких-либо из этих файлов идут какие-то Pay планы в данном случае это собственно папка с дагами конкретной команды конкретного направления например аналитика и там какое-то количество команд вот при изменении какого-либо из файлов в этой папке после того как после изменения этих файлов идет конкретно измененный И после этого идет довольно медленно и соответственно появляется на настыдже либо напротив если изменяется рекласти это Файлик естественно Скорее всего вы знаете с зависимостями например питона там перечисляются библиотеки питона вот для если он изменился то нужно будет пересобрать сам образ который будет выкатываться на Stage и соответственно три гидриться другая также изменяется которые собственно приводит собирается имидж пушится в Харбор и тепло и цена на случай встреч сверху увидите что где подхватывается разные чаи У нас они в разных репозитариях и соответственно заблокированы например и управляется одними людьми хелем другими людьми история они общие их можно использовать нужно даже использовать чтобы не переписывать один и тот же код здесь отображена отображен сиаей для фича ветки собственно Тот процесс который мы почти везде внедрили соответственно здесь если меняется requirectxt или docker файл это самое важное на самом деле Потому что если изменяется код самого Дага он затрагивает один датсловно Вот а если меняется сам образ при этом внутри жестко прописана зависимость они должны быть описаны версии например чтобы автоматически ничего не обновлялось то могут быть конфликты например мы поменяли мы добавили библиотеку или поменяли версию сделали мэр У нас пошел дагов пошел и мы увидели что при добавлении этой версии библиотеки либо предопределена в библиотеке у нас какие-то перестали стартовать например написано было импорт йор Что значит что Flow попытался распасить Дак не у него не получилось и он свалился с ошибкой Обычно он при этом показывает Что за ошибка либо вообще образ не собрался что значит что лучше вообще не стоит просто трогать библиотеку нужно внимательно посмотреть что там внутри случилось Вот после того как это все сделано у нас получается создана фича окружения стабильно работающее то есть там уже точно все версии работают у нас нет падающих импортов соответственно мы можем просить обрув и соответственно автоматически это летит в брат синком в этом случае у нас меняется и код самого приложения и меняется код Если же вдруг что-то пошло не так у нас среды внезапно каким-то образом разошлись всегда можно откатиться Всем советую очень классная схема сейчас часть в которой буду рассказывать как все начиналось собственно первый вопрос который был пришли заказчики в лице аналитиков и сказали что вот у нас есть классный инструмент хотим сделать чтобы он был у всех из аналитиков один и тот же чтобы он был чтобы среда была одна и та же и чтобы на правде это не падало собственно правде на этой очень маленькой схеме которую в целом может любой повторить достаточно поднять на машинке уже будет работать то есть нужно будет работать он уже будет что-то делать деньги будут исполняться но будет пачка минусов которые мы устраним по ходу повествования вы видите используется запускает локально окружение отличается это не масштабируется надежном месте локалках с этим запросом пришли первое что мы сделали собственно я думаю что все так делают это посмотрели что у нас есть в данном случае у нас был cuber найтес был хелем под верфи 2 вот и собственно get love и первое что мы сделали это выбрали чарт было собственно два варианта с наименьшим затратами это официальный чарт мы выбрали комьюнити потому что он более свежий был на тот момент сейчас он более свежий и начали его прикручивать на это у нас ушло примерно два дня написание себя и запуск но естественно ничего больше нет кроме того запускается и запускается пользователи как ходили напрямую условно такие ходят создали пользаков все Connection они практически видели если не видели это очень могли посмотреть логирование в очень глубоко в минусе метрики только вернитесь плюс при падении ноды на которые находился подгресс умирал и соответственно все метаданные было очень плохо и после первого же падения гитлаба когда мы не смогли сделать что привело к инциденту мы добавили промежуточное звено в виде Бакета соответственно пошел сначала с бакетом промежуточным а потом уже сайфу если отказывает работать если отказывает airflow он рестартует благодаря Кубу и быстро начинает работать минусы здесь похитили самое увеличивается время между созданием запуском в рот там 300 секунд Примерно это заложено в самом можно уменьшить Но тогда получается на него следующий слайд это мы собственно вынесли подгресс наконец-то и радостно для того чтобы он не падал вместе с Лол чтобы он в любом случае не падал даже если у нас есть кластер Куба умрет либо если мы захотим перенести кластер Куба запустить в другом месте у нас всегда доступен почти Вот Но тем не менее Это нам очень сильно помогло всего лишь два инцидента и у нас отдельный Прогресс и отдельное видео для кода следующее что мы сделали планомерно приближаясь к тому что у нас есть это подключили елка но никак логин просто сборкой с Куба вот в какой-то из моментов мы подключили его как собственно ремонт Локс Для чего изначально мы закидывали на власти и в S3 есть такая опция что можно закидывать в S3 власти отлетала по Кубу вот минус такого решения в то что пока пока airflow не прекратит работу в данном случае тоска какая-то не закончит свою работу логия увидеть нереально для того чтобы их увидеть нужно дождаться выполнения таски что очень нехорошо Потому что нельзя контролировать этот процесс Например если вы запускаете на фичестрит что-то Да хотите посмотреть либо внезапно напротив это случилось вы узнаете результаты планетаски только после того как она завершилась в момент запуска посмотреть что происходит например час и вы узнаете что что же там было внутри только через час или совсем упадет После подключения ремонта в лице эластика мы получили почти задержка от того как что-то произошло какая-то строчка Лога написалась в тоске и отобразилась сократилась до 5 секунд То есть практически реального времени начала происходить хорошо Единственный минус что если у вас Коммунальная ластик может увеличиваться задержка если поэтому одна из действий которые мы сделаем поднимем следующим шагом свой отдельный ластик здесь добавилась грифана на самом деле она была давно достаточно она была изначально с в комплекте с кубом Вот Но здесь можно наконец-то принялись настраивать графики чтобы у нас статьи нормально работал чтобы у нас красивый график отрисовывались также настроили alerting графа молкол для того чтобы если у нас пропущенные хербит или еще что-то не городить свои пути или еще что-то отслеживать это все чисто по метрикам То есть например наступалер вдруг он нас один иногда их два иногда четыре Вот Но если что-то произошло пришла отбивка открылся или закрылся еще одним шагом мы добавили собственно он исполняется У нас две функции Первое это он поставляет секреты при запуске запускается секреты из и приложение раскатывается после старта приложения секрет собственно отрабатывает как хранилище Connection of все Канакина подтягиваются из него то есть Теперь они больше не хранятся в базе данных все обращения идут к болту еще одним шагом мы добавили для того чтобы не хранить локальные учетные записи пользователей чтобы не смотреть за ними снизить нагрузку на первую линию либо тех кто их заводит от этого решения тоже можно отказаться безусловно можно использовать своих пользователей если у вас нет но как все мы знаем это очень хорошая штука что пришел условный человек работал устроился аналитиком и вот у него уже в первый или второй день все доступа есть которые нужны Не надо бегать и запрашивать Это все можно сделать выводы из этого классный продукт его можно поднимать разными способами и для разных целей Привет сегодня вы увидели как еще услышали как мы его поднимали Вот наверное чуть позже можно будет показать все элементы которые практически все элементы которые были перечислены можно изменять вряд ли получится поднять примерно то же самое сразу всегда можно начать с чего-то одного большую часть того что я показалась компонентов можно написать самостоятельно условно например чтобы пользователи симкались или конечно но лучше конечно использовать то что было показано Наверное мне все Спасибо Илья большое доклад У меня просто сердечко ложится Я в трех компаниях столкнулся с тем что не делал Надеюсь другие все посмотрит доклад и таких вопросов больше не будет главный вопрос сходу который есть в чате И у меня тоже сильно волнует а сколько дагов а у нас сейчас примерно 6:30 в 4 из них по 600 на год примерно плюс-минус колеблется каждому или суммарно в каждом две с половиной тысячи по 600 на каждый ну где-то круто сожалению часть этого кода написано очень сильно вручную часть написана с использованием фабрики даков Наверное вы знаете что это такое Если нет то это максимально с использованием D5 в одном из случаев то есть оно хорошо масштабируется и управляется нет такого что для того чтобы вести одно изменение нужно пробежаться по сотни нагов Вот Но к сожалению это не везде генераторы стандарт и теле у вас еще дбт блин такую хайповое слово и рассказал круто Что за счет если вопросы в зале У меня просто тонна вопросов подскажите пожалуйста заявлено что-то про Кровавый интернет можете раскрыть summerf можно использовать как инсталляцию просто на коленочную словно на одной виртуалке Например Яндекс такой сейчас предлагает Но там нет ни наблюдаемости ни того чтобы это было доступно неудобно разрабатывать то есть в пройде это использовать не очень хорошо то что я показал это собственно то как продукт простой который сам по себе полезный но нет этого всего функционала он немножко есть но его нужно отрабатывать обрастает вот этими вот сервисами без них он используется Она кинула ты те или вас начал гоняется Так у нас есть парк У нас есть рок который Яндекса мы от него отказываемся Пользуясь чистого Спарта на текущий момент здесь есть ещё вопросы в зале Окей давайте пойду по вопросу в чате такой хороший вопрос У меня он тоже возник пишите ли вы тесты для дагов потому что по-хорошему ошибки импорта не должны доходить до диплоя вот здесь есть два пути но собственно фабрика дагов и тесты конкретные в сяо у нас используется стандартный линтеры для самого по этому кода и собственно фабрика дагов dax sdk у нас называется там соответственно есть уже готовые темплейты Они дорабатываются они поддерживаются если их использовать ошибка импорта не приходим то что я рассказал Это примерно три года эксплуатации соответственно с версии 1.02 и 2 5 плюс вот естественно будут ошибки импорта на тех дагах на тех версиях где не используется фабрика дагов это к сожалению Legacy мы тут ничего не поделаем Кроме того что переписывать на новую версию не пробовали просто момент вся сети пытаться отловить ошибки импорта Здесь есть маленький нюансик Вы знаете да как пишется точнее читается самим все что он видит со словом он пытается распасить и за ним платить Но если что-то лежит вне Дада и оно прибита гвоздями она никак не покажется до момента выполнения то есть РФ стартовал например посинкались он их все прочитал ошибок импорта Нет при попытке запуска Дага Да клеит за каким-то скриптом который отдельно лежит вот внутри этого скрипта есть обращение библиотеки которые нет и здесь мы ловим ошибку импорта ошибки импорта все-таки мы говорим про ошибки момент построения так бега немножко в runtime двинулся Да в рантами реальных Не запустив не отловить А вот на момент построения дакбега наверное его все-таки можно на построение потом идут вот обычно рассуждает про ошибки импорт имеется ввиду что на момент построение желающих нет Пойдемте дальше по чату зайду на этот вопрос немножко с другой стороны вопрос звучит сколько ваш дудеров и какая на них примерно нагрузка Я бы начал немножко со стороны первый вопрос собственно инфляции один Зачем У нас есть несколько дата-центров в каждом из дата центров один доллар как минимум один и и Поэтому собственно несколько То есть например у нас одна зона уехала или надо умерла или еще что-то абсолютно не важно у нас остается второй скатерть который спокойно продолжает работу то есть у нас нет недоступности в этот момент Хотя при этом что-то может лежать собственно несколько и да И какая на них нагрузка Как вы измеряете Ну с увеличением количества нагрузка на базу возрастает вот он появляется Локи и так далее Вот суммарно вы смотрите как у вас себя чувствует что ли Как они создают нагрузку на базу как они сами себя чувствуют Да но после этого по операционке по тому как загружаться У нас не было такого что именно отказывает ни разу если мы видим что он начинает заработать у нас база уже достаточно мощная чтобы не нуждаться еще есть который все Лично у нас совсем немного времени здесь остается даже мы перейдем дискуссию поэтому сейчас или никогда если вопрос из зала вот дальше будут дискуссионной зоне последний вопрос но он звучит пробовали вы сэллоры плюс кабинет за компьютера Я бы задал его немножко по-другому какой тип экзаменатора вы используете и почему именно его мы используем потому что у нас есть Если бы у нас компании его не было мы бы скорее всего использовали selary чистый без потому что он более хорош для выполнения множества мелких тасок А большинство тасок именно использование это мелкие таски есть можно одновременно это не пробовали Нет мы его еще не пробовали но Будем пробовать в контенте потому что у них больше всего такого запроса Угу Отлично Да Кстати классный момент что sele rextuder есть очень сильно уменьшает оверхед На старт таски потому что конечно запустить под это еще большой вопрос Сколько еще себе сколько остасок читали Сколько суммарно времени На старт уходит для того чтобы пробежал в сутки собственно тогда вопрос у меня ближе к этому Вот я увидел что Стас D используется экспортер стандартный Хватает ли вам этих метрик На текущий момент пока не писали собственно все что можно загнать в код питона загоняется в код питона пишутся библиотеки метрики тоже частично оттуда забирается как только дойдет мы все что делаем мы делаем эволюционно надо сделали обычно вешают всякие вещи типа starwation плов время задержки шадулинга в том числе падение Даров падение дагов на это завязано или Как так у нас есть exporter она собственно У нас есть Прометей который смотрит комиссию смотрит за тем что у нас происходит и соответственно это все талерта Например если у нас хербит пропал либо у нас начали массово сыпаться либо на что-то еще случилось у нас на это есть альты которые присылаются и соответственно отслеживаются нападение конкретных дагов у нас такие отделены на группы если это критичные то Альбер срабатывает по два прилетает в мотор мост собственно время когда он упал кто собственно этого Дага и что нужно делать если такая инструкция есть Если нет призываются люди у вас это круто устроено очень понравилось что графон Используйте его делали русские ребята Вот мои одноклассники в жизни вижу что кто-то использует продаж очень хорошо собственно у нас осталось одна минутка Все кто в онлайне у вас будет еще опрос Пройдите пожалуйста про доклад очень интересно слушать все кто хотят еще с нами пообщаться со мной чуть-чуть Давайте Спасибо большое"
}