{
  "video_id": "nQd209e9eCY",
  "channel": "DevOops_conf",
  "title": "Виктор Гамов — Два с половиной дата-центра (и Кафка)",
  "views": 1343,
  "duration": 4177,
  "published": "2020-11-20T04:54:55-08:00",
  "text": "ну что ж ну что ж спасибо спасибо за за представление и давайте уже начнем добро пожаловать собственно в мою студию поехали поговорим про интересные вещи сегодня значит пожалуйста слайды домой проектор наверное работает в эту то что вы сейчас должны видеть на экране все должно быть замечательным на самом деле нет у нас никаких проекторов так как у нас все на удалён очки поэтому будем надеяться что скажет шиллинг работает и и все у нас хорошо сегодня сегодня я здесь с вами чтобы поговорить про такую интересную тему для меня я надеюсь она будет интересна тема для многих так получается и возможно даже многие уже пытались сделать что-то подобное или там интересовались этим вопросом есть много ну собственно каких-то там презентаций на эту тему на эту тему на то есть сейчас у чуть подлиннее и 1 признаться которой есть много разных аспектов называется на 20 план дата центра напишите мне в чате если вы поняли иллюзию поняли откуда reference и представляете о чем о чем разговаривать я меня уже немножко представили на самом деле те кто меня не знает могут меня узнать у нас есть телеграме есть такой чатик про кафка и а сам кафка это те вы можете плетей по задавать такие вопросы интересные я вообще в твиттере бывает много приходите ко мне в twitter пишите стал недавно делать лайв-стримы для тех кто интересуется кафка и прочим стрим про сынги там они только operations там еще и разработка и много интересных таких вопросов которые каким-то образом связаны с кафкой значит я хочу сказать опять же был слова благодарности одному из моих коллег он что-то подобное уже когда-то рассказывал но на самом деле здесь в этом докладе объединен опыт работы группы который называется похож на сервисе сейчас онлайн как другом называется но смысл один да то есть это у нас есть коллектив людей которые работают с нашими клиентами решают их проблемы непосредственно у них и и и вот вот этот доклад был создан по результатам от наших встреч с клиентами значит для начала давайте такой водный что вообще пытаемся сделать что вообще происходит и зачем это нам нужно вообще значит он представляет собой кафка для приложения здесь мы будем уделять чуть меньше времени именно разработки приложений и больше во время говорить о том как концептуально вещи будут взаимодействовать поэтому вы давайте вот я чуть-чуть небольшую водную сделаю да то есть здесь она представляет кафку как какой-то какую-то очередь например да но это зачастую но не знаю наверно процентов 50 как люди используют кафку на сегодня что всем если используется как очередь распределенное просто лень часто что поговорим но на самом деле с приложением нам нужна одна система ведет какую то обработку например она принимает майках сервис принимает заказы с одной стороны и потом эти заказы отправляются на на в другую систему там например для fulfillment а например для этом оплаты например поэтому нас есть 2 микро-микро сервиса здесь один микро сервис например вот вот этот вот то например где у нас тут вот такой вот здесь вот он например делает нам какую-нибудь обработку заказов и отправляет их на на оплату там другой микро сервисном здесь там распечатку ордером делать но смысл то есть что они делал без разницы но они могут и так это микро сервисы мы не всегда имеем контроль и где тут с дипломной особенность у нас большая организация есть различные сервисы которые читают данные там в одном месте поэтому здесь мы сейчас пока об этом не говорим но в этом мы не коснемся им или через пару слоев значит если мы посмотрим на этот чуть чуть больше с больше высоты с высоты именно как данные распределяются внутри кафки вот этот 1 топик да вот этот один топик сос ордерами он на самом деле это логическое представление когда ваше приложение работает с ним туда пишется или тут читается это все логическое представление и на практике выглядят приблизить ему так топике состоят из они некоторые числа по парте шинах и эти партии шины собственно размазаны по различным по различным машинам брокером который собственно вставляет классных класс старков key в например способ для чего это делается на примеру в кафки таким образом решается задача такой параллелизма выполнения или обработки каких заказов то есть если вот здесь посмотреть сейчас на вот есть система которую мы вначале говори например вот эта система y будет заниматься тем чтобы отправлять собственно заказана fulfillment а точно уже на отправку чтобы они уходили она может быть радуется тоже как бы как распределена тоже заказов много и и есть возможность запустить и в несколько потоков а есть система как отделать какой такой простенький port где не надо запускать в каком-то определенном режиме поэтому она все все эти сообщения из этого топика она попадает в одну эту систему поэтому здесь может быть несколько контейнеров которые могут потреблять данные сразу пар тишина таким образом увеличить например там скорости обработки этого всего дела как происходит запись то есть кафка известно что система достаточно как сказать рилай балда то есть она достаточно надежная и надежность в системе в системе кафка определяется некоторыми интересными архитектурным решениям которым сейчас вот с вами посмотрим то есть дать для начала поглядим охоты как работает продюсер продюсер это приложение это которое внутри себя содержит клиента кафки которая работает по кавказскому протоколу и есть такая вот часть взаимодействия когда мы пишем что-то и получаем какой так но там есть несколько видов окно нажмет некоторые несколько видов подтверждения получи полученные доставки значит наш продюсер может отправить сообщение и не дожидаться доставки наш продюсер может отправить сообщение и дождаться доставки только с 1-го пар тишина об этом практически сейчас и чуть-чуть расскажу немножко больше или например а вот давай сейчас как раз расскажу есть два типа вот этих пар тишина в которых мы вот здесь вот говорит есть потише 0 1 2 и 3 в данном случае вот в этой упрощенной схеме мы говорим только о протяжении который называется лидер работа основная модель consistent насти в кафки построен на том что в продюсеры и консьюмер и работают с одним с одним и тем же по парте шинам продюсер пишет данные в лидера и консьюмер читать данные из лидера это делается для того чтобы обеспечить вот этот консистентной и не особо не надо было задумываться о таких вещах как там когда консьюмер увидите данные то есть такой чтобы не было вот то что называется и венчал concise на себя только consistency здесь более строк как только записались данные то они сразу увидеть будет виден видно консьюмер теперь давайте чуть чуть поговорим о том как вот собственно что значит записались данные окно наш бренд я как рассказал можно не ждать никакого подтверждения то есть отправил за был второй виток менеджмент это когда подтвердились лидера лидер записалась и тогда брокер отвечает что я записал все можешь продолжать есть третий тип окно живут и когда мы получаем ответ от всех реплик которые входят там специальный набор который называется nissin крепло когда то есть реплики которые потенциально могут если произойдет какой-то сбой взять свою все взять свои руки и собственно значится лидером если одна из нот упадет давайте еще немножко углубимся если мы чуть-чуть немножко углубимся нато да даже вот вот эту часть которая называется стоит то есть в моем углубимся вот вот сюда где мы хотим мы записываемся что значит записалась до кафка интересная система и одна из особенностей этой системы заключается в том что вот эта производительность и например низкие требования к как типу например да . вк она не сильно требовательна к java hepu когда происходит запись а но там требует памяти связано с тем что применяется такой подход который называется за ее рукой и что он делает это когда сообщение приходит не сетевого соки то это сообщение не те дни здесь реализуется ничего с ним не происходит она авто начинается стремится сразу на диск но он сразу на диск не попадается по причине того что обычно относительно других операций которые могут происходить в этой системе запись на диск обычно самая медленная поэтому придумали всякие буферы и пачки ши и так далее там подобное чтобы момент записи непосредственно на диск отсрочек как можно дольше поэтому из операционной системы операционных систем есть почтишь соответственно когда сообщение подлетает из-за китае попадают в этот почтишь в принципе тогда у нас наше приложение контроль и дальше все дело принимает на себя операционной система и эти вещи там пробрасываю ца уже непосредственно файл то есть php зависит от количества аренда от количества оперативной памяти и например на каких машинах лучше иметь там больше оперативной памяти чем чем чем выделять эту память для hippo например да поэтому здесь будет такой вот ход значит не-не-не-не мне одной но до единой да то есть у нас есть ситуации в которых да да не ситуация кафка это распределенная система если мы пишем в одно место то не факт что это место нам эти данные сохрани и поэтому нам нужно иметь возможность сохранять еще где-то в сети поэтому есть еще этот подход который позволяет данные реплицирует и соответственно берется наш наш лидер в нашей партиции куда мы записываем наши дома мы записываем их в лидером из лидеров они будут другими репликами которые следят за лидером будут подтягивать к себе то есть есть специальный запрос который реплики выполняют на на лидере и забирают эти данные к себе и после этого как только там все запишется мы можем уже сказать не но мы гуляем спокойно в данном случае если вот мы посмотрим сюда есть такой вот пункте как он называется окно лишь пол что он означает что окно лишь момент на нашего продюсер вернется только когда вот этот весь полный цикл записи запишется на диск потом реплики все это дело под гребут и они отправят ответ что действительно мы все получили и только тогда только тогда нам нам нам скажут что типа все продюсер давать следующие значит этот процесс представляется внутри этого естественно синхронный процесс к то есть там не не то чтобы прям плачет все внутри кафки работа это следующим образом есть несколько различных очередей внутри есть очередь в котором все эти request и получаются есть специальные потоки которые занимаются непосредственно тем что обрабатывать только направо сетевую активность или там активность связана с диском есть специальную область памяти которая называется про который из которой собственно реплики забирают наши вещи к себе и дальше после того как это подготовить у нас собственно мы знаем что у нас все забралась отправляем обратно в испанский где наш сетевой поток отправляет response назад нашего продюсера если вот вернуться сюда да и чуть-чуть вот посмотреть наверное сейчас еще раз вернуться сюда и посмотреть конкретно на от части которая связана с датчика это дело все мы это делаем это чаще связано с собственно записи и когда вот это так ночью посылать сейчас мы чуть-чуть немножко углубимся в вот сюда как продюсер как консьюмер узнает что данные собственно готовы для потребления то есть когда у нас проходит у каждого топика есть такой так называемой сетка то называть меня и ссор минимальное количество in sink реплик вот эти реплики которые должны отправить response они входят вот этот набор минимальных in sink реплик важно понимать почему они такие собственно важный окно чем-то не получите для того чтобы обеспечить высокую степень сохранности данных айди врубилась то что называется и соответственно чтобы чтобы все чтобы мы бы знали спокойно что наши реплики спокойно нормально да получены должна быть определена какая-то вот средний . тут ватерлинии до которая определяет где что у нас вот asset этот определяет позицию где все реплики находятся в в сохраненном состоянии как только все реплики подтверждают что да они действительно нормально себе записали вот этот high water марка в сад он поднимается то есть понятно что некоторые реплики например если мы в лидера записали а дальше мы не смогли записать в какую-нить инстинкт реплику то в данные могут быть как бы не до распределены или например мы записали в лидера они не успели дали полироваться лидер упал и тогда одна из реплику которой кругу рубля больше всего данных и в зависимости от того где находится наш этот хайло товар станет она текущем лидером это такая ситуация где например мы можем там потерять какие-то данные если мы неправильно к сконфигурировали наш вот ну окно любит механизму наши в системе то есть х и watermark определяет собственно где наши данные успешно записано опять же не забывайте а не забывайте писать в чате если у вас есть какие то вопросы чатик мониторится мы будем смотреть и обсуждать эти вопросы ну собственно после после доклада я сейчас не могу туда смотреть но вы пишете потому что есть люди особо обученные которые за этим всем смотрят и которые потом эти вопросы мне предатель передадут ok поехали дальше распределение этих партнеров как он определяется но в принципе в принципе она определяется достаточно рандомно да то есть мы когда создаю есть определенное количество а брокеров у нас который находится там здоровом состоянии мы запускаем команду создать топик определяем количество реплик мы определяем количество пар тишина и дальше уже кафка начинаешь ушате определять какие из но то будут принимать себя лидера какой износ будет принимать себе какие снос будут принимать себе вот этих фоловеров до пола пирса есть лидеры есть фолловеры да и работает следующим образом приблизительно вот так у нас происходит распределение когда мы отправляем отправляем сообщения когда мы создаём топик ссоре и что вот в этом случае нам дает мы должны понимать что вот в этот вот в этот самый момент у нас продюсер должен иметь подключение ко всем нотам на которых есть наши лидеры это такая небольшая упрощенная схема но это также работает если продюсер нужно писать другой топик так далее продюсер пишет всегда в лидера это это очень важно и поэтому продюсер должен иметь иметь подключение к остальным к остальным брокером также значит что происходит в нашем в нашем случае если у нас одна из нот падает если одна из нот падает у нас а какая-то из реплик начинает принимать на себя обязанности лидера если вот на про давайте посмотрим вот у нас например полно до лидер который находился на ноги один вот этот лидер имеет реплику на ноги 2 и на ноги 3 соответственно когда мы одна из нот убилась фолловер из пуловер из нот и 2 приняла себя обязанности лидера то есть он дальше подключился и продолжить работы опять же есть хорошо описаны протокол как это происходит я сейчас не буду в это углубляться как происходит выбирает во лидеры так далее тому подобное есть определенные правила есть определенная конфигурация который позволяет немножечко чуть-чуть вот подключить к х у нас там слова для есть до русского трутень таким не знаю ну что подкрутить да то есть но вы поняли мы об этом поговорим это тоже очень сильно влияет на на консистентной данных и собственно в дальнейшем как у грамм выбираем consistency availability так далее я уже потратил 20 минут рассказывая про вот эти внутри жки кафки но ни разу еще не сказал слова звуки пир и никто меня в чате не поправил наверно сейчас сейчас будем смотреть значит закипел и это такая база данных тоже который кафка использовать для того чтобы хранить определённую metadata и в частности вот процесс выбора лидеров для определенных партий шихён тоже каким-то образом хранится в зуке перри все меньше и меньше много метода ты выходит сейчас на хранится внутри контроллера который это одна нотка вко брокера который может делать всякие административные штуки но на самом деле звуки пир тоже носит важную важной составляющей вот это все вот этой всей схемы значит звуки пир тоже работает по принципам распределенных систем и тоже нужно определенное количество но дату закипел чтобы обеспечить отказоустойчивость и чтобы вот этот механизм вот этот в сторонней арбитру мог нормально да сдавать нам консенсус нам нам важно чтобы он тоже оставался здоровым поэтому в данном докладе у нас пир тоже будет учитываться очень много хотя сейчас ведется много работы для того чтобы сделать такой а сама чтобы к буковке консенсус был ну как бы связан чтоб кафка само собой рулила своим консенсусом но все равно сейчас мы от этого не уходим и но ближайшие ну точно до конца года точно ничего такого не произойдет теперь пока остается но кому интересно ки 500 это вот наше все там читаем а изучаем если такое значит вот в данной картинке мы пришли appstore и мы пришли от вот вот такого да то есть пришли от вида системы как мы видит приложение это к системе как например наш администратор вот эту систему все видит есть у нас system x которая продюсер данные в наш кластер мы будем работать вот именно вот в этом вот в этом вот в этом самом ключе дальше у нас есть брокеры у нас есть звуки пиры у нас есть определенные системы которые все это дело подключает значит вот здесь я немножечко начал говорить про про репликацию и в данном случае мы сейчас немножко углубимся и поговорим про альпика цию более более в деталях и начнем мы отговорить репликацию в деталях начнем с самого такого у самого простого наверно способа который мы называем способ 3 дата центра давайте я сейчас сделаю небольшую паузу и чуть-чуть немножечко с вами поговорю о том вообще зачем все это нужно перед тем как я буду углубляться в дата-центры прочее прочее да зачем это вообще нужно и и и и как и почему по понятным причинам я надеюсь что для многих инженеров которые работают с со железной составляющей по понятным причинам мы хотим обеспечить отказоустойчивость наша система которая никаким образом не связано с нашими программными частям есть вещи которые программы не управляет есть электричество есть животные есть дикие животные есть домашние животные есть человеческий фактор да то есть не когда мы не забываем анекдот про то что про уборщицу которая постоянно отключала наш наш компьютер в бородатые времена если вы поняли эту шутку значит вы уже такой же старый как я на самом деле не надо далеко ходить не надо вспоминать уборщица можно вспомнить пару лет назад как трактор въехал в дотан центр амазона и из-за этого там восточный восточник это было вершени где-то восточный регион по моему лёха из за того что там в питании отвалилась и и пошло такая каскадная под падение также также есть есть данные я сейчас не помню этот веб-сайт надо бы поискать данные которые показывают нас насколько белки вредят нашим дата-центрам там электричество что такое поэтому это важно один дата-центр например это не является там спасением для все или например вот мы любим говорить об этом вот многие финансовые компании и даже представить себе не могли что что-то может произойти на манхэттане поэтому они держали свои дата-центры очень близко к фондовой бирже да то есть они это все делал на манхэттене и их дата-центр тоже находиться манхэттане но случился nine eleven начали падать самолеты и падать дома и оказалось что нету вот этой возможности быстро опере поднять инфраструктур поэтому стали строиться дата-центры за рекой до через через речку в нью-джерси через речку гудзон которая пока либо обеспечивать отказоустойчивость в таких вот ситуациях когда у нас как это называется де завтра а как у нас сказать по-английски деза star ну плохо когда и и им и в общем необходимость или объяснять людям необходимость запускать несколько дата-центров она как бы от пола люди сами это начали понимать интересное интересная такая тоже особенность что есть ваш доценту полетели на бомбу вас принципе будет чуть например больше проблем и меньше надо беспокоиться о кафке но на пронести трактор ваш дата-центр попадает и подключается там вода и электричество дата здесь что-то что-то важное произошло почему сразу это центов начинаем ну во первых это красиво да как он мы знаем эта знаменитая знаменитую шутку почему заселяемся начнём с самого простого почему три да потому что как бы 4 это много а два не достаточно известная известная шуткой мы знаем что в нечетном количестве вещей всегда есть определенная такая избыточность которая позволяет нам обеспечить там копирование этих данных соответственно мы сейчас говорим про один кластер и внутри кафки есть очень нехороший давно работающий механизм аппликации внутри кластера что здесь происходит мы берем 3 дата центра с хорошей сетью мы об этом сейчас немножко поговорим с хорошей сетью и запускаем наш класс вот такая вот минимальная конфигурация у нас будет вот в вот в этом 3 дата центра включаем 4 но тыковки которые позволяют нам выживать при падении каждого из дата-центра чтобы копии где-то оставались из окна звуки пир наш будет запущен пану по надежду кипер а вот этого нашего лизу кипрского ансамбля будет запущена в каждом доцент это такие minimal очки а более того кафка имеет себе возможность определять положение этих реплик чтобы например какие-то копии данных не клались в один дата-центр да поэтому есть такое понятие которое называется рак у эрнеста так сказать осознание стойки до понятие о том что стойка существует и мы можем что-то там хранить вдруг в другом месте как это работает когда создается топик определяется такой параметр который называется брокер до трек это в конфигурации идет о вашей ваш как равка брокера и в нашем случае мы например по трекам определяем дата-центр это может быть регион это может быть давала белый бизон то есть как вам нравится все зависит от того какая у вас конвенция вот это определение или там договоренность о том как вещи нужно называть и дальше все реплики раскладываются особым образом из из все вот этого происходящего мы можем понимать что лидеры могут храниться где угодно и все это замечательно и все это хорошо и вот такая вот сладкая жизнь нас ждет если посмотрите как один из докладов помогут же поинты был доклад ребят из контура они рассказывали как раз в этом году был доклад про как они оптимизировали продюсеры они сказали у них там топология 3 дата центра 1818 нот и 6 нот в каждом дата-центре ну то есть они как богаты и состоятельны ребята они могут позволить все три дата-центра с таким количеством но то есть они все делают правильно да то есть они понимают что даже два трактора если въедут в принципе еще могут просуществовать некоторое время давайте поговорим немножечко какие вещи должны быть необходимыми и достаточными например сколько вам еще денег стоит для многих к организации который на протянул свои кабеля тянут свои провода это например не очень является большим-большим вопросом потому что эта стоимость у них заложено уже в когда они тянули этой теперь они просто там платят за электричество какая задержка между этими дата серверами опять же если вы используете какой-то там общедоступную сеть вместо того чтобы использовать какой-то там частную сеть вам нужно понимать какую задержку ваш провайдер вас обеспечивает тридцать тридцать миль почему 30 миллисекунд ну можно и больше вот меня тоже часто спрашивают часто иногда меня спрашивают а вот здесь и 3535 тоже хорошо а если 40 в принципе тоже потянет проблема да вот эта булатность и заключается в том что должно быть как бы меньше количество нулей десятки миллисекунд терпимо потому что есть некоторые параметры которые можно починить который как бы немножечко обеспечит вам если вы например перестраиваете к вкус именно с целью того чтобы обеспечить вот этот вот отказоустойчивость вам не для скорости до поэтому вы можете где-то и тайм-аут и подтянуть и так далее то есть можно но есть вас лайтман ситом на полсекунды то уже в ну собственно надо задуматься она нужна ли вам эта я об этом поговорю чуть чуть чуть чуть в будущем есть еще у меня для вас пару интересных решений значит смотрим вот как раз желательно чтобы это 10 20 30 40 миллисекунд это эта эмпирическая эта эмпирическая вещь которая работает с конфигурацией кафки из коробки это что мы видели с определенными с некоторыми клиентами дальше возможность вопрос такой вот у вас есть несколько центов а какая у вас степень владения всем этим да то есть если кто то или какая-то другая система которая должна работать тоже также отказоустойчивого должна работать там все все нормально без без каких-либо проблем который тоже может потенциально есть сеть то есть есть там правку там сажайте на тоже сетевой интерфейс цель там на тоже switch с базы данных которые там постоянно читается обновляется ваша ваша складская база данных например то есть всегда есть вопросы кто может или даже на бородку например кафка может вашей базе данных тома под сетью немножечко папа подшутить над то есть вы должны это понимать что это эти вещи тоже должны учитываться самый простой способ этом это все таки наверное сделать опер да то есть между вашими местами где вы будете запускать кафку не используется pink для того что проверять плотность используя опер или какие то другие тулы которые например там может быть некоторые вендоры предоставляют и померить и померить и у нас потому что например вы можете думать 1-ого 6 вы администратор и устроив другой например есть определенные любители настраивать kyon ki as длина на на наносить их например там могут вам копать ваш ben david вы думаете что у вас есть там 100 мегабит кабель а на самом деле они режут вас у вас есть пять мегабит всего поэтому эти вещи тоже нужно проверять и перед тем как деплоить его лицу кафка не тяни то проверьте сеть сеть 1 причина из-за чего все ломается это распределенная система сеть более важно чем чем диски память это такое сердце ну и собственно вы должны понимать где может поломаться следующий момент мы сейчас говорили про инфраструктуру мы за тепло или все эти дела а где наше предложение это бегут то есть у нас есть дата центры где наша кавказа диплом а куда и что делается с нашими собственно с темами которые пишут давайте посмотрим у нас есть система x которая пишет в лидера который в дата-центре один нос и самой системой тепло и на в data center 2 например а система которые читают там тоже размазанные is docent r2 datacenter 3 соответственно получается такие вот интересная такая интересная ситуация и эта ситуация на самом деле не не что-то такое выдумано или что то такое вот из ряда вон это вот ситуации которая реально столкнетесь когда вы будете диплом эти вот в таком в таком распределенном режиме через несколько дата-центров много вещей может пойти не так и важно еще понимать там кто платит за сети сколько вы платите за кросс одессе трафик да если вы в claude особенно это важно понимать смотреть был по моему в прошлом году сан-франциско кафка саммит был доклад от ребят из сигналы форекс они рассказывали это ещё когда нам люди у них был за главное они рассказывали как они на самом деле пытались экономить на кросс диси трафике то что это очень много денег уходило как они оптимизировали эту жизнь а внутри их кафка кластера найдите доклад по а посмотрите это очень тоже интересно значит для тех кто хочет ну хотя прикинуть дату тип сказать виктор а вот ну хорошо вот вот в этом сетапе сколько это может нам стоить и какие вещи как уже леску нам надо ставить какие машинки надо поднимать какую сеть вот мой коллега джейкоб он как раз разработал то кофе такую программу но на самом деле это не программа это xl xs просчет вы пойдете то посмотрите он позволит вам посмотреть на важные параметры какие вы количество реплика количество данных которые вы хотите в день прокачивать и таким образом вы сможете понять приблизительно сколько сколько это будет выливаться вам но и давайте вернемся быстренько к нашим от к нашим этим системам вот в частности нас интересует теперь наша облигационная часть на наше предложение то есть вы видите здесь есть и какие-то такие возможности для маневра да есть возможности для того чтобы оптимизировать например вот здесь вот да и вот здесь вот каким то образом оптимизировать нашу систему давайте посмотрим что кафка для нас представляет по-моему в как и 24 или в 23 появилась возможность которая называется тип 392 это возможность ксю миром получать данные или указывать реплику скотов консьюмер может получать данных это на самом деле очень крутая возможность который позволяет делать много интересных вещей мы знаете уже что сегодня об этом уже поэтому вы знаете об этом вы знаете что сего что брудно брокере можно определить рег да и таким образом мы можем понимать где находятся наши реплики где находится наш лидер где находятся наши фолловеры так далее теперь же на клиентском конфиге мы тоже можем определить мы тоже можем определить вот этот трек 1 и сказать что в принципе it's ok что вы можете читать с определенным рег но нужно еще настроить такую настройку на брокеры который позволяет нам выбирать когда нам подключается консьюмер он должен знать откуда ему качать да то есть и он соответственно будет отдавать эту реплику в зависимости от того с какого века вы пришли то есть это такая вот так это выглядит и пи ай да то есть и для для типа который позволяет забирать непосредственно реплику близкую к вам таким образом система будет выглядеть следующим образом таким образом у нас таким образом всем воду ну понимаете то есть соответственно мы обеспечиваем для наших реплик вот на этот вот этих локальную реплику вы можете спросить как эти бы обстоит дело с концы снасти виктор искать если дело обстоит очень хорошо все радиуса пишет в лидера не зависимости от того где он находится да ну например на солдата центр здесь здесь вы пока ничего не сделаете с этим продюсер пишет по другим условиям он пишет по условиям он пишется еда в лидера и он всегда пишет то в зависимости от ключа и так далее там подобное значит распределение у продюсера у нашего стоит окно нажмитe all соответственно он будет считать что данные записаны только тогда когда вот эти реплики будут in sink до соответственно когда продюсер получишь так 0 момент в хай watermark поднимется и соответственно для вот этих двух систем данные будут консистентной то есть все все остается нормальным и никакую consistent ность здесь не ломаем мы просто обеспечиваем локальный локальный трафик для вот этих вот вещей напишите мне в комментариях напишите в чате или в твиттере кстати важный важный момент пишите в twitter twitter описано вот здесь вот до тех кто не знает за половки меня я очень интересный человек кей поехали теперь поговорим про проговорим про другой подругой аспект 2 дата центра да то есть мы начали 3 можно ли сэкономить убрав вот это центры ситуация будет обстоять вот следующим образом у нас значит у нас есть определенное количество брокеров которые в одном ядром дата-центре и есть звуки пир который тоже должен должен каким-то образом запускаться даже теперь это наше наше все и без него ничего работать не будет да какие проблемы естественно закипел и естественно репликация давайте сначала поговорим про проблему за кипер как мы дипломе накипи руки перди плавится таким вот ансамблем с нечётным количеством нот и при падении дата-центра может произойти две вещи одна вещь если падает меньше дата-центр смещу конечно за кипер ничего не происходит у нас до сих пор удастся поддержать наш консенсус сервер в нормальном состоянии и все будет хорошо в двух звуки перов хватит чтобы поддерживать в рабочем состоянии наш ансамбль а вот если большой падает то тут начинаются проблемы то есть тут начинать проблемы что у выкипит начинается проблем более того здесь вместе с кафкой еще звуки преподнеся верность звуки первую кафка падает там тоже проблем начинается вам еще кафка еще не сможет очухаться до сих пор показу теперь не сможет подняться поэтому эта ситуация считается не очень хороший в принципе вы можете жить с этим я не тот человек который будет иметь занята и так далее или там говорить вещи да но вот есть что есть в текущем в текущей вот такую стандартной конфигурации это не очень хороший день делать вот так давайте посмотрим что с этим можно сделать вот во всей вот этой ситуации оказалась оказалось что есть такая возможность в закипели которая такая ну а надо задокументирована присутствует она работает но мало кто ее пользу мало кто еще знает называется географических форум да который позволяет внутри своего дата-центра как бы определить маленький такой кворум который будет размазан по текущем нодом нашего там ансамблю да то есть мы например запускаем чуть больше звуки перов в одном дата-центре и за счет этого мы там обеспечиваем локальный корм соответственно значит ну вот такая конфигурация которая позволяет нам один из членов нашего дата-центра там может падать и из этого ничего страшного не происходит но требует значит теоретический корм все равно требует небольшого ручного вмешательства значит когда у нас падает это центр клиенты у нас не увидит и не чего то что было в том дата-центре то логично и может быть продюсер когда мы пишем продюсером может быть тоже его запись может быть запись тоже блокировано да то есть соответственно нужно будет руками лезть подкручивать говорите что тип лакей нас там более ослабленные рекламистам убирать изменить сам только фигура столбик и так далее там подобное ну так такой себе да то есть она обеспечивает определенную гибкость но требует более многих прыжков и вот этих жонглированием вот этим всем и требуется до обычно ручное ручное внедрение как то есть что именно требуется вот и про табличка которая позволяет вам посмотреть два режима как раз в режиме 2 дата-центров которая позволяет вам выбрать одно решение напротив другого то есть мы можем выбрать либо ставить consistency то есть мы предложение наши будут недоступны то есть они смогут записывать в какой-то момент но или например можно сделать в данный ссоре вначале мы делаем consist насиловали beauty до 3 соответственно мы данные с данными будет всё нормально и все там будет понятно что дата данные будут реплицировали даты будут все нормально но если произойдет сбой нужно что вы топике то перри конфигурируется провели уменьшить количество in sink реплик и так далее там подобные есть овал и белый террор к естественности значит что она себя позволяет в этом случае никакая реконфигурация не нужно но может возникнуть ситуация когда данные о могут потеряться то есть помните вот эту историю опять же сухо и watermark есть некоторые реплики которые могут могут стать лидером только при условии что вот на правда там clearly делал экшн у них выбрано то есть у них может быть недостаточно данных то есть и хай watermark не не не там не не поднялся либо либо что-то но они как бы есть какие то данные то ли вам нужно продолжать работать соответственно если в лидера записали лидер отвалился какая-то из реплика должна приниматься теперь за лидера а у нее еще до нее репликации не дошла до то есть мы потому что он лидер отвалился с не больше не забрали поэтому еще стоит анкер лидер локшин соответственно нету такого правила которая заплатила бы это реплики стать лидером она становится лидером хати хати данные потерялись а потому что количество нот в данном случае там rp кеш факт 4 начнут должно быть больше чем 4 там 6 да и в этом случае еще требуется вот-вот хитрой настройки очень такая мутная система и чтобы поиграться вот совсем вот этим другой коллега lemmings полина из из европы из из нашей professional services сделал этот проекте который называется кафку бум бум где вы можете со всей жестокостью который вы можете применить докер контейнером крошить aquastar и смотреть что происходит с вашими данными вот это вот такая вот там много таких вот есть интересных ходов и собственно они вот когда работали для одного клиента у нас у этого клиента было много интересных а требований которые необходимо было бы он собственно реализовать во всем вот это руки собственно это приводит нас к собственно теме сегодняшнего доклада да то есть два с половиной дата центра и как это все живет и почему два центра значит есть ситуации в которых у вас есть в офисе может ли важно при в офисе в бухгалтерии есть компьютер очень важный компьютер бухгалтерии потому что на нем считать зарплата на нем 3-ю пьеса висят но кроме excel и один с кино нем ничего не запускается поэтому вы на нем устанавливаете зуки пера он постоянно там бежит и он работает то что называется тай брейке то есть он является таким полу дата-центров кафка там не бежит ничего не бежит но случай конфликтов если один дата-центров у падает у вас остается ли ситуация в которой другой дата центр работает консенсус сохраняются потому что у вас все равно есть две ноты в ансамбле и самое главное во всем этом что не требуется никакой перри конфигурации они приложение нет никакой ничего не требуется делать с вашей стороны то есть это такая вот достаточно ну не то чтобы простая но достаточно доступная система доступная конфигурации которые люди могут использовать и особо как бы не задумываться что что происходит вот собственно собственно вот так это все выглядит нужно иметь как бы один такой с hyper ситуация должна немножечко измениться в будущем ситуация должна немножко изменится в будущем когда звуки пир собственно уйдет наверно но сейчас это выглядит вот таким образом вы можете меня спросить о кей видео-вопрос тебе а что делать если да а что делать если у нас есть два цента и даже может 3 дата центра но у нас сетка очень такая медленная да у нас есть мы через океан гоняем даны мы не можем растянуть кластер на через океаны что мы можем что мы можем затем сделать и как как мы с этим живем и тут нам на помощь приходит другой подход который обеспечивает нам защиту при сбое в которые называются зеркалирование зеркалирование заключается в следующем вам это практически два разных кластера у которых у которых нет достаточно рилай был канала между ними там например множество различных конфигураций может это будет может быть как ситуация когда у вас есть региональный и центральный дата-центр или может быть например есть какие-то такие с элитные системы например есть у нас клиенту которых класса кафки установим на кораблях и кукольник приходит в порт они должны данной принести и собственно да то есть вы понимаете что данные не должны теряться и но и мир не должен останавливаться по всему присмотритесь теперь реконфигурации они как бы не должны быть понятное дело использую два разных кластера то есть это уже не один кластер и я даже два совершенно разных кластера репликацию асинхронная обычно есть баги рекс надо есть такого обе стороны которой работает но в основном в основном ситуация это для вот этих односторонних и оно используется в там в различных конфигурациях как это выглядит есть система которая называется мира maker это встроенная в apache и кафку система которая просто делают копию одной системы в другую и собственно все то есть вот вот вот так вот и все как как жить в такой в такой ситуации есть есть некоторые нюансы да то есть если вы что-то можете сделать не за не обязательно что вы должны это делать например как у нас отличить данные снова в дата-центров другого то есть такой подход называется локейшн префиксы топик да то есть когда вода топика определяете откуда данные пришли во всякой в такой ситуации этот это это не актив актив хотя она достаточно актив в систему вас могут по обеим сторонам ваше приложение одинаково хорошо слышать это такой добыл basic я бы сказал да с одной стороны у вас есть приложение которые пишут читают с другой стороны у вас тоже есть поражение который пишет читают но например данную не каким-то не пересекаются или там нет возможности установить откуда там данные пришли и так дале там подобно поэтому такой имеет место быть многие делают и это вот ну так и такая достаточно достаточно часто картин который можно увидеть значит несколько момент во всей вот этой схеме требуется перри конфигурацию вашего приложения потому что например если один дата-центр падает два предложения перезапустить вам нужно каким-то образом жить с тем что есть а все три этих цвета не совпадают потому что разные кластеры ничего не происходит и второй это возможно возникнет дата до при дубликаты данных если такое произойдёт такой тоже можно вполне может быть произойти значит что со светами что советами во-первых офсета и хранятся определенном топике рассказывали ситуации где это все как бы стандартная такая стандартная конфигурация где у нас кафка и пишет данные в стандартный топе когда мы что-то кашами прочитал что-то сделал и потом это дело записалась данные записали себя все то записались эти а все ты тоже можно в принципе переносить их можно как бы реплицировать но здесь должна входить такая штука которая называется овцы красиво все translation потому что я уже сказал что костюмеры разные например консьюмер офсет разные среди разных кластеров поэтому чтобы например конвертировать а все чтобы он лег один в один система в светом которую изначально кластере было чтобы костюме вновь перри подняться на другой стороне с тем самым с ним самого все там есть такая процедура as a translation она делается на стороне и клиента и тут должен поддерживать например там репликейт р-н мир maker 2 по-моему они от мир maker 2 тоже поддержку репликатор поддерживать точно для этого требуется установка interceptor of прописываются специальные специальные хедира внутрь сообщение которое позволяет определять принадлежность собственно этот пункт номер два - это определяет откуда данные пришли чтобы мы например по кругу эти данные не шара шелли и так далее тому подобное чтобы мы знали с какого там дата центра они пролетают вот это со светами иметь один топик и реплицировать а все ты очень плохо не делать так можно поставить кучу всяких вещей и вы будете постоянно гонять одно и то же ну короче это очень такая неприятная ситуация более того может возникнуть ситуация что если использовать один и тот же топик и пытаетесь его гонять по кругу где-то нарушится очередность это не очень хорошо опять же в текущей обстановки в текущей конфигурации мы сейчас работает над тем чтобы и эту собственно проблему убрать я не знаю будет у меня время об этом поговорить на есть такая штука которая - кластеры linkin который позволит вот эти все вещи делать достаточно прозрачно без использования каких-либо tale of the правда титулы он про репликатор миру maker они все бегут внутри там коннекта например мир maker один это просто процесс внешней а репликатор это уже как бы connect коннектор который позволяет для которой нужна определенная структура который я тоже над каким-то образом поддерживать значит дайте-ка я быстренько гляну что у нас там по времени да давайте чуть поговорим про with both всякую вещь связана с тем что данные могут быть не консистентной как эту проблему решать проблему решать приходится на каком-то облигационном уровне да то есть есть специальный поттер который мы называем один патент он сам шин таким образом она позволяет не просто если вам нужно куда-то загрузить в другую какую-то систему до например мы система который ничего не понимает о эти потребности каски и то вы пишете в базу данных и по обратно в кафку у вас нету контроля на тему ну не то что у вас нет контроля пыток бы это делать неправильно у вас не мы нигде размазываем транзакции через кафку и через базу данных мы делаем это вот через либо unbox вот вот один повод consumes вот это то что мы делаем есть система например там кавказ 3-ем столике сехал тебе которые умеют работать и хорошо понимают концепцию как эти абсолюты должны сохраняться и как эти данные не должны теряться и потом на например там реплицировать вот этот вот топик с процесс над ими данными таким образом сделать такую многоступенчатую обработку вот но вот как бы нужно ли переносить физическую обработку через сито то центры тоже не не очень рекомендуется потому что опять же публикации данных если мы посмотрим вот на вот это все и построим диаграмму вызовов мы можем понять что во многих местах мы можем добавлять дубликаты и так далее и тому подобное поэтому это все все очень такое все очень такое ну не то чтобы все это ужас ужас но может могут возникнуть неприятной ситуации значит перед тем как я закончу мы перейдем к вопросам и ответам и с этим экспертам зонам я хочу сказать в одной очень интересной вещи которую я рекомендую вам посмотреть на на на этом на досуге есть ссылочка на на ноги хоп и там докер есть тоже там все запускал к называется мальте резину applications или мал терезин класс так это вот то что называется stretch кластер вот этот натянутый растянутый кластер но сделан правильно значит используется там несколько вещей используется тот же самый тип который мы упоминали 392 follower печенька который позволяет консьюмер у читать с определенных репликах не с лидеров здесь мы еще добавляем еще один тип реплика у нас есть лидер у нас есть фолловер и теперь у нас есть обзор на что делает observer это специальный тип реплики специальный тип реплики которые позвали она не входит в is our то есть она не может автоматически стать лидером когда нужно но она может стать лидером если мы можем это дело мануально делать это по сути дела такая асинхронная реплицируется я реплика то есть если у нас есть алиса в которой мы пишем и за время того как мы получаем окно он же мы знаем она записана то есть это то что мы называем синхронная репликация обеспечивает нам асинхронный и третий компонент это реплика placement который позволяет задавать правило как эти реплики будут распределяться например с помощью и позволяет а все делали конфигурировать кластеры это очень на самом деле удобно и интересная штука не то что удобно то что надо возиться с джейсоном и позволяет определять где куда разместить например мы можем разместить обзор мир в какой-то дата-центр где мы знаем что связь будет не очень быстро и таким образом он асинхронно туда подтянется и в случае какой-то там проблемы случае какого-то падение мы всегда ее может перри конфигурировать и от и назначить ее как лидера например да то есть это очень такая вот интересная особенность и из и она что самая классная она позволяет не не не думать о вот это репликации не думать о таких вещах как миленькая системы и так далее там подобно то есть это очень очень удобная очень удобная вещь и следующая вещь кота на которой мы работаем сейчас и возможно она будет очень скоро где-то рассказывание disclose the drinking который будет позволять кластер и просто меры без всяких вообще без ничего то есть не нужно будет ни миру maker не нужно будет ни репликатор ничего но об этом мы поговорим про раз значит а перед тем как мы разойдемся я вам верни смысле мы когда переместимся в экспертной зоны а я хочу вам сказать такую штуку во-первых в принципе и stretch кластер а вот эти растянуты кластеров чеснок до на центр это нормально это можно если у вас есть хорошие сети а если вы вот пытаетесь понять где вот в этой модели добра и зла вы находите вот собственно днат это смотреть 3 дата центра это идеально конечно это очень хорошо как нам туда все это делалось диплом два слоя дата-центра нам нужен половинка вот центр для того чтобы запустить вот так breaker для того чтобы консенсус наш не разваливался 2 дата центра можно но очень сложно и нужно иметь небольшую как бы инженерную такую закалку который позволяет вам восстанавливать и вы можете там хорошо владеть тула мире конфигурировать я кафку и налитую все такое 390 рой тип очень много помог с точки зрения по популяризации stretch кластера по сути дела да потому что в речь кластером нас теперь появилась возможность читать из реплик то есть такая вот штучка и canson сервер и вот этот о марсе функциональность которая вам так что показал она использует эти вещи и приносят еще такие интересные штуки которые называются обзор на всегда есть возможность от мира искала стираем использует вот в этом дабл дабл дабл актив вы поняли короче дату в таком режиме может поработать ну там есть тоже определенные нюансы можно можно поиметь определенных странностей зеркалирования она асинхронная соответственно это ну как у перенос данные в другое место и собственно никогда не поздно как это перед не до оптимизирует перри оптимизировать и на городить огород всяких клевых вещей вот поэтому да поэтому такая вот история спасибо вам спасибо вам за внимание подписывайтесь на мой twitter #dyh вупс всё клёво и давайте я сейчас скажу папе пока немножечко водички и передаю слово нашим нашим ведущим ты что пока ведь идет за водичкой мы наверное немножко можем обсудить доклад андрей вот ты когда-нибудь разворачивал кафку несколько дата-центров никогда вот я честно говоря вообще никогда не разворачивал кафку кроме как но соответственно в докере вот это очень легко и просто в ее ей вот я смотрю слушателем ножей на имидже хорошо я пришел я верну я вернулся до его виктор с нами я хочу сказать спасибо за доклад он отличный отличный и зевание крутые отсылки к одному из любимейших сериалов вот но это правда какие-то намеки на наш возраст такие не недвусмысленные по-моему он уже даже не выходят и я гришин поменялся уже вы как вы понимаете что у нас уже там после чарли шина был грешен коучер и что такое и мальчик сильно повзрослел вот другое дело что вот то что было анекдотом у некоторых даже оказалась в реальность они с таким сталкиваются приходит у барсы выключает к компьютеру все как бы какой production production вот но есть и вопросы вопросы насущные у людей и они хотят знаешь там не будем сейчас останавливаться на сравнениях кафки и пульсара об этом поговорим дискуссионной зоне вот вопрос вот смотри какой значит есть некоторое количество серверов и вместе с кафкой там должен работать другой софт понятно что на одном сервере разворачивать кафку бессмысленно да то есть вот эти три наши значит сервера уйдут под каской класть как ему уже состав там очень хороший вопрос это вопрос создается множество множество раз и ответ здесь на самом деле depends на всех всегда в любому в любой ситуации это чай как бы эта система зависит значит вообще в принципе желательно иметь две вещи как бы и май 1 вещь это сеть равич диск и третьим наверно в какой-то степени компьютер и там память давайте сейчас быстренько вот сколько у нас осталось 3 минутки а сейчас быстренько расскажу про вот эти три вещи сеть кафка позволяет настройках call стирал указывать разные части в интерфейс можно повесить разные ли сына ивана разности в интерфейс что это означает например реплика цион ную логику тоже которая ходит между вот этими нотами кластера можно повесить на один интерфейс если ваша система это позволяет есть вашим рукам пути много сетевых карт вы можете это сделать и например аппликационную логику можно вынести на другую сетевой интерфейс и дальше там и про если они развязана положите интерфейс он то можно накручивать разные безопасность по-разному и может быть quality of service может быть накручивать по разу где-то может быть работало где-то копыта например чтобы это дело все разбивать и другие приложения например с этим делом никаким не связан дальше момент диск желательно кафку иметь всегда на отдельном диске потому что данные скакалке там есть возможность указывать директории чтобы другие туда собственно не врывались опять же есть в к вкус какой-то база данных бежите хотите рядом класть и но не очень хорошая идея вы так делать потому что опять же диск и они резиновый и у вас эти крутящиеся диски или ssd диски . esosedi может быть отобразится нибудь есть низкий крутящий ся то лучше так не делать и и память значит буковкой работает через это называется зиру копи это означает что много вещей завязано не на хип а именно авраам и вот этот почтишь это часть операционной системы которые популяционная логика обычно не контролирует соответствие есть вас бежит обкаткой кассандра бывали случаи что нужно там отдельно подкрутить этот пачки чтобы эти две системы там нормально помещать потому что они не веруют нет возможности как разделить я вам сейчас листаю тут совет люди пишут поставьте кубер найтись это не не плохая идея если вы готовы идти вот по этому маршруту да то есть большие машины поднять на нем кубер и каким-то образом отдать контроль и to the king и вот эта вот изоляции этих ресурсов на кубер notice но здесь есть опять же есть нюансы отлично нас тоже есть нюансы тоже есть нюансы нюанс заключается в том что не андрея кирилл до подходит время туниса сторону от решая мне подходит концу это значит что мы должны попрощаться с виктором точнее я должен попрощаться с виктором а вы можете прийти будем делать давай давай давай инвалид так фильтр я очень рад видеть и уже не виделись со времен последнего подкаста разбор полетов практически но я думаю мы еще увидимся а вы дорогие зрители идите и задавайте вопросы виктору про кафку пророка идеи про все то что еще не успели спросить в чате а мы переходим к партнерскому блоку пока пока"
}