{
  "video_id": "p9Aih6rGFTM",
  "channel": "DevOops_conf",
  "title": "Иван Гулаков — Опыты с IaC: как мы научились запускать зоны доступности облака за пару дней",
  "views": 205,
  "duration": 2795,
  "published": "2024-10-18T00:11:53-07:00",
  "text": "Всем привет Сегодня у нас забавный доклад на тему того как большие компании пишут свои сервисы для диплоя своих облаков тема на самом деле очень интересно вот мы в Яндекс облаке занимаемся похожим разве что скажу честно у нас масштабы Чуть поменьше напомню сколько у вас дата-центров наверное совсем посчитать там Порядка 70 отлично там какая-то страшная карта есть я ее наизусть даже не помню ну отлично давай ты нам расскажешь как всем этим управлять я на всякий случай напомню что есть qr-код вы можете зайти в чатик задавать вопросы там в конце их Обязательно озвучу что еще из такого важного стоит сказать в конце еще будут вопросы Из зала поэтому Готовьте Ну давай Ваня Расскажи нам пожалуйста как это умудряетесь сделать потому что мне тоже интересно да Как мы до такой жизни докатились но Собственно как меня зовут Сергей уже представил вот я человек который отвечает за инфраструктуру нашего облака и собственно за те сервисы которые крутятся поверх этой инфраструктурой в случае чего по голове бьют именно меня вот И еще я очень люблю кубы и все что с ним связано и соответственно большинство наших решений я стараюсь строить на основе кубов такой Google Вот но давайте начнем немножко издалека вообще при слове облако люди представляют довольно разные вещи и вот если не знаю шутка байка вот я прихожу на семейное застолье зачастую когда люди там выпьют скажем так начинается классические вопросы Ваня кем ты работаешь и что такое облако А правда ли что все фотографии которые у меня на телефоне тебе в облако сливаются да Ну это наверное совсем обывательское такое мнение если говорить про более так скажем подготовленных образованных клиентов которые основную массу составляет наших пользователей в принципе кто это такие бизнес который приходит для того чтобы их жизнью простили предоставили какой-то какие-то удобные сервисы которые позволят им экономить на содержании что-то админовцев и вот этих вот всех людей вот Но для того чтобы эти самые сервисы предоставить необходимо команда разработки как Неудивительно Вот и наверное с точки зрения разработчика облако Это не просто как какой-то дашбордик с кучей сервисов которые видят все наши внешние клиенты а Целый набор стендов тут принципе наверное вы видите Знакомые слова где встреч prod против кстати несколько разных и плюс всякие еще дурацкие названия периодически стенда которая приходится разворачивать для каких-то особых видов тестирования внутри компании или там для даже особых заказчиков каких-то Я в дальнейшем буду часто использовать слова стенд регион Возможно даже облако в контексте данного доклада это одно и то же и под этим подразумевается какая-то независимая инсталляция нашего облака полностью функционирующая Ну в кавычках наверное полностью независимы обычно мы за собой не таскаем собственно биллинг и консоль облачного управления вот и говоря о стендах собственно если для разработчиков это веселое стендики сопишкой куда можно куда-то потыкать в сервиса то всегда должен быть Вася с лопатой которая это будет все копать поддерживать и получать По шапке Вот и каждый из этих стендов это целая куча различных приложений в данном контексте все это крутится поверх слоя виртуализации от января и этот накладывает дополнительные ограничения потому что нам приходится поддерживать частично поддерживать скажем так не только ту инфраструктуру которая знакома наверное любому инженером то есть знакомые комочки это кубы эластик Search мониторинг от Виктории и так далее но и некоторые скажем так интеграция сетевой частью то есть с дном тут есть и некоторые настройки на виртуализации и все вот это накладывает дополнительный контекст перед тем как пойти дальше здесь вот такой таймлайн изображен о том как по моему мнению обычно движется развитие управления инфраструктуры в большинстве компаний мы тут наверное не первый проход ни разу Вот ребята обращаясь к вам если в зале кто-то Кто ещё не пользуется подходом инфраструктура как вот вообще полностью и катится руками поднимите руку честно Ну наверное таких нет если кто-то кто только начал еще внедрять подход иак и только-только делает Первые шаги в этом плане хорошо все визу вот если кто-то кто уже не первый год этим занимается и вот допустим Если в контекстера форма говорить Тут много будет протираформ в этом докладе например уже делать более серьезно шаблонизацию у него много стендов у него много бэкендов модулей вот это все тигрант наверное знакомое слово тут прозвучит Если такие вот уже больше рук да на самом деле тема довольно таки интересная вот ты говоришь сейчас про некоторую некоторое движение в сторону того чтобы чуть больше автоматизации добавить то что мы делаем Да и не только автоматизация скорее тут все идет вместе с ростом чем больше вот этого кода становится тем сложнее его менеджер А вот следующим этапом еще и возникает проблема что запускает не полтора землекопа этих землекопов допустим 20 может быть да И на самом деле я хотел тоже не мог просто молчать Что вот мы в Яндекс облаке тоже вот активно последние несколько лет диплом новый регион по сути наш сервис раскатываем инсталляций и вот эта проблема она очень понятна она как я заметила Она не только нас волнует то есть многие компании из отличный доклад на этой конференции от ребят из Авито они тоже про это думают и это на самом деле очень такая тонкая мысль что на самом деле мы должны писать не сервисы мы должны наши сервисы делать продуктом который будет диплоиться по сути вот тепло и наших сервисов это отдельный продукт которым надо заниматься и если этим не заниматься то придется нанимать миллионы диопсов которые будут писать на печатных машинках ваш скрипты Ну да во многих крупных конторах обычно есть какой-нибудь подразделение не называются какими там платформенная команда команда развертывания инфраструктуры еще что-нибудь и вот такие продукты они делают Ну а давай я не буду тебе мешать Расскажи нам пожалуйста как вообще это у вас выглядит самое самое интересное начинается но смотрите давайте начнем наверное со стоков Я в МТСе около там трех лет кажется нахожусь и вот когда я пришел Мы где-то вот-вот на вот этой цифре два были То есть я был в каком-то виде стендов было немного и в принципе разработчиков то немного было нас там 20 или 30 человек тогда был фактически маленький стартап такой а потом начался активный рост больше стендов новое окружение появился например и вот это все стало тяжело менедж жить собственно я бы выделил вот такие основные проблемы которые с которыми мы столкнулись во-первых бардак в дите То есть когда было там полтора репозитория и допустим там ну две-три веточки в каждом репозиторе В принципе с этим можно было жить я дальше насвайде покажу наш Вегасе репетиторий рекордсмен кажется там 40 веток все соком вот выглядит страшно и отсюда же при такой при такой схеме управления был дрифт конфигов по стендам потому что как по 40 веточкам Попробуй копию по чири пикой все свои изменения посмотри что у тебя все актуально и так далее и отсюда же уже росли проблемы которые обозначены номерами 3 и 4 процесс диплоиста долгим не очевидным Новые люди когда приходили смотрели на этой вздрагивали и еще бонусная такая особенность Помните я упоминал о том что у нас активно используется стекает как мы низкоуровневый слой достаточно ну в контексте стандартной разработки у нас еще есть зависимости от слоя инфры который находится под нами то есть виртуализация и сеть и это важно в том числе даже для работы наших сервисов и вот здесь терялся Синг между командами потому что отвечали за этот целиком не мы соседние команды постоянно надо было симкаться и возникал Battle nake когда условно полтора человека знала о том что действительно происходит это тоже была большая проблема Ну собственно я обещал показать наш репозитории рекордсмен если взгляните на экран там скроллер есть Вот то есть оцениваете масштаб трагедия наверное Ну и о том что кроме количества веток тут плохо Тут есть папочки ansible То есть у нас и система инициализации в одном репозиторе Иван провижник и да и ту провижник в этой Репе и более того мы тут не просто модуль какой-то вызываем там на самом деле валяется прям классический мейнтф мы его таскаем между ветками Вот это счастье уже сейчас избавились Ну и тут еще Файлик с переменными окружения внизу лежит вот Ну посмотрели мы вот это дело и на самом деле первое что мы сделали это притащили тира Гранд про который я уже говорил в принципе он А ну и модули внедрили про модули уже много было сказано на этой конференции это средство разделения тироформ кода по таким логическим не знаю кусочком Наверное это можно сравнить с какой-нибудь библиотекой в языке программирования Я бы так сказал Вот но Казалось бы решили все проблемы Вот появилась какая-то обидчика запускал все стало хорошо а вот не стало хорошо потому что вылезли новые проблемы на самом деле они тоже очевидно решаемые но мы пошли довольно Я не знаю необычным что ли путем какая проблема была инженеры запускали свой не свой наш иак со своих рабочих компов отсюда какая проблема вот история у меня товарищ винда вот он сидит на соответственно будете пишет модуль у него внутри около все как мы любим локоны его бунте я на кого-то он мне отдает этот модуль говорит Все работает запускаю у меня он крашится на этом потому что у меня утилита от psd получается у него и ничего не состыкуется хотя название вроде одни и те же ключи разные и что на этом моменте приходит в голову Казалось бы запакуй в контейнеры и обычно как это делают запускают через себя CD систему через paypline У нас например есть можно это запускать через пейпы но не захотелось как-то нам привязываться гитлабу и на самом деле Уже довольно долгое время процветают система типа как косплей на кластерапия Они конечно не совсем про это Но про то чтобы централизованно запускать в кубе и мы собственно и подумали А почему бы нам не сделать менеджмент кластер по типу вот этих кроссплейн или кластерапию и начать с него все менеджерть потому что решается проблема с унификацией А кастомизацией ещё и дополнительная какая-то отказоустойчивость добавляются и вот это всё ну и собственно для того чтобы конфиги в этот кластер предоставлять Почему нет он популярен и в принципе для менеджмента инфры он очень хороший Вот про сервисы я бы так не сказал а ну давайте переходить конкретики обозвал я этот слайд платформа диплоя наверное громко звучит Ну вот этот тот самый продукт про который говорил Сергеев он в какой-то момент сформировался я бы тут выделил две основных части и в контексте сегодняшнего рассказа мы будем больше говорить про ту часть которая функционирует на основе терраформы на самом деле готовится сейчас немножко другие уже тут их нет я бы выделил две основных логических части у этой штуки собственно вот можно вот так вот линию как-то провести середке и та часть которая слева она отвечает в принципе за конфигурирование то есть конфигурация у нас лежит в ките точка Правды единая и потому что доставкой собственно манифестов кластер наш менеджмент занимается контроллер от ранчо он же раньше Флит Ну читайте это маргасситив Люкс вот мы выбрали Фит от ранчо Ну мало доставить инфраструктурные манифесты кластер они должны условно имплементироваться Вот этот прямоугольничек который справа он тоже появиться кто-то Это должен запустить и собственно мы нашли Такой чудесный продукт который называется с некоторыми фичами Давайте собственно посмотрим о том как мы вообще вот это все организовали Ну начнем слева опять же detops повторюсь с инваерами трепами думаю все понятно Это наш репозитория в которых лежат конфигурация которая в дальнейшем будут переданы в терраформ модулей И вообще вот эту обвязку которая выполняется мы используем сквозные переменные у нас с одной точки передаются не то чтобы конфигинут переменные будем говорить и тянутся дальше по всему коду соответственно а для поставки в кластер мы используем строго один информатор артефакта это halm это в принципе удобно за счет того что достаточно унифицировано все получается и у нас есть маленький Чертик такой заглушка называется и дальше на него тоже Посмотрим по сути приезжает одна церковь и парочка секретов конфигурациями для того чтобы ходить но теперь самое интересная часть скитапсом то все понятно про него много сказано было теперь собственно а то и запускалке которая вот эту всю штуку приводят в движение собственно терраформ оператора посередке вот этого прямоугольника Вы наверное видите сейчас подсвечу довольно стандартный Flow tier форма для инициализации инфраструктура Юнит плана plain ничего такого интересного Но самое интересная часть помимо запуска это huki вот это очень важная фича Я считаю по одной простой причине никто не любит вашего антиблино обычно называют не любят около экзеки в форме тоже по понятным причинам потому что их сложно обрабатывать из не каждый условно язык программирования можно туда без приседаний засунуть куки решают эту проблему вот во всех вот этих фазах приняты посты нет и так далее ну то есть пре понятно Это перед фазой запускается пост после можно запихнуть любое исполняемый код в любом формате будет запущен отдельный подвиг И в нем будет выполняться этот код мы использовали и питоны и Баш При желании можно запускать гошенные бенаристичное что угодно туда накрутить и это в принципе будет нативно прозрачно и В отдельной части сконфигурирована Ну и мелкие бонусы в виде того что у нас появляется принципе Рабочая модель рыбака можно как-то ограничивать доступа и выстроить какую-то систему доступа к этому менеджмент кластеру спойлер Мы еще до этого не дошли и наверное все Ну и в принципе то что тут еще сервис аккаунта видно мы не можем поломать соседей в соседнем спейсе тоже очень важно Ну и Давайте переходить собственно дальше погружаемся еще больше Здесь изображен пример нашего живого менеджмент репетитория В дальнейшем я буду рассказывать на примере на примере диплоя кубов Почему Потому что это наиболее полное полная история Наверное если вам покажу как смотрите мы можем за тепло идет на виртуалку Да через всю вот эту штуку Но это будет не интересно вот поехали собственно все файлы конфигурации у нас в формате Ямал Да я мол девелопера все как мы любим про формат артефакта я уже говорил то что это helm потому что это удобно потому что там геймплейт мы еще его любим Вот и в принципе нам все понятно Ну и для доставки используется повторюсь контроллер от ранчо называемый Флит Вот и Давайте посмотрим что же за такие чудесные папочки то у нас нарисованы в этом репозитория а собственно структура вот этого менеджмента репозитория она повторяет структуру любого инвайрамента репозитория нашего подконтрольного Куба в принципе за некоторыми отличиями Давайте снизу вверх пойдем вы veryble с яму это собственно та точка где происходит низкоуровневая конфигурация кластера выемке его раскатка для раскатки мы используем утилиту РК я и её шаблоны и собственно установка двух основных компонентов которые мы не можем поставить через git Ops потому что gitops не может без них существовать это сеть сенай Ну и Собственно сам с контроллер далее после того как кластер про инициализирован идет фаза пост инициализация это собственно то что изображено горя это те компоненты без которых у нас кластер не может считаться кластером он в принципе работает но нам этого недостаточно То есть микроскороллер он же сервис mash оси сайт драйвер для дисков и парочка интеграции с нашими системами Помните я упоминал то что менеджмент кластер он в принципе про Близнец за некоторыми отличиями вот эта штучка которая выделена в красный прямоугольник Она же директория кластерс это собственно то та точка Откуда мы менеджер всю инфраструктуру которая есть в нашем регионе весь наш вот этот стенд там будет набор папочек но в дальнейшем посмотрим в котором описана вся вся вот эта инфра которая у нас есть в нужном нам регионе Ну и Давайте смотреть про устройство релиза собственно я начну опять же немножко сбоку Для чего надо расставлять инфраструктурный код помните вот тот слайд где была жуткая помойка в репозитории Кафки было все в куча изменений было сложно протаскивать и так далее мы от этого ушли по нескольким причинам собственно Начнем с того что прибитие во-первых использование модулей и Особенно их тегирование позволяет нам гарантировать что при запуске инфраструктурного кода он всегда отработает Почему Потому что так вешается на Комет мы гарантированно знаем как настроить эту версию модуля у нас не будет такого что она не работает например привязавшись к мастеру раз два мы не переписываем 10 раз то что мы уже написали экономим время инженеров и собственно для того чтобы сослаться на вот эти самые модули я уже говорил у нас есть чарт заглушка TF оператор boolerplate Это единая точка управления инфраструктурным релизом нашим вот этими пресловутыми папочками мы используем только эту штуку и какую проблему мы этим решаем в принципе все Наши соседи могут к нам прийти взять шаблончик этого чарта взять свои модули и через нашу вот эту платформу за тепло и теле настроить то что им надо у нас нет никаких в принципе больше строгих требований люди могут там воротить что угодно и мы будем гарантированно уверены в том что оно у них запустится и отработает до какой-то степени отработает если они конечно модули плохо не написали ну и собственно я говорю то что мы еще хуки всякие используем вот у нас есть группа репозиториев которая называется скрипт и от наша помоечка со всякими хуками Давайте погрузимся еще глубже и собственно посмотрим что же мы в этих релизах поставляем вот здесь в принципе такой подрезанный манифестик того как выглядит этот чарт Да там кстати то Ямал используется внутри шаблонов как мы любим Вот и кто-то как не любит Давайте по частям разберем что же тут написано пойдем сверху вниз собственно Это я думаю в принципе синтаксис вам всем знаком банальные настройки терраформы Мы выбираем версию и говорим нашему контроллеру типа запустим не котики с тераформом вот такой версии ссылка на модуль здесь как раз примерно раскачка нашего кластера Куба и так мы прибиваемся к такому помните это говорил Мы в качестве бэконда используем куб Вот это кстати очень холеварная тема все как бы ратуют за свои бэкэнды кто-то гитлап любит кто-то позгрис вообще основная холеварная тема это блокировки наверное вот сразу спойлер в Кубе есть блокировки блокировки реализованы с помощью ресурса cubernet слиз И если мы запустим с тем же стоит он второй подвиг Ну такое бывает иногда он свалится и напишет что-то типа Ага Чувак я вижу Лизу занято я не могу идти дальше Ну и собственно Вторая причина почему кубовый быкант все яйца в одной корзинке у нас еще забегая вперед у нас пока по вот этого всего делают это легко восстанавливать еще это легко посмотреть в этом же кубе он же менеджмент а вот это уже флажки самого терраформ оператора то тоже наверное сразу возникает вопрос Вот у тебя последовательно запускается вот эти жабы А что делать если у тебя в плане какая-то дичь ты накосячишь с конфигурации У тебя там все красное надо все пересоздать флажком реквара провал мы можем завесить наш Flow deply на этапе собственно плана и прочитать его если нам все ок мы отправляем специальную команду по сути это создание файликов котики Ну если погружаться в детали и дальше оплавим нас пишут не нравится создаем другой Файлик у нас план отменяется падает как фейлд и инженер идет разбираться чем же вообще такое произошло второй интересный флажок это игнор делит про Что же он Давайте немножко вспомню как у нас вообще в среднем работают с оператора То есть когда у него только появляется манифест он по классике обязан его отработать и на основе его привести кластеры или внешние по отношению к кластера ресурсы к требуемую состоянию Но вот когда манифест мы удаляем У нас есть еще Такая сущность эвалайзер заглушечка которая позволяет на контроллера провести работу по чистке мусора за собой и вот это очень важная деталь в контексте терраформы потому что через менеджмент кластер При желании можно снести вообще почти все на свете И это большая такая красная кнопка вот этот флажок позволяет сделать нам так чтобы при сносим манифеста мы ничего не потеряли инфраструктура осталось целой дефолт мы проставляем этот флажок в труд для того чтобы стелить дополнительный соломки Ну и собственно достаточно Комон История это то как мы вообще указ ссылаемся на наши инваерами репозитория через переменное окружение здесь они имеют префикс tfr потому что они в дальнейшем прокидываются модуль даже не то чтобы прокидывается это служебный префикс по которому понимает то что эта переменная предназначена именно ему их уйти все как мы любим вас вот еще и онлайном сверху специально оставил ссылочку это как раз на репетиторий ссылаемся а в постопла и фазе просто инлайн штучка расшифрую ее после раскатки кластера Куба Мы вытаскиваем из со стейта его кубик конфиг и кладем в секрет чтобы его можно было удобно потом забрать Для дальнейшего обслуживания Ну и возвращаюсь о том к тому Зачем нам вообще детокс собственно это как раз развертка нашего репетитория который был на предыдущих слайдах вот куча папочек если обратим внимание тут есть не только учащая сущности связанных с кубами где-то внизу есть Кафка Open distra и даже настройка сетей на секса то есть что нам это дает единый формат релиза это наверное заслуга больше никитопса холмчарта Но все равно я здесь это пометил вот папочки братья-близнецы внутри welly's файла Все одинаково и отсюда же единый слова запуска диплоя гитабс как только КАМиТ в репетиторий прошел изменился Хеш у файлика контроллер постоянно обрабатывает эти изменения контроллер понял что изменение надо подсимкать контроллер дотащил изменения в кластер и запустился теплой единая точка управления в принципе про эту же историю и наглядная история изменения Вот это тоже очень важная вещь в контексте таких репетиторов любой Помните я говорил то что у нас есть смежные команды мы не понимали долгое время чего вообще происходит на той же сети допустим там фаером что-то перекрыли мы такие сидим блин а почему у нас все перестало работать внезапно Почему носили он сдох и перестал повезла на трафик гонять вот зашли посмотрели что что нас интересует в принципе При желании можно какой-нибудь высший менеджмент пустить на демо и там приходит условной сетевой такое видит Ага Ну вот ребята что-то наверное делали вот я даже могу потыкать Наверное они свой хлеб не зря едят удобства Ну и Давайте немножко подытожим выше сказанное она примере диплоя Куба что же вообще происходит помимо заполнения имлов А то только про них и говорим вот что делает инженер когда ему надо раскатить новые куб приходят создает инвайрмент репозитории прокидывает туда ключи такена и все Что необходимо для доступа различных контроллеров эту репу после этого на основе специального Golden так называемого репетитория он создает структуру вот этих папок файлов внутри папочки топ с манифеста формате флита плит Ямала не называются и собственно он описывает то что он хочет по итогу получить а то есть инвайрмент репост конфигурирован но этого все еще недостаточно для того чтобы из этого получился кластер нам менеджменту надо сказать Вот это та самая Папочка кластерс чувак сходи и раскати мне инфраструктуру которую я хочу это делается с помощью добавления двух холмовых релизов в контексте Куба это как раз если прощали внимание то что называется суффиксами рке и холм добавили манифеста и вот здесь уже начинается собственно сама вот эта вся балалайка по раскатки detops реагирует дотягивает манифесты Хоум чарта приезжают исковым чартов вытаскиваются церкви грубо говоря TF оператор видит Ага у меня появились новые церкви надо их обработать и запускает Весь вот этот лоу диплоид допустим с планом у нас все хорошо мы прочитали Мы не ломаемся на свете пропустили дальше Тачки задеплоились перед Кроме того у нас еще есть три ту провижник Хотя он наверное скрещен С первым днем мы используем строго и гнишн это такая штука типа клауденита и тачки еще предварительно конфигурируются спойлер у нас фотка еще на большинстве инфраструктуры Тачки от конфигурились время ставить на них куб запускается собственно рке-провайдер терроформе и раскатывает кластер Куба поверх этих машинок далее отрабатывает провайдер ставят туда тот самый Синай и еще Флит Агент И после этого кластер натравливается на свое инваером репозиторий и дотягивает всю вот эту муть которая в него должно там приехать порядка 50 всяких манифестиков чартиков и так далее все кластер готов к использованию средняя среднее время выкатки вот этого всего наверное самых наших больших кластеров по 30 тачек они по моему идут с кучей компонентов Вот я говорю порядка 50 штук 25-30 минут при условии что все настроено то есть опытный инженер который имеет копипасти имлы Да Ямал девелопер может в принципе со всей вот этой задачей с нуля справиться Ну наверное за полдня может за день если долго гонять Чьи Вот и небольшой бонус сразу предвижу холеварные вопросы А кто Вопрос первый откуда берется сам менеджмент кластер это концепция на самом деле тоже не нами Придумано подглядели мы ее в класс царапия и в косплейне собственно тоже для того чтобы за тепло эти перманентный менеджмент кластер мы используем boots кластер который инженер может в принципе развернуть ему нравится на ноутбуке в Облаке Я не знаю на калькуляторе на котором можно запустить не важно запускает он этот кластер и ставят сюда собственно оператор Это собственно все что ему требуется для дальнейшего после этого он устанавливает хэлмонд стал 2 релиза в этот кластер который полностью дублирует то что у него в инвайерами трепе по сути описано в папочке кластерс на основе этих двух холмовых релизов происходит то что мы рассказывали что мы просматривали на предыдущем слайде депоится перманентный менеджмент кластер и вот здесь самое интересное и важный шаг недостаточно его просто затеплоить мы еще делаем так чтобы кластер думал что он свой сам себя породил Вот для этого мы мигрируем стоит террорформа в этот кластерную некоторые другие штучки в основном стоит после этого кластер с помощью китовса он уже знает на какую инваерами трепа ему надо смотреть идет до Синг кивает и потом пытается сам себя за провижнее за провижник видит Ага стоит то у меня уже консистентный мне ничего делать не надо я раскатился и таким же Макаром как ни странным может происходить его обновление вот на самом деле киллер фича которая сам недавно узнал до последнего думал что не будет работать оно работает объяснение этому феномена нет короче этот кластер может сам себя апдейки бомбить своей версии Куба бамкнули версия в манифесте у нас уже заготовлен к этим плейта кластер сам себя апдейт вынужденный случай когда состоит и передергивается еще внизу runtime но это не работает К сожалению потому что тепло и сама себя убивает и немножко еще Давайте о защите Помните я упоминал то что это по сути такой чемодан с красной кнопкой действительно красная кнопка и При желании можно убить вообще все наше маленькое облачко стенд региона Называйте это как хотите вот мы минимально защитились от этого ну собственно У нас есть Open Police edgent и мы с помощью него заблокировали удаление ключевых кастом ресурсов которые описывают нашу инфраструктуру там на самом деле обычно используют два подхода кто-то аннотирует сразу ресурсы и для того чтобы их удалить надо снять аннотации мы делаем наоборот для того чтобы удалить ресурсы нам надо поставить аннотацию аннотация длинная ее в принципе там если человек решил под пивом в пятницу заделывать Наверное он ее не сможет набрать без проблем вот дополнительная защита от дурака на уровне терраформы на его ресурсах Ну я говорю про флажок блокировки стейтов и собственно стандартный функционал и я Dr тоже достаточно прост Я говорю что мы не зря положили все стоит и в эти менеджмент кубы Почему Потому что это можно достаточно легко забайкапить и я бы выделил в принципе три таких основных сценария Давайте коротенечко по ним пробежимся это когда ресурсы менеджмент купе целый а на виртуализации часть потерялась Давайте самый простой случай нас простые виртуальные машины потому что иначе можно тут это раскрутить историю в таком случае мы просто триггерим заново нашу репку мы идем по Дефо доставляем там нужные Тачки утерянные ресурсы менеджмент кубе вот здесь Наверное погрустнее история тут могут быть разные сценарии развития Иногда надо симкивать ресурсы стоит Если еще и стоит побился но чаще всего достаточно просто ресурсы перед диплоить они собственно не они поймет что все ок подцепит это и пройдет в холостую Ну и наверное самое грустный сценарий Это когда вообще развалилось Ну и тут кажется мы немножечко подготовились покопите себе докафундинг С3 с логотипом МТС мы бы капимся туда каждый час и При желании можем вытащить этот бэкап достаточно быстро с него развернуться и Это умеет делать Да не только я Вот это наверное в принципе наши минимальная степень защиты понятно что это не серебряная пуля иногда бывает грустно Иногда приходится посидеть вечером Ну вот есть как есть Ну и давайте наверное подытожим что я тут вообще рассказывал что мы в итоге получили зачем мы вот это все делали какой просят во-первых мы структурировали хранение нашего инфраструктурного кода это разделяемая репозитории модули ин капсуляция модулей друг друга и вот это все дело Еще и тегами обмазали нам теперь хорошо у нас все гарантированно работает и мы не копипастим за собой по 10 раз подход во всей красе ускорили Time to Market тут такой кликбейтное название еще у доклада то что ускоряем там диплом инфраструктуры в 10 раз наверное в 10 Но примерно около этого в худших случаях мы ускорение имеем вот я упомянул то что опытный инженер за полдня в принципе справиться с раскаткой знакомому компоненты наглядность мы видели наш менеджмент репозитории видно коммиты истории изменений и более того менеджмент кластер Вот кстати Киллер фича я к сожалению скриншот не приложил можно зайти в менеджмент кластер Vivi увидеть как ваши коллеги ковыряются что-то ломают True Store в прошлой в пятницу в 7 вечера на прошлой неделе я видел как мой коллега 17 раз перезапускал обновление Куба и у него все время это под все время это падало вместе можно работать Это достаточно удобно Ну и собственно стандартизация это инструмент который используем уже не только мы например наши сетевички активно настраивают секс с него и два наши потихоньку тоже въезжают и планируют база через нашу коробочку Ну и отсюда что это единая точка Правда и управление всей инфраструктуры региона в принципе я уже раза три проекта сказал Ну есть и недостаточки Куда уж и без них Наверное вы успели заметить то что тут куча оберток много оберток это всегда усложняется дебаг особенно когда они без трейсов например тот же кираформ это не засунешь неопытные люди достаточно по-разному реагируют на вот эту историю им приходится добычи отцы страдать отсюда же достаточно высокий порог входа Ну и я не знаю это недостаток или нет в контексте данного доклада мы довольно сильно завязались на форум наверное сейчас будет достаточно больно с него съезжать особенно в контексте разгадки кубов Ну есть как есть и какие-то планы по развитию первое что мы сейчас начали пилить это кличку потому что я говорил больше копипаста Бога копипаста вот Голден репозитории вот это все Коллеги начали пилить толзу которая позволит вот эти рутинные операции снизить их количество вот идея на это будет чем-то на генератор конфигов кубадом всем известный похоже также мы планируем переезжать на барметал с нашей чудесной системой виртуализации небольшой спойлер доклад Я готовил раньше чем мы начали это делать и собственно мы уже заехали в каком-то виде На железке вот Ну и также мы планируем отказаться наверное по большей части тераформы и вот класть терапии кросплей наверное тоже не особо актуальная история в контексте переезда вот туда Просто присунуть некуда особо А вот кластеры очень даже нам поможет в контекстера раскатки кубов и решит многие проблемы которые не решает только и вот собственно у меня наверное все Всем спасибо за внимание ваши вопросы давай спасибо большое что рассказал у нас наверное есть вопросы но я не могу задержаться и хочу все-таки узнать вот этом говорил про дивопса Да который чай пьет Или еще как-то отдыхает от своей работы с Ямал конфигами А можешь сказать вот смотри вот у вас много костеров а я правильно понимаю что их диплоид разные люди и обслуживают разные люди как-то вы передаете работу по поддержке этих кластеров какие-то Возможно даже команды которые не работают у вас внутри свободе так Ну тут наверное вопрос на две части поделить во-первых есть смежники условно Это от сетевики классический пример у нас есть Несколько ребят которые нам очень активно помогают они в принципе в нашей кухню погружены но они больше посещалки какие-то с таким на уровне сена и SD на делают просто тюнинг и так далее у них в принципе есть такие права рылевка сейчас недостаточно гранулярно настроена они в принципе могут зайти Вот в эти менеджмент поделать мы это естественно увидим по мерча Квеста вторая часть это про поддержку вот здесь тоже такая интересная история у нас есть соседний трайп-трайп в нашем контексте большая такая отдел вот хорошее слово русская есть они англоязычная и вот в соседнем отделе сидит целая команда эксплуатации которая частично знает как пользоваться нашим решением и помогает то есть принципе можно взять завернуть продукт коробочку и отдать эту коробочку сопровождать кому-то еще да более того и вот кстати Спасибо за напоминание я забыл очень важный момент сказать что основная фишка вот этого решения Зачем это все делалось переносимость очень хотелось сделать такой продукт который можно понятно с некоторыми ограничениями Но взять там флешку что-то положить прийти на железке развернуть минимальный пустой причем гитлаб прита щить туда полтора репетитория с нашими модулями наработками подключиться к железкам виртуализации и раскатиться вот При желании Ну может можно это проделать в Яндекс в принципе есть там провайдером Яндекс клауда воспользоваться местами совсем немного времени Давайте может быть у кого-то Здравствуйте гром Спасибо за доклад Вопрос такой вот тут больше наверное продитопс не испытывали вы неудобств в том плане что как бы нельзя ставиться что то что доедет она взлетит то есть надо сначала замерзнуть а потом мониторить поднялась или нет И может быть как альтернативу там не рассмотрели Атлантис для этого да спасибо за вопрос я забыл сказать И как не хотелось этого делать Хотя очень свое более контролируемые и Да сгитом действительно есть эта проблема то что нужно в каком-то виде делать тесты и мы уже частично начали тесты но очень низкоуровневые условно вот там сейчас у нас используется такая портянка то есть там служебка для детопса какая-то описание Чего Куда сходить что взять и так далее их и новые вывеса мы первым шагом отделили я прям прям сразу на примере начну рассказывать хел новые Мы отрезали для того чтобы можно было доделать дополнительный стоп-тестов при этом нет реквесте И у тебя хотя бы прошел рендер чарта банальная проверка то что у тебя вообще там отступа не поехали еще что-то Это первый уровень тестов дальше мы планируем уже какую-то интеграционку делать Ну вот это уже сложнее там Хотя бы минимальный куб какой-то поднимать и туда пытаться что-то воткнуть Но это как бы долго дорого и Да действительно такая проблема то что и сидишь смотришь учитывая количество костеров сделать интеграционные тесты интересная вещь Ну как бы нет предела совершенству операционные тест вот я видел два человека маленький еще вопрос про тераформы модулю упомянули вы держите их в своем рождестре или это просто папочки вообще да тут есть да важный момент модуль же это не провайдер Это для провайдера в принципе registry необходимо модуль можно в дике держать Это в принципе это просто портянка по сути целик вот мы держим у себя Привет Получается вижу две такие большие больные точки отказа потенциальные так как вы с этим справляетесь ну собственно с гитлабом Я долго я предвидел это тоже вопросы долго думал что на него ответить Но вот наверное ответ такой что если упадет корпоративный дедлаб то последнее О чем я буду думать это о том что упал кусочек моей инфраструктуры МТС как бы потеряет весь код который у него есть я думаю там придут сперва не за мной Вот наверное такой я бы так ответил вот а вот с менеджмент кластером это в принципе уже да целиком наша зона ответственности Я мельком про это упоминал это бэкапаете себе и плюс в принципе эта штука - это сама по себе стоит вас Мы можем быстро и если мы не потеряли гид самая самая страшная история Мы можем этим манифестики быстро перекатить а стоит и у нас на эти сиди за ПК прям Ну в принципе относительно процентов на 80 Наверное мы защищены Может тогда вот сразу вы перекатили что-то антираформ стоит гляну хранится если перекатили вот там ну если в инфраструктуры что-то поломать и заставить там будет проблема а вот это кстати классическая история на самом деле и я считаю что и правильно все-таки решать не техническими средствами А административными по большому итогу вот есть у нас админы никуда от этого не деться админы и так далее нельзя же как бы у всех есть там должностные инструкции просто там 8 как-то что нельзя лазать руками в инфру не как-то это не проконтролируешь захочет человек что-то испортить но он испортит я так считаю по крайней мере вылетела металлом Я кстати про него не рассказывал тут опять же вылетела Где в кубе в принципе небольшой спойлер мы быстро можем перезалить мы матч бокс используем для этого у нас используется Рем диски и Flat Car ноты информации Мне кажется эта тема можно поговорить потом дискуссионка один маленький вопрос еще успеем совсем чуть-чуть вот тут был Привет Меня Владимир зовут Я из магнита была схемка на которой было указано что в кластер накатываются всякие ластики база данных и так далее и прочее возможно в разные кластера и вопрос Следующий Для всего этого добра нужно создать как минимум бальзаков Да каким-то образом и имя пользователя это скажем так Ну такое А вот пароль это чувствительная часть соответственно Как вы с этим живете где храните Я думаю как это наверное спойлер от меня точно не в детлабе Хороший вопрос на самом деле тут я наверное криво объяснил это не вкупе все катится это вообще в принципе вся инфраструктура которая у нас есть у нас базальная тачках живут и в принципе для их тепло используется иак от наших до конкретно сейчас если мне память не изменяет кстати наверно в детлабе шифрованном виде то ли собственно то ли антиповал там это шифрованная история и хранится в отдельных еще приватных реках в дальнейшем мы планируем переехать на Волгу тут короче очень много приколов Потому что волосы почему-то обычно очень плохо дружат между собой ладно у нас сожалению вышло время если хочется это все обсудить У нас есть замечательный дискуссионка которая тоже будет транслироваться подключайтесь смотрите Я очень надеюсь Ваня мне ответить на вопрос тренировались ли они восстанавливаться из бэкапов интересные истории не под запись расскажет Спасибо большое Спасибо"
}