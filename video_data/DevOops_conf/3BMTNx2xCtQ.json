{
  "video_id": "3BMTNx2xCtQ",
  "channel": "DevOops_conf",
  "title": "Николай Рыжиков — Расширяем k8s",
  "views": 4988,
  "duration": 2832,
  "published": "2018-02-16T03:53:13-08:00",
  "text": "мы сегодня немножечко поговорим с вами про то как можно расширять кубер нить из я представлюсь вначале меня зовут николай рыжиков я художественный руководитель команды hell самурая но уже больше десяти лет занимаемся медицинские информационными системами и сейчас тут даже замахнулись начали делать платформу backend и за сервис для медицинских приложений на основе международного стандарта я участвую в разработке этого стандарта каким боком мы относимся к devops наша формула devops уже на протяжении десяти лет достаточно просто разработчики отвечают за 1 шт разработчики deployed разработчики монтень от при такой постановке она достаточно звучит может быть жестковато вот вы так или иначе станете devops поэтому есть хотите быстро и болезненно внедрить у себя devops просто заставьте разработчиков отвечать за ваш продукт они начались ребята смышленые начнут выкручиваться и пойму давайте немножко сами познакомить у кого докер в продакшне албана у кого кубер найтись production не так много а кто играл соску бернайс то есть представляет достаточно много у меня просто будет небольшая вводная часть если станет скучно вы скажете мы опустим наша история кто слышал про капистрано давно еще когда не было никаких chef автоматизации мы уже тепло или автоматически капистрано потом начали его растачивать вот чтобы он праве женил моды но потом появился чем мы перешли начав уехали в облака нам надоели свои дата-центры потом появился он sibl возник докер этот нашей историками тепло или sensible им потом мы переехали на таро форм собственноручно написанным супервизором докеров конда на канале и вот теперь мы переезжаем на кубер не this вот что самое страшное в operation кто удовлетворён и уровнем автоматизации своего operations честно руку поднимите а кто не удовлетворен вот это действительно страшно потому что так вот мы затратили очень много ресурсов и усилий чтобы все эти стыки собирает для себя of результат неудовлетворительны и это страшно есть ощущение что с кубер найти что-то может измениться посмотрим я приверженец бережливого производства и с точки зрения бережливое производство перейти на деятельность которой вообще не приносит пользу поэтому идеальный операция это но operations хотя бы operation сведенный камень и то есть ценность создается когда разработчик делает продукт и когда он уже готов вот это доставка она не добавляет ценность эта деятельность не приносящие ценностей нам нужно элемент вейст поэтому мы управимся по автоматизации для меня идеалом всегда являлся heroku для простых приложений мы его использовали где для разработчика чтобы развернуть свой сервис достаточно было сказать git push настроить heroku это занимает там минут как быть чтобы заниматься но aps можно купить на общество тоже heroku из подходит купить и потому что иначе вы потратите больше денег на разработку нормального перешли на есть ребят адреса не знаю правильно неправильно написал неправильно да у меня дар навсегда ошибки в слайдах это ребята которые пытаются сделать что-то типа heroku на кубер найти съесть клауд foundry который как бы тоже вам дает платформу на которой вы можете работать вот но если делаете что-то посложнее что-то покрупнее вы возможно можно сделать самому теперь вместе с докеры мы кубер нить из потенциально это становится как бы задачей выполнимое за некие разумные сроки с разумными затратами когда-то это было слишком жестко совсем чуть-чуть сделаю введение про докер кто не знает вообще штука и докеры с ним не работал вообще все знают да самое важное для меня в докере то что он разбил на две части одна из проблем операций на это повторяемость но когда гоняем наши once i был рецепты лечо водку кабуки и не всегда повторяется до что прекрасному привнес докер он разбил на две фазы у нас есть фаза билда как мы сбил деле этот контейнер как мы этого добились неважно если мы его сбил дели и он работает дальше он с большой вероятностью будет работать это очень важно второй момент который радует в докере то что он нам дал универсальный интерфейс для запуска произвольных сервис кто-то собрал это докер что-то внутри него положил операцию нам достаточно сказать докера и запустить и это прекрасно это отличная абстракция поверх которой можно двигаться дальше в частности кубер нить из туда и двигается то есть что такое кубер нить из это платформа могут мы сделали докеры нам нужно где-то запускать объединяет конфигурировать связывать друг с другом кабинете позволяет вам это сделать достаточно интересно так как uber найти свой отряд абстракции которые называются ресурсами мы быстренько по нему пройдемся и потрогаем их даже попытаемся по создавать 1 абстракция это под вот этот набор контейнеров очень грамотно они сделали что сделать именно набор контейнер ни один контейнер взяли за абстракцию а некий набор контейнеров которые могут шарить между собой волю мы которые видят друг друга через локалхост вот и это позволяет вам например использует такой паттерн как сайт карт слышали про слитка очень это когда мы запускаем основной контейнер а рядышком есть это вспомогательные контейнеры которые делают работ например из основной контейнер этапа сгрыз он пишет володе и чтобы этот контейнер чтобы в него не hard ходить как мы эти в володе там shippin куда-то да мы просто рядышком поднимаем другой контейнер который например забрасывает то в истре баки и таким образом вы можете как бы бороться с вариабельностью то есть вы можете добавлять эти сайт контейнер есть другой подход который называется ambassador это когда вы не хотите чтобы контейнер думал где находится какие-то сервисы вы ставите рядышком контейнер который знает эти сервисы лежат и они становятся доступны вашему главному контейнер упала колхоз таким образом у вас весь январь им начинает выглядеть как будущий локально работать давайте поднимем падик посмотрим как под описывается локальная можно разрабатывать mini cube он выживает кучу себе она позволяет вам на virtualbox и поднять на вашей машинки маленьких uber notice кластер из ним играться мы и будем играть нам давайте за диплом под вот это ресурсу написан я мало можем джейсоном описать чтобы его за деплоить нам нужно сказать давайте сразу сделаем алисе к небольшой например кубер на теплой скажем к вот и запла им наш ресурс под в кубер найтись а эй видно на я сказал кубер найти сапплай и залил подвиг я могу посмотреть какие у меня есть под и вот я вижу что у меня один бот за диплом от означает что кубер найти у себя там запустила эти контейнер я могу даже зайти в этот контейнер сказав кубер найти сексiq вот я уже внутри контейнера тут никакой истории нету могу выйти из этого контейнера могу посмотреть логи с этой точки зрения кубер найти сделан для людей действительно то что мы постоянно делаем в эти решения в обвязке кубер нить из а вот например это утилита юбка цель позволяет вам делать это ваши рутинные операции все достаточно легко дальше если мы с вами например следующий интересный ресурс то есть под он смертный он запускается это как докер рано если вы кто-то остановит никто его не перри поднимет поверх этой абстракция кубер начинает строить следующие абстракцию например реплика сет это такой супервизор который следит за потом следит за их количество можно сказать сколько таких кодов поднять если где-то под и падает он их перри поднимать это тоже очень важная важная концепция самоизлечение в кубер найтись и вот который позволяет спокойно спать по ночам потому что кубер notice будет пытаться перри поднять эти контейнер вот поверх реплика сета у нас есть такая абстракция как deployment тоже ресурс вот которая позволяет нам сделать с вами зиру time deployment то есть она под ним у нас работает один реплика сет когда мы делаем тепло и меняем версию контейнера например нашего внутри deployment а то поднимается другой рипли кассет мы дожидаемся пока эти контейнеры стартануть своих лифчики пройдут и потом мы быстренько переключаемся на новый replicas от той же классическая хорошая практика так ну давайте поднимем простенький сервис например вот у нас есть диплом and deployment внутри как бы описывает шаблон поду в которой он будет поднимать мы можем применить этот deployment зачем посмотреть что у нас есть вот эта интроспекции это очень круто то что сделано в кубер найтись и все лежит в баски данных и мы можем смотреть что происходит нашей системе так юбки tl get вот мы видим один deployment если мы попробуем посмотреть на наши коды мы видим и поднялся какой-то падик что важно что я могу взять и сказать удалить этот подвиг забыл сказать что я удаляю именно под вот я его удалил смотрим что у нас происходит с кодами у меня один уничтожается а второй уже поднимается это моя реплика сетка контроллер запустил не нашел тот под который должен был гнаться совсем съехали и запустил другой под так дальше если это у нас на примерку это веб-сервис над ним нужно сделать или внутри наши сервисы должны связаться нужен какой-то сервис рисковать нужно дать этому сервису имя нужно дать ему точку входа и для этого кубер notice нам предлагает ресурс который называется сервис он может заниматься вот балансиром отвечает за сервис discovery вот давайте посмотрим на простенький сервис вот у нас сервис мы связываем его с deployment ом и спадами через лейблы такое динамическое связано тоже очень важная концепция кубер найтись и что система динамическая в каком порядке это все будет создана неважно сервис будет пытаться найти коды с такими лейблами и начать их лот баланс оплавим сервис смотрим какие у нас есть сервис и вот она поднялся сервис например заходим в наш тестовый падик который был поднят и пытаемся сделать куру на моей серп давайте вначале сделаем ns lookup сервис нам дает кубер найти нам дает внутри dns q через которую ваши сервисы могут друг друга видеть обнаруживать сервис это скорее некий интерфейс там есть несколько разных реализации задач его balancing и сервисом достаточно сложное дамы одним способом работы с базами данных другим способом с нагруженными какие-то простые мы делаем совсем прост и это тоже важная концепция в к убираетесь что некоторые вещи скорее интерфейсы чем реализации и не жестко закреплены и разные например там те же облачные провайдеры дают разные реализации например есть persistent валим ресурс который уже в каждом конкретном облаке реализуется своими штатными средствами там в амазонии ты будут и bs подниматься это грамотная . расширения дальше мы обычно наш веб сервис хотим вывести куда нибудь наружу хорошая практика это все спрятать за некий джейд вей в купер найти есть абстракция ingresso обычно там же какие-то цели добавляют вот самый простой ingress выглядит как то так мы там пишем правила по каким ур лампа каким хостом какому сервису внутреннему перенаправлять запросы мы точно также можем поднять и на шынгыс после чего я у локально хостах у себя прописал последней строчке вы видите теперь можно этот сервис даже увидеть отсюда который мы с вами развернули пой давайте так чудом живут сейчас очнется уйди это такая штатная задача то есть мы развернули там некий веб-сервис чуть-чуть познакомились кубер найти сам давайте все это зачистим чтобы она нам не мешала давайте удалим сервис посмотрим марсе наш ресурс учета лишь не осталось мы можем и ingress удалить поехали дальше вот приблизительная картиночка есть еще ряд ресурсов например конфиг map ее секреты это чисто информационный ресурс который вы можете заполнить ваш контейнер перед и передать туда например там пароли от под grease вы можете это связать с января мид were его некоторые будут яндекс тиц и в контейнер и когда не запускается можете замутить файловой системы все достаточно удобно стандартные задачи симпатичные решение есть persistent валим вот некий интерфейсы которые опять-таки реализуется по-разному у разных провайдеров он разбит на две части у нас есть перси сам полем клеем это запрос потом к создается канте и блеска и она точится к вашему контейнер можно работать состоит full service так как это работает внутри кто разбирался с внутренней архитектуре кубер нити отлично рассказать интересно или не очень прикольно что сама концепция очень простая и прозрачная убирать состоит из двух частей одна часть это просто база данных в которое у нас лежат все эти ресурсы ресурсы можете мыслить как таблички вот конкретный эти инстанса просто записи в этих табличках поверх него настроенный 5r когда у вас есть и 5 класс губерн этих мастер вы обычно общаетесь цепей сервер с ним разговаривает клиент соответственно вот то что мы создавали поводы сервисе тогда ли просто пишутся в базу данных это база данных реализовано идти сиди так чтобы она там была устойчивой a highly available вот что происходит дальше дальше под каждый тип ресурсов есть некий контроллер это просто сервис который следит за своим типом ресурса и что-то делает во внешнем мире например делает докер ранда если у нас есть какой-нибудь есть как например ресурс под вот на каждой ноги есть тебе лет сервис который следит за кодами код который защиту ли на эту воду и все что он делает а просто сделать docker ран если этого кода нет периодически проверяю дальше что очень важно поскольку это все происходит нас в реальном времени . хошь на ресурсы в шейке или там модуль иван земли до местное что это работает все в реальном времени поэтому мощность этого контроллера выше то есть например этот контроллер зачастую снимает ученик и метрики и смотрит за тем что он запустил вот то есть снимает фидбэк вот из реального мира и тоже его записывают в базу так что вы могли посмотреть или остальные контроллеры это видели то есть тот же статус пода как бы будет записан обратно витязь иди вот и все таким образом в кабинете реализовано всю как бы все и очень прикольно что отделена информационная модель отделена от операционной модели в баски данных через обычный крут интерфейс мы декларируем то что должно быть а потом набор контроллеров пытается сделать так чтобы она была так вот на самом деле так не всегда получается это кстати то почему эта кибернетическая модель кто слышал про кибернетику у нас есть некий присед иска эта машина которая пытается как бы направить реальный мир там или какой-нить автомат в то место которые сказали не всегда так получается т.е. у нас должен быть петля обратной связи иногда машина этого сделать не может и тогда она должна обращаться к человеку здесь у нас контроллер мог бы обратиться например в чат апсо сказать не могу поднять базу все ресурсы закончились осознали модель очень проста очень прикольно но в реальных системах мы мыслим абстракциями следующего уровня у нас есть некие сервисы у нас есть база данных там какими кафки мы все это связываем мы не мыслим кодами мы не мыслим энгри сами и нам хочется построить некий следующий уровень абстракции так чтобы ли разработчики это было максимально просто чтобы он просто сказал хочу запустить такой сервис а вся остальная конфигурация произошла внутри хочется некоторой декоративности кто пользуется холмам вместе с кубер на кто пользуется кубер найти сам ну-ка то есть не все кто пользуется кубер натиском пользуется хэллоуин да о чем вы пользуетесь тогда просто голый купер нас отличный хелм это холмса гсх all wrong way сразу скажу это штамм plaything в стиле ansi было где мы соответственно просто пытаемся породить набор с configure он их ресурсов вот и закинуть их в кластер кубер нить из в чем проблема проблема во первых то что это выполняется только в тот момент когда вы это все накатывается то есть много логики он не может рисовать проблема в том что в ранта имеет абстракция исчезает когда я иду смотреть на мой кластер я вижу просто пода и сервис я не вижу что там за dipline какой-то сервис штампа не это такая эта база с репликация просто вижу там десятки под of abstracts исчезает как макросе вот их в runtime не существует с другой стороны самку bernie this уже внутри дает очень интересную простую модель расширения мы можем объявлять новые типы ресурсов например как deployment да это ресурс построены поверх кодов или реплика set мы можем написать контроллер к этому ресурсу положить этот ресурс базу и запустить нашу генетическую петлю чтобы все работало и это звучит достаточно интересно и мне кажется это правильный путь расширять кубер не this мы сейчас на это и посмотрим чтобы хотелось хотелось бы чтобы я в стиле heroku вот просто написал некий манифест для своего сервис сейчас очень упрощенный пример ну вот надо понимать что его дальше можно растачивать если я хочу за тепло эдька это приложение свои реально в своем реальном январь иметь у меня уже есть это соглашение уме есть с целью меня куплен домен и я просто хотят как вот для разработчиков хотел бы дать максимально простой интерфейс он не говорит какой контейнер поднять возможно какие ресурсы еще нужно этому контейнеру вот он закидывает в кластер это объявление все начинает работать хочется так давайте dance да мы сделаем свой д.с. как это будет выглядеть с точки зрения кастомных ресурсов и кастомных контроллеров вот у нас будет лежать в базе ресурс applications назовем его так вот и апликэйшен контроллер будет порождать сейчас в примитивном случае вот эти три ресурсы то есть он будет прописывать в инглис правило как крутить к этому сервису запустить сервис для лот баландин к и запустит диплом ментам с каким-то какой-то конфигурации так ну пошли давайте это делать перед тем как мы создадим кастомный ресурс губер найтись и нам нужно его объявить да как в базе данных создать табличку для этого у нас есть такой метр ресурс который называется кастом ресурс дефиниций счастливо вам напечатаю в ямале потому что возможно в кого жюри не всем комфортно смотреть хотя приблизительно напиться один в один так очнулся для того чтобы создать новый ресурс объявить новый ресурс кубер найтись и нам достаточно заплатить вот такое объявление считайте это crate ты был внутри базе кубер не this ну вот мы и создадим эту табличку вот мы и создать этого мы через например можем посмотреть как это юбка tr get какие у нас есть спать и ресурс как только мы его объявили у нас еще я пичко на него появилась мы можем делать например вот так крепка цель get up прекрасный пока никаких апов нету давайте туда какой-нибудь об запишем то есть теперь уже мы можем сделать кастомный ресурс instance вот посмотрим на него в ямале это то что мы обсуждали то чего мы хотим и создадим него просто постам на определенный url после чего он создался если мы побежим и 4 через кубка то посмотрим вот у нас появился один об но пока ничего не происходит вам просто лежит в базе данных то есть я могу например взять и запросить все об и ресурсы пока это просто крутик на 3 7 вот можем создать второй такой ресурсе из того же там plateau просто поменяв у него имя посмотрим какие у нас есть опа вот есть 2 ресурс так двигаемся дальше дальше наш контроллер должен делать там темп leaking похоже на то что делает hell да то есть получив описание нашего оппа я должен сгенерить и ресурс deployment я должен изменить ресурс сервис я должен сделать записи запись в энгри си вот это такой темплейт отложить самая простая часть то есть здесь лазурита эру макро я передаю структур куда нах она поддерживает функцию deployment передает и в дебаг который такой пай планчик читайте вы как pipeline в башке ну то есть и это чистая функция она принимает applications возвращаем простенький там plaything все понятно соответственно в самым наивным виде там олег я бы мог это тут же просто создать превратить в консольную утилиту и начать распространять этот темплейт описали мы будем двигаться дальше то есть мы тоже самое делаем для сервиса функция сервис принимает декларацию и генерит нам ресурс кубер не this то же самое мы делаем для строчки в энгри си все три функции которые принимают описание апликэйшен и возвращают нам кубер notice ресурс здесь вас полная свобода делаете что хотите теперь как это все будет работать у нас будет что-то в реальном мире это чего мы хотим то что мы хотим мы берем апликэйшен ресурс генерим по нему то что должно быть теперь нам нужно посмотреть что есть что есть мы просто через растопи шишку запрашиваем то есть вот например мы можем получить все сервисы их там сейчас не будет пошуми ничего не сделали все deployment и это мы написали дальше как будет работать наш кастомный контролем он будет получать то что мы хотим то что есть брать от этого div некий патч вычислять и применять его кубер notice это похоже на что-то с фронтом хоть раз сталкивался и слышал про react это почти то же самое что react придумал виртуальный дом когда у вас какие то функции просто генерят дерево just готовых объектов а потом некий алгоритм вычисляет патчи это применяет к реальному дом и это очень прикольная абстракция то же самое мы сделаем и здесь это там делается в 50 строчек ложе кода там захотите это все на гитхабе лежит можете почитать не очень сложная просто пролистывая вот в итоге мы должны с вами получить функцию при концы лыж для начала сделаем вот у нас есть функции рик перри conceal action который ничего не делает а просто вычисляет этот div она берет то что есть берет то что нужно и получает что нужно сделать чтобы привести то что есть к тому что нужно давайте ее дернем так где мне тут рикон selection она ничего страшного не делает ее можно либо жить вот она говорит что я захочу создать ingress сервис сделать ним 2 записи создам deployment один создам deployment 2 создам сервис один сервис 2 давайте чуть удалим давайте вот наш мая сервис удалим еще раз попросим сделать река силы шин мы его не применяем просто смотрим в данном случае уже должен быть только один сервис но мы видим это например по инглишу же только одна запись остается дальше все что нам остается это написать функцию которая применит этот патч кубер найти скала стар для этого мы просто рикон сollection передадим функцию и console все применится давайте это им что произошло здесь и вот мы с вами видим поднялся под поднялся сделался deployment запустился сервис давайте добавим еще один сервис дадим еще раз в суре constellation вот он нам добавил вторую строчку посмотрим что у нас произошло все запустить все прекрасно дальше как с этим быть во все это упаковываем тоже в докер-контейнер пишем функцию которая периодически просыпается дела и три конца его засыпаю для нас тут скорость не очень важно можно спать по пять секунд и как бы делать в туре constellation аппликация но все-таки будет там на сотни не будет тысяч вот есть watch и пьян где мы можем подписаться на изменения к у тори типы ресурс если нашивку бернайс отвратительная визовому теперь это связано с внутренними характеристиками потому что идти фидить в идеале мы там подписываемся на получение сообщения об изменении этих ресурсов когда ресурс добавлен мы видим что произошел event добавление ресурса но к сожалению стоите city делает compaq шин как бы периодически этот face переломается вам заново все надо доставать и восстанавливаться и снапшоты поэтому для простых случаев можно это даже не делать ну соответственно наш кастомный контроллер это будет просто сервисов которые дальше будет просыпаться периодически вычислять патч вот и что-то делать пойдём сюда сейчас у нас два сервиса с дипломы на давайте удалим один из одно из приложений например там мой сервис посмотрим как отреагировал наш кластер мои сервис удалилась давайте удалим и 2 я сервис смотрим что произошло 1 1 почистилось давайте теперь посмотрим глазами разработчика для него нужно просто сказать кабир найти сапплай мой следующий сервис тамаре one говорим кубер найти сапплай объему наш контроллер это все подцепил и создал прекрасно работает осознали дальше мы это собираем просто в deployment в сервис и штатными средства кубер notice а вот этот наш кастомный контроллер закидываем в классном мы создали абстракцию абстракции это стоило нам 200 строчек кожи кода но на питание на на чем угодно будет столько же идиоматические наверное записать на голову я к сожалению ненавижу this и программе нами да это все похоже на hell частично вот но это мощнее чем фильм потому что ваш контроллер работает в кластере он видит базу он видит внешний мир и вы вы можете сделать достаточно умным сейчас я покажу некоторые примеры как мы расширили кубер найти смывкой то момент сели и меня настолько взбесил дженкинс ну вот ну точнее как цепочка логической мы решили что seo и должен быть частью инфраструктуру то есть всегда когда ты разворачиваешь там новую инсталляцию внутренние должен сидеть и он должен жить там внутри это хорошо это удобно с точки зрения security там приватный репозитории мы пытались использовать ним сити пытались использовать дженкинс но это устаревшее средства и четном там на клики вать как туго разворачивается захотелось хакерского search by одной командой раз у меня вся этом есть интерфейс и все эти нам не нужны и мы как бы любим чат ops просто скажи мне в чатик что упал build или не упал плюс хотелось это все локально отлаживать мы очень любим трэвис там и circles но здесь как бы не не та ситуация то что мы хотели иметь ее внутри свою мы сели и за недельку написали свой сачек просто как расширение кубер на если задуматься над я им это просто инструмент который запускает некий джоплин в рамках этой джо бы мы там что-то билде прогоняем тесты зачастую тепло и вот так это совсем плохо ботает она построен на такой же концепции к остальных контролем во-первых нас есть и случай территорий который говорит о том мы закидываем в убирайтесь описание какие назад химере по истории мы следим вот контроллер этого ресурса репозитории просто идет например на гитхабе на бит makita добавляет вокруг если вы там еще нет тоже достаточно просто и у нас остается интроспекции есть я могу посмотреть моим инвар мити что мы там builders дальше нас дергается web хук там что же такое вот так я не буду двигаться дальше нас приходит web хук единственная задача которого обработать входящие тот же сончик и скинуть его в кастомный ресурс build который тоже складывается в базуку вернитесь за ресурсам build у нас следит build контроллер который считывает манифест который лежит внутри проекта и запускает под частности в этом коде запускается все необходимые сервис нам нужен позарез кафка как бы они просто рядышком запускаются вместе с ним в позе очень простенький агент который читает декларацию в стиле там трэвис или circles я я в яму ли там набор шагов и он их начинает выполнять после чего в конце билда он закидывает свой результат в telegram другой она из фич и которую мы получили как бы вместе с кубер найти сад о том что одной из команд вот в выполнение ваших вашего к seo или continue зелень можно построить поставить просто wilder у slip 10 как бы у вас ваш под зависит на этом шаге вы делаете до кубка это эликсир и оказываетесь внутри вашего билда и можете его де бо жить другая приятная фича это то что все построено на docker ах и отлаживать это ваш скрипт можно просто локально запускаете докер даже да это докер клиент способен работать локаль вот на все про все ушло две недели 300 строчек тоже кода куча идей как куда это все расширять уже все работает вот что-то ломается мы тут же чиним это маленький очень простой микро сервис который выполняет свою задачу разворачивание там в новой инсталляция занимает несколько минут дальше мы сейчас наш продукт построен на полюсе мы используем всякие там интересные фичи позже сами написали ряд extension of вот поэтому к сожалению мы не можем там использовать rds или еще что то все очень просто когда у вас стоит лес контейнер и все становится сложнее когда у нас даже нет не только когда вас стоит в контейнерах и когда у вас есть стоит за ним нужно следить и вы за него отвечаете головой это данные пациентов то мой врачей я уже почти закончил соответственно сейчас мы в процессе разработки не у оператора для не убиваемого под gris я озвучу как бы архитектуру опять таки я хочу просто декларативно сказать кластер дай мне под глэсс который нельзя убить сказать что мне нужно там 2 асинхронные реплики 1 синхронная реплика бэкап и дело ежедневно до ему там до терабайт в идеале даже не говорит чтобы там он сам разъезжался если нужно я это все закидываю дальше у меня кластер контроллер начинает заниматься оркестрация разворачивания моего контейнера вот он создает pg instance ресурсы которые отвечают за каждое место спускайся на этом у нас будет кластер пузырь дальше пока instance контроллер достаточно простое он просто пытается запустить там под или deployment или стоит фулл сет с этим под гриссом вот сердцем является persistent волюм вся эта машина берет полный контроль над под гриссом то есть вы даете докер-контейнер в котором есть только binary под grease все остальное конфигурацию поднятие там создание стартового кластера подрисовываю делает сам контроллер и он над этим иметь полный контроль так чтобы мы позже могли ри конфигурировать так чтобы он мог настроить репликацию там уровне логов и так далее то есть начали временный под проезжается поверх persistent валиума и создаёт там возле скло стар для мастера потом поверх этого запускается deployments мастером потом таким же образом создается persistent волюм уже другой под проезжается сделает базовый backup стягивает его и потом поверх этого запускается deployment счастливым дальше у нас соответственно кластер контроллер как ему описали бэкап и создает backup ресурс ничего не делать просто создает du cap ресурс a backup контроллер уже например берет его и закидывает в какой-нибудь астрид сделает базовый бэкап и закидывает в истре но здесь придумать можно много всего каждый сам по себе этот сервис достаточно прост в целом как бы work in progress да и я почти закончил давайте представим с вами будущее если мы может так получится за что мне нравится scooby знать что рано или поздно у нас будут вот такие интересные кастомные ресурсы кастомные контроллеры что я скажу дай мне postgres дай мне кафку поставим миссий и все это запусти и вместо там яма лапши в хелми как бы я вот по пишут ровно те три ресурса если меня не получится я пойду и сделаю свой контроллер на этих ресурсах вот это ближайшее будущее следующие будущее я как вот декоративный программист как бы выше функционально программе только логическая реляционный программеры самые декларативное там у нас operations семантика полностью отделена от забыл слова информация семантики если мы посмотрим внимательно на наши кастомный контроллер который мы делали или но что делает hell вот у нас в базе лежат например ресурс applications а мы из него выводим еще три дополнительных ресурсов это очень похожи на верху в базе данных да это выведение фактов это вот лоджи calibration 2 а вот следующий шаг для кубер nights out' мне кажется повышение уровня абстракции это вместо вот этого рубленого rest api дать некую иллюзию реляционной или даже логической базы где бы просто написал правил поскольку у нас рано или поздно все стекается в базу включая фидбэк то правила могут звучать так если нагрузка увеличилась на столько подними мне еще несколько там увеличить аппликацию так то у нас будет маленький такой es que el искали правило до или логическое правило на вот достаточно дженерика движок который затем будет следить и он нам все это будет давать но это светлое будущее может быть кстати там через годик я какой прототип покажу все интересно был я закончил можно про а ну вот и что наша и что под guys конечно буду консорт все это вот я тоже удивлен потому что в кабинете заложено модель расширения они сами ей пользуются а почему-то мало кто осознал что из этого можно построить мир будущего но ребята из скоро у вас они ввели понятие операторов до этого приблизительно том же у меня много вопросов наш топ 20 набралось мы тогда с тобой ты задай самое главное мы я задам самой главной вы почему-то ну очень мало использовали слово оператор хотя сейчас наверное штук 20 операторов уже есть работающих есть операторов несколько я знаю для postgres а мы ни один продакшене использовали ну то есть вот этот вообще паттерн архитектурный называется оператором я хотел обратить ваше внимание что вы зачем там в операторы рассчитывайте разницу есть вашим контроллером расчитывайте разница вам нужно знать как было и и и как сейчас вот дельту зачем если эта функционал cabernet оса то есть зачем если в купер не цепей уже декларативная логика зачем вы в контроллере рассчитываете разницу а как ты удалений но хорошо мы можем посмотреть только то что надо удалить лишние ресурсы это единственное что нам нужно но приблизительно это и делает ну то есть речь пойдет не о том что мы управляем то есть тот самый важный момент с губернатором это декларативный объем но он не найдя лара дивный для простых вещей типа холма да где мы просто из базы что-то прочитали как бы home просто оплатит все надежды на то что кубер найти с использовал если мы заходим чуть дальше и у нас мы еще пользуемся данными там фидбэка и так далее нам все-таки придется что-то делать вот эту разницу я просто показал то место что здесь вы можете заложить эту логику что у вас например ваш пост grease канта контроллер может проверять периодически что мастер жив что вари аппликация работает и вас на основании этих данных он будет предпринимать какие-то действия спасибо обязательно подойду к вам дискуссионный комнату мне очень маленькая реклама простите я полгода назад убил месяц на то чтобы сделать доклад про губернатор и его сделал на другой конференции наш опыт кубер нации если в google видете я очень подробно на пальцах за 45 минут разложил все в деталях про кубы вот поверьте это того свершит докладчик потенциальный ловил желали дни в поймал да пора оператор я немножко забыл мне было там что ребята из коры у вас как бы эту концепцию сформулировали назвали операторами но вот хотя говорю как концепция заложено в самом кубер найтись и сам губернатор расширяется новыми ресурсами да еще вопросы время есть я вроде даже все будем писать оператором меня вопрос по поводу масштабирования нас здесь все программирование нам как заявили накинуть а вот эта база до которую используется купер на этот саммит и цдк убеждаться в ней хранит свои ресурсы их наверное не так много да много обычные стали от и 10 это battle.net плохая база чтобы хранить данные в я вас я вас есть возможность использовать какие то другие хранилище там есть . ружье или нет просто я вот просе айда на зале а билдов же миллиону могут быть зачищаешь да они постепенно к 1 перекидываются в более дюрер был там на ис-3 куда-нибудь или в баке такова логика это ну то есть это же но это же не контроллер не почему контроллер может периодически там 1 час просыпаться и вы вырезать хвостом или раза в день а ваш билдов сколько вот на ваших данных и ну наверное ну да но подчищаем да нет это известная проблема даёте сиди плохая база это баттл не как раз вот для кубер найти со будем надеяться ли боитесь иди росточек у них его чипе отвратительные зайти сиди я бы просто в кафку писал все события как бы из нее бы остальные контроллера все это читали чтобы она никуда не исчезала когда эти сиди compaq шин сделал плюс еще ценность ресурсов built on a меньше чем ценность ресурсов огня кейджа примеры хранить в базе это наверное но здесь там если интересно архитектурно да то есть например прикол с билдом в том что ты вот он мы по верху куда запускаем ресурс build могли бы сразу запустить под с тестами но здесь мы дико у плен и ты можешь дать кнопочку которая просто создать ресурс бил там мальчик нарисовать и запускать build руками или еще каким-нибудь образом магическим а если мы будем собирать heroku мы в конце вот такого симайя на вот например там объявим что это у нас там кожи проект и он уже будет знать как построить docker и как все это закинуть ну то есть тут просто гибкость как вы сделаете это уже ваше решение начинаете с простеньких но вот сам купер notice получается пытается decal при чтобы как бы один контроллер выполнял одну конкретную задачу так проще мысли хотя в runtime они могут вращаться в одном точно кабель эти как раз поднятом менеджер контроллеров там не как контроллеров как бы в одном сервисе висят но логически потенциально чтобы их можно было разнести а еще вопрос пассию вы абсолютно верно сказали что там дженкинс ten city умерли но потому что у них нет той самой декларативные лайки мы не можем описать файле какой должен быть чай но вы абсолютно верно сказали что есть трэвис замечательным ямам есть битла вся и замечательным ямам и гид лап сайта в отличие от travis может быть сил хаоса твоего рассматривали или просто пропустили или в чем-то он вам не подошел то есть но это врача могла зачем же вам не подошли сжигался и толстая машину мы храним все таки на гитхабе и набит bucket то есть где хранить код у нас есть дальше от я и пытаюсь подумать если нужно просто запустить не под который с configure ну то есть макет pipeline себя так понял что он не доделаны какой-то вот это и бесит у нас 300 строчек ложе кода под полным контролем мы сделать с этим себя и можем хоть то что хотим ну вот и он достаточно просто было расширять любую сторону то есть вас вот всерьез проводилась оценка или просто вы привыкли там не мы уже всем пользовались сми мы всем пользовались даже на некоторых проектах еще остались и дженкинс и тем сити как бы они вращают lapsi у меня вот в git lapsi попробуем то есть все таки не смотрели нашли у себя запускайте я шучу нет хорошая штука я знаю есть отзывы о том что это прикольно как бы но хочется простоты мы же дети резчики и он хотел простоты завещал простоту вот мы делаем слишком просто на почему велосипед да он как бы он выродится вот если мы говорим про seo иную часть как был гари тубер найти сделает две трети того что нужно царь остальная одна треть тот как бы эта маленькая нашлепка сверху трости спасибо а король фидбэк получаете развалившихся в билдах завалишься в катах когда build упал до ноты через и пиа и кубер не tissot можешь следить за кодами что с ним произошло до сети под сломался вот то мгновенно фидбэк в позе запускается еще простенький агент вот если агент не сломался он тоже тебе даст фидбэк что все упал и какая у вас там в телеграм и такой либо бил ток либо build почему собственно ну в смысле хотелось посмотреть в лоб сборки ну да видно на его тлог а ну то есть ссылка есть он закидывается на до в bucket такая ссылочка в telegram прилетает и штука следующая идея вот все-таки продвинуться ближе к чату псу и ваши контроллеры могут разговаривать с людьми через telegram в частности про пузырь из когда мы думали как бы операция failover а иногда опасны поэтому в принципе контроллер мог бы минут десять спрашивать в чатике админа слыша действительно хочешь чтобы я автоматически за файла wheels но ты админ может быть ему успеет сказать 100 и дружище как бы и такой ситуации крис гекла бы мне будет ну смотря насколько ну да наверное да ну например там про тот же файл over мне кажется как бы в стиле netflix а надо просто постоянно делать switch over чтобы для вас переключения мастера была штатная операции тогда гораздо меньше вещей которые могут пойти не так поначалу будет больновато но потом кого это не хаус monkey конечно но просто делаете 1 неделю switch over для такой вопрос разработчики больше вот мы подготовили новый докер и мощь собрали его собственно как вас при будет происходить и обновления всех файлов то есть мы просто меняли версий докера это докером он же как вас будет происходить обновления всех дипломат файлов так далее так как он просто отдайте deployment ресурс ставит другую версию дачку верните самый то есть что разработчик потребуется сделать чтобы разработчику придется сказать кубер найти сопла и и закинуть туда свой обновленный а п п яму либо на seo и написать одну команду которая будет звучать как удалить и сапплай мой новый яму то есть принципе на себя это будет одна строчка чтобы такой простенький сервис сзади play"
}