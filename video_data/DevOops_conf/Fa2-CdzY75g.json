{
  "video_id": "Fa2-CdzY75g",
  "channel": "DevOops_conf",
  "title": "Артем Мещеряков — Умный DNS: вариации и области применения",
  "views": 740,
  "duration": 2483,
  "published": "2024-10-25T02:31:06-07:00",
  "text": "Всем привет Привет Артём Как тебе настроение супер боевое Взаимно здесь рад видеть тебя расстояние 4000 километров очень рад видеть тоже Ну что всем спасибо кто присоединился для меня лично было восьмерки все у тебя работает сдала записи сайт тебя уже онлайн до тех пор пока тёмный Рассказал мне новых возможностях применения Надеюсь что это доклад и вам откроют Новые горизонты и новые видения того как уже стоявшиеся надежность можно применять Да список большая начнем еще разок представлюсь я этим меньшевиков дивопс инженер компании Global dots сервисная компания Мы представляем услуги delops как сервис Сегодня я поговорю про DNS Я впервые воспользовался вот где-то год назад Это этим сервисов узнал открыл его для себя узнал что бывает умный DNS современный примерно до этого было представление как у Александра но потом я понял что это может быть гораздо интереснее чуть-чуть представлюсь Я из Новосибирска меня за плечами 13 лет войти из них 5 последних лет это интенсивный дивопс и все вот эти Наши Любимые слова как губернатиз облака мониторинг безопасности всем этом очень глубоко плаваю из хобби очень люблю читать книги играть на барабанах занимаюсь теннисом Ну и все стандартный такой набор devops удаленщика сначала дисклеймер небольшой я буду говорить про поставщика услуг нсн Но это конечно же некоммерческая презентация Мне никто ничего не платил Хотя Было бы неплохо я просто поделюсь именно инженерским опытом как я этот сервис использовал для своего проекта расскажу там тонкости то как настраивал и свои впечатления и второй дисклеймер небольшой что продажи сервиса внутри рынка России не производится но я думаю все равно доклад будет интересен тем что это и как идея для воплощения возможно и как просто расширение кругозор вот план у нас следующий пройдусь в принципе по эволюции сервиса оговорка что я буду говорить про именно веб-сервисы формате там каких-то почтовых записи не интересует а именно в приложение а дальше перейдем плавно к насвам как такое прям вершиной эволюции с очень большой гибкостью про цепочки фильтрации поговорим про API интерфейс дальше я пару слов скажу про премиальные возможности Ну и затрону важные для devops инженеров моменты как безопасность и возможность инфраструктуры как кода Ну что Давайте попробуем начать значит такая базовая фундаментальная вещь И чего мы обычно хотим от DNS чтобы клиент отправил в него доменное имя получил какой-то ответ который содержит себе запись данная зоне обычно мы а записи другие бывают но это самый популярный база данных Может быть как простой текстовый файл Ну и так как это у нас такой фундамента снова у меня дальше презентации будут такие отсылки к музыке я решил обозначить эту основу за Моцарта такая вот классика DNS что если мы пойдем немножко дальше сделаем его умнее и веду пример возможности у амазона DNS сервиса 53 там есть возможность сделать чеки то есть проверки на доступность сервиров которые отвечают за те или иные записи То есть у нас есть доменное имя и у него допустим три а записи то каждую каждую запись каждой адрес можно проверять на доступность и если что-то в дауне что-то лежит то помечать доступны и не возвращать это тоже функционал который Достаточно давно на рынке будем проведем отсылку к классике уже популярной музыки далее перейдем к такому варианту этого сервиса как Гугловский Клауд DNS которую умеет делать умную умное разрешение на DNS в зависимости от географического положения клиентов допустим у нас клиент отправил запрос из Гонконга ему прилетел сервер из Индии запрос из Мехико прилетел ответы из Бразилии и вот возможно у гугловских облачных сервисов благодаря IP то есть них глобальная доступность этого сервиса Ну это вроде как что-то такое поинтереснее и повеселее обозначим такую вариацию как Chili Peppers которые у нас делают весёлые фанк следующий следующий игрок на этом рынке он известен за очень высокую скорость ответов обычные стандартных скорости 10 11 Секунд действительно самые быстрые на рынке Ну и Здесь также своими слоями безопасности это такой действительно надежный Но что если мы пойдем дальше и DNS станет еще немного умнее здесь как раз открывается такой сервис как она слан сразу скажу это Облачный сервис но как бы отдельно от всех поставщиков облачных услуг и зависимый ни от кого пройдемся по шагам по тому как он работает у нас прилетает запрос сервиса это обычный DNS сервер То есть он работает по классическим протоколам за за кадром у нас происходит мониторинг реального времени То есть это тоже та же проверка доступности серверов мы можем проверять как индивидуальные сервера так и группы серверов Объединенных какой-то регион и помечать там целый регион недоступным можем сделать проверку по tcp То есть просто доступный Спарта и это может быть какой-то сценарий когда прям Edge сервера у нас присутствуют но суть сводится к тому что каждый ответ или группа ответов они помечаются доступны недоступны То есть это как раз таки базовые Health чеки также присутствует такая Такой слой как интеграция то есть дополнение к базовым проверкам доступности мы можем также через подгрузку каких-то данных внутренесла мы можем пометить опять же тот или иной ответ DNS определенными метками определенными данными и соответственно мы можем как полагаться на монитор который встроен так и делать настраивать свои и здесь уже логика которой мы можем сюда пришивается на может быть такой какой мы захотим Ну и самое главное что здесь нужно оговорить что инозван работает на основе цепочки фильтров то есть на каждой записи DNS мы настраиваем фильтрацию по шагам и порядок и составляющие этих шагов это все настраиваемые элементы то есть в данном случае вот есть пример шаг 1 мы проверяем жив или же Back and если не жив то мы убираем его из списка ответов на втором шаге проверяем достаточно ли он близко клиенту расположен можем использовать какие-то показатели геопроксимите так называемые то есть близость по раундтрек тайму если мы превысили какой-то порог предопределенный то убираем из списка ответов дальше проверяем какой наименее загруженный узел из оставшихся и оставляем например 3 из них ну и последними двумя шагами мы просто перемешиваем результаты чтобы не отдавать один и тот же первым и берем из этих трех Один Первый отдаем клиенту и таким образом у нас получается что есть какой-то ряд первичных условий по которым мы оставляем записи и есть также балансировка вот этих вот ответов между разными узлами а ну и вот это уже такие более интересные гибкие модные современные возможности давайте мы тут делаем отсылку к такому вот хипстерской музыки скажем что это выкинут значит какие у нас основные могут быть области применения когда таких вообще сценариях это может быть вас может быть нужно Ну во-первых все больше и больше есть необходимость балансировки трафика между различными облачными провайдерами когда мы не замкнуты внутри одного облака а имеем наш сервис и распределенными в разных облаках или используется различными cdn провайдерами или у нас есть разные точки входа в инфраструктуру тоже распределенный может быть по разной географии и обычно мы хотим чтобы у нас был какой-то вот первичный пунктом входа трафика был какой-то балансировщик но балансировщик это уже следующий шаг после разрешения доменных имен А если мы это сделаем на уровне именно DNS ответа то мы и в общем-то уберем необходимость балансировщики А DNS сервис Он и будет эту роль выполнять в данном случае также ГИА роутинг как я уже говорил то есть мы смотрим местоположение клиента и подстраиваемся под него Ну и также мы можем можем управлять трафиком в зависимости от загруженности узлов от доступности каких-то вот сервисов от самых самой доступности сервисов у нас Бывают такие случаи когда большие большие провайдеры уходят в на несколько часов и мы даже таких вещей таких обстоятельств этим защититься Ну и любые другие данные здесь гибкость за счет того что мы управляем любыми любыми кастомными данными привязанными к DNS записям мы можем настраивать любую логику которую мы хотим значит давайте посмотрим на цепочки фильтров внутри интерфейса NS One чтобы понять Какое бывает разнообразие Вот первая группа это как раз географические фильтры это может быть страна может быть регион может быть просто расстояние до клиента может быть какой-то fansing на уровне подсветей Hells checky то есть проверкам доступность может быть базовая типа жив не жив может включать себя нагрузку То есть это вот именно встроенная возможности насвана может сам проверять нагрузку может по количеству соединений принимать решения может по количеству запросов просто хранить в памяти количество запросов на тот или иной узел и зависимости от этого принимать решения также целый ряд возможностей про управление трафиком такие как обычный шарф стики шафл когда мы учитываем клиентский адрес и одному и тому же отдаем один тот же ответ можем добавлять ответом приоритеты также мы можем ответы группировать в разные в разные группы и на уровне групп тоже применять логику здесь действительно вот можно дать волю фантазии и исходить из расширенных так скажем требований бизнеса также есть продвинутые фильтры пульса еще немножко отдельный слайд позже скажу в интерфейсе One можно видеть такую красивую статистику как распределение трафика и он будет в процентном соотношении выводить откуда на наш наша доменное имя пришли запросы и в каком объеме рассмотрю пример того как именно Я настроил на своем проекте работаю этого сервиса и какая была вообще задача какая была требование от бизнеса во-первых был географический признак и была необходимость использовать разные седельные провайдеры в на двух разных континентах это Африка Южная Америка соответственно просто определяя откуда у нас клиент Мы перенаправляли в тот или иной сидел для всех остальных территорий запросы перенаправлялись в дата-центр исходный Origin который находился в Германии Но тут еще есть была дополнительная логика на эти узлы То есть это уже были конкретные узлы и измерял процент использование ширины канала сам сам само приложение с которым я работал Это был стриминг музыкальный видео стриминг и было важно смотреть загруженность каналов и конечно же не превышать ее потому что это не эластичная инфраструктура это были свои сервера он примес как бы возникает возможно вопрос А почему сразу трафик не отправлять но здесь так как свои сервера они уже были предоплачены то имела смысл использовать стриминг напрямую с них а на платные седин сервисы в платный кэш перенаправлять когда мы подходим какой-то границы поэтому таким образом это мера по сути использовалась как оптимизация расходов еще один пример реализации он уже не мой но другая команда в нашей компании реализовывала там чуть-чуть проще было логика но я тоже рассмотрю то есть Суть в том было что нужно было определить из какой страны пришел запрос если это была Корея или Япония Германия то в первую очередь направлять запрос если они вдруг недоступны Мы видим что там есть монитор монитор 02 То есть если он рапортует о том что эти дауне то переключается на второстепенный cdn а для всех остальных стран приоритет был ровно противоположный поэтому здесь получается сформированы две группы ответов одна связана Со странными другая не связано поэтому и фильтрация происходит так как нам нужно вот такие два примера реализации далее я покажу немножечко настройки изнутри интерфейса покажу как это все настраивается небольшой пример искусственный мы разберем Мы видим что данная зона у нас настроены есть некоторые записи вот сильны запись Play бардема это Входная точка которая основная Куда приходит клиентский трафик здесь мы допустим здесь мы настроили что трафик от Америки обслуживается сразу выбираются все страны относящиеся к этому континенту Ну и два других ответа Это Европа и Азия также сразу прописываются все страны и мы перенаправляем в другое в другое доменное имя которое отвечает за себе есть у нас фильтры все что я описывал уже до этого и видим что у нас настроены которые нам нужны то есть Азия перенаправляет азиатский некий сидим здесь искусственно все для примера но так примерно но в итоге в реальной жизни настраивается здесь допустим у нас есть какие-то наши уже сервера поэтому прописываем тип адреса которые нам нужны вот это вот метка в данном случае для примера я буду менять вручную задавать значение прямо из интерфейса Но чуть позже я ее переключу на на монитор который будет действительно вот таким образом мы сейчас будем пробовать резонный доменные имена И если в зависимости от местоположения мы будем попадать в разные различные ответы вот сейчас грубо говоря мы находимся в азиатской зоне получаем азиатский Ответ здесь сейчас за кулисами будет переключение на другие VPN сервера чтобы поменялось немножко география видим что NS One корректно идентифицирует трафики направляет туда куда нам нужно вот далее попробуем то есть мы увидели что мы перенаправили трафик в два разных сервиса переключился дальше смотрите вот который у нас настроены как бы на на Наши сервера которые которым мы управляем я пометил один как неживой и дальше я получил ответ который остался то есть ответ который 1234 мы больше не получаем Но это естественно я вот тут на пальцах это все показываю на самом деле вот эти все метки жив или не жив Они через мониторинг настраивается И вот сейчас я показываю переключаюсь на монитор и монитор он настроен на то чтобы уже отправлять ДТП запросы на определенный Кстати это не обязательно эти данные они используется то есть не обязательно используется тот ip-адрес который прописан DNS записи А вот проверка доступность она может быть настроена абсолютно любым образом то есть мы там прям прописываем URL который мы хотим мониторить то есть мы можем на своей стороне отдавать определенные Поинт который будет говорить что вот ответ вот он сейчас жив не прямолинейная связь все настраиваем так как мы захотим ну и плюс как я уже говорил там можно в этих проверках какие-то прописывает это все максимально удобно пойдем немножко дальше перейду к API как настроена взаимодействие Зачем нам нужен для того чтобы мы могли подгружать вот эти вот какие-то метрики о том или ином узле или группе узлов значит нсн предоставляют свои sdk библиотеки Я использовал питон буквально все что требуется это проинициализировать API И подключиться к дата сиду То есть datafit это как раз канал по которому передаются вот эти вот данные с нашей инфраструктуры и дальше в цикле просто сервис опрашивает мониторинговый мониторинговый Point внутри нашей среды запрашивает нужные метрики которые мы настраиваем как нам нужно и виде маленького пакета вот здесь в данном случае передает значение и это происходит каждый каждый сколько-то секунд У меня по-моему каждые 30 секунд передается значение Ну и важно конечно же этот сам сервис который передает данный мониторить Но если вдруг он какой-то причине не обновил значение то используется те значения которые уже были отправлены то есть ответ отдается такой который Последний был предоставлен с инфраструктурой поэтому важно конечно следить за тем чтобы данные всегда были актуальны и не было ошибок этого оплода дальше этот сервис работает в моем случае в кабернетисе И вот я настраиваю указываю ему опрашивать Прометей в качестве параметр даю запрос Прометей это обычный со всеми нужными параметрами которые мы хотим все это направлять из секрета достается ключи копи Ну и в общем-то все весь мониторинг весь вся логика выгрузки данных сцированных ассоциирующихся с тем или иным узлом доступно на стороне значит я хочу подсветить что взаимодействие с API очень простое буквально потребовался один день чтобы все это реализовать и оно заработало Я не столкнулся ни с какими там непонят ни с кем непонятным поведением несколькими багами То есть просто настроил попробовал отгрузить результаты увидел что они появились в интерфейсе нас want что вот эти вот меточки метаданные ассоциированные с ответом DNS они обновились и в зависимости от того какие были настроены пороги по этим кастомным данным ответы либо появлялись либо убирались поэтому простота и гибкость этого сервиса очень хорошо высоком уровне так про продвинутые возможности про то что можно получить если заплатить побольше денег значит я оговорюсь что я сам не пользовался этим возможностями но изучал что они предоставляют значит То есть у них есть некая своя внутренняя система которая содержит в себе данные мониторинга в реальном времени они опрашивают различные поставщиков сидел услуг спрашивает облака и в реальном времени мониторят скорость ответов от них то есть видят где вдруг может быть повысились и может быть сейчас не самая лучшая идея туда направлять клиентский трафик в общем это все позиционируется как продвинутая умная может быть даже где-то с искусственным интеллектом система которая за вас принимает решение куда же сейчас лучше направить клиентский Возможно это действительно работает очень круто есть за что заплатить Давайте поговорим Про некоторые аспекты безопасности пользования таким сервисом Ну во-первых с днсом У нас есть слой DNS securies DNS sec и обычно dns-сек использует заранее подписанные ответы то есть мы храним подписи вместе с данной записями и отдаем но так как у нас здесь используется динамические ответы то есть Они каждый следующий ответ может отличаться от предыдущего поэтому реализована возможность онлайн сайдинга когда подписываем каждый ответ но утверждается что без какой-либо потери скорости защита от DDoS включена по умолчанию в эту услугу то есть есть несколько слоев через которые проходит клиентский запрос на проверку его вредоносности и заведомо запросы а также есть вас представляется возможность на выделенных серверах запускать свои DNS DNS свои зоны хранить на выделенных серверах если не хочется путать свой трафикса трафиком других клиентов нсн вообще говоря они по умолчанию mult лейтенантные и весь трафик всех своих клиентов через один и тот же набор DNS серверов прогоняет но вот если есть необходимость полность полная изоляция это возможность тоже предоставляется также по инфраструктуре как кот как дивапс инженер это этот момент важно считаю важным подсветить есть телефон провайдер который отвечает за этот сервис есть все необходимые ресурсы чтобы его настроить и ну здесь просто такой пример того как у меня хранилась эта конфигурация важно заметить что я до сих пор не подсветил что ttl у DNS записей конечно должен быть минимальным на базовом уровне самый минимальный отель это 60 секунд То есть данные о dns-ах не должны быть закошированы на стороне DNS клиентов на длительное время Иначе мы не получим этот динамический динамическую гибкость Не получим самое актуальные ответы поэтому отель важно выставить ниже чем 60 секунд выставить можно по-моему тоже за отдельную плату Но если смотреть на базовый уровень сервиса то это минимальное значение Ну и Да в этом примере вот мы видим динамический блок что каждое значение нашей записи она связана с каким-то отдельным где-то на фоне подгружаем наше значение на данный момент я не знаю ни одного конкурента если есть какие-то подобные если вам известны подобные решения обязательно сообщите в дискуссии Ну кажется что все так благополучно классно суперсервис Может быть пора бежать и платить на самом деле Да он считается неким таким премиальным поставщиком у него есть бесплатный уровень пользования это 500 тысяч запросов 50 записей одну цепочку фильтров можно настроить Ну и полный доступ к интеграциям тоже предоставляется То есть это вот на этом уровне можно протестировать как работает сервис можно при желании какой-то маленький проект настроить но если мы пойдем на какой-то серьезное пользование сервисом то тариф идет 45 долларов за каждый миллион запросов который пришел 10 центов за каждую запись данной зоне и самое сердце они достаточно дорогие 90 долларов в месяц нужно каких-то несколько разных циклов поведения сделать надо будет отдельно оговорюсь про доступность у нас в стране Значит сам API и запросы DNS они принимаются и доступны тут блокировок нет но недоступен по умолчанию без VPN Основной сайт и соответственно стать новым клиентом для нас Ван я думаю будет проблематично Ну и в рамках РФ я подобных сервисов не знаю вообще у нас на самом деле сидел провайдеры пока не сильно представлены но можно подумать о том чтобы реализовать что-то интересное с доступом в разные облака облачных провайдеров у нас несколько поэтому Поэтому если говорить про практическую пользу то можно рассмотреть как отличная идея для импортозамещения и сделать такой сервис национальным оттенком спасибо на этом мой доклад закончен Я готов отвечать Спасибо большое Артём очень интересно вопрос действительно есть я Напоминаю что вы можете задавать вопросы в чате и Давайте перейдем Давайте перейдем к вопросам вопрос 1 Константина как на основании расстояния до клиента сервис понимает что нужно отдать именно этот список серверов если ти может быть в разные стороны разные страны географические или все-таки гео фильтры должны быть всегда в разные стороны географически Наверное я не смогу ответить Вот именно по этой тонкости Я думаю что Я думаю что используется какой-то первичной подключения к сервису может быть имеется ввиду Как определяется до серверов если это имеется ввиду то наверное учитывается только до клиента и мы настраиваем то есть на этапе настройки групп серверов То есть если мы их привязываем каким-то географическим регионом то мы им их явно уже ассоциируем с определенными графическими зонами поэтому дальше клиентский запрос приходит dns-сервис мы считываем его геоположение и потом считываем уже хорошо заранее предопределенную метку группы ответов и вот их соответствие их друга прибивает и отдает тот ответ который в которой мы пришли Спасибо там Следующий вопрос Давыдова если у сервисы какая-нибудь защита сталкивались доступностью самого сервиса Интересно что пользовались этим достаточно продолжительное время около года и за это время ни разу не возникло именно недоступности как я на одном слайде показал что есть защита есть несколько слоев защиты от дидоз То есть это встроено ну это встроено в сам DNS сервис но я думаю и в API они тоже используют те же слои безопасности поэтому Ну вот за около года использования и отсылки по API постоянной постоянной данных мониторинга в принципе всегда получали 200 ответ Следующий вопрос от Рената чем Это лучший вариант написать свой веб-сервис который будет схожим образом оценивать клиентов и перенаправлять и тому подобное не думаю что это лучше или хуже Это вопрос трудозатрат Да мы либо тратим свои средства и человека часы на то что пишем свой сервис и отлаживаем его добавляем в него кучу нужного функционала Ну и потом соответственно поддерживаем мониторим так далее так далее учитываются здесь Либо мы покупаем этот сервис платим за него и используем проверенный надежный сервис который это все уже умеет из коробки Ну как бы и тот и тот путь имеет право на жизнь поэтому каждый выбирает каждый бизнес выбирает тот путь которым хочет идти Спасибо Артём еще один вопрос от Константина расскажите пожалуйста на практике Было ли это полезно кроме как для оптимизации расходов в Европе падавались иены были такое что подобное отказывал свои плоды насколько увеличилось время ответа клиенту вот про то падали ли сидень или нет такого не замечали поэтому всегда когда размышляю про доступность именно сидеть серверов я конечно думаю что это очень редкие явления не то чтобы на сто процентов от них защищены такое случается но очень крайне редко поэтому Это скорее такая дополнительная возможность но не основная Выгода которую мы получаем у нас в случае Том того проекта где я работал скорее была необходимость выбора разных в этом смысле это возможность она оказалась подходящий а увеличилось ли время атлета клиенту Ну вот здесь здесь могу сказать что в общем-то нет потому что мы заменили получается один DNS сервис другим а этот dns-сервис нс-1 то есть он в принципе отвечает достаточно быстро но надо понимать что нету внутри того как он обрабатывает DNS запрос нет никакой дополнительной логики то есть вся логика она происходит в фоновом режиме асинхронно мы когда отвечаем на dns-запрос мы используем уже имеющиеся данные и уже подготовленный ответ просто этот ответ Он в динамике постоянно фоном обновляется поэтому нет здесь нет никакого увеличения времени лично Спасибо Артём на этом вопросы Сейчас у нас закончились Я Напоминаю что вы также можете перейти с нами дискуссии где мы поговорим уже под запись и также очень важно чтобы Вы оставили оценку этому докладу самом конце Это поможет нам стать лучше Ура Очень благодарю за внимание Спасибо что пришли на мой доклад был рад встрече проходите По ссылкам вот которые я оставил на последнем слайде Если хотите со мной связаться"
}