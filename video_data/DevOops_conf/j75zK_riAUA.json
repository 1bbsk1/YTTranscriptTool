{
  "video_id": "j75zK_riAUA",
  "channel": "DevOops_conf",
  "title": "Владимир Дроздецкий — Эффективное управление облачной инфраструктурой",
  "views": 305,
  "duration": 2754,
  "published": "2024-10-18T00:05:27-07:00",
  "text": "Добрый день друзья Рад приветствовать вас всех на нашем точнее докладе и собственно раз уж я его так быстро затирил Давайте перейдем непосредственно к главному человеку сегодняшних 40 минут а именно Владимир дроздецкий докладом эффективное управление инфраструктурой на коллеги Здравствуйте Рад вас видеть в зале наверное видеть вас в онлайне и пришло время начинать поговорим мы про инфраструктуру небольшой слайд немножко обо мне Меня зовут раздетский Владимир люблю все что связано и так далее мои контактики на данном слайде Если кто-то захочет отдельно пообщаться немножко люблю но не со всей силы сильнее люблю исключительно куберетесь немножко компании Магнит только у меня достаточно большое количество губернатик кластеров ядер у нас давно уже за тысячу оперативки много основ и программирования это голанка пайтон мы любим различные базы данных очереди и так далее тому подобное нижняя часть слайда обратить внимание ссылка на наш официальный github заходите смотрите можете ознакомиться как мы Живем работаем И посмотреть на наш тех радар Итак о чем мы сегодня с вами будем говорить в основном все будет проходить через практику инфраструк через код оформ как мы его используем и так далее И как говорится мы начинаем начинать аббревиатуры Я как многим из вас знакома инфраструк через кого-то Как много в этих трех буквах Казалось бы все достаточно просто все что мы можем мы должны описывать виде какого-то инфраструктурного кода версионировать его тестировать проверять мерч Квеста для него и так далее То есть применяем к инфра коду все те практики которые есть в разработке и так как мы уже давно долго и много едем с этой практикой у себя в Магните Мы порой задаемся вот таким вот интересным вопросом Всегда ли нам нужны Всегда ли Вова и задаете с этим вопросом или тоже Да расскажи же нам идея заключается в чем так как мы предъявляем некоторые требования к инфра коду Да мы понимаем что он его написание уходит Некоторое количество времени некоторыми слайдами ранее я говорил то что мы любим pastgress ластик Серж радис и так далее тому подобное конечно же у нас есть Хорошо напиленный инфракод хорошо напиленные модули но иногда разработчики приходят и говорят мамы в качестве эксперимента хотим попробовать монго тебе Да мы живем в яндекс.клауде монка там есть а модуля Нет потому что на данный момент в текущий стек э-э монго не входит соответственно как мы делаем ручками в тестовом режиме все делал диплом Почему Потому что задача дать быстро разработчику тот инструмент который ему нужен для теста Почему именно руками потому что написание хорошего модуля у нас уйдет два там три человека дня грубо говоря инженера и соответственно так как это тест заранее закладывать время под это не стоит двигаемся дальше что у нас по управлению инфраструктурой данный слайд мы видим достаточно большое количество инструментов со многими вы знакомы многие его используют конечно же форм ради которого мы сегодня собрались полумил клаудфармейшен который специфичен только для iws различные сидики это Клауд девелопмент Кит Ну конечно же система управления конфигурации был Чип и так далее и конечно же башню Кто ж я Может вам нам запретить описывать инфраструктуру на ваши дёргать а пешком Почему бы и нет инфраструкции башни да да естественно и конечно же мы смотрим Почему Потому что его во-первых очень многие инженеры знают многие используют и во-вторых он нам нравится он простой достаточно У него есть возможность интегрироваться с различными облачными провайдерами А если такой интеграции нет мы просто берем язык программирования да И пишем соответственно эту интеграцию естественно декоративное описание инфраструктура используется Hell трансформер имеет ресурс модель и хранит свое состояние в стойке который мы можем также раскладывать по различным бэкендам опять же мы не забываем что троформа есть модуль который позволяет нам переиспользовать наши наработки наш инфракод и на этом мы скажем так будем застрять достаточно много внимания в рамках моего доклада Как говорится есть староформ на данный момент некоторые проблемы в шикурп немножко нас блокирует виду определенных событий на самом деле с этим всем можно жить банально мы можем воспользоваться каким-то vpn-сервисом Да просто чтобы получить там провайдер настройки так далее тому подобное мы можем локально за кэшировать непосредственно настройки наших провайдеров и сами провайдеры мы можем использовать зеркала которые поднимают такие же коллеги как мы до для сообщества для своих коллег инженеров но здесь возникает вопрос Вообще Безопасно ли это потому что ну Доверяй но проверяй Как говорится и быть здравым параноиком не так уж плохо опять же если вы гоняете ваши инфа пайплайны внимание pipeline для инфраструктура Вы должны заботиться тем чтобы у вас был рабочий образ Опять же с установленными провайдерами и не забыть о том что это все дело стоит обновить из особенностей как я говорил трансформе есть бэкенды которые позволяют хранить непосредственно стоит где-то удаленно от машины разработчика Ну если вы один вы конечно же можете сильно не париться хранить все это дело локально у себя на рабочем месте ноутбуке А чего бы нет но все равно так делать не стоит даже если Вы один инженер всегда выносите стоит куда-то в отдельное хранилище Возьмите хотя бы минимальные С3 опять же есть альтернатива от форм Клауд есть Open Source И решение разной степени готовности разные степени зрелости смотреть надо отдельно и стрипер который я упомянул и гитлаб который весьма неплохо работает Почему Потому что доступны доступно хранение стрита абсолютно в любой версии и там есть блокировки о которых мы собственно и поговорим а Нужны ли нам блокировки бакенда свое время выполнения нашего инфраструктурного кода Вот как ты думаешь его тут надо задать вопрос с другой стороны сколько вообще нас людей будет работать с нашим тира формам как это мы уже профессионалам и растем если если я один инженер Как бы мне блокировки не нужны Я сам себя не поломаю А если у нас два человека уже как минимум не ровен час даже если вы профессионалы Да вы рано или поздно начнете пересекаться друг с другом и начнете стрелять себе по ногам поэтому блокировки в бэкенде вам нужны они автоматически помогут вам не выполнять одни и те же или разные изменения но надо одним ресурсом в Облаке скажет Извините заблокирован потому что идут работы все достаточно просто гонять обычный тараформ код это конечно весело и задорный постоянно его переписывать и так далее тому подобного таскать его из угла в уголок конечно весело как я уже сказал но это не серьезно и мы приходим к одной очень части тараформы это использование тераформ модулей конечно же первое что нам нравится это то что мы все дело можем развивать можем версионировать можем переиспользовать а также можем делиться с коллегами с другими департаментами или если мы примем решение мы все это дело можем за Open Source Да мы вот на самом деле сейчас работаем над тем чтобы когда-нибудь мы засорсили свои формодули А почему бы и нет структура типичного тарафор модуля выглядит следующим образом Да это просто разметка нашей папке redmi change Lock Казалось бы ничего интересного и хобо у нас появляется В Г все прекрасно понимают что файл конфигурации была а папка provision это папка которая хранит себя небольшой набор ролей Да и PlayBook of для настройки чего либо мы МТС Для нас это основной файл конфигурации форма А вот достаточно понятно это выводы после применения непосредственно нашего инфра кода и verybel Стив это файл конечно же с переменными вот здесь на данном слайде Есть один очень интересный прикол да многие из вас заметили я сейчас об этом тоже вам дополнительно напомню и как раз вот здесь начинается разница парадигм да то есть это да Иван и да и ту операцию например тайван разворачиваем виртуалку да и ту это конфигурируем виртуалку и по хорошему многие говорят что так делать не стоит и надо разделять все эти две сущности просто Задумайтесь об этом мы тоже периодически возвращаемся к этой истории Но миксовать на данном этапе разворота виртуальных машин их на стройку нам в принципе Ок Конечно есть свои приколы но сейчас приколы Я хотел тебе задать вопрос пока не забыл На прошлом слайде там у тебя были стало интересно они в модуль как попадают они там сразу есть Очень просто там есть два варианта во-первых есть некоторые набор самописных ролей Да ну об этом чуть позже где они хранятся расскажу они достаточно простые там буквально пара операций и некоторые мы переиспользуемые sensible Galaxy но там тоже не какие-то сильно страшные вещи там из разряда установить докер от товарища Джеффа модуль из Galaxy обновляет роли в моменте прям Нет там естественно все фиксировано получается что модуль версионируется вместе еще и с ролями которые в нем лежат сразу конечно да то есть версионируем модули при помощи тегов например тег 10 подразумевает что у нас версий был Galaxy ролики там например 20 15 меняется так модуля потому что мы хотим обновить ролик Galaxy соответственно для ролики пока ты не перестану ещё один такой момент А если роль которая находится внутри модуля Она же нужна и кому-то другому отдельно то есть вот он хочет просто ее скачать как будто бы из Galaxy то как тогда быть берешь качаешь буквально еще момент в роль в модуле для bootstrap той сущности которая разворачивает модуль Но в данном случае фокусируемся на виртуалках если кому-то надо что-то отдельно сделать в качестве теста Ну естественно он себе ну как-то поработать с этим самостоятельно потом если тест пройдут соответственно будет принято решение Ага нам нужна доп роль который будет делать топ магию она будет интегрирована в модуль вот если ты это имел ввиду Это я имел в виду Окей при разработке модулей на что стоит обращать внимание первое Не забывайте про переменные да то есть нашим подход подразумевает то что скорее всего 99 процентов тех сущностей которые используются в модуле должны быть вынесены в переменные Не забывайте устанавливать базовые какие-то минимальные значения для сущности которые помогут быстро развернуть этот модуль эту сущность за которую он отвечает Не забывайте как я говорил дефолтные значения указывать описание За что отвечает это переменная следующий очень интересный момент Это проверка корректности переменных обращаем внимание на секцию валидейшен где мы проверяем то как у нас называется условно имя баз данных Да мы подразумеваем себя что это могут быть а цифры буквы и только Нижний подчеркивание никаких тире это достаточно удобно потому что именно вас кластеров и так далее порастает прорастают дальше в нашем сервами летите универсальный дашборды чтобы потом все это не перебирать здесь получается достаточно это очень удобно Давай мы стою Call To Action закинем вот ребятам особенно Кто в онлайне Пишите в чат кто вот делает валидейшн переменных что я ни на одной работе такого не видел Неужели это мы раньше мы не делали а потом когда стали страдать среди Экспо и всеми этими делами мы стали таки все проверяем Напишите как только мы начали очень сильно как это встревать встревать да мы решили что будем проверяться вообще как бы критичные моменты должны проверяться это кстати вот ты уже говорил что мы наследуем уже все практики работают с кодом и вот это прям такой супер хороший пример что мы как бы сами себя ещё и валидируем в процессе такой знаешь зачаток небольшой типа того то есть чепуху мы уже не можем развернуть которая нам дальше что-то где-то сломает таких модулей у нас достаточно большое количество до которые разворачивать Терем те или иные сущности и в какой-то момент мы начали замечать что какие-то базовые части мы начинаем дублировать из модуля в модуль Ну например использование возьмем в пример тот же самый балансировщик инжинкс какой-нибудь BMW Harbor еще что-нибудь типа того что мы хостим на виртуалках мы понимаем что вот эта вот часть ресурса виртуальной машины у нас бежит там из одного модуля в другое они там живут как-то отдельно за ними Никто особо не следит и скажем так достаточно проблематично и у нас поднялся вопрос А нужен ли нам базовый модуль Как таковой украл у любого у меня опять расширю его немножко Вот давай действительно вот правильно Вова сказала Кстати по-моему я даже никогда не слышал о такой Я слышал что я так работал Но вслух никто не говорит действительно вот эти кусочки то там то есть там что-то поднастроить э Действительно ли они нам вообще нужны как базовые модули и вообще что с ними делать Они же не одинаковые могут быть да где-то надо одну жопку А где-то нет вот как же нам быть с этим мы пришли к выводу что нам базовый модуль нужен это вообще полезная вещь опять же мы подразумеваем что базовый модуль в нашем случае это модуль виртуальной машины у себя мы его называем дженерик модуль структура репозитория достаточно похожа на предыдущий который он показывал на прошлых слайдах опять же ритме все понятно Если был cfg provision это базовые ролики которые делают некоторую магию Ну там магия достаточно простая потом дальше мы НДФ описание провайдер TF описание провайдера оно достаточно простое используем Яндекс и в принципе там ничего нет даже фактически каких-то больших определений естественно переменной и выводы после применения структура мы МТС представлена на данном слайде ознакомьтесь пожалуйста Давайте вместе ознакомимся и зададим вопросы если кому-то будет непонятно только мы их прочтем в конце а принципе ничего интересного опять же за исключением некоторых моментов первый ресурс Яндекс компьютер наша любимая виртуалка дальше пошла секция Ну ресурсов как раз таки в которых мы вызываем которые уже будут стропит наш дженерик модуль Консул мот Консул сервис необходимо для того чтобы наша виртуалка или там какой-то сервис на базе дженерик модуля зарегалась в консуле и автоматически прометил стал собирать с неё метрики снова к спорте сама потом Да конечно То есть она будет по имени там прорастать по имени сервисы Это будет прекрасно отрисовываться на базовых дашбордах DNS отдельный да то есть базовый DNS по имени окружения имени сервисе так далее В принципе ничего простого просто собирается переменных обычный snapshot типичный но ресурс выглядит следующим образом здесь мы устанавливаем nodexporter прекрасно знает что это и для чего Ничего интересного через Local exec вызываем наш insible и дальше у нас появляется вот такая замечательная переменная коллеги кто успел сходу понять Вообще что это такое я успел я видел ранее презентацию Слушай а пока коллеги отвечают кто успел понять его пытаются вот Я вот тебя уже задавал этот вопрос Всегда ли вы хотите чтобы вас дефолтный юзер был бунту то есть это же видео Клауд и нет создает его и потом может быть Ну смотри В целом вопрос валидный да а на самом деле мы не очень хотим сильно упарываться в работу с виртуальными машинами в плане там авторизация модификации аккаунтинга и так далее То есть естественно мы могли бы все это связать с фрипой там с пользователями и так далее но так как у нас команда диопс команда это три человека вот нам вполне достаточно одного пользователя Мы в бутстропе просто прокидываем наши ключи и ходим таким образом Итак коллеги расскажу немножко Маги здесь у нас идет проверка То есть если у нас она то ip-адрес а в рамках Яндекс облака это внешняя публичная ip-адрес не пустой соответственно мы используем его как хост куда хотим подключиться если же внешнего адреса нет а такое естественно бывает потому что контора если закрыты есть виртуалки которым не нужно не нужны внешние IP адреса мы воспользуемся нашим внутренним адресом и секция зависимость непосредственно от нашего компьютера который мы создаем далее разобрались с дженериком И как же он может использоваться непосредственно в другом модуле который что-то должен делать с этой виртуальной машины структура такого модуля который использует дженерика выглядит следующим образом опять же ритме опять же было опять же какие-то провижные и так далее То есть мы видим что в принципе Пока что ничего не меняется и такой модуль у нас выглядит примерно Вот так это модуль центре все знают что такое центре да наверняка многие используют мы видим то что сорт для него это путь лабе до репозитория ему указываем так опять же не забываем версионироваться это очень важно прокидываем переменные у нас появляются такие же новые ресурсы про которые я говорил немножко ранее да то есть мы там что-то быстро настраиваем опять же у нас появляется Консул где мы дополнительно регистрируем данном случае центре чтобы начать собирать его метрики потому что интегрирован как сервис Discovery и конечный вывод непосредственно точнее конечный манифест благодаря которому мы можем развернуть наш модуль выглядит следующим образом непосредственно версия модуля появляется секция inclood и появляется секция импульс до переопределили в Input все нормально и особо внимательные из вас заметили что что-то как-то я странно вызываю форм-код чтобы запустить наш модуль кость Ты заметил что-то происходит Я заметил наши с тобой любимый инклуды без них конечно Расскажи как же ты Подключаешь что в итоге модули где магия это все магия в свое время когда мы начали активно расти у нас появлялась достаточно большое количество окружений Да там DF you от Pro там периодически прорастали новые окружения для новых проектов и нам нужно было все это как-то консистентно управлять и желательно с одного места и базовые вызовы это Форма нам это практически не позволяли делать потому что попробуй по всей этой Аравии там не знаю репозиторов там директории так далее пройдись проставь там переменные плюс иногда там это надо обновлять и так далее тому подобное Как все это прогонять быстро и мы задумались такие а может мы можем как-то решить этот вопрос да то есть чтобы все хранилось консистентно где-то в одном месте и при этом мы могли централизовано и обновляться и соответственно как-то переиспользуют наработки наш код и тот на сцену выходит программ которые как раз таки Нам очень сильно помог в данной ситуации коллеги многие из вас используют тарагран может слышали про него а если очень просто Тоторо Гранд это некий враппер для трансформа который неплохо так расширяет его функционал он нам очень помог внедрении так называемого драйподхода то есть Дон трепит Yourself и мы соответственно перестали генерировать провайдеры Вы перестали их заполнять руками вносить какие-то общие переменные так далее за нас это стал делать тарагран также он внес достаточно широкую и большую шаблонизацию об этом будет чуть позже дальше будет слайд дополнительные типа переменных и он нам решил как раз таки одну из проблем это управление зависимости То есть когда ресурсы некоторые зависят друг от друга как Я же говорил ранее было красненькая это как нам было больно когда у нас есть разные инфраструктура У нас есть некое количество директории мы их обновляемся них за ним следим и надо как-то местами синхронизировать и скажем так это много ручной работы опять же мы хоть и хороший инженеры мы все также люди которые могут забыть где-то обновить переменную и так далее и тарагрант нам решил эту проблему смотрим на структуру ритме здесь все понятно дев против это директория в которых хранятся непосредственно наши манифесты которые мы применяем дальше нас интересует два достаточно забавных файла это провайдер template и teragrant hcl смотрим дальше торогант H7 это фактически описание конфигурации того как будет работать тарагранд три секции locals generate и inputs locals достаточно Все просто мы выделяем для наших окружений nfwars и Group Wars в нашем случае N Wars это переменные характерные для окружения данном случае это DF you от Group Force это переменные характерные для какой-то группы ресурсов которые мы катаем дальше будет структура репозитория станет немножко понятнее generate провайдер мы для ресурсов так как мы используем Яндекс мы знаем какой про у него генерируем там будет template станет немножко понятнее Мы горим то что будет он храниться по пути где будет куда будет скачиваться наш модуль Называется он будет провайдер TF и если он существует по какой-то причине он просто может присутствовать в модуле он будет перезаписан всегда при вызове секция с контентом мы делаем template файл привычный который многие делали и указываем откуда мы берем переменную переменная зона захардко жена потому что базово мы для себя решили что ресурсы будут первоначально раскатываться только в зоне а Input smarth это как раз таки переменная которой мы добываем из анфас и групп Wars об этом буквально дали провайдер template выглядит следующим образом мы видим описание requare провайдерс в данном случае я оставил только Яндекс но у нас их немножко больше это Консул и так далее Все так что нам нужно для регистрации дополнительных действий описание бэкэндов Да в качестве бэкенда мы используем getlab И как я уже говорил используем потому что у нас есть блокировки и они нам нужны секция провайдер Яндекс как раз таки в него мы подставляем наши переменные которые опять же добыли немного ранее из тех же самых Варс то есть Cloud ID Folder ID зона Иди и так далее здесь в принципе ничего такого сверх интересного нет но магия начинается у нас здесь как я говорил слайдами некоторыми ранее У нас есть структура Да DF you от prod Folder в которых располагаются ресурсы в данном случае мы видим Folder компьютер и это не Яндекс компьютер А это выделенная сущность которой мы определили для себя то есть в директории компьютер у нас находятся все ресурсы которые нужны разработчикам А эти ресурсы не так уж много это база данных Click House и radiss то есть их всего 3 секция директории дмз Ну буквально говорит о том что там хранятся некие ресурсы которые мы размещаем в дмз зонах Да мы же общаемся все-таки через Cloud underconnect со своими коллегами через интернет с другими людьми и так далее А следующий интеллект интересная секция это секция Global в котором мы для себя выделили место для хранения адресов внешних Да потому что ну потеря внешнего адреса Ну скажем так больно когда у тебя там 20.000 клиентов в секунду вот они такие в расходы пропали иди переписывают DNS который будет сутки переписываться и сеть вот здесь начинается самый интересный момент зависимость ресурсов очень важная часть и мы для себя в рамках плотной эксплуатации Яндекс облака выделили что в Облаке внимание самым важным для нас является ресурс это сеть сеть ее подсети Почему Потому что без неё ничего не сделаешь И как раз таки зависимости во многих вещах прорастает именно из директории этого Нетворк на это стоит обратить внимание директория инфо в ней хранятся различные инфосервисы такие как не знаю фрипы могут быть графаны могут быть Харбор и так далее то есть инфраструктурные вещи которые нужны командным эксплуатации То есть мне и например тем же самым разработчиком отдельно у нас выделено директория k8s в которой у нас хранятся описание наших cubernets кластеров для окружения Ну и собственно все Обратите внимание то что в этой структуре у нас присутствует файлы групп группа стиль которых хранятся переменные для этой группы например инфра в компьютере такая же и nfxel в которых с переменной характерной для окружения в данном случае это непосредственно Dev создание ресурса при помощи Таро Гранта выглядит следующим образом здесь достаточно просто и пример был на предыдущих слайдах то есть мы вызываем наш модуль естественно указываем версию inclood в данном случае это обязательная секция нужна для того чтобы Гранд пробежался выше по директориям до корня вот нашел группа htl и вычитал оттуда непосредственно переменный поставил куда надо например в тот же самый провайдер или в базовой переменные нашего с вами модуля из секции nputs это те переменные которые нам нужно в моменте переопределить руками Ну например центре да как я приводил пример мы можем назвать имя сервиса супер дупер центре А почему бы нет Если я так хочу экстра варсы такие экстраварс Но для Тора Гранта если пример еще проще например Мы хотим чтобы у нас было не 8 ядер базовых до центра например 16 Почему нет такое тоже бывает следующее очень важная часть которая нам помог решить Гранд это управление зависимостями Кто работает в Яндекс клауди наверняка знает то что чтобы создать кластер нужно сначала создать мастера потом создать worker ноды и мы же с вами профессионалы мы же хотим быть безопасными нужно все это добро навесить Security группы и мы получаем вот такую структуру зависимости то есть мы создаем мастера за ними по идее создаем worker потому что они зависят от мастеров и по-хорошему там еще нужно прикрутить зависимости групп согласитесь получается ну неплохая такая линеечка тут нам снова поможет тарагран в данном случае создание наших непосредственно мастеров опять же указываем Source версионирование инклуды и у нас получается секция до pendency в которых мы указываем имя зависимости И откуда мы берем конфиг Обратите внимание на структуру гетре парут Мы возьмем прям самый корень нашего репозитория и по определенному пути Def Global Security группы мастер мы вытащим из аутпута ID Security группы inputs как я говорил мы переопределяем там название версии тому подобное Секьюрити группа иди чтобы не прописывать все руками туда-сюда не ходить так далее тому подобное поехали побежали все прекрасно будет работать из особенностей такой эксплуатации заключается в том что а как раз таки Security группа она у вас должна быть применена естественно и у нее должны быть аутпута на это обращайте внимание создание worker not в принципе практически Ничем не отличается от мастера тоже инклуды тоже указания модуля и версии опять же Input и но Обратите внимание то что dependency у нас теперь два штуки и Security groups мы указываем как раз таки непосредственно зависимости групп кластер 1 мы указываем dependence зависимость от ID нашего мастера достаточно удобно можно все достаточно быстро катать и при этом не бегать ручками ничего не переписывать соответственно Гранд весьма неплохой инструмент и в нашем режиме эксплуатации мы нашли некоторые ряд особенностей Например если вы вспомните несколько раз два три Если вы вспомните несколько слайдами ранее я рассказывал о том что мы генерируем соответственно и пути кэмбов Да в нашем детлабе по итогу в нашем случае мы получаем для отдельного непосредственно ресурса отдельный State для некоторых это может неудобно некоторые привыкли один стоит на все но для себя мы выделили именно этот момент почему потому что один ресурс один стоит он маленький просто управлять просто на это смотреть просто как бы с этим жить тогда Гранта есть прекрасная особенность а именно мы можем сделать ран ол то есть мы заходим корень нашего репозитория выполняем программу рекурсивно пробежится по Непосредственно всем директориям и применить применит свой стоит и вот здесь есть очень забавная особенность при применении на все инфраструктуре она минуточку это DF you от ресурсов там очень много мы получим вот такой вот вывод непосредственно дефа и разбирать моего отсюда будем и до зака просто пока держите это у себя в голове играм хочу тут тебе задать вопрос пока не забыл очень важный момент и прикольный про отдельный сайт для каждого ресурса но внимательны слушатели помнят что стыдлабе и получается что у каждого репозитория под ресурс свой стейт там же и хранится с ним или у вас какой-то есть глобальный Нет это немножко не так стейты хранятся в инфо-репе То есть у нас вот та структура репозиторов это наш инфраструктурный репозиторий который есть и ты хранятся там на самом деле это достаточно просто с этим жить просто это как это обслуживать так далее да если очень хочется можно сходить посмотреть на этот же сонник из быка пить почему бы нет то есть получается в одной Репе ресурсы распределены условно и стоит и прям в инфраструкции хранятся тоже все там ну так достаточно удобно весьма неплохо они есть можно глянуть продолжай Спасибо следующая третья особенность это проблема курица яйца вырастает она как раз таки из вот этих вот зависимости ресурсов между собой иногда нужно применять в определенном порядке Но тарагран тут нам на самом деле тоже может помочь потому что у него есть функция мог проще говоря можно подсунуть какие-то мокрое значение при создании а потом подтянуть нужные потому что ресурс создается здесь опять же в игру вступят особенность того или иного облака или инфраструктура иногда это может не как бы не взлететь назовем это так но в целом Использовать можно Окей мы как бы прошли долгий путь у себя в команде до определились с модулями как с ними жить как все дело раскатывается структура репозитория весело и задорно управляли наши инфрой и как обычно начали страдать буквально детскими болячками Несмотря на то что я повторюсь третий раз мы неплохие Я даже сказал хороший инженеры но мы все также люди применяем лучшие практи разработки отводим веточку чет применяем забываем пушить забываем применить забываем переменную обновить и так далее тому подобное если резко надо что-то сделать у тебя либо стоит разошелся либо ресурсов нет либо ресурсы созданы Вот и скажем так было не то чтобы максимально больно скорее было максимально неприятно и мы задумались а как нам вообще с этим жить-то тут в игру вступают Да мы же как бы я мол девелоперы тоже местами почему бы нет И мы решили отдать к мы напишем а пай планы для нашей с вами инфраструктуры Казалось бы что сложного плана Play Out посмотрел все хорошо опять же корни можем рано прогнать и конечно же все как надо то есть все по хитрому мощно и опять а возвращаясь некоторыми слайдами ранее мы получаем в таком режиме о такой вывод который очень сложно проверить опять же очень долгое время выполнения paypeline и в целом жить как бы с этим не то что сложно но опять же очень неприятно и мы приходим к выводу что как бы пришло время задействовать всю мощь гитлаба наш любимый стрим по и планы вот тут коллеги кто-нибудь из вас пользуется в детлабедал Стрим пай плайнами о Молодцы интересная штука мы пришли к выводу что они плохо бы нам для отдельных сущностей или для отдельных групп иметь внимание отдельный pipeline То есть если у нас был один пайпла им для всего некоторыми слайдами где опла его поехали побежали страдать Да мы пришли к выводу что делаем вот так то есть мы создаем байплайны для каждого фолдера в котором находится тот или иной ресурс проблематично это выглядит следующим образом мы генерируем наш провайдер для каждой директории и наш pipeline выходит выглядит примерно следующим образом То есть первый базовый который находится в gitlab Si яма в инкладах в принципе нет ничего интересного мы просто переиспользуемся своим наработки там из разряда какие-то базовые чекалки Там валидеет и так далее и тому подобное и в игру нам вступают и нам интересно сейчас это секция генерирования всего этого добра generate Def опять же стэтч Сета пока не интересно скрипт и вот здесь у нас начинается некое внимание большого магия башесси был Нет просто пока просто Баш как это столько много инструментов тащить генерацию Ну можно но думаю не надо лучше как бы как это бритва Кама проще чем проще тем лучше как бы сделать как это сделать проще сложнее назовем это мы пришли к выводу что будем генерировать вот так и сохранять вот этот внимание определенным именем мы Ну конечно же руны говорят нам о том что запускаемся мы только с протект ответа на и протект ответки в общем случае это Либо мы либо мастер здесь достаточно Все просто идеально соответственно мы три и следующий секция то что мы на генерировали сгенерированный новый downstream pipeline выглядит следующим образом фактически для каждой директории Обратите внимание на переменную TF Root Да мы как раз в ней и запускаем вот эту нашу валидацию непосредственно того что мы сделали и далее мы запускаем применение пока в принципе не страшно страшно становится примерно где-то здесь когда мы начинаем генерировать это на самом деле далеко не полный скрипт потому что Ну увы как это слайду нас ограничено по размеру и Обратите внимание что верхняя часть которую я пропустил это обработка переменных и применения когда мы видели слайдами ранее generate там Def Dev это выбор директории и дальше у нас идет непосредственно новый генерация до который у нас будет Дан Стрим пайплайном дальше у нас идет переборка непосредственно нашу территорий которые будут проставлены в переменную Fruit которая будет нужна для Tera Granta раформа во время его запуска действительно Magic скрипт как-то примерно так о результатам того чего я вам рассказал на что стоит обращать внимание следите за переменными Используйте базовые переменные и непосредственно проверяйте себя это важно Старайтесь автоматизировать свою работу и помните что некоторые вещи все-таки лучше не автоматизировать то есть не сделать такие моменты когда можете потенциального автоматическом режиме отстрелить себе ноги версии они все видите очень жглох Ведите ритме Старайтесь переиспользовать свои наработки делитесь делитесь имя со своими коллегами Да и собственно развиваете так далее и очень важный момент на который обращал Внимание В начале своего выступления и Ок в моменте может быть не нужен еще раз повторюсь если разработчику надо проверить какую-то гипотезу поработать с новой базой данных и далеко не факт что вы поедете Production не упарывайтесь на неделю не пишите хороший модуль просто Создайте руками выдайте Кредо если уже решат что да используем вперед и впрот заложите время Напишите хороший модуль и Работайте с ним чем мы хотим заниматься дальше А мы хотим дать некую возможность разработчикам влиять на инфраструктуру например через внутренний туллинг они смогут заказать базу данных или очередь создатели что-то типа того там репозитории секретик вот положите что и возможно мы постор посмотрим в сторону чата пса это из разряда тем Лид команды разработки пишет Алло бот Васян Дай мне пожалуйста Кредо базы данных он жуком в личку их отправил почему бы нет Как бы мы как бы Стараемся сделать так чтобы разработчики жили хорошо весело и коллеги Спасибо за внимание Пишите в чат Кто смотрит в онлайне Не стесняйтесь Я видел молодой человек первый Точно тут записи не услышит вопрос зачем выполнять мы можем Но не делаем вот мы базовый ответ А как я говорил долго долгая проверка и банально страшно Вот к этому выявил вопрос поэтому как бы мы пришли к вот этому пайплайну который генерирует маленький маленький кусочки которые можно простенько консистентной быстро применять и быстро валидировать понял спасибо пока носят микрофон я тебе еще задам вопрос началось Он такой знаешь не технически а просто забавный ты не заметил что в итоге все такие назовем то что ты сделал без практисами будем не будем себя скромной обратил внимание что стало похоже по логике работы на другой привычной уже всем инструмент которым наконец-то научились работать то есть у тебя прям получить инвентарии Да вот и получились группу арсы и получились зона определения экстраварцев все то чему учились прошлые года она как бы видимо настолько себя как это отполировала что приводя к нему вот к этому виду другое у нас получается как бы прогнозируемая надежная Работа были такие чувства Дежавю когда ты делал так я знаешь Это было на подкорке как это работали с эльзой мы знаешь как это из разряда потихоньку потихоньку хорошие вещи просто втаскивались А если сделал там какой-то через некоторое время overview сверху и такой думаю жага да я сделал типа это раньше но с другим инструментом все было получилось продолжу а там рука была Простите реально плохо видно Я просто ждал У меня два вопроса на самом деле Вот первый вопрос я где-то там видел в середине доклада то что антипал на машинке запускать просто вижу а переменная вас сквозные или нет через форму антип или две точки даете да все так опять доклады возвращаемся до модуль может быть сложный для какой-то сущности дженерик еще часть еще часть еще часть вызов да то есть такой Паровозик и некоторые вещи прорастают самого низа Ну например прорастает название виртовки или диск или не дать внешнее А некоторые вещи объявляется уже в моменте типа там пароль для там центре он уже чуть ли не в моменте вызова может быть либо добавлен либо мы можем выдернуть и вот второй вопрос прям совсем рядышком там валидаторы были на переменных вот на них Предатор валидации валидация реггикса вот у меня вопрос зачем их модуль Если вы все равно в детлабе запускаете Ну обертка по сути есть paype которая отпускает зачем вот этот бизнес логику название BD это по сути ему бизнес логика ваша чем ее в модуль А почему я например в детлабе на уровне реализовать Ну те же где-нибудь на зачем я понимаю я понял суть вопроса ну у нас есть инструмент который позволяет сделать и бизнес логика заключается в том что камни вот внизу подводные это матчинг базы данных и кластера база данных чтобы отрисовать на дашбордах Мы приняли Вывод что проще вот эти вот вещи валидировать непосредственно в модуль который все это дело и создает просто как бы выносить вот такую валидацию в pytline это скажем так будет достаточно проблематично Потому что ты будешь Не знаю там проверять и такие вещи ты будешь интегрировать модуль интегрируешь еще в моменте разработки его модули нативно интеграции мы же хотим сделать просто Стараемся сделать спасибо спасибо за вопрос буду пользоваться моментом пока носят микрофоны у нас с тобой есть всего минута поэтому приглашаем всех на дискуссию когда мы закончим и вот я хотел самый важный наверное вопрос задать Который прям витает в воздухе мы наследуем Пытаемся до последние годы все самые лучшие практики работы с кодом чтобы у нас действительно был инфраг через код и вот такие штуки Крутые они вот прям не прям необходимо одна из самых важных Практик работы с кодом это сама проверка То есть как обстоят дела с тестированием вот этих штук сейчас будет шутка профессионалы мы пишем код без багов на самом деле это очень сложный вопрос мы много думали над этим и пришли к выводу что у нас нет железной как это Серебряной пули у нас нет даже базового понимания как мы хотим тестировать модуля мы взяли пример два примера виртуалка и кликался ли ластик Search виртуалка катится быстро Ну что-то пинганешь ну такая себе Проверка как бы плюс Она работает железобетонная ни разу не было таких проблем в Облаке А вот Клик Хаус или ластик Search в некоторых конфигурациях он тебя может катиться часа полтора Ух и Первое во что мы впираемся это время хотя бы на разворот и второй Во что мы впираемся это тест кейсы Почему Потому что недостаточно просто что-то пингануть например базу данных туда надо что-то подлить что-то с неё прочитать там так далее тому подобное То есть у нас пока нет некоего понимания того как мы хотим тестироваться Но рано или поздно Мы к этому придём точно скопировать как будто бы Всем необходимо и мы пока не сделали сподвижник Ну чтож ребят У нас закончилось время если у вас остались вопросы либо просто интересно сами потусить Мы ждем вас в дискуссии на этом У нас все Большое спасибо Вове Давайте Спасибо Спасибо Я надеюсь вам было интересно со мной конечно"
}