{
  "video_id": "3ZxJIXIiKE4",
  "channel": "DevOops_conf",
  "title": "Дмитрий Афанасьев — Любовь. Ненависть. Nexus Repository Manager",
  "views": 608,
  "duration": 2671,
  "published": "2024-09-26T18:31:30-07:00",
  "text": "Привет ребята привет онлайн зрители Привет Дима Здравствуйте итак у тебя будет доклад про Nexus все верно о чем ты еще занимаешься Мы в нашей команде поддерживаем множество всяческих внешних инструментов среди которых git Love gitla вся и который к нему относится и трек Team City и всякое прочие нечисть отлично и у тебя будет доклад только про Nexus или как-то там зоопарк Нет весь зоопарк затрагивать конечно не будем мы сконцентрируемся именно на Нексусе именно на его компоненте репозиторий менеджер и будем разговаривать о нем что в нем есть хорошего что в нем есть плохого я расскажу много замечательных интересных историй байки травить больше Ну и последний вопрос для кого это доклад доклад скорее для людей которые хотя бы поверхностно знакомы и хотят узнать какие у него есть подводные камни чтобы или полегче с проблемами разобраться или вообще на них не наступить Отлично тогда передаю тебе слово Спасибо Всем привет Ну и как вы видите название доклада Любовь ненависть Nexus репозиторий менеджер начнем с небольшого экскурса Пожалуйста поднимите руку Кто из вас знает что такое Nexus или хотя бы раз им пользовался репозиторий менеджер такой это менеджеры репозиторов которые позволяют вам хранить разные форматы данных такие как newget npm докер мэйвен Пакеты пакеты То бишь пакеты и многое многое другое и вы Спросите От чего именно он ну потому что из всех существующих подобных решений Nexus это единственный бесплатный инструмент с очень большой функциональностью Что называется из коробки И сейчас я хочу с вами поговорить за что же его можно любить чем он так хорош начнем с философии и Nexus репозиторий менеджер как следует из названия это именно менеджеры репозиториев То есть это своего рода комбайн Я бы даже лучше сказал что это бетономешалка потому что все зависимости артефакты он очень интересно перемешивает который позволяет вам подружить между собой все эти форматы Ну согласитесь Когда вы разрабатываете какое-то приложение Вам редко нужен например только не убит или только питон у Вас например приложение У вас есть бэкент у вас есть фронтенд потом это все дело нужно контенизировать из-за диплоить куда-нибудь в кибернетиз так вот Nexus благодаря своему формату Он поддерживает все эти три штуки и вам не нужно иметь ничего другого поговорим про типы репозиторов это очень классная вещь которая в Nexus есть первый тип называется hosted или же приватный репозиторий У вас есть какая-то библиотека которую вы используете только в своей компании и вот вы будете хранить ее именно здесь в этом приватном репозитории вторая штука это прокси в данном примере указан ньюгиторг для тех кто не знаком это из мира дотнета основное хранилище опенсорбных пакетов и третий тип это группа что она позволяет сделать вы можете создать несколько приватных репозиториев и вы знаете помимо например нигеторга еще какие-то прокси нигета которые вы хотите включить и вы все это спрячете за одним углом и при обращении к этому урлу у вас будут выкачиваться все зависимости Таким образом у вас конфигурация сократится до одной строчки итоговая схема работы будет выглядеть как-то так то есть разработчик или какой-то Агент начинает сборку улетает запрос в группу и внутри группы уже как-то разрули вается Из какого источника какой пакет скачать оно поймет что есть приватные пакеты приватные пакеты и поймет Какие пакеты нужно взять из окон собственной кредиторе это удобно и смотрите возьмем такую ситуацию до использования Nexus наша конфигурация выглядела подобным образом то есть у нас здесь есть Три источника гугловой maven Central и плагины для Град мы поднимаем с вами Nexus У нас есть какой-то URL Для всего этого дела Мы обозначаем что находится вот здесь и теперь все пакеты из трех источников мы будем получать именно отсюда и ничего нам больше делать для этого не нужно в то же самое время вы компания Вы развиваетесь у вас появляются новые репозитории Откуда вы хотите все это качать вы просто создаете еще одно прокси и добавляете его в группу и для всех пользователей им не надо менять конфигурационный файл им вообще ничего делать не нужно у них автоматически появляется новый источник пакетов это правда очень удобно еще хочу сказать за безопасность есть такая штука называется Fusion поднимите руку Кто знает что такое замечательно рук уже намного меньше так вот Fusion это такая штука молварь из собственных репозиториев питон Руби гм что угодно которые автоматически распределяется дальше по всей цепочке поставок вникая во внутренние приложения вашей компании без какого-либо вашего участия и выглядит это так смотрите это файл с npm модулями то что выделено желтым оно существует в npm.org Эти пакеты там присутствуют и лежат то что выделено красным Эти пакеты В зависимости обозначены но в npmg 40 вы их не найдете Таким образом мы с вами понимаем что это приватные пакеты и если кое-чего сделать их можно подменить и вашу компанию интересным образом покакать то есть публикуется npm и пакет рубеге и так далее с какими-то с точно таким же и пеньем например но уже внутри внедрена какая-то Метрика либо же какой-то вредоносный код и если у вас не настроены определенные правила роутинга или сборки которых мы поговорим чуть попозже вытянется так скажем неправильный пакет и вы получите маловарь в своей системе сборки как от этого защититься и именно на этом моменте Я хочу вас всех немножко послать а именно я хочу вас отправить посмотреть Наш доклад с Денисом тарасовым который мы делали прошлым летом Там эта тема рассматривается намного подробнее на примере нью-гета там есть пример Как можно сломать приложение либо ваше либо что-либо еще и вы очень много узнаете о том что такое цепочка поставок и как ее грамотно защищать но было бы плохо с моей стороны не рассказать хотя бы каких-то базовых методах защиты есть такая штука она называется роутинг Роуз выглядит в интерфейсе она вот так то есть это какой-то регист у него есть режим работы блокировать или позволять и что эта штука делает так для тех кому было плохо видно вот поднимите руку У нас есть какой-то приватный пакет допустим My company.org неважно логгер Core что угодно без правил маршрутизации если такой пакет присутствует на юге торг откуда он скачается поднимите руку Кто считает что скачается с приватным репозитория так поднимите руку Кто считает что из прокси в целом Вы правы именно эту проблему сейчас нужно решить настроив правила маршрутизации и сказав что пакеты с таким префиксом качай только из Хосты трипозитория мы всегда будем качать из хостыда И тем самым мы обезопасим себя от dependency confusion еще хочу поговорить о такой важной теме в репозиториях называется она чистота поговорим и в первую очередь про мусор и устаревание артефактов что же мы будем мусором считать это одноразовые или превью пакеты артефакты или образы которым на продуктовые площадке или даже хранить особо-то и не надо но они тем не менее появляются и почему это происходит потому что Согласно даже философии что у нас есть некий процесс при котором на каждое изменение кода или даже на каждый КАМиТ начинает происходить сборка этого самого кода результатом сборки Что является правильно какой-то пакет или артефакт который мы публикуем в хранилище в данном случае это Nexus этот подход он не всегда оправдан и если у вас идет очень активная разработка то репозиторий быстро засориться Если вы еще используете в качестве хранилища ну скажем S3 Где бывают определенные ограничения на количество хранимых объектов то может быть критично не только свободное место которое вы потребляете на диске но и именно количество этих объектов Как же быть так вот ну первый наверное способ он организационный это пересмотреть подход к сборке ваших артефактов на каждый коммит возможно Не стоит так делать Возможно стоит собирать только при вливание мёрзший квест но опять же это не всегда оправдано и если у вас не очень активная разработка Вы можете этим пренебречь второй совет который я могу вам дать использовать вшитый в Нексус Клина полюсе это опять же регекс с параметрами описывающий При каких условиях нужно удалять артефакты из репозитория и вот здесь начинаются небольшие хитрости У нас есть возраст компонента он называется компанией и у нас есть с вами пакет он стал старше 30 дней все автоматика внутри Нексуса пройдет и удалит его и вы этого пакета больше никогда не увидите Ну звучит согласитесь с одной стороны нормально с другой стороны не очень не хотим мы так часто пакеты удалять второй более хитрый параметры которые мне нравятся больше всех Это последняя дата скачки То есть у вас есть библиотека хорошо тестирована популярная ваша компания которая пользуется многие другие команды какая-то инфраструктурная Например и вы в ближайшее время обновление на нее выпускать Не планируете и она активно используется Nexus будет счетчик если например это счетчик увидит что даже вашу популярную библиотеку 30 дней никто не качал Хотя может быть год два десять лет неважно он ее не удалит как только этот момент наступит что ее 30 дней не качали вот тогда она пойдет под нож и будет выброшен в мусорку Ну и куда без сопоставления имени мы не можем удалять все что мы хотим то есть мы можем также регионом обозначить что пакеты с такими префиксами мы удаляем либо другие не трогаем и отдельно скажу что все вот эти вот три параметры можно комбинировать между собой на мой взгляд самый удачный комбинация является Это вас и остатным матчем расскажу историю у нас в контуре была проблема докер репозиторий стал весит слишком много на тот момент это было почти 12 терабайт потому что многие команды использовали как раз таки невероятно активный процесс сборки что мы сделали ну мы поговорили и пришли к выводу что наверное образы которые больше полугода не качались они все-таки не нужны давайте мы будем вычищать и у нас сэкономилось место почти в два раза то есть мы похудели с 12 терабайт до 6 что и по объектам Нам очень прилично сэкономила Хотя Для нас это не важно было и по месту А вот это было очень важно Так что вывод из этого всего простой Чистота залог здоровья сейчас я буду рассказывать еще несколько очень классных историй но они уже больше про ненависть и первая проблема Нексуса с которой скорее всего каждый из вас так или иначе знаком кто его пробовал это архитектура начинается она с того что это Монолит и под монолитом Я имею ввиду что в случае с Nexus первое его Причина его монолитности это база бесплатной версии которая называется ориенди и в определенных случаях и ситуациях база может быть довольно хороша работать быстро выполнять быстро джойн и она графова и документы ориентированная Но как только вы начинаете использовать при поиске любой клиент к любому типу репозиторий будет этот паттерн использовать например npm перед тем как скачать пакет он сделает запрос и посмотрит А если вообще такой пакет Если такого пакета Нет он скажет например версия 1.01 Нет есть версия 10 попробую использовать ее и Orient db в этом случае ведет себя очень плохо он сваливается Full Scan То есть если у вас пакетов много у вас время на сканирование уходит больше все тормозит все медленно все не очень прикольно вторая проблема сориен db она не отчуждаемая что под этим я имею ввиду если вы хоститесь cubernets или просто запускаете где-то докер контейнер с наксусом вы не сможете базу данных оттуда выдрать то есть кажется что это какая-то такая вещь которую вот надо поставить по соседству и пусть она себе живет Возможно даже можно кластеризовать у вас это не получится сделать Почему Потому что sonatape сделали хитро у них есть самописная утилита которая с базой взаимодействуют и путь до базы криды к базе они зашиты вот прямо внутрь образа или бинарника и таким образом даже если вы захотите форкнуть это всё и переписать вас это не сильно получится потому что реализация этой утилиты она в общем-то закрыта Поэтому извините здесь я поговорю про эластик Он точно также не отчуждаемый точно также прибит гвоздями и он находится внутри контейнера либо внутри бинаря но эластик он решает первую проблему которую они породили уровень db То есть он строит индекс над базой из-за Чего поиск становится значительно шустрее дальше мы еще раз этой проблемы коснемся но немножко в другом ключе исходя из всего вышесказанного Nexus не масштабируется горизонтально Никаким образом кто-то Кто знаком с платными версиями может сказать Ну вообще-то у них есть постгресс в платной версии и вы будете правы но вы сможете кластеризовать постгресс вы сможете его вытащить и строить над ним какую-то аналитику что будет весьма полезно Однако эластик вы все равно износится не достанете поднять его внешние натравить К сожалению он такой возможности нам не дает и еще очень интересная штука Nexus хранит данные в бабах в бобах как в сущности ничего плохого нет но оказалось бы что вам мешало изначально использовать какую-то революционную базу данных и хранить пакет Ну как он есть вместо этого что происходит Мы проваливаемся в так называемые чаптеры ориента видим какой-то файл Он ведет на другой файл и так далее так далее но при запросе выписку Nexus нам это все любезно склеит И отдаст полноценный контент Но если вы внезапно захотите мигрировать из одного репозитория в другой даже внутри Нексуса вам может быть это делать очень больно потому что опишка у него медленно об этом мы тоже чуть позже поговорим а просто взять и условно сделать Control Control папочки мы не сможем потому что все данные они распределены черт пойми как В итоге конечный архитектура когда мы например хостимся в кабернетисе выглядит примерно Вот в такой схеме То есть у нас есть какой-то балансировщик нагрузки с него запрос попадает на энгресс и сыграть он уже уходит в Nexus внутри которого у нас есть вариант эластик и которые все данные хранят на каком-то хранилище То есть это может быть S3 Nexus позволяет использовать ис-3 но важную сделаю оговорочку это только АВС сколько я не читал про завести его например ВК и по-моему Яндекс 3 ни у кого из моих знакомых не получилось так что будьте внимательны как я обещал поговорим немножко про API оно медленно она очень неповоротливое И сейчас я иду веду речь не об API репозиторов которые в Nexus реализованы а именно оба пешки самого Нексуса как сервиса и первая проблема это пагинация смотрите в Нексусе она реализована посредством токенов То есть это выглядит следующим образом мы отправляем запрос на получение компонентов нам в ответе вернулось 10 штук Но конечно же есть еще и этот токен мы как параметр подставляем следующий запрос и таким образом получаем все пакеты пока только не будет равен нулю и здесь возникает вторая проблема количество элементов на запрос его нельзя регулировать или увеличить то есть классический механизме например скип тейк Вы можете указать по 500 по 1000 или даже по 10 тысяч здесь у вас такого не получится и к сожалению пользователей сделать это настраиваем зачем это вообще может нам пригодиться ну скажем Мы хотим сделать безопаснее У нас появился какой-то сканер который умеет выкачивать пакет потрошить его по каким-то паттерном проверять но для этого нам Разумеется надо будет сходить в пешку каждый компонент получить скачайте что-то с ним поделать и здесь мы приходим к третьей проблеме это фишка очень медленная задача У нас есть 10 тысяч компонентов на каждый запрос нам вернется 10 штук время ответа на запрос примерно 3 секунды иногда чуть быстрее а иногда даже медленнее таким образом Нам нужно будет сделать тысячу запросов потратить на это 3000 секунд или почти 50 минут Ну согласитесь для десяти тысяч компонентов это как-то даже я бы сказал неприлично а вы скажете Так вы наверное задушили его дайте ему больше памяти процессора и так далее и так далее но дело в том что сколько дров в печку не кидай ничего не выйдет мы пробовали увеличить количество ядер в два раза мы пробовали дать ему больше памяти и даже высвободить сетевой канал для него ничего не помогает И мы приходим к выводу что API оно не отзывчиво само по себе несмотря на те ресурсы которые вы сервису выделить но можно ускориться помимо стандартного поинта на get есть in Point который называется Search и мы можем через него искать Он работает в десятки раз быстрее то есть ответ на запрос у вас будет менее чем пол секунды и Вот видите магия возвращается не 10 на 50 компонентов и соответственно Наша задача преобразуется в такую мы делаем Не тысячу запросов А 200 нам нужно не 3000 секунд а всего лишь 100 то есть на вместо 50 минут потребуется чуть больше полутора Ну ты же здорово Это классно для решения конкретно нашей задачи способ подойдет Отлично вот только если у вас будет больше 50 тысяч компонентов у вас все сломается отвечу на вопрос почему в первом случае когда мы используем на get Nexus идет прямо в базу То есть он прямо отправляет запрос открывает транзакцию говорит Дай мне вот это вот все и достает нужную информацию и нам ее возвращает второй метод он ходит власти и берет информацию оттуда ну и соответственно искать по индексу Это намного быстрее чем напрямую ходить в базу поэтому и такое разительное ускорение но скролластик оно ограничено 50 тысячами компонентов в ответе я не скажу что я очень хорошо разбираюсь в эластике Но то что я успел почитать в документации написано что ну ребят если вам запрос надо вернуть больше 50 тысяч компонентов Наверное вы делаете что-то не так и надо подумать немножко другой реализации того какой ластик используете Возможно шортировать кластеризовать и так далее но как Мы помним Nexus нам этого сделать не позволяет баги лаги или трайа это вот вообще мое любимое Потому что когда мы писали определенный сканер для Nexus это прям боль была ищем много пакетов получили первые несколько пачек все у нас идет хорошо внезапно вместо токена нам берет и возвращается Ну получили мы допустим 30 компонентов а мы точно знаем что их тысяч 50 и весь процесс либо начинать заново либо обмазываем это все дело ретраями а вот только иногда Ну может по какой-то неизвестной причине прилететь более 5 раз подряд количество литраев Выбирайте самостоятельно вот здесь сидит улыбается Но мы с ним на этом очень много что называется гребли и в слове безопасность у нас потерялась буква у а если Вы внимательно смотрели то она обозначала у нас удобство что ж я под этим имею ввиду возвращаемся к нашим правилам маршрутизации и регист это здорово Это прекрасно Возможно вы их хорошо понимаете и любите писать Вот только когда он становится вот такого вида могут начаться определенные проблемы и у человека который пишет постоянно но еще больше проблем возникнет у человека который пишет там условно раз в полгода что здесь вообще происходит у нас реки У нас есть пакет который по какой-то любой причине попал к нам в немилость но только после определенной версии А все версии что были до нам надо оставить разрешенными и тот у нас начинаются Приключения что мажоры запретить какие-то миноры разрешить какие-то патч-версии запретить какие-то разрешить и вот таким вот хитрыми исключениями приходится очень много обрабатывать и спустя полгода когда ты снова за это садишься что как это вообще ни черта не понятно поднимите руку Кто считает что Nexus Open Source так хорошо хорошо но он действительно своего рода Open Source часть кода действительно лежит видеопансорс на гитхабе Вы можете ее посмотреть Вы можете туда даже попытаться по контрибьютить что-то А вот если вы попробуете найти реализацию любого типа репозитория вас ждет большой разочарование потому что вам интересно как реализованный Get не найдете Как работает докер как имплементировано его пи тоже ничего и такой последний по списку но не по значению это очень неоднозначное отношение к реквестам от сообщества Давайте такой небольшой квиз Можно ли сделать так чтобы Nexus в своем ответе отдавал больше 10 элементов поднимите руку Кто считает что да хорошо правильно а написано Для этого кота теперь поднимите левую руку Кто считает что да замечательно и вы вновь оказались правы А этот код в Main ветке А сейчас я вас попрошу поднять не руку а ногу сложно Да и некомфортно и даже может быть неприятно так вот ответ нет разбираемся подробнее существовал вот такой пул request что он опции добавляет лимит к тому сколько мы записки можем получить Как вы видите у человека 22 лайка что Ну не мало в рамках гитхаба и Обратите внимание пожалуйста на дату 23 октября 2019 года спустя почти три года мы видим что пул реквест закрыт не принят закрыт спрашиваем У человека Что случилось Почему так и ответ будет простой говорит меня будет заманал у меня там в полурекластеет зависимость он постоянно меня терроризирует чтобы я их Обновила Пури квест не принимают Мне надоели эти нотификации Я просто закрыл Пури квесты живу себе спокойно Ну как-то так поговорим за поддержку она очень важна но я должен сделать очень важную оговорку Мы никогда не были платными клиентами потому что взвешивая все плюсы и минусы за эти деньги что не просят именно с репозиторий менеджер в этом нет никакого смысла и резонный вопрос хорошо с багами вам нужен имеет увеличенный заплатить и все у вас будет не спешите радоваться потому что человек прямым текстом говорит что мы были платными клиентами наши тики ты не приоритизировались задача не брались и это становится грустно и вы понимаете что возможно не стоит тратить такое количество денег на все это дело а теперь поговорим за настройки документация Nexus Она довольно хорошая до определенного момента то есть всякие базовые сущности и Как скажем сварить суп чтобы у вас получился вкусный вкусная группа репозиториев описано очень здорово но когда вы сталкиваетесь с проблемой что вам нужно настроить Java Virtual Machine anexus для тех кто не знает написано Java вот тут настройки описано очень плохо и наступает прям невероятное поле для экспериментов также Существует множество не документированных настроек и о них вы можете узнать либо открытую часть исходного кода либо на подсказке которая есть на их форуме и все те кто планирует хоть в каком-то виде Nexus администрировать я вам очень рекомендую Зайдите на форум погуглите там свою проблему вы сэкономите себе тонну времени которая в документации не отражена и влияние всех этих настроек на работу сервиса оно вы истину непредсказуемо поговорим за Джава Виртуал машин и все что с ней связано главное Такая замечательная проблема бесконечный фул гарбач коллектор как это выглядело работает у нас сервер себе сервис все с ним хорошо неделю или даже две а потом внезапно бац и все перестало работать все запросы у нас отваливаются по тайм-ауту идем читать логи видим что у нас случается Full garbach Collection и сразу же он случается снова и снова и снова и объем освободившейся памяти будет смешной так сказать Не сочтите меня голословным посмотрим на скриншот верхних точках Вы видите что Full gc случался занимал относительно вменяемое время освобождал приличный объем памяти вот последние три строчки выделены Вы видите что Full gc длится очень много и очень долго почти по 30 секунд и объем освободившейся памяти но он правда смешной то есть мы свалились бесконечные фугасы из которого из которого выход только один это рестарт сервиса Давайте попробуем разобраться Почему вообще все так произошло Проблема крылась в том что при обращении на url-группы нигета поиск был у них бак и поиск происходил не только среди репозиториев которые носили тип нигета он вообще по всем репозитариям ходил и начинал искать А у нас в контуре разработка в основном ведется на дотнетти и не Гетто репозиторий они у нас очень популярны и самые высоко нагруженные соответственно индексы orendby работали неправильно генерировал с огромной мемори трафик и неизбежно рано или поздно приходил фургал Горбач коллектор пробуем настроить и Начнем с того что Куча у нас была 30 гигов мы выводили влоги максимально подробную информацию о том как у нас работал Горбач коллектор чтобы можно было Хоть чего-то начать хоть чего-то разобраться но помогли нам вот эти вот все настройки то есть что при оккупации кучи начинать разметку раньше что пауза для гц должна быть 300 миллисекунд что он чтобы он работал 12 потоков по поводу 12 потоков в документации прям хорошо написано есть формула как это посчитать сколько потоков для Дживан вам потребуется здесь самое интересная настройка Это последняя которая говорит про хранилище небольших кучек постоянных объектов значит Смотрите по дефолту если мне не изменяет память это значение равно 4 То есть у нас внутри нашей кучи есть четыре кучки поменьше в которых хранятся объекты которые переживают сборку мусора то есть они переезжают в следующую итерацию постоянно постоянно и в чем была проблема то есть когда мы уходили в полной гармошке коллектор это означало только то что Nexus сейчас для работы все эти объекты нужны и он не может их вычистить из память когда мы эту скажем так кучку внутри кучки увеличили до 8 у нас проблема Не то чтобы прям ушла но жить нам стало намного легче сервис мог без рестарта существовать значительно дольше по месяцу или даже по два и Вот такой результат у нас получился у нас СТВ паузы стали очень маленькими и само приложение работало Достаточно долго и по персентилям Вы тоже видите что это достаточно неплохо скажем так И все же корень зла у нас оставался бак в логике работе сервиса То есть то что мы делали оно исходную проблему не решит она нам позволяла жить с последствиями Когда у вас активная скажем так использование вам нужно что-то сделать вы не можете на это просто забить и еще одной причиной было то что Nexus выпустили смешанную смешанный режим работы не гет-репозиториев у вас репозиторий могли работать и по второй версии протокола и по 3 и существовать внутри одной группы и это все взрывало если у вас внутри группы были только репозитории только третьей версии с проблема вы сталкивались намного реже а впоследствии не это починили и Вы перестали сталкиваться с этим вообще но сам бака не починили только 10 релизов спустя релизный цикл у них не то чтобы стабильный Ну в общем это получилось наверное в районе полугода может быть чуть подольше и настройки GM впоследствии мы вернули к более классическим Однако новый опыт и знания позволили вывести более интересную конфигурацию она выглядит таким образом внимательный зритель заметить что как-то у вас тут разительно куча увеличилась была 30 гигабайт стала аж 90 что же такое произошло но за эти полгода команды постепенно заезжали репозиторов он остановилась больше тот же самый доки роз и соответственно потребление памяти Nexus все росло расстроило и росло И хотя бы вертикально мы могли его масштабировать это нужно было делать по картинкам вот так вот у нас сейчас выглядит потребление памяти То есть у нас остается запас 15-20 процентов на случай пиковых нагрузок а здесь мы видим количество выживших объектов после сборки мусора учитывая наш объем кучи 572 мегабайта Ну это приемлемое значение это не так уж и много как может показаться и расскажу еще одну интересную историю называется она И один в поле воин внезапно у нас просто берет и отваливается один из репозиториев он просто перестает работать Ну первое что мы делаем мы бежим влоги и смотрим и такие Опачки у нас значит на один пакет точнее на его индекс ломится больше 100 потоков одновременно Ну проблема ли это то есть Казалось бы ну может кто-то ошибся запустил сборку своего пакета на всех Team City там или gitlab ранних разом и вся эта вот машинерия пошла за одним пакетом могло такое случиться могло вероятность этого события маленькая ошибку начинаем гуглить искать документации ничего нет но мы хитрые мы идем в исходники мы начинаем смотреть где там вообще есть такая настройка фигурирует там такие слова или нет Да она находится мы пытаемся увеличить до 200 до 300 до 500 и мы огребаем другие проблемы То есть репозиторий у нас опять было проблем спойлер она починилась но у нас отвалились другие и здесь у нас развивается огромное количество поля для экспериментов из-за чего это вообще произошло ну здесь были виноваты уже Мы у нас была несогласованность настроек балансировщика Ingress и получалось что на балансировщике количество ретраев было установлено в единицу А на энгресс было дефолтное дефолтное значение в ноль что по сути означало повторять запрос всегда пока он не завершится успешно и таким образом нам прилетают условный запрос смерти который бы не выполнился до отвалился А мы сами себя медитативно начинаем добивать Выполни Выполни Выполни Ну устроили сами себе дудос чего делать стали умнее И тут я вам еще должен сказать что Nexus у нас это старичок бородатый дряхлые которые работают на Java 1.8 есть очень не побоюсь этого слова мемный тикет у них на Джерри которому наверное 3-4 может быть даже пять лет и люди говорят что ребят Даже там уже у бунту дебина выходит образы которые работают на армии на котором не работает восьмая Java Давайте с этим что-нибудь сделаем Ну и актуальная версия Java сейчас у нас лтс 1.17 и насколько я гуглил последний раз релизом кандидат по моему то ли 21 то ли 22 То есть отставание у нас огромная от текущей мейнстримовой Java что я хочу сказать заключение Nexus это сервис с определенной философией и если Вам эта философия близкая она вас устраивает Ну скажем так вы получите море удовольствия он очень гибко может настраиваться из коробки дает вам плюшки безопасности которые сервисы по отдельности То есть например там питоновской галерея нет галерея Или тот же Харбор вам просто не дадут у него есть вшитый настраиваемые политики очистки сколько я смотрел отдельных отдельные например там галереи так далее такой функциональности там нет с другой стороны там есть реляционные базы данных на основании которых эти политики можете создать Когда вы к нему под привыкните он удобный Ну и в конце концов это все в одном для кого-то это недостаток для кого-то это преимущество но недостатках тоже не будем забывать это долбанный Монолит и это расстраивает всех всегда и я думаю будет еще очень долго расстраивать иногда он очень медленный И для своего для своей работы требует прям особого подхода чтобы вы погрузились вникли при больших нагрузках он требует очень тонкого тюнинга что вот тут большие нагрузки Ну я это ограничил больше 300 РПС понятно что РПЦ бывают разные условный гет он вернется быстро если вы постите вот такой вот здоровенный образ он будет выполняться долго тем не менее на шенстонс Сейчас может проживать 35400 rps и вот уже после этого значения он начнет себя чувствовать плохо опять же проблема это неочевидные настройки и Nexus он тяжелый во всех смыслах То есть у вас большой instance он будет жрать много память он будет жрать много процессоры он будет прямо пожирать огромное количество дискового пространства например в случае с докером Ну и Open Source но не очень Стоит ли она вообще того ни один из схожих продуктов за бесплатно такое количество функциональности не предоставляет и я считаю что даже невзирая на все недостатки оно как минимум стоит того чтобы его попробовать дать ему шанс возможно понравится готов ответить на ваши вопросы у меня все Спасибо Дима Спасибо Дима Итак главный вопрос любовь или ненависть вы знаете сейчас современном мире очень часто говорят что лучший подарок это эмоции так вот если вам нравится эмоциональные качели и вы после этого хотите походить к психологу пожалуйста Отлично Теперь ребята есть qr-код можно задавать вопросы туда мы сейчас ответим на несколько вопросов и перейдем дискуссионную зону где можно будет выиграть книжку Дима Какую книжку поскольку эта конференция Упс и наверняка Здесь все так или иначе у нас любят возиться сам или хотя бы что-то с ним делать А те кто знает это чуть подробнее он написанного мы подарим книгу которая про этот язык расскажет подробнее Если вы не умеете то научиться с ним работать отлично Итак кто готов задавать вопросы молодой человек спасибо спасибо за доклад вопрос Следующий по поводу клинополисе вот этого всего Когда вы сказали о том что вы зачистили половину веса репозитория грубо говоря да то чтобы слишком объемные там образы хранились и так далее каким принципами все-таки руководствовались потому что просто зачистить по принципу что оно не участвовало сборке это тоже вопросик вызывает а вдруг она где-то в бою стоит да и это очень хороший вопрос потому что мы столкнулись с такой проблемой у нас крутили сервисы в куберетесь полгода с ними Ну ты же вот хорошо они не денется и там даже обновления спокойно переживали никаких критичных не было а потом вытягивается в Nexus идем мы его затерли Потому что больше гибкости к сожалению не дать чем мы придумали У нас ребята сканируют все ноты смотрят У нас вот эта вот штука крутится больше 180 дней мы сделаем припул Просто чтобы в Нексусе обнулить этот счетчик то есть подобную проблему Мы решили таким образом еще из вариантов решения Вы можете по взаимодействовать либо с самим апинексуса Но помните что она медленно либо сопи самого registry то есть Nexia но реализовано достаточно бодро но когда вы найдете какой-то манифест и прочитаете его Nexus посчитает что вы его скачали и ровно в этот момент его сбросится дата последнего скачивания и образ по сути у вас будет новый Окей вы обошли через этот сбрасывание счетчика Спасибо отлично сюда пожалуйста Спасибо вот такой вопрос вот было сказано что Nexus горизонтально не масштабируется но можно поднять несколько реплик вот сказать что эти самые там жирные допустим нью-гет от которого одни проблемы в Нексусе будет жалеть в отдельном Nexia А все остальные отдельно и так вот еще получить какой-то запас на горизонтальное масштабирование за счет шортирование такого Да можно но здесь идет прямое расхождение всего философии все в одном То есть у тебя уже получается не менеджеры репозитория фа здесь я по менеджеру не гет здесь по менеджеру докер здесь например мне питон будет жить так можно сделать и действительно вы нагрузку на основной стенд снизить Я в общем в Нексусе сейчас относительно недавно родилась такая штука Как прокси ноды мы сами еще это не изучали но в чем суть То есть у вас есть тяжелая прокси докер хаб многие торг все вот эти вот популярные вещи и вы можете это все вынести отдельно и поселить на отдельные ноги чтобы нагрузку на основную снизить а еще вы их можете рассчитывать То есть ты можешь делать что у тебя прокси только для Докера только для питона это будут все разные ноды внутри игры сам они разрулиться отправят запрос куда надо и еще такой вопрос поскольку там прокси репозитории они ходят там допустим тоже docker Hub и в какой-то момент это все работало хорошо и там пару лет мама назад докер такой хаб горит типа короче все запросы лимитированные и вот вам там 100 запросов например на сутки и огребарили с этой штукой или нет частично А поскольку Nexus это кэширующая прокси Я скорее всего об этом забыл сказать Прошу прощения То есть вы сходили за каким-то пакетом он к вам прилетел и он внутри Нексуса сел то есть следующий раз когда вы за это за этим пакетом пойдете он нечестно там в докер хаб пойдет он свою внутреннюю прокси сходит И отдаст вам его Это во-первых намного быстрее будет при тяжелых сборках во-вторых вас всегда есть относительно постоянное хранилище того что есть по поводу лимитов Да мы на это наступили Когда вы настраиваете прокси У нас есть галочка что теперь и ты можешь Туда положить свои деншила докер хабы эти лимиты обойти но Разумеется условия у вас должна быть хотя бы одна платный учет и видимо так надо на всякие другие хабы идем забираются ограничения да Если есть возможность их платного четко обойти да Ну например это Не сработает снегетом потому что у неё Гита Точнее у нее торг у него довольно жесткая лимитирование по ip-шникам и если вы почитаете документацию то мы как бы никаких платных учетах под это дело не даем поэтому прокси кэш здесь становится прям спасение и это касается например опять же Microsoft of Rage 3 Откуда образы для сборки современного а тут на это тянутся Спасибо Привет привет Спасибо за доклад Вот ты много говорила о том что не поворотливый медленный Монолит не масштабируется я правильно понимаю что можно в какой-то момент просто упереться в это ограничение и таким образом Nexus не подходит например для крупных компаний если у тебя ответы Какого размера Он подходит Что делать если ты его перерос у них официальная рекомендации прямо есть что если у вас условная папка Sorry начинает весить больше 12 гигабайт То есть это все это не учитывая контент не учитывая данные это именно схемы роли Security всякие штуки вот если больше 12 гигов они такие ну ребят пора платить денежку переходить на пост Если меньше этого значения то можете жить спокойно У нас сейчас Это волшебная папка весит 11.8 у нас Nexus занимает после всех чисток 8 терабайт в Пике у нас было 15 И как я говорил мы 35400 rps удерживаем то есть я бы сказал что-то достаточно высокая нагрузка на менеджере репозиториев но все что больше вам либо опять же придется его тонко тюнить искать вот эти не документированные настройки либо смотреть в какую-то другую сторону опять же прокси ноды про которые я сказал они частично эту проблему решат то есть по распределению запросов на основную вопросов а у тебя еще вопрос появился Хороший вопрос был перед этим так доколе продолжаться будет когда переписывать взять его на распределенную и нормальную систему от ответа на этот вопрос нет Гриша у нас спросил когда его переписывать на хорошую распределенную систему мы можем пойти в саната и потребовать с этого но я догадаюсь куда ни нас отправятся такими давайте у нас есть время на последний вопрос молодой человек а ну отлично ребята если мы не ответили на ваш вопрос Если вы хотите подискутировать про любовь ненависть Nexus роботов мы сейчас будем дискуссионной зоне Я точно знаю что в чате есть вопросы поэтому Приходите именно там мы разыграем книжку Ждем вас Всем спасибо"
}