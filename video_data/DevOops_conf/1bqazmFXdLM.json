{
  "video_id": "1bqazmFXdLM",
  "channel": "DevOops_conf",
  "title": "Федор Чемашкин — Заключительный рассказ про операторы",
  "views": 864,
  "duration": 3570,
  "published": "2020-02-07T07:55:35-08:00",
  "text": "у всем привет меня зовут чем hk даже и это мой последний рассказ про операторы о чем мы сегодня поговорим мы поговорим о системах управления поговорим о самих операторах и конечно же как мы делаем эксплуатацию в clown этих мир и мире а кто общая писал уже операторы кто хочет писать отлично в общем на самом деле это доклад я начну с самых основ он просто просто самых-самых основ и в конце в третьей частью же будут примеры как мы это делаем и для тех кто писал операторы надеюсь это будет вам тоже полезно и во второй части моего доклада будет немножко слайдов с кодом поэтому пожалуйста если у вас есть телефон то конечно же он у вас есть то вы можете пожалуйста открыть мои слайды на сайте конференции я уже выложил и сразу же небольшой дисклеймер писать операторы это вообще не сложно и своим докладом я хочу это доказать что не нужно больше никаких разговоров про эту тему потому что нужно просто взять за использовать какой-то фреймворк и взять просто и написать и поэтому он и последний я надеюсь и немножко бы мне я senior software инженер но я еще студент поэтому скорее всего вы на меня посмотрите вот так но пожалуйста не разбегайтесь за свою карьеру я успел разрабатывать два три оператора участник конечно же все они пока приватные они у нас и получилось в разработке нескольких клоун этих проектов я работаю в компании делаем сейчас это группа компаний дал технолоджис мы разрабатываем системы хранения данных и я работаю власти клауд сторож это объектно система храни данных то есть если вы не можете хранить данные в amazon и в амазоне в стрит вы можете купить наш сторож и создать свое приватное облака давайте вернемся на n лет назад когда вы все были студентами а скорее всего у вас были такие предметы как теории автоматического управления теорию управления там функциональный анализ и такая картинка скорее всего она вам знакома здесь есть устройство управления сигнал управления там управляемый объект сигнал к главной обратной связи и зачем я вам это все втираю хочу вас просить у вас никаких чувств не возникло у меня лично возникает чувство дежавю что где-то это уже было и где-то это уже используется и почему мне это чувство возникло когда я это изучал я хочу давайте вспомним как изменялась эксплуатация эксплуатация менялась очень очень быстро в последние года раньше это были какие-то binary на сервере монолиты все запускалась врач вручную сейчас же такие так облака контейнеры микро сервисы больше кода два пса сергея сколько ещё новых модных слов появится неизвестно и сейчас новое самое модное слово и так обернитесь и почему это до де факто стандарт неизвестно но сейчас это так и на самом деле известно но это стандарт с этим надо жить и как бы жить кубер нити сам как устанавливать приложения что делать с эксплуатации как делась вся и сиди как управлять инфраструктурой еще разные вопросы все в принципе своем кубер нити это научились делать ну я думаю все согласны с этим но в нашем случае в случае нашей компании нам нужно поставлять по в чужой кубер нить из то есть не на наш собственный а совершенно чужой которому доступ ограничен и это очень больно прям реально больно прям очень очень очень больно и все проблемы они всплывают заново нам нужно искать ответы на вопросы которые все уже нашли вс для своих uber notice of нам нужно ответить на эти вопросы заново как нам устанавливать приложения давать диски давать флешку открывать доступ к приватным у репозиторию ссылку ну не понятно как делать эксплуатацию там брать чтобы инженер поддержки мог подключиться через кьюб ситель сказками раскинуть клюв конфиг но это не очень хорошо как делать все и сидим тоже непонятно и как управлять инфраструктурой тоже непонятно и таких вопросов очень много которых нужно нам решить какие у нас есть варианты hell но он не подходит я думаю с весна сами знаете почему кто-то пишет скрипты на питоне используя питоновский гук клиент они пытаются автоматизировать установки развертывания и кто-то может так делать а кому-то это хорошо он символ то обще использует on сегодня кубер нить из а вот вот тот самый модуль нос во влогах вот этот модуль я не знаю зачем он вообще кто его изобрел я его сейчас на сюда только для чтобы flight красивый получился и конечно же есть ваш en-v баст глобальные переменные переменные окружения всегда можно написать божью крипты все будет хорошо но если вы солидная компания уровня дал технолоджис вы продаете ваши продукты за сделки в которых очень очень очень много нулей то большое количество манифестов ваш скрипт и и питоновские скрипты это не то что хочет видеть от вас автомир и на самом деле это не то что хотим видеть мы есть проблема как нам сделать конфигурацию простой эксплуатацию максимально автономный чтобы снять боль поддержки с нас как нам сделать наши стороны же кастами рф ренли и выход один это все вход эксплуатацию в код опыт сын ошибок трудных его туда же в код программистов кто программист вас в код тоже положат рано или поздно и ваш менеджер скажет вам спасибо в мире кубер не tissot таким решением стали операторы и это всего за стало возможным благодаря кубер не tissue и это новый вид софт во софта и на самом деле это не просто софт как таковой как какой-то binary это способ экран инга ваших приложений для кубер не tissot и как все это началось началось это с этой статьи в 2016 году интервью синкопе reuters путинка пришлось индусов веер компания cкoлиoз она выпустила эту статью они рассказали что вот есть бокс инженера если сердечники они получают опыт работы с каким-то своим специфическим продуктом это опыт они могут автоматизировать писать скрипты и выхода в мире кубер не tissot стали вот эти самые операторы и потом позднее куриос выпустила целый оператор фреймворк и зачем же нам это понадобилось казалось бы где мы детства роджер дик облака у нас есть продукт он называется пробегом это сторож который переосмыслен для мира стрим стриминга вымер а то здесь и an open-source ней то есть вы можете его поставить себе скачать изменить и здесь в нем стрим это примитив для хранения обслуживания непрерывных данных то есть это самый главный примитив в нашем в этом торджи ионную какие из кейса у него есть 1 это а j основной на самом деле если у вас есть очень много различных датчиков какие-то физических объектов которые генерируют непрерывные данные то пробега может хранить для вас их обрабатывать их также можно сделать масса jing то есть у вас распределенная система через проверку можно сделать message broker а у пробеге вот что очень удобно один api ой как для real-time данных так и для исторических то есть ваше приложение может реализовать всего лишь 15 и работать как is well time данными так с историческими и это стрим processing это одна из основных и важны самой главной фичей пробеге она умеет с помощью apache клинка в реал тайме процессить ваши данные и потом со временем сохранять какого-нибудь тир 2 стороны и часть наших заказчиков заказчиков то использовал пробегу они захотели пробегов кубер найтись и в чем же сложность я думаю у всех есть существует стереотип голова что пробега и докер ой извините не пробега q вернитесь и докер они не для хранения прецедентных данных но это большущий стереотип можно и нужно хранить да можно и нужно хранить данные в убирайтесь и в этом ничего страшного нет и мы это умеем делать это одна из сложностей 2 что эта специфичная эксплуатация сожалению просто так установить пробегаю не получится нам нужно установить ее в нужном порядке в нужным компонентов чтобы все размазалась так как нам надо и еще пробегает распределенная система что накладывают хита свои сложности что нам нужно поддерживать количество реплик нибудь кворумы и все такое то есть вот это три основных сложностей которых с которыми нам приходится жизнь жить и выходом чтобы решить эти сложности стал пробега оператор он умеет кастомизированный работать с pewdiepie виси что в принципе нам и нужно он умеет устанавливать и удалять пробегу так как нам нужна он умеет делать правильный rolling апгрейт к сожалению ролика предку беренса нам не подошел потому что он слишком простой и он не подошел к нам и он имеет еще проверять состояние кластера то есть умеет смотреть что происходит внутри количество реплик как все происходит с текущим текущей установкой пробеге и в рот mapi еще очень-очень много вещей которые оператор будет уметь делать как я уже сказал создание операторов стало возможным благодаря кубер нить из кубер нить из в принципе это большая сложная штука но ее можно представить в 3 картинках первое и самое важное наверное это ресурсы то есть это те плоды deployment estate full set и м поинты сервисы все то что вы можете создать убирайтесь и для вашего приложения то есть это путь будет можем сказать что это пусть будет существительное затем у нас есть контроллера это специальные контейнеры docker овский вас очень часто специальные контейнеры они слушают и вен stream и делают действия над ресурсами своего типа events 3 мг оберните со это вот по сути все то что эта штука которая пронзает весь кубер нить из которая связывает все части кубер найти совмести и все что происходит с вашими ресурсами неважно стандартными либо кастомными она попадает в вен стрим кубер не tissot и по своей сути events 3 мг убираете со и to open an lilac system то есть все чтобы записалось она попадает в конец и стандартные контроллеры которые дает вам кубер notice из коробки они управляются в контроллер менеджере это binary со всеми стандартами контроллерами и у каждого контроллера есть цикл управления пожалуйста сейчас запомните это позднее разберем и отслеживает контроллер менеджер каждый контроллер отслеживает общее состояние кластер а через вызовы к api серверу и вот такая простая картинка вот такой простой кубер найдешь в принципе и добавив сейчас в 2 с места слова кастом мы получим операторы то есть мы создадим наш кастомный ресурс его как-нибудь реализуем потом из изменения этого ресурса не всегда попадут в events 3 мг оберните со и наш кастомный контроллер он потом сочетает эти данные что-нибудь сделаешь что мы хотим и сейчас у тех кто не сильно знаком с операторами может быть возникнуть вопрос в чем же разница между кастомным контроллером и оператором и горе ос дает нам ответ что операторы это applications специфик контроллер который расширяет api айку верните со чтобы создавать конфигурировать управлять различными инстанциями каких-то сложных тут написано state full но необязательно стой стой full приложений и сравнивает операторы к steam controller они оба реализуют контроллер паттерн я этот контрольный паттерн он пришел на самом деле из 70-ых 60-х годов то есть это все то что мы забыли когда за и она сейчас в нашем кладу на эти в мире снова завоевать популярность и мы снова это используем но операторы они содержат специфичные знания о вашем продукте то есть ваш оператор он умеет должен уметь управлять полным лайк вам вашего приложения то есть установить обновить удалить и так далее так далее так далее все то есть все что ваше приложение содержит всю специфику которой вы знаете вы можете положить в оператора а кастом контроллер это обычный контроллер и часто их делают для какого-то нового простого ресурсов которого не было в кубе россия например это может быть хранить лицензия то есть у вас есть лицензия у нее из кастом контроллер он смотрит что она за их спорилась и что-то он сделал и своей компании мы еще разделяем так очень просто на самом деле не правильно мы разделяем еще операторы к сам контроллер и так что если мы пишем оператор и у нас есть какая-то специфика мы пишем это с помощью оператора sdk то есть это оператор а если мы пишем с помощью кубе билдера элемента контроллера и какой-то специфики у нас нет то есть это общий какой-то контроллер то это кастом контроллер но при этом также можно любой оператор написать на кубе бил дыре и также любой красный контроллера можно написать или оператор sdk у нас есть оператор то есть мы сгенерировали кастомный ресурс контроллер во лжи ли некий опыт эксплуатации и у нас есть наши по и как же они связаны если подумать привести аналогию то мы получим что оператор это ничто иное как система управления до картинка изменилась в принципе то она уже знакомое и все эти принципы они остались еще с тех времен тут вся теория все эти вычисления мы можем брать ее из с 70 и 60-х годов и делать наше приложение лучше у нас есть по это наш объект управления это какое-то приложение в кубер найтись и это может быть год java питон не важно нам сейчас это абсолютно операторы могут управлять любым приложением у нас есть возмущение это ивенты действия пользователей обновления версии выход из строя железо то есть все что произошло с вашим по в во время жизни в кубер не тисе есть управляемый величина это та желаемое состояние которые вы задаете в момент установки вашего ресурсных убирать то есть это количество реплик лейблы версия спецификация то все что вы можете задать это тоже чего что будет оператор стараться управлять чем есть сигнал главное обратной связи по которому вопрос все поступают в операторы и на самом деле весь убирать из построена на этой главной обратной связи на control у пах и как-то выглядит давайте посмотрим есть концепция из мира электроники это edg3 геринг и level 3 геринг edg3 геринг этот тогда когда что-то случилось и в тот момент мы запустим обработчик a level 3 геринг это мы запускаем обработчик тогда когда сигнал большой достаточно большой чтобы этот обработчик запустить либо же он наоборот достаточно малы чтобы дать сигнал запустить как вы думаете какой из видов 3 геринга выбрал кубер найти свои реализация да все так судя по ссылке внизу это все это level и давайте рассмотрим как было бы если бы обернитесь выбрал что-нибудь другое давайте рассмотрим что у нас есть пример мы хотим у нас есть одна реплика хотим потом 5 а потом две и левой стороне для вас на правой стороне для вас как должно в идеальном мире все случится в случае же edg3 геринга если бык убирать из этот подход выбрал то в какой то момент времени мы сказали купер on this дай нам плюс 4 реплики он начал в бэкграунде эти реплики раскатывать но в какой то момент мы сказали мы хотим -4 и в этой ситуации мы можем получить 0 то есть к убирать из ничего не проверил и получил 0 если же мы выбираем level 3 геринг это мы говорим каберне часу дай нам позже и при виде количество реплика пятерки а потом через какое то время когда он начнет а в играете эти реплики раскатывать мы говорим при виде количество реплик двойки и здесь в этой ситуации сложнее намного получить 0 ног обернитесь он еще и умнее он вот здесь еще делать дополнительную проверку и такая проверка называется рикон целей шлюп рикон слышен кто-то называет control лупами то есть тут уже вопрос терминологии и ufc убирайтесь и есть у каждого ресурса есть желаемое состояние и фактическое и рикон слэш клуб он обнаруживает изменение ресурсов потом он пытается изменить фактическое состояние чтобы привести его к желаемому потому что у него это в принципе может не получиться и он попробовать еще раз через какой-то период времени и разработчик которые делают клоуна эти вк убирайтесь на этих приложения он может и должен управлять этим циклом и управляется все это в операторе это обычный контейнер который за тепло этого ваш кубер нить из всего написанного но вчера вот вы видели что можно и на косы не нажали поделать и в нем реализована какая-то логика управления каким-то ресурсам и какие ресурсы бывают и убирайтесь ресурсы бывают двух видов это праймари секунды ресурсы то есть случае от стандартных контроллеров праймари ресурс этот диплом and a secondary ресурс под случай ожидаемым сета то здесь прайма ресурс будет сам демон сет секан ресурсам будет под и надо почему еще надо потому что даймондс эту важно чтобы каждый под был за тепло и на ноги поэтому этот контроллер он еще x будет следить на not за ноты случае же нашей пробеге нашего пробега оператора у нас есть праймер ресурс пробега кластер есть secondary ресурс муки персик monster и пробега контроллер и еще мало того что операторы того приложения на самом деле сейчас очень модным становится новый термин и так обернитесь на этих приложения то есть оператор это ищеек убираетесь найти в приложении потому что но займа действие скруббер найти сопи а им то есть представьте но у нас есть 3 нудный кластер на первых двух нотах бегут к билеты там запущены два каких-то приложения и они взаимодействуют убирайте сам только через кубе лет но если ваше приложение которое у нас на 3 нодди она за тепло и на через кубе лет как любое другое приложение но она еще как-то взаимодействовать burn this api и то она в этот момент становится убирайтесь не этим в приложением то есть она может получать количество реплик соседних кодов в dns ходить то есть тут уже нечего ваши фантазии не ограничен а сейчас давайте рассмотрим как мы создавали наш пробега оператор немножко вернемся назад здесь будет очень много генерального кода который облегчает нам жизнь что-то мы разберём с примерами часть просто объясню я что происходит в эти файликах потому что очень часто обычным пользователям не нужно их менять то есть в некоторых случаях даже не меняли никакие файлы мы до посмотрели что дает нам оператор sdk этим пользовались есть оператор sdk она разработана курьез сейчас the red hat вроде как сейчас живет еще и теперь объем она позволяет сделать очень быстрый старт она зги не вижу почти все за вас и оно реально сгенерирует половину из не больше оператора и эта часть операторов фреймворка в которой еще входят оператор metering для того чтобы ваши операторы можно можно было метриками каким-то обвисшей обвешивать и еще он есть менеджер или контроллер менеджер который позволяет ваши операторы как-то еще лучше управлять лучше менеджер прежде всего нам нужно инициализировать проект проект мы устанавливаем оператор sdk избит х были бы и собираем и команды оператора sdk new указываем имя нашего пробега нашего проекта пробега оператор и затем оператор sdk генерирует нам очень очень очень много файлов и вот это будет каркас нашего приложения и структура выглядит примерно вот так у нас есть билд и так там лежат различные докер файлы есть папочка тепло и там лежат различные ямале которые мы можем деплоить наши операторы есть пакадж как у любого к приложению они содержат в хадж в папочку там и там лежат apis и контроллер чуть позже рассмотрим что это такое здесь очень многих может смутить папочка cmd менеджер main . гол почему так непонятно почему с не cmd оператор main go можно предположить что это связано с тем что есть убирать пакет менеджер который позволяет как-то кастомно регистрировать управлять кастомными контроллерами а может быть еще потому что менеджер с английского только управленец и очень часто операторы больших проектов включают себя не только какой-то один бинарник но еще прям несколько операторов в одном из наших приватных операторов мы запускаем еще четыре не 43 соседних оператором то есть они нам нужны мы их используем и поэтому называем менеджером это и в этом файлики cmd менеджер main . происходит точка входа оператора . . входы любой go программы затем мы изолируем менеджер это специальный объект возможность за него это папочка так названо затем мы регистрируем кастомные ресурсы из папочке покажи apis и регистрируем кастомы запускаем кастомные контроллеры с папочки покажи контроллер и в коде это выглядит примерно вот так то есть мне новый менеджер регистрируем потом схемы ресурсов то есть кастомные нашей схемы и потом мы запускаем берем наш контроллер его добавляем менеджер и вот так всё это работает в main . гол пережде чем это запустить нам нужно создать опять создать контроллер это же мы делаем так же с помощью оператор sdk но перед этим давайте вспомним что такое кубер найти сопи сервер это опята rest api сервер он используется он может использовать через джейсон и вы можете туда preload слать либо через про то буферы здесь вы можете сделать различные crud операции над вашими ресурсами как на дефолтные так и над кастомными у вас есть кастомный ресурс который может через этапе а сервер вы туда ходите вы можете через него получать информацию о нём и плюс он еще и расширит стандартные api кубер не tissot и так же вы кастомные контроллеры через него потом могут получать информацию о своих ресурсах и вопи сервера есть своя терминология и такая то есть тип какой-то сущности которой который существует кубер не тисе это api группа то есть это количество коллекция логических связанных к эндов есть версия то есть это версия api group то есть это я думаю все видели когда писали явлен в 1 beta 1 2 1 альфа-1 там хор это вот та самая и теперь можем можем вернуться к созданию ресурсов также это все дело с командочка оператора sdk этапе и вот здесь вы видите что мы указываем ту самую api версию и в нашем случае это пробега в один альфа-1 и указываем кайнд пробега и запуская эту команду оператор sdk опять нам генерит очень-очень много кода и структура всего этого выглядит вот так здесь очень много файлов и на самом деле мы меняем здесь всегда почти только файл с нижнее подчеркивание type . гол в этом файле описку происходят различные манипуляции над и пиа им кубер notice а то здесь создается объект называемый эскимо builder и потом он уже начинает манипулировать нашими api в этом файлике и длинное название не буду читать здесь регистрируются наше типы в схеме кубер начаться то есть это файлики они там буквально под 10 20 точек и я почти никогда не видел чтобы их кто-то менял потому что оператор языка она все для нас инкапсулирует создает wrapper и и мы просто используем как библиотеку и файлик регистра . гол мы создаем объект групп вершин который потом позволяет еще попить наши но кастомный ресурсы с групп вершинкой даме кубер небеса то есть вот вся магия она вот заключена в этих файликах и в принципе если вы хотите просто начать написать оператор вы можете тоже туда не лезть этот будет работать из коробки и есть файлик пробега types . гол здесь происходит самое важное вот в для api для api аиф кастомных нас есть структура у него есть четыре поля 1 до 2 это type мета обжиг метра до то есть то что нам дает кубер нить из а вот эти два мы и сами можем их реализовать создать и с первым коль не в третьем вернее speck поле мы указываем желание желаемое состояние то есть то состояние которое потом наш каста мир может задавать либо мы сами можем задавать при установке пробеге есть поле статус это реальное состояние фактическая все что происходит нашем лесу что он попадает потом вот в эти структур ки и когда мы меняем этот файл и кстати да самое смешное своей команде мы называем ее того землями потому что по сути здесь мы берем наши старые я влип и переносим это в год вызывает структуры из кубер не tissot и когда мы меняем этот любой файл совершиться type . гол то есть неважно что пишите в свой оператор либо редактируйте чужой вы после этого должны вызвать команду операторы sdk генерит кубер нить из потому что тротро sdk для вас перегнили файлы которые of the genie лены то есть там есть гибко api файла есть я мля есть home чарт даже вроде сейчас новых версиях это добавили и эта команда она все сделает для вас когда вы поменяли ваши структуры она все перегенерировать и потом это все будет работать так как нужно и этим самым вы получили вот так просто получили кастомный ресурс то есть мы запустили пару команд чуть-чуть по редактировали этот файл и получили кастомный ресурс хорошо теперь нам нужно чтобы этот кастомный ресурс попадал в день stream и чтобы кастомный контроллер слушал этот овен stream и это здесь even стрим это все тот же even string оберните со никакого нового стрима мы еще пока не придумывали и мы создаем контроллер команды опять же из оператор sdk этот контроллер мы здесь указываем ту же самую и версию пробега в один альфа-1 и указываем тот же самый коэн в пробеге и запускаю команду оператор с деканом генерирует заготовку нашего контроллера и все это вот превращаясь вот такую структуру первые два файла это пробегая контроллер . здесь происходит магия регистрации кастомного контроллера в uber на ти то есть также здесь файлики тоже 10 20 точек почти никогда их никто не редактирую то есть оператор sdk aquarius молодцы все они для нас сделали берите пишите бизнес-логику и вся бизнес-логика лежит файле пробега контроллер . гол здесь в нем есть основные две функции их есть функция f просто обертка над функция это с маленькой буквы то есть божий у нас так мы определяем публичные методы есть функция ньюри consider здесь мы создаем объект рикон soner который нам потом позволит в будущем брать все что происходит с ресурсами типа пробега кластер то есть мы создали ресурс пробега кластер здесь его мы потом берем и потом также в этом же файле у нас есть функция с маленькой буквы здесь мы создаем новый контроллер и передаем ему рикон солер который мы создали то есть вот пробега контроллер менеджер рикон сайлер мы создали новый контроллер и вот так легко мы получили кастомный контроллер и теперь в этой же функции мы вызвали командует c watch то есть цвет объект нашего контроллера и таким образом мы подписали наш контроллер на изменение ресурса типа пробега кластер то есть у нас есть допустим нас к наш пользователи или кубер найти создаст этот ресурс которого еще не было в классе то этот контроллер с помощью вот этого метода con это заметит начнет обновлять и также если в течение этого времени мы поменяли нашу спецификацию нашей с пеку то контроллер опять же это заметит и начнет что-то делать и вот так легко и просто мы получили кастомный ресурс подписали его на овен stream и еще и создали кастомный контроллер и что дальше дальше нам нужна наша бизнес-логика и также в этом же файлики пробега контроллер есть функция рикон саяна то есть согласование на русском здесь мы должны писать всю нашу бизнес-логику все здесь наш опыт эксплуатации он вот здесь функция рикон солер она принимает объект типа request то есть что-то произошло функция запустилась с помощью рикон сайлер а мы берем что мы берем что произошло мы берем текущее состояние нашего ресурса и затем мы смотрим поменялось ей в нем что-то и в конце всего после обработки запор rosary consider мы возвращаем объекте порезал если все хорошо и р-р если все плохо а в середине всего этого мы реализуем бизнес-логику то есть у нас есть функция пробега . везде фолз я надо делает может показывать что изменилось и навар здесь у вас может быть что-то другое то есть вы посмотрели взяли ваш ресурс что-то изменилось вы запустили что то что вы хотите допустим если вы увидели что-то в ресурсы не было вы его установили у ресурса обновилась версия вы его обновили так как вам нужно вызвав там соответствующую функцию которую вы реализовали везде фоллз наш это вот такая функция потом эта проверка дефолтов потому что мы не можем нашим клиентам создавать создавать любую конфигурацию здесь мы об этом им сообщим потому что бывает так что конфигурация нерабочий на мачту нужно ловить но также еще эта функция по историческим причинам так здесь любят говорить она еще и показывает что изменилось нашим ресурсом и за это очень многие наши коллеги и не любят потому что на по сути выполняет две задачи что есть плохо в нормальном мире программирования и в принципе она встречается часто в наших операторов в публичных своих приватных мы тоже ее используем но наверное везде скоро мы ее уберем я надеюсь есть камни бесконечности а есть камни кубер нити с ее операторов флаг момент когда мне сказали федя привет ты сегодня пишешь оператор такое чего что я пишу и иди почитай я почитал я прочитал про кастомный ресурс про кастомный контроллер все понял но в тот момент я не понимал как все это как вся эта магия начинает работать как все это запускает и я даже сказал на одном из наших митингов простите я туман молодой тупой но прошло время я разобрался набил шишки повзрослел поумнел и понял что есть 3 главных вещи чтобы операторы а жили это контроллер runtime это специальный п которой написала сик убирается sick ips они написали специальный пейдж чтобы делать манипуляции над серди над духовными купер найти сопи ами есть пакет при consider это тоже написан вроде бы ими же и это специальный интерфейс который вы имплементировать и чтобы ваш контроллер заработал и во время создания контроллеры когда его имплементировать они получают различные фичи различные возможности для того чтобы как-то взаимодействовать к убеждайте сам и самое простое что сломала просто мне мозг и того клиент вашем операторе может быть go клиент вам ничего не мешают если вашем операторе нужно узнать количество нот на классе go клиент вам поможет и какой-то момент когда это узнала у меня просто сломалась голова потому что я думал это все намного сложнее а это все оказалось реально простым просто нужно взять один раз разобраться и просто писать хорошо мы сгенерировали оператор запустили разобрались как он работает нам нужно тестировать как-то его тестирует его по-разному есть фейковый go клиент его очень удобно использовать для unit тестов вы можете создать различные маковые объекты и потом протестировать ваш оператор оператор sdk позволяет запустить ваш оператор вас локально и подключить его к удаленному кубер notice кластеру и затем это все будет жить очень удобно и вы можете либо жить там и сайтов спокойно легко есть для нтн тестов используют г и ginga но гинга и тоби север driving фреймворк из голлинга если вы его видели то там происходит что что-то мы делаем expect без ошибки либо эксперт там что-нибудь ошибку такую-то такую-то такую такую то это все превращается вот в такие полосы текста их читать невозможно мы это не любим поэтому мы используем робот фреймворк да это питон да это робот до его многие не любят но нам он нравится за то что робот с юты очень удобно читать любой менеджер может прийти прочитать что происходит как вы тестируете ваш оператор либо что-то ваш продукт это то с чем мы смирились это используем и еще у нас есть такой вид тестирования называемые longevity потому что нашей системой хранения нужно проверять на длительном промежутке времени что они хранят данные что они хранят с нужными характеристиками что все хорошо и так же операторы которые для клауд на этих приложений для clown и этих sdk схд они тоже проходят через этот вид тестирование мы сгенерировали разобрались как тестирует и те же эксплуатации собственно ради чего все пришли сюда и это на самом деле самое интересное и самое сложное потому что эксплуатацию и и приходится получать через боль кровь и опыт кого-то кто работает и поддерживать ваше приложение и эксплуатация ее можно сравнить любовью к вашему продукту страстью к делу с так как вам нравится ваш продукт или как вы его ненавидите и поэтому эксплуатации она идет она вот здесь вот она не здесь она вот тут она вот-вот и еще она в коде мы рассмотрим примеры которые реализованы в пробега операторе это установка пробеге rolling upgrade и проверка компонент кластер а и рассмотрим примеры которые lisa ann и где-нибудь еще где я не могу сказать но они реализованы честное слово и вот такой нас план на третью часть первый пример это установка пробеге она реализована из-за того что пробегаясь у него по специфичную эксплуатация и мы сначала всегда устанавливаем только внешние компоненты это может быть конницу keeper и затем мы устанавливаем только внутренние мы устанавливаем сначала буки пир потом пробега контроллер а потом пробега signin створ то есть только в таком праве порядке и специальными онлайн и средне с пробами между каждым этапом есть это сожалению убирайтесь просто так не сможет нам установить нашу пробегу и в коде это выглядит примерно вот так где-то внутри нашей реконструкции когда мы видим что ресурса не существовало мы вызываем функцию диплом кластер которая уже вызывает deploy букет верди play контроллер deppa deppa сегмент стар и все что нужно для установки пробеге они себе содержат следующий пример это не простой rolling a grey это сложная многоступенчатая процедура вот это одна из блок-схем то есть мы проверяем версию можем ли мы на неё обновиться и начинаем что то делать но еще есть блок-схема которая показывает что нам нужно поставить кондишен что мы обновляемся и начинать обновлять то есть я надеюсь доказал что это не простая процедура и к сожалению к убирайтесь нам ее выполнить не может и поэтому нам пришлось ее реализовать в нашем коде и делаем это так же то есть мы сначала обновляем внешней компоненты мы не трогаем а обновляем только внутренние и обновляем также по этапам то есть мы установили буки пир обновить что-нибудь сделали проверили лайн и средней пробы потом установили контроллер тоже проверили что все хорошо а затем мы сделали обновили сегмент стар и между этими установка между этими этапами мы еще проверяем что все все хорошо если что-то пошло не так там мы должны еще и откатиться обратно сделать rollback и это оператор нас тоже наш оператор тоже так умеет следующий пример это проверка компонент кластера и это относится к то что пробегает распределенная система то есть у нас где-то в нашем и конца функции в какой то момент времени вызываются функции типа синхронизации размеры буки pervasive синхронизация размера сегмент вора и контроллера и здесь мы проверяем что там реплики которые нужно есть они крепки которые установлены они соответствуют нашей конфигурации то что все хорошо и в принципе убираете с фоном это тоже можешь гарантировать но здесь мы хотим еще больше контроля чтобы наша пробега наше приложение были надежнее и качественнее и это все что касается справедливо три таких примеров дальше пример которая лицо ван где-нибудь еще это масштабирование давайте представим что есть оператор который за diplo l2 реплики чего-то и он еще умеет ходить prometheus который снимает метрики из нашего приложения и принципе если что-то пошло плохо и нашим репликам стало нехорошо нагрузка возросла late in se увеличилось с руку системы упал то оператор везде это зачитывая метрики он может принять решение из-за деплоить количество реплик сделать их большим чтобы леденцы чтобы суп us системы нашей уменьшился чтобы увеличился чтобы lighten7 вы равнялась и тогда когда все это произошло когда оператор про читалось prometheus а что все хорошо то мы можем обратно количество реплик снизить вернуть всё назад и наши ресурсы не будут лишние использоваться и мы будем экономнее еще следующий пример это использование других операторов то есть вам ничего не мешает вашим кодом с помощью магии языка гол за импортировать какую-нибудь структуру из другого оператора и затем просто вы начнете в вашем коде работать с этой структурой как обычным любом языке программирования как и в обычном любом проекте вы можете проверять что-то устанавливать менять то есть вы не чем здесь не ограничены затем вы можете установить с помощью холма то есть вы берете показывайте ваши мхам чарте что у вас есть зависимость зависимость зависимость вашего оператора от например за киппер оператора затем home для вас все это установит есть куб сетей всегда он наш помощник он никогда не пропадет то есть вы можете просто взять и амлет с чужим оператором заплатить после этого заплатить ваш яму с вашим оператором и это все заработает поднимется и кубер notice ваше приложение начнет жить в нем и все будет хорошо следующий пример этому сидеть здесь и по-русски многовариантность главное в мире очень любят грамотное использование ресурсов поэтому это слово сейчас снова на пике популярности то есть это когда у нас есть несколько экземпляров чего-то которые работают в одной среде и они как-то логически изолированы то есть еще примером может быть что у нас есть один кластер у нас много приложений допустим у нас много prometheus of для каждого отдельного нашего приложения и вот это будет называться все мысли тенденция и у нас есть пример допустим что у нас есть оператор у него сзади про за тепло и на 3 инстанса приложений которые оператор за которыми следит за которыми который мог для которых он создан и они умеют этот оператор умеет все дело с этими приложениями и в принципе сейчас убирайтесь нам это может гарантировать и он это умеет делать то есть убирать из он умеет же тепло от несколько инстансов какого-то приложения но если ваши кейсы сложнее если вам нужно больше контроля то вам ничего не мешает в коде реализовать какие-нибудь контекст и использовать обычную синхронизацию там мьютекс и семафоры использовать мощные контекст и использовать член алызга и потом в каждом из каналов вы можете делать каждую инстанциям вашего приложения то что вы хотите то здесь вы ничем тоже как я уже говорю ничем не ограничены все что вы сможете написать вы можете положить это в оператор и также примером может быть сервисный процедур над вашим по то есть по которым управляет оператор вы можете с ним что-то делать с помощью этого оператора это может быть например миграции сервисов not пиве то есть принципе убирать из это умеет делать но опять же если ваш эскиз и сложнее вашем приложении не супер clown этих как хотелось бы то вы можете вашем операторе реализовать логику которая перед миграцией калым сервиса выполнится этом отправить запрос что-нибудь обработается и потом с мигрируют и также кейсом может быть миграция пиве сейчас кубер notice в версии 115 и 116 он как альфа пометил волюм cloning то есть вы можете сказать cooper tissues клонируем не волюм на какую-нибудь ноду либо вам там в какой-нибудь из cso и плагинов это если это уже реализовано и эту же логику вы можете перенести в оператор то есть взяли перри мигрировали пиве приложение переехала все хорошо также может быть minds мод то есть вы можете ваше приложение ввести в main thing мод для например апгрейда кубер не tissot то есть вы когда вы вели ваше приложение оно стало меньше функций каких-то меньше функционала выполнять но в то же время чтобы кастамере ваш это для него было незаметно то есть вывели mind он смог что-то сделали с кластером либо через опять же сделать что-то сделали с приложением потом вывели оператор это послать ему сигналы приложению перевел его в нужное состояние обратно и все стало обратно хорошо и обычно есть half чеки вы тоже можете их реализовывать ук убирайся есть line is радость пробы но если ваше приложение не соответствуют манифест 12 факторов то скорее всего лайн и солидность пробы кубер notice они вам не подойдут потому что они умеют ходить на рост ходить надписи проверять файл то есть бывает так что какие-то приложения не умеют там по историческим причинам они не умеют этого делать здесь вы можете в операторе реализовать то что является halls чеком line is пробы reddy's пробной проба если ты вк убирайтесь и говорить и вы реализуете вы заходите на какой-то запрос получите ходит xml q обработайте и в операторе скажите что все окей ваше приложение живет все нормально и все хорошо все что вы положили в код тот кто будет вашим хавчиком и таких примеров в принципе можно придумать просто огромное количество то есть все что вы накопили о вашем приложении она может если она подходит для того чтобы эксплуатировать его в кубер найтись и то вы можете положить в этого оператор то есть просто если вы понимаете что это лучше делать кодом лучше за автоматизировать кладите этот код и все будет работать лучше и надежнее и в принципе я надеюсь я доказал что вжух и операторы это все просто легко и просто это все красиво никакого я бля ну почти никакого но как теперь его нам запустить и я вам набрал наврал я думаю вы это уже заметили по ходу презентации zhu hai снова ямале и сейчас в мире к убирайтесь к сожалению без я мля какого-то минимального не обойтись и в нашем случае нашим спасением либо нашим проклятием тут как посмотреть стал home когда больно неудобно но нет никого верните свои развертывания да все с этим согласны это было сказано 2016 году на первой конференции 2 я абсолютно согласен все подписываюсь под это но он правда удобен для конфигурирования 1 хорошо относительно удобен для конфигурирования вы можете сделать максимально минимальную конфигурацию вашего я бля то есть сделать и настолько маленькой настолько простой что потом когда вы будете сопоставлять клиенту вы ему нужно будет изменить всего лишь там 5-6 строчек они смотреть на тонны ваших манифестов и это будет на этом каждый человек сна это будет способен чтобы прочитать и изменить и плюс еще home чарты они умеют инкапсулировать создание серди р баков сервис аккаунтов сожалению вот без этого всего убирайтесь пока не как и будет без этого когда отработать неизвестным вы здесь с помощью home chart вы можете взять всю логику тепло и вот этого всего не красивых вещей вы можете ее спрятать от каста мира и сделать проще красивее и у вас есть всегда - я мыл и в случае возвращались пробеге у нас есть пять параметров основных пять параметров если вы не какой-то не продвинутый конца мира вы просто хотите запустить здесь вам важно всего лишь на самом деле одна конфигурация это размера волюма под кэш то есть вам может быть достаточно 20 гигабайт может быть достаточно 200 то есть в принципе одну настройку реально изменить а если вы продвинутый то вам ничего не мешает менять и другие если вы уверены в этом и все хорошо либо вы просто разработчика вы можете вы знаете что вы делаете на самом деле индустрии идет этим путем ластик клауд он каберне this они выпустили свой оператор он умеет очень много он умеет устанавливать удалять а он еще на самом деле умеет работа с локальными дисками если вы устанавливаете убирать из он прям на бал ли метр то есть он просто комбайн есть сколько house оператор от яндекса то есть он тоже умеет устанавливать удалять обновлять то есть если вы house запускаете в принципе тоже хорошо есть prometheus оператор это тот оператор который было вообще на самом деле одним из первых сейчас внутри этого оператора около десяти кастомных контроллеров то есть он просто умеет все но он имеет диплом prometheus граф она умеет тепло и knot экспортеры туда уже включены даже борды для кубер лечится то есть просто ну просто чудесная систему управления всем и таких операторов все больше и больше их много они становятся все чаще и чаще production рейде люди их используют не бояться и на самом деле мы тоже туда идём и я один я иду туда ни один и сейчас я поблагодарю а потом мы вернемся к выводам я иду туда со своей команды это миша руслан и саша сколько шишек набили сколько всего мы сделали вместе сколько фэйс palm of мы словили не сосчитать но мы сделали это делаем все вместе и расширяем наш кубер нить из и также помочь доклад сделать не тот и показать что это писать операторы легко и просто не помогали вот эти люди это алексея copy on михаил саломатов анастасия соловьева спасибо вам большое и какие выводы все в код ну все сейчас все пишут код поэтому и операторы и опыт и программистов все туда в код это проще дешевле надёжнее и лучше оккупировать из это фреймворк это не просто система регистрациями контейнерами но если немножко сделать поменять еще еще раскрутить то это фреймворк который позволяет писать ваше приложение по новому делать приложение совершенно другие да конечно это иногда плохо потому что вы winder ложитесь на кубер не this но ближайшие сколько лет лет пять как убирайтесь никуда не пропадет поэтому возможет вообще будете просто commodity как стало сейчас докером поэтому я лично и мы не видим ничего страшного операторы эта система управления то есть это та возможность которую дал вам обернитесь сделать эксплуатацию автономной сделать ваше приложение лучше и надежнее чтобы они работали намного круче в кубер не тисе и поэтому раньше еще все говорили что операторы кастомных контроллер это круто это примитива это примитив ресурса в ластик search например или prometheus а да это так но не забывайте что операторы этим не ограничиваются это что вы можете сделать с ними это все что в вашей голове и вашей фантазии и низкий порог входа много делался за нас да это так операторы sdk кубе билдер мета контроллер который еще и это контроллер он еще и позволяет писать на питоне на джаве . языка независимый позволяет вам не запариваться о том что ну как нам взаимодействовать убирать и сам они все для вас уже абстрагировались подняли на уровень выше вы просто берете используйте их библиотеки примитивы и просто пишите вашу бизнес-логику и пишите операторы это круто легко просто решить их качественно тестируйте чувствуете боль ваших заказчиков делать их счастливее и делать мир лучше на это у меня все спасибо всем кто пришел вопросы о да из-за три лучших вопросам я подарю три бутылочки от нашей компании мои так у нас осталось совсем немного времени на вопросы но возможно ради бутылок мы задержимся в общем вопросов прилетела много поэтому я начинаю первый вопрос как бы вы выкручивались если бы не было операторов кубер notice было бы намного больнее но я даже не могу на самом деле представить раньше нашего где я работал у нас было 25 ям lei мы тепло и любовь скриптами но когда что-то шло не так приходилось каким стилем что-то делать и было нереально возможно если бы не операторы и не возможность перенести все это в ход то мы бы придумали код решение чтобы как-то клип сетелем все делать как то скрипт и писать кроме джозеф убирайтесь запускать не знаю что можно ведь я думаю это нормальный ответ что вы используете в качестве сторож слоя для своих операторов насколько я понимаю вот в случае пробеге возвращаюсь у неё стеван и тир-2 остановишь тир-1 это буки пир и для него что-то отдает волю мы то есть над случай пробеге мы не рассматриваем что типа у нас вот нам кто-то дает волю мы ить это обычно тот кто дает нам тир 2 стороны а случае если мы говорим о ком-то абстрактным стороны вк убирайтесь а то если это bare metal то часто эти же самые стороны там очень много их сейчас появилась они как бы сами уме с локальными дисками работать а если это говорить о клаудио к опеке есть амазоне ижоры google claude то там тоже очень часто есть то что дает сторож то есть случай пробеге нам нужен только тир 2 ст врачи обычно это рассчитано что это кто-то его нам даст вот бывает так что мы сами делаем спорыш для себя тут есть вопрос как апгрейдить оператор но ты рассказывал но я рассказывал как апгрейдить приложение которое управляется оператором самом деле операторы легко крепится и они в принципе спокойно обычному rolling апгрейдом убирайтесь rolling апдейтом убирается обгадиться то есть у нас не было ситуации когда наш оператор мы роллингов зрителя с ним что плохое случалось то есть принципе здесь убирайтесь нам помогает трудоемко ли делать операторы не на год наверное нет если вы знаете свой язык хорошо и знаете какие опекал и убираете со дергать в принципе все можно сделать и вот у меня то контроллер он языка независимый и в принципе вы можете это сделать ну и вчера в принципе картин деэссер то что показал fedora виктор в принципе я вчера думал что можно взять этот dsl засунуть в контейнер и тоже будет оператор принципе все возможно и тут вопрос похожие потом если фреймворке для операторов чтобы писать на других языках или у оператора sdk кода генерацию заменить на другой язык ну насчет оператор езды к ней не знаю ну вот есть место контроллер там все нормально то есть и тон там точно есть так если возможность использовать операторы не имея прав кластер админа наверное да можно потому что не всегда операторы которые я видел они требуют что-то такого кластер админа то есть там есть рыбаки есть сервис аккаунты и в принципе их можно ограничить обычно которые как он там нет хаббл найти операторы то там обычно всегда они из кластер админами в принципе можно попробовать изменить я думаю что будет достаточно api львы open api v3 схема для серди используете ли призеров она unfelt насколько вы серьезно следите за валидностью спецификации вашего ресурса все зависит от проект для операторов где я сейчас работаю мы еще не перешли на это потому что недавно выбирайтесь завезли где-то в другие я видел что стараюсь это делать как от миграция версии serie de создаете еще одну версию или меняете старую тоже зависит оператора насчет пробега оператора честно признаюсь не смотрел как они это делают то что я рассказывал навык на его примере а вот в наших мы где я делал я участвовал разработки мы бывали меняли дамы меняю в основном вопроса старую серди а новую даже не помню пробовали или нет пока вроде остановили что меняем просто обычно серди они не часто меняются потому что мы там один раз описали в принципе все статично получаешь нашем случае реализован либо перейти sdk из коробки корректный лидер election в случае если в классе окажется два оператора до реализован там есть я в коде не показывают . есть лидер олег шин вот и последний вопрос используете ли вы файл лазеры для корректного удаления ресурсов дам используем в пробеге вроде этого нет но в наших внутренних мы используем потому что позволяет как бы там киви си правильно почистить а какие-то ресурсы которые там воды возьму чистим плюс там различные некоторые наши сервис процедуры они заключены афину они завязаны на финальный лазеры кубер нафиса"
}