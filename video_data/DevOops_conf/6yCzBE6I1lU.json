{
  "video_id": "6yCzBE6I1lU",
  "channel": "DevOops_conf",
  "title": "Антон Архипов — CI больших проектов в JetBrains",
  "views": 861,
  "duration": 3536,
  "published": "2020-02-07T07:54:19-08:00",
  "text": "у здравствуйте очень приятно видеть так много людей я не думал что в конце конференции эта тема выйдет без визы вызовет интерес давайте немножко чуть чуть больше познакомимся чем меня приставили до меня зовут антон я работаю в компании jetbrains а живу в таллинне работаю из дома и работаю должности девелопера думаки то есть если из фоточки и понятно то моя основная задача это общаться вот и да я работаю девелопера 2-ки этом в команде тем сети в основном иногда и немножко помогают проекту intel и джорди тоже иногда что-то говорю про котлин но мой фокус все-таки полностью на тем сити просто чтоб не понять кто здесь в аудитории сидит сколько людей здесь когда-либо использовали фелисити используют или использовали а сколько нет чтобы так немножко понять окей 50 на 50 или 60 на 40 примерно так сегодняшний так вот он немножечко этим сити ну или по применению эти lucite в контексте разных проектов jetbrains естественная в этих всех проектах сам не участвую и моя задача была пойти собирать эту информацию и как-то упростить рассказать вам для тех кто уже использовала тем сити может быть будет какая-то полезная информация фоне того как же мы его используем своих проектов для больших каких-то сборок а для тех кто не знаком с теми сети может быть чуть-чуть познакомиться тоже будет полезно вот значит герб нашей индустрии он принципе символизирует любой продукт любой проект когда вы делаете какой-то инструмент или продукт который будут использовать другие вы никогда не знаете с какими сценариями на самом деле вы столкнетесь с чем популярнее становится проект тем более больше таких сюрпризов извлекает в каких ситуациях люди начинают его использовать и на каких масштабах это относится к jetbrains в частности даже со своими инструментами что такое большой проект так вы думаете есть какие-нибудь такие сразу журнала большой проект это сто пятьсот тысяч кода в одном файле педро двинув хороший пример да но этот конкретный пример а какие параметры большого проекта могут быть существенно например какой то количественный фактор может быть до например количество строчек кода ну не совсем количество строчек кода может показывать на то что или влиять на то что например за ваша сборка вашего проекта будет занимать немножко больше времени и с большой надеждой написали на на это большее количество строк строчек кода есть больше количество тестов но не всегда другой например параметр может быть много модулей это как-то коррелирующие в принципе параметров на не обязательно у тебя вас могут быть очень маленькие модули что в принципе потом мы видим дает какое-то преимущество правок в единицу времени относительно сиай количество право которые входят в систему она имеет прямое влияние на то насколько система загружена то есть чем больше программистов делать правки тем лучше как лучше относительно веток в репозитории например может быть вы платите ветки там какими-то большими пачками то тоже создается на розочка ресурсов для сборки всего этого может быть у вас проект большой вот по всем этим предыдущим показателем агент всего один для сборки и людей при частных проектов может быть тоже разное количество чем больше людей тем больше шансов что они будут генерировать какие то правки вот комбинация всех этих вещей в принципе создает какую-то какой-то набор для того чтобы определить большой проект или нет большой проект может быть не активный проект он просто собирается раз в месяц там за пару минут и все какая-то вот постоянная нагрузка на сей а все-таки на активном проекте создается очевидно сегодня у нас докладе будет три проекта который я выбрал для описания при этом естественно мы будем говорить немножко этим сети в двух контекстах 1 контекст этого что тим сеть из себя представляет для больших проектов и тем сити как сам как большой проект он достаточно крупный проект а когда команда тут нет у них несколько продуктов но я вот обозначил его логове шартр принципе он достаточно хорошо обозначает контекст и естественно продукты на базе платформы intel же идея мои самые колледжа идея как пример поехали немножко поговорим о тире сити о контексте его применения внутренняя инсталляция тем city jet brace вообще сам проект начался 2006 году или первая версия может быть даже появилась 2006 году и вот внутренний сервер сейчас содержит более 4 тысяч проектов активных где-то двадцать семь тысяч конфигураций порядка тысячи агентов коллеги говорят что уже было больше тысячи но скриншот никто не сделал это не самая большая инсталляция simcity который мы знаем есть наверняка в аудитории люди которые использовать его в более нагруженных проектах или или контекстах но тем не менее он достаточно показателен для какой-то такой найти нагрузки вот мне скриншотик есть для подтверждение моих слов со внутренними столицы и ну так я скажу что эти цифры выросли и за два года в два раза то есть рост принципе нелинейны если мы будем учитывать 2006 год и топология нам нужно понимать так он примерно работает какая топология для последующих объяснений довольно все просто есть основной сервер который отдает и life который вы заходите видите результаты что-то может быть конфигурируете через этот юань и есть какое-то количество агентов на нашем случае порядка тысячи где есть постоянные агенты железная которая крутится на на на настоящем железе и есть так называемые облачные агенты которые могут подниматься динамический опускаться динамически в во внутреннем нашим дата-центре мы используем бмв и сфер для того чтобы поднимать такие агент но тем не менее для некоторых проектов используется еще и amazon эти агенты формируют называемые пулы и эти пулы назначаются на проекты то есть у одной команды может быть больше на другой у другой команды меньше зависимости от требований кроме того поскольку нагрузка растет за счет этих агентов есть возможность выносить некоторые функциональность некоторые возможности сервера в во вторичную инсталляцию то есть есть основной сервер есть вторичный сервер и вот разные разные функции могут выноситься на эти вторичные сервера так например как одна нота может забирать обрабатывать результаты с агентов вообще работать с агентами другая например может опрашивать системы контроля версий на предмет изменений в проектах steam сети вообще очень много разных функций и меня многие коллеги должны называют его таким звездолетом но обо всех мы естественно сегодня не будем говорить нам 1 часу не хватит на это дело мы пройдемся по некоторым на мой взгляд важным аспектом или важным возможностями телесети относительно этих больших проектах которых мы сегодня будем говорить но начнем все равно с простых вещей вот примерно так выглядит ваша конфигурация простом нормально маленьком проекте собрать проект упаковать его в докер куда любит это слать имидж это одна конфигурация в которой есть три шага да все очень просто и это же конфигурации можно создать в котле то есть у нас свой disel который можно конфигурировать проекты и сборки и класть это вершин контрола все все здорово более сложные или так называемые конфигурации курильщиков выглядит наверно так там много шагов сборки интересным аспектом может являться то что эти шаги сборки могут быть очень разные какие-то вызовы утилит вызовы on the вызовы build системы и так далее когда вы видите вот такое должны обязательно озаботиться тем или озадачиться тем что может быть не так какая проблема в такой конфигурации может быть конфигурация сборки выполняется на агенте как бы одним разом нет возможности перед использовать результаты можно было поставить какие-то костыли но это не нормально то есть если у нас вот такая конфигурация которая исполняет много много много шагов скорее всего нам будет запускаться довольно долго час-два неважно у нас нет возможности это ускорить прямо вот напрямую в лоб каким-то способом даже большую машину какую-то взять более мощную наверное не получится чтобы на порядки ускорить сборку когда вот такое видите есть смысл подумать как бы логически разгруппировать эти шаги допустим на гору на одну на две группы на три или четыре сколько вам надо и это можно за конфигурировать опять же в в дешели то есть если видите смотрите на нижнюю часть там есть такой блок который говорит меня есть зависимость от dependency is built by есть зависимость набьют а то есть формируется некая цепочка вот этих вот конфигураций и они формируют на самом деле направленный граф внутрь этим сити и естественно есть на вход подается какая какой-то исходный код или даже много репозиторий может при этом использоваться вот это вот красота на самом деле может выглядеть немножко по-другому когда очень большие проекты много конфигураций это начинает выглядеть как микросхема не очень как бы становится удобно использовать но поэтому у нас его команда взялась и решило навести красоту и теперь гораздо более удобной работать есть еще что пилить и что допиливать но тем не менее даже вот сегодняшний сегодняшний вид этого уже не приводит в ужас а он теперь вместо микросхем напоминает какую-то такую звездную систему окей объяснять мы будем все равно на простых вещах чтобы нам было так понятно я сильно упрощаю примеры презентации и вот эти цепочки я считаю в тем сети они как бы прямо вот ядро если вы умеете пользоваться понимаете как они работают с этим инструментом сделать можно очень много и очень много он вам как сказать поможет в ваших ваших проектах значит две очень важные вещи которые он дает больше на самом деле эту цепочку эти цепочки можно много разных опций выбрать но две вещи которые вы получаете сразу же по умолчанию это поведение по умолчанию в таких вещах это перри использование результатов сборке-разборке то есть между разными шагами этой цепи вы сможете переиспользовать результаты из там не было изменений и синхронизация ревизий в цепочке если у вас много репозиторий с которым с которыми эта цепочка работает сейчас попробую все это объяснить значит но перри использование результатов сборки довольно простая вещь может быть интуитивно понятным давайте приведем пример вот у нас есть какое-то изменение в одной из репозиториев ясно что нам надо а перезапустил сборку где-то в середине этой цепочки и понятно что все которые от нее зависит должны быть тоже перезапущена но вот первая конфигурация не должна быть перезапущен да и даже вот на таком простом примере мы вдруг выиграли 20 процентов наивная математика но тем не менее у нас есть статистика которая каждый день собирается в зависимости от того как какая конфигурация запускалась на каком агенте там есть и вместе который примерно считает потенциально сколько бы времени сэкономили не перед запустив такую-то сборку и это вся статистика как-то складируется есть это примерная оценка это не точная далеко оценка но тем не менее концу дня это на прошлой неделе я попросил коллег собрать сделать крышу сик и получалось так что на 6 часов вечера мы успевали сэкономить 13 1419 сборок то есть не запустить их переиспользовать результаты и если еще 2 оптимизация которая позволяет заменить как сказать сборку в очереди она немножко меньше до эту тем не менее вместе они дают очень много и что выливать абсолютное числа элитные часы вам ничего особо не говорят что там семь тысяч часов сэкономлено или нет 3000 с половиной часов сэкономлено из 7300 но вот цифра процента она даёт примерно понимание того что если бы мы этого не делали нам надо было бы увеличить количество агентов на 33 процента это очень здорово и счета в некоторых проектах это экономия гораздо больше потому что это эта цифра это среднее по jetbrains все зависит от как сказать формы этой цепочке вторая вещь это 2 как сказать возможность цепочек это именно синхронизация ревизий что это означает вот возьмем этот пример секундочку глотнуть ok поехали дальше вот та самая же цепочка у нас есть четыре репозитории 4 git репозитория в них есть какие-то ревизии 1324 и пролетаю какое-то изменение 1 рыб история у нас изменяется ревизия в 1 репозиторий на двоечку то есть у нас сборка должна быть на 2-3 24 вот такая сборка запускается simcity берет вот эти все конфигурации кладёт их в очередь и который запускает их в порядке собственно определения их в этой цепочке то есть для первой сборки у нас запустится на сборка на ревизии 2 и 3 2 и соответственно потом на 4 у нас допустим тесты лежат в одной репозиторий моих просто поделили 1 zboard может занимать время допустим мы собираем там действительно самую большую часть нашего приложения наш jar какой-то или наш нашему собственно весь весь код приложения и вот здесь вот такой момент что в момент вот этой сборке пока ждёт вторая сборка очереди может например ваш коллега отослать новое изменение в репозиторию а если бы синхронизации ревизии не происходило наша сборочка от мутировала бы относительно изначального состояния то есть на момент старта мы ожидали сборку 2324 а теперь она вдруг мутировала на 2-3 4 в основном вот если мы вот вот прямо вот так вот это случилось есть шанс что ничего не произойдет ваша сборка соберется она будет зелененькая но если вот более простой пример привести и дальше вот развитие этой истории в этот же самый момент почему вот вы сделали изменения во второй части этой во второй репозитории или в трети репозитории с 2 на 3 до может быть у вас она завязана на изменение в другой репозитории тоже вы сделали как бы колит в 2 репозитории и тут такой момент мы уже если вы синхронизируем нас получается мутант вот этого 2-3 4 но он должен быть должен включать в себя вот это изменение которое с 3 на 4 произошло то есть у нас очень странная сборка получается и если у людей такое происходит то очень велик шанс того что сборка начнет мигать то есть если у вас мало правок входят в систему скорее всего она мигнет и следующая сборку уже будет опять зелененькая если у вас много людей работает над проектом и правки летят в систему все больше и больше такой весь поток правок грубо говоря тогда себя начинает мигать и рано или поздно он входит вообще в красное состоянии что как бы очень плохо вместо этого как это решается вот на момент начала сборки 9 собирает так называемый snapshot из этих ревизий если у нас опять этот сценарий происходит из произошло изменение 1 история из первой резина вторую зафиксировали этот snapshot запустили сборку если прилетели опять ревизии какие то получится вторая сборка и она никак не мутирует вам в момент как бы запуска первый раз получится 2 сборки с консистентными ревизию это очень важно в контексте больших проектов и когда у вас много людей делают правки в системе хорошо значит поверх этого есть возможность работы с врачами да сколько у нас гид самая популярная в мире система роли версий там есть branch и и если у вас branch и по конвенции названы более-менее одинаково simcity начинает синхронизировать эти версии по врачам тоже допустим если правка летит фичер 001 он соответственно сделать сборку по всем этим композитором и если там нету такого branch out в какой-то из репозитория он возьмет branch по умолчанию чаще всего branch помочь они это мастер обратная ситуация может быть когда вас немного репозиториев а1 и в репозиториях лежат эти под проекты в подкаталогах и в принципе точно также легко можно попить на конфигурации с помощью чекаут роуз есть такая вспомогательная возможность для каждой конфигурации задать что из этой репозитории выкачивает такой-то выкачивать такое-то под дерево ну естественно тогда с врачами это работает с ветками то работает очень просто не надо синхронизировать ветки между репозиториями все это к тому же напиться на агенты то есть у нас есть какой-то пул агентов сборка у нас распределена по цепочке она еще распределена по агентом может быть потому что например какая то часть нашего проекта при сборке требует джаву у нас есть агент из джавой какая-то часть может требовать докер там есть отдельные агенты с докером и напустим какие-то тесты у нас вообще должны запускаться на динамических агент где-то вклад такое тоже можно организовать вот давайте перейдем теперь мы знаем немножко контекст работать m-city ее основное как вот это вот возможность работы с цепочками сборок и теперь я хотел бы немножко рассказать про то как тем сети используется в проектах и вот как тем city 1 пользу используется в проекте simcity разработка в основном тем сити ведется в мастера или как есть методика ее часто обозначают trang beach девелопмент очень часто люди слышат термин они думают что врачей совершенно нет это не так врачи могут быть просто они мало живущие очень быстро происходит интеграция обратно в мастер но в данном контексте это не так важно главный модуль живет вот у него есть одна история мастер на самом деле этих репозиториев еще куча нос каждый плагин в своей отдельной репозиториях живет плагинов много соответственно репозиториев тоже очень много но будем говорить относительно мастера именно ядра m-city вот идет разработка в течение дня происходит какая-то работа инженер и добавляют какие-то правки система контроля версий и в какой-то момент дня а точнее в 5 часов происходит так называемый review бьют или review сборка что это означает и для чего это вообще делается цель каждое утро выкатывать новую версию тем сети на всю команду компания то есть внутри jetbrains simcity используется как ночной build каждое утро выкатывается новая версия для того чтобы понять насколько стабильно правки насколько полезной правки может быть какие то баг фиксы может быть какие-то новые вещи которые мы хотим показать сначала на себе внутри а потом уже вы хотите брались потому что релиз происходит два раза хотелось бы видеть прогресс гораздо чаще это позволяет более обеспечить более быструю обратную связь проекты крупные внутри jetbrains соответственно у крупных проектах мы быстрее видим эффект новых изменений так вот в 5 часов происходит сборка из всех этих репозиториев всех этих веток результаты что туда попало есть отдельная страничка внутри тем сети куда дежурный по сборке в этот день может прийти посмотреть какие сборы какие изменения туда пришли все ли хорошо и если что-то нехорошо можно еще есть окошко так называемое вечерняя где можно сделать какие то правки вот но если все хорошо эти коммиты из мастера перенесутся в отдельный branch которая называется у нас бил сервер и вот за эти 2 часа если у нас какие-то правки изменялись происходили и мы хотим их еще тот же добавить в этот branch чтобы на следующее утро их выкатить можно сделать дополнительные какие-то в носке в этот в эту ветку и соответственно вот это состояние которое мы получили в этом в этой дополнительные ветки помечается каким-то тегом их всего два вместе 20 означает примерно следующее 1 авто я его там называется по другому просто чтобы нам лучше было понимать те которые обозначают авто означает что апдейт сервера на следующее утро может начаться автоматически без надзора инженер и начали тогда начнется гораздо раньше там в 4 часа утра и к семи часам утра когда первые может быть люди начинают смотреть на сервер там уже все готов если выставляется тех ману означает что апдейт начнется и обновление сервера начнется позже под надзором кого-то из команды он все равно начнется рано там семь часов утра но тем не менее там кто-то будет кто будет за этим процессом следить чтобы если что быстро подставить костыли key ok то есть масло выступает 4 часа утра запускается процесс автоматическое обновление здесь кажется довольно интересный интересное решение сделано поэтому я хочу вам о нем тоже рассказать значит вот у нас есть условно наш кластер есть сервер тем сети есть агенты на которых могут уже уже в этот в этот момент уже в 4 часа утра могут бежать сборки на той же самой машине вместе с сервером установлен еще дополнительный агент для обновлений что прямо рядом с тем сети бежит он никакие сборки не запускает он сделан именно для того чтобы утром обновлять и висите вот в четыре часа у нас запускается этот процесс что первым делом делает агента он естественно посылает сигнал тем сити на то чтобы он остановился в это время сборки могут еще бежать то есть сборки не останавливаются когда ривер сити отключаются агенты бегут когда работа закончится они снова подсоединятся к тем сити когда он уже подняться поднимется агент который производит вот это вот обновления он после остановки тем сети запускает уже сборку сама этим сити и оно происходит очень быстро потому что на самом деле сборка произошла предыдущим вечером и мы теперь вместо того чтобы полностью его пересобирать можем переиспользовать результаты сборки то есть запускается тот же самый процесс сборки который обычно его собирают но он происходит там не за полчаса как мог бы обычно с прогоном тестов а поскольку там правок не было за ночь он происходит очень быстро просто он смотрит что все можно переиспользовать можно теперь все запаковать и соответственно отправить файловую систему распаковать и запустить simcity заново вот и при этом агенты которые там и запускались запускали какие-то сборки они продолжают работать они подсоединяются с новых тем сити и когда они закончат свою работу начнет происходить обновление агентов тоже потому что с новой функциональности мы можем выкатить новый плагин и новые какие-то из нее которые затрагивают агенты тоже автоматически обновляться гель чего здесь сейчас не сделано и может быть у вас сразу же возникнет вопрос что если у нас тысячи агентов и наводняли сервер и они все 1000 начинают обновляться вот это вот work in progress так называемые мы как бы хотели все-таки чтобы их группами начали обновлять или пополам или как-то но вот сейчас вот этого не сделано чтобы проверить вот у нас тысячи агентов мы их разом не стали бы обновлять нам это не стреляет в ногу сейчас но может быть у кого то кого более большие инсталляции может быть у них это как-то проявиться этом этот момент вот дальше вот и у нас когда уже закончилось все у нас работающая система следующий последующей весь день мы работаем с этой системы давайте посмотрим как это выглядит теперь в команде dotnet у них есть мастер на каждом продукте но разработку ведут разработчики не как бы не в мастере не в tranque а все таки в своих отдельных ветках ветки эти по функциональности как бы отличаются и правки все-таки делается в каких-то изолированных частях проекта так что редко бывает чтобы какая-то функциональность вот две разные функциональности пересекались на одном месте в коде этот один важный момент не кажется вот допустим в каком-то в какой-то из веток работа подошла к концу и теперь можно попробовать проинтегрировать свою работу в мастер этот процесс он немножко идет не по понятиям отцовской что так это не хорошо делать что у вас долгоживущие branch и но это работает для команды тут нет им им с этим хорошо жить так вот если у нас подошла работ концов этой ветке разработчик вручную нажимает кнопочку simcity где запускается так называемый робот для сведения веток но прежде чем мы об этом поговорим поговорим что может пойти не так вот у нас работа закончилась мы хотим поможет собрать обратно в мастер что не правило что здесь может пройти и так все может пойти не так здесь все взорвется почему потому что успели раньше помножить другие branch и и вообще все плохо будет как будем решать проблему говорите со мной мастер фичер branch что это нам дает дает то что мастер остается зеленый но взорвались мы в другом месте скорее всего что же на самом деле не очень приятная ситуация вы так будете нежиться до посинения потому что сначала вы попросят попробуйте поправить эти поломанные места попробуйте опять подмёл лица и опять взорвется если у вас эти между этими двумя моментами времени прошло достаточно много часов вас коллега успел что другой проинтегрировать вы опять взорвались то есть в команде тут не то это приводило к тому что люди днями не могли помешать своей свои правки там много людей много правок много мячей и как бы это очень такая конкурентная среда становится для того чтобы это как-то поправить был изобретен такой процесс как робот его назвали мертв шепот вот что это так он так он работает принципе он делает тот же самый процесс реализует но автор автоматизирует его значит вот у нас работа прошла этим сити человек нажимает кнопочку который запускает этого робота из командной строки то есть это какой-то бицепс конфигурации это утилита или как бы можно сказать себе процесс оделась следующая она создает или не создает иногда отдельные branch куда сводит разные ветки в наше простейшем случае может подмерзать макмастер он конфигурируемый то есть пара параметре зиру и мы и разными для разных сценариев нот на один из них разберем допустим у нас появился дополнительный через пик branch который сделан был и switcher 001 и туда поддерживается мастер запускается сборка этот сам робот запускает сборку на этом раньше через рст 5 на тему сити то есть он как бы выходит и обратно заходит в ten city и внутри этого процесса соответственно когда все прошло все зелененькая он делает тот же самый мир мастер здесь процессуально ничего как бы не меняется но это все автоматизировано и вот за счет этой автоматизацией гораздо выше вероятность что вот этот процесс удастся еще не взорвется потом там есть ретро если он делает несколько вот этих мер джей для нескольких людей то есть выделен на это отдельное пул агентов какие какой-то аромат робот может другого например обогнать да вот он тогда будет пробовать замерз несколько раз там он configure нам можно сказать попробуй три раза попробуй четыре раза попробуй 5 раз если это не прошу но это плохая ситуация конечно но чаще всего это с какого-то раза все-таки удается и пока инженеры спят робот работает есть как бы такой момент вот цель как бы достигнуто мастер зеленый инженер поспал работа сделалось правки пришли в мастер но робот тут может стать таким бутылочным горлышком если вот представьте что у нас команда распределена по всему глобусу вот равномерно и это вся команда равномерно генерирует правки в систему контроля версий то есть в принципе доведя до экстрима робот станет такие точные горошком по внесению этих правок и и с скрещиваний веток но его тоже можно растить как бы вот выделять больше агентов на нас видение веток на этот робот и так далее то есть тут вопрос уже в ресурсов сколько мы можем на это дело выделить но процесс интересен последняя тема немножко про in the li j тоже она не совсем прямо так простим сети но мне кажется тоже интересно проект большой это его вот цифры на на июль сейчас конечно там уже другие немножечко цифры другие масштабы но предположим что там уже 14 тысяч миллионов строчек кода ясно что сборка достаточно большая там много кодом много тестов она занимает время но до последнего времени до мая этого года весь проект и и вот проекты которые основываться на базируется в металле j1 они жили все в разных репозиториев все их было шесть по разным причинам исторические причины какие-то были когда разнесли код идея утилитой комьюнити эдишен он на в отдельные репозитории на гитхабе какие-то части и деяние этого этих проектов они находятся во внутренних репозиториях плюс часть android который разрабатывается на самом деле в google и отдельно еще репозитория с плагинами и беда заключалась в том что ни один из этих проектов нельзя было вот взять выкачать и запустить любой из них требовал еще какой-то докачки исходного кода из других репозиториев это очень не удобно с этим неудобно работать не разработчикам неудобно работать на себя и сейчас посмотрим почему значит для разработчика это означало что нужно разные части кода из разных репозиториев правильно выкачать в разные места когда мы вот с таким работаем если делаем поправку то есть это получается один монолитный большой проект и когда мы делаем правки внутри этого кода эти правки могут затрагивать несколько репозиториев за раз допустим вы поменяли метод какой-то внутри ядра а это этот метод используется и в плагинах и в android студии там в других и 2 соответственно эти правки расползутся по нескольким репозиториям сделали правку она нужен нужно сделать commit сразу же в мало мест какие проблемы из этого возникает ну естественно камедь сплит так называемые что нужно сделать коммент несколько мест медленная сборка получается но с этим можно как-то мириться еще то что она медленно это что не очень работается удобно с несколькими репозиториями как то это можно с помощью инструментов решить но вот красный сиай никак нельзя с этим мириться если такая модель проекта начинает влиять на сборку и она валится сейчас объясню почему навалятся значит вот у нас а как это пытались еще решить тоже вот у нас правки влетают в несколько репозиториев да тем сити забирает эти правки из нескольких историях теперь чтобы у нас прав сборка произошла и все было хорошо нам должно повезти два раза первый раз это то что мы все эти изменения примерно в одно время то там арно отправим 6 этих репозиториев и второй раз если вы на первом этапе нам не повезло что они прилетели одновременно нам должно повезти с правой стороны что тим сити заберет их более менее одновременно если этого не произойдёт если simcity соберет право очки скажем некоторые раньше а другие еще туда не дойдут или он их как-то начнет собирать раньше и другие увидят то у нас сборка скорее всего упадет ну потому что мы например добавили метод который теперь нужно использовать везде какие-то модули у нас собрались какие-то нет хорошо пытались решить это таким внутренним решением нас внутренний вид сервер и с помощью плагина в еде и пытались эмулировать атомарный commit это сильно улучшило ситуацию сборки позеленели то есть мы решали как бы с левой стороны да получается все стороны теме сити еще не происходило то есть чаще всего сервер мог такие обеспечить такой атомарный комикс эмулировать его примерно в одно время отправить правки во всей 6 репозитория city my city удавалось собрать эти изменения примерно одновременно 10 по умолчанию процесс сборки раз в 2 минуты конфигурировать его можно сделать больше рот можно сделать меньше но две минуты по умолчанию вот но тем не менее когда команда росла все равно сборка подала иногда чем чем больше чем больше людей приходило чем больше право приходила тем больше была вероятность того что все таки это все упадет не соберется решение пришло как бы на корню решить эту проблему решили свести все репозитории в одно целое то есть тоже самое дерево которое разработчик каждый раз все создавал на на машине решили вот свистеть просто в репозитории теперь в принципе вся схема работы внося она превратилась как бы всем у работы с одной репозитории единственное что естественно в самом тем city если вы хотите собирать какой-то отдельный модуль нужно было подкрутить правила сборки конкретного отдельного модуля но на тему сети собирается все сразу все модули сразу что на самом деле создает следующий такой челлендж для команды сборка занимает много времени какая основная цель себя и вообще быстрее дать ответ все ли у нас хорошо или нет вы отправили свое какое-то изменение в систему контроля версий хорошо быть минут через 15 максимум получить ответ ваш ваши изменения положила все или нет прогнать все количество тестов на своей машине для всех продуктов intel же идея не представляется возможным для этого нужно ферма соответственно мы хотим сделать это все-таки вся значит поговори немножко сборки то есть ребята начали решать скорость сборки и почему они пришли вот исходные данные у нас полная сборка модулей она занимает где-то 10 15 минут то есть если мы начнем собирать просто вот каждый раз проект 10-15 минут без тестов мы уже не укладываемся наши наши показать в наш сказать нашу цель давать ответ за 15 минут вместе с тестами это может ну от 30 до 60 минут занимать и таких количествах сборок в день примерно 200 происходит иногда больше иногда меньше зависимости от того как как люди работают но тем не менее если мы умножим это на размер артефакта который получается от сборки этих модулей 750 мы получим где-то 150 гигабайт данных которые генерируются за день естественно такое хранители отправлять или двигать по сетке тем более солнечными агентами это не очень оптимальное решение это влияет и на скор на скорость сборки и на счета в амазонии на все и задача получить значит 15 минут какая какое же решение принципе об этом можно уже догадаться давайте проанализировать инкрементные инкрементальные собирать что означает 750 гигабайт 750 мегабайт одного артефакта состоит все таки из большого количества отдельных маленьких архипов которые получаются с каждого модуля всего этих модулей 1250 на сегодняшний день я вчера посчитал можно эти модули не паковать как один архив а паковать каждый отдельно получится 1250 маленьких модулей теперь с каждого модуля снимается какой-то хэш и каждый модуль отправляется в хранилище так вот если модуль не изменился у нас вот эти вот хэши хранятся в хранилище тоже можно его туда не отправлять то есть казалось бы довольно такое топорное решение но она приводит следующему поскольку в основном работа идет но с каким-то одним модулем правки они изолированы общий размер пересылаемых артефактов в день вместо тысячи сколько там было 150 гигабайт превратилась 25 мегабайт и время сборки инкрементальные вместо 10-15 минут она стала стабильно меньше одной минуты в team сети свою очередь но это тоже скриншот из нового ей который сейчас в разработке но он тем не менее в последних релизах его можно у себя попробовать включить и увидеть некоторые вещички вот это вот такая так gant чарт до диаграмма немножко отсортировано то есть в начале мы видим инкрементальный сборку время инкрементальные сборки около 1 минуты и тесты которые раз про релизе раваны мы видим что наверху сразу же можно определить над какими тестами нам еще стоит работать как это будет решаться это уже вопрос инженерной можно разбить самую длинную сборку он еще на 2 она станет меньше да ну тут важно получить ложится именно в 15 минут они как-то обмануть вся система то есть четыре из этих сборки сейчас не укладываются четыре группы тестов и укладываются сейчас 15 минут но уже близки по к этому к этому показателю как распараллелить те тесты здесь один есть такой нюанс который нужно знать incity incity он не просто собирает или запускает тесты он их еще как-то анализирует пытается понять это новый тест упал это новый тест вообще запустился а может быть этот тест не мигает и надо его как-то zara портировать так вот если мы начинаем разбивать тесты на группы нам важно чтобы тест которая запускается всегда запускался в одной и той же группе потому что если он будет прыгать между группами которые спрогнозировали тем сити будет думать что это новый тест или он заново новый упал или он вообще мигает то есть это не будет будет не очень хорошо жить под возможностями density все нормально он запустится если этот тест пройдет все хорошо но будет не очень хорошо видеть в очевидно в отчетах то есть если мы разбиваем тесты на группы по ралли зиру им их нам надо как-то обеспечить то что тест всегда будет оставаться в одной и той же группе и этим занимается автоматических скрипт он по имени тестовый че высчитывает хэш и соответственно это обеспечивает стабильное попадание тестов какую-то группу даже если мы просто добавляем новый тест вам попадет в новую группу и там и останется поэтому он прыгать не будет вода нем есть тоже капитанские выводы у меня все был капитанский доклад я думаю можно адаптировать процесс под инструмента вот у вас есть инструмент что то он вам предоставляет вы инструмент и меняете пытаетесь сделать свой процесс вот так как этот инструмент вам делает это иногда можно делать то как допустим мы видели у меня в примерах некоторые команда делает видит что этим сети работает вот таким способом начать мы будем делать вот так можно сделать наоборот можно начать подпиливайте инструмент под процесс то есть команда тот над они решили что у них процесс вот такой и нам просто не хватает функциональности в team сети мы напишем свою утилиту своего робота который будет жонглировать бранча me почему бы нет если вы используете m-city и если у вас есть какие-то части в процессе которые не накладываются на intensity мне было бы очень хорошо узнать но и в заключение так мы начали с герба индустрии я вам немножко культурной составляющей принес город никогда не будет построен это фраза проталин где я живу есть поверье что если таллин будет построен то его разрушит так вот это в принципе применимы к любому другому большому проекту вы никогда не будете знать как в ваш инструмент будет будут использовать если он становится популярным его всегда придется как-то допиливать для себя или для других на этом я хотел бы закончить и если у вас есть вопросы я надеюсь что есть мы можем о них поговорить ты говорил о тебя будет на часы я уже дома я как-то очень тараторил вот вопросов нормально тут очень много вопросов мы наверно все не успеем на у нас еще дискуссионная зона поэтому начнем какие-то вопросы так как ты ambassador m-city просто pro team сити какие-то про твой доклад и я думаю что будут взглядов мы все попробуем удовлетворить в общем такой вопрос все проект этим сити реализован с использованием density это вопрос используете ли вы другие продукты если да почему короткий ответ да и нет ну то есть дать им сити собирается на тем сити и нет больше никаких семь инструментов я не видел чтобы использовались может быть используются инструменты для доставки но это вот такие как тира формы они напрямую вся и все-таки имеет отношения надо было по интересна тем седина дженкинс и собирать можно попробуем будет было бы интересно да увидеть справляется джунгли дженкинса с горкой simcity то как надо нам вопрос который я не понял на возможно ты поймешь когда investigation of the seiner будет нормально работать с ним мастер ветками а то заявили они работают не хорошо запускайте view трек этот фидбэк будем чинить нет или сердечно sought a summer он действительно получил появился в прошлом году и его разработчик так потихонечку доводит до ума в зависимости от обратной связи для тех кто не в курсе что это такое несите когда запускает сборке сборка там тест может повалится сборка может не стартануть какая-то проблема может случиться то есть сбор как раз на есть такая функциональность которая называется инвестициям среды как бы расследование вместо того чтобы открывать еще где-то ищет рокеры прямо в в тем city есть кнопочка assign инвестидеи шин на кого-то да то есть открыть тикет прямо внутри m-city и тогда в списке или в профиле пользователя пользователь увидит что вот у него есть какие-то задачи нужно посмотреть на такие то сборки такие-то сборки надо починить авто seiner автоматизирует процесс назначения вот этого вот этой задачи на человека анализирует кометы и соответственно создает вот это вот исследование расследуя не знаю как на русский более правильно это перевести вначале он был просто не конфигурируем в нем 1 эвристик а было зашито и он сделал одну эту функцию естественно есть какие-то фолз позитива так называемые когда он не угадывает и ты чего-то не делает и вот что там спросили наверное какие то корнер кейса еще не закрыты будет очень здорово если вы такие такой такую обратную связь приносите особенно если это связь прилетает в tracker ко мне люди приходят иногда в чатике такую обратную связь приносит я стараюсь ее до команды тоже донести но я не могу сказать чинить года я могу только сделать то что будет сбил сервером если у нас часть функции выделены все кондеры сервис например работа с агентами а мастер при этом упадет он полностью развалится или частично сохранить функциональность бьют идут а ей не работает да очень хороший вопрос значит я на слайде обозначил что есть основной сервер и вторичный сервер стоечный сервер может работать как ридом ли сервер который все равно будет отдавать ю ай то есть мы сможем посмотреть результаты сборок от агентов какие-то вещи если там очередь как бы есть тот мы на нее тоже сможем посмотреть но он рида умный серверу мы можем только смотреть результат но не менять конфигурации и не можем запускать новые сборки есть такое происходит есть мониторинг на основном сервере и естественно администратором придется его быстренько поднять то есть эта проблема процессуально решено так в чем смысл инициации на это билда в 5-ю в пять вечера с последующим fitch им право до 7 вечера не проще ли всеми и запускать тут смотрите я понимаю почему такой вопрос задам если компания работает с 9 до 5 и все пять бросили ручки ушли с работы замечательно можно всем поднять jetbrains практически нет времени когда кто-то чего-то не камень и кто-то чего-то не собирает поэтому просто вот 4 утра допустим это самое такое безопасное время когда можно это сделать но если вы за это ответственны то вам естественно в 4 часа утра не хочется проверять эти правки очень в конце дня после работы основной доска уже меньше этих комментов пролетает за за день сделана работа проверить эти вечером правки и сказать все окей ли не все окей это дает какой-то буфер по времени это дает какое-то контроль над процессом тоже если мы будем это всем вечера выкатывать ну кому то вечером может быть плохих ситуациях придется решать проблемы я думаю что не все это хотят это вполне нормальный человеческий процесс так получается с утра пришел и если что-то пошло не так утром вот как раз там минерал допустим да этот те кто ты с утра пришел и уже эти целый день ну или там ты сразу может заняться сексом до но сам самая худшая ситуация конечно если мы все проверили и в 4 часа утра процесс запустился и все все равно грохнулась данному какие ситуации не бывают это самый худший случай потому что сей вот когда он работает вы отсылаете туда правки и получаете что-то ответы обратно и с точки зрения программиста это идеальная ситуация и никто даже не думает прося и но как только вся сервер ложиться или там что-то плохо встает работа всей компании чем больше компания тем больше ущерб работа может реально стоять то есть я в предыдущей кампании до jetbrains к работал у нас тоже была довольно развесить листья если сервер даже работал но тормозил при этом сборки были долги работа вставала практически то есть это очень важный компонент для компаний в чем я хотел бы сказать я тоже хочу это поддержать но и не знаю что под н да я могу говорить про наше что ни в чем смысл а это только чтобы понимаю что обновление происходит в 4 утра это тот же человек но все-таки мог можно ли как-то провести обновление мастеров без недоступности или это не нужно мастеров без недоступности я не очень понял вопрос честно может быть из толпы сейчас народный человек громко крикнет и поправят как-то даст дополнительные детали мы ведь он уже ушел ну да или можно в дискуссионной зоне обновлять так как вопросы вопросов много предлагаю не останавливаться и какую суп используют в team сети есть возможность над конфигурировать разные суды у нас используется майский почему команды просто не используют по request зачем робот ну вот тут я сожалению не могу ответить на вопрос прямо авторитетно поддержка pal request of ten city есть она сделана для довольно простых случаев и сделано для публично публичных сервисов каких-то гид хоп hip hop beat bucket для нашего сервера для нашего собственного внутреннего сервера это не сделано и если мы говорим об ауре квестах все-таки нужно понимать что работа по request и это не и возможность гита это возможность сервиса сервисе должна быть по пешка у вас это поддержки внутри нет даже если в team сити умеет по request еще кстати было интересно в продолжении робота вот учитывая то что он но делать это автоматически на и так понимаю что если реально существует конфликт то он просто падает до и не может на это не серебряная пуля все-таки придется тогда немножко потрудиться инженером с большой вероятностью во-первых она пройдет ну если не пройдет то может быть другой раз получится пока что пока что справляются мы кстати у себя тоже используем тим сети и бит bucket и у нас теперь свой плагин который ходит в team city у нас тоже есть такой функционал что есть галочка типа смел жить автоматически по request когда все чеки пройдут но если людям мастер уехал то у нас сборка автоматически перезапускается и все так же по кругу идёт до очень похоже так как снесли все в один репозитории без потери истории комментов или забелиной историю с историей был перенос здесь сожалению я не хантон и не копенгаген чтобы рассказывать именно как это технически было сделано были использованы некоторые инструменты для копирования принципе такую информацию как возвести несколько репозиториев в одну с историей можно нас такой фол найти сами не смотрел как это делалось естественно еще один вопрос про гид можно ли было воспользоваться сам модулями для решения проблемы с кометами в несколько репозиториев наверно можно было и тем сити умеет хорошо очень сам модуль и почему этого не было сделано не могу сказать но наверно потому что изначально и разделение на репозитории на 6 вот этих репетиторов нам было довольно искусственная то есть проект все равно 1 и зачем пытаться дальше держать разделенные рыбе истории было не очень понятно то есть уже было бы разумнее просто на корню решить эту задачу и свести все репозитории в одну я от себя хочу добавить так как работал со модули минут я не сомневаюсь что тим сети может вас обманули но обычно разработчики не могут в сам модуль и потому что когда забывает на на чем конкретный сам модуль сейчас на какой branch и вот да то есть не очень удобно я вообще-то вещь и я думаю крайне вопрос все остальные перенесем дискуссионную зону хочется узнать поподробнее про веб дав хранилище как это устроено очень хороший вопрос я тоже когда спрашивала человека который готовил эту вещь и спросила почему скажи мне какое то бинарное хранилище в готовой продукции были что внутри у нас уже используется человек сказал что это просто файловая система с фениксом перед этой файловой системой и файле конфигурации там на 10 строк поэтому он не сильно сильно вдавался в детали поэтому я в принципе просто презентация обозначил что это водохранилище про технически как вот она прямо технически технические устроена examiner сказать не могу но судя по комментарию это было довольно просто если хочется об этом узнать владислав рассылки есть такое имя можно его найти в твиттере про спрашивать хорошо давайте поблагодарим антона"
}