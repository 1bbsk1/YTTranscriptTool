{
  "video_id": "NRaOzMubeKc",
  "channel": "DevOops_conf",
  "title": "Влада Зубарева, Mayflower — Апдейт инфраструктурных зависимостей без боли: DevOps-кухня с Renovate",
  "views": 223,
  "duration": 2065,
  "published": "2024-12-02T01:27:17-08:00",
  "text": "Всем привет Я рад всех приветствовать нас Я хочу представить вам Владу зуре вкладывание называется про апдейт инфраструктурных зависимостей и у меня к Владе вопрос а Влад ты что обновлялось яркие впечатления Чем можешь поделиться Привет Костя последнее что мы обновляли это Open Stack всей нашей инфраструктуры ставили Облака на новой версии И к сожалению в этом случае нам никак не помогает автоматизация нам приходится это всё равно делать вручную но сегодня я немножко расскажу о том как автоматизация может нам помочь в других зависимостях Спасибо я передаю тебе слово а сегодня я вам расскажу про апдейт инфраструктурных зависимости то как делать это без боли или то как мы в компании My Flow используем автоматизацию чтобы всё пошло легко гладко и красиво сначала расскажу немножечко о себе Я в it работаю уже Т из которых 8 лет как инженер начинала Я как разработчик в данный момент работаю в компании myf в команде inf в основном мы занимаемся установкой апдейта настройкой блоков на Open у нас инфраструктура и поддержка всего что с этим связано мой доклад сегодня может быть интересен всем тем кто использует и например какие-то вещи типа Фома любую автоматизацию например или тем кто создаёт свои до пишет свои скрипты или даже небольшие приложения также тем кто хочет понять как быстро эффективно обновлять свою инфраструктуру как это делать без лишней боли Как поддерживать консистентность всего что у вас за деплоя и настроено и экономить на этом время Давайте немножко расскажу о том о ЧМ мы сегодня поговорим более детально Сначала мы определим что зависимости Для нас Для девопсом поговорим про то стоит ли нам обновлять как это делать как это делают другие и как это делаем мы в чём нам может помочь автоматизация А кто такой renovate Bot как мы его используем My Flower и также я расскажу небольшую историю из нашей жизни которая случилась буквально Недавно как бенефит того что мы получаем от renov в мире существует достаточно большое количество зависимостей это Например Али докер имиджи какие-то CD пайплайн рафом модули чарты тут можно подставить всё что вы используете это достаточно большой Пласт инфраструктурных вещей А например на данном слайде я показываю просто три типа зависимости которые у нас используются это node с настроенными собственными Коле н де - это просто do сню в котором мы гоняем тесты например и Open это один из моих самых любимых фор модулей с помощью него у нас созданы почти все виртуальные машины в компании я специально перед докладом посчитала сколько раз используется каждый из этих зависимо у нас встречается в различных прок 38 раз НТО де как контейнер 68 и наш Фаворит Open instance - это 791 раз это не значит что у нас столько виртуальных машин У нас их намного больше мы просто используем этот модуль в том числе с инкремента А давайте немножко поговорим о том Зачем вообще нужно обновлять что-либо чаще всего Люди обновляют изза того что чтобы Получить какую-то новую функциональность чтобы какие-то старые баги в софте пофиксили также уменьшили секюрити риски или улучшить производительность например выкатили какую-нибудь оптимизацию под вашу операционную систему также один из главных бенефито - это то что обновлять лучше регулярно так как Иногда у софта наступает такой период как end of life И если мы не будем обновляться регулярно а будем делать это время от времени нию это может быть намного больнее чем то что мы потратим чуть-чуть побольше времени сейчас Давайте посмотрим у других как обычно это делают я специально спрашивала у своих коллег у которых есть опыт работы в разных компаниях и соответственно своему опыту Я знаю что есть два таких достаточно больших как лагере два способа это указывать у каждой зависимости либо либо мастер либо прибивать версию гвоздями А можем немножечко рассмотреть то какие есть плюсы и минусы каждого решения когда мы прописываем мастер у нас всё всегда свежее красивое И то что вот новейшее можно придумать но к сожалению у нас есть достаточно большое количество минусов это скрытые изменения для пользователей так Также можно легко ВС сломать то есть кто-то из соседней команды Например выкатил неудачную Аль мы просто дипло машину и всё сломалось такое может быть также сложно дебажить если мы говорим о дебаг нам нужно понять В какое время Какая версия была в данный момент То есть когда Что происходило есть второй способ это прибить версию способ отличный всегда понятно что где у нас это чётко красиво нет никаких скрытых изменений для пользователей если мы написали что хотим 13 мы получаем 143 у нас всегда ожидаем результат при пло при при создании неважно чего виртуальные машины какого-то имиджа или накатки какого-нибудь плейбук а но тут возникают закономерный вопрос А как это всё обновить если мы говорим что у нас достаточно большая инфраструктура У нас очень много всего как понимать о том что есть что-то новое Например если ты пользователь какого либо роли модуля или имиджа и как рассказать если ты являешься тенеро то что что-то изменилось потому что зачастую э обязанность ложится на плечи того кто пишет софт А мы в компании придерживаемся стратегии если можно так это назвать прибить соответственно здесь можно видеть кусочек одного из для с установленным дором наше роли утилитами и банальным кпом он намного больше Я просто показываю небольшой кусочек Как пример А теперь мы немножко погрузимся вю инстру суст ролей 51 docker Image и 15 фор модулей Это только на поддержке нашей команды А если мы вспомним предыдущий слайд и поймём Какое огромное количество мест Где используется роли с примера мы понимаем что у нас просто огромное количество зависимости мы не понимаем как их обновлять невозможно же пойти и обновить в 800 местах что-то и поменять циферка автоматизация А конечно же мы к этому пришли не сразу раньше мы обновляли всё самостоятельно каждую версию это занимало достаточно большое количество боли огромное количество маки врка и также из-за этого появлялись ошибки потому что невозможно сдать всю инфраструктуру компании и знать где точность используется например твоя роль которую ты написал и обновил А мы поняли что для автоматизации намм А у нас есть несколько требований это убрать ручное обновление а также мочь это гибко настраивать и чтобы это подходило именно для девопсом А мы поняли что есть два решения это dependabot достаточно известная утилита и renov он чуть менее популярен но тоже достаточно известен сди разработчиков depend создан в 2017 году его в 2019 купила компания github сделан Он был с одной простой целью это снижение уязвимостей и обеспечение совместимости оного п Это то что он отлично поддерживает github неплохо Поддерживает gitlab у него достаточно простая настройка и Он поддерживает огромное количество типов зависимости Не только для девопсом часто его очень используют ребята которые используют nots какие-то ПМ пакеты им обновляют но к сожалению у него есть минусы это то что е не основной фокус также из-за того что он просто настраивается гибкость этой настройки немножечко ограничено мы пошли посмотреть второе решение это он создан почему-то тоже в 201 году видимо В тот год как-то Очень остро встала эта проблема компания M Раньше она называлось Если не ошибаюсь его году и сделала частью своей системы Def Ops это достаточно большая система которая проверяет код на уязвимость и соответственно renovate в их системе помогает а поддерживать всё Up toate А главные его Плюсы - это то что он поддерживает gitlab он также поддерживает другие системы но как бы для нас был важен gitlab так как мы в используем gitlab у него очень гибкая настройка Он поддерживает также огромное количество зависимостей тоже как и devs так и для разработчиков он является полностью селф системой также у него есть aut Discovery о нём мы поговорим чуть больше чуть позже но к сожалению его главные минус это благодаря его поте его немножечко сложно настраивать иногда с ним нужно научиться работать возможно залезть куда-то в документацию или в исходники у нас это абсолютно не пугает поэтому у нас был выбран однозначный победитель в виде нота И сейчас мы перейдём уже к нему непосредственно и поговорим немножечко больше о нём а здесь можно наблюдать полный конфиг нашего Ну как он конечно же не полный Я его редактировала немножечко Но это основные вещи которые у нас используются А сейчас мы рассмотрим Как это работает а в самом начале у нас происходит запуск и мы прокиды ему токен авторизации в нашем случае для лаба то куда у него есть токен он туда идт и начинает получать список репозиториев после того как список репозиториев он пытается начать применять фильтры А здесь я хочу немножечко остановиться на одной из главных фишек это а Discovery АВ Discovery работает достаточно Просто если мы говорим про getl справа можно наблюдать классическую структуру проекта это именно в и в нейм спейсах мы просто указываем этот прок и все проекты входящие в эту группу у нас попадут в renovate То есть он об этом узнает и возьмёт их по своему фильтру фильтры могут быть гибкие там можно ставить звёздочки точечки и вот это всё А после того как он применил фильтры и понял что мы хотим рассматривать он начинает сканировать файлы сканирует он их Согласно менеджер в данном случае это ф UN Galaxy gitlab c и regex а сканирует он Согласно package Лам Их достаточно большое количество здесь я показываю достаточно простою фор модули который написано нами же и UN Galaxy R которая тоже написано нами А также есть очень крутой кастомный менеджер Он позволяет делать в принципе всё что угодно потому что это и благодаря кспу можно зать как-то Например если нужны какие-то внешние сосы или у вас есть какой-то свой мы его используем для того чтобы общаться с нашим же внешним и тоже заменять зависимость и Апти их после того как он понял просканировал файлы понял В каких файлика что-то ему нужно менять он берёт версию текущую и начинает смотреть начинает смотреть Что происходит если у зависимости поменялась версия мы используем это ну я думаю достаточно популярная вещь он смотрит Есть ли какие-либо изменения если они есть он Согласно правилом описанным в конфиге создат в данном случае мы используем простой шаблон нам этого хватает одна из главных вещей которая Нам нравится в нём это то что есть быстрая ссылочка на челок то есть для наших пользователей просто прилетает СТ они могут сразу же посмотреть Что изменилось зелёный ли у них пайплайн есть ли какие-то проблемы с этим связанные и в зависимо от этого уже и в достаточно щепетильно относимся к нашему коду и стараемся всё покрывать планами содержащими литеры формате тесты если мы говорим про чаще всего тест на молекулу а различные драй раны или какие-то планы если мы говорим про фом также у нас есть система CDE review и от нашего ближайшего друга когда он понял что есть какое-то изменени создал КСТ урек соответственно пошёл вот этот пайплайн состоящий из всех литеров форматов тестов и прочих вещей которые нужны которые накручены в данном месте и как бы он там лежит отлично но нам нужно как-то узнать произошло что у нас этот ший квест создан тут мы на костыли небольшой скрипти на питоне А который нам просто в слаг шлёт сообщение со всеми созданными квестами А всё вроде хорошо апдейты у нас стали полетать сами нам больше не нужно идти и обновлять что-то если мы Обновили роль renov бережно Принс эту коробочку всем У нас есть оповещение в слаке у нас перестали быть ручные действия А наша инфраструктура стала более консистентной А по причине того что сейчас везде всё одинаково но к сожалению у нас остались ещё некоторые проблемы это некрасивые нотификации а цикличность зависимостей это достаточно забавная вещь немного может звучать сложно для понимания это то что когда мы обновляем какую-то вещь которая зависит от другой Она тоже пытается обновиться и е такие цепочки могли быть достаточно длинными и занимать несколько дней это было не всегда удобно особенно если мы говорим о каких-то тестах также на некоторые меш реквесты на некоторые изменения у нас было очень большое количество спама А И это вызывало проблему Мы решили попробовать Ещё разочек а начали расширять функционал и затачивать его больше под себя мы сделали различные типы renovate ботов которые нам а помогают работать с разными типами зависимости или для каких-то других команд нашей компании а которые будут сделаны более гибко мы улучшили систему квестов здесь как можно заметить У нас есть SK Standard version это один из флагов для нашего Лиз менеджмента а о том что не нужно поднимать версию Мы специально добавляли этот тег на какие-то А вещи которые мы можем обновить не глядя то есть а мы понимаем что обновление например а зависимости в тестах не ведёт к изменению функционала соответственно нам не нужно поднимать версию самой утилиты или библиотеки также мы добавили достаточно прекрасную вещь Это авто и Автош Я понимаю что это звучит наверное немного глупо если мы говорим о том что мы боимся за частоту кода и что мы хотим чтобы всё было красиво и правильно И по флоус опять же мы говорим о тестах то что пайплайн зелёный у нас достаточно весомый аргумент для того чтобы это автоматически ВМР и это абсолютно нормально также мы немножко улучшили нашу систему нотификаций вывели на неё а индикацию о том прошёл ли пайплайн у данного мерш Квеста стал ли он зелёненький или красненький также у нойта есть один из типов сообщений который звучит как Помогите потому что он что-то не смог сделать Например у него слетели права на автоа И в данный момент стало всё намного лучше это Нас устраивает уже больше апдейты у нас всё ещё прилетают сами оповещения стали достаточно красивыми мы благодаря тому что некоторые ёрши квесты мы стали ржать автоматически опру Вить автоматически или скипать версии мы убрали достаточно большое количество фонового шума который у нас был в самом начале также у на стало е меньше ру нам не нужно теперь идти и если мы Обновили какую-нибудь зависимость по типу Докера которая используется там 807 раз нам не нужно идти и проливать все эти реквесты как бы достаточно глупое занятие что мы планируем делать с нашим Ботом дальше Мы хотим его развивать делать больше му оповещения пользователей чтобы не было скажем так забытых или подвис МШ квестов потому что иногда К сожалению бывает тяжеловато ОТС матри всё и хочется возможно как-то своих пользователей немножечко потыкать и сказать им Ребята давайте мы будем всё-таки ржиться Давайте поддерживать всё а также мы в данный момент у нас к сожалению не реализована ещ поддержка чартов мы её будем реализовывать конечно же и добавлять всё больше и больше метрик для того чтобы понимать как Аа это всё работает насколько у нас это эффективно насколько много люди мёрт насколько люди много используют А теперь я расскажу буквально кратенько небольшой наш случай из жизни У нас есть как я уже упоминала ранее это Раф модуль openstack инса который используется во всех виртуальных машинах компании и в связи с тем что мы решили добавить дополнительные метаданные у нас поднялась его версия с 640 на 6 Вроде бы ничего такого но Мы помним то что он используется почти 800 раз раньше нам нужно было сделать достаточно много МШ квестов поменять кучу файлив строчек понятно что есть автозамена Но это всё равно как бы что-то пойдёт не так подождать пайплайн самостоятельно потому что мы же это делаем в рабочее время конечно же а не ночью и получить АФ от своего там сокомандник коллеги соответственно это было много копипаста достаточно большое количество работы не очень такой интересный И рутинный в данный момент это выглядит вот так то есть это просто сообщение в слаг которые пришли и мы можем уже посмотреть мы понимаем что пайплайн зелёненький Мы заходим авим на всякий случай что-то проверяем сам merge request внутри содержит всю нужную нам информацию о том что именно обновилось До какой версии сколько он сделал ченджес мы говорим о том что в этом проекте у нас используется модуль 69 раз соответственно он сделал 69 н выглядят очень просто легко а и Ну как достаточно элементарный А если интересно можно покопаться самим посмотреть что там происходит внутри у него достаточно большое количество различного функционала а очень простой и лёгкий geted renovate можно использовать не только SF также у них есть другие варианты использования возможно вам стоит попробовать подобрать ту которая будет интересна больше вам а сегодня в своём докладе я кратенько рассказала о том какие зависимости бывают у нас в мире девопса мы поняли и узнали Как нам лучше обновлять и как это принято но поговорили про автоматизацию поверхностно посмотрели конфиге найтбота потому что к сожалению он достаточно комплексный и это бы Не влезло ни в одно ни в один доклад разбирать его полностью и узнали небольшую историю о том как это может помочь Я надеюсь что вы тоже сможете это использовать в своих компаниях и будете получать чуть меньше боли болье СБО Спасибо за доклад вопросы у нас есть вопросы Из зала потому что в чатике я вопросов не вижу и есть Да у меня дофига три вопроса начнём с двух первый вопрос Сколько заняло времени в человек часах вот интеграции и внедрения А наверное первое внедрение заняло не очень много порядка недели полутора работы одного человека то есть незнакомого воо В общем и целом из-за того что мы постоянно его развиваем это занимает Да какое-то время но в данный момент он стабильно работает Я думаю до версии 2.0 это заняло Ну не знаю 3 недели наверное рабочего времени вот так как нобо не является ну как бы он конечно же неотъемлемая часть того что я делаю на работе но так как он не является основным моим профилем скорее скажем хоби кото я копаю на работе он у меня делае йм и не занимает много времени Спасибо второй вопрос проверяете ли вы дополнительно мажорные версии обновления Да конечно мы проверяем А я хочу ещё немножечко дать такой дисклеймер о том что я сейчас Говорила именно про внутренние вещи то есть про внутренние роли внутренние модули внутренние имиджи Я знаю что многие используют и на внешне Понятно Мы конечно же проверяем мажорное обновление то есть когда я мёрз не знаю Я надеюсь когда Костя мёрт тоже мы смотрим если у нас изменился мажорчик L почитать Мало ли что бжи какие-то й MD Понятно Ну и третий Вопрос такой может быть не было случалось ли с нотом хотя бы один инцидент уже Я не уверена что прямо какой-то инцидент инцидент случился мы его отключали на какое-то время потом у нас там не знаю потухал токен авторизации в тла Можно ли считать это за инцидент но так как он у нас запускается каждую ночь каждую буд ночь по крону примерно в районе 5:00 утра для того чтобы когда он бежит со своими огромным количеством пайплайн не засорять всю нашу инфраструктуру и все наши раннеры мы как бы видим что на утро У нас нет сообщений Потому что почти всегда одно или два сообщения придёт плюс он тоже бежит у нас нает лапси и мы видим если пайплайн упал красненький он там придёт мне в почту там в слаг везде я об этом всегда узнаю Спасибо большое за доклад А Есть ещё вопросы из ала нужно Спасибо за доклад У меня вопрос Сколько ресурсов У вас есть при обновлении И сколько реп пробегает а в смысле сколько ресурсов есть можно немножечко развернуть Ну любой пайплайн который запускается Да он есть это либо подик да либо какая-то нода соответственно у неё есть ресурсы вот сколько на пробег всех ваших репозиториев во-первых сколько их Да тратится ресурсов А ну смотрите смотри тут достаточно сложный вопрос потому что у нас компании существуют различные команды девопсом из ни свои выделены раннеры соответственно это как виртуальные машины так и подики в окд соответственно у нас я не смогу наверное быст дать оценку Давай помогу Нам не пришлось дополнительно увеличивать квоты для этой задачи для этого плана то есть нам хватило тех ране Ну предположим у вас 100 репозиториев Нужно обновить Ну там 1.000 вот хотя бы циферка отношения Какой нужно отталкиваться на этих значениях А ну смотри при достаточно крупных обновлениях А мы не выбивались с 5:00 утра до 9:00 утра во времени ра ранения пайплайн то есть а мы говорим о том что когда renovate принёс Mer requ мы пошли делать какие-то пайплайн какие-то джобы у нас не бегут тяжёлые тесты это инфраструктурные это моле ще всего 57 минут на один на один прогон роли самое Наверно высоконагруженные это различные ауки Да они могут занимать и 20 и 30 минут но мы не Нам не пришлось увеличивать ресурсы Как правильно сказал Костя и в принципе мы не заметили каких-то изменений так потели понять масри вот так вот с схода Ну да хочется сравнение какое-то получить потому что у нас доста прожорлива почему-то он получился А я немножечко упоминала о количестве наших репозиториев Да А И вообще в принципе сколько у нас ролей сколько у нас модулей да возможно это не так много как в каких-то больших компаниях но я знаю что такая проблема которую можно решить с нотом может быть полезна буквально всем Потому что это достаточно большая проблема и боль многи Ну да если честно всё-таки тут идёт речь про инфраструктурные проекты и инфраструктурные обновления и там действительно идёт Ну где-то до тысячи репозиториев то есть ну это мне кажется более чем достаточно Спасибо А ещё вопросы у нас есть время а Вопросов нет а отлично может быть тогда я задам вопрос Смотри ты говорила про то что мы всё автоматизировали всё перели в авто Discovery но всегда же бывают какие-то исключения Да из правил что есть какой-то проект который Ну нежелательно или он не готов к ренове есть какие-то Да конечно же как я говорила у ренове достаточно большое и различно количество возможности настроек можно настроить исключение Можно также например взять и за экстент наш большой config Discovery уже непосредственно в самом репозитории если нам например хочется обновлять что-то необычное а не знаю по каким-нибудь хитрым гкс пом и нам нужно это Только здесь и сейчас только в этом данном проекте А мы всегда можем настраивать правила исключения и у нас даже они стоят на те репозитории которые в данный момент к сожалению не готовы или не могут принимать renovate мы по какой-то причи не можем их обновлять например потому что это какой-то leg который уходит там или уйдёт у него of буквально завтра то есть например до конца этого года я вижу вопрос из чата уже пишут Сергей зат вопрос были у вас проблемы с нотом когда он устраивал Ну что какое-то непотребство и вам потом приходилось обратно ВС руками откатывать реветь есть это опять же проде Да это тоже опять же про инциденты А так как мы изначально не предполагали автоматического ржа и у нас каждое сообщение ОТС матри ось дежурным девопсом команды То есть я как представитель команды инфраструктура осматривал свои инфраструктурной зависимости которую он мне принёс и обновил а там не происходит какой-то дикой автоматики не то что у нас запустилась какая-то машинка и всё у нас понеслись меж реквесты я говорила о том что у нас да существует автоматическое обновление но и автоматически ёрши approve Вот Но а у нас э это сделано только на тесты только на то что мы осознаём что можно абсолютно безопасно делать инцидентов связанных с этим у нас не было И вот правда новай у нас стоит уже больше ну где-то года я думаю год-полтора и у нас не было ни ни разу ни какой-то проблемы прямо большой единственная такая неприятная наверное вещь Это то что в самом начале при обновлении каких-то вещей к нам могло прийти там 100 сообщений в слаг и приходишь с утра открываешь слаг у тебя так 100 сообщений нужно с ними что-то сделать от смотреть что-то там как-то поиграться Ну я вижу вопросы закончились а ещё раз тебе большое спасибо за ответы Спасибо большое"
}