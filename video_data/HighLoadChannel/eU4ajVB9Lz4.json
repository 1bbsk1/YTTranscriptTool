{
  "video_id": "eU4ajVB9Lz4",
  "channel": "HighLoadChannel",
  "title": "Грамотное ООП: организация надёжной бизнес-логики / Дмитрий Елисеев (ElisDN)",
  "views": 25835,
  "duration": 2972,
  "published": "2020-07-17T06:36:40-07:00",
  "text": "я дмитрий eliseev чем я занимаюсь несколько лет я разными бронирую и фрилансом и на удалянчи campo был и в разных проектах по приходил по уходил в общем чем я там занимался и что меня так торкнуло на всяких конференциях выступать всякие доклады проводить и мастер-классы записывать если вы мне конечно в ютьюбе смотрели ну так людей много сюда пришло наверное есть знакомый меня здесь итак чем я заморочился не заморочился с тем чтобы изучать именно лучшие практики и попробовать как это у себя это сделать и другим людям привить эти привычки не знаю получится или нет но несколько человек уже подошли с офисом на сделали авто уже попросили сказали спасибо дмитрий за такую работу наверное организаторы конференции знали на что шли к бы меня приглашали потому что я у меня меньше ста слайдов не бывает поэтому ну извините придется вам это смотреть пошагово вот такие дела в общем что мы сегодня изучим и при чем здесь вообще ввп и откуда оно пошло это отдельная тема не будем на это заморачиваться но его создатель алан кей когда-то придумал его просто как совокупность объектов некая распределенной системы которой обмениваются сообщениями все если вас спросят на собеседовании еще где то что такое о.п. вы так скажете сеть из объектов обменивающихся сообщениями а как они там обменяются это никому не интересно уже неважно но такое понятие часто подменяют сейчас тем что нужно писать классы объекты классы и объекты все на классы нарезан со но самом определении опыта объектно-ориентированном программировании не классово ориентированного программирования поэтому воспринимайте а.п. в общем философски и при этом классами особо не заморачивайтесь и так поперлись кодом что у нас сегодня будет сегодня мы с вами рассмотрим как не взорвать мозг когда вы программировать и какой-нибудь сложный бизнес логику и куда эту логику поместить как удобно разделить этот код распределить раскладывать иногда он осла и так может встречаться всякие опечатки и ошибки если я буду находить я проект скажу если нет то вы может быть потом презентацию кому-нибудь перешлю оргкомитету они ее поменяют исправит и важный вопрос как не бояться обновлять framework и библиотеки который к нему прикреплен и почему это важно потому что часто бывает так что какая-нибудь проект написали на и один потом вышел и едва потом полгода переписывали на едва сейчас скоро выйдет и и три будут переписывать на е3 все свои проекты почти чтобы не отстать потом от остальных и мы рассмотрим как сделать так чтобы переписывать меньше кода и чтобы это было удобно ну и соответственно научимся тестировать свой код и будем писать такой код который удобен для тестирования про это будет отдельный доклад о одного из следующих докладчиков как они там чтобы кот нравился тестом мы сегодня может повторим может быть повторим как повезет и так погнали начнем мы с вами с контроля управления controls так называемый это ключевое слово сочетание которое определяет фреймворк от библиотеки отделяет чем они отличаются это тем что разные у них потоки исполнения потоки выполнения потоки управления при запуске что имеется ввиду когда у вас какой-нибудь запрос прилетает на сервер он у нас попадает на джинсы или apache не важно что вы там у себя использовать если это apache что потом он вызывает модуль мод . если джинкс . fpm и все остальное личин какая ключевая задача сервера это заполнить вот такие переменные служебные стандартные системные и выполнить наш код который лежит пар файлики public индекс спичкой что он из себя представляет просто для удобства все вот эти сервер get past файл складывается вместе в один объект request создается какой-нибудь ядро или апликэйшен класса и вызывается метод обработает запрос потом фары чем мы выводим заголовки потом печатными контент и все хорошо в симфонии не стали заморачиваться и прямо сделали methods and и которые это все дело выплевывать наигранной все замечательно людей не так если мы программируем на каком таком ешьте типе фреймворке так называемые то там что из себя представляет этот kernel или obligations это всего лишь какой-нибудь роутер или резольвер запускается он определяет какой контроллер запускать запускается него и выплевывает response чтобы он выводился контента соответственно у нас такая структура получается что запрос прилетает сервер там все это на наш файл index.php и в итоге к нему нужно к этому процессу как-то подрезать наши классы и озера и всех остальных который нас написаны а подвязываем мы свои классы к вот этому верхнему коду с использованием с написанием контроллеров которые специфичны для каждого framework а если вы налаживал на symfony на это у них контроллеры немного по-другому пишутся соответственно все что в верху у нас написано это ешьте типе framework минимальная поставка если вы ставите какой-нибудь микро фреймворк вроде slim & alex and express его то у него это всего лишь апликэйшен роутер и все и а внизу у нас код нашего проекта который запускается с ним работает и вроде как хорошо как то он здесь разделен от этого то есть контроллер это всего лишь способ наш собственный код подсунуть фреймворк у чтобы фреймворк потом запускал наш код из наших контроллеров и так первоначально контроллера как мы можем сделать чтобы за регистрацию пользователя осуществить создаем юзер потом создаем здесь форму формула лидируем если оно отправлено то создаем юзера через конструктор и redirect чем на страницу на главную страницу после регистрации чем можно этот код дополнить тем что можно сделать вместо массива какую-нибудь дата ложку просто объект пустой споём e-mail и password его форм его лидировать и заполнять и так вот симфонический здесь все symphonies там вроде понятно будет но так как у нас запросы и команды точнее все операции делятся на запросы и командой зависимости от того что они делают либо модифицирует либо не мне не модифицировать что запрашивает поэтому на командой запроса и до разделяем соответственно это будет у нас команда вот такая у нас команда с email им паролем если мы добавим симфоническую валидацию сюда то будет вот такая что email именно типа email пароль минимально 6 знаков и наш контроллер в общем теперь станет вот таким место массива мы используем вот этот до того жку в нашу команду и теперь что нужно сделать озера мы сделали теперь его нужно как-то в базу данных сохранить сохраняем через entity менеджер отправляем на сохранение скидываем на в базу данных и все замечательно и чем этот код можно ещё дополнить а тем что если мы хотим сделать подтверждение регистрации по емейлу нам нужно как-то сгенерировать как-нибудь токина его отправить на email и отобразить человеку сходи на email посмотри чтобы генерировать токены мы придумаем просто на лету какой-нибудь объект от низа и у него вызывает метод генерирования токен и все вот и все замечательно и теперь нам нужно этот токен куда-то отправить берем e-mail и токен и отправляем его на e-mail в простейшем случае через свист миллер вот так но так не особо интересно контроллер загаживать поэтому мы можем вынести в отдельный объект сендер сент когда мы будем его инжектить там будет видно что это токен сендер или confirm talkin' центр классно так называем главное чтобы было понятно что он делает и в итоге этот код мы вынесли отправку им его сюда в talkin' сендер запускаем его все замечательно рендеринг представления письма и отправляем на e-mail и соответственно код у нас будет вот такой как мы уже сказали соответственно после этого можно написать flash сообщения чтобы он посмотрел на емейл и среди рек на главную страницу все замечательно это у нас контроллер для ешьте теперь можно у нас может быть такая ситуация что помимо учтите простых выпуске у нас может быть какой-нибудь е5 и мы должны то же самое сделать но в зоне без всяких форм мы делаем вот так используем простой валидатор на лету используем вот это все дело и запускаем ее все вроде как работает также но мы возвращаем только час он ее не пишу никакие flash сообщения никакие шаблоны не рендере в этом коде дальше помимо опять у нас может быть как они другой контроллер но сейчас я просто упростил запись вывод ошибок валидации но это я так делаю свой собственный обертку над валидатор am использовать не особо важно и помимо этой контроллера у нас может быть какая-нибудь crm привязана к сайту от которой прилетают некие хуки по которым мы должен должны как-то пользователя у нас зарегистрировать базу добавлять все остальное поэтому будет еще 3 контроллер который будет называться crm call back call back в нем принципе тот же самый код который там была разница лишь в том что он возвращается к сестру место просто пустом массива и кода 201 создан у нас получилась такая ситуация запрос прилетает сервер он направляет на наш php файл запускает и у нас есть три контроллера который в разных адресах открываются но это не все помимо ешьте теперь у нас может быть консольный режим если там администратор нужно в консоли что-то активировать пользователя что-то сделать чем он отличается тем что используются другие стандартные переменные тем что файл у нас по-другому называется и мы его запускаем консоли и он содержит в принципе такой же код только вместо request a response он работает с импортом и и out потом который либо считывать с экрана из терминала либо пишет в терминал в принципе все остальное тоже самое почти что и приложение делает также есть такой же роутер есть какой-то резольвер который по импорту выбирают команду в который мы хотим запустить ее и запускает через комнаток секут передавая им толпы и команда у нас если мы используем symfony команд у нас будет вот такая где-то метод execute туда прилетает им патриот под и что мы должны здесь делать и что мы на что обратить внимание что вешние верхней код у нас в принципе тоже управляет нашим выполнением и запускает уже наш код то есть верхний код является тоже фреймворком но для консолей жанин для веба и если команда такой возьмем консольную в нее можно поместить тот же самый код создали команду но уже заполнили из консоли введите email введите пароль право лидировали я как-нибудь вручную вывели ошибки валидации и потом создаем также юзера управляем на имела все это остальное как и там у нас было то есть консоль у нас получается такая же почти ситуация 1 создается апликэйшен и вызывает нашу команду если у нас несколько команд а он разный команда выполнит газета но помимо этих вещей у нас еще собакам бывать зарыта что и подключаем какой-нибудь очередь и те же самые команда или какая нибудь другие микро сервисы если вы делать на микро сервисах вас прилетают из очереди некие сообщения видишь сон а что вы с ними делаете у вас зависит какой нибудь worker который циклом читает из очереди пока там сообщений есть по ним определяет также лизал миром некий handled и запускает этот крем для этого сообщения и handler принципе такой же код должен будет содержать в том коде будет на signat messenger который это сообщение принимает это тоже у нас фреймворк получился он тоже управляет нашим процессом перехватывает запросы уже разруливает как регулировщик и отправляет запрос к нам наш kinder вот у него такой же только чище в итоге что получилось получилось что у нас есть несколько входов в барский консольной и очередь в тоже консоли но немного по-другому именно джейсон ими без всяких импорта файла откатов и подобных вещей и у нас и там и там и там есть вот такие классы эти классы у нас в принципе являются контроллерами и там и там и там давайте нарисуем вот так чтобы было понятно удобнее разделять потом на слои которые в этом часто книг и читайте здесь что у нас происходит у нас вроде как сервера есть очереди есть консоль есть но они у нас запускают в принципе повторяющийся код почему потому что у нас там повторяется одно и то же то есть внешний код вокруг вот этого у нас разный в разных местах а вот этот основной код который юзера регистрирует один тоже что с ним делать его для удобства можно вынести куда-то в одно вообще место и потом и дергать отовсюду он давайте создаем некий класс хендлер обработчик этой команды регистрации пользователя достаем из базы данных из таблицы users ли откуда-то смотрим есть ли там по такому емейл он с такой человек такой пользователь кстати такой проверки у нас там раньше не была мы сюда добавили что потому что там и код экономили потом создаем пользователя отправляем записываем базу и проблем письмо все вроде как хорошо и теперь когда он такой хендлер вынесли мы теперь можем дергать из разных контроллеров всех этих вещах это его все зависимости которые мы на предыдущем слайде нем писали он принимает репозиторий хранилище пользователи которые в базу данных общается хэш пароля токи nether которым мы генерируем в токены и сендер с помощью которого мы эти токины на и мы отправляем вот такие классы просто так от балды придумали и нам хорошо приятно удобно их вызывать эти объектов и так хендлер у нас вот такой и теперь мы можем вот этот хендлер дергать из разных вещей мест мы помимо того как регистрация пользователь на вас проходят у нас еще должно быть подтверждение пользователя как мы это делаем создаем еще одну команду который принимает только токен длиннее сделаем отдельный хендлер она принимает эту эту команду находит потоки но этого человека если там пользователь такого не нашлось кидает исключение на текст ошибок особо не обращать внимание если там ошибки какими грамматически будут это я второпях писал и подтверждает регистрацию визира вызывает метод канфер sign up который этого и пользователя внутри переключает на новое состояние и и сохраняет это изменение мазу sinfonie и так здесь мы работаем напрямую с entity менеджером передали туда но весь entity менеджер туда можно не передавать его можно обернуть своим классом flasher и у него вызывать тот же самый метод flash который внутри будет вызывать on these менеджер flash это нам чтобы никакому другому программистом не брелок не взбрело в голову полезть вызвать какими другие методы эти менеджеры которых у него полно не так теперь мы все наш контроллер который их пользователя регистрируют переписываем на использование этого хендлера выпуски и описанные не все эти остальные и у нас принтер может как мы помним кидать domain exception что пользователь уже есть базе на проверку наук уникальность нам нужно как-нибудь поймать можно поймать прямо здесь если вылетит отправить сообщение зоновской такое либо куда-нибудь вынести наверх какой металл веры либо рабочих ошибок и там смотреть что если это дома in exception the genie рэм такой запрос в response записываем и тогда мы вот этот код упростим такого и больше не будем в каждый раз strike вич копипастите зона каждого контроллера для api для джейсона горчицу на это прокатывает но для вы бы это не прокатывает почему потому что там просто если ошибка 500 человек выбрать а соверши по 400 и текст сори не особо это удобно будет поэтому мы и здесь оборачиваем в особой тройки которым flash сообщение разные записываем что если успешно то проверьте почту саксэс если не успешно то прям ошибку верху лейблом выводим поверх нашего кода поверх нашей формы регистрации пользователя и так здесь мы можем еще и залакировать сразу мы можем как-то и мы не логировать если нам не нужно это дело блокировать в принципе у нас получилось то что мы в этом коде а теперь избавились от только пи посты которая была и вот этот основной код у нас дергается вот этими двумя вещами создаем команду и отправляем их 12 по соответствующей все остальное код чисто сугубо контроллеров ский консольная команда так же самое меняются в итоге у нас такая ситуация получилась что каждый сервер и подобная вещь дергает у него у нас свой собственный фреймворк для вейбо для консоли для очереди и он запускает нашей команды почему это важно потому что теперь вы знаете что это все фреймворке можете выбирать и какая ситуация возникает то что мы а вот это все их контроллеры который внизу написаны в этих фреймворков которые мы свой код к ним подвязываем у нас есть некие свои из кейсы которые мы с вами написали из этих контроллеров дергай макеевский если все замечательно из всех и таких из кейсов можно написать на разные операции на смену пароль на восстановление на редактирование профиля и всего подобного соответственно а эти эскиз уже внутри с вами и дергают нашей сущности основной юзер репозитории в менеджер из всякие сервисы и хитрые подобные вещи вот такая картина получалась и как мы видим контроль управления здесь вот такой фреймворк запускает наших контроллеры контроллеры запускает и из кейсы из кейсы работать с сущностями союзе раме и подобными вещами и вот это все hу что написано это именно взаимодействовать с пользователем slash сообщение миф обработкой запросов принятием отправкой рендерингом ответов и подобных вещей вот это вещи более такая отдельная она описывает операция которая нас с ядром вот происходить с нашим кодом это собственно сами сущности рабочих в которых мы код помещаем уже основной оригинальный вот это все верхняя это интерфейс с которым человек взаимодействует и он с кейсами напрямую не видит что там контроллер дергает работать только сверху внизу у нас основной домен если вы книги по 10 читайте подобные то там все время этот домен домен домен домен дома их модель и модули все это подобно а средний слой это прикладные всякие операционные сервисы applications прикладные за уровня приложения то есть если у нас есть представим себе систему вы приходите программировать проект вас там папочка entities сущности или модемов мы туда заходите а там 800 файлов юзер какой чек ордер и подобный я вам говорят ну с программируемыми вот это ли запустим мелли регистрации пользователя вы думаете и какой никлас тут дергать поэтому внизу будет кучу вас 500 всяких юзеров и подобных вещей а посредине вас будет например штук 60 из кейсов на каждую операцию и вы уже отделяете что у вас за основная куча основного кода и где волосами операции же можно в одну в отдельную папочку с кейс у нас положите либо куда-то еще чтобы было понятно где находится в итоге чем у нас система интересное то что вверху у нас интерфейс фреймворке а фреймворков может быть многом в мужских zend воровал симфонии и подобные там микро фреймворке все это подобное консоль на framework of либо symfony консоли либо зэнт консоли либо еще какой нибудь консоль можно придумывать сколько угодно виде и очередей много мира бетонки у редиса подобные вещи для них отдельные worker а вы можете написать и я не будут запускаться вот так то есть вверх в верху полный розарно абразив ю а н ю ай можность в при такой системе такой структурой полностью менять просто варварский controller и переписывает и на симфонические или на и фреймворк и все остальное код в нижней нее не меняете это удобнее в итоге если мы вот эти свои которые нас есть кругом нарисуем то встретим тоже самую картинку которую вы видите у вас есть и апликэйшен domain и они так устроены так расположен то есть все запросы пролетает и фреймворк он их обрабатывает всякие красивые штучки верстку туда нам выше вырывает и потом дергает апликэйшен и по нему уже из него работать с сущностями юзера и подобное с домами и так вот такая система у нас получилось такое разделение какие у него плюсы плюсы в нее объективные то есть если мы и и нормальные то есть вы все здесь нормально понимаете что если так писать то во фреймворке можно менять покойно сверху верхний уровень спокойно менять и вишни реальный а вот соответственно много способов с ними работать другой это то что контроллер а теперь не содержат основного кода они содержат только учтите пекут либо только консольных вот только еще какой-то код только взаимодействия такое ну и соответственно если мы так рассмотрим у нас распределение обязанностей теперь получилось то есть ядро у нас отдельно его я у нас один и когда ядро у нас отдельная мы получаем фреймворка независимые дыру более-менее потому что вот эти хэнды это переписывать не особо нужна вы доктрину как библиотека спокойно таскаете к себе из проекта в проект с микро фреймворка на framework и спокойно не живете или какой другой который вы изначально делаете если это компонент то его можно использовать везде они удобства здесь субъективные то есть уже такие нравится не нравится какое неудобства с объективной то что больше классов и файлов вместо одного класса контроллера что туда все написать мы сделали отдельный контроллер и каждым контроллер в отдельный space то есть основной код из контроллера вынесли в отдельный класс получилось больше два раза больше классов для контроллеров дальше необходимость сам контроля потому что вас может наступить лень и вам не захочется описать вам захочется все плюнуть и продолжить писать с фасадами со всеми теми делами прямо в контроллер и как вы раньше делали но тоже понятно а если у вас команда то вам придется не только за собой следить ну из-за и мне ними всеми мне тоже не очень хорошо бывает вот такие у нас система получилась мы рассмотрели в принципе с вами поняли для чего эти слои нужны просто так без всяких них я сознательном начальник никаких книг не приводил почему потому что сразу понятно итак для чего эти вещи удобны и так пошли дальше это мы рассмотрели как логику из контроллеров раскидывать но теперь что еще можно сказать по той системе если по такой структуре можно еще рассказать вот по этой что нужно для того чтобы она у нас работала она у нас нужно именно то чтобы мы сознательно ничего в нижние слои сверху не переносили то есть как только вы какой-нибудь flash сообщений лес сессии начинайте работать и звезд кейса то все у вас крах в контроллере это работает а в пиф консоли в очереди это не работает потому что там не c сиди там нет куб вы не можете вам среди рек тит оттуда из кейса то есть редиректов вам нужно оставить и сессия в контроллер и avis кейси только чистый код которым вообще по барабану как с внешним миром работать он принимает только команду и все ее обрабатывает вот что мы получили в этом коде теперь почему дойдем к тому подписать сущности куда основной бизнес-логику же вписывать в какие места мы с вами в контроллере уже не будем писать под смут потому что мы из них все вынесли в детский сад не будем логику основа писать почему потому что эта мешанина получится если мы туда все запихнем идеальное место куда это запихнуть это можно именно там где эти данные лежат если рассматривать паттерн их раз то вам достаточно знать первый принцип который называется информационный спирт что там основной код можно мечтать желательно помещать туда где сами до найти находится если мы в п рассмотреть если мы переключаем какие-то состояния сущности то этот код можно поместить в сущности пусть он там работает с ее приватными полями и на верхней лезет туда запихнули все хорошо ну давайте попробуем туда запихивать вот простой подход актив рекордом когда мы создаем какой-нибудь ну программируем опцион делаем на нем лот некий вот актив рекорда мы заполняем передаем авторы дату и все это стальной и сохраняем потом где тут логика нигде а где она должна появиться сейчас узнаем где появится если вы перейдёте на синем фоне сначала начнете генерировать сущности с гитарами сети рамена это перепишите на такой код но о пышном от этого вас не станет инкапсуляция вас от этого лучше не получится что нам в принципе можно с этим поступить как с этим поступить ну во первых можно для того чтобы есть такая мода последнее время от автоинкремент их одежд ников переходить на какие-нибудь строковой уникальные которые генерятся сразу то есть как то вот так можно поставить использовать один уникальный глобальный и вселенский уникальный идентификатор ее туда записывать его для чего это нужно для того что мы можем просто создать сочность и не сохраняя еще уже можем где-нибудь залакировать и создание указав айдишник то есть орешника знаем сразу но чтобы так не заморачиваться постоянно вот этот код писать сюда здесь можно сделать какой-нибудь код обернуть вот эту поддержку в отдельный класс для чего чтобы и типизация у нас потом работала узнанным видим как и чтобы этот код скрыть от наших глаз сделали статический метод next который будет и запускать и в конструкторе мы сделали так чтобы эту задержку нельзя было создать пустой то есть если кот пустой она кинется исключение мы используем библиотеку в моцарта сердца это вместо того чтобы писать вручную что если empty вылью то трубу инвалид аргумент exception вылью не должно быть пустой там имена не тот момент exception to штуки кидает удобная проверка с лучниц и соответственно любой программист который денег это печатка допустит или там попробовать нечаянно пустой знать пустое значение туда закинуть у него сразу ошибка выглядят и он ее сразу заметят и теперь мы вместо вот этого кода длину чтобы его не копипастить просто запускаем эту фабрику который генерирует следующие дни котором ну вот так мы немного так вот поменяли усложнили но давайте дальше пойдем это мы создали сущность вот так как сделать так чтобы этот кот стал объектно-ориентированным в объектно-ориентированном мире для того чтобы создавать конце объекты уже есть встроенные вещи для того чтобы эти объекты создавать фантастика нет реальность для этого и придуманы конструктором как использовать в простейшем случае вот так сюда и лот туда всю эту пачку передаем если мы работали раньше со строками этом и иодид устроен генерировали то получается что айдишник строка member айди строка дату можем тоже передавать туда строкой тайтл строка description строка цены стартовой ценой блиц-цена для досрочное окончание аукциона выводится числами соответственно вы понимаете какой конструктор получился у него там несколько шесть строк принимать strings 13 nsstring string как я пошутил недавно в виду последних событий в стрингах удобно по третьяковке гулять мимо картин если кто-нибудь из вас новости читает то можете поговорить или новости как один человек прошелся и так что здесь получается вот такой конструктор если мы просто стрингами кучу параметра мы передаем мы можем снять запутаться почему потому что нечаянно поменяем местами и всех она не то туда передали как быть и как поступать чтобы конструктор упростился для этого нужно пересилить себя с использование простых актив рекордов где вы используете просто плоские таблицы в базе данных на использование полноценных настоящих объектов именно вложенных с развитием по ответственности по группам то есть вот эти вещи здесь мне которые можно сгруппировать например тайтово и description на это что это контент правда-правда берем тайтл description и оборачиваем в контент два аргумента превратились в один то есть там у вас может быть превью большая фотография маленькая фотография там могут быть метод а их и если в этом блоке поспешить и соответственно вы можете сделать не метой туда передать мета тайтлами the description сгруппировали все а цены что с ним жить и с ним делать в принципе тоже можно сгруппировать в цену 1 цена начальная 2 блиц-цена вот одним объектных до поместили и конструктор у нас упростился почему потому что он сейчас принимает всего 1 2 3 4 аргумента они кучу которые там было и при этом он принимает теперь не стринги into a dish ник мимбар айди do the time my mouth all content прайс конструктор у него будет типизированным и если вы теперь попробуйте местами поменять какие-нибудь параметры здесь у вас спички штурм сразу ругаться будет что там ожидается объект класса провести попла прайса вы передаете туда контент переставить их местами и все будет хорошо и так вот мы в конце лот аукциона создали через конструктор вроде как замечательно получилось и теперь ее можно попробовать куда же нам без тестов ну чтобы с тестами поработать какой у нас основной тест нужно основной то есть нам нужен на то что протестировать сам лот но при этом может быть такая ситуация что нам можно будет какой-нибудь логику записывать сами вот эти маленькие объектом почему здесь это актуально потому что у нас есть большущие это за в котором написано чем как работать с ценами работается так что цена должна быть не больше точнее не меньше для должна быть какая-нибудь цена стартовая эти две цены обязательны и при этом blitz она должна быть больше чем стартовая цена то есть уже здесь нам нужно где-то iv поставить чтобы проверять что если цену меньше чем текущую были сцены поставили то ругаться нам нужно можно это соответственно проверку в формулу валидации добавить что там больше меньше больше меньше лезин ползаем и подобные вещи но для того чтобы и это было надежно и всегда даже если у нас валидация отключена мы можем сюда в этот объект поставить и куда этот код поместить но это относится к ценам для этого достаточно полей first and price index blitz прайс достаточно вот давайте в в этот самый в прайсе поместим то есть мы напишем такой тест создаем прайс передаем туда стартовый блитцен в успешном случае она должна создаться заполнится если этот случай не успешной какой например если стартовая цена отрицательным и вдруг передали но в печке нельзя указать им то что он ценит в типе где-нибудь чтобы это дело сам птичкой проверял поэтому вручную мы должны там проверку сделать и вторая проверка что будет если мы цену передадим меньше чем цена стартовой в этом случае нам можно написать вот такую штуку что если exception должен нам прилететь такой exception с таким текстом все как это делаем теперь например еще можно проверить дополнительно крайний случай проанализировать а если цены одинаковые указать что-то же должно ругаться вот мы и записали этого у нас тест для цены у нас будет это такой и если мы один тест на него потратим эти несчастные пять минут или 10 когда мы напишем первый метод потом в печке шторме control-d три раза и скопи постели просто текст поменяли циферки сложно такое сделать написать да хоть восемь я вам тестов методов таким напишу control-d и меняются recon3d меняют цифры и тексты все хорошо тесты пишутся такие быстро и вот чтобы удовлетворить эти тесты у нас класс цены может быть вот таким в конструкторе мы все эти проверки организовываем сначала проверяем поштучно что цены больше 0 1 2 потом проверяем что если первое точнее 2 больше равно точнее меньше или равно 1 толкином исключения что blitz она слишком маленькая но должна быть больше чем стартовой для завершения аукциона ну и тоже самое можно сделать для контента но контент можно заполнять либо обязательно сразу либо сделать такое условие что сначала можно заполнить тайтл а потом когда-нибудь при публикации уже написать хороший такой дискрипшн к этому лоту можно так упростить человеку жизнь чтобы его не заставлять сразу при форме создания писать целую текст здоровый он будет неделю придумывать как этот текст писать так свою машину продать ему сначала бы черновик сделать без текста просто ставит вам и все поэтому description мы сделаем необязательным с вопросительным знаком ну и соответственно типизации сделаем будет не обязательно спросите и вот мы спросим разобрались контентом разобрались contents тестировать незачем почему потому что там кода никакого нет к нему никаких требований особо нет просто сет на гетеро и все и конструктор и вот мы добрались до тестирование самолета как мы будем тестировать можем создать этот лот с тестовыми данными с вот этими же самыми первая операция второе можно взять эти данные куда-нибудь сохранить и проверить что вот эти хитрые нормально работает что там контент заполнился тесты примитивной но если вдруг там опечатались и где-нибудь когда на основе get a и d вы его с дублировали этот метод сам метод переименовали он у вас не мимбара идет началом возвращать а тот же самое день забыли написать то в этом тесте это всплывёт хотя гитары тестировать в принципе незачем итак мы лот создали конструктор мы протестировали все хорошо но теперь может быть такая ситуация когда мы хотим как-то с ним дальше работать что еще с ним можно поступить вот у лота примитивный конструктор может быть таким просто поля заполняет все но такие поля нам не особо нужны что мы делаем дальше мы хотим чтобы лот в изначально создавался черновиком а потом его можно было публиковать как это сделать ну наверно в конструкторе нам нужно сделать так чтобы у него по умолчанию прославлялся статус черновик состоянии черновик как мы можем остаться проверить добавить метод из дрифт из драфт черновик он или нет он должен вернуть нам true метод активен или нет он должен вернуть фолз вот такая первоначальное состояние когда мой лот создали пока черновиком на соответственно мы создаем вот так же самый проверяем помимо того что мы гетры проверим еще добавили две проверки что и своей ты сексе должна вернуть true или false и так как это реализовать внутри а нам вообще абсолютно без разницы что там будет внутри за код хоть константу свой присваивает хоть в отдельный класс вынесем хоть вообще какой-нибудь булево поле будет отдельный public актив и будем ему проставлять тролли falls это нам не интересует нам главное чтобы он работал как в тестах написано эти требования выполнял а что там внутри на программируется это уже без разницы как дальше что мы с ним можем сделать с этим лотом но мы его создали черновик у нас есть нам нужно теперь редактировать можем редактировать его контент и прайс с новыми создать в кондитерский с контроллером информатикой можем эти штуки разделить почему например нам можно сделать так чтобы после публикации лота цену нельзя было менять а контент можно было редактировать вот в этом случае эти методы желательно разделить и в них внутри разные проверки написать какой чего можем для кого и для чего нельзя поэтому мы разделим на отдельные два метода эти тесты работают вот так вызывает метод идет передает туда контента проверяет что контент поменялся на этот сам на тот который у нас есть вот простейший edit изменять контент и все простейшие с меня на цены будет такая же и у нас это простейшая идет о может быть не простейший например нам нужно хранить историю изменений или там еще что-то дату изменения этого контента добавляем эти дэйтон или апдейт до это отдельное поле и если вам при изменении текста нам нужно менять это поле а если мы добавляем картинки к лоту там не нужно менять это поле редактирования то вот пожалуйста в нужный текст а вы просто дату передаете текущую и и присваиваете принципе мы могли бы внутри и сделать здесь да это равно new data тайм-аута был но это одни особо хорошо почему потому что если мы в нью вызываем внутри метода то эту дату уже не получится в тесте передать какой нибудь а в этом случае можно и проверить что с этим ему нас может быть такая ситуация что мы хотим хранить историю изменения контента какой-нибудь как мы это делаем мы добавляем какую связь с менее конница связь контент и в нее добавляем новую строчку какой да ты у нас такой контент у записался вот такие у нас получились методы едят с риком контент подобными можно вынести из конструктора записывать из всяких вещей но нам ещё понадобится другие операции производить ну это мы тест написали с помощью котором мы проверяем что в этот контент у нас записалось это история что там два элемента теперь после создания и редактирования и что у них в последнего раем дату и контент вот этому которые здесь есть и вот такая ситуация дальше но лот создавать каждый раз не особо удобно почему потому что мы помним что длинный там конструктор если конструктор мы поменяем что каток учете став нужно переписывать вот такой вечер можно вынести в какой-нибудь либо статический либо обычный метод в виде конструктора и будет у нас вот такое сначала в конструкторе заполняет поля значениями по умолчанию для тестов и билде лот возвращает вот такой соответственно мы этот builder запускаем себя в простейшем случае у нас вот такой и у нас запускается проверяется это редактирование так после того как мы отредактировали его нужно опубликовать или отправить на модерацию но если мы рассмотрим что публикуется сразу пользователям то можно добавить метод publish куда мы передаем дату публикации и дату истечения как это работает он у нас запустит вот эти методы они будут заполнены вот этими датами и проверяем что эти методы заполняются дальше какая проблема может быть в метод publish уже хитрый почему он может проверить заполненный контент если фотографией лота или нет вот этого всего и проверить внутри себя то есть можно попробовать создать этот лот без description на без описания в контенте и проверить что он кинет исключение заполните контент для публикации как мы это делаем мы немного переписываем наш builder добавляем него метод мутирующий но не матирующие ему табельный discontent куда мы можем передавать свой контент и вот так у себя использовать как мы раньше записали ну так весь контент передали content by закреплена проверили что он получается вот такой вот у нас он проверяет что если не это черновик точнее если это не черновик кидает одно исключение если контент пустой кидается второе исключение иначе переключать статуса присваивать даты все замечательно вот у нас такой метод получился и теперь эти тест можно немного модифицировать почему потому что мы публикацию контента сделали а нам нужно теперь сделать так чтобы после публикации его нельзя было менять таза у нас так написано чтобы никому нельзя было отредактировать мы пробуем протестировать вот это делаем мы верху там черновик редактируем проверяем что он заполнится внизу мы не черновик уже активный год запускаем и проверяем что у него все хорошо для этого добавляем метод builder который будет активный создавать вот и проверяем чтобы он будет его здесь публикацию запускать который там есть вы слайда потом посмотрите в записи вас свет будет вот эти то у нас такой из проверяет что если это не черновик то извините я не могу отредактировать все publish добавили и модератор может нечаянно посмотреть лота у себя просмотрите какой из них может отклонить указав причину добавили метод reject вот мы такие методы добавили и теперь самое важное самое интересное и самое полезное что у вас будет из этого доклада с такими объектами мы с вами вроде как познакомились маленькой вложенными но вместо вложенных тактики объектов можно еще и большие вложенные объекты делать например ставки теперь к этому лоту можно добавить метод моих бед с помощью котором мы именно этому лоту от конкретного пользователя можно добавить свою ставку с какой-то да ты по какой-то цене как мы это делаем этот метод нас будет уже вот такой огромный почему потому что ставку можно сделать только в том случае если лот активен потом ставку можно сделать только один раз если там уже такая есть то вы уже вот как раз ошибка я писал вы уже ю а а потом забыл удалить потом смотрим если там есть ставки то берем последнюю ставку и и цену проверяем если текущая цена вот этой ставке меньше чем та которая последние то мы кидаем исключение вы не можете такую маленькую ставку сделать переплюнете другие все вот такой метод мы сделали ну и дальше он добавляет связь новую строку бит такой метод сделали можно добавить метод change пик с помощью которой можно в том случае если ваша ставка не перекрыто ее можно будет поменять на какой не другую вот так ну и можно добавить метод клаус которые чтобы делать а будет делать у нас он то что он будет как-то по крону запускаться если крон запустился если там дата истечения уже прошла так рон его закрывает и при закрытии он либо переключается статус закрыть просто так а если там были ставки то одна из них помечается победителем как это сделать вот так простой случай если он не активен , исключение иначе закрываем переключаем статусы и последнюю ставку делаем победителем все замечательно вот такие вещи у нас получились лот у нас закрылся ну а теперь очень быстро пробежимся как это реализовать доктрине и потом несколько вопросов и что-нибудь подарим мне напоминали что нужно вопросы задача выбрать тасс замечательно ответит на это дело как реализовать доктрине но первое что нам нужно реализовать доктрине это то что пометить что этот класс у нас сущность мы помечаем его так 2 нужно сделать чтобы технику нас был объектом как мы это делаем мы создаем объект айди и в него добавляем метод tostring который нужен для доктрины потому что она внутри себя для поддержки составной включая делать им плод через запятую всех этих вещей поэтому там иначе у нас вылетит с ошибкой не могу привести объект к строке поэтому нужно добавить мед пустыми создать тип который будет конвертировать из объектов базу в строку и стринги из базы обратного объект это тип прописать доктрине отдельным типам и его использовать у себя в маппинге теперь указывает что мы используем наш собственный тип автор айди мы делаем по то же самое но для мимбара найдешь ник для дата тайма ему то было используем стандартный symfony вский из доктрин овский этот компонент и так я айтишник лишний раз скопипастил вот это ремонте последние здесь уже не нужно да publish да это у нас может быть null и был базе данных и вот такими поля мы сделали теперь что нужно что касается контента для того чтобы вложенные объекты делать этот тренер уже есть ложная возможность делать вложенные объекты помечаем это дело как mb до был такой класс помечаем ему поля и теперь просто у себя в lotte указываем что мы используем вложенный объект вот такой контент который там все доктрина за нас все делает префиксы базе расставляет его раскладывает по этим полям обратно собирает дальше также делаем цену с классом прайс и иногда бывает такая ситуация что у нас некоторый объект здесь у нас цена и контент обязательно для заполнения не всегда есть такие ситуации когда у нас какой-нибудь полирнул а иногда у него может заполниться какой-нибудь контент здесь у нас такого нету но при регистрации пользователя это может быть таким подтверждение чего то для этих целей мы определяем mpd был токен него проставляем нола был поля и у себя сделаем небольшой хак у самого юзера у самой основной сущности прописываем что нужно использовать метод post вот после загрузки с базах данных и вручную оттуда вычищать почему потому что доктрина если там прописан talkin' to он создаст пустой talkin' если поле из базы подлететь но lable соответственно все с морями просто vita этому вручную его обновляем все теперь мы делаем статус отдельной строкой war чарам каким-нибудь и после этого определяемся связь beats нам вон там он мне и здесь что на что нужно обратить внимание это вот на эту строку war for removal tool in a casket пол каскадное обновление для чего это нужно для того чтобы доктрина воспринимала вот эту всю лот вместе с битами все как один большую как одну большую пачку и сохраняла чтобы это все одной пачкой то есть мы pure system через entity менеджер целиком весь флот и он и будет его сохранять вместе с вложенными видами то есть это склеивает это а точнее когда мы используем каскад каскадное сохранение все это стороной он сохраняется вместе арфарре мол он говорит что нужно и целиком удалять это все делает база данных то есть вычищать все эти беды когда мой лот удаляем в конструкторе обозначаем это дело как создаем как recollection доктринам скую и все и разница лишь в том что в доктрине нельзя сделать там то есть доктрине для того чтобы эту связь обозначить ее нужно обозначить как обратную из беда и туда передать наш текущий объект чтобы она через связь в измене сделано через билан 100 и соответственно мы получили что определяем бит тоже как сущность у нее можно поставить уникальный constraint чтобы уникальное поле было из двух колонок составное чтобы к одному лоту несколько один и тот же мембер несколько ставок не делал хотя это у нас и проверяется самом коде но можно добавить и здесь о доктрина есть такая штука как идентификатор в доктрине в каждой сущности должен быть первичный ключ у нас в нашем коде его не было уставок мы ориентировались только на мамбе рейде и здесь мы можем просто добавить какой-нибудь после того как мы связь на лот сделали и прописали каскадное удаление какой-нибудь мы можем добавить некий суррогатный вспомогательный ну чисто для доктрины нужный ключ дай ей так нравится и вот так мы сюда и заполняем но в нашем коде мы его не используем все мем параде мы прописали точнее и из из винного мы делаем связь belongs тон для того чтобы хранить ссылку на активный год все мы это все сделали методом и писали и чему мы к чему мы пришли к тому что вместо того чтобы работать с обычным active record эти поля поштучно где-нибудь в контроллер и заполнять переключать перри заполнять мы всю эту логику которая касается переключение этих полей переключение состояния самого лота поместили в самолет и мы работаем с этой пачкой как с одной пачкой да там есть у нас полноценная связь к измене на ставки у нас может быть там какими комментарии к этому лоту у нас могут быть какими фотографий тоже связь к измене но все это рассматривается как один объект и работаем и с ним через верх через сам лот вместо того чтобы работать ваш точно с каждым полем вот так все бизнес-логику который касается конкретно лота мы поместили в сам мод не получали вот таким методом вот собственно конец нашего доклада повествования"
}