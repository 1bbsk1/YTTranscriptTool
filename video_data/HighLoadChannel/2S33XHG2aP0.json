{
  "video_id": "2S33XHG2aP0",
  "channel": "HighLoadChannel",
  "title": "Ускоряем хранимые процедуры на Postgres plpgSQL по гистограммам / Анатолий Анфиногенов (ВНИИЖТ)",
  "views": 93,
  "duration": 2157,
  "published": "2023-10-06T07:22:02-07:00",
  "text": "мы уехали немножко назад Вот краткое содержание предыдущих серий наша история импортозамещения началась в восемнадцатом году Вот были получены интересные результаты и об этих результатах я рассказывал и на хайлоуи Питерском и на пиджаконфах вот чтобы каждый год не рассказывать одно и то же я продвинусь дальше что мы сейчас делаем вообще кто мы такие Я работаю в отраслевом институте российской железных дорог в ниже ты в Москве вот мы делаем систему которая позволяет планировать расписание грузовых поездов Железнодорожная вот эта система Эльбрус Она работает на всех железных дорогах России от Калининграда до Хабаровска в двенадцатом году мы даже получили премию международного Союза железных дорог за инновацию в этой области потому что расписание нас передовые вот так выглядят расписание глазами нашего клиента это график движения поездов там есть историческая область текущая Плановая это расписание строится нашими клиентами этих расписаний Много Они обмениваются это аналитика о том как ездят которые тоже делается на основе нашей базы Вот и Как устроена собственно все изнутри изнутри это одно расписание очень сложный объект там порядка 20 различных типов объектов в этом расписания оно одно расписание занимает до 500 Мб его конструируют тяжелый клиент при помощи там некой модели дальше все это располагается пространственно распределенно на 16 железных дорогах Вот и есть еще Центральный уровень который позволяет строить аналитику и выполнять там еще дополнительные прогнозы архитектура у нас классическая трехзвенная действительно на уровне базы у нас Монолит потому что задача специализированная задача компактная вот у нас Java у нас был самого начала за исключением базы данных уроков у нас была база данных Oracle Standard Edition One Это был там 2006 год на тот момент не удовлетворял требованиям которые предъявляли системе и мы наша база устроена Так что там порядка 250 активных таблиц Центральный там до двух ТБ данных На дорожных уровнях где-то 250 Вот и самое главное что у нас порядка 50.000 строк кода было хранимых процедур на до того было на плейлист QUELLE их было большая часть усохла при переезде на повис сейчас их порядка 50 тысяч на опустгосе используется автономные транзакции эмуляция потому что у нас плоскость ванильный используется у нас в римлянной таблице в смысле Oracle тоже об этом расскажу как мы выкрутились и основная особенность нашей специализированной базы что у нас мало клиентов и транзакции редкие и крупные потому что задача Вот это расписание хранить обрабатывать фильтровать обмениваться соседями Почему мы реализовали интерфейс базой только через хранимые процедуры потому что у нас предметная область понятная достаточно сложная Вот и соответственно логика хранение таких сложных объектов она должна быть сосредоточена внутри базы потому что неоднократно там делали протестирование делали какие-то преобразования структур данных клиент естественно этого не замечал потому что пока опять сохраняется взаимодействие с серверным приложением дальше то собственно ничего не происходит можно этим заниматься и самое главное можно иметь хороший механизм профилирования логирование Когда происходит что-то с точки зрения что бизнес логика как-то у нас не так работает или у нас что-то не воспроизводительность всегда можно разобраться Об этом я хочу сегодня рассказать как мы эти задачи решали что у нас произошло нового по сравнению с прошлым у нас продолжается эксплуатация системы на которую мы переехали 40 и вылезли проблемы которые можно уже отнести к проблемам хронических заболеваний потому что какие детские болезни Мы порешали про них тоже будет Ну вот хронические заболевания научились решать только сейчас лечить и плюс расширение нашей системы мы сделали следующую систему Теперь подробнее поговорим о том как у нас происходило импортозамещение импортозамещение у нас в восемнадцатом году началось с того что нам позволили маленькую подсистему там буквально пару десяток таблицу пара десятков процедур перенести и искать опыт приобрели мы и опыт приобрели коллеги на местах которые собственно впервые столкнулись с позже чтобы не бояться вот эту первую пилотную задачу мы сделали второе Что произошло это Собственно сам переход как вот сегодня был первый доклад это интересно это бурно Это большой опыт но повторять его целиком сейчас в этом докладе не буду Мы перешли у нас было Параллельная эксплуатация то есть полгода у нас система на уровне системном подвисе работали на соседних машинах причём около какое-то время был ведущий дома и опять же все привыкали что ничего не упадёт не сломается ничего Потом Они поменялись местами а потом море окончательно исчез вот попутно решались проблемы со скоростью с местом с эксплуатацией с метриками вот искать 20 год мы вкатились с тем что какие-то все-таки Проблемы остались и о том как эти проблемы решали мы поговорим как мы переносили переносить можно было естественно тремя способами вот корневых процедур можно было сесть написать заново это всегда не получается потому что не хватает времени ресурсов есть другие задачи которые тоже нужно решать потому что импорт размещение как всегда приходит внезапно вот можно было оставить как есть но тоже ряд проблем пришлось решить поэтому так сказать золотое решение было небольшой Фактор всё-таки в процессе переезда проделывать вот здесь в докладе оставил специально шаги которые мы сделали то есть это те дела которые надо сделать через них не перепрыгнешь этот список естественно все время растет то есть и в этом году в этом списке мы доросли вот до того что мы лечим хронические заболевания мы расширяем метрики мониторинга которые следят за производительностью и мы разбираемся почему же всё-таки у нас там временами база работает медленно в дальнейшем следующий шаг который здесь нарисован ещё не сделал это переехать всё-таки звонила на пост Газпрома потому что она же заказчик после приобрёл но нужно какую-то техническую работу привести для того чтобы всё-таки уже звонила перейти на про это тоже не так просто вот первое что Пришлось сделать когда мы переезжали это придумать обходные решения потому что ворот ли мы привыкли к одному в воздухе многих вещей не хватает А многие вещи ведут себя по-другому во-первых нам обязательно нужны были автономные транзакции не для того чтобы писать что-то поперёк транзакции для того чтобы делать логи чтобы Мы понимали что у нас происходит внутри нашего приложения Вот спасибо присутствующую здесь Иванов Волкова который написал поговорил сочетание дата вышлинка поговорила с нам на ванили удалось реализовать достаточно производительный способ писать данные в таблицу поперёк транзакции дальше я покажу что это действительно в нашей ситуации быстро и не создаёт заметный паразитной нагрузки на сервер вот кстати вместо можно еще использовать параметры в конфигурационном файле Но это решение гораздо хуже Поэтому лучше все-таки Если уж вы хотите пользоваться не про ванилой то лучше Используйте такую связку второе обходное решение это использование временных таблиц В смысле Oracle то есть таблицы которые данных есть независимо от транзакции почему это важно когда мне сервер приложения передает 500 мегабайт данных расписания для того чтобы я это при помощи процедуры сохранил единственное возможный способ передать такой объем данных на вход процедуры это поместить его куда-то в 40 лет помещалась во временную таблицу временная таблица создается только в момент транзакции ее нельзя создать заранее и сервер положение про это не знает чтобы не менять сразу систему во всех местах мы постарались сервер приложения сохранить максимально его старом варианте Тем более что во время переходного периода система у нас умела писать сразу в две системы вот преимущество пиая реализации работы с базой через Pi что примерно полгода сервер приложения параллельно умел работать и 40 градусов причём переключения было Ну грубо говоря остановить там Кэт поменять конфиг кто из них ведущий и заново запустить у нас мы могли переехать 40 на пост газ и обратно Вот но для этого интерфейс должен примерно быть таким же как вот мы реализовали сначала это через unlogited таблицы вот как потом оказалось решение было ошибочным почему мы сейчас увидим как говорил нехороший человек из этого произведения если вам дороги жизни рассудок от некоторых объектов следует держаться подальше вот дальше входные инфраструктурные решения это отсутствие джогов в ванильном возрасте нет ничего Что умеет делать жопы есть опять же различные расширения есть всяческие приблуды вот нам Пришлось написать свою потому что там Кэт у нас уже был Java приложение было в Едином стиле мы сделали себе небольшой Java приложение которое умеет запускать пакетное задание умеет делать еще много чего хорошего то есть в нашем случае это удобно в вашем ну по-разному эти вопросы можно решать начиная от простейшего Крона Вот и запомнившихся моментов при переезде различное поведение тутанстэмп и дейт то есть мы привыкли Что дает это такой же таймс Темп только чуть-чуть с меньшей точностью А в возгласие все строго да то есть это день без времени и числа синтаксически все замечательно Пока не сталкиваешься с результатами и находится не сразу а второй момент замечательный тоже наш урок изобиловал операторами мёрз вот он конечно прекрасно заменяется инцест он конфликт Но если указывается неконстроен относительно которого возникает конфликт а просто перечисляются Поля по которым конфликт должен возникнуть если Константа нет конфликт не возникает синтаксически Все правильно но это место код никогда не заходит тоже такая трудно обнаруживаемая ошибка который попила не мало крови вот чтобы все это у нас хорошо работало при приезде 40 на ванилу нам пришлось поставить ряд расширений по отношению к постгальзь про практически все это расширение являются встроенными а по отношению к ванили два из них Oracle ВДВ и ПК приходится собирать из исходных текстов Это очень неудобно это затрудняет обновление сервера Потому что при смене библиотека операционной системы при повышении версии при повышении версии возгласа Надо по-хорошему заново компилироваться иначе работоспособность неизвестно будет работать или не будет теперь собственно что я хочу в этом году рассказать такого как мы проверяем где у нас источник проблемы как мы ускоряем наше хранимые процедуры для этого мы должны уметь измерять производительность того что у нас происходит на базе вообще измерять производительность приложения в целом Идея хорошая Она должна и на клиенте измеряться и на сервере приложения измеряться и в базе измеряться но относясь конкретно к нашему случаю вот у нас например медленно стало сохраняться расписание или медленно устал читаться возникает вопрос А что случилось Где искать причины этого И что собственно конкретно делать чтобы у нас Снова стало хорошо для этого максимальный объём информации мы можем собрать естественно находясь внутри самой хранимой процедуры хранимые процедуры у нас достаточно большие вот поэтому по-хорошему возможность управлять производительностью лучше закладывать при проектировании иметь возможность писать некие логи в которых Ну во-первых измерять производительность это вообще бесплатно с точки зрения накладных расходов внутри кода вы всегда можете поставить некие таймеры и производить какие-то оценки и в случае если что-то вас не устраивает Вы должны об этом кому-то рассказать что не держать Это в себе Потому что когда станет Плохо настолько что увидит пользователя уже будет несколько более стесненные условия для работы для того чтобы эту проблему быстро исправить вот поэтому по-хорошему процедуру должны измерять собственную производительность если что-то вызывает подозрение кричать об этом в мониторинг Вот и в том числе даже планы выполнения вот даже план выполнения писались проблемные в подвисе пока мы знаем что это можно сделать но это слишком сложно чтобы быть пока реализовано вот как примерно выглядит процедура здесь в мелкий текст лучше не вчитываться это всего лишь иллюстрация к тому что вот у нас порядка там двадцати блоков вскрывали операторов большой процедуре вот из них какие-то проблемные какие-то хорошие но мы вводим им такие метки текстовые на которые потом будем ссылаться и по каждой группе операторов по каждой фазе мы измеряем просто скорость важность знать какая у нас абсолютная скорость и важно знать какая скорость относительная во-первых сверху написано время выполнения вот на трех разных железных дорогах одно и то же громадное расписание Оно просто рассылается вот время работы с этим расписанием одно и той же процедуры на одной дороге 4 секунды на другой 6 а на третий - 19 понятно что там где 19 - Это плохо но 19 - это в принципе девятнадцать А на что это 19 пошло вот смотрим Что фаза номер три два пятьдесят три процента в хорошем месте выполняется относительно общего времени выполнения там 63% приемлемом месте А в плохом месте она выполняется там почти 80%. уже это мощный сигнал что и из тех вот этих открывали операторов надо естественно вот смотреть туда вот он если мы его задавим то у нас перераспределиться общая картина когда мы только переехали с уроком на постгрыш ещё Точнее не переехали а просто вот тесто в тестовом инвалидности первый раз запустили писали писали нашу большую процедуру И сейчас мы сохраним расписание мы его запустили расписание вместо 30 секунд сохранялось 19 часов при первом запуске Ну Неудивительно плохую программу написать может каждый легче чем хорошую Ну просто вот с этого момента мы начали разбираться А почему у нас она работает так медленно каждый следующий шаг первый шаг ускорил на 12 часов второй шаг ускорило на 6 часов то есть там за первые сутки мы прошли путь от часов до минут потом уже начали разбираться с минутами и вот очередной шаг этой итерации желтенькие строчки это как было зелененькие как стало на очередном этапе этой итерации выделяется этап на котором у нас проблемы изменяется скорость Потом видим кандидата на следующую оптимизацию и так вот последовательно действие на этапе разработки доходим нормального состояния потом сдали все это заработало в продакшене но вдруг изменились какие-то условия что-то стал расти сторож поменялся технология например поменялась немножко стали вызвать чаще или не тем объёмом данных объём данных стал расти у нас всё время это всё дышит это падает мониторинг и когда что-то случается Вот например что-то случилось вырос красный пик до такого значения ясно что вот группу операторов которые относятся вот к этой части процедуры на неё посмотреть и разбираться что же у нас там творится когда мы позанимались поразбирались выполнили оптимизацию у нас главный пик снизился у нас подросли основные пики если скорость работы у нас клиенты устраивает Все мы тогда уходим занимаемся дальше своими делами если опять что-то случается мы смотрим снова на гистограмму и экономим время силы и так далее ну чтобы на эту гистограмму смотреть нужно результат а измерять и Б писать в какие-то логи и в мониторинг теперь о лечении детских болезней которые у нас происходили при переезде и в первый момент эксплуатации Ну самые лежащие на поверхности мы используем активно временные таблицы если Просто после того как вы этого временную таблицу что-то попало она как входной буфер сделайте аналайз Oracle мышление позволяет делать какие-то налазить Внутри там же сразу будет конец сразу транзакции закончится в плоскости можно делать все поэтому делаем становится быстрее вот комментарий в скобках что А почему ранее делается автомаком это конечно касается не временной таблице не ходят Но если у вас не приходилось какое-то нормальное таблицу делается наладить процедуре Задумайтесь это значит делать что-то не то в вашей базе вот второе допустим отсутствие индекса какого-то Вот например заглядываем в ПК стоит нас и смотрим на 10 топ операторов по загрузке вот на загрузка вызов процедуры которая по идее должна выполняться очень быстро Что случилось Да ничего так такого обычного объединение маленькая табличка объединяется с большой большая табличка стала большой потому что не доследили Все думали что она будет маленькая оказалось что она большая забыли построить индекс Ну построили индекс все сразу стало хорошо всё ускорилось А сколько стоит собственно логирование которое мы сделали вот таким полуколхозным способом через дата бейс-линг и поговаривался вот Нижняя строчка это конечно топ не топ Но если посчитать общее время выполнения разделить то получается менее процента для нашей задачи менее проценты это ерунда но возможность постоянно быть в курсе чем живет наше приложение это бесценно поэтому естественно мы возможно с логирование никогда не отключаем она у нас параметрическое у нас можно просто задать для каждой каждого типа функции задать признак логируется она или нет Если что-то происходит там не то мы просто включаем на ходу расширенные логирование по конкретной процедуре она начинает сыпать влог больше информации чем обычно Ну и разбираемся потом Выключаем обратно Вот Потом такой интересный момент увидели что нестандартные формы операторов апдейты Delete по крайней мере у нас 11 версии плоскость давали заметный прирост производительности по сравнению с стандартными операторами вот следующее естественно у нас расписание с которыми работает пользователь они в базу вливаются и они должны же оттуда и выливаться то есть устаревшие ненужные пользователи должны удаляться и Мы заметили что удаление идет как-то очень мучительно и долго не должно так долго удаляться что же такое вот сейчас узнаем у нас в окле было реализовано удаление дочерней таблицы через связь удалял из двух таблиц сразу связанные объекты когда мы стали смотреть Что же делает постгрыш при удалении 5 млн из родительской таблицы дочерней таблицы он удалил их построчно было 5 миллионов отдельных запросов вот это вот реализовано было естественно тогда скорость ожидать не приходится Как решить используя специфический для способностей был expressions то есть мы удаляем внешним операторе потом при помощи returing возвращаем то что мы удалили таблицу при помощи этого множества данных удаляем там помогло совершенно замечательно Вот после внедрения проблем с удалением у нас больше не было так дальше жизнь продолжалась искать мы пришли к диагностике лечению хронических заболеваний хронически заболевания были такие что что-то стало все опять же медленно работать вроде у нас технология не менялась объем В общем примерно такой же ничего не растет но медленно появилась иногда даже скачкообразно медленно было хорошо потом в 15 раз стало хуже посмотрели в планы откуда-то вылез чек-скан вместо индекса стал индекс перестроили ничего не помогает стали разбираться думаю может статистика как плохо собирается Давайте увеличим глубину сбора статистики по умолчанию там стоит параметр 100 вот поставим по максимуму там одна единичка это 300 страниц Ну вроде помогло вот смотрите опять процедура стала работать хорошо так живем дальше Проходит какое-то время даже вот такие вот расширенные способы сбора статистики не помогают перестроение индекса не помогает что делать Ну как что делать изобрести обходное решение с кенты были для того чтобы индекс использовать иногда ошибался индекс не брал Давайте позже поможем после Конечно хинтов нет но кое-что все-таки сотворить можно Можно например запретить индекс порекомендовать не использовать и вернуть Обязательно как было чтобы он только в рамках этой сессии работала не вообще в пределах базы тоже чуть-чуть помогает а потом опять не помогает Откуда же что случилось-то оказывается блокинг то есть вроде как и база небольшая и за таблицами следим но расписание у нас люди строят все это обновляется достаточно быстро обновляется порядка 60 процентов базы за неделю обновляется операторы делит естественно в массовом порядке присутствует как мы наблюдали поэтому Надо разбираться надо заниматься вакуумом автовакумом хорошее хорошо это рассмотрено и в книге и в статьях Егора Рогова и Алексей лисовского спасибо я по крайней мере туда смотрел то есть корень этих проблем в том что реализация МФЦ как известно оставляет пустые ячейки которые уже для нас пустые потому что мы знаем что они пустые Но после того что они пустые ещё не знает их нужно обойти автовакуум и пометить как пустые А еще лучше не доводить до того что у нас таблица распухает причем естественно по умолчанию настроен на очень нежный режим работы он от любого чиха поднимает лапки и говорит лучше делает база свою работу я как-нибудь потом и для многих таблиц это как-нибудь потом не наступает вообще То есть как в принципе борются с распуханием таблицу это либо правильная настройка автовакуума либо ручной вакуум либо вакуумфул либо погоре-пак но еще есть PG Compact Table вот у всех этих методов есть там свои плюсы и минусы потому что автовакуум можно настроить агрессивно тогда он будет успевать это в принципе считается оптимальным режимом работы особенно если база но нагрузка более-менее равномерно выражена Вот сам обычный вакуум Хорош тем что он может выполняться параллельно там одновременно таблицы индекс эвакуироваться он работает относительно быстро он не блокирующий Вот но он размер базы не уменьшает максимум Может там в конце чего-то отхватить вакуумфу фактически рядом строить новую таблицу блокируется всё включая чтение и можно этим заниматься только когда какое-то окно техобслуживания Потому что никакой клиент в таком фуловым одновременно работать не сможет Ну и пог он тоже рядом строит новую таблицу куда всё переписывает она блокирует только на момент переключения триггеры на исходную таблицу которая в случае на завершения процедуру Вас могут там остаться их надо будет ломаной лопатой оттуда извлекать поэтому по-хорошему для того чтобы ваша база данных поддерживалась порядке нужно иметь в общем-то в своем арсенале возможности всех этих вариантов просто применяю каждый из них по обстановке и Правильно Потому что например в нашем случае Есть момент когда нельзя настроить слишком агрессивный автомат потому что люди пришли с утра на работу получили какие-то задания вот здесь тут ремонты здесь будет план и начали строить расписание на завтра При этом они много читают много пишут сделали потом сказали нет Надо всё неправильно Давайте переделаем снова всё это начинается и до момента когда они наконец-то результат дадут систему планирования дальше их отвлекать от этой работы нельзя поэтому настроить автовакуум настолько такой чтобы он сразу всё чистил Не надо в этот момент лучше пускай будет Ну вот пока они там занимаются потом когда они расслабится всё это дадут у нас будет почти полдня когда система почти ничего не Ну по крайней дорожном уровне тогда можно и вакуумом позаниматься можно Если уж совсем дело запущено и репак произвести вот поэтому вот в случае в нашем мы такой способ выбрали так вот снова вернемся к аналоги таблицам и гистограммам такой вот замечательный случай срабатывает мониторинг у нас функция работает чрезвычайно медленно залезает гистограмму функцию устроена так сначала она получает блок информации от сервера приложения складывает вот таблицу как входной буфер дальше оттуда читаю начинаю заниматься основной деятельностью 95 процентов времени исполнения процедуры было на чтение из этой Темп таблицы в которой 0 записи в полное непонимание в начале и полное понимание в конце оказывается в нашем случае автовакуум нежно не приходил в эту таблицу никогда Ван логин там действительно было 0 записей но мертвых записей там было вон там 15 миллионов Вот эффект Казалось бы пустой таблицы такие же эффекты могут быть там когда Count звездочка спрашивает опять же от пустой таблицы а там лежит вот и он эти вот должен прочитать потому что он же не знает в рамках данной транзакции эти записи нужны или нет Поэтому вакуум в фосгосе это вещь которая вот для приходящих Из ворот кажется дикой новые но пока как бы её не примите не примените на практике это может вызвать самые неожиданный эффект так в итоге как мы настраиваем автовакуум мы настраиваем автовакуум индивидуально для каждой для наиболее часто изменяющихся близких мы сами знаем Какие таблицы у нас наиболее часто изменяются то есть не обязательно настраивать автовакуум для всей базы целиком можно для отдельных таблиц эти настройки сделать отличающиеся по умолчанию Вот и у нас все-таки система достаточно инерционная У нас стоит пока везде одиннадцатая ванильная версия мы планируем естественно её повышать но это так просто не делается в одиннадцатой версии вакуум настроен очень так сказать Не агрессивно уже начиная с 12 настройки заметно стали лучше но всё равно их надо ещё докручивать вот в нашем случае мы ставим такие настройки на основные части изменяющиеся таблицы и Это заметно улучшает ситуацию вот поэтому написано помогает надолго но навсегда они навсегда потому что мы не можем выкрутить слишком агрессивно чтобы вакуум не мешал работе вот в период пиковой нагрузки Поэтому в итоге мы пришли к такой схеме что раз месяц мы делаем погоре-пак вот в ночное время когда никто наши системы в этот момент не пользуется вот ночью можно делать обычный вакуум тоже хорошо помогает и индивидуально настроенный автовакуум и в среднем У нас вот стало в три раза лучше всё это работать но по крайней мере Наша задача не то чтобы Мы работали быстрее всех а Наша задача чтобы работали так чтобы пользователи могли свою работу выполнять не ожидая ответа от база данных и на основе нашей системы которую мы делали когда переносили мы стали строить новую систему на производительность системы мы можем повлиять на уровне проектирования на уровне выбора API средства разработки можем повлиять на уровне когда мы переносили просто как переписать хранимые процедуры здесь мы уже ограничены выразительных средствах А когда мы что-то делаем с нуля уже знаем что будем работать с возрастом мы можем конечно сделать все хорошо вот нашем случае мы проработали например над тем как хранить объекты расписание вместо трех таблиц которые в исходной базе мы сделали там 7 таблиц А в результате плотность хранения информации повысилась настолько что одно и то же расписание стало занимать там от 10 до 100 раз меньше это нам понадобилось для того чтобы на центральном уровне куда сталкиваются вот эти наши большие расписания используются в каких-то аналитических построениях чтобы можно было а базу такое всё-таки держать относительно компактные даже Для такой большой система вот а во-вторых делать по ней запросы по предварительно насчитанным каким-то данным То есть это мы уже все таки переходим нельзя сказать там у нас было в ltp У нас конечно ЛТП у нас огромные транзакции редкие но здесь уже ближе к аналитике Вот и собственно Продолжение следует наша новая аналитическая база только вошла в эксплуатацию там есть и портицирование там есть еще я думаю будет о чем рассказать дальше там на джиконствах и на хайловодах впереди Мы надеемся перейти на пост газпро потому что самодельные способы логирования это хорошо но сказать профессиональные лучше тем более что наша заказчика это система есть надо просто эту работу организовать и сделать так что я думаю что скучать Не придётся Спасибо голосуйте за доклад задавайте вопросы Спасибо ваши вопросы Вот первый вопрос У нас есть Спасибо большое за доклад подскажите вот вы упомянули что вы использовали специальные апдейта и делиты по сгрессовые и это приносило вам прирост производительности можете пояснить В чем отличие вот этих запросов пилит от раковых поддерживается и на тот момент это была десятая версия еще после у нас действительно работал быстрее при переписывание одного и того же запроса просто синтаксический используя другую форму вот с этим мы столкнулись Естественно что значит формировался другой план который был более быстрый Спасибо День добрый Спасибо за доклад У меня два вопроса Первый вопрос все-таки почему я так и не понял почему не подошла Unlock таблица если считать что юскетс такой что Unlock таблицы это временная таблица то кажется что очищаться они должны там после транкейта и автовакума не требуется вообще никакой вакуум соответственно это первый вопрос а второй очень интересно как организовали репликацию когда одновременно работали и по загресс и ораку Спасибо Спасибо отличный вопрос и этот момент упустил смотрите во-первых Почему нельзя танкист потому что у Урала Темп таблица да и всё тоже она для данной для данного запроса своя персональная А когда это будет таблица чтобы персональный надо вводить ещё ключ слоя чтобы ей пользоваться могли одновременно это процедура называется не один раз может параллельно два или три экземпляра этой процедуры каждая должна получить свой данных которые лежат в этой НЛО к таблице и разделены просто ключом слоя поэтому нельзя делать транкейт асламист слои сотрутся а что касается одновременно работы у нас поскольку ворогле был стандарт Edition то часть процедур которые связаны с передачей расписания между соседними базами был реализовано в виде процедур то есть такая репликация средствами приложения потому что скоро стандарта лицензионным соглашением не поддерживал Вот и эти процедуры Нам очень пригодились когда мы переехали на погрешность Просто у нас была процедура которая вместо линковорок илинка здесь ходила по Оракул фдв или плоскость фдв и то же самое дело с процедурой на стороне другого сервера всё это замечательно работало Спасибо следующий вопрос Спасибо большое за доклад вопрос продолжения предыдущего по аналоги таблицам А почему не сделали селекционирование тогда бы каждый пользователь имел свою секцию могут спокойно делать ранг Кейт Спасибо это красивое решение Но к тому моменту мы поняли что проще сделать обычное временное таблице они еще быстрее работают секции надо заниматься поддерживать какая-то инфраструктура вокруг этого спасибо Вот у нас рука во втором ряду спереди Анатолий Спасибо за доклад вы говорите очень много копий сломали об логе То есть вы логируете и inser ten to табличку слогами ретроспективно не проще было написать свое расширение пост поздности для логов у нас не очень большой коллектив разработчиков и как правило задача столько что писать еще приятно сделать некий пед-проект который пригодился сообществу здесь у нас во-первых уже под старый вариант планирования все было написано рефактор при переезде делали только вот по необходимости что нельзя не сделать а это всё-таки категорию чего бы хотелось относиться А так да Так но с другой стороны возможность вызов параметр процедуру что такая процедура с такими параметра вызывалась Вот тогда-то это бесценно То есть если что-то идёт не так просто ручками берёте эту свою процедуру берёте этот набор параметров вызываете её до тех пор пока не Убедитесь что всё работает хорошо вот поэтому логики это то с чего мы просто съели вот когда нам задачу поставили придумать а как же мы будем писать логику без этого дальше двигаться по каждому этот вопрос не решили мы дальше двигаться просто не могли а потом уже как все пошло хорошо то есть если бы сейчас делали сели это делать еще раз то вы бы сделали также Ну сейчас я бы наверное добился что дали После про искать использовалась промышленное решение а Не велосипедное ну а если нет тогда можете так спасибо Спасибо огромное за доплату вопрос вы показывали планы запросов которые были построены внутри вот э-э в различных функциях А как вы их получали возможно ввёл заблуждение вот эти планы были построены Когда уже пошагово я ходил по этим функциям Что тебе сказали операторы когда уже совсем такой глубокий разбор непонятно что происходит Ты идёшь Просто вот по этим этапам руками доходишь там до 19 этапа и смотришь план к сожалению из постгры я не научился строить такие красивые планы чтобы можно было их записать в табличку и потом досуге сравнить вот так было В смысле пока у меня так нет осмотрели на Ну а либо авто expline это понятно либо на пиджик вереплан вот я даже упомянул в докладе что он есть это в принципе возможно но пока еще нами не реализовано Спасибо спасибо Еще вопросы Ну что если они у вас возникнут то всегда сможете задать их спикер во-первых сейчас дискуссионной зоне а потом а нет мне показывает У нас есть вопрос в чате одну секунду Да у нас есть У нас есть вопросы слушателей было бы здорово если выпадает про сделал дистрибутив с включенным по умолчанию детей трейс флагом и понаделали побольше троиц поинтов для того чтобы можно было собирать статистику снаружи через ebpf например как раз при вызове хранимых процедур вопрос подтверждаю да было бы здорово Это было бы удобно Спасибо Ну что ж тогда как я лучший вопрос да настало время выбрать лучший вопрос и отметить это Да мне понравился очень вопрос по процитированию таблицы для того чтобы налоги сделать вот тогда мы дарим железнодорожную кружку на которой расписание нарисовано тут вот немножко не тот я взял в музее из нашего но зато общем очень нравится почему-то Вот наличие расписания прямо на кружке Спасибо поднимите руку чтобы ваш подарок вас нашел вот здесь вот по центру И также у нас есть подарок для спикера и пока он идет Давайте поблагодарим его за этот интересный доклад Спасибо большое И вам спасибо за ваше внимание продолжайте слушать интересные доклады ловите спикеров задавайте им вопросы а мы уходим на перерыв Спасибо"
}