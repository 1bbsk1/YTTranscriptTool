{
  "video_id": "y7h-XDmJo3o",
  "channel": "HighLoadChannel",
  "title": "Не типичные и критичные / Глеб Чербов (Digital Security)",
  "views": 345,
  "duration": 2125,
  "published": "2018-01-16T12:31:45-08:00",
  "text": "всем привет меня зовут глеб чергу и я занимаюсь пин тестами как нарисовано здесь никак не связана с ручками различного рода security research чем поиском их зима стей анализом информационных систем на предмет наличия их них мне льстит называет себя хакером в изначальном смысле этого слова каноничном смысле и делаю я все это в окружении себе подобных держите эти уже некоторое количество времени и да и сегодня мы поговорим немножечко про разные достаточно интересные кейсы баги не очень сложные совсем практически entry-level какие-то из них могут показаться кому-то страшными боя нами но каждый раз встречая их на проекте встречаются не раз от раза достаточно регулярно в течение в ходе наших тестов он проникновения и всегда очень приятно всем известная штука zip zip это формат архивов что с ним может быть не так может быть кто нибудь знает что может быть злодейского в zip-архиве но кроме she русов ладно мне бы первую очередь пришла в голову такая вещь как где бомба это когда мы упаковываем рекурсивная хорошо сжимающиеся кусочки данных который в итоге сжимаются нажимаю зажимается рекурсивное и мы получаем относительно небольшой zip-архив который при распаковке выбирает очень большое количество памяти и дисковое пространство то есть это как xml бомба всем знакомая только постарше и бомба тоже удобная штука для ввода систему в состояние отказа обслуживания еще windows windows его на счет едином них пор натыкаясь на такую штуку то есть не просто архиватор виндовый службой индексации windows если она находила такую архиву в директории которые как помечена как директория подвержены индекса индексацией поисковый пыталась его разархивировать и в общем все то бы очень плохо но речь пойдет мне поразить бомбы а про что мы взглянем на немножечко структуру zip-архива структуры запаковано одного файла такой штуки нет есть в начале идет заголовок всякие бесполезные поля сигнатуры по которому можно понять что это zip-архив версия флаги и флаги компрессии нас интересует здесь больше всего file name потому что мы можем в нормальных условиях он нам такой файл на им вряд ли удастся сделать но мы можем искусственно скрафтить zip-архив который будет распаковываться не study гнев в директорию в которой мы ожидаем он распакует файлы чем это хорошо для нас тем что очень большое количество приложений принимают на вход так или иначе упакованные зип пакет и файлов в zip-архивы распаковывать их и что с ними делают мы можем подумать такой архив и files пакуется совсем не туда такой фокус не пройдет с если мы просто ручками начнём распаковывать десктопном архиватором однако значительная часть библиотек которые для этого предназначены для явы для печки для тона в общем-то говоря они след слепо следуют указанию куда распаковывать файл и в данном случае мы можем добраться и следующее мы говорим про windows можем добраться до корне диска c а от него уже положить наш файлик куда угодно если приложение запускается с достаточно высокими привилегиями если это например реализованный с такой библиотекой какой-нибудь системный сервис это вообще сказка потому что можем переписать любой файл на первой системе хоть калькулятор хоть синди экзо который тоже будет вызываться хоть исполняемый файл самого приложения если вам мы знаем какому пути он лежит очень такой старый как мир трюк но почему там сих пор гречески встречаются и работает еще одна вещь которых хотелось бы поговорить это мать ее компоненты инструменты утилиты которые без которых сейчас никуда может быть кто-нибудь замечал на веб-сайтах часто вылезает вот такая вот штука типа чатик с оператором техподдержки или как-нибудь менеджером и он такой говорит а и давай я тебе помогу кто-нибудь такие штуки видел или мы живем в разных ходим в разные интернет и отлично да эти штуки очень нравится но не потому что я люблю общаться с людьми в чатах я постараюсь избегать а потому что очень интересный функциональность и она зачастую ведет к компрометации исследованного ресурсы если на него интегрирована подобного рода штука один из кейсов из нашей практики это когда у нас есть ролевой ресурс на который интегрирован этот чатик на ресурсе может быть вообще практически никакой функциональности только только вот эта вот формочка она взаимодействует через сторонний сервис который предоставляет эту замечательную штуку у этого сервиса есть отдельно сторож через которые ются файлы и есть standalone приложения который запускается у оператора или инженер саппорта как правило это штатный сотрудник организации который принадлежит исходный сайт и работает эта штука прим прим standalone приложение на компьютере в общем-то говоря как правило во внутренней сети и представляет из себя достаточно интересную цель для атакующего как работает например загрузка файлов загрузка файлов вообще всегда представляет значишь но наибольший интерес для изучения файл через просто обычный в форт формочку отсюда льется на сторож api приема файлов нас тораджи его проверяет проверяет его моим той проверяет ее расширение его имя может быть на вирусы его даже проверяет как-то проверяет его общем полностью если с ним все нормально она присылает и модификатор отдает ли у чатик дальше следующим шагом швеции сообщения которые попадает уже через непосредственное и сервиса в консоли оператора сообщение содержит в себе у реда файла чтобы забрать его со стороны то есть это такой карантинная зона в которой не впадает ни чего зловредного задумке приложение бери вот вот этот вот uri конко тренирует его с адресом старриджа и делает вот такой запрос и файл отдается отдается ну как как все файл отдаются и сохраняется под и именем который отдал сторож в заголовке file name вроде вроде неплохая схемы есть о такой ценить aiding видим тип файла файлового хранилища что может быть могло пойти не так и кого нить есть соображение иктон 9 что нарисовано этом экране если там светло хорошо может быть вообще самые безумные идеи до файл uri можно свой записать и как как это сделать правильным образом как мы можем заметить приложение слепок контакты конкатенировать domain name и прибавляет к нему uri который мы контролируем поэтому мы регистрируем свой домен с матчем к нему под домен и вот такие вот и соответственно передаем в ну кладем туда абсолютно любой файл мы можем его отдавать как хотим передаем сообщение в котором в улье добавляем нашу наши верхней доменные зоны оставляя так чтобы он дописал все то же самое он точно также честно конкретизирует и делает get запрос уже к нашему сервису с которого мы уже отдаем file name a file name мы отдаем насмотревшись на zip архивы и прочие вещи с острова встал вектором таким образом что он сохраняется не классическую дало директория эту директорию все скачали дак в ту директорию в которую мы хотим то есть если мы просто выйдем большим количеством dodge комбинации до корня откорме можем положиться в любой известное место в принципе если мы знаем имя пользователя мы можем попытаться записаться в директории автозагрузки сразу же то есть так как весь этот процесс происходит автоматически мы просто шлём сообщение оператору нам даже не нужно дожидаться чтобы он его прочитали ответил нам как-то отреагирую потому что приложение операторы она сделает сама положим файлик в эту загрузку и следующим утром мы получим b connect с машиной лава занесите очень удобная штука счастью все это было достаточно давно уже завершена но на одном из проектов мы когда это обнаружили это просто очень очень большую роль сыграла потому что вот сайт который мы который был дан в качестве скупо для проникновения вовнутрь выглядел немногим отличался от example.com функциональность и там была практически практически не был чатик ток счетчики эти очень хороши тем что их достаточно много и каждый раз там что то новое вот еще один живой сценарий при отправке сообщения оператора можно было в заголовок refer поставить xs вектор который отрабатывал правда не у оператора в чате непосредственно сейчас у этого человека есть еще такая типа административная панель для аналитики чтобы оценивать производительность операторов им там какие-то лайки звездочки ставить смотреть кто там сколько отработал и вот в этой панели в в разделе просмотр статистики как раз информация о рестлерах откуда приходили заявки и диалоги так как раз может голос триггерит xs вектор так как сосиска хранимая никаких проблем с обходом с с аудитором современных браузерах здесь не было и так мы имеем мы имеем исполнение кода в контексте сессия администратора вот этих вот чатов в принципе ничего там особо то и не сделать потому что xs комиссии уже лет 10 как никто не ворует потому что эти пион ли остается только сделать какой-нибудь злодейство непосредственно внутри самое злодейское злодейство которые мы смогли придумать это написать xs пилот который в контексте цессия администратора чат а вот это вот изменял дизайн самого чате к который добавляется уже на сайты то есть вот это вот все происходит в контексте домена вот этого сервиса чат техподдержки на нем есть функциональность изменения дизайна то есть у нас рамочка здесь будет зеленая у нас там не будут не будет аватарок но будет черная черный оранжевый допустим цвет в чатике и вот в одном из этих полей была найдена еще одна возможность enix лекции javascript а таким образом мы xc70 администратора чате к автоматически как только он заходит на страничку наш xs пилот отрабатывает и меняет дизайн самого чита дополняя его еще еще уже третьего уровня в лондон и в итоге это все наши безобразие которым таким образом добавляем оно подгружается вместе с чертиком на все страницы которые открывают пользователи на целевом ресурсе эксплуатация естественно занимает некоторое время потому что нужно накидать везде этих в рефератах наших проводов и дождаться пока кто-нибудь заинтересуется аналитикой заинтересовать аналитикой можно на самом деле несложно можно просто там жаловаться на примерно оператором там есть такая кнопка пожаловаться на оператора не понравилось естественные зона операторов много жалуется то это вызывает определенный интерес наверное мне это кажется я не знаю с работы в это или нет потому это произошло или нет да но в итоге наш злодейский java script и оказывается в ходе самого участке который добавлен на страничку к чему вся эта история про цирк баки потому что не стоит добавлять такие вещи на критичные элементы своей инфраструктуры то есть если у вас там какой-то сайт визитка или да пожалуй наверное все больше никуда не стоит запихать потому что если у вас например интернет магазин или упаси господь интернет-банкинг на котором помимо недавно на хабре была статья с разбором различных анализирующих быть систем подключаемых на в системе систему интернет-банкинга так вот эта штука не просто интернет-банкинг не просто аналитика какая то эта штука которую практически любой пользователь чата при достаточном желании сможет скомпрометировать ее скомпрометировать уже все данные в контексте домена в которой мы добавили эту штуковину используйте с осторожностью антраст от input вообще почти вся эта история предыдущие она про антраст 1 год каждый раз когда мы сталкиваемся с антрацит ему там должно возникать вот и не stick тивно и чувства напряжение ожидания чего-то нехорошего что может прилететь оттуда есть мы да мы знаем что монстров в этих лесах не бывает да да мы знаем что наши волшебные фреймворке за нас делаются нет айзенк там всех бед и пост запросов и какие злые хакер xss и прочие скилле nexia привыкнуть наверное не смогут но как то не очень все равно один из примеров как как мы видели несколько раз реализуют ограничение к административным административной функциональности то есть не то чтобы там прям сразу можно было отменить и изменять контент на сайте но админ очку физические ограждали от лишних глаз и в том числе таким вот образом напомню что в переменной ощутите хост содержится значение х 100 который был запрошен пользователем вроде как проверяется типа только только для админ должно работать в чем в чем может быть подвох тут д конечно дело в том что еще тебе хост эта переменная которая содержит значение которое прилетела со стороны клиента то есть послала его браузер потому что кто-то сбил его в адресную строку до доменное имя админ да но как бы предполагалось что она не резолвится из дикого интернета то есть вот это доменное имя на тот момент три залоговой столько во внутренней сети и считалось что ну и мне резолвится значит никто сюда не сможет обратиться к что нам мешает просто взять и заголовок идут поменять все будет работать похожая история с ограничением админке это уже более серьезно потому что чтобы можно было ходить только сокол hasta то есть мы залогинились пояс и сайте или из из ладно проверяем пользователь пришел с о колхас то значит можно ему там каких какую-то функциональность приоткрыть опять-таки у нас никогда нет уверенности что переменная ремонт видов содержит настоящий адрес то есть изначально есть две переменных ремонт и дыр и экс форварду for причем в export for кладется значение которое передается в заголовке export for значение ремонт это всегда должно хорошему бы содержать адрес пользователя или настоящий адрес прокси через который идет пользователь но это не всегда так и очень часто оказывается что мы можем заслужить заголовок export for на адрес который мы хотим и он попадет в итоге в эту переменную php и такой какой такой байпас именно так несколько лет назад один замер любопытный человек поломал с такой верху может кто читал то есть никакой магии он просто подставил заголовок из forward for устала 701 и обновим страничку и пам пам в админке стакан пол отличный способ антрацит input это не только история про в контраст и time but это вообще все данные которые попадают к вам приложения так или иначе не так давно у нас был прям живой проект было штуковина которая была приложение был backend приложение было штуковина который подключалась юсб и и отдавал ок никакие данные некую телеметрию и эти данные потом обрабатывались в приложении то есть как приложение приложение можно так назвать эта штука была чуть умнее чем просто камень который подключается в избе то есть как она могла стать какие данные считается что если устройство подключается по usb и значит там какие-нибудь сложные протоколу и там нужен через bit драйвер для него отдельной и в общем-то говоря четко смотреть очень большое количество устройств оказалось просто эмулируем в последовательный порт и приложение которое с ними работают они его просто открывают и котят как pipe или как файл работаю с ним совершенно совершенно прозрачная так как будто бы это была какая-то сущностью правой системе что там происходило устройство слова некоторые значения это значение цикле катились по мере того как они поступали оттуда из то есть by 0 далее с этими значениями происходило некая regex магия в итоге из него выделялись нужные значения и из этого же это все производилась бесконечно в while true запущенным ваш скриптом и следующем цепочки с спагетти скриптов в него передавались эти значения прям вот вот так вот казалось бы да на пихает и сюда ; да или там пинки пай пуф или амперсандах и вот команда джексон как он есть нет я когда вот этот увидел я очень обрадовался но но нет потому что пару лет назад или сколько там после того как была шумиха шоу шок это уязвимость там даже не вози местам целая пачка уязвимости было с инъекцией в переменной среды барж и лекции в баш и все это долго и мучительно и фиксили всех за фиксили и в итоге такие конструкции если они вызывают из из из баша оказались теперь достаточно безопасными то есть еще 3 года назад на этом можно было бы остановиться и напихать туда значение и получить акции на данный момент это уже не работает пришлось копать немножко дальше и и так этот наш а на зов ский то есть значение передаются в питон скрипт питон скрипт бравых как есть и вот так колхозно собирал джейсон и отсылал его через сеть другому питонов скому скрипту на назовем это backhand бэг-энде они обрабатывались и вот наши параметры которые мы вот здесь вот передаем о господи они падают передаются опять-таки воз и open то есть сюда мы тоже можем понапихать бы таких . запятой амперсандах и помимо этого и саша крипто выполнится все команды которые мы передадим так как это не окружении баш так как эта функция непосредственно рождение процесса никаких проблем с дополнением новыми командами они только параметрами для предыдущей команды здесь быть не должно ну вот небольшая проблема в этом нашу замечательную желанную ветку кода мы попадали только если значение кей из нашего джейсона было у значение n то есть там было такое развесистые дерева и граф и вот только одна ветка была вот такая вот классная с такой вкусный инъекций но значение кей мы здесь не контролируем оно равно единичке она захардкожены контролируем только вот эту вот штуку что делать что делают таких случаев да и мы делаем еще один кей крафтим вот такой вот вектор здесь мы скобочки фигурные берем его не для того чтобы поломать вот джейсон а потому что потому что если мы возьмем фигурные скобочки и передадим этого баш это будет равноценно как если бы мы были не запятые пробелы а фигурных скобочек не было сделано для того чтобы избавиться от пробела в конечном итоге потому что вот здесь вот вот это вот set а в к и hex 1 магия спилить его изначально строку по пробелам поэтому в нашем векторе который мы хотели передать в итоге пробел будет не должна была и мы добавляем еще один одно поле кей в итоге буча получаем получаем в итоге вот такой вот после постановки его уже непосредственно в то значения получаем вот такой джейсон который отправится на backend то есть мы видим что здесь есть кей который захардкожены значение яичку наш чудесный payload через точку , чтобы выполнить все наши команды которые мы хотим и наши еще одно значение кей совершенно замечательная особенность до полового партнера джейсон в питания потому что я честно не знаю как он это делает слева направо и отбрасывает последующие и и отбрасывает предыдущие или он парсонс справа налево и если встречает повторяющиеся он его игнорирует но суть в том что чем правее в джейсоне значение киева илью тема на тему него приоритет выше тем она более настоящей в итоге оказывается собственно так и происходит когда мы отгружаем наш вектор прогоняем через поры джейсона у нас остается только один наш и.н. и наша команда уже попадаем вот в эту ветку и наша команда исполняется возвращаясь к тому как все это эксплойтить в итоге была был написан был создан программно-аппаратный exploit на первое попавшееся ардуины подобные штуковине я вот код занял вместе с отступами чуть менее 10 строк как-то в итоге выглядела мы просто подключали наше устройство вместо вот так вот в интервале и она в цикле слова наш вектор вектор проходил проходил вот эту всю магию подавать сюда подал в вот этот касты лечь на страшный джейсон а целовался на backhand на бэг-энде впадал нужную на ветку и здесь происходило команда джексон особым бонусом для нас стало то что так как это было что-то такое около более всего это напоминало текущее состояние и от наверное поэтому с разделением привилегии кита полномочий созданием новых пользователей почему-то тоже никто не озаботился поэтому вот это вот все она запускалась на викенде от рута и в общем так и всех gg bb так может быть какие вопросы у кого-нибудь есть практически на коллеги глеб тебе в любом случае большая благодарность за интерактив за юмор во время презентации лично мне было интересно вопросы в таких случаях говорят либо понятно все ли вы ничего давайте сейчас стимулирующую картинку верну больше страха здравствуйте меня зовут владимир спасибо за лекцию мне интересно знать кокос происходит подбор вот этих параметров как вы это еще но когда я видно код бэкэнда естественно это все подобрать просто я такой ними вы вы не видите как это происходит вот но конкретно в этом случае код код бэкэнда нам по модели не предоставлялся там была немножко другая bawe которая позволяла его читать то есть обычный файл ride имхо disclose то есть ничего особенного когда мы кода не имеем мы имеем дело просто с параметрами то есть мы естественный как экспериментируем мутирует те параметры которые используются в системе плюс fighting параметров то есть добавление и посылка знать различным у тех же самых значений что мы тестируем на существующих параметрах в том числе несуществующими на который в принципе мы могли бы быть естественно все их перебрать нельзя но у нас есть словарик который типичные параметры которые часто не светятся на контенте 2 время могут обрабатываться на бэг-энде то есть один из найти тысячи таких параметров это значения типа дебаг установить в true или там админ true бывало и такое вот otibact ru он часто дает интересные результаты в том числе новый front на фронте бывает что javascript барсед содержимое адресной строке то есть дух и сша или даже после если это происходит то в этих в этих параметрах прежде всего нам интересны с точки зрения реализации дом xs-s то есть и в том числе если даже невозможно иногда подставишь после сша дебаг равно true и весь javascript сразу не всегда видишь то есть прямо на старте проекта а дебаг труп подставишь и видишь что опытом как панелька погрузилась для дебага и в общем это все сильно тоже упрощает работу вот а вообще по по словариком и мутации параметров в соответствии с типами атак которым мы проверяем то есть инъекции javascript коды из келли не акции dirt равенству ну то есть весь у вас глеб спасибо за такие стандартные виктора так"
}