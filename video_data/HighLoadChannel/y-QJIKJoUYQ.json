{
  "video_id": "y-QJIKJoUYQ",
  "channel": "HighLoadChannel",
  "title": "Как при помощи бумаги, карандаша и алгоритма Raft достичь консенсуса / Ярослав Дынников (Picodata)",
  "views": 741,
  "duration": 5522,
  "published": "2024-04-17T01:10:22-07:00",
  "text": "Я рад позвать нашего ведущего Ярослава дынникова Ярослав долгое время занимался разработкой Тарантула теперь он занимается разработкой не Тарантула на того что похоже на Тарантул Ярослав Добро пожаловать на сцену Привет Спасибо у нас сегодня будет небольшой Аншлаг интерактив такого на хелоде обычно не проводится буду экспериментировать ножевой публике Добро пожаловать Так значит начну с организационных моментов Мне нужно чтобы за каждым столом было ровно по 8 участников ни семь ни девять вот я здесь вижу еще одну свободное кресло можно попросить кого-нибудь пожалуйста его занять смотрите блокноты вам не понадобится У меня есть раздатка и у меня есть еще два захвастных комплекта но играть Там вне столов будет не очень удобно потому что надо передавать будет карточки так все места заполнены ну давайте поехали О чем сегодня речь пойдет интерактив предлагает вам поиграть в настольную игру по мотивам алгоритма рафт что это за такой алгоритм Я сейчас буду подробно рассказывать по времени ориентируйтесь часа на полтора примерно Ну я надеюсь полтора мы уложимся я провожу это мероприятие второй раз первое было в декабре в Москве я собрал кучу шишек постарался их учесть в тот раз мы не уложились немножечко во время там и материала было побольше в итоге мы еле-еле в два смогли закончить Так что я беру кликер э и у нас сначала будет немножко теории А потом я уже расскажу что собственно делать так пункт первый Давайте синхронизируем контекст зададим речь идет про кластера Я здесь выписал определение чтоб всем было понятно потому что в прошлый раз когда я это дело проводил вот самый показательный вопрос прозвучал под конец 2 часов игры молодой человек аккуратно поднял рук сказал Извините а можете ещё раз повторить что такое кластер вот собственно рассказываю с самого начала что такое кластер а определение из Википедии Мне понравилось для наших целей вполне подходит кластер - это группа процессов которые работают совместно И что самое главное представляется пользователю единой системы вот какой-нибудь набор микросервисов запущенные в кабернете вполне подходит под это определение но мне интереснее стоит Full всё что касается хранения данных потому что материал посвящен консистентности консенсусу значит того мы будем согласованность с вами добиваться в кластерах а попробую сформулировать задачу У нас есть несколько серверов по 8 За каждым столом каждый участник это отдельный сервер значит вы сервер и задача состоит в том чтобы консистентно по ходу значит репликации достигнуть консистентности чтобы все было согласовано все хорошо и Казалось бы на этом моменте можно бахнуть какой-нибудь двухфазной комедии все хорошо но у нас сеть не надежная сеть может рваться сервера пропадают Ну все как обычно собственно И для этого есть много достаточно решений я не буду сегодня проводить обзор Это не по моей части он там про базы данных были обзоры Возможно мы смотрели я рассказываю про одно конкретное решение называется оно алгоритм так я не сильно он загораживаю Да вроде нет это алгоритм который родился по мотивам паксоса но ребята ставили перед собой целью сделать его максимально простым понятным по подумать сегодня по залипать над листочками тоже конечно придется Но это все равно значительно лучше Итак начинаем знакомиться с рафтом значит что нам предлагают вот этот алгоритм он говорит хотите консистентности стройте реплицируемый конечный автомат или стоит машина вот стоит машина конечная автомат синонимы такая картинка проведена там статье Давайте попробую вкратце описать что здесь нарисовано вот правый в правом верхнем углу зелёный квадратик стоит машина это как раз то что нам надо будет сделать консистентным стоит машине у нас написано Ну например x = 3 Y = 9 Z = 0 и это состояние должно быть одинаково на каждом сервере Независимо друг от друга сервера вон видите целая стопочка тоже изображена значит стоит машина большая если упоминать вот в аннотации приводил два наиболее популярных такие на слуху продукты которые этот алгоритм используют это etcd это Консул значит там хранится огромное количество данных и просто так взять и переслать их по сети вы не можете это неэффективно поэтому стандартная совершенно очевидная вещь Это завести журнал в который мы записываем уже операции ну здесь приведено что X сначала присваиваем трем потом y1 потом y9 вот у нас В итоге оказалась y9 стоит машине по мере того как мы этот журнал накатываем А у нас ну состояние стоит машины продвигается вперёд эволюционирует консенсус модуль которая здесь нарисованы это как раз алгоритм рафт который говорит Вам что делать Ну а клиенты это собственно пользователи которые приходят и вот эти данные вам приносят говорят Сохранить то сохранить всё это а и как это отражается у нас на практике у вас на столе лежат файлики Сейчас самое время достать из них бумагу доставайте разглядывайте каждому участнику по одному листочку с рафт стейтом это ваш жесткий диск значит у каждого сервера у каждого участника по одному жесткому диску на которой вы будете перечистить все что вам там из сети понаприлетала получается получается и сразу давайте начнем наш интерактив Мне нужно по одной поднятой руке от каждого стола Давайте раз два три по одной руке со стола поэтому там внутри стала Решите пожалуйста сами кто будет Ладно Значит раз два три 4 5 6 7 8 Да вроде Все сходится Окей вы у нас ребята будете инстансом с номер один это ваш идентификатор сервера поэтому берите ручки и пишите себе в уголке и один и это делают вот те кто поднимал руку дальше по часовой стрелке пожалуйста от двух до восьми и два и три четыре вы Надеюсь сможете посчитать там не запутаться тоже проставьте сразу себе идентификаторы в рафте сервера Ну вот таким бесхитростным совершенно способом различаются и нам этого будет достаточно смотрим на материал дальше значит здесь есть два такие раздела фирмы и раб журнал про термо я расскажу позже Давайте про рад журнал поговорим раб журнал это вот тот самый журнал который был на прошлой картинки это место куда вы будете дописывать новые операции сам по себе алгоритм рафт не говорит что именно там должно лежать он оставляет это на откуп конкретный имплементации соответственно пишет что-то свое Спасибо Консул что-то свое В каком угодно формате это как бы личное дело каждого разработчика каждого продукта а записи у каждой записи У нас есть индекс тоже будут Циферки 1234 Протерм пока не говорим будет Позже value value value это по-хорошему вот та самая операция и в реальных продуктах здесь можно было бы увидеть что-то типа insert что-то куда-то куча значит данных чтобы это все отслеживать А нам с вами будет достаточно просто буквок мы будем с вами писать по одной буковке в клеточку и таким образом у нас в журнале будет накапливаться какое-то сообщение мы будем дописывать по одной букве тоже будет чуть позже но сразу пару слов скажу алгоритм требует что чтобы признак того что Вот запись из журнала применена к той стоит машине у нас с вами нет стоит машина но вы в голове держите что вот стоит машина это и есть вот все что я плавит это ваша стоит машина вот это вот кусок данных который точно никуда не денется гарантирует Доказано алгоритмически едем дальше а состояние рад говорит нам следующее что каждый сервер в любой момент времени находится в одном из трех состояний начиная там в статусе фолловер просто ничего не делает вот внизу подсказки есть это пассивный instance который запросов не отправляет просто делает то что ему говорит Лидер лидером instance становится еще маленькая Ремарка instance и Сервер это синонимы я буду их использовать одинаково мне почему-то больше инстанции на самом деле не суть Как важно Вот значит чтобы стать чтобы стать лидером instance начинает выбором это всё детально сейчас проговорим и задача лидера это единственный instance который может новые записи врат журнал добавлять команды другим инстам отправлять Но это короче вот единственный главный кандидат - это промежуточное состояние которое нужно нам в начале чтобы выбрать одного лидера соответственно фолловеры делают это по таймауту и фолловер он вот сидит пассивный такой слушает если он видит что долго никто ему запросы не присылает он думает а Наверное старый Лидер куда-то делся стану ка я кандидатом ребята голосуйте за меня и вот так вот это все по кругу заводится и работает но смотрите какой Парадокс значит лидером мы выбрали Лидер живой потом один перестал работать появляется новый Лидер там новый instance начинает выборы выигрывает у нас уже немножечко терминология начинает разъезжаться у нас появляется старый Лидер новый Лидер вот чтобы эту штуку правильно захендлить рафт вводят понятие термов Рав деле все время на отрезке неопределенной длины каждый отрезок времени начинается с выборов и когда кто-то выигрывает начинается нормальная работа Ну и заканчивается Когда что-то со старым лидером произошло там чуть позже лидера Кстати может и не быть вот здесь нарисован Т3 Когда выборы начались за кандидат никто не проголосовал Ну и термо кончился без лидера поэтому все что будет дальше собственно Вы же можете догадаться что правила тут простое у каждого лидера есть свой Терм Ну в смысле он знает В каком Терме он Лидер поэтому а сообщение из старых термов они просто игнорируются там никакой хитрости нету Так что Так что едем дальше Пора играть вижу скучающие Глаза начинаем первую игру выборы лидера а сначала хочу задать если какие-нибудь промежуточные вопросы или по ходу дела появятся Вы если что не стесняйтесь прямо по ходу поднимает руки задавать да вам ребята поднесут микрофон Слушаю А можно листочек тоже а кому вы его будете передавать сам просто для себя чтобы Да можно давайте я в зал отдам вот у меня еще два запасных комплекта есть у кого ребят Если вы на задних парках сама организуетесь как-то в кучке то чисто теоретически у вас должно получиться это все то же самое писать в блокнотике Хотя это будет и не так удобно потрошите Короче так давайте микрофон к столам пожалуйста У меня вопрос во время выбора лидера получается Никакой работы полезной не совершается вопрос по картинке у нас там клиенты были нарисованы и они будут с нами взаимодействовать как-то я предполагал что клиентов у нас не будет и лидер сам будет придумывать что ему на генерировать Какие записи но нет Давайте не будем привлекать публику это просто ненужную суету принесет у нас и так будет в чем запутаться возможно такая ситуация что выборы прошли выбрали лидеры Лидер упал заново начались выборы и так бесконечно да Да кто-нибудь из лидеров серверов может уйти вдруг отсюда у нас все сломается как мы будем Сплит Брайан решать Вы по фриловилите и нормально продолжите работать уже с одним инстансом оффлайн но у меня заготовлен скрипт я буду говорить кто у нас оффлайн Там просто я старался подобрать вот этот материал так чтобы все Корнер кейсы рассмотреть когда Лидер пропал и так далее Я надеюсь вам не настолько будет скучно чтобы люди уходили так еще какой-нибудь вопрос давайте уже поехали с выборов и один Прошу вас начать выборы значит смотрите Нет не прошу еще один организационный момент у меня слайды заготовлены вот с такими песочными часиками сверху их будет достаточно много Это значит что я вам вначале немножечко расскажу что делать Мы проговорим слайд потом я замолчу и там спокойно погрузиться в работу не отвлекая вас так что давайте проговаривать Из чего состоят выборы книги вот этот вот фолловер один из серверов который долго ни от кого ничего не слышал он чтобы начать выборы в первую очередь переходит в статус кандидат статус у нас как бы на листочках не отражен просто держите в голове что вот и один вы сейчас переходите в статус кандидата и первое что вы делаете Это голосуйте за себя Ну логично так что пишите Вот голос за себя вот Терм T1 начинаем новый Терм голосуем За себя и перейти в руки желтую карточку это карточки у нас будут для сетевых сообщений мы сейчас по кругу будем передавать значит пару слов просить как алгоритм вот в статье он описан вообще без привязки к какому-то конкретному протоколу сетевому это может быть tcp/udp что-то свое поверх http совершенно не важно то есть это тоже зависит от имплементации у нас достаточно интересная топология и вот если говорить про tcp/udp то скорее всего лидеру пришлось бы заполнить 8 7 карточек для каждого участника каждому ее отправить получить ОК но так как писанины достаточно много я выбрал немножко другой вариант у нас будет одна карточка на всех Ну представьте этот ринг сеть и там каждый будет говорить о книг голосует за голосуют против либо вообще он оффлайн не голосует до него это Сообщение не дошло а как то так что здесь Должен написать кандидат кандидат должен призвать всех остальных участников проголосовать за него Терм понятно откуда берется У нас сейчас термо Т1 кандидат ID и один и один говорит ребята голосуйте за меня про Last logindex Last Lock therm мы поговорим позже пока что ну я упомяну что это индекс и Терм последней записи в раб в журнале они нам еще понадобятся А пока у нас журнал пустой у нас последний индекс 0 последний Терм т0 такой фейковый считает что его нет так что здесь я на минуточку замолкаю лидеры Записывайте Можно вопрос Как определяется кандидат То есть почему именно и один решает что он кандидата если едва также решит что он кандидат и как вот это разрешается правила в рафте простое когда значит там есть тайм-аут как только вы достаточно долгое время не получаете ни от кого сообщение переходите в статус кандидат значит может действительно случится что два инстанция одновременно начнут выборы они могут закончиться неудачно это называется сплетут Мы про это обязательно поговорим про проиграем это на бумажках Но это будет чуть позже Так кто готов Давайте руки раз два три 4 5 6 7 8 отлично едем дальше Ну и передавайте значит и один передает едва И здесь тоже берем паузу я рассказываю как это сообщение обрабатывать вот едва сейчас Получил сообщение по сети от какого-то инстанса Ой я забыл еще важную ремарку сказать про списывание значит смотрите я попрошу вас подглядывать конечно хорошо но на свои листочки записывайте только когда у вас вот эта карточка сетевая она в руках потому что вам Списать можно два сервера которые стоят в стойке они друг другу в оперативку залезть не могут поэтому поэтому вот а от едва требуется одно он должен либо проголосовать за этого кандидата Ну либо не проголосовать правила простое в одном Терме голосовать можно только один раз так что если вы еще не голосовали А по скрипту по сценарию игры Вы еще не записывайте что вы голосуете за и один вот так и написано термо Т1 значит и два проголосовал за и один и сначала Сначала заперситили голос а потом поставили галочку зачем это нужно чтобы всё было консистентненько чтобы не случилось так что вы сначала галочку поставили Все эти сообщения отправили за перечистить забыли рестартанули проголосовали за кого-то ещё раз это чревато проблемами Подскажите По каким критериям обычно голосование происходит если не голосовал то я имею ввиду как сервер выбирает за либо против проголосовать если еще не голосовал то голосуешь за у нас будет потом еще одно усложненное правило но пока что вот просто можешь проголосовать голосуй не надо нам портить квору то есть ну не проголосовать конечно можно но просто кандидат не выиграет выборы и как бы кластер от этого не выигрывает стоит себе недоступный вредон ли Так что не жмитесь на голоса и вопрос можно быстренько Давайте пишем свой голос за кого отдали вот здесь вот вот здесь пишем за кого вы голосуете да вы получили сообщение по сети от кандидата и один вы еще ни за кого не голосовали вы говорите Ок я готов голосуйте за него отправляете ему эту галочку и передавайте карточку дальше значит здесь я опять Беру минутную двухминутную паузу Пройдите пожалуйста полный Круг чтобы у нас до 8 Все успели этот значит сетевое сообщение обработать карточка вернулась и один если есть пока какие-то другие вопросы Я готов ответить Слушай вас дабы Большое спасибо за интерактив очень интересно у меня единственное такое дополнение наверное надо сказать что это не Византийская штука И тут не надо пытаться хакнуть свой кластер Вот Вы абсолютно правы Да стоило упомянуть я забыл Простите значит рафт это алгоритм построенный на доверии Так что от византийских А так он не защищен это всё надо делать на других уровнях протоколов Ну не знаю там tcp свой в СССР заверните мне кажется если византийска это тогда типа блокчейны всякие майнинги типа Давайте посчитаем Там интеграл Вот это Так кто готов к кому И один вернется карточка поднимайте руку я тогда буду продолжать значит Раз два три четыре пять шесть со счетом но там еще один стол не готов сейчас мы подождем всё вроде все давайте сверяться карточка вернулась К1 давайте сверимся что она действительно выглядит так что все собрали голоса все проголосовали за кандидата и один и теперь когда карточка вернулась К1 Он точно знает что он в этом термин Лидер можете нарисовать себе корону вы большие Молодцы Сейчас будем реплицироваться значит упражнение следующее Теперь когда Лидер есть мы можем кластер в лице лидера может принимать запросы на запись если запросы приходят нет лидеру то значит класть от форвардит их лидеру Поэтому Просто давайте у нас лидеры придумывают какую-нибудь сообщение Вот я здесь написал хайло для демонстрации соответственно берите пишите себе 8 новых записей в журнал вы добавляете от одного до восьми всех термиты один значит вот враг журнал пишется тем Ну это как бы признак В каком термине эта запись была добавлена зачем это нужно чтобы потом правильно потратить увидите пока не буду рассказывать вопрос микрофон пожалуйста обязательно 8 записи Нет не обязательно Ну слишком мало не берите слишком много тоже не берите Вот примерно такое если ничего не приходит в голову пишите highload Если хотите немножечко творчества Напишите хайлот плюс если он 8 мало Так кто готов руки раз так так так так тот стол вот этот готов так готовы Георгий всё отлично едем дальше это Лидер пока что проделал упражнения локально пока что остальные члены кластеры понятий ничего не имеют Что за запросы от клиентов на приходили поэтому следующее что лидер Должен сделать это взять синенькую карточку она у нас называется opentress и этим сетевым сообщением Лидер говорит окружающим что ребята нам тут понаписали значит сохраните себе тоже вот это вот репликация в чистом виде значит почему вот смотрите у меня здесь написано влезло только 4 буковки Почему так потому что сетевые сообщения не резиновые как бы сколько влезет столько влезет у нас влазит по 4 понятно что в конкретной имплементации у каждого будут свои какие-то лимиты вот Терм и лидера и у нас остаются Я надеюсь это достаточно очевидно Да все еще первый термин все еще Лидер и один Лидер коммит тоже поговорим про него позже пока что у нас за комиченных подтвержденных записей нету это вот Мы только начали Так что с этой частью Ясно сразу проставляете и один Лидер сразу проставляет что он за персистил Ну понятно он как бы заперчистил еще до того как это отправлять и Нужно ли время давать или Мы готовы двигаться дальше руки Кто готов раз два три Хорошо хорошо вижу еще ребята дописывают Вы только учтите Если вы написали что-то свое то вы реплицируете свое они все никогда не влезет как бы что поделать сеть ограничения следующим пакетом будем остальные Половину досылать Да все правильно догадываетесь и отправляем в сеть что здесь нужно сделать каждому инстансу значит здесь уже нарисован и два и два получил это сообщение Ну все достаточно просто сервера как я уже говорил все фолловеры А вы у нас фолловеры они пассивные поэтому сказали реплицироваться реплицируйтесь ну смысле сохраняйте себе на жесткий диск сначала пишем на жесткий диск Потом ставим галочку что мы сохранили Да я сохранил она у меня на жестком диске все больше никуда не денется делать в этом в этот момент Think или писать в кэш это дело десятое Ну вот Какие Вам гарантии это тоже имплементейшен специфик на самом деле зависит от имплементации Какую выбрать у нас просто записываем на листок да Значит теперь я замолкаю передавайте листочки дальше и поднимаете руки когда листочек вернется к опять лидеру нет второй пока не надо делать не спешите Хотя Да не надо делать Сейчас еще одну вещь надо сначала Кто готов поднимать руки это уже медленнее идет Я смотрю Хорошо жду ждем дальше спешить нам некуда Все успеем а можно вопрос задать Да конечно вы не вдохновлялись Дэвидом бизли кем я не знаю кто это так что нет понятно он просто тоже делает Workshop Я знаю пора авто из питона несколько написал я вдохновлялся но это не новая тема Вы абсолютно правы есть несколько есть много способов построить этот интерактивчик Так что вот что получилось то получилось готовы Да отлично кто еще готов может еще какие-нибудь вопросы в процессе готовы Давай бери Микрофон пока оставляем пустым я про него сейчас расскажу как раз у нас на следующем слайде так Давайте еще раз 8 рук я убежусь А нет вон ребята вроде пишут Как сложно так все вижу вижу Да все хорошо и опять сверяемся опять сверяемся если Все идет по плану то к лидеру должно вернуться карточка опять со всеми голосами за значит с подтверждением что все остальные члены кластера эту запись за 50 лет точнее эти четыре записи и что с ними делать Вот смотрите лидер Он когда сообщение в сеть отправлял Он понятия не имеет такого там сообщение дошло не дошло то есть запись не была еще подтверждена И вот только теперь когда мы получили от окружающих подтверждение мы знаем что вот эти вот четыре записи все они на всем кластере есть точно Никуда не денутся поэтому что сейчас должен сделать лидер Он должен поставить 4 галочки до 4 до 4 индекса Я получил подтверждение здесь есть тонкий такой момент значит оплай или КАМиТ сейчас про него подробнее поговорим я здесь написал apply в том плане что это означает что записи запись подтверждена и ее теперь можно применять Вот то есть стоит машине То есть если мы просто стоит машина будем думать дата пока Лидер подтверждение Не собрал он не уверен что сообщение вообще хоть до кого-то дойдет поэтому применять его кстати машине было преждевременно но теперь когда это подтверждение есть можно прощёлкать галочки у нас применение записи вот этот тепла и сводится Ну просто к проставлению галочки но в реальной системе это могло быть что Ну вот если возвращаться к той картинке там где X3 y3 у нас Вот был брат журнал отдельно стоит машина отдельно И вот в этот самый момент вы переносите из Раф журналов стоит машины у вас все у вас стоит машина имеет индекс 4 значит к ней применено 4 записи из рафт журнала и вот Глядя на этот индекс стоит машины вы однозначно можете определить индексы ладно два Циферки нужно Вы можете однозначно идентифицировать в каком состоянии у вас сейчас база данных находится значит давайте взглянем теперь на всю эту историю Тоже маленькая лирическое отступление со стороны у нас получается вот стоит машина это где-то в оперативной памяти лидера хранится или как-то отдельно для нас стоит машина это вот две нижние строчки вылью и галочки плавают вот те которые с галочками это значит стоит машине как бы есть в обычной а получается или у каждого своя то есть У каждого есть своя копия стоит машины там помните было много слоев и вот каждый сервер он из одних и тех же компонент состоит что есть машина есть своя своя копия стоит машины своя копия журнала понятно что каждый обновляет это в свой момент времени Поэтому вот сейчас про это на следующем слайде будет Давайте взглянем можно еще вопрос Да вот у нас тут небольшой динамический кластер образовался и когда приходит новая нода А на синкой сот лидера да Я боюсь я не смогу на него так быстро в двух словах ответить посикайтесь от лидера посмотрим что будет окей и вопрос хорошо сразу ладно В двух словах попробую таки ответить значит вот этот интерактив вот это вот вся игра Почему я просил по 8 участников За каждым столом потому что на прошлом мастер-классе который я проводил мы еще рассматривали понятие конфигурации это когда у вас топология меняется Когда у вас как раз добавляется Сервер это сложно вот в таком формате это правда сложно поэтому считайте что этот значит новый участник там задним числом Вот давай считайте что он всегда с вами был вот как-нибудь на костылях Короче я сейчас проблему предлагаю решить так дайте-ка я расскажу про записи значит здесь мысль следующая взглянем На вот вы сейчас смотрите как бы с точки зрения сервера на все происходящее Теперь давайте посмотрим на каждую запись вот одна буковка H первая буква значит какую Через что с ней в это время происходило Вот был такой момент когда я вам сказал записать слово хайлот вы его в голове держите А на жестко Ну грубо говоря в оперативной памяти оно есть А на жёстком диске его ещё нету вот это вот как раз от stable записи Это самый свежие Вот они сюда добавляются и про них пока никто ничего не знает то есть они даже не заперсиченные даже на лидере а потом Проходит какое-то время и значит там не знаю скол записи на диск возвращает Что ок запись сохранена запись становится персистами и у нас вот этот фронт волны как бы бежит То есть у вас самые свежие записи есть хвостик который еще только в оперативке есть серединка которая есть у вас локально но еще нету от у окружающих значит следующее как бы это взросление записи в раб в журнале camid дословно запись подтверждена то есть остальные участники э-э сохранили её себе подтвердили и когда об этом узнаёт Лидер четвёртый пункт э Лидер уже Может её применить к себе а вот такие четыре состояния записи мы с вами будем рассматривать и Обратите внимание лидер лидер и один галочки проставил а остальные что они ни сном ни духом им об этом должен сказать Лидер поэтому мы сейчас берем следующую карточку тоже голубую и одновременно будем 5 6 7 8 отправлять в сеть и одновременно Лидер вот в этом как раз пятом поле Лидер Комет 4 расскажет окружающим что ребята Я собрался вас подтверждение значит 4 записи до 4 можете тоже к себе плавить поэтому Галочка с респонсом сразу ее уже не проговариваю замолкаю Давайте листочек по кругу и А нет не на час надо будет сделать следующее лидеры заполняйте Давайте едва и я вам расскажу Собственно как и два и три будут эти записи обрабатывать должно быть быстро готова нет готово готовы так и два и три рассказываю и два держите в руках карточку которую вам только что Лидер прислал Значит вам Ну я на самом деле уже проговорил Да вы новый кусок данных сохраняете а вот четверочку Лидер подтвержденной записи проставляете платите к своей стоит машине помечаете что они все они готовы это должны сделать и два и три а и 4 пожалуйста потеряйте сообщение значит развлекаться так по полной догадывайтесь К чему все идет Поэтому можно порвать не обрабатывайте просто там не знаю Уберите Спрячься в карман и все значит и два и три зачистили а да и 4 Будем считать что это запись не дошла вопросы или готовность А у меня у нас недопонимание только и 4 потерял аж 5 6 7 8 нормально нет и 4 порвал и больше никому не дал если что-то пойдет не по плану от этого только веселее будет так не переживайте сильно вопрос готовность Так кто еще готов слушайте Давайте наоборот кто еще не готов отлично Все готово следующий этап значит что сейчас произошло у нас и 4 упал Ну понятно там потерял сообщение не дошел not у нас сеть такую странную топологию имеет что и 5,6 тоже не дошли там в обычной системе Ну как бы гарантии доставки Короче может случиться Так может все значит и 4 пропал ушел оффлайн пожалуйста переверните ваши листки и один и один какое-то время еще поработал но тоже при устал и тоже там Спустя еще пять минут тоже уходить оффлайн Давайте смотреть что при этом произойдет я уже сказал что каждый фолловер он трекает время значит Лидер помимо того что вот он репликационные сообщения там какие-то отправляет периодически если данных в сети нет то чтобы фолловеры не тайм-аутили там просто Хард биты идут Я надеюсь это достаточно ну простая концепция понятное дело Я не стал рисовать карточки на хард биты у нас игра не на скорость нам бы хоть как-то разобраться вот значит что происходит и 4 упал и один тоже постоял поработал устал ушел офлайн и в какой-то момент кто-то кто-то первым замечает что все лидера не стало тайм-аут Пора начинать новые выборы Пусть это будет сейчас пожалуйста и восемь Нам так будет удобнее следующие всякие особенности воспроизводить Вы опять берете желтую карточку это реквествует значит просите окружающих ребята голосуйте за меня смотрите Как заполняется здесь уже Терм T2 Терм T1 закончился и 8 начинает новый термин следующий по номеру записывает термо Т2 кандидат ID и 8 и вот здесь нам пригождается два еще дополнительных поля ласло индекс сюда надо вписать он у меня введено индекс и Терм последней записи зачем они нужны вы увидите на следующем слайде а пока что напишите пожалуйста просто просто хоть какие-то последние сохраненные влоги не обязательно закамиченные Да давайте сверимся у всех ли его семь по моим прикидкам да и 8 не дошло сообщение предыдущее поэтому нас и 8 Вот как он одно сообщение получил так он с тех пор вот в таком состоянии и сидит То есть у него applife нет у него 8 записи Нет у него 4 до него дошло Время еще нужно или можно продолжать так кого надо ждать никого не надо ждать поехали и 8 и 1 у нас оффлайн поэтому и 8 сразу передает карточку и второму и второму и Давайте проговаривать что на этом слайде вот здесь появляется еще одно правило значит и 8 попросил окружающих голосуйте за меня записей много у него как бы информации больше Поэтому у нас здесь есть еще одно важное правило появляется вот оно в уголке в рамочке написано что с это едва может голосовать за потенциального лидера если у него либо раб журнал длиннее либо тем больше то есть голосовать за того у кого записи не хватает кто давно отстал не надо Да вот пришел какой-то кандидат говорит У меня 10 Терм Значит у меня в журнале нифига нету голосуйте за меня Вы ему говорите не у тебя ничего нету мы затягивать голосовать не будем поэтому и два У нас сейчас голосуют отказом в состоянии можно Поставить прочерк потому что голос против он как бы тоже считается за голос то есть если друг потом в этом же Терме придёт кто-то другой мы ему тоже отказом ответим потому что мы уже проголосовали не за кого Ну тут собственно неважно можно за себя проголосовать Короче просто поймите что вот вот голос Вы отдали свой единственный но ни за кого так Какие вопросы Давайте подождем пока и два и три обработают эти записи а вообще да и остальные тоже значит давайте берем паузу до тех пор пока полный Круг не пройдем и карточка вернется опять к нашему потенциальному кандидату и потом будем дальше разговаривать а у нас и 4 то выбыл он ничего и 4 у нас перевернутым листочком он не участвует в голосовании вот смотрите и 1 и 4 вообще ничего не достается вы Посетите пока отдохните понаблюдайте и 5,6,7 они же не знают у них всё совпадается это с 8 до это нормально значит если у кандидата журнал не короче чем вот у голосующего то можно голосовать за Поэтому вот смотрите так всем ли видно всем ли видно что на экране или вот это загораживает да так а можно кого-нибудь попросить кафедру мне чуть-чуть сдвинуть а нет нельзя тут много скотча Ладно все хорошо нет и что с этим делать проговорить значит и 2 и 3 голосуют отказом 5-678 ставят галочки голосуют за карточка с реквествуем там возвращается к нашему кандидату и 8 и 8 смотрят на все это с унынием потому что чтобы выбрать выиграть выборы проголосовать должна не меньше половины у нас с вами по 8 участников кластеры поэтому вам надо собрать чтобы стать лидером надо собрать как минимум 5 голосов за и 8 только 4 что поделать увы вот вам терн без лидера вопрос Да здравствуйте А вот такой вопрос почему из 8 вообще Откуда мы знаем Сколько всего участников кластере в какой-то конкретный момент сейчас у нас кластер стал на двух меньше То есть у нас 6 и 8 собрал 4 из 6 Значит у нас есть конфигурация и кластер у вас все-таки состоит из восьми и то что парочка сейчас оффлайн не значит что кластер стал меньше мы как раз таки должны Как бы не допустить потери консистентности из-за того что у вас сеть разделилась Почему именно 8 потому что я так придумал банально ответ то есть я в конце еще в конце презентации пару слов скажу про вот конфигурации так еще вопросы Вопросов много а получается Если 4 выйдет из строя тогда голосование никогда не кончится Да если вы потеряли больше больше да Если вы потеряли половину кластер или больше то кластерная запись недоступен это давайте я проговорю откуда такое значит правило берется но у вас есть кластер из восьми участников вот Представьте себе что у вас сеть разделила Москва Питер 4 там 4 тут пополам как и между собой договариваться Да никак надо уходить в ридомле и пока квору монету никаких записей никаких лидеров никаких выборов то есть Лидер Стар это лидер Он может продолжать что-то там себе на бумажке записывать об этом никто не узнает просто и подтверждение не придут А если бы и три не дошло бы сообщение с данными тогда бы он бы у себя бы их не тогда бы корм бы сейчас собрался получается Лидер был бы с недостающим количеством сообщением нежели сейчас еще раз и три и три потерял сообщение ну то есть до и три даже не дошло сообщение соответственно Не файл эти данные Да мы на это посмотрим У нас сейчас вот сейчас как раз смотрите мы к чему подходим мы подходим перезаписи журнала У нас четыре записи вот конец сообщения вот который там 5 6 7 8 они дошли до нескольких а всего до сколько до трех участников получается да двух Ну Лидер и еще двое соответственно трое всего за персистили Так что квору не набрался И вот сейчас я что предлагаю сейчас я отвечу на Ваши вопросы и один У нас пока что еще ненадолго останется оффлайн А и 4 давайте у нас сейчас вернется вернет перевернет листочек обратно Вот и такой проснулся меня давно не было сразу значит начнёт новые выборы и Можете уже начинать следующий реквествуют начинать следующий тем а и вот здесь подсвечу Немножко значит Смотрите по правилам рафта и 4 сейчас должен начать термо Т2 последнее что он видел это было Т1 Да вот когда он уходил соответственно но у нас иначе игра немножечко затянется потому что что дальше ожидает и 4 он начинает новый термин Т2 он отправляет это карточку там все уже проголосовали отказами но там эти четыре за два против было соответственно и 4 выборы тоже не выиграет на останется висеть новый тайм-аут поэтому мы вот эту скучную часть пропускаем и я вас прошу Просто в обход всех правил сразу начинайте термин и три поэтому и четыре У нас сейчас кандидат голосует за себя заполняет реквест уотерписи сразу ставить себе ок Давайте вопросы пока что Правильно ли я понял что каждый instance при конфигурации кластера знает сколько там компонентов у него и всегда считает что это количество неизменно до тех пор пока переконфигурация из мнения придет Да примерно так то есть самый базовый самый простой сценарий это фиксированная топология это не обязательно так и там есть механизмы я уже говорил я в конце про них поговорю которые позволяют менять конфигурацию кластера на лету добавлять узлы выводить узлы Но мы с вами играем с фиксированной топологией из восьми участников это Терм последний записи в журнале который есть у и 4 есть 4 записи в раб журнале ни одна из них еще не подтвержденная смотрите Сколько времени прошло и 4 до сих пор не знает что четыре записи заканчино было поэтому он честно пишет что у меня в журнале последние запись номер losing 4 в Терме Т1 Да проходите Круг голосования я ожидаю что сейчас уже значит и два и три по-прежнему голосуют отказом потому что у них журнал длиннее Но у нас есть и 4 5 6 7 8 целых пять инстансов у которых такое же состояние поэтому они спокойно отдают свой голос за и вот теперь-то когда и 4 вернулся у нас хватает голосов для того чтобы и 4 выиграл выборы и стал новым лидером в Терме Т3 помашите мне ручкой когда карточка вернется к и четвертому так хорошо есть я опять со счета сбился да что ж такое кто не готов не готова еще да Ребят а там еще бонусный кластер образовался Да слушаю вас А вот в нашем маленьком кластере получается мы сейчас откатим состояние потому что у нас не только в вашем не переживайте У нас сейчас все будут откатывать состояние смотрите у нас сейчас лидером стал и 4 у которого в журнале всего четыре записи Так ну теперь-то уже все наверное готовы да есть кто-нибудь кого надо подождать Вроде нет поехали и 4 новый избранный Лидер заполняйте журнал по-своему я вот ничего умнее чем хайвол точнее придумал можете изобрести что-нибудь свое и я потихонечку На слайдах начинаю ускоряться сразу можете начинать заполнять вот эту карточку голубой си и вы уже 5 6 7 8 записи отправляете совершенно другие и опять подсвечиваю эту шутку смотрите до сих пор ни одной записи у и 4 то есть кто-то ее уже применил и 4 до сих пор об этом не в курсе не переживайте Со временем это все разрулиться на что еще здесь обратить внимание Вы когда журнал заполняете вы уже пишете вот враг журнале вы новые записи добавляете и 4 Лидер в Терме Т3 вы пишите что вы эти записи добавили в Терме Т3 вопросы а у меня вопрос получается типа на текущий момент никто ну точнее и два и три не знает что и 4 стал лидером я не узнаю только когда придет Вот это сообщение да спасибо это достаточно часто так то есть узнают всё сильно запозданием Такова жизнь Такова сеть ничего синхронного у нас в распределённых системах нет и быть не может Поэтому Всегда приходится говорить вот в чем собственно суть всего этого действа чтобы прочувствовать вот эти вот парадоксы когда запись сохранена там на больше половины кластера но про это еще никто не знает Да слушаю вас а и 4 заполняет данные размером один пакет или в два или это не обязательно смотрите в карточке вы заполняете вот сколько влезет у меня на слайде влезло 4 врач журнал Вы можете писать больше но Вам их потом реплицировать сильно короче Главное чтобы у всех было то что сейчас и 4 напишет у себя да да да Окей спасибо 5 6 7 8 в applite ничего не должно стоять пока что у 5 6 7 8 да у них у них по-прежнему 4 записи до них еще ничего не дошло Ну давайте я уже следующий слайд включу и мы начнем проговаривать обработку этого заброса А можно вернуть пожалуйста мне ещё вопрос Да там у нас Лидер КАМиТ 0 То есть почему и четыре сразу не заплавил первые четыре которые всего кластера точно уже есть а ему до сих пор никто не сообщил что они подтверждены понял и четвертому вот он как сидел в изоляции вернулся такой выборы выиграл А до него до сих пор никаких сведений не доходило здесь вот тоже Парадокс такой маленький который можно подсветить что запись уже на кворами сохранена то есть она уже никуда не денется но и 4 про это ничего не знает поэтому поэтому честно рассказывает всем что я пока не знаю у меня 0 да Слушай вас А почему в таком случае в запросе мы не спрашиваем опять же про 1234 мы опустили Это для упрощения вот всех карточек самой настольной игры естественно в живых протоколах там сетевые сообщения они во-первых каждому адресованы индивидуально во-вторых там идет дополнительно какой у меня сейчас Кто сейчас Лидер э-э это все там больше пространства Да там это можно сообщать Я имею ввиду Вот это синяя не должна была бы про первые четыре записи раз и 4 не знает что они заплачены хорошие замечания Кстати вообще такое может происходить то есть а вот знаете что спросите меня А что будет Например если вот этот вот и 4 там реплицы просто в какой-то абстрактный момент времени кому-то отправляет 5 6 7 8 а ему instance такое У меня даже четвертый еще нету да там делаются ретраи это все протоколах обычных лица поэтому мы с вами пропустим Он должен был спросить Можно вопрос да да вижу этот у нас и два и три которые не голосовали За четвертый у них прочерк стоит в Терм на их равстрийцы Да в Т3 волт или они все-таки ставят и 4 потому что пришли к тому что и 4 Лидер Так сейчас мы до этого дойдем я отвечу И мы посмотрим у нас как раз будет обработка запроса едва и 3 значит давайте потихонечку двинемся Сейчас у нас запросы обрабатывают и 5 и 8 Но с ними все просто как раньше они вот получили карточку 5 6 7 8 вот этот вот значит новый кусочек от и четвёртого они себе его персистят ставят галочку за и все хорошо и я сразу лесную секундочку на следующий и вот здесь мы с вами не рано можно вот на предыдущий смотрите оплаед стоит снизу вот четыре Откуда эти аплайт у E5 взялось плавает и 5 возможно я криво нарисовал Ну Давайте попробуем и пять посмотреть да и 5 у нас погодите погодите возможно и 8 и 2 и 2 и 3 1 2 и 3 сохранили два и три сохранили и 4-8 не получали Вы абсолютно правы это ошибка на слайде то есть у у и пятого в ДОУ и 5 в этой истории не должно быть галочек все спасибо Так я видел какую-то еще одну руку кажется не короче давайте давайте сейчас карточка дойдет до и один сейчас будет самое интересное потому что и один У нас во первых Возвращайтесь онлайн и один У нас до сих пор отдыхал настал момент когда ей один пришел онлайн получается сетевое сообщение из нового типа значит с новыми записями которые его оверят что с этим делать как я уже говорил Ответ простой фолловеры всегда подчиняются во-первых увидели новый Терм значит Лидер перешел статус фолловера все корону снял корону зачеркнули выборы Можно прочеркать можно Не прочёркивать ну как бы понятно что он и не голосовал и голосовать уже в этих термах не будет Мы просто пометим что себе чтобы помнить и один просто обязан подчиниться новому лидеру потому что тиром свежей и все свежее поэтому все что и один когда-то было вот это вот он благополучно себе зачеркивает и пишет то что ему велели сейчас я вижу ребятам неудобно за кафедрой не видно зачеркивают зачеркивают и где-нибудь рядышком дописывают вот 5 6 7 8 в третьем Терме новые данные которые пришли от свежего instance можно в микрофон пожалуйста будет в итоге потерян Абсолютно верно Это записи которые не были подтверждены и их бывает может постигнуть такая судьба это абсолютно нормально и к этому надо Быть готовым Так вопросы Давайте а это и один вопрос а то и один 4 галочки оплата стоит снимать надо Нет 4 все это данные подтвержденные и один У нас помните еще на самом первом Круге он собрался подтверждение он их значит пометил что он знает что эти записи подтверждены он их применил к своей стоит машине и вот эти данные Никуда не денутся поэтому не галочки снимать не надо вот как раз вот пожалуй одно из немногих что рафт может вам обещать это то что данные которые были подтверждены никуда никогда не пропадут не пропадут я причём могу объяснить почему значит если воспоминаниями вернуться к тому моменту когда у нас термоза Когда выборы закончились э-э без лидера у нас там и 8 пытался собрать голоса У него ничего не получилось значит чтобы выиграть выборы а нужно собрать то есть чтобы за овираетесь чтобы дропнуть вот этот хвост нужно собрать кворум да А ты не можешь собрать корм если у тебя раб журнал короче Поэтому вот такой тоже прикольчик что чтобы выиграть Лиги чтобы выиграть выборы и заверять журнал нужен тоже кворум квору много же чтобы заперсить кворум нужен чтобы затереть то что еще не было заперсичено поэтому это зачем вообще нужно вот тот нюанс что э-э instance не знают или могут не знать что запись подтверждена или нет Ну просто не как бы сообщение отправила а до кого дошло до кого не дошло неизвестно кто-то потому что за персистил и упал ОК Не прислал это всё равно как бы не мешает рафту Давайте вот те гарантии что это запись выживет То есть просто вот как бы мы не знаем законы она или нет но она уже никуда не пропадет если она заперсячена на кворами слушаю Вот и один не голосовал за и 4 Но к нему пришло от него сообщение Да он должен подчиниться да то есть фолловер не должен знать кто сейчас для него Лидер Ну он в каком-то смысле отсюда же и узнает что сейчас лидеры 4 то есть вот он это сообщение получил что ему от разных пришли противоречивые от разных лидеров нет потому что в одном Терме у нас больше одного инстанса выборы выиграть не могут опять-таки мы вспоминаем что у нас византийские атаки не предусмотрены то есть мы доверяем друг другу мы считаем что все следуют протоколу Поэтому чтобы стать лидером нужен квором голосов это м пополам + 1 две такие подгруппы в одном кластере быть не могут поэтому у нас не больше одного лидера в Терме И если мы получили сообщение в новом ферме от кого-то то мы ему верим если мы получили от старого лидера сообщения в старом Терме то старый термы мы банальные игнорируем вот сейчас не знаю там в качестве усложнения можно было достать Ту самую карточку которую мы потеряли посмотреть на неё увидеть что там старый Терм игнорировать спокойно себе Так давайте сверяться на самом деле мы большие молодцы Мы пошли подошли почти к самому концу давайте сверяться у нас карточка возвращается по кругу Ну давайте да вот вот там где мы потеряли лот Есть какие-то средства возможности клиенту до Сообщить о том что он лот потерял есть смотрите идентификатором каждой записи в журнале давайте я попозже отвечу на этот вопрос Ладно сейчас не хочу немного отвлекаться завершаем Круг где потеряли Ну пусть тоже обработают дайте им тоже карточки Пусть они свои галочки поставили Значит вопрос мне нужно Сейчас минуточку минуточку Мне сейчас нужно чтобы вы завершили полностью Круг и у нас к и четвертому вернется карточка со всеми голосами за Значит со всеми Простите это не голоса за это подтверждение что все окружающие эти вот записи к себе сохранили и теперь и четвертый наконец-то может узнать что вот все сохранили может проставить 8 галочек и плает теперь можно вопрос Да теперь можно вот можете чуть-чуть поподробнее раскрыть момент про голосование по второму третьему терему для E2 и 3 потому что мы там проголосовали против оба и два и три против восьмого например чтобы он был лидером А теперь Ну что происходит вот это наверное да да вот сейчас подчиняться Мы перезаписываем в термах Ну короче влоги получается термо типа у нас было типа прочерк условно у вас будет Вот примерно такая же картина у едва и 3 тоже то есть записываем делаем лидером типа в тех термах Ну в Терме а вы из Рав журнала просто удаляете старые записи с номером у вас смотрите что получается у вас была в журнале запись с номером 5 из термо Т1 с буковкой L не подтвержденная приходит сообщение с той же самой записью с номером 5 но уже с большим термом Т3 соответственно старую запись откатываем просто дропаем да она еще как бы она просто в журнале просто забыли и журнал положили новую запись уже есть более свежего термо Т3 и вот это вот картина она должна распространиться на и 1.2.3 примерно одинаково слушаю А и четвёртый при получении подтверждения от всех он галочки проставляет и первым четырем записям Несмотря на то что он их как бы не рассылал как Лидер Ну мы этой темы немножечко касались мы пропустили рассылку для экономии времени но в принципе там Проще говорить про каждую запись индивидуально то есть надо понимать Да что речь идет про каждую запись индивидуально там можно и одну запись от реплицировать Как бы вас никто не заставляет 4 записывать вот поэтому подтверждение собрал Да может вопрос получается Лидер проставляет оплата только если абсолютно все ноды ну если N пополам плюс один кворума достаточно чтобы считать запись за комиченной и применять еще вопросы Все ли закончили применять эти 8 записей молодцы так переходим к заключительной части на самом деле у меня на этом скрипт игры заканчивается мы и по времени хорошенечко уложились на час я еще немножечко поговорю расскажу про то что мы пропустили потом если есть энтузиазм Я так понимаю зал еще некоторое время свободен не помню До скольки но пока выгонять не начнут можно продолжить самим играть но это уже будет постфактум значит что мы не проговорили во-первых это динамическое изменение топологии в рафте есть э-э значит там в оригинальной статье рассматривались варианты добавления сервера удаление сервера это ещё один тип картачек даже два типа ну вот ремонт ремонт а-а и а-а и когда-то так оно и было но потом сообщество пользователей скажем так решила что этого немножко мало потому что вот в в реальной жизни бывают ситуации когда нужно сервер не просто там добавить или удалить а заменить и там начинаются проблемы связанные с тем что мы не хотим открывать Вот это окрошка То есть у вас сейчас размер кластера 8 Да если мы Ладно давайте не про 8 говорить Давайте про трех instance вы говорите свой кластер там нужно одну ноду заменить старую вывести новую добавить вот врагте есть расширение которое позволяет это делать атомарно Это называется Joint консенсус присоединенный и специальное состояние которое вам как бы гарантирует что вот в процессе изменения топологии там главное если мы сначала добавим подскочит до трех и тогда вот в этот маленький промежуток времени есть риск что одна надо Упадет и мы получим не рабочий кластер починить не сможем если сначала удалить потом добавлять там тоже не совсем хорошо вот эта тема называется можно слушаю секундочку Ярослав Я хочу попросить тех кто уходит проголосовать и оставить отзыв на участие в этом мероприятии давайте я сразу тогда переключусь на qr-код а продолжу проговаривать отдельно значит следующая тема которую мы не коснулись есть еще такой вот когда алгоритм рафт разработали он появился и начали пользоваться появился такой значит случай представьте себе ситуацию что сеть порвалась не на совсем А например в одну сторону и вот эти вот там и 8 у нас начинали выборы и четыре значит если вот тому протоколу дальше следовать то какая ситуация может возникнуть А и восемь сидит такой в изоляции до него никто не может Достучаться он Пингви не получает его постоянно таймаут Зато остальные его прекрасно слышат Вот это прям повезло которое только можно пожелать любое распределенной системе значит если следовать банальному Вот потому что я проговаривала алгоритму рафта что получается и 8 говорит Ага тайм-аут новый Терм T4 голосуйте за меня ребята такие ой новый Терм мы все фолловеры значит Лидер сбрасывает свою фолловерство говорит что не Чувак мы за тебя голосовать не будем потом там тоже наступает тайм-аут там Ну должны произойти выжившие части кластера Да в большой должны новые Выборы это все жрет время и у нас вот этот вот и 8 ну не со зла Но работает Просто на не дотоз просто DOS он постоянно выбивает лидера который там все прекрасно работал значит чтобы этого не происходило у меня здесь на предыдущем слайде записано вот поэтому в современных системах которые рафт используют там голосование делается в две фазы вот Мы сначала как бы проверяем прощупываем почту а почву а проголосовует ли за нас вообще хоть кто-нибудь и потом если да то уже начинаются обычные выборы и третья вещь тоже достаточно интересная которую Вот в такой формат мероприятия впихнуть крайне сложно это снапшоты это бесконечный рост Раф журнала поэтому там надо понимать что опять-таки новый инстанции как-то надо добавлять поэтому там помимо репликации самого рад журнала вот это вот opendentress есть ещё это пять уже насчитал типа в записи снапшот э-э Значит э-э тоже его отправляет Лидер По каким соображениям он это делает это его дело Но на самом деле как бы если э-э там пытается что-нибудь реплицировать Да и ему пытается затреплицировать десятую запись а ему Уинстон сгорит А у меня вообще типа raph Lock пустой Я только добавился вот в этот момент логично не с первой записи с там с 1 индекса ему всё отправлять потому что мы могли уже давно дропнуть и забыть нам записи Зачем хранить нас стоит машина важная вот там и даёт ещё отправка снапшотом Вот и вот на этом совсем всё вот теперь можно переходить голосование к чему А ну вопросы ещё какие короче закругляемся Спасибо Ну что вопросы будете задавать можно к вопросу вернуться Как точно я обещал ответить Напомните пожалуйста как клиент который записывал в кластер лот мог бы узнать о том что лот не так Да действительно рассказываю значит возвращаемся к картинке Ну вот например такой каждая запись в раб в журнале идентифицируется двумя чиселками это индекс и Терм соответственно стандартная практика самая банальная примерно следующая приходит Клиент говорит Да пиши буковку т Лидер смотрит какой у него текущий индекс текущей тем это все врат журнал сохраняет запоминает для этого клиента ему надо запомнить две вещи что вот индекс тем Ну значение там Да тоже и блокирует этот запрос до поры до времени пока не соберет подтверждений значит параллельно По мере того как он общается с остальными сети он может ну банально следить значит как только галочка на этой буковке T появилась можно отвечать клиенту Да окей Все хорошо и ситуация которую мы проходили с перезаписью журнала Вот например клиент добавлял буковку D восьмому в какой-то момент наступает событие когда приходит Вот это сообщение и один и в Раф журнал попадает вот это вот Овер айдищая запись с тем же самым индексом 8 Но термом другим то есть мы клиенту как бы запомнили что мы ему должны восьмую запись в Т1 закомитить А у нас тут Лог перезаписан 8 значит 8 Т3 это повод сказать ему что Нет дорогой Извини твоя запись была за овержена можешь смело ее ритм и вот это на самом деле достаточно простой сценарий потому что худшее это когда мы оставляем клиента в неведении когда наступил тайм-аут мы кому-то что-то разослали а подтверждение ни Да они нет вот в таком подвижном состоянии К сожалению на них тоже приходится ориентироваться про них всегда надо помнить что да еще раз можно микрофон закончить официальную такую часть выбрать лучший вопрос тут их в общем-то было много но осталось мало людей так что придется выбрать и потом в оставшееся время мы можем продолжить Слушай что делать если я ни одного вопроса не запомнил их последний вопрос хорошо вот этому молодому человеку а давайте все последний вопрос а на следующий я буду отвечать уже в калуарах да последний вопрос из практики Вот такая вот повисший запрос от клиента на который не Дани Нет по времени Сколько занимает очень и очень зависит от конкретной ситуации от конкретной имплементации Я как продуктовый разработчик предполагаю худшее навсегда Ну понятно То есть получается есть такая ситуация случается то надо что-то делать Я так понимаю с конфигурацией А вот кстати интересно Можно ли кворам как-то менять То есть я так понимаю по дефолту форум Это половина серверов нет вором не меняется кворам Это ровно N пополам плюс один можно менять топологию если у вас один instance вывалился то вы можете как бы не знаю упавшие вот через это изменение конфигурации сказать что до свидания Ты больше не не с нами но чтобы такую операцию провернуть нужен который включает себя этот старый это гарантирует нам что никаких плохих вещей с перезаписью applite вот этих законеченных записей не произойдет Спасибо в микрофон пожалуйста даже в этой игре был ситуация когда у нас само сообщение больше чем размер кадра который мы отправляли и фактически Даже у нас запланирована половина сообщения и она не является консистентом для штат не все сообщения которые должно лежать на системе хранения допустим у нас сообщениями были у нас записями были по одной буковке Так что это всё-таки вот каждый у нас протокол подразумевает того что размер кадра больше чем размер сообщения как минимум большая равен А ну что подразумевается под размером размер кадра Ну размер отправляемый максимального пакета пакета который не обязательно но то есть никто не мешает там несколько edp-пакетов как-то Это хорошо Возьмите Возьмите измерения кадра с которым работает сам протокол мы тут у нас Четыре сообщения было Если у нас было например длина самого сообщения не одна буква сообщение шло там Ну скажем так 8 букв сначала написали хайлоат это полностью сообщение и соответственно было бы не консистентно уже после этого смотрите я понял ваш вопрос смотри Ярослав Вопрос такой что если у нас размер транзакции больше чем размер одной транзакции больше чем размер пакета то есть мы не можем сюда написать циферку пять потому что она не вылазит в это поле например ничего страшного э-э отправьте её несколькими сетевыми сообщениями Я уже упоминал что у нас транспорт агностик то есть какой именно транспортом под капотом будет неважно важно подтверждены да а важно то что да Вы подтверждаете одну как бы команда идёт вот это вот ANT Andreas Это буквально Лидер говорит Значит от сохраните себе вот эту штуку то что эта штука вот одно сообщение одна в раб журнале весит гигабайт и так далее неважно важно что вы можете ее там отправить и вам нужно одно подтверждение Ну каждую запись подтверждать его отдельно я понял то есть мы галочку оплат поставим после того как нам подтвердили условно там два три четыре пакета N пополам + 1 Ну я имею ввиду что как только собрали целую транзакцию из этих пакетиков Да мы поставим галочку оплату себя мыслить об этом как пройти CP Вот вы отправляли пакеты они потом за реализ собрались целиком и вот у вас получилось полностью нормально собранный поток здесь приблизительно так же вы собираете вот этот э-э оттенки целиком если он большой придётся собирать вопросы про чтение то есть Правильно ли понимаю Что читаем мы всегда с мастера ой с лидера потому что только у него сейчас есть актуальное какое-то состояние которое отвечает так или иначе кворуму и это зависит от ваших потребностей читать можно несколькими способами Спасибо тоже упомянули это надо было вот на предпоследнем слайде тоже сказать есть такая штука Как квормное чтение значит вообще Вот чтений давайте я три вида перечислил Первое это когда мы приходим На фолловера значит что-то читаем вот прям что есть то и читаем ни у кого ничего не спрашиваем мы знаем Из какого индекса мы это прочитали мы знаем состояние текущее Да там запланировано 8 Да мы прочитали вот из текущая стоит машины Мы можем это клиенту вернуть etcd вот если говорить про конкретные имплементации он в базовый поставке так и делает Ну там без дополнительных опций он тебе говорит вот дорогой клиент твоё значение Значит ты прочитал такой-то рафт индекс Ну Пользуйся этим свое усмотрение второй вариант это второй Кто у нас так третий это кворумное чтение к воронное чтение это такой прикольненький достаточно сложный алгоритм перескажу его в двух словах Вот его прям по шагам писать проще чем как-то еще значит там происходит следующее фолловер отправляет запрос на кворное чтение лидеру Лидер запоминает текущий коммит собирает подтверждение от всех окружающих чтобы убедиться что он до сих пор Лидер говорит что да я Подтверждаю что этот конец значит что я все еще Лидер что этот комит вот сейчас точнее когда его запрашивали был актуален там опять к тому времени как это все дойдет до клиента мы уже немножечко устареет это тоже соблюдает может быть Лидер уже устаревший Это проверка тогда отвалится и он после того как от лидера подтвердившего получает вот этот вот ОК Значит он смотрит во-первых что Да мне Лидер сказал там восьмая запись Терм T1 он дожидается применения у себя этой записи локально потому что может еще случится Так что Лидер сказал что Восемь А фолловер ещё лого себе столько не накачал какой-то там от старший из фолловеров Да только-только вернулся вот он дожидается пока эта запись будет применена проверяет тем что совпадает и тогда уже клиенту вот из этого индекса говорит Да вот твоё значение значит из такого термо из такого индекса Ты прочитал а второй промежуточный там ещё какой-то вариант был такой э-э промежуточный промежуточный я его что-то сейчас не могу вспомнить наверное и не надо вот кворамное чтение это прям самое-самое такое надёжное Спасибо я предлагаю закончить Ярослава за выступление Спасибо"
}