{
  "video_id": "KGi1tgNZIss",
  "channel": "HighLoadChannel",
  "title": "Как написанная нами система помогла избавиться от финансового фрода / Тимур Габец (Тинькофф)",
  "views": 1128,
  "duration": 2682,
  "published": "2023-01-19T05:55:17-08:00",
  "text": "так друзья привет меня зовут тимур я руководитель небольшой com работки в тинькофф банке мы занимаемся процессинговым системами процессинговый и митенки my системами я уже 9 лет занимаемся этой процессинговой истории а конкретно на тиньков sky galleria с 2018 года и с 2018 года собственно то чем я занимаюсь месяц своя команда это решение в различных процессинговых проблем меня взяли в качестве первого разработчика на проект и наша задача была разобраться с тем самым правым кейсом с теми самыми performance проблемами которые мы испытывали то касается меня то программировать я способен только на си си плюс плюс я ненавижу всей душой а джаву я к сожалению не понимаю отчасти это сыграло роль во всем том что вы наделали что мы написали что касается моего доклада если сказать коротко и одной фразой в принципе у меня нету задача вас каким-то образом удивить скорее всего то что все то что то что сегодня буду вам рассказывать вы так или иначе все знаете но если все весьма доклад свести к одной какой-то конкретной фразе то вот она in memory база данных способны творить чудеса и как бы это наивный не звучало это действительно так что все проблемы которые мы решили в процессинге в том конкретном кейсе которые буду рассказывать мы сделали благодаря тому что наши процессинговой система которые написали использовала редис наверняка вы все знакомы с редисом но если кто вдруг нет напомню что редис это довольно прикольная простая в довольно простая upon собственная in memory гибелью база данных в которой есть куча всяких разных ништяков конкретно для нас было важным использование хэш-таблиц и использовании такой фичи как отель собственно на этом на этих вещах которые отлично легли в нашу самую архитектуру мы выехали и построили все наша система как будет построен мой доклад если коротко я буду вынужден рассказать некоторую теорию про финансовые сообщения о том что это такое потому что мы мы в процессинге работаем финансовыми сообщениями это то тот материал который нам приходится иметь дело все процессе система не собственно чем и занимаются они обрабатывают финансовые сообщения и на них отвечают по следу я буду вынуждена рассказать какие бывают банковские комиссии как и считать потому что это также довольно важно потому что написано не системой собственно система по расчет комиссий без этого как бы никуда и третье это кое-что про клиринг овердрафт это все нужно будет исключительно для того чтобы я смог рассказать чем же суть того самого продавать кейса почему мы не до получали прибыль на протяжении нескольких лет и как вообще все это произошло это та необходимая теория про которую мне нужно будет вам рассказать надеюсь мы ложимся минут 15 я постараюсь сделать так чтобы это было максимально и скучно ну и дальше некоторое практическая часть как нам тут может редис и будет после этого немножко практике на мы постараемся прикинуться приложением попробуем походить в редис и попробуем решить ту самую проблему со ступенчатыми комиссиями которые мы не могли долго решить в нашем и митинском hostel ну и там же мы немного поговорим про объемы про то в каких данных и каким таким образом мы храним все наши tissot объекты ну и профит у нас же банк итак поехали финансовые сообщения эти авторизации я буду периодически привлек слова авторизации это некоторый профессиональный сленг как бы в своей голове прокручивайте по сути это есть финансовое сообщение это не та когда кто-то кому-то предоставляет доступ погнали вот такая схема например что он что происходит когда мы берем свою карту мы клиента тинькофф банка и нам необходимо снять наличные мы вставляем карту в какой-то чужой банк банкомат чужого банка который знает не знает о том если у нас деньги на счету тогда вся задача банка банка-эквайера в этом случае это переадресовать запрос в платежную систему если у вас на карте нарисовал логотип master card платежный запрос отправляется платежную систему в mastercard на самом деле нет но до задачи платежной системы здесь это роте трафик по первым 6 цифрам вашего номера карты определяется в какой именно банк мы должны будем отправить запрос точнее платежная система определяет и поняв по первым 6 цифрам о том что это карта ближе тиньков скому банку запрос продаете туда попав в уже комитенту то есть мы здесь выступаем в роли эмитента запрос попадает в эти самые процессинговой системы вот это вот желтая облачко это вот тот самая та самая росы процессинговых микенских систем в которых и происходят все происходит все проверки проверки перри фотографии проверки пин блока доступного остатка anti-fraud системы система просчета комиссии в том числе которую мы написали здесь еще важно сказать что вот эта желтая облачко это не целиком наша разработка скажем так потому что processing много частей состоит из венгерских систем которые тоже имеют свои плюсы и свои минусы но к этому мы ещё вернёмся так вот собственно пример запроса вот это то с чем нам приходится иметь дело это сообщение в некотором бинарном потакали прямиком из восьмидесятых это стандарт асо-8 583 каждый из платежных систем использовать свой собственный некоторый диалект но в целом все сообщения похожи друг на друга если присмотреться то фактически то с чем мы имеем дело это набор из пронумерованных полей каждого из полей это в каждом из полей передается какие-то определенные данные ну вот например во втором поле вам будет передаваться номер карты это всегда так 14 ли это expressions and processing вот это-то на основании чего в принципе процессинговый системы могут понять что что это за операция то есть 01 это снятие наличных а 00 это покупка если нам необходимо понять размер операции то вот здесь видно что в четвертом поле это 3500 рублей то что это рубли мы можем понять и 49 поле потому что код валюты это 643 самый один самых важных здесь кусков это mtc вот это 18 поле машин категорий код например на основании этих четырех цифр определяется то какой кэшбек вы будете получать в конце месяца если у вас приложение тиньков на следующий месяц выбраны повышенный кэшбэк на покупку подводных лодок то вот вы должны смотреть в четыре цифры искать такую ночь 10 11 в этом конкретном кейсе например это снятие наличных какие-нибудь супермаркета это 5411 43 поле достаточно важная здесь странное место проведения операции вплоть до улицы и дома все остальные поля нас здесь конкретно не интересуют но что здесь важно еще сказать что в принципе это все данные которые мы имеем запросе фактически нас есть только номер карты x поредеет ну и какая то крипто информация например вроде пин блока который мы будем проверять все все данные которые мы получаем мы должны сформировать ответ ответ тоже достаточно простой большинство поли копируется из оригинального сообщения самое важное здесь поле после всех проверок которые процессинговой системы проведут это 39 поле здесь эмитент указывает код ответа если мы одобряем эту операцию это 00 если нам нужно отказать тогда что ну тогда все что не 00 например 05 это просто отказать 51 если нам нужно и отказать из-за недостаточные средства 55 если введен неправильный пин-код еще бывают всякие интересные кейсы когда нужно мало того что отказать так еще например и забрать карту в банкомате тогда мы отвечаем 04 если например натив рот система понимает что это фрод мошенник вставил карту банкомат и ее нужно например взять все дальше по цепочке здесь все довольно просто откуда запрос пришел туда мы отвечаем да мы сформировали ответка комитент отправляю платежную систему платежная система отправляет ответ банка-эквайера банк получает ответ с платежной системой если ответ супруга ли ok все классно этому джентльмену значит можно выдать те деньги которые он запросил что там у нас с трафиком таких операций вот про который я говорю мы имеем порядка 30 миллионов в обычный будний день это порядка там двух с половиной миллионов в час и 600 чуть больше 600 операций в секунду ну операция это все вы понимаете все финансовые запросы покупки снятия наличных вот это все за какие времена мы формируем ответы что мы делаем ну вот средние время ответа у нас 60 миллисекунд за эти 60 миллисекунд мы осуществляем все все все проверки вот если посмотреть на этот стек граф то вот например 5 миллисекунд вот эта голубая полосочка это крипто проверки которые мы проводим огромная розовая 20 или 30 миллисекунд полоска это наша анти фрод система я надеюсь что когда нибудь наши коллеги соберутся с силами придут расскажут чем они там занимаются в течение 30 секунд потому что они занимаются реальные дечеви серваке у них по 3 терабайта но надеюсь когда-нибудь они об этом расскажут всякой работа с базой это вот там зелёный бордовый еще какой-то зеленый порядка семи миллисекунд и если говорить про нас то вот там есть такая тёмно-синяя полосочка две миллисекунды это внешняя система по расчету комиссии собственно это та система которая и была нами написано в этой системе за эти самые две миллисекунды которые здесь указаны совершаются все проверки все ступенчатые комиссии все ограничения ну и собственно это та система которая использует редис и you space который мы сегодня и будем с вами обсуждать небольшой оффтоп кое-что про конкретно наши две миллисекунды это все но не имеет особо отношение к редиса и к использованию in memory баз данных но тем не менее коротко постараюсь рассказать о том как именно нам дались эти самые две миллисекунды все то что я буду рассказывать это не руководство есть это просто тот набор вариантов которые мы пришли первое всего прежде всего тот послал от который мы сформировали самого начала это то что мы никуда не ходим по сети дальше vocal холста вот просто потому что те самые две миллисекунды которые мы получили в нашем техзадание мы восприняли к довольно таки буквально и решили что ok если мы вдруг начнем куда-то ходить по сети то как правило это еще там муки полмиллисекунды если мы еще добавим тут какой-нибудь сиропчик то короче мы начнем терять время в принципе нам не очень хотелось так делать короче наше решение собствен заключается в том что приложение всегда ходит на локальный редис и никуда кроме как вокального редиса она ходить не должно и более того мы используем реддит в качестве основного стороже они в качестве каширу ющий прослойки между например приложением и базой второй важный для нас пункт это отсутствие виртуализация всякие истории про аум киллеры overcoming памяти а также некоторые проблемы сладости которые мы увидели на наших virtual koch нас не очень порадовали поэтому сделали грустные глаза пришли к нашему руководству искали можно пожалуйста нам железные серваке вот перед этим работаем на 3 железных сервер серверах в которых стоит по 4 xeon я думать о байта памяти мы чувствуем себя на них прекрасно в качестве языка разработки мы решили что garbage collection нам тоже нафиг не нужен поэтому мы выбрали язык программирования си без плюсов и тоже весьма этим довольны это конечно самых или верный аргумент у нас монолитная архитектура приложения и ну понятно что от наше приложение отлично выделилась намекни сервиса но мы сказали сами себе что ну давайте нет у нас будет монолит мы никуда не будем ходить все внутри одного бинарник а быстро все посчитали быстро ответили бы страдали ну в данный момент у нас 100 тысяч строк кода две трети из них это тест и в целом все устраивает и делите на миг ротируется дальше тоже мы собираемся мы здесь нас дальше у кэширование данных внутри приложения для того чтобы не ходить в редис на каждый чих потому что редис однопоточный и имеет свои особенности и поэтому данные масс внутри приложения также кэшируются в своих хэш-таблицах это делается для того чтобы например не ходить по каждому запросу по карте если олег dkart у вас меняется раз в два месяца то не нужно каждый раз ходить за ним время сна каждую операцию можно его прикопать локально в приложении вот ну это конец авто по собственно ходи к нам на стенд давайте мы там затрем про микро сервисы если у вас друг здесь появятся вопросы давайте собственно категориям какие бывают комиссии как их считать напомню мы работаем с с расчетом комиссии должны считать их быстро какие бывают к миссии к миссии бывают простые простые это не те которые делятся на единицу и на саму себя простые это те которые мы можем достаточно легко определить из приходящих на операции сам простой случай если вы клиент тинькофф банка то вы знаете что если вы снимаете например тысячи рублей свадьба с вас возьмет в комиссии 90 рублей но это просто вам запросе приходит размер операции вы применяете простой арифметикой взяли 90 рублей easy peasy чуть сложнее становится когда вам нужно почитать тарифы и узнать о том что существуют еще и верхняя граница конечно же тариф никто не читает и вряд ли кто-то знает о том что существует верхние границы например ваш период выписки вы можете снять до ста тысяч рублей напомню период выписки выпускает окато когда вы получаете свой кэшбэк если кэшбэк вам приходит 14-го числа значит ваша выписка из 14 по 14 и в тарифах буквально написано что вы можете снять без комиссии до ста тысяч рублей накопительно в течение вашей выписки ok этот достаточно он не сложно да но это требует столь же то есть информация о том сколько вы сняли во время за последний месяц за время вашей выписки эту информацию необходимо где-то хранить и исторически так сложилось что наша виндзорская система которая которая достаточно хороша и является наверное одно из лучших на рынке тем не менее со сложными комиссия менаше бен мерзкая процессинга системы на наших объемах справлялась достаточно плохо и фактически в 2018 году в расчет ступенчатых комиссией в этой венгерской системе был отключен и давайте мы попробуем объяснить к чему и каким последствиям это привело кое-что немного про клиринг про овердрафт этот самый правый кейс значит вот эта картинка про которую я показал это все на самом деле только половину правды потому что это авторизация это в традиционная часть помимо то вот этих стрелочек и вот этих 60 миллисекунд которые происходят на в этом жёлтом облаке существуют еще и такая штука как клиринг про клиринг на самом деле достаточно подробно надеюсь после меня в этом же зале расскажет наталья весовые нас пока но я здесь коротко расскажу в общем сейчас вы в том что тот факт что вам в течение 60 миллисекунд и памятен что-то ответил разрешил снять наличные или разрешил какую-то покупку не означает вообще ничего фактически мы только говорим что окей мы закодировали эти средства в кажется можно клиентам воспользоваться этими средствами но фактически авторизация не является основанием для списания средств с вашего счета с вашего баланса таким основанием является исключительно клиринг что такое клиринг living это набор транзакций соответственно платежная система спустя несколько дней проходит несколько рабочих дней платежные системы готовит огромный клиринговый файл в котором фактически перечисленные то есть этот натуральный построчный файл каждая строка в котором это определенный транзакция на основании этой транзакции списываются деньги с вашего счета что дело платежная система платежная система складывает куда-то на шару бэк-офис на система банка каждого из банков должна сходить на эту шару забрать клиринговый файл обработать его обработка клинка файлы это тоже отдельная отдельная процессинговой история требующие своего перфоманса но в течение нескольких часов происходит обработка клинка файла все они простираются и происходит кстати повторное вычисление комиссий то есть если по костная система также сама считает сколько живые сделали снятие наличных в течение вашей выписки и уже в этот момент все нужные комиссии по стираются и списываются с вашего счета собственно сорт коротко к сути фродо до 2019 года как я уже сказал сложной комиссии не рассчитывались в frontier то есть в момент получения авторизации наши митинский хост windows к система не рассчитывал никакие комиссии практически не мог это делать там был такой механизм его включили но после того как ответ на авторизацию начал занимать несколько секунд естественно все свернули отключили потому что никто не хочет ждать по несколько секунд пока он получит свои деньги ну и вот к чему это привело это привело к тому что люди которые например профессионально занимаются обманом есть такая сфера как обнал они узнали собственно об этой бреши и тут надо понимать что занимаюсь аналом как и любым другим бизнесом у вас есть задача максимизировать прибыль и минимизировать риски соответственно один из способов ионизировать риски это уменьшить комиссию за снятие наличных и вот наш кейс был практически идеальным вы можете взять одноразового клиента одноразовый это человек который получает карту там по поддельному паспорту не важно каким образом этому одноразовом клиенту вы можете перевести условный там 20 миллионов рублей ну и все единственная задача этого на разово клиента засунуть карточку в чужой банкомат в чужой это важно и вытащить все эти 20 миллионов рублей технически мы должны были бы взять комиссию с него но мы не можем потому что наш процессинговой система это не умела тогда почему это приводило это приводило к тому что клиент в в металл 20 миллионов рублей в ноль проходил несколько дней формировался клиринг приходил клиринговый файл на основании этого клиппинга файла бы кофе ная система начала считать комиссии с 20 миллионов рублей 2 процента это примерно 40 тысяч рублей эти 40 тысяч рублей пасти руются со счета постираться на счет клиента фактически оказывается что клиент оказывается в минус 40 тысяч рублей понятно что это как бы не убытки но это недополученная прибыль которая никого не радовал это во-первых а во-вторых за такие случаи как овердрафт а вот фактически это есть термин овердрафт то есть когда у вас есть дебетовая карта вы ни при каких условиях и ни при каких ситуациях не можете выйти в минус тем не менее в этом в этом минусе оказываетесь и вроде как по нашей вине короче за такие истории с овердрафтом нас очень сильно дрючит регулятор центробанк и история с овердрафтом он никогда не любит собственно вот в таком бэкграунде мы находились в 2018 году в принципе откуда родилась вся эта история с редисом и с написанной систему в конце концов из нас там году это немного всем надоела и было принято решение о том что кейт нам нужен отдельный модуль отдельная система которая смогла бы рассчитывать комиссии и причем желательно чтобы она делает достаточно быстро потому что времена по 20 миллисекунд всех не устраивали ну и собственно как же нам тут может помочь редис мы решили что мы будем использовать рейде в качестве основного хранилище повторюсь то есть мы не используем его как кэш напомню что мы восприняли эти самые две миллисекунды как некоторый челлендж и некоторый вызов самим себе скажем так то есть мы восприняли эти самые две миллисекунды довольно серьезно но и поняли что мы будем ходить исключительно вреден и хранить будем все нужные компоненты только вредить и какие же нам будут нужны компоненты для того чтобы считать ступень что комиссия ту самую ступенчатую комиссию напомню что мы хотим снять мы хотим хранить сумму снятие наличных за время выписки нам нужны карты потому что в запросе который к нам приходит нет ничего кроме объекта карты у нас только номер соответственном нужно хранить все объекты карты нам нужны счета потому что карта может быть привязана как вы знаете к разным счетам у вас может быть несколько валют долларовые счета фунтовый считаешь как ваша карта может быть подключена к любому из них более того к одному счету может быть приковано множество карт у нас есть клиенты у которых есть несколько тысяч карт такое тоже бывает ограничение вот это 100000 рублей которые у вас есть она применима к счету многие карте вам нужны продукты потому что разные банковские продукты имеют разные комиссии например дебетовые карты имеют вот эти самые ступенчатой комиссии кредитные карты не имеют комиссии за снятие наличных вообще поэтому к ним эти штуки неприменимы собственно сами объекты комиссии тоже должны где-то хранится вот эти все тарифные настройки сколько мы берем там два процента 90 рублей какие вот то есть вот эти все границы они тоже должны где-то хранится каких-то объектах очевидно что тоже должен быть редис ну и фильтр и потому что мы должны каким-то образом уметь отделять одни операция других самое главное что мы должны делать это понимать то есть является операция вообще это снятие наличных или это просто покупка или пополнение ну и последнее нам нужно где-то хранить счетчики счетчики это некоторые накопительный данные об общей сумме авторизации потому что мы решили что особо нет смысла хранить историю операций и в момент получения запроса ходить по этой истории что-то суммировать там еще что то делать мы долго думали в конечном счете решили что наверное смысла нет нас вполне устроит некоторые накопительный счетчик общего количества ваших снять здесь небольшой оффтоп по поводу того как именно вы можете наливать данные в ваш приедешь в этом конкретном случае в принципе здесь все очень сильно зависит от того как какими возможностями обладает ваш оба костная система в принципе если ваш бекофис та система которая хранит все считая карты если например на скидывает информацию по всем событиям куда-то в кафку то вы можете просто подписаться на нужные вам топике вычитывать из кафки из наливайте напрямую время нашем случае так не получилось всего различных причин нам что из-за иметь свой собственный урок новую базу ну мы ж тут в кровавым энтерпрайзе поэтому у нас везде кругом oracle так вот у нас отдельная рак новая база и мы стремимся помощью годом гейта из быков с ней базы данных уже к себе на нужных объектов в нашей базе у нас висят три игры то есть когда вас меняется какой-то объект карты по трейлеру создается событие отдельный кусок нашего приложения backbone бек часть нашего приложения собственно полет периодически эти события понимают о том что какой-то какая-то карта изменилось ли какой-то аккаунт изменился ходит джо нет все нужные таблицы все нужные данные и в конечном счете собирает это в один единый какой то объект и складывает его время про саму структуру объектов я чуть дальше расскажу подробнее в общем это делается все для того чтобы задача пока какова задача бека в этом в этом процессе подготовить данные максимально удобные для фронта фронт это собственно приложение которое занимается расчетам комиссии и обработка всех авторизации и задача здесь предоставить данные максимально удобном для фронтовики так вот вот мы храним карты где естественно удобно будет хранить карты естественно хэш-таблицы потому что у нас есть только номер карты он может выступать в качестве ключа собственно объектом у нас будет являться вот некоторый объект карты собственно мы используем в качестве но мы используем про табу в качестве механизмы сериализации принципе ничего не мешало нам использовать какой-нибудь условный джейсон просто нужно понимать что это заняло бы раз я не знаю в 10-15 больше места поэтому все что мы сделали это исключительно для для для экономии места вот конкретно например моя карта здесь на слайде она занимает 140 байт и единственное что здесь нужно понимать и какое удобство здесь приносит про the buff вам приходится писать инструмент при том числе и утилиты командной строки для того чтобы понимать вообще с какими объектами вы работаете ну например вот для того чтобы понять что здесь нам приходится писать такие инструменты собстна самое важное что нужно понять здесь у нас будут некоторые объекты которые будут в которых внутри которых будут находиться ссылки на некоторые другие объекты в объекте карты у нас есть ссылка на аккаунт вот этому конкретно мой рублевый аккаунт у него есть некоторые идентификатор собственно что мы делаем дальше дальше мы получаем счета все счета которые у нас есть также удобно будет хранить в хэш-таблице идентификатор счета в качестве ключа пробыв на объект 140 байт все то же самое 145 так совпало так же как и у карты собственно карт например вам придется хранить если случае тинькофф банка у нас 100 миллионов карп вы можете перемножить одно другое у себя в голове и понять сколько примерно займут у вас карты 130 миллионов счетов умножите на 140 байты тоже примерно поймете сколько у вас займусь это объект счет а самое главное что в нем внутри у нас находится это некоторые идентификатор продукта вот эти цифры пятьдесят семьдесят три такой раз информация о том что у вас есть некоторые дебетовый продукт тинькофф black у который будет содержать некоторые тарифной настройки давно он рублевый еще важный timestream здесь это дата выписки это вот та самая дата выписки это оружие которое еще стрельнет сейчас чуть дальше мы будем использовать эту этот тайм стенд для того чтобы указывать время жизни наших счетчиков так с продуктами все примерно тоже самое все храним хэш-таблицы некоторые идентификатор про the buff на объект единственно что занимает он 300 килобайт но учитывая что продуктов у нас не так много всего полторы тысячи в принципе это не проблема то же самое важное здесь в продукте у нас есть ссылка на некоторую ступенчатую комиссию к продуктам дебетовых карт могут быть приковано различно ступенчато комиссии конкретно здесь к этому продукту у нас одна единственной ступенчатой комиссии сложная и у нее есть некоторый индификатор вот оно в принципе это исключительно отражение того что написано вас тарифах идентификатор комиссии комиссия применяется к аккаунту это один statement ну и дальше некоторые тарифные настройки что это минимум 90 рублей или 2 процента и собственно вот какие то лимиты 100.000 рублей в чужих банкоматах и 500000 в наших и следующий идентификатор как следующая ссылка на следующий объект это фильтр мы должны понять аж какие условия применения этой ступенчатой комиссии условия применения фильтрах фильтры это некоторая маска накладываемые на авторизацию в принципе желтым здесь выделена то на основании те поля в авторизации уже знакомый вам на основании которых можем делать какие-то проверки проверки могут быть самые разные и в принципе они не такие очевидные как они могут показаться на первый взгляд но в нашем конкретном случае например то что нас будет интересовать нас будет интересовать проверка боем сиси наша задача будет понять что если авторы в авторизации 6011 значит все просто это снятие наличных так вот фильтры ну вот примерно так выглядит фильтр мы указываем что здесь мы будем проверять м сессии тут есть всякие разные дополнительные условия которые мы сейчас обсуждать не будем потому что здесь конкретно для нашего виски из они смысла особого не имеют естественно хэш-таблица некоторые идентификатор 2 2 с лишним килобайта наш объект от обычного объекта и 40000 фильтров которые вам необходимо будет хранить для всего бизнеса и для расчета все комиссия которой у вас есть счетчики это последнее что у нас остается здесь и что нам необходимо будет хранить в одессе собственно счётчик это такая структура данных в которой мы храним накопительные значения всех снятию наличных например счетчика есть два т м с темпом это два атрибута первый это время создания то есть мы не создаем например в счетчике для всех наших клиентов для всех счетов счетчики всегда создаются в момент срабатывания 1 авторизации как только смочил спела 1 авторизация мы кладем информации об этом редис собственно вот здесь конкретно моем случае 22 апреля было первое снятие для по моей карте например и x паре датчика это соответственно кончание дата выписки ну и в структуре здесь ниже мы храним видно что у меня было 1 снять на 1000 рублей в банкоматах тиньков и 3 снятия на 4 900 в чужих банкоматах собственно где мы храним счетчики нет ни в хэш-таблице потому что для этого для хранения счетчиков мы используем такую фичу как expiration date то есть вы одна из отличных вещей с которыми ли отличная глава нашего архитектуру у каждого счетчика в одессе вы можете задать время жизни то есть вы указываете что этот счетчик должен жить 5 секунд десять дней или вот до определенного времени как только вот это определенное время наступает ready заботиться о том чтобы вы больше этот счетчик не получили но можно сказать что он удаляет нет но как бы да ну и вот есть единственный нюанс то что отель может указываться не для хэш-таблицы для отдельного для каждого из элементов хеш-таблицы вы не можете указать какой-то тель поэтому счетчики мы храним россыпи вот у нас есть там составной ключ который состоит там идентификаторов ступенчатой комиссии идентификаторов счета в принципе выглядит он как бинарный объект тут глаза даже особо зацепиться не за что но собственно вот мы собрали все нужные компоненты все рассказали тут видно что одни объекты ссылаются на другие и как бы в целом понятно что должно делать ваше приложение давайте как бы хантон и немного практики давайте представим что мы как раз являемся нашим приложением которое должно будет рассчитать ступенчатой комиссии мы представим что вот мы из консоли ходим в редис при диск ли это обычная стандартная утилита поставляемое вместе с редисом так вот представим что вот мы получили операцию по какой-то карте ну и че мы здесь должны будем собственно делать должны будем мы делать следующий мы берем номер карты идем в хэш-таблице с картами получаем какой-то объект аккаунта получаемый некоторые delphi катар ok идем дальше в хэш-таблице со щитами получаем объект продукта идентификатор продукта идем в хэш-таблице с продуктами понимаем что к этому продукту приковано какая-то ступенчато комиссия какая же она идем в хэш-таблицу с ступенчатыми комиссиями получаем какой-то объект понимаем что кейт аккаунт на что танки и statement а ещё тут есть какой-то фильтр идем в хэш-таблице за фильтрами получаем какой-то объект в этом объекте указано что мы должны будем проверить нашу авторизации проверить совпадает там эм си си на 6011 тут задача приложение будет заключаться только в том чтобы смочить фильтр и понять и совпадает они или нет если на миссии в авторизации фильтры совпадают значит мы считаем что filters начался значит это ступенчатая комиссия к этому счету действительно применимы все что нам необходимо сделать здесь после этого это получить счетчики из редиса то есть мы формируем вот это составной ключ определенным образом но и к примеру вот мы понимаем что мы получили зрителя счетчик 98 тысяч рублей то есть мы вот-вот уже приближаемся к нашему стотысячную лимиту что должно будет сделать приложение приложение должно будет взять размер авторизации допустим вы хотите снять 10000 рублей вы должны будете взять 98000 прибавить с ним 10 и это значение счетчика 108 тысяч рублей записать вреден при всем при этом вам нужно желательно но нежелательно для того чтобы нормально работала вам нужно указать время жизни этого счетчика вы должны будете явно указать когда эти щечки дорамы про x парятся собственно вот вы должны будете взять его из дата выписки все после того как вы получили og вот редисом это означает что счетчик был сохранен ваша задача как приложение заключается в том что вы должны посчитать сумму превышения 108 тысяч рублей минус 100 тысяч рублей до 8 тысяч рублей вы смотрите в тариф понимаете что два процента умножаете одно другое и понимаете что эта комиссия 160 рублей ваша задача здесь ответить и митинском хостой сказать все классно с этого джентльмена пожалуйста еще 160 рублей и митинский хост за халдир uid нужную комиссию со счета клиента а в случае например если у клиента было ровно 10 тысяч рублей и он пытался эти самые 10 тысяч рублей снять у него это не получится потому что ему не хватит денег на комиссию в таком случае митинский хвост откажет тем самым вы откажете на эту операцию то есть клиенты будет недостаточно средств но и все ваши фродо вы и кексы с которыми вы имели дело вот эти все снятия 20 миллионов рублей без за халдира ваной комиссии они все тоже улетучатся потому что теперь вы халдир уйти комиссии по авторизационный ну как бы поздравляю вы великолепно вы победили этот кейс спустя три года потому что вот всю механику которую я здесь примерно показал все это была за пелена в нашем приложении 2018 году в 2019 мы оказались в продакшене ну и собственно спустя три года ваша система считает абсолютно все комиссии в банке которые есть таким же самым образом всякие там округление в инвиз копилку если вы их подключили какие-то центра банковские ограничения короче вообще все что есть все делается в вашей системе и делается это за средние две миллисекунды тут я постарался не набрать по большому счету вот если приглядеться то конечно спустя три года 99 персен силе всех операций у нас иногда вываливается за 5 миллисекунд а иногда бывают операции которые занимают и 30 миллисекунд тем не менее по большому счету это мало кого уже волнует потому что к этому моменту ваша система использующая рейде становится плюшевым ключевым объектом процессинговой инфраструктурой и по большому счету всех уже мало начинает волновать за сколько вы отвечаете то есть средние две миллисекунды нокии классно с этими ребятами все понятно ну а то что у вас президент на пятьдесят гигов памяти в одессе ну это как бы скажем так мало кого волнует это уже наверное немного не относится к тому что рассказываю тем не менее редис тоже не панацея у редиса тоже есть некоторые определенные проблемы с которыми вот прям мы например сталкиваемся например пятьдесят пять пятьдесят гигов резидентной памяти тоже своего рода проблема потому что свое время мы в январе этого года решили прийти к нашим в vr админом из и сказали слушать а можно вот давайте мы попробуем использовать виртуалке они рассказали во сколько вам надо памяти на скале у нас уже есть пятьдесят гигов а еще когда редис у нас марковица то нам нужно еще столько же давайте 120 гигов на скале нет давайте нет ну и все ладно по поводу всего того что здесь написано приходите к нам на стенд мы еще вам и не таких историй по на расскажем давайте мне нужно уже немного заканчивать я немного последнюю минуту попробую пофилософствовать то что я рассказывал вам здесь это не rocket science но общая идея такого что иногда вы можете оказаться в довольно консервативной отрасли а банкинг и processing от довольно консервативный отрасль где например не слышали ничего про поздравь а у нас везде кругом oracle но это так к слову и вы здесь можете выстрелить и выступить на эффекте низкой базы то есть когда в целом у вас все такое довольно консервативнее к можете применить какое-то свежее решение довольно простое не примитивное а простое и это простое решение будет работать и что самое удивительное она будет помогать зарабатывать деньги бизнесу потому что вот все эти истории которые рассказывал я не могу раз деньги не могу раскрыть детали этого самого продавать кейса но конкретно вот эти вот 100000 100-тысячная комиссия которая я здесь рассказывал и приводил в качестве примера сейчас мы таких комиссий халдир у им на несколько десятков миллионов рублей ежедневно соответственно это те деньги которые банк зарабатывает по горячим простым решением которые вы когда-то начали использовать все в принципе у меня все я готов ответить на ваш вопрос спасибо большое слушай но это прямо практически какая-то магия взяли и сэкономили несколько сотен миллионов рублей в день тимур от организаторов тебе небольшой памятный подарок как говорил у винни пух вот тебе прекрасный горшочек это не горшочек и мешочек друзья мои я немножко объявлю о том что к сожалению у нас время вопросов в на сцене выше один вопрос да окей давайте так один вопрос из зала потом перемещаемся в цифровые кулуары там продолжаем задавать вопрос и за лучший вопрос тиньков который будет и здесь их цифровых кулуарах соответственно тимур выберет его потом по результатам всех вопросов тимур вручить подарок прошу здоровский тимур спасибо за доклад мне очень понравилось на самом деле я языкам пойти меня зовут jr я тоже когда то писал эти врут систему у нас поэтому не тема очень близка и вопрос такой вот вы сказали что у вас и счетчики на основе которых и антипов аналитику строите что вы делаете если нужно считать много разных срезов то есть нужно много счетчиков на каждого клиента ну то есть десятки на самом деле даже сотни по нашему опыту это вот сотни счетчиков как вы это обсчитывать и если у вас такие кейсы спасибо доклад очень классно реальная и архитектура мне понравилось спасибо вся проблема заключается в том что мы ninja fruit системы и не стараемся как бы и быть фактически мы не являемся у нас есть отдельные ребята которые занимаются этим родом и фактически мы стараемся не отбирать и не хлеб то что мы занимаемся это мы занимаемся расчетам комиссии фактически если так получилось что вот мы теперь начали быстрее рассчитывать комиссии и победили какой-то фрод но она так получилось как бы царём возвращаясь к собственно к вопросу вот механизм счетчиков которые есть это единственный механизм который мы стараемся использовать ничего сложнее у нас как бы нету единственно у нас есть то есть если нам необходимо например иметь счетчики на целиком на клиенте такое тоже бывает когда у клиенты бывает много счетов это тоже накопительные счетчики то есть вот самый последний пример при наступлении когда случилась война на украине cb ввёл ограничение снятия действий рублей они тоже распространялись целиком на клиента и на все его счета окей мы имели те же самые накопительные счетчики таким же самым образом хранили их в одессе только мы брали все аккаунты соответственно наших аккаунтах есть ссылки на то что они принадлежат тому или иному клиент сколько счетчиков на клиента сколько счетчиков на клиента я могу сказать сколько их всего скажу сколько всего 13 миллионов значимых спасибо большое друзья"
}