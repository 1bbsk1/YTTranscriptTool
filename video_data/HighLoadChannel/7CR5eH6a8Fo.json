{
  "video_id": "7CR5eH6a8Fo",
  "channel": "HighLoadChannel",
  "title": "Базы данных и Kubernetes / Дмитрий Столяров (Флант)",
  "views": 58064,
  "duration": 3326,
  "published": "2018-11-19T02:47:38-08:00",
  "text": "значит всем еще раз при ну и последняя 1 от я являюсь технически он и учредителем plant и сегодня я вообще я люблю вызовы и сегодня я решил что нужно рассказать с моей точки зрения очень сложную тему тему про базы данных и губернатор откуда вообще взялась эта история дело в том что и нам как компании флант и мне как дмитрий столяров у очень много раз задавали там совершенно в разных вариациях мне кажется что это в основном был троллинг но но в разных вариациях вопрос а можно там базу в докер сначала было потом а можно базуку бернетт ас и каждый раз мы отвечали вот примерно так в целом да но и вот это вот в целом и на хранит под собой такое количество нюансов особенностей красок оттенков которые но невозможно изложить там в кратком текстовом сообщении дам невозможно изложить в 15 минутном разговоре не подготовленным и именно поэтому я решил попытаться вам сегодня рассказать о том можно ли или нельзя ли более того вопрос на самом деле несколько шире и тот вопрос который я сегодня расскажу звучит вот так можно ли state в кубер нет ну то есть база все понимают это частный случай сразу два вопроса которые у всех возникают вопрос номер один зачем нам стоит в фку бернетт ос этот ответ очень простой если отбросить эксплуатационную сложность самого куба докера и всего что внутри то с точки зрения использования cabernet с нам принес простоту и удобство и когда мы хотим запихать туда states мы рассчитываем мы внутри не ожидаем что это нам принесет простоту и удобство а о каком стоит full идет речь потому что стоит вала может быть много разного да давайте сразу определимся прежде всего это конечно наша любимая реляционная база иной сквер база тут показаны не не все варианта показаны там характерные представители значит так же это безусловно и memory хранилища также это безусловно очереди бизнес безусловно все очень жены я бы сказал что вот этими пятью штуками в абсолютном большинстве проектов там так или иначе мы обходимся чего здесь не хватает не хватает еще отжиг старик же потому что не все живут в паблик клаудов где есть нам из коробки какой-то с 3 а есть люди которые живут там или встраиваться где этого нет или вообще набери металле и ну с файлами приходится работать их нужно где-то хранить хранить удобно и нужно джек старый еще один момент который там активно появляется постоянно это сервис discovery в разных совершенно проявлениях или какой-то configuration is to reach который нам тоже нужен и в целом вот этими уже семью пунктиком я бы сказал что мы покрываем там добрых 80 процентов того что нам нужно того что нужно нашим приложением понятно что есть еще кучу другого софта понятно что есть потребности иногда в нашем коде в нашем приложении с собственный state какой-то хранить но я сейчас сконцентрируюсь на вот этих случаях и попытаюсь вам рассказать о том как это делать или как это не стоит делать в кубер нет и если я сейчас попытаюсь вам просто рассказать кейсы типа ребята делаете вот так и будет хорошо или делаете вот так будет плохо мне кажется результат не будет получен потому что решение очень много и все их рассказать нельзя из моей точки зрения гораздо важнее понять почему что-то можно делать почему что-то нельзя делать какие основные принципы откуда все это идёт и куда все это идет и для того чтобы это понять хочется поговорить прежде чем смотреть какие-то конкретные кейсы хочется поговорить о трех вещах первое о том как вообще губернатор строится высокая доступность второе какие гарантии согласованности дает губернатор согласованности консистенции если мы говорим про базы данных снова консистенции у нас всплывает одним из первых и какие возможности для стороже есть cabernet соответственно доклад будет так что я рассказываю те три части а потом перехожу к примерам с объяснениями буду говорить очень быстро потому что у меня как всегда там 250 слайдов и ну я стараюсь очень много информации рассказать им не всегда сложности со скорости ok философия высокой доступности в купер над все знают эту аналогию питомцы против стадо все понимают то что губернатор эта история из мира стадо все понимают что там классические базы данных эта история из мира питомца но давайте посмотрим в деталях как же она выглядит если мы берем классическую историю например с моей сквером то у нас обычно есть два сервера 2 железки у которых есть зарезервированное питание зарезервированная сетка зарезервированный диск там стоят mais quel стоит какой-нибудь тёплой вт настроен разумеется репликация поднятой api адреса и есть главный айпишник на который ходит клиенты обычно для того чтобы быть совсем уверенными мы родным рядом с этим еще инженера который если чем может прибежать поменять диски ставим вокруг стену охранника огнетушитель видеокамеру танк для чего для того чтобы быть увереными что наш процесс мы искали не упадет потому что он для нас ну но не то чтобы священный но мы всячески стараемся не допустить того чтобы что-то произошло с нашей базой и отказал у нас диск питания все вместе нам вроде как неважно мы мы под флагом у нас инженер побежал поменял все хорошо это вот мир мир классический что у нас в кубе r'nessa купер нити у нас обычно больше железок они обычно проще у них нет резервировать питания у них нет резервированный сетки с тем нюансам то что сама сетка губернатора считывает что сеть надежная но подключение одного просто не имеет значения то есть мы можем терять хосты мы не можем чтобы это допустить чтобы это все развалилось это ожидание кубера там не очень отказа устойчиво и надежно и железо есть софт который развеет поверх этого который все эти машины объединяет в некоторый кластер и дальше в этом класть или у нас живут но контейнеры но только в купер нас живут не контейнеры а под и я думаю что в судя потому что уже половина людей там знакомы с купер нету сам понятие под уже все знает на просто группа связанных контейнеров я их рисую вот такими зелеными штуками с со стручком гороха потому что под это стручок из нескольких связанных контейнеров так вот у нас есть контейнеры и если у нас что-то происходит с узлом то задача кубер нет с от детектив то что узел пропал понять что контейнер сдох и запустить новый instance на другом узле то есть у нас вся отказоустойчивость делается софтом и какие есть механизмы башни и в губернатор прежде всего это контроллер и их много но основных 2 это deployment и стоит fools and deployment это контроллер для стоит вас приложение стоит в сэд из названия понятно да стоит ву за что они отвечают в них лежит вся логика давайте репликации дублирования резервирования контейнеров то есть вот когда у нас узел ушел и контейнер стал сереньким именно контроллер отвечает за то чтобы под создать новый экземпляр кода который отправить на другую тачку второй важный механизм это под анти affinity смотрите я нарисовал коды каждый на своей машине почему потому что для этих кодов настроен анти affinity им сказано мы не можем вдвоем быть на одном узле это дает нам гарант того что если с узлом что-то происходит понятно да у нас падает только маленький кусочек и третий важный механизм хорошей это под destruction budget о чем идет речь смотрите если мы пойдем и попытаемся устроить month and so например выключить вот этих два сервера не с ними что-то плохое произойдет да а мы осознанны попытаемся нам не знаю надо их поменять еще что то скажем выключаем а и если для показанной связки настроен под destruction budget который говорит что нам нельзя гасить больше одного кода за маской вернет сделает следующее он не два контейнера убьет сразу он убьет один удалит создаст на другой и только потом сделать то же самое на со вторым контейнером то есть о чем идет речь в кубе ли есть все необходимые механизмы для того чтобы управлять группой контейнеров и обеспечивать на уровне группы отказоустойчивость то есть если мы возвращаемся к первой картинке к аналогии питомцы стадо у нас есть все инструменты для управления стадом и так старый подход новый какие у нас выводы основной вывод что в кубе есть мощный фундамент второй важный момент что конечно же требуется совершенно другие подходы потому что но в первом случае у нас основной expectation был что у нас процесс москве ли запущен всегда во втором случае у нас ожидании того что мы можем мы можем свои ловится да ну и третий момент что надо понимать несмотря на то что сам губернатор рассчитывает на не рассчитывать на надежность узлов если мы туда пытаемся загонять стоит у приложения мы же не можем делать так что нас мой склероз 10 минут падает и при запускается на другой . никому от этого хорошо не будет потому что невозможно сделать без простой на эту историю что она будет перерыв там на какой-то период поэтому конечно же для стоит в проложив важна надежность узлов топик номер два я сразу извиняюсь я сейчас как бы все дальше чем дальше тем жестче будет гарантии согласованности в губернатор смотрите если вы мы возьмем классе куда как она была раньше ну или как оно есть сейчас у нас есть все те же самых два сервера с москве рим и на них есть тёплой вт а один из серверов мастер 2 ст имбой то есть пачка бы kind of есть балансиры есть пользователи пользователи ходят балансиры балансе рыбакин дыба кендо в базу но сама этом на и классич низшая архитектура что происходит есть и к нам приходят большие сетевые ножницы что происходит если к нам приходит network card shining причем он может же проявить прийти куча разных способов то есть может быть просто мастер сервер оторваться может часть сети оторваться но вот в данном случае как на картинке у нас keep-alive который неправильно настроен который конечно же поднимает мастер айпишник и снимает readonly во второй базой и возникает ну как бы классика сплит brain беда трагедия ну я думаю что все знают все были в этой ситуации а как бы как мы с этим боремся классический дамы вместо keepalive доставим какой-нибудь карась inkspace мейкером который образует корку форумный кластер и дальше этот q расинг делает leader in action говорит что это база мастер это база стендбай настраивает репликацию ну и собственно клиенты ходят также в мастер но если происходит network card shining ну или какой-то другой отвал узла до происходит две вещи одновременно во первых вот этот узел который отвалился который потерял связь с остальной частью кластера который потерял кворум он всячески пытается самоубийца да он снять пытается снять если там доступ айпи адрес пытается убрать этот ай-пи-адрес если там не знаю майский базовом пытается привести you were done it is он всячески пытается защититься от нарушения целостности данных и тоже часть кластер а оказывается в очень неприятной ситуации она не знает что произошло с тем куском который был мастер а потому что ситуации могут быть разные если там прибило по питанию ok а если там просто повис процесс красин к и там мастер продолжает работать айпишник продолжать доступный туда продолжают ходить как быть нам нужно удостовериться что этого узла точно не стало мы не можем становиться мастером пока не удостоверимся это вообще ну как бы сам этом больная проблема всех этих историй и для этого есть механизм fencing а я думаю что все знают выглядит он следующим образом мы пытаемся как-то ту машину внешние убить до способы могут быть разные от похода выпьем а и выключения машины блокирования парта на свече управления умная розетка если это облако обращения копья и облака с задачей выключить виртуалку и так далее так далее так далее в общем подход это называется финском то есть нам нужно удостовериться что эта машина точно все что ее точно нет и только после того как мы удостоверились мы поднимаем у себя там снимаем в базе редон не понимаем поднимаем айпишник и начинаем принимать трафик клиентов вот как бы так классический работает отказоустойчивость стенд сингл мастер бастан о тех бас которые в которых мастер может быть только один и ну там со всеми вытекающими историями а ну вот собственно именно этим механизмом обеспечивается это мост wynn's гарантия которая ну и и создает нам can системность как с этим дела обстоят в губернаторы как такой же сделать губернатор с одной стороны очень просто с другой стороны очень сложно смотреть я уже говорил что в кубе есть разные типы контроллеров есть контроллер который называется deployment есть контроллер который называется стриптиз от и нато их едва что они ведут себя совершенно по-разному картина следующая если к нам приходят большие сетевые ножницы и отрезают нам узел губернатор детектив то что этого узла не стала и deployment контроллер видит а мне сказали что должно быть трипода а у меня доступна только два создам к я новый эта логика поведения до playman контроллера а логика поведение стоит вот это совершенно другая он видит то что кода не стала и он горит подожду подожду чего есть всего 2 варианта или этот узел вернется или нам скажут его убить и именно этим ну как бы делает сайт мост vans гарантия получается то что кумир просто стоит вот эти не перед создает контейнеры не когда он гарантирует нам что без ручного решения без без привлечения оператора ничего не произойдет вот этим обеспечивается гарантия понятно что если эта тачка действительно оторвалась от сети там есть приложение там есть база данных от приложения может продолжить писать и нарушить consisting то есть этот вопрос в целом там он его надо решать отдельно но базовый подход такой что есть специальный механизм стоит вас от который вот обеспечивает эту этот мост vans гарантию но также требуется fencing для чего но понятно да то есть чтобы автоматически разрешить эту ситуацию нам нужен какой-то механизм который придет и скажет да этой но ты точно больше нет все мы ее прибили это может быть или оператор ну или или какой-то автомат какая проблема с фен стингом спиннингом две проблемы первая ну его достаточно сложно сделать потому что нужно просто сделать кучу-кучу-кучу реализации если в облаках это там еще раз ходили выпи а еще как-то то на бирме то ли сделать дженерик имплементацию сенсинга сложно но главная проблема не это а главная проблема в том что fencing обычно убивает узлы медленно например обращение к пи ай может занятым или обращение к и поймаю может занять там секунды или десятки секунд или минут и если у нас узел отвалился и мы его добиваем и мы ждем минуту для того чтобы свело верить базового понятно да у нас простой в минуту этом но мало кого устраивает мы все живем в мире когда мы рассчитываем там на простой при файл avi rip миллисекунда или там в секунду но не в минуты а но есть другой взгляд на эту проблему как можно обойтись без сенсинга и я это буду показывать невку бернетт asiana квадратиках классических серверов но потом мы переедем с этим же паттерном в купер нету смотрите вся та же самая схема есть две базы и давайте представим себе что мы их настроили в режиме но не мульти мастера а мая скверного multimaster ада циклическая репликация и давайте представим себе что у нас есть load balancer и непростой load balancer а очень хитрый лот баланс вещь с объясню в чем хитрость смотрите боккен доходит в него not балансир отправляет трафик в базу но этот он балансир can системной он может атомарного выключить весь трафик и он с защитой от там сплит брейна от network портишь энинга соответственно если мы хотим перекинуть трафик на другой сервер если мы хотим переключить мастера делается это примерно следующим образом мы горим лот балансер выключи connect и от балансер нам говорит я выключил после этого мы на стенде и дожидаемся что нам дали тела реплика и говорим от балансер включи connect и понятно что тут здесь ей в любом случае при при переключении москве ли будет некоторый простой при переключении пожгли со будет некоторый простой но вот балансер нам гарантирует can системность я не нашел термина да потому что это паттерне очень распространенный я вот его решил что корректно будет называть consistent switch over да вот consisting и переключение а но сразу возникает вопрос что это за чудо такой лот балансир как его сделать дженерик так чтобы он работал и в кладах и встраивать ее ну вот на всех тех вариантах на которых ставятся cabernet и общая идея следующая можно рядом с приложу хами поставить прокси кстати необязательно ряду с пазухами сейчас расскажу варианты и не просто прокси a proxy которые собирают кавур умный кластер точно так же как у нас к расинг собирал к он умный клана кластер прокси которые собирают форумные кластера тем или иным способом там способов реализации много и каждый прокси принимает запросы от своей своего приложения и отправляет в базу если к нам приходят сетевые ножницы вот тут самый важный момент у нас есть два серверов 1 партиции 3 сервера в другой партиции два сервера потеряли кворум и они тут же закрывают свои соединения вот основная логика вот этой концы стильности потеряли связь с кормом закрыли connect и гарантированно а при этом с учетом того что весь трафик ходит через проксю если самой проксей что-то случилось не знаю прошел о вам киллеры убил да мы не потеряем can системность у нас просто прокси пробьется мы но она как-то перезапустится да и его становятся единения а в этой части кластеров в той в которой кворум сохранился у нас тоже ничего не работает но мы можем прийти и перекинуть трафик и не поломать не поломать связанность после того как мы трафик перекинули понятно что у нас два бэк отдают пятисотке 3 отдают нормальные ответы но это уже разрушится на балансе рах совершенно другими механизмами если мы network card shining проходит сетка возвращается 2 прокси по цепляются к форму видят у нас уже новая задача перекидывают как мы переключаем трафик сказали отключится отключилась дождались репликации пущу подключилась собственно реализация к естественно савичева хочется что сказать что эти прокси могут состоять не обязательно со стороны apple кушак они могут стоять со стороны баз данных они могут стоять как отдельный слой это не так важно да где они стоят там просто разные истории сладости получается потому что если они рядом со нюансы как бы не важно и но вот этот паттерн позволяет обойтись без без fencing а и обеспечить can системное переключение в standalone базе теперь у всех наверное возникает вопрос а где такая штука есть где работает об этом я расскажу в конце презентации о том какие такие готовые решения есть но вот основной посыл в том что вот этот паттерном позволяет как-то a truly вать ситуацию и ток в кубе рн эта си есть встроенная работающая семантика it most lanes нет сенсинга его можно сделать но сенсингом вообще как с механизмом есть проблемы и очень не хватает там разнообразных имплементации consist in свечи вора в купер нас есть внутренний load balancer там есть такой примитив как сервис и они не не концы стены и они никаких гарантий не дает о хранении данных cabernet основной механизм хранения данных cabernet оси эта штука которая называется network блок девайс ну там классический сондо в совершенно разных имплементация если мы говорим про панель клауд там есть свои варианты если про правят клауд нам свои если про там или правят клауд там есть ну для любителей распределенных систем surf а так разумеется обручена и scozia как это выглядит у нас есть губернатор и под просто подключается к сетевому диску ну как бы да на практике это что означает что губернатор монтирует этот сетевой диск на ноду аноду пробрасывать в контейнер дальше если мы узел куба отправляем корректно в maintenance то губернатор гасят контейнера удаляет его с машины пытается его запустить на другой видит то что ему нужен диск при этом от монтирует диск монтирует туда подключает и все работает все классно то есть у нас есть как бы из коробки механизм подавать перекинули понятно что с простоем но но как бы он из коробки есть если приходит отвал узла магии не случается потому что ну этот конфликт конфликт нужно ризал ведь опять вспоминаем fencing вспоминаем всю эту историю но мы можем прийти замочить машину сказать купер нету все это машина нет и тогда он перекинет перекинет контейнер дальше но но но но это же сетевой диск а у сетевого диска есть некоторые latency и давайте посмотрим как это выглядит случае с базой данных смотрите если у нас в серваке есть локально стоящая на мишка то время доступа к диску там очень маленькая примерно 100 микросекунд если мы купили очень дорогое железо из могли выносить вынести n вами я сторож за пределы сервера сделать удаленным то там время отклика будет чуть больше но чуть больше если мы используем commodity а из казино community это 2 там дорогой хорошее железо но если мы используем рассказе по 10 гигабитной сети пусть у нас даже там в хранил кунапе ханны хорошие очень быстрые диски относи будет что-то типа миллисекунды если мы в амазоне то там документации вообще очень классно сказано типа если вы используете оптимизированные под ввод-вывод инстанций то вы можете достичь single digit нам bros как бы ну понимаете в общем как бы формулировка в стиле в стиле что нам это дает пока не очень понятно смотрите давайте pdf ки с источниками презентация в печатном виде я понимаю эти ссылки ним невозможно прочитать давайте допустим что у нас есть база которая требуется 50000 чипсов это достаточно нагруженная база я бы даже сказал что это очень загруженная база на и если мы ее поставим в первый вариант конфига нам достаточно всего пять рядов для того чтобы утилизировать то есть мы можем в пять потоков при таком land and sea при таком от насти мы можем пять потоков выдают выжать эти 50000 iops во втором варианте нам нужно уже семь с половиной потоков третьим в пятьдесят четвертом 250 понятно же это не потоки это эта степень параллельности ввода-вывода дано нам нужно читать писайте в первом случае в пять потоков во втором в 250 потоков для того чтобы выжить 50000 руб софы то что означает это означает что практически любой вор клауд мы берем и ставим в первый кейс и он заработает и это означает что практически никакой workload не заработает в четвертом кейси за вычетом определенных случаев при определенных настройках в определенных ситуациях и понятно что чем больше лотность и для диска несмотря на то что у нас диск сам 50000 чипсов и дает но это и опция не настоящая поддельные опция и вот вот это вот поддельности abs of она очень важно и и ну как бы загруженную базу бухнуть на и блеск в амазоне ну никак не получается что для этого делает губернатор у него есть второй вариант с тораджа который называется local storage по сути это просто локальный жесткий диск с возможности его подключать о чем идет речь у нас есть просто под с базой который использует директорию на железке на ноги на самом деле там все несколько сложнее мы изначально кубинцу говорим что вот на этом узле у нас есть вот это директория ее можно использовать а под уже говорит мне нужен около 100 речь и планировщик отправляет под на эту машину и навеки туда прибивает если мы эту машину отправляем в ментоне нс губернатор выгоняет оттуда все коды а этот оставляет потому что он навеки связан с этой надо ему понятно у него там локально данные лежат соответственно планировщик кубовый учитывает всю эту историю и ну решает вопросы понятно что если к нам приходят большие сетевые ножницы мы ничего сделать не можем мы должны идти чинить машину на но то же самое у нас была в классике если у нас есть ну как бы один надежный сервера он отвалился мы идем че немого а оба эти варианта называются ри drive lancia быстро объясню что такое но я думаю что всем понятно сетевое блочное устройство невозможно подмонтировать в место есть она у нас уже подключена в одной мы попытаемся 2 под подключить но это физически невозможно вот есть это возможно она короче не будем об этом да это не возможно для того чтобы нам сделать второй диск нам нужно второй диск и второе подключение в cabernet съесть из коробки возможность для стоит сэтов задавать шаблон создания волю move соответственно когда мы например стоит setpos келим до трех узлов у нас автоматом создастся волю разумеется пустой разумеется наш софт уже должен ему как-то наполнить да если это база данных он должен откуда-то там я не знаю скачать дамп там настроить реплику центра до но механизм с заказа волю move есть встроенный и прекрасно работает если нам нужен рыть rhythm и не то в случае с public клаудом у нас есть дверь реализации случае sbm этом у нас есть две реализации для любителей распределенных систем я думаю что здесь есть такие но это не все и по сути в железные истории у нас остается единственный единственная возможность делать reader отмене это in office и выглядит это вот так тут специально не нарисованный базы данных тут нарисованы паха пышные приложите подразумевается что вы базу для баз данных вам не нужен ретро отмене это какой-нибудь confluence который не умеет работать с общих с оружием ему нужно вот сетевая папка как бы на все узлы примонтирован ну например на ok какой вывод по этой часть вывод следующий во-первых в гранате все идеально среды от vans есть варианты на любой вкус и цвет и для любого вида инсталляции и все хорошо ими можно пользоваться нужно пользоваться все вопросы на данный момент решены что касается network file system но при драть менее ну как бы основная мысль в том что старайтесь избегать но это просто архитектурно неправильно да все кто там проектирует приложение высоко доступны знают что работать с париками нельзя можно работать со джек с торгом почему ну потому что сделать пусть к совместимую систему распределенную надежную и доступную can системную ну ни у кого не получается там вроде получается но не совсем а все с как бы основами разобрались давайте посмотрим теперь что из этого какой фарш и нас из этого получится дадно то есть на самом деле фарш на нам нас интересует уже конечный результат какой конечный результат из этого получится кейс номер один это standalone смотрите что нам мешает взять и например по загрыз запустить просто в standalone режиме никто она мешает взять mais quel и просто запустить на standalone режиме с локальным сторожем никто понятно что у нас не будет высокой доступности тут речь не идет о высокой высокой доступности хотя она же могут быть железки достаточно надежными у нас могут быть не знаю будем воровские виртуалке и может быть так что нам этого достаточно и ну знаете как бы все говорят там про высокую доступность надежность и так далее так далее так далее а вот у кого такой вопрос к аудитории только честно ответьте у кого база сама файла верится по-настоящему автоматически 1 2 56 да то есть а у всех остальных нет это мне кажется люди думают что у них файла верится недавно не проверяли ну как бы смысл последующей есть множество случаев когда нам не нужна высокая доступность прежде всего это конечно всякие стринги и девы и так далее а во-вторых сейчас микро сервисный архитектуры у нас много есть каких-то вторичных микро сервисов которые могут влечь спокойно на 15 минут ничего с ними не будет ими пользуется там только кто-то внутри сами потом поднимутся я закончил говорить про standalone ну понятно что если как бы приходит какие-то проблемы с узлами у нас все лежит пока мы не решим этот вопрос как это выглядит в реализации в кубе нас я уже говорил что есть титул сет соответственно мы создаем сайт full set из одного кода просто на него направляем внутренней кубовый балансир куб при этом выдает там внутри нее даем доменное имя москве и у нас просто приложите пользуются этим и сквидом как бы там не смешно было дано это абсолютно жизнеспособный вариант и он реально ну как бы прекрасно работает с моей точки зрения у него нет минусов в сравнении с тем чтобы воткнуть также москве льна просто виртуалку вот если вы его втыкаете на просто виртуалку кладите его в купер на дцать разницы никакой ну объективно понятно что это не только моя сказать понятно что это любые сингл мастер базы но и вообще в стан д'олоне что угодно можно поставить практически любой софт работает вариант номер два репрессирована я пара с таким ручным переключением как выглядит у нас есть титул сердцем опять примерно москве ли но он работает с другими решениями и обратите внимание что он называется не майской москве а и у нас есть сервис который смотрит на этот стоит фулл сет из одного единственного пода дальше у нас есть 2 state in set который называется майский альба и он обращается к имени москве а получает айпишник и реплицирует там самой обычной москвиной репликации у него может быть тоже свой сервис персональный для случая на надо будет репликацию перевернуть или для случае если мы решили настроить циклическую репликацию плюс у нас есть сервис на входе самый обычный кубовый который отправляет трафик на 1 стоит full set при этом ну понятно что продолжение пользуется при этом если к нам приходит какие-то проблемы с узлом на котором стоял кусок который называется а их специально называю а и b потом уж не понятно кто из них мастерством байда в какой момент это а и b 12 до но не а и b чуда не происходит разумеется мы ложимся но у нас есть копия на которой можем переключить трафик или мы можем пойти починить узел и и все живет важный момент что эта штука работает в ней есть нюансы какие нюансы если мы хотим переключить трафик то нам нужно сначала вот этот сервис который балансит точно также выключить от него запросы на на на наш москве а и после того как мы выключим запросы на самом деле не выключаться а потому что губернатор балансирует и 5 был сам там контракт си пышные соединение он не разорвет то есть нам нужно зайти в этот мой склеили по прибивать соединений удостовериться что да точно все отключилась и только после этого перевернуть репликацию наверное зайти и да ну то есть на мой скальп этом настроить реплику с ну короче в обратную сторону и только после этого отправить трафик на на второй узел а если в этот момент переключения у нас кластер губернатора развалившийся есть отвалившийся узлы ни в коем случае этого нельзя делать на нужно сначала разрулить сетевую проблему только потом перекидывать рай потому что это некая системный свеча вор ни разу но это вариант который нормально работает если у вас сейчас есть две виртуалке два сервера с мастером из там баян это абсолютный еквивалент если у вас нет автоматического переключения а мы выяснили что автоматическое переключение здесь есть у человека так 10 15 из не знаю 300 500 так вот это абсолютный кинолент классической инсталляции для сингл master system работает для майской для под колеса для редиса центра и центра кейс номер три масштабирования нагрузки на чтения на самом деле читерский кейс потому что это ни разу не стоит вал потому что ледовую нагрузка на гормоны не совсем стоит он выглядит следующим образом есть у нас база данных которая где-то снаружи она может быть также в купюрницы но оно за пределами той истории которую обсуждаем ничто нам не мешает сделать ферму с своих серверов да есть пачка нюансов специфичных там для каждой базы да потому что общий механизм такой что при запуске подал руку вернется есть такое понятие нет контейнера нет контейнер видит что у нас на диске ничего нет у нас новый instance он лезет в базу и как-то получает данкану помощью дамб без повода снять не сможем в москве лесли одни решения для горячей дамб в полисе другие может быть мы берем дамп ну много нюансов да ну если вам нужно создавать слайды то вас вы знаете как это делаете вам нужно просто этот функционал перетащить в куб и и он заработает второй момент нам нужно быть уверенными что этот instance не отстал сильно от мастера в cabernet и есть лояльность пробы которая умеет чекать состоянии узла и добавлять удалять его из балансировки до соответственно мы можем написать нам достаточно простой скрипт который говорит охрана этот instance у нас остается там на 5 секунд своего от рубай понятно что если прилетит там conti огромная транзакция с мастера у нас все отшибет но эта проблема не губернатор считает губернатор здесь не причем на ну и мы просто создаем сервис который балансирует по этим узлам соответственно в нем будут добавляться удаляться контейнеры по мере их готовности и наше приложение на чтение ходят туда на запись туда прекрасно работает прекрасно работает не только с моей сквере могу привести пример ну такой достаточно популярный это сфинкс если у вас нет динамически обновляемый сфинкс имею виду сфинкс search да обычный сфинкс который отдельно работает индексатор подготавливает яндекс и потом запускаются инстанции который его сервер прекрасно работает такая схема можно добавлять удалять викенды более того если мы в каком-нибудь claude это можно делать авто скейлера мда то есть нас приходит трафик у нас такие пункт пинг пинг добавились узла трафик ушел не пунктом пунктом свернулись шикарно кейс номер 4 умный клиент смотрите если мы возьмем и сделаем советовал сад из трех мышей то в кабинете есть возможность создать сервис специального типа который вместо того чтобы балансировать запросы создаст каждому коду по своему домену соответственно имя имя но has no ему неважно имя имя хоста будет связана из имени сервиса плюсами не повод для 0 будет и msi 0 . memcache это и так далее и если у нас умный клиент который сам умеет sharding репликацию почему бы это не складывать губернатор прекрасно работает примеры такого умного клиента простите лежат у нас под носом . если мы говорим про хранение сессий вот он из коробки так умеет там достаточно интересно сделано на мой вкус то есть он на каждый запрос сессии отправляет запрос его все бакены получает все ответы и выбирает просто самый актуальный и также делает на запись ну соответственно когда там один узел отвалится ему ну неважно там под тайм-аут короткий он будет отстреливаетесь запрос по таймауту когда узел вернется он будет опять в него получать запрашивать старые сессии с других узлов новые понимать что это старая не использую это новая использован в общем умный клиент который умеет сам шарлин комплектацию прекрасно работает главными нет ни главный а почти главный почти самый главный кейса то клауд на этих решения смотрите у нас есть большая пачка которая далеко не заканчивается вот этим решение которое клубный тифы подколодный тиф я что подразумеваю что они изначально ориентированы на там выход из строя узлов и они сами умеют делать failover есть у них мастер локшина и не нужен мастер лишь но они сами это разруливает у них есть у самих recovery узлов да и у них у самих есть какие-то consistent гарантия они могут быть очень разными в некоторых случаях они могут управляться вами в настройках некоторых случаях они могут управляться в клиентами в запросах да но они разруливают очень большой класс решение сейчас берет и разруливает вот эти вопросы сам все они всегда ставятся просто стоит full set находят узлы друг над друг друга и образуют кластер и magic и все работает отличаются тремя вопросами во первых вопросом как узлы узнают друг о друге если мы говорим например пробитым киум к нему есть плагин который умеет ходить по пику бернат находить соседей и образовывать кластер если мы говорим про чтобы я вспомнил кого на dns discovery построен какой интересен где by по-моему на один оси диска варится губернатор меет группе сервисов выдать один домен который разводится в пачку ip-адресов соответственно на многие клад на этих решения умеют строить discovery соседей на dns и статически если мы говорим про звуки про например там просто в конфиге прописываются все узлы ну все соседи в кассандре сиду злы у нас может быть кластер встретил сайт с большого количества подав мы указываем что первых 3 обратись к ним они уже друг друга помнят у них встроенный сервис discovery может использоваться сторонний сервис коварный пример сейчас будет доклад про ковку и на наверное нам докладчик расскажет о том что кафка используется кипер до для до сервис discoveries ответственность звуки перу нас тоже стоит cabernet со статическим с отсутствующим service desk avorio кафка использует звуки пир в общем различаются все эти варианты тем как узлы узнают друг о друге второй момент чем отличается как подключается клиент есть кейсы когда достаточно поставить лот балансир клиент может подключаться к любому злу если он жив ему обработает request есть случаи когда как в manga да нам нужно клиенту сказать все хвосты и это прекрасно поддерживается губернатор третий момент который отличается как делается горизонтальное масштабирование первый вариант оно не делается не как и есть немало там клад найти в решении которая клауд на этих но не горизонтально масштабируемые и это нормально и это для многих ситуаций абсолютно достаточно есть вариант как в кассандре масштабируйте хоть и масштабируйте есть вариант как манга деби масштабируйте но сложные с нюансами то есть там но если кто манга тебе работал вы знаете там масштабирование треплет кассетами то есть там добавляются реплика сета и как только мы хотим шарди там еще дополнительный компонент нам все несколько сложнее ok общая мысль следующие кстати тут перка на экстра тебе кластер который тоже по сути клоун этих он сам отрабатывает фил образ он следит за консистенции все эти решения хорошо работают в кубер нету почему потому что они вот вот вот в этом вот так оттуда они изначально оптимизированы под под подставную часть они изначально к этому морально готовы их не делали специально для cabernet сада но они шли тем же путем и поэтому они хорошо ставятся хорошо работают используйте ну все хорошо история номер шесть главные заключительное а есть решение которое называется стол он и его смысл заключается в следующем вы смотрите это название до подагре сквер клауд не тихо и вы любили ti в этом названии очень много речь идет о чем о том что подрезкой он из мира питомцев клауд на этих это мир стада и стол он это то решение которое превращает пост гнезда в стадо но позволяет под весом управлять вот этими паттернами давайте посмотрим как она выглядит во первых для стол на нам нужен сервис discovery лучше всего идти сиди там есть другие варианты не будем на этом останавливаться для того чтобы сделать из сиди в кубе у нас есть третий сэт 3 узнаю нашли друг друга синхронизировали кворум вот это все все хорошо дальше у нас есть еще один стоит full set собственно сползали сам но не просто с после сам а с компонентом стол о на который настраивает этот взгляд и ну как бы рулит им и этот компонент подключается 5 сиди и получает оттуда данная как настраивать postgres есть компонент который называется сентинель rides in t 0 до мы услышали смысл тот же это компонент который следит за конфигурация кластера и логика такая сентинель решает кто будет мастер кто будет стендбай и так далее и пишет витязь и de aqui пир читает идите день и говорит а вот мой instance мастер соответственно его настрою как мастера а там мой инстанция тест имба я его настройках с тумбой и и и ночную реплицироваться то есть вот эту часть a true ливает кипер дальше есть прокси и вот это тот самый прокси который про consistent свечой это прям вот имплементация от того паттерна с концы стенным переключением эти прокси подключаются кити сиди и если connection у практике ты сиди оторвется прокси сразу обрубает входящее соединение для того чтобы обеспечить потому что он не знает может быть этот сервер уже не мастер может быть он уже стал байда как только порвались вот вот вот этот паттерн и прокси соответственно знают кто мастер отправляю туда трафик на входе перед проксиме стоит самый обычный кубовые лот балансиры проложения ходит туда получается то что мы превратили питомца до в стадо почему потому что ну тут любой компонент можно убивать все работает и у нас нет там завязки на узлы на технологии за пределами контейнеров и на данный момент я не знаю реализации вот этого паттерна для москве или для редиса для чего-то другого кроме пожгли со но из того что я вижу пожалуй это единственный способ вообще сделать что-то с сингл мастер базами и именно по этому пути там сейчас все пойдет все значит давайте посмотрим что получилось раньше у нас была картинка с крепостью теперь у нас вот такая вот навороченная штуковина в которой черт ногу сломит хочется там возникает вопрос там а стоит ли а нужно ли возвращаемся к теме доклада на а может на базу в cabernet сюда конечно можно но вот так да конечно можно в некоторых случаях важно другое важно куда все идет все знают что технологии развиваются волнами такими вот волнами волнами изначально любая новая штука она очень сложное в использовании на первые радиоприемники когда появились там за того что поймать волну надо было сейчас нет ради при радиоприемников час яндекс музыка да но сначала появляется технология потом она становится простой в использовании то что то к чему идем к тому что да она останется вот так же сложно внутри да это будет прекрасно работать но мы об этом не будем знать мы будем говорить нам позарез у нас появился просто in point в который ходить который нам обеспечен необходимый уровень гарантий в кабинете активная эта тема развивается называются операторы пока их мало они не супер хорошая но все это идет и должно прийти на этом у меня все немножко рекламы немножко рекламы с месяц назад мы релизнули плагин чик графа не статус map если не сложно плюса нити называется пользуясь моментом очень полезная штука посмотрите может быть еще многие знают мы пилим dub за полгода мы очень сильно рванули тоже плюса нити теперь вот окончательное спасибо за внимание подписывайтесь на наш фабри и на youtube это был прекрасный дисциплинирует эйтан танец это твои подарки интером не да это тебе книжка которая ты подаришь за лучший вопрос у помощников друзья если есть вопросы магните вот они уже лесу уже с микрофоном до пожал этого я этих людей знаю давайте слова сооснователем не даем микрофона до мкада released не от пожалуйста да это да здравствует метро еще раз то что вы игнорируете куприн эти сообщества не значит что она будет игнорировать волос как бы принесли я не слышу а то есть слышно да вот я говорю еще раз то что вы игнорируете купер на эти сообщества московская не значит что нам будет игнорировать вас собственной поехали поехали к вопросу и так чтобы обеспечить нам жизнь с базами данных кубер нить из там нужен либо stone либо fencing ручной труд по переключению реплик перестанут волю мои проблемы с и up some и далее далее по списку а теперь вопрос а зачем нам это надо кроме как для быстрой раскатки stay j потому что на виртуализации все это прекрасно живет годами уже отработано люди умеют с этим жить и кушать я начал доклад со слов про удобство и простоту я абсолютно согласен с комментарием что далеко не все случаи сейчас приносит удобство и простоту проблемы с опциями есть также на виртуалку моя задача была показать картину в красках и тонах я не говорю что ребята давайте все переезжаем всем стоит валом в губернатор я говорю что есть вот такие возможности идет вот туда и ну куда она идёт тестировать его роль этого я не буду конечно вот и еще мой маленький вопрос а вот ребятенку вы лично пробовали где-нибудь в амазоне кластерам вот да и как вам дошло до понравилось да ну там есть нюансы основные нюансы в том что надо правильно настраивать х поле силу очередей но он работает добрый день спасибо за да здравствует пардон я здесь направо направо от входа прям очень важно опроса секундочку у нас просто не с тобой сервака я сейчас взяли да супер важная лекции я очень надеюсь что кто-то об этом расскажут и это прям моя боль и нынешний год и я бы хотел спросить и и будут ли примеры реализации то есть я так понимаю этой ссылочке они по всем вещам которые вы описали там будут прям для губернатор речь идет а армиях готовы в конфигах да да да зная эти паттерны до написать питомников не проблема если надо вы если вы это организуете я буду просто ну мы подумаем об этом спасибо теперь можно и здравствуйте и спасибо за доклад очередной мне очень ваши доклады нравится но сейчас по конкретно по последнему кейсу вопрос cockroach слышали как роуч тебе послужить если postgres хочется то cockroach в принципе в кластер теоретически есть еще по сгрыз xl но мы слышали ну как бы в интернете написано но по сути вот последний кейс очень хорошо crotch решает извелась то же самое для мы искали есть перк она x 3 db мы его не только слышали мы его юзаем в пройдено небольших нагрузках он отлично работает ну ясно спасибо можно можно мне вопрос вот я здесь вот битва танцпола давай данного вопроса на самом деле первый open service broker пробовали ли вы об интерес брокер это средство получения базы данных ну и слегка не твоей но в твоём к вернется ну а какие service broker i can системные но amazon там все с но это же как бы менеджер тебе просто так обернется я не понял вопроса окей хорошо и обсудим тогда потом и второй вопрос в схемах много говорили пробовали ли вы и может быть вы уже пробовали может быть нет вообще то есть еще один вариант это когда у тебя сторож отделен от компьютер и у тебя компьютер работает как бы твой пот до работает отделена отделена от старриджа и тебе вообще не нужно решать проблемы там с мастерами и репликации вообще ни с чем потому что если умирает компьют надо ты и возрождает подключаются к старриджа и у тебя все продолжает работать но и там есть время failover естественно когда на то время когда умирает компьют надо и сторож переподключается вас есть сейчас готов я об этом кейсе мне показалось то что я об этом рассказывает рассказывал он дал он или это что это с тандемом там есть время свеча и в некоторых клаудов можно может быть нормальный fencing ну она она просто пуховик pajar вел делите она может и 4 детки давайте себя время свеча быстрая то есть я не понимаю чем она лучше или хуже чем она хуже чем у нас есть время на структуру позволяет туда ну ответ такой да если инфраструктуру позволяя небо то что это можно сейчас реализовать набирать не реализовывали еще такое вот прямо у вас есть пруд на standalone не который хорошо работает ну куча ну прод на стенде лоне я говорил о том что для многих продав того уровня доступности которая позволяет выдает базовая инфра достаточно да это рабочая тема вот мы люди саму только слову стажеры и зови то есть вопрос пусть люди за мой можно я слышала ты говорил что для вас гри знаешь вот это решение его показал для мускулы не знаешь а тебя чего не говорит такая штука как москве любит с ну вот и актом интернет я считаю их ты считаешь что она не подходит или в целом да я просто не капал в деталях просто у них прям есть официальный мануал как все это дело вот ровно в такой же схеме наку бери вот и они как раз на ту а схема такая же да она очень близко вот потому что я описывал и выглядит так что это вот прямо один в один давай попробуем nokia те напишу авито один последний вопрос нет все вот хорошо скинемся на каме ножниц кто задаст вопрос возник комментарию мин таре и да да спасибо большое за доклад я хотел сказать что я сегодня буду рассказывать в 4:00 про реализацию 5 connected by кластер в кубер найтись и как раз так же интересно то приходите полевка сэра спасибо а вот тогда вопрос быстро из заканчиваем идем дальше да пожалуйста добрый день говорили про то что горизонтально нельзя облик сторож ну там пример меня был как решаете проблемы ну не использовать меню использовать цех в случае с отдых сторожем ну или шортить руками но потому что как бы закончить заканчивается место в одном меню заводим 2 ну так же как и раньше решалась друзья нам надо вручить подарок книгу общему кому книгу за вопрос подарим кому книгу за вопрос подарим мне кажется слились до задающий вопрос а больше лежали побежали побежали тогда мужик или можно коллеги который в 4:00 выступает смотри вон not он не ушел да да да да спасибо данная схема великолепных срыв так эксперта спаси большой дмитрий друзья аплодисменты улюлюканье спасибо большое"
}