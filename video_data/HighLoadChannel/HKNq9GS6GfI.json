{
  "video_id": "HKNq9GS6GfI",
  "channel": "HighLoadChannel",
  "title": "Обработка голоса кодеком на Си под Андроид? Сделано! / Константин Цховребов (MobileUp)",
  "views": 722,
  "duration": 1328,
  "published": "2017-05-17T12:52:28-07:00",
  "text": "здравствуйте сейчас константин скобрев расскажет нам про обработку голоса кодеком на сипадан droid пожалуйста я приветствую как сказали меня зовут константин да есть компания bae лап и я с вами поделюсь как как я дошел до такого что не пришлось обрабатывать голос пользователя до кодеком уже написанным на си и все это запустить в андроиде и мой доклад и вообще как всегда кладу да сама полезно это делиться каким-то опытом собственно и вот у меня этот опыт возник из того что я на свою беду или на свою радость тяжело сказать решил поучаствовать в конкурсе в прошлом году который устроил павел дуров поводу telegram а вот и так даже вышло то что я там занял первое место и это был интересный опыт я не стала бы продолжать участвовать третьем этапе 1 2 участвовала и ну и расскажу почему вообще ее особенность а в том числе и технический вопрос так но перед тем как перейти к всему этому делу пару общих вещей чиж такой интеко не часто встретишь ну не то чтобы не часто да многие android разработчики просто своей практике редко встречают необходимость разрабатывать нативный код вот достаточно бывает использование sdk и соответственно и написание кода на джаве для решения каких-то вполне типичных задач под android но тем ни менее возникает ситуация когда нужно и необходимо использовать в нативный код либо самому писать либо чужой и для этого google представила не детей который позволяет этот код собирать под различные мобильные платформы и взаимодействие с ним из java и так когда может возникнуть такая ситуация во первых сама специальным случае это использование уже написанного кода огромное количество библиотек реализующих те или иные задачи написаны на оси и это наверное самый распространенный кейс когда может понадобиться детей второе это низкий уровень работы бывают такие ситуации то что dalvik нам не может дать каких-то какого-то уровня доступа к устройству и нам необходим опускаться ниже ниже на прямой работы с драйверами и с железом далее не самый типичный кейс тем не менее он есть это скрыть ее реализация для приложения которые последнее время достал популярные темы это защиты информации приложение банковские еще какие-то если там все реализовывать на джаве да есть большая вероятность того что найдутся школьники на попу до которые все это быстренько де компилирует и скроют то чего то не хотел показывать если это будет сделано достаточно просто но тем не менее да будет гораздо сложнее это сделать есть это реализовать нативно и окулировать уже написаны готовыми решениями и опускаться нативного кода далее порой можно сделать общее ядро и реализовать нативным кодом для того чтобы его переиспользовать на разных платформах в том на разных платформах в том числе android и айос бизнес-логика 1 приложение разные насколько я знаю так работает приложение спите файл которого логика там перетекла из доступной версии вот такой кейс и наконец последний кейс но тем не менее которое насколько я знаю чаще всего упоминается припоминать дикей это производительность даже google начинает зачем нужен детей для того чтобы повысить производительность но надо понимать важность что реке это не магия если мы захотим ускорить наше приложение то не совсем не значит что если мы перепишем сейчас какую-то часть нативно носи то у нас приложение начнет летать нет в первую очередь конечно надо посмотреть свои приложения и понять вот не такое лиану потому что есть продолжение тормозит надо задуматься об архитектуре и во-вторых перед тем как переписывать что-то нативно надо задуматься потому что многие вещи в андроиде уже реализованы нативно среди них ты курсор и отрисовка на канвасе и многие другие и возможно если вы напишите свой велосипед он будет медленнее того что сделали инженеры android так вот теперь к реальной задачи конкурсе была задача за две недели можно сказать написать реально работающий telegram приложение мобильный под android но слава богу не полностью с нуля уже была готова ядро которое занимается взаимодействием сервера серверном и так далее это библиотека предоставляется но тем не менее одна из задач это было записать голос пользователя до голосовые сообщения его сжать и сохранить файл для будущей передачи в через чат так как я этим никогда не занимался это меня сначала поставила в ступор и главное что специфика конкурса да у тебя времени вообще нет никакой архитектуры ты должен пилить быстро чтобы работала и чтоб еще не падала то есть тут такой опыт очень стрессовый приходится выкручиваться и конечно я полез смотреть вообще какие кодеки есть возможно не надо ничего придумывать в условиях конкурса было сказано что я должен использовать опус и его классе контейнер g когда я видела джеб одному во что-то знакомы пошел википедию да и среди самых популярных кодеков то на первом месте mp3 потом оси дальше идет кодек в arbee's и даже меня порадовало что он есть в андроиде начиная там вроде как с пятой версии может быть скидка то но тем ни менее как потом выяснилось счет бюджета просто контейнер а кодак именно в аргос а нам нужен кода корпус который проект который запуск кода который выигрывает в arbee's по многим параметрам вот здесь среди этих кодеку все можно заметить кода can be sick которые самом конце насколько знает его skype использовал ему возможно щас ещё использует для своих голосовых звонков вот а теперь что же такое опус skype начала 20 новый кодек после ой беседа назвал его silk есть такая некоммерческая организация xiv которая занимается разработкой sensors решений в сфере всяческих медиа том числе кодеков и они взяли свои наработки кодек и кельт взяли наработки skype silk и выпустили не так давно относительно того же кодек mp3 да выпустили кодек опус вот первый рейс был двенадцатом году и мне кажется это одна из причин почему он не такой распространенный а потому что мне кажется он должен стать очень устранена кодеком есть посмотреть на следующую карт график с официального сайта этом графику настороженно различные качество сжатия в зависимости от битрейта и лидера не сложно определить вот видно что опус практически на всей широте битрейт и скорости того как быстро кодеки сжимают входящий сигнал и опять же видно что в opus побивает огромное количество других решений что делает возможным его применение краски в задачах онлайн голосового общения и тут можно сказать что это неявное намек на то что в телеграме да когда то появятся голосовые звонки и об этом много чего говорится и вот тут есть косвенные доказательства это что именно кодек который для этого предназначенного рассказать тут используется немного общей информации по коду корпус здесь стоит обратить внимание в первую очередь на скорость кодирования она всего можно занимать детства не миллисекунды зависимости от настроек конечно широкая полоса битрейта которая может кодировать и одно из там главный один из недостатков mp3 до что у него все два канала может быть а в опусе этих каналов может быть 255 вот то есть вам идеальный кодек для обработки звука далее сохранении воды g как я сказал это мультимедиа контейнер и тут большого выбора не было пока контейнер класть потому что именно джиджи гриф разработала для того чтобы складывать в этот контейнер медиа данные обработаны их кодеками вот поэтому файл сохранится в джей без вариант то все библиотеки в open source и все мы можем скачать даже возможно как кажется что сейчас соберем положим проекты все заработает но как жизнь показывает нельзя просто так взять и что все заработало такого не бывает и далее я покажу такую практическая hold у для людей которым возможно предстоит с этим столкнуться и почему оно вообще появилась потому что мне очень не хватало мне приходилось прям гуглить из там напрягать все силы чтобы выудить эту информацию по шагам что сделать чтоб она чтобы кодек извелись так поехали на чем самых понятных простых вещей скачаем интеко скачаем с официального сайта вопросам кодек также дополнительно комментарий и утилита для складывания все это вот g после этого создаем стандартную папку с проектом не забываем указать лог all properties путин т.к. далее рядом с папкой java нас появляется папка джиной the same папку в которую мы сложим все наши нативные исходники которые будем собирать вы такую библиотеку после этого то чего самое главное наверное фишка которую надо знать это то что мы должны указать в грабли прямо что путь к исходникам мы должны поставить пустым вот как видно да у меня джиной source и ничего не указана потому что если этого не сделать то проблема в том что android studio попытается сама собирать а нативные исходники а у нее этот функционал очень ограничен был я в конце скажу про новый android судью который было представить всю недавно но тем не менее вот в той которая была до 22 все было с этим не очень хорошо и нативные исходники собирать придется через командную строку ну и тут же мы указываем куда где будет надо искать собранной библиотеки для того чтобы уже скомпилить android-проект как я говорил женя им распаковываем все скачанные ресурсы и для того чтобы собрать чтобы ndk занялась сборкам сборкой ресурсов нам надо сказать и говорили два файла один не обязательно апликэйшен . у нее есть несколько параметров я для примера показал да что здесь можно сконфигурировать под какие платформы будет собираться исходный код и второй файл это главный файл android м каяться и сценарий сборки нативного кода полную информацию по этому файлу можно найти мне очень понравился сайт который так и называется android.mk там без лишней воды конкретно какие параметры нужно указать либо в официальной документации гугла и я пробегусь по основным флагом который нужно сконфигурировать для того чтобы все получилось итак в начале мы должны указать local паз в котором будет происходить сборка и очистить все внутренние переменные после этого козы и модели которым мы собираем тока на выходе будет называться наша библиотека в моем случае этот файл следом идет конфигурация самой сборке здесь мы указываем флаги для session и сборки для си плюс плюс сборки откуда эти флаги эти флаги берутся из воздуха мы берем из официальной документации по кодеком которые используем по каждому коду к есть большие много какой флаг где использовать и соответственно копаюсь них надо выводить тут не все и большое количество и с помощью них мы конфигурируем сборку ну как примера могу сказать да тот же входы корпус его можно собрать с флагом будет он работать с численность по высшей точкой лишь фиксированный соответственно от этого зависит качество и время сжатия также мы можем указать различные флаги для разных архитектурном снизу это видно показано далее необходимо прописать пути ко всем заголовочных файлов и также точно найти все session и и файлы которые нам понадобятся при сборке проекта после этого мы говорим сборщику что мы хотим собрать с а библиотеку добил shirt libre который мы будем использовать из android приложения и если у нас все звезды сложатся да мы вызываем в папке джина и команду ndk build ждем чтобы все привет без ошибок а так говорят ли произойдет и на выходе у нас получается файл . и со собранный пакет платформы который нам который мы указали вот такое бывает редко я на самом деле перед презентацией буквально вчера попробовал все это пройти и у меня появились ошибки не понятные на первый взгляд непонятные я начал избирался чем дело оказалось то что коды корпус обновился буквально пару месяцев назад да готовился я конкурс в конкурсе участвовало ниши вот они выпустили новую версию кодек он обновляется очень активно и они давали какую-то видеотеку я честно говоря неси разработчик я в этом не силен на я прочитал они включили в библиотеку не он который оптимизирует сборку session авокода под рем архитектуру я ее подтянул тоже она подхватилась вроде как сборка прошла вот но и потому что на этом этапе надо смотреть на все ошибки которые появляются консоли и уже по опыту пытаться идти на них решений у нас получилось собранной библиотека но как же с ней работать до многие слышали про такой штуковиной она не одна в своем роде но тем не менее она сам растворенный и удобно пользоваться на есть детей вот это такая прослойка между java кодом и нативным кодом простой представляет собой интерфейс для взаимодействий в одну и в другую сторону в нее есть аналоги я их практически не знаю но я прочитал то что главное преимущество джина я этот он то что изначально разработан разрабатывался для двоичной совместимости то есть такой совместимости что наш код будет работать на любых платформ без необходимости пересобирать его это речь идёт не только одолевает машине до виртуальный но и вообще про дживы так каракозова тут женя и отжимка у нас работает на огромном количестве различных артист архитектур у нее отсюда х расцвета двоичном бинарная совместимость каково жженой работа заключается двух шагах то что мы описан дрова интерфейс в котором методы помечаем сауны этих и в этом же интервью в классе в интерфейсе мы отказываем указываем что подгружаем статичную со библиотеку и второе мы создаем session и файл в котором реализуем эти методы вот в этом файле у нас должна в зависимости от жена я и хитро именования этих самых реализованных метров чтобы было понятно вот я привел такой пример да есть у нас интерфейсе есть нет в год лэнс то соответствие в его реализация по правилам джина и мы должны прописать полный путь к этому методу включая пакет имя класса в котором он описан и так далее вот и также при лиза цемент у нас будет доступны указательный интерфейс и ссылка на тот объект в котором вызван метод то фейса ну и также передаваемый параметр уже дальше идут там через запятую те которые мы хотим воображение говорить можно много как он работает и так далее но это тема отдельного доклада большого в моем случае обработки звука до мой интерфейс выглядел так я создал некоторого пуск helpers те методы которые мне необходимы внизу видно что я указал до статичной подростку библиотеки которые собрал и примерно так выглядят реализация этих методов тут представим этот startrecord куда я подаю путь к файлов который будет записываться записанный звук всё просто как мы реализовали интерфейс надо не забыть добавить новый класс в android.mk вызвать интеко билд и все отлично теперь мы можем прямо из java кода работать с нашей библиотека через тот мир фейс который мы писали а исходник и вообще на самом деле не большая талда который позволяет записывать голос и сохранять его конверте вот же файл до сжав куда корпус можно найти набит боккетти я выложил также немного хороших новостей как многие наверно слышали недавно была google over 16 и там представлена в android studio в которой как они объявили как раз таки лучшая поддержка нативного кода и это не только то что он позволяет собирать теперь нормально прямо из студии нативный код но в том числе мы можем его итиба жить то есть прямо нативном коде ставить beer point и запускать приложения этих при поинтов останавливаться и анализировать что произошло также ну билда проходит я сказал уже и еще из изменений что теперь мы можем собирать не только с помощью ndk которые предоставляет google но и с помощью семейка которые возможно для session их программистов привычнее чем ndk вот и здесь как раз видно что вместо той строчка которая говорил самом начале можно указать путь к android м к файлу и по идее android студия должна все это теперь понять правильно и сама перед запуском общей сборки собрать наши библиотеки вот как то так спасибо и еще пару слов по поводу того что за опыт участие в конкурсе да вот вы говорите про архитектуру провайдер но как показывает мой опыт все проекты делятся условно на три части да это старта перски и проекты которые делаются на коленке ради идея это проекта которые долго поддерживается и вот я открыл для себя ну вот проект который долго поддерживается это там где ты можешь нормально заложить архитектуру и третий тип проектов это участие в конкурсах это особый тип проектов это дар это с одной стороны не стартап потому что же должно получиться качественным его будет проверять тестировать на падение так далее в то же время должен запилить быстрее чем стартап приложения это ценный опыт и я советую попробовать это как-нибудь но в реальности такой код писать не стоит наверное спасибо расскажи пожалуйста ты вот упоминал там много про конкурса можешь подробнее рассказать как вообще проходила разработка то есть какие сроки были так узнал о конкурсе там контакта с того ожидает он начинался 20 мая а концу насколько я помню июня уже должно было быть работающее приложение первый этап конкурса заключался в том что должен быть ну мне показалось сначала вообще полноценный messenger со всеми анимация мисс материал дизайном с онлайн обработкой сообщений с отправкой файлов неподъемные количество задач но так как меня внезапно сводились майские праздники я решил поучаствовать как он проходил у тебя есть описание официальное которая стоит там из 5 строчек приложены должна уметь татата и в конце главное опирайтесь на то что приложена в дополнительно файле в дизайне ты открываешь от файл с дизайном а там у тебя видео плеер там тебя аудио плеер там эти редактирование профиля и ты понимаешь то что ну как бы совсем не совпадает а вот эта строчка то что опирайтесь на то что в дизайне да там графический ключ еще и море всего и видимо он заключался том кто больше успеет и качественной и все заключалась в том что до я там вставал 3 в 4 утра и перед основной либо работаю часто писал код для конкурса вот я старалась конечно не как в архитектур не закладываться написать просто по собственному опыту на той архитектуре который предоставляет система хотя теперь мы от этого все больше и больше отходим те же фрагменты теперь это не фрагменты а в ухе а еще тогда такой вопрос в дополнение расскажи тестирования насколько тщательным там вот было при проверки результатов в чем она заключалась может вообще вся оценка за принялся он то что отправляющий по кашку потом долго ждешь обновляющийся постоянно там почты все остальное даче нектар лимите ты видишь свое имя в списке победителей вот но тем ни менее хорошим знаком было то что меня буквально там за два дня до официального представления дуров добавил друзья я потому что все хорошо вот так как проходила тестирования потом узнал косвенно что запускалась на двух топовых и двух старых девайсах вот ручными тестировщиками эти строчки по всякому пытались порушить приложение и писали рапорты там кто сколько раз упал как я понял мое приложение ни разу не упал а вот отработал так как должно опыт меня не подвел отлично спасибо давайте еще раз благодарим константина"
}