{
  "video_id": "jHYzy6DDo9c",
  "channel": "HighLoadChannel",
  "title": "Как мы сделали ровную балансировку нагрузки на фронтенд-кластере / Юрий Насретдинов (Badoo)",
  "views": 589,
  "duration": 1965,
  "published": "2017-04-08T13:49:06-07:00",
  "text": "Так ну что Всем привет Меня зовут Юрий на серединовка про то как мы сделали практически идеально ровную балансировку нагрузки на нашем кластере так Для начала я бы хотел сказать немножко нашей компании баду мы се представляем социальную сеть крупнейшую в мире социальную сеть для знакомств с новыми людьми и для того чтобы обслуживать то количество пользователей то количество Рекстоне приходит 170.000 в Пике и о том как собственно мы эти запросы распределяем по нашему кластеру я расскажу Так ну кратко о чём я буду рассказывать во-первых я расскажу о том как устроено наш Ну с высоты птичьего полёта Как устроен а роутинг запросов э на нашем сайте потом немножко расскажу какие вообще алгоритмы балансировки существуют а про то как мы делали балансировку до того как мы сделали автоматическую систему а расскажу про собственно эту новую автоматическую систему и какие-то выводы а да Также хотел сказать то что А эта система будет вы выложена в Open Source после этого доклада так вот Давайте начнём с архитектуры для начала Значит на этом слайде изображён путь запроса Когда вы набираете http Bom и соответственно попадаете на наш сайт для начала поскольку у нас больше чем один дата-центр есть система от компании F5 которая называется Global Traffic Man она умеет для разных континентов лви DNS запросы на соответствующий дата-центр потом когда IP адрес уже получен трафик приходит на систему Local Traffic Man от той же самой компании это просто железка которая умеет принимать на себя весь трафик и распределять его по тем правилам которые вы задаёте распределять его по Соответственно по разным кластерам и у нас есть два вида трафика это мобильный трафик и трафик на веб-сайты для мобильного трафика У нас есть ещё отдельный прокси который принимает соединение от мобильных клиентов и держит их он не показан на слайде Но именно Он общается с ксом который уже в свою очередь раздаёт запросы на PHP fpm а для вебсайта ltm а умеет балансировать такие запросы напрямую соответственно всё это обслуживается либо PHP fpm либо же в случае Web - это ngx + PHP fpm Так значит зачем вообще нужна балансировка И что это такое в общем-то если у вас количество запросов на сайт приходит больше чем может выдержать один сервер то в принципе вам нужна балансировка нагрузки для того чтобы распределить трафик по нескольким серверам и также в принципе достаточно очевидно вки распределение нагрузки по тем серверам которые стоят в кэндес серверов нужно чтобы обслуживать пики трафика и тем лучше User Experience потому что как правило время ответа зависит от загрузки сервера и оно тем выше чем сервера загружены А какие есть алгоритмы вообще в целом а я рассматриваю в основном часто используемые алгоритмы балансировки которые используется для балансировки именно веб трафика я их разделил на четыре категории Первый вид балансировки Я отнёс в категорию тупых Ну самый простой алгоритм балансировки - это не балансировать нагрузку вообще то есть у вас нагрузка прекрасно держится одним сервером и соответственно вы просто передаёте нагрузку на этот сервер Потом весьма простой алгоритм это есть когда запрос от одного и того жере лиже от одного и того же клиента попадает на один и тот же Сервер это простой реализации алгоритм и в принципе у него есть большое количество плюсов особенно если ваше приложение Не на PHP но у него есть также очень много подводных камней о которых я сейчас рассказывать не хотел бы это тема отдельного доклада наверное А если хотите поговорим на стенде баду об этом подробнее ну есть очень простой способ балансировки это Случайный выбор сервера он в принципе хорошо работает Если у вас особенно не очень много серверов и простые запросы но возможны всплески нагрузки на какие-то конкретные сервера из-за того что как бы вы выбираете его случайно и может прийти допустим 10 запросов на один и тот же сервер а второму неста это соответственно алгоритм этот алгоритм Более сложный чем случайная балансировка но обладает са самым главным достоинством по сравнению с ней - это равномерность нагрузки То есть если у вас одинаковые сервера и у вас одинаковые запросы то в общем-то вы с помощью этого алгоритма получите идеально ровную балансировку то есть этот алгоритм заключается в том то что вы посылаете каждый следующий запрос на следующий сервер и таким образом достаточно легко показать то что загрузка будет равномерно не будет никаких всплесков а Но жизнь немножко сложнее и на практике такой алгоритм используют но с некоторой модификацией и мы его тоже используем это Взвешенный Рон когда сервера не одинаковы и соответственно А вы должны каким-то образом делать так чтобы больше запросов попадало на те сервера которые мощнее и могут держать больше нагрузку это можно реализовать разными способами например повторять один и тот же сервер несколько раз в обычном раунд робине соответственно чем больше вес машины тем больше повторений а ну и группа группа алгоритмов которые я отнёс к категории грубо говоря умные а которые должны следить за состоянием системы каким-то образом и балансировать нагрузку Исходя из этого например очень распространённый алгоритм который в общем-то исз когда ваш балансировщик отдаёт следующие запросы на сервера с которым установлено меньше всего соединений это тоже позволяет по сути достичь равномерной нагрузки потому что предполагается то что пока соединение открыто тост обрабатывается Ну и поскольку сервера не одинаковые есть модификация этого алгоритма которая учитывает веса также простой Рон предполагает статический а нет вше завешены Рон предполагает статические веса для серверов которые задаются один раз и не меняются после этого но строго говоря Вы можете их менять со временем и это то о чём я расскажу дальше Ну и есть другие некоторые алгоритмы которые тоже можно упомянуть Так значит как мы соответственно распределяли нагрузку до того как мы написали автоматическую систему это делается руками администраторов то есть грубо говоря приходит системный администратор добавляет там 1020 сколько это серверов наш кластер и на глаз смотрит Какой вес ему присвоить на основании частоты процессора количества ядер таймингов памяти и так далее И вот он редактирует который выт Каким образом А ну можно понять то что в общем-то здесь достаточно сложно что-то увидеть А И тем более сложно что-то сделать чтобы загрузка была ровной и вот график за несколько месяцев нагрузки на разных серверах то есть на разные сервера Загрузка процессора показана разным цветом линии разного цвета и можно видеть то что они находятся просто строго друг над другом то есть загрузка стабильная у у разных серверов она отличается довольно существенно вот отличается она где-то на 20-30 Вы наверно Спросите А почему админы не могли затюнить веса руками Ну на самом деле тут причин очень много основная причина - это то что у вас очень большое количество времени проходит между внесением изменений и получением какого-то результата То есть вы можете в принципе выровнять каждую линию отдельно но м нужно будет сделать 200 итераций и обновление не стоит делать слишком часто То есть например мы делаем не чаще чем раз в 15 минут в общем это очень большое усилие и ручная работа которую в общем-то не очень хотелось бы делать Поэтому собственно Мы решили сделать по-другому мы всё-таки когда у нас начал расти трафик на нашем сайте особенно на мобильном кластере Мы решили сделать автомати позво собственно Помимо того чтобы выровнять нагрузку иметь меньшее количество серверов для того чтобы обслуживать в Пике трафика чтобы не упираться в 100% процессора желательно и держать загрузку меньше чем там 75 условно Ну и есть я опять же выделил два основных подхода к тому чтобы делать вообще балансировку нагрузки В смысле не балансировку нагрузки а подбор весов для балансировщика высчитывание грубо говоря какого-то индекса производительности и задание статического веса сервера Ну и противоположность ему на основании состояния системы оценивать Какие веса нужно дать и соответственно выдавать веса в процессе работы смотря на то как она себя ведёт а и вот на этом на этих двух графиках Я попытался изобразить проблемы с первым подходом на левом графике изображено дневное дневная производительность машины то есть мы взяли написали скрипт который грубо говоря прогоняет Некоторое количество циклов нашего приложения и измеряет сколько их было за единицу времени за одну секунду и это гоняется на одном ядре можно видеть то что производительность как таковая ре одного ядра зависит загрузки наст то есть грубо говоря на например процессорах AMD Вы такого не увидите но мы используем процессор Intel в который включена гипертрейдинг и в принципе на графике на слайдах не очень хорошо видно но проседание производительности начинается где-то после 50% но при этом сервер продолжает обслуживать ВС увеличиваю нагрузку и делает это вполне успешно гирен в нашем случае очень хорошо работает мы оставляем включ а то есть что я хотел сказать то что выдать какой-то один вес на самом деле довольно проблематично потому что производительность машины меняется со временем вот и не стоит забывать про то что А многие используют виртуальные машины у которых понятие производительности Аа очень плавающая величина Ну то есть не очень понятно какой вес брать и м к сожалению такой подход Несмотря на то что он очень надёжный то есть там нечему ломаться а нечему выходить из строя он не очень работал в наших условиях и собственно этот алгоритм Ничем не отличается от ручного подбора весов которые собственно должны были админы делать а поэтому после многих итераций мы придумали следующий алгоритм предположим то что Загрузка процессора зависит линейно от веса что в принципе ну должно выполняться в большинстве случаев то есть ваше приложение начинает пропорционально больше есть процессора чем больше запрос секун оно получает если оно конечно в состоянии их обработать и тогда получим очень простою формулу то что мы умножаем текущий вес на какой-то на отношение средней загрузки ПО кластеру на средне загрузка машины Вот И это получается очень простая Линейная формула и соответственно таким образом Стараемся сделать такой в л систему которая бы привёл в устойчивое состояние то есть уменьшил разницу то есть понятно то что когда Разницы нету коэффициент будет единиц и веса меняться Не будут а напомню Как выглядел график но правда трёхмесячный у нас к сожалению нет данных более точных чтобы дать дневные графики А как выглядел график До того как мы внедрили эту систему и вот как стал выглядеть график после То есть можно видеть это дневной график можно видеть то что в принципе за исключением пары серверов которые грубо говоря загрузка на которых скорее похожи на синус чем на что-то другое почти все сервера а там около 200 штук а они слились в одну линию в принципе это наблюдалось постепенно То есть как только мы включили эту систему оно начало сходиться в очень тоненький промежуток и разница между самым нагруженный самым не нагруженный сервером А в общем-то довольно сложно увидеть на графике на самом деле а но у этого подхода на самом деле есть очень много проблем а то есть Несмотря на то что он даёт хорошие результаты А как бы было бы странно закончить э доклад именно на этом и не рассказать о том что с этой системой не так Ну во-первых понятно то что поскольку Вы регулируема такой что машина не справится с нагрузкой соответственно она будет выключена из кластера Если вы если в этом алгоритме есть какие-то проблемы То соотвественно вы можете вырубить кластер Несмотря на то что он способен обслуживать нагрузку потом есть интересная проблема то что этот алгоритм довольно проблематично в ltm и в сам eng то есть наверно в eng можно - это просто закрытая железка которой можно сообщать веса новые веса как-то внешним образом и есть такая проблема то что эти веса могут в принципе не применяться То есть вы даёте системе какие-то новые веса но она продолжает работать со старыми вы продолжаете применять свою формулу и ничего не получается потом отдельная проблема Как удалять машины она в принципе не связа конкретно с ровной балансировкой просто это проблема которая здесь не решается никак И у тма есть ограничение на максимальный вес в 100 и возможно это имеет какие-то проблемы Ну во-первых как сделать из такой вот формулы очень простой что-нибудь более стабильное которое не подвержено перегрузкам то есть ЕС грубо говоря шми % вы на него дали загрузку в два раза больше это не значит то что у него будет загрузка ну то есть скорее всего это значит То что у него загрузка 100% но не факт что он будет обслуживать все запросы корректно при этом А идея очень простая не стоит менять веса слишком сильно за единицу времени в нашем случае мы получаем более-менее ровную линию загрузки серверов если строить одну точку за 15 минут то есть обновление весов должно происходить не чаще чем 15 минут в наших условиях иначе там очень большой временные погрешность из-за неравномерности пользовательской нагрузки получается соответственно мы накладываем ограничение на это коэффициент который мы на который мы домжале не больше 5% к весу каждый раз и поскольку это целое число то значит то что минимальный вес должен быть 20 5% этой единиц и также чтобы не не было ситуации то что грубо говоря кластер не нагружен но на самом деле там например сервер просто временно а ошибается в запросах или ещё какие-нибудь есть проблемы не скидывает нагрузку с тех серверов которые в общем-то в состоянии обслуживают тоже слишком быстро потому что в общем по Тим же причина почему мы не набрасывая нагрузку слишком быстро так вот значит соответственно Что делать если у вас таки нарушилось обратная связь то есть веса не применяются довольно легко понять то что приведённая мной формула будет тем сильнее увеличивает разницу между загрузкой процессора чем больше времени прошло То есть если грубо говоря у вас есть два сервера у которых нагрузка 5% и 50% то сколько вы не будете увеличивать нагрузку на тот сервер который 5% загрузка короче Смысл в том то что если веса не применяются то вы будете видеть разницу которой нет и будете Всё дальше и дальше увеличивать нагрузку на слабые сервера и наоборот не додавать нагрузку на сильные это совсем не то что нужно в нашем случае мы решили проблемы тем то что мы поставили ограничение как на минимальный вес который приходится на одно ядро машины так и на максимальны то есть мы считаем то что разница между ядрами у самой мощной машины и у самой слабой будет не больше чем в три раза и кажется то что это довольно логично то есть зачем держать сервера которые отличаются в три раза по производительности А и таким образом мы лимитирует в случае нарушения обратной связи То есть это не решает проблемы Но если у Вас например меньше чем 30% нагрузка то этот подход будет работать ну и также на об вес ядер просто потому что они не должны быть слишком большие так вот значит ещё один вопрос Что делать если нужно удалить машину из кластера то есть машины больше не отвечают на запросы но Такое возможно в двух случаях если машина перегружена то есть на неё даётся Да слишком много запросов и вторая проблема она действительно умерла и дело в том что когда вы трафика и если у вас вдруг возникнут какие-то проблемы на кластере то скорее всего они будут на всех серверах и грубо говоря просто потому что сервер не отвечает по Хард биту не стоит удалять сервера потому что вы можете таким образом каскадно отключить весь А и В нашем случае мы решили использовать просто информацию которая у нас есть о загрузке процессора в Пике и мы смотрим справится ли система если убрать этот сервер из балансировщика и справится ли она с нагрузкой в Пике трафика Если нет то мы сервер оставляем в принципе этой логики должно быть достаточно для того чтобы у вас не было проблемы с перегрузкой процессора Ну и в общем-то на этом всё что я хотел сказать напоследок Ну для веб запросов взвешены работа очень хорошо по крайней мере для наших запросов то есть когда у вас запрос запросы более-менее одинаковы вам не нужно больше ничего придумывать это работает а потом опять же в нашем случае чтобы подобрать веса статически а нужно приложить довольно много усилий и не всегда этот подход хорошо работает ну и я не привёл цифры для того сколько на самом деле разброс составил после того как мы всё сделали это 2,5% то есть для 200 серверов Мне кажется весьма неплохая цифра то есть разница между максимальной и минимальной загрузкой очень маленькая также мы решили проблему того что админы должны править конфиги вручную Ну и за счёт количества серверов которые у нас есть для того чтобы обслуживать пики трафика нам теперь нужно Ну примерно на 50 серверов меньше что кажется весьма существенным этот балансировщик будет выложен поду по следующему адресу после доклада и У нас есть очень большое количество других проектов которые возможно вы слышали Это PHP fpn pinb и blz но также есть и много более мелких о которых Возможно вы не слышали Это например наш форматер для кода инструменты для аналитики на клиенте под названием G инструмент для того чтобы запускать много параллельно через СШ под названием Go написано на языке го и разные другие вещи например библиотека для андроит избежать утечек памяти Вот спасибо большое за то что пришли я готов ответить на ваши вопрос Добрый день системы с обратной связью они бывает начинают раскачиваться само возбуждаться есть он то бросает нагрузку на машину то снимает с неё то обратно бросает видели ли вы такое Как вы с этим боролись Ну да видели конечно То есть сейчас не очень хорошо работает кликер или я не очень понимаю куда его нужно направлять В общем вы видели на графике где проведена Загрузка процессора то что несколько серверов были вот а были загружены грубо говоря какого-то синусу да то есть они плавали вокруг среднего но при этом они никогда его не достигали в общем-то почти во всех случаях Когда мы это видели были проблемы с самими серверами то есть грубо говоря либо неправильная конфигурация не оптимально конфигурация памяти То есть когда нарушается линейность да тогда и возникает такая проблема но она Ну мы боремся с ней очень просто мы не набрасывая собственно ради этого и нужны эти ограничения а подбирали это чисто экспериментально никакой там математики хитрой не использовали что подбирали скорость изменения веса чисто экспериментально мы не подбирали мы просто поставили изначально вот для одного Ну по-моему для пары серверов были какие-то проблемы Что это было слишком много но в принципе Мы сначала использовали 10% потом стали 5% использовать но в общем-то это работало вполне Здравствуйте меня зовут Андрей У меня есть одно уточнение и вопрос во-первых хочется Уточнить про Рон балансировку да на самом деле она Ну мне кажется было не учтено то что Рон балансировка работает ещё в том контексте когда запросы примерно одинаковые если у нас запросы разные то она не будет совсем работать вот вопрос мой собственно связан примерно со следующим вот все вся аналитика Она вся системная довольно то есть Загрузка процессора загрузка А есть какая-нибудь какой-нибудь фидбэк от самого приложения потому что на самом деле я не верю что в баду все запросы одинаковые которые приходят на на PHP fpm и кажется что только на основе системных метрик как-то строить балансировку Ну не очень получится ну есть Метрика время ответа но мы не основы на ней балансировку потому что она зависит не только нагрузки на процессор она зависит е от сервисов и соответственно если у вас грубо говоря время ответов на на некоторые запросы больше чем на другие это ещё не значит что нужно уменьшать нагрузку на сервер Ну то есть я понимаю да Вопрос хороший у нас в общем-то как я говорил работает вве но поскольку мобильных литов ввм делать-то особо нечего на запросе и к тому же у каждого сервера очень много ядер Вот то есть там 24 логических ядра как минимум И даже если там возникают какие-то неровности Да в обработке запросов за счёт большого количества ядер оно не сказывается на производительности сервера в целом то есть один воркер может действительно начать что-нибудь делать но а всё равно все запросы ограничены по времени очень значительно у нас нет запросов которые больше 10 секунд работают на вебе то есть так или иначе получается что запросы примерно равнозначны все то есть не бывает так что что-нибудь я говорил да что-нибудь пошло там какой-то пошёл трафик который начал нагружать там базу данных и всё затормозила Вот то есть вы никак не анализируйте типы запросов которые приходят и не пробуйте их отправлять там на какие-то менее загруженные или более загруженные кнд в зависимости от того сколько реально запрос времени занимает Ну я писал один пункт мале о том что можно использовать балансировку на основании времени ответа мы пробовали включать на тме и как-то у нас не получилось может быть мы что-то делали не так и короткий совсем короткий вопрос А я правильно понимаю что вот эти вот процессы Да сервер приложений он сам по себе вообще в принципе вос тоже потому что грубо говоря поскольку ppm изолирует процессы друг от друга и они в общем-то не имеют никакого общего состояние Это позволяет масштабироваться по сути линейно на сервер и не заботиться о том что грубо говоря нагрузка может расти Ну каким-то другим образом Да на сервер нам не нужно Заботиться об этом никак Спасибо большое интересный доклад Здраствуйте вы не рассмотрели в докладе э метод балансировки от противного так скажем То есть когда есть некая общая очередь и э кнд сами из очереди Ну как бы вычитывает запросы А да я согласен что я не рассмотрел этот механизм балансировки я не знаю как Аа сделать балансировку http запросов таким образом Ну да да там понадобилась бы какая-то прослойка которая бы запросы удерживала но Ну я просто я скажу честно я не не думаю то что это хороший подход для балансирования именно веб запросов поскольку ни eng X ни там ltm такого не умеет а то есть вам придётся реализовывать руками Да это не очень хорошо вы говорите что вы это не пробовали но отвер Ну как-то наверно не очень правильно Так то есть вы просто не рассматривали просто ну такой вариант Ну мне неизвестно решение которое позволить таким способом держать хотя бы ну то есть распараллелить нагрузку на пару сотен серверов СБО Ну я согласен Есть такой подход когда и вы разгребает эти запросы а но опять же тут возникает вопросы как вы будете обеспечивать равномерное загрузки сервера в этом случае а у меня небольшая дополнение к первому вопрошающий управления там есть ответы на вопросы Как выбирать коэффициенты чтобы не было синусоида Ну и вообще там очень много ответов можно проанализировать систему заранее на устойчивость Спасибо А да И тут как бы интересно то что наша наш алгоритм Да очень простой А и не не оперирует историей вообще никак а то есть у него нет состояния опять же А извините нет состояние у него есть потому что вы изменяете коэффициенты меняется балансировка и тут же меняется состояние текущего сервера всё равно есть временной лаг какая-то задержка это собственно и рождают эти синусоиды я радиоинженер мне это знакомо не рассказывать хорошо Да я согласен то что существуют теории автоматического управление Я даже о них слышал но как вы понимаете вбе обычно всё делается максимально просто из как говорят там из дерьма и палок Да вот и если если какие-то алгоритмы хорошо работают то вижу ничего плохого в том чтобы их рекомендовать даже какой-то более сложной теории нет нет нет нет просто вопрос заключается в том чтобы правильно даже подобрать коэффициент в ваш алгоритм Вы могли бы его не на глаз ставить а просто вычислить нужное значение в нашем случае проблемы с серверами которые загружены в синусоиде обычно заключается в железе и поэтому мы решаем проблемы с железом когда это возникает мы стараемся решать проблемы с железом Здравствуйте Вы рассказали что в пик трафика вы не включаете сервера не Выключаем сервера если отвечают на А если таких серверов будет Там пять если вот они как раз будут выдерживать нагрузку вашу А я возможно не очень понял вопрос К сожалению А смотрите а алгоритм смотрит нагрузку в Пике трафика А и смотрит Какую Ну соответственно Какой вес на этом сервере был и если грубо говоря убрать этот сервер и мы сможем пережить пик трафика то Он убирается а если он упал е сервер упал Ну то же самое то есть он не отвечает на хабит и мы его убираем но тут важное уточнение то что если вы говорили что не убираете если он не может если у нас в пики трафика 100% то мы не уберём этот сервер Да из балансировки но его уберёт сам eng X ltm То есть он не будет на него лить трафик Вот но просто он будет присутствовать в конфиге всё ладно спасибо"
}