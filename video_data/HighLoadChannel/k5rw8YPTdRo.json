{
  "video_id": "k5rw8YPTdRo",
  "channel": "HighLoadChannel",
  "title": "Переезжаем на ClickHouse: 3 года спустя / Александр Зайцев (Altinity)",
  "views": 5831,
  "duration": 2890,
  "published": "2020-04-14T11:39:29-07:00",
  "text": "я вам расскажу сегодня доклад который называется опережаем накликал с 3 года спустя инструкция по выживанию что это значит а значит это следующая не много лет тому назад а где-то три года я вот тоже стояла на сцене правда не на это я в другом зале здесь и рассказывал о том как компания в которой я работал переехала на яндекс crack house и мы тогда слез мило видовым рассказывая друг за другом он рассказал какой клика вас хороший какой не тормозит а я пытался это немножко про верность своей страны что конечно хороший но не очень вот это играли в такого хорошего и плохого полицейского получилось неплохо и сегодня я решил чуть-чуть как бы вспомнить что было там что за три года поменялось насколько click to lose как бы стал другим если он стал другим и рассказать немножко о проектах по переезду накликал из как их можно делать к сожалению это объем огромный то есть нельзя объять необъятное и обо всем рассказать не могу я вот выбрал одну область про который я на хэллоуин ещё не рассказывал и на ней сконцентрируюсь чуть-чуть побольше чем на остальном прям что было три года назад мы переводили компанию на crack house с другой аналитической базы данных как только клика вас вышел open source в или не 16 года начался проект через пару месяцев схожий был прав и в концов на сказать что как бы очень большая была сеть очень большие данные двести-триста было терабайт данных в другой базе данных увлекалась это стало в несколько раз больше потому что стали больше хранить и такая большая-большая инфраструктура поэтому это был сложный проект и я одним с удовольствием рассказал на холоде и через некоторое время мы уже вышли в продакшен вот в процессе этого в марте случилось одно событие которое здесь обозначенного просекам и я рискну спросить может быть кто догадается что могло произойти в марте 16 года что имеет непосредственное отношение к тому что я сейчас буду рассказывать что не новые версии кликал ся выходит чуть ли не каждую неделю я бы не стал на самом я произошло следующая была основана компания tiny tim то есть когда я переводил компания накликал с мне это с одной стороны очень понравилось то есть клик аусат совершенно классная система из не просто приятно работать вот с другой стороны стало понятно что она конечно классная но она сильно не дотягивает до решения enterprise уровня и нужно как бы ему помочь индекс он конечно компании очень сильная но откликалась это их внутренняя проблема внутренний проект которым они в первую очередь будут заниматься во вторую очередь какими-то вещами связанными с комьюнити и с нуждами других заказчиков поэтому мы сделали компании аль денте которая пытается сделать клик aus еще быстрее и еще удобнее для всех и мы это делаем вместе с индексом понятное дело и помимо того что делает ребят изъян акса мы разрабатываем собственные к системные брат проекты делаем поддержку и в том числе обучаем и помогаем построить решение наклюкался так чтобы это работало чтобы вам не приходилось на себе какие-то шишки набивать может быть помогаем их многим избежать возвращаясь к теме как бы доклад мы помогаем с переездом потому что обычно накликала переезжая с чего ты с другого это что-то другой может быть самое разное вы можете пережить mais quel а вы можете пережить смерть и ки с оракла с гринд лама с redshift и так далее мы видели самые разные переезды и они все были успешными то есть если люди начинали остались все задач переехать то они переезжали и это им было после этого обычно хорошо ну прежде чем пережать давайте зададимся вопросом вообще зачем вообще надо переждать накликал кто в зале у кого кликал уже есть можно такой задать вопрос хорошо а кто вообще не знает что такое кликал слава богу таких нет она может быть я не вижу потому что мне слепят прожектора но я надеюсь что таких нету вот actos у кого кликал со нету но он собирается на него переехать то есть у всех остальных они уже использовать лекал замечательно но вообще зачем как бы пережать накликал здесь есть не так много причин самая может быть главное тоже кликов не тормозит вот это просто очень быстрая база данных и она очень быстро на самых разных сценариях вот вторая немаловажная причина то что она масштабируем и то есть можно действительно на какой-то другой базе данных добиться неплохой производительности на одной железки там забил закидать железкой но сколько он сам и его очень удобно масштабировать вы добавляйте сервера ну не так гладко как может быть хотелось бы но тем не менее вы можете расти систему вместе с ростом бизнеса и это очень важно это очень важно что вы не ограничены как бы решением сейчас у вас всегда есть потенциал для для развития следующая немаловажная причина то что она по open source вам не нужно ни за что платить и это как бы все мы понимаем да то есть она бесплатна там можно как представить что есть какие-то скрытые платежи но главное что что вы можете его взять в любой момент поставите на лаптоп постоять на сервер и начать пользоваться как бы ничего не надо низким договариваться об этом и отсюда же вытекает еще свойства квартиру и масти у вас нет привязки к чему-то одному если вы пошли вымазана redshift то с него вы же очень тяжело куда-то переехать откликалась можно поставить себе на сервер можно потом сзади плыть в облака можно уйти в q бернетт с можно войти сюда сюда сюда то есть нету никакого ограничения где вы вообще можете свою инфраструктуру один раз построена эксплуатировать это очень удобно для для всех и это большой-большой преимущество клик хауса которым не могут похвастаться многие другие похожие базы данных и последний я здесь указываю гибкость и с моей точки зрения это тоже уникальное свойство клик хаоса то что он очень гибкий и он позволяет за счет этой гибкости решать задач гораздо больше чем изначально может быть предполагалось и с одной стороны а с другой стороны позволять его расширять и добавлять все новые и новые возможности для решения еще новых задач и эта гибкость это в то что позволяет клика усу опять же не за кук лица в чем-то в маленьком в яндекс метрике в маленькой одна из метрики да а начать развиваться и использоваться все в большем и большем количестве самых разных проектов и самых разных индустрий ну и последнее это сообщество я считаю что увлекалась отличное сообщество если как бы вы были в 3-ем чатике там ходили на митап и вдруг то наверно это знаете это большой drive лёша миловидов всех нас пытается этим драйвом заражать и это очень само по себе предприя приятная такая база данных с приятный такой кармане кармой харизма на харизматичный оба знак так скажем так вот я сказала гибкости и эта гибкость приводит к тому что калле каллас не тормозит в самых разных вещах начиная от того что он может заменять elastic search для сохранения логов казалось бы мы всегда говорили те кто там постарше помнят что логия хранить в базе данных никогда то есть это совершенно неправильно это там моветон и прочее поэтому люди придумали ластиком не стали хранить логика ластики вот оказывается что лунев клика лассе тоже можно хранить это бывает часто лучше чем власти ки например можно там в 10 раз меньше железа взять клика us там если мы говорим о про open source то никакая open source технология из баз данных она не может в принципе с ним по скорости конкурировать там mais quel марии де beko lonestar green клан все они все не сильно медленней чем старше технология тимана тем оно медленнее здесь приведены какие-то случайные цитаты людей вот которые покликал высказывались они все работают в тех или иных компаниях использующих эксплуатирующих клик house уже долго и сделаю сделавших этот выбор осознанно после того как они посмотрели как он как он работает вот есть такая известная статья 60 года написаны по выступлениям года раньше американского математика по моему венгерского происхождения фигнера непостижимой эффективность математике и естественных науках кто-нибудь читал ее знает о чем это что правда никто а вот вижу вижу руку на смысл этой статьи в том что наш окружающий мир вот он почему-то оказывается очень хорошо описываем математическими законами то есть вот эти вот физические законы выраженные в математической форме это на самом деле совершенно не тривиальное нет нет реально то что так можно математика какая-то абстрактная мыслительная конструкция и вдруг оказывается что и природа вокруг нас она может быть описана этом языке это странно это нетривиальный фактами и вот это вот статья она обсуждает вообще почему как это так то есть она акцентирует внимание о том что это очень странно и с моей точки зрения вот в кликал из меня есть такая же странность они с непостижимая эффективность в самых разных аналитической в приложениях даже для которых он изначально не был предназначен возьмем рилтайм до этого хаоса тесте до этого хаос которые данные грузятся более-менее непрерывно и мы хотим от него запросы с секундный лет они сюда чтобы мы не долго ждали пожалуйста это тот с чего клика лась начался и полно примеров тоже из разных областей не только вайп аналитика этой от тех этот фронт detection маркетинга и финансовая аналитика где кликал с именно так и используется это один сценарий споря использованием как он был изначально разработан возьмём другой сценарий time series это мониторинг он строит интернет вещей различные статистика когда у нас идут по упорядоченные по времени достаточно простые события клика вас для этого не был изначально разработан но он очень хорошо себя работает в там серьез и очень-очень большие компания использует клика us именно как сторож для мониторинговой информации лук - мента что я уже упомянул вроде как сбор логов базы данных это плохо да африка усы то можно с некоторыми там комментариями и многие компании используют кликала семена для этого разные разные вещи обычно мы используем специализированные базы данных для этих штук откликалась один может делать все и достаточно хорошо нас такое хорошо что что обгонять по производительности какие-то специализированные решения но есть одно но он то есть одно но который называю проблемы переезда если вы переезжаете накликал с чего то другого ты очень люблю этот слайд то у вас обычно что-то не подходит да вы привыкли каким-то практикам каким-то вещам которые работают в ваши любимые базе данных и вы хотите приехать накликал и обнаруживаете что эти практики они чуть чуть не работают или работают не так насколько он немножко другой то есть он не такой как базы данных которым мы привыкли и он другой с двух сторон во первых вот три года назад и кликал эссе не было вещей которые любой человек который работает с базами данных соску или базами данных считает что это просто обязательна и до транзакции constraint и консистенсии индексы апдейт инала и миллисекунды то есть вот этот вот список это то что вы приходите в вас данных вы ожидаете что это там есть вот три года назад клика оси этого не было как вы думаете есть это сейчас кликала селенит частично правильно так частично есть да то есть что-то вот зачеркнуто это то что сейчас уже как бы не является ограничением индекс у нас появились немножко другие все на самом деле что включало все делается это делается так называемый кликал своей не так как в других базах данных то есть если индекса то они необычные а никак не индексы которые не выбирают и которые пропускают если апдейты дели ты они не синхронные и асинхронные если налы тоником тоже со странностями со странностями если join и хорошо множественные джон не сделали но планировщика запросов клика осень эту как они тогда выполняются вообще как бы не очень понятно людям из базовых данных о мерз джонов вообще нету до сих пор партиции есть ну ладно хорошо что он еще как бы совершенно в сильно-сильно б тест в это состояние вот он так и казалось бы наш кактус вот как-то с которой был раньше мы его немножко подсласти ли сыром но все равно там еще внутри вот этот кактус торчит почти во всем включалась капнуть и можно как бы на эту галочку на эту галочку напороться хотя становится все лучше и лучше и так сыр и все разрастается разрастается разрастается зато в клика оси и есть много того чего в других базах данных совершенно необязательные есть например очень хорошая поддержка для массивов почему вложенных массивов любой вложенности отреагирую щи и структуры данных которые считают что это одна из то что называется helene fischer crack house и несмотря на то что ребят изъян exo всегда говорят что мои данные не хотим агрегировать вот все отреагируют включалась потому что это супер удобная штука материализованные представления тоже вместе вот с этой сегрегирован ими структурами данных позволяет вам делать рилтайм агрегацию жутко удобно кликал sql я выделила в отдельно мы вчера обсуждали как бы его назвать сожалению сетку или уже занят кассандрой вот поэтому называется просто кликая скрыть это расширение языка sql некоторыми дополнительными фичами которые есть только включалась а раньше как бы она была соответственно расширение с другой стороны недостаток сейчас по почти весь недостаток по сравнению со 192 он убран и остаются практически только расширение лямбда выражения я не знаю кто нибудь в какой-нибудь еще базе данных системы выражения может быть есть какой это это откликалась есть лямда я покажу примерчик вот поддержка эмаль но это здесь есть в разных базах данных там в каких-то лучших как в каких-то хуже и открытый код то есть мы можем решать вместе в том числе и вы и и кто угодно сейчас в кликал всего около 500 наверное контрибьютором вот этот вот набор того что есть он как для клика вас очень уникально так вот чтобы переходить накликал с чего то нужно всего лишь три вещи вещь первое это понимать ограничения то есть понимать для чего кликала в принципе не подходит или какие в какие вещи во что там могут упираться второе это использовать преимущества то есть там где кликала сработает лучше лучше работать когда вы делаете например большие сканы до большой кусок данных и агрегируются это его самый лучший сценарий и если можно все вот подогнать под это то у вас будет идеально экспериментировать то есть даже понимая более-менее как работает клика ос не не всегда возможно предугадать когда он будет быстрее когда он медленнее когда он будет хуже когда он будет лучше поэтому лучше всегда всегда экспериментировать возвращаясь к трем с кейсом которых я упомянул это дэрил кондитеру холостым силе ссылок менеджмент они очень разные то есть если для до этого хаоса в общем нам нужна сложная структурированная схема обычная типа звезда или типа снежинка там много таблиц с джой нами с иногда с множественными joy нами и данные обычно меняются то есть они там у нас каких-то еще системах лежат и меняются то для time сивец менеджмент там совершенно другая структура там для time series обычно очень-очень табличка узенько буквально несколько колонок очень маленьких вот это их очень много то есть очень очень много может быть данных с мониторинга они идут обычно каким-то рилтайм стримингом маленькими вставочками поэтому нужно какой-то другой сценарий вставки и запросы с некоторой своей спецификой но тоже просты может быть жены вообще не быть может быть 12 и дана некая не меняются а для логов еще по-другому если малаги хранит у нас плоско очень широкой таблица куда мы храним либо целиком наш лук или джейсон или либо его там на кусочки нарезаем и так далее грузим его обычно большими бочками а ищем по какому полю либо типа full-text search то есть разные разные разные сценарии и я вот вообще хотел рассказать обо всем по чуть-чуть а потом понял что о первом сценарии я рассказывал в год назад а лугах я рассказывал в прошлом году вот поэтому повторяться может быть и не надо хотя там есть много что сказать и поэтому я расскажу только про то им сириус то что я ещё не рассказывал и на самом деле там сириус сейчас один из основных кейсов вот те crack house все больше и больше становится стандартным решением и так что такое там сириус вообще это какие-то измерения это когда у нас есть набор упорядоченных во времени событий на которые представляют измерения какого-то процесса во времени это может быть например температура чего нибудь там количество процессов системе secu usa че так далее вот и больше всего такого рода события у нас раз приходит из мониторинга причем это не только может быть мониторинг небо это может быть мониторинг реальных каких-то устройств это могут быть автомобиля это могут быть какие-то промышленные системы у нас есть люди которые используют лекала для мониторинга производства или для для для чего-то связанного с этим то есть все что вам дает какие-то усики временные с какими-то измерениями это этом серьез и этого сейчас всё больше и больше и больше то есть не только в генерит все больше девайсов генерят подобные данные данные например есть компании которые собирают данные судов на вот свой судно плывет который как как какой-нибудь контейнеровоз и раз в те к секунду или там несколько в секунду там скидывает сотни различных измерений а потом люди смотрят подгони какие-то модели и пытаются понять вообще насколько хорошо там эффективно не использует это судно потому что ты нервоз он вообще не должен простаивать ни секунды то есть и любой простой и так оба потери денег и поэтому старается всегда спрогнозировать так чтобы он максимально меньше у него был простой максимально он хорошо ходил если tomcat какой-нибудь шторма течение то мы туда не пойдем вместо этого пойдём сюда и так далее там очень все всякие сложные вещи вот здесь откликалась тоже используется или я знаю что индекс в багажнике sl driven cars тоже кладет кликал сервер маленький вот и он там собирает все про свою машинку вот и что интересно что вот эти вот специализированные базы данных которые time сириус измеряют их очень сейчас наблюдается рост вот есть такой сайте где г-н джонс нам на котором каким-то образом ранжируется разные базы данных и можно посмотреть по типам вот этот график он выведен по типам и вот самый быстрорастущий типу это как раз ставим серия состоянии все они более-менее плоское еще графические графа вы и базы данных растут а вот там сервис растут на просто очень сильно раз сливать последние несколько лет это именно связано с тем что у нас стало много вот данных такого типа и типичные представители из этого семейства и the influx который используется очень многое и много где это про митоз которой вы наверное вы все знаете kedy by time scale деби построенная на подгрести в amazon есть конечно самого решение и какие там ещё есть вещи откликалась тут тоже здесь может быть использован и он используется и очень много наверное один из пионеров это компания клауд player которая сидел провайдер и они мониторе свой сидел через crack house dns запросов себе запросы с громадной нагрузкой 6 миллионов в секунду них ивентов там все это через кафку заливается в криков как хаос и предоставляет людям возможность real-time дашборде видеть потому что происходит системе comcast большая тоже американская компания сделали аналогичную систему в рамках open source снова проекта apache traffic control если кто-то пользуется и знает вот apache traffic control это такой open source седин систему open source системы управления сидена которая была разработана can кастом и вот они сейчас может быть еще там не запущена и то и дело но вот кликал с как backend для аналитики куда прикрутили а у самого comcast а у них огромные тоже данных это очень дана эта большая сеть там ай ай пи телевидения и прочее там у них объемы не меньше чем у кого-то финансовая аналитиком пожалуйста тоже несколько компаний и даже перка на которые здесь несколько докладов сделали а не внутрь своего перемен конечно же встроили клик house потому что им нужно хранить то же самое мониторинг различных мой скрыли я сейчас не буду останавливаться на бенчмарках это не так интересно всего лишь один покажу который мы делали потому что быть маркер всегда субъективно и все могут сказать что в этом чего-то подкрутили вот мы один раз сделались бы не палка что просто посмотреть вообще кликал из подходит для time series или нет и этот бенчмарк был на на основе того что сначала сделали influx а потом time scale для себя что показать какие они молодцы мы его взяли и увидели что клик house вот на их площадке то есть на их поле выигрывает у них по целому ряду сценарии вот здесь вот он почти везде кроме по моему одного запроса выигрывает на каких-то других запросах он может чуть-чуть проигрывать но этот проигрыш незначительный это кликал из который не оптимизировать никогда специально под такие задачи на чужом popular очень хорошо работает вот какие там есть специфические требования у нас катаем серьез и как их выполняет кликала сам но во первых обычно это быстрая вставка со многих агентов то есть мы должны очень быстро вставить данные и с многих потоков почему кликал из хорошо это делает потому что у него все insert и не блокирующие мы знаем да то есть любой insert это новый файлик на диске а маленькие enter текке можно в принципе зубы фирюза реализовать тем или иным способом не очень хорошо клика оставлять по одной строчки он обижается и мы тоже если вы немножко по большими-большими пакетиками это сделать это уже будет скорее всего хорошо гибкая схема в time series обычно мы не знаем структуру данного до конца то есть можно конечно построить систему мониторинга для конкретно вот это вот приложения но тогда его трудно использовать для другого приложения потому что в другом предложение могут и какие то другие вещи которые надо ну некоторые другие названия другие типы до этого нужно более гибкая схема клика у нас никто не то что он очень строго типизированные база позволяет сделать систему с гибкой схемой обычно в time series очень большой объем данных поэтому их надо хранить максимально эффективно у influx а у них например супер хорошая компрессия это у них основная фишка наверное вот но помимо того что надо очень хорошо хранить надо еще уметь и забывать и делать какой мендон сэмплинг понятно что вам интересно последние пять минут может быть посмотреть прям с точностью до миллисекунд как что-то происходит чтобы словить какую быть проблему или может быть за последний час тоже посмотреть с очень большой точностью на данные месячной давности вам минутная гранулярный может быть уже даже не нужно ли секундная а достаточно какой-то общей статистике чтобы понимать как среднем было тогда и такого рода поддержка она необходима потому что иначе у вас например запрос за три месяца когда вы хотите посмотреть что-то такой общий тренд он будет выполняться очень долго даже в клик хаосе когда вам хочется чтобы у вас и за минуту и за три месяца все было быстро запросы типа last point сны азов это типичная тоже для time сириус вам нужно посмотреть какое было последнее измерение или какое было состояние системы в момент времени t это не очень приятный запрос вообще для mmo для баз данных вот и его надо тоже уметь выполнять и какие-то операции с временами рядами современными рядами то есть там сириус это вообще временной ряд и если у вас есть два временных ряда то их можно как-то между собой соединять икари лилы коррелировать и не на всех базах данных это вообще удобно делать особенно если у вас не выровнены и временные ряды у вас там один с одними временными засечками другой строгими временными засечками а вам нужно как-то что-то с ними сделать вместе как это сделать можно там средние считать какие-то да но вдруг там все равно будет дырка непонятно вот ну начнем со схемы схема ты там сириус можно сделать тремя разными способами увлекался если у нас есть регулярные dune 2 не двумя здесь у нас есть регулярные данные и нерегулярные то есть в регулярных данных мы все знаем заранее в нерегулярных мы не знаем заранее и наверное это более общий случай то есть можно построить систему на регулярных данных для какой-то конкретной одной штуки вот как сделать например club flyer конкретный мониторинг сидена и это жутко жутко хорошо за оптимизированная система можно построить более общую систему который мониторит всю вашу инфраструктуру самые разные сервисы и тогда вы не знаете заранее что вы мониторите вам придется строить другую схему на давайте посмотрим а регулярная схема очень простая у вас просто есть колонки с нужными типами какой тип хороший и я еще чуть-чуть об этом скажу предположим что здесь сейчас флота 4 вот обычная табличка который мониторит какую-то активность у вас в системе по загрузке системы user систем idol найс и так далее и тому подобное очень просто очень удобно но не гибко если мы хотим более гибко на нерегулярные данные мы можем использовать массивы массив кликал оси в данном случае это массив это два массива то есть не стоит структура она представляет собой два массива я бы мог это написать по другому но так красивее то есть массив metrics ним и metrics вэлью я могу хранить здесь совершенно произвольные мониторинговые данные мне нужны только сохранить массив название и массив измерений если хоть чуть-чуть по оптимизировать я могу вместо одного такой структуры сделать несколько одну для флота в другой drain клиентов например потому что int и может быть я хочу хранить более эффективно на но к такому к такой структуре чуть сложнее обращаться то есть мне придется использовать конструкцию от внизу да как так не видно вот это вот это вот то есть каким то образом они каким-то образом через специальные функции вытаскивать значение сначала индекса а потом по массиву но это все равно работает достаточно быстро другой способ нерегулярных данных это можно просто по строчкам такой традиционный способ без массивов вы храните сразу название и вылью и если у вас с одного девайса приходит 5000 измерения вы просто 5000 строчек 9 в база данных в принципе кликала с этим справляется и у него есть специальные вот расширение опять же кликал соску и например макс iv специальная функция которая вам посчитает максимум по метрике при выполнении какого-то условия зачем так нужно можно в одном запросе сразу написать несколько таких выражений и сразу посчитать значение для нескольких метрах например если сравнить эти три подхода то видно что здесь я еще добавил колонку размер данных на диске для некоторого тестового dtc то в случае с колонками у нас самый маленький размер данных то есть у нас максимальное сжатие максимальная скорость запросов но мы должны платить тем что мы все зафиксировали сразу случае с массивами у нас чуть чуть похуже да это все равно еще все еще хорошо сжимается и мы можем хранить нерегулярная схему но тут надо понимать что слегка аскалон ночным базы данных когда мы начинаем хранить все в массиве то она во что превращается строковый баз данных то есть мы платим гибкость и то есть на любую операцию нам придется прочитать весь массив с памятью после этого на нем найти то есть если очень массив растет то скорость деградирует одна из компаний которая использует такой подход они нарезали массивы на танке по 128 элементов то есть они хоть и хотя там хранить несколько тысяч метров но ни в одном массиве а нарезали просто в таблице сделали там 10 или там 30 массивов вот и специальная логика и там подгоняет чтобы сохранить но несмотря на то что это кажется сложным ни одно другое решение для их нагрузок в принципе не срабатывает нам надо 200 терабайт там этих мониторинговой информации в день загружать в какую-то систему с куча самых разных этих девайсов и ничего кроме клик олсен в принципе не подходит они пробовали вот ест роковой строковый это максимально простой подход но не неудобно то что это плохо сжимается вы видите размер большой и когда у нас запросы по нескольким метрикам то получается не оптимально есть еще такая штука как гибридная схема то есть можно оставить массив но дополнительно если мы знаем что большинство наших дашбордов они показывают только юзеры систем мы можем из массива прямо на уровне таблица некоторые колонки материализовать вот таким вот образом и при вставке кликал автоматически как бы их нам посчитает вот и мы можем таким образом совместить приятное с полезным у нас вроде схема общая да но какие-то самые частые колонке мы усиливают вытащили даже не меняя вообще нашли наш injection даже не меня и тел и тел как пишет массивы так и пишет вот или какой-то там процесс который вставляет данные а мы взяли alter ты был добавили порой колобейчик и у нас получилось уже схема чуть-чуть другая более быстрая и мы мгновенно можем начать ей пользоваться вот следующее очень очень важное это кодеки компрессия для то интерес очень важно насколько вы хорошо упаковываете данные насколько они малы место занимают на диске именно потому что массив информация может быть очень большой и увлекался целый набор средств для достижения нужного эффекта а нужный эффект это обычно 1 6 1 к 20 иногда больше то есть ваше не упакованные данные занимают 1 терабайт она диск она не на самом деле занимает 50 гигабайт или 100 гигабайт сильно сильно меньше это очень хорошо и быстрее прочитать и быстрее все с ними сделать так вот откликалась есть самые разные средств начинает лог ординарец и который подходит для строк и дальше различные кодеки для числовых данных дельта подходит для упорядоченного времени крика вас в этом случае хранит разницу между значениями понятно что если у вас идет например каждую секунду вы пишете что-то у вас всегда разница единичка ее можно очень потом легко запаковать добыл дать то он хранит разницу между разниц тоже он лучше всего подходит для каких-то растущих значений какие там счетчики у них более менее разница может не меняться или меняться в меньших пределах и дабл дельта очень хорошо позволяет упаковать такие вещи горилла encoding с таким очень странным названием может быть кто знает почему его так называют на решетку гориллы никодим это названо по названию time series система от фейсбука которые они позвали горилла и там ibiza отписали способ упаковки флот of который позволяет если у вас чуть-чуть меняется значение какого-то флот величины то обычно у них меняется немножко немножко битов где-то в середине так вот float устроен что в этом поменяли чуть-чуть да и у вас в серединке поменяюсь бита или вк или в конце старшие биты например на совсем не поменялись младшие могут уже совсем не поменяться и вот горилла позволяет вы только и эти изменения поймать а все остальное отбросить и аналогичным образом работает т-64 но только для ин-тов она тоже позволяет хорошо хорошо работает когда у вас например внутри ограничено то есть а никаких каком то прошу прощения в каком-то диапазоне ограничены и тогда их можно хорошо упаковать ну вот пример как могла у нас b определяться таблица здесь видно что мы определяем кода когда был дельта в одном случае во втором горилла и обязательно добавляем еще компрессию то есть после коды к нам нужно паковать либо через lazy for либо через эти стандарты и к чему это приводит к тому что у нас размер сильно уменьшается то есть вот здесь вот пример размера одних и тех же данных как они сколько места меня занимают в зарипова нам в газе пленом файлы на диске дальше в клик хаусе без кодеков но с 200 декомпрессии дальше с кодеками там разными скотт с кодеками и потом компрессор зиф и кодеки компрессия 219 насколько мы меньше места заняли на диске и это очень важно не менее важно выбрать правильный тип я вот вначале показал что наш флот вся 4 но если мы выбрали фло 32 то это было бы гораздо лучше потому что для даже в меньшей степени для размера на диске в большей степени для скорости запросов очень важно использую максимально компактный тип кликал очень к этому чувствителен то есть если вы поменяете можете на место int64 использовать in 32 вы можете ожидать почти двукратное увеличение производительности данные занимают меньше в памяти и гораздо быстрее вся арифметика работает то есть клик хаос внутри себя очень строго типизированные система и он максимально использует все возможности которые предоставляют современные системы агрегация и материализованные представления позволяет вам мог сделать вот на разные случаи жизни агрегата например в основу быть исходные данные не агрегированные и на них вы можете навесить различные мать или зова на и представление с самим наш 3 это специальные агрегируются структура данных который считает эти самые агрегаты автоматически то есть вы вставляете сырые данные у вас автоматически они появляются агрегированные и сразу по ним можно использовать dash барда титела то есть как забывать данные которые больше не нужны кликал сумеет и это можно указать и тела и что нам в рио минутные данные мы храним только один день дневной агрегат мы храним 30 дней какой то там неделю или месячный храним всегда и вообще его не трогаем никогда развивая эту идею можно данные хранить в клик хаосе и в разных местах это совершенного и fitch она появилась буквально в сентябре предположим что вы у вас горячие данные там за последние недели вы хотите на очень быстром локальном ssd а данные которые более исторически вы куда-то там и в другое место складывайся но хотите чтобы они там тоже хранились увлекался сейчас можно и это то есть можно сконфигурировать таким образом политику хранение сторож полисе так лекалах будет автоматически перекладывать данные по достижению некоторых условий на другой сторож этот сторож может быть как а иметь медленно истории в другом месте достаточно чтобы он просто был примонтирован файловую систему таким образом вы можете очень хорошо контролировать свои расходы вам нужно дорогого немножко на горячие данные а холодного да сколько там неважно она хранится и чуть-чуть развивая эту идею можно добавить такую штуку это еще нет но скоро будет да что вы определяете выражение когда именно по времени данные переходят на холодное хранение то есть у вас семь дней лежат на очень быстром диски все что старше восьми дней мы переносим на медленные диска опять же чем это хорошо это вам позволяет вашу систему держать на максимальной производительности при этом контролирует расходы вместо с того чтобы много- терабайтный ssd-диски использовать из вы хотите очень-очень быстро вы ставите терабайт диск быстрый ровно на столько сколько вам нужно а все остальное отправляется на более что ты медленно и так хитрые запроса увлекалась есть много много различных способов сделать одно и то же вот здесь показан пример как мы можем вернуть значение последнее значение из таблички для каждого устройства в данном случае secu и вот три различных способа которые существует кликала что есть еще и 4 но он еще более экзотические поэтому я его не привожу 1 показывает как удобно делать вот увлекалась запросы когда вы хотите проверять что-то пал содержится в под запросе это то что во мне например очень не хватало в других системах базах данных что если я хочу что-то сравнить с под запросам то мне приходится использовать скалярно крика оси можно использовать the pale что-то пол содержится там второй пример с арк макс делает то же самое но использует агрегат ную функцию arb макс клик хаосе кликайте на самом для игры и агрегатных функций наверное десятка 4 если не больше а если использовать еще с так называемыми комбинаторы то их там можно напридумывать около 1000 потому что их можно дальше от камина тарика вступает в дело вот арк макс одна из функций которая считает вам максимальная значение на котором был достигнут максимум то есть значение там скобочка лишняя полна стоит юзать узор на котором было максимальное значение created этому и последнее это и зов лев join совершенно крутая штука которая будет объяснено вот здесь вот функция достаточно уникальная тоже для баз данных она есть еще только в те деби по моему когда у вас есть два временных ряда но у вас в этих временах рядах и временных рядах разное время вам хочется как-то в одном запросе их склеить и тогда из of joint позволяет вот их как-то сместить то есть для каждого значения в одном временном ряде ряду находятся ближайшие значение в другом и они возвращаются на одной строчки вот такая такая у них уникальная уникальная штука аналитичным аналитические функции вот вы сказали 2003 стандарте вот можно писать такую штуку в кликал это нельзя написать то есть вот кликал не поддерживает и сколь 2003 standard и наверное никогда не будет его поддерживать вместо этого в крика уже сейчас принято писать вот так я вам обещал лямды в твоих получили то есть вот это запрос накликал оси который делает то же самое что делал аналитический запрос вот здесь вот то есть считает какие то что он считает он считает разницу между двумя таймс темпами дверей шин он считает порядковый номер и так далее то есть какие-то вещи которые мы обычно аналитическими функциями считаем откликалась мы считаем массивами то есть мы сначала сворачиваем данные в массив после этого на массиве делаем все что хотим все свои самые тёмные дела а потом их разворачиваем обратно это не очень удобно требует любви к функциональному программированию как минимум но очень гибко кроме того клика lasik куча специализированных функций вот например как определить сколько у вас одновременно сессии сейчас типичная задача для мониторинга определить максимальную загрузку одним запросом откликался и специальная функция для этой цели и вообще для очень многих целей в click once есть специальные функции вот здесь вот далеко не полный список этих специальные функции если вы хотите узнать все функции в клика у себя то надо смотреть не в документацию в системную табличку и она вам сейчас вернет наверное около пяти или шести сотен разных функций который включался есть не все из них документированы но все очень интересны и последнее клик хаос в некоторым способ некотором роде могут может пожрать самого себя на прижать в хорошем смысле сейчас объясним дело в том что в кликал оси он может сам себя хранить очень много о себе и так verilog это лог трассировки и толок операции с блоками данных портулак это лог метрик это лак который он обещал обычно пишет на диск и вот лог метрик это на самом деле там cyrus кликал оси в самом на самом приказе так сколько он сам для себя может играть роль time series баз данных с таким образом пожирает пожирая самого себя это тоже я считаю что уникальная вещь раз мы хорошо делаем dtm сириус почему мы не можем сами в себе хранить все что нам нужно то есть больше нам не нужно primitives мы сохранили все себе подключили графон и сами себя мониторим если cry класса падет однако то мы не увидит не увидим почему и последнее что лучше сделать один большой кластер или много маленьких клика усиков или кликах возят так вот скажем до традиционный подход это у нас есть 11 большие кластеры там вот в яндекс метрике в 800 серверов или 500 серверов вот и там где-то еще тоже большой кластер не обязательно клик хауса то есть большой рекламы кластер и нам выделяются схемы под каждое приложение этом приложении вы пришли к администратор баз данных дай нам схему мы ему выделили схема flickr лассе можно сделать это по-другому можно каждым предложи приложению то есть свой собственный recalls нам больше не нужна большой большой большой клика us мы можем каждому выдать свой собственный потому что крика вас очень просто устанавливается и не требует сложного администрирования но есть у нас много клик house of the хочется это автоматизировать и вот автоматизировать мы можем при помощи губернаторы кликал с оператора об этом мы вчера рассказывали на если кто-то не не знает то на самом деле в губернии ты все коли колосс можно поставить вот так вот то есть я могу просто нажать кнопку запустить манифесте и у меня уже кликал из готов я могу начинать туда грузить метрики ну создам схему грузить метрики и там через пять минут у меня уже графа носки даже порт вот так вот настолько просто заключением великого с это быстро это мы все знаем кликал с это просто это немножко спорный момент но я считаю что как бы тяжело в учении легко в бою если как бы понять как лихо вас работает дальше все очень просто кликала сито универсальна и он подходит для всего почти до это warehouse там сирия слог сторож это не will теперь базу данных поэтому не пытайтесь сделать там какие-то коротенькие вставки чтения но тем не менее и криков это очень интересно вот не знаю кто работает сколько у сам наверное вы пережили много интересных минут в хорошем и в плохом смысле вышел новый релиз у перестала работать запросто вот или белиз белиз бились над какой-то штук и потом вам кто-то сказал в телеграме а вот есть такая функция и ее моё все и дворянинова не делал оказывается все можно сделать гораздо узел и такого рода вещи происходят постоянно или вот как сегодня на докладе лишь миловидова скриншот с и сколько уса сломал трансляции холода вот так тоже бывает спасибо у нас был очень затяжной и долгий рассказ настолько что он вытеснил немножечко вопросы также я хочу вам сказать что у нас сегодня печальная новость это был заключительный доклад но ничего мы увидимся с вами в следующем году надеюсь на нашей конференции также я хочу поблагодарить александра за его вклад труд и работе бам"
}