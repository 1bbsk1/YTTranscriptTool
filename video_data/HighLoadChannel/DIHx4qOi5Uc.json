{
  "video_id": "DIHx4qOi5Uc",
  "channel": "HighLoadChannel",
  "title": "Пряморукий DNS: делаем правильно / Лев Николаев (Макснет)",
  "views": 8133,
  "duration": 3143,
  "published": "2018-01-16T12:34:35-08:00",
  "text": "коллеги Добрый день Спасибо что пришли на доклад Мне очень приятно здесь выступать это Моё первое выступление на Рите Ну как бы я практикующий тренер поэтому выступаю постоян значит О чём будет мой доклад три важных пункта пункт первый а как сделать хороший резольвер Что такое резольвер да это та штука которую выпиваете в настройках сво операционной сист чтобы можно было превращать понятные человеком адреса типа y.ru да в что-нибудь непонятное IP это вот всё для этих вот странных компх второй вариант - это если вы уже доросли до этого как держать зону самостоятельно А как это делать хорошо и Отказ устойчиво как это делать если у вас много доменов Ну не знаю как очень много но много там 500 600 700 и так далее как у нас и третий сменой вариант Как смешать д ну взболтать но не смешивать зачем это нужно я тоже буду пояснять потихонечку и Давайте начнём с простого я объясню собственно откуда бэкграунд когда я пришёл в компанию maxnet это было 3 года назад DNS развивался как раз-таки в неправильном ключе То есть это был Бин текстовые конфигурационные файлы Zone и долго очень у меня висела эта задача привести это в порядок я это в порядок привёл А теперь соответственно делюсь с общественностью ка грабли ждут на этом пути ну давайте поехали поговорим про резольвер значит ещ раз давайте коротенько я не буду объяснять сущность Да резольвера я надеюсь все понимают что тут ещё раз говорю такая штука которая умеет некий адрес превратить там в IP или в ещё какой-то то есть выполнить запрос Да значит начнём с чего Кому это надо вообще Первое это нужно некоторым организациям котом проде уе вам ме Ну мешать В каком смысле от вас тся столько запросов что он не успевает отвечать или же вас лимитирует по количеству запросов и так далее это организация если выт или не дай Бог провайдер от вас в принципе Бут ждать его наличие что он у вас есть как бы что он работает да интересный вопрос к размышлению специально прита операционной систе нет резольвера который умеет самостоятельно выполнять ДНС запросы от корня То есть почему всегда моя машина должна идти к кому-то и просить его преобразовать адрес человека понятный Да выполнить ДНС запрос совершенно непонятно как ни странно коллеги по цеху из bsd ответили что там есть там из коробки ставятся unbound Но это вопрос к размышлению Почему Этого нет в остальных операционных системах вариантов здесь на самом деле два по большому счёту Вы можете использовать Бин Вы можете использовать unbound на самом деле в принципе это почти всё что можно использовать реально для серьёзного прода для больших нагрузок есть ещё варианты я намеренно их сюда не пишу Потому что далеко не все сервера отвечают устойчиво Ну вернее требованиям к большим нагрузкам А если вы делаете резольвер то автоматически прикиды что нагрузка у вас будет большая вы бы иначе его не делали в принципе значит что здесь нужно сказать е раз в отношении резольвера я не пытаюсь вас склонить к выбору какого-то конкретного софта Почему Потому что на сегодня резольвер - это в первую очередь некие реализуемые фичи а не софт какой-то конкретный Да поэтому ради Бога пожалуйста вы можете использовать бинт Вы можете использовать unbound можете использовать что угодно ещё если оно будет отвечать тем вещам которые про которые я сейчас расскажу Итак отдельно в сторону Если вы унту любите как используете вам прид немножечко по велосипеди потому что как известно должен стартовать при старте системы в 1604 перешли на systemd А естественно Юнит написать забыли соответственно Юнит генерируется так называемым генератором который пытается его сгенерировать автоматически из RC файла получается одиа не вздумайте это выкатывать в продакшн поэтому я это сделал и оставил 30.000 абонентов без днса собственно примерно на полчаса благо это было ночью соответственно надо писать Юнит я в конце дам адрес репозитория со своим юнитам берите его и Используйте пожалуйста ну это касается только тех кто сун я не знаю может быть с другими операционными системами такие же приколы Но честном скажу в дене там очень там близкая веселуха на самом деле Окей Итак что должно быть в резольвер То есть как должен быть устроен нормальный резольвер пять вещей которые нужно сделать Ну первое наверное очевидное да то Ниго форварда пожалуйста перестаньте Это делать чит если вы считаете что классный ДНС это перенаправить мои запросы Гуглу Это плохо понимаете да О чём идёт речь Почему это плохо по двум причинам ну во-первых вас ограничат по количеству запросов рано или поздно и очень часто коллеги по цеху говорят знаешь там Гуглу кидаем наши запросы что-то тормозит гово почитайте внимательно дагов ходим от корневых серверов сами и самое знаете ещё мерзкое в форварде запросов знаете что заключается что связанность не идеальная и иногда бывает что даже заветные четыре восьмёрки недоступны такое было за последние пару лет несколько раз не по причине того что это у Гугла проблема а по причине Магистральной соответственно у вас тоже будут проблемы абсолютно Тоже самое касается и Яндекса Да у Яндекса тоже есть как и у Гугла публичные ДНС Вы можете на них пихать свои запрос соответственно е раз повторюсь никакого форварда забудьте про это хотя к этому вас сдвигают многие хуки что меня удивляет лично Давайте варм на gole всё нормально не делайте так пожалуйста дальше опция Она реально ускоряет жизнь вообще на самом деле она сильно ускоряет жизнь но требует Чтобы у вас было ядро как минимум версии 39 кто-нибудь 26 пожалуйста всё расслабьтесь всё хорош закопайте его пожалуйста соответственно в чём фича этой опции да Обычно когда я не говорю мне говорят Да ладно что ты с этим там есть Там круто нене там не круто смотрите опция позволяет нескольким процессам одновременно биндить один порт но её приятность в другом что нагрузка распределяется на эти потоки равномерно есть по принципу пакет Это для подходит идеально и реально вы увидите прирост производительности просто перейдя на современное ядро поэтому пожалуйста ещё раз не надо вот этих старых ядер это не будет круто следующее Да ну естественно извиняюсь есть и в бенде иба в бенде он включен из коробки отключать иногда в ущерб производительности следующее значит это странная опция она действительно помогает в том смысле что она немножко не уважает Т то есть смотрите когда мы идём к авторитетно серверу и спрашиваем У него какую-то запись у неё есть Т Да и соответственно это то время в течение которого к нему можно за обновлением не ходить Что делает unbound Что делает Бин в таком случае они идут за обнон содержим этой запи Т реально истк Нова момента первое вы получите прирост исходящем трафике то есть ну у вас его станет больше Пронто на 10 Хотя в лом на самом де резоль с тдом могут генерировать вообще большую полосу поэтому вряд ли это вас будет волновать но второй момент что с короткими тлями это работает так себе то есть представьте себе т в минуту Да это и оче коро совестно вы в таком случае с причем никакой особой пользы не получите но в зарубежном интернете короткий ТТ - это уже как бы норма для ру сегмента это пока ещё фантастика Поэтому в принципе для России это отлично работает то есть в чём фишка Да что ответ резольвера всегда будет из кэша в такой ситуации будет ряд горячих доменов которые в принципе не будут покидать кэш это клёво это значит быстрый ответ Это хорошо дальше опция expired НТ не нашёл есть она unbound значит А это к вопросу когда сторонний интернет или сторонний DNS сервер лёг и если помните с дином был такой прикол Тут недавно Да соответственно когда он под прилёг мальца и собственно у людей дальше интернет тоже под прилёг соответственно expired One boundy позволяет возвращать просроченную запись с нулевым ТТМ А в фоне пытаться там сходить к серверам к авторитетным всё-таки у них её узнать на самом деле это серьёзно говорю хорошо помогает от крупных падений то есть вас пользователи могут даже не заметить что Дин упал Если была бы э опция но её скажем так не все знают Не все любят не все включают продолжаем ДНС сек вообще знаете общее отношение к ДНСе - Это примерно такое у ДНС сеек сложно Сложно сложно всё я не буду этого делать смотрите есть в двух ипостасях в лёгкой и в сложней в лёгкой это когда вы просто лидирует Когда вы сами для своего домена делаете подпись там все дела так вот в лёгком варианте оно работает автоматически то есть Надо просто сказать если есть ДНСе Проверяй его и при нарушениях не отдавай результат запроса почему это важно на сегодня потому что Т записей стремятся к нулю значит что есть и существует определённая вероятность попытки отравления кэша ДНС А если мы отравить кэш резольвера Как вы понимаете результат будет прекрасным все клиенты этого резольвера получат отравленную запись и можно будет сделать много интересных вещей поэтому поскольку ТТ стремится к нулю запросов сервера резольвер шлёт много и пытаться отравить его кэш это уже на самом деле даже на сегодня это очень интересная практика поэтому полу всегда проверяйте десе если он есть у домена зарубежные домены нском обзавелись уже ну неплохо Хотя процент там тоже небольшой Ну про Россию я говорить не буду там очень всё плохо и сложно и при этом многие провайдеры принципиальное не проверяют Ну например Ростелеком этого не делает то есть последняя жалоба клиента что у не не открывается один из сатов Выяснилось что нсе у сайта поломан у домена но у Ростелекома всё нормально он открывается всё хорошо Это ваша забота о клиентах Поэтому если делаете резольвер вы обязаны Да как бы проверять ДНСе ничего в этом сложного нет На самом деле за полтора года переведённый вот этой вот валидации я всё ожидал что кто-нибудь из наших Крупко сможет накосячить с ДНС секом Ну там Сбербанк какой-нибудь ну как пока нет То есть пока все срабатывания были на зарубежные сайты с небольшим трафиком ВС нормально мелочи жизни Ну первое это если вы делаете резольвер то Перестаньте отвечать на запросы я понимаю там может быть мелко не очень понятно Я просто презентацию вот вот это проще потом посмотреть в самой презентации Итак Перестаньте отвечать на запросы ви замм на 99% всякими замечательными вирусами для того чтобы с помощью вашего днса кого-то потом прикладывать поэтому Перестаньте отвечать на эти запросы чтобы не опускаться до программного уровня можно использовать IP T который работает достаточно быстро если он видит в запросе строчку что это запрос он его просто дропает говорит всё пока Дальше в моей практике получилось так когда мы сделали новый резольвер выкатили Первое что я сделал за его для всех кроме нашей сети и первое что случилось буквально через пару дней взло несколько крупных клиентов которые запрашивали обращались к нашим резольвера из других сетей Ну как бы до этого это никого не заморачивался Если вы не можете закрыть ваш резольвер для клиентов снаружи О'кей Ладно хорошо понятно Не закрывайте Да Бог с ним но пожалуйста а лимитируется их Ну там количество добавить по вкусу Да сколько какой вы лимит поставите у меня 70 70 запросов в секунду там дальше Кому как интересно и третья мелочь приятная А ну обычно резольвер в сети делается не один а и иногда хочется файвер делать между ними Естественно что лучше делать не при помощи самого резольвера то есть не резольвер надо объяснять что знаешь Брат ты ещё и зава теперь работаешь А надо делать методами маршрутизации и вот у есть отличная опция интерфейс автома То есть она говорит если запрос ко мне попал вообще в принципе на адаптер лёг Да мне плевать кому он за Раи сого ЕС это сде что мониторить Ну вот это типичная картинка сда пря вот вообще типичная мы здесь видим Ну мы здесь видим так чуть-чуть то есть на самом деле вот на картинке видно что мы там Дону до 300000 запросов это не в минуту и не в секун уме сти снимается каждые 5 минут это мелочь на самом деле и ситуация была такая Я попозже о ней расскажу это у клиента китайские видеорегистраторы включились мониторить количество запросов обязательно нужно понятно да то есть если вы не можете это измерять вы не можете это контролировать Да соответственно первое мониторим количество запросов анализируем пики смотрим Что происходит следующее что нужно мониторить виды запросов Какие к вам запрос сплю Наре видно Бирюзовая полосочка это ПТ запрос Это значит что на этот резольвер льётся куча ПТ запросов Надо разбираться Почему и откуда чаще всего их причиной является криво сконфигурированный софт либо роутер какой-нибудь считает что ему срочно нужно ПТ Запроси сделать пару тысяч раз виды запросов обязательно нужно мониторить это делается доста минимум а потом оттуда Ну вот мы ВК р параметром забираете то что вам нужно дальше виды ответов обязательно надо мониторить вот на картинке типичный пример DNS Water что это такое когда botnet внутри вашей сети запрашивает несуществующие адреса под домены атакует что происходит он получает ответ Вот его видно красненьким он нарисован там и видно что в доходило до 25000 таких запросов соответственно в чём фишка заколебал вам отвечать соответственно как только вы начинаете мониторить виды ответов вы начинаете видеть насколько внутри вашей сети активный бонеты причём Обратите внимание и количество легитимных запросов подпрыгивает точно также когда появляется красненькая полосочка да то есть это значит что совместно намт тасю там допустим вот на этой картинке увеличивают количество запросов там в два раза это некрупная сеть на самом деле там порядка там 60.000 абонентов Да но тем не менее Вы должны понимать что как только вы начинаете мониторить ответы вы это увидите другая проблема что с этим делать потом Но это это не сегодняшняя тематика ваш лучший друг ДНП То есть если у вас случилось атака Вы видите что что-то пошло не так то Как понять кто и что запра очень удоб Единственное что е Все любят запускать без параметров обычно это неправильно Я специально пишу что мину нужно указывать наш IP адрес то есть чтобы из статистики запрос самого резольвера вычеркнуть понятно да потому что их там будет много они вам будут мешать смотреть и c+ 2 это на самом деле магические кнопки которые надо нажать то есть это выдать детализацию Поре девня смотреть что у вас там получается Кто куда ходит и какая атака идёт сейчас грабли их много Ну во-первых понятно как только вы поднимете резольвер вы столкнётся получить там тонну ПТ запросов это нормально такое бывает достаточно часто особенно когда люди сквит не умеют настраивает например он там на каждого клиента ПТ запрос пытается кидать такие ве вы будете виде сможете их фиксить Ну и как бы разбираться и делать вашу сеть лучше отдельный момент - это прекрасные китайские видеорегистраторы к ним у меня особая любовь да как и у многих наверное И самое главное ответ клиента Да вы говорит Вы знаете а у меня там компьютеров Нет мы говорим Да ну как бы собственно понятно но у вас там трафик большой идёт и ботнет в вашей сети главная Проблема в том что вашим пользователям на них будет глубоко наплевать чаще всего то есть то что от пользователя идёт паразитный трафик с DNS Water torcher его волнует мало пока танки работают ему нормально он ничего делать не хочет А как-то так это мы сейчас с вами говорили про простейшую вещь про резольвер да то есть понятно что мониторить нужно Что делать с этим понятно Давайте усложни задачку Итак мы хотим держать у себя какие-то зоны то есть мы доросли до того что у нас есть домены Мы хотим их у себя держать быть авторитетным за них сервером отдавать ответы На что нужно обратить внимание как это делать хорошо значит естественно Кто держит зону у себя понятно что организации Те у кого есть особые амбиции Они говорят Мы крутые мы зону держим лучше чем какой-нибудь там Дин Или например если вы или провайдер то от вас будут опять же этого ждать то есть к вам могут прийти клиенты которые скажут вот у меня есть Зона на пожалуйста Обслуживаю её сни бу пожалуста не делайте этого никогда хотя нам исключение из этого правила на одной машине резольвер и авторитетный сервер не надо это плохо причём будете смеяться Но Говорю допустим если почитаете унту сервер оно прям вот реально вас к этому подталкивать будет Давайте Вот мы сейчас фавар настроим потом туда же зоны положим и ВМБ понимаете об этом вообще не узнаете собственно никак Почему Потому что локально вы изменения можете не внести У нас были клиенты которые настолько верили в то что если сайт открывается изнутри нашей сети а у нас вот такая была в начале конфигурация что им и домен продлевать не надо и всё о'кей и всё и они так знаете там пару лет они так жили им было хорошо у них дома наш интернет и на работе наш интернет Ну везде ж открывается дома На работе всё нормально а пожалуйста не делайте так никогда Ну кроме там определённых случаев мы о нём поговорим да Никогда не говори никогда а выбор софта ребятушки Вот это главный момент не надо думать что вы здесь выбираете софт Вот это Ключевая ошибка в головах многих Что они говорят я вот читал бинт Это круто я возьму бинт значит смотрите Давайте DNS - это база данных Зачем её пихать в текстовый файл кто-нибудь мне может объяснить Да не совсем я ещё раз говорю что источник текстовый файл Зачем Господи Ну объясните мне а потом ко мне приходят люди и говорят Слушай у нас 300 доменов Давай у всех ТТ изменим это так грустно на него смотришь говоришь меня ждёт бессонная ночь с греполис да Если у вас есть ал или шеф это очень очень плохо если вы при помощи них генерируется текстовый файл который потом засовывает в бинт но я знаю вы это делаете Вот вот вот да потом вы рассказываете о том что плохо работает да то есть я ещё раз повторюсь логика в первую голову это база данных отлично Не надо её генерировать в текстовом файле поэтому ответ Power DNS вы скажете почему хорошо поднимите здесь руку Кто знает что к бинду есть па в чтобы он мог там вот да Да знаю А вы его пробовали Вот именно Нет ну как бы Power DNS есть не для всех да Что называется то есть многие ещё не знают большая часть святы считает что вот этот вот патч на какую-то старую версию там можно на тянуть и всё нормально не делайте этого пожалуйста даже если вы раскопайте эту стюардессу на катите патч оно работает но оно работает ужасно в плане производительности потому что это тупо набор костылей поэтому Power DNS и всё тут Ага опять Привет Если вы используете убунта как мы не надо не надо в 1604 лежит альфа-версия Power DNS че Я не знаю кому сказать спасибо за Альфа версию в репозитория нет но она даже действительно работает но с проблемка год скоро уже исполнился и который я открыл у разработчиков Я говорю ребят А ничего что ЕС перепуска у ва Power не подхватывают его обратно Они такие Ух ты прикольные вот этот баг запомните его они уже три раза его закрывали и три раза открывали Понимаете в четвёртой ветке Он он до сих пор открыт Я думаю что он в четвёртой ветке так и будет открыт поэтому пожалуйста не надо есть третья ветка она она реально с у неё этих проблем нет но Нан вам подови из но догадываетесь какая проблема есть правильный Юнит для systemd я в конце репозитории дам там есть ну как бы вы понимаете что у бунту это выбор да То есть хорошо давайте про архитектуру подумаем вот здесь сейчас сейчас сложная часть доклада начнётся значит смотрите Итак А как только мы с вами пришли к Power дсу мы говорим вово Ну тогда уж если это в базе данных Давайте возьмём какой-нибудь удобный редактор в вебе чтобы всё красиво а редакторов нет кроме Power Admin Ну по-серьёзному нет конечно можно написать свой но но зачем Да его можно использовать Power Admin прекрасен это веб приложение на ПХП сразу понятно да что тому кто его развернёт вместе с сервером надо руку отрубить то есть нельзя его на ту же машину ставить понятно думаю почему Да потому что вы открываете целый ряд интересных вещей как только вы его туда ставите в ито варов неско есть возникает за У нас есть база данных У нас есть сервер который ходит в эту базу данных чтобы получить ответы у нас этих серверов несколько и возникает интересная задача как это дело синхронизировать естественно в первую голову приходит механизм трансфера зон я специально ставлю звёздочку xfr потому что там без разницы какой А xfr без разни но е раз этот механизм Если вы его оставите для переда вы себя запр вы будете продолжать делать Вот это вот Мастер слей и так и не уйдёте от этих понятий помните что вот это вот различие мастер сй оно мертвое я вам сейчас объясню почему и как бы как с этим жить да то есть ещё раз xfr не вариант Поверьте мне сейчас поймём подробнее Почему и дальше у нас нейм серверов несколько как туда базу данных доставлять То есть у нас получается что есть машина с Power админом с базы данных актуальной Да и нужно эту базу данных как-то раскатывать на кучу машин Да ещё Давайте возьмём репликацию да например говорят она прикольно работает Она Вам тоже не поможет поэтому схема выглядит вот так что вы делаете смотрите у вас есть сервер ещё раз сном там есть mysql понятно да и с сервера вы идёте туда Говорите делаете My делап файл вы скажете тоже мне я невидаль Господи что мы дампов никогда не делали А вот дальше начинается интересное знаете я вот вот вот следующее про rename Table Я когда рассказываю у людей почему-то удивление начинается то есть смотрите Естественно что вы не можете взяв дам у вас там 700 доменов допустим А вы не можете его загружать в ту же базу как-то не очень интересно получается Поэтому его надо загрузить в соседнюю а потом сделать rename Table скажете Зачем это амарна 100% rame Table это офигительная штука которая как и переименование файла в линуксе либо отрабатывает либо нет У неё нет вот этого состояния на пол шишки там Получилось Не получилось это очень удобно Это удобнее чем транзакция потому что это быстрее гораздо в разы А после этого после того как вы успешно этот дам ВС сосали вы этот же файл кладёте в git а поскольку там есть опция Skip Extended insert то Файлик получается Friend То есть у него на каждый одна строчка и вы получаете вменяемый Итак е раз Да у нас есть база данных нам Ну разложить е копию по разм машинам окава Амар то есть вся накати вся не накати пликация здесь неработает нет мы коча выкати это дело с ци за же де пликация сломалась жы мы пожали плечами сказали наверное репликация здесь не лучший выход и действительно Если Вы шутите со схемой данных что-то переименовывать там таблиц то репликация становится таким опасным зверьком И самое главное я хочу увидеть ди от того что я накатил То есть я хочу по каждому серверу иметь возможность если надо пойти в И сказать там от вот предыдущего у тебя там изменилось покажет которые изменись Уно а соответственно как я и рассказывал ещё раз скрипт на каждом не сервере делает myq Dump заливает Во временную базу данных нет никаких проблем нет никаких временных состояний промежуточных или залился или нет Потом выполняет rename Table там тоже амарна либо выполнило либо обломалась да то есть как бы вариантов никаких и всё jit comit Push если вам нужно а 225 строк на ПХП и из которых реально смысловых строчек Может быть 100 Каждый делает каждые 2 минуты часы у них синхронизированы поэтому у вас может быть любое количество они получат одинаковую базу данных накат её и у них всё будет хорошо ещ раз напомню опция skiper позволяет делать не монструозный один большой и да А много малех этот на 700 доменах там занимает еле-еле 15 секунд и он не растёт пропорционально да то есть если у вас завтра будет 1.00 доменов то он будет занимать там 18 секунд такая дешёвая операция достаточно а убираем понятие мате и slave мы сейчас поймём почему оно нам маловажно Да в данном контексте нам нужно просто держать одинаковую базу данных для наших нейм серверов всё это основная задача один сервер на котором мы вносим изменения и она разъезжается на нужное количество нам серверов всё бы здорово всё бы замечательно но у нас есть одна проблема этот классный подход работает только если мы для домена в котором мы это делаем и мастер и сй если же это не так начинаются сложности сечас будем их побеждать пере осознаем роль мастера и слева ещ раз значит нас к роли Мастер и слев приучает как ни странно бинт с его архитектурой Ну давайте как бы по большому счёту пацанского разложим и посмотрим а что это на самом деле что мастер что слев отвечают на запросы понятно да то есть тут ничего нового мастер шлёт уведомление на тифе как только зона поменялась с эти уведомления получает и что-то делает да Окей есть два варианта вариант первый клиент хочет чтобы мы держали у себя слев то есть у клиента где-то будет мастер мы долж быть слейм долж забирать у него Данные и это как раз сложный вариант который будем рассматривать второй вариант - это когда клиент хочет чтобы мы у себя держали мастер А он будет слейм забирать у нас копию про этот вариант мы разговаривать не будем Потому что нам всё равно мы просто разрешаем трансфер зоны ему и второй вариант закрыт А вот первое интереснее да то есть мы с вами получаем копию централизовано же с единого сервера Как там обновлять данные что туда всё-таки ставить DNS Нет конечно Что мы делаем один из серверов хотите два отдельный разговор Мы назначаем ответственным за примф это не может делать сервер с там не сгт один из наших серверов получает внот изменения в свою базу А дальше эти изменения вка серверу Где стоит тоже ничего особо сложно В итоге схема следующая у нас может быть две роли у нас может быть просто сервер который синхронизируется да тем процессом который я показал опять же ещ раз это простой процесс А второй вариант это рве когда он готов принимать xfr если таковой приезжает он его принимает записывает к себе в базу данных в этот момент она у него начинает отличаться от той которая есть у Power Admin понятно Да ему нужно эти изменения как-то отдать па админу Но он же это и делает выполняя ещё один скрипт что получим же доста простая операция Опя 25 нах из которых какойто обвязки соответственно ответственный за делает это перед синхронизацией То есть он сначала запускает скрипт который называется рабство то есть надо полученные мной до этого новые сведения о доменах перетащить в а потом снова синхронизироваться как и все остальные это делают ещ и позволяет полною отказаться от понятия ма вообще в принципе мы Для тех случаев когда нам нужно им быть и вс не более того что мониторить потому что вс-таки это отдельный механизм который надо мониторить Ну картинка из Акса мы снимаем это сколько времени занял ответ это микросекунды микросекунды и всп то есть база данных тормозила это будет отлично видно протокол по которому пришёл запрос тоже нужно мониторить там не всегда tcp легитимен за ним тоже надо аккуратно наблюдать заодно можно понять насколько популярен ipv6 Ну вот в нашем случае 10% запросов уже летят с udp ipv6 Мы работаем и версии 4 версии 6 естно виды запросов тоже обязательно нужно снимать Почему Потому что ну как минимум вы будете понимать что происходит и видеть например да что если говорить про а запросы то например запросы вида 4А то есть адреса ipv6 Ну в нашей ситуации уже практически равны запросам версии 4 а обязательно нужно мониторить се Fail где мы косячить причём А это удобно делать на одном графике Когда вы мониторить и corrupt packets то есть повреждённые пакеты да и там же сер фейлы вот эти две цифры должны совпадать совпадают Спите спокойно не совпадают вы увидите соответственно у меня настроена графика Так что я буду видеть цвет да то есть если вверх полез жёлтенький Значит у нас где-то есть селы без соответствующего капто пакета Окей смешная третья опция да А когда нам нужно это смешать и я говорил что так делать не надо Ну вы иногда надо к примеру У вас есть какой-нибудь хитрый внутренний домен там то Local и One Bound это пихать неудобно И вам нужно чтобы зона Local резол во что-то своё А если это не та зона то дальше запрос пропускал кстати так работает один из механизмов блокировки сайтов Да это соответственно резольвер вашего провайдера может возвращать для ло домена заглушку для хорошего домена нормальную соответственно запись Ну и в корпоративной среде это часто применяется смесь предыдущих двух пунктов типа из разряда а давайте заблокирую ВКонтакт или Facebook иногда для защиты от вирусов для того чтобы к некоторым доменам возвращать подменять запись и архитектура здесь добо простая я специально не многого не рассказываю потому двух компонентов которые мы только что видели С вами до этого да то есть в свет смотрит Power DNS он принимает запрос смотрит в базу у него есть опция в конфиге что если ты у себя не нашёл отправь запрос дальше Вот этому серверу вот этому это стоящему на той же машине Абан Ну собственно это очень быстро удобно работает единственная особенность что ну в рамках мониторинга тогда на эту машину мы натягиваем два темпле закса да то есть темплейт что и есть и картинок становится просто в два раза больше спасибо репозиторий Мы ждём ваших коммитов ну и соответственно мои контак Спасибо готов Ответь на ваши вопросы Да сечас Да конечно смотрите Хотелось бы услышать вам обм до сервера запрос определенных типов Например я хочу полностью отрезать i4 все запросы чтобы они не доходили до сервера вообще смотрите значит они есть эти опции есть в и Power и абаде я сейчас боюсь соврать но там можно как-то это регулировать Ещё вариант какой используя вы можете Вот там выдёргивать кусочек Да какой-то что там за запрос допустим вобще его дропать просто полностью ещё один вариант - это посмотрите существуют различные DNS прокси причём даже авторы Power днса выпускают тоже свой резольвер который поддерживает скрипты на лу и вы можете туда подсунуть свой скрипт который будет делать любую кастомную магию допустим смотреть и говорить ага TP V4 Уйди отсюда не мешай или ты ipv4 и там в ответ модифицируют так-то так-то то есть есть есть для этого разные средства всё зависит того что у вас задача Спасибо Лев спасибо за доклад было интересно послушать ваш опыт Скажите Вы у себя на сети внедрили блокировку запрещённых сайтов с помощью ДНС я скажу так и её тоже а статистика примерно ну как бы Много ли блокируется вы знаете смотрите понятно что блокировка через это да то есть Ну понятно что никто не мешает абоненту взять и вбить там ДНС Гугла честно вам скажу мы не смотрим на неё у на нас достаточно других задач Но вообще в принципе туда Да что-то туда падает по отчётам ревизора как заметно изменение после внедрения блокировки через да да да да для ревизора Это отличный способ Если что да ите имейте в виду он прямо вот так вот подходит Спасибо за доклад вам Скажите пожалуйста Вы своим клиентам которые пользуются Ну НМ ваших ваших ДНВ даёте IP адреса Ну как А вы обеспечиваете какой-то точнее доступность этих адресов смотрите и каким образом да давайте расскажу значит вопервых давайте я коротенько вам расскажу о том как работает то есть вы же помните мы там вводим два адреса да типа первый и второй знаете как смешно там работает я вам расскажут смотрите Windows и Linux ведут себя по-разному при недоступности первого переключается на второй и раз в 15 минут пытается по-прежнему тыкать первый и говорит Ну что ты там как ты живой Если да переключается на первый Linux этого не делает причём он переключается Забавно только в том случае если я не помню то ли се получает Толи что-то такое то есть во-первых что надо понимать что файвер средствами операционной системы Короче говоря не униформе и плох соответственно ваша задача чтобы оба айпишник которые вы отдаёте как резольвера светились всегда Да и работали значит как мы это делаем поскольку у нас мы это делаем с помощью маршрутизации то есть руками разрулил айпишник к интерфейсу прописаны адреса Его друганов Ну у нас их три используется в принципе нам этого пока хватает соответственно мы при помощи маршрутизации туда направляем трафик Да и поскольку в Абан используем опцию что отвечает на всех интерфейсах он отлично отвечает и ему никаких дополнительных манипуляций для этого не надо то есть сетевому инженеру достаточно в Уфе покопаться и перенаправить просто в другую сторону эти запросы Ясно спасибо ситуаци всех да на всех но смотрите primary висит разный А вот дополнительный шник который можно повесить на интерфейс при помощи IP там то есть смотрите Вы можете настроить один IP адрес Да и дове туда дополнительно соответственно й адрес у всех разный Ну чтобы могли по SS ходить там ещ не что-то захочется а дополнительные адреса Да там Вот соответственно моих там двух друзей Да чтобы я я мог перекинуть на него весь трафик А ну СФ быстрый конечно в этом смысле там нулевое время практически схождения да Э спасибо за доклад такой вопрос У вас вот была табличка по передаче mysql дампа Даро друг другу у вас вы говорили что у вас снимать слей да Да а там получился матер Мар да То есть вы грубо говоря меняете всегда Зону на одном из серверов перекидывать на другой то есть spit Brain не может у вас в этом случае получиться Нет смотрите Split Brain возможен в какой-то ситуации Нет вообще каждый сервер да раз 2 минуты бежит делает Дамп закидывает его к себе но если у него это не получилось то мы наблюдаем а spit Brain Да у неё старая версия но здесь нам помогает следующее если он не смог этого сделать то скорее всего у него нет связанности Да если у него нет связанности то значит клиенты до него тоже не доберутся то есть как бы это не проблема Как только у него появится связанность он раз в 2 минуты это делает он очень быстро получит новую копию нет в виде того что грубо говоря Вы на одном из серверов изменили запись а на другом из серверов каким-то образом смотрите на самих серверах ничего не изменяется изме а оттуда раскатывается на все остальные соответственно такого не может быть что мы базу поменяли забыли поменять где-то в другом месте мы как раз это и делали чтобы так не было никогда вот это была наша одна из наших проблем когда был Бин с текстовыми файлами было клёво полезть поменять зону в одном месте потом забыть серийник изменить и она фром на второй не перека да то есть вот это была наша боль которую мы вот вот этим тоже устраняли е есть какая-нибудь статистика по тому Когда перестать пользоваться и начинать пользоваться по именно скорости я понял о чём вы вы знаете я я не могу вам Её привести Почему xfr вообще очень странный механизм Ну не то что странный не так скажу xfr - это механизм который был придуман в условиях плохой связанности понимаете то есть условно говоря вот xfr особенно инкрементальный xfr Да он вообще придуман чтобы полосу экономить но понимаете В современных реалиях там полоса DNS сервера - это там 5 мегабит в секунду Короче говоря он там больше он ну не ест Он не получается него больше Да поэтому На мой взгляд сейчас xfr - это механизм так себе он он уже давно так себе Да вот поэтому я бы в принципе не рекомендовал бы смотреть в его сторону да то есть я бы в принципе и Ну вот ребята из Power DNS они прямо в документации так и пишут что ребят Если вы можете базу энд вернее они это называют эндом потому что там разная может быть база Да нита если вы можете базу как-то реплицировать без вот этих вот Бубнов xfr и прочего Сделайте это и это ну как бы в нашем случае получилось Здорово Нам очень нравится как это работает то есть вот а у вас падал ку ма с Да нет А да падал Да падал ма сй то есть мы сначала сделали на пробу ма сй репликацию то есть мы с машина Power Admin была мастером Ну а соответственно каждый NS у неё был слейм Да вот нам не нравилось что происходит потому что ещё раз говорю У нас репликация из коробки и только в первый день запуска падало четыре раза Ну в смысле рассинхрон случа там дальше Понеслась руками всё это прибивать обратно На тестах конечно же такого не было То есть На тестах репликация себя вела как Занько всё было хорошо выкатили В продакшн Вот такая вот фигня посыпалась мы быстренько поняли что репликация нам не друг в данной ситуации потому что мы немножко играемся там со структурой данных то есть rame Table не очень приятная штука поэтому мы сказали нет Вот пока нет спасибо у меня ещё вопрос Вы вот когда рассказывали про ситуацию настройки авторитетного сервера сказали что якобы репликация ма сй это забудьте про это и мы типа отдаём один сервер одинаковую конфигурацию со всего в такой ситуации в суа записи У нас есть какой-то NS сервер Да а а Вотс записей Сколько получается то есть не будет ли такого что мы приходим Как правильно сформулировать нужно разные чеке существуют DNS сервисов Угу Правильно Он настроен или нет И он будет ругаться там типа у тебя один NS Сервер это очень плохо и так далее или мы делаем одну НС запись с несколькими айпишник просто несколько НС записей если быть правильным Смотрите кто кто нам мешает а то есть вот в нашей ситуации если клиент приходит к нам с доменом да то мы в качестве НСВ прописываем раз два ну хотите третий дорисуй четвёртый пятый смотрите НСВ может быть огромное количество Любое да у вас на все из них будут литься запросы равномерно Понятно попробую спасибо да Здравствуйте а как у него у Power днса насчёт гео днса То есть когда надо для разных дата-центров я понял о чём вы вы знаете честно наверное это как бы проблема лично наша в том смысле что мы региональный провайдер Да и нас как бы волнует больше наши клиенты географически сосредоточены в одной точке честно скажу Не знаю просто не сталкивался с этим вопросом с необходимостью То есть те зоны которые мы держим да мы держим ну светим их от себя ни откуда-то географически то есть поэтому к сожалению не могу сказать попросту не экспериментировал так да привет Спасибо за доклад разложил меня лёгкие уточнения по по поводу Power днса и изменения зоны в четвёртой версии у них есть по DNS тил а pdns у Edit и он берёт из базы зону предоставляет её в текстовом виде в классическом говоришь сей он её загружает обратно по поводу XF Он всё ещё используется на корнях Дада но они просто никуда не уйдут от этого И по поводу Мита я если правильно помню томит он вроде использует котрек Да нет который когда ограничить количество запросов нах я понял вот про этот самый Просто если включить котрек и ну заранее об этом не позаботиться скорее всего курсор как бы через 3 секунды скажет кря Я больше не могу насколько я помню Нет но я сечас не Вспомни нет а это стейт это понятно А честно говоря вопрос интересный А я к тому что по-моему всё-таки там нет контре это же не tcp но он Чтобы хоть както по он и он их где-то где-то где-то хранит Просто у меня уже был случай когда я только начинал Да я что-то не то сделал напрямую я котрек не трогал но он модуль загрузился и и всё нет у нас как не нет На самом деле я просто к чему у нас-то конфигурация Вот именно с рейд лимитом да то есть ну у нас И до миллиона бывало там налета много абсолютно спокойно и ты уже упомянул как раз вот DNS ди он тоже может справиться с этой задачей Отлично просто на ура А по поводу исправления ишьюс назад разговаривал с разработчиками Power DNS они очень мало прит притравка DNS дист и на курсор Поэтому если хочется запа Лучше самому То есть в ближайший год Они похоже ничего там делать не будут Я честно говорю да меня вот в плане третья версия устраивает И мы говорим О'кей всё хорошо то есть мы четвёрку четвёрку я увидел только потому что она в 1604 по дефолту приезжает То есть это было из Разве о Что есть то есть О'кей просто последнее в сентябре будет меняться как раз ДНСе КС ключ на на корнях Не забудьте Обновить мым да да да спасибо Спасибо Давайте последний вопрос А вот вы говорили что нельзя использовать форвардинг нужно использовать вот это вот прямо рекурсивный резон у меня что-то Ну вопрос такой возник в принципе ну все наверное используют всё-таки форвардинг Это наверно как-то просто так сложилось и у меня вот вопрос такой А это вообще нормально если все начнут использовать рекурсивный ДНС этих корневых серверов их же как бы мало и смотрите значит протокол ДНС протокол он придуман Так что вы к корневым серверам будете ходить очень редко понимаете корневые сервера они там условно держат конечно сейчас уже много tld топ level доменов Да но там посмотрите ТТ там он конский реально То есть вы туда будете ходить очень редко вы туда там раз в месяц сходите И после этого не будете вы имеете в виду что наш резольвер от резолв эса допустим zone.ru и он будет уже ходить только к ним там конечно пока тель не истечёт он туда ходить не будет смотрите я же ещё раз говорю да Вопрос к размышлению Почему А то есть смотрите я вам просто просто ещё раз открою вот этот слайд Да я что здесь хочу как бы вот третий пункт я не зря написал смотрите ведь это же точка отказа Понимаете вот есть у меня клиент да и у него в настройках сетевого адаптера какие-то ДНС сервера Господи ну они не обязаны никому работать понимаете можно было со автова включить поддержку этого дела в операционную систему вы себе представляете какой Пласт проблем бы это сняло отравление кэши и многие вещи просто перестали бы иметь смысл понимаете То есть злоумышленнику сейчас резольвер кусок для атаки Почему отрав Ему кэш отрав кэш толпе Это плохо Это неправильно Так не должно быть лёг резольвер толпа без связи Ну что это такое Ну то есть как бы не классно не прикольно чтобы это решить надо просто всунуть резольвер в коробку в операционную систему Я не понимаю до сих пор почему этого никто не делает это не настолько сложно у бунты кажется ДНС МАЗ из коробки есть или он там не там плохо всё поверьте просто каширу ма вообще плохо то есть я вам честно же DNS Мак - Это плохо но дело даже не в этом он есть только во fre bsd там есть unbound в режиме ну он на локал Хосте висит и работает ну понимаете да Что как бы процент пользователей FreeBSD - это как бы отдельный разговор спасибо спасибо коллеги Спасибо"
}