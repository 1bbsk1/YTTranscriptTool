{
  "video_id": "7I_FreB0Cu0",
  "channel": "HighLoadChannel",
  "title": "Кластер Kubernetes в твоём ноутбуке. Знакомство с minikube / Виктор Сафронов (Авито)",
  "views": 7379,
  "duration": 6218,
  "published": "2019-05-14T14:47:53-07:00",
  "text": "наверное сначала представлю здание pure сафронов я работ lavita я в системном администрировании там не ни в архитектуре не в платформе не где-то я просто обычный backend разработчик и поэтому то чем я хочу поговорить это скорее про девелопер experience про локальную разработку с использованию вернется вообще когда я планировал этот метод мастер-класс workshop не знаю я ожидал что это будет какой-то маленькой переговорщики где влезет от 0 до 5 человек примерно именно столько должно было бы вам понимание прийти на этой неделе ознакомился с расписанием и вдруг обнаружил что это все в сан-пауло это большой зал вероятно организаторы хайло до посчитали что тема достаточно хайповая чтобы поместить ее сюда и количество людей пришедших конечно тому подтверждение она совершенно расходятся с тем что я ожидал поэтому сразу прошу прощения за возможные проблемы с содержимым потому что готовился я скорее к тому что мы сейчас будем доставать ноутбуки устанавливать мини кубы качать кучу софта и это ещё одна проблема я вчера попробовал сделать это здесь с местным интернетом и не очень хорошо получилось но то есть mini cube качался примерно минут пять и сашка меню куба качалась на 10 в принципе если есть энтузиасты которые хотят за мной что-то повторять и действительно выйти с этого воркшопа у нас 6 есть целых 2 часа запущена минимумом вы можете зайти на подготовленные мною маленький репозитории где есть команды которые вам нужно выполнить для того чтобы у вас все это появилось сожалению сейчас плохо видите его адрес это гид хоп com слэш витек сафронов слежку job вот я сейчас постараюсь наверное как-нибудь максимально это приблизить нет не смогу но вот гид хоп ком а потом вот это вот но в целом поскольку мало кто из вас будет делать на самом деле я скорее смещу акцент в теорию и расскажу вам о тех вещах которые можно запомнить узнать и так далее но для начала мне хочется вообще понимать кто из вас в принципе еще ничего не знает руку дорне this но или слышал но не пользуется им пока ничего себе хорошо хорошо тогда я тогда я немножко кратенько пробегусь по основным вещам которые связаны минус cabernet сам а потом расскажу уже практически о том как все работает культурной this нужен еще тогда альбине куб в принципе кто-то трогал из вас ну а вид овцы можете опустить руку так хорошо не очень много прекрасно культурно this для чего он нужен это кластер который позволяет вам регистрировать и докер-контейнер а вот с докером я надеюсь знакомых больше чем скопирует сам отлично докер-контейнер в простейшем случае вы можете запустить просто один образ но когда таких образов становится несколько вам нужно каким-то образом обеспечивать взаимосвязь между ними и есть разные система регистрации но губернатор по факту стал таким стандартам сейчас он очень активно продвигается у провайдеров который представляет услуги контейнеров и многие компании переезжают в cabernet с кластер и и как быть разработчику разработчик хочет чтобы его код был ну примерно в похожем к production окружению раньше мы пользовались какими-то мной каркам позам во грантом но если мы говорим про кубер notice нам нужен купюрница где-то у себя как убернатор оперирует такими терминами как давайте я начал открывать того код губернатор оперирует манифеста me каждый манифест определяет какой то плохо видно у настраивается через яму файлы мы каждому avito.ru планируем дарить угольники для того чтобы отсчитывать правильно отступаю яму файлов без этого тяжело с ними работать повернитесь и основная сущность которая определяет ваши контейнеры это так называемые под под состоит из какого-то количество контейнеров под вы можете рассматривать как какую-то условную виртуальную машину очень условная то есть это не виртуальная машина прямом смысле слова но то есть это какая-то связка из контейнеров которые атомарный выкатывается в облако и имеет свои настройки ну например вот здесь у меня если вас будут возникать какие-то вопросы можете сразу по ходу их поднимать руку задавайтесь это напоминает о нас скорее workshop мастер-класс они доклад в привычном понимании несмотря на эту обстановку поэтому я я пытаюсь ну это просто набор правил которые определяют один из видов каких-то кубер найти есть разные сущности вот есть сущность deployment а она состоит какого-то количества кодов есть сущность сервис ingress сущности реплика контроллеров разные варианты самый базовый нужный для нас это как раз deployment так и не что он видимо не может но сейчас мы попробуем тогда просто ничего себе стало лучше видно это простейшие описание как конкретного deployment а здесь ключевое слово определяющих deployment как раз говорит о том что как это воспринимать здесь у нас есть некие мета-данные список меток по этим меткам мы потом можем строить селекторы для того чтобы выбирать за ну там одной командой нашей сущности связаны каким-то образом у нас их много мы можем построить селектор найди мне все коды у которых метка об равно куб шоб все здорово дальше идет спецификация где мы указываем например количество реплик которая нам нужно выкрутить надо понимать что мы говорим нам отказоустойчивости поэтому мы описываем контейнер мы описываем под но в кластере он может быть представлен в десятью сущностями двадцатью 50 и дальше идет шаблон его спецификация здесь мы перечисляем наши контейнеры которые будут использованы в этом поле здесь простейшая конфигурация используется один контейнер с индексом в качестве базового образом и берем просто последний образ docker и и определяем политику по которой кластер будет выкачивать образ в данном случаев not present означать что если его еще никогда мы не скачивали тогда он скачает а если скачивали то не будет можно поставить о луис тогда он бывают переворачивать его каждый раз и мы определяем порт который будет доступен внутри кода удобства подав в том что если вы определяете несколько контейнеров вам не нужно думать о том как связать их по сети между собой все они внутри кода общаются посту 27001 через те порты которые вы определяете в контейнер портах то есть если я здесь например допишу еще один какой-то контейнер печь ппм нам нужно не только статику так так так по моему так например по-моему по умолчанию слушает именно его вот такой deployment нам позволит получить два контейнера запущенных по отдельности но видящих друг друга напрямую без какой-то там необходимости прокидывать им сеть и так далее теперь выйти из этого режима что такой формат вот спецификация а это уже спецификации относящаяся к шаблону ну то есть да шаблон сизо задает один под если мы хотим какой то еще под описать мы сделаем это в отдельном диплом эти ты ну вот я подумал контейнеров будет портов тоже можно открывать какое угодно количество это просто массив можно можно добавить здесь будет еще какой-то а я думаю какое то просто разумное то есть я с этим ограничением не сталкивался давно контейнеров в позе можно делать сколько угодно для того чтобы как то ну то есть мы запустили например давайте прямо сейчас сразу буду вам показывать как это работает pro mini cube я сейчас сделаю отступление то есть когда вы хотите deep ловите себя локально в кубе равен с класть или перед вами стоят задачи настроить и убирать сквозь тир на своем ноутбуке эта задача не такая простая как может показаться если бы не было меня куба вам пришлось бы по отдельности качать все его компоненты настраивать кучу конфигов и понятно что этот если во мне нет необходимости иметь экспертизу именно настройки купились кластеров тогда вам это не надо эту простую вещь понимали и другие люди которые решили что нужна какая-нибудь команда которая может просто вот раз написал youtube работает кластер они это сделали до них были попытки например там была команда local куб вот к ней тоже требовалось некоторые обвязки делать в какие-то конфиге настраивать ребята создали mini cube mini cube делают очень просто вот у меня сейчас машину удаленное дело mini cube старт он номинально поддерживает возможность запуска разных версий кластер купер на тесс по умолчанию он запускает последнюю актуальную на момент сборки меня кого вот в данный момент я использую mini cube версии 030 когда ее зарелизили актуальной версии интернет кластер было 110 для того чтобы не пытаться решить проблему разных версий файлов для разных операционных систем чего-то еще mini cube поставляет виртуальную машину то есть он использует виртуализацию вашем компьютере запускается полноценной виртуальная машина внутри у нее уже linux на гору с и уже там запускается докер демон который будет крутить ваши образы там запускается instance самого кластера api кластеру кубот муку билеты куб прокси все то что необходимо для полноценной работает сковырнуть сам вот наша машина стартовала для того чтобы виртуализировать машину есть разные способы самый простой наверное для разработчиков использованию артуа лизации от virtual box ну и и часто имеют на компьютер просто для того что не знаю какой то дополнительную машину запустить мы во вид и начали отказываться от использования virtualbox а примерно год назад мы стали переходить на макоси в сторону driver x hive который в свою очередь унаследован от бездушного beehive на линуксе мы начали использовать драйвер квн либерт тому была причина в неожиданных падениях меня губа никто не хотел разбираться чем связан вдруг заметили что на virtualbox падает она x h и вековыми нет мне было не лень я начал копать выяснилось ну то есть проблема выглядело как-то работаешь работаешь раз у тебя нет кластер а ты заходишь в машину и видишь то бинарник который запускает к ударница слопал куб он не только не запущен на его вообще не этой виртуальной машине а вон туда копируется при старте я начал исследовать и понимаю что у меня нет никаких лог-файлов я знаю только что машина почему-то перезагрузилась сама виртуалка но почему то есть было перезагружено по отсыпке счастью virtualbox позволяет настраивать параметры виртуальной машины таким образом чтобы например в спа и не использовалась и тогда я смог поймать момент когда машина захотела перезагрузиться она не смогла в том что не отключенных и в этот момент я обнаружил что логе завалены сообщениями a тета c который не может чего-то прочитать выяснилось что у него разрушилась файловая система путем долгих-долгих манипуляции оказалось что есть какой-то баг в драйвере баг в файловой системе которая делает диски vmdk если они расположены на x на холсте с файловой системой и ак-103 я ничего с этим не смог сделать как бы я докопался до этого скалы ладно и пошел пользоваться к вам потому что я находил какие-то баги на virtualbox она их как-то чинит не очень хорошо и требует много информации толку ноль но в целом если вы хотите вы можете попробовать на virtualbox будет работать мы в том числе переходили на их сайт потому что там чуть выше производительность вообще у нас я чувствую себя как бы таким в меньшинстве у нас меня точной статистики нет например процентов 80 90 по моим ощущениям разработчиков пользоваться маками у нас и оставшееся количество на линуксе поэтому те проблемы которые ловлю я на линуксе они даже дайте пожаловаться почти никому проблемы были дальше ты долго стартует пара божиим и сейчас под эту виртуальную машина выделено по умолчанию по моему 2 гигабайта команда mini cube старт она как раз нужно чтобы запустить машину но что про нее нужно знать у нее есть много параметров которые определяют какой траура вы хотите использовать сколько памяти вы хотите выделить виртуальной машине сколько процессоров вы хотите выделить ну естественно это все можно посмотреть там где-нибудь внезапно на кучу всего вы можете указать какую класть какой кластер запустить там вам нужен мне конкретно в 110 а предположим у вас продакшене используется 18 как у нас и вам нужно быть уверенными что те конфиге купер нас кластер который вы пишет что они заведут с продаж и тут надо быть к чему готовым mini cube хоть и заявляет поддержку разных версий кластеров но скорее всего чем старее версию выберите тем больше вероятность что она у вас просто не будет работать как вы хотите ну или по-крайней мере сам кластер будет работать но не будут работать расширение меню куба которыми он славится mini cube поставляется с расширениями которые позволяют ну вот например список расширений которые есть у меня куба чудесное расширение дашборд позволяет визуально смотреть состояние вашего глостера что в нем происходит какие дипломе на там уже есть какие-то в мое состояние ingress позволяет вам за руль и вать трафику web traffic внутри но вода без этого у вас как бы внутри кластеров компоненты смогут общаться а без него нет dns но здесь сейчас уже по умолчанию сводятся к dns новая разработка до этого был куб dns и вот эти расширения они сами по себе представляют точно такие же ямал файлы которые рассчитаны на самую свежую версию вернуться в поставке mini cube поэтому если вы захотите запустить как мы это делаем версию 18 на новыми не кубе что-то пошло не так да если вы захотите запустить какую-то старую версию вы столкнётесь с тем что скорее всего эти расширения будут работать некорректно или не будут работать вообще тогда вам скорее всего просто придется либо откатиться на старую версию мини куба и жить с какими-то проблемами которые есть в ней и либо найти те ямал файлы которые соответствуют старым версиям меня кого отключить все расширения которые вам нужны штатно ну и просто через кубка tl команды которая позволяет общаться с api кубер найдется примените эти настройки ну что-то нику позволяет показать вам логин из виртуальной машины можно провалиться прямо туда и увидеть то же самое внутри ну здесь мы видим что-то не запустился вот ура вот раз это было слишком долго что мы теперь можем сделать у нас запущен кластер для общения с кластером используется в консоли команды куб долл она позволяет иметь несколько контекстов это нужно для того чтобы скажем у вас есть div кластер прот кластер station кластер чтобы каждый раз не указывать параметры подключения к тому или иному кластеру вопрос сохранять в контексте и переключайтесь между ними винекуп по умолчанию когда вы его запускаете настраивает для себя собственный контекст который называется внезапно винекуп и вот он использует сейчас и теперь если мы захотим получить список уже запущенных кодов мы можем это сделать сейчас нам ничего нет по крайней мере в нем спейси по умолчанию в кудир найтись и есть понятие namespace для того чтобы вам не листать большое количество модов вы можете разделить их там по каким-то логическим областям видимости ну и namespace имеет такую классную штуку как и разделении ролей то есть если вы например я же на уровне класса ради площадь вы можете какой-то команде отдать отдельный namespace выйдет выдайте и право на прям на исполнена запуске команд только в этом на экспрессе от других у них этого не будет если мы не указываем space которого мы подключаемся здесь используется на экспресс по умолчанию называется дефолт то же самое и когда мы запускаем кластер здесь появляются под и в специальном кейсе куб систем вот здесь мы их видим но тоже еще не все компоненты стартовали можете увидеть запустился например уже scheduler gtc который используется для хранения настроек ну вот чаще всего вот это состояние контейнер рейтинг означает что он сейчас января перри выкачивают их образы вообще mini cube очень много завязаны каширования то есть те образы которые он скачивал он кэширует и на хвосте поэтому если вы предположим удалили виртуалку и потом заново и создали он не будет переворачивать их и над если они только не обновились там если не стоит волос медленно что еще вам нужно знать полезного про команда mini cube старт нельзя просто взять и указать какие то параметры которые вы однажды задали при первом старте первый старт отличается от любых других потому что в этот момент формируются конфет машины то есть там вы можете захотеть сделать мини клуб старт будет драйвер именно в virtualbox но если вы уже запускали mini cube с другим драйвером то это сохранена в конфиге эта настройка будет проигнорирован то же самое касается памяти то же самое касается процессоров каких-то базовых вещей настроек самой виртуальной машины не удивляйтесь если вдруг вы захотите запустить каким другим драйвером машину она у вас запустить со старым потому что просто сохранена в конфиге вам в этом случае надо либо удалить машину либо воспользоваться другой чудесные функции меню кубы как поддержка разных профилей вы можете иметь несколько виртуальных машин и переключаться между ними можно это делать указываю ключ к например нет такой если мы посмотрим по умолчанию то мы увидим что у нас мне куб запущен кластер запущен и куб котел корректно настроен на использование именно это виртуальным машинам кстати она у меня как раз и запустилась на virtualbox и одинаковыми потому что я его не указал ну давайте сейчас установим mini cube сохраняет состояние вашего кластер а то есть если у вас какие-то были выкачанные приложения туда вы можете просто оставить мне куб делать что угодно сделать мини куб старт он снова запустит кластер и восстановит все ваши пода это же чудесная штука нам нужно временно там погасить виртуалку вам не нужно будет ничего переди плавать но теперь давайте сделаем сейчас уже доступны два разных драйвера для виртуализации либерт мм2 я сейчас говорю про linux с кремом получилось смешная история я в ту давнюю борьбу с богами в меню кубе сейчас счет 21 то есть 2 бага я поправил один добавил было это очень смешно в какой-то момент у нас люди начали на linux жаловаться что при тепло и нашего монолита авито в mini cube иногда что-то не отрабатывается dns какая-то проблема не резон витамина рр изнутри кластера 1с нам нужен для того чтобы ходить в внешние какие-то компоненты включаться к базам я конечно решил разобраться в этом и что получилось я долго смотрел логе dns со встроенного сам кластеров он просто говорил что вот не может чего-то получить я обнаружил что для виртуализации любви рт создает внутри меню куба 201 использоваться по умолчанию для доступа в интернет а вторая изолированная сеть которая нужна только для общения хоста и виртуалке это изолированная сеть она не пропуская трафика на вот только в таком режиме работает или bird зная что сеть изолированное добавляет параметр но урезав на dns маску для того чтобы они работали на каждом интерфейсе которым хост смотрится торна виртуальной машины запускает для нас most эта программа которая может работать dns и dhcp сервером но на интерфейсе который настроен для изолированной сети он запускает dns маск с конфигом который запрещает рекурсивные запросы dns что получалось у нас внутри виртуалке была настроена 2 dns-сервера сейчас когда запустится меню куб я вам даже покажу как это выглядит соответственно один смотрят на dns mask запущены на том интерфейс 2 на втором и вот я и словил ту ошибку который добавил чудесно получалось что когда резольвер идет к случайному dns-серверу один из них ему говорил ответ а другой нет той молотил не говорил какую-то другую проблему он групп refused сорян нельзя тебе такое такой ответ для клиента является терминальным то есть нельзя но все больше не буду спрашивать он не шел ко второму dns и выяснилось что проблема собственно в параметрах с которыми запускается mini cube через которыми он создает сеть сейчас есть такой одну маленькую строчку я добавил в шаблон сети которая описывает конфиг для общения в приватном режиме этот параметр dns не был но как раз позволял вообще не запускать dns на втором интерфейсе ну и таким образом он не не сообщался виртуальной машине все начала работать но как оказалось я проверял это только на уже созданный запущенной машине которая когда-то была создана и теперь она каждый раз при создании корректно настраивала сеть но почему-то выяснилось что когда мы запускаем с нуля я машину это dns ей зачем-то все таки нужен я все выходные раз готовясь к этому воркшопы провел окруженный типе темпами и разными прочими командами пытаясь понять что же происходит там на самом деле я до конца не приблизился к решению вопроса но вот выглядит это именно та когда вас в 0 создаете машину на драйвере км2 и не только вы любой человек в мире благодаря мне не может этого сделать мне стыдно я постараюсь это исправить самый смешной что когда я пытался эту ролик проблему раскопать я нашел что все таки я не первый класс этим естественно столкнулся и уже были попытки и решить но с другой стороны не со стороны ас то не отдавать этот dns-сервера страны виртуальной машины не принимать его и выглядит как будто должно работать на не работает но в общем я не сдаюсь моя борьба продолжается возвращаясь к теме номинальной поддержки старых версий кластеров комбинации то вторая проблема которую я решил в мини-клубе в какой-то момент а то есть вообще что обычно себя представляет кластер в нем есть несколько нот много нот они могут там водиться заводиться мы можем перемещать нагрузку на он другой временно выводить но для того чтобы там проистекает регламентное обслуживание у меня куба но ты естественно 1 ну зачем вам для какой-то разработки у себя на машине держать их несколько в кластере повернется есть такое техническое понятие мастернода которая отвечает за самый там кипит крутые процессы на необычно тепло и cdn с на нее тепло и какие-то такие критичные для инфраструктуры вещи у купюрница есть понятие теллер шансы кейнса такие два связанных понятия когда надо объявляет о себе какие-то признаки с которыми выкатываем и под должен либо смириться либо сказать нет я не буду такое но докатиться и мастернода выкатывают такое всем предупреждения мастернода если что учитывайте это и выкатиться на эту ноту могут только те кто готов этот теле ration выдержать вот как раз в настройках куб dns а прописано что даже на мастерноду я могу катится таким образом как раз обеспечивается что на мастерноде будет жить только те коды которые действительно там необходимо чтобы побороть эту проблему в мини-клубе поскольку в меню куб то мы все-таки хотим на мастерноды выкатывать она у нас единственная но при этом мы не хотим в каждом тепло и минти прописывать этот то ли ration иначе тогда мы нам придется куют логику городить что вот если мы в mini cube катимся то тогда нам надо а если мы в продакшен катимся то не в коем случае не куб сам решает этот вопрос и в какой-то из версий они изменили механизм то есть там в новой версии кластер купер нас появилась простая строчка в конфиге самого кластера подготовит его запускаешь и и говоришь не надо добавлять attend a старых нужно было после запуска кластера специальный к нему подсоединяться выполнять команду ждать когда она выполнится и тогда это лишь набирался не куб увидел что в новой версии курица такая возможность появилась просто через строчку конфига это сделать они ее использовали а старый механизм который по хитрой костылина логике отключал этот то ли рейши на ней убрали ну зачем он нужен и теперь кластер умеет подключать ее и так и таким образом они просто отрубили возможность запускать старой версии курица я решил попробовать на новой версии как будет катиться 18 а он не пошел потому что ну вот я героически сделал commit состоящий из river то другого комета это был очень сложный commit итак второй раз вошёл в историю меню куба что может помочь вам в решении каких-то проблем они у вас обязательно будут если вы будете пользоваться новиковым я не то чтобы пугаю но надо понимать что mini cube это утилита которая с одной стороны скрывает от вас очень много деталей но тем она и вот этого подхода есть обратная сторона то что скрыто надо раскапывать вас есть логе которая сейчас как раз говорят что не получилось запустить сейчас единственный способ запустится с драйвером квн использовать вторую версию драйвера когда вы запускаете виртуализацию на virtualbox вам ничего дополнительно качать не нужно для работы меня кого если вы используете виртуализация через касаев или х и пир пятна макоси если вы используете виртуализацию виде крема или кого m20 на линуксе это тогда вам нужно скачать еще отдельно исполняемый файл docker machine который используется как раз для каких-то там базовых операций вот здесь мы можем видеть само по себе установками не куба достаточно простая что в майке что в linux достаточно скачать единый бинарник установить его а дальше он все сделает сам он выключает образ своей виртуальной машины едины для всех вы можете установить кубка tl если хотите общаться непосредственно с вашим сервисом можете этого не делать вы можете захотите скорее всего захотите установить себе home и хранить конфиге не в таком виде как я вам это показывал дьявол файлах а в таких же яму файлов но параметризовано проколом совсем чуть-чуть расскажу это отдельная утилита которая позволяет шаблоне zero вать ваши конфиге то есть чтобы не делать разные конфиге под разные окружения которые вот на большом количестве просто копипаста вы можете использовать home и какие-то вещи которые хотите параметризовать ну например я хочу чтобы у меня в локальном окружении под выкатывался в единственном экземпляре там она продакшене чтобы их было например 2 в этом случае я могу просто использовать home и этот же deployment сделать параметризовано у нас есть там какие-то технические переменные которые будут автоматически сюда подставлены и у нас есть возможность создавать какие-то values файлы в котором я например напишу реплика 1 и теперь в этом deployment я могу здесь количество реплика приказ заменить на values реплика и она будет автоматически подтягиваться из того валью с файла который у вас указан в качестве в качестве тепло и калинку кроме этого позволяет вам дополнительно атомарного управлять набором таких deployment of то есть что ну давайте сейчас за тепло им чего-нибудь самое время а черт у меня же не работает машина а нет я и запускал отдельно вниз virtualbox но хорошо нет что-то пошло не так ну у нас есть простой ответ на простой выключить и включить до часто помогают все удалить все создать многое конечно теряется при этом но зато не теряется время на попытки разобраться нет что-то пошло не так дизейбл квн кернел extension они хотят вместе работать на ok есть есть но уже лучше сейчас мы запустим mini cube из-за диплом в него самое простейшие приложение состоящая из engine.exe по хп на первом этапе у них не будет ни каких то конфигов не какого-то самого приложения только два контейнера тихой изолировано живущие где-то в виртуальной среде очень полезно сейчас посмотрим что происходит да что такое да но мы пока еще не можем подключиться машина запускается в чем преимущество но я не могу сказать что это правильный подход когда какие-то часть логике тепло и приложение живут в конфигах именно там где есть но вот у нас например мы к этому тихонько уже переходим на то есть когда ты мы описываем под мы помимо контейнеров можно написать так называемый и нет контейнером и такая полезная штука которая также состоит из каких-то образов которые запускаются с какими-то своими командами перед запуском основного набора контейнеров такие вспомогательный прошу эти нет контейнеры например могут что делать там создавать какие-то файлы устанавливать зависимости применять миграции ну то есть что то что тебе нужно сделать при очередном тепло из набора контейнера все верно но если у тебя эта логика описано для продакшен окружения чтобы она выполнялась там то тебе будет удобно использовать все то же самое на локальной среде чтобы быть уверенным что когда ты выходишь в прод она заработает чтобы тебе не дублировать конфигурацию в докер compose и в целом чартах в своих который используется ли там просто deployment рано или поздно скорее всего просто придет понимаете что надоело поддерживать и там и там да можно сделать docker композ я знаю что у нас есть какие-то энтузиасты которые по-прежнему пытаются поднимать монолит авито в blogger.com пользы кто-то ты эту vagrant по-прежнему использует но это уже вот сейчас почти невозможно то есть требуется кого большое количество кстати потому что никому не нужно поддерживать разные конфиге вот есть конфиг для prado для стретчинга есть шаблоны которые описывают как the deep ловится и удобно когда ты точно зная что то что это делаешь будет воспроизведено именно там в том же порядке ну и в целом mini cube дает локальный запущенный кластер дает клёвые штуки он работает сам по себе где-то там внутри тебя ничего нет необходимости хитро описывать взаимосвязи она работает из коробки 2 на doom насколько прямо нет да там только одна да одна нота которая поменяет себе это это сейчас нас запустим консоли у самого mini coupe нет но есть плагин дашборд который мы сейчас мы можем открыть когда запустить виртуалка это стандартный компонент для работы с любым куприна с кластером то есть запущенному я нибудь там можно установить дашборд и смотреть что внутри происходит сейчас мы запустим как выяснилось это происходит обычно долго вот пещера просьба если вы хотите задать вопрос поднимите пожалуйста руки я вам передам микрофон потому что не всем слышен ваш вопрос ok давайте я пока покажу чарт чуть более сложный чем тот который вам показывал здесь уже есть возможность как раз параметризации здесь контейнера мы подключаем разделы губернатор позволяет вам монтировать какой-то путь с основой машина пробрасывать его непосредственно внутрь контейнера для чего это может быть нужно особенно это необходимо при локальной разработки естественно вы не хотите каждый раз если это касается приложение которое не требует перекомпиляции отрежет вы пишете на печке но да что угодно питон вы хотите сохранить файл увидеть результат сразу уже в сервисе как это было бы если бы он был запущен непосредственно вашей машине для того чтобы это работало вы должны пробросить там папку своими исходниками непосредственно внутрь образом для этого у cabernet аэс в волюма есть такой тип волюма называется host пас где мы просто указываем ему какой-то путь который нужно примонтировать внимание вопрос это путь где файловой системе чего все это путь к виртуальной машине файла системой виртуальной машины вашей который запущен меня куб ну то есть компоненты кластер запущенного в виртуалке они непосредственно общаются своего системой и здесь возникает вопрос а откуда эти исходники появятся внутри виртуалке мини куба да все верно обычно используется такое двухступенчатое монтирование когда вы сначала из своей системы монтируете папку внутри виртуалке мини-клуба а уже оттуда подключать ее через fast pace есть другие способы вы можете например в куб долл в кавер найти определить внешний нфс раздел тогда вы запускаете скажем на своей машине nfs сервер и тогда происходит непосредственно и монтирование но по сети с интересом все не очень хорошо может быть с производительностью на больших листинга hе так далее но но работает mini cube естественно тоже готов к тому что вы можете захотеть пробросить что-то внутри виртуалке какую-то папку раньше они по крайней мере в драйвере virtualbox еще до сих пор от возможность работает они как раз с помощью файловой системы в бокс монтировали по умолчанию вашу ком директорию прямо внутрь для linux то соответственно home юзер для mac он монтирует все директорию users внутрь и она там внутри была доступна по пути там хост home bomann теперь для этого требуется отдельную команду запускать очень долго можно просто уточнить по поводу под от я правильно понимаю что сейчас знает что под это не касалось контейнер которая запускается и вместе на одной ноте то есть под себя на одной ноте кодов может быть разное количество они могут быть запланированы на разные но а один пост живет на 1 этаже конечно вот и получается да все ясно из него светило связь между тот и на если мы хотим сделать связь между кодами то для этого культурной tissot есть готовое решение под названием сервис сервис позволяют сказать что вот есть какой-то конкретный и пи адрес который соответствует любому и спадов описанных в спецификации этого сервиса сейчас я но давайте пока там она deep ловится я покажу как это выглядит мы описываем сервис знать не видно да каким-то образом его называем и в его спецификации указываем селектор селектор как раз состоит из киева лью которые мы указали в качестве меток нашего кода в целом у каждого пода есть свой айпи адрес и внутри поэтому айпи адресу можно к ним обращаться но это не очень удобно то есть можно было бы использовать скажем round robin кодов у вас может быть какое-то количество надо изначально исходить из того что одно и то же положение во запущен на 20 инстанция двадцать футов и положим воды обладают такой штукой как цикл жизни и смерти они могут запускаться если вы съедите приложение там вы понимаете что вам не хватает нагрузки можете нажать на в одну кнопочкой у вас их станет не 10 и 20 запустится там еще 10 инстансов какой-то момент у вас воду можно администратор захочет вывести но тут из под нагрузки потому что она сбоит и все эти коды будут терменировали тайскому нам нужно быть готовым если бы использовался например round robin dns для снижения тогда возможно были бы такие проблемы как кэширование на стороне клиентов клиенты dns очень любит кэшировать на разных уровнях и на уровне приложений и на уровне самого клиента могут быть каши и вы не хотите этого поскольку губернатор знает что вы этого не хотите они отложили другой вариант использование это сервис он автоматически знает обо всех кодов которые соответствуют этому вашему селектору и он прокси руя трафик именно на или 4 то есть он выдает вам какой-то конкретный кластер айпи доступный внутри кластер уже и вы можете смело обращаться именно на этот адрес из любого другого узла на какой-то конкретный пор тут в данном случае мы говорим что мы хотим иметь сервис который будет слушать 80 порт ну и таргет порт можно было не указывать sky не совпадают то здесь для наглядности указан 80 и если этот deployment раз катить то у нас появится свой сервис доступным же с одним конкретным айпи адресом который будет мочиться на какой то из ваших кодов там уже как раз будет работать round robin еще одно чудесное свойство сервиса заключается в том что вы можете внутри своего кода в описание контейнера писать его готовность обслуживать трафик это чудесная возможность в чем оно заключается предположим вы потеряли коллеги базе данных если кто-то из вас вчера был на докладе у глена греха вас по поводу микро сервисов как раз об этом хорошо рассказывала ваш ваше приложение должно быть готово к тому что у него предпроекта пропадет связь с базой что-то еще произойдет и он хочет временно убрать себя трафик ну то есть не обслуживать запросы но и не падать при этом потому что может быть сейчас все все становится может быть что поет хорошо рэйден с пробы настраивается в там что в дипломе nti вы можете указать ее в описание контейнера и тогда периодически кластер будет опрашивать ее обычно ради нас проба чаще всего представляет себя простую этапа проверку которая должна вернуть 200 если она это возвращает значит мы говорим все с сервисом все в порядке он жив-здоров все хорошо как только ради нас проба начинает сбоить и говорить со мной не все в порядке автоматически этот под исключается из списка подав на которой сервис будет управлять трафик сервис этим удобен все видят не так мы попробуем ещё хотят создается давайте попробуем что-нибудь за деплоить самый простой способ сделать это прямо через команду кубка т.л. мы пишем play минус f и наш яму файл тыдыщ у нас было указано две реплики и вот создаются два года в данный момент которые там стоят из каждый из двух контейнеров чтобы не да сейчас еще можем сразу задевает сервис так и дашборд даже борт еще не запустился удобнее смотреть это не в консоли а в вебе там информативнее гораздо все ну вот пока dash можно не запустился мы можем применить наш конфиг с сервисом вот у нас есть два сервиса один создал сам кластер авторы создали только что мы сами окушок сервис ему выделен закрепленный за ним айпи адрес который доступен внутри кластера с любой но да и вот мы видим что это 80 порт себе если мы на этот адрес обратимся sh100 мы ничего не получим то есть эта сеть только внутри not даже виртуалками не куба туда тоже сходить не сможет но для того чтобы все таки вывести сервис наружу используется такая штука как он grasset уже эль 7 приложение вы ingress связываете с сервисом вот запустился вы можете запустить команду mini cube дашборд и у вас откроется и у вас откроется web-интерфейс в новой версии они отказались от стандартного порта на котором он будет слушать и он каждый раз создает port forward туннель изнутри сюда ну вот с ним что-то пошло не так как раз так он запустился хорошо не работает дашборд так cross давайте за диплом ingress и тогда у нас должен будет появиться доступ к нашим engine.exe вот с помощью команда mini cube айпи мы можем узнать на каком айпи адрес она запущена это эпи адрес как раз сети которую создал virtualbox и сейчас наверное мы должны что-то здесь увидеть tragen нет не можем возможно он запомнил нет возможно а у нас индекс контроллеры ingress не запустился что-то идет не так я подозревал что workshop может превратиться в дебаг сессию так оно и получилось ну вот к сожалению так вот не покажу значит вчера работала да конечно сейчас микрофон дадут 1 внутри а вопрос немножко не по технической теме а по наверное идеологической да то есть в чем смысл эту штуковину держать у себя на ноутбуке мы у себя держим в форме пока что все мы как мы считаем что мы до кумиров немножко не доросли вот и мы естественно там через несколько месяцев разработки пришли к тому что у нас небольшой сервис достаточно мы пришли к тому что на локальной железки наш свой уже не живет потому что он тяжеловат он там кушает уже под десяточку гектор памяти разными сервисами и так далее у нас это все естественно ушло надев сервера то есть надев сервере нарезанный виртуальной машинки в каждой виртуальной машинки в гипервизор и крутится dockers форм для каждого разработчика свой они там через сеточку и туда с урсы эти заливают естественно вот в вашем случае чем была оправдана держать это именно на буке то есть почему не нарезать cooper на сеточке где-то там на серва очки и друга всех пустить этот вопрос у нас просто чтобы локально путешествует с этим буквам или там и так где нет интернета этот вопрос в разных формулировках у нас периодически всплывают его задают наши архитектуре а нельзя ли сделать так чтобы наконец перестали это делать на ноутбуках а делали это где-то на каком-то выделенном сервере пока просто скорее вопрос ресурсов пока наши ноутбуки то вывозят проще делать это здесь у нас ну то есть в любом случае будут проблемы с верху то есть и так есть проблемы с пробросов файловой системы внутри виртуалке иногда бывают такие с производительности что будет если она будет где-то далеко в дата центре будут задержки еще какие-то но и просто ресурсы на то чтобы то есть у нас сколько предположим человек триста запускает эти инстанции у нас и так достаточно ресурсов тратится на разные тестовой среды тестовые ветки и так далее это потребует еще кого то количество ресурсов то есть этот вопрос насколько прямо прорабатывается вы угощайтесь ноутбук по дорогам обещаем синод конкретно на моей машине 16 гигабайт мне хватает у нас наверное 16 ибо тоже хватило под запуск наши вас т.к. до сих пор но мы просто подумали что как будто пройдет еще несколько месяцев там или полгода мы все но выйду премся и проблем я знаю что решать я знаю что те у кого 8 гигабайт уже жалуются у нас с восьмерками как раз машинки были мы там подошли к тому что стало слишком плотно ну 64 попытаться вещаете на данном этапе вы считаете что вот так распределить девелоперские стенды по персональным машинкам это экономичнее правильнее чем пока да где все но я точно знаю что волокна и вопрос этот поднимался не один раз и скорее всего есть вероятность что это стороны будет какое движение там у нас может быть мы тоже придём какому-то варианту когда они всем когда можно опциональный выбирать и откусить но в целом все же зависит и от размера самого приложения у нас помимо монолита наши водительского мы в mini coupe диплом и наши микро сервисы точно также которые выкатывается и микро сервис шоу только в cabernet все это конечно есть не так много ресурсов как все остальное и там как раз проблем с производительностью не возникает к сожалению к сожалению не хочет сегодня у меня работать как надо не куб поэтому вам придется поверить мне на слово я еще тогда немножко расскажу про сам подход но то есть в целом в кластере у вас есть коды для того чтобы они между собой общались есть сервисы сервисы объединяются и выводится на уровень выше через ingress и если вы хотите деплоить по 1 1 deployment вам достаточно кубка тела play и вы запустили диплом если вы хотите управлять а там арно набором разных дипломантов ingress of service of reflection контроллеров чего-то еще вы уже используете можете использовать home чарты это возможность как раз описать один раз вы создаете какой-то чёрт со своим названием и в нем уже описываете все ваши шаблоны которые у вас есть там есть какое-то конвенциональная правило что они называются именно так на самом деле здесь никакой принципиальной разницы нет они могут называть как угодно могут лежать в одном файле разделенные там тремя душами как это принято разделять директивы в яму файлах и эти же черты можно использовать как готовые которое выложено уже кем-то то есть есть репозитории чартов вернется chart холма который вы можете подключить себе как зависимость и не описывает самостоятельно и вы просто устанавливаете их через home и в этом случае у тех 2 вот эти да легко все конечно вопрос очнись кладете воды реки что сервис насколько я просил тебя представлял под это не лениться не ходит там microserver она дает вот так прыгнуть с самого утра сервиса или он мягко там по пути на базу данных и вот он может наперекор и там нет лица и пойма о сервисе то соответственно и сели рования важного сервис получается этим пяти сеансов нашего часть будет принимать развода у вас именно такая почти как правило внутри одного кода что выкатывается у нас нас выкатывается но если говорить там про монолит ну естественно печка fpm с кодом приложения рядом с ним в том же позе выкатывается клиентский bouncer bouncer мы используем пост для работы и таким образом в качестве базы данных адреса базы данных о приложении используется 27001 а уже bouncer цепляется к серверному балансируя тот уже настоящим базам здесь же выкатывается как правило специальный агент который собирает все логе которые пишут приложение и он и засылают там в статье и ну да какие то вспомогательные вещи отдельно саму базу выкатывать нет смысла потому то есть в каждом поле потому что до это все скрываю внутри себя кластер повернуть всю вот эту необходимость что-то разруливать оперируешь только сущностью а сеть развивается там три автоматически видимо у меня не получиться вам показать как это должно красиво работать но мы можем сейчас еще попробовать так так до нику где лидка всегда команда которая нас спасает вот ничего себе скорость вчера такое не было если на линуксе использовать dagger машин драйвер к вам 2 версии 0 25 0 то в нем есть баг который я не исправил и нет бога который я добавил смотря что вы хотите добиться сейчас мы попробуем еще раз запустить машину с драйвером кого м2 можно добавить немножко подробности он сразу будет показывать что происходит собственно вот да здесь показана вся подкапотная магия что он делает он качает успокоить сушку создает там внутри разные сертификаты папки закидывают туда необходимые бинарники из которых состоит кластер повернитесь применяет добавляет чудеса с вам конечно взять его гораздо мягче за столбы конкурсы на стыке вот ну вот мне кажется что минимум это скорее не про то как заехать в контейнер вообще это скорее правильно заехать и культур не these к этому может быть примерно две причины причина номер 1 вы точно знаете что у вас production вы только границы и вы хотите максимально близкую среду и причина номер два вы просто хотите попробовать кубер notice но не хотите не знаю подключаться к е к весу там к yandex который теперь он тоже нас предоставляет такие услуги если вы не хотите внешних поставщиков ходить просто попробовать в себя локальный вот можно запустить меню куб и если не будет никаких проблем но чаще всего их нет да когда ты контейнерах в целом mini cube губер нить из подразумевает что все-таки входящие в него знаком с докером знаком с понятием уже перерос перерос докер голый и скорее всего перерос dakine campus но здесь уже как бы не точно может быть сразу из докер прыгать туда нос равно какой-то background абсолютно точно нужен без которого тут еще основная проблема когда пытаешься постичь какую-то новые технологии очень сложно там отделить мух от котлет друг от друга когда ты видишь кучу разного всего и не очень понимаю что к чему относится что из-за чего следует особенно там когда ты приходишь на готовый проект где-то раньше скудаться не работал вдруг видишь нагромождение я был файлов каких-то там что здесь происходит вообще ничего не понятно но начать с простого диплом целом несложно к счастью у губернатора очень хорошая документация на официальном сайте есть здесь сильно меньше а вот пошли интернет кластер есть такая чудесная возможность называется но спорт это ещё один способ использует свой какой-то порт вы можете попросить у вашего узла вашей ноды кластера какой-то отдельный выделенный под ваш сервис порт который будет портам открытым именно на ip адрес этой ноды в данном случае айпи адреса много является как раз адрес который который светится прямо в host то есть любой ваш сервис может может либо попросить выделенный айпи адрес который будет доступен внутри кластера либо порт непосредственно вот на этом адресе ничем ingress является диплом который использует возможность над порт то есть по сути ingress это точно такой же контроллер который у себя в сервисе говорит я хочу на айпи адрес синода получить 80 порт и собственно ingress контроллер состоит из двух deployment of а там это просто обычная gemix он прекрасен чем у него динамически конфигурируемый конфиг он подписывается на изменение в списке сервисов каждый раз как только появляется какой-то новый сервис который требует 80 порт он добавляет нет не так каждый раз когда он появляется новый тип сущность ingress это отдельная сущность от сервиса который уже в свою очередь смотрят на сервис когда появляется новый ingress он смотрит какие правила там описано то есть в inglese мы можем захотеть привязаться какому-то конкретному поступка к виртуальному хасту мы можем привязаться к пути слэш что-нибудь он эти правила зима файла преобразуют в конфиг индекс закидывать себе пири-пири стартует и вот у вас на этом engine.exe разруливаются и кроме этого контроллера у него запускается еще один deployment of all бэкон он нужен просто как заглушку для того чтобы куда то за руль и трафик если мы не смочили запрос с чем но уже очень хорошо пока ничего не упало да не может быть кажется все запустилось подождите подождите до пока еще не хочет а да да да все верно вот что значит внимательность вот собственно у нас нет ни одного настроенного ingresso поэтому по умолчанию отвечает дефолт backend 404 мы ничего вам не нашли теперь если мы рассказать о наше приложение с вашего позволения сделаю это сразу через команду home холмс состоит из двух частей одна часть клиентская собственно программа консольная halo 2 она серверная и deep ловится также внутрь cabernet для того чтобы это сделать надо home и нет сейчас за тепло и свое приложение внутрь мы увидим еще один под который сейчас должен создаться и спуститься ну с этим проблем уже быть не должно и вот уже как раз стиллер серверной серверная часть холма он принимает все шаблоны все значения компилирует их в полноценные ямал файлы и уже отдает класть руку вернется для того чтобы он их применил может быть долго у меня используется старая версия холма 282 его полезно иногда обновлять недавно они обновили библиотеку sprig версию используемого библиотеки spree горный склон написанного в последней версии с приго появилась чудесная возможность под названием тернарный оператор если бы вы сейчас посмотрите на какие-нибудь в конфиге где нужно сделать именно так в home чартах что если у нас вот это условие тут пусть будет такое значение если нет то такое там обычно на горошины какие-то дикие танцы к стальные конструкции за обновить hound можно от этого уйти так идти лишь у нас за тепло и лс прекрасно все что нам теперь нужно всего лишь сделать how great мы можем сделать install но более такой и дым патентный команда является команда обновления с ключом он стал чтобы он установил наши релиз если он еще не установлен install что нам нужно сделать я не буду писать ее руками я просто скопирую здесь используется хитрая магия когда мы пишем команду hill мы можем в том числе передать значение в values файлах они задаются в яму ли но их же можно переопределять прямо из командной строки то есть мы можем у себя где-то здесь в valve слопал написать что у нас будет какой-то mount пас вот такой например но если мы передадим его снаружи как переменную то тогда она соответственно придет из из аргументов и тогда подставиться что здесь происходит здесь мы берем но это было рассчитано как раз на кросс-платформенный deploy чтобы и на маке на линуксе работала мы берем текущая директория в которой есть заменяем в ней путь к домашней директории на mini cube host для этого нам надо чтобы mini cube добыл за диплом смонтирован для этого спрутс команда mini cube mount мы можем смонтировать наш home в mini cube хост то отдельный процесс которые запускаются и если теперь мы зайдем внутрь и виртуалке то мы должны будем там увидеть содержимое нашего наши домашние директория но теперь устанавливаем релиз мы задаем ему имя и вот это вот имя под которым мы диплом чарт она как раз будет доступна в переменной релизный это позволяет с помощью одних и тех же конфигов деплоить параллельно разные инстанции которые будут конфликтовать друг другом например для стоит джунглей для prado вы можете добавить какой то суффикс три листа ему и он вас не будет конфликтовать неудобство команда mini cube mount как отдельной команды заключается в том что оно требует открытые вкладки в консоли то есть этот постоянный живущий процесс но это можно обойти если прямо при старте машины указать ключ pound тогда он запустит виртуальной машины и сам фоне будет держать этот процесс вам уже ничего делать для этого не нужно будет устанавливается наш релиз а ну да ура теперь я могу вам показать как выглядит дашборд это стандартный веб-интерфейс то есть плагин дашборд который устанавливается на любой кластер как на которые вы захотите кубер нас и соответственно это тоже что мы видим мы видим список наших дипломатов откуп shop мы видим список кодов которые в нем есть под инициализируется мы можем посмотреть его логин блоге собираются stdu то мы можем переключаться между всеми контейнерами которые у нас есть может зайти в инет контейнер можно увидеть даже что он отрабатывает там в инет контейнере был простой шаг composer он стал он даже установил какие-то зависимости engine.exe php-fpm пока не стартовали скорее всего сейчас выкачиваются их образа ну вот это тоже должно ближайшее время произойти а вам привел есть режим дебаг тогда он будет водить больше информации здесь он запущен с ключом weight где-то где-то до здесь я добавил флаг уэйд и тогда home дожидается успешного деплоя и пока он здесь вот просто висит можно этот флаг не указывается тогда команда просто отработает и уже фоне будет заканчивать выполнение всех заданий в зависимости от того что вам удобнее ну вот пока контейнеры запускается обычно происходит быстрее но по-крайней мере первый запуск холодный запуск может быть как раз долгим из-за отсутствия необходимых образов докера но когда у вас уже есть когда вы запускаете не в первый раз тогда запуск происходит конечно раза быстрее ну вот все за тепло велась вот мы видим он выдал информацию о том что в состав этого чертова шло собственно вошел наших грёз он почему-то указывает адрес из 2 сти но ничего страшного вот наш под с единой репликой и сервис и дипломе по идее сейчас если мы попытаемся зайти на этот адрес да он теперь в дтп с интересно почему ура привет файлов да здесь можно хлопать и в подтверждение того что файл смонтирован мы сейчас можем что-нибудь добавить ура здесь как раз сейчас схема с двухступенчатым монтированием то есть мы сначала пробрасываем папку с исходниками в внутри виртуалке а уже оттуда мы ее через пост по смонтируем в наш докер-образ на самом деле естественно вы этим не будете пользоваться продакшне и вы очевидно продакшене будете пользоваться базовыми образами в реальном в реальности вы будете делать свой какой-то докер файл куда которые вы наследуете там от чего не будет устанавливать своей зависимости и очевидны копируете туда не всю папку с исходниками а только то что нужно потому что в этом случае у нас сейчас получается внутрь при монтировались исходники холма и так далее так далее и все это ну не очень красиво и безопасно но для локальной разработки никаких проблем с этим нет что мы еще можем сделать ну например мы можем сейчас сделать апгрейт чтобы реплику нас было больше так-так-так deployment или с репликам да мы снова делаем холмам great и указываем наш файл который мы хотим использовать те только не помню нужно ли абсолютный путь или нет да интересно мы сделали холмам great и что мы теперь видим нас количество реплик стал опять теперь у нас есть 5 кодов которые отдают нам тоже самое если мы посмотрим список кодов вот они 5 штук ну и соответственно мы можем зайти в логе какого-нибудь engine x а здесь не увидеть что к нему не какие запросы еще не прилетали с ними достаточное количество раз по обновляем нашу страничку ну наверное какое-то количество запросов сюда все-таки пролетит но вот сколько то долетела но не все очевидно это логе контейнера дави здесь подразумевается по умолчанию к счастью все докер базовой образы так и сделано что все логе пишется мест дауд именно оттуда их ожидает вычитать самку верность мастер оттуда они выводятся сюда и дальше собираются уже в вашем приложении разумно тоже писать все вас туда вот и она будет подхвачена и унесена там в какие-то единые хранилище логов ну естественно речь идет каких таких простых хлопков приложения которые не требуют подключения другим систем что ещё интересного здесь можно сделать мы можем там поменять какие-то настройки порты что еще важно например здесь есть у нашего deployment а есть стратегия выкатки в данном случае используется rolling апдейт это такая плавная перри выкатка когда у вас примет какое-то количество реплик запущена 10 штук и он будет их выкатывать не подряд 10 убрать 10 добавить а по 1 1 убрал одну добавил одно убрала добавил в этом случае вы точно знаете что у вас идет постепенное диплом и они друг друга подменяют прозрачно по моему да с таки что еще здесь можно сказать а ну да еще в качестве монтируемых каких-то разделов можно указывать абсолютно разные вещи вот здесь у меня указано два разных волюма один из них это источник нашего кода нашего приложения который задается как о спас а вот это как он фильм об это такая возможность создать файлы внутри вашего контейнеры из простой какой-то киева илью карты мы создаем конфирмат вот его данные ключи engine.exe дальше просто какое-то значение это значение просто большая multiline строка в этом случае и вот весь этот текст как он есть в нашем deployments превратиться в файлик engine.exe он в которой будет подложен контейнера engine x по пути которые мы ему указываем own pace это в свою очередь тоже позволяет легко и единообразно параметризовать ваши конфиге приложения если вам нужно чтобы сам the magic запускался с разными параметрами для провода для station где-то как-то еще вы просто в этом конфиг mapi точно также можете там сказать что здесь worker процесс будет не один а например вот так и в этом случае у вас в разных окружениях конфиг будет сгенерирован просто хелм поддерживает очень крутые средства обработки текста там есть очевидные реплей с дефолты какого значения нет в конфиге мы можем написать что по умолчанию должно быть там один например и тогда мы можем не беспокоиться если такое значение задано или нет и так далее ну и на этом в принципе наверное все что я хотел рассказать про mini cube я думаю может быть у вас есть какие-то вопросы где оказывается то что нужно сделать при запуске куба то есть там подтянуть зависимости по проекту то ли еще что то вот это вот для этого у нас есть и нет контейнера вот в данном случае вопрос был обвинит контейнер района контейнеры да то есть я например с форме том же никакого аналога этому не знаю то есть мы всякие инициализирующий задачи запускаем у нас есть специальный отдельный контейнер который мы после старта дергаем он прогоняет там всю эту инициализацию и после этого все работает интересно было как это в кубе раками здесь настроены таким образом мы отдельно описываем список наших и нет контейнеров он по структуре во многом похож на список просто контейнеров но пони вот что нужно полезного знать здесь мы также указываем это имя какой образ использовать для запуска такая же политика вытягивания образа какую команду нужно запустить в этом образе если то есть это же необязательный параметр у докер контейнеры есть свой entry point настроены по умолчанию будет запущен очевидно он нужно ли туда монтировать какие-то пути что главное надо знать про и нет контейнеры для того чтобы под запустился в принципе каждый и нет контейнер обязан завершится с нулевым x кодом если конце если какой-то из и нет контейнеров завершается не с нулевым экст кодом то есть под перезапускается и нет контейнер и начинают работать по новой они отрабатывают строго в том порядке в котором перечислены в этом массиве это тоже очень полезная штука этого нельзя сказать например про контейнер и сами здесь они запускаются в общем случае в произвольном порядке и вы не можете быть скажем просчитывать что у вас начала поднимется php-fpm а потом поднимется на x или в случае если мы сюда добавим какой-то bouncer базы данных мы не можем рассчитывать что всегда если мы поместим наш наше приложение после этого то уже точно скажем мы сможем подключиться к ним балансиров может получится так что он стартует позже из порядок запуска контейнеров не определен и я точно знаю что в и shews губернатор много раз об этом просили потому что часто бывают так чтобы все таки была возможность управлять порядком запуск контейнеров но пока такой возможности нет но и нет контейнер выполнять строго в этом порядке но вот собственно две вещи которые про них надо знать то есть единственная известная проблема с ними которое может быть если вы забыли что в каком-то случае который для вас не критичен exit code может быть отличным от нуля тогда у вас приложение просто на самом деле не запустится потому что докер кубер нации будет считать что и нет контейнер не отработал а в целом их можно рассматривать просто как какой-то набор шагов которые должны обязательно выполнить опять же к вопросу о магии и могуществе холма мы можем например сделать так можно писать iv валью с там composer и здесь сделать н и в этом случае у нас и нет контейнер от работает только если в нашем наших полюс файлах задано переменная composer и она не пустая то есть мы можем частями отключать делать какие-то ветвления здесь это как раз та самая логика которая с одной стороны может сильно влиять на ваше приложение но и как раз мешать параллель помешать поддержание параллельных конфигурации запуска если вы хотите одновременно то же самое делать где-то там dagger compose в чем-то еще да подойти пожалуйста микрофон на задний ряд 1 раз а подскажите пожалуйста если вот тут пробрасывать секреты в контейнер получается иногда когда много секретов разряд такое полотно очень большое как можно этого избежать есть какие то не знаю там мы сейчас говорим про секреты именно как сущность cabernet до сложный для меня вопрос потому что мы по определенным причинам не пользуемся секретами повернется потому что не такие уж и секретный наш взгляд секретами у нас управляет волк и красным для управления секретами волосы у нас есть свои разработана и внутреннее решение волки нет контейнер который просто там подключается как зависимость если нужно иметь какие-то секреты он просто в список и нет контейнеров добавляется он сам себе содержит магию подключения к хранилищу вытягивают токены просто потом в папочку которую ему укажешь подмонтировать твои секреты виде простых плейн файлов это как раз удобный способ не держать там одну большую портянку их можно держать разные и они будут просто доступны внутри твои файла система в приложения но только после тепло и что касается секретов купюрница 0 не подскажу но наверное какие то варианты должны быть то есть я попасть еще один вопрос по поводу миграцией вы запускаете руками или у вас есть примеры там винит контейнере запуск миграции какой то чаще всего мы запускаем миграции вынет контейнеров поскольку информация о том применено миграция уже было или еще нет храниться в самой базе данных как правило мы как раз не боимся того что она будет выполнено несколько раз разными int контейнерами то есть надо понимать что и не контейнеры запускается в рамках конкретного пода если у вас есть 10 кодов то весь код который есть у них контейнер быть запущен 10 раз если вы ожидаете что этот он выполнится один раз то не ожидаете этого если там есть вещи которые нельзя выполнять дважды то нужно делать какие-то внешние проверки что мы уже делали это или еще не делались с базы данных такое работает мы учитываем таблицу миграций смотрим какие миграции были применены какие нет ну и те которые не были применены мы накатываем в случае rolling апдейта как раз мы можем быть уверены что у нас одновременно не выкатывается два кода и не будет гонки например когда оба пода могли обоих контейнера могли увидеть что миграции еще не применены и оба начали ее применять здесь такого не произойдет если мы используем rolling апдейт когда сначала один запустился прошел свой цикл пошел запускаться следующий следующий увидел что применять уже ничего шаг пропустила explore все идет дальше нашего села целом и не в контейнер и как раз удобный способ делать какие-то рутинные вещи которые вам необходимы в приложении какой-то build так далее сейчас а нельзя сделать так чтобы и нет контейнеры запускались например только на одном воде если не делаем несколько их чтобы он запускался только на ном нет они не для этого то есть я говорю если нужна какая-то проверка на уникальной запуска то ее нужно реализовывать самостоятельно get сверху чтобы он при запуске знал надо ему работать или нет на самом себе нет контейнер будет выполнен но только если мы целиком не отключим его на уровне шаблону но в таком случае он дал сделан будет ли тогда он не будет робот везде у меня дополнения такой комментарий такой про и нет контейнеры вот говорили про порядок запуска порядка запуска среди контейнеры внутри под действительно нет но порядок запуска подал именно можно разруливать через инет контейнеры да и мы пользуемся такой штукой вот как раз спасибо за замечание чаще всего когда мы разрабатываем что-то локально мы имеем свою локально поднятую базу данных которая запускается также у себя в кабинете отдельным чар там там тот же по сгрыз например и для того чтобы когда мы стартуем приложения мы знали что база данных уже есть и к ней можно подключиться вот как раз там у нас вынет контейнерах есть какой-нибудь даме скриптик который делают wilder у и проверяет есть коннектор базе нет slip секунда нет коннекта slip секунда есть connect exit 0 таким образом мы можем такими костылями искусственно контролировать как запускается в каком порядке запускается под покрыт таки условная зависимость и выстраивать от не особо к стали потому что используется в 70 процентов официальных чартов вот если это используется в 70 процентах специальных чертов то возникает резонное предложение сделайте нам какой-то более удобный механизм регулировать порядок запуска нашего приложения как внутри так и самих кодов по отдельности до да у нас например мой коллега расследовал странные случаи он работал в направлении грейс пул shadow на чтобы сервис завершаясь корректно гасил все соединения только потом выходил я там были проблемы связано и с тем что когда он закрывался там соседям когда поступало команда на дестрой пода она поступает всем контейнером одновременно и контейнеры могут завершаться тоже в произвольном порядке кто-то дольше кто то нет и там получилась ситуация когда демон еще запущен он еще обрабатывает запросы но погибал настя раза живущий в отдельном контейнере уже вышел и получается что демон ну не мог ничего сделать корректно и когда мой коллега искал какой-то правильный способ как этого избежать как сделать так чтобы пока bouncer не выходил не завершался пока там ничего пока он еще нужен официальным ответом условную официальным ответом от и навозе разработчиков комбинация была добавьте slip на выходе на пагуба у нас тире чтобы ну то есть там есть такая штука хуки вы можете на старте контейнера на выходе контейнер и записали какие-то дополнительные команды которые должны выполняться именно в этом контейнере и там просто предлагалось возьмите какую-то величину в секундах в течение которой ваш демон точно завершит свою работу и настолько поставьте slip в своем пока балансире это к вопросу о костылях который используется как почти официально ну и надо сказать что в целом этот подход работает и действительно проблема у нас с игрой схож a down в этом сервисе закончились вопрос спасибо за доклад хотелось бы узнать хотим использовать волк корпус их есть какой-то best практик использование откуда в кубе я видел недавно где-то был доклад по моему здесь или прошлом году это даже можно хотя бы вспомнить и там по-моему было упоминание об этом что в кубе прямо из практика который хочу раз это делается до история у нас сложилась таким образом что когда мы начали его у себя интегрировать использовать в uber найти еще не была официальной поддержки world of купер найти поэтому мы были вынуждены написать свои вот такое решение кастомная которая представляет себя просто шаблон который ты young люди в свой home чарт а он просто представляет собой описание нет контейнера который внутри в себе делают все необходимые вещи для подключения к контроллеру там автоматически политики разруливаются по имени сервиса по namespace у тебе выдается токио но он монтируется внутрь и так далее скорее всего сейчас может быть уже можно обойтись и без этого но у нас в этом направлении пока мы ничего не делали ну тогда получается нет большого смысла в целом мы сделали то же самое . подход опять же удобный и действительно можно видеть контейнере это делать один и тот же волюм подсовывать и приложению и континет контейнера и тогда к моменту запуска приложения в eve volume уже будет лежать этот секрет виде какого-то файлика привет от обычного докеры как invidia докер для для поддержки gpu внутри внутри контейнера кубер нас есть такая я точно знаю что у нас есть ноты сбу я точно знаю что в нашем наша команда их не использует а я точно знаю что из команды которых использует по крайней мере об этом могу судить по общению в внутренних каналов где была речь как раз о запуск какого-то сервиса который был требователен к ноде именно с видеокартами ну то есть можно да дай собственного релизного тоха какой-то из свежей версии классе тирада об этом было заявлено не уверен но здесь наверное все вопросы операции виртуализацию мини-курс записка лент мастер для виртуальной машины и сливать и виртуальной машине и то есть то тогда это можно будет использовать если нет то соответственно вопросов больше нет у меня есть мне продолжение вот вопрос с секретами то что обычно используются волки нет контейнера и все что видел по сути нет контейнер просто берёт эти секреты и кладет куда-нибудь файлик текстовый даже не зашифрован и которые потом монтируется к самому контейнеру и вот вопрос это насколько это вообще безопасно потому что ну теоретически получается очень какой-то секрет и можно будет украсить каким образом если у тя есть например у макара доступ к этой тачки и ты можешь просто если есть доступ к этой тачке то это уже в принципе ну да то есть но у нас просто было проблема то что у нас безопасники не очень хорошо в итоге к этому отнеслись и они считают что например например для 50 best они хорошо подходят этот вопрос ой у тебя чтобы залезть в волюм докера на тачке должен быть не просто доступу те должен уже доступ если тебя кто-то получил рут на тачке то у тебя проблемы то есть расскажем далее я я сходу не представлю себе какого-то вектора атаки именно через вообще возможность получить файл оттуда если нет какой-то очевидной дыры в приложении если она их не монтирует в папку самого источника она не доступна пока тот об этом например или как то еще или если может быть есть дыры которые позволяют просто произвольно обращаться к файловой системе ну это скорее минус защита на такие изнутри когда есть когда например должна быть предусмотрена защита от того что сотрудник не всегда проснулись но это разруливает столько доступа me у нас например в продакшен окружении ни у кого нет возможности делать экз окна воды в прозе она есть только у администратора в которой в принципе к этим секретом и так могут получить доступ по крайне мере администратора smalto но в общем я не вижу в этом какой-то большой проблема спасибо feel вопросов больше похоже не туда спасибо вам"
}