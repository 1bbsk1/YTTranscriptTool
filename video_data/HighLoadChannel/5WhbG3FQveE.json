{
  "video_id": "5WhbG3FQveE",
  "channel": "HighLoadChannel",
  "title": "Автоматизация замены дисков с помощью Ansible / Артём Александров (Одноклассники)",
  "views": 1421,
  "duration": 2787,
  "published": "2019-05-15T02:27:01-07:00",
  "text": "всем привет спасибо большое те кто не пришлись меня зовут артем александров я работаю ведущим стен администратором в компании на классники компании я ответственна за стабильную работу портала также помогаю коллегам и обучаю их и внедряя новые процессы инструменты для того чтобы стабильность повышалась а работа наша становилась более быстрый и лучше в общем занимаюсь развитием сегодня я расскажу вам о том как мы выстроили процесс по автоматизации замены дисков а затем как мы исключили из него работа администратора и заменили ее ботов мой доклад будет состоять из двух частей первая часть будет про собственного строение самого процесса а вторая часть будет более техническая о том как мы на базе этого поста царик процесса построили собственно автоматизацию использованием ансимов перед тем как начнем немного цифр одноклассники это гигантский сервис которым пользуются миллионы людей его обслуживает около семи тысяч серверов которые расположены в четырёх разных дата-центрах на это количество серверов у нас приходится более 70000 дисков чтобы понимать масштаб если все эти диски сложи и друг на друга полочку то мы получим башню высотой более километра здесь важно заметить что жесткие диски это наиболее часто выходящий элемент в серверах и при таких объемов нам приходится менять около 30 дисков в неделю в таком случае у нас замена диска она стала рутиной и на самом деле не очень приятный который администратора во всяком случае просто не любит ног делать необходимо также я хочу заметить что у нас компании vision полноценный инцидент менеджмент каждый инцидент который случается мы фиксируем jiri а затем его решаем разбираем есть инцидент был сложный с эффектом для пользователям то мы устраиваем встречи на которых мы думаем как быстрее реагировать на цедент как снизить эффект от него и естественно как предохранить предотвратить его повторение жесткие диски не исключения за их состоянием следить система мониторинга zabbix забег собирает самые различные проверки начиная с марта вычисляет износ и ssd диска иногда эту информацию можно подчеркнуть прям и см от дисков иногда нам приходится используя различные формулы и коэффициент буквально для карты модели дисков вычислять износ собираем сообщение из лога анализируемых смотрим какие ошибки записи чтения были а также ошибки и закрываем рода мы также собираем когда zabbix и загорается какой-то триггер выжили создает создается инцидент эти инциденты автоматически останется на соответствующих инженеров дата-центрах мы и так делаем со всеми х в инцидентами подковы инцидентом я подразумеваю такие инциденты которые требуют какой-либо физической работы с оборудованием дата-центре инженер в центре это собственно тот человек который решает вопросы связаны с железом отвечает за установку обслуживание и монтаж серверов жене до центре после того как получайте кит приступает к работе там где это возможно он на меня и диски самостоятельно это дисковые полки и железки у которых инженеры есть доступ но это естественно не всегда возможно тогда инженер обращается к дежурному системным администратором с помощью помочь в первую очередь это же конечно вывести диск из ротации вывести диск из ротация это значит сделать необходимые изменения на сервере остановить приложение от монтировать диск подвести в общем сделать всю логику какой бы она сложно не было для того чтобы диск можно было просто легко вытащить и сервер и заменить на новый и женой системный администратор этот человек в течение рабочей смены которые отвечают полностью за работу все портал не занимается только с жестким диском он расследует инцидент и занимается починкой помогает разработчикам выполнять какие-то небольшие задачи общение между инженером куда-то центре системного администратора у нас происходило в чатике инженеры буквально набрасывали ticketing ссылки на джиро ticket и одни сада проходил по них открывал вел какую-то лог работы команде блокнотики потому что это неудобно вообще чатике на самом деле классная штука но когда они выходят за пределы какого-то быстрого общения пользоваться ими неудобно информация там не структурирована быстро теряется люди могут отойти и так далее особенно это проявлялось когда инженер было администратор был занят и просто не мог ответить нашим инженерам ежедневно мог стоять у сервера с пачкой дисков и ждать когда администратору ответят в чатике потерял время самое плохое была в том что наши администраторы они не видели картины целиком они не видели какие есть существуют дисковые цедент и не знали где потенциально может возникнуть проблема это связано из-за того что мы всех его инцидента даем инженером отдавали инженеров конечно можно было отобразить вообще все инциденты показать их на дашборде администратора но и хочет немного администратор привлекается не по всем а по меньшей части кроме того инженер не мог корректно расставить приоритеты потому что не знал у него сервере серы какая группа база данных он этого ничего не знает приоритеты поэтому были неудобны первое что мы сделали мы вынесли все наши дисковые инциденты в отдельный тип назвали его ходить х в диск и добавили соответствующие поля к этому типу это имя блочного устройства размер диска и тип диска чтобы эта информация сохранялась в ките и не приходилось постоянно в чатике обмениваться также видео лет и мы договорились что в рамках одного инцидента мы будем менять только один диск и это нам существенно помогло когда мы начали внедрять автоматику потому что мы просто поэтому же не думали один тискать один инцидент один диск все логично также мы добавили поле раз понци был админ тогда автоматически подставляется дежурной системный администратор это очень удобно потому что теперь инженер она всегда видит кто ответственный не нужно идти в календарь искать этого человека именно это поле нам позволило вынести на дашборд администратор ticket и в которых возможно им потребуется работа когда внедряется какой-то новый процесс важно помнить каково и для чего он делается мы делали это в первую очередь для людей поэтому чтобы все понимали и получали максимум от нововведений мы создали фильтры и даже борды рассказали о них ребята мы распространили среди ребят а когда люди чувствуют и понимают изменения они не отталкиваются от никак животных жиров и начинают тянуться например для инженера важно знать номер стойки где располагается серы что поменять и размер тип диска то время как для администратора нужно в первую очередь понимать что это за группа серов и какой может быть эффект при замене desktop наличии более их отображения это очень классно но ну никак не сбавляло нас от необходимости использовать читы для этого мы поменяли workflow это собственно так выглядел наш мир флопа которым мы работали и так и сейчас продолжает работать инженеры когда им не нужна не требуется администратор тикет либо находился опытный просто проселку сарвиноз после замены либо висел какой-то fixing ну полезности от этого был не не был никакой первое что мы сделали мы ввели новый статус и настигнет в этом статусе ticket находится когда инженер еще не решил нужен будет ему администратора или нет то есть он через этот статус он может передать ticket администратору а также у меня мы располагаем ticket и когда требуется замена диска на диск на площадке нет например какие-то седины удаленные площадке также мы добавили статус синквейн его текке переводится уже после замены то есть все уже сделано но на сервер происходит синхронизация mdr еда или however i do это может занимать довольно таки продолжительное время разловить и пить нельзя и как бы фактической замену уже произошла в случае же когда привлекается администратора схему немного усложняется и статуса open a ticket может забрать как системный администратор инженер потому что ним увидит эти тикеты а в in прогрессе администратор подготовить их к замене выводит из ротации сделать все чтобы инженер мы просто вытащить включает как минимум под пятку от монтируют диск остановит поражение но для разных групп сервов по-разному на дальнейшем проекту говорим после того как он это все сделал текке переводится в рейд ты чинишь это четкий сигнал инженеру диск можно вытаскивать все поля в жире уже заполнен он знает какой тип и размер у этого диска можно не проставляется на предыдущем статусе либо автоматикой либо если автоматика не сработало администратор после замены диска переводим в чаще где диск водится обратную ротацию проверяется что ставили тот диск делается разметка запускается приложение какие-то тоски по восстановлению данных также естественно присутствует и синквейн но в данном случае он уже останется то есть ответственный администратор потому что он заводил диск ротацию полная схема выглядит так она немного это сложно для понимания сразу поэтому я показалось части вот и которая правая часть это инженерная лево это с администратором добавление новых полей она существенно облегчило нам жизнь изменений в apple о первых потому что ребята стали работать структурированной информации они прекрасно знали что на этом этапе мы делаем это стрелять приоритеты на стали намного более толерантны потому что теперь их выставлял администраторы сам решал что вот здесь вот какие то pendingintent а мы-то диск можно за подождать а здесь нужно менять вот прям сейчас как можно быстрее чат и они в них необходимость отпала естественно администратор может написать инженеры пожалуйста вот здесь вот нужно заменить побыстрее или уже вечер и спросить сейчас буду там сможет заменить но да и бдм и в чатах уже не общаемся поэты вопросам диски стали менять пачками если администратор пришел на работу чуть пораньше у него есть свободное время еще ничего не случилось на портале разработчики не подошли со своими задачами он может подготовить пачку серверов там 56 сколько у него есть инцидентов замене то есть проставить поля вывести все диски и передать инженер инженер приходит чуть попозже в дата-центр видит набор нужно три ssd такого-то размера берется склада идет и сразу меняет из-за этого естественно нас увеличилось к рязань небольшой опыт если вы вдруг захотите после этого доклада что-то изменить у себя или у вас уже были такие мысли просуммировать первое что она естественно и понятно но иногда забывается при построении workflow нужно собирать информацию совершенно из разных источник даже если вам кажется что это понятно и очевидно например а у нас и некоторые администраторы не знали что инженеры меняют диски самостоятельно некоторые считали что за синхронизации софтовых рейдов им дверей следят инженеры хотя у инженеров у некоторых даже не было доступа для этого делать а некоторые ведущие допустим инженеры это делали но естественно не всегда потому что этот процесс нигде не был закреплен и описан workflow должен быть простой понятный человек тяжело держать в голове множество шагов два-три шага дальше становится тяжело самые главные переходы вот соседние в жире нужно лучше выносить на главный экран можно их переименовать не называть по имени статуса ticket дамы допустимым прогресс называем препараты тяньши той ради той же нише и так далее а остальные переходы по прятать вдруг down menu выпадают чтоб они не мозолили глаза но лучше их не не ограничивать людей и дать возможность делать сделать переход потому что кейсов бывает много и когда что-то не возможно это просто вызывает раздражение показать ценность рассказывать почему когда люди понимают они не отталкивают они лучше принимают варку для нас было очень важно чтобы люди не прошел cavalli workflow именно шли по нему потому что и на этом потом строили автоматику и ждать анализировать понимать ну тут совсем такое на построение workflow у нас ушло на техническую реализацию навстречу обсуждение так далее около месяца на его внедрение 3 с хвостом то есть я вот прям видел что потихонечку-потихонечку люди начинают пользоваться получается на первых этапах было очень много негатива причем иногда почему workflow не шел не принимался людьми эти причины совершенно не зависит от самого workflow технической реализации так далее они лежали где-то были абсолютно стране на я как-то заметил что один инженер приходит на работу и у неё в комментариях появляется везде рак jira тикать и я спрошу зачем ты это делаешь у тебя рек написан двумя строчками выше он glide я не знаю я вот прихожу на работу наливай кофе и по привычке хожу и проставляю реку потом замечая этот блин зачем это сделал почему не вошло там несколько дней два три четыре я уже точно не помню он перестроился другой же администратора у нас оказалось не пользовался аджиры он использовал jira плагин в confluence и естественному некоторые вещи были недоступны показали ему что jira посмотрели что ему не хватало там не performs подрос и по общей вообще-то скамью по дискам том числе давайте теперь перейдем к автоматике автоматизации эта часть я назвал диска бот по имени приложений there которая у нас меня диски к вопрос автоматизации замены дисков мы подходили несколько раз у нас уже были какие-то наработки какие-то скрипты но все они работали либо в интерактивном либо в ручном режиме требовали запуска общем это нас не устраивал это когда у нас появился workflow мы поняли что да это именно то что нам не хватало эти на минутку вернемся схеме администратор подключается на трех этапах и можно какой-то этап самый простой ожидании синхронизации правый арку что аппаратный рейд или софтовый за синхронизироваться отдать бота то есть написать какой-то простенько скрипка то это будет несложно не очень ответственно пожалуйста когда будет чуть чуть подрастет обучиться можно ему дать более ответственную задачу контроль и не контроль а вот диска в ротацию смысл здесь в том что можно и включать автоматику поэтапно не нужно реализовывать и сразу полностью целиком потому что это был нас заняло я не знаю честно говоря сколько времени во первых страшно во вторых количество кейсов очень много о поэтапном включали постепенном была в очень крут перед тем как начну рассказывать про бота небольшой экскурс зоопарк с этапом он обусловлен в первую очередь размерам нашей инфраструктуры я уже говорил это гигантский сервис автор их что под каждый сервис мы стараемся подобрать наибольшую наиболее оптимальную конфигурацию по железу первый же у нас около 20 модели и аппаратных рейдов первую очередь это конечно же лассо и адаб таки но встречается их игр по и белым разных версий raid-контроллеры имеет каждый вид контроллер имеет свою утилит управление где таркан где-то там сосал 2 ирку и т.п. куклева все эти причем вывод их может отличаться от версии к версии у каждого рыб контроллер где у нас нет рейд контроллеров у нас может быть md ритм хочу кстати заметить что практически все новые инсталляции мы делаем без дискового резервированием то есть мы не используем аппаратный и софтовые рейды но у нас очень много legacy серверов и собственно их нужно поддеть поддерживать где-то диски в рейд контроллеров прикидывается от как рок девайсы где-то используется g-коды есть конфигурации где все расставлено один системный диск соответственно если его нужно заменить нужно полностью переди плоти весь сервер накатить операционную систему после завершения диплом на какие туда приложения причем той версии которая работала потом это приложение запустить докинуть какие-то коффинга персоны файлы и так далее очень много групп серверов сервисов где резерве меня осуществляется не на уровень диска подсистема а непосредственно в самих приложениях к ним относится в первую очередь наша система хранения это образ система горячего хранения cold storage мы называем о cs про них можно почитать подробней по ссылочкам эта презентация моих коллег крайне рекомендую очень очень классное решение gdfs тоже там резервирование на уровне приложением и облака в общей сложности у нас более 400 уникальных групп серверов на которых работает около 100 различных приложений чтобы покрыть такое огромное количество кейсов нам нужен был на профессиональный автомашин tool с желательно с простым д с элем чтобы я объясню зачем простой dsl чтобы не только тот кто когда-то написал и все это выручить сережи поддерживала что это могли делать любые люди там junior администратор любые администратор иногда даже разработчик который поправили свое приложение api пошли сразу нас поправим мы выбрали ansi было потому что он и gentle с но мне нужно было подготавливать инфраструктуру быстрый запуск а вторых он написан на python python это стандарт нашей команде мы стараемся использовать его простой dsc ли низкий порог входа давайте посмотрим на общую схему на примере реализации автоматики на примере одного инцидента zabbix ходит дата центр собирает какие-то метрики и детектирует что диск с д б вышел из строя за биг си загорается триггер и он создает тикет jiri я сейчас пропущу процессы навести гейши на когда мы определяем тип размер диска его имя сразу перейду к замене администратор посмотрел на ticket понял что это не дубликат не фолз полете все хорошо нужно менять переводите кит вот процесс диска бот приложение она работает демона режиме на но написан на python она периодически опрашивает жироны предмет новых тикетов замечаешь что появился новый тикет управлюсь нужно менять в нем срабатывает с от с лишь и там thread а он который запускает в анси был пыл ebook для каждого статуса в дыре мы запускаем соответствующий пульпу в данном случае запускается при подключении диск выводится за ротация анти был отправляется на холст выводит диск из ротация и возвращает ответ приложение а результаты выполнения play буков мы получаем с помощью callback моделей это два типа call back of во-первых стандартные ansi был узкий call back он предоставляет данный по результатам выполнения playbook а то есть там описано тоски который мы запускали зафейлили за сакэ селись они какие-то за скитались в общем результаты выполнений естественно он вызывается уже по окончании проигрывание play book если же нам нужно получить какую-то информацию во время проигрывания play буков для этого мы используем к ттп кубики то есть ван сибли запускается выполняется после запрос в тоске и нам данные прилетают в приложении там может содержаться комментарий вертикали чуть попозже проекта это подробно расскажу через кого-то и кукол бэкки до также передаются переменные которые были определены при выполнении play бука и который мы сохраним хотим сохранить для выполнения playback of последующем при заводе диска в ротацию эти данные мы пишем из kool-aid базу локальную у нас используя sql алхимия поэтому может принцип будет любая база он там данных совсем не мог мы выбрали скрывать по результатам год переводит автоматически ticket фредди ты чинишь инженер видит сигнал окей пошел поменял диск вставил диск новый перевел текке в чем же по той же самой схеме тикета аппарата по куда попадает боту тот запускает в данном случае уже другой playbook который проигрывается идет на хост меняя диск результаты так же само возвращается через калмыки и бодр и золоте кит ура все счастливы диск заменю давайте теперь чуть подробнее расскажу про некоторые компоненты как я сказал диска будет приложения написано по этой на работы приемной режиме ним запущены несколько трейдов для каждого статуса эти статусы они описаны в конфигурационном файле это яму конфигурация это ниианси было это именно конфигурация самого диска бота бот выбирает тикеты из дыры соответствии с жителями поэтому администратора можете легко поправить житель данном случае выбирается для инвестидеи шины ticket и со статусом окон для in progress видно что мы выбираем ticket и они там будут это чушь и сократил фильтроваться ticket у которых есть только диск says не пустой и девайс ним девайс на имя это имя блочное устройство нужно для выполнения play book a disc сальса нужен для того чтобы инженер поменял диск то есть тем самым просто гарантируем что a ticket не уйдет автоматически на замену инженера с пустым полем размер диска в роде видно что мы фильтруем по лейблу by both игнор это стандартные jira вский лейбл мы используем их как для подобной фильтрации так для маркирования дубликатов тикетов потому что существует дубликаты а также для сбора статистики когда play books зафейлился в джерри поставляется соответствующие лейбл там где bat-файл и я могу или кто-то другой может спокойно посмотреть список тикетов разобрать что там пошло не так если все хорошо у нас другая статистика положительное мы смотрим о том как вот хорошо работает взаимодействие приложения сансе был выполняется через анти был пойти на пин есть несколько способов мы взяли playbook y you to play books & кута мы передаем не посредства имя файла я москва а также набор переменных это нам позволяют держать ansi был проект виде обычных я могу файлов не не описывать его в python коде также wanz и был передается переменной экстра wars это имя блочное устройство 90 места-то стики там а также call back url callback url это как раз уру в котором зашит и щуки и он используется для кубиков хоть и т.п. штуку также мы в анси был передаем a status check молот это встроенный в анси был функционал драй ран функционал при запуске с которым ansi был не выполняет на сервер от никаких действий только эмулирует их там происходит валидация синтаксисе тогда расскажу зачем мы это сделали в анси был кстати мы генерируем временные inventory когда его запускаем состоящий всего из одного поста из группы в который входит и the force для того чтобы групп фарси применились давайте чуть подробнее расскажу про х ттп callback это пример тоска в котором он реализован как и многие дать epn и тоски мы вынесли его в отдельный a common файл и просто img людям при необходимости чтобы не поставить не повторять постоянно в playbook а здесь фигуры как раз колбы url в котором зашит и щуки и host name поэтому когда ansi был делает этот выполняет этот под запрос будет легко можно поставить что это запрос пришел в рамках такого то инцидента и call back пост body это словарь который может содержаться различные данные данные а это собственно пример young людям здесь видно что хранится в клуб с бадди то может содержаться статус это статус в которой будет переведет ticket после получения этого call back a message сообщения который будет запущена в дыру в виде комментария а также дата которая просто словарь можешь себе держать любой набор вложенных перемена например это кусок мы из play book где мы выводили диск и из инди устройство но перевели после этого тоска в реддит очень she добавили комментарии рыбу в диск хром md рейд а в дом дата мы сохранили список он был строить из которых был удален диск в парке потом партиции от при порты да и поэтому когда инженер заменит вставит нам новый диск мы сможем использовать эти перемены чтобы восстановить дам партиций а также завести дисков тем destroys из которых он был удален анти был чек но включать автоматику было страшно реально страшно поэтому мы в 1 решили запуска теплый букера иран режиме это позволило во лидировать работу ботом при запуске анцев игра на режиме мы прогоняем out путь через отдельный call back модель и выхлоп то есть результат выполнения этого play book мы постим дыру в виде комментария здесь выхлоп от удаления одесской земле рядом во первых это позволило лидировать работу вода во лидирует работу play букаф вторых это повысило доверие администратора ботом потому что сначала люди просто ему не доверяли потому что не что-то творилось под капотом любимых продакшен серверах некоторые люди просто предпочитали по старинке делать замену руками хотя автоматика уже было в какой-то момент я заметил что некоторые администраторы наоборот стали использовать этот вы out put от бота как инструкции замены чтобы не идти смотреть какую как там написано в конфликте нужно менять диски а он пожалуйста в жире они уже представлен когда же мы прошли валидацию и надо поняли что можно антипу запускать недра я на режиме нужно его запустить мы сделали кнопку ран диска бота в жире она доступна который выполняет get запроса в приложении и результатом является выполнение play бука с теми же самыми переменами того же сама play book на том же самом кости но nidoran режиме кроме того эта кнопка используется для повторного запуска если play books of явился такое бывает например пыталась остановить приложение она не остановилась и мы поэты mode отвалить министра то посмотрел пошел проверила приложение все-таки закончилась завершилась просто не в тайм-ауте нужно повторно запустить playbook потому что дальше еще идет какая-то логика он нажимает grandis cabot automatic поехал дальше обработчики которых мы конфигурации которых я показывал раньше они запускают разные play буки то есть для упал на месте гейтом будет запускать один play books для in progress 2 во-первых так намного проще организовать вход во вторых в некоторых случаях это просто необходимо допустимо при замене системного диска чиню яму у нас нет вообще никакой операционная система то есть мы заменили системный диск он голый там нет ни linux не цены вообще ничего не не говоря уже бы с.х. нужно в первую очередь пойти в систему тепло и создать task на тепло этого сервера и после того как уже сережи корректно за тепло это станет доступен псх можно на него пойти накатить приложение если бы мы делали как бы все в одном play буки таланте было бы просто пошел собирать какие-то факты и завалился потому что хост недоступен это структура одной из ролей мы естественно используя манси был роли для каждой группы серверов где видно что как разнесены по ибуки это очень удобно потому что сразу понятно где какие тоски расположены в main ям ли в основном кота фку который является входом леонсе был роли у нас может быть просто include или там могут содержаться какие-то общие тоски необходимые для каждого статус например прохождение какой-то модификации получения токена или что то еще чуть-чуть про play букин инвестициями яма во-он запускается для инвестиций шин тикетов и для опыт в нем в первую очередь нам необходимо понять имя блочное устройство какой диск мы будем менять это информация не всегда доступна для ее получения мы анализируем jira самаре тайтл last вылью от zabbix придира там может содержаться ими площади устройства до повезу здорово может содержаться mount point тогда нужно пойти на сервер пропарсить это цех стопы понять какой диск может содержаться skazi адрес или какая-то другая информация может не содержать вообще ничего нужно ходить там какой-то дополнительной канализировать после того как ими блочное устройство у нас есть мы собираем по нему информацию для заполнения полей аджиры это тип и размер также мы снимаем информацию по дискового vendor а модели прошивка какая то едишь к с марта и это постим комментариям jira тикет администраторы инженеру теперь не нужно собирать эту информацию он открывает ticket она сразу доступно начнем мы конечно же удобный экономим время кроме того вообще понравился такой сборы и нести гейш он автоматически он довольно таки простой его легко сделать и мы планируем организовывать и для решения других инцидентов при поэту чень ши это вывод диск из ротация подготовка к замене самый сложный ответственный этап потому что именно здесь можно спокойно установить приложение в то время когда его нельзя останавливать или вытащи диск и который являлся у которых не хватало реплик и тем самым получить эффект для пользователей потерять какие-то данные здесь у нас больше всего проверок и нотификации в чате так далее в самом простом случае это удаление дескать сендера и да там все на дисковой подсистеме может спокойно удалять более сложных и кейсах где резервирования ощущается на уровне приложения необходимо спать и в приложении папе сказать это диск мы вводим и строя деактивировать его запустить восстановление так далее но это касается наших систем хара хранилища bss который я же говорю в случае с облаком мы сейчас массовым мигрируем на облака диска бот идет вопи облака говорит я с этими new на миньон это собственно сервер на котором запущен docker контейнеры собираюсь с ним работать меня де пожалуйста сми грыжи все контейнеры с этого миньона чтобы я смог с ним поработать и естественно подсветка диска чтобы одни инженер знал какой диск вытаскивать а не гадал очень я у после того как диск заменен в 1 g проявляем что dice доступен проверяем а с марта диска мы мы все используем бы у диски то есть не всегда инженеры нам ставят новые диски и поэтому мы делали до бы вы добавили определенную проверку если но оставленный диск не дают влияют нашим требованиям по смартом фаррелл оком коран тренингов мы просто возвращаем диск обратно инженеру с комментарием пожалуйста новый диск выключение подсветки разметка там в принципе все стандартно вот ротацию иногда обращение опять же к приложению папе чтобы диск корректно завелся синквейн тоже в принципе самый простой кейс проверка синхронизации ангел устройства и расстройства если приложение то там тоже что-то проверяем я очень много говорю про то что мы ходим приложение папе для какой-то дикой для какой-то работы бота не все наши приложения имели соответствующая приходилось дорабатывать с разработчики нам активно помогали с этим я здесь на слайде вынес некоторые методы наиболее важно во-первых это статус он может быть любой может быть статус кластер или статус диска чтобы понять что с диск можно выводить за ротации можно корректно работ ну старт-стоп деактивация диска какая-то запуск какой-то де комиссии my great restore данных во время и после замены в завершении хотелось бы подайтесь подвести некоторые итоги по касательно ansi был я люблю очень этот инструмент но когда я смотрю на разные open source ные проекты в первую очередь и вижу как люди пишет play буки мне становится немного страшно там иногда такие страшные конструкции из лупов воинов поэтому мы решили делать не так делать все просто и подчеркнуть самую сильную сторону once i было это простой понятный playback play буки я я выделил такую модульность tris 3 уровень на самом верхнем уровне находится play буки их могут писать любой администратор junior сторонний разработчик который не знает и чуть-чуть знает ansi был это в принципе очень легко и понятно они написаны на ямале вот пример звуком и включает подсветку диск вызывается dice лакей 2 переменах лакей тов имя блочного устройства чуть ниже если какую-то логику сложно реализовать плей буках мы выносим в ванте был модуль или фильтры это уже какие-то скрипты они написаны на поэтому не обязательно то python принципе не довольно таки простые если вы никогда не писали модули откройте какой комьюнити ли built-in модель посмотреть как они или золотом нет ничего сложно в них мы реализуем уже более сложную логику потому что там полноценный язык например диск лакей то модуль который только что был на экране у нас реализован в шестьдесят пять строчек с учетом комментариев примеров и документации и это не просто который включает logcat но он также смотрит и ищет соседние диске то есть если dice полностью не доступен мы не можем его подсветит ай да мы подсвечиваем его соседей а когда диск ставили нужно выключать подсветку на соседей на самом низком уровне библиотека для данного проекта мы написали отдельные отдельные приложения такого своего рода абстракцию насильно mesh аппаратными со вторыми родами который выполняет соответствующие запросы когда приходит деспла кейт который библиотеку импортирует говорит дисконт дисков библиотека уже выполняет там запуску arcconf а сосал 2 ирку и всех вот этих утилит для подсветки в общем все реализуется мультика просто раскатано всех сервера вёдер pm пакета еще некоторые такие под итоге самая сильная сторона антиблик что он получил популярность простота и понятные play буки я считаю что нужно ее подчеркивать не генерировать страшные войны лупы и так далее выносить всю самую сложную логику фильтре модули если вы вдруг захотите повторить наш опыт использовать анти был пойти на пи имейте ввиду 2 две вещи во-первых playbook экзекьютора и вообще на самом деле play буку нельзя передать какой то при бы тайм-аут есть таймаут на из к сессии но нет time out an apple ibook если в нашем случае мы пытаемся от монтировать диск который системе уже не существует ли бог будет выполняться несколько часов до бесконечности нам пришлось обернуть запуск пойду к в отдельной wrapper эпиляцию поймал во вторых ansi был работает на базе ford процесса поэтому его а penetrate сейф мы запускаемся на шипы play буки нужно сказать одно по точно то есть в один момент нас работает один пай бук по итогам нам удалось автоматизировать около 80 процентов дисков см и смысле замен дисков 80 процентов замена производится автоматически без участия администратор администратор делает только одну операцию он смотрит на инцидент понять менять здесь диск или нет нажимает одну кнопку меньше рутины соответственно мы забыли на самом деле начинаем забывать что такое замены дисков столкнули начиная сталки за другой проблемой некоторые нового администратора не знают как мне диски но это скорее они шутки скорость замены дисков увеличилась два раза то есть без каких либо усилий я имею думы не стали быстрее нажимать кнопки ли что там мы получили прирост в два раза и самое главное мы поняли что эту схему она настолько гибкая что она подходит для решения решений и других инцидентов и мы планируем дальнейшем внедрять его решение только дисковых ценят большое спасибо за внимание я готов ответить на ваши вопросы здравствуйте спасибо за доклад очень ясно представляю компанию седин видео такой вопрос вы редактируете проблемы с диском уже по факту конана произошла то есть там полетели вовсе слог ошибки fs или заранее собираете там метрики pending лакей sectors и другие да я понял спасибо за вопрос по разному иногда диски вылетают просто сразу и не было никаких превращений о том что он вылетит но мы стараемся менять диски до их вылета и больше часть замен у нас происходит до того как диск выйдет из строя поэтому смотрим на два атрибута smart и показал мы опираемся именно на них на поединке in a real окей ты причем релокейт и меньше ста анализируем износ диска его на работку это касается ssd-дисков эссе слоги просто появляется сообщение что там какая-то ошибка на файловой системе потенциально это отказ диска и мы меняем его до того как он выйти строй понятно а еще такой вопрос наверняка вас уже но накопился огромный опыт вы планируете куда-то выложить статистику по разным диском от разных производителей мож там на хабр статью было бы очень интересно нет мы такого не планировали на самом деле есть компания которая хостер я к сожалению не могу сказать ее название могу посмотреть и мы поделюсь этой информацией которая публикует буквально ежегодно очень огромный статистика у них намного больше серверов у и дисков и там прям по вендорам по моделям у них есть отличные отчеты по смартом и так далее крайне рекомендую как бы посмотреть могу потом дать хорошо спасибо большое пожалуйста здрасте спасибо за доклад мне такой вопрос выписали вы используете различные утилиты для обращения с рейдом для разных вендоров и писали модули под каждый утилиту свой концепт или шиловский скрипты нет мы как раз а вот где я говорил побери отеку вот про эту это реализовано непосредственно самой библиотеки это поэтому библиотека которую мы просто young людям в модулях и в нее уже реализовано вся логика то есть она определяет какой контроллер какое нужно утилита и в ней зашиты соответственно команды для сам вопрос будьте вы выкладывать в открытый доступ нет мы не планировали могу сразу объяснить почему потому что она очень чётко завязано на наш рейд она не пока нанаширо еды на наши модели на нашей версии и мы не тестировали других то есть мы просто писали ее под наши нужды и не было такой задачи пожалуйста приветствую спасибо за доклад алексей тщательный креп шин вы сказали что вы отказываетесь от аппаратных рейдов по какой причине это экономически невыгодно вам производительности не хватает или что то еще не сейчас будет сложно прямо ответить по расчету экономичность но просто переходим на резервирование не на уровне дисковая система на уровне приложений так гораздо проще с учетом того что мы переносим и сейчас очень сильны мигрируем в облака там нужно применять другие подходы они использовать рыб и то есть даже случаи вот с вашим на сервер миньенов так понимаю что это что-то вроде кубера да это это оркестрация докером ну да это самый читаемый словно кубер то есть готовы к внезапному вылета но ты как бы и у вас это все покрываются уже приложения да спасибо пожалуйста здравствуй спасибо за доклад а такой вопрос во время ребилда массивы независимо от его происхождение софтовый он или аппаратный всегда есть вероятность отказа источника чтения то есть есть ли анализ на суббота то есть превентивно предсказать а вдруг он умрет во время ребилда стоит ли заменить диск или изменить и как это действие предпринять заранее чтобы не развалился рейд весь у нас настолько raid1 поэтому из двух дисков мы один диск меня и мысли 2 вылетел мы ничего не можем сделать мало допустим а если оставаться облачное ваше хранилище которое всегда есть источника который будет отдавать в эту реплику там проверяются диски там где мы ощущаем резервировать на уровне приложений там и отдельные алгоритмы которые реализованы собственно сами хранилищах которые вычисляют различные хэш суммы сделает сверяет блоки так далее там все это зашита но как бы я щас не могу про это сказать это не в рамках майк офисы в докладах все это есть вот ссылочка которых давал про без горячее-холодное хранилище добрый день скажите роли я понял что замену сама дисков инженером производится по logcat летом в основном то есть вы никак не прямо киваете там диске то есть основной метод нахождение диск какой вот мужчине цвет к дискам по цвет подсветка диска да я насколько однозначно вот потому что опыт у достаточно не всегда она сработает там в особенно когда диске хэ лиц вы говорили про соседней диски там какой-то выработали это такой забор у нас много alice iv которые собственно позволяют подсвечивать диски но это реализовано в рейд контроллеры мы не используем рейды мы просто их к краю девайс используем они позволяют подсвечивать если диск полностью вылетел то вот в логике модуля он смотрит берет дам список айди шик который есть как контроллера пробегается по ним и выискивает по пропуск что нас там 46 пятерки не хватает значит выйти 5 диск последовать 4 5 мы естественно в данном случае даем сразу комментариев jira что будьте внимательны подсвечен не вылетишь и диска подсвечены соседи спасибо а вы постепенно как то идете давайте зации железо количество моделей контроллер насколько я поняла да и сброс говорите что уходит за можно сказать скорее нет чем да мы стараемся выжимать максимум из железа и для каждого сервиса подбираемся тысяч конфигурация с облаком стало намного проще мы там просто нас есть определенные типовые миньоны на которых контейнеры там конечно разброс гораздо меньше но это никак не не изменяет в плане зоопарка потому что на миньонах там когда выходит диски надо тоже ловит под руку перед не закладывать но уже для приложений спасибо презентацию будет линк дает ему будет"
}