{
  "video_id": "NspApITg1SA",
  "channel": "HighLoadChannel",
  "title": "Система подготовки видео для стриминга на платформе ivi / Евгений Россинский (ivi)",
  "views": 1177,
  "duration": 2923,
  "published": "2018-01-16T13:09:35-08:00",
  "text": "меня зовут женя и я являюсь техническим директором компании киви и сегодня расскажу вам немножко как мы погрызу и кактусы поплакали с мышами на тему того как сделать систему кодирования с последующей выгрузкой для он бы month видео соответственно сначала будет там три секунды немножко о том чего у нас за сервис что вы понимали контекст а потом уже перейдем к окна сортирного юмора и различным подробностям и так собственно или показывает легальные видео у нас хрена вы тучи различных клиентских приложений играем там на небе айосе кофеварках телевизорах недавно запустили иксбокс авс к и приложение вот собственно kholod проект смог миллионной аудитории 33 ляма вот построили свою сидел уже там несколько лет назад 30 городов в россии вот и 3 до центра в москве с кольцом 150 гигабит соответственно и развлекаемся такой нагрузкой как там 70 тысяч запросов в секунду маленькая прям было теперь перейдем непосредственно к теме от того о чем хотел бы поговорить собственно как видео от правообладателя доходит до конечного пользователя соответственно правообладатель отправляет нам либо ссылочку либо там в 10 процентах случаях это система автоматизирована к специальному протокольчик у мы забираем своих автотехника ссылки на файлике оригиналов вот дальше у нас есть специальный отдел который называется in jest термин взят термин взят и собственно телевидения люди которые занимаются подготовки подготовкой видео к передачу же в систему кодирования в чем это заключается эта работа нужно посмотреть что прислал правообладатель посмотреть битрейт посмотреть в каких кодеках там вообще пригодна лето к просмотру вот возможно где-то отрезать начало или конец вывести уровень звука сделать цветокоррекцию прочие разные интересные вещи собственно в отделе injustice 2 тип специалистов собственно два года назад мы сделали два типа специалисты когда всю эту байду затеяли первое это люди которые действительно разбираются в кодирование видео слова гоп и keyframe для них люди не является пустым набором символов вот а есть люди которые являются операторами системы массового обслуживания названием системы кодирования это некий вид баран они кидают его систему массу обслужим с другой стороны получают две палки колбасы не уходит колбасу нормально все можно лейн опрос вот соответственно наша задача была сделать так чтобы число профессионалов с ростом компаний которые разбираются видел не сильно росло а нужно было растить число как раз вот таких людей которые закидывают барана и получают две палки колбасы соответственно дальше из волшебного делаем жеста видео попадает в систему кодирования это уже наше падение вот которым я собственных я расскажу а после собственно кодирования раскладывается на сервера оригиналов дальше стандартная схема это все раскладывается с помощью магии или самостоятельно на сидел и отправляется конечным пользователям простая то есть начиная с серверов оригиналов там и заканчивая там сединам классическая схема дистрибуции контента вот но интересно нам будет вот эта вот штука да то есть сама система кодирования котором мы с вами поговорим точно я вам расскажу о вы будете задавать гнусные вопросы какие у нас были проблемы почему два года назад мы пришли к выводу что надо бы в общем что то поменять и сделать мир лучше они хуже вот есть первое у нас были просто многокилометровой инструкции о том как создать собственно продакшном среду для кодирования мы любим их в комплекте разного концертную хрень вот и вот разработчик вышла новая версия класс сейчас я быстренько ее там соберу у себя блин вот как какая вообще там битрейт упал на 5 процентов ваще огонь надо за деплоить и вот тут начинается самое веселое у него как мы дальше классической проблему devops а до кого-то него разработчика 1 инфраструктура там на продакшен серверах нас тестовых кластеров другая вот начинается боль содомия кидания какашками ненависть между отделом разработки и эксплуатации там можно много говорить там про там то что да надо быть devops он вы просите но на самом деле нет люди всегда есть люди они ненавидят друг друга вот поэтому нужно дать начало технологическую платформу которая уберет противостояние вот значит вторая большая проблема нам нужно был действительно сильно снизить требования к уровню вхождения операторов работы системы кодирования то есть на самом деле попробуйте поищите на рынке людей которые прекрасно разбираются в кодирую не видел чтобы было еще много там пришло десять тысяч единиц контента да там например там год назад то мы взяли на попробовать индийский сериал 10 тысяч сайтов надо вывалить довольно быстро все они в разном битрейте там где какие-то самим правообладателям скачаны с toronto какие-то там полное садами и вот это нужно все бы быстро как-то обработать вот и когда у вас систему которая требует очень умного и в понимающего человека в собственно 10 тысяч сайтов не обработайте так чтобы качество было нормально поэтому мы предприняли ряд шагов вот следующая проблема это то что для того чтобы подготовить видео к стриминга нужно пройти большое количество этапов значит на каждом этапе вы можете облажаться упасть вот и систем массово вслух не нужно привести в чувство и собственно этот самый эту самую задачу либо перезапустить либо исправить и перезапустить нам либо искать какие то мы вообще в принципе кодировать не можем вот следующая история это у нас есть аренде это вообще веселые ребята которые просыпаются в районе ночи вот и начинают креативить тогда на techcrunch и вышла какая-нибудь статейка что типа израильский стартап выпустил новый кодек который позволяет снизить битрейт видоса на 10 процентов надо же конечно попробовать и внезапно получается так окей контракта с израильским стартапам все там на из говна и палок летним крепим концерт а теперь надо все это за запустить в продакшн и тут возвращаемся к первой проблеме в пищевой цепочке появляется еще один потребитель что очень неприятно вот дальше у нас зоопарк контейнеров кодеков и демов кодеков на самом деле очень большой зоопарк а вот с контейнерами и д р м действительно большой поскольку мы легальный сервис нам нельзя просто так взять и отдать прекрасных даже или прекрасный через потому что нам просто этого не разрешают да то есть проволоки говорят ребята вот например там фильм звездные войны вы например можете отдавать на такой платформе только в таком дырами все значит такой грм кивнули несколько человек это digitalwrite менеджмент это та хрень которая вроде как защищает от скачивание и от возможности украсть контент видео в видео к видео аудио контент вот собственно боится деле этих систем на самом деле несколько но вот собственно мы практически все популярные внедрили вот это правда боль и страдание почему потому что по-хорошему ты не должен знать как работает д-р м потому что он эта система защиты не имеешь права заниматься реверс на жене лингам казалось бы вот если этого не делать это фигня нихрена не работает вот поэтому особенно как тестируете отлаживать работу да и рама это вообще просто отдельная песня вот ну и как результат у нас появилась 52 различных конфигураций кодирования пакетирования видеопотоков потому что например есть старый телевизор элджи у которого представление обучились и очень специфическое если ты ему дашь честный хороший классный человек который проходит всем стандартам вот он вот играть не может хотя в доке у не написано что может и по хорошему играть ничего кроме как mp4 у него не получается соответствующими минусами для пользователя как время старта там буферизации прочие всякие вещи вот поэтому для того чтобы играть на максимально большом количестве устройств нам пришлось научиться либо генерировать эти форматы заранее либо генерировать их на лету и тут собственно деньги решают где нам это выгодно где нам это невыгодно об этом я чуть чуть позже расскажу следующая боль а нам нужно было уметь сохранять истории параметров кодирования для того чтобы в дальнейшем понимать что делать что можно что нельзя делать с этими видео файлами например нужно найти все видосы там с ки фреймами там в две секунды к примеру зачем это может быть нужно могу рассказать там нам нужно провести тест нас к насколько изменение собственно длины чанка влияет на нагрузку на наши дейэн там да как это все связано с алгоритмами кэширования вот эта информация нужна вот это не жизненно важная история без которой нельзя существовать но если ты хочешь сделать свой эксплуатацию своего сервиса несколько более экономически эффективной для sap вы понимали мы где-то в шесть семь раз дешевле чем коммерческие предложения наша себестоимость чем коммерческое предложение любого сидена это действительно так вот то есть там такие конские ценники закладываются но при этом это вполне себе бизнеса бизнес должен закладывать нормальную маржу вот поэтому система кадира для нас не пустой звук ну и как и в случае с его псам большие проблемы с тестированием систем кто же первый кто любые фичи смотрят перед тем как мы к этим это на прот это конечно к инженер и водку инженер должен сначала там прочитать вот этому многокилометровую инструкцию у себя в кластере где-то это поднять вот вообще проблемами собственность тоски по кодированию фичи по кодированию они самые сложные почему потому что требует большого времени тестировщик тоже человек вот он запустил что-то кодироваться и пошел бодренько пить чай на этом у них контекст потерялся он вернулся все упало надо разбираться что вот этот притираться таких много на счет два года назад время тестирования одной новой пищи в среднем я считал у нас обходилась примерно в две недели это было прям очень больно вот при том что там не знаю там на том же самом виде или на бэг-энде там мы gone по 15-20 релизов в день вот и это нормально а вот случай с системой кодирования где очень много времени уходит tube на то чтобы дождаться пока тестовый файлик даже если он там весь черный да нет никаких смен steam все равно требует определенного времени вот ну и стандартные проблемы с системами массово обслуживание большим количеством потребителей у нас несколько департаментов которые пользуются системой кодирования соответственно это отдел контента который от правообладателя забирает и есть еще веселые ребята под названием реклама поскольку мы горды и низ и независимо у нас ещё и своя рекламная крутилка чтобы не садиться на чужие пилюли вот и иголки и поэтому рекламщикам нужно уметь быстро выкатить тот или иной рекламный материал по тому же самому пользователю вот так дальше вот собственно была проблема от бизнеса друзья как бы в таком интенсивном режиме мы не можем тут и набирать людей которые разбираются в кодировании чё хотел business business hotel дешевую специалиста который все умеет и в восторге от рутинные однотипные работы просто придется от нее вот собственно чего ждал технический департамент от специалиста по кодированию вот и к чему на самом деле мы шли собственно что что хотели сделать хотели создать систему с низким уровнем вхождений для операторов возможность используем дешевых несколько де квалифицированных сотрудников которые по требованию можно как подключать так и отключать вот ну и не увеличивать число профессионалов которые дорогостоящие и в общем не настолько оправданы использование такого количества людей вот значит теперь немножко про этапы подготовки видосов ну собственно первое что происходит с видео которое поступает к нам в систему это проверка оригинала зачем это нужно это нужно для того что в общем то даже классные ребята которые разбираются в том как правильно закодировать видос могут ошибаться и первым делом что нам нужно проверить нужно проверить битрейт по статистике в предыдущей версии системы очень часто были случаи когда например оригинал приходит в битрейте 1 мегабит и оператор кодирование бодренько просто система сделай мне пожалуйста из этого full hd ну по хорошему можно обстрел там в общем никто не отменял вот систему тупо берет и и делает эту штуку на выходе получается один большой квадрат бежит с другим большим квадратом вот и на все это смотрит третий большой квадрат вот инженеры контроля качества видео потом на этом все смотрит ребят воткнуть вот после n-ого количества обращений людей которые занимаются контролем качества именно видеопотоков мы добавили вот такую штуку следующий вещь от пропорций в нашей практике был два смешных случаях когда правообладатель прислал видео размером 2 пикселя на 480 вот две полоски вот да понятно что аналогии не очень смешная вот но две полоски случайно выкатились на прот собственно после двух полосок у нас и появился один отдел контроля качества человеческий вот соответственно пропорции смотрим чтобы видео хоть к чтобы видеопоток хоть как-то мог поместиться в этом 9 16 3 4 хотя бы в крайнем случае там один к двадцати нтам но не 14 180 вот соответственно следующий история это fps зачем нам это как правило мы ввели там где-то около полугода назад когда стали экспериментировать с генерации и чавеса на лету вот зачем нам нужен контроль fps аж такое fps и знает фрейм персиком то есть сколько кадров в секунду у нас в нашем видеопотоки соответственно зачем это нужно это нужно для того чтобы в начале каждого чанка у вас всегда находился опорный кадр вот если вы говорите что вас чанг там четыре секунды или две секунды а вас fps дробный так или иначе куда-нибудь опорный кадр вас от начала тянка уедет конечно можно подгонять все делать там неравнозначные чанки там и прочного когда вы делаете адаптивный streaming вам нужно это как-то синхронизировать поэтому более простые правила порождают более простую эксплуатацию и понимание как это все работает соответствие сейчас у нас есть там где-то процентов 7 или 10 контента которые живут с дробным fps ом и эту штуку можно с как бы нельзя стримить на лету нельзя стримить в произвольные контейнеры да то есть сейчас у нас есть система которая позволяет там простым по 4 мы летун нарезать в и чсв дашь еще и кодировать от все вот с дробным в прессом получается говнище почему потому что в момент переключения на другую на другой стрим да то есть адаптивный streaming как работает пользователь затупил канал надо быстренько переключиться на другой чанг а вот он переключается на другой чанка там опорного кадра нет и вот какое-то время пользуете может развалиться картинка черный экран все зависит от реализации на клиентской стороне собственно как коды к релизу вот проверяем звуковые дорожки часто приходят видосы который вообще без звука вот часто приходит видоса которые помечены звук в другим языком там или еще что то вот то есть стандарт набор проверок там в том числе потом проверяем там размер файликов вот что происходит дальше поставках мы решили что оригинал в общем-то годный и его можно использовать для последующей обработки дальше собственно происходит кодирование в нужный битрейт из одного файлика в другой файлик исходный файл и результирующий файлик будет mp4 после этого происходит упаковка возможно шифрование да то есть если мы хотим заранее там по каким-то причинам мы хотим заранее видеопоток упаковать в тот или иной контейнер чтобы уже потом с отдавать серверов ориджинал статику статику всегда дешевле отдавать по нагрузке вот но дороже хранить дополнительную копию битрейт а вот значит а потом происходит отправка на собственность сервера оригиналов куда уже приходят специально обученные люди которые занимаются контролем качества от того что получилось контроль качества это двух частей первая тривиальная проверка собственно нормальным и вообще донесли файлик с контентом до сервера оригиналов на самом деле тупо проверяем md5 от потока что в нормальной со ска пировала вот один раз в год примерно вижу влогах история о том что донесли хреново вот то есть это не придуманный случай вот а дальше специально обученный человек вот который смотрит в принципе в встроенном плеере сначала в админке как это все смотрится то есть насколько нормальный соответствует там текущему качеству то что мы закодировали потом поскольку мы в общем то сервис изымания денег из людей мы размечаем метки где нужно показать рекламу вот если этот фильм будет работать по и вот модели то есть модели с демонстрации рекламы ну это что приятно для пользователя то что будет установлен метка титров соответствующие там notification там следующей серии там и прочим вещами вот после этого специально обученный человек дергает рубильник и контент уходит собственно уже сервера бэг-энда начинают отдавать ссылки именно на этот видеопоток вот это если очень кратко о том как какие этапы проходят видео чем собственно говоря мы кодируем самый большой кластеру нас это их ампер плюс разный софт то есть два типа можно выделить софтверный хардварные соответственно мы берем фмп ff проб там и прочие всякие там mp4 бокса вот и это там наверное 95 процентов всех задач кодирования которые мы выполняем однако для экономии времени а где-то год или полтора назад для проведения экспериментов мы купили пару serv очков от компании элементов частной реклама не просто правда неплохие ребята вот стоит дороже чем все наши железки там вместе взятые вот но у них есть один плюс те вещи которые тебе сложно сварить с помощью томов им пега или спонсорского софта там работают и ты всегда можешь там отпроситься в сапр искать ребят у меня вот smooth streaming не работает сделайте чтобы работал вот они тебе это отправляют а потом ты уже если хочешь это масштабировать просто тупо копируешь то что они сделали и либо вставляешь софтверные решение любишь nokia пусть это крутится на элементы собственно сейчас нас продакшене элементы используются только для одной штуке мы делаем контент с дерьмом плеер иди который отдаем вы часы сочи сад как раз сумму streaming вот майкрософтовской хрень которая сейчас поддерживается не таким большим количеством устройств ну например там телевизоры philips очень любит его вот там или там какой какие-нибудь старые самсунге и лжи вот все остальные как бы платформы несколько быстрее догоняют собственно смарта вообще проблемы с обновлением как прошивок они очень часто забрасывают старые те лики и по железу и по всему и там в общем с саппортом беда вот поэтому но там есть люди которые хотят смотреть кино в общем наша задача как-то ужас vision подружить вот поэтому 95 процентов у нас уходит на софтверной кодирования и пять процентов примерно занимаемся кодирование упаковке с помощью элемента и очень большой кусок связаны с и рэнди тоже проводим на элементах там все-таки по скорости несколько быстрее потому что там готовки написаны вот и например там историю с 4к мы первую сначала запилили на хард варнам решений историю с их диорам тоже запилили на хардвар нам решение вот теперь как это все работает внутри и как мы к этому пришли соответственно вспоминая первой проблеме что у нас там разработчики мочили эксплуатацию эксплуатации мочила админов мы админов плохо получилось да эксплуатации мочила разработчиков вот мы сделали довольно простую штуку взяли докер контейнеры запихнули то все что связано с кодированием этим убрав все сложности с настройкой инфраструктуры со сборкой ffm пегов версиями и прочими всякими вещами собственно сделали а фишечку сделали админку для разработчика с помощью которой они могут разбираться со сложными случаями админку для операторов кодирования управления контейнер и очень примитивную к регистрацию дальше я чуть-чуть расскажу чем мы пробовали из система регистрации почему решили остановиться на тривиальных примитивных решениях вот именно для этой истории вот соответственно как это работает если на пальцах запускается ну собственно вот предположим мы хотим запустить новый сервачок и сделать его частью облачко которая занимается кодированием видосов мы загружаем туда собственно через паппет всю концу конфигурацию вот устанавливать туда кром который 1 минуту проверяет если свободные места для того чтобы запустить еще один контейнер дальше поднимается этот контейнер контейнер смотрят есть ли для него задания на кодирование выполняет их на серваке есть расширенная папочка куда он кладет все свои результаты и благополучно выполнить задачу умирает вот при этом поделившись лагами с историей кадет мы все очень просто вот потом по крону просыпается новую штуку смотрят есть ли чо делать если есть то бежим туда вот очень просто работает бронебойно вот значит о чем внутри контейнера собственно три контейнера есть несколько каждый контейнеров последовательно запрашивает задачи нескольких типов сначала друзья есть ли чего сделать именно вот по самому видео нужно ли мне в какой-то другой битрейт перегнать и делает собственно mp4 вот от кодиров mp4 он говорит друзья окей классная сделан по 4 все хорошо а может быть есть чего сделать упаковать вычел с вот это может быть на самом деле не обязательно тот самый mp4 это может абсолютно любой другой им по 4 вот с другим битрейтом дальше происходит аналогично истории с дашь им дальше происходит на логично истории ssd с а вот пройдя по всем попробовав выполнить их по одной задачи каждого типа контейнер благополучно сложив результат своей работы отмирает внутри контейнера собственно бунт кайфом пеков и.в. проб mp4 box вот и все это обернуто запуск вот этих волшебных вещей обёрнут джунглей почему потому что так было проще на тот момент можно было shell script и написать можно было обернуть это все собственно джунгарские командочки вот дальше стало вопрос а как к этому всему добр ищу подключить внешние сервисы тоже довольно просто собственно контейнер имеет еще один тип на самом деле то отдельный тип контейнеров отправить задачку куда-то еще он по ssh тупо лезет на элементов смотрят если у него там ресурсы у этого элемента чтобы а выкачать файл б запустить задачку если это есть прекрасно он выкачивает файлик ставить задачку на кодирования синхронно входит ждать дальше он в цикле ки периодически спрашивать элементов есть чё там готова если готова опять в одетом выкачивает уже обратно и кладет в общую папочку сейчас секунду вот сюда вот там складывает результата кодирования таким образом мы подключали там несколько разных очень простых рпц сервисов и недели не очень простых чтобы интегрировать это в систему кодирования соответственно чё дальше а дальше это все выкатили в эксплуатации начали получать первые веселые отзывы ну собственно таким образом появилась вот такая вот интересная систему приоритетов это все взято с реальных запросов которые отправляла нам различные департаменты но собственно самым высшим была названа приоритет внезапно вот автор этого человека который создал эту классификацию володе прохода методично это все выписал вот и сейчас действительно вот такая система приоритизации и они в этом прекрасно разбираются они знают что там мне надо вчера это намного более важно чем супер срочно вот а супер срочно это почему-то важнее чем нига срочно вот ну вот собственно какие пользователи такие и запросы вот с приоритетами более менее понятно но приоритетов оказалось что почему потому что ну все естественно начали мочить внезапно то есть майор задать самое важное там еще когда там бизнес пытается навесить туда кончики пи ай там типа ты должен там от кодировать там не знаю там 20 видосов в час там ведь и так она там конечно ниже надо внезапно внезапный давай давай горшочек вари вот ну и всех вы однозначно появилась внезапно к чему это привело привело к тому что там действительно важной задачи стали тупо ждать ресурсов то есть если посмотреть на ситуацию то можно было совершенно спокойно там видео которое нужно там через 4 месяца только появится на продакшен можно было поставить вас обычным переодет она бы все равно заносят кодировала вот но пока люди сидят в офисе им же нужны как это шампуры и переворачивать говорит что у тебя подгорело эфир вот это вот все вот по этому у нас появились маршруты чуть такое по сути мы отгородили в своих вычислительных мощностях штуки куда может ходить только определенный департамент но то есть вот из действительно срочных задач у нас это трейлер и рекламы и горячий премьеры мы потом в этом году довольно часто выкладываем штуку под названием как форвард когда мы выкладываем сериалы до эфира и народ дрючит наш сапорт ну когда же когда же там следующая серия там отеля или он там я уже не могу ждать вот и там действительно время идет там будет смеяться правда вот я уже не говорю про популярность сериала сваты 6 значит поэтому горячие премьеры особенно которые идут к с форвардом или к чатам catch up это когда сразу после телеэфира идет вот вот эти штуки нужно выгружать быстро с рекламщикам еще хуже потому что при таком большом количестве пользователей там получасовая или часовая задержка можно посчитать в деньгах сколько это эти деньги соответственно упущенной выгоды компании и как только в спор между разными подразделениями встает бабло люди перестают быть людьми начинают там доставать топоры войны и в общем кровь слезы и сопли поэтому мы отделили сделали резервации назвали их маршрутами куда можно ходить куда ходить нельзя вот на самом деле срочных задач действительно не очень много то есть там если бы у нас там супер горячих премьер там в день какие там цены 20 рекламных роликов в день приходит одна железка справляется с этим вот так вот да то есть они в принципе сами собой не конфликтует вот а все остальные вещи совершенно спокойно могут решаться приоритетами вот выделив собственно для дела контента для премьер там и трейлеров отдельные загончик где они сами с собой там договариваются вот выделив для рекламщиков отдельную историю получилось так что они смогли более-менее неплохо договариваться вот и вести диалог вот ну как мне это кажется может быть они конечно уже грома наверное так и есть вот значит а теперь какие проблемы мы встретили по дороге ну собственно службы эксплуатации когда к ней приходится чем-то там новым она всегда это в штыки потому что девиз службы эксплуатации не трожь технику она тебя не подведет соответственно вот в случае с я смотрю и поцелуйчики сидят на первом ряду вот соответственно как только приходит что-то новое это значит тебе нужно меняться вот изменения всегда происходит через боль человечество другого пока я не придумала вот поэтому мы хотели вообще с историей с виртуализации там с дагерами хотели запустить несколько шире чем только систему кодирования вот и пошли двумя путями первое это мы начали попытались внедрить кубер нить из для того чтобы у нас работали тестовые кластера для наших quien жене raw на кубер нити на нужно было оркестрация вот это было два года назад напоминаю полгода мы блюд а бились головой об стену пытаясь решить те проблемы которые вот-вот через три месяца сейчас мы завели зим все будет хорошо это я про инженеров к вернется сейчас я перед докладом посмотрел какие изменения произошли там за 2 года до действительно там порядка наверное 70 процентов наших проблем закрыты то есть сейчас уже можно этим всем наверное пользоваться но мы полгода уже убили и пока сейчас я думаю следующий виток будет на этом через полгодика годик вот но при этом нам очень понравилась история как раз докер контейнеры с простотой которым можно завернуть нужную тебе конфигурацию причем абсолютно не имея конфликт между отделом эксплуатации отделом разработки дата у нас есть отдельный devops инженеры которые помогают людям вот это вот все там ужас vision скрещивать вот но тут в принципе и союзов докер-контейнер получается довольно просто вот но кубер нить из нас доконал человек который его внедрял приуныл в hud'е через полгода уволился вот потому что ты делаешь ты делать вроде как хорошо вроде по документации там им если у тебя правильное направление у тебя правильный вот но вот горшочек не варит а через месяц поставках мы решили мы все не будем делать кубер nights один из наших разработчиков взял и написал очень простую систему оркестрация вот как раз для решения локальные проблемы поднятия теста кластера для тестировщиков то есть к бернейс решает все таки как бы более глобальный проблемы там как на продакшене все это делать дат не только на тестом кластере нам нужно было прежде всего да у меня была мечта там ломанутся с этим на продакшен но сначала был первый шаг идей первого шага сделать и сделать тестовый инфраструктуру и вот тест руссо структура оказалась намного проще сделать без помощи сложной системы оркестрация вот хотя я ни в коем разе не критикую путь кубер нить из это правильный просто вот на тот момент когда мы начали но было еще очень сыро вот еще там не заговорил с вами го класса итак что нам удалось добиться ну во-первых действительно простота в эксплуатации докер-образ собирает вставлен быстро там низко секунд вот мы получили очень хорошие возможности масштабирования то есть есть вычислители мощности поднимаешь туда собственно все что тебе нужно с помощью пакета и все работает шустро и быстро очень важно для нас это подробное логирование всех этапов обработки видео снизили количество обращений собственно от in jest а в отдел разработки дать мне важно чтобы разработчики все таки занимались разработкой они занимались саппортом вот сейчас там наверное раза два в месяц максимум кто-то из программистов смотрит а чо произошло вот 100 или иные задачки что идет не так при этом как правило не лезут в код а используют специальную админку и вне как техническому директору стало несколько спокойнее жить что люди там не перекладывать бумажки с одного ящичка в другой в общем-то делают добрые и светлые вечное ну или нет вот соответственно попробовали на примере элементов и например там каком-то упаковщика вычел с яблочного подключать внешние сервисы вот и но это уже по необходимости за шестнадцатый год несколько раз перекодировали пять или шесть или четыре часа уже точно не помню очень примерно вот таким полностью каталог это был нужно как раз там для оптимизации работы фидия на для того чтобы адаптивный streaming лучше шуру пил вот но в принципе да создания вот этой системы вопрос перекодирования всего каталога мог занимать там от полугода до года но здесь люди много видео вот теперь же в общем на самом деле где-то я думаю за месяца полтора-два можно справиться вот вопрос только зачем то есть если у тебя есть за полтора-два я имею на тех мощностях которые есть у нас сейчас при этом совершенно спокойно можно арендовать какой-нить облачко главное чтобы облачко было где-то недалеко от тебя потому что как-то к нам пришел amazon искал ребята смотрите классической задачи там давайте поднимите у нас там его спросить у них есть ну так чтобы вак вам близко нет игру смотрите вот у нас там два петабайт а нам нужно там условно говоря оригиналов перегнать их туда а потом забрать сколько он вам завтра фон заплатим да тут есть в россии поднимемся придем вот то есть вот и это по времени если гонять куда-то далеко расстояние имеет очень существенное воздействие на вы выбор партнера где можно например поднять внешней вычислительной мощности вот ну и собственно клей теперь в принципе получил возможность тестировать потому что две недели которые я описывал раньше на тестирование и проверку качества любой новой фичи в системе кодирования это ад и содомия просто на корню заруба it все желание получать какие-то фичи от этой системы а так сейчас там денек 2 но если уж совсем геморрой ну три четыре вот ну понятно как это делать с тестировщик в этом случае не занимается инфраструктурными проблемами он не ходит вокруг devops ironik блин меня вот вот тоже самое не работает почему вот ну и собственно сейчас по крайней мере тестировщики перестали я надеюсь боятся частное послушают доклад скажет нет все еще боимся вот перестали бояться брать на себя задачки по контролю качества системы кодирования вот мне кажется я уложился в 40 минут очень старался вас не нагружать давайте перейдем к веселым вопросам здравствуйте добрый день я подскажите пожалуйста пару вопросов вот видео которое вы гоняете для кодировщик автом и вас два петабайты каталог это как вообще построили это хранилище там как эти сервера выкачивает это видео то есть по какому протоколу там это происходит привет все еще т.п. то есть почти 15 собственно говоря идет обработка а вот то что у говорить вот контейнеры ваши запускаются по крону там спрашивать о кого не спрашивают сервер очередей какой то я не стал на этом акцентировать внимание там ничего сложного есть собственно под гревы и не или манга пампа зря вот он будет короче да короче есть бы где хранятся храниться инфа о всех запросах ну собственно контейнер статусах тоже пишет все в обиды и последний вопросик маленький сюприз ну там или кратко джипу какой крюк кодирования живу делаете или все-таки там обычные циклу в основе смотрите у нас есть а в обычные цыпа ушки вот в 95 процентов кодированных является на обычных цыпочках есть два serv очка для экспериментов и нестандартного программирования дает вот элементы узкие там джипа ушки вот мы каждый год мы делаем новый тендер и смотрим имеет ли смысл купить там янину один сервак с же пушками стоит как 6 серваков обычных вот и а когда ты ставишь их рядом и просто проверяешь по скорости ну да там по питанию чуть чуть меньше не хочу классно вот но каждый раз мы считаем 1 году может случилось чудо сейчас для наших целей подойдет и вот это казалось бы да но вот пока еще нет вот месяц назад сын видеть снова поговорили нам вот они вчера прислали на тесты новые новую железку для того чтобы посмотреть как и что посмотрим если действительно экономическая целесообразность будет есть то что g пушки классная не спорю но мы можем построить примерно ту же скорость просто раз параллели все эти на других жилья фриц спасибо большое спасибо спасибо за доклад . vitaly все конец микрофон то вы слышал собственно вопрос 2 во-первых собственно элементов как таковой система кодирования и чистим пакетирования превосходит облик один в него спонсировать да только ли твердость пакетирование у вас пайолы я напомню за кадром и там высота запаковывать его человека и все матчи единственного что мы запаковываем на элемент или это и час с и шифрование вы делаете целиком на фоне вы не на уровне питера делать я прямо на этапе кодирование ну и так пакетирование мы делаем есть по китай зерга которому ты скармливали условно говоря что тебе нужно упаковать и говоришь вот там вот сервер лицензий там вот ключи вперед сделай мне вот этому ну тут просто непонятно что происходит собственную encoding об этом начали говорить про диаграмма ну ладно они связаны между собой понятно вопрос 2 1 вопрос от рассказывают вы собственно сэкономили кучу денег на эксплуатации прочим но это вам стоило очевидно как какие-то уже на безумных сроков разработки есть какие-то примерной оценке сколько стоила разработать вот саму систему in category пакетирование расширили пятниц четыре-пять месяцев команда из двух человек понятно и второй вопрос по ты говоришь 2 нейролептиков бернейс на нем мы не внедрили кубинец попробовали простом два года назад у нас не получилось а просто мы смогли ли вы нами за смартфоном от рассмотрели а ваш кейс вот непосредственно ваш посмотрели по поводу этого можно отдельно долго говорить там были чудовищные проблемы по поводу сетевой связанность вообще адресации вот и на месяц с марафоном с мортоном мы потратили около 2 месяцев вот и пришли к выводу что да это классное замечательно но можно сделать сильно проще для смотрите как бы если говорить про те преимущества которые даются там система артист рации для именно продакшен использования классно да то есть то что там заявлено что может любое количество инстансов поднять нам и прочее но вот для задач который скрыто от пользователей да там по хорошим для внутренней системы бэк-офиса ну мне кажется это из пушки по воробьям а идите еще найдите людей которые нормально вам кубер найти свари вот поэтому вот это скорее административные решения нет не полетела да у нас сетью были проблемы именно с тем как там с этим сетевую связано сделать потому что там все настолько через жопу что прям больно спасибо за доклад пару вопросов админских собственно на чем хранить это петабайт а как-то бэкапить или ну значит у нас сервелат отдельные большие хранилище для честно говоря забыл как они называются могу вам сказать после доклада когда погублю где мы храним именно оригинала которые приходят от правообладателей вот этот их мы используем для последующего перекодирования если нужно будет перекодировать за ну вот а так по парочке насчет каждый файл хранится в двух местах на 2 serv очках в разных дата-центрах бэкапов но собственно не же самые то есть являются backup здесь аналогия как с китом что у вас есть бэкапы на сидения у вас есть ну по сути да там у вас есть просто резервирование хранения вот если вот все там забэкапить ты из нормальных адекватных по деньгам бэкапов быстро это все не вынешь иногда быстрее просто перекодировать тому то есть правда и второй вопрос касается логирования собственно чем парсить и чем парсим что логик где хранить и значит смотрите киба на явине спасибо за доклад вопрос такое смотрите но понимаю что вы для разных платформ видео держите до вопрос сколько в итоге копии одного и того же вы храните под разные девайсы просто смотрите вот там в начале презентации была история про 52 формата храним из этого мы меньше потому что 52 это самый плохой вариант вот и он скорее всего да ты сам плохой вариант когда нужно обо всех да и remove на всех платформах вот соответственно а так сейчас вот мы как раз экспериментируем с генерации на лету то есть у нас уже даже это работает на проди вот примерно я думаю что ну вот смотрите у нас 6 по моему битрейтов да то есть вот приходит исходник 6 битрейтов дальше как бы в идеале мы хотим хранить вот только вот эти 6 в идеале вот соответственно сейчас мы умеем из них на летуны резать мы через и чудесном сканирование двери matrix и через с кодированием перейди который там нахер никому не нужен нужно делать из этого и д.с. они тоже с не можем на лету можем делать этого даже вот соответственно поэтому но при этом для например того же самого и двайное проще мы храним еще и копии за заранее от кодированных потому что тут нужно несколько дольше времени на проведение тестов потому что не всегда понятно ты облажался потому что ты облажался с кэшированием на одном из седин узлов или ты облажался с тем что у тебя просто за заглючил грм вот поэтому сейчас наверное где то вот если говорить наверно 18 примерно вот так да спасибо да информация очень такая прям интересно я живая вот еще несколько вот тут несколько раз упоминали что вот сетью там перегонять там какие-то проблемы были достаточно большие а вот какой то отдельный ребята который там сетью занимаются над опыт какой-нибудь или молите как вы не работаете у нас нет проблем с сетью у нас прекрасный отдел которые занимаются исключительно сетевыми вопросами вот и который собственно занимается сетевой связанностью вот и там подключением пиров там различных операторов и проще проблема была в том чтобы совместить сетевые потребности каждого микро сервиса с внутри себя и чтобы это было все еще под управлением там какой-то системы оркестрация то есть не проблема не с тем как мы настраиваем сеть тут у нас как бы наши ребята боги вот-вот проблем отвод для нас пришло новые технологии вот незнакомой да вот там либо местом либо там кубер нить мы начали в этом разбираться и попробую решили попробовать а насколько она для нас применимо потому что хочется очень минимизировать касты на тот момент времени пришли к выводу что не очень применимо может быть будем пробовать ещё и вот тогда еще стоит уточнить уже соответственно есть ребята админы программисты и сетевики вот какие то перекрыт как-то не знаю перекрывающий зон отверстие вот они между собой на каких уровнях взаимодействуют и и вот он готов происходит смотрите есть админы которые любят программистов есть админы которые любят админов вот собственно в отделе эксплуатации есть там несколько человек которые занимаются исключительно задачами разработки ну то есть вот они помогают разработчикам тестировщиком там сделать так чтобы у них там было что-то хорошее например вот мы пробуем запустить новую систему генерации проблем сети да вот это как то есть вот по хорошему надо тестить как работает адаптивный стримит ну к примеру до для этого вам нужно эмуляция проблем сети то есть можно купить железку там за там несколько тысяч долларов вот а можно взять там софтверная штуку пропустить это все через нее искать оки гоу тут у нас будут такие to drop и пакетов тут у нас будет такая штука тут у нас будет такой от штук вот и вот в этом нас как раз собственно devops инженеры по хорошему ребята сидят вместе там они меняются кто за никто там дежурный кто там нет вот это вот все по-хорошему там сначала когда приходит новый человек к нам в команду он сначала ближе к программистам чем опытнее он становится тем ближе к продакшен он подбирается привет кирилл салафун же никс вот как раз тот самый сидел про который уже не говорит что дороже шесть раз трактовались у меня вопрос немного такой более концептуальные да ну ты говорил что 4 кей в том виде увеличивается и так далее на крик вы смотрели уже тестировали может быть уже обсуждали думали и рассмотрели но пока еще нет не дошли до пока пока еще нет все можно поговорить листики 2 мы не мы не делаем смотрите вот особенность я немножко лукавлю да когда говорю что мы сильно дешевле чем классические седины но это достигается очень одной простой штукой мы не решаем те задачи которые нам решать не нужно вот во первых у нас нет у живого потока вот а значит нам не нужно его на ходу а на лету это плагин чик для engine со вот собственно самим по продолжим если на тот вопрос который вы не задали но я начал отвечать вот соответственно мы умышленно не в свой сидим сейчас пока не легкая не заставил не делаем именно живой поток это другие правила кэширования вдруг другая архитектура но умышленно исключая эту задачу можно использовать более дешевые железа и решать ровно ту задачу которую тебе нужно дешевле и эффективнее чем универсальная машинка которая умеет все с вами весело друзья спасибо"
}