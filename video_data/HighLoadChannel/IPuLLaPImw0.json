{
  "video_id": "IPuLLaPImw0",
  "channel": "HighLoadChannel",
  "title": "Open Source SQL-базы данных вступили в эру млн. запросов в сек. / Ф.Сигаев, С.Смирнова, А.Распопина",
  "views": 2248,
  "duration": 2987,
  "published": "2017-04-22T14:47:47-07:00",
  "text": "Ну пото что это очевидно так соответственно дальше мы дальше мы говорим про Свету Вот потому что я про неё лучше знаю Поэтому я решил начать начать с неё то есть Света инженер технической поддержки С myq С каким стажем то уже более де с 2006 года с 2006 года то есть более 10 лет вот дадада это человек который титанический труд не один юбилей я пережила Вот соответственно Света автор книги маль л shooting и изданный уважаемым издательством о Райли Вот и собственно это человек который сделал возможном в конечном итоге поддержку формата данных JS в mysql 57 то есть та работа которая была ну это был зайн прота это не не тот код который сейчас есть нет Ну понятно что это как бы работа которая предшествовала не собственно Вот и ещ то есть света тоже приложила руку к для Ну и была докладчиком понятно почему то есть Oracle Open и соответственно ряда российских конференций вот сейчас мы собственно перейдём к красному углу Кома стам три мушкет всегда вместе Олег бартунов Александр Коротков Фёдор сигаев Вот то есть это команда которая наверное на Российском пространстве в представлении уже не нуждается вот собственно они вывели уровень пост коммьюнити на то что мы сейчас собственно и видим То есть это люди которые делают в России постгрес совы конференции люди которые выступают на постгрес сох конференциях по всему миру Вот и люди которые активно поз контри То есть как в ядро так и этеншен соответственно там было много чего сделано полезного от полнотекстового поиска расширяемость и э каких-то носик альфи до собственно каких-то более э специфических экстеншн вот ну и соответственно сейчас э опять же начнёт Света потому что у неё был промежуток между конференциям больше она успела прогнать тесты и сделать слайды первый вот Спасибо Настя ой О'кей mysql А вообще для меня могло быть всё сильно проще чем гонять с тесты Почему Потому что есть такой человек Дмитрий Кравчук Он работает в performance te оракле и Он занимается тем что он тестирует производительность mysql перед тем как она станет J и он вот эти свои тесты он их регулярно публикует и очень детальный отчёт что он тестировал как он тестировал где нашли Нашлись ботл неки как они их исправили я мог просто сделать Сашу коротко попросить их прогнать на поре и сидеть тут докладе со стульчика просто наблюдать Ну вообще проблема оригинально це идеи была не только помериться кто может сделать больше запросов оригинальная цель вообще меня как инженер технической поддержки Я работаю с клиентами и клиенты сейчас использован это не такой даже можно сказать может быть и не столь частый случай очень часто бывает так что некоторые компании они используют несколько СУБД и они не могут допустим перейти на какую-то СУБД просто потому что это разные продукты там может быть основной движок там на одной базе там допустим тикет трекинг на другой базе как правило уних есть тоже у с экспертизой в одной из баз А и без экспертизы Ну ну как бы разбираясь в общем-то будущей dba мы все можем как-то работать и с другой SQL базой но а как правило лучше разбираемся всё равно в какой-то одной то есть оригинальная цель идеи была помочь вот этим людям как-то отвечать на вопросы Найти какие-то вещи которые пересекаются которые работают похожи может быть где-то просадка производительности где-то может быть изменения в поведении и так далее эти базы они имеют общие проблемы такие как ну вот если с точки зрения наших клиентов это скорость записи на Мастере это максимальная производительность Сва и это влияние таких вещей как контрольные суммы как синхронизация и так далее и в общем-то один вопрос как получить лучшие результаты для этого всего на похожем обоп очень часто бывает что база разные но какой-то да цент там закупили одни и те же машины и вот идея была такая то есть для того чтобы получить ответ на этот вопрос нужно использовать одинаковые тесты Свет ну чем в итоге тестировали Сим или что-то треть взяли предлагал Проблема в том что в мере поса у них стандарт тестирования и те его стандартные иследования это Сич и его стандартный тест оригинальный в общем-то обе sbch у него есть расширение под работы с погсона у нас была идея взять Сич и переписать и переписать тесты постгрес совские под него и чтобы погонять ити другие тесты на постгрес на Мас посмотреть сравнить чтобы вот ну взять вот эти вот стандарты которые сложились в обоих мирах и обе их посмотреть а ну у меня случилось Я в общем первое что я сделала я взяла пег бенче ский стандартный тест и переписала его под sbch формат и собственно с чем я столкнулась А ну во-первых у меня было две машины для теста это машина пико там а а машина пико они а то есть у неё два 12 физических ядер а 300 250 1 ГБ памяти и очень быстрый диск ну быстрый диск 33 Киса и машина это которую партнёры предоставили для тестов Она наоборот она у не очень много 72 физических процессора 3 раба памяти но почему-то такого консьюмер ского уровня жёсткий диск всего с м кило осами ного просо чтобы тестировать проблемы в памяти с процессором а не с диском ой и я прогнала тесты на обоих машинах и обнаружила что это mysql тест который оригинально написан для конвертирова производительность получилась одинаковая Как бы мне бы хотелось бы использовать машину 100% памяти это Point Select он это то же самое в принципе этот вот тест единственный который тестируют И те и другие свет а нормально что нли на 100% в памяти вот ты как инженер поддержки у клиентов такое бывает бывает то есть в памяти имеется в виду когда данные а в общем могут быть в ndb бафер пуле а и такое Ну достаточно часто что у нас база больше на db бафер Пула Ну и в то же время это как бы сказать не редкий случай когда у клиентов активный сет он помещается в бафер пуле и реально вот ли нагрузка она полностью в памяти То есть это нормальная тесть а также что ещё хорошо в этом тесте а то что а pgbench ron Test и а sis Bench Simple Select тест они оба используют Point Select и они в общем-то одинаковые тесты вот а я запустила и у меня получилось 700.000 запросов в секунду что как бы несколько меньше чем было опубликована Дмитрием я стал смотреть А в ЧМ дело Почему у меня на в общем-то аналогичной машине у меня не получается и оказалось что использовал столько же CP сколько и mysql то есть грубо говоря он просто не давал работать на этой машине решение решение я говорила И с Дмитрием и с Алексеем копытом который разра СП СТ и нли равно О они оказывают влияние на вот высоко конкурентной среде также Алексеем было Вот для лода была приведена ветка в конкуренции Kit была как сказать последние изменение на гитхабе Как сказать он стал в общем сделал изменение чтобы она была более стабильна её можно было использовать в тестах а также но это уже не как бы помимо вот этой проблемы во время использ текста помогло ещё переписать лу скрипты с используем мента использовать старую версию синка без поддержки скриптов мы не могли потому что вообще ну потому что в исследовании терялся смысл то есть мы сейчас не буду показывать кастомизированные скрипты но в принципе мы хотим сделать это ну вывод в общем-то Написать хороший теже просто а промежуточные то есть в данном случае Какие у меня результаты получились вот связи с этими улучшениями А прежде всего хочу рассказать системную конфигурацию опять-таки это важно А что здесь важно vmap Ну вот оно по умолчанию оно то ли 30 то ли 60 там в разных операционных системах сейчас оно должно быть едини чтобы у вас mysql никогда не уходил в swop Ну кроме случаев когда у вас система будет уже краш В таких случаях онн а уйдёт SW EOS sked был на машинах fre установлен deadline он может быть ещё установлен в noop но ни в коем случае не в cfq А Что было добавлено было добавлено CPU аверн поставлены в performance А И вот изменены вот эти вот опции керла ээ Фёдор у нас этот слайд Не повторяется то есть а какая системная конфигурация у постгрес была На тестах такая Ну нам её фактически настроил свет но не правда А операционную система наибольшей эффект мы попытались идеальные условия обеспечить чтобы всё было Поче всё одинаково с точностью до настроек ядра даже на самом де с для прироста достаточно значительного значит конфигурация mysql я взяла последнюю версию перна сервера 57 15 и конфигурацию Дмитрия вот тут скобочка с небольшими изменениями у меня конфигурация есть на слайдах но я её не буду её вам всю зачитывать потому что её скачаете слайды здесь важно что у нас вот большие значения Table Open чтобы дескрипторы не открывались не перекрывались Ma тоже большое значение чтобы это можно было тестировать инструмента выключена вот per SK тут интересно Она у меня стало оказывать влияние где-то после после миллиона запросов то есть до миллиона она даже вот включённая она на результаты тестов не влияла сервер специфические опции они кстати в общем-то тоже сильно не влияли но я их отключила све вопрос и установлено значение 12 то есть тако такое вообще в продакшн бывает то есть и почему поставили я расскажу почему поставила поставила потому что вообще вот первоначально когда NB была молодое у него было единственно NB бафер по была одна единственная инстанция и вот Несмотря на то что данные все были в памяти при обращении к нему установился глобальный Лог который Ну вызывал некую Котен в версии 56 Вот появилась возможность сделать несколько инстанций и вот когда я гоня тест у меня вот был вот этот cont Даже несмотря там со значением по умолчания сво баферов и в общем-то Я старалась минимизировать этот процесс в продакшене почему-то люди так вот не устанавливают Я не знаю Я бы хотел бы протестировать может быть с большим активным дейта сетом в таблицах чтобы оно было там как бы ну в моём случае Там наверняка вся таблица помещалась например в один Баер то есть в общем Ну посмотреть весь один результат запроса был в одном бафер так скажем первая склянка 15 минут окей Окей спасибо большое значит пойдём быстро значит здесь что важно важно вот э вот опция этон если нету тив ВМ пытается сделать получить этот Лог и получается тратить цпу циклы впустую а впустую и вот эта опция регулирует регулирует чтобы была некая задер Ну тут есть такой трейдов что мы увеличиваем й мы больше ждём мы уменьшаем й мы больше тратим CP циклов для н для значения по умолчанию подходит тут выключено потому что это R но в этого делать не надо у меня там вклю ладно я тогда про эти опции расскажу приходить у нас будет два перна Мета сегодня Приходите Я могу рассказать вот немножко про Bench мы брала стандартные тесты prep для там несколько Селект запросов - это и для а Simple - это Point Select ну и соответственно опции которые включают табличка у меня тут 10 млн табличек вообще размер таблички он на результатов тест количество вот для нли он не имеет значения для рай наверное да значит что у меня получилось Получилось результаты редон они получились несколько хуже чем у Дмитрия но А почему мы с результатами Дмитрия сравниваем сразу таем Да сравниваем потому что как бы хотелось такой бейслайн с того момента не то что вот как бы мы что-то там получили как-то оно за производилось хотелось получить какую-то Ну нормальную производительность которую может добиться от мас на этих машин которые хотя бы ну как-то более-менее чтобы какое-то было честное в общем-то сравнение и с результаты по селекта они тоже немножко хуже Но тоже можно хотя бы как-то Представлять с посо так Ага ну ты перешла к ра сейчас конфигурация она отличается Да она отличается опять-таки я не буду про неё рассказывать а значит вот лучше для тестов получилась опция о есть ещ о просто есть ещё сервер опции когда то она почему-то хуже работает здесь для 12 но вообще-то нету такой формулы что типа вот на такой-то машине поставьте такую-то опцию это надо тестировать и смотреть Это просто с профайлером значит что у нас получилось у меня получилась некоторая Аномалия который я не могу пока объяснить Ну во всяком слу я могу частично объяснить только Первое это Аномалия вот вот почему-то после ше клиентов стало замедляться и падать объяснение к ним такое что что когда для транзакции берёт сшт один раз а для каждого запроса там селекто и три апдейта проблема в том что я вобще ожидала вот такого результата это на пиковский машине с с физическими ядрами с виртуальными одинаковы во всяком случае может быть некое проседание на больших запросов Но вот не такого момента То есть я буду не знаю либо слать Бах либо что-то делать с этим вторая Аномалия - это Аномалия то что так как диск на машине к не быстрый А я хотела попробовать с рам диском и вот у меня получилось что результат тесто Вообще одинаковые Фёдор а будут результаты по диску от поса наверно памяти много будут конечно Окей значит полезное сравнение всё-таки то есть Несмотря на то что получилось несколько не так как ожидали польза всё-таки была как я понимаю ну какая-то польза Да значит что можно сказать со стороны myb его влияние вот оно вот у меня получилось вот такое на машине опция которая в общем-то рекомендовала иногда отключать для луше Фома на каких-то машинах где вам не нужны не вы не хотите восстанавливать данные после крш операционной системы она в общем-то не влияет сейчас на производительность а будут Кстати у поса какой-то аналог есть дабл райта дабл райта нету А вот 3X вот этот вот синхронный асинхронный комит это прямой аналог и есть Ага Хорошо а к Сумы My 56 есть кса CRC с алгоритмом CRC 32 57 они по умолчанию и они вот совершенно тоже практически бесплатные а будет аналогичный тест контрольный Сумма от постгрес да И там тоже будут неожиданности правда немножко не такие так вот оставайтесь с нами А это ну такого я так понимаю в постгрес нету а бинарного Лога не имеет смысла но я просто протестировала потому что конечно же А ну честно говоря за последние 10 лет я всё реже реже вижу машины без бинарного Лога Ну вот bog 1 это рекомендуемое значение когда каждую транзакцию bog синхронизируется на диск его кстати можно установить больше единицы и будет каждая там транзакция синхронизироваться А и опция 0 когда мы отдаём всё это операционной системе решать когда бело будет синхронизироваться Мы видим что bog 0 до 7 трев тут производитель вообще не проседает а потом идт вот тако плата Ну и симен Log 1 и она ожидаемая тоже проседание немножко производительности и вот плата так и почему же эти результаты стали возможными а а ключевые изменения в ndb оптимизация transac list то есть что такое transac list то есть первоначально в ntb был один лист транзакций глобальный на на ВС а куда при создани транзакции транзакция туда попадала а версии 572 он был разбит на Два листа read и ron то есть соответственно хотя бы rly не были Ну в общем хотя бы это было Два листа То есть уже меньше кон А в 573 по умолчанию транзакция вообще ни в какой лист не попадает до тех пор пока она не открыта с опцией специально R таким образом rly транзакции они вообще никаких КФ позволяет сделать rly performance очень высоки А ну есть Побочный эффект что этих транзакций не видно в шоу eng NB статусе подробнее можно вот слайды будут доступны это активные ссылки подробно можно посмотреть их Вот вот здесь а дальше в NB уменьшен вот вот это вот ко Это что такое Это у NB есть четыре вида лока ИМТ ИМТ эв Эксклюзив иплит - Это значит что перед тем как взять взять эксплицитная попадает как бы говорит Я хочу взять Привет Я хочу взять такой Лог Потому что если она его взять не может она попадает в список и чтобы не было так чтобы первый пришёл а там какой-нибудь двадцать первый только получил этот Г И вот в момент когда конвертируется вот этот вот имплицитная один лог на полный индекс 3 то есть на на всю табличку целый Лог То есть если вы делаете конкурентный Запрос к одной табличке у вас вот такая Котен а появился быстрый и параллельный флашинг то есть появилась такая опция несколько потоков й клинеров которые вычищать грязные страницы из NB папула Что лучше чем это в один пок это происходит быстрее улучшен адаптивный флашинг адаптивный флашинг - это он алгоритм который автоматически решает когда проводить флаш он улучшен уменьшено вообще число страниц которое должно быть ФТ а также изменена масштабируемость metadata Log убран вот этот вот к брался зачем-то для NB который берётся опять-таки при установки Мета Дета лока он разбит на части вот это количество частей оно постоянное оно харко будет и используется для его выборки Т ID Ну как правило оно выбирается более-менее нормально и позволяет либо уменьшить либо полностью удалить Н В зависимости от количества соединений и также вот в Мета Дета лока у них тоже есть такие вот для он был убран свет А что ещ изменилось ты говорила ста быстрее дама стала быстрее но естественно когда для тестов я не включала никаких инструментов для инструментов это нужно делать какие-то дополнительные тесты появился как я уже говорила Ну то есть точнее он появился давно Но вот он стал по умолчанию 5 быстрый алгоритм То есть если вы когда-то отключали ния этого недо также увеличилась производительность временных таблиц то есть они в самом деле временные То есть их нету ни вреда не в логе потому что они там просто не нужны ни в инсет бае Ну и никак не появилась ещё отдельная tace для таблиц они теперь не могут быть не в систем не в системным также Появилась возможность выгружать и загружать бафер потому что сферм там Какая история получается что Когда вы только стартовали сервер а перед тем как он зарабо Ну даже если у Вас он допустим работал быстро а потом Вы перезагрузили компьютер и у вас какое-то время идёт на то чтобы е разогрев Вот теперь можно сэкономить просто загрузить и выгрузить бафер пол это немножечко делает медленнее а стартап и shutdown но оно того стоит всё равно это быстрее чем разогревать его и много чего ещё так ну Итак мы переходим к к Фёдору Почему собственно не удалось сис бенче постс протестировать И как из положения выходили как издевались над Си Ну мы попробовали и не получилось первое на что наткнулись это то что баг в самом сис бенче он неправильно обрабатывает нулы там вот патчи вот во втором пункти есть очевидно что они просто проверяют что есть существует указатель на знание нул или не нул но содержимое вот этого поля не проверяют Ну это быстро пофиксили но случись неприятность следующая просто загрузил всю машину нафиг и не даёт времени поработать постгрес вот здесь вот хорошо видно то что постгрес тратит порядка 4% времени А сам си сожрал 250 ну как бы это ни странно не звучала с это что вот это вот исправлять времени никакого не хватит то есть авторы мы это ВС загрузили показали что Вот в такой позиции меряет самого себя не постгрес и значит решили сделать наоборот то есть традиционные тесты mysql перевести Ну в ПГ поку ч уже скрипту первоначально это было не так вот Т Саша писал полностью перевёл скрипты вот такой вот тесты значит здесь единственная тонкость поскольку пгч не умеет генерить Рандомные строки разложили это на базу данных поскольку мы вертим ич бенчмарка и сам порс работают на одной машине то собственно какая разница на какой стороне генер эти случайные стройки а алгоритм расч этих строк взяли А вот с тем чтобы можно было поиграть Ну вот это ВС опубликовано можно себе скачать но только без фон сайза он тут случайно вылез у вас всё получится можете потестить на своих машинах Только не забудьте положить прод перед этим а то мешается значит результаты ну сказать вкратце В 96 собственно на Компани вообще сообщество Но упиралась вот в эти влон и так далее выборки и вот тут К сожалению нет тестов 95 которые были бы ещ ниже но мы нашли после как случился рфз 96 Мы ещё нашли способы ускорить поэтому мы демонстрируем здесь два графика один это вот ванильный 96 синенький и зелёненький красивенький такой Сват друг другу через эту память процессы по друг другом общаются мы её выровняли по шй чем это я щёлкнул не я дальше Вот это вот запрос кстати просто вот точечный Ну правда для меня термин оказался новым Я как-то всегда пользовался там запросы или запросы только по я при вотт са слайды назад простой скрипте вот редон запрос на этой же большой машине Сверху над слайде написано как это можно было приблизительно какая машина и в сколько потоков мы это гоняли мы вообще ограничились 250 потоков знаю что в общем-то пог я сильно опаздываю не очень лют большое количество коннекто по разм Прим можно отдельно обсуждать если кто хочет заходите на митап и спросите меня ну только кофе Сначала налете я расскажу Ну вот 30 минут вторая склянка Так что ещё у меня чувство времени видишь Да вообще значит РВ РВ опять же Ну все знают там какую-то борьбу типа надёжно хранить и и быстро высчитывать либо хранить ненадёжно но зато мы при этом будем у нас большая большая скорость быть Вот собственно вот эта вот настроечных комит то есть в постгрес синхро комит собственно говоря это база не отдаёт подтверждение комита пока данные не долетели до диска точнее подтверждение комита не долетела до диска а Син комит база может ответить раньше естественно Есть риск что если вы внезапно грохнули то вы потеряли несколько там последних транзакций Но обычно это никогда обычно никогда не превышает секунды Ну и сонно очевидно что асинхронным коммитом быстрее Единственное что вот поит на указание на возможные улучшение то что потом эти кривые гораздо ближе к друг другу чем в области порядка 100 ядер То есть это Натка на то что не ВС ладно В корост нашем Ну вот он собственно диск Ну тоже В общем машина оказалась такая несмотря на её Т кила ипса совершенно неважно на диске мы находимся или не на диске совершенно неожиданный результат с ксму имейте в виду что посчитать ксму на странице быстрее чем её не считать какой арим использу до этого использовался какой-то там самописный ССД лицензии Бог знает откуда взятый а потом была проведеная работа на то чтобы заменить этот алгоритм на то что в современных процессорах считается crc32 непрерывно куска памяти одной командой вот он сейчас используется есть большое подозрение что лучше становится из-за того что мы вот этот подсчёт РЦ закачивает всю страницу в кш процессора и в результате дальнейшая работа с ней происходит быстрее потому что хаотично по страничке побегать дороже чем 8 КБ одним хом закачать себе в память в кэш как это стало возможно что это ну графит графики это мы смогли нарисовать что мы сделали с постгрес до 96 са одна из самых частых операций знаете поса это куча процессов шарит в том числе это шарит бу шари бу Ну называть можно по-разному но факт в том что любой процесс поз зачитывает страничку в эту память Дальше он начинает работать он может её там найти и ему важно чтобы из-под ног не вышибли эту страницу то есть чтобы её не загрузили ему при этом даже е чить не надо то есть она может меняться ему нужно просто гарантировать что она находится в памяти он е зало чуть попозже и собственно вот это вот правильный Я не знаю мы так и говорим запенить у себя вот в по когда дискуем за булавка прикрепить Да наверно прибить гвоздиком в уголку и собственно было очень короткий Лок ПЛЮСПЛЮС про э и оказалось что вот это вот место оно поскольку очень частое вот эти вот Локи дерутся много обидно переделали на атомарной операции там на самом деле Вот это сильно упрощённый псевдокод Что называется и мест там нужно потрогать ещё несколько то есть там вот это вот как кэш работает более-менее все представляе нужно учить насколько сто страницу хотели поэтому кае появлятся но удалось их сделать тоже без лока во моделям ВЦ многие знакомы с пом вот в этом плане 1 2 3 4 5 6 Вау потом расскажете нужно зна все идущие в данный момент транзакции Ну кроме всего прочего естественно в памяти есть вот этот вот массив в котором записаны вот эти вот в данный момент идущие транзакции и нужно взять сшт сшт нужно взять из разделяемой памяти очевидно что чтобы взять нужно взять а чтобы транзакцию закончить надо вять э достаточно атомарная операция это в общем-то было сделано и Достаточно давно Но вот идея то что очищение требует Эксклюзив Лока с ней побороться атомарные не удалось но зато удалось сделать то что если у нас под высокой нагрузкой А когда у нас много ядер то так и случается что чаще всего несколько транзакций приблизительно одновременно хотят почи зан и это можно сделать за один скачок То есть за один лог имеете в виду вот эти вот оптимизации Почему они там можно говорить что вот поре придумал поздно на самом деле это нужно было делать в Восьмидесятых годах Нет просто потому что число ядер было маленькое 24 вот этот вот проблемы с этим проком на них не видно э когда мно следующее точно также если мы наткнулись на запись и у неё там указано что внесена на такой транзакции в списке работающих она отсутствует нужно слазить проверить в comit Log узнать статус транзакции опять же когда это было давно-давно 32 странички было достаточно то есть всё всё нормально всё оно Отлично кэшировать Но поскольку машины выросли диски стали быстрее У нас число траза типсы выросли значительно этого кэша перестало хватать поэтому здесь были применены не дюжины интеллектуальные силы Чтобы увеличить этот кэш Так я вот почему-то тыкаю всегда в направление кадра а должен направлени собственно компьютера перспективы что там есть и дальше вообще говоря можно спросить где бутылочное горлышко у поз вот в девяностых годах помни та Москвич выпу владими Москвич выпускает Василий Блаженный салон отделан из Роми двигатель семи цилиндров разной высоты и диаметра вот у поса голык много это не значит что поре плохой Это означает что ликвидируют каемся в следующее этот процесс не сходится И вообще он не должен сходи Какие места это медленная хэш таблица Ну как она она хорошая Она там паровая она хорошо работает но её периодически видно вот эту хэш таблицу видно в профайлеры при определённом профиле нагрузки снапшоты для получения каго снапшота надо сканировать все активные транзакции вот этот про синхрон проко то есть в сот можно пихать запрос до того как получил ответ на предыдущий запрос но самали это не поддерживает А самое главное что такая техника программирования требует очень большой аккуратности от прикладного программиста и собственно Тут ещё нужно разработчикам баз данных вкладываться в какие-то фреймворки которые позволяют эту штуку упростить вот там в я смотре вот там вот это вот архитектуры хотя сам её терпеть не могу но тем не менее Вот в такой ситуации её можно по использовать медленное выделение ID транзакций тоже иногда видно и видно что оно мешается именно по причине блокировок как на это посмотреть Ну собственно берём вот запрос вот этот точечный запрос и делаем его десятичным то есть 10 раз и мы видим что мы вместо полутора миллионов запросов начинаем выполнять 150.000 запросов на самом деле Мы выполняем те же пото милна поисков в секунду это по факту это мы видим что мы упирался позволяет через точку запятой строчке указываем всё это отправляем видим что таких запросов мы можем выполнить два с хвостиком миллиона запросов в секунду мы здесь упиралась не участвует парсер тривиальный мы упираясь номеру комита вот с этим па патч мы сейчас введём он сообществу представлен но работы там ведутся ещё значительный потому что он иногда в каких-то позициях ведёт себя странно сразу в два раза можно улучшить улучшить А вот сек Cent - это просто самый простой Селект который позволяет лоцирование 400.000 запросов в секунду имейте в виду если вам кто-то говорит что на ноутбуке а достиг миллиона транзакций в секунду Он врёт на запись на большой машине это всего 400.000 А ну как это можно улучшить это можно ликвидировать буфер менеджер совсем сделать там вариант там подключаемых так или иначе движков сделать in Memory Коми коспа уже упомянул слайдом выше асинхронный бинарный протокол почему она синхронный потому что вообще говоря база не обязана отвечать в том порядке в котором её спросили но опять же это сложности для клиентов но клиенты типа НОД GS это будут достаточно естественным образом понимать а ну и собственно уменьшение Котен для выделения ID транзакций так в эту сторону сравнение начинается с са интересная часть да я всех попугаю а рекламу все помнят возьмём серную кислоту и чистую воду опустим газету и ТВ Парк естественно газета развалилась Она плохая ТВ Парк хороший не будет этого так вот здесь сразу сходу вопрос почему графики построены на разном количестве точек то есть у постс красивый плавный А у Света получился такой угловатый Зигзаг удачи А ну в общем дело в том что коллеги из по Professional они тестируют с каждые с увеличением каждые 10 запрос в секунду но вот если заметить тут максимальное значение - Это 250 А в то время как mysql ну в mysql конечно есть такая хорошая практика не открывайте больше соединений чем вы сможете обслужить но мне там тысячи открытых соединений для mysql это в общем-то обычно то есть ну другое дело в реальной жизни Многие из них спят Но в любом случае мне было интереснее Ино протестировать с большим количеством соединений ты говорил 104 было Да у меня было 1024 и естественно Если бы я каждый Вот с таким с инкремента по 10 10 клиентов Я бы тестировала бы до следующего Хайда А самый самый популярный ответ в поре сообществе на тему у меня 104 и я алкоголик что делать в стиле Стива Джобса Не держите телефон таким способом а проблема в том что пользователи мас говорят А вот мы и будем так следующий А так это были точечные запросы и хорошо видно вот если вот мы доктис либо Вот это выравнивание в кше то идм на зря в надр то есть там плюс-минус может бы влияние Марса на луну так чистые ситуация аналогичная количество точек тоже те же причины то есть мы как-то привыкли тестировать ночами то есть запускаем оно само тестируется А с утра Нужно где-то несколько сот гигабайт логов разобрать А это быстро так рай Ну тоже тут подписи даже я уже не вижу насколько там мелко но я цвета все видят значит синенький зелёненький - это пос 96 снко и синхронным котом при этом Здесь даже показа э или выравнивание по кшу и два теста mysql от дмитрии и от Светы А вот Пятая склянка 45 минут у нас отлично успеваем значит если я правильно помню свете объяснение 31 2 - это приблизительно тоже что в асинхронный кот Так что видите худший результат постгрес совпадает с худшим результатом лучший результат постгрес совпадает с лучшим результатом таким образом так итоги Так ну собственно итоги у нас такие Радужные для обеих сторон То есть это динамично развивающаяся база данных которая хорошо адаптирована под современное железо и релизы последних версий по содержат серьёзные улучшение вертикальной масштабируемости Так что в общем-то Мы благодарим за предоставленные сервера за номы благодарим Оганова за авторство этой идеи пото что На прошлом мы обсуждали как бы вот так вот всё протестировать И узнать много нового вот благодарим Александра Короткова за прогон тестов со стороны по вот использованные инструменты тоже вс кликабельно и адаптировать PP Bench - это тест Александра Короткова Вот который он использовал для тестирования здесь и Open То есть это адаптация myq теста для поз чтобы гонять пог Бен оптация пого по для масля а также конвертация стандарт тест вй у вас вопросы собственно есть у вас есть вопросов Сейчас сейчас я их коплю Алло А вот такой вопрос К Спасибо за доклад вопрос к свети Смирновой а в у вас в конфигурации не было указано Pull of threads он по умолчанию с включен Да нет он не не включен В смысле Pull of trads вы имеете в виду перко Т по ПН А ну как бы это было бы нечестно Если бы я использовала пги Я его просто не использовала Ну он бы дал бы там сильный же при А ну я у меня есть планы Что добавить слайд с с пред полом но как бы ну для конкретно этого сравнения Я считаю что пока это рано на самом деле у нас сериал Не окончен То есть те апдейта и Давайте ещё один вот там два человека а кто был раньше а я не успел заметить Хорошо извините пожалуйста Здравствуйте вопрос К mysql А если у нас возникает вот блокировка мтек он по-прежнему целиком же валится у нас Что значит валится Ну поскольку он у нас не классической архитектуры а архитектуры на базе трив Да соответственно любая блокировка на низком уровне в тех же спящих например инстанса истан а трех Вполне может свалить всё так же ну свалить А в смысле Вы имеете вду вот это семафор что ли Вот это вот да А вот эту вот фичу Ну она разные представление Да как бы сказать Ну во-первых семафор который валит mysql он валит только когда он ждёт больше по-моему 600 секунд Ну валит Ну валит Да это валит просто получается такая ситуация процесс работает достаточно долго у нас долго спящая вот эта транзакция допустим Ну висить там несколько месяцев например то вполне после этого дохнет май А зачем вы держите транзакцию откры несколько межи лефон спосо Это не мы его держим это сама СУБД в какой-то момент времени ведёт себя таким образом то есть это уже надо будет Ну на самом деле было давно Но я думаю сечас тоже Ниго не поме на самом девор Да это вообще валидная ситуация когда держится такой Лог допустим у вас есть огромная таблица вы делаете её допустим изменени при помощи алтер причём в маской есть быстрый не блокирующий алтер сейчас ту тоже смотрим руководство вы делаете какой-нибудь блокирующий алтер И в этот момент приходят какие-то транзакции которые ждут Вот вот когда этот алтер закончится почему-то ждут они не Log а почему-то ждут NB А и почему-то они не умирают от дебик таймаута а то в этот момент это ну это как сказать валидная ситуация когда этот семафор должен Ну вот он всё равно будет держаться но ситуация когда вот просто так у вас нормальный допустим dml волод и у вас держится столько долго семафор это ненормальная ситуация это Надо разбираться и слать Баги и смотреть что происходит Ну вообще я слал баги слал икону и слал и проблема не была решена Ну не воспроизвели наверное не воспроизвели ну проблема давайте мы тогда это перенесём у нас Бут этапы подходите мы поговорим на э тему Да потому что в 12 Мета и в 17:00 Спасибо время закончилось все остальные вопросы можно обсудить В кулуарах Спасибо"
}