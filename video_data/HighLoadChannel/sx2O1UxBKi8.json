{
  "video_id": "sx2O1UxBKi8",
  "channel": "HighLoadChannel",
  "title": "Инфраструктура распределенных приложений на nodejs / Станислав Гуменюк (Rambler&Co)",
  "views": 6163,
  "duration": 3429,
  "published": "2017-04-22T14:48:24-07:00",
  "text": "случай зовут нина станислав гуменюк вот и сегодня я вам расскажу про инфраструктуру вот здесь наверно в название доклада самое важно это все-таки инфраструктура то что есть вокруг приложения по ходу доклады я расскажу и о приложении о том как его строить самого начала в общем пройдемся немного по верхам и в конце концов придем к инфраструктуре перед тем как я начну свой доклад я бы хотел немножко обратив внимание на то что есть вокруг у нас в зале вот здесь я стар и докладчик здесь вы многоуважаемые зрители слушатели моего доклада и других докладов но посмотрите вокруг кроме нас здесь с вами еще есть можно сказать практически невидимые люди это те кто нас поддерживают это звукооператор и те кто помогают настраивать технику вот микрофон clicker вот это всё вот эта вся инфраструктура и без инфраструктуры ничего этого бы не было все это бы не работал а вот поэтому когда вы строите свое приложение помните что инфраструктура очень важно без нее еще работать не будет собственно говоря что такое инфраструктура вот есть красивая картинка нашел в интернете инфраструктура это город дороге машины все вот это в хорошем городе в продуманном городе где инфраструктура продумана машины ездят быстро пробок нет вы всегда можете добраться из точки а в точку б с работать до дома из дома до магазина все это происходит без каких-то затруднение вы постоите всего на одном на 2 светофорах вас всегда и заправки рядом общем все есть но как показывает практика в россии и других странах иногда встречается вот такая картинка вот я думаю что многие из вас ее видели вот это пример плохой инфраструктуры когда я в принципе то и нету и на самом деле как показывает практика зачастую в приложениях люди напиши хорошее приложение она получает в итоге вот такую картинку то есть вроде как все хорошо там вон команд какой-то сильный зил газ вроде машин это крутые все все нормально но они справляются с тем что нет инфраструктура не буксует поэтому я предлагаю с вами немножко сегодня обсудить тему интер структуре я тут какие то какие то буковки написал примерный план моего доклада как я сказал мы пойдем самого начала попробуем на но джесс написать небольшое приложение после этого его запустить завернуть это в контейнер ну и далее далее собственно пример простейшего приложение 10 для тех кто пишут на но джесси здесь я думаю все очевидно простейший http-сервер запускаете на практичном порту и все работает почему но джесс ну с одной стороны молодая технологии и совсем недавно выпустили можно сказать в продакшен когда люди стали использовать и в продакшене и тем не менее на него очень удобно писать на нем можно быстренько запустить прототипу какой-то и начать с ним работать так ну касательно приложение что есть что-то по серверы которые слушают практичный порт и по запросу отдает привет кого еще такого сложно когда мы написали наше приложение любое вот такой хэллоу молд или что-то очень сложное мы в 1 все должны запустить наше приложение мы должны посмотреть как она работает и плюс наше приложение должно работать все время она должна работать бесперебойно все это сложно и все это как раз таки инфраструктура ну что ж поехали немножко насчет на в эту структуру когда мы запускаем но наши ног предложение пускай это будет самый простой вот hello world который был написан мы можем запустить через но через стандартный интерпретатор за интерпретатором и вроде все запустится она будет работать но у нас есть некоторые проблемы мы практически не можем мониторе то что происходит логе сыпятся просто в стандартный а вот food без каких-либо разделений в общем а если эту титул пойдет она никогда в жизни не поднимется умные ребята написали такой такой штук как not mon0 атман кому как больше нравится произносить этот сервис позволяет но он больше для разработчиков когда вы запускаете ваш приложение он мониторит на изменились ли изменились ли файла iso файл изменились то он перезапускает приложение если предложение падает он старается тоже перезапустить вроде бы все хорошо все работает вот но этого мало потому что логе опять цепь от стандартных стандартный поток нет никакого разделения в общем ничего интересно абсолютно не происходит поэтому я предлагаю вам использовать более продвинутый инструмент это п м 2 сейчас мы про него по гриппа больше почему и forever те кто давно работают с ноты те использовали форева скажем так ясно достал работать носитель недавно это где-то год с небольшим и мне повезло я до этого на жизнь когда-то лет 10 назад чуть-чуть на джиг верит что такое дел вот то тут я прошел на новый проект и мяско лет чувак мы пишемся на ноги вот извини только так пришлось учить ноду и я пришел в тот переломный момент когда вышла 4 нот когда и от же с ноты объединились я практически не застал камбэк hello я не застал старых инструментов я начал сразу что называется ходит на этом скрипте который в итоге стал почему-то 2015 сейчас уже есть 16 я не застал сара инструменты того же forever а с другой стороны когда мы стали изучать что мы хотим использовать п м 2 forever или что то еще пн-2 мы выбрали на тот момент потому что ну во-первых он в поиске выдавался первые когда мы пытались искать а во-вторых он просто в больше возможности нас интересовало расширение какой-то расширь расширение гипервизора но все-таки какой-то мере гипервизор нам хотелось более умный гипервизор который можно настраивать дополнять что-то с ним еще делать поэтому мы выбрали по м2 сводную табличку с фарином делать не буду вы можете легко нагуглить но я вам советую тоже не искать а просто брать п м 2 когда вы запускаете ваше приложение с помощью пн-2 у вас контроль к выведется вот такая вот маленькая смешная смешная табличка где будет указано имя вашего приложения его какой-то айдишник в общем как эта информация виду вы сами сможете прочитать то что здесь более репрезентативности чем я произнесу это вслух теперь давайте немножко изменим наше приложение что я здесь изменил ну партия почему-то стала слушать 5 не знаю почему я наверно поздно ночью все это козел что основной я добавил вывод логов обычный лак и рок теперь я также запустил свое приложение и захотел посмотреть логи этого приложения сверху я пишу команды которые к этому привели и как мы видим у нас уже есть некоторые разделение логов есть р-р лак есть стандартный outlook чем нам это полезно во первых можно смотреть логи по отдельности они пишутся файлы можно поставить расширение км2 который будет ротировать наши локи если мы хотим чего-то более умного пуп м2 из возможность ставить дополнение модули так называемая и мы можем наши логе например сыпать уже не только в файлике отправить куда имплант власти q в общем любой хранилище который умеет работать с лагами если мы карта кастомизировать наши логе то возможно даже тоже ластик или тоже spunk уже сможет по ним строить какие-то графики и так далее и тому подобное пойдем немножко дальше возможностях пн-2 и мы можем просить пн-2 вы истекают информацию о нашем приложении но тут все очевидно там эрла к outlook и щелкает информация носит не интересно на самом деле интересно немножко вот здесь на этом слайде что нам позволяет делать пн-2 я думаю те кто с ним работали прекрасно знаю что здесь написано тогда год назад и для меня это было нескольким открытием что маленький небольшой гипервизор позволяет уже реализовать некоторую структуру он может запустить несколько приложений он может их за доплыть у него и встроена кластеризация это прям вот вообще у меня прям слов нет сейчас подобрать таких цивильных как-то было круто когда это увидел для тоже запустить невское приложение мы описываем такое качестве экосистем файл и запускаем его когда у нас одно приложение еще интересного не происходит на самом деле все то же самое как если бы мы запустили наше предложение базово но давайте немножко поиграемся мышка тимку store за цию все-таки то же самое к систем но мы добавляем что наше приложение хотим запустить в двух листах можете в 4 запустить восемь условно ориентируйтесь на то сколько у вас я der я запустил наше приложение я вот надеюсь но все-таки видно немножко из зала суд какая если мы посмотрим информацию наше приложение к тому видимо и в приложении в айтишники и тот факт что не запущена в костер джимми это очень важно что позволяет нам делать кластер собственного частные от картинки вы увидите когда мы запускаем наше приложение в просторном режиме п супер zdf приложения пн-2 берет на себя функцию во-первых он до утра белом раскидывает запросы то есть ваше предложение поднимается на 5000 нам порту на самом деле насколько понимая pm 2 это перехватывает и от начинает балансировать ваши запросы если какая-то весну от начинает подтапливать он перестает на нее кидать ваши запросы вот так из коробки вы уже подготовили самую простую но все-таки инфраструктуры ваши приложения уже будет сама подниматься она будет классно резеро ваться вас уже будет некоторое разделение нагрузки отлично но собственно в итоге картинка у вас будет выглядеть как то вот так запущенные приложения n 2 к гипервизор и там блоге где-то внизу логия вы можете как на сервер и смотреть также с помощью различных модель отправлять куда-то еще собственно то что я сказал . . то чего мы добились смотрите мы сделали сейчас для самого простого приложения небольшую инфраструктуру вот я в терем игр инфраструктура вот вот это слово повторяю и я буду повторять очень много помните что инфраструктура это вот как дороге в большом городе она позволяет связывать все и позволяет приложением нашим работать а теперь давайте от слова инфраструктура перейдем к очень похожему слова которую говорится архитектура я думаю все видели эту картиночку как как построить кубик можно взять цельный кубика можно вот с городить из докеров с контейнеров вот вот так выглядит докеры если что у меня друг работает в порту и когда ему что-то стал рассказывать про докеров он не очень понял потому что в порту докер my называется люди которые грузят вот эти большие железные контейнеры пойдем дальше я думаю все знают проблему почему так плох монолит я тут выписал нет некоторые проблемы что собственно и какие у нас есть проблемы с монолитом и что мы хотим получить в итоге от микро сервисов но самое главное то что мы хотим мы хотим проще писать код проще деплоить доплыть огромное монолитное приложение очень тяжело поэтому нужно как-то стараться разбивать я в докладе мало буду рассказывать о том как это делать если хотите могу что-то рассказать в секции вопросов или после этого итак давайте сварим когда у нас есть какое-то базовое приложение вот он монолит как она взаимодействует с йоши миром запросы приходят ему запрос от него уходят ну все плохо на самом деле так так делать не надо поставьте хотя бы перед ним engine во-первых уже можно проектировать запросы с помощью дживс отдавать статика для веб приложение это то что нам нужно но если мы горим право приложения тату все на самом деле становится намного интереснее современное в приложении очень часто представляетесь а вот такой вид engine со отдает наш фронт чаще сейчас cut a single page applications либо у капитана большой набор же с фронт загружается в браузере и дальше frontend уже общается с нашим брендом это может быть как просто приложение так и некоторые пей в соседнем зале сейчас разрыв был доклад про то как построить и rest api я думаю там рассказали больше про про это я миша буду рассказывать вот на самом деле можно еще сделать и вот так индекс позволяет точно также проектировать наш запрос и я думаю кто то из вас это знает надеюсь что все знают и вот эти вот не патетики справа на самом деле можем вполне мог быть разными серверами то есть также как можно не g-100 отдачу статике разделять с бандами наш нашего пи это немножко о том как можно поставить предложение в самом базовом варианте вот здесь уже получилось после архитектура нашего приложения и уже немножко мы коснулись инфраструктуры потому что мы добавили индекс архитектурно разбили приложение на две части фронт и бэкон теперь и добавили джинкс как инфраструктура теперь давайте немножко поговорим об архитектуре приложения уже немножко в другом разрезе вот есть наша большой монолит монолит мы решили все таки разбивайся на векторы подсистемы и получили и pr отлично и пену сама сам по себе интересен ничего не делать если нету базы мы добавляем базу и собственно некоторую связь с базы дальше у нас есть некоторое worker если например мы пишем сервис который рассылает письма то когда у нас обязательность это и есть worker и которые как-то получает данные их обрабатывают ну привет отсылать письма вот теперь собственно вопрос как мы должны взаимодействовать вот worker должны ходить напрямую в базу или выпей это как раз таки вопрос уже о том как строить архитектуру как разделять наше приложение на микро сервиса на самом деле ответ очень простой с одной старых кажется удобно чтобы worker ходил в базу знал что-то базе но это не совсем верно возможно очевидно а может быть и не очевидно ходить нужно вот так почему нужно ходить вот так она этой вы вполне можете вашу базу заменить на какую-то другую вы можете спирко на переехать на мангу упаси вас боже конечно но я встречал таких людей а почему то все обратно в итоге переехали либо на перк он и либо на прогресс вот и только и 5 должно знать о том что происходит внутри базы все остальное вас должен быть зафиксирован какой-то пирс пособ взаимодействия с внешним миром и ваше приложение должно уже общаться только цепей база данных должна быть сокрыто за ним и соответственно маркеры будут ходить уже уже копии и получаю информацию когда вы добавите больше worker of вам не придется в каждом word или реализовывать связь с базой данных какие-то знания базе вам нужно было только знание о папе а знание об api вполне может быть внутри за реализованы какой-то библиотекой и таскать библиотечку в разы проще чем обновлять везде в другую структуру базы и работать вместе вместе с базой из каждых маркера отлично пойдем немножко дальше вот смотрите здесь есть worker и worker этот нектар приложений которые общаются пиаф онтент то же самое приложение только она общается из браузера по факту ничего ничего не меняется да у вас там может быть по другому авторизацию вас может быть приватная api и публичный api но сути это не меняет а во все равно остается не которая пьет но тут не еще один слайд не очень просили его добавить мы добавляем шину данных у вас как-то worker а все-таки должны между собой еще общаться вполне api может туда ходить собственно говоря если мы реализуем тоже рассыльщик писем мы можем шину данных пускай ты у нас будет пробитым kill вы кидаете в рыбе сообщение о том что необходимо разослали столько писем worker и подхватывает эту информацию а тем же о том что разослать кому разослать культ дополнить информацию маркеру жена сходит вполне себе в open вот вот тут я перерисую таким одним большим квадратиком но на самом деле api может выглядеть на саму внутри вот так то есть яндекс за ним ваши прим собственного же сам api разбрасываете к хотите здесь здесь уже ваше дело вот а теперь смотрите мы прошли некоторый путь уже нашего развития совсем простого приложения мы выделили worker и выделили пиа и отдельный фронт теперь следующий этап нашей жизни мы хотим наше приложение каким-то образом диплоидный сервер отправить вас есть множество вариантов вы можете копировать туда основной ваше приложение если это но до после этого сделать npm install и так далее и тому подобное можете где-то заранее сделать npm install зорькин сделать все в архив и отправить на серверы и там где-то запустить но это куча лишних действий заархивировать разархивировать ну может быть не лишних но тем не менее это все равно действие плюс у вас есть некоторые консистентной возникает я вам предложил использовать вот слова я последнюю говорил такое страшное слово хотя за два года уже hyip некоторые прошел все прекрасно понимаю что это за слово поэтому я сделаю следующий слайд вдумайтесь в этом до докер это хорошо он позволяет решить но игрок огромное количество проблем собственно проблема некоторые здесь выписал самое главное почему докер часто хорошо hyip прошел сейчас уже не все не воспринимают это как что-то новые пытаются использовать у куда там ваще просто в совершенно ненужных целях сейчас докер это просто небольших технология которая позволяет решить некоторые проблемы например те что указанное здесь на слайде эти проблемы вполне себе можно решить для тех кто не знаком с докером маленький экскурс буквально там на 5 слайдов когда мы хотим собрать некоторые докер-контейнер например нашего татарского приложение если мы горим здесь про backend мы должны в корень нашего проекта добавить файле который называется докер файл и примерно востокова содержимое по строчкам я пойду еще дальше извиняюсь по строчке напротив дальше что что это значит пока объясню суть нашем приложении в корне мы добавляем файл докер файл с помощью котором по сути декларативные писания что мы хотим получить мы хотим получить образ некоторый образ нашего приложения приложение собственно говоря такими команды мы собираем образ и дальше начинается магия до которой почему-то не все заходят сразу и которое нужно проговаривать вслух и после этого у некоторых людей просто как будто открывается что-то новое и не узнают для себя что-то новое по совершенно по-другому смотреть на жизнь теперь смотрите когда мы сбил деле образ наш мы должны во положить в registry это может быть публичного реже стали docker hub тот самый либо вы можете у себя поднять в git лобби например можно очень удобно настроить даки реджис 3 авторизацию через гид лапы и уже туда если наши реджис 3 что самое то главное а самое главное это вот это потом заходя на нужный сервер либо на ваш локальный локальную машину мы можем спорить образ и запустить наше приложение но в такой картинки это неинтересно самое интересное происходит на следующей картинке вот на этой а если посмотреть внимательно это преломит приложение когда я делал внутри компании доклад про докер ребята которые пишут для мобилок очень резона заметили что докере jest и это по сути play маркет ну а есиков лечит не помню appstore называть вот на самом деле docker и джесс 3d магазин приложение вдумайтесь реджис это магазин приложений но заходим в приложение выбираем необходимое нам приложение скачиваем к себе и запускаем когда автор захочется обновить приложение точности также создает новое приложение как-то потом заворачивать подписывает вы отправляет в магазин мы его скачиваем и используем и докером получается два ровных точности та же картина поэтому те кто думает что докер это некоторые виртуализация не думайте что докер от виртуализации это неправда правда то что докер это магазин приложений и это все и и вот это самое главное то что нужно запомнить я вам обещал немножко пройтись в паре слайда потом что из себя представляет сам докер файл первая строчка всегда обязательно вот кровь из носа должна быть из какого база образом мы собираем наш докер-контейнер докер-образ здесь базовый образ это надо версии 423 просто игроки красивая там уже помощь 67 или общем все последние они появляются что это значит березовской базовый образ кем-то там добавляется туда надо инахо пушатся уже готовый образ со встроенным но джессом собственно мы его и будем использовать для построения дальше на наши образом дальше мы прописываем что текущая папка где находится наш проект становится в образе папочкой код устанавливаем папочку код как нашу основную папочка где мы будем работать и запускаем установку всех наших необходимых зависимости таким образом три контейнера мы сразу получим и наше приложение и все его зависимости указываем какой команды мы должны запустить наше приложение и какой порт наше приложение хотела бы слушать то что будет про прошлый наверх я бы хочу немножко вернуться назад вот к этой строчке некоторые ребята резонно заметили о том что на самом деле здесь можно использовать встроенный в npm возможности например npm скрипт там есть omrоn npm тест и что-то и что-то подобное так вот про это слайда поэтому я проговорил вслух попробуйте немножко это осознать я садись я заменю команду нота ппс на npm старт или этом and france старт ну поправьте меня если я ошибаюсь внутреннего вот этой команды в паке джейсоне я могу описать что мне нужно сделать там перезапустить наше приложение а теперь вдумайтесь нас всегда обычно в покере sony есть команда с которой запускать тесты ну надеюсь что есть на самом деле вот если я у сбил же образ вот такой командой и потом за хочу запустить но я запущу не команды докер на на там имя нашего образа а допишу еще в конце npm contest and em started to запустит тесто внутри нашего контейнера нет работает и выдадут весело вот тут к нам в консоль таким образом у нас внутри контейнера можно сразу запускать тест для тестировщиков это очень удобно таким образом можно тесты прогонять прямо где-то в нашей царьки то есть тесты прогонять не в окружении системы а прям в окружении docker и посмотреть какие могут быть проблемы с внутренними за веселись потому что вас могут быть тесты и просто юнит-тесты она прямо внутри контейнера вас есть какие-то специфичной зависимости но и не за фантом же с и вам нужно проверить сделать такой смог т.с. понять подключается или внутри контейнера фантом же с работает ли общем фантома что что то ли он дает таким образом сделать смог тест можно прямо здесь одной команды по сути не по сути не особо напрягаясь так как игра экспорте 5 1000 порт вот в самом начале вы пойти и говорил про п м 2 идет кто-то заметил что мой доклад можно переименовать инфраструктура приложение как использовать п м 2 в больших проектах ну я сам щекам не согласен но доля правды его есть словах смотрите мы заменяем две строчки нашем приложении мы на дно мышь и из шагов добавляем установку pm 2 глобально и также переделаем запуск нашего приложения команды которая здесь обратите внимание на после на последней суффикс на у daeman что это значит м2 обычно запускается как демон и работает в режиме демона если мы запускаем таким образом то у нас ему будет работать в режиме вот прямо сейчас постить в текущей out put для контейнеров это очень удобно потому что если если вы запустите в режиме демона-то просто запустится и сразу же упадет потому что демон будет не основным процессом уже основе процесс уже от работает в таком виде ваше приложение будет работать оно будет самаре статица и все дальше ваши ухищрения которые вы будете которые вы сделали внутри приложения но все будет работать если вы поставили какой-то моды который будет отправлять логе логе будут отправляться в общем все будет работать основные лаги которые уходят в out food в стандартную откуда они будут сыпаться влоги и докер-контейнер который можно посмотреть помощь команды докер лакс и того что мы в итоге получили докеры но я приписал мы очень много умных слов что самое то главное я получил в 1 первую очередь то же самое вы можете получить и вы у вас получится образ вашего приложение которое можно запускать где угодно просто скачав из магазина на 10 keys приватного магазина из вашего вы только вы его сможете скачивать и ваше приложение в три контейнера будет работать стабильно например если вы запустить внутри как делаем это мы тоже и 5 кластер режиме то есть вы всегда 2 у вас практически не будет случаев простое вот таким простым образом собственно говоря мы все и запустили вот теперь давайте подумаем вот мы создали образ нашего приложения зашли на сервера с пуляли запустили все отлично но серверов допустим как у нас проекте их было много 1000 серверов это не там практически 1000 worker of еще где-то по сотне openiv и к баз данных очень тяжело все это мониторе практически невозможно понять где что запущена когда какая версия была запущена какому api обращался в шляпе много эти сервера эта ферма какой-то сервак может прямо сейчас вырубится и возможно все это мониторе необходимо какой-то сервис который будет помогать им находить нужные нужное нам приложение те же worker и перебит все что угодно такая штука есть и давно используется называется рвалась discovery например мы будем использовать консул почему концы вот я привел такую табличку честно-честно украину с интернетом вот люди сравнивать эти сиди и консул на самом деле вариантов сервис discovery есть еще несколько почему мы выбрали консул самое главное во первых если вы загуглите рвалась discovery то скорее всего первое что вас выпадет это консул что для нас было критично важно to consume the service discovery очень удобно для нас было то что есть некоторый встроенный мониторинг есть тройня мониторинг а также есть определенная key value хранилище чуть почитаешь немножко расскажу путь для чего нам нужно будет киева или хранилище собственно проблема которой мы решили с помощью консула здесь указано на верху вот здесь четвёртая строчка очень важно как раз касается келли вуки в или нашего мы очень долго вначале просто роняли конфиги для нашего приложения внутри контейнера но конфиге мер могут меняться очень быстро а потом перед apple id на 1000 серверов несколько тысяч контейнеров это очень тяжело вам и можем можно просто положить в сети даже если rolling апдейтом на змея конфигов может занять на 1000 сервов это сутки это реально сутки проходят когда ваши конфиге храните где то в другом месте это может быть жуки пера если аналоги какие-то может быть еще что то но вот мы использовали консул там все это есть сразу вот и мы все конфиги стали складывать внутри консул и собственно читать их оттуда 1 минуты если конфиге изменились мы пытаемся завали zero вать наш конфиге если конфиге рабочие то перезапускаем приложение собственно все все очень просто и теперь вкратце о консул когда вы запуская консул на сервере у вас собственно открывается несколько портов которые необходимо слушать самое главное для нас вот как для простых простых смертных если мы не совсем админы что хочется знать это порт 8500 ты 8600 собственно 8500 это штате people to appear почти теперь работающий 8600 и dns с да и нас все очень хорошо консул позволяет делать очень крутую вещь когда я про собственно читала мы все это запускали это было для меня это было как открытие да люди используют james h прокси еще что-то для того чтобы просто обращаясь по dns имени обратиться к какому-то сервиса интриг он слов это работает примерно так же наверняка прокси есть список собственно эти приложения и консулом по доносу может round robin им как-то выдавать 1 из 1 issues of того приложения которые сейчас работает если например у вас есть некоторая пиаффе запил запущен на 100 серверах то обращаясь например api и серво из консул вы получите один из тех not которые сейчас работают то есть концу знает о том работает ли но да не работает но если вы также можете настроить консул мониторить ваше приложение и отправить информацию если приложение сейчас сильно загружена так росла будет помещать о красненьком и не будет отправлять туда запрос и ну все это устроено возможно возможности в конце и например можно отработать по dns узнавать о вашем сервисе можно узнавать паштеты причем чуть подальше я подскажу сам себе консул на одном сервирован не интересен вам нужно запускать классно понятное дело и вот с кластером все хорошо у консула самое главное стартануть вообще этот кластер что тонуть ноду который в самый первый момент окажется главный и дальше у вас построиться кластеры и вы можете острей ливать по очереди какую-то из нот и кластер сампери балансируется и всегда будет работать и потом ноты которые потянутся они поймут что они в общем то отвалились от кластера под сосуд необходимое значение все будет работать в точности так же работает и и вылью в консоли вы пишете в киеве или на каком-то одном сервере и дальше это значения различается на все остальные собственно конфиге мы так и хранили у нас был один из консулов которые стоял на хер серваке мы просто изменяли там практически через ю а ин и иногда авто и автоматом чипа api меняли наши значения какие вы ели стороже и все конфиги менялись они разлетались страшно все сервера что-то стороны теперь давайте подумать зачем нужно стирать discovery когда у вас одна но данная запущена ваше приложение база данных вам не нужно держать discovery вот даже не смотреть туда бесполезно для вас преждевременной оптимизации когда у вас note 2 ну скорее всего вам не нужно потому что вы наверняка знаете где запущена ваша база данных и как не обратится сильно не пинайте за 3306 пожалуйста я знаю что правильный порт 5432 вот а теперь давайте рассмотрим очень странный случай но идеальный случай приложение запускается на хвостовые машине на железные тачки а база данных запускается пускай в амазонии и мы не знаем когда она запускается на каком порту вообще где она запустилась какой машине что с ней происходит или например еще более странная ситуация api запустилась докере база квартир запустились дайкири worker нужно работать цепи куда обращался куда бежать вот вообще непонятно мне 1000 серверов что делать-то вот ну и собственно грейс и вернуться картинки от виртуальной тачка сама зонам если у вас настроен консул то когда ваша база данный стартанет с помощью небольших конфигов понятно кому нужен то настроить ваша база данность зарегистрируется в консоли она получит имя и внутри об его просто пропишите db сервис консулу в нужный вам порт и все заработает если база данных будет несколько вас ну как-то будет равна дроби нам раскидывать но там уже смотрите сами как вас будет консистентной базе может просто мастер мастер репликации вот а если уже у нас есть worker и и и все это запущена в докера все это весело и молодежно вы вот вашего пей на самом деле она может быть запущен на 80 порту вы можете варьировать порты таким в таком случае вам необходимо обращаться консул копии урок который здесь у каждого он ненастоящий он плюс минус такой вам ехали необходимо обратиться к пии и узнать у консула где запущен войны вам необходимо обратиться кон свою знаете запущенного shape на кон порту запущена на самом деле в ответ придет намного больше портянка там вот какие-то статуса еще информации наезде сократил для того чтобы показать что самое важное вот как установить консул на серве то вот тут немножко больше обмена можно просто установить на каждую машинку но это не наш путь вот представьте себе когда я запускал на ферме с 1000 серверов просить админов установить консул на каждую машинку как то не очень хорошо вот тем более то ферма ферма все доступные для всех внутри компании можно использовать докер консульское ца в докере он прям изъяли есть официальный образ на docker хобби примерно инструкция на самом деле зайдите на кирха посмотрите эту инструкцию вы можете просто запустить консул докере и они у вас в итоге все свяжется между собой но если уже быть чуть прописать вот эти циферки я думаю получится экспериментов у вас все заработает отлично мы запустили консул пускай все работает вас построил все кластер все замечательно теперь давайте подумаем вам необходимо регистрировать ваше приложение внутри консула для это у вас есть несколько вариантов если вы не все таки ваше предложение не стали заворачивать докер но тогда я вас могу понять почему вы это не сделали но все-таки используйте по м2 то вы можете использовать модель пн-2 консул на самом деле до нового года за релизиться новые новой версии этого модуля который из практику нескольких кущ их ошибок и добавить пару плюшек вот но в принципе сейчас эти можно как-то пользоваться версия которое было написано три компании к сожалению поближе нельзя поэтому в упал форсы лежит намного более урезанные чуть более старая версия тут тут уж извините но у меня в декабре заканчивается идеи поэтому я смогу опубликовать более-менее приличную версиям отлично но собственно если как выглядит немножко и конского запустились нашей этапе вот примерно так это выглядит на название циферки обращайте внимание тестовой платформы вот отлично если же мы все-таки запустили наше приложение внутри докера то тут все намного проще умные ребята написали такую штуку назвать регистратор что же так что же такое регистратор регистраторы такая штука которая смотрит это тоже докер-контейнер который вы пускаете на своей машинке на необходимый там где есть тоже консул и регистратор наблюдает за всеми контейнерами запущены если вот о контейнеры есть порт которым слушает то регистратор берет этот контейнер паевой ими и регистрирует в консоли собственно порт и имя контейнера скачать его запустить можно вот так самое главное просто загуглите консул регистратор и и таким образом у вас сразу все заработает теперь смотрите есть такая штука я вначале говорил про dns то что консул позволяет использовать dns то есть не просто обращался каждый раз cкopee а использовать красивая да и на семена вот тут немножко сложнее для того чтобы использовать вам не принёс скорее всего настраивать дэн осман dns mask вот тут уже лично у меня сил не хватило его настроить вы можете просто мало пытался запихнуть и не смог тут я попросил админов настроить на некоторых серверах где необходимо было работать с dns а это было же другой проект в проекте котором мы изначально строили эту архитектуру мы просто подсоединяли контейнеров с кан сонг контейнером где находится наше приложение и внутри уже обращались на у колхоз но 8 тысяч 500 порт копии запрашивали там другом проекте пришлось добавлять вот такую поддержку что же мы в итоге то получаем от консула и от вроде написал у меня слова самое самое главное что получили мы это возможность запускать много много видосов нашего предложения всегда злодей не запущенный балансировать нагрузку между ними и вообще жить достаточно спокойно жизнью никто ребята и запел самурая пошли немножко дальше они написали такую штуку я к сожалению не указал в слайдах может вы тоже нагуглить и назвать конда она выложена это хобби я на публичном репозитории берите пользуйтесь написанного камня и не знаю чтобы это значило что это штука умеет делать она позволяет декларативно описывает мир только то как должны быть запущены ваши контейнеры и хранить все эти настройки внутри консул то есть что происходит вы на каждом сервере запускаете атакует эту штуку конда и дальше просто в консоль описываете состояние мира то как вы хотите выглядеть чтоб игре в ваш мир на сервере то есть те контейнеры которые должны быть запущены и конда сама их запустит перезапусти запустят нужном порядке и свяжет все как положено вот это была маленькая рекламка хорошего проекта моих друзей что в итоге из наши у нас получилось вот у нас был слева монолит наше приложение с которого мы начинали с холова ворда и в итоге пришли в такой страшной картинки где у нас есть это и есть базы данных из конструктора все это связывает есть worker а есть к это внешнее приложение потому что фронт это по сути но некоторые внешние приложения в то есть также которым может работать цепи ну да там чуть другая авторизация вот и посмотрите уже сейчас на картинку вот здесь уже по факту и архитектура инфраструктура здесь уже построены все наши дороги все будет работать у нас есть светофор и который будет регулировать то куда пойдет трафик то как он пойдет пойдет ли он вообще собственно говоря вот мы построили инфраструктуру ребят всем большое спасибо что послушали я жду вопросы переключу на следующий слайд я не знаете кому то будет интересно можете сфотать так один вопрос такой не планируете использовать с паром либо кубер на это для того чтобы заменить давно сложную инфраструктуру на на более простой нора инструмент давайте подумаем насчет сложности вот swarm честно я только читал один раз прямо на хабре и больше вот вообще никак не трогал и не касался почему потому что просфор мечтал давно когда только появился был всем сырой и вот но больше не было потребности этого делать я надежду в этих праздниках я все-таки немножко поиграйся с форумом и вот с тем что появилась новость о что я пропустил за последние там полгода год вот я очень надеюсь что я вас помнил все упущения теперь насчет кубер не tissot и на тему того что сложно что нет купер найтись и если убрать если просто открыть его исходный код который написан по моему нога там полтора миллиона строчек кода вдумайтесь полтора миллиона строчек кода документация по нему тоже очень ёмкое понять что происходит купер найтись и на самом деле очень тяжело дальше я спросить ребят которые разворачивали купер нить из что им это дало и вот вообще работает у них это или нет то возникает такая ситуация интересно что для маленьких проектов купюрница не нужен он слишком сложны и потому что летящие к которыми этого поддерживать настроить это это реально сложно это сложнее чем поставить консулом тоже самые потому что концу запускается несколькими командами и опорос потыкать в админа палочкой настроить купер нить из это нужно всем понять как он работает написать нереальное количество конфигов взять кучу машин в общем это сложно поэтому пока мы не пытались даже на треть смотреть на кубер не это с тем более ситуация такая что сейчас вот лидер структура представлена здесь она за производится в нескольких проектах проект по которой говорил где было около тысячи но сейчас проект сожалению закрылся может быть в том проекте удалось попробовать в остальных проектах количество нот не превышает там поутру двух сотен и там вот текущей инфраструктура вполне справляется очень хорошо понятно спасибо насчет к вернет из ада я согласен он довольно сложный но the swarm он намного проще и действительно работает у меня еще один вопрос есть ли что вот на одном из слайдов я заметил что вы запускаете б м 2 внутри докер-контейнер а да было такое веселье означает ли это что б м 2 в этом случае запускается контейнере несколько приложений вот в данном случае да вот в этом украсить ими g-100 не вы можете написать на самом деле все что угодно вы можете запустить как а где-то и было примера к сетям джейсона собственно давайте пока расскажу почти дошёл вот вот здесь у меня вот здесь запущено приложение и 2 этого приложения запускается вот и когда в докере через пн-2 я запущу вот это к сетям джейсон я не услуг прогорел то запустят воинство со приложения если вы к систем вы напишите еще несколько worker of the да у вас запустится еще еще столько же worker а это может быть worker еще еще что-то угодно да ну все будет запущен в контейнер но много запускать не надо как бы это вот нет ну не докер вой и докер p должно быть одно приложение если мы говорим про и перед едва не статься в принципе это нормально потому что иногда 1 из 1 инсов может немножко рисоваться и 2 его в этот момент переходит но у опытом опытным путем в нашем наши приложения которые мы запускали вот такая конфигурация она себя оправдывает больше смысла нету запускайте инстансов меньше ну вот бывают проблемы то что он сирота внутри контейнера мы запускаем таким образом 22 инстанса приложения на всякий случай да по сути на всякий случай понятно ладно спасибо вопрос что нет меня так еще вопрос вот там если можно можно стать и вас не вижу да никита пресса здравствуйте вы спросите вы рассматривали например нам от которая более нативно для консула одну в качестве регистратора к той что и сам от духа шикарном от не от сожаления хэши карп томат мы не рассматривали ну на самом деле регистрация я против не рассказывал ничего об оркестрация лишь сказал про конда которая есть в кочегарке станции мы использовали ansi было теплее контейнер они оба то есть ничего такого сверхестественного спасибо оставите спасибо интересный доклад мне как инженер эксплуатации очень понравилось но я хотел бы тоже в своей вот пару вопросов задать насколько я помню только смутно куб м 2 есть какая-то фича б м 2 докер она что-то вот что она делает вот на к сожалению я при не слышал не могу прокомментировать ясно хорошо еще один вопрос расскажите про production ну вот использовании имеющегося вот функционал до функционала именно в продакшене инфраструктура насколько она большая а как изменилась сопровождении вот что было что стало и что стал лучше вот хорошо смотрите давайте самого начала да вот про продакшена все это приложение сразу запускалась в продакшене и вот буквально с первых дней в начале мы запускали просто п м 2 на машинке запускалось приложение было джинкс а вот все как я вначале показал ты понял все это через п м 2 ребята из-за бог называется девушек ребят из отдела сопровождения которое занимается дипломантом их практически не трогали все делали сами когда мы стали использовать консул когда мы стали использовать все вот это связывание сопровождении немножко усложнилось потому что во первых потребовалось больше двух серов которые должны были настроить консул наш должны были поставить dns mask но какие-то такие базовые вещи дальше на самом деле ребята из отдела документ мы в итоге просто передали on seba скрипт который умел правильно выполнить наше приложение как происходило там был тим сити тем сити скачивал необходим антипу и запускал его и на этом на самом деле все сопровождении заканчиваясь вот именно внешний команды все остальное мы делали внутри своей команды у нас была такая достаточно мультифункциональной команды которая вполне могла и писали front-end и back-end и заниматься админист вам до фокусов в общем все всем чем угодно если касательно немножко другого проекта как у ребят устроено в продакшене вся вот эта история они допой а также антибан также через ten city но этим управляют дэвов зиры и просто в общем говорят как в каком порядке настроить давайте его в сером окей операторами да пускай пускай будет системные операторы противо системным админом я надеюсь я ответил на ваш вопрос да на самом деле проектов в продакшене сейчас смотрите один проект трубу самый большой вы вы не сможете видеть потому что он закрылся вот скажем так он собрал необходимое количество данных все что нужно было обработали и сейчас просто эти данные пока еще обрабатывается скажем так но у проекта не было бизнеса или его решили закрыть бы тут не техническая проблема оказать и на других проектов пройден проект я пожалуй не могу говорить потому что я нарушу индии про другой проект вы сможете про него зайти ко мне в блог он там написание страничке я про него напишу в следующем году когда он пойдёт в продакшн для большого количества пользователей а вот сейчас вы к сожалению вот прям ссылку дать я не могу и не могу ни на что потому что я нарушение которое обязательства дам вам тоже спасибо здравствуйте меня зовут приятный какой вопрос а местные вы не боитесь вас нет страха положить всю инфраструктуру неловким движением руки вот через ваши конфиге в консоли и если есть то что вы делаете для того что такого не случилось на самом деле такой некоторый страх есть вот во-первых мы написали некоторые checker тех самых конфигов которые проверяют на базового тоже нато вообще валидный джейсон получается как минимум вот во вторых конфигах мы храним таки достаточно примитивные вещи ну к сожалению там храним пароля кредо я знаю что это плохо но тебе мой хранить там кредо не иногда меняются и хранятся там что мы еще храним такого в конфигах важны по большей части наверно все в чем плюс вот системы которое описано здесь пэм 2 будет перезапускать предложение до тех пор пока она не стартанет при этом конфиге каждый раз будет погружаться заново top точность также докер будет пюре стартовать контейнеры пока не перезапустится и да мы можем на самом деле положить в инфраструктуры неправильно по меня в конфиге если даже не забыли дерутся в системы проверки но тем не менее они достаточно быстро предложения поднимется то есть до был такой один из косяков там по кластера положили просто не дописав в одном месте и праймер скипетров кредо вот но тем не менее на самом деле поскольку происходит давление не мгновенно она немножко но размазано по времени мы очень быстро заметили эту багу поправили и в итоге downtime а не было никакого вот но это просто потому что мониторе ли так на самом деле да есть такая боязнь очень сильная давайте знаешь здесь молодой человек хочет давно очень задать вопрос спасибо за год скажите пожалуйста вот есть такой гипервизор 6 и туза из 6 оверлей неправда есть с ней работать смысл гипервизор просто в чем что покрывают проблему нескольких процессов в докер в одном докер контейнеры вот и так же вопрос как бы как с этим справляется пн-2 если он стартует в качестве главного процесса на самом деле я вот противник того чтобы в контейнер все-таки запускался больше процессов чем один но вот с но да и там вот меня все на и сектор и приближения про надо помнить и картинку про хипстеров и миньонов вот когда идет человек вот из фильма про миньонов встречает медведи берем в руки дубинку от анапе сверху java вот тахиметр и миньоны такие типа на возьми мухобойку вот как бы но да я бы и там письмо джесс вот я но до сих пор я сейчас на воспринимаю вот так же что я не всегда и доверяю поэтому для контейнера используют м2 и запускает два из нас окрас вот этот случай что что-то может пойти не так и да я нормально отношусь к может 2к главное главное приложение запустят фоне два каких-то еще сделать каким-то кластерам и запусти к этому нормально другие гипервизор и в docker и есть что это не правильно то есть я видел людей которым приятного контейнера запускают и мускуле там php джеймс в общем все вот это вместе с 6 нет я мог сожалений не видел я не знаю что это такое но смысл просто немножко в другом вопросы был не из того что запускать там базу и приложение сразу в одном контейнере просто так же не видел монетах такую связку есть специальный проект от 6 оверлей и направлена на то как раз чтобы интегрироваться с консулом то есть запускается консул давай в структуре вот а подошли запускается приложение и консул клиент и автоматически мониторится как раз изменение конфигов и собственно restart приложения при их изменении в консоли но вот я обсуждение видел но вот игры есть например тоже проект andaman практически тоже самое реализует такой он там остается на хвосте и запускать контейнеры я думаю что сейчас эта фишка станет очень модный мы все больше увидим так подобных приложений вот поэтому я честно считаю что есть некоторое будущее за этим вот потому что в очень удобно просто описать и квартир на что мы хотим и что кто-то за нас это запустил еще вопрос не рассматривали сравнении с консулом нет nextep от уж сама эврику не от сожалению не только став мы не рассматривали почему я даже из затрудняюсь ответить на ваш вопрос наверное просто не до google или вот дата тут еще до запускаете внутри контейнеров новое приложения а как насчет других сервисов базы данных смотрителями данных да давайте немножко про шины данных рай в этом чё запущен в докере за кластере zero вам в docker и на разных машинах за катализировать через консул все ищут все эти ноты работает база данных страшное слово манга запущена в докере одна-единственная и служит она там для вот очень узко специализированных целей и там про сутки в нее записи столько же чтения кластер пожгли so close the ripper конов в разных проектах сожалению запущен на железных тачках почему потому что базу данных админить лично я не готов других дэвов сирота же не готова поэтому падает на админу ну то есть как при архи админы не готовы отменить базу в докере поэтому до база ставится на железную машину я бы все привел докер да а зачем зачем базу в докере ну проще обновлять наверно вот я проспорил новый образ запустил миграцию все за все запустилось медика в докере запущен когда мы приходится запустить новую я проскочу новый образ там скажу покурить условное наличие чем здесь внутренние обновленный get лапы неких проблем вот я как бы тоже ничего ничем не нужно делать такого страшно так я еще протяну вопрос я забыл да да вот например одно из приложений еще показателем токи нас была адская связка приложение написанная на groovy спасибо ребята приложений описано groovy рядом же с ним поставлен selenium вот и грове connect aqua драйвера усилениями и работать все это запущен на 3 1 контейнер вот эту случае когда много всего запущена в одном контейнере но она себя оправдывает потому что получается такой очень хороший парсер все в одном и она работает вот и мы доплыли вот это как раз таки такие worker и которые можно просто пулять на бесконечное количество нот запускать ее собственные больше запустили тем больше отработала главное сеть ни положительным вот да вот тут еще молодой отлично зовут андрей здравствуйте картинка была где шина данных api и worker и ну почти такая же справа будет такая же надо чему шина данных отдельно почему маркеры общаются через нее смотрите тут такая история на самом для меня ты думаешь меня скоро выгонят так вот я отвечу на картинке указаны не вся правда api тоже общается шины данных она тоже может туда пушит какие то сообщения worker общаются через шину данных но и также общаясь через api в чем суть в шину данных у нас наши на данных винтовая туда уходит к краске информация о событии кому нужно какое-то событие обработать вот а все данные основные то есть какие то данные о сущностях что конкретно то есть там уходят на прям шину данных отправить сообщение там то кому то пол или о каком-то событии все всю информацию события пользователя получается и запер потому что пока тот момент когда события дойдет до варки работ мир под стиль может измениться email поэтому мы все это хранится в базе и входим через это копьё но еще один вопрос и этот вопрос будет последним давай хорошо в коридоре все хорошо пн-2 страхует перезапускает приложение кто перед спускает м2 кто был докер я сам докер да спасибо всем большое спасибо спасибо что послушали и пришли"
}