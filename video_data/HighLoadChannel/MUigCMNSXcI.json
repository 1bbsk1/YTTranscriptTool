{
  "video_id": "MUigCMNSXcI",
  "channel": "HighLoadChannel",
  "title": "Ангелы и демоны многопоточного программирования / Алексей Федоров (Одноклассники)",
  "views": 1530,
  "duration": 2206,
  "published": "2017-05-14T22:53:05-07:00",
  "text": "значит зовут меня алексей федоров я в java мире лет десять из них последний несколько лет последние годы я довольно активно занимаюсь именно конкор lense с разных самых точки зрения и в продакшене повидал и теории много разных в этом месте читают вот и сегодня такой у нас будет базовый доклад введение в конкурсе давайте мы немножко познакомимся с вами чтобы четче понимал чем не рассказываете мне рассказывать то из мира менеджером таймов то есть у кого там сборщик мусора там вот это вот все тамджид компиляторы до пасибо так кто вообще из другого мира у кого онлайн-чат runtime мы тогда сегодня постараемся поговорить про аспекты которые не касаются вещей связанных с тем четче на самом деле происходит на практике в ран тайме в железе и будем немножко больше говорить о это общих концепций а кто более или менее постоянно работает с многопоточности у себя мало хорошо окей ладно ну тогда тогда наверное вот те кто постоянно работает вы вряд ли что-то много для себя из этого доклада вынесете тем не менее с вами пообщаюсь возбуд какие-то мысли вопросы вора те кто больше newbies вот может быть для них и я какие-то вещи покажу расскажу наверное ну так или иначе кто наверно слышал и читал и в институте сдавал и статьи на хабре все вот это да почему я считаю что это важная тема и почему у одноклассника считаем что это очень важная тема потому что он начинает считать статьи алгоритмы все выглядит очень естественным образом то есть везде порядок все там значит потоки работают одинаково всего порядочно проблем нету как значит собственно сталкиваешься с реальностью получается какой-то от вот значит судя по реакции не все эту картинку очень видели хотя нам уже год ходит в интернетом значит смотрите я не очень буду заниматься академизм значит что еще следует ссылки с одного на другой как это любят все академические люди я постараюсь как это больше на пальце все рассказать значит я не буду ничего говорить ну или почти ничего не буду von uns не буду давать никаких советов насчет того что надо делать что не надо делать я попробую некие общие принципы проблема показать вот и холивары этого тоже не будет и собственно никаких волшебных решениям тоже не дам я скорее покажу несколько типичных каких-то вот проблемы грабель в которого ты каются любые там любой человек который начинает работать многопоточность и может быть немножко успел если поговорим об их решениях great значит давайте так вот здесь вот 55 буллитов да кто там примерно знает хотя бы о чем три четыре из них то есть вот чтоб я тоже аудиторию понимал нормально тогда в аудитории мы попали а значит начнем с такого примера которое вот прямо вот все везде рассказывают и показывают значит вот есть банковский аккаунт какой то в нем есть ищейки там значит вот когда вы хотите там не знаю как как работать физически банк там приход человек пишет платежное поручение прошу там перевести условно говоря там такое-то количество денег с такого-то счет он такой-то счет идет человек значит мы очень грубо такой физически банку на стол вера в которой не было никакого интернета не было никакого значит вот и чего электронный счетчик приходит специальный какой то значит скрывает ячейку вытаскивает количество денег другую человеку открывает этот день кто кладет себе физически банки так до сих пор очень многие работают такие фильмы есть хорошие как-то все царские банки люди значит специальные ходят все это делаю вот когда вы начинаете это программировать у вас возникает какой такой код это там псевдокод на псевдо языке который очень похож на java но в целом лойко примерно такая что если денег у вас значит вы хотите снять какое-то количество денег перейти с одного аккаунта которая from на аккаунту если этих денег не хватает вы как бы говорите что денег нет и значит к сексу бросаете что такое делаете но если есть то вы собственно уменьшаете количество денег на счету увеличиваете на эту же сумму количество денег на другом счету и все у вас хорошо пока собственно вас один поток с этой задачей справляется вот когда потоков становится много и вы такой код пытаетесь запустить низких потоках у вас там есть какие-то очевидные проблемы вот какие да громко-громко только что все слышали хорошо значит смотрите ну на самом деле до на самом деле тут куча багов и собственно про этой слайд фокус в том что точки зрения вот логика в одном потоке это сделано правильно то тут очень много проблем с тем что потоки могут приходить на одни и те же самые аккаунт и одновременно и что в этом случае будет происходить очень сильно зависит от того какая модель памяти ну там к модель памяти используется вашей среде и от того чтобы на какую все это запрограммировать в частности здесь одновременно могут приходить потоки на одни и те же аккаунт и считывать значения эти чтения будут перекрываться эти запись они будут значения пытаться куда-то записывать записи будут теряться и так далее так далее то есть возникнет проблема в том что одни и те же потоки без каких-то дополнительных усилий приходят на одни и те же там данные физических китайчики в памяти и собственно накладываясь друг на друга происходит ошибка в том значении которое хотите увидеть да вот банально здесь могут значение там записи перекроется то есть вы потеряете просто какое-то присвоение вас не сойдется суммы начнутся большие проблемы вот как обычно это решают вводят некие не некую вещь который наса блокировка или критическая секция или что-нить еще там много разных терминов вокруг этого есть собственно эта вещь очень простой семантику нет для операции первая называется лог 2 блока еще часто такой в более теоретической литературе эта семантику называется квар и релиз что такое лог или квас значит мы некий кусок кода защищаем собственно вот пара этих методов акварели стрелок unlock и я на входе если собственно и берем некое состояние занят или свободно вот если свободно там и значит входим в эту коническую секцию запускаю там какой-то код потом выходим если там занято то мы стоим ждем ну то есть такая вот собственно после доклада можете сходить в туалет убедиться что вот на практике так работает либо занято либо можно войти вот ну и вообщем такая аналогия странная получилось но в целом как то так ну в общем в собственно лог это либо захватить и дальше двигаться либо ждать в очереди какой-то пока освободится до лестниц собственно освободить good вот и собственно можно все наши операции защитить вот таким вот глобальному на весь банк то есть казать что мои ученики операции глобально не делаем и в общем в целом если у вас операция не очень много есть нагрузка вы справляетесь то это очень даже будет работать но вот как только ваша нагрузка начнет расти то собственно вы начнете соревноваться за этот лог то есть вас все потоки сколько бы их не делали и сколько его машине ставили вашем кластере если у вас какой-то вот такое 1-го глобальный который защищает то вы рано или поздно в него упретесь вот кто знает там литература он там знает про законом дал ее про всякие такие штуки вот это вот про это собственно что тогда надо делать кто знает что делать если вот да правильно надо лучше текстом по отдельности ну как бы как сказано так и сделали сделали log for он сделал акту как бы и погнали ну хорошо давайте считать что у нас что у нас и так аккуратный там трой какой-нибудь написано то есть что мы там разлучились арахна да ну да совершенного это правильно предположим мы допустим делаем волокна эксепшен что еще здесь не так с этим кодом вот да да следующая проблема там на самом деле я покажу немножко вот есть еще одна задачка храмы банка тоже классическая задачка пробегающих философ значит у нас есть 5 философ они сидят по кругу между ними ли там лежат вилки или там китайские палочки и они могут либо ничего не делать той сидеть думать и размышлять либо не могут брать там одну вилку вторую вилку то есть такое условие что они едят только когда у них две вилки в руках вот собственно вот такая к это простая система вот берешь там значит но и какие-то такие простые вопросы задаете значит можно написать какой-то алгоритм для тех философ чтобы они там проголодались ели не проголодались сидели думали вот чтобы они все как-то вот не помню с голоду короче говоря и на самом деле вот и задачи есть куча параметров которые можно менять вот но в целом вот так это простейший алгоритм значит взгляд так примерно берем левую вилку берем правую едим кладём одну венку кладем другую вилку думаем вот такой простой алгоритм тоже очень легко программируется вот как то так тоже на псевдо языке взять одну мелкую взять другую поесть положить можете подумать и все это в цикле такой нормальный философ либо есть либо ждет думает вот но собственно если вот так вот взять такое в лоб решение написать и запустить на каком-нибудь более-менее человеческой вантами но в частности вот живьем вот у вас очень быстро философа перестанут вообще что-либо есть вот и если вы немножко займетесь диагностикой например вот jestic или что эти в том духе запустить это вы увидите всякие разные нехорошие вещи вот именно система ваши напишет что вас там где блоки и даже что-то про это расскажет собствен в чем проблема да проблема она первая строчка в том что уберем сначала левую вилку а потом все правы вот представьте себе такой нехороший кейс когда все философы одновременно взяли левую вилку все программы в этом месте больше ничего не делает по той простой причине что вот никто из них не может взять теперь правую вот эта ситуация называется дилок а мы с банками на самом деле там ровно та же ситуация у вас например вы захотите перевести деньги сперва комната на 2 со второго на первый либо это какая-нибудь там по кругу штука дата с 1 на 2 2 3 3 1 все то есть если вы неудачи написали вот эти ваши локи то беда-беда вокруг оси у этого существует довольно много разной теории вот в этой теории ресурсам называется что-то к чему можно брать локи значит но и собственно терминология ресурс то на чем берут собственно эта операция называется там это раз я захвата далее бы операции тому в английском случая тыквой и собственно то что мы видели это взаимо блокировка никто не может продолжать двигаться вперед потому что кто-то другой ему мешает значит опять таки ресурсы в данном случае либо банковский аккаунт или бутылки они могут быть выгружаем и не выгружаем ее с вот с не выгружаем ими как в нашем случае беда с выгружаем ими есть свои беды мы тоже попробуем об этом немножко поговорить вот соответственно операции запрос я уже говорил то есть можно брать ресурсы seo свободен либо ждать если он занят ну и собственно можно его как-то по использовать освободить ничего нового и опять таки то о чем тоже олег много довольно говорил в своем докладе мол можно использовать миллион разных стратегий поводок делать разные запросы до блокировкой тоже некоторые запрос и в принципе она тоже может быть на вас по зеленой системе хотя это отдельно еще на песню вот и она может быть там без тайм-аута то и захватили и ждем до победного вот берем вилку и ждем просто вот пока до конца вселенной июнь отпускаем вот либо тайм-аутом скажем подержали поесть не получилось положили на место вот либо с исключением не можем взять вилку говорим что ой ой ой какая беда и передаем управление кому-нибудь наружу и собственно дальше вот интересная вещь выясняется что взаимо блокировка вот ситуация в которой все всех держат она может возникнуть только в случае когда выполнена этом 4 некоторых условиях одновременно это на самом деле слайд на который но кто хочет вы питается на интервью кто собирается дать интервью муж фотографировать мало кто знает вот на самом деле вещи которые нам сейчас современных системах кажутся очевидными часто приходят к эта система в которой все работы немножко не так мы потом участи но ломаем голову почему же вот она совсем другая почему же с ней совсем по-другому работают в частности это связано с ресурсами есть процессами с потоками тем как они ведут себя с этими самыми ресурсами и собственно что же это за четыре волшебных условия до первое это условии взаимного исключения значит как это удобно сортирный примерно заходит всегда лучше других вот у вас есть общественный туалет вот и в нем может находиться время кто-то один вот либо никого не находиться два человека в нем находиться не могут вот дальше собственно процесс который ресурс удерживает он может запрашивать еще какие-то новые то есть вот если мне что-то я могу просить себе что-то еще нельзя принудительно выгонять что это 100 лет это как бы плохо для системы и дальше собственно когда возникает диалог когда возникает некая последовательность из низких процессов которые собственно не дают друг другу двигаться дальше вот собственно для этого существует хорошая красивая графическая модель граф уже все давно проходили в институте да все думали зачем они нужны вот на самом деле очень даже нужны рисуется двудольный граф ориентированный и в нем собственно есть два типа вершин это ресурсы и процессы но здесь у нас процесс это черные квадратики а ресурсы это оранжевый кружочки значит если процесс сейчас удерживает ресурс то есть ресурс занят процесса мы рисуем стрелочку в одну сторону если процесс запрашивать ресурсный ресурс занят кем-то другим то собственно мы рисуем стрелочку в другую сторону вот и кто знает как будет выглядеть такой модели deadlock да то есть будет на самом деле цикл то есть все очень просто вы сняться что теория графов это небесполезное занятие она вообще кому-то нужно это-то и делать ну а теперь представьте себя что у вас есть собственно какой-то большой граф в нем существуют некие ресурсы на которых вы берете блокировки есть некоторые потоки которые все это делают все это динамически меняется в памяти например и соска динамический адаптивный ротань и вашу натальную примеру ну то есть вот базы данных да мы тут очень много на конференции говорим про база данных вот базы данных она должна фронтами строить какие такие модели в runtime и там находить графа да то есть вот она она должна находить цикла в графах да у нее систему там здесь таблице есть строки на этом на всем было от кита блокировки и вот реальная задача чтобы на живую ну живых запросов пытаться находить там в таких график цикла это вообще говоря трубы вот соответственно видите да где edit log кто видит ну видит кто-нибудь наверное да ну да вот такая штука и это это еще очень какой-то простой там буквально здесь сколько там 12-13 у меня объектов в системе в реальной системе их могут быть сотни этом 1000 да и сколько угодно и все это еще меняется постоянно со скоростью много-много раз секунду нифига не тривиальна и соответственно с с блокировками существует с ним надо бороться до если все это самые разные стратегии борьбы давайте мы про них немножко поговорим первый алгоритм это очень ну кто знает этот алгоритм на самом деле это такое да это это еще с придумал когда готовила слайды вот на самом деле это проблема называется давайте сделали что мы страусы зароем голову в песок вот собственно и на самом деле выясняется что это не всегда провальная стратегия это то о чем говорил о самом диалект что если ваши у вас есть к этой проблемы эту проблему там не видят например ваши пользователя то может быть это и не проблема вообще говоря в целом то есть когда вы вот у вас возникает эта проблема в системе ну в частности блок то следует провести простой анализ да насколько часто она возникает если она возникает 1 год то может быть как бы хрен с ней вот значит второе это вообще если у вас в системе другие проблемы может быть у вас вообще все нахрен разваливается вот там вот где-то в углу есть блок вы таки нет нет мы пойдем чистить чините блок и плюнем на систему то есть ну такая естественная вещь то есть важно понять насколько вообще блоки в вашей системе это проблема и последние наверно там самое важно это вообще последствия если вас последствии никаких нету нудил оки-доки с ними может быть можно забить на всё на это вообще следующая стратегия это обнаружение блокировок это система которая собственно как-то там следя за тем что чтоб система происходит если находят блок они что-то с этой штукой делают но в частности например принудительно все убивают и перезапускаю философу немножко поели стали в deathlok мы взяли все всю эту хрень перезапустили и собственно и дальше ждём пока не задело очень смысла перезапустили вполне себе тактика почему нет значит существует ну то есть я проговорил до что да можно еще ввести некий период эта скажем в нашем случае взрослые могут быть более сильными и более слабыми вот и например более сильный философ он у него немножко больше прав вот например он может отобрать вилку слабого философа вполне себе тоже почему нет очень даже стратегия вот уничтожение перезапуск я говорил вот у нас тут как бы какой-то там как все работает в государстве газ отжал там очень модная тема вот про откаты значит вот это то что все падали на самом деле мы чуть-чуть про другое да кто еще в детстве видел windows наверно сейчас уже мало кто видит windows значит у вас винда постоянно ломалась старая винда вонючий надежной системой постоянно говорила что вот есть некоторые точки отката волшебные в которой можно откатиться и все будет работать на самом деле вы откатывались в данном случае 10 вот и потом все равно ничего не работало вот то что плохо умели еще сумеет лучше собственно идея возникает в том что у вас некий контрольной точки там snapshot условно говоря если у вас 2 систему сзади случилось то вы можете откатиться к кому-то snapshot у но тут есть такая проблема что если вы откатили снапшоты дальше ваша система ведет себя точно так же как она вела себя в предыдущий раз то вы снова упретесь этаж сам edit log поэтому таких систем нужно но иметь там например kipp дополнительные внешние источники рандома или что-то в том духе который позволит системе как немножко по-другому себя вести либо какие-то точки в которых ну то есть фиксировать какие-нибудь переходы условно которые мы делали вести себя по-другому то есть должен быть какой-то внешний источник который говорит что нам ну как бы который не даст вам повторить то же печальный пути случае когда вы делаете откат ну вот вот в частности собственно старых я не знаю как новых там наверное те кто колеях то там работа сейчас мы с гелем они меня поправят на старых системах там собственно если у вас есть две транзакций между не возникает зима блокировка то собственно выбираясь некоторые жертва которой говорится как бы извини но тебя придется обучить про уклонение за блокировки если runtime умный он может так scheduler у кулер может так планировщик задач ных может раскидать ваши задачи по процессорам что не даст им захочется вот это отдельное совершенно область науки алгоритм банкиров можете погуглить большая интересная штука иногда работает иногда нет ну вот тем не менее это вот там такая классика вот идея заключается в том чтобы поиграть с немножко в планировщик задач и попытаться не дать процессом захватывать опасные локи то есть попытаться дать эти что вот значит вот еще чуть-чуть и мы войдем edit log вот если вот ты чувак сейчас вот возьмешь вилку там один блок значит и чувак ничего не делай подожди немножко пока ситуация улучшится вот примерно такая стратегия ну и собственно у вас есть четыре условия любой из четырех можно атаковать то есть если они все четыре соблюдаются те блоки возможно если хоть одно не соблюдается to die блоков в собствен одиноков системе не будет вот взаимно исключение убираем ненужные блокировки акуратно нужно очень следить за корректностью насчет следующая стратегия называется давайте мы будем ни по одному захватывать ресурсы а давайте мы их вместе сразу захватывать тут тоже бывают разные проблемы потому что не всегда понятно как имплементировать вот это вот все вместе то есть на этом все вместе должна быть некая товарность с точки зрения там модели памяти вашей системы вот и собственно еще тогда вторая проблема в иногда когда начинаете делать какую-то вот такую там транзакцию да вы не всегда знаете на самом деле заранее что вам надо то есть куда там она полезет если вы это знаете ну хорошо если вы этого не знаете то очевидно все сразу вас может не получаться захватить особенно когда и скиньте кондишен утром систему что если у вас какое-то значение то мы идем еще что-то захватывать нет другой как значение не идем не захват вот еще одна интересная стратегия называется временно высыпать все что есть то есть философы перед тем как там начать есть вот у него уже есть в руках там кита вилки он их там кладет на стол и потом пытается взять снова вот возможно кто-то другой не в эту вилку перехватит то есть для него это может быть конкретная проблема опционная система это довольно хорошее решение вот и есть собственно такая классическая для для нас с вами для программистов система это атака условия циклического ожидания собственно давайте мы просто не будем как-то запретим системе нашей скопируем а так что циклов не возникать не будет вот и классическое решение в этом месте это нумерация ресурсов вот значит давайте мы позволим философом брать ресурсы только в порядке братики только в порядке возрастания всего супер углероды витки бронированы мы будем брать не сначала левая потом право будет брать сначала вилку с меньшим потом вилку с большим номер не сложно в общем показать что в такой системе де блока не будет вот потому что вас просто если вы ваш или вот возьмете вот этого цикл ну возьмите вот эту вот модель с довольным графом и попробуйте в нем состава прорисовать ну пронумеровать ресурсы которые вы захватили то выясните немедленно что не бывает такого цикла в графе до в котором при движении по стрелочкам номера все время растут потому что собственно рано или поздно вы там идя по этому циклу витязь к началу ну и в общем тут вас тут же разочарований соответственно такой доказательства на лету лёгко соответственно получается что собственно нумерация рисунков это задачу полосе решает набраться аккаунтов точно так же решает задачу мы сначала лучше мне пока он с которого он переводим или не аккаунт на котором переводим а тот у кого тупо идиш так меньше с этим тоже бывает проблема потому что не всегда у аккаунтов можно там взять хорошие техники и в общем случае в системе не всегда можно сделать хорошая техники проблема дисков олег тоже на самом деле говорила свои презентации вот случае философов есть еще одна беда если взять и просто вот запустить на любом практически языке по генуя низких запускал такую систему систему с философами да и просто дать и некоторое время поработать и братья ресурсы именно в порядке вот остальных номеров вот то все будет работать то есть общий прогресс системе будет идти количество съеденной еды будет расти вроде как все будет работать но при этом я взял какой-то момент решил посмотреть а вообще говоря нет ли такого что скажем к это философ есть а все остальные стоят и ждут ну логично вроде в системе в целом прогресс какой то есть но если прогресс у каждого и выясняется что в общем нифига вот эта вот система работает буквально там пара секунд и числами обозначены количество еды который съел философ за эту пару секунд и можно заметить что результат драматически слегка то есть не то чтобы они едят не совсем ну то есть не у всех одинаковый приоритет одинаковые права вообще абсолютно вот одинаково созданные там потоки процесса все что угодно зависит от системы и выясняется что разницы между соседями она экспоненциально до в одну сторону она растет другую сторону социально бывает внезапно да ну да понимаешь это очень специальный тест которому система ничего не делает кроме того что чтобы крутится вокруг и блокировок с никакой полезной работы там нет если там была бы какая-то полезная работа которая самое главное какой то смысл и при уже так времени занимает блокировками то ситуация была бы не такая драматическая конечно в одном случае когда система занимается только тем что перекидывает туда-сюда блокировки вот результат будет вот такой смотрите свойство очень простой вот когда все собрали сначала левую вилку потом правую модель была симметричной а когда мы поменяли это правило то на самом деле для одного из философов а именно для 5 правила игры изменились то есть все по-прежнему кроме него продолжают брать сначала левую вилку потом права и только он один берет и в другом порядке но это сразу приводит к тому что вас модель стала несимметричной у вас есть кто-то кто симметричность вашей модели нарушил и это симметричность она внезапно ну в первую часть пагубно сказалось на нем сама то есть вот этом сам пятом злополучном философы который собственно вообще перестал что то есть практически вот и собственно дальше это всё раскидал с по системе вот таким вот странным образом это все и к чему к тому что общий прогресс системе и прогресс для каждого конкретного worker а это очень разные вообще говоря вещи если вы видите на ваши графиках что ваша система там вообще говоря справлять не знаю место жилка candida типичная история у вас есть месяц у кого он уперся в какой-то единый лог там вы сделали конь strapping и у вас и надейтесь что теперь вам полегчает вот вам может полегчать и вы там можете это увидеть а можете может воплощать но вы этого не увидите конкретно с маркерами это может превратится в то что у вас какие то сообщения которые приходят к определенному worker у но они просто капец в очереди остальные ходит нормально вот с кем то конкретному проблемах и от ситуации она называется голодания или starway шин вот есть расхожее ра заблуждение что что старого и шин случается в случаях когда вас у потоков там физически на уровне там операционной системы scheduler а разные приоритеты на самом деле нет вот это вот историю с как бы с неодинаковость you неоднородности и можете носить нифига не операционной системы не scheduler а вообще для просто модель до модель того как вы это программируете это тоже не очевидно то есть точки зрения того чтобы казалось бы мы берем сначала вилку с меньшим номером по тарелку с больше мы берем сначала аккаунт с меньшим номером по такому с большим вроде как правило игры одинаковые на самом деле вот если с другой стороны посмотреть то ни фига не одинаковые вот но это вот мы поговорили про там про одно только из условий да дальше можно разгружать значит дальше еще одна проблема такая называется lifelog вот представим себе что у нас есть дверь в которую пытаюсь войти несколько человек и каждый из них говорит как бы после вас все очень вежливая и вроде как они все что-то делают там общаются друг с другом а в дверь никто не проходит если это формализовать то это такой эффект вы смотрите ваша система она будет что-то делать какие-то операции проходят у загружен там что-то в памяти крутится вот а прогресса нет вот если кого-то глобальный счётчик прогресса сколько там единиц работы вы сделали ничего никак не увеличивается вот вот это вот возникает из каких таких эффектов то есть еще там более сложные эффекты на системах томска слугами прочими но мы наверное сегодня про них уже не успеем поговорить распределенные блокировки тогда вы видимо показывал разные сценарии как там волшебного раза все что угодно может валится там есть клиент не знаю клея спустился метро него пропал интернет обыскал сделал запрос и общем потом он вышел из метро и что что должно произойти никто не знает никто не понимает и вообще чтоб все это корректно работала систему требуется строить определенным образом довольно сложно вот в нашем случае представим себе что у нас есть там что у нас зеленая блокировка ситуация в которой скажем клиент берет какой-то ресурс на сервере для того чтобы развести некую операцию а потом собственно делает операцию потом этот ресурс его обожает вот он сообщение постит вот он берет этот ресурс делает под ним то что ему нужно и вдруг не знаю интернет пропадает на серве остается блокировка что делать вообще непонятно он там вон там возродиться там не возродится может батарейка села может пользователь решил закрыть приложение может быть там я не знаю другой начал делать может быть bac ну и здесь еще так нарисована клиент и сервер что клиент это вот некий там скажу пользователь да а сервис сервера это же клиента может быть там соседи сервер вашей стойке да вот тоже про то что олег рассказывал про клиент и сервер это наша система там много уровней один кластер ходи к другому всего там сколько больше 150 по-моему разных по системы они там непрерывно другом общаются вот и там тоже может проходить что угодно между центрами сеть оборвалась на стойку что-то упало черт вот поэтому распределенной блокировки вообще говоря это определенно там своя большая наука и своя большая головная боль вы тут про них на самом ничего говорить не будем проблема такая что действительно вот куда ни плюнь везде везде что-то не так вот это наверно основной место моя сегодняшняя презентация что использовать такие системы надо очень осторожно и лучше брать готовые чем писать свои это на самом деле большой сейчас большой тренд и большая наверное самая большой самый челлендж современные многопоточной разработки он заключается именно в том точки зрения разработчиков фреймворков разных да как бы сделать такую систему чтобы она работала на пользователю не как можно меньше мог накосячить и все эти системы ну там большинство систем известных мне они приходят к тому что вообще все ручки связанные с потоками они прячут внутри себя и какие свои кишки наружу пользователю они не отдают вот то есть api он становится чем-то простым и ничего вообще не знают про потоки вот если у вас не некая очередь которая по вашей спецификации многопоточное то как правилам говорится что вы можете обратиться к ней из нескольких потоков и собственно делать что угодно и вот она сама внутри себя from word вам гарантирует а там не будет блоков что не будет потерянных данных не будет гонок не будет чего угодно вот любая попытка сделать какой-то фреймворк который наружу дает какие-то ручки нетривиальные она закончится крахом вот соответственно чем можно делать совсем возмущены в частности там с блокировками со старейшинами всем остальным в первую очередь это попытаться ну то есть к крайней мере посчитать про это узнать вообще как все это работает и поизучать классику что именно про изучать я скажу через минуту буквально вот аккуратно власть блокировки общие правила и с точки зрения перфоманса с точки зрения корректности диалог всего остального брать как можно позже отпускать их можно раньше значит или есть еще вообще альтернативная история это использование систем без блокировок когда у вас есть там атомарные апдейты когда у вас есть вершине нг и там что то в этом духе к этому на самом деле многие приходят но там тоже много своих самых разных грабель проблема оба если у вас она что runtime сборка мусора если у вас мы на 4 мая так далее вот ну и да всё на системе это вообще-то игра отдельно беда теперь собственно литература это во первых конечно классическая книжка tannenbaum а можно читать по-русски можно по-английски потому что русский перевод очень очень даже адекватной глава 6 называется она так называется за его блокировки можно если не носили 4 издание можно читать 3 там вот по крайней мере части про это правда ему блокировки она сильно не изменилась и для тех кто хочет хардкора а да и вообще чувствует себя труп программистом есть классическая книжка 2006 кажется года save the art of males процессор программе нда но это понятно это такая известная и известная refer на другую известную книжку соответственно про зайцев просто вертов программе надо соответственно хорошая книжка берите лист репринт потому что в первой версии много ляпов у меня знакомый который даже диплом по он писал поля помыться из книги сперва с этой книжке там собственно все очень подробно разобрана и очень много там весь и pro performance и про корректность и самое интересное то реально учебник там реально есть доказательства из того что полезно там есть упражнения вот из упражнений к 1 помог самый первый ко второй главе уже не помню у меня родилось два или три доклада в свое время вот как то так у нас есть еще несколько минут на то чтобы сколько у вас есть минут есть то чтобы поболтать 15 ох ты хорошо все значит у меня все на сегодня и давайте давайте поболтаем спасибо спасибо за доклад содержательно вопрос такой а что делать с системами которые но в блокировки это проблема систем ну вот просто ним противных систем что делать система в которых является какие-то модели последние программы другого уровню скажем к детектору или чешуи таком духе они решают массу проблем связанных блокировками но тут просто вами слово да ну да я системы с акторами но собственно это как один из хорошо да грубо говоря существует глобально для тех кто может быть не очень и там тоже вкусите рисует глобально две принципиально разные модели как между собой могут взаимодействовать процесс или потоки в проблема когда проблем возникает тогда когда нужно обмениваться какими-то данными собственно и глобально существуют две больших моделях привычная нам почти всем при программировании модель когда у вас есть какая-то ячейка памяти и вы можете делать на ней операции типа рита райт почитаю значения записали значения это вот такая классическая модель и блокировки в принципе проектов про то как вот к этому как к этим общим ячейкам памяти ощущать правильный параллельны доступ есть вторая модель она принципиально иная и это собственно модель называется местных модель передачи сообщений там собственно есть два ключевых метода у актеров у игроков учите этой модели это метод послать сообщение и метод сделать что-то при получении а соответственно я бы отвечая на твой вопрос в итоге я покажу там совсем другая модель просто на другой у нее другие проблемы вот и все она немножко за рамками доклад но так собственно да как один из способов избежать этих проблем вот использовать модель совместный дженга вы получить другие проблемы место этих спасибо спасибо быстрый вопрос когда он там четное количество философ там распределения какое работы хотите можно после доклада поиграться я вам покажу я по памяти так не помню над понимать что там этом четность не четность количество это вот я брал там несколько это laptop bag четырехъядерный какой-то простенький там core i7 и есть у меня там в лобби сервер тоже не очень мощно несколько я гиря мощный не брал я моделировал на них то есть там в обоих случаях 4 физических ядра четыре портрета черта 0 1 2 3 и так далее то есть это здесь очень важно понимать что физическая модель исполнении будет сильно зависит исполнителю data processor with scheduler и операционных систем и много много чего но я честно говоря там конкретно я не разбирался от чего у меня такие эффекты возникают ну вот и я вот из всего что я видел из всех вот спецэффектов которые я там пробовал на разном количестве потоков запускать с разным количеством там памяти проще и проще вот единственный видимый видимое различие которое видел я лично это именно четность не четность количество качество философ задача ну наверно там можно немножко подумать и теоретически показать что висит над это что-то зависит модели но я думаю что нужно брать к это вероятностное там распределение брать рад нужна модель того как у нас scheduler собственно запускает наш эти самые процессы физически на ядрах и делать исходя из этого конкретный они моделировал"
}