{
  "video_id": "wqB8eX5qKFI",
  "channel": "HighLoadChannel",
  "title": "Красиво и не тормозит! Анимация без ущерба для производительности / С.Токарев (SuperJob)",
  "views": 613,
  "duration": 1361,
  "published": "2017-04-22T14:47:56-07:00",
  "text": "я хотел бы поговорить сегодня о анимации и каких-то методах который позволит вам получить пару-тройку лишних fps а где-то порой существенно ускорить свою производительность свое предложение ну прежде хотел бы начать с небольшой истории о том как мы выпускали очередной релиз пару лет назад приготовили сборку все протестировали отдали тестировщиком build они тоже протестировали посмотрели и дают отмашку что можно выливать в магазин мы выливаем стар и спустя какое то время это презентация открылась можно нет мая но порядок не тот потому что нет у супруга это труд которая ван перси но она в общем и варистор и оказалось что приложение тормозило она тормозило нам стали поступать отзывы от пользователей что она тормозит на младших устройствах на тот момент это были четверки вот мы все тестировали там на пятерках и мы поняли что что есть проблема и что нас тормозит список список но тот момент это было приложение для соискателей мы обновляли список вакансий и он показал что он тормозит на четверках дермазин список еще плохо погружались картинки нужно было с этим что-то делать вот мы исправили проблему и выгрузили новую сборку написали слезное письмо выпал о том что чтобы они побыстрее здоровью или нас в итоге они заявили на за один день и все прошло хорошо и хотелось бы добавить немного грустной статистике том как о том как ведут себя пользователи в случае того что случаи когда что-то не так идет в приложении по данным статистики hewlett-packard который предоставляет тоже различные сервисы для аналитики около 79 процентов пользователей зайдут пару раз еще в приложении ваша если она упала в первый раз при первом запуске то есть мы теряем сразу 20 процентов пользователей в момент когда продолжение крошиться еще 25 процентов пользователей выйдут из приложений если она будет тормозить или не будет откликаться на действия пользователя в чине трех секунд еще 31 процент расскажут об этом своим друзьям и скажет что это приложение там крошиться тормозит и глючит и вообще не ставь его поставь лучше другое приложение я думаю никто не заинтересован в таком развитии событий и никто не хочет терять своих пользователей и думаю поэтому мы все сегодня здесь собрались и хотелось бы поговорить и формате разбор данного кейса как у нас происходит процесс разработки суперджо к нам поступает с ним придумывает загорается какой-то идеей о том что нужно там улучшить скажем список к резюме в приложении для работодателей он горит этой идеей бежит к дизайнеру и говорит что нужно все переделать и в итоге мы получаем вот такой вот макет на выходе мы видим обычный список ячейка на которые немного лейблов на ячейки каких возможные скругления тени и все это может сказаться на мальчик устройствах еще загрузка фотографий фоном как это возможно и ирис айзен скругление наложения масок и прочее все это может дать ущерб на производительности естественно чтобы не было такого как в моей истории в самом начале что ожидания совпадало с реальностью хотелось бы поговорить чтобы не тормозил список отображались картинки и как сделать так чтобы приложение соответствовало отклик у давал мгновенный отклик на действия пользователя и поговорить о текущих путях улучшения это работа с анимацией и работаю с потоками для начала перед тем как говорить про анимацию хорошо бы понять о том как она работает то есть об этапах ее выполнения первый этап это layout на данном этапе происходит формирование фреймов которые будут отображены далее и задание свойств для view таких как заливка background различные borders следующий этап дисплей на в данном этапе происходит формирование изображений которые потом будут переданы на render сервер то есть на данном этапе происходит выполнение методов друг другом контекста и дроу rect третий этап это препарат подготовка на данном этапе корни меньшим пакует подготавливает все что все те изображения которые были на втором этапе сделаны для отправки их на render сервер и commit финальная стадия на нем происходит то что корни меньше покоятся слои и уже непосредственно отправляет их на render сервер это то что касается то что происходит на стороне основного процессора на стороне графического процессора происходит вычисления промежуточных состояний фреймов в анимации и непосредственный их рендер повлиять мы можем только на первых двух этапах на этапе layout и дисплей но прежде чем говорить об улучшениях еще неплохо понимать о том что у нас сможет с вами замедлять графический процессор слишком много геометрических вычислений то есть какие-то различные преобразования там полеты не знаю одного угла что-то может полететь другой угол это все та же является геометрическими преобразованиями которые ложатся на сторону графического процессора большое количество перерисовок если мы имеем если у нас есть кнопка на ней с ней как-то может еще пересекаться там возможно ли эболы или что то еще их гранит в тот момент когда игра не пересекаются и если они имеют прозрачность то графический процессор будет вычислять то как их на их наложении между собой то есть если есть возможность задать заранее цвет фона лейбла и и он известен и не нужно чтобы он там скин пересекался с другим слоем элемента то лучше это делать заранее в итоге мы получим пару-тройку лишних fps которые дадут нам в общем прирост различные закадровые отрисовки это к ним относится все что не может быть не может быть отображена сразу это тени то есть обводки для наших view различные маски и и все слишком большие изображения если мы загружаем какое-то большое изображение соответственно под него выделяется соответственное количество памяти и хорошо когда это одно изображение если там много изображений то соответственно в пике они дают очень большую нагрузку на графический процессор и соответственно мы получаем падение фпс что замедляется по ум преобразование изображения то есть различного рода 1 3 зация сюда относится если кто-то еще может быть вряд ли конечно такое делать но преобразование из одного формата в другой тоже там из png в джипег тоже являет дает нагрузку на основной процессор различные вычисления layout of то есть вычисление фреймов относительное положение друг друга тоже дает падение фпс и ленивая загрузка тут имеется ввиду ленивый загрузка viewcontroller а когда viewcontroller отображается в первый раз на экране он все основные действия происходят дальше фоном то есть в момент когда мы читаем баз данных или читаем большую коллекцию изображений это все может сказаться на отзывчивости вашего приложения вот но я хотел бы остановиться на методе на втором этапе дисплей когда отрабатывает метод ролик вот небольшой пример кода отрисовки одного элемента то есть в данном случае e-mail тут сдаются его атрибуты и где где он позиционируется на основном view и в итоге мы получаем такую картинку изображение дом показывает нам как каждый лейбл находится на в основной иерархии view и это показано красными прямоугольниками после если в методе дроу rect от рисовать каждый лейбл то будет выглядеть как единое изображение и в итоге мы получим значительный прирост но надо помнить что в данном случае мы отказываемся вот та стала ялта и нужно вычислять все руками и что доставит много более так как нужно учесть как-то на разных устройствах будет отображаться но я думаю оно того стоит то есть голубой график показывает то время отрисовки основных ячеек до применения и после синий где-то примерно на порядок отличается время отрисовки но надо понимать что данный пример был таким утрированным что применение этого метода должно быть осознанным в тот момент когда вы понимаете что все что вы могли улучшить не работает то можно попробовать данное свойство переопределить также тень у нас еще была тень ободка ем почему-то многие забывают про shadow пасс он с помощью него очень быстро можно от рисовать тени и не прибегая там стандартные методы отрисовки вот все хорошо мы отрисовали фрейм расположили на нем основные элементы добавили тень и хотелось бы в дальнейшем как-то контролировать число кадров и не запускаем при этом отладчик есть множество библиотек указал вот xfp с есть множество модов которые можно подключить своему проекту и задать у них тут какую-то границу после превышения которой точнее например меньше 40 fps когда падает то сделать так чтобы она отображалась есть еще методы когда высчитывается разница в основном потоке высчитывается количество времени которые блокируют основной поток и соответственно тоже можно вводить сообщение от каких-то логах вот ячейке у нас скроется все казалось бы работает но он необходим еще нам с вами погрузить изображение и и сделать ему риса я думаю все знают что это можно сделать с помощью многопоточности многие люди когда приходят на собеседовании superjob порой теряются при ответе на вопросы про различные виды которые не знают как работа с потоками есть айос нам дает он ест red ns operations и grand central dispatch in истрать нам нужен кстати есть те кто использует иностранных приложениях мы тоже не используем хорош тем что если тебе нужно полный контроль над созданным потоком то это в сторону и не стоит стоит смотреть и нас операцию хорош тем что он позволяет добавлять зависимости между операциями и он является более высоким уровнем работы с потоком сам apple рекомендует работать на самом верхнем уровне и постоянно как бы совершенствует работу с ними grand central dispatch я думаю самый распространенный метод работы с потоками в его можно встретить везде том числе и на stackoverflow он фигурирует большинстве ответов и соответственно ниже дальше я предложу три вида того как как можно было бы в данном случае загрузить картинку с помощью эстрада нас есть какая-то модель фотомодель и у нее есть метод долот фото и мы создаем поток для загрузки в данном случае с помощью grand central dispatch можно таким образом загрузить то есть с чего грузим фото потом дальше в основном потоке делаем какой то с ним преобразование и на с оперой шим там создаем две операции и the network загрузка ресайз и как раз то что то о чем я говорил это добавляем зависимость сначала загрузку фото потом я его обработка и собственно создаем очередь и выполняем ресайз необходимо понимать что каждый раз когда мы создаем поток лишний он также отъедает у нас время на время процессор на и дополнительно выделяет нам память вот так что я вас всех запомнил если вы к нам придёте на собеседовании ответите на это на эти вопросы то пеняйте на себя ну это конечно все шутки мы понимаем что нашими приложениями с пришел ежедневно пользуются десятки тысяч пользователей и и мы не можем мы не имеем как brown ошибку и должны разбираться в тех инструментах которые мы используем собственно у меня все всем спасибо вопросы используйте layout и для отрисовки как вы оптимизируете например или силе всегда у вас позиционирование авто да мы все в основном стоял там используем только данный метод это вот как для примера оптимизации мы не особо не сталкивались с тем что мы упираемся производительность of the royal это так сильный и на старых девайсах тоже есть у нас отказались от их поддержки мы поддерживаем минимальная iphone 4s вот и не объясню просто у меня такой вопрос возник тут нет она тоже запускали одно приложение и у директор нашего казался первый ipad и на нем все это жутко тормозил на когда я стал разбираться казалось что это вот проблема в fallout ах там пришлось сделать некоторые хаки мне вот интересно просто опыт еще выходит по этому поводу нет мы как-то не не прочь надо то есть либо уже переходим на фрейма и фреймами непосредственно ручками там что-то расставляем и где надо конкретно отказаться тогда автомат используем что все вопрос прочь нет все всем спасибо"
}