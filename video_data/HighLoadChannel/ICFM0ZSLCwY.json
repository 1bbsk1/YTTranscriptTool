{
  "video_id": "ICFM0ZSLCwY",
  "channel": "HighLoadChannel",
  "title": "Длительный рефакторинг в большом проекте / Федор Лаврентьев (Яндекс.Go)",
  "views": 2148,
  "duration": 1981,
  "published": "2021-10-04T02:47:02-07:00",
  "text": "всем привет спасибо что пришли спасибо что пришли на самый ранний самый первый доклад доклад на такую печальную безнадежную тему как рефакторинг я ожидал что будет пустой зал будет три человека и мы с не просто камер на поговорим о жизни и грузные разойдемся но я приятно удивлен давайте тогда начинать итак это история о том как я занимался большим проектом при факторингу одной компании в яндекс такси все началось году примерно 1018 когда 2018 когда я еще не работал яндекс такси и меня балку это опыт я был техническим менеджером который занимался в основном машины мучениям и работы с данными работал в кучу разных компаний построил 10 разных продуктов и занимался консалтингом в своем маленьком мультики занимался сведением и мыльных премиальных приложений под ключ обычно такого не зрение начало с того что нужно было понять что люди хотят а потом понять что не хочешь с данными потому что машинное обучение но данными данные по сути пит питается обычно там был это хаос и нужна была школа перейдя produce навести это нужды в конце шестнадцатого года ко мне пришли мои знакомые из яндекс такси и предложили сделать тоже самое но у них и не как console вчера прим вот внутри и почему ты согласился вообще если вы не в курсе как рук для того заданными то вот пример типичные по структуры взяты из какого-то древнего моего доклада что вообще происходит у нас есть киты источники данных в компании это сервис и какие-то бренды возможны это внешнее штуки типа google analytics и так далее мы соберем из них данные и запихиваем себя потом долго их чистим нормализуем раскладываем во вторых у них связи а в конце концов мы включаем cute систему отчетности и там какие-то люди из бизнеса понимают что у них все хорошо или все плохо если хорошо они радуются им владеют премии на основе этих данных это плохо то они паникуют мальчики за решение и если в данных все хорошо то решение бывает иногда правильные а если данных все плохо то времени будет дата лайком быч называют ту часть внизу который находится нижний слой целом от не очень важно для нашего доклада просто что мы понимали мире factory мне только сервисы и какие то ну и у нас есть большой набор большие объемы этих самых данных которые нужно возить туда-сюда и любая процедура с рефакторинга включает требует перекладывания каких-то гигабайт терабайт или петабайт данных и данного формата в другой стрелочки нарисованы здесь и так называемые детей по pipeline и е т р ы т как то раз он был out собственно вся логика все бизнес-логика датой по структурами . заключается и концепции расположение всех этих слоев это их называют архитектурой стрелочки как какие возможны делать стрелочки называют потоками данных а сами стрелочки это деталь pipeline и итак я прихожу в девяностом году индекс такие и что там есть есть довольно большой проект с которым уже 25 человека нет много всего написано в разработке он несколько лет там есть команда человек десять 12-15 этом вес примерно 500 стрелочек довольно много написано много много кода и там я снять как разной освободят на стенке было три разных чтобы да вот тут их как бы чуточку побольше как это получилось но мать очевидно так бывает со всеми такое наверняка видели у себя вне зависимости того чем вы занимаетесь сначала вы хоть и какие задачи вам нравится от решение вы его масштабируете и немножко забывайте обобщить и какие-то рефлекторные концепции в итоге получается что-то сложное уже непонятно как быть в таких ситуациях люди напрягаются начинают не прямо что делать все просто начинает начинает падать если снижение с данными сделано плохо то мы знаем об этом от юзеров все друг на друга рут пишут критики ты постоянно пальцы некоторый хаос возникает этот соблазн отвлеклась при факторинга давайте мы все это перепишем что было наконец нормально и так что мы будем делать мы будем все переписывать на самом деле нет подождите до сначала понять что вообще почему такая ситуация возникла что происходит на самом деле если копают вглубь ситуации получается ставящие как бы point их которых который нам нужно будет чинить во первых это сломалось никто и концептуальное понимание то что был сделан изначально она перестала выдерживать новым требованиям и немножко под протухла целевая картина больше не видно поэтому люди не знают к чему идти есть некоторый хаос глава с ним начинается все проблемы как не знаю что делать то делаешь все подряд и в итоге у тебя бы плохо ходят по контролю и начинает взрываться ты не знаешь на чем фокусироваться ты начинаешь делать все медленно и хаотично и дальше идут проблемы уже прикладные в первую очередь ты прекращаешь сядет за кодом ты просто нет на это времени так петру не выдерживает чего-то ты начинаешь писать код code хаотично выходя из своих эти летуны концепцию тебя получается большое чрезмерно большое многообразие всякого ты мог бы это все сделать унифицированы единообразно и некоторые вещи подумать или 90 сделать нормально вот это сделать сейчас не успел поэтому ты начинаешь каждый раз плодить какие-то локальные костыли заплатки и смелые решения из этого они все друг друга не похожи их много они разные и они все разной степени ущербности и привод тому что у тебя в конце концов ломать и контроль над runtime то есть ты у тебя не унифицирован мониторинг для того чтобы они унифицированный процесс и код ты начинаешь все ломать какие-то баги которые всплывают в одном месте tedx чинишь они смывают другом такие же переходят еще не там заново все общем очень грустно в целом это проблема на самом деле хорошо известны многим техническим обходительным и а не примет их решить как решать в целом для нужно во-первых вы оставите концептуальное понимание понять чему мы идём построить не котел целевую целевую картину который мы будем бежать и придумать как к ней бежать вот только подумайте и на придумать ник ник некоторые план перехода из текущее состояние в желаемое кроме того нужно сделать некоторый фундамент то что можно было начать на него переход когда рождения полом она нужно починить его рутинную работу нужно нужно поставить которая экологам понять что там отделочный надо выстоять это фокус и если у нас есть некоторый негатив от заказчиков из бизнеса надо выставить работу с ними все починить ну и вообще когда нужно научиться нормально публиковать код делать релизы что все каталась все было хорошо и уже после всего этого мы сможем взять и убрать тех долг то есть три factory всякое мы находим находимся больные вещи приводим их чему-то унифицированном у все переписываем весело потом просто в кути менталист им платить новый legacy код потому что пока мы не сделали первые несколько частей мы все еще платим к этой legacy итак рефакторинг находится здесь и хочется сказать про него на самом деле отдел троном потому что начала нужно понять куда мы идем нельзя начинать рефакторинг какой-то большой проект по переделке всего пока это не знаешь почему ты хочешь прийти и кроме того нужно быть иметь возможность все сделать нужно сделать так чтобы хватило сил на это значит и просто не тоскуешь не выполнить свою прекрасную миссию и из всего этого диффундирует первый принцип файтингах терновым саун как-то помог это нам нужно знать куда мы хотим прийти и так покатили во первых что мы делаем это мы мы начинаем делать основатель вы платформу мы разделяем нашу команду на команду разработки инфраструктуры и команды разработки продукции данной продукции команды разработки инфраструктуры занимается только по стране много его картины мы берем над отдельный ресурс команда разработки продукта занимаются ликвидации горячих более бизнеса мы разделяем команды по довольно тип нам очевидного принципу в команду слева войдут разработчики с на суде широким кругозором в первую очередь тесто люди которые смогут придумать как сделать нормально для этого нужно видеть какой то нормально в жизни иметь некоторый вкус к техническим решением поэтому мы беремся на людей у которых есть некоторый жизненный опыт они видели много более и примерно представляют как и в будущем ликвидировать и на старте для 100 очень важно поэтому если кидаем сюда больше половины команды считаем что это будет главное больное место в команду продукта мы в этом людей по другому принципу людей которым которым интересно делать какие-то прикладные задачи потому что как раз от команда справа на самом деле на самом деле делать чек полезная команда слева это просто инвестиции в инфраструктуру который для бизнеса можно считать что они не купятся смысле они бизнесу не нужны это некоторые налог на инфраструктуру и мы его как бы говорим что мы платим мы без ним бизнесу что нам необходимо открыть отдельный стрим работ он будет заниматься чисто развитием инфраструктуры и по сути мы убеждаем бизнес том что он не хочет туда смотреть эту команду этой командой будет заниматься только технический руководитель платформой там архитектор тех лиды и другой технический менеджмент важный важная вещь нужно построить некоторых бетонную стену между командой продукцию и инфраструктуры на момент когда происходило у нас было довольно мало людей нас не хватало у нас артур совы покрывать все задачи поэтому фокусированию задачу продукта было таким довольно смелым и отважным и мы делаем только супер важны и критичные вещи которые нельзя ли сделать мы не пытаемся делать ничего большого и сложного мы пытаемся видео сорвать какой queen и и и как-то начать чинить локальный болью бизнесом чтобы они начали нас любить итак принцип второй которым видел этот фактор где то мы явно разделяем инфраструктурным вести центр продукту разместиться накатили поехали начну делать платформу команда продукция команда вас тут делает делает всякая команда продукта че не всякая и мы начинаем мы начинаем осознавать чего же нам стоило все не бросится приписывать все сразу а стоило того что наши процессы поставки данных те самые стрелочки слайды с картинкой они поддаются они могут падать по миллиону разных причин и они пойдут по всем этим причинам бизнес недоволен для него есть перед последствии которые критичные есть последствии которые ну просто не приятны в общем люди немного недовольны и есть некоторые процессы которые подают регулярно чаще почему вот можно выделить на три причины в целом они будут в каждом в каждой индустрии немножко разные у нас они вот такие как на слайде и возникает соблазн давайте все-таки возьмем все и перепишем но нельзя просто к тебе писать сотни тысяч года это и вас слишком много чтобы можно было сделать разумное время нам тот момент 25-30 человека лет разработки туда в копан а все это переписать это просто оставить командую продукция на на год может быть на на 2 нет так не получится многих не переписывать это больно команда продукта в ярости они недовольны тут его бизнес и наверно люблю либо бизнес не довольно либо комада продуктом довольно что мы делаем мы все-таки можем сказать что проблемы с этим кодом они объективно бизнесу мешают жить они стоят денег и можно их стоимость каким-то образом оценить давайте мы попробуем это сделать как это сделать во первых мы начинаем считать стоимость инцидентов вообще прям обычно обычно процесс тикетов о суете снова просто формировать именно во имя на учет инцидентов и будем пытаться считать это метрики частотности инцидентов времени которые мы тратим причем это не обязательно делать совсем прям строгое формально должна просто просто иметь место где то можно посчитать то есть если честно то мы не построили супер-огромный даже борт который все это офигенно классно учитывал мы просто начали учитывать все важные падение и все что реально вас болела мы начали видеть и чтобы делать дальше мы выделяем некоторые вот им в продуктовых командах на то чтобы заниматься ликвидацией всего этого добра мы договоримся с бизнесом на то что мы какой-то процент усилий команды уделяем ликвидации этих долго по факту суть или факторингу и вот начинаем с наиболее больные места выпиливать кроме того мы вводим процесс дежурство это выделено человек который занимается только тем что пытается стабилизировать систему и мы говорим что он не делает никаких сдачи тот момент времени то есть осуждаем вот всех бизнес-задач и он просто занимается ремонтом текущей фич сам чинит мелкие баги большие магия делегируют в команды продуктовые ну за одну ночь у нас начал заниматься релизами потому что все падения они почему случаются пастырю релизов у не всем но многие которые делаем мы которые делаем мы они после релиза который делам ним и они там все время случаются он просто поэтому все время птицы этот человек в чем-то проклят поэтому телефон примерно там день или неделю в зависимости от ситуации после этого мы даем какие-то плюшки типа отгулов чтобы он мог немного отдохнуть от такой тяжелой жизни итак здесь есть несколько трюков которые использовали того чтобы фактами как-то пропушить во-первых я выделяю снова квоту на риф аким постоянно а вторых я ввожу отдельный ритуал дежурство некоторые окружение человека в от ходе которого проходит закалку и сам становится лучше знать систему может и при этом люди не выгорают до конца и при этом это еще бы снять бизнесу что почему просто так них разработчик ничем делает как сочетаемости мнению стоимость инцидентов слайд более подробный во первых нам нужно научиться ну трекать каждый каждый запуск каждой стрелочки нужно 1 все стрелочки как-то друг друга назвать уникального вторых каждый запуск начать тратить для этого не обязательно писать кучу сложную структуру достаточно просто на уровне логов в том что то научиться выковыривать каким-то эвристик вот ее то это можно сделать довольно дешево после этого мы сделаем то дежурного некоторые инструменты которым он вы видеть текущую ситуацию что вообще происходит системе и сможет и пользоваться и и нанес navi чинить всякое и 2 1 проник про проект про кинем айдишники и или хотя бы название падающих процессов этого что потом их можно было искать в идеале мы сделку этот счет но если честно клевая чет не сделали но при этом вы получили возможность найти историю всех падений что само по себе важно дальше для объяснения бизнесу нам нужно учиться считать стоимость всего этого добра честно стоимость рублях мы считать можно но это требует некоторых упражнений которые будут большой степени формальными поэтому просто договариваемся что во-первых это отнимает разработчиков время и бизнес то покупает во вторых есть некоторые целей которые мы хотим выдерживать и частые падения чего-то нам поэтому сила убьют и бизнес тоже покупает потому что бизнес уважает а солей вот таким образом мы объясняем объясняем бизнесу что делать ее потопу того что парит над участком это лечим возникает источник принцип что нужно лечить там где болит то есть ненужный факт все подряд тоже не хватает только то что реально падает и реально больно чтобы лечить там где болит нужно знать где болит нам очень нужны приборы даже если мы супер техническое подразделение которое делает какую-то странную штуку нам нужно знать где у нас болит и так как то процесс рефакторинга стерилизации пошел команда платформа перед всякая и в конце концов через какое-то время через полгодика чуть больше ребята приносят нам какой-то законченную версию закончена это работающую версию новой платформы мы поделить с архитектурой мы поделись со стеком придумали какие базы нам нужны какие познание не нужны мы поняли какие стрелочки бывают эти стрелочки что c кошерными какие не очень мы поняли как вообще по видно данные раскладывать мы поняли как всяким доступ и контроль и модульности так далее организовывать и 5 мы закончили культа фреймворк который теперь умеет делать вещи типовым образом мы упрощает работу и выглядит одинаково везде и это прямо успех все хорошо но на самом деле нет возникает некоторый конфуз что у нас уже есть другие какие-то базы данных которые нам что-то делать у нас есть потоки данных которые не вписываются в общую картину дело с ними что-то нужно у нас теперь появилась кучу работы по моделированию данных мы хотим что там теперь наводить везде порядок у нас письмо logo старого кода короче стала сильно больше проблем которые надо подумать и вот здесь вот прекрасно что надо было сначала сделать это план перехода целевой архитектор текущей ситуации коваль территория поэтому у нас какой-то план и план был следующим во-первых нам труды были что скорее всего мы не сможем сразу перенести фиксируете институ я слишком большой объем работы поэтому мы свойственной жесткая фокусируем команду прекратить платить что-то в нецелевом картине оплатить только в целевой другой стороны для тебя не удастся поэтому мы вносим некоторые регламент как когда когда нужно прямо переписывать всякое когда не нужно и чтобы переписывание было не супер тяжелом не полностью и не под ноль мы вводим некоторые режимы совместимости мы пишем в приманках разные wrapper и мы пишем какие-то косметики с вещами которые может подать могут мы можем можно использовать и начинаем 50-ые проверки которые пытаются выявить нецелевое использование фреймворков получается некоторые переходный режим презрение так можно делать не везде например есть вещи которые просто нас не получил из него по частям это был бы слишком дорого например тепло и тепло и нам пришлось мутировать сразу и это наверное хорошо все таки есть кит инвестиции которые при попытке рефакторинга нужно выплачивать сразу большим куском опасных местах мы выходим большую длинное приключение и чуден принцип это нам нужно жить в эпоху перемен долго смирились с этим сделали начали раскатываете факторинг новую платформу но что-то вот она как-то не работает команда уже команды которые продуктовые уже привыкли конечно локальным сдачу когда можно быстро получить результат мы полагаем вам делать большие довольно переписывания команды привыкли жить в каком то есть у каждого привел свой маленький уютный мирок они в целом как с этим начали смеяться то он как они адаптируешься даже у apple локально когда переход предлагаем 7 трясти бы большую финансовую систему они немного недовольно кроме того концепция новой она довольно молодая и в ней конечно же есть огромная куча багов не тот непродуманно к недоработок и неудачных решений и мы сейчас на все наступает наступаем плюс акации что никто новая концепция строгая она предполагает целевое использование нашей системы что вот типа 10 вещи для которых на подходит если кто-то не подходит раньше нас был подход что надо сделать мы сделаем поэтому некоторые вещи просто в новую картину не влезают их приходится выносить выкидывать или вносили заборчиком отмечаю здесь мины не ходи сюда возникает сопротивление со стороны как разработчиков которых которым подрывают их канон и все святое уничтожают что не была классная так со стороны бизнеса потому что просто внезапно начнет задачи делаться медленнее потому что разработчики культурной занимаются зачем это все вот и так сделать сходу сплошные волнуйся факт нас не получается что будем делать мы будем по принципу разделяй и властвуй есть нашего слона по частям мы разобьем на что тот лайк на модули по принципу похожему на разбиении монолита на микро сервисы и начнем по сути проекты по откусывании кусочков нашего монолита будем постепенно их оформлять в отдельные сервисы на которые будем на каждый сервис подберет некоторые стандарт и общие правила их стандартов не ухудшать качество этого сервиса и дальше мы наш большой фронт работ дробим на кучу проектов маленьких локальных который можно назвать так что выделив это модуль и зари фактор его чтобы он был был нормальным и у команды платформе появляется некоторыми хорезм плейграунда для своих новых внедрений когда идет какой-то чудной новый большой мажорный этом проект с новыми барные улучшениями они берут какой-то сервис сами в нем наводят новый порядок реализует всякое проверяю что штука работает сами погребают первую порцию багов расстраиваются чинит их выкатывают наконец и потом уже на команду продукта второй пилот в пепел делать из команд продукта а дальше просто говорю что все стали медленно и ничего не успевают им позор они такие ну ладно черт начнут делать итак здесь есть как 33 ук мы выделяем отдельный проект при фактор локальный небольшой и мы никогда не пытаемся сделать все сразу мы мы и едим все по частям это классно почему-то получилось потому что у нас польши никто изменения за это время во первых команды инфраструктуры уже закончила большую концертную часть работы и перешла к точечным улучшением это привело специализация не понимаю что делают а с другой стороны команда продуктом и все в это время активно нанимали она сильно выросла мы перестали совсем уж прям безнадежно нуждаться в ресурсах и это я бы хорошие новости пока новость то что мы все в это время делать какие-то клюквенные они кончаются и в целом команды продукты понимать что дальше носить пользу маленько вокальным лучшими уже не получается и надо делать что-то большое к счастью маленький круг вины позволили нам наладить контакт бизнес заказчиками нас уже в целом люди поверили что так что эта функция может работать и можно сделать менять целеполагание команд выводить платформы 5 лет новый focus мы хотим как можно быстрее релизе нос к товарищу в продукции и наша главная цель это команда продукта ускорять новой платформы концепция готово теперь давайте ее внедрять и и убедишь да то беда в том что оно работает для команд продукта меняем новый focus мы теперь будем делать все проектами и пиками как вот есть кроме есть эпики наверное в курсе надеюсь в общем проектами все приходим на проект проектную работу и когда у нас есть большой проект не может помешать немного рефакторинга чтобы бизнес это не вызвало ярость чуть чуть не в три раза увеличить в полтора скоб работы вот и планирование эпиков у каждого пика это конечный бизнес смысл бизнес польза и можно вовлечь вовлечь много заказчиков в конкуренцию за планирование и они преследуют нас за то что медленно работаем начинает хотеть друг другом потом потому что они воюют за место в рот mapi вот десять никто трюк с подвешиванием и факторинговых проект вот его ним примем его ok работа началась и мы теперь начинаем делать код как спокойно начнет начинает улучшаться мы построили затолкают рутину и в общем целом все идет тут тоже возникают некоторые проблемы уже совсем системно которого характера рефакторинг как процесс становится рутиной мы пашем и прошли период приключения и это просто то ли однотипные задачи которые которые мы понимаем что делать мы подходим к той каждой новой задачи и она в целом примерно понятно и люди ощущают некую скуку и они гретне начинается некоторые брожение в стиле что у нас в продукте какие-то все даче простые мы хотим заниматься чем-то более интересным и веселым и даже самый такой плохой симптомами понимается некоторые намеки на кастовой что вот там-то нормальные люди работает это чуваки которые просто клепать или одинаковых процессов как это грустно вот это очень плохой симптом надо было не доводить виде надо чинить и кроме того мы сделали уже довольно много кода начинам года осталось то есть там как бы уже какие-то тысячи разных тех стрелочек и нам нужно уже начинать их учитывать помнить что мы 3 факт лишь эти факторы или вот и это становится дорог и тяжело что мы делаем для того чтобы починить вот первый первую проблему мы сдвигаем фокус команд потихонечку перри балансируя x за задачи мы пытаемся увеличить разнообразие задач мы не позволяем разработчикам на только и стоять в ком-то одном рефакторинга чтобы они не выгорали чтобы не становилось скучно если правильно заводчика предстоит большой проект мы стараемся от любых это больше людей чтобы не сделали быстрее либо примерять эти задачи с чем-то другим более разнообразным чтобы не видел как некоторые унылый конвейер мы начинаем площать запросы бизнеса на разные сложные хотелось есть и раньше мы говорили мы идем такое квн и честно грим на оборот что типа вообще говоря мы потом что мы даже отдаем нашим потребителям некоторые типовые задачи потому что из качество платформы мы уже можем это делать мы начинаем отдавать смежным подразделениями и типовые вещи а сами хотим заниматься только тем что другие поведением делать совсем сложно меняем наш портфель проектов по сути мы меняем и поскольку задача в целом тори проще мы можем не мать мы можете развивать больше джунов и рефакторинг на самом деле как такой вот совсем типовой уже его можно отдать его можно упаковать большой проект и отдайте кому-то как материал для стажировки понимаем стажера и он проходит некоторую закалку в бою или factory что-то на что всем там разработчикам опытным заниматься чем чем не интересно мы можем таким информировать широкий фронт на из кучу стажеров и на весь код перепишут мы планируем сделать летом 1020 но лето выдалось не очень и мы хотим правильно добить большой факторинг вот этим летом в целом мы научились жить с тем что у нас осталось куча не до песчаного нет дефолтного года он уже перестала носить на проблемы мы его видим и мы научились его мерить мы научились взять какую-то модуль и понятия сколько там научились делаем соус научились научись не понимаете насколько это нам тут она marine определенной моды мешает много там осталось работы или нет насколько он вообще говоря нужен и что важно мы также 3 крем использование масть всех наших данных наших объектов итоге то и так далее чтобы понимать что вообще важно на что можно забить вас есть некоторые стрелочки некоторые данные которые пользуются какой-то там один экспертный процесс который никто уже не трогал три года и возможно он не нужен вообще никому мы вам возможно выключим однажды но просто час можно его не тратить время это прекрасно и он нам не мешает он прислал нам мешали потому что мы больше не подтекает вот и вот здесь есть еще один трюк который при факторинге мы используем это широкий фронт маленьких раза мальчиков можем себе позволить взять много людей пройтись вдоль по типовым вещам и важный принцип принципиально важные который нам очень много поможет это нам нужно избегать отопление людей в рутине везде не только ли факт региона особенной файтинги и на самом деле здесь уже можно подарить какие то итоги а итоге они непомерные следующее вот эти принципы песчаные слева это то чему мы научились в процессе этого огромного 2 годового приключения и трюки конкретные которые мы применили применяем для того чтобы впихивать рефакторинг в большой рефакторинг в наш в наши рабочие backlog ради этого слайда все это и писал можно считать что он последний спасибо большое что послушали"
}