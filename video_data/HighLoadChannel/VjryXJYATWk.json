{
  "video_id": "VjryXJYATWk",
  "channel": "HighLoadChannel",
  "title": "Json or not Json. Плюсы и минусы использования Json в PostgreSQL / Олег Бартунов, Никита Глухов",
  "views": 14013,
  "duration": 3856,
  "published": "2022-03-21T13:55:21-07:00",
  "text": "здравствуйте мне очень приятно каешься оказаться опять санкт-петербурге прошлый раз я выступал живьём два года назад рассказывала про пузырь из 12 но сейчас скоро выйдет пузырь из 14 а я вам буду рассказывать про джейсон бы знать что с питером очень много связано слонов то сейчас у вас есть певец слонов николай копейкин вот собственно то его картина медный слон оказывается в питере чуть ли не самого возникновения слоны жили то есть был слоновьи загон было слоновая улица слоновая площадь и вообще николай копейкин он создал целую галерею слонов писан петербурге где отразил особенности социума питерского но вот я долго думал что взять но решил взять вот эту картинку то что на самом деле картинка вот более скучная классическая это слон у которого холл хобот закручен как логотип джейсона словно это логотип джейсона а доклад меня будет происходить таким образом что я буду говорить про джейсон а вот и стоит ли его использовать и стоит но для того чтобы это понять нужно им немного получить технических знаний и я как раз как разработчик пузырится хочу своими словами как-то донести до вас не много технических деталей прапор джейсон чтобы это знание вам помогло в конце концов но в каких ситуациях сделать выбор самим я кое-что же вам скажу что на делать но знание они никогда никому не помешали а вот здесь ссылка есть на доклад то есть у кого немало времени может прям скачать это доклад и пойти на следующие то другое место этот доклад мы с никитой делали практически на протяжении всего года разных вариациях модификациях и в этот раз тоже есть кое-что новое по сравнению с хайло дам сначала я представлюсь конечно забыл сказать что я мажорный контрибьютором в подвес я работаю научным сотрудником москву в университете то есть я профессиональный астроном по специальности я также работаю в компании ползает профессиональный вот слон отображает проекты в которые я делал участвовал помогала и так далее никита тоже сеньора разработчик мог мой коллега это же является официальным контрибьютором в пол риса это вот его таки уже серьезные проекты большие вот а саму связанные вот с нашими телами про джейсон а почему я вот решил этот сделать доклад потому что во первых больше чем 20 лет я занимаюсь тем что расширяю возможность реляционной базы данных но в частности патриса то есть если посмотреть на то что я делал этот массивы ведь штор который еще 2 2003 году мы сделали полнотекстовый поиск не точный поиск всякие индексы вот des jeunes pages- это мы делали пространственные данные которые очень ну для меня было я использовал их астрономических проектах и вот сейчас уже в 2014 года я занимаюсь джейсон бей его продвижением и в частности наша работа привела к тому что появился стандарты сковали джейсон и сейчас мы в подписи вот как бы уже реализовали и заколите ли какие-то части от этого стандарта джейсон период и экономически говорят что это бинарный дэвисон но люди привыкли говорить что это лучше джейсон но только лучше вот и для нас вода производительность джейсона более важное чем его функционально чем его совместимость я потом покажу почему и так получилось что джейсон стал одним из драйвера в развитии погреться потому что именно джейсон беру то что мы сделали да он привел к росту популярности пузырится потому что совпали две волны то есть micro серость архитектура который сейчас является хайпом допускать она привела к тому что людям захотелось иметь джейсон поддержку и причем не просто там кого ну текстовый джейсона так что можешь больше ты с ним еще сделать и в подписи jason jason de как раз в это время появился и я вспоминаю я вижу как сколько людей приходят на конференции задают вопросы и почти все они связанные так или иначе с вот этой долларах текстурой также это конечно облака конечно же стартап и потому что стартап вы сами понимаете да то есть несколько человек собрались им нужно срочно склепать какое-то приложение теперь очень крутого зато архитектора или там дыбой а у них нет иногда быстро что-то сделать вот джейсон как раз очень быстро подходит для этого ну плюс понятно вот такие темы как джоэл девелопмента то есть когда нужно быстро делать лизы весов здесь очень даже хорош ну конечно же деле сон это такой формат когда универсальный формат для того чтобы передавать несколько сообщения предпринимать результаты выполняет сообщений он очень хорош например для миграции данных предположим у вас есть старое приложение которое должно например есть новые данные если у вас стандартно реляционная архитектура это делать очень тяжело и больно вам нужно переделать довольно много всего вот если вы писали использовать джейсон вы новые данные очень хорошо и бесплатно безболезненность уж эти вот очень хорошо очень просто пример делать как я сказал это дизайн вашу базу данных очень простые получаются запрос и потому что микро сервиса если кто не знает это тогда когда вы знаете да какой вопрос вы будете отвечать своим сервисом то есть это 1 опрос раз вы знаете что от вас требуется что вы можете сделать вы можете приобрели ровать результаты собственных джейсона является некоторым агрегатом и вот этот жизнь чик лежит сервис просто берет его maxion что не так фильтрует и выдаст наружу свое приложение это очень простая операция если у вас реляционная база реляционная структура то вам придется сделать кучу join of потому что объект на собрать из разных таблиц вот по можно сделать там агрегат потом это на послать клиенту а у клиента клиента сейчас все пишутся в основном на ну питон либо java script там многих джиос так далее для них скажем более естественно принять джейсон то есть одна и та же структура и в базе и в коде это очень удобно нежели вы парсить и от ветра и лицо на базы данных то есть сам опрос разработка и архив тур становится как бы проще часто джейсон используется в базах данных для того чтобы хранить а метаданные вот мы когда придумали и штор мы как раз пришли отсюда то есть мы делали проект для где агрегированные данные права субъектов министерство образования то есть школы и университеты колледже than к технику мой так далее их там было штук 10 если ты вы эти метаданные пытаетесь в одну таблицу свести вас получается широкая простыня в основном пустая потому что они специфика очень специфических полей вот при этом есть там петух шин петух полей которые совпадают там ну грубо рио иди адрес там город там директор или кто там я директор уже раза пожелать директор бывает ректора бывают дико ну бывает ведь они по-разному вот но целом работать с такой базой какой таблица неудобно даже в плюс q или нельзя посмотреть и собственно мы и штор придумали именно для этого все вот эти несущественные поля просто-напросто записали в некий hash это было отдельно колоночка оказалась вполне удобно когда вы в поиске она не участвует но при показе вы можете взять вот эту всю информацию и показать уже потом добавили в 4 вели средства фильтрации индексирования и так далее вот собственно потом уже все это мы на основе и створа сделали для джейсона что очень важно конечно что что джейсон изгладил противоречия между разработчиком приложения и владельцами данных и башни коми потому что как раньше бывало что я помню на слоем славику мы делали мы приложение то есть в приложении описывали данные как они хранятся это была так называемая коды центре то есть все вы лежал он сравни приложение нас на стороне кода это привело к тому что например я видел комнаты и завалены и магнитофон ими лентами который никто не знаете что на них записано но грубо ряд разработчик уволился умер там не знаю так далее код потерялся и никто ничего не знает сейчас последние годы все сместилась то что когда появились реляционной базы данных появилась такая уже дата-центре то есть данная сейчас является основным а сетом организацией поэтому реляционная теория она как бы очень хорошо помогала здесь потому что если разработчик уволился у вас есть база данных вас есть схема все понятно вот и вот это противоречие между замок дают кодировки но программист разработчики и до башни кимани это было два разных мира привела ли приводила к тому что появились вот эти формы которые как бы позволяет разработчику как бы работать с данными на своем языке но при этом все равно этому арму нужно было отдать схему и языки программирования сиз quelle там скажем java script или питона было некое противоречие вот джейсон он как раз стал близок и тем и тем потому что с одной стороны он довольно хорошо описывает данные у легко читать да там над ней к самой тоже это делать но к самаре то уж слишком от jason он нативные и для разработчика приложений из другой страны он попс появлением с кори стандарта он стал уже нативным как бы и для баз данных то есть я считаю что если мы будем двигаться по этому пути то скоро все будет хорошо счастье вот есть такое слово решусь в джейсон бер почему я хочу рассказать потому что очень много людей даже не думая просто берут и используют жизнь руби под приходят и говорят я использую джейсон бен меня все хорошо все потом через некоторые пишут что что-то у него стало плохо где-то начинает тормозить и так далее да поэтому я как раз я решил рассказать что на самом деле несмотря то что я один из создателей джейсон by как бы и продвигаю его везде но джейсон бер нынешнем состоянии скажем надо использовать ну как бы понимая понимая его ограничение другой стороны она понимать это что же нас ждет в ближайшем будущем потому что мы не стоим на месте а постоянно его улучшая вот поэтому доклад посвящен вот посмотрите вот как бы иллюстрации того что именно сейчас jason de является могил из двигателей популярности пузырь из а вот на графике изображены на относительно рост популярности для четырех баз данных для пузыри самая скуэр оракла и mssql мы видим что все базы кроме пузырь со находится примерно на одном и том же месте их популярность a puzzle с вот синенькая она растет и русские начался вот тогда когда мы сказали что у нас подвезти есть бинарное джейсон вот есть полноценный джейсон тот с тех пор это продолжается потому что мы после су мы реляционным базам данных как бы как кто-то выразился второе дыхание далее потому что все привыкли что но вскоре это круто реляционной базы это старый хлам так вот сумой по когда появился джейсон q2 си люди поняли что все все все нормально можно пользоваться и джейсоном в пол виси и пользу своего фичами и нормальным гибким дизайном реляционных реляционных схем вот и много на из куриных юзер пользователь просто перешло к нам после того как они поняли проблемы на ус quelle вот а вот это успех джейсон beyonce привел к тому что из кур он теперь джейсон появился в стандарте иску или 2016 то есть это уже не просто как мы там из-под полы пользовались это теперь легальные легальная вещь как джейсон еще не тип данных его ожидается в принятии уже стандарта на типы данных но как модель данных она вполне уже стандартное можно пользоваться вот был такой обзор двадцать первом году топ-3 фичи которые используются в потряси мы видим что первая фича это вот эти 72 процента это jason jason de на втором месте это триггер и на третьем месте не быть решены индексы это вот такие очень интересы результат но мне приятно потому что первым и третьим как раз я и занимался у нас есть очень хороший подвижный чат вот здесь ссылка на в телеграме кто не знает вы приходите туда потому что это действительно там больше 6-ти тысяч человек и каждый каждый раз посмотреть в онлайне то мог больше двух тысяч просто в онлайне любые вопросы для начинающих там да народ довольно дружный все объяснит так вот там как развитие жизнь джейсон он на 3 месте популярности хорошо это или плохо может он плохо написана рот много задают вопросов но тем не менее это говорит о том что это все таки популярная вещь вот один из примеров когда люди торопятся как раз популярная ошибка люди создают табличку табличку в которой просто один джейсон скажем вот посмотрите например когда мы айди а идея и диета ну прайма реки говоря то вещь это важная то есть слева написано что идея красненькая это когда она вы внесенной джисона а справа желтенький айди это айди внутри джейсона посмотрите какая разница вот слева мы видим значит время время доступа к иди еще к одному полю вот синенькая но на смотреть на красненькая и желтенькая мы видим что если аиде находится вне джейсона то у нас такой равномерные нормальные нормальное время независимо от размера джейсона но как только вы айзе прячьте внутри джейсона посмотрите какой рост придет то есть просто на таком обычном примере обычно простом запросе вы проигрываете в разы в порядке все это происходит потому что люди просто берут верят в силу джейсона и от ска говорится все туда засовывает но хотя потрудитесь аиде вытащите джейсона потому что пойди вы делаете довольно много операций полезных вот справа картинка показывает количество блоков которые прочитать опять же мы видим по красный цвет он показывает что количество блоков постоянно грубая 0 фактически вот а для желтой для желтой количество блоков растет он куда-то вверх это такое пример которые очень иллюстрировать вот над чем мы работали мы работали весь этот год в последние годы вот на этим большими проектами и довольно много вот но в конце концов мы решили что а самое основное это сделать джейсон и как бы гражданином первого сорта но как бы нормальным и легальным гражданином пол риса вот то есть что был эффективное хранение были был хороший api были быстрой апдейта select и так далее вот и мы отказались от того чтобы слишком много сил тратить на совместимость потому что что-то совместимость совместимость означает что вы должны сделать реализацию стандарта чтобы приложение ваши работали на ура клеммы соску или на подвесе все был одинаковый код как бы и это было первый год это была сильнейшей мотивацией для нас но после того как мы закончили джейсон пас это язык работая с джейсоном самая правильная самая нужная часть стандарта мы поняли что дальше нам особо торопиться некуда потому что на самом деле стартапы например который использует пользовались их вообще не волнует ни урока ладим с sql вот мужестве представите стартап которые которым нужен оракал он взял пузыри с джейсоном ремонт часть ли вы доволен поэтому нам зачем нуждаются совместимость нам лучше чтобы джейсон потратить свои ресурсы до которых не так на самом деле много на то чтобы джейсон бы стал нормальным типом данных быстрым удобным экономичным вот то что в сообществе нет ресурсов я могу продемонстрировать вот лежит патч искали джейсон четыре года он лежит мы сделали 59 версий 59 версий он до сих пор не за комичен джейсон teil 4 года пятьдесят две версии это говорит о том что на самом деле люди не очень хотят хотя вот сейчас появились сигналы что в 15 релиз все-таки хотят закомитить ну пожалуйста да а мы больше сконцентрировались на том чтобы сделать джейсон более удобным хорошим и чтобы с ним можно было делать ульте писал об вот чтобы он был там расширяем и так далее а причем продолжать дальше я хочу вам рассказать про проклятие толстых все знаешь какой тост если вы хотите хранить что то больше чем 2 килобайта вот вам нужно знать человеку тост потому что пудре саката устроено и к сожалению текущая реализация этого толсто текущая архитектура потряси она может приносить такие как бы сюрпризы неприятный вот пример когда вы встречаетесь непредсказуемой производительностью то есть имеется лаз табличка простая джейсона вот так гинер и naked 10000 строчек и скажем делаете маленькие вот видео первый запрос вы вытаскиваете аиде здесь еще осаде и время 6 половина секунд миллисекунды делайте маленький апдейте маленький апдейте у вас получается 6 6 милисекунд то есть это что это означает означать что вы там в продакшене вдруг начинаете получать проблемы ни с того ни сего вот это надо знать это связано с тем что после того как вы сделали этот маленький ободрить их строка перестала помещаться в ту пле of happy и стала она ищет туситься вот что это такое сейчас я вам попытаюсь объяснить лишь то есть посмотрите если использовать такое расширение позже inspect the мы можем видим что джейсон б он оригинальный джейсон беда апдейта он помещался в хеппи ужас грубая в табличке дисплей тысяч страниц с четырьмя куклами на каждой страничке вот такой запросам раз показывает хорошо иллюстрирует а после апдейта джейсон бы стал чуть чуть больше чем 2 килобайта чуть чуть больше и что это привело к тому что джейсон б заменился на нефть некоторые pointer так называемый тасс pointer до который показывает на специальную скрытую от вас табличку куда на самом деле эти данные перемещаются вот и мы видим что посмотрите на одной страничке теперь помещается 157 couple of потому что самих данных нет уже в табличке под здесь вас обманывай данные уже лежат видов другим другом месте и вот чтобы вытащить эти данные вам приходит придется грубого ряд сделать внутренней джоин вы его не видите но он есть и это вот как раз является одним из проклятий этого толсто вот вот видите джейсон бер данные переместились в толст табличку вот и каждый джейсон бер разбился на два чанка то есть ну кур буря в этом реляции в толще реляции находятся чанки из которых еще надо умудриться вытащите так вот доступ если вы хотите взять джейсон by которую затащим то есть уже переместился туда дополнительно вам нужно прочитать три дополнительных буфера три дополнительных страниц и 2 и 2 из них это прочитать из индекса которые тоже строится автоматически вы его не видите в данном случае b3 имеет высоту 2 двойку и один тост и буфер то есть один буфер в котором содержится собственно сам джейсон b и вот мы получаем вот этот explain a voice он показывает 30000 64 страничке надо прочитать вот это вот как раз математика четко подсказывает все четыре буфера плюс 3 буфера умножь на 10 тыс то есть реально 64 полезных и 30000 этого то что вот оттуда если объяснять штукой тост то грубо ariana ищет посмотрите вот wear имеется у вас тупо у которого есть а иди и джейсон так вот этот большой джейсон если он не помещается в 2 килобайта вот большой скажем бывает там мегабайта я видел джейсон и по сотни мегабайт его сначала сжимают вот а потом нарезает тачанки куски и которые идут вот в этот самый в тос так называемый а длинные место место этого длинного джейсона остается вот этот самый тасс pointer ответит ос пойнтер который вот ссылочку на вот эти танки и чтобы достучаться до этих чанков которых лежат данные вам нужно сначала вот вам уже сначала вот пройти по спуститься по этому дереву это тот индекс бы три индекс который строит стан независимо от вас этот machinery открыто но оно есть и при этом overheat можем для того чтобы только прочитать несколько байт из вот этого этих данных вам нужно 3-4 иногда 5 дополнительных блоков из бус из индекса прочитать это такое серьезе приличный overheat вот на самом деле the song конечно очень сложная штука потому что существует несколько разных алгоритмов для толстая то есть есть толст вы можете сказать что вот этот эту колоночку вообще не толстеть вот скажем например по умолчанию например интерьера я не на то что маленькая штучка вот а джейсон б у него он может быть extended или external они отличаются друг от друга тем что один из их extended это же сжимается а external не сжимается но оба они по умолчанию уходят отдельно от таблицы вот в этот тост как только они превышают 2 килобайта вот чтобы чем ситуация происходит довольно сложно каждый раз вам нужно решить какую колоночку что с ней сделать то есть при имеется четыре прохода первый проход вот посмотрите x это как раз extended я это их стёр дал мы это main.pp to play on мы их имени нам не интересны нам интересно вот этот extended вот upper джейсон он после того как он сжался у него размер стал меньше двух килобайт поэтому его оставили в relation happy вот а вот external давите он больше чем 22 килобайта и он не сжимается поэтому его двигают вот сюда в тост ведь я вместо него остается тупу pointer ну грубо ряд ссылка вот на этот на этот чанг вот ситуация дальше идет повторяет повторяется и мы смотрим после всех этих сжатий и вытаскивание данных наружу вне в бок строка больше чем два кило воители нет если на больше чем два кило боюсь идем на второй проход вот и мы смотрим дальше опять заменяем на щит и замене вытаскиваем наружу заменяем над упал pointer и так мы делаем три четыре раза то есть вот эта процедура вот вся она от вас скрыто но она делается это такая сложная штука теперь вы поняли что тост что работать джейсоном который длинны небезопасно но опять же для каких операций следующий пример я хочу вам рассказать вот зачем мы вообще начали оптимизировать потому оптимизировать джейсон нужна какая-то мотивация что мы можем получить если мы будем скажем улучшать джейсон или там что-то делать джейсон be at смотрите табличка в ней сто джейсон of разных размеров от коротеньких до больших и сжимается они соответственно надо сдать 3030 и байт ну грубо и до двухсот сорока семи килобайт вот такой простой джейсон в нем есть ключ кей 1 потом длинные ключ кей 2 коротенький клей 3 и длинные крючки и 4 ну так они расположены им имели доступ время выполнения оператора стрелочки ну грубо ли достать ключ для каждой строки и повторяем тысячу раз запросе и для того чтобы исключить какие то ну на проезд статистику вот такой запрос что мы видим вот мы видим вот такую картинку видите там где все помещается для для коротких джейсон of online где все все лежит в табличке все нормально все ключи берутся с одной скоростью нормально вот когда мы начинаем выходить в зону например компрессы онлайн то есть когда джейсон становится таких размеров который после сжатия всё равно лежит в онлайне мы видим что время доступа увеличивается но когда это совсем уже уходит тост то есть после сжатия размер размер записи все больше двух килобайт то продолжается рост и самое противное самой противно то что это не зависит от размера ключа то есть маленький выключу берете большой ключ вы берете скорость доступа падает с ростом размера джейсона интуитивно хотелось бы так что у вас болит большой джейсон но маленький то ключ и вот шли куда взять да но не получается вот так нехорошо и мы подумали что как-то это надо исправить подумали что может быть это искусство интерес вот продемонстрировать на чит такой же пример для реального тесто international movie database то есть база данных по фильмов вот мы отобрали из нее несколько ключей от айди это короткие частый очень большой это роли актера массив высота актера и от внутренние ай ди эм би биа тоже коротенькие и частой и провели тот же самый запрос то есть пытаемся достучаться до 2 раз для ключей вот видите вот высота ай ди эм би би один роль из порядок между прочим заметим он как бы вот именно в таком виде мы видим что опять же не зависимо от того какой ключ все пока все помещается в строке но в то в таблице все хорошо дальше идет вот такой рост причем мы видим что это ну два порядка может отличаться как-то это не очень хорошо вот поэтому мы поняли что проблем здесь много например с декомпрессии то есть как я говорил голос тех храниться все в компенсировано виде если у вас например 100 мегабайт джейсон для того чтобы вытащить хоть что-то оттуда вам нужно вот этот 100 мегабайт собрать из этих кусочков на которую нарезан вот вместе потом и его раз сжать а потом вытащить можете представить как оверхед собственно поэтому вот этот рост идет вот поэтому мы подумает о надо сделать частичную декомпрессию чтобы забирать где компрессировать не весь а по кусочкам ну то есть как только зашел да тогда до нужного ключа прекратить декомпрессию вот ну и второе конечно что мы видим гигантский overheat а толсто поэтому нужно сделать так чтобы это толстая overheat уменьшить то есть читать только необходимые блоки вот целый план каких мы улучшений в результате сделали то есть сначала мы вели мы реализовали префиксу декомпрессию вот смотрите прекрасно декомпрессия то есть мы сжимаем только только то что нужно пока не встретим ключ потом мы сделали сортировку ключей по их длине это очень важная штука потому что тогда у вас коротенькие метаданные они будут лежать вначале и из за того что они будут потом префикс разжиматься досуг ним резко улучшится а длинные ключи длинные ключи они будут лежать в конце но обычные от какие-то было бы там до них их с ними обычно вал они не работает их они нужны для там хранения чтобы показать потом вытащить и так далее вот следующее мы сделали декомпрессию chiang mai chiang то есть мы уже не стали собирать джейсон целиком а потом его сжимать а просто уже стали разжимать бочонком нужные куски нам ну и дальше вот онлайн толст и сделали реализовали последняя тот же тост то есть мы сделали так что мы теперь не сжимаем и нарезаем а сначала нарезаем а потом сжимаем что это почему и привил приводит привод тому что мы четко знаем что вот в этом чанки будет лежать тот самый ключ которого нужно мы уже не будем здесь у нас появляется некий доступ отдельные вот и на этом деле мы соответственно довольно много сэкономили то есть access у нас случился скорость доступа апдейт резко улучшился и вот сделали даже геймплей соблюдает когда вы длина длина не меняется тогда можно просто делать вообще in place вот у меня есть отдельный доклад с большими деталями погрузиться можно там если рассматривать поэтому здесь я просто показываю в результате что получилось вот для синтетического примера вот это мастер видите пока в тос влезала все было хорошо а дальше вот так пошло а дальше мы видим улучшение вот от этой маат этой линии вверх начинает отваливаться какие-то ключи видите вниз отвалился красненький красненькие так 1 маленький ключ от кей 1 отвалился потому что он стал уже префикса декомпрессия то есть мы где компрессируем и дальше прекращаем то есть видите по сравнению с этим он был вот здесь а вот тут он был вот здесь ну там порядок сразу выиграли теперь отсортировали ключи отвалился еще синий синий от зеленый остался в верху только жёлтое жёлтые то роли они лежат в конце и до них добираться долго вот те ключи которые короче они стали видите гораздо быстрее вот вообще ниже ну вот здесь видите частичный де тост in line tools еще и тост мы видим что ну как бы несколько порядков мы начали начали сэкономить вот видите красные и зеленые ключи вот они лежат внизу это короткие ключи они уже ну то есть если вот посмотреть вот здесь на 10 мегабайт ах так и работает да вот на 10 мегабайт ах вот здесь на 10 мегабайт ах вот здесь и сравнить с тем что было здесь на 10 мегабайт ах вот здесь вот так вот сюда идем но какие-то бешеные бешеные порядке то есть вот эти все оптимизации они нас сильно вдохновили то есть мы действительно можем оказывается сделать джейсон удобном и как бы отвечать нашим ожиданиям коротенькие метаданные вы достаете быстро ну длинные они как бы лежат там то же самое мы сделаем для а м д б мы тоже видим что здесь мы видим все ключи все цвета перемешанные а потихоньку приходим к тому что вот здесь остается только зеленые это роли длинные роли а все остальные спустились вниз вот это очень интересный результат ссылка на предыдущий доклад где setra джона есть и там внизу будет теперь посмотрите вот та самая ошибка которую про который говорил она теперь после тех а эти оптимизации выглядеть вот так видите желтой это вот айди которые внутри джейсона отвалился вниз и стал чуть-чуть конечно overheat есть но он уже стал по крайней не зависит от размера джейсона вот здесь он был такой а здесь такой вот но это не говорит о том что так уже можно делать нет айди все равно держите вне джейсона отдельная тема это апдейт джейсона как вы понимаете вот этот тост который был который в позорить реализовано он конечно ничего не знает о структуре джейсона дел то что когда puzzles начинался делаться вообще реляционной базы они работали только со товарными типами данных то есть либо все либо ничего внутри ничего не было то есть целая там строка что-то внутри базу данных него la la la это сейчас когда у нас появились появился джейсон у нас появились массивы и так далее нам стало интересно уже структура но вот тут механизм который реализован о ничего об этом не знает вот поэтому апдейт джейсона происходит очень тупо маленький бантик вы поменяли весь вот этот джейсон переписывается понимаете к чему это может приводить приводить это покажу то есть the storage тоже дублируется кроме толсто еще вал трафик все вот эти изменения они записывают еще и вал вот и получается то что получается человек начинает кричать а шум я в продакшене как все сто стала медленно поэтому когда вы тестируете тестируйте секис более-менее реальными данными они просто в песку или песку или все летает как правило вот краб продакшене тому же начинается проблемы вот описание проблемы возьмите 10 тысяч объектов каждый из объекта состоит из 1000 ключей ключи такие простые 1122 и так далее тривиальные вот есть он сгенерил взгляни релиз и мы имеем табличку 512 килобайт размера но при этом мы имеем еще тост августе лежит 7 из 8 мегабайт этот краз иллюстрация что видите в хеппи лежат с грубой одни это спойлер и а все основные данные лежат в какой-то другой таблички вот здесь показана и дальше мы делаем обдурить посмотрите если мы облетим айди то это занимает сорок две миллисекунды aydym нашим джейсоне он правильный он лежит вне джейсона то есть когда мы облетим то что не тащиться это легко сорок две миллисекунды проблем нет вот здесь вот с помощью вот этой функции мы берем сначала вала да там сказать и мы смотрим что всего трафика была под полтора мегабайта после этого апдейта ну то есть не о чем при этом мы смотрим что размер таблицы у ровно в два раза увеличился а это правильно потому что в подписи любой апдейт это делить insert да там удваиваешь потому что версии от ост не изменился ну потому что как теория говорит этот этот от ольги лежит вне он помечен как не толщины а теперь попробуем джейсон об запретить вот таким простым апдейтом маленький простой апдейт мы видим вдруг вал 130 мегабайт восемьдесят семь раз больше мы видим табличка изменилось чуть больше стало и мы увидели что тост увеличился в два раза то есть вот мы видим весь overheat вал и 87 раз изменил больше тост в два раза извинился и отсюда начинается вот эти тормоза потому что это тормоз он занял место 42 миллисекунд 12 секунд ну конечно же это нехорошо вот эта проблема с этим надо как-то бороться и мы придумали как раз такой механизм когда мы сначала видите вот та же самая картинка где атос объяснял но мы здесь сначала нарезаем а потом вот здесь уже начинаем компрессировать и это дает нам возможность например оператору стрелочки гораздо быстрее достукиваться до того чанка где он лежит этот ключ вот соответственно мы сделали здесь in place апдейт вот то есть мы не гирим новый вал и мы делаем купе только того чан как в котором был обречён и запущенный ключ а все остальные чанки от их много а их не надо заново копировать мы просто их оставляем дело неё ссылку и поэтому это называется шея тост то есть мы шарим мы шарим вот эти чанки между разными версиями и еще у нас есть соответственно in place апдейт то есть когда мы пытаемся еще если данные не не меняли длину пытались просто на месте вот причем в онлайне в хип не в тосте of happy записать информацию о то новом значения и мы увидели что вот к чему это привело вот этот мастер версия то есть как в нормальном пузыри se когда вы что делаете с апдейтом он все это производительность начинает падать резко вот после того как мы сделали шея тасс мы увидели что длинный остался верху остальные упали а после и shad им placa апдейта у нас все упало вниз более-менее таскать там осталось конечно жилось но уже скажем короткие метаданные мы можем отметить достаточно быстро обычно их и апдейтер вот видите это вот нас и такие интересные красивые картинки при этом вот это вау вау он копать практически не за не зависит от работ от того где находится элемент и только валяться только те и онлайн данные которые поменялись в результате им place апдейта вот это все как бы написано ну предыдущем докладе вот то что новая здесь это вот то что мы теперь решили посмотреть на проблему оля глобально вот мы нагини relic кучу тестов скажем сравнивали джейсон by подход и реляционный подход вот здесь например есть приведены примеры каррамна карта карта распределение такое времен доступа к целому документу представьте что у вас микро сервис которые которому нужен просто целиком документ и этот документ лежит либо в джейсон б либо собирается бл онлайне в из реляционной таблицы и вот мы видим здесь вот здесь по оси икс это размер массива документ просто обычный массив мы не мудрили вот ap а здесь размер ключа вот здесь вот 100 байт и наверху один килобайт и вот мы видим что то есть размер документа он по диагонали надо просто умножить количество роли ресайз умножить на размер ключа и тогда вы получите размер документа мы видим что когда вы работаете джейсоном вот эти синенькое вот производительность максимальная порчи неких проблем если вы работаете с традиционным видом мы видим что видите оверхеды то есть чем краснее тем хуже синие то лучше то есть для коротких документов уже есть про проблема в реляционной виде но чем больше чем дальше тему вы бы все больше и больше вверх от и начинает замедляться это хочу сказать сразу что когда мы делали тест с джейсона вообще никаких настроек не надо было он просто взял его и все а чтобы получить правильно правильно вытащить документ в реляционной виде нам пришлось поставить их кучу сетов столько-то памяти отменить их и jojen там какие-то настройки там еще одна строить алгоритмы то есть реляционной схема она же гибкая раз гибкая дальше там юнгом и очень долго да ну много надо работы с ней то есть куча вариантов можно сделать через под запросы может так вот нашли лут самые оптимальные зафиксировали и все равно то что вы делаете традиционному проигрывает джейсону это вот самые идеальные идеально используют джейсона микро сервис микро сервис который знает что ему надо раз вы знаете подготовить документ для него и пуля эти вообще проблема это когда мы достаем достать джейсона а теперь вот мы передаем джейсон видите то есть передаем джейсон как текст к примеру мы видим сразу проблемы то есть вот здесь уже становится сенеки не такой уж синенький а здесь от появляются уже красненькое что это означает это вот тоже надо значит потому что когда вы что-то передаете в текстовом виде вот вы должны что вы должны перекодировать весь джейсон оставить и скрипы и так далее это такое то есть каждый байтик вы должны поправил страну пропарсить и заменить на что-нибудь не дай бог там что-то встретиться нет а то есть от операция каста в текст это очень такая сложная слова простая операция очень много тратит ресурсов здесь мы использовать функцию как раз вот текст стенд для того чтобы про эмулировать что вот мы в текстовом виде здесь у нас бинарном и получили из тех сцен а вот здесь мы попробовали передать его как бы в бинарном виде вот док документ джейсон убить джейсон мой убил джейсона такой простенький такой простенькое расширение которое позволяет просто джейсон бинарном виде без ничего не перекодирование куда отдать вот мы видим что все равно вот когда вы начинаете передавать какие-то проблемы есть они получим здесь конечно в текст стал но они все-таки есть соответственно с революционным видом мы тоже все это сделали мы видим что проблемы приз в текстовом виде все равно есть остаются вот я дуг relation вот этот здесь мы передаем реляционный документ бинарном виде я был сам удивлен not когда вы посылаете массив оказывается массив можно послать именно бинарном виде очень быстро происходит экономно бейте она даже можешь сказать сравнимо себе зр сон а вот то есть этот кейс мы забрали то есть полный документ забираете джейсона будете счастливы вот теперь мы хотим не весь документ 5 а какой не ключ и еще мы хотим этот не просто ключ взять а еще попробуем запустить и тут мы видим что конечно у нас наступает на и ключ некоторые проблемы вот оператор стрелочка вот оптимизированная стрелочка этот наш оптимизация так тураева все рассказал да и соответственно это реляционная мы видим что реляционная самое быстрое самое лучшее но это очень действительно понятно потому что вы вам нужно всего по индексу найти строчку и запретить а в джейсон ли вам нужно вот в этом варианте вы видите pack v2 килобайта вмещается все достаточно быстро а дальше начинается тормозится потому что вам нужно переписать все ну спесив прочитать все и рожать вот это вот select а вот апдейт обдурить мы видим конечно медленный вот потому что как я уже говорил из-за толсто вот после двух килобайт ведь его здесь еще такая синенькое осталось полосочка но дальше всё начинает желтеть и потом начинает красней это означает при увеличении размера документа вам все больше и больше overheat на то что вам нужно переписать весь джейсон вот когда мы начали оптимизировать мы видим что вот наша после всяких оптимизация мы стали почти как реляционные это очень большая победа то есть джейсон оптимизирует джейсон когда мы имеем вот этот шарит толст in place апдейт антипод шаре толстые все эти сортированы круче декомпрессия мы получаем доступ к ключам почти такой же как как реляционным случае вот эти ступенечки вот они их легко mba и понять и потому что здесь просто напросто разные ключи достигает своих двух килобайт вот этот самый большой ключ он достиг дух килобайт раньше превратился в the us pointer вот за не начинает второй ключ папа папа по величине доходить до двух килобайт но и так далее вот это все то же самое происходит на самом деле и в реляционной виде собаки это мы видим что конечно реляционный апдейт сильно лучше вот сильно лучше чем оригинальный джейсон by и к нему приближается собственно наш оптимизированный апдейт приближается вот мы сделали такую карточку ну относительную то есть вычли реляционная да и вот здесь показывается access кей slow down то есть реляционный самый лучший видите такая без никаких а вот здесь замедление вот мы видим в мастере версии это замедление в прекрасно видно в нашей версия в оптимизированный она почти такую же цвета как и реляционная но только маленькие там бывают какие-то чуть-чуть есть замедление но не сильно то есть мы оптимизированная версия она может быть то быть такой же быстро и почти как и революционное когда мы берем какой-то ключ с апдейтами здесь похуже мы видим что все равно конечно оптимизированная версия сильно лучше чем то что сейчас есть то но там есть куда раку доработать но тут имплант эта плата за то что за универсализм джейсона вот вал с валом как раз этот тоже очень важная вещь когда вы тестируете приложение всегда нас уже обращать на это трафик потому что вот если вы начинаете приобрети получается вот такой трафик большой то есть pack v2 килобайта входит все синенькая это хорошо дальше когда мы уходим за два килобайта у нас вал вырастает в разы и это конечно удручает оптимизированная версии мы видим что картинка смазывается и становится похоже на реляционная то есть мы на у нас есть возможность облететь значит короткий ключи также как и какие традиционной версии то есть вот такая картинка то есть что из этого следует что для коротких документах пользуйтесь прекрасно надежда облетит апдейт прекрасно работает так далее но если у вас растет особенно вон там за сотни киловатт апдейт уже начинает быть слишком большой your head вот она для доступа ключам более-менее жить можно с реляционной сможет соревноваться а теперь другая такая версия мы рассматривать теперь не просто ключ взять а достать элемент массива то есть имеется какой-то ключ у которого значение массив и нам нужно взять какой-то элемент из этого массива вот здесь вот как это колоночки по 5 мы тестируем стрелочку 1 верхняя верхняя это мы забираем первый элемент средний элемент и последний элемент это в не оптимизированная версия 2 колоды вторая строчка от оптимизировано и третье традиционно и вот мы видим что вне оптимизирован и в оптимизирована картинка одинаковая потому что мы на самом деле там ничего не оптимизирую то есть у нас мы не дошли до того чтобы оптимизировать доступ к элементу массива а получается получается видите не очень хорошо ну чуть-чуть лучшего не очень хорошо потому что что потому что по индексу вы можете найти этот джейсон легко а дальше вам нужно делать рычаг то есть грубое в ручками проверить sew если массив большой вы представляете как вам уже переборов чтобы найти тот самый элемент это пока не оптимизирована и нет доступа мы пока не знаем как это хорошо сделать эволюционное там кажется проблем особых нет вы просто сразу же находите то что нужно но это опять же говорю здесь нужно взвешивать насколько вам это нужно или не нужно ну соответственно ободрить тоже единстве что апдейт ну vanilla версия мастер версия на отца не очень хорошая то есть если вы оба взлетите элемент массива а вот наш оптимизирована она такая же как реляционная то есть все все более-менее нормально ну соответственно вал мы видим что ванильной версии вал растет сильно с увеличением размеров до наше оптимизированное реляционная более-менее совпадает то есть какие здесь могут быть выпуск выводы что весь объем бен хорош когда вы хотите достать объект целиком это прям быстрее чем реляционный способом потому что там я говорил нам нужно сделать join и агрегаты там тонкая настройка там всего это дело вот он очень хорош когда вы храните метаданные как просто используйте джейсон вид для того чтобы там хранить метаданные вот даже по ней можно делать по yandex индексный поиск и так далее вот он хоть хорош для обмена данными потому что база данных она это же него q не вакууме же она база данных нужно только для того чтобы быть общаться с с клиентами с приложениями и здесь конечно джейсон это достаточно универсальный формат вот как там cs в этом их для excel a-data jason de для современных веб-приложений это прям сама это джейсон ну как я говорил дизайн базы данных простой такой и не забывайте вытаскивать из джейсона весь удачи сегодня принципе нормально хорошо вот и позволяет вам схему быстро менять вот ваш любимый джоэл там разработку то есть хоть каждый день выпускайте версии меняете там схемы дата миграции и что приятно что все в одном формате клиент backend база данных а используется одно и тоже скажем джейсон то есть происходит некое такое примирение но к сожалению он в текущем варианте который существует по греси ванильно он не оптимизирована для того чтобы для в длинных джейсон of которые толщины уходят тос до толстый джейсон и его доступ к элементам массива не очень быстрый вот совсем никакой вот но существует очень много обещающий результаты это то что я говорил оптимизирован нашей оптимизации они показывают что мы можем сделать джейсон вполне себе таким быстрым так далее почему мы можем сделать они сделали это просто потому что это затрагивает как вы видели одни из самых таких ну центральных fitch после сайт вот толст мы не можем взять просто так да и его заменить потому что то сон внутри очень глубоко спрятан и поэтому если вы хотите сделать нормально это то нужно сделать тос который понимал бы кого он носится кого он постит то есть например ты ему объясняешь что вот я джейсон ты давай меня вот то есть вот таким-то способом они всех под гребенку то есть сделать тест соответственно расширить puzzle is еще дальше сделать настраивая вот этот тост и следующие конечно о чем мы думаем это подпор подумать о джейсон бек со сметой то есть совсем отдельно хранилище где например хранить ключи значения как граф знаете графа его базы они их работает на уровне документов а тут нужно просто еще глубже на уровень ключ-значение вот хранить все ссылочки так далее тогда можно будет по отдельности облететь по по отдельности с нутом вазик идет операция сбора документов наверное вот здесь надо думать но лучше яндексе и лучше лучше или индексы конечно да то есть настоящий момент можно использовать жим у него имеется два old класса еще два от класса вы можете скачать из g сквере вот они поддерживают же джейсон пас но там можно очень много сделать например такие вещи как передавать параметры в яндекс то есть сейчас вы инвестируете весь джейсон совсем мусором который там есть вы можете конечно построить функциональный индекс то есть по тем потому ключу которую вы хотите делать но хотелось бы просто-напросто при индексе рование сказать какую по 2 тачку по индексировать какие веточки вот джейсон пас как раз я зык который позволяет вам декларативно но грубо описать те части джейсона которые вам интересно если бы наш create index это бы поддерживал это можно было бы создавать такие компактные индексы индексируют а что нужно вот этот патч тоже лежит у комьюнити но он пока руки руки не доходят насчет этого но это на наших планах вот ссылки например видите на детали детали наших улучшений вот можно прямо здесь посмотреть где-то даже есть запись вот слайдик наши нашего доклада вот можно вот эту курс улочку кликнуть ну и про то что про джейсон и вот были несколько докладов можно прочитать то есть чем джейсон богат а то он богатого я больше 50 функции работы с ним все что можно уже делать там об этом не стоит волноваться и вот такая хорошая страничка николая копейкина это ваш питерский художник у него тоже есть страничка про салона в питере очень такая полезная ссылка новый год заканчивая тем что вот мы сравнили puzzle с манго вот секс can вот ванильный пузырь из а это значит соответственно манга видите ванильный пользуюсь несколько раз проигрывает манги но так который помещается в памяти и а если память уменьшить то ванильный пузырь становится почти равным манги но когда применяем все наши оптимизации про который рассказывал смотрите мы начинаем бы обгонять мангу очень даже хорошо вот потому что у нас есть о первых параллельное исполнение запросов видите вот параллельно исполнение запросов вот здесь вот наш оптимизации шарит толстый лайн и так далее и так далее поэтому мы можем мы держим руку на пульсе и хочу сказать что мы не должны сильно проигрывать вот на узкую или базам данных что внутри технология от и даже можем выигрывать как вы видите но это опять же это не научная benchmark сравнение что сделать хороший benchmark это очень большая работа и требует какой-то если кто-то из вас это может за это взяться это будет вообще шикарная работа вот вот слайд что все что вам нужно это пузырь это вот мой лозунг которую я везде рекламирую потому что потряс это универсальная база данных то есть она позволяет вам начать любой проект и вы не прогадаете потому что даже вот в нем богатом на реляционные fitch ip адрес твоего расширяемость еще появился джейсон которые вполне себе рабочий и самый последний доклад и я вас всех приглашаю на конференцию по глисону которая будет 25 октября в москве там собирается много много людей после двух лет как это мы будем все очень такие радостные увидим все друг друга вот последний раз у нас было порядка 700 человек а сейчас будет орда думаю еще больше потому что все соскучились и там вы сможете узнать но просто сказать будут весь свет пожгли со нашего и его ответим на все вопросы и у зайти и люси кейсы и потроха подвеса зададите вопросы у нас там наверно будет опять сертификация в знаете что у нас есть в подписи сертификация то есть вы можете получить сертификат если вы зайдите в общем на сайте пазы под здесь profession а вы можете увидеть целый раздел образование где лежат ссылки на бесплатная лекция бесплатное видео бесплатные книги по пол рису все это вы можете скачать и посмотреть подготовиться прийти к нам и получить сертификат о соответствии скажу всё на этом я хочу закончить он занимал пам пам пам пам пам пам пам пам слон слон слон у нас остается 8 минут на проветривания один вопрос вот такой чтобы просто вот без ответа умрешь я буду здесь вот кого тусоваться боже- сюда мне спросить вот такой что смерть или ответ вот смотрите жало желтый цвет идти вот рука размахивает логотипе индекс голову прямо на рукаве у человека ведь а хороша битва между белым и желтым начинается до девушку надо выбрать во-первых он сексизм не из моих уст смотри ну давайте 1 и 2 быстро прям быстро раз два вот там на многих грим их микрофон на многих графиках есть порог в 100 килобайт можно в общих чертах описали с чем он связан тучи просто там просто внизу по оси x и ник сжатый размер а сырой размер вот эти 100 килобайт они на самом деле сжимается вот эти два килобайта просто ты об этом не сказал он так она есть и 2 бегом подскажите пожалуйста по поводу чанков если вы например удаляете или записывайте больший объем в значения будут создаваться новые чанки и удаляться и создаваться новые ссылки на них и либо же просто чанг увеличивается в размере чанки не увеличится в размере то есть они увеличатся до двух килобайт то есть как только размер превышают 2 килобайты появляется новый чанг фиксированный размер и она будет замедление если мы будем писать об тратить большими значениями либо наоборот уменьшать данные ну уже все так вот не могу сказать точно как это значит подойди в кулуар олег кому книжку даем за 1 просто лиза 2 во вторую хороший за второй вопрос хорошо вот и вместе с книжкой подходите олег для тебя тоже у нас есть призы и памятные как обычно традиционно друзья сейчас спикер уходит в цифровые кулуары вы можете пойти вместе с ним из онлайна вы также можете проследовать со спикером в онлайн кулуары аплодисменты не стесняйтесь спасибо друзья"
}