{
  "video_id": "BQJ6w620OV8",
  "channel": "HighLoadChannel",
  "title": "Индексный поиск по регулярным выражениям / Александр Коротков (Интаро Софт)",
  "views": 245,
  "duration": 2116,
  "published": "2017-04-28T04:21:05-07:00",
  "text": "александр коротков является ведущим разработчиком в янтаре софт работал над такими проектами как новый сайт государственной думы система обработки заказов для restore федеральным страховым порталом и сервисом анализа днк человека интересно нам тоже александр коротков выражение вот и говорят что автомат считается как у если можно от начального станет и конечно пройти и при этом по ребрам которого прошли будет написано то про строка которую регулятора же не создает чтобы это было понятно давайте сейчас небольших примера рассмотрим потому что весь остаточный материал он основа как раз на понятием мистического автомата есть вот у нас есть такое выражение в котором вначале идет символ и потом цепочка эссе повторяется сколько угодно раз от нуля до бесконечности а в конце символ ты из него получается вот такой вот автомат где есть начальное состояние которое здесь помечены звездочкой у него есть ребро которого ссылается самого себя это значит это состояние но остается всегда активным потому что у нас регулярное выражение если обратить внимание на дни префикс на она может с какого угодно символа начать совпадает со строкой нуждаюсь дальше мы читаем силы и активируется другое состояние вот и дальше символы не силу так вот считаются про цепочки сколько угодно раз здесь можно ходить вот а потом из этого состояния мы можем просто все волги перейти в конечное вот это мы тоже можем сколько угодно раз оставаться в зависимости от того какой сил у нас подается на входе это потому у нас в конце регулярного выражения не стоит признака статей и посмотрим как это работает когда нам на вход подается какая-то конкретная строка нас в начале тут символы x y z они несут не совпадают с тем что подписывал у нас на этом ребре вот поэтому активном остается только начальное состояние так мы читаем первые три символа потом встретили символ рейки активировалась вот это состояние дальше символами и силу ткань а я вот эти состояния вверх вниз вот а потом соответственно когда вы нашли силу где-то у нас активировалась конечное состояние и она уже остается активным до конца строки все у нас на тот момент когда вся строка была обработана конечное состояние активно это значит у строка подходит под регулярным ножи вот теперь все мы кое-что знаем про регулярное выражение вполне достаточно чтобы понять содержимое остального доклада поиск регулярных рождением в возрасте хорошая новость то что присутствует плохая новость том что пока что был только последовательно то есть нужно было читать все строки и все строки предмет ее соответствия регулярного выражения значит вот все существующие методы которые есть для того чтобы осуществлять поиск по регулярно выражении свой щит x они основаны на так называемых инвертированных индексах нам граммах и в том числе и мой метод тоже по поводу того что такое n grub грамма кажется такое достаточно сложное слово вот в google и можно вот такие вот картинки найти поэтому словом сейчас мы посмотрим что такое на самом деле все очень просто инграма это просто некая подстрока длинный м которая используется как сигнатура исходной строки то есть набору инграм который входят в строку мы можем что то ее сказать даже не видео всей строки целиком в частности сейчас просто задача будет понять удовлетворять 40 регуляр жители нет и ангаром они широко используются в различных поисковых задачах вот помимо той задаче которую я рассматриваю еще также различные задачи нечеткого поиска телетекст поиски с опечатками и так далее вот все что про инвертированный интерсная играм охота индекс которая поддерживает соответствие между in гаммой и один никами всех тех строк которых оттенком и присутствуют частности вот модуль изжить себя джим он содержит реализацию для n равно n равного 3 для 3 грамма вот если так логически представить индекс который строит в модуль изжить себя чем-то он переводит набор строк у каждой из которых есть радич ник в набор ригов всех треков которые присутствуют в этих строках и для каждой триграммы указывается список айтишников этих строк которых присутствует этот экранах такая довольно ну вот на данном уровне вращения такая довольно простая структура если там уже смотреть как физическим так устроен танк довольно много тонкостей на следующем докладе не в призме блага священ и также очень важным является вопрос частот grub word потому что если взять например базу данных детей и это такая база данных по научным статьям там вот взять и тут два с половиной миллионов заголовка статьи то можно видеть что 3 грамма же арктикой английском языке встречаются и 60000 довольно много а если взять 3 грамма а вот да он встречать всего один раз частности мне стало интересно почему где же встретился встретилась такая-то грамм оказывается кто-то назвал главу книги состоящей из одних буксует вот и что получается исходя из этого на самом деле не все три грамма одинаково полезны при поиске взяв как будто 3 грамма можно быстро поднять список для нижников текстов который встречается азиатка пульта нам приходится по очень длинному списку лазать то есть все частности вот может быть там 300 тысяч возможно нам было бы проще без нее вообще обойтись есть идея в том что не все три грамма одинаково полезны и на самом деле нам хотелось бы все-таки для для поиска наиболее полезной низкочастотные от грамм и потому что с ними можно очень быстро работать и поэтому родилась идея так называемых в грамм или мы с тигром которые встречаются в различных научных работах это значит что у каждого может быть свое индивидуальное и то есть например если к это 3 грамма встречается очень часто мы ее не включаем индекс а в яндекс включаем на единицу длины и там получается квадро громада из четырех символов которые которые уже и будет много но каждая из них будет арье таким образом нам длинные списки из индекса не придется поднимать эффективность становится выше но проблема с этими программами или мультик равный первое это то что трудно поддерживать актуальность потому что в научных работах как подходит просто у нас есть изначально набор данных из строя по нему индекс один раз какую проблему что базы данных могут приставы дальше insert и это так далее вот с тех статьях которые я считал никого не волновало поэтому есть такая проблема это первое второе это то что алгоритм патентованные и опыт собственную базу это так просто не добавишь навык будет возмущаться как же так у нас подадут в суд и все такое вот как же можно такой индекс на интимные нас не граммах использовать для поиска по регулярным выражениям общая идея такая что у нас есть исходные регулярное выражение и мы его преобразовали в логическое выражение в данном случае внутри граммов вот вот мы видим что у нас есть вот логические выражения лиц может идти о р б а дальше за поиск осевого с этой а вот можем видеть что получилось логическое выражение значит обязательно встречается 3 грамма а cd или обязательно бега или pct дальше обязательно встречается с этой эта получили логическое выражение которое обязательно тут мина для любой строки и которые которые соответствуют или популярного выражения но не наоборот то есть ну понятно что если вы бы вот это логическое выражение то есть все вот эти 3 грамма соответствии с логикой подошли то это не значит что регулярно рожать будет соответствовать но предварительная фильтрация позволит нам очень много лишних результатов осей и вот идея следующего у нас есть инвертированный индекс мы для каждого из них которые нашли соответствующим 3 грамма запомнили такую табличку в которые обозначены какая программа присутствует какая нет и дальше приседали вот это логическое выражение которое нас получилось там где у нас получилось друга это значит что сексуально острога который мы извлекли она может регулярное выражение подходить тогда может достаем исходную строку из базы в данном случае существо к сессии и по исходной строке проверяем соответствие регулярного выражения делаем так называемой reechoed и уже тут тоже снова может либо подарить ipad регулярного же не линия но мы сделали достаточно большую предварительную фильтрацию которая большая часть ненужной работы нам позволило отсечь вот но вопрос возникает в том как же нам это сделать окном в общем случае перевести из-за регулярного выражения вот в логическое выражение на 3 граммах этой задачи есть уже ряд существующих подходов было 2002 году опубликовано научная работа fast travel express яндексе и джим она до сих пор широко 5 как state of a в данной области хотя на самом деле это не совсем так метод который в ней предложат достаточно простой на сном на том что мы изделий из регулярно выражения вырезаем непрерывные участке строк из строя по ним дерево вот дальше мы там это дерево определенным способом преобразуем вот и потом из этих непрерывных пускал строк делаем мульти грамм и вот который как мы рассматривали тут инграм у которых может быть индивидуальный опять ибо финальной стадии как и везде это используем инвертированного индексной граммах сейчас рассмотрим небольшой пример что-то у нас был было исходно регулярное выражение вот в нем был было три таких вот непрерывных кстати вот еще один символ x вот получилось вот такое дерево в которых узлах находится во внутренних углах находится во логические операторы элимов звездочка вот дальше подход следующий значит там где присутствует звездочкам мы заменяем канал но это как бы означает что мы упрощаем вот эту часть дерева и считаем что там может быть другое что угодно вот а дальше уже на определенную по прилету правил из этого дерева удаляются то есть но в данном случае он что называется съедает вор потому что если у вас или которая связывает какое-то конкретное как эта вещь не известно что что ну что в результате мы тоже не знаю вот и наоборот and он у нас считает начальник после этого лишний корм можно из этого дерева убрать вот а дальше у нас осталось просто дерево в котором участвует непрерывный участке строк мы эти строки преобразовали обман грамм на в данном случае в 3 грамм мы преобразовали вот а дальше уже идет сканирование по инвертируем у индексу аналогично тому как выпало до этого смотрели вот это первый метод который осматривает из второй метод это был проект google search который можно было по всем проектам с открытым исходным кодом опять пользу по исходникам в том числе и с помощью регулярных выражений года в год все еще был запущен в 2006 году меня только сразу не совал вопрос как же они это сделали потому что поезд регулярно выражении в общую в общем случае это довольно тривиальная вещь и вряд ли google взял и сделал там последовательный поиск во всей своей базе это мыслимо вот но с другой стороны google врят-ли поделятся своими секретами вот однако же уголка все еще он закрылся в 2000 в конце 2011 года и и жене google раз фокс в своем блоге описал эту технику которая использовалась так вот если говорить вкратце то там по поводу каждой части регулярное выражение собираешься 5 характеристик empty бома это территория 3 пустая строка этому выражению или нет exact это если можно те все строки которые поданы и регулярно выражения подходят перечислить то просто они в этом свойства перечисляются префикс это соответственно означает что строки которые подходят они должны обязательно начинаться с одного или западных нас снова есть глаза твого набор астролога вот суффиксы аналогично но только с конца а мальчик-то значит что обязательно в средине должен быть некоторый фрагмент поток значит эти характеристики они вначале собираются для самых маленьких составляющих регулярно выражении а потом рекурсивно объединяется а дальше как как и в прошлом методе инвестирования и газ используются на 3 граммах здесь не было варьирую его воде вот точно так же как в после simon или ищите джим сделал yandex вот рассмотрим небольшой пример как это может работать вот у нас есть регулярные выражения такое же как мой самом начале в примере брали вначале для самых простых составных частей рассматривал характеристики здесь все просто здесь будет забор на характеристика exact вот поскольку это просто непрерывный такие участков символ пусть даже из 1 тогда к и сего добавили плюс вот этот движок он считает что если бы узнать наушник префикс писем того что ему говорят иисус нанесение вот дальше когда мы к этому ещё добавляем начала и у нас вот это и я на добавляется префиксу а когда в конец добавили день это добавилось суффикса в итоге у нас получилось вот такое вот такие вот характеристики уже для общего регулярного выражения получилось что мы взяли и заявляет о выражении сделали вот эти характеристики а в конце уже из них несложно сделать с логическое выражение на 3 граммах поскольку у нас за грехи xxi суффикс очевидно что обе триграммы которые них участвуют они должны присутствовать кстати которые мы шли до этого было все что было сделано до меня теперь я расскажу про свой метод излечения 3 грамма из регулярного выражения которые совершенно другим путем работает значит идея в том чтобы работать не из исходной регулярной с тем автоматов которые образуется потом упростить это этот граф который получен при граммах вот а дальше использовать жены dex в модуле бежите от же вот сам процесс образования его довольно сложно четко математически это написать вот данная данных временных рамках поэтому рассмотрим он примеряет вот пусть у нас есть вот такая вот регулярка и соответствующей ей автомат вот и мы сейчас будем составлять результирующий граф в котором ребра будут подписано уже не просто символами исходного алфавита а три главные значит у нас есть начальное состояние и первое что мы сделаем эту вы к начальному состоянию подпишем то какие что мы можем сделать если не прочитав ни отныне приставки 1 триграммы то есть например мы можем взять прочитать сила выберите состояния 2 потом прочитает символ вот в результате у нас последние два символа против них и деньги состоянии 2 потом аналогично мы можем и и гипер читать его попасть состоянии 4 аналогично в нижней части расположен эссе прочитать вопрос состоянии 3 и 4 чтобы сделаем мы посмотрели все что прочитать если мы не прочитали не 1 3 грамма дальше смотрим конечное состояние 2 здесь мы можем снова прочитать символ и вот уже у нас появляется 3 грамма который обязательно должна присутствовать в исходной строке вот мы ставим такая в результирующем грязи еще одно состояние вот еще одну вершину и подписываем ребро триграммы и вот аналогично мы можем снова прочитать символ вина перейти в состояние 4 и тогда у нас будет другая уже вершина которая подписана тем что мы может быть в состоянии 4 и последние два символа которые прочитали это вот вот аналогично мы можем прочитать из состояния четыре символа геи и тогда мы попали уже в конечное состояние результирующая вершину мы тоже помечаем как конечно вот сделать вот такие вот все преобразования дальше начинаем уже не только из не только изначально из всех других вершин результирующего графа смотреть что мы можем прочитать вот получили в итоге вот такой вот граф потому что мы можем у него сказать при нем можем сказать то что этот как раз граф нам задает логическое выражение которое мы можем проявлять то есть чтобы строка подходил под регулярным выражением мы должны иметь возможность пройти вот от начальной до конечной вершин вот таким образом чтобы все триграммы которыми помечены ребра они присутствовали строке вот есть например если в строке присутствует и леди 3 грамма то соответственно значит она вот этому графу удовлетворяет или если присутствует рыбы и беги вот такие вот 2 3 грамма то она тоже будет удовлетворять вот этому графу вот очевидно что этот граф можно упростить вот потому что ну например здесь совершенно лишнее какие-то телодвижения что если мы прочитали триграмму или ли мы можем напрямик попасть вот в эту вершину не обязательно нам делать еще здесь это абсолютно личное вот здесь требуется еще некоторые процедуру вращения процедуру обращения выполняется данный момент просто собирается матрица всех возможных путей и по ней строятся логическое выражение вот небольшое сравнение на примерах подхода phase 3 игры экспресс яндексе или дается google вот все вот и в предложку метки если у нас есть такое регулярное выражение соответствовало к метров сокращен называемый фреон позволяем вот только 33 грамма собрать google позволяет со праздничка более полное логическое выражение предложенный метод на самом деле предлагаете предлагать почти то же самое вот вот только здесь не так голову просила получилось изолирующие выражение вот если посмотреть вот такой пример с плюсом и с помощью метода сведение сегодня получается извлечь вот потому что здесь нету непрерывного участка из трех из хотя бы 3 символов потому что такое всего оси здесь относятся плюсик вот тут все из позволяет s2 3g собрать выражение предлагаемый метод он позволяют нам побольше триграмм собрать в адрес этих проверку появится выполнять точнее вот ещё один пример здесь вот из-за звездочки даже men этот google под все ничего нет не может залегать вот с помощью предлагаем вам не туда можно такое выражение на 3 граммах собрать и вот ещё один пример здесь тоже вот из-за этой звездочки соединен даже нет google год все еще не позволяют извлечь ни одной триграммы если бы были сделаны методом например году серж или free нам пришлось бы все равно делать полное сканирование по всем строкам вот небольшой тест производительности который был его замеряем с помощью патча написанного модуля пищей для jail вот здесь сравнении с последующим сканированием потому что реализация других нет нас она требует серьезных трудозатрат вот но здесь видно что на самом деле наблюдается замедление чем линии нас выражение всем больше нам нужно прочитать списков тем дольше получать сканирование по индексам вот на самом деле можно некоторые директору делать еще дополнительной оптимизацию то есть там наиболее длинные списки пропускать вот этим соответственно пока я не занимался есть пачек модуля пишите отжим вот он сейчас разработки есть если в или ввести вот надеюсь что версий 93 отказ и все это даст включить воду и будет знать из коробки всего работать вот если кто-то хочет присоединиться к тестированию или кого-то есть данные которые могут пригодиться при тестировании то соответственно вы приветствуете плотность есть следующий проблема пока первое то что с помощью такого преобразования может получиться очень большой граф вот во вторых то что при упрощении этим методом который был выбран может получить с на самом деле очень много путей и это упрощенное представление может оказаться очень большим page лучше всей был и не обращать на 3 из патентов проблему не удается использовать программы или ultegra мы вот и приходится использовать встретить проблемы видимо пока просто придется смириться и вот первый век видимо придется просто такие случаи специально обрабатывать и все-таки возвращаться опять же последовать ему поиска все-таки магия здесь никакой передвинуть недостоин вот на клад немножко упрощен из-за временных рамок здесь во-первых не я не рассказывал там это минировании книга доминирование автоматы что на самом деле в 2 шкаф регулярных выражений очень важно здесь все что мы рассматривали это нет ни детерминированные автоматы 2 прошли они рассказывают про то что сила на самом деле группируются так называемые цвета то есть это множество неизлечимых символов с точки зрения ли для отображения потому что но представьте если у вас идет там духа гозиас регулярно выражении присутствует любой непробельных символов to dougie которые соответствуют всем возможном непробельных символов символом хранить для графа это будет очень дорого полиции но и посольстве результате это что как специальным образом обрабатывать сначала перестать им это тоже я не рассказывал на тоже при обработке регулярно выражения да очень важный момент спасибо за внимание я слушаю ваши образы только день я понимаю сценарий поиска по регулярным выражением что начали пишется есть цель написать свой запрос с использованием регулярные упражнения после этого пишется его некая трансформация и выполняется все-таки и трансформирования свой запрос и в результате мы ищем уже делать начать поиск потому что получаем все на самом деле с точки зрения пользователя намного проще из вы просто пишете sql запрос регулярным выражением вот если есть нужный индекс после сделать дальше все сам внутри себя от dice там внутри ищется что в этом классе операторов для этого индекса в нем есть вот этот оператор поиска по регулярному выражению дальше он там уже смотрит как по инвест нам яндекс что это смотреть вот потом бездны индекс когда он дает результатов ставят везде флаг 3 чек то что нужно перепроверить и за века когда извлечет данные из хип вот ибо тонкой проверяет вот с такой сложный процесс но с точки зрения пользователя все прозрачно просто запросы гулянкой и работает c можно вмешаться через параметры плана вы можете взять и там сзади заявить индекс канон будет последовательно сканировать если даже на уровне планировщика запросов в принципе можно предусмотреть ещё какие-нибудь глобальной переменной через которые передавать какие-то параметры именно для данного модуля если это будет необходимо из какие-то перемены сессия возможность восстановления настроить магов instagram что у меня зовут зрения же по количеству узлов первоначально газе но на самом деле оно не экспоненциально но там что то вроде того что количество узлов умноженная на квадрат и от количества возможных символов но на самом деле это тоже не сахар что называется потому что силы вас может быть много но поэтому собственно вот вариант только такой что уже в процессе преобразования обтекать как этот процесс если мы видим что получается что-то громадное сказать извини друг лет и напоследок на сканировать вот есть еще такой аспект что если у вас выражение берется не из такого запроса а просто заданная константах забросе то тогда плана он проверить то какое мы сканирование по индексу проверяем вот предлагаем вот если смотрит что получается плохо он не будет на полное сканирование по инцидентам просто сразу по таблице пойдешь размер к именно время построения там переборка первоначально брака официальным по количеству количество но в принципе да особо помнит вам время здесь равно тоже получается если я сейчас могу отмотать время получать все равно количество узлов умноженной на там квадрат от количества символов ну просто дело в том что здесь число вообще вот этих возможных и фиксов которые мы можем записать вот этими вершинами это будет вот-вот понятно весь алфавит в квадрате воды можно и на состояние собственно число состоянии выпуск исходным график вот но как бы самом деле даже для нас неважно специальный венец равно может получиться что то что по времени до будет долгой и по памяти будет большим такая паста с действительно есть вот и вот как бы решение я вижу пока только такое что надо как-то этот процесс там прерыватели где-то возможно идти на какие-то делать на плаванье упрощения то есть предположим получать не такой точный граф до какой-то граф который будет пропускать побольше строк облик большего сходства котлов возвращать true но в то же время сна будет попроще уж прости самую детстве забыл можете постоять такого вопроса как тут делаешь какие-то убивает или там привезли были я думаю довольно плохо обстоит вот потому что лукас еды и лук пихайте как правило для них движок регулярное выражение делает отдельный автомат а у себя тут я использую вот этот автомат который бродит для так называемого ритуале снова поиска вот и скорее всего свете если есть только мука head will look их алиби а кроме них ничего больше нет то не сможет работать на самом деле там похожие ситуации и там их подходах в подходе google glass вечно сколько документально другие классы количеством услуг у нас к грязный они как но такое свечение такой по-моему именно вот чтобы эволюционной базу базе это было это по-моему не где еще нет то есть есть только вот отдельные движки вот этот метод и который и только виде стать и видел ее патента 1 реализации нет и метод google к все как бы это все что мне удалось найти и существующих реализации по данной проблеме в реляционных базах такого что уже был готовым нет вот именно так устроена или смотри граммам обе статистика на каждый триллион раз на встречаются стоки мог использовать какие-то бы стать по каким бы стать но на самом деле на текущий момент статистики нет вот но во первых там есть там как длинные листы они на самом деле хранятся никак не стой как деревья когда мы считаем сканировать дерево то там можно получить оценку вот а уже там по этой оценки решать вот авторы как мы в следующем докладе покажем там планируется улучшить набор оглашение для jane exo будет но презентацию меня нет но там по сути просто обычное будет bitmap индекс там который при любому тогда сканирование по жены вы также там как при полнотекстовом поиске"
}