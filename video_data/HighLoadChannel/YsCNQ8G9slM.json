{
  "video_id": "YsCNQ8G9slM",
  "channel": "HighLoadChannel",
  "title": "Как обслужить 60 миллионов абонентов / Артем Руфанов (ПЕТЕР СЕРВИС)",
  "views": 205,
  "duration": 3599,
  "published": "2017-04-22T11:02:39-07:00",
  "text": "мой доклад разбит на четыре части в первой части расскажу о той задаче которую нам предстояло решать о тех требованиях которые были сформулированы к нашей системе в следующей части Я поговорю о архитектуре и каким образом мы удовлетворили требования за счёт архитектуры следующая часть будет посвящена дизайнерским решениям когда я употребляю слово дизайн Я говорю о проектных решениях и не имею в виду решения связанные с юзер интерфейсом Как вы знаете ка система должна быть инсталлировать моего доклада будет посвящена историю успеха и частично я расскажу про наш опыт который мы получили в процессе внедрения прежде чем приступить собственно к выступлению к докладу я хотел бы сказать пару слов о компании которой работаю Я работаю в компания Питер сервис ключевые слайды вы видите о компании на стенде на слайде важно отметить что тер сервис - это компания которая занимается производством телекоммуникационного программного обеспечения И входит в топ-50 Российской Федерации нашими клиентами являются все мобильные операторы входящие в большую тройку Итак поехали Как вы знаете операторы стараются внедрять и разворачивать стадам последнее время и Один из таких стандартов это сеть Evolution это делается для того чтобы операторы могли в будущем свободно менять оборудование и иметь возможность как-то оперировать со своей сетью организация которая управляет выпускает эти станда называтся инново изло 3gpp стандартов сети ти - это узел pcrf собственно говоря перед нами стоит задача реализации узла pcf Согласно 3gpp спецификации для того чтобы быть в состоянии обслужить 60 млн абонентов оператора связи Что такое pcf упрощённая это система которая принимает решение о качестве обслуживания с учётом многих факторов таких как расположение абонента в той или иной соте таких как его тарифный план перегрузка сети и других упрощенно можно привести пример допустим кто-то находится в торговом центре переполненном торговом центре и смотрит видео пока его супруг или супруга выбирает и завершает покупку в этом случае на pcrf поступает информация о том какой контент потребляет Данный абонент допустим это видео высокого качества также на pcf поступает информация о свойствах е абонента именно п и со в которой он обслуживается соединяет всю эту информацию анализирует е и принимает решение о скорости которая предоставляется данному абоненту в данном случае скорость должна быть комфортная для того чтобы ему просматривать фильм высокого качества как я уже сказал организация 3pp выпускает достаточно большое количество стандартов для на этом слайде первый Стандарт действи с внешними системами по различным протоколам но и внутреннюю архитектуру то каким образом pcf должен быть реализован внутри следующие стандарты они регламентируют протоколы взаимодействия с внешним системам к таким протоколам относятся GX gxx RX S9 эти все протоколы основаны на диаметре и в качестве транспорта используют либо tcp либо как транспортный протокол всем нам хорошо известен протокол ctp менее распространён но тем не менее все эти протоколы могут работать на транспортном протоколе CP Итак давайте посмотрим на место pcf в архитектуре 3gpp либо Согласно архитектуре 3pp на этом слайде pcf располагается в центре и в простейшем случае когда абонент устанавливает соединение то информация это приходит BF BF - это узел который отвечает за управление радиочастот на pcf в процессе этого осуществляется загрузка профиля из udr udr расшифровывается как User dat репозиторий и он хранит профиль и подключённые услуги у данного абонента в простейшем случае можно udr воспринимать как просто хранилище как базу данных после этого вся информация э соединяется в PC анализируется и отправляется ответ по по GX протоколу и gxx на bbr для управления радиочасы выставить качество обслуживания данного абонента как я сказал это простейшая ситуация в более сложной ситуации допустим производится анализ того контента который потребляет Данный абонент это осуществляется на узле тдф ТФ - это фи detection Либо второе его название это dpi Packet на этом узле осущест контента который потребляет абонент и по интерфейсу SD передают на pcrf в том случае если мы интересуемся некоторыми счётчиками отображающие монетарное состояние данного абонента то мы взаимодействуем с системой по протоколу систему можно упрощенно рассматривать как некоторый биллинг в том случае если в процессе принятия решения в процесе оказания услуги участвуют голосовые услуги эта информация передаётся с узла АФ prx протоколу и если у нас абонент находится роуминг то происходит взаимодействие с визитёр Ским рфм Как вы видите сложность этой системы заключается в том что мы должны собрать большой объём информации с разных систем мы должны его скоординировать обработать принять правильное решение о качестве обслуживания предоставляемое абонента и всё это сделать в реалтай Итак давайте сразу проговори Что такое 60 мл 60 млн - это предполагается что абонентская база оператора из них у 100% подключена услуга мобильного интернета и из них порядка 60-80 пользуются этой услугой порядка 12 125% от 60% используют эту услугу Здесь и сейчас что это означает фактически для нашей системы для нашей систе Это означает что порядка 15% это активные сессии абонента которые присутствуют сейчас на системе и порядка 80 - это обм максимальный объём профилей которые мы должны либо зашивать либо обеспечить иную работу эффективную работу с ним в нашей системе Давайте поговорим про требования которые выставляются к нашей системе эти требования разбиваются на две большие на две большие группы первая группа это системные требования и вторая группа - это функциональные требования не видно низ слайда но я проговори его к системным требованиям относятся достаточно традиционные в Телеком отрасли такие требования как режимы поддержка работы в режиме 247 отсутствие единой точки отказа масштабирования резервирования достаточно новая для нас требования это геореконструкция вендер специфик интеграции и возможность внедрить новые бизнес-услуг без перем приложения перем приложения это выпуск новой версии То есть фактически это задержка Time to Market к функциональным требованиям их здесь не видно относится соответствие спецификации 3gpp из функциональных требований только одно но как я уже сказал 3gpp организация в своих спецификациях подробно описывает не только внешнее взаимодействие но и внутреннюю работу окружение в котором мы реализуем нашу систему наша система реализуется на операционных системах и поддерживается inin 32 64 Linux 5 и 6 в качестве языка в качестве языка программирования которые мы используем это язык c+ Plus и язык лу на языке c+ Plus мы реализуем ядро нашей системы и на языке лу Мы реализуем бизнес-услуги в качестве библиотек мы используем собственные библиотеки Прежде всего это связано с вопросами надёжности и производительности на данном слайде перечислено типовое оборудование на котором данная система должна работать важно отметить что операторы в последнее время отказались или отказываются от тенденции покупать большие дорогостоящие дорогостоящее оборудование и предпочитает чтобы их система чтобы система эффективно работала на обычном x86 железе надо отметить что мы в этом тренде Я позже расскажу каким образом Итак на текущий момент мы сформировали я кратко рассказал что мы собираемся делать в каком окружений мы работаем И какие требования Мы имеем к нашей системе часть этих требований Мы реализовали за счёт архитектуры и часть этих требований Мы реализовали за счёт дизайна Давайте в этой части поговорим про наши архитектурные решения я их напомню Это масштабирование резервирования которое мы достигли за счёт избыточности то есть ренн герез вирова резервирование в сист и расширение без пеком Итак первое требование масштабирование Как вы знаете масштабирование бывает вертикальна и горизонтальная к вертикальному масштабированию относится масштабируемая которая достигается за счёт увеличения производительности к горизонтальному масштабированию относится масштабирование которое достигается за счёт добавления нового оборудования здесь дальше я буду говорить про второй тип масштабирования то есть добавление нового оборудования соответственно для того чтобы реализовать эту задачу мы разделили наш pcrf на два слоя первый слой либо Узел - это p7 p7 он реализует всю ту логику которую он должен всю ту функциональность и логику которую он должен реализовать Согласно 3G PP спецификации второй же Узел - это дра инкапсулировать себе алгоритмы масштабирования например распределение по кругу распределение по кругу с Весами распределение по узлам с минимальным временем отклика и другие То есть таким образом когда к нам приходит запрос из внешней системы например по протоколу GX дра принимает решение куда конкретно отправить и отправляет на очередной выбранный Пис за счёт этого можно сказать что задача масштабирования решена следующая задача - это резервирование резервирование это по сути обеспечение единой точки отказа что мы резерви мы резерви внутреннее состояние нашей системы а именно диаметральный сессии которые необходимы которые содержат информацию необходимо для принятия P решения то есть решение о качестве обслуживания существуют достаточно классические схемы резервирования это N П 1 2n и 2n + 1 Давайте вспомним что это такое резервирование N П 1 У нас есть N узлов сейчас Извините у нас есть н узлов и допустим узел pf2 вышел из строя в этом случае вся нагрузка переключается на резервный узел pcf и система продолжает функционировать без единой точки отказа резервирование 2n построено следующим образом у нас каждый узел имеет резервный узел в том случае если выходит например из строй pf2 то вся нагрузка переключается на резервный pc2 следующий тип резервирования он сочетает Дух это резервирование 2 ВМ сча и резервный N П 1 в том случае если из строя выходит P2 например то нагрузка переключается на резервный P2 если пара выходит целиком то переключается на резервную пару понятно что Надёжность такой системы выше Мы в качестве реализованного алгоритма выбрали алгоритм 2n этот алгоритм мы поместили точно так масштабирования в поместили в него не только алгоритмы масштабирования но и алгоритмы резервирования и тогда когда приходит запрос от внешней системы допустим по протоколу GX то дра принимает решение Какой из писмо в группе является мастером для данной сессии и отправляет её если приходит другой запрос следующий то в качестве матер писма может быть выбран другой узел за счёт этого обеспечивается эффективное распределение и использование ресурсов между железом на котором стоит P Мар и P Как вы видите на этом слайде отсутствуют горизонтальные связи между пим но обмен информации между писма то есть синхронизация контекста в сессии осуществляется через драм понятно что за счёт избыточности мы резервировать узел p7 но во всей схеме целиком У нас по-прежнему остался осталась единая точку отказа именно узел дра Давайте решим Это для того чтобы решить эту проб д но э схема будет работать только в том случае если внешнее оборудование на данном случае на данном слайде это pcf Будет поддерживать функциональность позволяющую определить что дра 1 вышел из аварийно завершил работу и переключит переключит всю нагрузку на дра 2 как правило все производители телекоммуникационного оборудования такие алгоритмы в себе уже поддерживают поэтому можно сказать что мы обеспечили резервирование наше систе целиком герез вирова герез вирова - это достаточно новае для нас задача её важность заключается в том что оператор хочет прозрачно обслуживать абонентов и предоставлять им интернет принимать в нашем случае решения даже в том случае если из выйдет из доступности целый регион допустим это может быть в связи с проблемами в электричестве Дант для проблему мы дублируем pcrf но как я уже сказал Горин обмен информации внутри писмо в одной группе осуществляется за счёт дра в данном же случае это невозможно то есть обмен этой информации между разными георесурс нам в дре нужно Извините нам в ме нужно реализовать функциональность восстановления сессии по частичным данным после того как мы это сделаем мы можем сказать что осущест георесурс то есть допустим у нас есть PC который работает с ми udr - это US Data репозиторий и он распределяет нагрузку между udr 1 и udr 2 а pc7 либо pcrf целиком должен идентифицировать ситуацию Когда udr вышел из строя и прозрачно переключить всю нагрузку на резервный udr такая функциональность у нас реализована не только по интерфейсу ud но и по всем тем интерфейсам к внешним системам которые мы используем и мы называем это реализацией F tlb то есть Full tolerance Load balancing то есть способность разбалансированный требований которое предъявляло к нашей системе - это возможность интеграции с новыми типами оборудования либо возможность внедрения новых услуг без перем приложения для того чтобы достигнуть эту цель мы ввели Мета описания на мы ввели метаязык на этом метаязыковая бизнес-услуг и загружает Мета описание когда по протоколам приходят данные они раскладываются ВНО писа на Мета языке и отправляются в лу машину для принятия решения на основании загруженных лу скриптов это всё работает и выходом результатом работы лу машины является PC решение то есть решение о качестве предоставляемых услуг абоненту важно отметить что это может даже работать без мы можем реализовать возможность интеграции с новым типом оборудования новых услуг даже без перегрузки системы для того чтобы это сделать держать функционал когда pcrf поймёт что у нас изменилось Мета описания лу скрипты автоматически их загрузят систему И после этого мы готовы без прерывания сервиса обслуживать и работать с новым типом оборудования Давайте поговорим чуть-чуть поподробнее про реализацию метаязыка реализация метаязык у нас описывает как я сказал либо бизнес сущности либо протокольные сущности он описание этих суно хранится в де файле которая состоит из двух частей это динамическая и статическая часть статическая часть прогоняет через генераторы Вроде я например схожие с яком и антром и формируются PP файлы которые статически Линку ется с писе мам динамическая часть Она загружается в ран тайме в файлах либо Мета языке мы реализовали такую функциональность как наследование динамическое расширение И за счёт этого позволяем И за счёт этого имеем возможность осуществить интеграцию с новым типом оборудования достаточно важно отметить что у нас большой объём кода порядка 10% находится в динамике Ну мы считаем что это достаточно большой объём кода собственно говоря к этому моменту я проговорил все те архитектурные решения которые мы приняли для того чтобы построить нашу систему следующая секция - это дизайнерские решения к дизайнерским решениям относится обеспечение параллельного выполнения задач минимизация единых точек разнесения получения декодирования данных из сети и использования собственных использования собственного менеджера памяти Давайте про каждый из этих пунктов поговорим более подробно параллели зация для того чтобы обеспечить эффективное использование аппаратных возможности машины либо аппаратных возможностей оборудования мы должны поддерживать парализации мы это достигаем следующим образом мы вводим такое понятие как обработчик событий обработчик событий по сути это поток который зада мы рекомендуем выставлять количество обработчиков событий приблизительно равное количеству ядер на машине за счёт этого мы достигаем использование эффективное использование всех ядер когда приходит к нам очередной запрос по протоколу Мы из него вычисляем идентифика уникальный идентификатор абонента в нашем случае это им и по формуле которая здесь написана оде тот ивент процессор который обрабатывает данную задачу таким образом поскольку мки у нас достаточно равномерно размазаны мы равномерно загружаем все ивент процессоры важно сказать что такое задача задача - это сущность которую используют вычислительные возможности машины и не предполагается в этих задачах наличие либо работы с сетью либо с дисковым вводом выводом потому что в этом случае мы будем стоять на ожидании и не будем эффективно использовать вычислительные возможности машины то есть не достигнем хорошей параллели зации следующее требование - это Следующий пункт - это отсутствие точки синхронизации для того чтобы поддержать необходимую производительность у нас в системе есть различные хранилища одна Одно из таких хранилищ это хранилище это кэш в котором хранятся профиля абонента и одна один из возможных вариантов работы с Шом изображён на левой части в этом случае у нас есть единый кэш и каждый ивент процессор лезет каждый обработчик событий лезет в этот кэш для того чтобы получить профиль абонента очевидным образом что бы это работало Нам необходимо синхронизм КС и таким образом мы ухудшая кон для того чтобы избавиться от этой проблемы мы используем подход который избран на правой части слайда а именно мы поделили наше хранилище на сегменты и привязали к каждому ивен процессору свой соответствующий сегмент в качестве хранилищ мы используем сессии абонента и Кэш Мы это можем сделать разделить на сегменты потому что у нас есть уникальный идентификатор абонента и мы знаем В каком обработчике будет использова Данный абонент У нас есть примеры хранилищ с которым поступить так трудно например Это справочники оборудования эти справочники используются в во всех ивент процессорах то есть они должны быть доступны из всех обработчиков и тут необходимо принять решение Первый вариант это вы дублирует информацию в этом случае потребляете больше памяти но увеличиваете скорость Либо вы осуществляете работу через МКС если справочники достаточно маленькие то это тоже имеет право на жизнь Следующий пункт - это декодирование э декодирование протоколов либо работу с сетью один из возможных вариантов работы с сетью изображён на левой ча части слайда предполагается что когда у нас приходит очередной запрос из сети то мы а во-первых получаем его то есть достаём данные из сокета в этом же потоке декодирует вляет ветственно мы получаем даны сети подсматриваем уникальный в нашем случае идентификатор абонента и отправляем для декодирования задачу в один из ивент процессоров у каждого из подхода есть плюс и минусы во втором подходе очевидным образом реализация сложнее и Мы это можем сделать легко поскольку наши протоколы с которыми Мы работаем например Это диаметраль Либо они содержат либо идентификатор абонента либо в самом начале и мы можем легко подсмотреть в том случае если для определения такого идентификатора необходимо декодирование всего пакета целиком то возможно поступить следующим образом снять эти данные отправить задачу на декодирование в любом в любой из ивент процессоров по кругу и когда данные в ивент процессоре декодировать после этого отправить в правильный ивент процессор уже на выполнение собственной задачи надо понимать что у такого подхода есть минус а именно более меже памяти на выделение задачи Следующий пункт о котором бы я хотел поговорить Это менеджер памяти первоначально и на текущий момент мы используем собственный менеджер памяти этот менеджер памяти позволяет нам решать задачу утечки поиска и выявления утечек он хранит всю историю выделенных объектов и истори удаленных объектов Таким образом мы можем легко определить и конкретно тем Вот но в то же время мы понимаем что для систем подобной нашей то есть систем которые активно выделяют память хороший менеджер памяти - это как минимум важно поэтому мы проанализировали несколько менеджере памяти и Сначала мы предъявили к ним требования перед анализом Мы хотим найти такой менеджер памяти который поддержал бы и комфортно себя чувствовал в многопоточного режиме то есть один поток выделяет память отправляет её на выполнение и другой поток освобождает это раз и второе менеджер памяти должен предоставлять нам функциональность в помощи функциональность в поиске утечек памяти мы проанализировали три мы проанализировали несколько менеджер памяти среди них это системный менеджер памяти собственная реализация и библиотека тац мало из осного решения GF Tools мы провели эксперимент а именно выделяли разного количества объём памяти от 128 байтов до 1 Мб на разном количестве потоков идеально и ожидали бы что хороший менеджер памяти обладал бы свойством что у него время выполнения обратно пропорционально количеству потоков это результаты нашего эксперимента результаты нашего эксперимента для объёма памяти 1кб на данном слайде видно что наш менеджер памяти он обозначен жёлтым цветом ведёт себя достаточно хорошо при малом количестве потока но потом теряет эффективность системный менеджер памяти и менеджер памяти целок ТЦ мало эффективно работает при большом количестве потоков при возрастании их более того их природа графика приблизительно одна и та же это связано с тем что они используют так называе каширование на уровне потока то есть когда они выделили Дан некоторый кусочек памяти и этот кусок памяти возвращается обратно Они его не сразу отправляют в пул А некоторый по некоторым алгоритмам хранят его на уровне потока и при повторном выделении памяти они могут запрашивать не у централизованного хранилища памяти а отдавать из данных потоков у нас такой функциональности нету но с другой стороны как вы знаете не системный менеджер памяти ма не предоставляет встроенных включенных по умолчанию возможности для выявления утечки памяти Я знаю что Лок предоставляет возможность включить и дополнительно залоги выделяемые объекты но по умолчанию этого нет соответственно каков итог На текущий момент мы понимаем что эффективный менеджер памяти для нас важен и Он важен для систем подобного вида и Либо мы реализуем тред кэширования на уровне потока в своём менеджер памяти Либо мы будем дополнять некоторые функциональностью которые поможет находить утечки либо системные либо алок это наш результат по поводу менеджера памяти Давайте подведём некоторые итоги выполнения за на этом сде вид требования я их повторю это работа в режиме 24 на 7 отсутствие единой точки отказа масштабирования резервирования геореконструкция достаточно большая и мы должны обеспечить стабильность в стабильность для развития этой системы для того чтобы это достигнуть мы встроили качество разработки в процесс и буквально один слайд тому как у нас осуществляется разработка в том случае если мы осуществляем разработку через tdd то есть СТ ding development то первоначально пишутся Юнит тесты и на неё уже реализуется функциональность В некоторых случаях сразу реализуется функциональность и покрывается Юнит тестами после этого остальные члены команды либо их часть ревью вируюче инструмента ревьюирование мы используем онное решение review board и после того как все замечания устранены эти изменения попадают в хранилище исходных кодов в качестве хранилища исходных кодов мы используем git после этого запускаются автотесты в качестве инструмента автоматического тестирования мы используем орное решение Robot frameworks также у нас есть достаточно большой исторически накопленный багаж тестов который мы запускаем на своём внутреннем на своём внутреннем инструменте проведения автотестов это ru Framework автотесто у нас покрыта большая часть системы если в цифрах то более 70% системы у нас покрыта автотесто После этого мы запускаем нагрузочные тесты которые позволяют идентифицировать определить качество нашего продукта по сути измерение время отклика по интерфейсам на которых мы работаем в том случае если у нас наблюдаются проблемы то мы осуществляем профилирование также у нас есть такое понятие как технический долг То есть то что мы должны то что мы должны были сделать и не сделали по разным причинам иногда это связано с бизнесом иногда мы не успели это сделать для того чтобы выпустить версию конкретному конкретной дате всё это приводит к тому что у нас есть шаг рефакторинг и профилирования который может привести к разработке очередной и таким образом у нас качество встроено в процесс этот цикл у нас реализуется с помощью в качестве мы используем решение дн Кроме тех задач которые перечислены здесь у нас в дженкинс есть дополнительные задачи это измерение покрытие кода Код Мы измеряем после покрытие кода Мы измеряем после Юнит тестов и автотестов также есть встроенная задача определения качества кода с помощью статических анализаторов в качестве статического анализатора мы используем решение C и у оделяет соответствует ли наш код нашему кодинг стай собственно говоря на этой Это Давайте приступим к следующей части истории успеха как я сказал каждая система должна быть инсталлировать чтобы у неё были счастливые пользователи и в этом разделе Я бы хотел поговорить про те инсталляции и возможно этот опыт который мы получили у нас есть три инсталляции это они перечислены на данном слайде в хронологическом порядке первый - это региональный оператор я к сожалению не могу назвать его имя потому что мы не получили подтверждение и согласие на то чтобы назвать его здесь поэтому он присутствует здесь в обезличенном виде второй второе наше внедрение осуществлялось в Войнах телекоме И последнее внедрение одно из последних внедрение это в МегаФоне первое внедрение было Достаточно давно к томен не был реализован метаязык и всё писание Извините вся бизнес логика была реализована в c+ Plus очень быстро мы поняли что это не очень хорошо и с этим что-то надо делать и уже во втором внедрении Войнах Телеком Мы перенесли весь бизнес в ло скрипты и сущности описали с помощью Метаком метаязыка информация внедрени можно найти сылки и заключительной одно из последних наших внедрений - это внедрение в МегаФоне мы обслуживаем 100% трафика Мегафона в семи филиалах во всех филиалах это самая большая наша инсталляция мы инсталлировать немножко уточнить вот udr хранилище вы нарисовали на одном из слайдов Да я тут тоже немножко написал Если не секрет что это за хранилище это ваша разработка или это что-то ещё значит работа с хранилищем ведётся по ID интерфейсу интерфейс специи 3gpp организации соответственно Мы работаем с любым хранилищем которые поддерживает интерфейсу На текущий момент у нас есть две успешных инсталляции две успешных интеграции одна интеграция это да с собственной нашей разработкой которая поддерживает большую скорость и вторая интеграция - это с Льве падом если будет интересно по поводу специфики интеграции то я готов поделиться своим опытом после Хорошо если можно я ещё тут пару штук набросал Вот вы говорили о перегрузке радио в начале презентации что обя связь что если радио в данном каком-то куске сети перегружена то вы об этом знаете да это так значит и это делается следующим образом мы не знаем стандартного интерфейса которые регламентирует 3gpp для того чтобы определить состояние сети поэтому у нас Кроме тех перечисленных интерфейсов есть вендер специфика интерфейса и одна из них один из этих интерфейсов служит для того чтобы определять ру поэтому вендер специфику интерфейса подается информация о том какая Сота перегружена и какой е уровень перегрузки и все абоненты которые обслуживаются на данной соте их качество обслуживания может быть изменено снова с помощью лу ответила на вопрос да спасибо вам большое И вот уже ближе к концу два маленьких если не секрет Нако много строчек на какой-нибудь из инсталляций 20.000 50.000 сейчас давайте сориентируемся приблизительно так я сказал что у нас 10% исходного кода на лу 10% от там 20 Мб составляет соответственно порядка 2 МБ исходного кода у нас налу и В каждой строчке от 80 до 120 символов Ну дальше уже дальше пою СБО извиняюсь подведу ито на самом де файлы достаточно большой объём информации Но это позволяет осуществлять новые интеграции и внедрение новых бизнес-кейс почти на литу понятно И последнее вот немножко не очень понятно в резервации n на 2 про сессии вот я не очень понял вот если сессии хранятся в главе в главе C pccm модуля то если вот он этот процесс завершился там что-то случилось с машиной данные А вот gxx сессии они потерялись сгорели или они где-то пря нет как я уже сказал на слайде не было горизонтальной связи между писма но обмен этой информации осуществлялся через дра то есть дра используется как узел который передаёт информацию между письмами в одной группе Ага То есть мы не стали внедрять новое горизонтальную связь мы использовали стандартный протокол и возможность его расширения это диаметральный протокол GX для того чтобы передавать состояние сессии ответил на вопрос или не очень не очень ну вот запрос начал обрабатываться там iccr потом потерялся запрос первоначально приходит на дра дра назначает ту систему которая является мастером и ту систему которая является слейм она обоим говорит о том что вот вы мастер вы мастер вы как бы слей после этого эта сессия даёт некоторый ответ и дра дублирует на вторую систему При следующем приходе таким образом то есть явно нету горизонтального обмена так углом Так есть да это решение подход имеет плюсы и минусы оно дискутировать мы осознали что оно нам подходит больше всего мы его реализовали понял я не очень помню три ГПП какой-то есть Стандарт на эту тему что-то Мне кажется дра он какой-то был тонкова на эту тему в стандартах Ну дра по-прежнему у нас не хранит Никакое состояние то есть дра это сй да име виду в само работает как прок в самом диаметром прокси протоколе вот такой функциональность Как вы описали обратный ответ продублировать слову такого я не очень помню это вы наверное сами придумали мы не дублируем обратно ответа при приходе следующего запрос этот контекст передаём и на второй м То есть у нас тут нету отступления от стандарта Я не хочу никуда наехать я имею в виду сгорел вот этот допустим первый узел его данные о той сессии кото Вась они все не потеряются заказчик делает вам какие-то кейсы Да и вы как-то это правите как вот этот вопрос решили и на чём если не секрет Сейчас подумаю секундочку во-первых У нас есть возможность pcf запускать отдельных абонентов на отдельной лу виртуальной машине то есть весь основной поток идёт на одну виртуальную машину по мку либо пону заворачивается Абонент на другую виртуальную машину за счёт этого предоставляется интерфейс точнее предоставляется возможность обкатываю услуг дальше На текущий момент услуги заказываются у нашей компании мы разрабатываем их и внедряем с очередной версии но наша цель предоставить оператору возможность рисовать эти услуги в графическом интерфейсе и на текущий момент мы работаем над формализации построения и после того как мы это решим то будет гуи конструктор который позволяет что-то там двигать и строить бизнес-услуги ответила на вопрос да спасибо спасибо большое за вопрос Спасибо большое за выступление подскажите пожалуйста с точки зрения техники какую какую сбд и какой движок для хранение ов вы используете Значит сбд мы не используем никакой потому что нам необходимо обеспечить высокую скорость та тот кэш и можно сказать что это in Memory deb написан самописная никакую СУБД это прежде всего связано с вопросами производительности касаемо Лога На текущий момент мы используем опять-таки самописец диазон и в качестве первого кандидата который мы рассматриваем это сисло прежде всего это связано с тем что как правило у оператора инфраструктура и он использует силок либо его разновидность и настроенное оповещение поэтому мы на текущий момент используем только своё логирование но планируем поддержать диапазон исло первый кандидат Ясно спасибо большое спасибо большое ворам Спасибо за доклад Вот вы упомяну для операторов большой Трой Ну не секрет кто эти конечно же операторы но привели Вы только одного и также вы упомянули что для описания бизнес логики у вас используются виртуальные машины это значит То что для всех трёх операторов стоит одно оборудование разделённое в виртуальном пространстве и собственно только лишь реализует бизнес логику Можно я с первой части начну я сказал что компания - это компания которая став которая инсталлировать но я не сказал что pcrf там везде инсталлировать опыт внедрения только в МегаФон Вот это ответ на первую часть вопроса А можно повторить вторую а вторая вторая часть вы сказали что у вас для ло используется для писания для поддержания бизнес логики используется виртуальное пространство Ну виртуально машины выполнения то есть не скажем на одном оборудовании в можем обрабатывать поскольку виртуальные машины Мы можем обрабатывать несколько представителей связи для Е соответственно с их запросами и их их биллинга у нас нету такой Я не встречал такую задачу и у нас нету Если я правильно понял вопрос Вы говорите О том чтобы мы поставили pcrf на который бы который бы работал для нескольких операторов правильно я понял и на разных виртуальных машинах бизнес-услуги для конкретного оператора Ну отчасти Но меня интересует именно что использует ли они это именно так нету инсталляции когда операторы с кем-то делят pcrf То есть все операторы покупают собственный pcf и используют его спасибо если я не правильно понял вопрос Я предлагаю в кулуарах пообщаться Может быть я отвечу более Тол Спасибо большое за вопрос ещё такой вопрос здесь про парсинг диаметра Вот вы говорили что вы имс всегда достаёт Да и ещё было интересно Действительно ли у вас сообщения диаметров ские всегда имеют одну и ту же структуру Что вы так легко можете им там ну этот найти там насколько я понимаю subscription ID subscription ID Type subscription ID Data и все эти надо вы парсить То есть как это на самом деле происходит у вас пре парсинг какой-то Ну вот я сказал что это весь смысл в алгоритмах lookup в 3gpp спецификации У вас есть header потом идёт Session ID которые определённое место и subscription ID вот нужно определить этот subscription ID Определить если там им его там может и не быть если он там есть то использовать его для вычисления ивент процессора отправлять туда пакет уже для полного декодирования а сообщения раз не различаются достаточно сильно там Ну у вас всегда один и тот же сдвиг грубо говоря Ну грубо говоря да они отличаются значит они специфика из интерфейса по которому мы работаем GX он специфик этот мзк А вот при при интеграции Вот вы говорили с разными там Huawei железками и так далее у вас разве не возникает проблем когда всё там по-разному все нюансы Кстати у вас этот парсинг в находится или всё-таки в основной части не парсинг находится в c+ Plus но он парсит в сущности которые описаны на Мета языке для того чтобы влу мог оперировать с этими сущностями значит касаемо интеграции с различными производителями во-первых есть 3gpp стандарт и если кто-то не соответствует 3gpp стандарту то он должен исправить это раз а то есть вы так относитесь Нет мы не так относимся мы просто просим уважительного отношение к нам значит расширение 3gpp Стандарт он регламентирует места в которых можно расширять это там абстракт ВП в диаметральный протоколах соответственно это те места где и предполагается расширение Они находятся в конце пакета то есть они не мешают вычленять вот этот мюк то есть смысл того что мзк находится в начале и позволяет более Ну позволяет лу сделать понятно И второй вопрос Если можно вот нач дра которая вы привязали же сессию к определённому вашему вот этому процессу забыл как он называется pccm Да да вот и затем вам надо отправлять всё что касается этой сессии туда же обратно правильно есть два способа Либо мы можем привязывать в этом случае мы будем хранить Либо мы можем опять-таки вычислять каждый раз допустим на основании МКА на основании мюк деления по модулю мы можем Предста придумать функцию которая будет вычислять это наш подход то есть мы не храним то куда мы отправили Мы каждый раз берм из диаметрального пакета там некоторый кусочек информации определяем куда надо отправить А Понятно Потому что сессия одного юзера естественно будет всё равно на Ну это будет как мастер да спасибо большо за вопро Здравствуйте спасибо за ваш доклад очень интересный А у меня такой вопрос даже наверное два коротеньких во-первых не является ли бизнес логика написанная на лу узким местом при обработке запроса И второй вопрос Это Если я правильно понял то фактически у вас получается что сессия абонента обрабатывается на каком-то определённом узле на каком-то определённом ивен треде и так далее значит и в этом случае как вы боретесь с с неравномерной загрузкой вот отдельных нодов идов Давайте Спасибо большое за вопросы первый вопрос рипт занимает достаточно большой объём кода и время выполнения его в принятии P решения составляет порядка 70% Да так есть но мы мы оптимизируем ло мы данные которые возможно ширу мы избегаем всех копирования данных то есть мы можем мы делаем всё то что необходим что можем сделать как технические специалисты мы проводим инспекции скриптов но мы понимаем что это приняти все решения - это по сути Наша задача всё остальное является вспомогательным мы получили пакет собрали пакет и отдали в PC А бизнес решение принимает лу Да это дольше всего Но тем не менее производительность узла хватает а И второй вопрос Повторите пожалуйста а либо я сейчас скажу правильно ли я услышал что как мы боремся с равномерным распределением по ивент процессорам неравно неравномерным Да да я ещё раз повторю Дело в том что если вы э вычисляется постоянно непосредственно ноду на где абонент и где абонент обсчитывают да то вы фактически всю информацию Ну отправляете на один мастер да Ну один Мастер и один слей там нет когда Ну affinity у вас получается сервер affinity Session affinity У нас есть разделение на группы пис семов и соответственно Когда нам приходит мзк мы его делим на модуль определяем какой группе отправлять После этого мы отправляем эту сессию в данную группу поскольку запрос первоначальные запросы они достаточно распределение мзк достаточно Случайно у нас получается равномерное распределение То есть у нас нету такой ситуации что все абоненты в реальности в продакшн пришли на одну м группу они равномерно распределены между всем оборудованием причина В этом заключается в том что имю можно счита рассматривать их как случайные числа и они равномерно распределены ответила на вопрос А да но внутри одной группы у вас как обработка одного абонента идёт на всех нода сразу же Ну то есть пришёл новый пакет и он он следующий пакет попадёт на тот же самый обработчик или на другой внутри одной писем группы У нас есть два писма и сессия продолжается на одном из этих пив как мастер на втором как слей соответственно когда PC уже получил данный пакет то он должен определить тот ивент процессор где он обрабатывает и это снова осуществляется на основании имю имка и таким образом По той же самой причине достигается равномерное распределение между уже ивент процессорами внутри одного писма а распределени в группе Кто является мам является отличным Если я сейчас не вру Но вот предлагаю после задать вопросы мне коллеги подскажут Ну спасибо большое за ваш ответ Угу Пожалуйста Здравствуйте спасибо за доклад и особенно за ответы что с виртуализацией с динамическим скела аутом работаете Судя потому что слова мне это незнакомые либо я их не понимаю Либо мы не работаем nfv nfv от вас не требует никто Network function virtualization Я всё тогда Спасибо Судя по всему никак вас не просят на виртуалке вставать и расширяться динамически класть расширять сессии перекидывать и прочее наши заказчики насколько я знаю периодически проводят такие эксперименты они разворачивают нас мы как бы типа против пока ещё не очень аргументировано Но именно требование что должно быть так и мы бы проводили эксперименты такого мы не делали Артём ещё есть вопрос один прилетает запрос допустим с pcf Да ну по GX Да мы его обрабатываем лу обработал всё здорово ответ также улетает по GX или у вас ещё есть какой-то Ну диаметр протокол да то есть там gy или ещё что-то или всё вот общение с внешними системами только GX нет общение с внешними системами осуществляется по тем интерфейсам которые были нарисованы То есть это GX для управления для взаимодействия с pcf для взаимодействия сфом там с тдф и вот много протоколов соответственно запрос приходит по какому-то протоколу мы по этому же протоколу отдаём ему ответ Ну то есть всё допустим вот от инита сессии да потом о репорте трафика то есть в всё вот то что с PC общается по у нас были внедрения когда мы подняли GX частью на то есть осуществляли с обмен Поу такой у нас опыт был но это не согласно спецификации Спасибо большое за вопрос Добрый день а используете ли вы шар по сабскрайб скрабером Вы можете положить в оперативную память одного процесса по текущей архитектуре держать в памяти данные о всех сабскрайберы о кэше то что в презентации называлось кэш абонентов я должен держать всех абонентов в кэше каждого процесса нет нам это не нужно потому что ещё раз когда приходит запрос по протоколу У нас есть уникальный идентификатор абонента от него там модуль тратата и определяем тот ивент процессор и помещаем его этот ивент процессор эту задачу соответственно после GX пакета в процессе его обработки осуществляется запрос профиль абонента и он помещается в сегмент данных который обрабатывается данным ивент процессором и он никогда не попадёт в другой То есть у вас данные загружаются видимо с диска Ну они загружаются с как говори репозиторий с базы они загружаются по необходимости дальше мы их помещаем в кэш у нас кэш имеет мягкое жёсткое ограничение он постепенно вымывается Да мы понимаем что всю абонентскую базу даже распределив пон процессор мы не в состоянии но у нас есть алгоритмы Сколько время мы храним каким образом мы вымывает и так далее вот мы храним необходимый нам объём информации для того чтобы производительность понятно что если мы будем хранить 100% то это быстрее всего но практика показывает что это не нужно И второй вопрос по таймера я правильно понимаю что вы информацию о таймера реплицируемый но в случае переключения он может начать их посылать То есть вы должны всё-таки как-то информацию о некоторых настроечные параметры которые есть у каждого узла то есть есть у дра есть ус настроечные параметры они должны быть согласованы для того чтобы это более Легко делать у нас реализован веб-интерфейс который в ближайших версиях планируется автоматизировать процесс изменения конфигурации по всем узлам но ответ заключается в том что настройки всех параметров у этой систе должны быть согласованы не я имею в виду таймер на внутри сессии У меня например таймеры же есть А что значит таймер внутри сессии что через которое это время По истечению которого дра либо писем должен дать ответ когда приходит запрос на дра то дра к примеру может взвести таймер спрошу по-другому у вас есть тайм bas политики У нас есть например ночью Ночью скорость выше или в выходные дни и мы должны совестно pcf уведомить о том что всё Халява кончилась Ну соответственно в 3GP спецификации есть такое понятие как ration Timeout и когда к нам приходит очередной запрос мы можем установить время когда на По истечению которого внешняя система должна послать То есть арами вы не пользуетесь я вот этот термин не очень знаю мы requ а Рами Рами мы пользуемся request мы используем для следующих причин если у нас допустим поменяли во внешни системах либо пришла нотификация которая изменила что-то в решение то мы посылаем ры Да рамы пользуемся но я просто ры используем Согласно спецификации То есть если решение изменило по каким-то изменилось по каким-то причинам подключилась финансовая блокировка у абонента отключилась поменялся тарифный план зашла в состояние перегрузки Да мы посылаем ры В некоторых случаях мы посылаем ра ответ такой и ещё вопрос а не является ли в вашем решении узким местом поскольку через него идёт и трафик и репликация и всё это через один процесс Ну вот теми свойствами которые должен обладать дра Они были озвучены это скорость за счёт простоты То есть это прокси по сути поскольку мы там не декоди пакеты только делаем который необходи нам на текущий момент производить а вы оценивали какой у вас максимальный размер кластера может быть Сколько за одним может стоять но давайте мы перенесём потому что вот мне коллеги на самом деле помогут более квалифицированно ответить Спасибо большое за вопрос Добрый день спасибо за заклад е Вот вопрос по поводу вки Вопрос такой вы сами бизнес логику пишете или вы даёте там заказчику руками как-то поковыряться вот у меня встречный вопрос Если бы вы были заказчиком вы бы захотели писать бизнес логику Ну есть такие заказчики которые хотят это сделать если они хотят они могут это делать У нас есть отдельная тестовая виртуальная машина лу встроенная внутри писем на котором они смогут тестировать свою бизнес логику но мы предлагаем консалтинговые услуги Мы предлагаем по написанию лу по инспекции и так далее понятно То есть финальное делать какую-то ревизию Да этого кода у нас был небольшой набор Ну у нас был набор инсталляций И во всех этих инсталляция фактически мы получали бизнес-кейс и самостоятельно писали лу У нас не было реально опыта работы в котором бы кастомер сами бы писали наши бы заказчики самы писали лу такое пожелание высказывалось Но как правило это сопровождалось тем что Дайте нам пожалуйста р в котором мы сможем двигать кубики и получать бизнес-услуги на текущий момент это в разработке когда это появится Вот если у нас будет опыт Я с удовольствием поделюсь Ясно спасибо спасибо большое за вопрос L"
}