{
  "video_id": "HlKijvTa_h0",
  "channel": "HighLoadChannel",
  "title": "Отрисовать за 16 мс / Глеб Михеев (Beta Digital Production)",
  "views": 3303,
  "duration": 2960,
  "published": "2017-04-22T14:48:16-07:00",
  "text": "Всем привет Я Михеев Глеб технический директор Beta Digital Production И сегодня я вам расскажу о том как сейчас секунду вот если есть свободное место сдвигаясь в эту сторону хотя бы хотя бы так Если не хотите пересаживаться всё Извини продолжай ничего ничего И сегодня я вам расскажу о том как добиться высокой производительности в интерфейсах и анимациях Но прежде Давайте поговорим об обратной стороне производительности о лагах Что такое лаги этим словом называют всё что не устраивает польс в работе программы или игры если быть точным лаг - это задержка между действием и ожидаемым результатом Какие лаги бывают наиболее Часто мы с вами встречаемся со следующими проблемами анимация идёт рывками подр страница при скролле интерфейс виснет при изменениях на странице например при добавлении новой порции товаров в конец списка Ну и конечно блокировка экранов при явной фоновых вычислениях а почему они нас раздражают В чём причина негативной реакции при восприятии первая группа раздражает нас из-за потери ощущения постоянства движения для простоты плавности анимации наше с вами зрение имеет эффект который называется инерция зрения для любителей красивых терминов персистенция зрения Я думаю вы уже догадались О чём речь этот термин обозначает эффект при котором быстро смеющаяся картинка при принимается нашим мозгом за плавное движение Как видите на подобранной мной анимации не очень создаётся это ощущение Почему вторая группа нас раздражает из-за неоправданного долгого ожидания из-за той самой задержки между действиями и результатом причём Чем сильнее задержка темне приятнее пользоваться этим интерфейсом Давайте перефразируя Первое - Это медленный отклик интерфейса а вторая - это недостаточно быстрая смена кадров может быть виноват в этом браузер забраться что он думает по этому поводу для начала стоит сказать что обычный бытовой монитор обновляет изображение в среднем 60 раз в секунду также весь сов который мы пользуемся при отрисовке изменений синхронизирует цикл отрисовки с частотой обновления монитора То есть это получается что на каждый кадр В среднем у нас приходится примерно 16 миллисекунд хочу заметить что применимы к частоте обновления экрана и всем производном Я произношу слово в среднем так как реальная частота колеблется от монитора блока питания и напряжения вы никогда не получите чистых 60 кадров в секунду вы будете плавать где-то там Ладно поехали дальше Итак если программа не успевает отрисовать кадр то По истечению 16 миллисекунд она покажет предыдущий кадр и продолжит отрисовывать ваш длинный кадр этот бедный мужик Явный тому пример отри Ура Итак разуме поработает у наш с вами браузер То есть получается что фризы и рваные анимации которые мы ругали - это не что иное как продукт долгой прорисовки кадра и сорвано дедлайна по поставке обновлённого кадра к пользователю на экран Итак чтобы обеспечить плавную анимацию нам нужно первое отрисовать примерно 60 кадров в секунду и следователя при такой частоте мы должны уложиться примерно в 16 мсн иначе браузер покажет старый кадр Что значит отрисовать что такое отрисовка отрисовка - это процесс визуализации вашего HTML и CSS в конечную картинку на с последующей передачей её на экран отрисовка состоит из пяти основных стадий Давайте разберёмся что это за стадии как роль каждый из них исполняет первая стадия это парсинг разметки стилей по ним создаются две модели данных дом и CSS первая модель данных содержит дерево всех элементах присутствующих в вашем HTML вторая дерево всех селекторов вторая же модель содержит дерево всех селекторов с их стилями а также наследуемые свойства родителей к примеру можете посмотреть на H1 заголовок он наследовал нса от но потом его переписал в 46 пикселей Обратите внимание что на диаграмме с ССО присутствуют только те стили которые были у нас в с файле на самом деле в не всл быть ли элементов по умолчанию это те самы ли которые для каждого браузера сво разли которые мы сбрасываем при помощи Normal CSS далее оба дер передаются по конвейеру дальше вторая стадия конвейера - это расчёт стилей на этой стадии на дом элемента накладываются стили в соответствии с CSS селектора из правого дерева а также пропускаются элементы которые были скрыты через в результате нас строится так называемый render 3 это то дерево с которого действительно уже будет рисоваться страница То есть если у вас есть много элементов скрыты пле то они не будут присутствовать в этом дере пока мы явно их пока мы явно не уберём пле третья стадия - это расчёт макета после того как render 3 пришло в эту стадию наша здесь задача вычислить геометрическую форму объектов и подготовить блочную модель отображающую положение размер каждого из элементов на экране четвёртая стадия - это визуализация на этой стадии браузер непосредственно рисует пиксели он заполняет фоны прорисовывается и пятая последняя стадия - это самая магическая стадия всего этого процесса к ней мы вернёмся чуть позже так как её имеет смысл обсуждать только в контексте обновления изображения Итак Какие стадии мы теперь знаем Первое - это парсинг сырого htm CS кода в объектной модели вторая вычисление стилей и подготовка единой объектной модели для дальнейшей работы расчёт геометрии документа заполнение этой геометрии пикселями Ну и конечно наша магическая штука компоновка с процес с процессом отрисовки Всё ясно но наше веб-приложение Живёт во времени пользу с ним взаимодействует Да и машина тоже не простая зазря След это у нас происходит изменения в документе так как же происходит отрисовка этих изменений мы понимаем как оно рисуется но нам сейчас при разобраться с тем как мы будем изменять Этот документ в целом изменения бывают нескольких типов и влекут свой разный объём работы Сейчас мы с вами эти типы проговори тип отличается по глубине инвалида первый тип перерисовка происходит в случае когда структура документа и геометрия остатся без изменений А мы меняем свойства отвечающие за цвет текста цвет фона заменяем картинку на бэкграундер Но кроме этого изменяется свойство макета например высота какого-то блока что полностью сбрасывает ранее рассчитанный макет в документе и его приходится рассчитать снова собственно но как же тог делать анимации то есть мы понимаем то что постоянно перерисовки расчёта макет - это медленно и трудно затратно ВС бегает на процессоре Вот был бы способ раздеть страницу слои Чтобы избежать полной инвалидация макета и полной перерисовки всей страницы а вообще по-хорошему бы ещё эти макеты потом слои Простите можно было бы ещё и двигать между собой применять им матричные трансформации поворачивать давать им прозрачность убирать прозрачность вот собственно Этот способ есть это тот самый магический способ представленный в конвейере как компоновка слоёв Итак В чём заключается магия компоновки на самом-то деле браузер выносит некоторые блоки в отдельные слои разделяя рендеринг страницы с цельного на послойный и держит всё памяти наиболее близкая нам аналогия - это слои Фотошопе а в браузере они как и в Фотошопе имеют свой индекс могут изменяться без перерасчёта всего документа также к этим слоям могут применяться матричные трансформации Ну и конечно тоже прозрачность и теперь самый главный бонус трансформации считаются на видеокарте Ну и конечно Наша радость была бы тоже не полна бы из этого последнего пункта если бы они при этом бы ещё и э не клеили между собой тоже на видеокарте Итак вот как выглядит мобильная версия сайта второго агура а вот как она выглядит в слоях Я конечно же не сдержался и добавил пару свойств чтобы браузер вынес в слои ещ и логотипы спином для большего эффекта Как вы видите все элементы по своим слоям их можно крутить и вертеть как душе угодно и при этом не будет перерисовывать макет можем эре ви з теперь больше нет места магии это как раз ответ на вопрос почему Например страница с фиксированным заголовком на мобильном устройстве так хорошо и плавно скро потому что как вы видите Сам хедер он висит отдельно отдельно висит вся страница Если бы я бы полностью показал бы вот эту модель со слоями то здесь была бы ещё колбаса на 45 экранов вниз уже заранее отрисовать слои поэтому у нас получаются такие супер плавные анимации шикарные так собственно вот магия и пропала Так что теперь в спис изменений в документе самый последний самый производительный и предпочтительный тип изменений это компоновка слоёв теперь при изменении свойств компоновки у нас отрабатывает только расчёт стиле и сама компоновка это происходит супер быстро Хочу уточнить что свойство компоновки - это трансформация и апати всё всё остальное дёргает либо макет либо свойство отображения в целом в целом можно считать что компо вообще не занимает времени кстати Обратите внимание что я в repaint и reflow также добавил компоновку которая До этого была отключена Дело в том что документ сам по себе представляет уже слой и поэтому Даже если мы не добавили х дополнительных слоёв в документ у нас всё есть первый слой который проходит компоновку Итак да давайте закрепим первое для того чтобы гарантированно вынести элемент в слой нам нужно дать ему свойство Will change это свойство сигнализирует браузеру что мы будем изменять этот элемент и поэтому он его заранее вынесет в отдельный слой и подготовится к изменениям также в старых браузерах по старинке мы делали это следующим образом устанавливали C свойства значением или 3D и тогда в этот момент браузер выносил всё в отдельный слой забавный факт Кстати что анимации будет применяться к слам даже если вы заблокирует всего конвейера и он кажется рисовать вам новые ра исполнять код также на предыдущем слайде Я сказал что компоновка практически не занимает время но это не до Кон правда но когда их много вся польза их сходит на нет поэтому контролируйте количество слоёв перемещайте на них только те элементы которые необходимо вынести в отдельный слой также не забывайте что ва ваш интерфейс Живёт во времени если отыграла какая-то анимация то нужно с собой прибраться и убирайте э элементы слоёв Не держите их в слоях потому что наступит момент когда у вас заполнится память и начнутся проблемы Ну и напоследок хинт Если вы дали слою опас ноль то на самом деле он продолжает висеть И заметь память и для того чтобы выгрузить вот этот большой битм к примеру допустим это Например экран там 1 на 1000 там 24 Да и это огромная какая-нибудь картинка на фоне она может занимать там порядка 15-20 Мб в памяти мы дали опас но думаю такие Ну всё её нет ну как бы я её не вижу значит нет враньё на самом деле При этом она продолжает присутствовать в памяти потому что как бы браузер ожидает то что ты ему лишь скрыл прозрачность скоро вернёшь обратно или сделать что-то ещё поэтому он его не выгружает для того чтобы вычистить это из памяти Дайте сло в этот момент он выгрузил всё из памяти но этот слой по-прежнему останется слоем он не перейдёт в в основной Документ и когда вы уберёте visibility hidden Он снова рисует эту картинку вы сможете с ней работать кстати ещё касаемо этого хинта если вы используете кто-нибудь рисок то присмотритесь к свойству автоальфа как раз он реализует подобную механику и теперь немного практики перейдём к кейсам Спасибо Давайте вживую посмотрим как работают эти перерисовки начнём с самое простое с репета Но прежде чем я вам покажу Я хочу чтобы показать вам одну хорошую штуку в Tools есть две крайне удобные настройки для этого нужно зайти в меню выбрать Tools и нажать перр две галочки это пер первая галочка отвечает за то что она показывает перерисовки то есть если в прошлом кадре что-то было перерисовал этого будет нарисован зелёный квадрат и и вторая галочка она показывает слои которые уже сейчас в данный момент существуют Но поскольку у нас нету наших собственных слоёв то единственный здесь слой - это слой документа и вот он у нас в Да ещё сразу ещ говорится что в данном случае я использую только CSS анимации поэтому примеры будут без JavaScript кода в таймлайне Итак смотрите здесь у нас есть кружочек у которого плано меняется цвет фона собственно Давайте запишем Тайлан как он выглядит вот мы смотрим отрисовку одного кадра Как видим главный происходят все изменения все расчёты стилей исполняются JavaScript был занят работой о ниже во вкладок eventlog мы можем детально посмотреть какой работой он конкретно был занят Как видно из Лога А тут прошёл перерасчёт стилей обновление геометрии после этого Отработал отрисовщик и прошла компоновка а отрисовка одного кадра у нас заняла 47 47 миллисекунды теперь посмотрим то же самое но добавим ещё перерасчёт макета А здесь я добавил анимацию ширины и высоты чтобы этот кружочек чуть-чуть дышал И тем самым генерировать перерисовка макета делаем запись и смотрим на объём работ который выполнен браузер в целом всё то же самое но только появился ещё один новый блочок собственно вот это вот леутин это пересчёт лейауты потому что у нас изменился размер блока он тригер изменение размера самого документа потому что как вы знаете что если в этот блок на поместить 10.000 там символов он ещ сильно вниз документ должен стать больше Поэтому он триггерит перерасчёт макета вот также общее процессорное время Который было потрачено на отрисовку кадра увеличилась и составил уже 65 миллисекунды на 18 больше чем в прошлый раз А теперь мы эту же самую анимацию с помощи трансформаций Я заменил изменение высоты и ширины на Скейл после чего Круг Был вынесен браузером в отдельный слой и получил золотистую обводок Вот она вот она наша родимая А давайте теперь посмотрим как он ведёт себя в таймлайне Давайте вот он тут дышит как вы видите уже нет никаких зелёных штучек пропала перерисовка приближаем сам кадр Смотрим А работы-то И нет там Нет вообще в тред вообще в целом отсутствует работа не куда-то пропала это что опять магия собственно Помните я вам говорил что ЦСС анимации могут проигрывать при полностью заблокированном трейде Это был частный случай наблюдаемого нами поведения в чём идея в отличие от непредсказуемых для браузера JavaScript анимаций CSS анимации и анимации при при помощи Web Animation ipi объявлены заранее и от начала до конца проходит внутри самого движка браузера без использ Ja машины Именно поэтому браузер Может их делегировать в соседний тред и исполнить параллельно вне основного треда то есть собственно мы распараллеливания вчера мы расли расчёты А сегодня мы расли анимации Вот почему при блокировании у нас всё продолжает работать собственно Так что никакая это не магия Кстати это хороший способ резко повысить производите вашего мобильного устройства пригнитесь к тому как библиотеке наподобии Реут на мобильных девайсах и почему он не лагает он не лагает как раз именно по этой самой причине потому что он происходит отдельно и пока M в полном локе занято отрисовывать вам кадр напряжение половины секунды с анимации спокойно продолжают там дышать работать и в итоге по получает хороший экспириенс и ещё одна вещь Я хочу привести ещё один пример это досрочная инвалидация Это самый гадкий антипаттерн при анимациях под управлением изва скрипта на в данном примере у нас есть 200 блоков на странице вот этих вот красненький сладеньких квадратиков и мы хотим чтобы каждый кадр их высота увеличилась на один пиксель антипаттерн заключается в том что если мы считываем размер блока и потом добавляем к нему плюс о пиксель опустим Давайте просто посмотрим как это работает не очень бодренько собственно посмотрим млайн у нас Mad вообще не отпускает он нон-стоп работает а отрисовка одного кадра занимает 98 миллисекунд это крайне много при наших целевых 16 это вообще полностью неприемлемо А самое интересное Мы видим что у нас тут ну просто ну очень много это забор из маленьких-маленьких перерасчётом макета Почему они помечены красным потому что как раз это антипаттерн это плохо Вот О чём нам говорит браузер А давайте детально разберём Что происходило и что привело к этому результату А с чего всё начинается мы начинаем обходить в цикле все 200 элементов на странице А мы приступаем к коротке первого элемента и спрашиваем него высоту она читается из рассчитанной ранее в прошлом кадре геометрии самой модели макета после мы устанавливаем ему новое значение увеличиваем на один пиксель устанавливаем новое значение чем инвалиди всю ранее рассчитанную модель потом мы берёмся за следующий элемент и говорим ему элемент элемента Какая у тебя высота элемент не знает Потому что предыдущий рассчитанный макет он инвалиди и браузер понимает что он не может дождаться там пока закончи JavaScript и потом лениво всё посчитать отрисовать и собственно вывести на экран а ему нужно прямо вот сейчас срочно вы до полож и он досрочно рассчитывает макет узнаёт что всё-таки да у тебя 20 пикселей а даёт нам обратно это дело в JavaScript а Итак Ну уже 199 Да вот в общем потом мы берм следующий элемент и снова и снова и снова и получается вот та самая большая расчёска которую вы видели собственно в итоге мы получаем одну перерисовка от которой не избежать и 199 досрочных пересох просто потому что мы нормально не подумали А собственно теперь нам не удивительно почему это заняло целые 100 миллисекунд Итак Теперь мы понимаем откуда растут ноги так что давайте исправим наш код так чтобы он не вызвал досрочных рисовок Для этого нам достаточно разделить цикл чтения начте запись что я здесь и сделал в этом примере я использую библиотеку кото называется еци сводится к тому что мы можем передать функции которые будут исполнены при чтении и при записи тем самым разделить работу с дом на два этапа что что нам это даёт на первом этапе мы проводим 200 чтений из уже заранее рассчитанной за Каширова геометрии документа После этого мы изво ВМ Измени в момен Как вы уже догадались после этого происходит только одна перерисовка Давайте посмотрим как это выглядит всё супер плавне посмотрим на Тайлан интернет отпустила Да присут нагрузка она Крайне мала Мы у нас все кадры зелёненькие все КАД успевают того 4С против 100 что было собственно это вот почему этот паттерн настолько плохой Это получается где-то на 25 раз быстрее чем мой прошлый пример Ну что ж если всё это хорошо то Давайте повысим ставки и увеличим количество элементов в 10 раз и посмотрим как это быстро рендерится в целом также достаточно бодренько Давайте посмотрим чуть внимательней что нам покажет наш таймлайны не успеваем да уже M в целом замкнул он полностью занят своей работой но при этом всё равно наш кадр остаётся в рамках 22-24 миллисекунд что в целом достаточно приемлемо Вот это при том что мы увеличили количество элементов на 10 раз то есть получается что при плохом подходе у нас 200 элементов считалось 100 миллисекунд при хорошем подходе у нас 2.000 элементов считается в пять раз быстрее вот к слову в целом есть ещё и третий вариант как это можно было можно было вообще не читать размер из документа просто сделать и который с каждым новым циклом бы добавлял плюс о Но я этого не добавил презентацию потому что то на то выходит никакого смысла в этом нет Что там мы ничего не считаем что здесь мы ничего не считаем Итак что мы вынесли из этих примеров первое нам стоит избегать пересос в макете особено при анимациях потому дож работать на стадии компоновки третье CSS анимации и анимация при помощи Web Animation ipi работают ультрабыстрый тред третье Ja анимации в целом они дороже Но но не значит что они хуже потому что их и их минус в том что их нельзя вывести в отдельный тред так как они не предсказуем со стороны движка браузера И он не может предсказать что будет происходить ему приходится каждый раз по новой сталкиваться с новыми стилям которые вы их ему даёте как-то их обрабатывать Вот но у них есть масса других преимуществ таких как сложные таймлайны гарантированные Крос браузера с полный контроль за исполнением можно комбинировать их по-всякому анимировать данные при этом использовать переменные окружений куча всего так что не отказывайтесь от них Но помните об альтернатива также избегайте досрочных перерасчётом и перерисовать себя даже если А даже если у вас на компе нету видимых лагов проверяйте в талай смотрите Что вы делаете потому что никто вам не гарантирует что девайс послабее тоже мобильный телефончик особенно средненький прож эти перерисовки в рамках 16 миллисекунд Ну и естественно не грейте атмосферу зазря вот также я ещ хочу отметить то что есть очень удобный способ синхронизировать свой код точ синхронизировать свой цикл изменим с брот на этом Я закончил получилось очень быстро Всем спасибо ваши вопросы нет в микрофон хорошо Скажите пожалуйста есть какие-нибудь советы для тех случаев когда нам с бэнда приходит очень много данных парсинг Джейсона может занимать там 10 кадров а от парси его например в ворке Также вы видите в отдельный процесс либо Например можно как-то это всё частями например парсить допустим да ну то есть тут можно по-разному поступить Угу Ну в принципе да то есть либо мы выносим получается из основного треда либо бьём на микро таски и считаем каждую то мы можем как-то это обработать циклично либо можем разбить ещё на уровень самого вывода уже переда здравствуйте Я вот заметил что вот на сайте с адаптивной вёрст и с обычной вёрст Хотя он выглядит одинаково адаптивная почему-то Ну отрисовывать намного медленнее почему так происходит а потому что у нас намного более слабенький процессор и видеокарта в целом то есть все мобильные устройства они расчитаны на то чтобы работать долго и потреблять мало энергии То есть у них другая немножко цель поэтому на них всё работа намного медленней и это это реально главная причина этот у них меньше памяти она медленнее работает нет тут имеется в виду именно на компьютере когда смотришь Ну то есть ты сначала делаешь например блоки с определённой заданной высотой там например каждый блок там 100 пикселей а потом делаешь адаптивную вёрстку они получаются те же 100 пикселей да Но если как бы вёрстку сужать то она получается там ну как бы растягивается как блоки растягиваются получается что ко адаптивная она получается загружается почему-то медленнее отрисовывать это вот Собственно сам объём отрисовки возможно например сложность расчёта самого йу То есть йу можно сделать по-разному можно сделать какими-то быстрыми фиксированными способами А можно такого ть что сам расчёт Лаута в целом он может занять все 16 кадров в секунду и можно и больше сду можно много чего сломать и поэтому может быть из-за этого это может происходить а в целом надо смотреть на конкретный кейс Потому что от кейса к кейсу Вот либо может быть Например у вас там включен Лин CPU недавно такую штуку добавили в de Tools можно его прижать к земле он будет еле ползать и медленно работать вот тоже наме Как вариант а так доста просто открыть маленькую верси большую версию и плюс-минус станет Хотя Понятно Куда копать потом можно срезать лишнего сделать более чистый тест Да кото меньше за окружение которое не будет себя путать не будет ну и в целом В общем такой инкапсулированный И вот тогда сразу там всё станет Понятно Потому что Вполне может быть что где-нибудь проценты на пиксель Замени оно сразу Бах всё и завели и Заведётся и станет намного быстрее понимаю что грубо говоря текущие механизмы отрисовки Да соответственно с помощью анимации для распространённых библиотек это уже не наша зона ответственности мы грубо говоря проверяем убеждаемся Что ага Ребята работают так как надо и просто начинаем её юзать в целом да то есть затея дурная например самому допустим да вот прямо с нуля все эти анимации писать это крайне дурная затея это просто очень много времени и всего не предусмотреть плюс что там на старые браузера что если они поддержит transl 3D или ранты обычные библиотека за тебя сама пойдёт нале топ и всё остальное поэтому их однозначно нужно езать но в целом нужно понимать как всё работает внутри как работает под капотом потому что иначе Вот вот этот пример Да вот с расчёской из перерисовали в Ja что-то попросишь делать он сделает Прямо в лоб если ты попросишь делать пять раз подряд в рамках одного кадра он сделал п раз подряд поэтому луше конечно Поль какими-то модными штуками Например я там фанат ГНК вот что это шикарно либо там очень крутой Тип который е пишет И он действительно понимает как всё работает внутри Вот и Кроме того что он выпускает хорошую библиотеку он ещё делает хорошие блокпосты он пишет о том как всё работает вот я сделал эксперимент Посмотрите Вот это и ты начинаешь Лучше понимать как оно работает вот поэтому Да там передайте микрофон пожалуйста кому а Спасибо за доклад интересно Вот хотелось бы может быть какие-нибудь ссылочки на литературу и чтобы почитать поэтому получше а да это либо консультацию от вас дополнительную У меня просто много много вопросов да давайте сделаем следующим образом в любом случае мы ещё после доклада Я думаю здесь потаскун небудь скину либо может просто на github выложу ссылок сопутствующих Это хорошо спасибо Вот пожалуйста Здравствуйте Глеб Спасибо за доклад у меня такой вопрос первый допустим вы говорили что есть там Они там вызываются нам стиле Вот ещё вы сказали что этот вызывается если мы меняем текст контент допустим да как этого можно избежать если я знаю точно что у меня длина строки не Измени и ничего не поменяется Как избежать на измене Тентен приме самый простой способ да Опять же вот Will change у него есть одно из значений это контент Да когда мы говорим такой браузер видишь блок тут контент поменяется и в целом вот в этот момент Можно отступить Да он там сам пытается сделать на более оптимальным образом Да я например не вдумайся в то это работает а вообще по-хорошему если у нас например есть страничка какая-нибудь Вот вот такая вот страничка огромная такая Да и мы хотим где-нибудь здесь Да сделать такой счётчик который будет там 01 2 3 45 будет даёт какой там 99% например да такой то есть мы будем изменять контент Мы же не хотим вызвать всю пере можем сделать из него слой Пусть перее один маленький слой это будет быстро чем будет страдать вся страница причём даже возможно возможно Не знаю нужно протестировать то что браузер увидит то что ва скриптом постоянно меняешь маленький контент он сам сделает блок он скажет Слушай давай вот так потому что не надо мне менять всю страницу не сделает не сделает Там есть такая предиктивная предиктивное Поведение у браузера присутствует То есть когда он видит что ты начинаешь резко менять какой-то блок он может вынуть Но это дело тоже не всегда к примеру Вот раньше о хорошо относился к тому что мы какие-нибудь большие блоки пример брали там например у нас вот есть страничка и на ней вот огромная фотография так типа одна такая плана прилетела потом оп там вторая третья всё было плавно потом что-то просто вот мы делаем проект сидим обновился хром бац смотрим и там просто пошли вот прямо вот вот прямо такая лестница Да с кучей пропусков кадров просто оказалось в этот момент они немножко затюнить изменили то как он работает угол наклоной земли вот и теперь он требует но стоит ему сказать всё опять становится плавно просто они например допустим приняли для себя решение что всё Мы Поддержи Это хорошо давайте всех отучать от этой предиктивной хрени Пусть они Конкретно мне говорят я меняю здесь я меняю то сейчас буду трансформировать уже не трансформируйте слов Вот и поэтому наме начало лагать Вполне может быть что нужно что-то такое о Спасибо теперь вот второй вопрос вытекает из первого фактически вы сказали что ти можно если что-то меняется выделить его в отдельный слой выделить отдельный слой есть способ Вот и когда пытаешь выделить в отдельный слой можно непроизвольно половину страницы выделить туда потому что это сделать вот как тоже этого избежать Ну ну как у нас есть блок который содержит например эти там вот цифры которые мы меняем мы можем просто самому блоку сказать что был чеч например контент Да и потом Потри Как это работает вот Ну ну то есть никаких Практик просто смотрим профлит никакого стопроцентного такого вот решения потому что мы мы до конца сами не знаем как рабо он постоянно меняет свою механику работы например там 3 года назад мы там сделали один проект Мы тоже добились супер Гладких анимаций 60 кадров в секунду всё идеально проходит полгода Мы заходим на проект он вообще просто дёргается Ну невыносимо оказывается что ребята там опять что-то поменяли и например Т леф топ больше всё вот типа на отказ мы больше это не анимируем Наверное они что-то выкинули свою работу Да им наверно стало проще работать ну самому браузеру но изменилось и то есть надо опять это исследовать смотреть что происходит И к сожалению к сожалению всё что свя с анимациями оно ещ не в релизе поэтому оно будет меняться и нужно быть к тому что если ты берш какую-то модную штуку то скорее всего тебе и то нельзя будет один раз прибить гвоздями оно работает придётся экспериментировать Спасибо пожалуйста ещё ну Придумайте что-нибудь грустно будет заканчивать вот прямо сейчас Ещё полчаса есть Спасибо за доклад переключитесь пожалуйста на предыдущий кадр а ещё один какой из них Ладно я задам вопрос там у вас был список Animation IP и Animation Frame чем это отличается Да пожалуйста Animation Frame это метод у объекта Window да в который мы можем передать просто функцию сказать Вот будешь рисовать возьми Вот это исполни здесь у тебя какая-то замена есть Вот например держи это первое А - это вот крано шку которую недавно начинают поддерживать я ещё сам толком в ней полноценно не разобрался это как раз вот новая Вот такая новая вение вот оно сейчас пришло со вторым ангуляр это вот как раз вот вот тот этап который Скоро нас всех ждёт вот просто я его упомянул для того чтобы это знать наперёд То есть например СС анимации они для нас всех уже пройденный этап вот а это это как бы такой пересмотр классической СС анимации как бы там получаются какие-то и таймлайны ещё какие-то зависимости последовательности то чего полноценно нельзя было реализовать анимациях то что приходилось делать именно как бы в фрейма и нельзя было как-то Вот последовательность выразить более явно только в процентном соотношении вот а Спасибо за доклад У меня вопрос насчёт мониторинга то есть вот как это ловить потому что Ну я понимаю мы можем зайти в Тайлан Можем даже FPS счётчик включить в Хроме А ещё есть способы какие-то Ну в идеале мы бы хотели вообще ловить это скажем пользова Да потому что ну вру это всё реально поймать В общем поговорим немножко о библиотеке ФЗ дом а не помню я её автора но он большой молодец что он сделал он кроме библиотечка у которой есть два метода Да что типа в момент чтения в момент записи исполне есть ещё небольшое э м маленький пакетик в плюс кне который делает дом элементы immutable ты не можешь их изменять ты точнее Неправильно ты можешь их менять только когда настал вот момент когда можно менять И то есть во все остальные моменты он выкидывает ошибки и всё перестаёт работать это хардкорно вот если подключить на рабочий проект то там можно сгореть реально что не сможешь Всё это исправить потому что там будет обязательно какой-нибудь очень очень очень полезный там плагин каки библиотек которые всё игнорирует и которые невозможно быстро переписать самому Вот но например в каких-то академических целях просто ФМ добавляется вот этот плагин всё и только читаешь только пишешь он тебе не даёт не делать ничего другого и сыт ошибками вот к примеру таким способом это можно делать так я здесь Привет На самом деле мне не вопрос больше уточнение по поводу Animation что это такое на самом деле у нас просто раньше не было в крипте правда вот делать какие-то анимации это на самом деле JavaScript API тем самым анимациям который есть CSS Вот и собственно говоря там достаточно простой интерфейс получается что у каждого элемента появляется метод в кото как ре задать теже самые настройки как функцию и так далее по сути ве анимации которая вот именно в два скрипте и CSS анимация - это как бы интерфейс к одной и той же самой системе То есть под капотом там работа одно и то же собственно говоря вот эта штука давно развивается спека пишется давно в Хроме по-моему там она имплементировать даже меньше Вот Но в принципе м перво проходится в этой области поэтому уже имеет смыс за ним потихонечку приглядывать А да е как бы есть для этого дела поэтому можно уже сейчас использовать полифил соответственно он использует либо уже готовы в браузере либо это мули ет покс по-моему называется или что типа тако ГНК - это очень старая штука это он я могу на путать но что-то в этом роде дадада потому что он Вот как раз там ещё этого не хватает а полифил что под капотом использует он либо использует то что есть уже не в смысле CSS или Ява скриптом Он меняет он как-то Элит возможно ческие фреймы Вполне может быть Кстати что из-под себя и создают просто тала начинаю например запускать либо будет очень быстро либо пока что не очень быстро но со временем станет быстро В общем со времене станет нативным да Да Вопрос есть г Спасибо большое за доклад очень интересная тема очень хорошая подача вопрос У меня такой недавно в Роме приземлился тово а хорошо которое по идее должно давать хинты браузеру там вот при изменение этого элемента не надо делать ре потому что он не повлияет на все окружающие то есть ре производится не всей страницы а Конкретно ограничивается и там целая куча ещ этих свойств скажи не ковырял ли ты это Нет ещё вот в следущий раз ещ и с этим расскажу спасибо спасибо за доклад присоединюсь к вопросу про автоматизацию слежением за всей этой ситуацией Было бы очень интересно намер К тому же селени к тем же тестам получить какой-нибудь отёк или хотя бы опиш и самому Дописать За сколько ну какие-то FPS то есть посидеть посмотреть на страницу 5 секунд какой когда иде не прол просто знаете как можно реализовать можно просто посмотреть у de Tools какие есть например консольная команды наверняка можно Запустить Chrome с включенным de тосо снять все показатели и выгрузить их в Jon потому что вот эти таймлайны Они прекрасно выгружаются в Jon они рею забель их можно потом просто пропар Сить хорошенько и посмотреть там например Да например суммой считать Да там что если мы там например за 5 секунд пропустили больше чем 40 кадров то атата надо что-то с этим делать Ну например да Вопрос как раз может быть кто-нибудь из отдела тестирования там или ещё кто-нибудь здесь присутствует мы это делали в довольно доисторические времена просто гоняя requ Animation Frame по кругу и соответственно сколько раз за секунду Он выполнился столько кадров мы отрисовать Ну и как бы можно померить время через Window performance между отдельными кадрами в целом да да Как вариант Но для этого кстати Нужна реально боевая машина если там будет какой-то там например Маленькая слабенькая машинка то конечно там она не даст тех показателей то есть нужно посмотреть ну реально целевое железо чтобы о бегало на реальном железе при реальных условиях Спасибо А если у вас там ещё какая-нибудь функция была которая request Animation Frame использует Она же могла заблочить и у вас тогда сдвиг получится между кадрами Хотя он не настоящий можно микрофон ну конкретно в том случае этого не было То есть я не пропагандируют метод как универсальный отве скорее как способ померить что-то внутри request Animation фрейма Если вы знаете что вы ничего другого специального в этом месте через request Animation Frame не делаете Ну и дорогого то есть замер текущего времени очень дешёвая операция кстати ещё как вариант недавно пол айриш это парень который десо занимается Да Сейчас секундочку он в общем писал что у них появись какой-то новый IP как раз позволяющий нормально по православному мерить FP вот да то есть это сюда тоже можно копнуть А по поводу измерения фпса от создателя 3GS есть такая либо Stat GS она как раз этим занимается намери 3p и FPS и всё прочее даже память Ну то есть без велосипедов можно от крутого чувака воспользоваться тулузой Дада Спасибо Скорее всего на этим Апик раз и пользуются Ну сечас в Google вбивал там на самом деле их миллион этих библиотек которые FPS меряют наверняка там есть что-то космическое которое вообще всё супер точно показывает ещё вопросы вопросы у вас нет немножко вопросов У нас просто ещё несколько ответов осталось Не стесняйтесь осталось его пара ответов Так что это ка какой фотки БМ Вот это Понятия не имею Я нашёл видео пореза Да просто мне интересно сколько уже рации получа да она такая гипнотическая я минут 10 как-то провёл думал о чём ты смотрел мне так нравилось прогонов было много да он классный нравится ой-ой-ой давай давай чу вот так наслаждайтесь делал замеры сколько примерно на каком количестве слоёв начинает тормозить браузер то есть когда пора останавливаться выносить в отдельные слои элементы Сейчас расскажу по количеству Нет ну какого-то единого Такого бенчмарка можно сделать даже 1000 слоев по пикселю Да они будут как бы достаточно быстрые всё равно Да но будет некрасиво А можно сделать пять слоёв но 2000 на 2000 и они уже начнут там пролаги поэтому здесь Это скорее всего это вопрос Чуй То есть ты просматриваешь Ты понимаешь что вместо в тала бы осталось но оно уже типа утекает А машинка у тебя побыстрее будет И ты такой вово всё подходишь говори слушай а давай вот мы избавимся её этих дву Слав то слишком кучеряво получается то есть только вот вот так это всё на уровне ощущения тем более например взять например там два компа например допустим вот этот комп и вот этот комп на этом компе будет лагать анимации больше потому что там разрешение 280 на 1340 это всё дело приходится обсчитывают ком будет круче Вот в общем это и в играх тоже са не покупайте рети И второй вопрос а можно вытащить Да я так понимаю слой из общего и также можно его засунуть обратно Да втащить тоже можно да да то есть этот процесс быстрый А это просто ещё один репей во например представим ситуацию Вот Значит у нас есть опять же вот такая например страничка и тут какая-нибудь там шляпа нарисована не то что шляпа в смыс ругайся АНО реально шляпа вот нарисова шляпа и палочка мы думаем Блин мы хотим чтобы вот эта хрень она полета вернулась на место соответственно мы ВИМ что она полета трансформ шляпа откупоривать её больше там нет да помните ка модель когда мы вращай нормаль фон и рисуется сама шляпа пос она полета мы говорим всё хва убира вы как хотите Опа опять прилипает то есть вот Вот так например работает поэтому например даже вот чистить не нужно всегда сразу то есть например если это какая-то анимация где что-то ещё приезжает какая-то огромная хрень съехала и не значит нуть самы момент Пусть ещё даёт маленькие штучки Потому что если мы эту хрень в этот момент выруби она она прилипнет там будет Рей и вот эти маленькие штучки сделать так сейчас сейчас сейчас Всё отрисовать дальше и получится подёргивание Так что тут надо вот тоже аккуратно этим жонглировать вот Спасибо В целом ещ Как вариант если допустим мы Поль к примеру там алям люблю ангуляр У нас есть там два стейта Да и мы хотим сделать анимацию с переходом сно Т на другой то перед тем как второй Т начать показывать нам хороше нужно дождаться чтобы он весь прорисовать подождать КАТО стоит два кадра первый кадр во второй Если что-то вдруг там не успело оно как раз в этот кадр там доедет там да может какие-то внутренние штуки которые есть у браузера и потом она супер плано запускается вот мы как раз таким образом сделали себе Вот на есть такая либо xif UI роуте на ангуляр мы её чуть переписали чтобы она поддерживала нормально таймлайны все остальные штуки вот мы таким образом запускаем все таймлайны потому что иначе получается вот это первое подёргивание которое портит всё ощущение вот всё продолжаем обсуждение тогда А вон ещё целый вопрос я здесь У меня вопрос может быть последний у Safari de Tools это вот вещь которая сделана чужими для хищников я её использую только в одном случае когда нужно поре которые вы пу Вот именно только в сафри Я знаю можно посмотреть сколько он занимает слой в памяти Почему он вынесен на ГПУ что-то кроме Safari сейчас появилось более удобное да Безусловно Это умеет делать chome помните вот э вот сейчас покажу вам вот эту загогулина красивую которая вот так вот у меня крутилась сейчас вот так вот это из Хрома как раз там в ЧМ идея в таймлайне мчать од изло са пос пока рисе и тогда там снизу помните владо вся чтото ещ там появляется ещё один пункти который называется получаем слои Единственное что хоче сказать на тему этих слоёв если слой уже заранее был готов слоя у нас в этой штуке не будет эту картинку Да вот Как я добился собственно этой картинки Да я нажал записать и поменял окно браузера Она вся все слои были перерисовали в этой штуке также если например я просто нажму записать пово мышкой просто по экрану и и потом уберу у меня будут кадры Да что там что-то происходило Может быть но у меня там не будет слоя Если же я наведу например на заголовок да то у меня заголовок перерисуй потому что здесь он при наведении видите он становится светленький на первой картинке то есть оно вот так работает вот и при на больших страницах оно очень сильно тормозит вот ну то есть Safari остаётся самым удобным быстрым способом посмотреть возможно Точно точно сказать не могу потому что я в сафри очень редко де баж я к сафри прихожу толь когда мне нужно дебажить непосредственно единственно причина почему Я открываю в Safari на самом деле вот да то есть и поэтому я даже не слежу что там происходит Вот спасибо да Safari de Tools единственный способ посмотреть что происходит в Safari да да как с Да там в другом прожили всё будет немножко по-другому Возможно да да Всё спасибо большое за доклад Спасибо Спасибо"
}