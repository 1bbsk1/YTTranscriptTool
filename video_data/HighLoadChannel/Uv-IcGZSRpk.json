{
  "video_id": "Uv-IcGZSRpk",
  "channel": "HighLoadChannel",
  "title": "Как сдержать самые сложные обещания: планирование batch-задач в системе Yandex.YT / И.Колесниченко",
  "views": 2000,
  "duration": 2827,
  "published": "2021-10-04T02:39:18-07:00",
  "text": "меня зовут клеща игнат я занимаюсь разработкой планировщик в компании яндекс а фактически мы в компании строим большие кластер а вот я содержание доклада будет пример такой расскажу вообще зачем мы это делаем и почему перед нами стоят те задачи которые я решаю вот потом я расскажу про то а что такое вообще планировщик что это за сервис чем он занимается и в одном мы с вами погрузимся немножко в красивые картинки в алгоритмы в математику и разберемся а как же по честному делить ресурсы на кластере итак поехали значит как вообще устроена жизнь больших компаниях ну смотрите наверное там не для всех из вас это знакомо но вот индекс это реально уже большая компания это там больше десяти тысяч разработчиков какая-то не знаю я не знаю сколько точно но мне кажется сотня подразделений уже есть разные поиск банерной крутилка марки дзен и так далее бесконечное количество сервисов никто уже не знает сколько их вот что есть у этих сервисов у них во-первых у всех есть куча железа у них есть куча данных которые не собирается обрабатывать и что самое неприятное у них есть общие данные но мы все с вами живем в век в персонализации индекс хочет строить умный алгоритм и которые там показывают вам правильную рекламу делают правильные предложения делают хороший поиск для вас для этого надо данные из разных сервисов иметь там в одном месте или по крайне мере каких-то очень близких места чтобы уметь их совместно обрабатывать и на основе этого строить kitten этом умные модели машинного обучения вот ну как я уже сказал есть куча железа то есть каждого подразделение чтобы его данные хранить и обрабатывать это уже какие-то не за этом сотни серверов и что самое собственно не даже неприятное а некоторые данность которой приходится иметь дело и который мотивирует нас делать то что мы делаем это у всех этих подразделений скорее всего очень не постоянное использование ресурсов то есть не за есть подразделение она понимает что она я хочу не зная там в 12 часов ночи все логе которые за день накопились обработать перри посчитать перестроить модель вот мне значит надо там и на часов ночи иметь не знай 200 серверов чтобы успеть это там быстро сделать чтобы уже днем работала новой модели там не зна все было замечательно вот но оставшееся время и железо будет простаивать ну и для большой компании это все крайне выгодно если каждое подразделение будете покупать 200 серверов из которых не знаю они там три часа будет работать эффективно оставшиеся 21 так себе не будут загружены но значит лучше железо простаивает собственно сейчас вот графики которая объясняет то о чем я говорю вот этот график он описывает некоторую долю вот этому и залитом наши самые большие кластеры посчитали долю используемых ресурсов на кластере разными подразделениями у вас должно возникнуть вопрос почему она больше единицы на этот вопрос вы узнаете ответ в конце доклада когда его до слушаете вот но пока это некоторое данность мы научились распылять ресурсы так что доля получается чуть больше единицы ну окей хорошо научились научились дальше то что а вот следующий график это тот же самый график сна на предыдущей картинке но в каждой точке я почитал максимум за предыдущие 12 часов этот график объясняет почему людям подразделениям выгодно сожительствовать вместе если бы они ни а сожительствовали вместе то им надо было бы не знает am в полтора два раза больше ресурсов вот а так они все объединились в один кластер эффективно его утилизируют и при этом решают свои задачи собственно ну повторю ещё раз и ещё на самом деле одну мотивацию сейчас расскажу почему выгодно не 50 маленьких кластеров иметь каждому подразделению свой а иметь один большой кластер вот представим что не знаю каждое подразделение имела бы свой маленький кластером и например hadoop а вот тогда если у вас не зная кластер hadoop она серверов вряд ли ваши разработчики захотят его поддерживать вам нужен быть какой-то и сырая который будет его администрировать обновлять не знаю диагностировать проблемы в общем ну пусть даже это будет там один ну или там не знаю в каких то больших подразделениях два человека мы умножаем это на 50 получаем не знаю от 50 до 100 разных там высококвалифицированных админов и сырья hadoop а вот у нас же единая система своя под названием войти единая команда который разрабатывает от вся команда это 30 человек мы все инженеры все немножко сырья выгода на лицо компании у компании не 50 одиноких и сырая которые обменять свои кластер одна большая дружная команда которые новые фичи пилит и поддерживает текущие железо текущие поднятые сервис и собственно что такое войти ну и то про что дальше будет идти ну дальше будьте доклад про одну из компонент нашей системы собственно войти это некоторые наш внутренняя самописная система которой уже более 10 лет более-менее то налог ходу по наша система умеет хранить данные экзабайт и данных умеет их обрабатывать вот у нас как я уже сказал примерно 30 человек разработчиков и админов в отделе по факту такого разделения явного нету мы все хорошо понимаем какой код мы пишем имеем его же диагностировать выкладывайте и так далее вот у нас больше тридцати тысяч серверов в эксплуатации которые хранят данные обрабатывают вот мы и вот на самом большом кластере для которого я до этого показывал графике у нас примерно миллион сепию сейчас в обслуживании собственно чем занимается кластера тоже это уже немножко проговорил значит чуть чуть больше деталей для того чтобы вы лучше понимали чтобы и дальше происходить есть такие сервисы называется мастера это такой аналог на i'm not языки пера в ходу пи то есть это некоторые реплицирования стоит машина которая хранится мета информацию про то где какие данные живут на каких хостах она же умеет нам реализовывать локи в общем такой надежная in memory хранилище есть собственно непосредственно ноды которая занимается полезной нагрузкой они хранят во-первых данные во вторых их обрабатывают и not очень много их там десятки тысяч собственно есть обработка данных которая производится на нотах и также вот есть та часть про которые бы рассказывать это scheduler планировщик но это аналог ярно в ходу pivot в ходу пи есть такой я уже забыл как расшифровывается ета на за ресурс снега shader кажется вот есть такая система которая собственно планирует вам где какие вычисления запустить вот я разрабатываю такую систему только в нашей инфраструктуре вот это уже для нас не очень важно у нас есть не знаю и верю хранилище мы умеем данные которые мы мы придем сам как-то обработали получили по кнопке поднять не знаю начать с них сер ведь нагрузку наружу то есть такой real time кивали сторож тут же поднимать ну вот примерная схема показана как это все выглядит есть вот мастера собственно который хранит в эту информацию нам эта информация уже очень много когда у вас десятки тысяч долларов поэтому это не просто там одна тройка серверов это какой-то сложный протоколу общение между ними есть прокси который собственно стоят таким забором между тем что происходит в кластере пользователями есть планировщики которая собственно вот про них я буду сейчас рассказывать буквально через две минуты который занимается планированием к ним приходят пользователи горят я хочу обработать эту табличку на петабайт а он решает где какие же вы мы запустим сколько мы параллельно и будем запускать и так далее есть агенты агенты собственно план составляет планировщик не думает о том как ему с петабайтов данных поработать он говорит агент пришли сколько у тебя будет рабов как это вообще все будет нам что в какой посольстве запускаться планировщик только разделяет этим же бы на ноты вот ну есть собственно ноды отвечу на не заданный вопрос который наверняка вы захотите задать а почему не ходу почему мы строим свою систему уже десять лет там вкладываем в этой силы почему просто не возьмем ходу ну вопрос как бы ответов несколько разных вот 1 ответ про то что hadoop не умеет наши масштабы я уверен что не знаю кто то из вас наверняка видел hadoop на сотни not я знаю что из hadoop и на 1000 not не знаю в той же компании criteo у них кажется кластер на 5000 ноты 50000 секунд вот ходу пав нашего размера скорее не бывает либо бывает не знаю словно в фейсбуке но там это ходу в версии там 14 которая не от форк 0 это же 10 лет уже сами развивают что нельзя назвать в чистом виде ходу по ну еще часть мотивации стоит том что у ходу по достаточно большая кодовая база и туда достаточно сложно засылать патче многие почти которые мы видели как люди их дизайне то засылает занимает не знаю там от полугода до года для того чтобы добавить какую-то новую важную функциональность ну конечно коммерческую компании это не очень устраивает ждать полгода год надо будет for 5 hadoop как-то не очень хочется вот ну и кроме того про фичи на самом деле мы решаем задачи наших пользователь наши пользователи десятки тысяч разработчиков яндекса вот и мы умеем поддерживать для них многие разные вещи которых в ходу пи нету например мы умеем нашим планировщики в интегральной гарантии если интересно спросить потом в кулуарах я расскажу что это такое как они работают мы умеем решать задачи фрагментации на кластере ну и на самом деле мы умеем хорошо делить кластер hadoop этого не умеет опять же я не буду сегодня рассказывать про так как это делает ходу почему но как он это делает это некорректно но если вам интересно спросить и расскажу собственно поехали ко второй части давайте разбираться кто же такой планировщик какую задачу он решает вообще с кем он общается что он делает важный дисплей мер если вы знакомы с хату по мто выгодно знакомость про ноги ходу по ходу пи жизнь устроена таким образом там есть job это собственно такая одна большая задача хочу обработать вот эти файлики в этой папочки вот таким то кодом положить их вот от другое место ну по историческим причинам у нас это же называется операцией а то что в ходу пи называется джебом у нас это на самом деле то что в ходу пи называется паском у нас это называется в жопу так как я это терминологии пользуюсь буквально каждый день я к сожалению не смог доклада перестроиться и рассказать вам другой тебе ноги поэтому буду рассказывать в нашей терминологии но понимаете что операция это вот большая задача a job это уже конкретная маленькая задач который будет исполняться на конкретной ноге с конкретными там в ресурс любит собственно с чем приходится иметь дело планировщику ну вот использовать или пользователи приходят со своими запросами но запрос это вот какие-то входные данные там не знаю список таблиц перечисленных кит выходные данные куда собственно пост о как мы эти данные по фильтруем не знает а мы обработаем нашим замечательным бинарник а мы положим это собственно писание того о чем надо запустить вот ну у нас такой интерфейс более низкого уровня во мне не вложен в java как не знаю как в ходу пи то есть можно запускать просто произвольный код который вы собрали вот мы важное для нас часть это собственно вот эти вот гарантии не знали там clicker или нет это то сколько secu нужно одному джаббу для исполнения этого кода сколько памяти ему нужно вот ну и пул это вот некоторая вещь который будет важно для частности скоро вы узнаете что такое собственно кроме того планировщик общается с нотами кластера нуланд он должен запускать жабы модель общения примерно такая надо приходит сообщает начинаний уже бежит что запущена сообщает что а у меня тут вот эта задача доработал это задача доработала у меня теперь не знаю 70-ю свободное 20 гигабайт памяти а вы дай мне новые работы вот ну соответственно в ответ scheduler планировщик сообщает надя какие-то новые жабы потенциально он может решить что чтоб надо попортить прервать ну потому что не знаю но вылезла за какие-то положенные ресурс вот кроме того есть агенты который как я бы сказал составляет план операции ну там достаточно сложный протокол общения с ними планировщик рассказывает собственно ted успех у которой вы видели агент из нее составляет большой сложный план а как операцию исполнять но это нас сегодня не сильно будет интересовать поэтому пойдемте дальше вот картинка иллюстрирующее что происходит если разработчик за своим ноутбуком он стартует операцию эта операция там превращается некоторые запрос пример каким-то агент составляет ее план после этого планировщик общается с нодами ноды приходится свободными ресурсами планировщик идет снова к агенту и говорит а вот у меня есть бирка на кластере найди мне тут окунуть работу ну агент знает какие есть операции горит окей вот тебе чтоб под эту дырку немножко про нагрузку тоже протон с чем нам приходится иметь дело но вот кластер дорос до таких размеров и до такого масштаба что у нас уже 16 тысяч орбита в секунду то есть вот этот единственный сервер то есть планировщик это сейчас один процесс на одном сервере он обслуживает 16 тысяч запросов в секунду от но от вида а мне этот счет закончилась на зимняя какую-то новую задачку запустить вот ну факту это 16000 очень непростых rp асов это достаточно сложные тяжелые запросы и скоро станет понятно почему немножко еще статистике собственно наш планировщик планирует 7 миллионов операций в день примерно 7000 джабба в секунду заканчивается то есть на самом деле на каждый найдя достаточно часто что нибудь заканчивается примерно 600 тысяч раз планировщик пытается вот конкретную дырку освободившуюся на ноге пристроить какой-нибудь job ну его по каким причинам не получается не знает unity фильтр стоит на джебе что тут не надо не зная или там по ресурсам он фактически не подходит но в общем примерно такие вот масштабы и цифры того что происходит в этом одном процессе окей собственно такая самый алгоритмическая может быть сложная но может быть и наоборот самая увлекательная часть про то как же наш огромный кластер наш огромный торт по честному поделить между теми отделами которые принесли в него ресурсы то есть картинка такая у вас не знаю есть много много разных отделов каждый из них самостоятельно покупает железо зато центр ну дата-центры единые там не знает и железо как-то ставят вместе вот и дальше они все говорят о кей это железо ваши мысли мои наши нашей системы но так конечно не работает если нам просто дадут железом и никаких обещаний про него не дадим то люди скажут не хотим так мы лучше себе собственный кластер hadoop а поставим будем сами заниматься утилизацией этого железа поэтому мы не просто должны принять железо мы должны про него пообещать что то мы должны дать какие-то гарантии собственно вот про гарантии еще буквально через пару слайдов будет а пока давайте поймем что же известно планировщику и какой то не знаю простой алгоритм посмотрим увидим так вообще планировщик мог бы решать задачу собственно планировщику известно следующее вот есть какие-то ноды на них и скиты ресурсы вот эти вот два столбика это такой профиль ресурсов на самом деле первая часть 1 столбик это обычно будет сепию у нас второй столбик это будет рам соответственно есть операции у операции есть жабы но вот вы помните там уже оба были написаны 10 цепью 20 гигабайт epam это вот будет как какие-то два столбика на снова или собственно планировщику надо как-то вот эти вот столбики операции сопоставить свободные дырки у ног также можно это делать ну немножко еще на следующем слайде будет рассказано никто уже простая стратегия тут еще немножко вводных какой модели на самом деле будет делать от планировщик значит вводные такие в кластере очень много нот и средний с очень маленькой ну вот вы помните там типа 7000 дубов заканчивается в секунду ну если не знаю там на хвосте 50 цепью то примерно так и получается что средняя длительность одного джабба примерно минута вот как следствие мы не можем решать задачу не знаю там раз в минуту мы можем 1 минуту прийти посмотреть на все операции посмотреть на все ноды решить ага давайте вот это сюда поселим это сюда поселим тогда мы минуту не будем ничего планировать на ногах очень быстро по заканчиваются какие-то джебы и ресурсы будут простаивать все время будет такой мы загрузили кластер на сто процентов он так выдохнул и стал загружен на половину потом снова загрузили на сто процентов он выдохнул стал загружен на половину хотим его все время грузить работой не хотим чтобы ресурсов простаивали окей теперь пора какую-нить простую стратегию вот самая простая стратегия называется сифон мы берем все операции выстраиваем в очередь у каждой операции вот есть профиль рабов которые она хочет приходит к нам надо собственно с hard by там и мы вот на это на ту скорби там на ее свободные ресурсы хотим чуть поселить ну вот мы смотрим не знаю у нас есть первая операция есть первая операция вот оно ну она у нее она уже полностью все заселила смысле все за все запустила в нее юзай уровень диман да она ничего больше не хочет поэтому я ими даже ничего предлагать не будем есть вторая операция вот она у этой операции есть свободные ресурсы но у нее профиль не тот вот видно что не первый столбик маленький он подходит а второй столбик большой он просто не вписывается в то что есть на надя ну не знаю там надо я освободилась 5 гигабайт a job хочет 10 ну сорян запустить не получится ну и вот есть 3 операции у которой есть и свободные джаббы столбики вписываются ну можно видимо там взять один job этой операции и на это надо запустить победы ну тут справа немножко формализма введена про то как собственно работает такая стратегия сифон вот ну понятно него что стратегия замечательно своей простотой но также на замечательные своей практичностью мы-то у нас ни один кого то есть если бы вы были не большой отдел и там кластер на 50 not to наверное вам даже подошла бы фифа стратегии но у вас не знает что операций одновременно бежит как-нибудь все срастется если же у вас там кластер в котором сотни подразделений запускает свои операции это очень странно выстроить все операции в очередь и также типа что вот придет какой-нибудь аналитик запустит какую операцию которая делает кого не грепп логов и бежит не знаю там полдня и все остальные продакшен процессов станут конечно так не годится собственно ну для этого предлагается ввести пулы то есть не просто пришел какой-то отдел принес свое железо поставил в кластер а дальше надеяться на чудо нет он пришел в отдел поставил свое железо еще сказал а вот вы мне теперь там ресурсы которые на этом железе были те цепью и память напишите пожалуйста свой конфиг и будьте добры соблюдайте тоже написано конфиге я ничего тут собственно получается такая модель есть конфиг в конфиге написаны какие-то отделы не знаю там поиск market zen написано сколько железо они принесли вот мы и дальше операция не запускают каждой своем конфиге ну понятное дело что нужно опять система прав ты должна быть так что разработчики из поиска могли запускать операции только в поиске что ты не мог свою операцию кому-нибудь подселить ну это такая уже техническая деталь собственно все делать планировщику вот планировщика встает вопрос пришел харбин на нем есть свободная дырка какой операции предлагать раньше была единая очередь ну шли по очереди находили теперь есть титул и непонятно как выбирать ну на самом деле на этот вопрос не сложно найти ответ собственно предлагается такая стратегия на основе фер нас и все следующей стратегии не будут иметь в целом такую же схему такой же план для каждого пула читаем некоторые честную долю она будет называться у нас фарша честная доля по-английски и читаем некоторые ну как бы у нее есть юзать сколько реально ресурсов уже в этом поле потребляется вот мы будем этот use что же переводить некоторую долю вот то что здесь написано сокращённо это называется user и будем сравнивать эти два числа и будем просто напросто искать тот пул у которого это отношение минимально это очевидно тот отдел который больше всего страдает что он уже захотел ресурсов а потребляет он мало вот понятно что наверное давать тому кто так бы сейчас больше всех обделен вот ну исходя из этого рождается простой алгоритм вот простой алгоритм описывается на самой для одного ресурса когда ресурсов многое уже возникают разные вопросы на которые мы ответим но пока ресурсы один вроде бы всё совсем просто предположим у нас есть только сепию предположим что нас есть ресурсы нашего кластер это вот этот прямоугольничек синий водой и есть такие вот три пула здесь нарисованы значит что тут нарисовано каждый пол на самом деле вот его прямоугольник это то сколько ресурсов он вообще хочет ну вот пришли запустили операцию на тысячу шагов от вас там столбик высоты 1000 получился ну по факту столбик высоты 1000 умножить на то сколько сепию хочет один ваш треп вот то есть еще гарантия то сколько у вас конфиге написано это вот оранжевые засечки тут собственно как делить ну вот предлагается мгновенную честную долю раздавать пропорционально гарантия но и не выше чем то сколько вообще хочет ну глупо если вы пришли запустили операцию на тысяч зубов глупо вам говорить окей мы вам обещаем сейчас прямо сейчас 2000-ого мне нужно две тысячи но как раз хотим пообещать тысячу оставшийся тысяч распределить между остальными потому что они не просто так пришли сожительствовать друг с другом а для того чтобы пока один не использует ресурсы остальные их перри использовали но и за счет этого эффективнее быстрее выполняли свои задачи собственно вот ну начинаем наливать происходит вот такой первый этап наливания пока во втором пули мы не дошли до диман да ну и потом до наливаем весь остаток 2 пол больше не хочет в 1 в третьем и доливаем пропорциональные и гарантия ну получается такая картинка вот собственно то что синие мы тут на читали это та честная доля на которому щас будем ориентироваться при планировании когда к нам придет надо с со свободными ресурсами мы будем на вот это синее число ориентироваться а про оранжевое уже забудем собственно ну вот что происходит когда приходит надо пришла надо на ней вот есть там свободные ресурсы я например на последнем ресурсам работаем у каждого пула есть какой-то юзать сколько вот реально уже там запущена job of и потребляется и есть вот это честная доля но вот мы выбираем просто тот у которого это отношение минимально но в данном случае это там 3 pool ok поехали дальше ну ресурсов ни один на самом деле если вы начнете планировать кластере только сепию быстро выяснится что есть всякие машины обучения которые памяти хотят больше чем secu них кит модели там на сотни гигабайт оси пью нужно там не знаю всего десяток и вы не сможете просто 0 вы либо запустите как бы не явно займетесь и пью либо запустить я памяти вообще не хватит и процесс упадет конечно так делать нельзя поэтому предлагается когда у нас есть это вектор ресурсов то есть какой-то такой не затем 2 столбика предлагается смотреть в этой паре столбиков на такую доминантную долю то что называется то есть мы берем все ресурсы кластера суммарно по всем ногам суммируем это такой вот наш большой total который здесь нарисован слева а дальше есть не знаю зачем юзать же можно посчитать вот его долю теперь который который мы дальше хотим оперировать в нашем алгоритме планирование в данном случае это доля одна треть относительно и потребление рама меньше чем относительно потребление сепию вот поэтому доминантной долей вот этого правого набора столбиков будет одна треть окей собственно как теперь делить ресурсы но деле мы на самом деле по-прежнему просто мы теперь на диман смотрим тоже как на долю такую вот у нас теперь есть такие уже пора плов у которых диман какой-то непропорциональный гарантии все еще будут такие не учитывающие то что ресурсов много то есть гарантия формируется в доле кластер а ну и мы просто берем и доливаем эти ресурсы пропорциональны гарантиям но не выше чем самый высокий столбик то есть если здесь у какого-то из пулов вот этот прямоугольный столбик был бы ниже чем гарантия там и выше него наливать бы не стали ok что дальше происходит при планировании ну теперь на самом деле надо как-то решить что такое а вот это вот юзать шар поделить на пейджер раньше это были два простых понятных числа ну теперь мы не просто так водили доминантную долю теперь на самом деле это просто отношение доминантных долей ну вот на этом примере видно что вот есть левый пул у которого какой-то flasher мы насчитали есть у него usa чем доминантный усач него явно пора маму по второму ресурсу ну и вот он там отмыты отношения примерно равно пять шестых но управа пола наоборот доминантной сепию и там наоборот отношении по первому столбика считается то есть это 6 5 вот ну значит надо ресурсы предлагать вот первому полу окей что ж происходит более глобально более глобально происходит следующее у нас есть ну допустим у нас не знаю чистый кластер там написали какой-то конфиг запустили его и начали приходить какие-то операции запускаться джаббы ну вот процесс будет примерно таким образом устроен мы посчитали какие честные далее дальше орбиты хандрит их орбитах орбиты мы что запускаем запускаем запускаем запускаем столбики растут и растут и растут растут но и вот тут видно что если есть два процессы в них не paparazzi анальное потребление ресурсов то они на самом деле с точки зрения честный доли даже сидят больше чем единицу кластером первый съезд как бы 8 седьмых от того что ему обещанное второй съезд 87 их от того что ему обещанную ну и разумно они как раз один используют скорее всег или другой скорее память поэтому с точки зрения своя частная доля не как бы даже больше единицы кластеров могут потребить собственно ну я вот нам на память слайдов до этого была ссылка про drf это не то что мы придумали это была такая статья он реализован тоже ходу и этот алгоритм статья кажется 11 года он обладает разными доказанными математиками свойствами он во первых такой алгоритм доедайте ресурсы кластера то есть всегда когда вы такой ритм используете и у вас есть достаточные demand от операции вы по какому нибудь ресурсу весь кластер должны будете съесть ну по модулю там проблем с фрагментацией он поддерживает собственно несколько ресурсов там secu epam в данном случае дает гарантии по доминантному ресурсу то есть к сожалению гарантий нельзя сформулировать вида я принес не знаю больше secu и меньше памяти вот мне вот гарантируете вот насколько я принес нет вы должны приносить столько ресурсов бы так вот вообще в целом ситуация на кластере устроена не может быть так что на кластере миллион сыпью и миллион гигабайтов памяти о вы принесли там 200 тысяч цепью и 50 тыс гигабайтов памяти вот так сожалению не работает вот ну это же полезное свойство излишки он раздает пропорциональную данным гарантии то есть если кто то не доедает ресурсы сейчас то всем остальным они будут окну равномерно наливаться собственно чего не хватает не хватает на самом деле двух вещей ну вот одна вещь про которая уже сказал это про то что гарантии только временами ресурса формулируется на этом и там через пару минут поймем еще не хватает иерархии на самом деле вот нам яндекс поиск какой-нибудь там ни на одной из самых крупных подразделений в яндексе он очень большой и там внутри куча тоже разных процессов куча разных каких-то служб в которых тоже у всех свои вычисления там может быть немножко свои данные они не хотят иметь один пул в котором все будут становиться в одну очередь они тоже хотят внутри себя какие-то подпылы иметь тоже как-то распределять ресурсы ну вот тут не знаю есть простой пример прям вот в консоль я запустил на нашу команду line утилиту корневых полов у нас там 170 но из них может быть типа 70 технически х100 реально соответствует каким-то делом а вот если пойти в глубь то там плов уже больше двух тысяч вот то есть мы на самом деле хотим картинку примерно такую ну тут понятно делом так очень урезанном виде нарисована реально я думаю начать рисовать все наше дерево плов это будет такое очень монструозная дерево собственно предлагается сделать такой иерархический der значит чем мы будем делать предлагаешь простой план ну вот у нас есть схема как мы делили ресурсы в корне вот мы взяли ресурсы сего кластера есть полы в корне пошли в них навели ну давайте повторим это дальше просто рекурсивно ну там мы налили в какой-то пункт пойдем в этот пул посмотрим на его детей и там тоже нальем ну вот есть корень налили пошли в ребенка сказали о кей ну там у нас уже там всякие demand и не так интересует вот у нас насколько мы в этом полу выдали давайте выдадим дальше ну пошли выдали вроде все нормально окей ну надо еще же дурить уметь планировать ну точно так же будем выбирать пол с минимальным отношениям юзать шерк фарша берем не знаю корень в корне выбираем вот опять же тот же самый вот этот верхний пул явно здесь отношении пять шестых поменьше ну вот у него есть типа двое детей ну и у двоих детей опять выбираем тот у кого отношении поменьше то есть вот этого ну казалось бы все очень просто иди зачем про это говорить но на самом деле есть проблема к сожалению мы не статический четырем кластер не то что у нас пустой кластер пришли какие-то операции запустились мы туда счет запустили и всем и задачу решили к сожалению операции приходят-уходят что запускается и возможно вот ситуация описана этом рисунке ситуация какая есть два пола в корне значит вот этот правый пул у него вроде как все хорошо по его честно и доля ну не вот явно в первом столбце ему выданы уже больше чем пообещали есть 2 у которого ну как раз не до выдано очевидно надо идти давать второму точнее начинаете давать первому что втором уже все хорошо но на самом деле у второго в его детях полная беда у него там есть первый ребенок который явно ему не докармливают его не дают ему ресурсов вот но мы этого не видим а за то что не и справа и сосед у которого всё хорошо ну и и так реально могло получиться потому что не знает нам левого левый под пул у правого под дерево запустили позже в 700 этого не было операций там было все хорошо был запущен только правый ребенок все насыщена все отлично потом запустили левого и приехали левому с точки зрения родителя не видно что у левого проблемы у те им что же с этим делать но на самом деле есть простое решение называется satisfaction hdr off фактически спас такая есть даже статья специальная про her all for hair холдера чуть попозже вышедшие чем статья проверив но там очень непонятная и плохо доказано и решение поэтому мы когда-то лет не знаю пять назад по думали и придумали свое решение очень простое давайте мы привод принятие такого решения будем смотреть не на текущие подпылы их вот эти вот литва ленности usa решили поделить на флэше возьмем все под дерево и в нем возьмем минимум то есть будем идти туда где реально сейчас самая худшая ситуация но в данном случае когда мы посчитаем минимум вот в этом по дереве окажется что это минимум равен 1 2 поэтому мы должны когда предлагаем ресурсы освободившийся на ноге выдавать мы должны идти в правой под дерево ну это мы уже понятно дело пойдем в этом страдающего левого ребенка вот но мы даже писали статью к сожалению не хватило сил чтобы ее довести до ума и там послать на какую-нибудь приличную конференцию вил би би или и в россии с но если вам интересно почитать как это работает и почему это тоже доказуемо корректно скажите мне я вам пришлю этот текст ok чего еще не хватает но вот как я уже говорил еще не хватает векторной гарантий на самом деле люди реально хотят гарантии которые непропорциональный по себе память в нашем кластере не зная пропорционально что-то в духе на один secu четыре с половиной гигабайта а есть не знаю люди которые занимаются только машинными обучения me у них там большой отдел не знает sales равен картине все процессы они там про машины и обучения так или иначе им нужна гарантия очень непропорциональные то есть они хотят платить поменьше покупать поменьше железа и за счет того что остальные процессы наоборот память хотят меньше чем цепью получать такие векторной гарантия собственного ну хочется как здесь нарисована на правой картинке вот так не хочется хочется вот так вот ну давайте это сделаем собственно же будем делать давайте скажем что гарантии теперь могут быть непропорциональные но здесь нарисованы такие оранжевые рисочки неодинаковые для левой и правой части и начнём раздавать ну вроде бы понятно берем тоже пропорционально этим листочком наливаем ресурсы все налилось вроде бы шанс вот там уже решение получится давайте раздавать дальше у нас графическая схема даже не только корень вот пусть у этого не знали об этом и вот уже выдали какую-то частную долю вот эта вот синенькая налитая жидкость пусть у нее два таких под пулатов пусть на самом деле его гарантия формировалась из гарантий такого левого ребенка а в правом не знаю вправо китам research процесс с живут в которых гарантий никаких нет вот ну и продолжим наливать ну получится носами для сочи странная ситуация то есть не то чтобы что-то прям сломалась но есть к этому вопросы некоторые то есть дамы тому левому ребенку которого есть гарантии нальем его гарань ну нальем вот этот честный фарша а правому ребенку найдем все оставшиеся но правый ребенок на самом деле не хочет а в такой и пропорциональности у него есть какая-то пропорция между его там потреблением secu epam а мы ему выдали честную долю которой этой пропорции не очень соответствует ну так странного-то на самом деле собственно эта странного то есть приводит к тому что ну такой алгоритм по честному не работает то есть если начать пытаться доказывать про него кит свойства ничего не выйдет будет плохо будет даже хуже чем когда мы раздавали прямоугольники вот поэтому мы сели с моими умными разработчиками долго-долго подумали какие-то разные математические модели по применения и придумали как это сделать я к сожалению эта часть сложная я сейчас не буду рассказывать и в деталях в кулуарах могу попробовать рассказать но я расскажу будет общую идею собственная стоит в том что мы не надо пытаться действовать наивно не надо пытаться в корне раздать ресурсы детям пропорционально гарантиям и на этом как бы успокоиться на самом деле надо разобраться про каждый пул в какой пропорции ресурсы он хочет вот и дальше научиться эти пожелания ресурсов склеивать вверх по дереву если мы для каких-то не знаю там операции понимаем что у них там все живые гомогенные и вот хотят ресурсов такой пропорции но мы можем их склеить и почитайте какой пропорции теперь буду хочет ресурсы а потом для этого пула можем склеить его соседями и снова посчитать эту штуку вот получается в итоге такой вот график то что мы называем сочи с чем-то вам предлагает какую-то долю кластер а по оси x ну собственно вот давайте называть x а мы говорим мы нас на вид для каждого ресурса строим график какую реально долю от этого ресурса мы можем потребить ну вот на этой картинке видно что у нас есть значит левый сын который потребляет цепью epam равномерно поэтому в начале первая часть графика будет такая одинаково у нас цепью epam вместе идут а потом когда мы 1 насытили у нас есть 2 по пунктам или 2 под операция у которой нет гарантий но у нее есть диман и вот ресурсы мы должны выдавать пропорционально этому диман ду ну вот там видно что графика сепию и рама расходятся возможно в какой-то момент не знает там если 2 под пол был пониже то график бы даже не дошел бы до единицу бы в тот момент просто раз и превратился в константу ну что всем и весь demand удовлетворили дальше давать никуда ну собственно вот мы научились строить такие функции научились там придумали как это математически их сочетать в под пулах неожиданным образом это можно там за линейное время даже вычислять вот вначале у нас не получалось ну и в итоге мы избегаем диспропорции между диман дамы фарша мы умеем реальные ресурсы детям выдавать в той пропорции в которой они сейчас их хотят вот мы на самом деле мы планируем детали опубликовать в статье ну как минимум на хабре а как максимум все-таки в какой-то какой-то такой научной конференции вот тут видно собственно commit который это делает был он примерно чуть больше года назад сделан вот моим коллегой который к сожалению ушел в науку вот но на самом деле он сделал очень большой вклад большой взять спасибо андрей тонких его зовут собственно мы научились непропорционально выдавать ресурсы мы научились выдавать нашим пользователям гарантии который не одинаковы по secu и по памяти собственно пришла пора ответить на тот вопрос который был поставлен в начале и который был не отвечу почему же тут сумма больше единицы но смотрите вот этот график это на самом деле график того самого faire шерпа корневым под пулом то есть у нас есть корень есть вот отдел у каждого из которых есть свой пул и там есть графики в частной доля так вот за счет того что мы внедрили векторные гарантии здесь сумма стала больше единицы то есть какие-то дела которые хотят скорее степенью чем ram но и мы для них это долю считаем пасеку а есть те которые хотят с карьером чем себе мы для них то лично им парам в итоге когда мы все это просуммируем получится больше единицы с этой диспропорции вот такой вот ответ то есть на самом деле мы смогли более гранулярный более правильно гарантировать кластер в каком смысле смогли больше единицы кластер гарантировать нашим пользователям за счет того что они хотят цепью больше sepia меньше рама другие наоборот больше рама меньше пью собственно ну на этом более менее все давайте буквально на минутку под виду выводы значит выводы какие ну во первых задач и планирование такая простая как кажется когда-то когда мы изучали этом статьи не знаю лет 5 назад казалось ну вроде все просто там вот есть ходу перелезать сейчас возьмем ее повторим не знаю вроде все понятно потом когда начинаешь вдумываться и вдаваться в детали оказывается что есть масса разных нюансов которые в частности в ходу пи решено просто некорректно необходимо уметь планировать несколько ресурсов хотим строгий гарантии на полах хотим иерархию полов это все реальные нашей бизнес требования которых никуда не деться немножко еще расскажу про то что умеет наш планировщик вот как я уже горел он имеет обеспечивать интегральные гарантии если интересно потом спросить я расскажу что это такое ну идея на это более-менее когда мы хотим не мгновенно себе какую-то какие-то ресурсы получать грамм и хотим сказать что ну нам в сутки в среднем 1000 secu у нас тут ресурс процесса для них не знает нам время выполнения так важно главное чтоб не знает за 5 часов она как-нибудь добежала а сколько вы прям сейчас будете им давать ресурсов не так важно умеем на самом деле поддерживать планирование по чапаю нас большой парк depay'a хостов и там есть свои сложности с тем что люди хотят запускать какие-то смешанные 4 secu обучение хотят распределенные читы и обучения на десятки хостов запускать и они еще зараза очень непохоже на то что было в матче вычислениях там не средняя длительность ни одна минута и джабба не знаю а там полдня если не день умеем на лету изменять гарантии то есть можно прийти и сказать ой а давайте в этого пола будет другие гарантии или в этой операции умеем также фактическое потребление учитывать то есть если пользовать пришел сказал я хочу 10 цепей оптом выяснять что начать с цепью не потребляет мы берем извини друг но мы тебя сейчас подожмём до 5 опять будем давать другим людям которым они реально нужны вот ну как всем спасибо если есть вопросы задавайте спасибо большой игнат у нас есть для тебя подарок конечно памятная рамка и если вам замечательной худи эмблемы халат поднимайте пожалуйста руки у кого есть вопросы 1 рука вижу и на первом ряду вторая рука а в это время руслан из из онлайн и задал вопрос говорит к сожалению не может подключиться он в эфир чтобы задать я задам за него можно тоже защитить зачитывать потому что приз достанется в том числе если человек из онлайна задал вопрос у него 2 учитываются ли локальность данных при выделении ресурсов 2 если в вашей модели механизм принцу смотрите на оба вопроса ответ да на первый вопрос и он на самом деле такой с подвохом каком-то смысле то есть мы когда система писали мы локальность данных учитывали но потом с ростом пропускной способности сети просто на способности дисков стало понятно что вероятно это не самое важное но сейчас такая элементарная поддержка есть да есть ощущение что может быть я даже выключим потому что связано с 3 кластер очень хорошая и локальность данных религии так важно на второй вопрос если прям шиндо есть прям что это отдельная большая сложная задача про которую к сожалению в рамках доклада не рассказать но очень многие проблемы которые мы вот решаем нашим планировщик они так или иначе связаны с прям шоном что без причины соблюдать честность конечно не выйдет все еще может прийти разработчик запустить грепп логов там выходные на миллион шагов он зависнет и дальше эти ресурсы будут заняты этим разработчикам и никому не не будут выделены поэтому чтобы обеспечивать честность надо надо вытеснять джаббой да супер первый вопрос пожалуйста представляетесь у кого уже есть микрофон вставайте и говорить о представьтесь и задавайте свой вопрос и 2 будет в первые ряды или не донесли хорошо у того у кого есть микрофон вставайте представлять и задавайте вопросы здравствуйте меня сергей зовут спасибо за доклад вот у нас тоже систему есть которая распределяет ресурсы она чуть попроще модели она учитывает только временно которая ресурс будет за ним то есть нету вот двух столбиков как быть если тот кто запрашивает ресурс он может обмануть и занять на дольшее время ну то есть в ваш к вашей системе это как-то применимы или нет когда честно распределить в таком случае что с ним делать хороший вопрос смотрите в нашей системе мы естественно и ну как бы вот по место где мы не верим пользователям это то что нам рассказал про памяти просить у нее как я сказал мы умеем поджимать if you память про время мы не спрашиваем вы не знаете сколько она бежит но добывает системы где люди ориентируются на время и кажется в этом случае надо от пользователи требовать уметь такой мягкий прям что делает из вы можете запустить его на час он часто работает опускать друг извини ты обещал за час за часом не ложился мы тебя вытесним и на еще через час митя запустим снова учись подниматься как бы своего промежуточного состояния дом и такой первая мысль пришла в голову нас намекаешь надо изучить литературу понять как как правильно и ваша ситуация спасибо ребята поднимайте пожалуйста руки потому что мы успеваем протирать микрофон и дезинфицировать их перед тем как передаем следующему бы сейчас уже есть микрофон остается человека поднимайте руки заранее чтобы успели вам принести здравствуйте меня зовут сергей я руководитель отдела поиска зонт спасибо за доклад я не совсем права тонировщик хотел спросить в начале были отсылки ходу пола и вы сказали что он не выдерживает кластер а таких масштабов можете прокомментировать во-первых проверяли ли вы как-то это на свои инфраструктуре там теоретически или а на практике и второе в каких именно местах он перестает работать на таком масштабе кластером к сожалению очень плохо слышно можете мне помочь разобрать вопросы ребят давайте туда выходить на сцену и задавать здесь у нас действительно немножко гулкий звук беги скорее тоже микрофона чтобы тебя докладчик слышал рядышком да давай скорей поднимайте руки дальше пожалуйста так не знаю отсюда слышно да как-то лучше слышно кажется поднимайся вопрос был про hadoop вы упомянули что на вашем объеме кластер hadoop уже не будет работать первый вопрос пробовали вы как-то это проверить и 2 в каком именно месте он перестает работать смотрите пробовали мы мне кажется лет пять-шесть назад всерьез смотрели на ходу по мы его разворачивали на тысячах not перестать работать в разных местах смысле разные места начинает упираться в производительность не знает там планировщик не тянет только задач где-то там утилизация ресурсов начинает падать потому что не знаю причин мастера не умеют так на такое количество нот распределять свои там опередишь джебы но опять же смысле может быть часто чтоб поменялось по что году пять лет назад и сейчас немножко разные системы но пугает то что нет таких инсталляций то есть если кто то пришел и сказал посмотрите вот он уже работает все хорошо вот мы проверили мы там не знает такие же объема как вы обрабатываете замечательным можно было вернуться к этому вопросу а так к сожалению не дашь и у нас есть много свободных рук чтобы пробовать другие системы на таком масштабе что это очень дорогой эксперимент очевидно если вопросы у нас из онлайна дайте сигнал и таких сигналов я не вижу и я в том числе а есть вопрос онлайн супер нету нету сигнальная система помоете у нас аналоговой она не очень строго и поэтому не очень получается такие аналогичным способом вы можете поднять руку и задать вопрос последний шанс потому что дальше мы игнатов проводим в онлайн кулуар с тем чтобы вы могли лично да есть вопрос ура здравствуйте мне николай зовут спасибо интересная штука очень вопрос такое планируете ли вы эту штуку сделать коммерческое продавать кому-нибудь еще не знаю каким нибудь сравнимым по объемам данных компаниям хорошо на бронер скажу честно мы думали над ним смысле мы несколько лет назад всерьез рассмотрели в том что он вложиться и сделать я вообще open source со мной летом после этого там в рамках индекс облака тогда только появляющегося начать продавать есть следующая проблема что у нас там все интерфейсы своей у нас все свое и это к сожалению означает что у людей будет очень тяжело этим пользоваться что люди привыкли там как в ходу пи запустить не знаю map комбайнер находятся так airflow находят рецептик копируют делают у нас многие вещи сделаны там гораздо удобнее гораздо лучше но нету никаких длинных инструкций нет такого наработанного опыта ответов и ощущение что это большое препятствие потому что ну hadoop кластеров на размерах 50 not не то чтобы у нас есть какая-то супер ценность 50 ноты и hadoop имеет кластеров на 1000 машин очень мало у кого есть люди все равно скорее будут там свое писать чем нашим решением пользоваться скажем не гнал какой из вопросов понравился больше всего меня вот последний понравился супер и приз получает представься пожалуйста тогда более официально николай завьялов из компании аркадия супер поздравим победителя нашего именно для тебя благодарю ассистенты тебя проводит цифровые кулуары с тем чтобы из онлайна могли с тобой тоже пообщаться"
}