{
  "video_id": "1Ih0bL2Zp1c",
  "channel": "HighLoadChannel",
  "title": "Пишем свой протокол поверх UDP / Александр Тоболь (Одноклассники)",
  "views": 8572,
  "duration": 3610,
  "published": "2018-07-19T04:55:09-07:00",
  "text": "уважаемые гости здравствуйте и мы начинаем наш доклад и я передаю слово александров здравствуйте как сказали да меня зовут александр я отвечаю за техническую часть видео в одноклассниках и сегодня мы с вами поговорим про то как писать свою dippy протокол зачем это может потребоваться напишем его узнаем все про другие протоколы стриминга видео и напишем свое мобильное приложение для стриминга поют и видео full hd это будет первое приложение с такой appstore и собственно говоря поехали давайте начнем с прямых эфиров из их истории да где-то там больше 50 лет назад прямые эфиры в россии начались появление вот этого троллейбуса это передвижная телевизионная станция которая позволяла вести эфиры первое это были спортивные эфиры вот она позволял вести эфир ней студии потом через там 56 лет перископ позволил вот этот вот троллейбус засунуть вам в телефон вроде бы да но нет мы протестировали это приложение и нашли ряд некоторых проблем связанных например с задержками в этих эфирах связанных с тем невозможностью стримить из более менее на наш взгляд приемлемых сетей и невозможностью смотреть трансляции если они в высоком качестве дальше мы об этих проблемах поговорим и где то через полгода мы запустили свое приложение мобильный аки life для стриминга которых мы порешали эти проблемы вот еще через несколько месяцев появилась появились прямые spears в инстаграме а вот в марте 2017 мы добавили возможность стримить с мобильного интернета full hd и провели прямые эфиры высокогорья собственно говоря поехали посмотрим как мы это все разрабатывали говорят что надо начинать всегда с архитектуры стз говорят без них нельзя ну что попробуем вот я понимаю сейчас утро еще не все проснулись тут надо собраться вот это вот архитектура любого стриминговый сервис а видео входит на вход преобразуется и выходит на выход вот к этой архитектуре мы добавили еще немножко требований что на вход оно должно входить с десктопов с мобильных телефонов она выхода должно попадать на те же десктопа мобильные телефоны смарте витом chrome касты балл тебе различные устройства все на чем можно играть видео дальше нужно перейти к т.д. если у вас есть заказчик у вас есть то за если вы социальная сеть таза у вас нет вот соответственно как его составить можно конечно попросить польза ли спросить все что они хотят но это будут куча листов просто их желание которое никак не коррелирует с тем что действительно надо и мы решили пойти методом от противного и посмотрим что пользователи не хотят видеть от сервиса трансляций ну первое что не хочет пользователь пользу не хочет видеть задержку на старте трансляции что еще пользу не хочет видеть пользу них очередь некачественные стримы вот ну и собственно говоря что еще не хочет пользователь он не хочет чтобы если у нас в трансляциях есть интерактив полетели общаться со своей аудиторией возможно там встречные прямые эфиры звонки еще что то вот при таком интерактиве пользователь не хочет видеть задержку вот примерно поддержки с ной опушке наш специальный корреспондент роман роман так слушайте роман я не понимаю о чем вы говорите скажите вы сейчас находитесь в лисод татьяна вот так выглядит обычный стриминговый сервис а теперь посмотрим как сделать так чтоб он так не выглядел ну собственно чего начнем попробуем вас еще немножко взбодрить кто из вас знает два и более протоколов стриминга поднимите руку вот много людей вот ну в общем да начать можно было с того что можно было посмотреть все протоколы стриминга выбрать наиболее интересны сравнить их вот но на самом деле все сделали по-другому во всех случаях давайте смотреть конкурентов открываем перископ и смотрим что у них ну как всегда наша главная архитектура смотрим вот сара лид инженер из перископа пишет что для бэг-энда не используют в отзыв а если ещё немножко почитать статьи мы увидим что стрим они делают sortie импе а раздают его либо в артем пи либо вылечилась вот дальше и посмотрим что это за протокола и как они работают потестируем перископ на наши 3 главных требований а скорость старта качества и задержки скорость старта у них приемлемая там меньше секунды на хороших сетях качество постоянная порядка 600 пикселей вот не hd и при этом задержки могут составлять до 12 секунд как собственно говоря померить задержку в трансляции вот фотография измерения задержки здесь вы видите мобильный телефон с таймером дальше к мы начать включаем нашу трансляцию и видим изображение то телефон на трансляции за 15 миллисекунд изображения попала на сенсор камеры и вывелось собственно говоря видеопамяти на экран вашего телефона после этого мы включаем браузер и смотрим вашу трансляцию собственно говоря ой она немножко отстала секунд так на 12 отлично надо поискать причины задержки по профилирует streaming итак у нас есть мобильный телефон как мы уже поняли видео идет с камеры попадает видео буфер тут задержки минимальной порядка там 15 миллисекунд потом она попадает в inquadr кодировщик кодировать видео упаковывают его в пакет и отправляется в соке тный буфер это все летит в сеть там дальше на вот том месте где она преобразуется происходит все то же самое и в принципе две основные точки трудные которые нужно здесь просмотреть это кодирование и декодирование видео и собственно говоря сетевые протоколы немножко поговорю о том про кодирование вам все равно придется столкнуться если вы будете делать лол и отнести streaming что такое видео видео это набор кадров считайте что но не совсем простых кадров их бывают трех типов айпи by flame айфрейм это просто g пешка по сути это опорный кадр он ни от кого не зависит вам пролетает четкая картинка есть пи фрейма они зависят исключительно на предыдущие кадры и есть такие хитрые бифы мы которые могут зависеть от будущего это означает что чтобы посчитать by flame вам нужно чтобы с камера пришли еще будущие кадры и после с некоторой задержкой поставок вам пришли камеры вы сможете by flame посчитать отсюда видно что by flame и вредны вот и попробуем их убрать если вы стремитесь мобильного устройства можно попробовать включить profile bass line оон отключит вам префреймы можно попробовать подтюнить кодек и тоже можно выключить уменьшить задержку на будущие кадры чтобы кадры быстрее приходили еще важная штука в тюнинге кодокан это включение себя констант нам битрейта собственная как работают кодеки вот здесь на картинке видно что вы снимаете видео там статическая картинка для диска он экономит память там почти ничего не меняется и битрейт видео низкий происходит изменения растет энтропия растет битрейт видео и для хранения этого на диске это здорово но для сети в этот момент вот это все что у вас выросла она скорее всего в сеть не пролезет это как раз то что происходит когда если вы делаете видео звоночки и вот начинаете поворачиваться то скорее всего на той стороне кому вы звоните у него будет подтормаживать это как раз будет связано с тем что вас битрейт вырос сосед не адаптировалась вот надо включать себя не все кодеки на андроиде его будут корректно поддерживать но они будут к этому стремится то есть нужно понять что идеальной картины себя аромат такой как мира как нарисовано внизу вы не получите но включить его тоже стоит и на бэг-энде необходимо добавить к 64 кода курировали pension вам позволит как раз не делать зависимости в кадрах на будущее в принципе на этом по кодеком наверное все это не тема тема у нас право протоколы давайте посмотрим какие протоколы стриминга нам предлагает индустрия я их разбил условно на два типа на потоковые протоколы и на сегментные протоколы потоковые протоколы это протоколы из-за мира пир toupper звонков это rtmp в партесь и они отличаются тем что пользователи договариваться о том какой у них канал они подбирают битрейт кодека соответственно каналу там есть дополнительные команды такого рода как дай мне опорный кадр то есть вы пришли кому-то вы сейчас нет опорника вы запросили получили если у вас получился дроп вы потеряли кадры в этих протоколах вы можете эти опорник еще и до запрашивать вот и секретные протоколы их отличие в том что никто ни с кем не никак не договаривается они режут видео на сегменты хранят каждый сегмент в различных качествах и клиент сам смотря может выбирать какой сегмент смотрят ну и в принципе каждый сегмент начинается с опорным давайте чуть чуть более детально посмотрим про протокол и начнем с спа тока вот протоколов из какие у нас проблем будет сталкиваться если мы будем использовать вот такой протоколы для братка снова стриминга вот перископ использует артем пи ар темпе появился где-то в 2009 году адоб сначала не полностью его специфицировать потом у него были определенного рода трудности с тем что a dog хотел продавать исключительно свой сервер для артем pi mod развивался довольно трудно но основная проблема в том что он использует теперь но почему-то его выбрал перископ давайте посмотрим если почитать детально то вы увидите что перископ для трансляции с малым количеством зрителей используют or темпы и как раз для таких трансляции если у вас достаточный канал скорее всего вы их не сможете посмотреть что происходит вот тут немножко обратный пример у нас есть пользователь с низким качеством которые смотрят вашу трансляцию вы с ним договаривайтесь партии mpi о низком битрейте начинаете персонально для него стримить к вам приходит еще пользователь с классным интернетом у вас тоже классный интернет но вы уже с кем-то договорились о низком качестве получается так что они не смогут его смотреть эту проблему мы решили устранить мы добавили возможность того чтобы можно было этот артем пи подрезать для каждого клиента персонально то есть стремись и договариваться сервером стримит на максимально возможно возможном качестве и каждый клиент это получает тоже то качество которое позволяет ему сеть здорово но все равно rtmp у нас есть на типе и никто нас от блокировки начало очереди не застраховал вот посмотрим на картиночка у нас есть аудио фреймы видео фрейм они поступают артем пик пакует может и как-то перемешивать от него не улетают сеть тут мы теряем один пакет все это к нам прекрасным образом приходит и тут бы мы могли во первых возможно тот самый желтый потерянный пакет это вообще by flame от какого-то предыдущего его можно было бы дропнуть возможно аудио можно было как минимум играть но при этом типе нам не отдаст пакета так как он гарантирую что гарантия доставки постоянность пакетов вот то есть с этим надо как-то бороться еще одна проблема использования протокола тисе пи стриминге это собственно говоря у нас есть буфер у нас есть высокая пропускная способность сети мы генерируем туда из кода к из нашего пакета высоком разрешении потом у нас об и сеть стала работать хуже находок и мы уже сказали что битрейт нужно понизить но пакет и мы уже в очередь засунули неким образом их изъять оттуда не может и он отчаянно пытается наши hd пакеты пропихнуть через наш 3g собственно говоря у нас нет управления и какое буфером вот поэтому теперь крайне не подходит для стриминга теперь давайте взглянем на наши мобильные сети вот этот наверное у жителей столицы как бы будут будет изумление но наше мобильное средняя сеть выглядит примерно так 1 1 мегабит трафика 0 1 пакет пакет лосс и средний pink 300 миллисекунд а если начать смотреть какие нить регионов и какие-то конкретные операторы вот там вот в углу есть пример то у них средний дневной пакет лосс выше трех процентов ну и round trip как бы от шести 100 миллисекунд это нормально так собственно говоря тисе пи это да и то с одной стороны классный протокол очень трудно научить машину ездить сразу же эпохой бы по бездорожью но вот научить ее потом еще и летать по беспроводным сетям оказалась очень сложно вот пример работы окон и и в зависимости скажем здесь на этой картинке вы видите мобильный интернет пора мега пара мегабит в секунду вы видите на другом по оси y график пакет лосс и оставшись пропускная способность с ростом этого пакета с видно что даже на одной тысячной процента процента вы уже теряете порядка тридцати процентов пропускной способности то есть среднем нашей пользователь 30 процентов пропускной способности интернета теряет просто на проблемах тисе пи а в определенных регионах если вас прикид лосс дошел хотя бы там до одного процента то у вас остаются просто какие-то там десятки процентов вашей пропускной способности поэтому найти себе делать не будем посмотрим что у нас есть еще четыре в мире стриминга из люди пишут есть такой протокол в партесь и он очень хорошо зарекомендовал себя для upper toupper звонков не как некий стандарт вот если посмотреть на очень популярных сайтах тут пишут что использовать для звонков и очень здорово от использовать для доставки видео и музыки не хорошо вот основная проблема в том что он пренебрегает потерями то есть самое при всех непонятных ситуациях он просто дропает еще некоторая проблема с его привязанности к звонкам в том что он шифрует все и поэтому если вы ведете брюс отказ ну трансляцию и вам нет необходимости шифровать весь аудио-видео поток если вы запустить через в партесь и вы будете напрягать свой процессор возможно вам это не нужно еще есть такая штука как ртп ртп то такой базовый протокол передачи данных пою т.п. ну вот справа вы видите набор extension of к-т рпц всяких которых пришлось реализовать в партесь и для того чтобы этот старый протокол адаптировать для звонков в принципе можно пойти по такому пути и попробовать вот сделать что-то подобное набрать набор ок старшинов карта п и получить у деби streaming но это очень сложно и вторая проблема в том что если кто-то из ваших клиентов не поддерживает какой-либо extension to собственно говоря streaming у вас уже не завить ну протокол не заработает переходим дальше рассмотрим какие еще есть сегментные протоколы хорошим примером сегментного протокола является видео является эффект дэш он состоит из манифестов вот вы какой то манифест файл выкладываете у себя на портале вот он содержит ссылки на файлы в разных качествах в начале файла есть некоторые индекс который говорит в каком месте файлы начинается какой сегмент то есть все видео разбита на сегменты о например по три секунды каждый сегмент начинается с опорного кадра и если вы смотрите такое видео и у вас меняется битрейт то вы просто на стороне клиента начинайте менять тот сегмент братья с того качества которое вам нужно еще одним примером сегментного стриминга является и чавес если дадеш это был было решение скажем от google она хорошо работает в android то это решение более старые у него есть определенный ряд недостатков первая из них это то что основной сегмент основной манифест содержит ссылки на вторичной манифесты а уже вторичные манифесты по каждому конкретному качеству содержат ссылки на каждый отдельный сегмент а каждый отдельный сегмент представлена отдельным файлом если еще более детально взглянуть-то внутри каждого сегмента находится и mpeg-2 ts это очень такой протокол который еще делали для спутника и размеры у него пакета сто восемьдесят восемь байт упаковывать видео в размер пакета сто восемьдесят восемь байт очень не удобно особенно что все время снабжайте фидером небольшими на самом деле это трудно не только сервером которая его для того чтобы обработать трафик 40 гигабит должны там 26 миллионов пакетов собирать но это еще трудно и на клиенте вот поэтому когда мы переписали в ios плеер на дэш мы даже увидели некоторую производительность вот но apple не стоит на месте и вот в шестнадцатом году они наконец-то анонсировали что у них есть возможность запихнуть фрагментом темпах 4 вычел с если это кто-то делал скажите потому что мы как бы поленились они обещали в шестнадцатом это добавит только для девелоперов вроде бы сейчас должна появится поддержка на вот маках и айос до фрагмент ный streaming всем классно приходите берете нужный фрагмент с опорного кадра стартуете работает минус понятное дело что тот опорный кадр из которого вы стартовали это не тот кадр который сейчас у того кто стримит поэтому у вас всегда сразу появляется задержка вообще есть возможность обе перейти через до задержек там порядка пяти секунд кто-то говорит что ему удалось там четыре получить вот но в принципе решения использовать сегмент фрагмент ный streaming для трансляции не очень хорошая ну что посмотрим на все имеющиеся протоколы и папа сортируем их таким вот образом это latency которые они дают между трансляции и смотрящим а это их сложность чем соответственно протокол гарантирует вам меньшую задержку тем он более сложный собстна говорят что мы хотим мы хотим сделать эдипе протокол для стриминга от одного кэн с задержкой сравнимый спирту пир связью вот с возможностью шифровать пакеты опционально в зависимости от того приватной публичной трансляций и так далее вот какие есть еще варианты можно подождать например когда google выпустит свой quick или kvites кто знает что такое квик ох как много знает здоров но все-таки где-то меньше половины чуть-чуть расскажу google quick это такая штука google наверное вас позиционирует как замену как раз tcp нет некий типе 20 вот разрабатывать они где-то с 13-го года сейчас спецификации у него нет зато он доступен полностью в google chrome имя кажется они иногда его некоторым пользователям таки включают для того чтобы смотреть как он работает в принципе можете прилетим зайти настройки включить себе quick пойти на любой google сайт и вы получите этапа этот ресурс по и т.п. вот ну мы решили не ждать пока ничего специфицировать и решили запилить свое решение что мы решили какие требования предъявить протоколу мы решили штамм протоколе нужно многопоточность то есть мы имеем несколько потоков это там управляющий это видео аудио мы хотим иметь опциональную гарантия доставки потому что управляющий стопроцентная гарантия видео нам нужно меньше всего мы там можем дропать фрейм аудио нам все-таки хотелось мы хотим приоритизировать а понимать чтобы audi у нас уходила вперед а управляющий вообще летел вот и хотим иметь возможность шифровать или все все данные или только заголовки и критичные к атакам данные ну собственно говоря до стандартный треугольник если у вас хорошая сеть то у вас высокое качество низкие задержки как только у вас появляется нестабильная сеть у вас начинают пропадать пакеты вы начинаете балансировать начинаете балансировать между качеством и задержкой у вас есть выбор либо подождать пока сеть наладится и отправиться что есть высокого то что вас накопилось да либо дропнуть и как-то с этим жить а если по сортировать протоколы по такому принципу то видно что чем меньше latency тем хуже колоти вот довольно простой вывод мы хотим свой протокол запихнуть вот сюда вот где иметь возможность заиметь задержки близкий клипарт eps но при этом иметь возможность его немножко отодвинуть потому что все таки это не звонки это трансляции польской хочет в конечном итоге получать качественный стрим вот чтобы это можно было чуть ну что давайте начнём писать о типе протокол как мы это всегда а с чего мы начинаем посмотрим статистику вот собственно говоря наша статистика по сетям по мобильным ну тут вот видно что средний интернет как раз там одессе чем-то мегабита будет пакет лосс под процент это нормально да и пинги он в районе шести 100 миллисекунд на 3g это просто средней величины будем у на это ориентироваться при написании протокола ну что поехали открываем виде печные socket забираем данные упаковываем отправляем берем вторую пачку нам кодек вернул еще отправляем вроде бы все здорово но мы получим вот такую картину если мы начинаем беспорядочно слать эдипе пакеты socket то вот поводу этой статистики там 20-20 первому пакету вероятность его дохода а будет всего лишь 85 процентов то есть уже будет packet loss 15 который просто никуда не годится это нужно фиксить фиксится это стандартно собственно говоря вот это вот жизнь без спейсера а это жизнь спенсером пейсер это такая штука которая раздвигает пакеты скажем так во времени и контролирует прикид лосс на смотрят какой но сейчас покидал зависимости от этого адаптируются под скорость канал отлично дальше как мы помним для мобильных сетей 13 процентов packet loss то норма будь соответственно надо с этим как-то работать что делаем место теряем пакеты ну собственно говоря есть и happy мы наверное все знаем есть такой алгоритм phase 3 transmit мы отправляем 1 пакет второй пакет об пакет потеряли и тогда через некоторое время отправляем собственно говоря через и transmit период отправляем этот же пакет собственно говоря какие здесь плюс и никаких проблем никакой избыточности собственно говоря но но минус есть некоторые transmit период давайте попробуем на него взглянуть кажется что очень просто через какое время нужно повторить пакет если вы не получили на него окно lodge ну логично через pink вот давайте посмотрим пинга нём наш highload сегодня через наш прекрасный вай фай вот посмотрим на наши времена тут вот 100 миллисекунд сто семьдесят шесть миллисекунд мы видим что pink это вообще увеличена вообще ни разу не стабильная и поэтому точно через время pink мы понять не через некоторые ртт time наш средний мы определить точно что мы потеряли пакет не можем для того чтобы это оценить можно например использовать такую величину как джиттер мы посчитаем div и между всеми нашими pink пакетами вот например было четыре пакета 3 интервала взяли эти интервалы посчитали среднюю величину как раз в сорок шесть миллисекунд у нас джиттер вот средний на портале у нас 50 в принципе вот в этот вайфай работает примерно как средний мобильный интернет наших пользователь отлично вот если посмотреть на времена приходов на распределение вероятности приходов пакетов то время не вот здесь у нас будет round trip а здесь у нас будет некоторая величина после который мы можем действительно понять что окно лучше не пришел и повторить пакет принципе есть алексей который в тисе пи говорит как это можно хитро посчитать мы это делаем через джиттер примерно на портале 15 процентов у нас джиттер по пингу то есть понятно что при transmit у вас случится через ртт плюс там 20 процентов как минимум сделать вот как можно это пофиксить а давайте посмотрим еще на один кейс с ре транслитом у нас с прошлого раза был окно луч на второй пакет вот мы отправляем третий пакет какие-то пакеты ходят после этого у нас случается и transmit период мы отправляем пакет после этого он еще раз дропнул ся и еще раз отправляем его и вот собственно говоря если у нас случается двойной поки дроп tonari транс митя у нас появляется такая проблема что если у нас например пакет лосс пять процентов мы отправляем 400 пакетов то на 400 пакетов у нас один раз точно будет вот такая ситуация двойного пайки дропа то есть когда мы через экран смит период отправили пакеты он еще раз не дошел эту ситуацию можно пофиксить например добавив некоторую избыточность можно начать отправлять пакет например если мы получили окно лучше от другого пакета считаем что rewarding еда редкой ситуации можно подписать например сюда вот если там еще пошаманить со спекулятивным петром смитом то можно эти проблемы побороть и он неплохо работает но тут мы заговорили про избыточность а что если добавить for there a correction давайте просто все наши пакеты снабдим например к ссорам если мы точно знаем что мобильные сети такое и там 1 процентный пакет лосс это прям вот поголовно у всех просто добавим еще один пакетик вот здорово у нас нам не нужны никакие round trip и вот мы да но у нас привязка это избыточность а что если у нас пропадет ни один пакет а сразу 2 ну давайте место к ссора есть например там коды рида-соломона есть фонтейн коды там еще можно понять всяких решений идея будет такая что если у вас есть к пакетов вы можете к ним добавить н пакетов так что вы любые можете потерять вроде бы классно хорошо если у нас такая плохая сеть что у нас пропали просто все пакеты то к нашему for correction у очень удобно добавляется негатив окно логично что это у нас есть отправка пакетов тут мы теряем пакетик тут наш сервер понимает что мы потеряли столько что наш наш парите protection нас уже не спасет назовем его так вот и соответственно запросит этот пакет дополнительно и эту ситуацию нас по фиксится плюсы на к он простой правда можно сомневаться пак нужен потерять но это проблема такая мелкая вот и хорошо совместим спект смотрите у нас есть два интересных решений у нас есть с одной стороны эффект + лак с другой стороны phase 3 transmit здорово посмотрим как у нас распределены потери пакет оказывается что пакета теряются неравномерно по одной штучке а пачками и вот это график этих распределений причем есть такие интересные пике там на 11 пакетах есть еще пекина 60 80 пакетов они главы повторяются мы ещё изучаем откуда они берутся вот но средний гэп потери пакетов 666 на портале 6 если посмотреть детально по сетям то вот в чем хуже сеть тем больше гэп и здесь вот есть некоторые времена сколько сеть была недоступна то есть вот вай фай там по 20 миллисекунд недоступен теряет 5 пакетов там 3g может 30 миллисекунд за 8 потерять восемь пакетов за 30 миллисекунд и так очень хитрый вопрос к аудитории если мы с вами знаем что у нас средний 90 процентов packet loss на портале укладывается в 10 пакетов и при этом средний глеб у нас там 25 миллисекунд давайте попробуем подумать что будет работать лучше эффект плюс на к или phase 3 transmit давайте кто за farther correction поднимите руки прогрессивная аудитория а кто за phase 3 transmit ну примерно поровну распределилась вот ну тут наверно надо рассказать что google когда делал свой протокол quick 2013 году они как раз farther correction стояли просто во главу этого протокола что он решит все проблемы в 2015-м они его отключили вот мы протестировали оба варианта и у нас не получилось завести эффект плюс нак но мы еще пытаемся и не отчаиваемся давайте рассмотрим как он работает цифры и близкие к средней сети просто чтобы было удобно считать у нас есть 1 мегабит на сеть однопроцентный тепло сам у нас есть 300 миллисекунд round trip time мы в такой сети будем слать пакеты размером в 1000 байт и при этом у нас будет как раз 1000 пакетов в секунду ходить здорово захотим мы пофиксить пекин гэп в 10 пакетов то есть если мы теряем 10 пакетов или менее мы хотим это фиксить соответственно при пайке площади в один процент нам нужно к тысяче пакетом добавлять 10 ну логично почему не можем каста пакетом добавлять 1 потому что если мы потеряли интервал хотя бы два пакета мы не остановимся вот мы начинаем делать такие добавления и вроде бы все здорово и тут мы на середине наших тысячи пакетов на 500 ом теряем эту самую пачку 10 и у нас собственно говоря есть вариант мы можем дождаться оставшиеся там 500 пакетов и восстановить через наш farther correction эти данные но на это на вас потратиться примерно пол секунды а пользовались данный ждет можно при этом взять и воспользоваться на ком получается что накал можно воспользоваться дешевле чем дожидаясь наших кодов коррекции а еще на самом-то деле можно было просто взять phase 3 transmit не добавлять никаких кодов коррекции получить собственно говоря тот же самый результат поэтому farther корректно работает но работает на очень узком диапазоне то есть вариантов когда у вас грипп небольшой вот и вы можете там хотя бы там в раз в двести-триста пакета вставлять эти избыточное кодирование вот а как работает phase 3 transmit вот мы отправляем пакет и после этого мы теряем нашу прекрасную пачку в 10 пакетов отправляем другие пакеты понимаем что у нас три transmit период прошел и отправляем эти пакеты что здесь самое интересное ри transmit период на такой сети будет 350 миллисекунд средний там duration это вопреки депо будет там 30 миллисекунд ну пусть даже 100 означает что к тому моменту когда ри transmit на 4 трансмиссий пакеты то в большинстве случаев у вас ведь уже восстановится они уйдут вот вот у нас получилось что эта штука работает лучше и быстрее отлично когда вы пишете свой протокол на юге п и у вас есть возможность отправки пакетов вы получаете дополнительные плюшки и опции вот у вас есть буфер отправки у вас там лежит опорный кадр к нему лежат baby фреймы они у вас равномерным к пещерам так уходят сеть тут они перестали уходить сеть больше не уходят в очередь прилетели еще пакеты и вы тут понимаете что на самом деле все пакеты которые у вас лежат в очереди они уже больше не интересны клиент потому что прошло например там больше полусекунды эту трансляцию уже нужно дропать пакеты и там на клиенте просто склеиваться и жить дальше вы можете в знаю информацию о том что у вас хранится в этих пакетах почистить не только опорник ну и все пиби фреймы на него зависящее и оставить исключительно те данные нужны и целостные которые можно потом потребоваться клиентов да так как мы сами пишем протокол дальше мы столкнёмся с такой штукой как айпи fragmentation я думаю многие знают но на всякий случай можно и и быстренько представить так у нас есть наш например сервер отправляет какие-то пакеты в сеть они приходят комнату маршрутизатору и там and у на его уровне становится ниже чем тот размер пакета которому пришел он дробит пакет наконец большой маленький вот у нас здесь на 1100 например 400 байт и отправляет в принципе проблемы нету это все соберется на клиенте и будет работать но если мы теряем с вами один пакет мы дропаем все пакеты плюс мы испытываем дополнительно overhead на хедиры пакетов поэтому идеально работать если вы пишете свой протокол в размере mtu как собственно говоря его посчитать на самом деле гугл вообще не париться они там что-то типа пищи 200 байт в целом крики ставят и не занимается подбором потому что и дефрагментация на вам потом все пакетики то соберет мы делаем точно так же мы сначала ставим какой-то дефолтную пакет сайт начинаем слать пакет и пусть он их фрагментировать параллельно мы запускаем отдельный трек и создаем socket которому говорим выстави нам всем пакетным флаг запрета фрагментации если маркизата встречает такой пакет и не может эти данные фрагментировать но ему необходимо фрагментировать и седан это он этот пакет дропа это возможно паисием пивом отправить что есть проблемы скорейшего семьи будет закрыт это не будет работать поэтому мы просто три раза например пытаемся отправить каким-то интервалом дан пакет определенного размера если не дошел мы считаем что он был превышен и дальше его уменьшаем таким образом имеем ту вашего интернет интерфейса который вас есть на устройстве и какой-то минимальный ту просто бинарным поиском подбираем тот правильным tool и после этого уже в середине в какой-то момент работы пакета его работы протокола корректируем размер пакета вот например здесь говорим понимаем что им ту максимальной 1100 выставляем и дальше живем в формате именно размеры mtu на самом деле иногда меняется мы были удивлены но в процессе или переключения там вайфай или еще куда то у меняется и эта штука параллельный процесс его лучше не останавливаться время от времени на самом деле проче кивать и подправлять это распределением ту в мире у нас получилось где-то 1000 ступать на портале шифрование да мы говорили что мы хотим опционально управлять шифрованием делаем самый простой вариант делаем диффи-хеллмана на лифте ческих кривых сделаем его опционально шифру им только управляющий и заголовки чтобы мы он замедлил не мог получить ключ трансляции перехватить и так далее если у вас трансляция приватные мы понимаем что этот стриме для всех тогда можем добавить еще и шифрование всех данных пакеты шифру и моя сун 256 независимо чтобы если мы понимаем что пойти дроп у нас возможен то вы могли дропнуть это никак не влияло на дальнейшее шифрования пакетов какие ещё штуки можно мы хотели от протокол мы хотели приоритизации у нас есть на картинке пакеты с метаданными у нас есть аудио фреймы и вата и питта все видео фреймы мы отправляем их успешных сеть потом наша сеть где-то сгорает в аду и начинает не работать и долго-долго не работает и тут мы понимаешь нам нужно дропать пакет и соответственно мы приоритетно тропами видеопакеты потом уже пытаемся дропать аудио и никогда не дропаем управляющий пакет и потому что по нему ходить такие данные как изменение разрешения стрима там еще какие-то вопросы вот собственно говоря это мы тоже сделали наверное кто-нибудь из вас скажет по поводу и т.п. это такая дополнительная плюшка если будете писать свой протокол и например с двухсторонней связью то нужно понимать что есть натан байден есть шанс что вы обратно не сможете например сервера найти клиента и как раз вот это вот есть времена того когда вы не даст учитесь до клиента сервера пою т.п. просто многие скептики говорят что амортизаторы устроены так что натан банкингом вытесняют в первую очередь именно в дипе маршруты ну вот тут видно что если вы будете свой keep-alive или там pink делать меньше 30 секунд то в принципе вы клиента будете достигать там с вероятностью 99 до доступность youtube и на мобильных устройствах в мире google говорит 6 у нас получилось семь процентов пользователей не могут пользоваться их теперь в этом случае мы оставляем наш прекрасный protocols политизации с плаванием и всем только конечно же его фалби чем нати спит на юге пища сработает voip а вы порты c google quick пытается делать на этом и многие игры работы при гриппе поэтому верить что идите на мобильных устройствах закроют я бы не стал так что мы в итоге зато все получили мы снизили задержку между стримером и смотрящим до 1 секунды избавились от накопительного эффекта в буферах то есть трансляция скажем не отстаёт во время жизни вот у нас снизилось количество столов и зрителях и мы смогли поддержать на мобильных устройствах full hd streaming of да куда это и как мы это все внедрили собственно говоря по мере померяем задержку в нашем мобильном приложении о клайв вот это вот наше устройство с предстоя мерам это приложение вот почему так life на 10 миллисекунд дольше рисует то что вы снимаете с камерой на экране это не так страшно а вот вы видимо трансляцию на веб и увидим задержку всего 690 миллисекунд в космос что ещё у нас умеет streaming на одноклассниках собственно говоря он принимает протоколы наш протоколов комп с мобильных устройств может принимать арт mpv партесь и и собственно говоря выдавать вам на выходе тоже дышит через app темп и так далее если кто-то был внимательный то увидел что мы тут сказали что мы можем взять у пользователя в партии se а с конвертить его в rtmp вот тут будет некоторые нюанс что на самом деле в партесь и как раз протокол ориентированы на дроп пакетов и у него как раз аудио кода корпус используется вот опор tempus засунуть нельзя у себя на серверах бэг-энда внутри когда мы перекидываем видео мы везде используя март м.п. поэтому нам пришлось сделать еще некоторые фиксов им беге который позволяет запихнуть опус в rtmp его от конвертить чтоб потом запихнуть об запихнуть опус dover tmp чтобы вас конвертик потом дальше пользователям бац и и отдать уже там или вы учились или еще в чем-то отлично как это выглядит у нас внутри вот пользователям по одному из протоколов загружают на наш оплот сервера там мы разворачиваем протокол внутри paar темп и отправляем на один из серверов трансформации видео всегда оригинал сохраняем наши распределенное хранилище чтоб не дай бог что не пропала после этого мы эти все видео поступают на сервер раздачи что-то у меня сел другому кто то завис в чем совсем давить он заработал лично да собственно говоря по железу у нас получилось 3 оплот сервера 150 серверов нарезки и 27 серверов раздачи видео если чуть-чуть про отказоустойчивости только это работает оплот сервера распределены по разным дата-центром стоят за разными а фишками пользу я переходят по dns и получает эти пешки какой-то из них коннектится соответственно плод сервер отправляет видео на сервера нарезки те нарезают отдают сервером раздачи сервера раздачи под более популярной трансляции мы начинаем добавлять больше количество серверов и собственно говоря все что пришло от пользу и сохраняем в хранилище чтобы потом создать архив трансляций и ничего не потерять хранилище отказоустойчивые распределенная тоже по трем дата-центром как мы определяем какой сервис сейчас отвечать за трансляцию для этого используем звуки перри для каждой трансляции храним ноду там делаем эфемерной но ты под каждый сервер по сути такая штука которая позволяет для кого-то стрима создать очередь серверов которые будут обрабатывать и всегда текущий лидер в этой очереди занимается обработкой стрима тестировать отказоустойчивость будем по быстрому и начнем сразу же пропадания всего дата-центра вот что при этом произойдет пользователь надо и носи возьмет следующая пешку другого apple о от сервера к этому времени звуки пир поймет что сервер у него уже в транс форме в том дата-центре умер вы выберет для него другой сервер нарезки download сервера узнают кто теперь отвечает за трансформацию этого стрима и будут это раздавать в принципе все произойдет с минимальными задержками до продукт куда это все уехала мы запилили мобильное приложение для стриминга клайв она полностью интегрирована с порталом в пользователи там могут общаться вести прямые эфиры там есть карта эфиров популярны в общем все что можно хотеть также мы добавили возможность вести эфиры full hd к андроиду можно подключать android экшен камеры да зачем мы это все делали если у вас есть такой механизм который он позволяет вести трансляции то вот мы проводили прямую линию с президентом через а клайв и мы делали трансляцию президенты на всю страну пользователи смотрели и при этом через встречной стрим могли попадать в эфиры и задавать свои вопросы то есть по сути у вас два встречных стрима на минимальной задержки обеспечивает вам некоторые формат такой публичный конференц-связи вот на самом деле мы где-то уложились порядка 2 секунд туда и обратно секунду за секунду обратно но например вот помнить этот троллейбус который вначале был презентациях вот он сейчас выглядит как два огромных грузовиках и в принципе для этого эфира у них просто снять с камеры все смикшировать порядка одной двух секунд задержка это тоже нормально то есть на самом деле в принципе нам удалось у себя воспроизвести что-то сравнимое с текущими современными процессами так какие у нас цифры по нашему приложению нас порядка 2000 online stream of 3 миллиона установок приложения у клайв и 30 миллионов просмотров этих эфиров в сутки прямые эфиры это текущий тренд за последние полтора года они выросли в три раза в на портале og и не без помощи приложения у клайв да все трансляции которые вы ведете по умолчанию записываются у нас порядка 50000 прямо в сутки это все генерирует порядка 17 терабайт трафика в сутки а вообще все видео на портале генерирует около петабайтов данных в месяц как хранить эти данные можно будет послушать на следующем докладе который будет здесь же 12 так что не переключайтесь до что из этого всего получили мы мы смогли гарантировать задержку между стримером и зрителям сделали первая мобильная full hd приложение для стриминга на мобильном интернет-канале меняющимся получили возможность терять дата центры и при этом не прерывать трансляции что и узнали вы сегодняшней презентации вы узнали что такое видео какого стримить узнали что в принципе можно писать свой и дипе протокол если вы точно знаете что вас очень специфичная задача и конкретные допустим пользователи вот и собственно говоря вы узнали архитектуру любого стриминговый сервис а видео входит на вход преобразуется и выходит на выход спасибо саше еще раз отличный доклад вопрос прозевал ли tense а также как этапе битом фреймы да это называется игра да то есть это все история по поводу того чтобы условно говоря экономить трафик да то есть условно для разница между p и бед и видимо где дельта меньше вперед или назад или или какая другая логика работает и такой же вопрос прямо зависит от кадров в будущем то есть для того чтобы построить by flame тебе нужно дождаться ещё сколько-то кадров из камеры то есть еще три кадра например ты ждешь и у тебя зависимость прям то есть уголь что вот в этот объект там возьми оттуда сейчас то есть история как-то минимизировать дельту или или то есть что сделать кое-что это все на дельтах работает к опорному кадры или там последовательно дельта к опорному кадру но здесь дельта в обратную в отрицательный он смотрит куда больше куда меньше из соображений экономии трафика из каких соображений просто выбираю зачем кодек делает by flame и для того чтобы эффективнее жать он станет гораздо более оптимальным если начинает следующий кадр генерить не только в зависимости от дефа предыдущих но еще и может какие-то объекты брать из будущего и заднего айфрейм а например вот если это тоже ну история про это же то есть просто отключить те которые всем спасибо большое что теперь слышно очень крутой доклад спасибо вы вначале рассказали про винить рты и говорили какой он не прикольно то что работает по тисе пи когда у него есть протокол двойник артем с и который работает в египте почему вы про него ничего не сказали да мы знаем это действительно скажу так арт mfp это полный аналог voy por ti si его основная как бы на нем хорошо делать например пир toupper звонки и он поддерживается в принципе во флеше наверное в первую очередь из клиентов ну собственно говоря это как раз то почему что мы хотели контролировать вот этот баланс между качеством и тропами спасибо еще майки вопрос когда будет в open source и кодек и какие кодеки энкодеры вам больше понравится то есть mx200 64 65 или какие у вас мысли по этому поводу спасибо отлично первый вопрос про open source собственно говоря как только директор выделить время на так сказать оформление всего в этого open source мы с радостью это отправим а второй вопрос про кодеки почти случаев используем h 264 аж 265 имеет проблемы с поддержкой на различных браузерах вот например если уж смотреть випе 8 он хорош для конференц-связи позволяет дропать vp9 который использует google мы не смогли завести нарезку в него то есть випе 9 на самом деле современный сервер вам какой-нибудь 1080 может резать там со скоростью 2 3 fps а и хардварные акселерацию випе 9 нету вот то есть классный кодах используется google можете играть его кроме где-нибудь но вот нарезать если у вас есть поток you джесси видео в него у вас не получится поэтому по большей степени 206 от 4 используем ответил давайте александр спасибо за интереснейший доклад вопросик следующий насколько я прямо ему в отличный египте протокол со здорово быстрый но понятно что он работает видимо только между там приложением до вашем смысле да потому что в браузере нативной поддержки как же ничего нету я так появляться чехол бог идет на smth or темпа на or темпы в данном случае был артем пи через зал transflash или в если могу сильно приложение мобильное приложение на мобильное приложение если наш immobilier лабильный мысли веб-приложений на мобильном зайти через браузер то это все-таки mpeg и т.д. да да если запал бачек мобильный браузер тазов lb чит на душе лечилась и задержка будет в среднем там 5 6 вот те короче которые есть добром десятке спасибо здравствуйте да спасибо вам за очень интересный клад а скажите вот ведь skype и разные другие мы месяц ну видео средства для видеозвонков вроде бы работают с задержкой меньше чем секунда hd и ну разве это проблема как бы чем отличается вот проблема видеозвонков и личных с проблемой стриминга почему эта проблема в скайпе вроде бы решено было давно ну давайте так у skype свой проприетарный протокол его аналог полностью доступны везде его пан source и который сейчас такой стандартом является для проведения звонков это в партесь и собственно говоря в партесь и я рассматривал все его проблемы в докладе основе проблема что он дропает в первую очередь вторая проблема что если вы берете телефон вы наверно замечали как у нас шикарно греется при звонках вот это как раз то что он использует иногда бывает использовать коды крепи 8 например софтверной а еще проблема что он все шифрует то есть на самом деле в пенс ну доступность аналог skype это в порты c в партер он очень сильно запили запилен на пир toupper то есть для трансляции мы батарейку живем в разы меньше чем ваши звонки ну и наверное третье что вы можете посмотреть вы берете звонок смотрите он другому час на мобильном интернете попробуйте начните вот так двигаться и вы увидите что у вас там будут небольшие заедания голос у вас будет идти в приоритете вам будет нормально пропавший кадры вам на более-менее но для трансляции стримеров которые вели там транс каскад мероприятие это крайне неприемлемо здравствуйте спасибо за год у меня такой вопрос а цифры показывали кадр по поводу концертного протоколов концерна за нахождение окна в тисе пи вот какой из них вы используете себя где-нибудь он вагон тогда я я примерно помню что там было давайте не буду не буду этот слайд искать там была история в том что вы видите на графике различные протоколы окна тисе пи и с ростом пайки plaza у вас падает пропускная способность мы сейчас у себя на видео используем алгоритм окна бибер потому что он наиболее лучше адаптированы именно copycat лосс принципе все еще такой образ смотрите вот когда вы про rtmp рассказали разделить одну трансляцию качество ли такой вопрос как у вас клиенты как подключается к rtmp осенью хотят какое-то качество подключается к одному поток потом у них интернет упала не подключаться к другому по току или как это происходит вот сейчас не совсем понял у нас есть клиенты они смотрят артем пии если можно изменить качество они общаются севером сервер выбирают наиболее ближайшие качество под тот интернет который им доступен то есть сервер убирает necklace сервера то есть к любой клиент может учиться к вашему attempt ему автоматически будет автокачество да спасибо я вас нет у меня вопрос вот эти 13 процентов потери в мобильных сетях это для видите протокола или для теперь вопрос там сравнили ли вы работу потери 10 пакетов и типы пакетов может быть оборудование лучше оптимизирована для работы были у вас проблемы внедрения да если можно доверять нативной статистике android то у вас там есть очень небольшие некоторыми возможностях оками глеб мы поверить не сможете но устройство сможете спросить пакет лосс и packet loss happy сравним стикиз packet loss и т.п. все больше работаете ли вы на поддержкой нативных браузерах плагины может быть какие то нет мы стараемся как раз до браузера заставлять стандартными протоколами или в партесь или артем били и человек гарнируйте нет вот прям совсем нет еще спасибо за доклад такой вопрос вот вы часто говорите про получите впервые на мобилки впервые какая пропускная способность нужна для того что форде телефона транслировать ну давайте мегабит от 3 на время это три хорошо и второй вопрос высокие live at как-нибудь связаны или не завершена 2 параллели разработать совершенно 2 правильно хорошо добрый день и спасибо за доклад подскажите пожалуйста как вы прижимаете роуминг а есть ли какие-то проблемы с этим ролик с мобильных девайсов и если есть какие то проблемы то чем модифицируются сессия общение а может быть немножко добавить и детали я просто мне кажется что роуминг эта проблема клиента он как-то должен это переживать платить за него а мы не переживаем здоровье doramin кни за границей а при приключение 5-ти а примирилась внезапные intent и если in point и поменялись то как вы продолжаете модифицировать эту сессию и эта проблема решена с помощью того что сессия инфицируются каким-то большим числом случайно да у нас также в каждом пакете есть некоторые айди сессии и понятное дело что если вы поменяете свое пиш никто поэтому эти сессии она установится и будет продолжаться то есть как бы меняющейся айпишник мобильного клиента это ну как бы понятно что я понимаю а вот дальше когда у вас допустим случился роуминг вы начинаете пересчитывать пинту например pen tool делать заново нет мы его постоянно в бэкграунде делаем да если сеть меняется то мы его тоже пересчитаем у меня практически доклад вопрос практически трансляция highload происходит через одноклассники если нету почему наверное это вопрос коллегу бунина я тогда происходит не через одноклассники но мы бы с удовольствием бы и провели спасибо спасибо за доклад и хороший поток смотрите высказались то что вы пожалуйста что skype греется во время соответственно работа с мобильных устройств и пожалеем утонули что вы шифруете aes-256 тоже с мобильного устройства весь поток а если процессор не поддерживает а я здесь 56 железно то это будет софтовая pset ваша не знаю положить рядом skype и ваши наклонялась позже хочешь весь поток шифруете только и фреймы либо только несколько у нас был опыт я на предыдущем месте работы довольно долго моим пик треск который вы только что так опустили за сто восемь байт соответственно мы шифровали не все мы шифровали довольно майка процент это было более чем достаточно питер им да хорошо спасибо я вас понял про шифрования основная тема что это приложение пользователи используют братка стримы на бродкаст стримах если вы делаете публичный стримы вообще видео и аудио не шифру и мы шифрами только управляющий управляющий поток и хедиры то есть получается у меня вот мобильная трансляция с 1 класс никогда не будет шифон нет ни вайшьев ровно и и любой другой если вы включаете и приватно и тогда она начинает шифровать нет был шифроваться только аудио и айфрейм и как вы сказать я просто такой фрейм да ну потому что если у вас есть просто div по нему очень трудно что-либо собрать давайте здравствуйте большое за доклад меня такой маленький вопрос планируете ли вы создать приложение около yc pro для просмотра около трансляции для той зона для ввс над каста для smarty ли вы сейчас уже можете смотреть на мобильном давай на приложение ок видео для smart tv в эти трансляции уже сейчас можете смотреть вылечил с их даже и они будут крипто ван и не будут криптона и закрывал на трансляции приватная трансляция она не будет крипто ванна на клиенте еще вопросы давайте это будет уже последний вопрос скажите пожалуйста сколько времени уходит на переключение имплантов то есть эти пользователи реально перешел из одной сети в другую там 3g 4g окей описанных сменился сколько времени уйдет на эту операцию банально вы пытаетесь и при отправить отправляете в пустоту а ну не доходит но умника трудно трудно понять по волю zippy почему случился тот или иной пакет гов если бы я знал что ну для сейчас не мочу пакет гипса сменами со сменой айпи но вот эти как раз пятен на 10 и на 60 пакетах которые у меня есть на hype я могу предположить что это как раз та самая смена . . как часто вы просто банально смотрите базу в какую-нить где написано какой у него и пешни куда слать скоба говоря какой вот лет нити в этом плане это же входящие streaming протокол который клиента стримит насер нет я от той части когда у вас потребитель трафика путешествуют туда-сюда вот они очень меняется айпишник у нас есть некоторые де саси и внутри пакета мы тут все продолжаем у него случится не который пойдет гэп в виде провал пакетов пока университете переключая и он говорит все знаете у меня и печник сменился прыгают ok кому все равно он пугаюсь ваша система поймет что она сразу же эти пакеты принимает потому что айди сессии зашит в пакете ему на самом деле абсолютно не важен какой у него исходная печник данном случае главное что вы на тот на тот сер которые ходили грубой 1 тимофею туда и приходите какая разница какой у вас айпи не я от человеке который потребляет трафик некоторого генерируют и которые потребляют еще он смотрит видео вот там смотрят говорит меняя печник изменился пришли мне на тугая печник как быстро система поймешь что нужно слать на другой печник на другой адрес соответственно да я понял мы до клиентов не доставляем его этим же протоколом и до клиентов используем или or tmp или собственно в порто c и лечилась или дэш мы как раз не делаем кастомных иными словами есть человек переместиться во времени и пространстве и он будет клиентам то есть потребитель у него все разорвется и он ему придется переподключиться ровно так как в стандартных протоколов днесь эпичных это будет происходить потому что доставка видео до клиента работать по тисе пи и в вашем клиенте мобильном которого ты полный там соответственно тоже стандартно используется на то есть все вот эти прибуду только для вещателя жаль спасибо хорошо всем спасибо поговорим александр за замечательный доклад"
}