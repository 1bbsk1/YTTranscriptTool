{
  "video_id": "T1tiwor-oSI",
  "channel": "HighLoadChannel",
  "title": "Как Vagrant и Chef ускорили разработку в несколько раз / Тимур Батыршин (Cinarra Systems)",
  "views": 362,
  "duration": 2350,
  "published": "2017-07-30T00:47:37-07:00",
  "text": "ну вот и подходит к концу наша конференция последний доклад будет про рокет сайенс про то как vagrant и шеф ускоряют разработку в несколько раз тир мур батыршин из компании я не выговорю это слово он сам наверное скажет вот расскажет вам сейчас про это поприветствуем его всем привет на самом деле я обнаружил что с названием доклады несколько наврал то есть это конечно у нас vagrant с шефом ускорить разработку в несколько раз но я почти ничего не буду говорить про шефы совсем чуть-чуть про vagrant а больше буду говорить наверное про такие вот вещи технические особенности нашего процесса то есть недавно была на конференций и меттом не очень понравилось что там было много капитанских таких вещей их решился большую часть как бы выкинуть расставить только сделать больше упорно технические вещи количествах можно так меня зовут тимур как я уже сказал я работаю в компании на российском около года со мной можно связаться по таким адресом сена российском молодая достаточно что такое алла назад достаточно молодая международная компания по моему она у нас организовалась года два с половиной назад я здесь работаю около года у нас мы занимаем с тем что строим платформу для мобильной рекламы следующий когда год пришел сюда год назад была примерно такая ситуация инфраструктуру еще никто толком не занимается приложение нас достаточно сильно связанная всех компонентов приложения практически таких большие конфиге с портянками там на где-то там на несколько экранов и достаточно большие следы в базе которой который очень сильно влияет на тесты на следующий в общем то как наверно во многих таких случаях когда инфраструктурными задачами никто толком не занимается и занимается все там помаленьку у нас были такие классические для этого для такой ситуации проблемы долги плане продакшна когда я туда пришел там например делали deploy на productions когда все вручную эту меня занимало наверное часов там 5 на это в общем-то было связано и с тем что большое количество компонентов и большое количество конфигов то есть и у нас еще при этом и есть такой момент что конфиге часто меняется в этой портянки разработчик может там добавить какой-то новый интеграционный параметр про который никому не сообщает и без него ничего работать не будет пока все это проверишь веришь это достаточно долго была про сложность конфигурации у нас приложение так получилось что достаточно сильно связаны и то есть вот если есть у нас несколько компонентов друг с другом разговаривает и вот здесь это неправильно работает может вот вот этот компонент может давать совершенно не те результаты отсюда проблема возникает для разработчиков у них были какие-то вот свои окружении на каких они раб на которых они работали и они в общем-то не могли создавать новое я как-то наблюдал ситуацию когда они там всей команды человек пять создавали там новое окружение для того чтобы дома показать у них это заняло наверное несколько дней то есть вместо того чтобы там fitch пилить они им пришлось от просто настраивать этот сервер пока я еще как бы не совсем вошел в тему и отсюда же проблема была синхронизации тестовых окружений то есть например тут здесь стоит одна версия компонента здесь другая тут например нашли какую-то бабу здесь не уже оказались пофикшены и вот такие постоянных были синхронизации не могли воспроизвести ошибку тест эту проходить то падали то работали и я бы сказал наверное у них процентов там 70 времени уходила вот всего уходил вот этот на синхронизацию между собой разных вот серверных частей на их собственных окружениях тут кто-нибудь с такими проблемами сталкиваться вообще а кто их решил замечательно дальше ну тогда перейдем дальше что я сделал первым делом всю конфигурацию вернули в шеф тут знает кто-нибудь что такое шеф а кто пользуется шефом а кто пользуется там ansi план или другими аналогами но почти все ну значит я был прав что решил не рассказывать здесь о том что такое шефы чему вам помогает но как бы хотел рассказать об одном моменте который у нас не очень хорошо работал в шляпе принципе в других системах тоже подобной ситуации же было дальше как я уже говорил у нас фанфиках большое количество параметров и они часто меняются то есть классический способ управления конфликтами то как мы берем плюха им тимплей на рыб для шефа там на jin jin jie для ансипа плюхами в клубок и потом подставляем атрибуты из атрибуты ноды в соответствующие там места но тут получалась бы такая вот многократная работа то есть пришлось бы все это поддерживать все эти параметры указывать их нам в трех местах каждый раз синхронизируется с разработчиками при том что у нас слову через океан разница там 12 часов это было бы достаточно сложно и мы решили пойти другим путем следующий слайд тут знают что такое audios работал с замечательно есть люди общем объяснил в двух словах что такое audios такая вот библиотека или инструмент который позволяет представить все конфиги в системе вообще все видео1 дерева значений наподобие x пасок которому можно обращаться как к универсально обращаться для любых конфигов сейчас придут приведу пример следующий возьмем например простенький конфиг engine.exe тут в общем то все понятно допустим мы хотим поменять какой-то параметр она не знаю поставить грибков нам бы пришлось как это все это дело парсить там не знаю сетами или еще чем то вот это вот убедиться что мы там не затерли ; проверять комментарии и делать вот много другой такой непонятно никому не нужно работать когда у нас если например другой формат конфига там совершенно другие действий пришлось бы делать общем то это достаточно неудобно и вот когда вот если мы прогоняем вот конфиг через например через audi вас получается примерно такая штука он его анализирует специальным образом мочить и строит вот такой вот дерева это у нас получается массив пар ключ-значение с которым уже легко и удобно работать например мы хотим здесь поменять пользователя мы просто меняем дату на другой причем что интересно он сразу при разборе конфига про его производит его валидацию и когда мы что-то меняем сохраняем он записывает это прям ну как бы сохранять даже форматирование какой-то нам комментарий был например в конце строки он его оставляет был там поступь между там пробелами и значением он его тоже оставляет вот так то есть там такая вот внутри достаточно сложная система риггс который позволяет это делать ну и в нашем случае получается примерно такая такое решение мы написали сюда как бы дополнительный ресурс для шефа для а у гиоса потому что все которые были они такие не очень удобные были что здесь что что здесь происходит мы создаем конфликт который указывать первые строчки на тот момент у нас была такая практика в компании что приложение притаскивает собой дефолтный конфликт который как бы с которым она поднимется то есть там он он его как-то генерирует там она прямо в таком же формате который понимает приложение не случай диабетом или каком-то другом и там есть все параметры то есть это ответственность разработчиков наш ресурс берет этот конфликт вот это лунный комплектуем и подставляет в конфиг файл которым мы управляем значение из него то есть при этом если добавилось много значение там просто туда добавится сейчас я дальше поясню как это работает в общем то здесь мы задаем вот как я уже сказал такой шаблон такой конфиг указываем что формат файла ini файл и говорим переопределить какие-то вот значения на на другие на нужны на в конце делом омри startservice следующее вот и то есть пример вот вот приходит вот такой файл в родном формате приложение это у нас не файл а здесь какие-то там значения по умолчанию мы хотим допустим поменять там как уже предыдущем слайде было там два хвоста и уровень логирования следующий вот этот ресурс у нас как бы прям в этом месте меняет эти значения комментариев я добавил это не не ресурс добавляет с либо например у нас в этом в при следующей версии приложения придет новый обновленный конфликт ну-ка талоны конфликта там просто соответствующее значение которую не указ наши дополнится или изменится соответственно то есть это сразу снимает вот эту головную боль следить за параметрам в конфигах ну я думаю все понимаете что здесь хотя нет пока еще рано об этом говорить следующий слайд подведу небольшой плюс вот этого у гиоса то есть можно вообще всеми конфигами управлять одним тем же способом на тот момент мне неизвестно было там компонентов много времени мало неизвестно было какие форматы конфигов у нас есть то есть он для этой цели хорошо подходил поддерживает почти все форматы конфетку ну там пожалуй только яму не поддерживает как я уже говорил он строгий то есть если конфликт не проходит там какой-то через валидацию если он например там ошибка так он просто отвалится что общем то часто бывает хорошо и его можно расширять там дописывать а новое описание конфигов на языке наподобие а кому ну так я уже начал говорить не может быть такого что все вот такая красивая нет нет никаких проблем следующий слайд у него проблем такие что всё-таки атому язык не простой и расширять его с достаточно сложно особенно если у нас какой-то формат не строгий то есть вот у нас у нее файл если там например мы можем мы хотим чтобы можно было кавычек значение и не обрабатывать там символ комментариях у меня это не получилось сделать и другой момент что мы чаще всего пользуемся одним двумя форматами конфликтов которые нужно управлять и смысл в этом не так ну вот то есть такой вот инструмент который с одной стороны очень интересны с другой стороны очень понятно где его использовать мне кажется он очень хорошо подойдет случаях когда например по каким-то причинам нельзя использовать шеф ansi пол или еще какие-то вещи при этом униформу на там менять конфиге в общей системе мне кажется происходило примерно для таких целей предполагали так следующий слайд дальше с шефом мы управляем продакшеном мы им собираем базу и образы серверов и дальше их для работы с ними используем vagrant тут знает кто не столько vagrant будет замечательно значит право гранта можно не говорить так давайте следующий у нас работает это так ежедневно дженкинс собирает амазонский образ при помощи покера и публикует vagrant бокс нашим репозиторий vagrant la grande бокс это образ как бы это понятие из vagrant и это именно образ сервер который используется сейчас я это поясню что я что под этим подразумеваем дома важный момент что этот образ bercy они рованный давайте следующий слайд чтобы собрать именно пакиром образ для vagrant а там просто нужно указать постпроцессор в конфиге и он в итоге получит такой вот бокс файл который можно на рим и подсовывать его гранту этот бокс файл можно допустим подсунуть ему сказ команды строке или там загрузить на vagrant клауд но в общем то и то и другое у этого есть какие-то некоторые проблемы то есть бокс файл нужно как-то разработчику передать чтобы он мог его запустить да я забыл сказать что это еще начал рассказывать про задачу что воспроизводства окружения для разработчиков чтобы они могли повторяться вот нужно его как-то передать и с другой стороны мы не хотим пользоваться сервисом центральным вот поэтому мы подняли собственный сервер сервер для этих vagrant боксов вот и джинки дженкинс при сборке после сборки собирает vagrant бокс и обновляет джейсон с информация о версиях следующий слайд vagrant бокс случае амазона в нашем случае он в принципе достаточно такой вид имеет у нас получается что лежат на сервере там большое количество таких файликов которые потом скачивается на компьютер разработчика из них запускается собственно сами сервера для разработки и тестирования подробнее чуть чуть остановлюсь на том как работает в агрон бокс апдейт следующий слайд когда мы делаем запускаем скоба на строке vagrant бокс апдейт vagrant лезет по такому адресу и счета джейсон то есть например если у нас используется бокс там ubuntu представившийся 4 он лезет по умолчанию вот огранка лотком ubuntu при спрятавшийся 4 с этого адреса отдается пример женщина примеры такого содержания ну то есть он достаточно простое здесь у нас имя этого бокса описание и массив версий он состоит общем то из описания версии и адреса по которым мы находит этот бокс файл таким образом работает именно обновление боксов на стороне самого vagrant правда тут чтобы это подошел для наших вариантов тут есть там пару таких моментов про которые я хотел упомянуть во первых на стороне разработчика там где установлен vagrant нужно переопределить vagrant сервер url это говорит vagrant у чтобы он лез а за вот эти вот обновлено бокс файл с обновленным образу не на сервер vagrant клауд а именно брал его с нашего адреса и второй момент что вот этот джейсон обязательно у него должен состоять из степи content type a pleasant женщины на чем просто отказывается его принимать вот следующий файл в итоге у нас получается что разработчик один раз ему нужно добавить и бог систему и потом каждый день он просто перед работой делает бокса дэйт запускает сервер и сворачивает все это заменим занимает ну там пределах выполнять в пределах пяти минут так с с тем как облегчилось жизнь разработчику немножко надеюсь объяснил и следующая часть докладу меня про дженкинс с дженкинсон здесь работал я думаю работали так следующей сборки я думаю вот много кому знакома ситуация когда у нас есть одна большая сборка и в нем много подчиненных сбор принципе он так в общем таки работает эти казалось бы ну такая нормально ситуация классическое но здесь есть такие проблемы что допустим если мы хотим внести какой-то там изменение например там хотим по-другому собирать там собирать камешку нам нужно открыть большую страницу с параметрами найти вот как бы это изменение в нужном месте причем часто они спрятаны еще под кнопка advanced и для других branch и сделать то же самое в случае для когда нам нужно еще например при этом чека учить код для при при сборке то придется например этот branch указывать там что в пяти местах например и тоже часто спрятаны под кнопкой advanced то есть это совершенно следующий да вот здесь я на слайд вынес все эти проблемы и плюс еще конечно возможно немножко мой такой личное мнение об этом работать через про кликать по кнопочкам достаточно медленно и удобней хочется эту работу свести к минимуму мы поступили следующим образом у нас каждая сборка она может собирать то есть она она может собирать вот свою задачу совершенно отрезан от от как сказать отвязанный от того что она собирает то есть например вот сборка вот этого там cnr мейна она совершенно без изменений именно вот эта сборка она может использоваться для любого branch и она принимает на вход параметры выполняют отдает если мы хотим выполнить это дорогого branch и мы просто передаём другие параметры и соответственно с остальными тоже также сейчас и это поясню следующий вот например для сборки которые у нас производит компиляцию мы в ней не делаем не чекаут мы делаем гибче caught с центральной сюда просто передаем workspace каталог который мы правда про чака утиль использование в качестве workspace а это соответственно все команды будут выполняться по умолчанию в этом каталоге и сборка произведет те изменения которые которой она должна сделать совершенно и нам совершенно не нужно знать о том какой мы раньше собираем новый-старый даже может быть там какие-то другие параметры меня нет ни о чем этом нам знать уже больше не нужны именно внутри этой сборки мы хотим запустить для другого branching просто берем и копируем один в один и запускаем ну следующий слайд в остальном в принципе тут никаких особенностей нет просто обычный сборка получается дальше следующий слайд остановлюсь немножко на том общем то как устроена центральной сборка откуда у нас получается вот эти все параметры которые мы который у нас дальше проваливается по всей этой по всей по всему дереву так до следующий слайд у сборки мы то есть для центральной сборки мы передаём параметр из какого branch и собрать там какой тип сборки может быть какие то ставьте пропустить это удобно в отладке ну и прочее то есть таким образом мы можем опять таки эту и ту же самую сборку переиспользовать во всех случаях для одного бранча для другого для другого вида например то есть не для это дневные там для какой обрели сборки что тоже очень удобно не нужно лезть в код когда мы хотим вот просто поменять версию следующий центральной сборка у нас выполняет то есть вот как раз вот такие вещи она общем то задает принимает параметры пользователя потом внутри генерируют какие-то свои параметры то есть например там ими джейсона из версий томи какого-то базового шаблона чека эти все git репозиторий общем-то запускает подчиненной сборки и передает туда вот эти переданы сгенерированный параметры чтобы они там уже начали работать как нужно когда все закончилось она вытаскивает из него все артефакты тесты их публикует следующий так сейчас немножечко расскажу в общем-то о том как выглядит общем как какими-то передает параметры как это выглядит вот на примере вот этой сборке показаны стрелочкой следующий вот здесь в общем то как раз как раз мы это и виден весь класс имея вот этого шага именно сборки которая называется дальше вот этот момент очень важный multijet плагине который мы используем для этого есть такой момент если мы несколько параллелям сборки одна из них упала что делать остальными убивать или оставлять и передаем сюда вообще вот всю кучу параметров отсюда у нас например вот этот параметр пришел из от пользователя остальные они там как-то сгенерировали скриптом на груди после того как это все передавать это уже вот на основании вот этих параметров уже подчиненных сборка запуская скрипты и генерирует выполняет свои действия для вот тебе надо нужных версий для ног для нужных так как нам нужна следующий мы рассматривали другие варианты счетам вот которые здесь перечислено немножко остановлюсь на них можно править config.xml ну это как в чем-то может быть удобнее когда нам хорошо решает задачу когда нам нужно вот эти изменения распланировать на несколько там разных branch и но это общем-то и врач xml и править и неудобно и с другой стороны чтобы применить изменения приходится перезапускать джимпет можно менять это через ebay но сыпем тоже такая не очень удобная вещь что это происходит бы сложно контролировать насколько соответствует то что мы делаем через обь с тем что у нас есть то есть или как это лучше сказать что через это и хорошо совершать действия нынешних не очень удобно изменять состояние есть такие вот варианты совершенно замечательные work all plugins был слова плагин который предшественника его они мне сейчас немножко расскажу что это такое это мы можем описывать сборку виде да и сели на следующий слайд про это будет и есть еще джобс был плагин про которые к сожалению на тот момент не знал он позволяет генерировать писать на groovy описание сборки того как она и генерировать новые сборки из этого описания то есть вот этот плагин например используется для генерации новых сборок деревьев например для нового брань следующий слайд так вот workflow плагина котором я говорил в общем то вы попытались его тоже использовать дженкинс и в этом случае сборки выглядеть примерно так то есть вместо большого дерева разве стара у нас один скрипт такое вот ну раза в три мерном больше чем этот лежит просто ходить здесь всем все дела здесь нового check out this гитхаба запускает майк грин архивирует получившиеся пакеты и еще один момент то есть вот мы сразу здесь у нас записано что сборка cnr main и там вот это вот цен ртс она параллель запускается параллельно то есть тут тоже есть возможности для для того чтобы сборки параллели последовательно делать в принципе все что можно описать эти годы можно сделать и здесь так следующий плюс и здесь в общем то достаточно такие очевидные мы можем изменений хранить видите откатывать накатывать когда нам нужны например нашли какую-то баги нужно исправить сразу во всех branch их мы просто меняем в одном месте видите она применяется везде мы на мой взгляд программы проще отслеживать логику чем вы искать его по вот эти по куче менюшек и по куче мир и страничек один путь и так следующий нуу плагина такие достаточно серьезные минусы он вышел в декабре прошлого года и общем-то достаточно сырой пока сейчас вышло несколько новых версий наверное кучи багов исправили или уже не в курсе и у него другая проблема то что он переопределяет обычно обычный тип сборки дженкинса и из-за этого он не совместим со многими плагинами то есть разработчики опубликовали как эти плагины исправляют для того чтобы работал в реально там с ним совместимого десятка два плагин который мы можем горки вы параметризировать остальные просто а не увидите в меню поэтому после как бы написав прототип такой сборки на workflow плагин мы решили на нее не съезжать следующий слайд ну и в итоге общая за схему нас выглядит теперь так что ежедневно гент дженкинс с гитхаба собирает где пакет который потом при помощи лет мы можем установить на наши там продакшен сервера и при помощи шефы и baker из них из них можем собрать образ сервера дальше этот образ используется но при пункт при помощи логран там могут спустить разработчики по необходимости а также при помощи vagrant уже по ним можно поднять новые сервер почему это сделано чему дженкинс тоже использовать vagrant для запуска тест у нас была такая проблема что разработчики приходили там жаловались что локально тесты проходят на рынке синиц поэтому мы сделали чтобы вот именно обе этих 2 обе оба процесса выполнялись одинакова в обоих случаях ну и в общем то все разработчики сейчас ночами спят не так как у них этого освободилась из 70 процентов времени которая у них уходило на то чтобы исправлять ошибки синхронизировать на то чтобы синхронизировать окружение и общем-то разработка пошла гораздо проще спасибо вопросов тимур спасибо за доклад у меня вопрос а почему не использовали все таки бертло плагин а это как бы его наследники built for такой проблемой что там он не может когда по крайне мере не мог смотрела он не может делать чекаут то есть нужно чека вот описывать отдельно обертка уже можно там все остальное все остальные можно писать bilham а workflow плагин решили не использовать потому что молодой да еще абортов вот все реализовали запустили на там как бы у него не модифицируется интерфейс то есть там вот именно вот эти вот шарики со ступенями вот как там ну я понял раньше не да там их получается очень много и просто ну в разработчики не матерятся начали то есть просто визуально сложнее визуально сложнее и вот тут-то тоже какие-то вот такие вот небольшие баги и мелочи и все-таки сказали что на непроверенные решение сразу прыгать не стоит окей спасибо еще один маленький вопрос если можно совсем вот ты сказал что долго гранта вот январь момент они воспроизводились как нормально когда есть дженкинса на чем вы их воспроизводили если не на гранте просто была физическая машина какая то стояла там они будут там разработчики как это все это ставили руками то есть вот поставили приложение настроили зализина то есть там они не джинсам ставилась она она она была просто для для тестов какой-то отдельный сервер для разработки отдельные там еще до труда разработки другой группы отдельно они там каждый как-то все это обновляли периодически не понятно то есть житель столько сборку делал да понятно спасибо будет делал сборку и там по моему еще подергав где today торчит такого рода обед install понятно спасибо ну круто да спасибо спасибо спасибо большое за доклад отличный просто доклад мне очень понравился здорово что кто-то заюзал этот стек а в с vagrant пакир вот у меня есть вопрос на самом деле состоит из двух зависит от отряда скажите вот ты доставляешь как конфиге нас на продавцы сервера шефом то есть типа если так же продаете конфликты и ваша команда тишь да то есть с продакшном на самом деле не все так радужно безоблачно у нас процесс еще не совсем отлаженный например разработчики там любят туда ходить сами и менять там вот параметры у у приложение которое они разрабатывают вручную и в этом случае бывает что получается разъезды а тогда ставлю новую версию приложения там а потом шеф его как бы приводит конфликт в порядок и в общем то все подтягивает новые значения из конфига и получается подтягивает новая имя виду что если например у нас есть applications к в этой версии мы вот он за добро или сделали новый бокс раз про ценили его в пруд разработчиками подтянули и тут допустим на продавай ремонте ты обновляешь культур версию конфига как это дать дотянуть для разработчиков потому что наверняка это разные варианты поэтому типа в гранте и противник не соответствует там разные там допустим не знаю discovery разные там разные переключалки как вот это вот у вас разруливать вот именно такие разные версии чтобы они доставляли чтобы одни и те же фичи были включены если надо а так видимо вопросу другом чуть был то есть имея да как меняется вот эти параметры на продакшене и как в отличие от тестов чтобы ну и и как как вы синхронизируете чтобы тестовый были максимально похожим на текущий продакшен но чтобы если разворачивайся эту дырку поставили там погоняли включили это может что-то доделали при разработке другой сервис который с этим общается он там посмотрел что остальные фичами там api вы один а в то время напротив уже врубеля pivo 2 и он типа нифига не будут работать они у нас как бы тестовое приложение varmint они не похожи на продакшн у нас продакшен там стоит на нескольких серверах тестовый там одном вот и про то как эти значения протолкнуть продакшен то есть of sheep завожу только те которые мне реально нужно менять например там айтишники там включить и выключить а все остальные они проваливается из дефолтов приложения в тестах они практически все там используются default дефолтные у разработчиков тоже дефолт на используется да да спасибо еще вопросы 1 вопросов больше нет я хочу знать вот all goes ты хранишь конфиге прямо в его в формате в 6 или этого он туда сюда перегоняет их нет значения для каких каких-то параметров я храню в атрибутах шефа шеф как бы уже вызывает audios для изменения параметров в конкретных местах и потом и в ирбит не а у кинулся именно нормальный стандартный файл да тут как раз это отличается стандартно подходу что тут нет херби тут нет отдельного файла с шаблоном шефе тут есть просто вот описание сервиса как там вот audios темплейт и значение которое нужно переопределить а шаблонов в рядом сказку буками нет никакого вообще нет никакого ментального налогу разработчиков когда они там видят в документации джон x1 а потом надо это все представить формате аудио со себя в голове что в этом что-то поправить или ну это как бы пока что сложновато нас будет у нас как раз процессы находится в стадии отладки такие вот процессы общения и разработки и это было именно описание того как мы решили вот на на тот момент когда было вообще все плохо и до того момента когда стала ну более менее предсказуемой работать и предсказуемые быстрые работать здорово спасибо спасибо большое тимур"
}