{
  "video_id": "Z6kmgGxOcoM",
  "channel": "HighLoadChannel",
  "title": "Современная операционная система / Александр Крижановский (Tempesta Technologies)",
  "views": 1110,
  "duration": 3579,
  "published": "2017-07-30T00:47:27-07:00",
  "text": "у нас сегодня будет интересовать операционной системы и внутренности что у нас там происходит но честно говоря просто пересказывать какие-то презентации к тому же есть либо книги либо там не знаю что угодно было не очень интересно поэтому хотелось с вами поделиться тем на чем мы ну идеями над которым мы сейчас работаем и соответственно суд небольшое такое вступление о том что я расскажу вам то что из чего состоит современный linux как вы можно починить у нас будет достаточно короткий доклад но выскажу но тем менее мы начем с никто своего видения которые вам в котором я приглашаю пахали варить во время вопросов так поехали во первых мне не состоит в том что современный персон с тем это плохая штука дело в том что вот на картинке изображены графики сайте нет map может быть кто-то его знает это штуковина который позволяет очень быстро вам захватывать и отправлять пакеты сетевого адаптера то есть вот вот это картинка она показывает в том что вот на одном ведре вот связанные тактовой частотой до до трех гигагерц нет мэг позволяет детский габит планы вот 14 миллионов пакет в секунду от аббат уже на psy стах мегагерцах а вот синим колени и это пока те ген это вообще самое быстро что есть в ядре linux такая штуковина генератор трафика который подберет один пакет и его просто отправляет много газ вода то есть вообще никаких копировать никакого создания новых пакет вообще ничего только кафка одного и того же в адаптер и вот она вот настолько сильно проседает по сравнению с темпом а вот то что делается в use space это вот вообще розовый линией показан да и она вообще где-то там внизу находится соответственно вот люди которые работают с очень вы сами сетевыми приложениями они вот приезжают на этом об эдипе дикий п frank таких технологий их море сейчас 2 point это о базах данных то есть это было всех теперь о базах данных если кто-нибудь заглядывал в баз данных мы знаем что но сегодня посмотрим то что можно использовать map можно использовать дерек большие баз данных пожгли смазку или на тебе в основном используют a direct и еще в седьмом году было обсуждение волка имели и было сказано о том что директ это грязная подборкой она неправильная и в целом мы можем посмотреть если посмотрим на код операционную систему посмотрим код мощный баз данных то мы увидим что базы данных она загребают себе большой вашу область памяти и сама ей управляет она сама там держит пу страничек прям пас работа со страницами вытесняет их сбрасывают в общем все что делает операционно систем на уровне виртуальный память новую не файлы системы паучьи linux тогда сказал о том что пожалуйста используйте м от вас для того чтобы вам работать к эту зайцев спасибо о том что как же мы будем без за директа жить потому что нам нужно знать когда какую страничку сбрасывать и так ответа небу и как бы мы продолжаем так же жить следующий point это о том что как вообще мы пока минут свои приложения вот можете поднять руку те кто пишет носи на си плюс плюс какие-то потоковые приложению ну ну немного ну я здесь вы пишете многопоточный демоны сетевые то у вас к полу должно возникать вопрос по коми у меня при каждом новом демоне возникают вопросы что же я буду использовать будете там процессы там будет ивенты будьте там потоки как будет много потоков к запускать как поддержите стоит машины для того чтобы каждый поток а баба-то много событий стыд машину и потоки либо может быть использовать паутины да там как делает его лонг и так далее это достаточно сложный вопрос и и тоже здесь есть спал есть вот замечательные кстати это почему ивенты плохо и по себе и совершенно не противоречили друг другу одни говорят о том что нужно все делать на потоках что современная пенсионная система очень хорошо работы с потоками и мы можем ходить столько потоков сколько хотим и хорошо очень vinzer хорошо нас будет бы сработать следа говорит о более тяжелой архитектуре о том что мы запускаем какое-то количество потоках в моих при спиде между определенными задачами там в общем сложный довольно механизм планирования потоков по неё незадача по этим потоком в общем да вы довольно такой геморойный вопрос который надо решать и по сути либо мы используем какой-то код фреймворк поток вы да там например буста силу либо мы сами все делаем руками и должны задумываться о том что нужно из нам нужен performs мы должны задумываться об этом 2 что он нас мы живем мире где у нас очень очень много лака ты в памяти то есть если мы пишем что-то простое дату мы используем липси используем молоко либо там new все + + и не задумайся о том как иначе происходит как только мы выходим на высокие нагрузки мы начинаем уже тащи джима log out и там другие готовые библиотеки до либо мы пишем свои распределители памяти там свапу там много всего то есть вот этих слов их очень много это то что вспомнилось за 1 то есть если мы делаем sega то сначала мы начинаем с простой программы и потом мы уходим по сути комплиментации операционная система виза спейси да мы делаем buffer pool для сброса для быстрого ввода вывода мы делаем свои потоки это механизм планирования синхронизации мы делаем свои его коты памяти тогда то есть мы очень много чего делаем с другой стороны вот desktop я вчера просто посмотрел что у меня запущена у меня запущу там 120 процессов многие из них мне даже неизвестно вот я люблю легкие системы и принципе я понимаю что у меня работает если я запущу куда едем окном то там будет море процессов там будет может двести-триста которых я даже не догадываюсь что это такое что они делают какую нагрузку они дают на систему я тоже не догадываюсь и целом нет неважно я там печатая собираю код там целом я не не интересуюсь максимальном вич пока на моем десктопе мне интересно максимальным which make на моём сервере там где мне нужно ставить рекорды второе то что desktop и сейчас достаточно маломощные да это какое-то обычное один процесса немножко яде он немножко памяти никакой ну ну а то есть все все очень просто все очень маленькой тем не менее мы знаем что у нас венок сработает на наших телефонов и на телефонах и на больших сигналах это не очень правильным если мы посмотрим вообще как живет по 2 сильный мир может быть если кто сталкивается с тяжелым diedas либо держит собственно седин который фильтрует diedas они там знают эту табличку это вот один табличкой данные от одного из пионеров построения больших дата центров по фильтрации трафика не работает на обычном манты русском же есть без всяких акселераторов сетевых и собственно люди сделать собственную операционную систему вот красным цветом показано то что они убрали и они получили вот данные что они могут с базовых совершенно все его из дешевого снимать десятки габи трафика если вы просто запустите linux то вы ничего не снимете тем более эти люди делают достаточно серьезный но фильтров на уровне при качеству adidas то есть они залазит не только flight of the speed что делать обычно операционка но они ещё и повысят аж типпер избивают его запускают классификатор и они успевают там один пакет и забрать там за сколько-то тактов потенцию все очень быстро те самым попытаюсь ответить вообще почему так вот мы живем с венок сама ягода где-то в двухтысячных годах были но в начале 2000 может быть конце 90-х когда очень-очень пазик крепкий были позицию solaris был спор о том что solaris стал он тяжелый linux быстрый и легкий потому что маленький это тоже можно найти в списках рассылки и теперь мы имеем то что тогда имя solaris linux очень большой его код москва сами там куча опций он кучу всего умеет делать все что вы хотите делать вы можете в нем сделать есть другие птицы он нас тема типа там up and bass dnb sd которые сильно проще а не менее используем и но linux этого очень мощная штука я содрал картинку с википедии это собственно вот то что они попытались изобразить linux мне кто такой таком разрезе да вот у нас есть в вертикальные столбцы его по системы по его директориям в ядре и внизу они прошли от более высокого у них более низкому здесь очень сложный гав на самом деле если посмотреть какой-то . например на плане и не ввода-вывода то где-то вот там новым не стоит живут синие сине-зеленым где-то в середине там далеко не все показано все на самом деле сложнее там большие связи очень много различных череде и очень много блокировок и все это должно работать и работает это все медленно давайте сейчас пройдемся по вот этим столбиком вертикальным посмотрим на капот системы linux и что с ними можно делать где то могут быть проблемы здесь от части с точки зрения администрации отчасти с точки зрения разработчика и к одному кодом во-первых работа с процессами с годами ну у linux есть планировщик ввода-вывода справедливый который работает за логарифмическое время сейчас дефолтный планировщик до этого был планировщика то работает за константное время но честно говоря мне никогда не приходилось возить в сам планировщик с целью оптимизации получения него больше производительность то есть как там работает я знаю а вот таким сделайте вы никогда не происходило то есть там как то все понять и наверно она поднимется хорошо проблем вам быть возникают в другом месте совершенно то есть как я уже сказал что десктопы и всегда совершенно разными то есть эту есть сервер с одним процессом да там 8 ли там сколько-то ябеда там дети 16 это извиняюсь это один вариант если у нас сервер где стоит 4 процессы у каждого там по 10 яде у нас там 41 в системе плюс там хочу рейтинг у нас 8 потоков сейчас уже процесс вы стали еще более массивными там еще больше полезных контекстов и соответственно котенка совсем другое прежде всего вот если говорить о потоках о процессах ивентах то чтобы мы не вы были потоки процессы либо стоит машина это все о вашем удобстве то есть если вы хотите написать быстро берете какой-то фильм wog и используйте вода там либо винт там будет 100 силуэтом скачи потоков что угодно если вам нужен performa 100 нужно но точно понимая что у вас есть определенное количество железа вот этих я те которые могут видеть времени чего-то делать если вы одну вот эту единицу заставить и делать больше чем она может да там на 1 на 1 hour 2 на поток отдадите многого позвонок потоков то ничего хорошего не произойдет произойдет 1 контекст свечи контекст свечи они у нас дешевы если у вас происходит системный вызов у нас есть специальная оптимизация операционной с темами что если прикладной процесс уходит вы двое возвращается обратно тут же то у него крыша каши не так сильно вымываются и у него не происходит и наблюдаться крыши немного происходит вымывание но в целом мы хорошо живем если у вас начинают припаиваются прикладные контекст это становится все очень плохо первое что на современных и терских процессах мы должны были делать каши первого уровня то есть сама наша цен на то что сама у нас маленькая и самая дорогая то что нам позволяют работать действительно быстро при медленной памяти мы это теряем более старшие кешью и 2 и 3 они просто вымываются то есть если у вас работают твари нам несколько потоков несколько процессов там программ которые работают с достаточно большим объемом данных и они у вас преподаются то понятно что вот та память которой каждую программу работает или каждый поток она вам загружается в каше и вымывают то что делало предыдущее на то что набивал себе в каше и когда происходит обратный контекст свечи когда первый программа снова получает появления она приходит по сути на холодной кашей начинайте ночь данные из памяти у нас становится совершенно другой порядок времени работы еще следующие то что у нас не встречаясь на десктопов на наших смартфонах это юма современные x86 и до этого раньше были только md теперь уже intel они стали несимметрично архитектуры сейчас будет чуть ниже картинка поэту архитектуру подробнее скажу но суть в том что наш планировщик операционную систему нас есть разные процессы это разные наши ноты они каждой ноты работы со своей физической локальной памятью и если они очка person всем вздумает из одной ноты примеси заново процесс его переместить процессами другой процессов то у нас становится все очень плохо у нас тянется память через медленный канал и частью описана система она знает типологию ядерную которых она работает она это старается не делать но тем не менее иногда я это сделать приходится вник в силу каких-то своих соображений следующее что нас поменялся немного механизм того как мы работаем с разделяем данных то есть если мы сколько-то лет назад могли спокойно гулять спину лака считает что это самое быстро то есть брать какую-то маленькую переменную крутится в цикле ожидать ее в некоторых значения этой переменной то сейчас мы так делать не можем то есть если у нас наши 81 вольница на одну там на один байт на четыре байт это на становится шошин и шина данных у нас страдает из нас все становится очень медленно то есть мы не можем пользоваться механизм синхронизации потому позвать раньше я очень не советую почитать урихо дверей дворца замечательная книга она немного стала но в общей концепции там очень хорошие на покажу как работает и как что можно делать вот это can you mom вот первая картинка это довольно старый картинг может восьмого или девятого года от м.д. когда ну собственно только все навин но не начиналась но входил в широкие массы вот первая картинка у нас два процессора всего есть вот там синенькие канал это те канал которым общаются 2 ядра . здесь у нас два процесса по два и два вот между двумя рядами у нас очень больших быстро трансфер а между разными процессами очень медленно соответственно если у нас скажем 10 и 3 они работают с одной и той же блокировка с одним и тем же винтовыми винтом то они вот по медленному канал памяти начинают гоняйтесь там четыре байта это очень медленно если у нас работает то ли по1 садим тем же винтовок переменных то у нас все очень быстро современной архитектуры они вот уже приблизились наверно они дали дальше даже по шее чем картинка с четырьмя процессами то есть если здесь у нас плоская структура что у нас есть два процесса у нас есть быстрый канал и медленные каналы то там у нас уже трехмерная конструкция и там у нас уже не все яды не со всеми общаются да вот например p3 не общается с по 4 напрямую он должен сделать 2-х по то есть с и нам нужны данные вп-3 нам нужны данные spa 4 мы сначала идем в по 0 а потом панели уже идет по 4 то есть нам надо еще один процесс задействовать в нашем трансфере современный вот интеловские ситуация вон у нее там очень серьезная шин у неё кипиа то есть по по сути там вот вот этот вы структуру вот общение один из реализации данных они построили свой теперь то есть там многоуровневый по такого общения там свои пакеты бегают по шине данных между процессами там достать сложная вещь и разобраться то в текущем в современном асеан и как у него вот где у него транс и быстрее где медленнее очень тяжело вот ну мам кателли она показывает вот not distances это вот если мы посмотрим вот по диагонали и до само собой у него там некоторое это некоторые писание акты попугая у него самое дешевое в любой другой узел мы уже тяжело ходить то есть там уже веса по 21 считается то есть вот даже вот утилита которая собственно вам должна показать топологию вашего железа она считает что вот любой ядро котором вы попадете на одинокую цену имеет на самом деле это немного не так но если мы работаем с ума-то выпущу считай что у вас тут в вокальном процессоре все быстро в чужом все медленно вот теперь что мы можем сделать и что буквально день для того чтобы кот работу быстро во-первых spylog разные структур данных об free которые там наверное в 10-х годах стали очень сильно популярны разные общей очереди прочие то она не работает на больших машинах то есть недавно меня спрашивали о том что вот у нас есть 20 тысяч потоков их человек хотел написать быструю очередь который бы позволял быстро вставлять избивать данные в 20000 им потоком она так не будет работать то есть все очень медленно 20000 потоков они будут каши у тебя не будет безопасно деготь вот эти атомарные инструкции и данные и будьте очень медленно соответственно если вы пишете код для объема системы вы считаете что у вас есть маленький классе внутри вашей машины внутри одной железки и вы строите свой софт так что у вас вот маленькая машинка один процессора на многоядерные там 8-10 16 ядер она делать что-то свое вокальной и иногда общаются с чужими дальше если вы объединять уже classic из машин вас еще более медленно коммуникацию у вас получается такая иерархия костюмов там более быстрый classic более медленно кости wan ip он хороший пример вот выделяемых данных о том что них и нехорошо использовать мы теряем и данных это секрет pdf то есть если у нас есть указатели на данные это наши там smartpoint а вы у них есть reference каунта который при каждом копирование указатели он изменяется соответственно если вы напишете нагруженный сервер то 6pm мир возрасте нельзя и одна из причин почему там будет спросила например никогда не даст вам хорошими производительности на сервере это то что он использует очень сильно использую как раз вот всякие вот эти 6 pt smartpoint у и патчи искал у него вещи которые сильно замедлять действия то есть вот это вот колонию объектный код он не рассчитывать на то что он должен максимально быстро работать своим железом дальше фолз шеринг так или иначе мы в разных языках пока мельницу кого не оперируем там одним байтом двумя 4-мя там восьмью байтами процесса оперируют с четырьмя байтами это однако синей к процессу то есть если у вас переменная хранятся в одной кэш линейке все четыре байта для процесса это одна переменная он будет все свои алгоритмы делать именно вот над вашим двумя переменными то есть если вас по каким-то причинам ваши две горячие перемены например 2 спину ока совершенно разные идеологические ложатся в одну к шинельку то у вас большие проблемы у вас разные я для того не желая начинают двигаться за одни и те же даны хотя они должны работать параллельно и у вас вы приходите к тому что у вас по сути блокировки две работы то они как одна привязывать процессы это как а сучек юма здесь вот по моему бы вам машина доставит с здесь была машина 4 процессы по 42 вас начал когда мы запускаем dd и отправляем его на анти у нас dd запускается на одном ядре и онсена другом и в тот момент почему-то операционной система решала так что у нас же разных процессов и лучше нам процесс прикладной разбросать по разным процессором и она отдавала один процесс на один процессов дугой на другой и получали достаточно низкую производительность с и мы жестко по пишем что у нас оба процесса должны жить по оба процесса должны жить на одном процессоре то у нас сильно возрастал пенсию то есть a person система она делает не всегда хорошие вещи не всегда умные вещи вот по планированию процессов еще и как бы одно из того из мессаджа то вот который вы хочется сделать что у нас бывают связаны cо дату сели у нас десктопы есть на которых вообще что попал к учиться мы не знаем что там такое у нас есть вода на которых может быть работает apache и nginx москве или там не знаю может быть какой-то glow то ли еще что то то есть бывают такие сборной солянки но если мы строим из к производитель кластер там если посмотреть то как строится большие компании как правило у нас есть пастью там есть уровни там первую не у нас стоит там например дженкс на 10 машин ardo это на каждой машине только engine x a person's тем там следующего виню нас опа че то там с каким-то скриптами защищал его ныне нас москве то есть у нас получается что одна машина 1 никто высокого уровня задача это совершенно другой другой подход и в того в таком при таком раскладе у нас наше приложение там и джон x и вещи или apache может рассчитана то что он владеет всеми ресурсами ему не нужна визуализация который дает система это виртуальная память за изоляция адресных посланцев то что каждая программа на считаю что на работу с каким-то неизвестным количеством сепию то есть мы можем привязать например ну хорошо пример это то что когда мы запускаем web-сервере да мы запускаем волки волки вов либо главном количеству я не дали бы там в два раза большим то есть мы основываемся количество киллов на количество ядер это как раз тот пример что у нас одно приложение оно полностью используют всю машину по память я если коротко то чем больше памяти вы используете тем вам хуже если посмотреть вот на кого но в общем туда дальнюю картинку это то как работает наша виртуальная память у нас есть вот адрес в этот линеечка сверху вот так 0 до 63 бит и когда мы работаем в виртуальном адресном пространстве а железу наса но с физическим адресом пространством у нас соответственно и и происходит к всегда моими pink виртуального адресного пространства физическая соответственно если у вас работают две программы у них адреса переменных могут совершенно быть одинаковыми но эти адреса ссылаются на разной физической ячейки памяти этот принцип работы виртуальной памяти соответственно того чтобы когда у нас процесс обращается к не к тому адресу мы должны сделать резал wing этого виртуального адреса в физический вот у нас работает так мечты и бомб вот то что там показано по штабу состоит из 4 уровней у нас есть вот первые четыре уровня вот откуда ссылается 39 47 бит это страничка в этой страничке она представляет собой в табличку в ней индексом служит число который катится битом мы прыгаем на следующий уровень потом резон следующую часть битов так далее то есть у нас вот здесь показан плоская структура что одна страница 1 уровень и ссылаться на следующий понятно что на первом уровне старшие адреса в программе они как правило совпадают 507 выбегает когда тело этого cuts память она выбегает мальчик адреса максимально близко к тем что имеется то есть мы получаем дерево то есть вот первое первое рассказывать 1 вот эта серая линеечка она будет у нас 1 дано 2 может быть тоже 1 потом на третьем уровне у нас происходит 2 на последнем уровне мы уже начинало полностью использовать весь уровень то есть у нас получается такое дерево с о том в главной странице потом она ветвиться соответственно вот чем больше у нас памяти расходуется тем более ответственно см и дерево получаем и понятно что вот это тоже должно где-то хранится это тоже наша физическая память дальше посмотрим как это все расходуется и персию восход памяти 2 что мы допустим своем какой-то бин она дереву dom мы используем например там б дерево там стрельбе по ещё что-то такое это наше дерево мы считаем что вот у нас есть синенькие узлы и зелёненький доводят куда мы хотим прийти для нас это дерево для person системы это дерево внутри дерева то есть когда мы походим по ключу а из первого уровня во второй нас происходит классы по нашему дереву и полностью резов мы проходим 4 уровне дерева теперь мы прыгаем от от второго уровня к третьему пцр к следующему элементу на основу дерево резолвится то есть у нас вот для того чтобы пойти и смеха дерева вниз у нас будет 8 трансферов памяти это много нас к счастью есть втб кэш там это на самом деле достаточно маленькая маленький кэш у нас всего там помещается порядка 1000 адресов то есть вот в таблице трансляции у нас мы адресуем страницами то есть вот 4 килобайта страница 1000 страниц получаем 4 мегабайта то есть вот 4 мегабайта то что у нас закрашена втб как только вас приложение выходит за 4 мегабайта вы начинаете бегать вот уже потери по дереву 4 мегабайта для современных приложений это вообще говоря не что и соответственно возница сейчас возникает выход из того ппш то есть чем больше память мы расходом тему нас все сильней деградирует производительность к вытеснением страниц я уже в начале говорил о том что нас баз данных это делают и действительно у нас некоторые механизмы очень похоже базах данных и в операционной системе linux держит двойной список то есть вот у нас есть активный список и пассию неактивный соответственно страничка когда вы только делаете локацию и что делать и страничка она помещается в актив лист потом через какое то время она вытесняется в инактив рис вот демон к свадьбе из вы сделать и ps вы увидите к свадьбе их по одной штуке на едва они вот когда заниматься вот этими перевозками страничек из места в лист и когда страничка совсем устаревают второй раз и она уже вытесняться из инактив листа и если это анонимно страничек например какой то молока на уходят в своп если это зама плинфа у топовых страничка в басу из у нас мы пойдем файл зама пленный кроме того что у нас есть этих инактив лист у нас страничка может быть грязный чистый то есть если мы только читаем страничке то она чисто если мы что-то записали то она грязная пока она не будет сброшена на вторично хранилище да это либо своп прибыл обратно файл записанным соответственно мы не хотим вот то есть вот когда каждый раз как мы записали что-то в память мы не хотим идти и сбрасывать это все на диск да там своп да и так далее очевидно что это замедлит работу поэтому но иногда нам сбрасывать нужно потому что если вот у нас идет массивная нагрузка если вот мы сейчас все пишем пишем в память а потом ничего никуда не сбрасываем то потом у нас памяти не хватает у нас приходит запись в какой-то один байт памяти и у нас начинается активность босс в этот поход по вот этим списком с боссов все на диск и как мы вообще стали встаем соответственно у нас есть влад бег тоже такой процесс и файловой системы они добавляют в этот процесс свои работы и в фбк касс делать сброс грязных страниц на вторичных хранилище у нас есть и скота или диск отеле переменные я вообще вот здесь искать или пользуюсь документацию 32 у меня всегда под рукой есть едва я туда заглядывали вот есть документация в ядре где хорошо написанную что делать каждый сескапиль соответственно дети богам 3 бойца это точка начала сложных боссов то есть когда у нас файла с тем а вот решаю что надо поместить работу для avoid bk том что во сколько байт мы уже написали сколько у нас есть грязных байт либо сколько процентов грязных страница чистых мы достигаем его тогда мы начинаем записывать эти данные на диск 9 веке убоится это когда у нас процесс записывать данные делать грязную страницу новую и в этот момент он смотрит сколько у нас уже есть грязных стране цвета у нас их много то он сам будет сбрасывать и и вот прямо сейчас на вторичных хранилище если их мало то он это оставить работу tdi avant бег то есть так мы пытаемся уйти от ситуации когда мы очень интенсивно записываем новый бег поток не успевают сбрасывать ваш бег санте секс это собственно контролю то как у нас страничке проходит по листам и как часто они выталкиваются cash cash это ну это некоторый наш компромисс между тем как мы выйти вы выталкиваем какие данные то есть более если это у нас какой-то файловые серверы то нам нужно многое но ты много писателей директории если это просто базы данных который замачивала большого быть память это нам и надо не нужны например джексон открывает файл и где же ты во в своем каши нам потом директория особо не нужные ноды может быть нужны но скорее всего нет ему более важны . большие странице я думаю большинство из вас услышав такие штуки я говорю по то что наши таблицы страниц она работает со страницами 4 килобайта и вот действительно у нас получается втб мы можем адресовать только четыре мегабайт это мало соответственно у нас есть на уровне и двойного вне процесса оптимизация это большая страница я честно говоря не знаю как это как процесса с ней работать но суть там в том что если вы оба целую страницу нас нет физической какой странице вот в один мигов там сколько 2 мегабайта либо один гигабайт физически у нас все на 4 килобайта и когда вы отсылаете большую страницу в вас ответ он к на самом деле ищет непрерывный блок по 4 килобайта которые составят вам вот эту одну большую страницу вот эта большая страница она будет составлять всего одну одно вхождения paiste было одно вхождение втб беда здесь заключается в том что если у нас the bad idea новую пиво уровня для обычных странице порядка тысячи вхождений то для больших страниц это наверное около восьми до двух магов мегабайтах и наверно 1 2 для гигабайт достигну точно сейчас не помню но порядок такой то есть совсем немного исходя из этого если у вас большая база данных то вам может не подойти большие страницы и если вы пишете всего один байт вас на этот байт выделяется 1 гигабайт и он у вас дергается с файла да там вас это невыгодно становится вот если вы если вы держите какой-то очень интенсивный стоит который в сравните небольших данных то есть не так как вы поднимаете там скажем москве на там со гигабайт в памяти одессу вас есть небольшая база там буквально на один гигабайт на 2 там 4 мегабайта которые очень интенсивная работа со структурами данных то имеет смысл использовать хедж ты реджис прелесть состоит так что то не хочу привести в том что ваша из 38 linux вел прозрачные вашей странице то есть вы на самом деле в каком-то какое-то время нам нужно было специально забывать большими страницей монтировать специальный файл с тем для работы с ней сейчас ты одинок сможешь делать всё сам стоять на если вы указываете для вашей области памяти вот делайте мимо два эс о том что вы должны хотите чтобы эта область памяти используя большие страницы то когда вы выделяете странице да вот скажем в макс большим будинок что будет стараться вам выделить большую страницу если он не может выделиться выделите он скатится 4 килобайта много он бы делать все возможное для этого соответственно вот поддержку ваших страниц можно посмотреть фокси пию info ой всего сказал он диск вы ввод-вывод ну здесь у нас три варианта вариант на самом деле интересных большой категории можно разделить 2 а первые тот первые буллит это файл и вот вывод с копированием вторые два это без копирования соответственно вот на картинке показан нормально работа о том что если мы делаем обычный опыт делом бритвой то у нас все идет через наш конечно так называемый bash bash то есть любой вот вывод файл который происходит он для него есть странички в который пишется этот данной который мы считались файл которых записали файл и они вот как раз вот с помощью к свадьбе с помощью кэшбэк потоков сбрасываются фауда и наоборот поднимаются него если ну здесь мы получаем копирую то есть с у нас есть наши прикладной богами буфер мы сделаем из него рид либо в гайд то мы пишем данные в этот буфер и мы их пишем еще в этот пешкеш то есть у нас происходит война копирование это медленно соответственно больших баз данных они используют a direct вот вывод мы минуем пичкаешь мы говорим о том что у нас есть своя большая область памяти вы там выделяемые тем же мало им а пом идем прямой ввод вывод с контролем одесского в эту область второй подход это мы делаем мама map это значит о том что у нас операционной система то есть если сучьего директ мы сами делаем риты либо в гайд на определенную страничку сами и с классовым на диск то случае map у нас специально система как то когда то что то сбросит мы не знаем когда я что она сбросит соответственно если у нас есть инфекционный лог мы говорим о том что вот это вот этот блок данных должен обязательно быть записаны перед другим боком мы не можем это делать мы можем сделать только случае вы директом вторая интересная штука же сама пам что вообще говоря у нас большой адресно по солнцева x86 в целом есть соблазн вообще как поскольку у нас виртуальная память поскольку мы можем за маппить 128 гигабайт памяти имеет всего 10 гигабайт это просто мопед мопед много файлов да и как ты с ними работать в частности мы пробовали сделать ну поскольку мы знаем что у нас есть ps3 мы можем сделать следующие мы можем завопить 128 килобайт сделать орденом об и в ответе 128 килобайт это сколько это бит в нашем адресе да вот в этом там допустим это там будет младший там сколько т.н. бит и соответственно получаем что у нас вот мы сделаем мапу и мы получаем уже железное дерево до которая дает нам оплату то есть мы берем любой адрес берем биты в качестве нашего ключа который мы храним и кладем их на шину и и получаем уже данной в этом api так можно работать там в каком-то варианте она будет работать быстро но у нас сильно разрастается по штабу и по седает каши соответственно вот почти будет достаточно дорогая штука под здесь процитирую что на 128 килобайт у нас 256 гигабайт используются масштабов то есть ну на порядок меньше но цифры очень серьезную по поводу столь же он нас есть планирование ввода-вывода на наших стран стражах здесь картинка вот давайте то что красным показаны представим что у нас есть три блока которых хранятся на разных местах разных дорожек нашего диска и мы их в каком-то в каком-то порядке кидаем контролем и контроля начинают бегать там сначала нас внутренней дорожка потом частью сразу видит второй блок потом он должен побежать достать большой десантов что сбросить 3 4 то есть у нас диска все время крутятся если они при порядок чивает если же у нас который будет умнее вот зеленым показано механизм оптимизации то он сможет двигать нашу головку память того как вращается диск он может ее еще двигать между дорожками и соответственно делать вот вывод связанных дорожек параллельный у нас получается за один оборот мы успеваем все сделать а здесь вот мы три оборота делаем это работает нас также виза у нас есть еще в линуксе свои планировщики ввода-вывода соответственно у нас есть этот простой планировщик который по сути ничего не делать по счастливая запросы и полагаются на то что х2 ный планировщик все сделает сливает он за пост пост для того чтобы сократить время сыпью и работы притон системы на вот вы то есть большой большой пачке сразу отдать выгоднее d2 планировщика то что вообще рекомендуется для баз данных он обеспечивает нам гарантии того что за какое-то время наши данные будут скинут и то есть они не будут там вечно жить это достаточно простой тоже планировщик и позволяет он базам данным хорошо понимать как будут их да она ложится на диск есть сейчас сетку это дефолтный планировщик наверно во всех дистрибутивах он делать сложные вещи он там если у вас есть виртуализации если у вас есть разные сигу показную пользователи он пытается всех не обидеть балансировать вот вывод давать одинаковые качество обслуживания пользователям но вот для баз данных для серверов это не очень хорошо подходит по поводу оптимизации вот есть в cis капелью параметры здесь перечислил которая там можно починить в частности поменять планировщик изменить длиной в очереди соответственно если понятно что вот в этот очень который мы кидаем и контролем если она у нас более длинная то контролю япония щик лучше сможет сделать свою задачу опере порядочным более оптимально посылайте очереди запросов если она более колодка то у нас например рид с диска будет быстрее да потому что на мы не ждем вот это все переупорядочить рядах это когда мы читаем какой-то блок с диска то мы читаем еще следующие сколько там здесь у нас просто переменная которые задают вам сколько нам читать в частности в и на тебе там более сложный механизм который адаптивным пытается понять как у нас идет нагрузка и подстроится под при fetching если вы пишете свои приложения тут есть ряд системных вызовов которые вам позволяет лучше контролировать сброс данных на диск сеть у нас есть зил копия вот к сожалению у нас нет за копию то все наоборот у нас ездил копию вывод но его копию вот у нас нету то есть если у нас есть например htpc вы который находится в таких условиях что у него очень интенсивный вот и он его фильтрует до либо его там какой-то язык space его вы строите то вы не можете сильно оптимизировать второй недостаток это этого подхода что вот вверху в use space таласе нем написано 2 стенах вызова то есть для каждой вывод вам нужно позвать вас темных вызову резиденция ответ на больше контекст свечей соответственно вывод вот здесь есть биг мак который сделал сам джинсах сбу кто собственно это все и примитив здесь использовать размер 64 килобайта есть 4 его батах у нас destino к ситуация очень сильно там в 45 его в четыре раза если мы захотим размер скажем там до 100 байт у нас наш 2 копию вывод будет хуже чем с копированием все большего количества количество системных вызовов второй недостаток ну это больше не удобства работы что когда вы берете страницу отдаете его копию вашу страницу данных напрямую помещаются в . перестройка операционной системы и вы отдали и вы на самом деле не знаете когда то тебя отправить данные да он может делать ри transmit и так далее вы не знаете когда собственно данные можем можно переиспользовать эту область памяти соответственно используется подход двойного буфера если у вас например 64 килобайта буфер отправки tcp то вы делаете buffy 128 килобайт и вы можете быть точно уверены что если вы то есть вы сначала вы записали план 64 килобайта и если вы пошли уже на второй 64 килобайта у вас socket не блокируется на этих вторых то значит он уже что-то отправил в принципе вы можете начать использовать первую часть буфером то есть двойной buffy он обеспечивает то что теперь буфер будет то полностью поток но до того как мы будем переиспользовать эти данными снова параллельность обработки на самом деле немного ну наверно теряет актуальность уже эту информацию потому что современности вы адаптер они уже дестве на дешевые все имеют вариант уже sh2 на поляризации то есть если сделать грэб блок intergold на ethernet card то мы увидим ни одно призвание для нашего адаптера там скажем в 1624 там 40 много в общем это как раз очереди этого адаптера то есть у нас мы можем нам сетевые бои обработку использовать да вот там 20 40 прерывание соответственно если мы на каждые два положим по отдельным прерыванию то у нас все яды будут правильно работать есть софт канализация ubs то есть если ваш адаптер и всю месиво одну очередь то вы можете использоваться сад ванной реализации и уже операционной система вот имея одно прививании она решит на какой едва отдать обработку этого пакета еще преимущество социальной реализации что там на самом деле плохой хэш считается то есть х-2 на реализация она считает хэш от api адреса назначения и от лавки и 2 потоп , ну и плюс еще по великана протокол там спереди тогда то есть в этот petek она спит в качестве хэша для выбора и 2 по идее должно быть так но по по всей видимости по умолчанию адаптер сквозь довольно плохую хэш-функцию и если у вас очень много я тя вы сделали много очередей то вы сейчас увидите неравномерную нагрузку и один fps другой странных достаточно хороших хэш-функции спорт и позволяет вам лучше распределить трафик с другой страны поскольку то работают на железо но намного быстрее чем 2 еще уже уже заканчиваем это файтинг то есть если вы можете использовать джамбо фильма использовать их потому что операционной системе приходится намного меньше работать глава зубатка каждого пакета в силу мощности стыка очень дорога и гола и газ-аа не помогает решить эту проблему немного другим способом то есть если ваше приложение генри отвязный пакет например 64 байта то операционная система она соберет все ваши пакеты в один большой большую цепочку эту цепочку разума даст на адаптер и одопту и его зам выплюнет как правило к слову о не придет 60 четырьмя килобайтами в принципе вы можете рассчитывать что если ваша прикладная программа на геррит данные небольшими кусочками то больших скоростях 500 сем их быстро собирать и будет работать с участками в 64 килобайта другое дело что это не настоящие пакеты как в случае jumbo frames а это именно вот сегменты которые некоторые пути операционных систем поход немного быстро за счет того что это собранная цепочка по поводу q диск ну это больше диалогов то есть если вы стоите на линуксе you сложную систему например вам нужно вас есть готовый вам нужно дать определенную полосу всем вайфаю за вам о каких-то юзеров опустить на большем качество обслуживание соответствовал можете построить несколько дисциплин очередей каждой дисциплине определить параметры как вы определите да например по айпи адресов москва сити во это будет у вас одна дисциплина с одной ним качеством служит другие адреса вам будут с другими качество обслуживания и так далее в частности она решает хорошо по объему что если у вас есть какие то данные например to win тогда вот там синие пакет это талант и до массивный обработка данных а желтенький один пакет это ваш skype ваш голос вы не можете ждать долго пока ваш пакет с голосом пойдет всю цепочку вместе с он там соответственно q диск позволяет вам назначить более высокий приоритет и пропихнуть пакет более приоритетной раньше чем более низкоприоритетным есть хорошая статья в ли на джона вам этим дисциплинам вот сескапиль я сейчас включил новинок вас так что это должно быть в целом либо статья на той же фабрик попова того как оптимизируйте джексона обязательно скажет о том что есть вот такие сиз критериев везде можно найти вот ну вот мы можем это делать вот все вопросы спасибо за доклад хотел знать вот эта информация которую вы нам представили как можно углубить свои знания вот в этой области узнать больше разных аспектах работы операционной системы linux если какой-то и один ресурсы например несколько больших ресурсов либо это единственный способ только собирать информацию по крупицам с разных мест интернетов книг и так далее не знаю честно говоря я на иначе вообще сваха ли это книжка она совершенно не по linux этапа unix как он способен fous тем смотреть исходники linux есть книжки тёплого готового замечательно книжка на достаточно тонкой может быть 4 страниц она простой студент но она больше поток для разработчиков linux администратором нужно понимать какие есть механизм с которым можно покрутить но и прикладным разработчиком и мне нужно там знать по ядерные api и так далее вот такие книжек я не знаю то есть у меня это как получается вторичное знание которое там получилось поскольку там заниматься разработкой в ядре наверно не ответил на вопрос я не знаю может быть это значит по крупицам получается ну наверно да ну либо вы либо вообще разбегаться вообще как-то все работает как там поговорить либо вот пока песню таким сыграть ну я не знаю не может быть иисус после я им не пользуюсь я в основном они ну данная показывать википедии вообще даже не за sling-tv additions ну не знаю может быть то есть я особо туда не вожу в основном пользуюсь исходниками не знаю ну ну вот в частности вот linux и скачать исходники linux там будет директория документация большой буквы там очень много документов хороших они как бы часть на разработчиков и до рассчитана часть на саму там пассивка целью там очень хорошо можно смотреть нормальный хороший ли ватный сточник спасибо по функции пол и пол и вообще асинхронное программирования там нас указано в linux предоставляет преимущества по сравнению с другими но как минимум по сравнению с windows да наверное нет потому что у нас есть free база у него есть какие вина на еще раньше чем у linux был solaris здесь пол то есть там механизм достаточно простой там суть в том что если у вас есть по серег системные вызовы то вы например добавляйте тысячу дескрипторов ракетных и вас совсем бегает опрашивать дескрипторы с очень и пола вот у вас приходит пакет он попадает в очередь со китае вас понимается вен потому что в данном сайте есть и пакет и дергается прикладной код вас прям из сетевого стека делается планировщик операционной системы и в вас текущий процесс при планируется на запуск здесь есть два два момента во первых в принципе я не знаю что в индии есть но я предполагаю что там должно быть потому что механизма чисто вы во всех фильмах сахар есть на винде он есть 2 здесь есть недостаток что если мы представим что у нас есть не 1100 дескрипторов а скажем 10000 или 100000 если мы работаем безобидный сети у нас выходит очень много мелких пакетов вот нам сейчас на адаптер приходит пучок пакеты скажем 1000 пакетов за счет очередей за счет того что у нас есть много нитей обработки там скажем 40 в яде они мгновенно там поднимают в это эти пакеты и рассовывают их по разным сокетом и у нас есть скажем один наш массивный сервер который получает скажем сотню этих пакетов один поток либо один процесс фактически у нас вот он каждый пакет приходит высокий кино очередь мы делаем планировщик но нам и понимаю что у нас есть никто платности от того что у нас пришел пакеты у нас преклонился наш процесс который готов уже забывать этот пакет и в этот момент вот за счет вот этого вот этой задержки у нас прикладной процесс когда получает управления он имеет он уже у нас там сотни готовых дескрипторов это как раз одна из основных оптимизация этой системы и в этот момент у нас нет гарантий о том что вот конкретный пакет которому первому приступит процесс он пришел первым это значит что этот пакет уже может быть вытеснен из кэша процессора то есть интер ский адаптер + татарский чип они вам дают оптимизацию что пакет которые приходят на да ты сразу кладется в кэш процессора и если вы вот за счет вот этой вот в медлительности планирование вы можете потерять эти данные которые у вас сейчас горячий который вы можете очень быстро обработать из вашего каша и обрабатывайте долго то есть вот сам по себе механизмы по если мы действительно будем обрабатывать все синхронно полностью например как работает воевал linux которые работают внутри софт и q пришел пакет моего сразу за благо там посмотрели побегали по нему там сроки поискали вас сразу получается при фокус на порядок выше"
}