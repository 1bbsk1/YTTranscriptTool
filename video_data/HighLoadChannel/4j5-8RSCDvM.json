{
  "video_id": "4j5-8RSCDvM",
  "channel": "HighLoadChannel",
  "title": "Эффективная отладка репликации MySQL / Света Смирнова (Percona)",
  "views": 2099,
  "duration": 3608,
  "published": "2017-04-22T14:48:24-07:00",
  "text": "сегодня буду рассказывать про эффективно про эффективную отладку репликации мая sql и вот я сначала расскажу про себя меня зовут свет смирнова я работаю вот так вот она я работаю в технической поддержки mais que al уже более 10 лет работала в компаниях майской labels on oracle сейчас в перка не я автор книги отладка май скул trouble shooting на английском языке автор джейсон людей функции которые дизайн прототайп джейсен функции которые сейчас есть в май скул сервере а у меня есть хобби проект на гитхабе где я пишу разные плагины для майя escuela используя к вере в райт интерфейсе один из них например фильтра clause для маску л я а докладчиков на ряде конференции фотографии с ритой наверно следующем году здесь будет написано highload содержание а чем же мы сегодня будем говорить вообще 1 часть у нас особенности репликации mais que al вообще как не знаю хотелось бы начать это клад с того что репликации такой отладки именно репликации такую темы и не существует и отлаживать импликацию надо точно также как любое другое майского приложения но есть особенность нужно просто учитывать особенности то что происходит у вас на мастере и то что происходит у вас на слове и как они взаимодействуют естественно есть специальные инструменты которые используются для отладки для отладки репликации я их буду упоминать в докладе но а но хоть целую большую часть посвященный только инструментом я ее несла в приложении кто будет скачивать слайда она там есть его тут нет на в содержании но она но оно есть и можно почитать подробно с примерами как эти инструменты работают сделано это было для того для того чтобы осталось время на вот эти вот 5 ч 5 частей которые показывают в которых я буду рассказывать про про основные проблемы которые возникают с репликации на основе моего опыта то что люди вообще вот какие у них проблем возникает с репликации то что чаще всего приходится решать и как их решать итак давайте начнем с особенности репликации прежде над понимать что репликация в майскую асинхронная и она из инициируется slay вам то есть допустим work ли там мастер может что то там послать но вскоре crc словам свои файлы tried инициирует и и он запрашиваю каким образом он запрашивает пакет у мастера с данными мастер ему отправляет этот пакет и дальше мастер не знает вообще что произошло на основе получил ли он пакета если он получил этот пакет смог ли он его времени применить к данным смог ли он его выполнить и изменились ли данные на основе если он смог его план завершилась ли это выполнение с ошибка изменились ли те данной или не те данные то есть это всего мастер не знает а только вот все это slave инициирует слышать тоже не знает какие данные на мастере и вот они сами абсолютно независимые а для того чтобы частично это решить проблему голову сделан 7 sync раз плагин который делают пола синхронную так скать рипли к цию что тут начинается она точно также слоев инициирует запрашивает пакет мастер его отправляет и ждет ок это вот ну как этот ждет ответа от слова в том что он получил этот пакет слив отправляет пакет а как бы на этом на этом получается что что у нас вообще видит видит мастер что узнать знает здесь мастер maitz мастер до версии 57 мастер знает что только один-единственный slave получил пакет а если сливов несколько to the master master знает только о том что получил пакет вот эту который он послал только один из сливов только один из слайдов также мастер не знает вообще что случилось с этим пакетом то есть был ли он куда то он знает только то что этот пакет получен он записано в relay у нас на сливе он не знает был ли он выполнил было ли что-то этакое а версии 57 вот это ограничение с одним словом она исправлено есть опция тоже в приложении она указана как она сводится к длинная опция которая можно указать количество сливов которые должны вернуть ответ проблема-то в чем проблема тут есть в том что если что будет если мастер не дождется ни одного ответа есть намаз there's time out сколько он будет ждать максимальное время когда это тайм-аута стечет он просто так почти молча станет все асинхронным стоит если вы не не проверяете в орленке вашем приложении или если вы не смотрите в роллах вы просто у заметите что неожиданно ваше предложение вдруг стала получать ответы от базы сильно быстрее но и вы не узнаете о том что у вас на самом деле асинхронной репликации не они 7 синхронно причем когда если допустим какой-то slave потом решит ответ пришлет ему ответ а мастера опять станет 7 синхронным и опять и опять ваше приложение начнет работать медленнее значит что еще нужно знать привлекаться на морской логическое это значит мастер получает как выглядит а мастер получает изменения передает движку табличный движок пишет в таблицу оперетта пройдет управление на уровень выше на уровень я искал сервера мастер пишет в бинарный лоб и потом от все дела синхронизируется то есть в чем здесь проблема проблема в том что у нас есть пи данные пишется в табличный движок и дано ищу пишет пишутся в отдельный и плюс после этого они ещё ждут когда они область синхронизироваться чтобы не был такой ситуации что сервер допустим упал данный с табличным движке но нет в бинарном локи правда вот синхронизацию можно отключить но не нужно в отличие это в отличие от физические репликации которые копируют данные только из логов табличного движка плюс в этой репликации то что вы можете спокойно делать все что угодно на сливе можете вас может быть таблицы другой структуры у вас могут быть совершенно разные данные вы можете его модифицировать вы никаким образом не привязана к этому и у вас есть масса способов прострелить себе ногу аусла его есть два типа поток вообще до версии 56 это было два потока и давайте пока это просто но говорит что это два потока это и отрезать читает мастера и сохраняет данные брелок из квартиры и thread который читает и среда и лук и потом исполняет а вообще то что два поток это основные источник проблем с производительностью на сливе потому что мастер он обновляет все данный он подавляет несколько поток вас несколько клиентов сразу пишут пишут файлы таблиц на мастере услышавший читает все это в одну один поток и соответственно 2 даже будет какой-нибудь то мощное оборудование несколько я тёр процессоров это использовать никак не сможете с одним потоком а для отладки это наоборот плюс потому что заднем этим потоком у вас нету никакой вот конкуренцию вас искал отряда не буду вызывать дизлайки у вас не будет проблем с каким то может быть они просто будут у вас вот записано вот как они есть как они шли пока не записывались по порядку на мастере так они будут выполняться нас и если у вас какая-то там простим проблема можете просто посмотреть и запустить эти запросы и что-то решить но проблем со скоростью она остается в 56 решили эту проблему таким образом что я склеил тредов стала появилась возможность что их может быть много это указывать по умолчанию это опять-таки 13 но вы можете указать их несколько с точки зрения отладки что у нас остается что его 30 равно 1 то есть в принципе скорее всего вы не упретесь в эту проблему с точки зрения производительности потому что данные передаются по сети они все эти медленнее все равно чтения с диска но тем не менее если у вас ну почему то например вас на видели приказ у вас мужчину становились кьелд ред и и очень много у вас сохранилась relay логе у вас ну придется читать и снова файлов с равно соответственно relay лак тоже один раз а его 30spl thread все равно может стать если так по опыту люди которые переходили на многопоточные sleeve как правило проблемы а вот с отставанием от мастера не решались чисто теоретически можно сделать на мастере такую нагрузку что услий все равно будет отставать от мастера и по этим причинам архитектуры ошибка одного потока в случае мульти поточного своего она останавливает их все и это логично потому что непонятно что делать дальше как ну как должно плестись за приложение момент еще такое что в 5-6 вы можете вот эти несколько потоков вы можете вы должны использовать разные базы данных разные схемы версии 57 это исправлено и вас есть выбор либо каждый поток будет обновлять свою базу данных либо будет использован алгоритм лучше call клок который будет вы который устраняет это ограничение да еще про несколько школ потоков там момента кое что нельзя регулировать как бы то есть вы можете сделать вот это параллель слив workers это опция вы можете сделать допустим ну какое-то число допустим 6 до 16 по размеру ягер а вот реально работать искал 3 возможно мир 8 и это не совсем регулируется то есть обычно когда вы запускаете этот слив он начинает стартовать с одного потом в какой-то момент их становится 23 пока они все не не задействованы но вот как-то самостоятельно этот регулировать все невозможно это всё автоматически делается версии 57 возможно быть несколько мастеров то есть мастер это что такое это несколько наборов релог то есть каждый мастер имеет набу свой набор а и отрядов свой набор из клиентов то есть это несколько наборов relay а вот сколько мастеров столько релог а несколько отрядов и несколько и sqweel тредов и вот этот слайд пролил workers для каждого канала то есть если у вас допустим стоит пара лир workers равно 8 а мастеров допустим 4 то у вас будет четыре отряда и 38 и скрыл тредов канал и независимые это значит что ошибка на одном остановит только его и также это значит что одноименно контент объекты могут вызвать конфликты причем использование допустим global transaction айди тут не поможет потому что transaction ади все время будет разная поэтому лучше как то ну как и мне кажется что лучше делать вот мастеров хотя бы на разной базы или хотя бы на разные таблицы хотя я делала в субботу-воскресенье мастер-класс по отладке производительности маску или мне сказали что надо в одну таблицу с нескольких мастеров писать и то есть такие из кейса первый раз мне как я не захотела чтобы все повально обновились на 57 также репликация в майскую бывает позиционный это значит что вам нужно указывать при старте позицию бинарного logo на мастере и его название и с точки зрения отладки значит о событии выполняется показатели позиции то есть если вы ошиблись у вас выполнится не то же самое событие если одно те же время если у вас допустим репликация встала из-за ошибки вы можете легко его пропустить ск1 сказав сетку упал skip слоев transaction равно сколько событий вы хотите пропустить либо просто указав номер новой позиции в бинарном локи ну точно также легко переместить указатель прошлые например случайно так допустим криво написав файл over выполнить одну и ту же транзакцию сто раз это все возможно май скул и никаким образом о вас тут не заботится это все права на уровне действий пользователя проверок никаких нет вот чтобы вот эту проблему решить было придумано глобальные идентификаторы транзакции то есть что это такое каждая транзакция получает свой номер global transaction джи ти ай ди стартуете вы идет то есть вы уже нет не заботитесь ни а бинарном логине его позиции не нет не считаете нет раза просто ставить авто позиция и стартуете то есть не нужно указывать не бинар налог не позицию с точки зрения отладки тут есть такой момент что например если у вас во первых вы можете не заботится если у вас один мастер конечно а не можете не заботится о том что у вас там 1 этаж там транзакция будет выполнено 2 что она не будет в любом случае если вы пытаетесь это сделать оно будет завершится с ошибкой но когда это приходит по каналу репликации просто if i и просто пропускает соответственно файлов реализовать очень просты например команда воркауту который идет май скул utilities у них утилита майскую фолловер она работает только если master и slave используется gt1 потому что ну как бы на самом деле потому что орку выгодно что все использовали gt1 не реализовывать но и это на самом деле очень очень просто но есть нюанс что если у вас какая-то например ошибка какая-то вы хотите пропустить транзакцию это уже сделать не просто не не так просто что сет тирекс это надо набрать несколько команд которые inject которые как бы выполняют пустые транзакции с указанными номерами для того чтобы это для того чтобы это сделать проще я рекомендую использовать утилиту из пакета того же май скул utilise называется маску слоев trx которая сделает вот наберет все эти команды для за вас но в принципе то есть вот такая есть в особенность sg5 есть еще одна особенность жить ради то что вы должны если вы используете хз файлах des вы должны быть уверены что у вас есть все бинарные логе на случай как какой-то проблем с рипли концы то что я очень часто есть случае у клиентов когда они пытаются восстановить репликацию них а допустим репликация ломается а потом проходит какое-то время почему-то не ученик не сразу через несколько дней за это время уже блоки за x парились и случае джи ти ай ди там немножко сложнее там не знаю там есть вот люди которые тут на мысе данные они нужны мы просто хотим стартовать репликацию ну так нельзя судить и сделать важно это не формат репликация это формат бинарного логово бывает либо statement best это вообще формат который использовался самых первых версий май скул и до версии 5 1 он пишет запрос то есть клиент шлет запрос sql запрос а бинарный опишет set time stamp то есть время когда была выполнена запрос этот сохраняет сессионные переменные из пишет сам запрос вот какую то он был послан с клиента а значит есть тут такой нюанс что несмотря на то что сохранить секционной переменные многие встроенные функции у вас будут работать так как надо возвращать одно и то же значение но но немногие скажу как некоторые но другие встроенные функции и уж точно все ваши стоят функции которые не терме который не эти термини stick и иудеев они тут могут возвращать непредсказуемые значения на слове и принеси при привести вниз к не совпадению данных между мастером и слова для того чтобы решить эту проблему было изобретено строк выйди на фарма бинарного logo то есть он выглядит так что клиент посылает запрос в бинарных также пишется timestream также пишутся с эссе он ее переменные но пишется в бинарном формате строка до того как изменение было сделано и потом строка с изменениями то есть получается что вы во-первых качающихся ну как бы кто пишут очень длинный даже вот кто пишет очень длинные запросы на да а у кого есть таблицы с большим количеством строк или со строками допустим там с текстовыми полями но рук почему-то не все вы если люди у которых нет ни того ни другого но вот людей которых таблицы вот их больше и получается что вот это вот огромное строка она по умолчанию она пишет 100 изменений и пишется после изменения то есть если у вас там может быть медиум тексту носа пишется а вы изменили в числовое поле запишется после чтобы с этим побороться был придуман формат бинарного logo такая опция ее можно сделать в минимум когда пишутся только изменившиеся поля то есть если вы изменили числовое поле вот она будет записано в настройки то только первичный ключ и числовое поле а если вы изменили там если вы изменили там два поля будет эти два поля и примет первичный ключ есть формат full но full это вот такой как здесь показано этом складе есть еще формат full новый блок в этом случае будет записано первичный ключ все поля кроме купаний который ларцом джек то есть это текст медиум текста large текст и соответственно блог медиум блок плант был еще такой момент что если у вас нету определенных первичных ключей в таблице без принципе все равно происходит поиск по первичному ключу и поэтому если у вас этих ключей нет то у вас может репликация немножко подтормаживать и в старых версиях еще были баки когда были проблемы с совпадением данных но эти погиб маску я знаю исправили я давно не видела да еще есть формат mixed который первоначально первоначально по умолчанию пишет в формате statement и если на statement не сейф это такой термин то есть котлетам есть неделями не stick функция например или тмин сердце игнор или лимит ордер buy он тогда пишет его формате строку какие основные инструменты есть для отладки отладки репликации в первую очередь это ошибок лог ошибок вообще это инструмент отладки всего в случае репликации у него есть там он пишет когда стоишь стартует кота слив следы совершают свою работу и штатное нештатно и также пишет все ошибки которая репликации поймала есть на сливе тоже шоу слоев стоит эта команда которая вводит все состояние репликации это что хорошо в этой но это опять таки первая команда которую вы должны набирать если у вас какие-то проблемы с репликацией что хорошо в этой команде она сразу выводит все все что всю диагностику слева все его конфигурацию то есть конфигурация и отряда конфигурации sql 31 состоянии отряда состояния скрыл от ряда и также информация об ошибках в одном месте в одном вы видите такой одной строкой но которые можно вывести вертикально при помощи опции обратный слеш большая g но это такой вывод они очень неудобно наверное с ним работать не человеку а машине вот версии 57 появились таблицы perform от стима они в общем то почти всю информацию кстати не всю содержат свои сусла estate us но они содержат там на каждую на и о конфигурации есть своя табличка на sql конфигурацию есть своя табличка также на и спел статуса и статус я вот вот это вот вообще описание фарма вот этих вот инструментов с примерами она есть приложение скачаете слайды вы увидите примеры что это такой системная база mais que al ей нельзя пренебрегать на слипе для отладки конфигурация слои вы может храниться либо файлах либо в таблицах в таблицах она как бы вкратце потому что это используется и найди by таблицы и она транзак сунул то есть это это сейчас рекомендованный способ хранения конфигурации слева другой вопрос что в общем-то встречаются баки вот с этим системы хранения а на мастере же команда вы есть сейчас извините без команда шоу мастер стоит us который покажет позицию бинарного logo имя бинарного logo если вы использовали фильтры а белок дтп или белок игнор тебе на мастере их покажет команда show белок events покажет то что содержится в бинарном локи то что содержится в бинарном логин такой по умолчанию длинный вывод по моему 1 доступного logo но можно указать какого из какой позиции и команда май скул билоха она показывает более она просто читает бинарный это комбо утилиту командной строке начинает таять бинарный и представляет формате который в текстовом формате причем если вы у вас есть вы используете рублей от формат у вас она выведет такое hex выйдет для на закодированной валют строки для того чтобы она была раз кодирова надо использовать опцию wear босс и тогда получится это будет правда не тот вопрос который был реально посла но это будет запрос как бы вот это ролл event она будет сконвертирована в запрос человека понятные которую вы можете посмотреть глазами понять что там происходило перка на tool kit беркана тулкит там из-за есть основные три утилиты которые можно использовать это 5 онлайн 5 ты был checksum которая правил соединяется с мастером если вам и проверяет на насколько то есть если если разные данные в таблицах 5 и табл sing который синхронизирует и пятен slave fight по моему который показывает топологию репликации морской луч или то самое главное утилиты из май скул utilised to myspace нефти а рэкс который вам поможет пропустить транзакцию если у вас к эта проблема с global transaction айди и также есть утилиты которые сравнивают сравнивать структуру бас сравнивают объекты в базе они несколько менее мощные чем утилиты и спирко наталки то но у них есть свои интересные из кейсы ну помимо репликации еще у них интересные русские своих можно на одном сервере делает когда перк она толкает инструменты нельзя и плюс есть утилиты которые проверяют и топологию репликации показывает опыт и которые имеют отношение к репликации ok особенности итоге а репликация моя скала она всегда доступна но требует настройки она синхронная а мастер хранит данные в двух форматах бинарном логе в двух форматах либо arrow либо statement slave если вы есть и атрид который реплицирует все данные с мастер обрели лук иску эл трит который исполняет все обновления и которых может быть несколько в 56 и несколько таких наборов может быть в 5-7 и также есть кулон был transaction а диверсии 5-6 вы ж давайте приступим теперь к более практической части проблема мастер какие же у нас проблем мосты вообще я делю все группы проблем на две проблемы поведение проблем производительности вот проблема производительности у мастер происходит из-за следующих вещей первое это более активная запись а то есть мастер пишет не только файлы движка напишет и бинарный для того чтобы это уменьшить это эффект это этого используйте а белок в случае робость это формат используйте биллов роу имидж full minimal in a blob патефон значение по умолчанию это full это когда пишется сначала строка туризме и потом после изменений minimal это только измененные стройке но blob то же самое что full но без текстовых полей и бизнеса large общем то есть такая переменная биллов кэш сайт и белок statement кэш says что это такое это борьба фиры куда я рассказывала про синхронизацию a mistake личный шут пока до того как не произошла вот эта синхронизация вот транзакции пишется вот вот вот вот вот такой вот memory буфер а не трансакционный статами запрос пишет вот в этот вот буфер а вот с ним бывает проблема то что ну в общем то по умолчанию значения они обычно подходят для большинства work лотов вот если у вас большие транзакции на имеет смысл после увеличить вот эту переменную сейчас большие запросы имеет смысл увеличить или запросы которые меняют много строк имеет смысл увеличить вот эту переменную чтобы понять что они нужны увеличение надо смотреть опции это паола по шоу global global state as либо версии в 5-7 в perform адским а вы можете смотреть конкретно по средам но в принципе я думаю глобальные перемены тут имеет смысл просто смотреть шоу global статус наблюдать и белок кыш discus и beenox statements диски соперник из ключевое слово диск синхронизация синхронизация отвечает опция белок sing по умолчанию она равна единице это значит что мы совершаем поставках мы сделать запись бинарный по принудительно системе говорим его синхронизировать на диск если ее можно ты описал мне изменять и на самом деле это не совсем правильно еще сплю по умолчание это делается в каждую транзакцию почему-то puma я не это делается 57 до этого это не делалось до этого молчание было другое белок sing равнялась нулю что это означало это означало что после того как произошла синхронизация моя сказал не говорила системе делать в sing и от полагался на операционную систему когда она решит и файловой системы когда они ж тут сделать сейчас можно сделать бинов сил опцию не допустим если вы почему то для вас это как-то ну вы можете потерять больше одной транзакции вы можете указать допустим 10 транзакций если вы можете бесполезно потерять десять транзакций когда они теряются теряются а если допусти происходит крыш май скул сервера они оба эти транзакции потеряны остаются в табличном движке но их нет в бинарном логе о поведении поведение вот и как я уже говорила время жизнь их спарлок да и с одной стороны без экспорт лук dejzr жить тяжело потому что бинарных логов становится много и они используйте sky пространство другой стороны экспорт диса но должно стоять таким образом чтобы у вас вы всегда на самом деле правильный ответ это делать регулярные бэкапы и копируйте бинарной логики и сделать их спарлок да с таким образом чтобы вот ваши чтобы у вас не было такого периода что у вас есть локи такие-то в бэкапе логе таки это на сервер а вот каких-то ряда логов не это вот лучше чтобы немножко перекрывались то есть вы немножко потратите лишнего детского прострации зато вы сможете в любом случае восстановить репликацию его сделаете point and recovery для копирования бинарных логов есть такая опция май скул белок utility она доступна в 5 6 и выше arrow вы должны ее поставить на отдельном сервере едино написать маска белок ride from ремонт сервера у стоп never и куда-то там сохранять и она начнет сохраняется логия касс мастер этого можно использовать для бэкапа а почему это лучше допустим readonly слева то что вы занимаете вы не выполняете скопируйте только-только логе исходного и хуже это опять-таки ход стрельба я то что если вы захотите сделать допустим случится с мастером вам эти бинарной логике придется накладывать но уже в любом случае надо бинарной логике чтобы они вот нем не было пустое то него смотрели бы в бэкапе либо они у вас были были на мастер и синхронизация также из-за синхронизации statement без 8 триплекс это такое сокращение жаргон она несовместима с транзакций залечены рид комитеты ride on комитет то то есть если вы используете эти transaction и завешены волевым у вас только один вариант использовать aruba ice & репликацию порядок записи бинарный лог вот есть анти термини stick события извините она determining события такие как как там entertain гуннар или лимит без ордер buy вот эти все события они в случае statement бесит они могут быть записаны и не не не то есть могут быть реплицироваться могут ждать реплицируется на основе не в том порядке есть еще такие моменты как локи локи wanna be back a gap локинг она тебе для автоинкремент а по дефолту молчание то сейчас умолчанию стоит сейф опция но для ускорения работы а некоторые делают не сейф и получают неправильные порядок записи на слове какие проблемы у slave а и отряда услышат его треда в общем-то основные проблемы так как это он читает они сеть опер диагностика это шоу слоистые тасс вот мы видим что статус и файла connecting в то время старк статус офис quello но может быть есть то есть а у нас рабочий слив но почему-то а и о не работает и видно что уже мы видим ошибку что произошла ошибка 1045 к мастеру из вас но пытается по моему перри соединиться там тоже самой информации можно найти perform от стима рипли конечно конечно стоит из таблицы но там не будет информации о стальной и в ошибке влоги ошибок увидеть этих несколько таких таких ошибок это значит что слейд есть опция ты можешь насколько сколько раз попытаться то есть это коней и конечно регулируется регулируется опыт и номером вот этих попыток он сделает одну попытку каждый каждый 70 каждый ретрита ем каждые 60 секунд а делает вот попытки перри соединиться как это как понять вообще что произошло а для того чтоб понять а вот этот клип сик ошибка 1045 есть утилита называется perry roar она пуста идет стандартной поставке с myspace и можно посмотреть что это ошибка доступа и соответственно если у вас бы хоть другая ошибка вы увидите расшифровку для другой ошибки как это вы все что делать что делать с ошибками доступа ошибками доступа слайд а его 3 ты вообще обычный клиент mais quel и поэтому надо просто взять мой обычный морской из-за машины на которые у вас есть свои пускай пытаться сконектиться с мастерство используя те же параметры что вы использовали в чинишь мастер в данном случае я тестирую на локальном сервере поэтому не стала 7001 вашей же у вас наверно будет какой-то другой номер то есть я вижу опять таки что у меня ошибка access денаит и соответственно дайте на мастер смотреть гранд таблицы таблицы смотреть что там такое вот например я зашла нам на мастер посмотрела шоу грац я вижу что то есть грант только сидят но нету доступа рипли кэш если поэтому достаточно просто решить эту ошибку ну соответственно справки привилегий на мастере перезапустить репликацию производительность сети и также как бы произ-во другие проблемы сети это производительность производительность смысле имеется ввиду сколько по времени занимает вот передачи данных коммуникации между мастер весны ну тут ничего такого специфичные для репликации нету поэтому я не буду извините застрять тут внимание вот это обычные методы опять-таки all и отладки и хочет опять таки удобно проверять с клиентом командной строки посмотреть как он себя ведет или с каким-то а можно писать приложение которое будет делать нагрузку на сеть и я делала для перк анонсирую troubles узел хобби на рафу то можно подробно посмотреть как я я про это рассказывал а в принципе про эти методы окей какие проблемы бывают на sql трети школу третьи вообще есть 2 2 основных таких а топологии простая один мастера dance life какая тут мои руки тут бывает проблема что бывают разные данные на мастере если вы труслив не может выполнить event-ы зрелые logo потому что потому что ивент этот ожидает например 1 первичного ключа я одного уникальная уюни constraint но на основе там она практически другие данные есть такая упс еще разные ошибки на мастере сливе особенно замечает на ошибка что на мастере у нас замечательно такое сообщение что на мастер у нас такая это ошибка она силы и ошибок нет поэтому репликацию нас остановилась встречали такое вот или взрыв сильно отстаёт от мастера в случае круговой репликации какой-то любой другой дополнительной запись и выполнение успел 3 в принципе тут все тоже самое но разные данные их немножечко надо то есть в принципе они отлаживается одним и тем же способом но тут то допустим вот сюда прибавляется больше вот это вот топология как надо думать как могли вот эти разные данные могли попасть вот из топологии которые вот здесь вот это сложный сделано значит разные данные вообще такой чек-лист первый вопрос лица менял если в нее репликации каким-то ваше приложение в принципе нормально менять ну не то что нормально не рекомендуемая практику на все ее используют многие ну надо посмотреть отписали что она действительно безопасный меняется что там ну вот это классический случай описан и ману одисов то инкрементом с какими-то другими полями уникальными надо посмотреть каким образом бог вас есть конфликт возникнуть конфликт с обновлениями на мастере идентичная де структура таблицы можно посмотреть вот структуру май только структуру можно посмотреть мамой school div утилитой она только структуру сравнивает а вот данные в таблице еще можно посмотреть вот перк он опять это пальчик сумму утилиты но можно вот этой вот май скул тебе compair я рекомендую 5 ты был чиксу потому что она сравнивает данные в танках и это меньше нагрузки на сервер а маску тебе cad cam пара она просто делает checksum ты был и ну как бы это не совсем может быть то что вы хотите сделать на большой таблицы обновление в неправильном порядке то есть нужно посмотри ну как бы есть вот надо наверное наоборот пункта логика приложению на мастере посмотреть грубой оценить в россии тоже ваше приложение то есть вы знаете как она работает оценить приблизительно что может вызвать эти конфликты и проверить и удостовериться либо если не знаете посмотреть в май скул берлоге в каком порядке идут записи потому что следующий год следующему сейчас будем говорить про сбр особенность то есть дайте про и сбер значит обновление в неправильном по рядам вот эти вот обновления неправильном порядке они во-первых бывают чаще всего только иначе не то что не бывает только при statement смита рипли кации вот классический случай это блокировки на уровне строк и допустим обновление несколькими 3 на одной и той же таблички одной и той же таблички и бывает была проблема со старым из-под старого обозначением и на тебе of the yang yang алла комод когда когда они гарантировалась когда это она реплицирует сосны с разным один с разным один генерируемым авто инкрементом и после этого после этого при обновлении для таблицы могла возникнуть уже ошибка которая 100 остановит репликацию даже если казалось что это не важно но при молчание при дтп eating мод вам он единицы по умолчанию этого не произойдет но но часто и иногда меняет его на другие значения на на другие значения менее сейфе надо вот если вы это меняете получаете выигрыш-выигрыш скорости но надо понимать что риск такой есть триггер и триггеры классической вообще вот этого собственно триггер и очень часто эта причина вот это вот ошибки когда на мастере была ошибка о славе нету особенно если триггеры это они почему-то используют не транзакционные таблицы что делать с ними с триггерами ну как бы тот самый простой способ починить это пропустить транзакцию либо сердца глобус левский скаут р если вы не используете глубже тяги либо пропустить транзакцию джи ти азии потом синхронизировать таблицы но и как-то аккуратней подстригает иметь br пробуем может быть перейти на роба эти форматы для кто-нибудь использует я не знаю 51 уже нет да то есть все используют что-то 55 или выше отлично то есть тут не не читайте это это уже это уже неправда потому она опять родины очень была такая ситуация от показала про то что хранится случае statement by смета там ранец as the instep и хранятся опции сессионные и вот дело в том что вот они хранятся они хранились не все и были баги когда просто лишь говорили вот у меня там искал мод менял на данные данные с а не помог 55 таких богов нет уже но встречаются люди которые используют совсем старые версии поэтому я это решила здесь слив отстоя от мастер опять-таки mail то в основном очень-то в общих чертах это говорили то есть проблем в том что мастер выполняет обновление в несколько потоков основ используют один а либо если он использует ни один они все равно там есть некоторые некоторые ограничения как это выглядит выглядит это что секанс пихает мастер увеличивается ну да это нельзя однозначно полагаться почему потому что это какой-то эстимейт допустим если численно мастер если вы как-то не не так работают то есть этого можно либо я ой ой извините очень сделала так через и на мастере сливе как-то раз синхронизировать либо еще бывает бывает так что какой-то запрос например нас на сливе длинный он своих можно делать неправильное предположение сколько он будет выполняться то есть что нужно полагаться можно полагаться что в шоу слоистый тусе есть есть информация о бинарном локи который сейчас данные выполняются и бинарном логе которого читает аулах и их позиции вот эти позиции можно сравнивать он опять таки вы не узнаете время в таком случае потому что все равно все равно придется делать самим эстимейт еще можно сравнить шум мастер статус чтобы сравнить как артрит и отстаёт а надо что с этим делать это настраивать производительный слева то есть по возможности пути 3 slave но могут возникнуть проблемы правления выполнения между потоками слева потому что они начинают тут же шарить ресурсы и причем это может быть не не те и не те права которые мы управляем и то есть не достаточно репликации даст достаточно умный чтобы там где доков между потоками наверно сделать он не будет это делать но может быть такое что допустим вот запись на диск увеличится будет какой-то multics контент шин потому что их будет просто больше то есть то что всегда должно ну то есть это должно соответствовать вашему оборудованию этих количество этих потоков а если вы используете statement без трипле кришна используйте апдейт сфера clause тасс там имеет смысл сделать яндекс если но опять-таки используйте посмотрите по explay но поможет ли это вашим апдейтом но можешь помочь мне сделать индексов на сливов если это стендбай но и предки с тобой тоже туда не должны данный одинаковая но если как в каком-то варианте то есть многопоточный slave какие с ним проблемы но проблема с ним в общем то такие же как и 1 поточного только единственный нюанс это единственный relay лоха и соответственно скорость которая высоко высоко конкурентной среде она все равно может проседать по сравнению с мастером просто потому что много стоил отрядов они читают из одного файла slave параллели workers эта опция которая который устанавливает количество потоков из них породил type вот версии 5 7 и выше можно использовать либо то тобайес когда будут каждый поток будет работать с одной базой ганнибала jackal клок когда будет вызывать пользоваться внутренний алгоритм который будет позволит использовать одну базу нескольким и скрыл 3 этом неправильные методы это очень то те же самые методы что для этого поточного но опять-таки вы должны обращать внимание на вот методы как на проблему которая возникает в конкурентной среде потому что то по точно у вас проблем с конкурента святой не было если с многопоточного съесть и опять таки вот эти все детерминистский канадцев statement и они могут неожиданно вылезти ты именно многопоточном слове ошибка 1 3 это останавливает все вот можно пример как раз perform от стима репликация специальные такие разные инструменты взялась если иллюстрации и плеер state us buy worker и player это вот такое название school тредов performa схема почему-то назвали ней player worker это нут их несколько вот для каждого из них есть есть информация вот поэтому видно что у него нету ошибки и поэтому видно что вот у него есть ошибку worker два файла такси креатин transaction можно при помощи утилиты террор посмотреть что этот номер 1032 значит и логи ошибок посмотреть ошибку multimaster то есть тут достаточно короткий слайд репликация должна быть настроена для каждого канала а можно одновременно использовать master of global transaction аде и без но естественно слои должен быть все равно стартовать с опцией gt1 можете создать всем но головной боли но те же проблемы и решения что и в случае обычная репликации но единственно вам нужно помнить о том что как-то их разводить мастера то что своей совершенно не заботится о том чтобы они не конфликтовали их не изменения фильтры да вот это интересный момент фильтры они применяются одновременно для всех каналов это что значит если у вас есть фильтры на основе это реплика этих норы и теперь при кайду тебе или wild их версии они применяются для всех тут нельзя так использовать наприме нельзя распараллелить репликацию например sperg an extra типе кластера с одной ноты копировать допустим одну базу с другой ноты с другую базу нельзя потому что фильтр применяется для всех каналов и вы не сможете вот таким образом разделить с у вас должны быть объекты с разными названиями на всех мастеров итоге проблема мастера те же самые что и для обычного сервера без всякой репликации но он единственно больше пишет и больше проверяет больше синхронизируется с wi-fi а и отряда у него это обычный проблемы с сетью решают с таким же образом для тестах удобно использовать мой осколком онлайн клиент просто потому что вы в нем а лучше увидите в чем ошибка в случае sql 3 да это обычная проблема при выполнении запросов это обычной проблемы те же самые движка которые у вас есть на любом сервере но меньше и в любом случае это меньше потоков выполнения чем на мастер и больше информации где можно вот я опять на ссылки на trouble shooting вебинары the basic techniques это вот я когда говорю что это от обычной технике и тут я отсылают к этому trouble shooting хардовый ресурс и usage это для нетворкинга для для проблем сетью там ее проблемы с оборудованием introduction to the storage in trouble shooting и бинар это с типичными проблема с движками upper канат алкид май скул и телитесь это перк он где можно это документации где можно скачать набор книга майскую хая в обидеть чака бела ларса tall man аймакс кендалла она это реплика ешь интима orkla она только как бы из двух частей она чем цена в ней описаны multimaster какие-то сложные реплика яшин сетапа и описано общем-то грабли по которым людям ходят и как их избегать вот она они много уделяют фабрика не так как раз работали над фабрик там у них очень большая фабрика часть самая ценная часть это вот эти вот грабли по которым люди ходят и как сделать настроить так что по этим граблям не хотите i am a искал рипли конечно team blog где пишут просто о том как они разработают на 3 фикации если у вас есть вопросы то спрашивайте добрый день я не знаю хорошо это или плохо но к 6 или ник 6 все проблемы с репликации у меня пока сводились крышу мастер или слева это может быть вам кибер или просто сервер упал и если мастер попал то репликации легко устанавливать с указанием нового файла а если упал slave to у меня пока еще ни разу не получилось вернуть репликацию кроме как просто заново выкачать весь dataset то есть раза четыре опробовал сказать себе нет в этот раз я все ошибки пропущу корректно я восстановлю консистентной все будет хорошо но не получалось чаще всего эти ошибки были связаны с таблицами либо у которых нет автоинкремент на поле либо на таблицах которые используют триггеры скорее всего проблема в где-то в консерватории можно сделать что-то себя изменить так чтобы таких ошибок больше не было вот в чем может быть проблема с движки вас транзакционные то есть и на тибетом на ну и ошибки у вас именно у искал 323 ошибок нет это ошибка попытка удалить то чего нету или виду при клетки и в случае крыша именно слева но это надо честно говоря вот так вот просто надо смотреть ваш слух ошибок потому что то что привело крышу слева скорее всего каким-то образом то есть если допустим там да это корр обшита в этом ничего удивительного если там что-то еще надо хна начинать с просмотра внимательного чтения error logo и смотреть что привело крашу крышу а потом уже смотреть что происходило на основе то что могло вот так вот и сметаны я хотел спросить насчет multimaster для слова а может быть можно ли сделать при этом слое в самим мастером то есть как вот кольцо мастеров то можно если приложение будет без проблем с не крепкими какие еще могут быть подводные камни подводные камни то что вы таким образом все вас больше шансов повредить данные апдейтом не из того мастера не стал осваивая в каком плане об этом листва мастера то есть русские мастера пишут на все мастера допустим 4 мастера и а не обновляют друг друга не в кольце а прямыми то есть вы также начинка 4 мастера они пишут ну как попытки если у вас вот но в обычных круговой репликации если вы допустим мастера обновят один объект то есть вас будут какие-то проблемы а так у вас четыре мастер вас в четыре раза больше шансов получить эту проблему хорошо нет если это на приложение разрулит и что они пишут совершенно разные вещи тоже есть тут в принципе можно попробовать магнит почему нет спасибо вопрос здравствуй спасибо за доклад здесь здесь скажите вот про галера репликацию как-то мало осветили тоже натренировались фикации я не освещала потому что это совершенно отдельный продукт и то есть начнем они у них upper там и свой лоб куда они пишут изменения и для нее это тоже быть отдельный вебинар понятно спасибо еще один такой вопрос на sleeve на сливе каким образом при репликации отрабатывают триггера если это робыте трипле catia они если у вас они не отрабатывают если это statement ps3 приказ это таким же образом как если бы вы запускаете запрос то есть вы запустили запрос триггер сработал ну так получается когда на мастере уже отработал триггер даже тоже меняются но опять-таки предки для вас получаем двойную изменения мы не получаем если в случае roll band репликации триггера не отрабатывается в случае стоит а в случае стоит в таборе pliko p3 при кация мы не призываем то что sleep tracker отработал на войны релог мы пишем только сам запрос то есть вас может быть stryker на мастере не может быть триггера наслаивать допустим не может быть триггер намасте я может быть триггер на слои в этом случае а если там и там триггера анона мастерят работы триггер что-то изменится ну кто к авто как работал мастер на триггер у вас будет сообщение только там если он сашиного завершится она не пойдет робость потому что вас statements включена as робость не пойдет просто изменение там не будет в принципе мы получим ошибку таким образом не почему не обязательно если того как вы триггера написать нами на пятна пейджерами неодинаково написанные на мастере но злые если они одинаково написаны на мастере на основе и вы используете стоит нет б с 3 клика цию у вас будет запрос на мосты выполняться на таблице вызовет триггер триггер выполнится и запрос который первоначально вы прислали он запишется в баннере когда слив его прочитает то что ты записал там триггера в бой налоги не окажутся вот это что записала слои соответственно прочитает это за рост оригинальность мастера и что-то с ним сделает если у вас все атлетично но оно должно быть идентична то есть получается когда на слове произойдет вот эта запись на слове точно такой же триггер на обновление если стоит а ну а не он же тоже отработает получается то должен конечно спасибо здравствуйте и спасибо большое за интересный доклад у меня есть такой вопрос по при примерке аппликации из практических ситуаций мастер 56 катаете репликация в какой-то момент на слове и о троит работает с created практически стоит соответственно растет секонд-хенд с чем это может быть связано куда смотреть шоу лица листы не показывает некий хен сортов неких локов ничего что это может быть сейчас минуточку у нас просто следующий докладчик я хочу показать что слайды будут на сайте конференции слайдера и вот кто скачает вот там будет приложения да пожалуйста поддержи соединяйся значит такая проблема в слив из ql thread у вас один помогу да ну штатная ситуация это что-то он выполнять такое большое и сложное то есть ну а ну-ка правил тогда отображается шоу процесс листе там допустим я не знаю какой то длинный длинный длинный обновлению стро в том-то и дело в шоу потому что запросов активных не только select и никаких инсектов никаких апгрейдов ничего нет из статуса вот этого из ql3 да там какой вес не это имеет в процесс листе что он делает там не понятно да не могу сказать ну в общем это может быть баха я даже в общем то что то подобное стажа когда версия 56 из последних 5 6 из последних руд в руне из последних последний раз ситуация была где-то с полгода назад после этого обновлялись то есть 5 6 вот на полгода назад полгода назад на общем смотрите сейчас вот в принципе если вы ничего там не видите tools может быть и и бах смотрите на но есть еще может быть там такой момент конечно если у вас там какую-то огромный стресс может он не хочет может еще допустим но опять-таки вы можете телефон морским или вот best performance тима есть такая events as they just set таблицы там можно посмотреть что там делалось можно посмотреть просто по системе что у вас там уж на диске какая-то активность больше может быть сибиу что-то возрастает то есть какие-то временный файл открыто ну может быть и барда канал спасибо большое но наверное всё я передаю микрофон следующем докладчику спасибо большое"
}