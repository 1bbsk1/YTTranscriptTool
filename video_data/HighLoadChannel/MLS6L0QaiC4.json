{
  "video_id": "MLS6L0QaiC4",
  "channel": "HighLoadChannel",
  "title": "Как не «проспать» проблемы в базах данных Postgres / Николай Самохвалов (PostgreSQL.support)",
  "views": 6408,
  "duration": 3132,
  "published": "2020-04-27T13:26:34-07:00",
  "text": "сегодня будем говорить про здоровье вас данных вкратце обо мне в общем да с пол весам очень давно активно в разных ипостасях когда-то даже немножко хакерам побыл но последние годы я занимаюсь тем что в долине ну и в сша по большей части консультирую как лучше масштабироваться как лучше избегать проблем заранее они тогда когда они уже нас уложили продакшн и в общем-то участвую разных конференциях качестве участника программного комитета включая эту самую конференцию вот и мы в принципе в мы идем сейчас к тому что что мы делаем то что они делают клауд клауд вендерс они они все по-прежнему ну не только клауд вендерс по-прежнему в в суде главная задача как а в мире микро сервисов cabernet так далее нам сделать оркестрацию потом продвижением бэкапы реплики failover вот это все это еще будет много лет улучшаться и делаться но у нас фокус дальше другие задачи ebay которые пока что слабо решаются их автоматизировать и улучшать и одна из них об одной из них сегодня пойдет речь эта проверка здоровья простой простая постановка проблемы я извиняюсь что так что у меня будут слайды на английском зато я все раскрасил в правильный цвет это я или вы а кстати кто из вас работает с полюсом ежедневно поднимите пожалуйста руку вот правильно с правой части в два раза больше чем с левой а кто из вас хотя бы раз разбираясь какой-то проблемой докапывался до решения с помощью чтения исходников под газ а теперь слева больше интересно это правильно то есть open source силен тем что мы можем документацией всегда не хватает дай мы можем закопаться в исходнике разобраться что на самом деле происходит тем более это не так сложно подписи очень как правило чтение исходников после все сводится к чтению комментариев а это plain english и он хороший там все понятно допустим это я или вы и вот у нас есть наша любимая базы на пол здесь и и у нее конечно же есть паспорт реплик для ячей то есть чтобы если что мы мастер могли приключиться и downtime снизить к минимально каким-то там минутам от если of the fall over топ десятком секунд но вот у нас разработчики начали разбил великий на микро сервисы и ли у нас какие-то новые проекты там появились и у нас еще появились мастер и с их репликами и так далее и если раньше мы заботились о нашей базе как там пэт то есть домашнее животное знали все болячки особенности мы с ней уже давно живем и все хорошо то теперь у нас есть как это называется стадо котла да и у нас у нас уже нет роскоши относиться каждый из них как любимому животному там и примут выхаживать нам нужно как-то управлять всем этим делом и конечно же очень часто в компании кто-то один лучше знает область суде или несколько человек но их очень сильно меньше чем backend инженеров и все вот это вот масштабировать если у вас только пара рук которые знают как работать с базами в общем нужно что-то с этим делать вот собственно эта проблема и есть немножко с другого конца можно подойти к этому вопросу так если у вас есть какая-то система то особо да это всегда в сердце я выбрал эту профессию потому что я снова начала знал что база данных есть любой системе а nikon 1 со рациона и реляционная модель хороша и будет еще долго жить и это на подтверждает и это сердце вашей системы это топ где лежат данные это тоже что сложно масштабировать потому что это много терабайт на часто база которая которую не так-то просто взять и и развернуть еще где-то и нам нужно заботиться то есть проблемы в базе данных это всегда очень больно и лучшие проблемы видеть заранее то же самое как как если у вас есть автомобили или если у вас есть вы сами и вы должны заботиться о своем здоровье и делать проверку регулярно если вы этого не делаете ну потом будете расплачиваться гораздо серьезнее то же самое с базами данных в итоге чтобы вот учитывая все вышесказанное что мы хотим мы хотим прежде всего прийти увидеть мастер низко реплик и очень быстро понять что что они из себя представляют нас обычно эти суета вполне конкретные вещи я забыл упомянуть я вся за свою карьеру больше стать технических аудитов сделать хавчик овчека пав как угодно можно называть и на для подвеса и уже как бы выработал какие какие штуки нам нужно обычно проверять конечно можно очень сильно углубиться а можно сделать такую золотую середину где мы покроем важные вопросы и и сможем подсветить проблемные участки и так мы пришли и мы хотим очень быстро появится с кем имеем дело или заново понять может быть мы приходили после нас полгода такое тоже бывает угодно за да пусть у нас несколько там микро серовато в куча бас именно конкретно этот сервис мы проверяли после нас полгода уже забыли и обычно это мы хотим узнать что за ресурсы используются в случае клауда какие там инстансы как как какой тип нагрузки очень важно какие в случае он принес или saf момент клауда мы хотим узнать версию системы версию ядра чё за файловой системы там используются и и также мы хотим быстро понять если различие между мастером репликами потому что это тоже важно потому что если файлов случиться у нас реплика будет совершенно другим мастерам чем раньше второе мы хотим быстро понять где главные потенциальные проблемы или где уже существующие проблемы которые просто из даст к внимания мы проспали это очень частая ситуация то есть что какие-то проблемы живут долго пока не совсем не-не-не-не обозначить себя иногда это только зарождающейся проблемы и общем то же самое что в машине что здоровье любой сложной системе включая самую сложную систему это человеческое тело есть вот такие паттерны что мы можем что-то заранее уже выявить и это либо это вот что-то с перфомансом мы можем уже понять что вот это вот эти допустим часть его клода ведут себя хуже и уже видно что они хуже уже видно что они там а ехать хотят больше или что-то такое или есть какие-то серьезные вещи например мы знаем ну это вот чек-лист может включать в себя проверку каких то вещей которые покажут что допустим в sing выключен значит у нас ясно что очень существенный риск потерять данные и вообще получить не консистентные состоянием случае хард резета а сервера то есть это такие вещи тоже надо сразу подсвечивать и соответственно мы хотим подготовиться к тому чтобы если в случае прав ну если есть проблема чтобы мы могли их trouble шутить решать уже знали куда копать и какими инструментами копать здесь хороший вопрос к есть конечно у вот я буду рассказывать инструмент open source ные который мы мы сейчас развиваем то есть сегодня завтра будет версия 11 три или четыре недели назад была версия 1 0 то есть мы уже его вовсю используем продакшн и наряде клиентов обкатываем автоматизирует автоматизируя собственные же процессы он главный open source на git лови доступен вы сможете его использовать или какие-то принципы из него используя фидбэк по прошлым моим докладом про другие инструменты я вижу ник часто бывает фидбэк реклама своего продукта ну пожалуйста не пишите это open source я рассказываю про принципы и кусочки кода который можете смело тащить китае рекламируют а что я делаю да но это очень странно и фидбэк если я еще раз увижу я значит не знаю что делать значит мониторинг конечно есть пересечении то есть в мониторинге тоже мы можем увидеть проблему ну во-первых мониторинг он он он недостаточно глубоко копает часто то есть да мы видим что высокие потребление сыпью высоко-высоко занят да ну почему так мы докопаться чтобы докопаться надо идти вглубь вот мы можем на самом деле мониторинг свой развивать добавлять туда например анализ запросов но не все в мониторинге на это способны если какой-то там дед да это так это вообще там такого нет и он принципиально они даже не обещают пока если это ваш какой-то кастомы там grafana какая-нибудь там только последних версиях графа на это можно как то хоть как-то запилить на основе перестал стоит statements если же востоке метр вам повезло у вас достаточно там уже интересные штуки уже за покрыты спасибо им они очень хорошо сделали но есть такие вещи ну да мониторинг он показывает исторический он постоянно теребит вашу базу проверка ли вы не можете более тяжелые проверки делать например я вижу как некоторые пытаются запилить анализ флота и со временем у них начинают запросов там 10 секунд 20 секунд от робота для мониторинга это уже не очень хорошие запросы гонять такое каждые там пять минут даже это уже не очень хорошо и оно и не надо то есть нам достаточно эти проверки делать реже но но в общем более более полноценно то есть check-up это такой инструмент который плоскость check-up и такой совет который нужен для глубокого анализа но не так часто вот и отдельные случаи когда вот ну наши console тирский некоторые случаи когда вы приходите к кому-то хотите помочь и в общем-то и мониторингом году но они даже готовы поменять мониторинг а если это более менее крупный заказчик это занимает лучшем случае недели а нам про хочется прям щас и отпуск с check-up он может прямо сейчас информацию дать и но не всем не веду я уже рассказал до что не все вещи покрываются мониторингом и еще один момент вот последний пункт с попробую эту супер фичу вот а то есть но ты хотел строчку ru кружочек не работает то есть в некоторых случаях нам хочется анализировать в совокупности мастера реплики а в мониторинге это не тривиально общем то он но хорошо если графики можем кита наложить а нам хочется не графики нам хоть таблицу хочется нарисовать на то есть мониторинг имеет свои ограничения в том виде в котором он сейчас существует и в итоге мы она да и мониторинг у него задача другая то есть у него задача это быстро быстро сообщить о проблемах которые всплыли превысили какой-то порог срочно решать одну сочно реагируем и как правило ретенция хранение логов хранения мониторинг информации он тоже какой-то ограниченный вам повезло если у вас есть информация запустим за прошлый год за позапрошлый год обычно мониторе бит информации нет соответственно выяснить как у вас росли разные таблицы это очень нетривиально становится нам даже приходится там специальные статистически алгоритмы использовать чтобы понять как она 1 слой как оно будет дальше расти размеры таблиц и индексов и так далее вот но мониторинга необходимая вещь по любому то есть я здесь не говорю что давайте выкинем мониторинг в замене на прозвище как мониторинг должен быть обязательно и подрядчиков никак не заменит вам мониторинг это другая вещь то есть болельщиков это в лучшем случае вы будете 1 неделю что-то анализировать но но нет они не такой тактический инструмент как мониторинг который каждую секунду там 30 секунд каждый каждый минута или 30 секунд опрашивает все и и в случае чего красную лампочку зажигает вот значит дальше следующий вопрос а у нас уже есть какие-то tool set и инструменты и и все такое это именно то что то что именно в эту сторону мы должны копать чтобы решать проблему хорошие проверки здоровья автоматизированный то есть это наш фундамент для того чтобы строить автоматизацию проверки здоровья вот год назад как раз здесь я рассказывал про инструменты плоскости бей которые получил какой-то там отклик на гитхабе заметный и это такая штучка которая там заходишь песке ли мы получаешь такую менюшку интерактивную грыж мне пожалуйста вот этот отчет или вот тот отчёт то есть это вполне себе инструмент который я тоже постоянно использую но он такой тоже в мониторинге мы что-то нашли и мы пошли вот эти вот этого тоже проверять и смотреть что мы там можем накопать мы сидим на одной машине здесь то есть это уже ограничение да и конечно же песку эль формат который мы там видим он ограничен и то есть эта консоль к я очень большой любитель консольки но не все такие большие любители вот есть другие инструменты вот некоторые здесь здесь перечислены некоторые из них в представлении дают как пиджи кирова бесплатный наруби написан инструмент очень легкий простой довольно но довольной в том числе довольно хорош хорошо закрывающий некоторые вопросы инструмент вот есть такие древние как человек после с . пели на перле написаны так далее вот все это мы взяли замешали и продолжаем замешивать и делаем больше автоматизацию улучшаем форматы и делаем молодцы но танариса никакого никакой фантастики нет вот то что мы делаем после щека значит теперь с чего мы у нас состоит инструмент и как мы его применяем на практике он должен на git лобби прямой наследник вот пол везде бей который 1 но давай им такой ручной и очень важные требования и не всегда легко его придерживаться но я обязательно его придерживаюсь мы ничего не должны ставить на сервер никаких агентов ничего вообще то есть это принципиальное требование потому что нам нужно с первой минуты уже получать результаты смотреть что там происходит с первой минуты взаимодействия сервера инструмент ограничивает себя 30 секунд любой запрос то есть если у вас огромная база то какие то запросы могут занимать какое-то время как я сказал пример blood запросы инструмент будет себя ограничивать и в общем стоит над mode выставлять благословит автоматически и общем то минимальный эффект оказывает на сервере хотя конечно следы могут быть и чтобы ну то есть это не то не для того чтобы там никто не узнал что вы выгоняете что мы выгоняем то есть это для того что имеется ведущая семена про эффект на производительность сведён к минимуму насчет знать что вы его вы его гоняете наоборот выставляется application name check-up наоборот видно в логах что что что происходит естественно молча not анализ я уже третий раз на говорю что это очень важно в совокупности частенько смотреть на на картину в целом вот и в общем как результат если раньше для крупных баз для которые развиваются несколько лет и там много терабайт нам приходилось тратить на полную проверку порядка двух недель сейчас это все сводится к четырём часам причем из которых самый сбор данных это меньше десяти минут обычно несколько ну то есть зависит 10 минут это минимум потому что там два snapshot а надо а дальше идет о просто пара часов анализа работы эксперта чтобы написать правильные выводы рекомендации и так далее как это работает вот у нас есть мастер несколько реплик мы просто со своей машины идем по ssh соединению там лака но есть нам нужны права конечно же как правило у тебя есть право или тот кто общается с биби и у него есть право и просто по ремонту ssh дальше запускается локальной песке ли мы все собираем ничего ставить не надо второй вариант прямое соединение случае rds допустимые там другу их других облачных решений вы можете использовать прямое соединение к полюсу ну тогда вы потеряете ряд отчетов которые смотрят файловую систему плетеную систему и так далее поддержка всяких rds и так далее у нас тоже в планах есть чтобы собирать инфу а что заимствоваться какие там характеристики и так далее вот и соответственно дальше первое что делает инструмент он горит джейсон отчеты они складываются файлики их можно сохранить пол с не может делать что угодно это максимальная гибкость так как это джейсон вы можете это интегрировать свои какие-то другие там решения специально так сделали чтобы быть ну чтобы быть машин френдли а дальше делиться markdown report markdown репорты являться для того чтобы их можно было легко вставлять например в git хоп и shews если кто ими пользуется это мы сделали просто ну или гид лапы shews сделали потому что нам было удобно так сделать и действительно взять кусочек reporto и вставить его в git лап ищу и сказать разработчики или там смотрите вот такая-то проблема такой-то запрос тормозить прям кусочек markdown мужик и сгинь ириной это мкоян табличка и это все очень ускоряет мою работу точно сейчас дальше из макдоу на вы есть возможность автоматически попросить генерить pdf или статичный чтим el в ближайшем будущем мы планируем также сделать красивые чтим эль динамические которые будут брать джейсон и отрисовывать их уже так что можно было там сортировать и так далее но пока вот только такая картина что уже неплохо то есть у нас есть машин френдли у нас есть home и френдли и пока пока что без картинок пока что только таблицы но эта база картинки тоже будут вот есть еще один вариант можете ничего там не ставить именно машину можете взять докер контейнеры и поднять на основе нашего образа который у нас выложим на git лобби и соответственно оттуда плясать и тоже сам точно то же самое делать уже из этого контейнера и соответственно вот но это вот contributor его на муратов сделал спасибо ему за это и есть уже пример где это хорошо используется сейчас это обкатывается прямо в git лобби github.com они чека привыкли репорты как раз у себя вся сиди там каберне тасс поднимает runner контейнеры там несколько строчек уже все весь опрос происходит очень удобно красиво и современно вот теперь отчеты значит у нас вот так такой был общий очень много всего до больше 50 отчетов которые мы запланировали и мы сделали вот где там и shews видны это мы уже сделали мы сделали больше половины уже это будет попал постоянно пополняться потому что поле там огромная для работы в кого так не туда вкратце вкратце у нас разбивается значит на какие-то общие вопросы дальше идет вещи которые сложно автоматизировать обычному это разговариваем с людьми как с быка по настроены используете ли вы что-то для авто фил озеро или и как вообще с политика там всякие слыл ваши какие у вас там бэкапом характеристики и так далее но дальше да и мониторинг то же самое то есть как какие в метрике уже имеете покажите и так далее ну дальше пошла автоматизация то есть вот of the vacuum настройки blood анализ индексов и анализ запросов об этом их кросс сейчас поговорим некоторые анализ схемы начнем с первого да вот есть общие при первый отчет это просто мы знакомимся системой данном случае то это вот из райнеро дятловского я прям взятое видно что у нас тут у нас видно что сколько памяти видно какой процессор 1 1 весе пью всего на общем видно и важно видно что у нас с версии ядра не такая уж и старая не не хотя бы там ни 2 какой-нибудь уже хорошо то есть такие вещи мы видим да тут замечание контужен своей командой шанс мы только начали автоматизировать но мы все еще принимаем заявки на то чтобы бесплатно их заполнить вы можете нам прислать мак-даун с вашими то есть каждый отчет забыл сказать очень важный момент когда чет я выработал своей практике его удобно строить делю на три части первая часть это наблюдения observations чем мы видим да то есть мы видим такой такой и очень классно бывает сырой вывод прилагать потому что внушает доверие тем кто будет потом с этим документом например работать то есть если там допустим кроме росстат показать этого видно что это просто от людям видят знакомые вещи но не всегда это возможно но тем не менее вот мы собрали дальше второй вторая часть confluence какие выводы мы из этого делаем обычно это нормальный plain english или там рашен мы говорим мы здесь наблюдаем что у вас там так такая этот вещь вызывает подозрение что скоро будет ой-ой-ой и третье это экшена этом 100 есть это что ту-ду-ду-ду да то есть рекомендации что нужно сделать чтобы этого избежать и бы исправить если уже уже плохое случилось вот такая простая простая структура каждого отчета она позволяет ничего не упустить и уже и понятно что делать да то есть очень важно меня спрашивает от чего великом контужен с рекомендуешь с одно и тоже часто иногда бывает там чтобы это больше 90 процентов нет все таки вот мы рассуждаем о симптомах и дальше все таки тут у должно быть отдельно опять же можно копировать уже вставлять выше решили разделить и пока конкуренты рекомендуется нас вот только вот в сегодняшней этой версии которое мастер есть там там 5 отчетов по моему они заполняются это все еще такое только начинается остальные конку женском удачи нас будут пустые и мы готовим для вас заполнить присылайте на check-up собачка под газ . я вот дальше едем и мы вот эти отчеты они как бы они пони как я уже говорил для всех нот и мы можем быстренько посмотреть все ли там одинаковое допустим да вот здесь мы видим что для вот этих двух нот 1 1 мастер другая реплика все совпадает здорово иногда не совпадает это нехорошо очевидно не хорошо почему потому что если мы если мы неправильно нажимаю если мы переключились у нас случился с вечера или failover там и оказывается других условиях очевидно то нехорошо вот дальше по версии конечно у нас в планах тома сделать очень крутую рекомендацию который будет говорить вы используете джин индексы а вот там они падали срочно обновляйтесь потому что в новой версии пока такого нет но есть уже вот сейчас в мастере как раз уже говорится что какая вас мажорная версия поддерживается ли она сейчас комьюнити и будет ли поддерживаться ближайший год потому что если нет вам стоит обновиться иначе вы можете оказаться в ситуации когда обнаружили бак но его же никто не хочет исправлять потому что все эту версию больше не развивают какая вас минорная версия насколько вы отстаете от самой новой минорной версии и вот этот сайт очень хороший здесь вы можете посмотреть мы там даем к рассылку автоматической вы можете быстро посмотреть список всех изменений которые были между вашей версии и самый новый помогает разобраться стоит ли вам срочно обновляться или можно там месяца два щупать подождать вот здесь мы видим что во первых версий одинаковые это уже хорошо то есть потому что смесь с разными версиями это очень вообще все любые отклонения между мастером и реплика это прям зло во вторых здесь версия она не самая свергнет не криминал то есть это не девять не 96 пять или шесть у которых вообще серьезные проблемы были которые в случае фоловерам могли привести к тому что вы там данные потеряли хотя бы больше чем 969 уже хорошо большие равно но видно что есть отставание некоторых частности вот там печально известная проблема совсем com в том что linux вязаться псинка такая что если но что в некоторых ситуациях на самом деле данные не сохранены и и у нас sing-sing отвечает что все хорошо там была ошибка в общем это исправили вникнуть и не за то что исправили а теперь под газ будет падать в ситуации когда подозрение на какую проблему и тут забавная ситуация у меня есть заказчики которые говорят а может быть нам лучше не обновляться потому что если там какие-то коробки пару страниц памяти это может быть не так нам плохо как если мы про лежим у нас нет автофигуры мы можем пролежать кучу минут и это вообще потерять кучу денег может быть лучше фиг sims коробку такой забавный разговор идет в чем была ну в общем да это конечно хозяин-барин но тем не менее наша задача здесь показать что мы выпускаем дальше мы ну вот тоже самое с расширениями есть список автоматически делиться какие там версию в комп да у нас есть понятие текущей базы бы то есть мы базе базу который коннектимся мы и прощупываем гораздо более подробно она называется вам коран дтп с мы и исследуем специализировано да и вот в частности мы собираем список всех версии расширения которые установлены и которые доступны соответственно здесь мы видим что есть несколько расширения которые отстают по версии довольно легко исправить нужно просто alterac страшно сделать или пересоздать расширения дальше вот это мой любимый отчет один из любимых как раз про те самые разница между мастером и реплика когда нет автоматизированных проверок когда мы все делаем вручную в случаях процент случаев когда есть отличие прижаться к 100 то есть ну просто руками такое каждый раз проверять замучаешься то есть если вы просто сейчас пойдете на свой мастер на свои реплики и сравните конфиге есть хороший от на что там будут отличия здесь конечно клинический случай совсем если посмотрите да тут вот обычной ну то есть я бы мог спросить вас новым микрофоном в конце будем ну то есть здесь и вообще все различается в плане логирования и здесь во-первых разные лог destination то есть в одном случае мы пишем csv файлов другом просто файлы в одном случае мы там используем даже вот здесь под свечу здесь вообще используется директория а здесь в памяти пишем видите дев шуму то есть это совершенно разные подходы клонированию на на мастере аддона реплики другое то что там случится мастер часть частенько имеет большую загруженность случаев и лавера возможно просто репликой вообще не потянет очень легко здесь это может быть ну дальше договор км м и отличаются тоже важно поддерживать все таки близко если у нас репликой очей она должна быть в любой момент готова стать мастером новым это не хорошо если там в моем другой особенно если меньше да даже если больше тоже нехорошо но общем это надо отслеживать вот есть еще один отчет который говорит делали в альтер систем если вы делали alter систем вы здесь увидите дивы есть увидеть of вот поскольку это autoconf это значит что вы руками применили какое-то изменение с помощью alt российским да и как правило это сделали на одном сервере может быть ни на одном но его в случае это значит что ваш перри конфигурация прошла скорее всего руками они через ваш on seba пакет или что вы там используете это тоже не хорошо для он принес инсталляций в общем длинна что в данном случае три настройки были руками под пропатчены хорошо бы их вынести все таки желание чтобы конфиг был в те да и и мы отслеживали когда сделано было что было сделано следующий отчет это вот такую отпуска сориентированы взгляд на файловую систему мы здесь видим что у нас мы здесь вот видим самому не видно ни черта мелко слишком извините файловой системы видим какие у нас особенно вас нас интересуют поджидает а здесь да вот здесь вот под рисовой директории до отдельно 2 табличка мы смотрим на пиджи дельта смотрим на их слух или вал директорию где а где у нас журнал транзакций выяснены это не вынесено это вот здесь от нее не вынесено да видно что mount point одинаковые у них значит они на одном физическом диске но современные рекомендации нет строгого рекомендации выносить как раньше было при rotational disks мы всегда говорили что давайте лучше их слог писать ну журнал транзакций пишет писать на отдельный drive сейчас такой регуляции уже нет но соседи ssd они хорошо и поддерживают реализацию разных обращений или облачный типа типа ebay своём тоже самое ну и смотрим также на остаться там директора директор и лучше всю эту память у нас здесь сделано и смотрим на где у нас логе в данном случае локи тоже в памяти это экзотика это из другого доклада практически но это интересное решение чтобы собрать побольше и логов чтобы все запросы пролонгировать следующая тема она достойна конечно же отдельного доклада и нас на на холодина back and comfy были такие доклады вы можете посмотреть ютюбе а тема исчерпана исчерпаем а есть некоторые признаки что когда-нибудь в плоскости об этом перестану так сильно пристани так сильно болеть после сюда это плод раздувание таблиц и индексов особенно индексов здесь мы начинаем с того что мы смотрим какие у нас настройки и пока что вы должны быть экспертом да чтоб понять быстро что вот здесь настройки они по умолчанию 0 1 этот по умолчанию но мы у нас в планах сделать здесь будет обязательно то есть движемся в сторону того чтобы не экспертом давать более удобное представление то есть его первичность будет расписано что если of the vacuum не настроен но это признак того что скорее всего проблема есть потому что дефолта вы и настройки в плоскости до 11 версии кстати 11 версии какие кое какие настройки сделали агрессивнее в 10 раз в год до 11 версии конечно дефолта вы настройки означают что вам обязательно затюнить если у вас более менее существенно нагрузка если вы это не сделаете будут будет накапливаться blood очень быстро после настроек мы смотрим а первое о чем мы смотрим эта критическая вещь если угроза фразах шнура по раунд есть относительно свежий истории the smell чемпом когда они пролежали там полутора суток один из сервисов бла деградация там один из 1 шард полностью лежал потому что они упёрлись это за шнур up around the раза шин лидера праут и здесь ошибка в названии здесь и эта проблема очень болезненная то есть все что вам нужно знать про это первом приближении что просто регулярно смотреть что у вас здесь 50 процентам точно ничего не приближается все к писательству вас маленькие вот здесь они должны быть маленькие сам не очень вижу тут оттуда обещал не выходить так да здесь у нас каким здесь процент но здесь вообще по нулям это взято но здесь мы обычно видим не больше десяти процентов потому что под газ начинает 10 процентов он уже агрессивно начинает в табаком отрабатывать ее убирать это чуть ускорюсь значит хибла тот же ты был blood мы мы постарались сделать более такие химии френдли вещи то есть мы показали проценты гигабайт и мы сделали жирным когда там больше процентов более высокий вот здесь видно 50 процентов жирно да то есть мы показали когда у нас был последним собакам это все упрощает работу с пониманием где у нас блок конечно же яндекс вот это более критично я вещь потому что вас как правило запроса используют индекс сканер диксон риз can scan и и раздувание индексов приводит к деградации производительности довольно серьезно ну и к тому же яндекс бот это более кати более болезненная штука потому что вот как раз 11 версии питер gigan и улучшал как то есть индексы будут раздуваться меньше чем до 11 версии как мы знаем индексы рано или поздно все равно приходится перед перестраивать и раза раздуть им стоит следить если у вас там 40 процентов это уже немножко напряг 50 это уже такой напряг 90 процентов это значит что вы уже в 10 раз индекс раздут то есть 90 центов блок здесь пациентов полезно нагрузка значит вас факт а вот это умножается на день в 10 раз мы сейчас там добавили фактор еще здесь его не видно то что немножко другой взгляд на вещи когда люди под между 90 процентов и скажем 99 процентов там всего девять процентов разница но это десять раз или в сто раз у нас раздутия да и то в губ в байтах это очень много бетах мы тоже кстати показываем то есть индексы это неизбежность что неизбежная данность что вы должны их периодически maintenance делает то есть перестраивать и плод как раз хорошо покажет вам stable захочешь покажут что именно стоит перестроить важный момент мы там пишем это эстимейт мы не делаем тяжелый анализ мы делаем очень быстрый легкий анализ он иногда ошибается и здесь есть пример который я люблю показывать потому что люди думают что они знают свой блог он может быть супер ошибочно вот здесь мы создаем табличку интер 4 потом integr8 потом это же 2 потом интер живой си те кто знают unter null знают что есть такая штука и лайман трейдинг поединка лаймонд и между интер 4g 84 байта будет ноликами забиты то есть эти из этих ноликов скрипт анализа болото любой который быстрый он будет особо он будет ошибаться очень сильно с индексами та же картина и в итоге мы здесь получаем что таблицу мы только что создали миллион строчек там никакого было то там 0 но скрипта за анализа болото быстрый не на перестать упала на решение основаны которые нельзя использовать продакшене постоянно потому что он будет вам полное сканирование делать а вот именно на основе статистики у вас будет говорить волна сто двадцать три процента болото а вот для такого индекса вообще были 31 процент и вы можете броситься переставить индекс хотя здесь не стоило бы представить вывод выход только один мы кроме вот check up of мы еще наша фишка что мы строим дтп слеп компаниях и позволяем упрощать стоимость экспериментов исследований и так далее и вот одно из одной из простых вещей одна из простых вещей то есть мы особенно классно и какая-то в облаках делается клон делаем вакуум фу подождали иногда сутки и собрали размеры до и после это самый надежный способ узнать какой у вас блог но в качестве быстрой оценки все но конечно же эстимейт и нам нужны они когда как начальная стартовая точка для анализа индекс анализ это довольно большая тема то есть очень часто бывает приходишь и видишь что индексы очень много лишних индексов по на создавали надо это бывает 20-30 процентов всей базы и конечно в этих ситуациях хорошо бы ска сэкономить место и лишь не индексы поубивать личных индексов бывает базовых классов их 2 первое это неиспользуемые а второй это избыточные простейший случай избыточного это два одинаковых абсолютно индекса нам такие нам нужно 1 1 оставить другой прибить и они уст индексы это но не используем индексы в них вот много скриптов но нужно не забывать что вы должны проверить все ноды и плоскости копатель это конечно же не забывает вот оно подобно дом что проверила из специального вводим нолики если мне нолик значит статистики нет то есть вообще там ничего про этот индекс неизвестно не трогай не трогали вообще и соответственно мы видим нолики мы можем смело эти индексы просто замочить единственно что он от не забывать что если статистика была сброшена час назад то на досуге нужно подождать недельку а то и месяц иногда бывает так что индекс используется 1 месяц какой он там дымом флери порта генерит мало ли еще бывает конечно индекс специальный случай когда индекс на вообще особо не нужен но поддерживает внешний ключ у нас для этого есть вот колоночка здесь вот ни один индекс не поддерживает внешний ключ то есть с одного конца внешнего ключа индекс обязательно для поиска сюда с другого конца не обязательно reference исходной да откуда мы ссылаемся и он обычно кабы не нужен но если вы будете как бы эту строчку удалять то там вы получите сексе консульском в полной таблицы то что он должен убедиться что на меня никто не ссылается средства в таких случаях даже если индекс мы не используем мы можем захотеть его оставить потому что вдруг мы там через пару дней решим удалить какую строчку модератор томкович еще делает и мы сознательно какие-то яндекс и оставляем но это вот специализированные случае так почти последняя тема на самом деле я немножко задержался эта тема очень важна эта вообще кого вершина всего анализа и это неисчерпаемый а тема которая иногда даже выводится в отдельную активность это анализ запросов субд должна делать запросы выполнять запросы желали к можно быстрее и сиди совместимое так далее у нас свой взгляд на все это а то есть если во-первых у кого стоит перестать statements пока поднимите руку да ладно ну плоскость была раз чуть не в десять больше рук вы что кажется стоят нос должен стоять у всех для анализа производительности запросов если вы его не ставить и вообще не знаете что у вас там запросами происходит и конечно можно там new relic или что там у вас есть вспомнил чтобы там профилировать со стороны приложение но это совсем другое и только перед состоит нас да даст вам нормальную картину статистике со стороны базы полную картину логе тоже в блоге в нагруженные проекте включать полное логирование это отдельная большая тема как это правильно сделать к сожалению у нас такой взгляд то есть вот притчи состоят нас придется немножко объяснить чем делает мозга сам собирает тайминг собирает сколько boffins была взята из буферного пола это называется хитами да сколько было счета нас кэш операционной системой это называется рид то есть это как бы в буферном пули не оказалось пришлось читать иск операционной системы к сожалению поезд не знает что возможно при этом и в кэш описана система не было это уже за его пределами по умолчанию да возможно это и даже с диском пришлось поднимать для этого чтобы вот эту проблему решить есть еще перестать кей кэш дополняющий перед состоит нас и мы тогда можем увидеть еще и что когда мы сочетаем существом с диска это все постоянно к статистика накапливается overhead небольшой несколько процентов стоит иметь все были менее крупные проекты которые знаю обязательно используют и дальше мы имеем вот эти метрики мы их видим здесь вот вот это у нас есть группы запросов здесь запросам не видно но он там где-то справа какой-нибудь там select insert неважно вот здесь показана две группы да а ну да то есть причина сайт вас выкидывает параметры то есть вот select звездочка фронте был в этом айди равно 10 будет написано иди равно доллар один ? если более старая версия и дальше все это агрегируется и у нас есть мы знаем что вот эта группа запросов она вот настолько медленно и у нас есть главные параметры the total time that all time здесь в колонке видно по нему сортировка и мы знаем что допустим за период наблюдения check-up нужно принять два раза потому что ну нужно снапшоты иначе у нас есть только абсолютно значения мы дельта высчитываем и после этого мы знаем что у нас вот за приют наблюдение 10 минут мы на этот запрос убили 15 минут например такое может быть у нас больше чем одно ядро это вполне себе нормальные ситуации и соответственно тот так группа запросов которые больше всех total time накопила это самое грузии наши ресурсы штука борг лоте давно как обычно нагрузки если мы из оптимизируем мы можем отложить апгрейт это очень круто потому что если иногда видим там 50 процентов и и мы можем реально с ним облегчить себе жизнь в два раза если мы просто сделаем оптимизацию иногда бывает очень тривиально чем и дальше делаем в каждой строчке вы видите здесь 4 под строчки и мы берем эту метрику и мои два раза дифференцируем то есть мы первый раз мы делим на 1 решен на расстоянии по времени между двумя snapshot ами вот как я сказал 10 минут между сотами 15 накопили знаешь будут полторы секунды в секунду вот здесь паузу чтобы это осознать это и люблю эту метрику она нам говорит о том что каждую секунду мы занимались полторы секунды мы чудо делали у нас рассказал бы у нас ни одно ядро средства грубо говоря вот мы здесь видим вот здесь ну там к двум секундам приближается да значит она как минимум два ядра под этой выделить по только под эту группу запросов это очень хорошая вещь чтобы понять вообще чего происходит из чего структуру рабочей нагрузки можно понять 2 во второй способ второй второй метод дифференцирования мы делим на количество запросов этой группе которые бы наблюдали количество запросов она вот в 1 в этой колонке есть здесь всегда будет один потому что конечно запросов поделить на количество запросов это один это чисто для общего но чтобы для единообразия сделано но в других во всех колонках это очень полезно видеть например мы видим что здесь 10 миллисекунд на запрос это наш и в решил этом си принципе современная причесаться и так дают но вот и bridge сколько там хитов сколько рядов и то вы должны сами читать и здесь это все посчитано мы здесь видим что в целом запрос быстрой 10 миллисекунд но на первом месте по total time значит просто столько колос было довольно много в секунд в секунду 170 запросов и довольно такой большой поток идет и он поэтому накапливает много времени и мы можем быстренько посмотреть хиты и ряды вот здесь они есть да и мы видим что в среднем 4 хита на кол и меньше то есть а я здесь вообще не проблема дело него и но быстрый запрос да дело в количестве можно пробовать оптимизировать таки посмотреть там может быть что-то именно сепию bound нагрузка и последняя четвертая под строчка это проценты от всего war клода наблюдаемого то есть вот этот вот эта группа запросов от 20 процентов все нагрузки 1 5 следующая там тоже 19 процентов они примерно похоже если вы мы когда видим больше 30 процентов это значит вот эта группа распухла и на ней нужно поработать и то же самое мы делаем для других метрик мы выведем что вот допустим 1 группа она у нас работа с каша он призвал нас тема 7 процентов от всей работы сказать что он с ковшом при ценностями вот такой взгляд у нас на анализ запросов он довольно мощные хотя пока что он не очень визуально он таблица да мы думаем как это графике мы графиками лучше сделать я готов это обсуждать это очень люблю эту тему то есть аким метр очень классно графики рисует но они не такие то есть такие многогранное все-таки хотя там есть конечно детали вот еще гитлер все рассказал напоследок я вижу время уже поджимает напоследок мы все еще делаем мы суммируем все и даем вот такую штуку для каждой ноты для мастера для реплики и мы видим в итоге что вот у нас на самом деле весь мир клод он занимает он занимает аж девять секунд секунду хотя на этом все и потом 12 ядер я не помню точно то есть эту серую уже тяжело сказать всем этом увидим лоты мираж высокие так далее и напоследок еще один отчет мы берем первое слово в каждом запросе и делаем так так с вами first for sport analysis это сколько select и занимают и мы отдельно электроплитка топота что не луч от отдельных здесь вот делаем вот сколько select и сколько inserto сколько лет те же самые метрики это очень богатый материал чтобы понимать что вообще за за зверь ваше приложение как он работает с вашей базы время вижу совсем подходит концу я не все успел рассказать можем это в кулуарах у нас есть так вот этот и напоследок вещь интер 4 обо всех современных в борках руби java уже integr8 интер 8 по умолчанию сделали но это же 42 . 1 миллиарда у него потолок и проблема в том что таблицы которые интер 4 pro брюки имеют они были созданы несколько назад и только частные подросли и это больно апгрейдить больно можем пообщаться и я знаю несколько методов реализовали это в общем когда вас два миллиарда строчек и уже 96 процентов и это платежная таблица это круто конечно все рекомендации автоматизируете и главное проверяйте здоровье детально регулярно что эта машина что это ваше личное здоровье что это ваша база данных спасибо давай мысли давай в следующий раз тебе два часа дадим чтобы уже так не обрывать на середине вопросы но общее обычном этапы делает хороший хороший де обычная после доклада делала митап но вот трассы и как то у меня не получается сейчас это хорошая идея два часа у человека докладывать час перерыва на обед да да кофе-брейк или как поки почти академический час привет спасибо доклад очень круто полезно ты сказал том что когда вы проверяете главное чтобы версия ползти не отличалась на мастере и но doch ну чтобы была одна минорная версия а сам по сгрыз говорит обновляйтесь сначала на своих а потом на мастере и какие могут быть риски когда вы как раз такое происходит но это хороший вопрос конечно подловили меня здесь во-первых я говорила про про то что мы не хотим подводных камней бывает такой вот какой то баг исследуешь а почему на 1 zapplink только проявляется из только потом о черт они различаются конечно же обновляться правильно вообще-то rolling апдейт или как он там называется это классно но это же подконтрольная вещь да и это на какой то период времени то есть это никак не правило чтобы этом вообще не отличались конечно же репликация совместимы между разными версия никаких проблем там не будет мы можем тестировать на одной из реплик новую минорную версию пару суток не проблема в это время чикаго покажут различия но мы подконтрольно это делаем но просто - такой подход и хотим использовать это правильный подход абсолютно я говорю база заложенные мины они бывают вот эти заложены мины когда у нас да еще по демонстрирует недостаток процедур когда у нас не с помощью anserglob лопиталя еще чего нибудь там час или еще что-нибудь или комик губернатор все это разворачивается к управление конфигурациями да или там патронник управляет у нас просто видно что тут подделали там забыли вот это вот этого наш способ выявить недостатки под и заложены мины но конечно можно жить спасибо пожалуйста 1 раз я есть этот доклад скажите я правильно понял что этот отчёт надо на своей базе сделать отнести к вам еще и денег заплатить мне часто пока бесплатно это раз второе мы автоматизируем observations то рекомендации нас мы монетизируем ся на том что мы рассказываем подробнее помогаем пофиксить потому что мы на мне интересно на стартапах на самом деле оптимизироваться как я вчера рынок российский это не наши нак то есть мы полностью не кирова на ios интерпайп все поэтому сейчас вы можете писать мы будем бесплатно вам делать ближайшем будущем вот сейчас новая версия уже пять отчетов они будут автоматизированы и выводы и рекомендации генерить это сложная вещь на иногда бывает спорные моменты разные подходы людей мы мы стараемся разные подходы там ссылаемся на разные статьи смотрите какие бывают но также вы можете просто использовать observations хотя бы до и уже пытаться раскопать что что вообще идея куда смотреть это уже полдела потому что обычно люди не знают куда смотрите у меня все плохо хочу делать да мы за годы там тренировок накопили какое-то знание показываем куда смотреть то есть получается это можно как-то прогонять у тебя допустим ни детей у меня там где-то в облаке выпуск нас есть это прогоняю и он мне говорит этот отчет оао тут проблему ну да то есть если вы возьмете скрипты которые были разработаны они уже будут там что-то показывать но они очень так технически наш observations мы стараемся там чуть более him in a friendly сделать вывод и рекомендации которые следуют уже скоро и для опять 5 отчётов они уже есть в мастере пока они будут вам может евро за чего надо делать наша задача чтобы людям было объяснить показать там даже ссылки на статьи на какие-то хорошие там тоже чуть не видео там как идет рассказывать не надо делать то есть документация точно не хватает для многих вопросов конечно и вот мы их раз дополняем это все а если это все будет делать делаться автоматически тогда не на чем будете вы зарабатываете я же уже сказал на ветерана и is marked enterprise они платят и даже если open source им важно поддержкой чтобы кто-то закрывал вопрос понятным и я начну вообще не переживая у нас закончилось время спасибо осиба если есть еще какие то вопросы то или не появится вопрос замечание предложения то можно в дискуссионной зоне а ты выбери пожалуйста лучший вопрос последний вопрос отлично"
}