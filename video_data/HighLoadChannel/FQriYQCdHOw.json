{
  "video_id": "FQriYQCdHOw",
  "channel": "HighLoadChannel",
  "title": "Хранение и доставка контента / Олег Илларионов (ВКонтакте)",
  "views": 1150,
  "duration": 3260,
  "published": "2017-04-25T08:02:58-07:00",
  "text": "люком далеком 2007 году разработчики компании во главе с олегом буниным в далеком санкт-петербурге консультировали братьев буровых как он покорить галактику с тех пор утекло много воды и разработчики вконтакте стали частыми гостями на наших конференциях теперь уже они рассказывают вам как покорять галактики и так на сцене олег илларионов разработчик вконтакте конечно он там не один их там еще двое встречайте олег илларионов пару лет назад на похожий конференции тоже на холоде приезжал павел дуров его спросили как вы храните файлы он ответил что на дисках и начать презентацию мне хотелось бы с того что до сих пор это решение является лучшим сегодня буду рассказывать о том как мы храним файлы как мы их доставляем пользователям в таких объемах какие у нас есть но начать хочется самого начала с того как это происходит когда создается какой-то стартап какой-то сайт все начинается как правило аватарок сначала нужно хранить аватарки и как-то отдавать пользователям сервер 1 как правило все очень просто и как правило код пишется просто вконтакте изначально было примерно так я еще не был тогда в составе команды но я видел в куски кода которые не использовались но явно отвечали за этот функционал то есть один сервер и файлы хранятся прямо тут же прям на диске вот пользователь его загружает сюда же то есть даже не какие-нибудь там поддомена еще что-то а вот прямо слэш какой-нибудь оплот печки туда отправляется файл он сохраняется и дается потом пользователям прямо оттуда через яндекс какие есть плюсы и минусы у этого подхода плюс очевиден это самый простой самый быстрый подход и если вы хотите сделать как стартап что-то доказать то наверное стоит начать с чего-то такого не стоит сразу усложнять сразу делать сложные системы сидена и так далее лучше все идет просто но есть минусы которые являются очень серьезными даже для самых ранних стать сайтов самых ранних продуктов это безопасности такой подход является довольно опасным и очень многие опираются на то что не предусматривают тот факт что можно загрузить какой-нибудь скрипт они фотографию что-нибудь нехорошее и потом это исполнить поэтому если вы используете этот подход то стоит проверить все ли чисто точно или нельзя загрузить не фотография что-нибудь еще может быть флешку вместо фотографии потому что флешку потом можно загрузить и выполнить в ней скрип получится xss либо еще что то можно загрузить либо какой нибудь скрипт который на сервере вы помните то есть в любом случае это довольно опасный подход и стоит очень аккуратна с ним работать еще один очевидный минус это масштабирование при таком подходе нет никакой возможности масштабироваться горизонтально вы можете только увеличивать мощность сервера добавлять диски расширять каналы и так далее еще один момент это то что как можно быстро решить эти недостатки от касательно безопасности стоит сразу отдельный домен отвести чтобы хотя бы клиентские атаки избежать то есть xss и так далее если вы грузите статику с отдельного домена то есть не с вашего какой другой домен там какой остаться что-нибудь точка ру например и оттуда грузите контент те же самые аватарки то все гораздо безопаснее гораздо лучше и как минимум никакой access к него войдет еще что то но впоследствии нужно двигаться появляется несколько серверов и появляется необходимость что-то менять и следующий такой этап через который проходят все сайты вконтакте не стал исключением это когда много серверов но сохранить по-прежнему на текущий то есть подход примерно такой же как был просто два сервера например и все то же самое можно масштабировать все изменилось как при переходе на этот проект нужно вносить некоторые изменения например нужно начинать хранить тот сервер на котором лежит текущий файл самом компактном виде это просто номер в менее компактном это какая-то конечная ссылка хотя лучше наверное номер это универсальны и потом по этому номеру пользователи уже даются конкретные ссылки но у этого подхода остается ряд минусов несмотря на то что можно масштабировать нет возможности работать со свободным местом то есть нет возможности распределять нагрузку так чтобы место не кончилось с не было такого что на одном сервере кончилось место на втором его полно а это бывает очень часто потому что второй сервер появляется не сразу а в какой то момент когда у первого уже наполовину диск забит поэтому приходит третий подход это когда много серверов но мы выбираем на какой мы сохраним это этот подход он гораздо сложнее с клиентской стороны потому что мы не можем просто взять и сохранить файл нам нужно сохранить его на определенный сервер в некоторых случаях это вызывает всякие кросс доменной проблемы например в случае с в давние времена это был flash и в давлении в давние времена на flash с этим были проблемы сейчас никаких проблем нет к 1 до main.xml и все такое еще один момент это html если мы сохраняем систем или но при этом данные генерируем на клиенте что тоже часто бывает то есть современный html5 проекта могут вырезать уменьшать фотографию ту же аватарку на клиенте и при этом тоже будут курс домены и проблемы которых нету только в самых последних самых модных браузеров в чуть устаревших нет возможности загрузить на какой-то случайный сервер но появляется возможность повысить безопасность потому что вы можете сервера для хранения фотографий вывести отдельно и не хранить на них скрипты то есть изолировать эту среду и таким образом вы в разы повысить и безопасность проекта потому что будет даже если злоумышленники смогут как-то проникнуть найдут какой-то exploit в совке который обрабатывает эти файлы загружают так далее они не смогут выйти наружу потому что сервер изолирован он позволяет только загружать на него файлы отдавать клиенту не обязательно это физический сервер например можно на одном физическом сервере чтобы поделить ресурсы делать и храни но главное разбить их есть много способов но я не буду углубляться в этого подхода есть серьезный очень серьезный минус точнее минусом момент который нужно предусмотреть это как решать на какой файл загрузить то есть вот у нас точнее на как у серго вот нас несколько серверов и мы думаем как вот выбрать и самый такой простой вариант это мы берем просто и на последние добавленные сервер загружаем тут у нас закончился сервов и мы взяли его отмели и ну закончилось место и теперь все загружаем на следующий потом на нем закончилась а на следующую плавно так и добавляем очень хорошо подходит для проектов которые растут у которых редко происходит такой момент потому что они имеют возможность не тратить сразу много ресурсов на большое количество серверов а добавляйте по одному тот мужик мужик тратить средства по мере необходимости но вот надо заметить что у нас несмотря на то что это было совсем недавно таким образом были посту был построен сервис документов мы просто когда его делали немножко мы не думали что будет такая большая нагрузка не планировали его сделать таким массовым и на самом деле первое время первого сервера одного хватило достаточно надолго на несколько недель но потом каждый раз добавлять новый сервер это было рутинно нужно было каждый раз системным администратором напоминать и так далее поэтому этот подход он довольно неудобный с точки зрения того что нужно об этом заботиться довольно часто особенно когда серверов много и довольно часто нужно менять поэтому другой подход который приходит на ум это загружать на совершенно случайный свободный сервер который точнее не на случайно она самый свободный сервер у нас есть сервера и мы берем какой из них на котором больше всего свободно месту да и загружаем тогда у нас точно все будет плавно распределяться точно не будет такого что какие-то сервера забиты какие то нет все все будет более менее гармонично но есть большой большой минус это трафик клиенту потому что представьте мы добавили новый сервер он самый пустой туда пошли все самые последние данные которые естественно гораздо популярнее чем старые этот сервер загнулся это не очень хорошо поэтому самый правильный подход который мы используем это загружать на случай на сервер среди тех на которые стоит загружать которых на которых не кончилось место и может быть секций вопросов кто-то предложит более простой или более удобный вариант или более лучше в чем-то но пока мы используем именно это следующий момент это то как можно работать с производительностью как можно ускорять что то и вообще какие есть подходы способы так далее самое главное это понимать что как правило есть какие-то бутончики что не просто слишком большая нагрузка поэтому поэтому стать к дается медленного а есть какое-то одно место где слишком большая нагрузка все остальное в целом как правило работает гораздо быстрее все окей и причины могут быть разные в зависимости как правило от типа контента и нужно понимать какие нужно мониторить и смотреть что то есть может быть диск в этом случае можно поставить трэйд еще что то это может быть сеть причем проблемы сети могут быть как внутри дата центра то есть вот у нас например сервис видео очень долго страдал именно из проблем внутри дата-центра который было очень сложно решить связи со всякими более но связи с невозможностью организовать трафик еще более надежно трафик был очень большой потому что видео очень много и его очень много смотрели сейчас ситуация гораздо лучше чуть позже расскажу как мы решили эту проблему еще один момент это кэширование когда вы коллируете каширование можно сделать на совершенно разных уровнях и 1 чем над подумает на каширование клиенте потому что если речь идет про те же аватарки с которых мы начали ну или фотографии так далее то кашированные клиенте невероятно важно потому что на самом деле когда люди смотрят на пример свои профили свои фотографии они больше шестидесяти процентов контента достают из кэша то есть это очень серьёзная часть нагрузки которую просто вот правильным и заголовками просто продлив срок кэша там неделю на 2 можно избежать кучи проблем и еще один момент сжатия вообще практически все сервера подержу твой по дефолту даже стоит позаботиться о том чтобы она была включена и так далее несколько более поздний момент и то к чему приходит чуть позже это такие проблемы как трафик снаружи то есть когда внутри дата-центра когда удается решитесь проблема то есть ставится совсем мощный маршрутизаторы еще что-то трафик снаружи как-то пропихнуть с большей производительностью не представляется возможным это вещи на которой мы не влияем в какой-то степени поэтому приходится делать такие вещи вот примерно год назад мы начали внедрение системы content developer network которая позволила нашему видео гораздо менее что тормозить чем раньше то есть у нас просто я могу объяснить почему с видео такие большие проблемы мы загружаем его в хорошем достаточно качестве сравнительные при этом не ограничиваем по длительности поэтому естественно трафика очень много и учитывая то что этот сервис абсолютно не монетизируется с ним проблемы то есть это то что нам хочется делать они не то что мы делаем ради каких-то финансовых показателей и так далее поэтому с видео эта проблема особенно актуальна и учитывая то что видеозаписи они очень трафик каемки для них мы первыми стали внедрять сидел и такой типичный кейс это когда видео файл находится в санкт-петербурге а запрашивают воткнуты из москвы москва большая санкт-петербург поменьше соответственно трафик в таком количестве из санкт-петербурга в москву не всегда подходит достаточно хорошо более того очень часто этот трафик идет не так как мы себе представляем не так как должен идти а через какую скандинавию там потом через европу потом еще куда-то и только потом москву поэтому разумный такой подход это поставить в москве сервера собственно что уже реализовано и достаточно много в москве сейчас стоит серверов которые начали мы с того что мы просто начали размещать видео в москве на это неэффективно и потом мы шли к тому что ставится сервера которые при загрузке видео файла у них его нет но пользователя мы отправляем на этот сервер который смотрит что файла нет он не за кашира ван обращается уже к оригиналу к серверу в петербурге и загружает оттуда уже справили настроенной маршрутизации все окей и там уже кэширует то есть пользователю отдается этот файл потоком первый раз а все последующие разы этот файл отдается из кэша для того чтобы решить какие файлы стоят кэшировать какие нет вместе с файлом отправляет свою популярность это некий индикатор просмотров которые мы считаем он позволяет определить какие видео актуальны какие нету к только каких много просмотров и за счет этого мы можем показывать мы можем кэшировать только популярные видео потому что кэшировать все что попало не будет настолько эффективно еще один момент который стоит учесть это и себе совсем недавно мы внедрили но сейчас такой момент в истории развития интернета когда я тебе стал более чем актуален совсем недавно это было нужно только всяким банковским системам еще к чему-то но сейчас открыты и вай-фай точки без пароля типа той что здесь они набрали очень серьезную популярность действительно везде и очень много трафика с них идет этот трафик ничем не защищен любой может в поясничать смотреть что там поэтому из тебе стал актуален и вот недавно мы его внедрили в настройках уже есть галочка и сейчас можно если не хочется поставить галочку просто обратиться через gps все будет гораздо безопаснее но если мы будем загружать из степи странице страницу которая не найти тпс то у нас возникнут трудности у нас сменится сверху значок и пользователь будет поймет что что-то не так в сессии недостаточно secu на потому что загружается контент не через эти теперь кажется мы могли бы поставить пусть сертификату и настройтесь на всех серверах где хранится контентную слишком много просто такое количество сертификатов будет стоить довольно дорого и это небезопасно могут украсить какой-нибудь один сертификат и потом наделать много пакостей поэтому нужно проектировать это неизбежный вариант и сейчас мы именно так и делаем около 10 серверов прокси руют все для и steppes пользователей и самое что интересное что я у себя обнаружил в своем конкретном случае когда из офиса сижу в сети ты-то что статика быстрее стало грузится как ни странно это связано с тем что нужно гораздо к меньшему количеству серверов держать коннекта фотографий очень много они все с с разных абсолютно серверов и каждый раз когда снова сервера фотография к ним нужно падка ноктиса в условиях того интернета который у нас в офисе все очень быстро и самое медленное что может быть это connect потому что трафик идет с бешеной скоростью фотографий грузится очень быстро и в моем случае почти без сайт работают быстрее подозреваю что так же быстро он должен быстрее должен работать на мобильных платформах точнее с мобильным интернетом за счет того что connect и там тоже отживают значительную часть времени другой степени например на андроиде самочки петь подтормаживает насколько я слышал от нашего разработчика поэтому там может быть будет чуть дольше именно до кодирование там всяких и джейки и так далее вот ещё хотел сказать о таком подходе как какие-то магические штуки которые позволяют в некоторой степени что-то решить это как нетрадиционная медицина но иногда работает например пир toupper вот в нашем случае у нас примерно год в видеозаписи видео плеер поддерживал пил toupper и отдавал контент между пользователями сейчас мы это отключили потому что удалось с другими способами решить проблему видеозаписи а этот подход он создавал небольшую задержку при начале проигрывание файла и сейчас просто для нас это задержка это лишнее когда у нас так видео работает более менее нормально а в тот момент были страшные времена под вечер сеть в дата-центре превращалась во что то очень ужасное и видео тормозило нас не было возможности как-то решить эту проблему потому что там и так все было очень тесно поэтому мы стали мы узнали о том что на слушаю возможно передавать от клиента к клиенту файлы и разрезаю на куски и передавая кусочки и 100 лет использовать это работало довольно большая часть трафика чуть меньше десяти процентов шла через пир toupper а еще хочется рассмотреть собственно обзор всех видов контента это тут больше статистики больше всяких интересных фактов ну и может быть каких то советов например фотографии это самый такой масштабный наш сервис вконтакте очень много фотографий то есть это больше чем на фликере то есть это это очень много и при этом скорость их загрузки тоже колоссальной 17 миллионов в сутки это очень много при этом когда масштаб доходит таких вещей приходится задумываться о довольно редких таких моментов как сама сжатие фотографии насколько она быстро потому что в небольших проектах в это принципе неважно потому что ну пользуется загружая фотографию не ожидает там не считает доли секунды ему в принципе все равно 10 миллисекунд прошло и листов в нашем случае миллисекунды считает не пользователь система охлаждения вот этой центре поэтому один из неплохих способов ускорить этот момент это переход на graphics magic вот этот подход он ускорил примерно на 30 процентов сжатия фотографий при этом позволил нам эти 30 процентов если быть честным потратить на что-то более приятное типа шарпа и так далее то есть небольшой обработка фотографий за пользователя чтобы они уплыли посимпатичнее ещё один момент про фотографии который хотел бы хотелось бы упомянуть это то что в наше время очень советую сразу сохранять много размеров как минимум все размеры которые вы используете стоит дублировать в два раза большими потому что потому что например недавно мы озаботились такой проблемой это то как хорошо сайт выглядит на третьем айпаде на макбуке и эта проблема не так просто решить когда нету фотографии нужного размера и у нас если честно до недавнего времени вообще все старые например аватарки на рите не выглядеть не очень хорошо они всего лишь 200 пикселей в ширину и мы вот буквально на той неделе только начали сохранять их в размере 400 пикселей чтобы показывать налить и не четкие сочные аватарки еще один то есть если проект только начинается я советую пару строчек добавить чтобы всегда было 2 x размер особенно на если есть какой-то пить для мобильных платформ еще один момент который очень важен и мы его видели на графиках это сжатие на клиенте кажется что это полная фигня если говорить про фотографии но к разницу там пользу передаст 5 мегабайт или 10 но нужно же фотографии хранить более-менее хорошем качестве они так как бы загружаются в таком вот там 5-10 мегабайты вроде как мегапикселя точнее и вроде как не так уж и важно на самом деле важны и когда мы стали сжимать их на flash о перед загрузкой количество загруженных фотографий подскочил очень серьезно это важно потому что пользователи которые сидят через мобильную сеть они очень чувствуют время загрузки они чувствуют что у них одна фотография загружается в течение 5 минут у них отпадает желание загружать остальные это неприятно поэтому если мы сожмём до 5 мегапикселей размер файла уменьшится где-то в четверо и гораздо приятнее будет загружать ну и таки еще небольшой момент это импорт geo geo тегов сохранение размеров и так далее это мы все делаем и очень плохо что не стали делать изначально потому что у нас потерялась большая часть информация есть было бы здорово если бы мы сделали это сама начала тогда мы могли бы сразу по всем фотографиям уметь гигантскую базу данных саути записями все гораздо проще их во первых загружается не такое большое количество дело в том что благодаря тому что на сайте можно копировать добавлять к себе никому не нужно ничего загружать потом если конечно контент не уникальный слева ющенко не сгрузил и надо сказать что это тоже такая магическая кнопка которая позволяет честно снизить нагрузку потому что от правообладателя не понимаю зачем нам это нужно причем каждый пользователь не загрузить себе сам файла по сети и надо сказать что мы никак их не ужимаем не ухудшаем качество считаю что для каждой для каждого типа аудио записи существует пример свой какой-то битрейт с которым лучше всего их ее слушать и пользователь лучше знают в каком битрейте они загрузят а мы если будем какую-то планку делать то мы наверняка поскупимся сделанную маленькой и музыку будет слушать неприятно так у нас куча музыки в 320 км но стоит сохранять теги и стоит привязывать ссылку какие-то очень просто сделать там например на и джинсы в конфиге какой не фишек для того чтобы просто не было всяких сливов всяких сервисов которые просто используют продукт просто делаю другую обложку и представ предлагают уже контент с видеозаписями самая интересная ситуация дело в том что видеозаписи в отличие от фотографий так просто не обработать я имею ввиду что мы не можем просто взять получить от от пользователя видеозапись обработать ее там за 100 миллисекунд и сказать ему все окей потому что видеозапись обрабатывать долго и мы не можем держать общий запрос столько времени тем более что иногда видеозаписи обрабатывать все загруженные в текущий момент в час пик дольше чем их вообще будет больше чем есть серверов и в времени на сервер я имею ввиду что нужна какая-то очередь нужно откладывать это и чтобы кто-то там ждал час пока его видеозапись обработается пока дойдет очередь и так далее поэтому реализация гораздо сложнее как мы делаем пользователь загружает видеозапись мы ее кладем на диск и ставим в очередь задачу при этом мы говорим пользователю что вот в течение какого-то времени видеозапись будет обработано пока можно подождать при этом задача выполняется поэтапно то есть мы не просто взяли обработали и все у нас есть много форматов много видов качество много разрешений которые мы сохраняем естественно потому что у всех разный интернет разные девайсы разные форматы могут проигрывать разные девайсы и поэтому мы сохраним их по очереди сначала самые популярные и самые маленькие по размеру чтобы максимально быстро их уже отдать пользователи он уже обрадовался да у меня загрузилась а потом постепенно все большего и большего качества потому что когда большая очередь гораздо приятнее побыстрее пользователю отдать какую-то меня не терку в плохом качестве уже потом когда очереди более-менее рассосется можно обработать уже и 720p сжать опять же тоже нужно динамическая привязка к api и вот здесь хотелось бы обратить внимание на статистику соотношение загружаемых видео запись и копируем несмотря на то что загрузка видео записи это не очень сложная такая вещь то есть кнопка она не спрятано никуда она куда ближе чем в разделе аудиозаписей тем менее как вы видите всего лишь то есть больше чем в 10 раз даже в двадцать раз больше видеозаписи просто добавляется к себе чем копируется ну чем загружается на сервер и также хочется пометить что у нас есть такая такой момент которую возможно нет никаких других крупных видеохостингов это то что большие видеозаписью у нас занимает существенный процент то есть восемь процент видеозапись длятся дольше 20 минут это говорит о том что восемь процентов видеозаписей весит довольно много и забивают сеть очень неплохо особенно в часы пик ну и самый быстрый такой простой момент это обработка документов у нас был такой непростой непростые решения насчет того что мы подержим что не поддерживаем потому что сначала мы сделали белый список для того чтобы не загружали ничего кроме того что мы разрешаем для того чтобы не дай бог какой-то неизвестный формат не загрузили было очень много жалоб мы очень долго пополняли пополняли пополняли белый список пока не поняли что вполне чего можно бесконечно поэтому сделали чёрный список того что нельзя загружать и в целом немножко ущемили безопасности зато могу сказать что все равно спамеры считают гораздо более рентабельным использовать текст на фотографиях чем что-то в документы загружать ну и момент приятная то генерация превью вот сейчас вроде как об очень интересный момент жалко мало времени осталось это то как хранить файлы речь идет о том понятно что их надо хранить на дисках как я говорил вначале но как как их на диске размещать и большинство делает это прямо вот в отдельные файлы кладет и использует файловую систему это не лучший подход и сейчас для многих типов пожалуй почти для всего корана видеозаписи и мы от этого отказались почему потому что когда мы загружаем файл пытаемся получить файл пользу пытаясь получить контент прямо с файла на диске это не очень быстро потому что файловая система делает кучу вообще вещей для этого она там бежит по дерева каталогов там всякие индексы это не очень быстро работает поэтому мы все слегка переделано мы храним все файлы на сервере все новые файлы старая мы еще не успели импортер точнее значительную часть старых файлов мы уже импортировали но есть еще не импортированные храни все в одном файле один большой файл на самом деле не один а два или три в зависимости от количества дисков на сервере но на диск по файлу на по одному большом куда складываются все отдельные доступ к этому файлу очень быстрый потому что он уже открыт на чтение не нужно его открывать на каждый запрос пользователя он уже открыт все самое сложное это прочитать с определенного отступ а само тело который нужно отдать пользователю и для того чтобы это тоже было быстро мы просто храним в оперативке яндекс по файла это очень быстрый подход потому что у нас не так много файлов я думаю что ни у кого не так много файлов чтобы не поместился индекса в оперативку оперативка достаточно большая диск еще больше но заголовок соотношение заголовка к самому файлу она очень большое нет совершенно никаких проблем этот подход принес нам очень перспективные возможности того как мы можем развивать это направление и уже развиваем вот прямо сейчас это абстрагирование от физических серверов этот этап на стадии внедрения но уж реализован можно так сказать просто не запущен то есть мы храним у каждого файла не только физический сервер где он лежит а некий виртуальный виртуальный том по которому мы всегда сможем получить сервер это нужно для того чтобы потом файлы не были привязаны как с текущим сервером чтобы их можно было гонять туда-сюда как огромную кашу переносить и движок который позволяет хранить и отдавать файлов из одного большого файла он поддерживает передачу файлов с одного сервера на другой просто внутри дата-центр сервер соединяется с другим сервером и получает файл довольно просто в итоге таким образом удалось город очень сильно ускорить загрузку фотографий получение их клиентами а сейчас это очень важно эта мелочь это милость что каждая копия файла советуем уже большим проектом которых здесь как вижу очень много сохранять у каждого каждой тумбы у каждого размера фотографии разные размеры что у каждого размера свой номер сервера это довольно важное помогает потому что когда все это перри переносится когда на какие-то забиты до смерти старых сервера хочется сохранить фотографии но какого-то размера очень полезно иметь возможность вот эти маленькие тумбы новые какой-то нестандартный размер кадра раньше нужны были поместить куда на другой сервер где есть место и чтобы все работало система не нуждалась опыта модификации вот ну и времени осталось только на вопросы которые я был бы рад услышать здравствуйте хочу поблагодарить вас за доклад меня зовут станислав у меня есть ряд вопросов к вам если вы позволите он быть ни один не проблема так первый вопрос это про загрузку случались ну и случайный сервер какой механизм вы используете для определения этого случайного серго то есть это обычный up stream engine силе так как это сложная система вот я на самом деле должен был про это рассказать просто совсем мало времени готовился потому что приехал только вчера есть список серверов на которым можно загружать его формируют админы изначально не просто поставили стоп вот этот список но при загрузке перед тем как начать загружать файл мы обращаемся к этому серверу просто к запросам на клиенте и узнаем что вообще спрашивай у него как у него дела и он отвечает хлопали дела или нет если дела плохо мы помещаем этот сервер что у него плохо дела и загружаем на другой выбираем другой сервер загружаем другой когда таких ответов становится много много пользователей сообщают нам что у какого-то конкретного сервера плохо дела мы уже ну эта задача предается сисадмином они смотрят что за дела и удаляют из этого списка этот сервер вот такая система спасибо второй вопрос вы не упомянули про резервирование или мне так показалось то есть вы файлы как-то резервируйте ли они на одном сервере хранятся то есть один какой-то файл пользоваться конечно один файл который 15 тыс на этом сервере нету других файлов либо они есть но этот файл он то есть естественно место резервируются и не может быть такого что этот файл losing готова какова там от максимума и все более того если сервер чистый там с ним ничего не происходило как правило это так то нет никакой фрагмент фрагментации абсолютно всегда есть возможность то есть всегда файл лежит чисто на диске без каких-то копия насчет копии мы используем очень простой вообще изначально практически собственно вообще самого первого сервера насколько я знаю очень простой способ это на два диска на сервере класть каждый файл каждый файлами и копию на втором диске и в условиях когда нету торнадо нету пожаров еще чего то это хорошо работает они торнадо не пожаров все еще не было у вас сервер целиком никогда не умирал нужд иначе целиком до сервер легко может умереть но диск из него можно достать и поставить в другой на того вместе с дисками но диск может умереть это легко но так чтобы два диска умерли одновременно такое было но было один или два раза скажите пожалуйста вы рассказывали о хранение файлов в одном файле а о каких размерах вы говорили при этом он не интересуют размеры диска и собственно размеры вот этих файлов то есть ну и соответственно время доступа когда вы движетесь по файлу в микросекундах миллисекундах то есть вы сказали что это очень удобно что файл все время открыт собственно мне кажется не очень много времени должно экономится на просто на открытии файла как бы самое большое время действительно тратится на то чтобы продвинуться по этому файлу но я точность цифра не смогу назвать разве что может быть могу уточнить и позже вам сообщить но это гораздо быстрее чем с новым файлом потому что у нас есть отступ сразу то есть мы по индексу из оперативной памяти достали отступ то есть мы знаем конкретно сколько надо промотать чтобы открыть этот файл это наиболее быстрый способ в то время как с обычной файловой системой точнее используя самую файловую систему как хранилище мы этот отступ узнаем не сразу нам нужно сначала много чего прочитать попрыгать по диску чтобы наконец-то узнать сколько нам надо отмотать какую файловую систему вы используйте xfs спасибо и еще тут несколько вопросов про аудиофайлы видеофайла вы сказали что дубликата вы не храните а насчет фотографий стоп уму всего естественном фотографии хранятся дубликаты нет нет я имею ввиду полное копирование файла то есть аудио и видеозаписи вы полностью не копируйте когда она у польский например ставит его себе еду или загружает такое же файл имеется ли какая-то проверка на то что файл уже есть на сервере вас хранить не надо ну что файл уже есть на сервере то есть каждый новый файл он загружается каким-то новым имеем в какое-то новое место поэтому не может быть ну почему видео может дублироваться один пользователь увидел видео загрузил его к себе и другой пользы где то увидел то же самое видео тоже файлы тоже загрузила они ведут одинаковые да и будет два одинаковых загруженных файлов все там может быть проблема но это не то на чем нужно концентрироваться потому что случае довольно редкий и в общей массе он просто растворяется спасибо еще скажите как вы обрабатываете видеозаписью что вы используете ffmpeg там монкада . ffm бег и несколько этапов как я сказал то есть не просто взяли и сразу все на generly а взяли на генерирую часть потом еще часть нет какой механизм вы используете на принтер да да то есть причем довольно просто то есть прямо вот команда of ampeg удается и все то есть у вас память из какой-то демон который следит за приходящими flame очередь читается эта очередь и обрабатывается файлы по порядку то есть это демон нокаут языке она спасибо а как вы еще генерируете привели фотографии что штаб превью как вы генерируете превью точно также но без очереди здесь вот как раз фотография это та вещь которую можно обрабатывать практически в реал тайме то есть пользователь послал запрос мы обработали и после этого отдали ему ответ потому что это миллисекунды там сто-двести пользователь подождет то есть в используем джинс для генерации привели при генерируете превью потом сохраняете на диск нет мы при загрузке всегда генерируем превью если нам нужно кита новые размеры то это всегда большая проблема поэтому я советовал сразу сохранять 2x и так далее потому что приходится просить систем конденсаторов пересохранить а вы видели какое число фотографии всего и системный администратор и делают это месяцами но нельзя на привет пользователь джинкс и там какой intimate resizer и он будет автоматически гель эротики превью и сохранять их куда-то откуда потом можно будет просто перенести на диск и сохранить в постоянное хранилище это можно но тогда будет гораздо сложнее работать решать где какой файл лежит лежит и так далее система слегка усложнится но я согласен что этот подход он заслуживает внимание и возможно кто-то другой расскажет про именно этот подход который был применим ладно спасибо подскажите пожалуйста изображение наиболее горячие картинки вы пишете каким-то образом что что изображение как она картинки загружаем и пользователям иногда бывает там десятки тысяч просмотров в час и конкретно вот самый горячий контент каширы тиски дом или еще чем то это такая большая проблема то есть мы сталкивались пару раз с этим это аватарка павла в горячие моменты и раскрыл большой секрет аватарка павла лежит на всех серверах со статикой вот и когда вы загружаете профиль по ул а та фотография грузиться с того же сервер с которого генерала самосад страницу зависит от того же с которого статика получалось вот там всякие и конкурсе аватарка павла это можно считать логотип или как тегин стиле вот так же я удар к павлу еще был была пара случаев про со всякими звездами фотографии которых в блоге писал постились это довольно давно было но когда-то вот мы такой эксперимент делали там приглашали звезд и каждый новый пост мной видениях он сопровождался в фотографиями каких-то звездам это примерами и так далее и вот тогда тоже были такие проблемы то есть в момент появления на блога все слегка-слегка уложилась и решение было примерно тоже самое как только мы вспоминали про эту проблему мы быстренько сохраняли эти фотографии взяты из это единичный случай и мы же говорим пир социальную сеть они про какой-нибудь youtube и так далее где все одно и то же смотрят здесь каждый смотрит собственный контент олег здравствуй эти пожалуйста у вас весь статически контент контент храниться без авторизации то есть здесь напрямую да знаю прямой ссылке можно придать получить работа и но прямые ссылки никто не знают особенно если вы используете чести без а вы как-то сход рынке намбу вход клин кингом боретесь то есть размещение своего контента на чужих ресурсов и дополнительно нагрузки за что ваши фотки там расходятся потом тысячам сайтов не сталкивались таким то есть я знаю что у нас некоторые используют как фотохостинг на довольно редкий очень случае потому что это делают люди которые что-то понимают знают как ссылочку вытащить и так далее и вообще знает что так можно взять из сохранить еще насколько я слышал как бы файлы которые возникают конфликты правообладатель вы удалите покажу как бы изменение одного байта уже мешает этот механизм не маленький подробнее рассказать про это ну смотрите сначала все было так то есть мы дергаем получали хэш и действительно были проблемы потому что на марсе была довольно сложно какие-то слепки делают не хотелось тратить на это время разработчиков у нас немного поэтому md5 и все и по этому числу мы находили копии удаляли сейчас аудиозаписей чуть сложнее и точно не могу сказать доступен функционал сейчас провод бластер но в любом случае будет скоро доступен потому что недавно эта тема была работа и у нас уже есть слепки и аудио файлов то есть возможность удалять и похожее с некоторой степенью схожести с видео это будет чуть позже но сначала надо провести эту реформу удачно со аудиофайлы выбором больших дуг сохранить то есть каждый файл уже их ешь его тупо соответствия нет соответствия то есть я не очень хорошо знаю как это происходит но вот ребята которые носил нас пишут они написали алгоритм который анализирует файл скорее всего темп какой-нибудь сравнивает либо ещё что-нибудь большое спасибо а скажите пожалуйста каким образом вы настраиваете маршрутизацию между дата центра для того чтобы пакеты не ходили через скандинавию найти механизм использовать я боюсь сказать что-то неверно скорее всего маршрутизация прямая во всех случаях за исключением может быть московского дата-центра где старый всякие видеозапись лежат приветствуя а можно вопрос подскажите пожалуйста вы говорили что вы храните си индексов памяти но собственно касательно фотографии сбрасывайте вылили индексу на диске соответственно если удаляйте фотографии как ощущать осуществляете навигацию по файлу и сталкивались с проблемами битых файлов там не до песчаных и так далее и как с этим боретесь смотрите естественно на диск мы сохраняем белок потому что после когда серого при загружается нужно как-то восстановить этот индекс и в этот момент считывается белок и данного против ки восстанавливаются с последними загруженными файлами на которые могут быть битый или еще что-то может быть похожая ситуация за исключением того случая когда файл загрузился битым но при этом адекватным то есть его размер совпадает в начале с количеством символ байт продолжение и вы в этих случаях он таким битым останется потому что мы никак не можем понять бетон или нет не будем же мы проверять его каким кодеком я имел ввиду сам конечный файл вот этот вот ваш большой файл сталкивались ли вы с теми проблемы что он оказывался битой там случае допустим активной записи падения сервера и так далее нет то есть за счет того что есть белок насколько понимаю эта ситуация практически нереально хотя она не стоит так говорить но не сталкивались вопрос по поводу раздачи контента сталкивались ли вы с перегрузкой при раздаче видео когда к примеру вот модель как на youtube когда файл раздается один многим пользователям много смотрящих и если сталкивались то каким образом балансировали нагрузку как это решили смотрите то есть в целом видеозаписью нас не дублируется пока вот все что я о чем я говорил в конце презентации это шаги к тому чтобы начать их автоматически копировать в случае повышения нагрузки потому что в наших условиях это очень сложно сделать при таком большом количестве файлов но у нас есть опыт именно видео файлов которые дублируются это рекламные объявления то есть если вы загружаете реклам видеорекламу то ваш файл будет лежать не на одном сервере она нескольких потому что предполагается что просмотров будет много и в этом случае просто изначально в момент загрузки так как это помеченное видео она копируется тут то есть изначально когда файл уходит на раздачу бы джинсы или еще там на какие-то сервера раздающий никакой проверки загруженности сервера балансировки предварительной нету нет естественно нет то есть за исключением сидена когда вот мы обладаем статистику файлами того чтобы он закашлялся спасибо олег добрый день в контексте хранения фотографий и доставки пользователю ты сказал что есть несколько потенциальных ботаников то есть это диск и сетевое взаимодействие и еще упомянул сжатие используется лежать и га земли фотографии и не взрывает ли это все пью все фотографии тесно сжимаются то есть они загрузившись все пережимаются до тех размеров которые нас устраивают за исключением самого большого размера который flash на нажимает если фотографии не превышает 5 мегапикселей мы вот этот оригинал ставил но мы на сайте его нигде не используем кроме как загрузить оригинал вот и все остальное естественно пережимается пережимается с обработкой в каких-то случаях немножко шарпа в каких-то случаях контраст и так далее и понятное дело что если фотографии не сжимать они могут быть самыми разными недавно был случай пользу держалась что не может загрузить png жку которую сто с чем-то метров весит вот и у нас там no limit был по количество пикселей и по размеру и она не входило вот эти рамки а при получении гриб то есть стандартные джинсах zip смотрите то есть файловую систему в любом случае нужно потому что нужно как-то с диском работать когда нибудь сделаем своим файловых систем и может быть но в данном случае самый большой то есть есть проблема и надо решить и написание новой файловой системы или какая-то прямая работа с диском это не самое простое решение но смотреть на все равно нужны какие другие файлы ну на которых какие-то скрипты крутится еще что-то софт работает поэтому файла система нам нужно и почему бы на этой же файлы с теми не положить этот файл доступ к очень быстрому что мы уже открыли у меня последний вопрос насчет седин вы сами выстраиваете способе провайдеров тип лакомое нет сами и так как началось совсем недавно пока . только в москве но достаточно большая позже будут точки на вопрос как вы записываете до конца либо идет полностью отбой в конце не до конца в конец другие как бы этих вас этот отказ что что идет предположим вас несколько родов и нет я точно не знаю потому что не я эту часть писал но скорее всего последовательной записи с кэшированием в оперативку не но если сервер упадет в момент загрузки то в любом случае все будет не очень хорошо но да я не уверен я точно не знаю так вот у меня правда был не вопрос я хотел уточнить еще в том самом начале вот эту штуку с файлом который уже открыты ли не открыт соль вообще не в этом соль в том что мы не пользуемся собственно индексом файловой системы для куча мелких файлов а вот яндекс от файловой системы которые содержат sky права а размер каталог всякой вот эту фигню потом как раз нам не нужно если мы не пользуемся тогда только индекс файлов мы весь засунем в оперативку именно поэтому работа с файлом быстрее открыт он не не открыты от на самом деле нового но это разумно до"
}