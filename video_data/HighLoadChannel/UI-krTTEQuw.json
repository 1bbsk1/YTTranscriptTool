{
  "video_id": "UI-krTTEQuw",
  "channel": "HighLoadChannel",
  "title": "Партицирование и миграции данных на примере PostgreSQL / Денис Иванов (2ГИС)",
  "views": 354,
  "duration": 2022,
  "published": "2017-04-22T14:47:44-07:00",
  "text": "всем привет меня зовут denis фанов и я сегодня буду рассказывать как мы решали задачу парте церовани и миграции данных нашей компании на примере под графический элен но для начала немного расскажу про себя про вообще нашу кампанию про нашу команду так я готовлю ведущим озабоченным компании 2гис у нас есть очень много подразделения есть также бобами и есть одна команда которая занимается полочками я за вас таким нагрузка себя заботы я отвечать на раскопки работали не камазе о ничего все хорошо . скажу о продукте чтобы было более понятно вообще что новую проблему решали чтобы было понятно что у нас вообще за продукт которая коррелирует вместе со организациях города у нас есть проезда из как раз я отметил корабли были армяне давай добрались до места проведения конференции что можно сесть на экспресс пока дойти пешком на метро здесь на петрова вас проекта и на автомобиле и на петра организации поиска задавать различные параметрами также авторизация пользователя у нас есть фотографии практически до всех организации в одессе я привел фотография проклятие павелецкого вокзала сыну обычно это были какие-то проблемы с этим на всех момент до 250 руб дорогу тропических 2 миллионов фильм нам известно каждый фильм и средний есть 34 филиала один в городе но по сути его обществом и два десятка как происходит у нас слабо получается около 50 миллионов записей возле съели информации вид информации находил совершенно в основном ссылки на фотографии чтобы потом показатели все эти фотографии нас просто-напросто встала проблема производительности того что данная слишком много каши ниже главной таблицы и так очень много остается вся нагрузка на 2000 последнем саммите слова списка старатель и наша и смешная аудитория удивительно 22 но человек из доводчики давече хочу перейти к самой первой части доклада по ассоциирование это маленькая машинка и отпустил кучма нашего приложения градский на выбор как мы видим у нас 1200 но на самом деле как я уже сказал на 2000 с нагрузка это означает что мы не вывозят просто-напросто здесь показана 200 200 это предел допустимый по нашему его глаза наши слова и еще страшного с этим нужно что-то делать что же делать вообще есть несколько вариантов решения проблемы слишком много накопилось облицевали что хотим сделать разнести наши раны на кластер и распределить их начнут можно бесконечно забавлять обратились к другим путем ный на пол текущую жилете которые вас было оптимизировать работу по графику раз не добавлять ресурсов что вообще также работала пути и собственно было два это три визировать работу приложения и оптимизировать работу вас дорожки следующим путём у нас есть какая-то сущность как проект собственно сам крупный город с городами спутниками и за мной они когда пользователь не будет смотреть фотографии находясь в зале одновременно рафии деталей москвы то есть данные никогда они будут пересекаться именно в этом контексте мы решили что будете гражданами по проекту каспийское провоцировали сперма жить нам подсказку английский рок его card sharing что что написано там написано что если в конце что успели сделать при создании таблицы еще любой тут же нам говорят что текущий статус этого проекта 2008 года на правах человека и неизвестно будет использовать создание последовательных таблицей использования поддерживает действительно обследование в принципе с константами выглядит следующим образом можно стирать и слишком простые вещи расскажут мы создаем табличку с новостями у нас к новости ездить есть категория когда новость находится есть заголовок а новость есть классическая . также у нас есть иные категории чтобы можно было быстро искать я создал две партиции не обязательно и не узла добавил проверку таблицы 1 категория 911 эти гореть 2 как же мы создаем два правила чтобы представьте news при этом категории 1 из 1 нашу практику и и результат у нас были результаты того как исследование я фактически говоря сколько почему я разбил данным таблицы все слова на самом деле частного бог потому что в основном таблицы news она превратилась грубо говоря попью и при запросе на у нас происходил бук сиквеста того чтобы найти нужного птицы у нас начался и либо всех по птице и вместо одного запроса там училась на запросах это никуда негативность и мы разработали как называемый подпишем мечик привет из 90-х что это такое за утилита это охране на которая написана она бы с такой некий вот грамм решением кого не поддерживается космоса мы используем то же самое наследование те же самые константы но мы добавляем много всяких плюшек она никаким образом не ускоряет данный расскажу позволяет автоматически управлять собственно ведущий который показывал применить с помощью таблицы news таблицы для фрезерования и боли в котором данные берутся из категорий на лице произойти остановка это магия произойдет нас наша будет работать основной против который дает эта процедура при создании индекса банальной ситуациях нам прибежал менеджер говорит давайте короче новости показывать не только по категория еще пусть они подготовку насыщаться там поисковую строку добавили создать морально хотя бы индекс в этой табличке но мы столкнемся с проблемой что собственно придется на все сто тысяч у партиций создать этот индекс английски самый новобранцы этого nina pretty nice не сделает так как он наследования только по сути поляна перемещать наши последние таблицами яндекс и папу . за какой 1000 справки мы просто напишем президенты для qashqai наши partition это никуда не хотелось совершенно наша рука эту проблему решает как с использованием вообще проецирования ускориться то есть не просто разнести данная действительно ускорить процесс и есть два способа во-первых оказаться самым краем запасе есть явно передач на мы будем сейчас собирать из категории д1 да мы его напрямую указать эту по птицам в данном случае анализатор у сказки алиса сама поймет куда нам нужно идти не будет все будет замечательно чтобы имеется с применением наработок приложение научи и следующие результаты замечательно не цена на звучание как называется могли бы секты нас ускоримся результатами миллисекунды запрос через гаспаряна бывает у нас восемь сотых секунды то могу всех категорий она становится украины и числах миллисекунды и в районе того как миллисекунд если мы я показываю мартин если это возможно как могу себя добавлю вас сходках явно указывает partition в запросе то есть как не делать запросам важно просто использовали композитные хищники обычный вид shifting достигать одних наших сущности на идиш ник категории и все становится замечательно на пропажу избегаем вычисляет partition вопрос вот в итоге мы ускорим set of 3 теперь очень сжато рассказать о самой процедуре что там внутри происходит как она работает и еще профит она дает как я уже говорил на использует того crown тем чтоб casters самые расставлять искорки внутри мы используем системные на принце для получения индексов таблиц справил триггеров и прочих вещей для того что получите финишную на тему просто делаем тип между каждой partition основной таблицы и того что не достает его добавляем то что пропала ната мы его добавляем новые все это происходит автоматически зайди числитель нам нужно просто пойти боль каждый рассказывать про цифру для обновления маркетинг также мы добавили возможность автоматически создавать партицию не очень удобно появляется новая категория данные партицию хорош не просто напросто еще нет вас гости автоматически им не создаст constraint и все поверят и засунет эти данные в основную таблицы рассказал cnews нас news просто тоже будут играть так зачем они нам нужны на добавили возможность что ухватиться и сами оставаться создавались принципе все замечательно это решение она работает без единой папки кода приложения присвоили применяйте процедуру на своих обидчиков у вас все замечать разбиваете partition приложения при этом вообще не трогайте ну за исключением того что если нам нужно повысить производительность и мы уже не лезем сапсан приложения чтобы направить наши запасы само решение работать предвиденный праздник в итоге мы ускорились действительно в три раза по отношению с изначальным результатом мы не добавляли новые сектора нет ничего не просили завали то есть вас прост такое обычное решение в пределах а то же самое же взять и просто напросто повысительные сериала самое главное это то что доступно на кентами потому что подумать потрогать наши задачи решила надеюсь она тоже поможет присвоить google поиска вы че смотрите ждем ваших комментариев и вложений с первой частью про портирования мы закончились мы разобрались это можно совершенно не по поводу управления партициями что все можно делать автоматически весь мир вообще переход на автоматизацию чуваками делается поэтому совершенно вот теперь хочу немного поговорить миграциях наверняка у каждого в проекте есть такая проблема вот например мы у нас куча хранимых в возрасте и когда два раза хочешь пытаются исправить уже ходил в рамках разных задач и они просто создаю это будто дельту данном случае мы используем дельфин ну и пишем тройку историю по властвует лапшу ресницы мы указываем некоторые папки как эти бои у нас разговор заполняться сакура заменяется но проблема в том что при разных разработчиков у нас пролетают дипой 2 разработчики она закрыта мнение первых потому что это две разные дельты собственно так и сильнее первого заводчика просто пропадут проблема в том что мы теряем на суда просто изменения в коде момента может даже не подозревать если мы это заранее смотрим если разработчики не договорятся и не узнаю только еще арест процедур мы долго с этим боролись решили что с этим что то нужно делать разработали небольшой этажа инструменте который названием редактор грактар это обертка на венгерскими мигает за вся пройти мы используем buick 1 ну думаю если вы используете технологии вы по этой концепции принципе сможете реализовать это для своих инструментов что поддерживает утилита она поддерживает unicity reconnection и значит так как нет нужных баз данных они есть только через использованием компонентов наследовать их отсюда и connection of мы то же самое со станиной компоненты смотрим какие цены что там есть и с этими конечная будем работать мы поддерживаем на тигле верификации как я сказал уже просто обертка на дуэль те же самые методы мы поддерживаем также own history new tool и так далее это все команды которые поддерживаются ей играет мега хочу поддерживать мы потешным схемы мы избавились от стинга в бане деле накатывание низких вопроса на войск добавили поддержку схему миграции у нас его требованию граната нужно раскачать ногу базовый или что-то подобное сделать мы добавили поддержку хранимых процедурах боссов на что самое главное теперь процедурой обычный кусок кода который лежит на детей это просто файлик с которым написан сам не финишем сердца дурой то же самое происходит со view долина изменения в структуре данных изменения самих данных некий скрипты например кузов подпишем менеджера чтобы каждый раз критика его исполнялся ревновал наши позиции ну и много другой тип это получили мы получили достаточно массивный инструмент опеку над и мини игры мы используем через она команды по всем доступна ничего не нужно изучать каких-то новых команд запомнить специально операторами что то еще то есть используем также какие игры все будет точно также работать дельте миграции это тоже ход как я уже сказал что мы не делаем 2 разных деньги которые у нас просто-напросто подавший чуваков больше никогда не исполнится самая актуальная версия наши процедуры лежит детей папочки спокойно вот собственно и обновляемся критику и каждый раз вызывая микро все сам сделает поймешь как скрипт и нужно тоже каждый раз накатить партиции должно захотите это сделать опять же на гидрат может пользоваться на наших дачах вам решает мы все довольны больше никаких конфликтов про пачек пота с потери каких то пользуйтесь у меня еще спасибо за внимание спасибо за раздачу слонов не часто бывает приятно такие до 2 тоже вопросам на самом деле первый это я не очень понял может момент про то почему нужно делать запросы в конкретные child в таблице да он исследованы я знаю в девятом подпись и уже давным давно из такая штука constrain эксклю жинда когда мы применяем непротиворечивые кита constrain и которой он может понять что он подает запросам однозначно не может соответствии с этими constrain затронуть какие другие таблицы там нежели 1 или более нанести собственно да и вот насколько я прими ваш do it is it у вас вроде бы это должно работать ну видимо не работают объяснить почему на самом деле в данном примере где я показывал что мы добавляем constrain именно категория иди по сгрыз сам определяет что нам нужно именно в ту портится уйти но при этом он сам еще в основную таблицу лезет и как бы там там пусто может быть не пуста и все равно как бы уходит время на cut обработку то есть разница между прямым обращением через from в партицию и указанием constraint она незначительна то есть две где-то соках миллисекунды но она все равно дает прирост потому что мы напрямую обращаемся в таблицу и только оттуда то есть работаем как с обычной таблицы с партиций случае указания constraint а vr условие вот по сгрыз все равно полезет смотреть что вот есть news вот у нее есть унаследованные какие-то таблички и но он конечно полезет в итоге в news 3 если мы укажем категория 13 по константа но родились готовлю с очевидностью допустить у нас пустая она нас просто как грубо говоря шаблон используется то есть мы добавляем туда индексы она хранит вот все там триггеры правило все подобное то что должно переноситься в партиции этим такой вопросец вы когда вот google или postgresql и тебя парте цианирование вы ни ногой или случайно какую результате из такого-то расширение портман врут видели по г портман тоже общем не вчера появившийся могут просто интересно ездят ваш продукт использовать какие у него бонуса но если вы конечно наверняка вы знаете ну наверняка инструмент хорошие мы много чего находили мы хотели создать более такое консервативное что ли условие которое просто ничего с по сбросу мы не будем делать не добавлять никаких extension of ничего мы просто используем хранимую процедуру которая нативно поддерживает любым позже сам то все работает наша задача это решала поэтому мы смотрели больше в сторону кого-то более нативного решения у должен идти вне чем типа расширение для подвеса вот женскую из улиц но это дополнительная работа у других команд потому что мы интегрируем с другими командами это также нагружает админов это нужно также добавлять в рецепты тогда одно если только напрягает ну да такие вещи немного напрягают ок нативные проще и быстрее хорошо спасибо большое здравствуйте низ здесь спасибо за доклад у меня вопрос такой возникало ли вас проблемам поиска компромисса между числом партиции и их объем если до того как вы решили в принципе нет такого не возникало в принципе после разделения данных на партиции так как у нас более 200 50 городов эти 50 миллионов записей максимум по 2 миллиона разделились все она можно общий объем базы ну в записях либо тропа этих у нас 50 миллионов записи именно самих фотографиях но остальные данные для нас там особо уже не имели значения нам нужно было повысить производительность именно отдачи данных то есть это мы затронули только одну часть архитектуры по объему данных там много джейсона со ссылками на сами фотографии и если они ошибаются 200 гигабайт таблица весит сама по себе не так много не так много проблема фрагментации жесткого диска тоже не возникало да и зиму у нас так исторически сложилось она вся архитектура серверная это в трех дата-центрах в каждом по 20 серверов у нас всё на ssd вот админ это избавит такой шаг то есть с диском там уже ничего не сделаешь по сути пушки быстрее ssd спасибо оперативная память спасибо за доклад было интересно вопрос короткие что достаточно вызвать partition magic или маджи квартиры не будет указать таблицу и она сама и и проецирует но вопрос вот такое если на нее были франки что нас ним сделать с воронками они также перенесутся а точнее нет здесь на рынке me creepy действительно проблема такая была нам пришлось просто избавиться от форинтов потому что нельзя создать фрэнки сразу на все партиции извиняюсь за тупые убивает рынке пришлось отказаться спасибо за доклад вы приводите пример на картинке с новостями и абстрактные какие-то категории используйте при этом ваш кейс которые вы рассказывали там фотографии что в качестве категория иди не использовали в вашем кисть с фотографиями у нас разделение по проектам и где то есть проект это отдельный город фотографии группы москвы у нас project это называется то есть по project айди мы портировать чтобы не вдаваться он html терминология на более простых всем понятным примером все фрилансе ли все делали новостные сайты второй вопрос как раз связаны с тем что вот есть москва есть города маленький в москве явно фотографии гораздо больше чем в маленьких городах и они там все растут растут и растут и вот вопрос как не упереться в то что в какой-то момент не хватит партиции под москву можно идти дальше проецирования позволяет не только от мол свой указать можно несколько то есть можно добавить еще более то есть ну в данном контексте у нас есть еще рубрики то есть можем еще и по рубрикам дальше проецировать саму москву это все так же будет работать вот так опять же нужно будет внести эти constraint и в запросы само приложение вот про птиц и ровать принципе можно до бесконечности это все дела но предел все равно есть я его к сожалению сейчас назвать не могу потому что мы пока не уперлись в это скажи микропор ваш поддерживает даунгрейд то есть можно ли написать зонты для даунгрейда поддерживает там сзади человек хочет спросить напомните вы сказали что после портишь magic у вас скорость insert of не изменилась она да вообще не изменилось я так понимаю это на триггере работает ставка определяет партицию и создает ей при необходимости не переносит туда на самом деле с сенсорами ничего и не могло особо измениться потому что интер просто круг говоря добавляет новую строчку наша таблица при этом он не станет эту таблицу приобрети и селекции у нас под происходит по таблице там либо по индексу и выбирает наши данные либо для обновления либо для отдачи нам случае сенсор там такого не происходит то есть просто добавляет строчку пишет изменение на диск перестраивает индекс поэтому здесь портирование практически никак не поможет именно для вставки данных я просто помню что у нас в компании была история с триггерами что скорость работы с таблицей подала там чуть ли не в два раза когда появлялся хоть один триггер мы стараемся не использовать триггер и то есть лучше заложить логику приложения потому что триггеры о нем в любом случае какую-то магию добавляют то есть и явно мы пишем - это там что то еще где-то происходит при этом какая-то логика поэтому мы стараемся триггеры особо не использовать единственно это вот partition magic v before and saw триггере проверяет что если нет такой таблички он ее создает т.е. уважаю за глотку вопрос такой может быть оффтопиком таким небольшим но раз уж вы написали вот ваш микро ptr наверняка вы сталкивались с проблемами копирование этих сих пор тиц и они рваных данных когда они мигрируют backup чеки не лежат там где-то и вот что что в этот момент у вас происходит может быть раскроете секрет я вас не вижу а вот все теперь вижу на самом деле с бэкапом никаких проблем особо не заметили мы просто по таблично бы kopen данные если правильно понял ваш вопрос имеется ввиду именно при переходе с обычной таблицы на парте церовани и выпить или на нет такого если но к сожалению нет то есть мы ничего нет ни архивируем у нас данные которые есть мы нам их нужно отображать всегда здесь нет каких-то удаленных фотографий там они есть а не просто действительно удаляются мы делаем вакуум и больше не нам не нужно если они удалены нашем контексте это так дождя select вот эти очень быстро не как динамические генерируются и просто вопрос вот select от из основной таблицы я делаю она сама подставляет вот эту партицию нет сам запросам мы ничего не делаем то есть мы занимаемся в актив мэджики только автоматическим созданием партиции обновлением этих партийцы чтобы ты доставлялись индексы правило триггеры то есть только структурные данные с самими их самими запросами которые поступают в эти таблицы мы ничего не делали с мы оставляем логику на приложение она может быть более специфично чем например у нас этому нельзя заложить все при процедуры видимо все видимо все всем спасибо еще раз а еще есть еще такой вопрос уточните все-таки как вот вы делали миграции но для триггеров для триггеров мы просто убрали де финишем триггера также его сравнивали ну то есть просто если триггер ниро не равен тому который в основной таблицы мы обновляли этот триггер но как это исключает ситуацию что вот в двух отдельных ветках трубочки поправили 2 как бы триггер там и там потом все на придется мир g-100 все сам триггер он также хранится в отдельной папочке он постоянно будет обновляться в обществе gear он же вызывает например процедуру сама процедура может я правильно понимаю что мы грубо говоря где-то там в коде миграции храним новое тело триггера правильно у нас просто как там пышный файлик лежит этот регион там java триггера как решить проблему что вот двух независимых ветках разработчик правит мы делать миграцию там добавляет ну тело триггера новая и то есть это не решает ни как проблем брать пример же нужно разобраться какая частью версия будет более например же это уже разработчик просто работает с обычной системой контроля версий ему прилетает файл в которые он ведь история вы создали две разных миграций получается правильно то есть поговорят человек создает сначала одну миграцию с год человек создаёт другую да то есть если и знаем и это выглядит как две разных миграций независимо правильно ну вот и нам получается два разных тела триггеры это именно не разные миграции а там файл этот триггер он там всегда лежит если то есть два человека одновременно начали один и тот же триггер создавать вы это имеете ввиду но здесь какой-то конфликт скорее всего что спасибо не может неправильно понимаем вопрос телесно если в базовой таблицы у вас никогда не лежат данные вас можно или нет я просто не проверял задать constraint на нее что и сказать после су что в ней данных точно нет чтобы он ее не склонял к сожалению не могу сказать скорее всего нельзя сказать что там не данных потому что именно вот этим результате категорию несуществующую сказать что в ней вот категория иди там минус один это как бы приказ по сбросу не говорить о том что здесь такие данные лежат это некая проверка чек на то чтобы другие данные туда не попадали поэтому если это условие но все прокатит если на базу таблицу ска повесить constraint и сказать что в этой таблице лежат только категория иди -1 то а там данных нет конфликтов никаких не будет но планировщик поймет что если кто-то ищет категория эти 10 чтоб в базовую таблицу лезть не надо я что-то не так понимаю к сожалению не подскажу не проверяли так вот я тоже не проверял на проверить"
}