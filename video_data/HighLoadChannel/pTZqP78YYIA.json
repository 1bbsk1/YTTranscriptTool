{
  "video_id": "pTZqP78YYIA",
  "channel": "HighLoadChannel",
  "title": "Самый лучший GEODIST() к западу от Рио-Гранде / Андрей Аксенов (Авито, Sphinx)",
  "views": 2675,
  "duration": 2905,
  "published": "2019-12-05T13:15:27-08:00",
  "text": "буду рассказывать как обычно тупые простые вещи и в принципе как обычно доклад можно уместить его примерно два слова я только я пока не не вполне определился какие конкретные два слова из этого докладывать что там там учитесь в школе пацаны летом не знаю использую линейную то полету пацаны счет такое но очень в принципе если вы эти два слова знать то можно расходиться но тем ни менее над счет начинать с утра должен быть такой доклад наверное легкий ненавязчивый и заходящее во всех как омлетик а в гостинице sky экспо да ну вот с него и начнем так что не обессудьте если как бы техно хардкора будет мало ночь была длинной значит звать меня андрей нынче я тружусь лоретта это стандартный слайд названием кто здесь о чем сейчас буду дальше рассказывать мы делаем в том числе в оаэ то есть оказывается поиск а у поиска внутри вот в этой известной концепции плоского мира которыми слонах черепаха вот нам валить соответственно сфинкса до самого низа под сфинксами тоже конечно же что то есть внутри у нас того этого сфинкса в том числе помимо прочего кроме поиска занимает smas еще всяких интересных вещей фильтрации поиске по карте всякие интересные подмешивания дополнительного сортировки ля-ля-ля то ли жу-жу-жу нет никакой человеческие возможности мониторить абсолютно все запросы которые какие-то негодяи нам в кластер выливают но я точно знаю что guildies ты всякие там точно есть либо для очищения радиуса поиска либо для всяких фокусов с сортировкой по карте так далее это я к чему пах валяюсь там тачки не похвалялись а провязываю так сказать сцену представления с темой доклада к тому что все что я буду рассказывать а ну-ка даром что простой тупой как палка но это как бы не теоретизирование в продакшене последних так много лет крутится они чисто гипотетической а теория просто сейчас интересный вот вопрос понятное дело что когда доклад называть самый лучший diodes там или еще че нибудь там не знаю самый быстрый поиск подстроки или этого наоборот строки в под строке очень под строку строке кстати я только что понял над клик доложить надо наоборот искать строку по строке тогда это ее никогда не находишь сразу и нормально да доклад как будто бы праге а диск но на самом деле нет diodes тут как бы пример он интересные довольно показательные выходят такие примеры случается не очень часто пытать почему это соответственно запомнился и в один прекрасный момент в голове вылез на вообще на самом деле доклад того этого про больше про техники оптимизации древних вот тут ничего лучше чем древние пирамиды я конечно же не смог придумать такой маленький трибьют наверное висячие сады или 7 сады семирамиды было бы лучше но не удалось найти хорошие фотографии собственно геодец что такое геодец геодец пацаны это многочисленные дамы это вот всего-навсего функция которая берет на вход четыре обычных человеческих вещественных числах считает расстояние но как бы щель идиотизм дату что может быть проще того чтобы посчитать расстояние но там вот некоторые сейчас еще одному скрипя мозгами как бы в алкогольном угаре могут наверно там span прием лишь теорема пифагора я точно знаю мне в третьем классе еще рассказывать пифагоровы штаны во все стороны равны но вот есть нюанс как только какая-то скотина искривляет тебе реальность у многих я надеюсь сейчас реальность искривлена хотя бы до сферы считать расстояние по поверхности этой сферы вот сколько на самом деле придется по поверхности пройти пешочком становится уже менее просто дело чисто для справки дополнительно осложняется тем что земля оказывается не кругла она просто длина вот более точно на аппроксимировать они сферы а эллипсоидом а еще точнее геоида слава богу мы в делает не полезем но во-первых мы это интересный анекдот для утреннего легкого как омлетик доклада поэтому хотя бы это упомянем вот как на самом деле оно устроено вот тут не видно navi наверняка честно говоря даже мне не видно со всех источников но понятное дело на землю какая-то зараза зависла там горы долины реки так далее мы их решительно игнорируем но если землю дико бешено раскрутить и намазать маслом чтобы это масло равномерно растеклось по поверхности внезапно выясняется что она будет не то что не круглый не то что приплюснута или стоит эллипсоидом а за счет внутренней неравномерности типа там здесь нефть зарыта а здесь конечно же какие-то враги нашу советскую нефти переложили в саудовскую аравию а вот весь уран спрятали в другом месте за счет этой неравномерности она даже еще и не эллипсоид а вот такая вот там адская фигура геоид считать дистанцию пологи аиду прям совершенно полноценному ну занятие совсем вычислительно сложные по моему этим не занимается на данный момент совсем никто даже люди которым нужна очень высокая точность и вычислениях следующий слайд touch полковник на вот сверх точно в принципе не надо мы как бы делаем веб-сайте китам с нехитрые домашние странички вот ну а честно говоря об отзыве что даже люди которые особенно изделия под названием изделия запускают при помощи другого изделия чтобы она долетела до вражеских изделий и соответственно всем на изделием там порядка навело вот подозреваю что супер точность обеспечиваем расчетами прям по гео еду они аппроксимирующих эллипсоида не нужно даже им но это неточно потому что я все-таки вещаю отсюда они из бункера до соответственно у нас таких запредельных перегной и конечно тут со счетом радиус эпицентром он тоже позволяет небольшую ошибку внести что такое достаточно точно с нашей вот точкой зрения то по 9 дилетантски прикладной вот у нас изделие попроще они у нас как бы на серверах крутятся и никуда не летают сами по себе как мы обычно эти координаты то хранить будем into my но нет внт они наверное не влезут хотя в принципе если сильно угореть можно иван положить делов-то подумаешь там 45 45 сколько 6 может быть знаков после запятой можно положить в энтом делить на 10 тысяч десятичную не дай боже вот понятное дело что по пути наименьшего сопротивления координаты ты будешь хранить типично обычными флотами у флотов и значит замечательное свойство вот знаете как вот такие приколы на собеседования хардкорных хищников с бородами но назовите число которое не равно нулю но икс плюс икс равно нулю и кандидат такой ты че дурак что-ли как бы там алгебра полукольца все дела ешь никому такой это -2 в 32 и вот здесь та же самая история 16 миллионов плюс фитиль уточнение 16 миллионов и 16 миллионов семьсот семьдесят мегабайт 16 мегабайт 777 1000 байт 216 плюс единица с точки зрения флота равно самому себе потому что начиная именно с этого порога точности решительно не хватает и внезапно выясняется что когда ты пользуешься такими сам обычными старыми добрыми fall флотами без хардкора a&w my в 64 бита и тем более расширенной точностью 80 пользоваться блин вычислительно сложно и медленно плюс место еще живет в два раза больше не приятно у тебя уже просто из-за этого просто из-за неточности хранения координат ну извините точность теряется соответственно странно делать какую-то реализацию мгновенно почему это важно то что странно делать свой оптимизация как следствие реализацию которая там превысят по точности вот эти условные два с половиной метра или в наших северных широтах там допустим метр у тебя натурально просто не хватает точности координатной сетки для того чтобы это сделать а ну в наших паразитических применениях по меньшей мере важный были по меньшей мере интересные т.к. что вот есть некий предел точности у нас просто данные достаточно нет это мы еще молчим о том как дпс позиционируется там понятное дело ошибка может составить даже и не два метра как знает знают все кого когда бы то ни было яндекс навигатор и ввёл на джипе через пешеходную дорожку кроме точности данных у нас есть еще в добавок точности алгоритму да вот немного копну как так полагается всем я как бы немного не тут не геодезист поэтому тоже по читал википедию нашел там несколько в свое время не прям перед докладом слава богу позавчера нашел там несколько алгоритмов один из которых оказывается не фамилия оказывается в русском языке есть слово over синус вот кто не знал вот это я точно с какие-то не вниз википедия начал переводить перевел не сразу но оказался over синус да и оказывается это не фамилия всего-навсего нехитрая функция единица минус косинус пополам и оказывается весь этот разврат нужен был для того что в 1800 году в табличку занести именно его они просто синус иначе в 1800 году вот как бы век другой проблемы те же точности реал с при вычислениях соответственно два наиболее интересных алгоритма который видать который там грубо говоря дом в исходниках всего угодно отсвечивают когда ты начинаешь интересоваться как бы тебе в своем маленьком движке сделать дел расстояние это вот эти самые аверсе нужны потому что просты как метод при помощи over синусов потому что простой как палка и еще один метод который зверский медленный сложный и так далее под названием винченцо он по моему или винсенте них там поляков итальянских не разберешь а очень сложные относительно по меньшей мере всего остального очень медленный и вообще это итеративный процесс там натурального как бы ньютоном скорее не думским интегрированием долго и нудно что-то решать и конечно же как любой нормальный оперативный процесс можно ему подсунуть пару таких точек на которых он селится очень в продакшене именно такой реализации использовать не рекомендую все подряд используют эти сами aver синусы вроде как простые быстрые всеми любимые но нет понятное дело что есть всегда вот этот зуб что можно сделать лучшим и ты пытаешься иногда сделать лучше смотрим как все вот классическая реализация diodes то чуть менее чем в любой нормальный но базе данных наверное она выглядит примерно вот так то есть как бы выглядит страшно тут достаточно много букв но тем не менее все достаточно просто первые три строчки вообще извините считаем всего на всего разности между там шириной и долготой неважно не особо даже важно в каких единицах измерения в этом случае главное чтобы они вот промеж себя сходились далее делаем некоторое количество тригонометрических вычислений буквально там два притопа три прихлопа да там 27 фз косинуса чет позвони в квадратном корне time но чет вычисляю вот как от дистанции она еще такой немаловажный момент вот эту цену нехитрая формула она действительно нехитрое смотрите на предпоследнюю строчку и на пред предпоследнюю строчку это вот мясо формулы все остальное set at предполагает что земля круглая ну понятное дело за счет чего сразу получается вот это вот небольшая достаточно ошибка где эту форму по волшебной тормозит что-то про оптимизацию как бы собрались говорить про древние оптимизационные техники древних вот смотрим где она потенциально может тормозить интуиция подсказывает и потом в бенчмарке и не везде опровергает в паре мест опровергать что тормозить будет вот в этих вот местах интуиция подсказывает что будет тормозить из-за дабл of из-за корнем они не таким непонятно сколько это видно честно говоря но на всякий случай расскажу что они подсвеченную не настолько ядрёна красным потому что вот они действительно немножко подтормаживают но оказывается не настолько смертельно как казалось бы и вот это вот самая долбанная тригонометрия получается что нам надо посчитать а там 3-4 разных синус и косинус и и это все еще достаточно медленно ну то есть быстро но медленно вот решение обычная и беды у него соответственно тоже обычный вот еще упомяну зачем флот они дабл начал что интересно перемерять выяснилось что обычно хватает флота обычно хватает флота то есть по мото моей тестовой сети не сказать что сильно растет ошибкой так далее но во первых что интересно на ноутбуке в котором я в последнюю минуту так сказать переменял того чтобы в башке подновить выяснилось что вариант c флотами какого-то черта работает даже медленнее это вот не нормально так быть не должно выяснять почему это происходит вниз там еще смутно помню что иногда иногда в каких-то реализациях внутри немножко не хватало точности вот в этих вот самых вот долбанных синусах косинуса х самое главное вот в этом вот арксинусе то есть потерять извинить вот здесь вот одну там миллионную подарок синусом которую ты после этого будешь умножать на диаметр земли это вот там слишком большая потеря точности там может быть в десятки и даже сотни метров соответственно но и так такая заметка про добыл а проблема с производительностью которая как бы нам возможно не знаешь что она есть но она есть она на самом деле синусами и косинусами вот полторы секунды в 1 и 4 секунды можно просунуть оказывает сотни миллионов вызов но как всегда все равно я думал хочется еще быстрее кроме того возникает ещё вопрос а вот эта вот штука она не очень точная оно имманентно неточное она предполагает что земля круг земля не круглая отдельные какое-то качество удается скроить с этого самого концепта с овир синусами невозможно и слова читать его могу только но еще возникает дополнительно вопроса чуть поточнее может быть можно может человечество за это время что-то придумал в натуральном формул 1805 года или чуть тип того земля же эллипсоид но наверняка под можно считать по эллипсоид это как-то вот наверняка можно считать точнее и в принципе прогресс это не должно быть так сложно ну казалось бы еще такому потому что мы расстояние по эллипсоида посчитать вот значит функция которая считает расстояние по эллипсоида точнее обратно расстояние по эллипсу я задержусь чтобы все успели переписать конечно как это обычно происходит вот смотрите здесь еще опечатка где то есть наверняка то есть я уверен что пока я copy постил и руками раскрашивал все идентификаторы где-то вкралась опечатка у меня в исходник кроме того наиболее пытливый глаз сумеет заметить что это на самом деле не та функция которая считает именно расстояние это немного другая связанная функция которая мне как раз было нужно вот так вот она считается и вот вот здесь вот опять таки если просто в тупую дабл заменить на флот ну тоже получается чет не очень хорошо да наверное при помощи вот этой функции с оптимизировать то нам ничего не удастся точность расчетов приподнять видимо удастся злые языки клевещут что вот это вот чудо природы обеспечивает точность и расчетов натурально до одного миллиметра но очень точно можно изделия приземлить у него собственный радиус шверине говоря про радио с эпицентром но чет короче dice ходится слава богу люди придумали что если что-то допустим круглая то можно его натянуть допустим на барабан и соответственно для не ори заводь эллипс и при этом сохранить ну-ка понятное дело потеряв вот в этой за предельной точности но сильно упростить расчеты то есть как бы вспоминаем картинку самого начала несмотря на то что вы рисовали достаточно давно малоизвестная компания и все ситом федеральная комиссия по черт знает чем у радиочастотам и прочему фаршу федерал коммюнике шанс к уменьшен или что то типа того разрешают в америку у нас конечно свой роскомнадзор разрешает дозволяет и даже так сказать пропагандирует использование на маленьких дистанциях оказывается если там википедию посчитать аппроксимации эллипсоида плоской поверхностью это вот мы не сами придумали оказывается а соответственно целый fcc разрешил и так далее как только мы делаем этот нехитрый знать не хитро ментальные кадир сейчас говорим на учет как бы адский фарш давайте вот попроще вот ну да ну его кей там эллипсоид ну вот он вот как то вот в этой точке где именно там где нам надо считать расстояние давайте его упростим вот слава богу этого нам делать самостоятельно не надо вы все это бородатые мужики которые даже бесси компиляторы а просто с карандашом как бы и этом бесконечным количеством досок сделали за нас и опубликовали в соответствующих вестник их оттуда можно просто формулы спереть они выглядят ну на самом деле не сказать чтобы запредельно более просто но на самом деле мы сейчас посмотрим в них повнимательнее и выяснится что они действительно более просты добыл если правильно помню здесь тоже написано по инерции чуть такое это вот интерес и другой интересный альтернативный вариант считать расстояние которое по утверждениям работает на небольших дистанциях и тормоза здесь соответственно потенциальный забыть залитой залиты засунуты где но в тех же самых местах но видим что косинусов как бы сильно поменьше это у нас уже там наводит на размышление что ну наверно должно стать получше ну хотя бы на коротких дистанциях но должно если аккуратно выписать там посчитать пальцем сколько у нас красненьких токенов на каждой странице я перематывать не буду поверьте на слово потом проверить и получается вот что что а с эллипсоидом я у нас 33 геометрических операции один корень соответственно этими полу симов сами ли там vr синусами у нас 4 тригонометрической федерации и что самое отвратительное есть как вот такая подло и незаметно но на самом деле просто запредельно феерически тормозная операция взять арксинуса тригонометрии это до сих пор не бы стран арксинус вообще караул однако появляются определенные сомнения проточность если тебе прям в вестнике сразу пишу что нельзя на больших расстояниях ну прочь с точностью есть какая-то проблема мы же можем это проверить можем вот это вот чудо как раз на самом деле используется для проверки ну вот у нас есть супер точный метод это как раз код который я использовал для проверки точности этого всего добра вот и смотрим в эту самую точность сколько ее на самом деле есть и и действительно не хватает и на как вестник прав и и не везде хватает скажем так на так называемых коротких расстояниях прокатывает на так называемые коротких расстояниях достаточно вестники написано полон про 275 километр воле они про 200 сколько-то там миль 200 усилить этого 475 километров по человечески я считал анти научным наверняка методом но которое как бы умеет в брутфорс не получилось достаточно хорошо я просто buller овал определенные шаги по весь шарик нарезал сеточка и равномерный равномерно и не по расстоянию а по широте и долготе раз и в каждой точке по всем направлениям прошагал с определенным шагом там метр десять метров десять километров и так далее 2 вот вычислил куда я должен прийти после этого разными методами вычислял расстояние точно и эталонные расстояние мне известно я вычислил пару координат нам в дубля все дела на расстояние между которыми по грубо говоря лучшему методу известному человечеству равно 10 километрам попробовал все остальные методы сосчитал 2 метрики средняя ошибка вот там по разным hidden по разным углам в по разным направлением в которой я хожу и соответственно максимальная ошибка в случае с вот этим вот этот вот линейная аппроксимация эллипсоида она получилась на диван на больших расстояниях просто зараза запредельное то есть там дистанцию от нью-йорка до сингапура считать методом ну а давайте короче представлен в землю плоским эллипсоидом вот отработать не очень хорошо ошибка составляет 72 процента но то есть как бы все это вот понятное дело что вот эти 72 процента могут означать что угодно там то ли в 1 7 раза то ли в 4 раза и честно говоря я не могу сейчас сказать это в навскидку это в один из 7 или в 4 но не менее чем в 17 раз и мы промахиваемся максимум в среднем как видите даже в этом случае не так все просто ой плохо просто не так все плохо в среднем и промахиваемся на адских дистанциях на 7 процентов но знаете на дистанции 5000 километров промахнуться в среднем на 7 процентов то есть на 350 означает приехать совершенно не туда в принципе конечно прикольно если дает перформанс на расстоянии от станционной 100 до станционные 104 в 17 раз больше но конечно же такое в продакшен лить зашквар как говорят у нас в селе а вот опалу синусов несмотря на то что у них некая встроенная ошибка есть это встроенная ошибка еще все равно по умножается на ошибку флотов там вот действительно несмотря на то что земля круглая ля ля ля zhu zhu zhu тем не менее ошибка вот в целом в каких-то там разумных пределов 0 4 процента 08 процент не зря я его и вот все любят этот вот подход и все его реализуют одна короткая формула ошибка маленькая все дела но ведь можно же улучшить наверняка можно и тут мы собственно наконец-то 20 минут полётного времени переходим к 17 оптимизационные техникам древних на самом деле если внимательно посмотреть на формулу выясняется что там внутри ни один не 3 синуса и косинуса а синус и косинус всего-навсего один мне вот лень перематывать и слайд я забыл скопипастить но я надеюсь что не все еще забыли и тут под грохот барабанов миша обещал грохот барабанов но барабан короче не удалось со стенда принести в зал заносятся optim зонная треть техника древних номер один напряженный момент и на сцене появляется господин погорелов потому что оптимизационная техника древних которая требует она от нас внук мы уже люди взрослые мы этой фирме заниматься перестали поэтому ментальное напряжение при следующих тайных строках очень высоко и этаж косинус двойного угла а после этого начинается вообще за пределы задачка со звездочкой косинус тройного угла если внимательно присмотреться вот этой самой формуле с плоским эллипсоидом внимательно присмотреться они просто скопипастить википедии внезапно становится ясно что углы которые там об считываются это не те угол и и которые об считываются формулы этих адских гавер синусов а повторы широты и долготы ну там повторному умноженное на два на три и так далее некой средней точки вот это вот и млад это что такое это всего-навсего средняя . того отрезка которой мы обсчитывает вот гавер синусы какие-то дельты считают а соответственно подход с плоским эллипсоидом говорит вот у нас есть отрезок мы взяли идет него среднюю точку просто просуммировав и поделив пополам широты и долготы вокруг нее что-то там считаем всего на всю вот выясняется что эти косинус и синус и можно заметить на умножение и сложение и это важный момент почему эта долбанная техника древний до сих пор работает потому что до сих пор тригонометрические операции и видимо всегда так будет запредельно дорогие по сравнению с умножением и с вложениями на фоне тригонометрических операций там арксинуса в корней и так далее ну вот это вот нечто не стоит это вот пыль вообще под ногами кажется вот теперь стало вообще хорошо потому что опять таки интуиция подсказывает мы свели все до одной тригонометрические операции там всего три косинусы было остался один выглядит что вот улучшить нам ничего не удастся и дальше еще особо пытливый взор либо взор сна снабженный дизассемблер am говорит что вот этот корень который мы берем и так далее он как-то там клюву ложится на соске шлю и строк исполняется за один такт и в принципе ну наверно вот лучше сделать уже не можно да но нет потому что уж такой то потому что в этот момент в зал заносится древняя техника древних номер два правда никакая лично сне не и ассоциированной этом даже не знаю там автора экселя может быть надо или что то типа того выделенного супер забредать или у нее нет сейчас вот опять таки держись за стул я сейчас вылезу спасибо будет супер техника супер техникам даже те кто не программист наверняка умеют ею пользуются это называется техника таблицы должно возникнуть и честно говоря у меня самого возникает постоянно определенное недоумение как же так 2019 год на дворе вместо того чтобы честно посчитать косинус синус и прочий фарш мы должны как ядрёна вошь табулирования с помню что на процессоре 80 286 косинус работал очень очень медленно это сейчас он работает очень медленно 100 микросекунд грубо говоря вместо одной микросекунды на самом деле конечно же 100 наносекунд супротив 1 наносекунду она 80 208 6 вот на этих барабанах и перфокартах напряжение с которым вычисляет косинус компьютер его пощупать можно было то такой инструкций компьютер инструкция косинус но так скрип тросов там грохот лебедок натурально можно было моргнуть и косинус еще не досчитался пока ты моргаешь приходилось два раза считаться в этот момент человечество понятное дело я использовал технику раз его так медленно считать мы заранее посчитаем несколько нужных нам значений их за табу леру и мы будем из таблички брать из таблички брать получалось с меньшей наружностью но что интересно возникает опять некой беда с точностью если просто взять и в тупую из-за табулирование возможные значения косинуса с каким-то шагам то если мы их возьмем слишком мало и будет нормальный размер таблички в один килобайт точность будет какая-то запредельно низкая какая я считать не стал поленился а если большую то и табличка слишком большая и нить с ее долго и на самом деле скакать по ней но тоже не не настолько хорошо что же делать но после 208 6 процессора придумал 386 процессор и еще одну технику заносится техника дрены древних номер три опять-таки вроде ну надеюсь она настолько очевидно что выделенного изобретателя не имеет и она называется пам пам пам пам пам линейная интерполяция самый главный пример линейной интерполяции для нас конечно же вот здесь да вот это совершенно очевидно первая игра где вот матерые использовали линейную интерполяцию через каждые 16 пикселов движок квача интерполировать перспективность с это скорректированные текстурные координаты чтобы руками текстуры на полигоны ложить очень-очень хорошие грамм была когда-то рассказывали не имеет никакого отношения к коду на следующем слайде то есть технику я не оттуда спиро как так как один из 220 миллионов программистов независимы переизобрел или посмотрел у кого-то но конечно минутка ностальгии в 11 утра еще клипы эти которые в гостинице круто это не из квача это руками написано из квача ты лица другой фокус как быстро быстро считать корень если тебе и соске 2 не завезли а это руками все писали и пишут до сих пор косинус оказывается можно написать вот так вот это вот вот этот а да это на самом деле косинус счет чего здесь происходит в этом аду в этом разберем его по всем другим строкам в этом аду строится небольшая табличка этих самых косинусов но вот я только что понял какие еще два слайда надо было засунуть если просто табличкой такая ступенчатая функция ступенчатая аппроксимация то здесь на хотя бы линейное сильно более гладенько вообще мощной техники идут вход просто караул оказывается внезапно что вот это вот нехитрого хода с табличкой и линейная аппроксимация между двумя соседними кусками таблички и ее хватает для того чтобы точность косинуса того самого сделать тут достаточно высокую уж по меньшей мере как низ рана на крохотные таблички получается что точность косинуса достаточно высоко например для того чтобы барабанная дробь с гаком покрыть ошибку флота ну еще обратите внимание здесь совершенно не нужно никаких сложных операций использовать мы всего-навсего округляем до целого числа вычитанием были над ним одним вычитанием вычисляем целую часть дробную часть используем все это делал для того чтобы посчитать наш линейную тополя цию вот соответственно ну прям вообще вот вроде отделались исключительно арифметическими операциями то есть вместо косинуса ещё вот это вот вонзив мы этом взяв упрощённую модель немного подшаманить с константами по поколдовав с таблицами линейной аппроксимации мы доводим нашу формулу исключительно для арифметических операций 1 взятие корня которая сейчас уже наконец хоть что-то наконец то работает быстро кажется это вот успех и дальше улучшать уже точно нельзя но нет вот в этот момент надо посмотреть немножко опять таки на исходную формулу понять что там косинус и мы посчитаем не так там табличку где заменим и так далее и можно прицельно посмотреть вот тут важно прицельно посмотреть вот на эту строчку вот как вы считаете можно ли что низ оптимизировать вот в этой строке такой подлый вопрос с клэр если чё это там не формальный метод не писать по два раза по два раза это всего-навсего возведения в квадрат умножении само на себя самые смелые гипотезы как бы возможно лис оптимизирует эту строку гипотез нет не брать коэффициенты вынести коэффициенты то есть к 1 там на к1 развернуть вот эти умножения и так далее да хороший вариант но как бы но нет дело в том что если мы развернем вот эти умножения у нас еще больше термов будет умножение суммарно будет больше проще посчитать или все-таки их перемножить то есть как бы ход не плохой но не получится еще одна гипотеза будет или не будем затягивать уйти от корня от корня к несчастью уйти не получится ну в общем можно мозг поломать мы правильный ответ нет эту строчку с оптимизировать нельзя зато можно оптимизировать все остальное 4 техника древних номер четыре под бой барабанов 4 так оптом что мы делаем с этими самыми косинусами таблицами всем вот этим фаршем считаем lookup табличку читаем до интро полируем а на кой черт мы это делаем зачем мы считаем и интер полируем какие-то промежуточные значения давайте вот эти мутации коэффициенты к1 прям они этаж функция от вот этой вот средней точке медиум лечь и с людьми xoom logic давайте их сразу возведем в квадрат зато полируем их и линейной интерполировать будем прямо их все вот эти вычисления все включая последние возведение в квадрат сложим в табличку заранее зато buller of хочу а вдруг получится еще интересно что характерно получилось что еще более интересно для того чтобы за табулирование вот это вот дела и натурально как бы для всего земного шарика он оказывается большой неожиданно хватило достаточно маленькой таблички во-первых и с маленькой точности вот в этот вот момент мы уже прям полностью и навсегда хватает перехода от doblo окончательного к флотам ее на самом деле итак то почти всегда хватает но возникают какие-то border кейсы крайний случай а здесь вот у нас получилось все этого барабанная дробь все вот эти четыре техники оптимизации древних привели вот к такому вот простому superfast посту он не выглядит сильно более простым и была сильно более простым является потому что обратите внимание что здесь происходит всего-то навсего посчитали среднюю точку всего-то навсего принтер коррелировали причем умножение без деления и так далее какие-то коэффициенты по таблице но дальше уже пару-тройку умножение корень от этого уже не избавиться вот соответственно самый быстрый результат с там более-менее вменяемой точностью это важно которая удалось добиться он выглядит вот так вот диллон меньше 13 и девон меньше 13 если что это тщательно подобранная крафтовая константа и соответственно в градусах или радианах каких-нибудь при которой это формулу к вот такие вот фокусы с прокси мацы и так далее все еще дают приличную точность и честно говоря даже еще более лучшую чему вот всенародно любимого подхода с гомер синусами вот в принципе на этом можно успокоиться и расходиться а можно и доделать чё будем делать расходимся ну его нафиг пойдемте кофе попьем и льда делаем ты глянь 11 утра все таки есть есть программ мерзкая гордость ну ладно доделаем хочу доделывать но наверное надо доделать вот тот кусок который не меньше 13 я больше 13 почему он зараза вообще внесен это вот разница как постоянно их путаю честно говоря широта-долгота вот это кажется долгота когда разница долгот больше 13 градусов то есть это вот вроде бы но это неточно это вот те самые дистанции более 500 километров но в принципе там от новосибирска до дата бердска наверное меньше поэтому для любых практических целей внутри дубль гис и нет никакой потребности считают такие гигантские дистанции вот просто ради того чтобы написать все таки универсальную функцию которая всегда работает и всегда дает внятную точность но нам надо все-таки написать другой код пав вот это довольно далеко но вот тем не менее хоть тамблинг хотя бы извините тот же самый гавер синус обратно воткнуть на этой ветке кода хочется плюс у на нас уже понесло мы уже там хотеть таблица как бы вот вспомнили древней техники древних и пытаемся их применять чему мы уже якобы научились на самом деле надеюсь скорее вспомнили что от можно for муки оказывается упрощать можно эти формулы composer овать вместе вместо там промежуточных штук считать сразу композицию функций эту композицию засовывать сценическую в табличку и по этой табличке еще более цинично с особым цинизмом в составе группы инструкций процессора делать линейную интерполяцию ну хорошо как бы в древней техники древних мы вспомнили попытаемся их применить к этому самому over синусу две ключевые строчки с которой все начиналось выглядит вот так можно ли здесь что-то сделал ну конечно можно вот чувствуется что синус и косинус и так далее надо заменить функциями которые по табличке все интерполирует мы их уже еще и написали как только мы написали косинус тут вот сейчас господин погорелов так машет рукой и улыбается и передает привет как только мы написали косинуса с прибавлением константа пи пополам мы написали заодно и синус а с арксинусом и корнем вот этой вот композиции мы еще не воевали но судя по всему на даже как бы как это как деды завещали просто тоже сделать вот табличку все нормально будет это работает ровно на половину действительно воткнув туда реализацию табличную дебильную так далее как натурально там если не восемьдесят девятом то пятьдесят девятом году на 208 шестом процессоре идиотия полная берешь библиотечную функцию синус и косинус а вместо реализован в библиотечную функцию синуса к косинусу руками ну какого черта в работает дает сильно большей производительности вполне приличную точность а вот для арксинуса с корнем не работает хотя казалось бы причем тут лужков ждал чтобы понять при чем тут мужиков необходимо посмотреть на распределение этой ошибки от аргумента ну там аргумент внутри корни там не внутри корни аргумент под этим арксинусом всегда строго от нуля до единицы и вот видно что он из серединки какой-то там грубо говоря от 0 1 года грубо говоря 0 9 точность просто вот запредельная вот эти вот 3 106 1 369 ста наверно тысячных это вот и и этого флотах в дабл их еще меньше при крохотном размере таблички работают все там прекрасно ура ура но на концах на конца то есть на самых коротких дистанциях которая грубо говоря там по пять-десять 100 метров и на самых супер длинных дистанциях а это соответственно тему запредельные которые там по 10 тысяч километров вот на них наступает беда вот поглядев в эти константы натянув их на расстоянии там получаются как достаточно приличные такие расстояния потом под 5 тысяч километров под 10 20 тысяч километров но мы же универсальную все-таки функцию хотим написать ей при этом на точную быструю универсально но вот ладно тот конец которой рядом нулем он скорее всего в нашей реализация даже вызываться не будет мое очень чисто на автопилоте напишем но вот тот конец которые рядом с единичкой вот там с ним беда его надо заткнуть выглядит он вот так вот этот график чуть ли там не в бесконечность уходят там чуть ли не впрямую выстраивается вертикальную идеальную как раз в около единички когда ты приближаешься к полюсам пи пополам у и соответственно по ходу через половину земного шара ровно и предельной дистанции там в 20 примерно тысяч километров и как ты вот эту вот заразу не интерполирует тебе всегда не хватит точности выписан окрестность единицы тебе может не хватить точности от 0 9 до 10 и от 095 до 10 от 099 и так далее но где то там на запредельно высокой дистанции тебе точности все равно не хватит на сколько у большую таблицу ты зараза не сделал вот вся он не хватает ну понятное дело что там тебе уже то это ошибка перестает как бы колыхать вот но все таки повторюсь как будто мы боремся с универсальностью и тут внезапно глядя на эту функцию мы понимаем одну простую вещь не понимаем че мы делаем с этими какими функциями с функциями фокусами с таблицами аппроксимация my все дела и всеми делами мы это приближаем прямой линии или набором прямых линий ну короче не работает но как бы если работает то можно долго долбат с головой об стену и делал таблиц побольше а можно и тут последняя техника древних номер 5 вместо линейной функции взять квадратичную правильно для начала если заработает квадратичная куб 4 степени так далее и тому подобное и наконец-то мы только что пацаны вот мы насильно породе большого прорыва до этого нам господин погорелов махал рукой как бы из 7 класса средней школы а тут мы совершаем квантовый скачок и мы поступаем в вуз ешь ряд тейлора не узнал вас в гриме но или не сразу по меньшей мере что в итоге вышло когда как бы удалось вспомнить но тоже не сразу пришлось как проконсультироваться ко всем профессорам сходить начал сначала с профессора по социологии поэтому плохо пошло но потом постепенно их химиком зашел попустился и уже после этого ряд тейлора рассчитали современную эпоху слава тебе господи нет даже потребности руками все это на листочке яростно выводить можно в в альфу прямо онлайн нужной формулы закатать она те красивые графики рисуется которые собственно спер на предыдущем слайде производные считает в нужной точке все онлайн все прям в браузере очень удобно то есть тот один раз в десять лет когда к вам приходят тети и говорит слышь короче тыжпрограммист вот мне тут там правило лопиталя там не успевающим у влияем племяннику как ну тыжпрограммист помоги вот и можно это делать теперь прямо в браузере очень удобно хватило четырех членов read для того чтобы нормальную точность аппроксимацию строят для вот этой функции композитные не для самого арксинуса прям для от арксинуса а то от корня ориентировался я при выборе всяких порогов и так далее там супер точности на те результаты которые мне в серединке дает моя lookup табличка ну или чтобы общая точность там на всех возможных дистанциях не очень падла пороге водка опять крафтовые подобранные они ровно вот оттуда вышел вот такой о бок вот такой a dog учить такое вот оказывается на маленьких дистанциях с точки зрения функции арксинус от корня и так далее которые мы используем где-то там внутри маленькая дистанция пять тысяч километров вот получается вот такая формула выглядит она страшно но по причине того что там исключительно умножение и сложение вот опять таки вот это случайно затесавшийся корень считается довольно быстро существенно более как бы интересно и работает быстро для нужных для основной массы нужных нам дистанции вот там 5 тысяч километров до 17000 километров все тот же самый древний шаг древняя техника древних номер три слуга по табличкой циничной интерполяции этой табличке ну вот там просто табличка другая и что интересно еще даже меньше чем для синусов и косинусов вот и конечно же на самых запредельных дистанциях точно так же можно сделать ряд тейлора просто сделать разложение не в окрестности 0 окресности единицы ля ля ля zhu zhu zhu но будем откровенны я посчитал какая там дистанцию выходит прикинул насколько часто веб-приложениях надо считать дистанцию на 17 тысяч километров и решил что перформансом в этой части я так и быть пожертвую и оставлю просто вот честные расчеты и но зато это как его а он честный относительно медленно расчет но зато приличную точность и можно повторить вот эти все приседания с рядом тэйлора я и попытался сделать могут болеть за 15 минут не удалось там какой-то слишком уж забубенный ряд выходил и вот там потребности невелика и того я обещал древние техники древних вроде вот они эти древние техники древних они не хитры оказывается пацаны как в школе учили формулы можно упрощать оказывается как опять-таки в табличке заново как графики помните когда-то может устроили потолще com можно строить таблички оказывается после того как ты построил табличку можно пойти табличками просто тыкать пальцем а тыкать пальцем между ячейками и между точками проводить по линеечке линию и линейно интерполировать ну и конечно в особо редких случаях когда тебе надо vip-сауна три снасти нуля либо единицы посчитать арксинус от корня это нечасто и понятное дело явление в момент перекладывания g сонов на лопате спасает первый клуб и ряд тейлора вот одна из древних техник древних она возносится там прямо в целом у первому курс тот натурально у меня самого вот такое вот гнетущее ощущение под название чё ты несёшь чё ты несёшь 2019 год на дворе таблички линеаризация ну ладно хрен с ним сегодня там ну вот еще прогресс не дошел вместо 286 уже там видимо 1586 там девятое поколение архитектуры core 2019 год на дворе синус все равно вот работает медленнее чем лук по табличке линейной интерполяции но ведь будущее то настанет обязательно и она будет светлым и там квантовый миловидова квантовый клик house пишут и наступит же 2049 год и все вот это вот изменится вот моя гипотеза что нет не изменится ответ нет и вот люди которые будут жить в светлом 2049 году все равно будут писать линейные таблички местами в особо нагруженных но не требующих запредельный ток вот видите вот чувак чел делает левой рукой явно явно косинус интерполирует по табличке вот других объяснений нет а правая об электро опциями мечтает вот несмотря на то что время идет вперед вот это вот засада под названием линейная функция блин быстрее чем синус косинус арккосинуса так далее не денется скорее всего некуда будет с нами вечно вот это вот засада и вот эти вот древние техники древних были оказываются актуальны 10 лет назад 20 лет назад 30 лет назад и даже в эпоху перфокарт натурально вот эти вот самые aver синусы не табличка единице минус качества с пополам это тоже оптимизационная техника потому что кто-то не хотел лишний арифметические операции делать тогда в 1805 вместо этого он решил за дублировать на одну композицию функций и вот уже три сотни лет скоро наверно в обед тех ставить точку до по дну как бы у меня . то длинная тоже но сам понимать надо право заграна прямота оттянулась еще значит всего-навсего 10 слайдов и хорош капли философии что такое лучше и лучше не значит быстрый вот самый быстрый dist только с точностью него определенные проблемы достигающие в отдельно взятых местах сто процентов лучший и это необязательно самый быстрый лучший это некий клёвый баланс у вас достаточно точность у вас достаточно перформанса у вас как бы выполнена бизнес требования то тут должна быть какая-то смешная шутка что вот есть бизнес требование чтобы ракета обязательно попала в эпицентр но я ее не сумел придумать до одновременно с этим но обратите внимание что где древние техники древних местами дают достаточно интересный результат функция вот это вот адское адаптивная которая в этой части считает арксинус от корня по табличке здесь интерполирует его рядом тэйлора в промежутке какой то еще от считает вот этот безумная адаптивная функция получилась по обоим doom особо важным для программиста параметрам интереснее и кливии она одновременно и более точна определенных дистанциях там где то вообще возможно но она по меньшей мере не хуже да потому что в том месте где она является по где она полностью копирует вот этот финт ушами с приближением земли лепса этому вместо сферы там абсолютно такая же точность в тех местах где мы свои трюки присовывает она еще и улучшает точность местами что интересно полу оказывается получше обоих двух этих как их звать обоих 2 использованных техника и соответственно ну вот она немного быстрее на мега тесте с которой этой сеткой покрывает весь мир она вот там сколько сложно считать в 3 раза быстрее на более вменяемых дистанциях до там до сотни километров она вот врачи выходит в четыре раза быстрее резюме простое помните про древние техники древних и постоянно их применяете тогда все живем хорошо спасибо андрею коллеги всего один вопрос можно здесь а потом дискуссионная зона я думаю дрель еще долго будет отвечать на ваши вопросы давайте один вопрос в зале а к сожалению потом надо переобуваться в следующий доклад здравствуйте а можно тогда пробовали синус и косинус и представить в виде ряда тейлора ответ да у меня была одна из промежуточных реализаций пока я вот это все конструировал один из моих шагов был действительно написать для там статической координаты какой-то классик разложить их в ряд и т.д. и т.п. точность получалась такая же а работала медленнее то есть так там то мне потребовалось там линейная табличка с работала достаточно хорошо и она естественно навсегда быстрее ну что продолжаем учить андрея в дискуссионной зоне мы тебя благодарим за твой замечательный доклад и дарим федор как выяснилось требующий сдачи в багаж благодарность"
}