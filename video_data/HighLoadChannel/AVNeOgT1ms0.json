{
  "video_id": "AVNeOgT1ms0",
  "channel": "HighLoadChannel",
  "title": "Эволюция поиска Avito / Вячеслав Крюков  (Avito)",
  "views": 1904,
  "duration": 2429,
  "published": "2019-06-03T08:57:08-07:00",
  "text": "немного статистики аудитория вид ежедневно это 10 миллионов и уникальных посетителей около 140 миллионов поисковых запросов 40 миллионов активных объявлений на данный момент что вы узнаете из доклада поиск вави то достаточно долгое время практически стоял на месте и последний год разительно отличается от это от этого времени и я решил рассказать вам о том что появилось нового и мой рассказ будет как с продуктовой точки зрения так и технически мой доклад не утяжелен каким-то хардкорным вещами но надеюсь он вам понравиться ценности поиск авито достаточно очевидно две важные ценности это предоставить покупателю то объявление которому нужно за меньшее количество действий а для продавца это доставить объявление в поиск как можно быстрее если система позволил ему пройти модерацию и она угодно публикации как же устроен поисковикам он устроен достаточно просто в нем есть фильтрация по ключевым словам дерево категорий у нас компания это называется инфо моделью достаточно сложная система есть фильтры по параметрам категории у каждой категории может быть свой набор фильтров есть общие фильтры например фильтр по цене есть сортировка раньше было сортировка по дате основной сортировкой которую вы видели на приложение и на сайте авито также были есть сортировки по цене и удаленности и за последний год появилось выдачи авито релевантность вернемся на год назад и предположим что вам нужно пианино ищем пианино заходим на главную страницу набираем пианино у вас будет сортировка по дате и вы получите скорее всего грузчиков и услуги по перевозке пианино также это может быть что то еще связана с этим что будет более популярна чем сам инструмент пианино с точки зрения его использования для обучения музыке еще чего-то упс что же делать надо удачной категорию мы кликаем на рубрика тариф хобби и отдых дальше спускаемся по дереву категории музыкальные инструменты клавишные инструменты и наконец-то мы видим то что хотели а сейчас этого не надо делать при поиске с главной за счет релевантности сразу увидите то что вам нужно при этом добавилась новая сортировка называется над по умолчанию и представляет собой сортировку по двум показателям это релевантность и свежесть в топе вы видите самый свежий из релевантных при этом поднятие работает как актуализация свежести то есть если ваше объявление спустилась водопаде вниз по времени то вы поднимаю его делать его более актуальным и она выходит в топ есть она релевантно также мы пытаемся доставить ценность пользователю разными способами не только улучшая выдачу а например разработали несколько подходов один из таких подходов это проброс категорию например мы ищем вот кстати кто может произвести гальярдо гаярдос lamborghini gallardo чтобы добраться в листовой категорий там нужно совершить два лишних клика ну капец или вовсе скорее всего вы получите что хотите но есть дополнительный способ которого сразу про бросит в автомобиле то есть выдачи будет сужена будет выбран нужный автомобиль фильтрах и вы получите выдачи желаемый вам автомобилей это реальные автомобили которой синий с выдачи до автомобили таких москве на и в эту же тему расширяющий теги например когда вы вводите слова куртка вас появляются подсказки данным на данном screen не показаны подсказки тип курток женская мужская ага девочка мальчик если я нажму на девочек я сразу попаду маму микро категорию где будут выбраны соответствующие фильтры это тоже если потерю категории спускаться вручную достаточно много действий будет соответственно выдачи ниже и тут же покажется набор дополнительных расширяющих тегов зимняя куртка кожаная новое и так далее для покупателей появилась важная вещь которую они ощущают при подаче своего объявления если ваше объявление не задержит какой-то запрещен тень является дубликатом то есть обычно хорошее объявление вы его увидите выдачи практически сразу реально это задержка около 2 минут фактически задержка может быть до 30 минут но такое бывает редко раньше же эта задержка была фиксирована 30 минут появилась очень интересно фича на при приложениях на android и на ios вы можете воспользоваться поиском по фото когда вы заходите приложение у вас ей значок фотоаппарат и если мы на него тапните то вы попадете в на экран с которого вы можете сделать фотографию предмета автомобиля чего угодно что вам нужно и по этой фотографии вы получите выдачу либо вы можете загрузить фотографию своей галерее я подготовил пару примеров вот здесь отображена статуэтка которую нашел в интернете и попытался поискать поиском по фото на авито и что удивительная точно такую же статуэтку нашел правда нет самом топе чуть ниже но все таки она нашлась или например наушники точно такая модель нашлась и причем нашлись похожие модели но других производителей то есть похоже смысле там по цвету и по форме как работает поиск по фото у нас есть объявление которое индексируется поиском для того чтобы работал поиск по фото это объявление должно быть обработано сервисом распознании фото его фотография должна быть обработана и сгенерирован вектор изображение технически это набор флотов отрицательных положительных из которых ничего не понятно дальше к нам осуществляем поиск то делая фотографии или загружаю из галереи мы отправляем ее в тоже в тот же самый сервис этот сервис нам возвращает диктор но уже наши фотографии и эта фотография отправляется в сфинкс но не в обычные сфинкса сфинкс 30 и не 2 вектор извиняюсь дальше свинца просматривая объявления когда формирует выдачу он извлекает соответствующие виктора проиндексированных картинок и сравнивает их операции скалярного произведения результат эта операция является показателем по которому сортируется выше все достаточно просто и вы видите то что хотите найти по фото что было год назад год назад он у нас был близким и сейчас есть покупаем монолитный весь поисковый функционал который работает вои там был в этом молите то есть этапах оппой и он работал на 4 платформа android ios мобильная версия в браузере и до 100 для того чтобы отдать выдачу внутри этого кода формировались соответствующие теперь запросы twins шла пост-обработка и выпечь отправлялась формате джейсон или хтмл на листок и пользователи видели то что они искали соответственно если реализовать какие-то новые фичи новые системы интегрироваться с этим монолитом очень сложно поэтому приняли решение разработать поисковый сервис нас он имеет сокращенное название искала теперь монолит входит в этот поисковый сервис а сервис how it feels когда мы разрабатываем сервиса всегда нужно задать вопрос а зачем достаточно очевидный плюс это вы нас не скоро вне логики то есть нашем случае это вскрытие с кухни по обработке свин спеть запросов также мы можем более простым образом предоставлять поисковый функционал сторонним системам синхронное выполнение запросов менее очевидны ну тоже достаточно понятный момент зависимости от реализации можно достигнуть тех иных успехов у нас же сервиса ли заново link поэтому у нас получились хорошие результаты быстро диплом здесь все понятно мы выделили отдельный функционал которые меньше по объему года меньше тестов проще выкатывается и самое главное счет удачного подхода в реализация этого сервиса в нас получилось запиливать интересные штуки и реализовывать продвинут алгоритма ранжирования то есть мы имеем возможность делать достаточно сложную обработку который мы не могли бы сделать монолите и нам это дает очень хороший фундамент для проведения экспериментов с качеством поиска ну как бонус это возможность перейти из освенцима elastic потому что низкого ранга логика теперь у нас скрыта на этой схеме уже отображен случай когда у нас есть монолиты есть уже сторонние сервисы это сервис авито помощник который в бою и авито telegram.bot официальной telegram.bot авито помощника это chrome extension который позволяет посещая какие либо сайты виде на них товары видеть сколько эти товары стоит на авито и этот сервис ходит в поисковый сервис они в монолит а также есть официальный telegram.bot это будет замечательно тем что у него достаточно простой интерфейс в нем есть геолокации и есть поиск по радиусу и он тоже ходит в поисковый сервис как работает поисковый сервис в нем есть набор агрегаторов каждый агрегатор выполняет некую бизнес слойку связаны с обработкой выдачи то есть он может это выдачу каким-то определенным образом сформировать запрос поступает на планировщик планировщик а критерию запроса с точки зрения его параметров или если в самом запросе указан какой агрегатор нужен выбирает агрегатор агрегатор идет сфинкс и получив от сфинкса ответ формирует выдачу отдается этот ответ клиенту в данном случае запрос был снаружи облака в котором работает наши поисковый сервис и также возможно например вариант когда какой-то другой сервис обращаются в поисковый сервис например через телеграм бота он делает запрос но идет уже в другой агрегатор потому что это другая бизнес-логика получает ответ и таким все таким опытом все это работает как работает асинхронное выполнение запросов на агрегаторе агрегат состоит из нескольких профилей а прочим это грубо говоря сущность в которой можно получить объявление какого-либо типа или каким-то определенным способом ну например это можно объяснить через налоги того что на али ты есть премиум vip и обычные объявления профиль получает запрос от планировщика и сразу на нескольких проверять эти запросы выполняются параллельно а профиль имеет внутри себя драйвер который физически обращается на нижележащий уровень нам случае the sims но это может быть любой другой носитель информации и дальше отдается ответ сейчас этот сервис бою он обслуживает сто процентов нагрузки за небольшим исключением нагрузка который он держит это примерно 140 р п м в секунду рпн производительность получается такая что в этом 795 процент 95 процентили у нас от 60 до 120 миллисекунд и 99 процентиль у нас на уровне 150 200 миллисекунд и того по поисковым сервисом он написан на гол young разворачивается в кубер нить из агрегатора синхронно работать с несколькими профилями профиль работает за данным драйвером драйвер обращается к одному источнику данных например свинца количество запросов которые обслуживают наш северус и да там 150 крпн в данный момент и личности 95 шестьдесят сто двадцать миль секунд 9 150 и 175 очень интересный вопрос это внедрение сервисов уже существующую рабочую систему проблема двойного функционала достаточно очевидно нам приходится поддерживать 2 веку до базы которые должны выполнять одну и ту же задачу нам нужен столбик мы назвали его соломкой по принц того что подстелить соломки ну и нам нужно управление трафиком желательно чтобы она была быстро через дашборд сейчас мы с вами посмотрим как работает наша соломка запрос приходит соломку видит вызова соломка стыдно работает внутри монолита и она может сделать дальнейшей вызов либо в новый поиск либо в старый она делает вызов в новый поиск новый поиск и его отрабатывает и в случае успеха отдается ответ все хорошо но может быть плохой ситуация что что-то свалилась например какой то legacy не было учтено либо не ли зова на какой-то функционал внутри поискового сервиса и запрос испарился тогда мы обязательно залакируем такой запрос соломка выполнит его в старом поиски старые поиск из монолит обратиться в сфинкс и ответ уйдет клиенту клиентов ничего не почувствует достаточно очевидная схема но всегда интереснее на практике посмотреть что бывает вот здесь отображен интересный случай наши отдел архитектуры постоянно совершенствует наше облако юнит его делать его более надежным но на каком-то этапе были проблемы что когда обслуживалась но да у нас пошли ошибки достаточно большой интенсивностью это было сто ошибок секунду при этом у нас резко поднялся в пенси на сервисе видно пике а соломка замечательно отрабатывала эту ситуацию итоговых at&t по ошибке были на прежнем уровне этом объединиться ошибок на все vito и наших ли посетитель ничего не и не заметили теперь самое наверное интересная тема это автоматизация экспериментов мы хотим иметь возможность быстро развивать поиск для этого нужна соответствующая инфраструктура что мы сделали у нас монолите на настроена автоматизация б тестов без вы к так монолита мы можем настраивать новые группы ну к примеру есть даже борт в котором можно добавить новые группы и они тут же отобразятся здесь отображена в состоянии когда у нас нет никаких тестовых групп есть контрольная группа и группа без разметки так называемом группа которая не фиксируется никакой статистики нам пришел запрос монолит а pt100 тристана об считалось распределение куда отправить запрос запрос слушал примеру в контрольную группу и канал который отрабатывает поиск он обращается поисковый сервис поисковый сервис знает что нужно обратиться в какой-то агрегатор и отдает ответ теперь мы разработали что-то новая новую формулу ранжирования и для этого нам нужно сделать следующие поисковом сервисе выкатить соответствующий агрегатор здесь он помечен агрегатор 2 создать новую группу и дальше по нам приходит второй запрос который будет обрабатываться этой группой он уходит на поисковый сервис сервис его отрабатывает и отдает ответ при этом нам не нужно такие совершать каких-то сложных настроек экспериментов мы это можем делать быстро нам нужно только реализовывать поисковым функционала выкатывать его в поисковый сервис дальше мы можем создать еще один агрегатор и так далее в общем все на правильно то чтобы нам интенсифицировать развитие поиска и иметь возможность быстро достигать успеха и того по инфраструктуре поиска что у нас есть у нас есть кластер серверов с винкс 3 этот кластер у нас держит 13 крп с swiss pelle запросов и на нем средств на 40 миллионов активных объявлений на нем работает сфинкс 30 как говорил он стабилен радует своей производительностью и и на рынке доступны в открытом доступе на радио открытом доступе что касается сервисной архитектуры у нас есть сервис распознании фото остаток поисковым бэкенда то что в монолите на php и поисковый сервис есть сервис это помощника и сервиса telegram.bot также мы умеем обрабатывать онлайн статистику ну к примеру не дожидаясь того как появятся данные пвх и персики мы можем настраивать даже борды с оперативными данными под капотом там получается у нас реально внизу crack house мы работаем скр экстремум нашим мы настраиваем нужные нам консилеры и через эти консьюмер можем писать по протоколу 100 т.д. и и фиксировать те или иные агрегировать или иные счетчики видеть их тут же в даже бурды grafana выводы которые можно сделать там за последние год получить на провинции системы разработки поисково функционала мы получили возможность проведения быстрых и гибких экспериментов нас увеличено количество способов доставки польской ценности что же будет дальше дальше мы будем продолжать выносить из монолита то что осталось это рендеринг это фильтры и мы будем работать над повышением качества поиска продолжать радовать наших посетителей надеюсь вас тоже спасибо вопросам здравствуйте тему очень знакомое вот здесь этим вопрос вот пусть и фильтры а в чем разница фильтры тоже вроде поиск да это поиск но это отдельная скажем так набор параметров которые при существу или иной категории можно просто считать каким-то отдельным набором по которому осуществляется поиск например в категории автомобиль одни фильтры в категории личные вещи другие фильтры то есть это не то чтобы там ты можешь этот фильтр вы думаете использовать любой категории нет это достаточно жесткая иерархия ответила нет фильтры это просто какой-то набор атрибутов характер этой конкретной предметной области а поиск это такой generic по набору фиксированных атрибут которые есть то есть поиск большого счета это получается интерфейс классов да а фильтры это я имплементация или как поиск можно рассматривать в различных ситуациях как мало тексту поиска дался есть поискового запроса на поисковым запросам может они быть можем просто навигировать по каталогу переходя из одной категории в другой при этом автоматически в поисковую систему при нажатии на куриную ссылку будет передаваться нужный набор параметров и соответствующих фильтров и выдача будет меняться и она будет именно той которая должна быть в этой категории то есть если человек размещал разместил объявление в этой категории это отделение там и будет за тыщу такого просто не было такого слайда вот как бы увидеть как выглядит вот этот голос тучи общение с сервисом поиска но идет через некая api то есть а как выглядит вот запрос в этапе то есть это какой-то кусочек что джордж конечно есть в нем есть некая структуру придуманный нами которая обслуживает там сугубо определенную бизнес-логику в ней есть от текстовая часть например есть часть которая нужна для поиска по фото чтобы вектор передавать есть часть фильтров то что касается там фильтр по цене есть параметры которые присущи то ли иной категории ну структурное то там открыто иерархия можно так себе представить там основные компоненты я назвал будем спасибо спасибо за доклад извините если я может быть как бы замечтался и не заметил так что же с пианино был ли слайд в котором объясняется почему теперь не мы не грузчиков еще успею которое перевозит пианино а сама пианино нужды есть релевантность прошел как она есть то есть ну там кубики агрегаторы тут в них вот их была функциональной заложено или же вот как достигается релевантности то есть получается либо бренд ну или группу как-то на выискивает и потом дополнительно фильтруется так наверное ну технически выглядит следующим образом есть некая весовая функция которая учитывается те или иные параметры пакет факторы так называемые и она формируют конечное число которых который участвует ранжирование также в ранжировании участвует и свежесть свежесть то есть если ваше объявление устаревает она уходит назад это весовая функция такая наверно секретная ну я наверно не могу не говорить честно говоря как в яндекс у них есть функция с большим количеством параметров спасибо здравствуйте всего за доклад скажите просто как вы храните поисковый индекс в cabernet и вырезать или он у вас память как вы реплицировать между машинами хорошего и сорос сразу человек задумался можно ли в кабинете содержать индексы мы не держим индексов кабинете у нас с милицией живут на физических машинах в кабинете у нас разворачивается поисковый сервис который собственно обрабатывают логику поиска а нет планов делать спасибо нет такой вопрос а как вы делаете по перекликаться на связь и я могу рассказать вкратце два года назад я участвовал реализации так называемая rt яндексе ра это компонент который обеспечивает моментальное попадание объявления выдачу после того как объявления становится активным то есть его можно проиндексировать этот момент написано blank он имеет внутри себя две очереди первую очередь доставляет данные которые можно проиндексировать сам индексирование происходит с базы база puzzle is индексирование может быть двух типов собственно говоря real-time когда приходит отдельные события тут же их отправляю на облейте здесь там нет от этих есть и replace есть белита отправляя их тут же на конечные сервера либо можно совершить так называемый rebuild то есть построить plain яндекса и и тепла индексы раздать сервера и дальше продолжить уже в тарелками обновлять 2 же очередь которая последовала соединена с 1 она как раз и занимается тем что в онлайне раздает запросы всем серверам эти мужем первую очередь получает данные с мастера то есть когда нас поменялся ой там он приходит к нам кладется нашу базу и дальше второй очереди создается события по которым я могу это той там уже извлечь из базы и раздать на конечно сервера если у меня что-то будет не так например не дошел запрос или ошибка в конфигурации что-то поломалось у меня данные есть мази я могу всегда сделать rebuild 40 миллионов объявления это не такое большое количество данных чтобы за раз это проиндексировать ну а нам конечно требует времени но это не дни на и создать платили с раздать их и продолжить дальше то есть как таковой синхронизации какой-то механизм который обеспечивает в онлайне консистентной его нет есть файл огера который отслеживает поломалась лишь тот а может кто то запрос выполнился неправильно и пуловер это фиксирует дальше уже происходит так называемый rebuild перестроение индексов и раздачи их на конечный сыра земля вы используете статические индексы индексы комбинированный подход получается по windows и можно протащить в рты работать с ними уже в онлайне раз спасибо за доклад хотел знать о как вы оцениваете качество поиском то есть это не просто там количество на них объявления но еще там какая-то relevant в автоматическом режиме и смотрите это если во время пытаться рассказать разные подходы были в начале у нас практически не было оффлайновых оценок то есть мы действовали через конечно и целевые метрики которые могли замерить на аудитории делать маленькие оба теста вот то есть мы выдвигали гипотезу проверяли ее и будет как правило была очень простая тривиально проверяя приняли ее в онлайне и дальше принимали решение сейчас уже появилась брился оффлайн мы умеем оцените объявлений в оффлайне состава работать уже более продвинутым способом подробности хочется узнать мы используем к луку и отсюда говорю с другой стороны и делаете ли вы и если у вас планы делать анализ естественного человеческого языка например чтоб я искал машину без красных колес то есть еду глаза голос разных голосовой поиск нину словами как бы обычный запрос просто ломбарда у нас и план есть это как называемые колдун чеки когда колдун чеки про я понимаю это набираешь голубой цвет я должен распознать то что машина должна быть голубым цветом а ну я например написал хочу там машину не не просто голубого цвета потому что это я думаю сейчас работает а например не голубого цвета сейчас найдет голубые машины наверняка это ты хочешь если ты хочешь сейчас что-то исключительное ты имеешь вас такую возможность а можешь минус поставить в поисковой строке это не документированная функция но она есть пока но возвращаясь к первому примеру машина без красных колес и тоже не получится сделать без красных колес да ну я понял что ты предлагаешь мы вот некую семантику не клиники перетряхивать запросам мы планируем может быть не прям не в том виде как это сейчас сказал да без колес но мы планируем где-то делать спасибо спасибо за доклад на сколько я понял теперь им мобильные приложения тоже минуют ядром монолит попадают сразу на поисковую машину до потом сфинкс ну на поисковый сервис правильно понимаю но не совсем вопрос задать разу в догонку дома фонд он тоже начал пользоваться вашим поисковым сервисом домофон два фунта отдельно отдельно поиску но работает на эластики вот то что касается то вопросы про мобильное приложение смотри мы из монолитов функционал пока еще не выпилили собственно соломка она работает с этим функционалом если вдруг что-то назад или то есть мы это рациона двигайся того момента когда мы откажемся от старого функционал бы просто вырежем поэтому есть часть php кода которая работает который ну никуда никуда еще не делась есть часть кода которая она не будет выписываться например работа с фильтрами она переедет в отдельный сервис вот и получается что приложение она и все равно идет монолит но логика низко уровне связано с формированием союз цель запроса логика связанная с тем как там замешать выдачу она отсутствует монолите там более легковесная логику монолите спасибо за доклад как раз вопрос возник у поводу фильтров я как правило не у вас отделены от поиска и тогда вот интересно как они отделены если сфинкс например при поиске нашел там ну например тысячу результатов да вы что берете тысячу иди шик пересылаете в сервис который занимается фильтрацией и он из 1000 идиш их отфильтровать это элита нитками роста другого работает как из тарелок есть дерево категории есть параметры у нас компании это называется инфо модели есть словари который эту модель реализуют виде некой логике то есть я могу а индюшки параметра узнать что это за параметр что он делает я могу узнать если он в поиске и в поиске тоже бил биться набор параметров при индексации и он уже есть у каждого объявления во время поиска то есть когда шляется поиск запросе поступает к текстовую часть манишка категории так и набор параметров соответствующие этой категории и он есть в яндексе по этому соответствую осуществляется фильтрация внутри свинца походов наружу нет а то есть все таки сама фильтрация осуществляется с ним сада тогда что сервис фильтрации собственную нет я не говорил про сервисы фильтрации но я сдал на d в отдельный сервис уедет не только сервис фильтров это сервис который должен сказать у меня есть игру говоря такой had to paris крест я хочу получить набор фильтров который должен применить для поиска вот поэтому хотя перекрестку дальше формирую на основе этих фильтров запрос поисковый сервис и я понял это сам набор только которая называется до сего добрый день я спала скажите пожалуйста а вы пробовали самого индекс его в контейнер и класть эту класть индекс но вкупе с кластер положить укрыть его с яндекс отдельно лежит у нас лежат сэмплы на которых происходят тесты кубинец но индус туда класть нельзя а можете рассказать какого ваше мнение почему ну потому что сервисы которые работают кабинете to stay close сервис принципе от этого можно реализовывать но это всегда геморрой это некое сложно ли вами о спирте стенд во львове есть на но это всегда сложности то есть по возможности в кабинет лучше реализовывать стоило систему окей спасибо спасибо за вопросы и числа вопрос человек на самом деле мне понравилось даже два вопроса вот это про индексацию то что сорта яндексе рам из тем ну вот кстати вопрос насчет держать почему нельзя держать тоже как бы похоже вопрос почему нельзя держать индексы в границы это же не сложно выбрать честно говоря может и разыграем мы твоим людям дадим мы дадим наклеечки твоим людям хорошо давайте тогда первое место за индексацию а потом второе место за погонять"
}