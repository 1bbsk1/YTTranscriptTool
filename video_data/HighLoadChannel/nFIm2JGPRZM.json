{
  "video_id": "nFIm2JGPRZM",
  "channel": "HighLoadChannel",
  "title": "Знакомство с NGINX Unit / Игорь Сысоев, Николай Шадрин (NGINX, Inc.)",
  "views": 9050,
  "duration": 2140,
  "published": "2017-12-11T00:41:18-08:00",
  "text": "вся другой профессии да у нас как видите накладка за накладкой в том недели с нашим докладом первоначально его должен был начать планировать что прочитает в рейтинг бартенев но он заболел внезапно я должен был выступать в роли конферансье вот но теперь придется всю работу делать мне поможет мне коля шадрин он сделает дыма сессии у него это получается гораздо лучше он и делать несколько раз я ни разу итак сначала немного кампании 2011 году мы основали компанию сейчас сих пор она существенно выросло в нас 4 офиса в сан-франциско в москве в ирландии в корке в сингапуре буквально недавно коли сингапуре 180 сотрудников в основном это продавцы не не разработчики разработчиков у нас значительно меньше что мы делаем мы продолжаем разрабатывать джонс open source как это ни странно для многих мы делаем коммерческий продукт engine x плюс и недавно вас появилось несколько новых проектов один из них индекс amplify это система мониторинга сбора статистики и еще один проект дженкс юнь про который собственно сегодня буду рассказывать мы его представили на нашей конференции в портленде 6 сентября в этом году это первая бета начале моего разрабатывать именно в таком виде как сейчас он планируется в начале этого года и вот примерно за девять месяцев мы сделали этот проект она концертный лицензирован под лицензией apache 2 0 у нас нет никакого неприятия слова apache слову на сайте и юнит engine x.org вы можете посмотреть документацию эту проекта значит надо момент это application server для трех языков питона гоу и печки мы планируем поддержку большего количества языков и в том числе больше вкуса навести за пределами applications эльвира ключевая фича ключевая особенность этого проекта заключается в том что он динамики конфигурируемый то есть конфигурация в виде статического файла в принципе нету то есть все это заливается через либо unix socket либо тисе пи socket по протоколу ftp виде джейсона маслом и так далее все как сейчас модно арте труда выглядит проект следующим образом куча процессов схема сложные возможно даже смутно выглядит поэтому мы ее разобьем на части и так как я уже говорил конфигурация делается с помощью джейсона удаленно она вливается в специальный процесс контроллер который в принципе не должен быть доступен извне то есть он может быть защищен там firewall ми сейчас никакой аутентификации не делается но естественно это будет будет поддерживаться и цель будет поддерживаться authentication по сертификатам так далее контроллер анализирует конфигурацию портреты и проверяя тую валидность и после этого заливает в основной процесс и в процесс раутер основной процесс занимается запуском всех остальных процессов этой если процесс который работает под рутом все остальные работают под не привилегированными пользователям причем пользователи разные основная работа происходит в процессе раутера значит он платит рейдовый но каждый thread работает со своим соку когда ты рад работать со своим собственным и полом какую но все что есть на данной платформе мы используем каждый thread обрабатывает тысячи одновременно дней в 8 chrome нам режиме с помощью и пола какие так далее трека используется для того чтобы утилизировать много процессом на системы вот но есть как бы сервисный главный тренд который занимается запуском этих трендов остановка и так далее значит главу вся работа апликэйшен код пички питон запускается в отдельных процессах под разными пользователями пользователи могут быть может быть то же самое что и раутер процесса может быть другие соответственно взаимодействие между ними осуществляется с помощью соки декстера и дополнительно сегментами разделяемой памяти причем эта память она является приватной для каждого для каждой пары процессов то есть раутер процесс и там допустим 30 облигациям процессов для каждого из этих 30 процессов будут свои собственные сегменты разделяемой памяти другие процесс туда залезть не могут если процент application process падает то все это чистится и никак не влияет на работу других апликэйшен процессоров и на сам собственно раутер значит каким образом мы запускаем интерпретаторы дефлятор запускаются после того как приходит запрос от клиента он приходит в процесс раутера раутер слушает там уж тебе про порту 80 или чего там с configure мы если облетевший ещё не запущен то запрос посылается в главный процесс главный процесс сборка это процесс и рабочий процесс и подгружать туда модуль для дан для нужен с нужным интерпретатором ну допустим там печкой 5 вот после этого запускается весь остальной код изначально бою на система была придумана для того чтобы было удобно пакетирование нет в дистрибутивы linux и другие опцион системы вот но как в качестве побочного эффекта получилось так что юнит может одновременно запускать разные версии допустим печь и разные версии питона все это в одном приложении естественно в разных процесса значит все языки интерпретатор которые использую нити можно разделить на 2 группы а те которые можно встроить в веб сервер к ним относятся например печки питон ruby & pearl и те которые как бы сами из себя писали от веб-сервер это например java гол но джеймс не так далее вот для них мы используем другой подход необходимо немножко изменить начну то нужно собрать модуль юниты который будет обеспечивать взаимодействие этого приложения с процессором рау там про утром и поменять буквально там одну-две строчки в вашем приложении то есть место вот три пи пи джей и степи нужно использовать пикачу нет вот при этом вот этот модуль юнит он умеет работать одновременно и в режиме standalone то есть как без роутера то есть вы запускаете как обычного приложения оно если роутер не нашел то слушать там на 80 порту ну в рино указанным портом а если роутер присутствует то все заметить происходит через него апорт уже игнорируется вот ну очень кратенько так документация под есть мы используем mercurial такие старые жирные люди недавно перешли со своей на накидкой мы тоже присутствуем завтра мы планируем ничего не изменилось и планирует свой этап вот в аудитории с такими координатами в 11:01 естественно мы у меня индульгенция ольга будина мы харим вот поэтому sea level при могут слать резюме мне проще всего мне так и теперь собственно как происходит конфигурация потому что возможно вы ни хрена не поняли из моего доклада сейчас коля все это покажет на пальцах и будет более понятно николай шадрин спасибо так будем надеяться что мой микрофон работает отлично так значит что мы здесь сейчас будем показывать нам часто задают вопросы как с юнитам жить как его configure как его собирать вот поэтому проще всего сделать сделать следующее давайте я зайду директорию посмотрим что у нас есть я скачал исходники напрямую с гитхаба и давайте сразу посмотрим на возможности конфигурации значит здесь в принципе достаточно стандартный набор функций и когда мы запускаем наши наши функции нашу конфигурацию то что мы соберем мы соберем сам юнитов ский сервер так как рассказывал нам игорь только что уюни то есть разные модули для разных языков интереснейшая вещь это то что конфига надо запускать несколько раз для каждого из языков которые у нас есть то есть для печки мы запустим config.php естественно посмотрим на hell посмотрим какие у нас есть параметры и мы можем запустить наш конфига печки он нас нашел в системе 7 php и все замечательно если вы поставили свой собственной печки можете собирать со своими собственными данными из делая конфига несколько раз с разными значениями конфигов и модулей вы соберете несколько разных модулей для одного и того же языка возможно для разных версий возможно для разных патче и может быть для тестов или для чего вам понадобится эти разные языки такая же ситуация с питоном вот в данном случае мы что сделали мы набрали конфига python и он нас нашел замечательный питон 27 в этой в этой нашей убунте этого нам как бы недостаточно у нас есть питон 27 а есть еще питон 3 5 значит что мы сделаем здесь мы наберем can figure python и сделаем ему конфиг вот с этим самым названием python 3 5 конфиг в общем что у нас здесь получилось мы с configure ли его для версии 352 и теперь у нас модуль который появится это будет модуль для модуль который называется python 3 5 уже интересно конфигов принципе то же самое вот моих с configure ли мейк мы уже сделали поэтому давайте я вам просто покажу что у нас собралось в директории build у нас собрался сам демон и разные модули к нему когда мы ставим модули для печки питона это файлы которые вот-вот здесь расположены но когда мы устанавливаем модуль для год ситуация там несколько другая модель для go надо поставить в наш гоподь который у нас уже обозначен так как у нас времени нет аксель не так сильно много поэтому давайте двинемся уже дальше и посмотрим что у нас запущена так собственно процесс юнита у нас не запущен давайте его запустим и вот он на стартовал значит что у нас появилось нас появился главный процесс юнита появился контроллер и и раутер значит запущена они у нас уже под разными юзерами все в этом замечательном что я еще хочу показать это нет нет стад так одной секунды я его немножко неправильно запустил я хотел запустить юнит с определенным control соки там сейчас мы его запустим так чтобы наш api для управления слушал на вот допустим на таком порту значит в продакшене так не делайте естественно потому что он будет слушать сразу на все айтишники открыто и без аутентификации в продакшене вы его закроете за firewall начнёте слушать нас то 27001 или слушать на unix сокете то есть это естественно надо применить какой-то уровень безопасности к этому для демки поступим проще значит открылся у нас это замечательный socket вот он у нас слушает и что мы сейчас делаем мы на него сходим к орлам туда и мы видим что у нас замечательная пустая конфигурация внутри я приготовил конфигурационный файл который очень простой в конфигурационном файле мы определяем наше значение listeners на вот такой вот порт это означает что юнит будет слушать на этом порту и все запросы по эстетике приходящие туда будет отправлять вот в такой вот applications applications определен интересным образом это у нас и апликэйшен php с максимумом тревор кира дальше указанной директории пользователь группа и различные другие параметры значит все достаточно просто возьмем этот файл и засунем его в этот api прямо простым запросом под замечательно значит если мы сейчас сходим на наш api еще раз мы получим как раз тот же самый конфиг то есть все у нас там появилась если мы посмотрим в процесс и ничего не на форка лась мы еще пока не сходили на этот порт давайте сделаем это давайте сходим на этот порт 8 300 и там живет наша печки info ура она работает сервер api написано unit давайте сходим обратно и увидим что у нас появилось приложение печки что здесь интересно и мы с configure новое приложение у нас не рестарта вались не роутер и не контроллеры ничего мы не делали никакого дела до зубов в любой ситуации и мы запустили приложение печь бешеная под пользователем php она работает и живет все прекрасно давайте сделаем следующее добавим еще одно приложение которое у нас есть питонов ская у меня для этого приготовлены еще вот такой файлик это уже не целый джейсон это уже его отдельный объект соответственно далее делаем следующее мы возьмем мы возьмем этот файлик у меня тут приготовлено команда для этого и файл мы положим по уралу applications с вот этим его именем python 1 вот мы его запустили что у нас сейчас произошло у нас сейчас создано два приложения но только один лист н.р. значит мы сейчас можем сделать следующее мы можем либо создать новый леса на либо переопределить текущей на новое приложение кто хочет чтобы мы создали новый лист in our новый порт так а кто хочет чтобы мы переопределили текущей порт вот все хотят чтобы вы взяли и переопределили вот этот порт 8 300 в и поставили туда приложение python 1 это очень-очень просто мы сделаем следующее мы давайте давайте начнем с нуля так проще это у нас будет запрос put внутри мы положим слова python 1 и положим его в наш api в lies lies in с и в лесу нирс у нас соответствующий порт 8 300р а я понял я порт забыла здесь указать 844 3taps у нас появилась у нас ошибка потому что я не указал вот здесь параметр дата то есть здесь я должен сперли показать минус d кстати сообщения об ошибках классные вот хорошо запустили python один у нас теперь на борту 8 300 должен естественно жить запускаем вот он мой питоновский скрипт акт который показывает версию питона теперь и теперь еще одна интересная штука питонов у нас в системе 2 unit посмотрел на то какие у него есть модули и так как у нас тип приложения был указан питон без версии мы запустились мы запустили вас версии которая имеет самый высокий номер то есть 3 5 и так далее если мы возьмем то же самое приложение например давайте сделаем так возьмем наш файлик и вот здесь из типа питон 3 поставим тип питон 2 вот возьмем тот же самый файлик и положим его давайте в другое приложение питон 2 сделаем вот и если мы сделаем то же самое у нас ситуацию тоже то же самую вещь поставим приложение питон 2 и в тот же самый порт 8 300 вот обновим его и у нас сразу же наше приложение начала работать с портом с версией 27 12 на том же самом порту без каких-либо изменений вот давайте обратим внимание на то что у нас происходит с процессами с процессами все тоже достаточно интересно у нас мере стартовал ся не не контроллер не роутер не главный процесс соответственно все что у нас слушала на этих портах она продолжает также слушать все запросы которые у нас выполнялись на старых версиях нас на старой конфигурации они продолжают выполняться и у нас получается совершенно интересная ситуация мы можем рикон фигуре этот сервер настолько часто насколько нам вздумается это становится очень удобным когда вы начинаете что-то быстро менять в приложениях либо переходить между версиями приложений и еще интересно между версиями языков вот сейчас мы взяли перекинули питон с версии одной на другую и перебросили там с питонами печки когда нам собственно вздумалось хорошо давайте сделаем еще одну вещь которая очень интересное я вам покажу как у нас выглядит файлик с кодом горного приложения и сейчас мы скальпелем сейчас мы соберем гошена и приложение для юнита и запустим его в этой же самой системе с рпк и у нас у назывался хэллоу . значит что мы сделали здесь мы добавили пакет юнит вот сюда в импорт и сделали очень просто вместо http и сенсоров мы сделали просто-напросто использовали моделью нет с теми же самыми параметрами это у нас тоже совершенно простой hello world и мы его уже с с configure ли и собрали здесь я поступил следующим образом я не стал класть конфигурацию для этого определенного приложения в файлик я ее просто напишу сразу параметрам вот сюда в perl так запустили отлично далее что мы у нас делаем мы должны это приложение создать собственно можем использовать тот же самый порт можем открыть новый значит здесь так как у нас времени мало я просто сделаю тоже самое на том же самом порту я поставлю наше приложение go хеллоу ворлд и сменим его вот здесь на этом порту вот так у нас раз появилась уже совершенно новое приложение нам часто задают вопрос зачем в языке go сервер приложений тут просто приходят люди так спрашивать ребята на фига вы это сделали задачи очень интересное решаются этим у вас появляется один и тот же ищите пестик для разных типов приложений и единая методика конфигурации причем совершенно динамической конфигурации вне зависимости от того какой платформа вы используете у вас может быть печки питон go в скором времени там же будет руби но до java и возможным множество других языков вот собственно это то что я хотел здесь показать и есть еще один момент который перед тем как мы перейдем к вопросам будет интересно посмотреть вот мы сейчас создали кучу этих приложений но их же надо и чистить и удалять тоже давайте выберем какое приложение мы хотим удалить грог громче я не слышу по моему все говорят php ok все отлично давайте сделаем следующее тогда мы подойдем сюда на applications здесь у нас соответственно приложение называется здесь нам это не нужно у нас запрос будет делить applications печки ой опять и печатался так пить и а точно печки инфа по право раз она исчезла и у нас все получилось печки удален спасибо по моему у нас остается буквально какая-то минутка на вопросы значит что у нас интересно можно еще раз слайд запустить с ресурсами из информации ага спасибо значит у нас будет митап завтра в комнате а 1.3 надеюсь все смогут его найти и там мы сможем ответить на множество вопросов я тебе помогу с вопросами просто я тебя не унижения тем более вот максим готов подвинуться со следующим докладом для минут он тебе дарит смотри улыбается отлично друзья чтобы задать руку поднимайте руку чтобы девушка с микрофоном вас видела и действительно во время вопросов-ответов можно спокойно выходить из зала и заходить в зал чувствует себя свободно так первый микрофон есть пожалуйста вставайте представляйтесь и понеслась друзья только кто выходит будьте добры и делать это молча спасибо спасибо за доклад вопрос простой а как обновлять сами приложения то надо будет перекомпилировать эти модули апликэйшен и или как ну ты вышла минорной версии этом печки новое что нужно сделать будет так ну да естественно вам нужно собрать 1 печка и скорее всего это будет пакет в дистрибутиве и до нужно нужно и прекрати говорить юнит чтобы он подхватил это печки этот модуль то есть перехожу управление тут операции делает это море то можно еще интересным образом поступить вот у вас вышел этот новый модуль новое приложение но моя версия хорошо создаете новый объект приложения в unity совершенно новые с параллельно со старым создаете новый порт на новую на новом порту все тестируете гоняете все как есть потом уже существующие worker и существующий объект перебрасываете на рабочий порт все онлайн и проверяете смотрите если что-то не понравилось а перекидываете обратно опять же без каких либо рестартов а вы какой то веб морду не руки для все это настройки веб морду да вам морда планируется но в принципе поскольку это джейсон то веб морду можно как бы в морду может писать что угодно то есть здесь сейчас показано то как обычно configure мм и то есть когда мы разрабатываем карлом очень удобно светодиод кроме того мы планируем еще come on line утилиту которая будет каких-то случаях удобнее чем курс то есть то же самое из командной строки можно будет редактировать команда будет даваться unit собственно поэтому тема называется ее нет д они юнит вот все хотелось узнать первое я здесь не планируется или может быть есть уже такая вещь как поддержка цепочек вот таких приложений то есть как при использовании в апликэйшен защищать серверах chain фильтр и все такое но мы планируем там появится еще только секция раутов который позволяет разруливать запросы по порта по углам по хостам и так далее и в том числе она будет может передавать запрос в одно приложения получать из него ответ и перри рулить его другое приложение то есть вай-фай причина мы планируем спасибо еще такой вопрос приложение которое вызывается из юнита как там skunk anansie и тайм-аут и все такое вот что то вот такое конко россии чем ну это два отдельных как бы вопроса до могу ли я в приложение которое вызвал юнит то есть не вызвал куда is you need a были переданы какие-то там вот данные до сделан запрос порождать танки это потоки что-то делать еще и может ли данное приложение работать скажем так долго до приложи но смотрите значит сейчас например если мы говорим а печки и питоне то там просто задается фиксированное количество worker of для каждого сергей как бы это при for king downy тепло но на данный момент это не при for каунда ман мо планируешь разные режимы и при for key on demand там минимум максимум там spr процесс и так далее если мы говорим ага у того она ну как правило запускается одно приложение которое внутри себя там порождает кучу гору then вот и там уже но это можно как бы там у нас меньше власти над приложением то есть если с питоном печки мы больше можем управлять the cow java чуть сложнее спасибо большое и последняя авторизация от при вызове реконфигурации каким-то образом вас поддерживается или это отдельные сейчас авторизации никакой нету то есть мы планируем добавлять во первых вот управляющие socker socker контроллера он должен быть защищенным и с элем сейчас этого нету и унификации соответственно либо там по basic тоже называется happy basically фикации либо клиентские сертификаты цель вот либо просто адресанта есть там как угодно стоит планируется до то есть на данный момент скажем для тестирования ну скажем если вы хотите тестировать в более-менее в продакшен среде то лучше управляющий soccer использовать не для тени типи ну или записи защищать его firewall мид там и так далее а это использовать у них соки воды слота собирается ли их sockets как раз спасибо за доклад вопрос по удалению старых форков ненужных уже приложений то есть я вас понял то что можно сделать еще одно приложение допустим на которые мы обкатываем какую-то новую фичу потом убедившись что у нас все хорошо мы можем подменить наш порт рабочий на мэри приложение подменить вот как быть со старым приложением то есть который у нас руками его убивать или будет какой-то сервис или какой-то помощник который мы через старых форков да сейчас нету но в общем вот в этой весной конфигурации планируется еще отдельные такое пространство имен actions то есть там можно убить перегрузить какие-то приложения прибить приложения то есть все это будет это будет автоматически при ненужности уже приложения не при ненужности а на оси и сейчас вы автоматически то есть как только вот этот приложение мы удаляем из конфигурации то процесс пропадает это руками на было лет руками удалять потому что мы не потому что мы не знаем когда вам действительно захочется произвести именно это удаление может быть вы хотите чтобы она там полежала audi какая-то development версия покрутилась на основном сокете понял спасибо как только есть корпорация попадает приложения пропадать и процесс связан с этим приложением друзья будьте пожалуйста готовы потому что сейчас все вопросы не зададут но следующий доклад тоже джинкс поэтому после него можно задать вопросы и завтра mytab давайте ещё два вопроса вот 1 и 2 остальные остальные после доклада ином этапе пожалуйста здравствуйте а вот такой вопрос что если я делаю новую конфигурацию я понял шо проверить ну рабочий она или не как обычно запускаешь да про синтаксис ч как вот в этой схеме когда я сразу запихиваю веб-сервер как не проверить может быть там есть ошибка может быть там что нибудь работал смотрите значит когда вы синтаксически и логически проверка делать внутри контроллера то есть вот вы загружаете туда конфигурации варьируется если она с точки зрения контроллера правильная ну там совпали все имена там и так далее вот нету синтаксисе тактических ошибок то дали то применяется эта конфигурация если же конфигурация неправильна это продолжает работать старые то есть такой явное проверки как в engine.exe там минус -3 мне нету но он будет говорить что вот в этом в этом в этом ошибка да но вот вы видели коля там ошибся в конфигурации и там достаточно подробно и вот сообщение о том что ну а на спицы фирм для того чтобы мы можем было показать web-интерфейсе то есть в принципе человек это прочитает роботу будет легче сообщение настолько подробно даже показывает в каком символе по счету произошла ошибка спасибо добрый день большой вопрос касательно того что будет если процесс приложения которые запустили упадет главный процессор перец стартует будет при этом как бы на все остальное то не будет влиять но при условии что вы там с базы данных проблем или с точки зрения юнита должно все про чисто там дальше будет вспомнить пытаться поднять и следующего просто показывает что если я хочу новую версию приложения то я ну поднимай его на другом порту потом переключая сторона новый можно ли как то делать горячий диплом без подмены портов то есть чтобы я новое предложение закидывал старые connection и поступками завершились переходили на новое приложение ну в принципе это если у вас нет никаких там сильных зависимости да то есть вот но контакте если ваше приложение сразу при старте варки разрушается все на там все питоновский модули которые мы нужны тогда естественно вы можете подменять томатом арно там сменам как смена каталогов или как-нибудь еще новые процессы будут запускаться из нового приложения ну вот но то есть пока мы эту тему деталь не прорабатывали но общем все зависит от самого приложения и поскольку минуту подарена еще остается давайте последнего про красиво за доклад меня зовут али вопрос по поводу языка java да то есть юнит сервис в итоге просто осуществляет проектирование в апликэйшен сервис java или это все-таки будет уже модуль как applications серверы знаете джавой мы смотрим пока что делать у нас экспертов компании по джаве нет если есть мы захотим с удовольствием хороших экспертов которых есть базовое понимание все и хорошо подбежали вот значит и значит сейчас мы планируем его делать не устраивать как это сделано для питона и либо печки а именно по также как сделано в кого то есть делать сам модуль там джаве насколько этом огромное количество стандартов коннекторы но изначально будем делать примерно как сделано в том какие то есть делать свой connector java будет запускаться отдельно как гол сейчас то есть это будет не встраивание в юнит как бы добавление модуль его в приложение которое будет соединяться соединить его с юнитам то есть это при конечно себе получается да спасибо ну и кстати для такого для такого вопроса и для разных подобных вопросов еще есть метод можно зайти на git хоп в раздел и shews создать там вопрос и вместе со всем остальным комьюнити это обсудить игорь сысоев николай шадрин спасибо"
}