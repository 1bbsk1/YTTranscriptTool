{
  "video_id": "HP1Sa2HtRPM",
  "channel": "HighLoadChannel",
  "title": "Новые технологии репликации данных в PostgreSQL / Александр Алексеев (Postgres Professional)",
  "views": 5893,
  "duration": 3149,
  "published": "2018-08-16T04:03:49-07:00",
  "text": "меня зовут александр и в этом докладе я хотел бы поговорить запас gres из репликацию в нем и новые возможности которые появились в подброс 10 который вышел то ли в октябре то ли около того я пытаюсь потому что там была серия bad например приблизительно в октябре пара слов о себе картинка наверху это компании где работаю под 1 professional замечательная компания занимается консалтингом по по сбросу а также разработкой под него если вдруг в полюсе escape фичи которых вам не хватает картинка снизу она не имеет ко мне никакого отношения она тут так чисто случайно вот но если вам вдруг хочется такой же модную картинку себе на laptop или на холодильник то тут я ставил наклеечки подходите берите я хотел бы также сказать у меня мне нравится общаться с аудитории во время доклада то семейные не нравится как бы говорить в одну сторону поэтому вы в любой момент не стесняетесь перебивайте выкрикиваете там дополняете все что угодно вот мне такой формат комфортнее и чтобы никто не бегал к вам с микрофоном я буду это повторять в микрофон поэтому на видим все будет значит то что в этом докладе будет что не будет во первых в нем не будет там модного мучительного пересказа документации в нем не будет там огромных конфигов на полэкрана почему потому что во первых организаторы холода очень просили так не делать во вторых как бы по собственному опыту это очень тяжело воспринимается люди начинают засыпать уходить вот а для тех кого действительно интересует прям как настроить рипли к цию логическую физическую любую прям пошагово со всеми подводными кораблями которые вас ждут в конце будут ссылки на дополнительные материалы там все подробно расписано также я хотел бы обсудить несколько таких но связанных моментов которые лично меня беспокоит понимаете я большую часть карьеры был бы кант разработчикам и я тоже хотел на highload будучи ещё молодым зеленым и слушал там разные интересные истории что например у нас 100 гигабайт данных это очень хорошо у нас 100 гигабайт влезает войдет сервер это максимум а если у нас 1 терабайта нам нужно 10 серверов надо сортироваться и думать про распределенный транзакции ришар дикари балансировку вот я хотел поговорить немного об этом моменте потому что прошло время ситуация немного изменилась до также будет прав и lover как его настроить автоматический фолловер для подвеса что есть для физической репликации что есть биологической а также чего сейчас в подгрести нет во всем этом контексте что дает вам некоторые некоторое пространство для подвига то есть вы можете из этого доклада подчеркнуть какую-то идею для под projector да и вот про то чего не будет я кажется уже рассказал вообще а поднимите руки кто настраивал репликацию в подписи ну так процентов 30 навскидку новый я примерно так да я ожидал ну значит этот доклад будет многим интересно спойлер это был небольшой спойлер скажите такую вещь вот я так специально сформулируем вопрос не очень правильно 2 терабайта данных это много или мало ну хорошо поднимите руки те кто считает что 2 терабайт именно в базе данных без картинок потому что картинки мы очевидно кладем на отдельный сервер там помимо engine x если но речь правая по типичный вот 2 терабайта в типичном интернет-магазине вти потом ozon.ru надо например в типичном новостном сайте lenta.ru например 2 терабайта это влезет в один сервер или мне нужно уже два сервера баз данных поднимите руки кто считает что в один сервер влезает а кто считает что нужно уже больше одного ну да на самом деле большинство оказалась права и да я очень рад потому что был отличный доклад на хеллоу я вчера я же не пункта докладчик и там высказался интересная мысль что мозг человека это умная штука и настолько умны и что она ленятся но слушая нас старается использовать энергию экономно не не тратили in бесполезное вычисления и отсюда следствие что люди они вообще инертны то есть если мы там десять лет назад на хэллоуин слышали что там терабайт надо шарден то когда вот в 2017 году к вам подходит и говорит у нас терабайт данных на душе родители шортить как бы мозг он как бы автоматически 100 байт на душе рвись вот на самом деле уже не нужно то есть если у вас 2 терабайта данных то они помещаются в память целиком как бы это я не понимаю чем вы смеетесь и это как бы не шутка это действительность то есть сервер в амазоне доступен более того я специально походил по стендам там есть ребята которые представляют компании которые занимаются дата центрами которые занимаются физическими дисками физическими серверами и я спрашивала сколько сейчас максимум влезает в один сервер именно дискового пространства сколько сейчас максим влезает в один сервер именно памятью ответ я получил такое что сами диски они довольно дешевые и ограничивать они чисто физически это если мы поставим там например 2 юнита вы сервера рядом с ним 3 юнита в полку для дисков то туда влезает мне назвали цифру и 950 примерно терабайт в следующем году появится более объемные диски можно вместить в один сервер полтора петабайт а это если мы говорим про хдд да пожалуйста замечание по поводу удобства восстановления что если база маленькая июль легко восстановить там полтора байта восстановить быстрее чем 10 я думаю это правильное замечание вот но также мой вопросам казался памятью то есть если у вас 2 терабайта памяти 4 терабайта на диске то ну да занимать какое-то время там писатель снапшоты и волыну я думаю это будет у меня нет точных цифр да и я вообще не люблю быть таким обсудить в парке почему там же матч марки их чтобы их аккуратно воспроизвести нужно конкретный стенд конкретной конфигурации что намного важнее конкретные админы которые смогли ваш возраст другой базы данных настроить поэтому ну так из в у меня прикинуть трудно будет быстро не будет быстро но я согласен что это может быть верным замечанием нужно на это больше внимание обратить поэтому я не говорю что нужно запускать базу данных там петабайт на более того я знаю точно что под гарсон с этим будет плохо работать если вы за исключением случае если вы только пишите в базу и не удаляйте данные то есть если вы удаляете данные то там начинают триггере ца vacuum vacuum он там берет блокировки но это становится уже не так хорошо да возвращаясь к ребятам на станете по поводу памяти они сказали отдав две вещи что поместится по это основная часть стоимости сервера в наше время это самые дорогие вещи и 3 терабайта памяти сейчас выйдет сервер можно уместить это все как бы дорого но это дешевле чем два сервера по полтора терабайта вот почему я вообще вот начал доклад этого и так далее потому что я часто сталкиваюсь что появляется новая компания например она ну достаточно молодая но они планируют что они станут как google и поэтому им нужно масштабироваться сейчас ну по чтоб на будущее не переписывать мы же не дураки вот поэтому мы сразу возьмем мозгу мы возьмем ластик и так далее а у них там после 10 лет развития большой работающий бизнес который приносит хорошие деньги и у них там не знаю стоя гигабайт данных или терабайт данных но у ребят зачем вы все этому теле когда у вас все влезает в один сервер в один полюс у вас там будет отличный полнотекстовый поиск у вас там все будет отлично все будет править все будет летать зачем вы как бы грозил огородили вот этого все то есть посол такой что начинаете спускаться и вертикальное масштабирование но работает в больших пределах чем десять лет назад меня просто это вопрос глубоко беспокоит как вот человека который много занимался бы кант разработкой если на этом моменте замечание дополнения вопроса возражению нет этот примерно 2 тыра согласен хорошо да это опечатка на слайде а как как неловко вышло до небольшой ликбез для вот тех людей которые не расстраивай репликацию и возможно ее не очень представляют если представляют возможно в контексте других реляционных баз данных поэтому как поговорим конкретно про позарез репликацию типичной рисую так то есть вот этот цилиндрик он обозначает базу данных стрелочки это направление репликации то есть мастеру или лидер который посетить передает данные на другие сервера которые мы называем реплики они же фолловеры и в последнее время не принято использовать термин своих потому что там очевидно он ассоциируется с рабством вы со всем этим вот тем не менее мастер все еще используют как ни странно да зачем какие вообще задачу люди решают с помощью репликации зависит от нагрузки до если у нас типичная в лтп нагрузка то есть ну если вдруг кто-то путается в этих терминах я сам пытался пока не начал работать под гаспра вот велосипед когда у вас много маленьких транзакций лапа это когда у вас большая аналитика которая там может неделю считать ее получить отчет так вот если у вас и лтп много маленьких транзакций то вы можете до какой-то степени масштабироваться горизонтально с помощью репликацию вы заводите реплики и ходите в мастер на запись в реплике на чтение поскольку там во многих проектах типично выбил вас 10 процентов операций идут на запись 90 процентов времени операции идут на чтение то вы можете вот эти 90 процентов раскидать по репликам масштабируется клево вот olap там немножко другое применение обычно выводит создается отдельная реплика которая стоит где-то в сторонке чисто для аналитики и все аналитические запросы вы гоняете на этой специальной аналитической реплики чтобы у вас не тормозил ну чтобы у пользователей сайты не тормозили они могли делать заказы и так далее ну и наконец и реплику использовать для снятия бэкапов потому что опять же бэкапы могут тормозить то куда у вас идет основная нагрузка до какие бывают виды файла вера ручной и автоматический про это будет там чуть чуть подробнее ручной хорошо когда у вас мало баз данных смысле серверов автоматически становится интересно когда вы приближаетесь к масштабам google отложенные репликации это особенный кейс когда ну и последним пунктом репликации не заменяет бэкап и почему потому как бы кто не знает почему репликацию не заменяет бэкапы ну да да да неправильно изменений все равно прилетят я зашел на мастер сказал дизель it from users и у меня это все ушло на все реплики как бы как восстановиться никак но смысле можно на трудно и отложенная репликация это как раз один из приемов которые вроде как еще еще репликация но уже почти backup то есть это репликация задержкой на там например на 10 минут на сутки то есть данные приезжают на реплики задержка если вы сделали till it from users вы можете быстро быстро остановить мастер за промолвить реплику она станет новым мастером и выданы не потеряли но смысле вы сколько-то данных которые за это время успели прийти можете потерять но это лучше чем чем альтернатива конкретно в контексте по сбросу разделяют репликацию на разные виды первый вид раньше столько он и был это потоковая она же физической репликации она же streaming реплики джин это в сущности просто передача райта харлова по сети то есть я думаю все представляют как работает внутри реляционной базы данных она все события пишет в журнал этот журнал мы можем передавать по сети и проигрывать на репликах тем самым у вас на репликах будут те же самые данные это и как бы вот как работает потоковой репликация ее в свою очередь можно поделить еще на две группы синхронная синхронно и асинхронно это очень просто мы на мастере применяем изменения и нам все равно чего там происходит на репликах они отстают не отстают успели получить данный не успели они как успею так и процесс отвал синхронная репликация это другой случай это когда мы ждем от это от реплик подтверждение что на них журнал проигрался ну или по-крайней мере они его получили это более хорошо с точки зрения надежности почему случае с асинхронной репликации если у вас падает мастер у вас нет гарантии что данные папа лечу куда-то в случае асинхронной репликации в случае синхронной репликации у вас есть гарантия что данный есть еще хотя бы где-то до важный момент если вы использую синхронную репликацию нужно использовать хотя бы две реплики кто скажет почему правильно да то есть если у вас всего лишь одна реплика используя синхронная репликация и реплику упала или у вас на сплит между мастером и репликой это там реальный случай если вы реплицируется другой этот центр то есть случалось часто особенно в то у вас падение реплики вызовет остановку всего на мастере потому что не приходит а кино репликацию и все все встало поэтому реплика должно быть при использую синхронной репликации хотя бы 2 и желательно в сильно разных местах да и мне нужно было хоть куда-то написать про каскадную репликацию я выбрал этот слайд но это просто когда вы реплицируется на реплики а реплики реплицируют еще на свои реплики это кто скажет когда это нужно ну а зачем кого да я думаю в ответ правильный да то есть мы разгружаем во первых все эти во вторых мастера в этом случае используется каскадной репликации несколько забавных фактов которые вот как не широко известны во первых если у вас postgres мать мастер по сброса работает например на x64 а реплики работают на армию то потоковая репликация не факт что работает но это такое вот ограничение потому что но и представьте что вы разработчик базы данных да у вас есть 2 варианта вы можете писать все на диск в переносим вам формате там переводить все байты в сетевой порядок там четко говорит что вот это всегда int64 это им 32 и так далее либо вы можете писать в представлении текущая архитектура это будет быстрее но непереносимо как баба варианты они по-своему плохи оба плохи вот но разработчики по сбросу в свое время решили писать в платформу зависимым формате поэтому если вы хотите реплицировать конкурс вам нужно тоже архитектуры и вторая большая проблема не работает репликации между разными версиями по сбросу ну по крайней мере она не гарантируется может так случайно совпасть что когда-нибудь выйдет релиз пользу который будет совместим но этого никто никогда не обещал на самом деле я в этом году был в канаде надев митинги разработчиков по сбросу это такое забавное событие то есть прям разработчики садятся за круглый стол начинает обсуждать там типа char нас плохо чего у нас хорошо давайте мы обновим список трибьюта raw навеки там пять лет не обновляли но и так далее и помимо прочего поднимал вопрос типа давайте может как-то сделаем потоков репликацию совместимый вот ну почему нет ну и мне разработчики так и доходчиво объяснили почему нет почему потому что то есть это технически реализуемо это можно сделать проблем в том что возраст он занимается относительно небольшой комьюнити open source на и не хватает ресурсов на эту штуку ее нужно поддерживать в этой версии через версию проверять совместимость версий новость нужно еще какой-то стенд который этот тестирует это большое вложение сил и профит который мы получаем от этого вложения он как бы несоизмерим это не является большой бизнес проблемой для многих пользователей под газ и поэтому в этом можно вложить силы но лучше мы их можем вошли мы другое такой вот ответ поэтому совместимости обратный в поток в репликации позвольте нет не будет никогда да и отсюда проблемы если мы например хотим перейти на следующую версию по сбросу там это классическая проблема то есть что делать допустим мы хотим упустить мастер да это плохо потому что у нас записью стало хорошо давайте тогда опустим например реплику хорошо опустили пока все нормально читать дальше давайте мы ее обновим хорошо обновили что теперь теперь я вроде как надо запустить нельзя запустить потому что она не понимает старый протокол репликация вот то есть и вы как бы единственный нормальный способ обновить по сбросу это вот опустить все быстренько быстро к обновить подождать пока там погиб great проиграет если кто-то не сильно знаком с возрастом это утилита которого прямо идет по базе ее в новый формат конвертик потому что формат базы тоже меняется между версиями вот потом быстенько все это запускаем в некоторых приложениях ну в них раксус сайтах приложениях так далее это нормально там полежать в течение там вот я привел ссылку на статью это разработчики индекс в свое время делили сколько у них занимает обновление на новую версию downtime типично это несколько минут в некоторых приложениях это нормально в некоторых это не очень нормально то есть ну например я работал в компании которая занималась разработкой системы торговля ценными бумагами и там был не торговый день воскресения поэтому можно было воскресенье останови всю систему аккуратно и обновить протестировать вот ну как бы там это было нормально в позор за 10 появилась логическая репликация прямо с коробки прям встроенная прямо работающая то есть поэтому вот про предыдущий подходы которые слой не ланди ест по голу jackal можно смело забывать но за исключением случае если вы уже на них потели тогда вам нужно про них помните про то что все них надо завалить побыстрее до чем собственно плохи эти решения но во первых с лоне ланди ест по многочисленным паркам который проводил не я я говорил я не люблю матч марте они медленнее чем логической репликации в плоскости встроенная но сильно имели нет в десятки раз почему потому что они строятся на триггерах и когда у вас данные в базе меняется рабат его и триггер который там должен еще куда-то сходить но это все там интерпретируемым по кабелю сквере ну или по-крайней мере часть этого функционала это не быстро но смысле не настолько быстро как кусок все что вы коды прямо в ведре касаемо по голу jackall magallon jackal замечательное расширения ребят из компании стакан квадрант которые по сути вот то что появилось в десятке это взяли по голу jackal его там сильно-сильно переработали под требования комьюнити и замер жили в манилу но конкретно по голу jackall но скажем так мне лично он не очень понравился почему потому что я честно захотел попробовать разобраться я зашел на git хоп там во-первых искал пакета у них там все хорошо есть пакеты для цента see your hell и у бунт вот этого всего а я подарки вот ну значит надо собрать исходников нет проблем собираем там по мануалу запускаем не работает вот и как бы каких-то отладочных ручек но я там разные подергал не получается более того вот этот мануал который я упомянул он в некоторых местах его можно было очень двоякого интерпретировать там например написано запускаем команду такую-то где запускаем на мастерили на реплики но то есть банальный вопрос ну я воссоздал с этой проблемы и шью на что у меня там ответили что типа да какой то баг но моего уже исправили там в какой-то версию но мы еще на github не раз хотели новый короче там же дети вот но в целом я думаю что пакеты для ubuntu они нормально потому что я уверен ребята из квадрата это тестировали и но будете народ хэл там все хорошо вот но решение с таким уровнем поддержки из такой переносимостью между дистрибутивами но я бы никому напротив рекомендовал вот но может у кого-то кстати у кого есть другой опыт кто-нибудь поголовно прозе гоняют кто ним а вот один человек и как а дистрибутив или system center ну вот вот у человека на цент оси работает хорошо вот а кто-нибудь использует склоне лонг-лист что-нибудь из этого никто а что у вас норм потому не он останется 1 уперлись в ограничение по это я попытаюсь в микрофон воспроизвести вопросе ограничения по количеству событий со транзакции так понял это для lan листа вот но это нормальное решение они работают в одно поговорим про новое решение которое появилось в десятки и какие там есть собственно ограничения но сначала зачем вообще еще один вид репликацию но я стремлюсь не все нормально но не все нормально во первых было отмечено что между версиями трудно перейти в вас логической репликации это возможно во вторых а что если я хочу реплицировать не все подряд оао только одну таблицу или там вот вот эти три таблицы только а что если хочу эту таблицу на одну реплик white другую в от логической репликации позволяет решать такие проблемы более того в olap нагрузки типичная проблема я хочу на реплики вычислять тяжелую аналитику но я не могу на нее писать потому что но это ограничение стрим вы потоковые репликация а я очень хочу тут описать хотя бы временное таблицу потому что но они очень круты для аналитики и вот с потоком репликации этого сделать нельзя в то же время с логической репликации без проблем мы когда что ты реплицирует мы можем это мы можем писать в ту же таблицу в которой мы реплицирует мы можем реально создать еще одну таблицу мы можем там погони скуют аналитику запуск записать в это временно таблицы потом записать другой время таблиц по этому помешать потом их гробус как бы не проблема логической репликации все это позволяет да одна реплика может агрегировать данные с разных источников без проблем то есть опять же потоковое репликацию этого не позволяет и втереть теоретически можно изобразить даже multimaster когда у вас есть два сервера один реплицирует на 2 2 на 1 вот но это со звездочкой я я не уверен если у меня отдельно слайд на этой темы нету есть есть отдельный слайд я расскажу об этом чуть подробнее то есть это можно сделать но это трудно и немного с велосипедами пожалуйста ну в принципе он покрывать любой бизнес кейс который вот с которым вы столкнулись если у вас сейчас нет то как бы хорошо если если мы представим что у нас есть один филиал в там в сша 2 филиал в россии и мы хотим это все агрегировать в хардкор где-нибудь в германии и там погонять аналитику ну как бы вот можно представить такой кейс до дополнение что любой аналитика покрывает этот кейс да дополнение такой что можно влезть кусок данных в общении спас gresso и как-то это там померить паджоне аналитики они обожают и склей они просто очень очень любят вот там все паджоне им это просто и понятно поэтому чем больше данных мы влили в отдельную реплику где вы все есть и все джон несу тем лучше для аналитиков до фанфик про логическую репликацию во-первых схем и таблиц могут различаться как бы никто не говорил что то таблице которую я реплицирует то в которую я реплицирует неодинаковые более того никто не говорил что там порядок полей один и тот же он может быть легко различаться при этом на реплики могут быть столбцы дополнительные при условии что они на lable то есть если на мастер есть какие-то столбцы которых отсутствует столбцы которые есть на реплики нет проблем мы их как бы с реплицирует а что если остались запишем налы ну это опять же удобно если мы вот там в примере с двумя филиалами которые там с двух отделений реплицируют и в одном отделении есть одни столбцы в других есть другие столбцы и мы это все замерли в одну таблицу где есть все столбцы вот почему но потом уже законодательства разные там сша и в россии и вот где-то одни столбцы имеются другой не имеет над я просто первых первое что в голову пришло почему такое может быть кому-то это не нужно но не нужно не используете да но важно мастер не может иметь больше столбцов чем реплика меньше может больше не может вот такой вот ограничение чем отличается логической репликация еще от физической что во-первых обязательно должен быть прайма реки без этого она не работают такие вот ограничения но это в принципе не так уж большого breach они вообще иметь prime реки это обычно не плохая идея во вторых не реплицируется до этого div ниже ленгвич то есть всякие crate и было alter index а и так далее не реплицируются tranque это трагедии регулируется потому что в подгрести вообще не транзакционный и не реплицируется sequences если кто-то вдруг не сильно знаком хрена с возрастом это его внутренняя штука которая делает автоинкремент ключе то есть это это просто счетчики и они тоже не очень транзакционные до при этом то что дизель не реплицируется это ограничение logic олди кодинга про который будет чуть впереди это механизм на котором работает логической репликацию то есть это с одной стороны почему он не сделал потому что ниже нежели лежачий механизм еще этого не поддерживает но потому что у кого руки не дошли руки еще не дошли на самом деле по важной причине вот представим себе случай что у меня разлить простой сценарий у меня есть мастер у меня я реплика мастер реплицируют в реплику но схем и таблиц разное и вот я захожу на мастер и говорю там alter ты был dropcam данный пример и а что я должен в этом случае сделать я должен это реплицировать на реплику ленин не должна я должен это реплицировать как-то героично или как есть вот что вообще должно произойти в общем случае не ясно поэтому она в позе сейчас никак не реализовано потому никто не понимает как это нужно реализовать ну то есть если вам нужно что-то выполнить на мастере на реплики но вы заходите руками делаете от на мастере на реплики такие вот пироги с котятами и касаемо трейдеров это собственно то причина почему нельзя легко изобразить multimaster то есть мне мне честно было очень интересно попробовать я прям обрадовался вау логической репликации в позе сейчас я заряжу multimaster значит поднимаю один мастер по дима 2 мастер с 1 сырую на 2 со второго на первый понятно есть какие-то могут быть конфликты потому что ну например я за i'm sure сел что-то на один мастер это пришло к логической репликации на 2 а там уже такой прям реки есть что делать вот надо разрешить конфликт вот нет проблем ну мы же умные пишем триггер да там типа то что на вставку там и следам проверить если уже давно если они есть то подержите написали триггер отлично а он не работает но смысле он не выстреливает и влоги со сыпется что там логически репликации остановлено потому что у тебя там конфликта прайморить и чувак разберись вот но я пошел в рассылку собственно спросила это как бы нормально поведение нет ну как бы в час пека говорит в спике как бы об этом не было почему меня триггеры не работает вот но оказывается что да про это известно сейчас поддержка триггеров на вот то что прилетит прилетает по логически репликации она несколько ограничена то есть на insert у вас работает все отлично также все хорошо работает на самом деле на апдейта вот на апдейт я к сожалению помнят очень сильно exist но там можно сказать что апдейт при изменении конкретного столбца вот на это повести триггер вот и его я использовал потому что меня интересовало изменения прайма реки вот он как раз не работает и поэтому довольно трудно изобразить ну в смысле multimaster можно изобразить но вам понадобится завести временно дополнительную таблицу на 2 мастерах повесить триггеры на свои данные чтобы когда они меняются создается и так далее у вас сделался инсар в эту таблицу в дополнительную назовем его там рипли тишинке или как то еще потом вы должны ее вот со реплицировать на кого-нибудь там inbox до назовем таблицу потому что мы помним десерт у нас отлично реплицируется потом вот на то что у вас сюда пришли данные в эту еще одну в добавить таблицу нужно повесить триггер на он и insert который вам уже обновить данные рулет конфликта multimaster может работать но вам придется на велосипеде вот то что я сейчас описал ну так себе решение я бы подумал так ли сильно мне нужен multimaster вот но в принципе это будет работать если на этом моменте дополнение вопросы возражениях комментариев да смотрите sequence и не реплицируются то есть у вас или плита когда вы допустим вас есть таблицы в ней есть праймари serial как там в синтаксисе ключ короче авторы клемент и вот когда вы делаете туда и сердцу вас локальные там и клементи руется этот sequence берется из него значения записываю таблицы и вот уже этот купол он летит к сети то есть сам себе sequence он остается локальном да но sequence он как был локальном так и остается до но он у вас будет четные и нечетные секвенцию ну а что вы именно хотите этим разрешить нет ну в этом случае конечно решит но тут нужно понимать что у меня прайма реки может быть во первых есть еще другие константы uniq constrain да например вот и что вы будете делать когда у вас с ним конфликта а он у меня может быть на имел пользователи да например ну зависит от бизнес-логики приложения то есть вам нужно разрулить разруливать конфликты не только конфликтов на прайморить и дополнение про то что мы можем поменять платежку на одном сервере на другом и и тогда вообще непонятно как это держит действительно непонятные там по хорошему это нужно как то в другом месте разруливать например вы должны всех пользователей из франции направлять возил дата-центра всех пользователей с германии на другой дата-центр чтобы они не писали в одни и те же документы разные вещи ну например мне показывает что осталось 10 минут поэтому я немножко скорость она вопросы отвечу потом значится в подгрести есть механизм с версии 94 называется лоджик диковинка если кто-то вдруг не пользовался это клевая штука она позволяет подцепиться к по сбросу как реплика и данные получить в текстовом виде есть все чтобы происходит на мастере вы получите в текстом ведь вы здесь пример как это сделать это один из немногих технических таких глубоких относительно слайдов в моей презентации то здесь видно что в первой транзакции что-то произошло но мы ничего не получили ось сейчас станет понятно почему в следующий транзакции мы сделали сорт в таблицу и там прямым текстом передано название поля значения и типы в первой транзакции ничего нет потому что там как раз создавалась таблица недели не реплицируется в конкурсе поэтому в этом контексте механизм он так у него сомнительная ценность потому что вы не получите там alter table и так далее вот но каких и задачку может быть полезным есть extensions вот тут можно найти строчку третью сверху где тест decoding это на самом деле расширение из каталога контрит в подписи и она отвечает за вывод данных вот в таком текстом виде вот там где интер : и так далее есть расширение которое выводит то же самое в джейсоне кому-то там жить вам больше нравится в удобнее парсить но у этих расширение есть проблема что они сторонние они не поддерживаться комьюнити они между версиями могут ломаться в частности вот и расширения которые я тестировал буквально в эту пятницу поэтому информация свежая они на десятки сломано пройдёт какое-то время перед тем как их авторы что-нибудь с этим сделать вот но в принципе если вы вам необязательно джейсон то вот этот формат он тоже вполне себя партия но просто наверно не так удобно как джейсом failover как было сказано бывает ручной автоматический для физической репликации есть множество решений это ритм игры это патроне от компания zalando отличный не расширение отличное решение я на самом деле удивлен по уму не было на этой конференции доклада от зеланда и стал он стал бы она была говорят было столов меня лично нравится больше всего нем я расскажу чуть больше для логической репликации сейчас решение нет на самом деле этому есть простое объяснение то есть чтобы вы писали of the fall over для логической репликации вы должны ее использовать она появилась только в октябре условно и вы должны быть масштабов у гугла и вы их должны хотеть мигрировать на логическую репликацию ну так таких компаний просто сейчас нет а кому-то тратить там свое время своего энергию на написание этого в качестве под пружину пока не нашлось когда у вас появится новый google который будет использовать логической репликации захочет него фил айви раз за свои деньги свое время отходя жажда напишет вот ну либо вы можете это сделать в качестве прочитать на самом деле не особо рокки sense стол он развивается 15 года лежит на гитхабе написан ногой используют консул и интегрируется с губернатором клёвая штука и меня на лично нравится тем что я ее попробовал она работает адекватно смысле она нормально переживает все наши плиты все падения узлов и так далее то есть она ведется так как должна то есть в первом приближении во сне не потеряете данных эта картинка с гитхаба который говорит что у нас там есть агенты которые здесь называются keepers которые ставится рядом с возрастом все клиенты ходит через прокси и на самом деле в этом есть глубокий смысл потому что если вы например ходили в реплику без прокси а потом реплика оказалась в у вас произошел на сплит и реплика оказалась в минут в minority то вы не должны продолжать в нее из нее читать в вас там уже не актуальные данные и если нету прокси то вы ничего не можете сделать у вас продолжает приложение оттуда читать и получать не актуальные данные если прокси есть то вы можете порвать от соединения что он свой делает то есть как я уже отметил он очень правильно обрабатывать всякие странные случаи stepan и цветов у него есть существенное ограничение он и читает и пишет из мастера видимо потому что вот компании-разработчику было не очень нужно читать реплик но в принципе есть workaround который описан на гитхабе то есть можно сходить прям в консул узнать где сейчас текущие реплики и пойти в них напрямую но в каких-то задачах это будет нормально в каких-то не очень как бы просто наблюдение что консул он он может использовать эти сидели консул стол он может использовать сидели консул но он не знает про их там дополнительный фич он использует их тупо как и вылью то есть например он не обновляет dns-записи в консоль а тут краткая информация о консоли для тех кто вдруг с ним не работал ну если коротко это киви льюс rest api и использующий ровд написанное на год очень клевая штука крайне рекомендую и до у него еще есть встроенная разных новый механизм уже был назван dns у него есть веб админка которая отображает информации текущих сервисах сервиса можно регистрировать на сервисы можно вешать метрики то есть если у вас например упадет ну не знаю engineers to console его сам удалит из своих записи чтобы другие клиенты этого сервис discovery туда не ходили кроме того поверх консулу как и любой базы данных с компресс web легко написать лидер election если вам нужно ну не знаю вас 10 front end of вам нужно один из них просите но front end of по отношению базе данных а на самом деле бэндов из него нужно выбрать один в качестве мастера это легко сделать поверх консула и тут есть ссылка на статью описывающие там 100 строк ногой если я правильно помню есть до этой последней такой и относительно технический слайд я обещал так не делать но я лгал вам дело в том что тем как происходит потоковые репликации в подписи можно гибко управлять притом этот параметр его можно указать как в конфиге так и в сессии то есть через все ключик равно то есть мы можем сказать что мы хотим асинхронной репликации что мы хотим синхронную репликацию что мы хотим синхронную но не дожидаться псинка в волна реплики это такой промежуточный вариант то есть данные попадут в память на реплики и мы говорим что нам этого достаточно но это компромисс между надежностью и скоростью плюс к этому появилась в 96 важных флаг arremato плай почему он важный потому что до этого запись попадала в вал но необязательно ну как бы могла не успеть проиграться примениться к данным в результате вы получаете такую картину что вы записали что-то на мастер читайте с реплики и получаете оттуда старые данные потому что репликация синхронную все попало вал все без обмана но еще когда нам не применилась начиная с 96 это можно ситуацию исправить у вас комет пройдет только тогда когда это стало видно на реплики больше у вас вот этой проблемы с чтением устаревших данных нет это собственно здесь говорится что можно не только конфликт править важное изменение в десятке появилась commit на кворум то есть это означает она вторая строчка вот этот второй будет это означает что если вы у вас происходит на сплит есть гарантию что вот в этой распавшейся сети не зависимо от того где у вас оказалось мажоре ти есть как минимум один сервер с последней актуальной версии данных раньше это не гарантировалась у вас мог носить произойти так что вы оказались в той части где нет актуальных данных это проблемы ну и там другие варианты а не менее интересно там можно писать не и не the first three и так далее то есть можно указать там жди акад трёх нот из заданного списка но я не знаю где это полезно поэтому читайте документации если вы знаете где за кадром остался sharding или sharding потому что но мы ещё не масштабов google а если будем то у нас будет много денег и много времени чтобы с этим разбираться а также распределенной транзакции и подобные вещи потому что я не знаю для этого готовых решений для подвеса может вы знаете тогда вот всех вопросов и ответов можете дополнить а если вы хотите но если вы уже google и хотите сделать это сами руками то есть статья которая хотя бы теоретически описывают как это сделать вот краткая версия что есть пирккала there like транзакции которая делать распределенной транзакции без блокировок и так дале оптимистичны там просто иди и при помощи логической репликации который теперь наконец то есть можно делать клевые sharding ришар zing перебалансировку и так далее тут сотен дополнительные материалы которые преимущественно состоят из сайтов проектов таких как консул cabernet и так далее и я идеально уложил 45 минут и готов ответить на ваши вопросы и послушать ваши дополнения я думаю вам должны дать микрофон поэтому не опускайте руки я-то спасибо за доклад я правильно понял чтобы обновить пузыри с помощью логической репликации надо сначала с мастера перенести ддл после этого на мастере прекратить выполнять любые del команды после этого настроить репликацию я понял вопрос можно и на него уже сразу отвечу после этого час погасить мастер и с него перенести все sequins и и после этого можно поднимать новый предполагается как бы в идеале что у вас уже есть одна реплика которая вот уже все настроены и все что вам нужно это погасить мастер за промо учить реплику после чего реплика становится мастером и с ней все работают в это время в старой мастеру аккуратненько обновляются подцепляете как реплику и накатывает после чего вы можете повторить процедуру вот да это не так ну скажем так это намного более удобно чем при физической репликации том что она это не позволяет вообще вот если у вас есть идеи как это ну можно было бы улучшить но в простейшем случае наверное можно написать скрипт который прям все все все все все будет реплицировать одесских не сложно потому что в позы сия синтаксис позволяющий сделать репликацию всех таблиц но то есть я ответил на ваш вопрос если реплики не было то ее достаточно легко ввести но вообще я хочу предполагал что она уже есть а зачем вам приносить секунд а зачем это хороший вопрос и краткий ответ я не знаю я об этом не задумывался но дополнение зала что до очевидно на репликах нужно обновить секунд sequence и до значения больше последние записи но это логично спасибо за доклад у меня небольшое дополнение по репликации вот случай когда выполняются долгие запросы валы пи могут привести к тому что of the vacuum и эти долгие запросы будут входить в конфликты будут возникать конфликты и репликации и это тоже будет мешать вот и вопрос насколько вы считаете что докер и вот супер на из который его регистрируют готовы к тому чтобы работать с базами данных серьезно вот с таким с большими позырить в частности это отличный вопрос смотрите если честно то я не работал с кубер нету сам я его никогда в жизни пробовал я работал немного с дагером но я общался много с людьми которые много использовать купер не тестом на продакшне если кому интересно я думаю тут где-то рядом сейчас появится ваня глушков и вот с ним можно будет об этом пообщаться подробнее вот и больше чем одного человека в один голос мне сказали что губернатор с на данный момент не подходит для реляционных баз данных лучше поставить реляционных баз данных рядом а в кубе рн это все уже катить вот эти стоит из контейнеры которые как бы для паса и вот этого всего и честно говоря вот когда заходит речь про контейнеризации мне как-то обидно что забывают что есть не только у бернетт а зачем вам собственный не строится там на proxmox и elixir ну или или вы уже масштабы в google я я я так не думаю тут же вопрос даже не не столько про регистраторы сколько именно при контейнер то есть насколько контейнер и надежный хрени нет даже потому что уже и вадиму существуют внешние ситуация поменялась но насколько сейчас это все но если вас интересует мое мнение субъективное она не на чем абсолютно не основана но я очень скептически и ко всему этому отношусь и если вас интересует мнение экспертов которые с моих слов которых я спрашивал то они тоже настроены скептически говорят что по их опыту так нельзя еще один маленький вопрос спасибо за доклад насчет определённо транзакции вчера был человек из цитруса и они рассказывали у них такое интересное решение они самописная какая-то у них такой типа есть раза khan менеджер который смотрит на каждом шаге транзакция потом их magic и стресс на работе тоже их но это такое как бы просто что кто-то пытается пилить но в каком состоянии но пока непонятно смотрите насчет cytus я не эксперт конкретно в цитрусе но последний раз когда я общался с ребятами с этой компании они недвусмысленно говорили что их решение она для лап а то есть вы в грузили в cytus данные вы на нем прогнали какую-то аналитику она здорово быстро про гналась раз параллельны стану распределенные так далее вы получили результат а насколько я осведомлен они не умеют хорошо переживать там на сплит и падения узлов и так далее поэтому он ударил теперь я бы не стал но опять же это не точно спасибо за доклад у меня такой вопрос вы говорили что можно для каждой связи для каждой транзакции установить свой уровень допустим асинхронная или синхронно до порядок при этом гарантируется есть допустим у меня в системе всему по сбросу прописан оси cronus коммент на конкретной сессии говорю asynchronous а параллельно ну конкретной транзакции а параллельно еще там другие транзакции идут как синхронность коммент никак будет применяться все на реплики порядок гарантируется или нет да конечно для асинхронной репликации порядок в определенном гарантируется это если все ключи они они намекают на ваши на ваши ожидания что эти данные не потеряются то есть они никак не affected там порядок транзакции там доставит не достается вал и так далее то есть они работают они могут сделать вам лучше в плане скорости но не хуже получается эта транзакция которая асинхронность на самом деле все равно станет также в очередь и все остальные синхрон из будут ждать пока на применится но если у вас смотрите в например есть синхронно с транзакция которая там попала в очередь а следом за ней в другой сессии вы выполняете синхронную то да конечно у вас по кругу как будто синхронная на у неё не пройдет камер пользователи не вернется к мид пока она как бы не при не даете до реплики но вдруг у той другой сессии у него проблем нет она как бы если она сказала синхрон хамитов она записала это в буфер лоб менеджеры и пошла по своим делам спасибо и еще один вопрос от коллега говорил что of the vacuum vacuum процесс как то эффект это логическое репликацию либо я неправильно понял darel речь чуваки тогда сложилась и речь была про конкретно локи но как бы очевидно если у вас есть долгоиграющая транзакция и параллельно пришел вакуум он как бы не может вычистить то с чем сейчас работает долгоиграющий транзакцию вот там возникают очевидные проблемы вопросы дополнения комментария возражения крики докладчик идиот вот спасибо вам и если что ловить меня в комментариях это хлора"
}