{
  "video_id": "IoNGmwgo9ZY",
  "channel": "HighLoadChannel",
  "title": "Shardman - постгрес для кластеров. Сейчас и завтра / Андрей Лепихов (Постгресс Профессиональный)",
  "views": 1665,
  "duration": 2031,
  "published": "2019-12-05T08:27:57-08:00",
  "text": "здравствуйте сегодня я расскажу сегодня расскажу о шах money это один из продуктов которые разрабатывать наша компания под газ professional проект и цель этого проекта научить об отгрыз выполнять запросы на кластеров эффективно эффективно потому потому что сейчас под газ уже обладать возможностями для того чтобы формировать базу на пластырей каким-то как выполнять запросы но так будет это не очень удачное дальше расскажу в рамках конференции вот уже мои коллеги рассказывали вам о таких частях шарм она как-то писи как распределенная транзакции как вы берете а я сегодня сосредоточьтесь на 1 новые фичи как только что появился даже может котенок появляется называется параллельное выполнение запросов поскольку ещё ни разу не уступал на этой конференции я кратко си расскажу в нулевых занимался научной работой в области паяльных систем баз данных специализировался на балансировки загрузки репликации в то время парные система баз данных были чем-то из разряда скорее теории по станкового базы были маленькие запросов было мало вот и сейчас я чувствуя каким-то классиком вот реализуете говорит на который делал я и мои коллеги в нулевых в компании puzzles professional первое что мы сделали определись тем когда мы используем сортирование прям используем кластер раньше в нулевых мы считали что шокировать нужно уже 1 терабайт на базу но на сегодняшний день ресурсы подрасту не по 5 натали стала больше и теперь экспертной оценкой мы пришли к выводу что сортировать есть смысл базы размером от 10 тераватт и выше для чего нам необходимо во первых это доступность данных когда мы дублируем данных данные на разных узлах мы делаем синхронные и асинхронные реплики повышаем доступность и второе на что ориентирован шарман это на масштабирование здесь есть два аспекта а первый аспект это ускорение когда вам нужно увеличить дпс и для этого добавляете новые узлы и таким образом шар героя базу уменьшаете и объем на каждом отдельном узле ускоряете и второе когда у вас есть растущая база быстро растущая база и вам нужно сохранить тот tps которой уже есть и вы для это добавляете новые узлы как можно утилизировать кластер ну пусть нас есть четыре ноты на них ш сортированная базы на дисках этих нот и первый вариант вариант для о типе когда мы просто перед направляем запрос на ту ноту где у нас есть все необходимые данные мы выполняем там запрос и выдаем пользователь результат здесь мы получаем очень большое эффектно мы работаем с меньшей базы утилизируем меньше дисков памяти вот и все достаточно хорошо второй случай а также для у теперь когда мы все таки обязаны использовать несколько узлов частей базы находятся на разных надо вот и в таком случае мы можем получить выигрыш и получить преимущество за счет того что мы рассмотрели ваем операции с дисками и имеем больше оперативную память больше процесса нас больше шанс попадания данных в кэш вот и третий вариант характерный для пола лап запрос это большие запросы скучать join of с кучей агрегатов и что характерно они часто используют не маленькую часть отношения как вот кипиа большую часть даже не то есть нужно сканировать почти все отношения и в этом случае наиболее эффективным является сортировать базу так чтобы максимально задействовать все узлы максимальной распылитель операции с дисками с памятью с процессорами и быстро быть результат вот это собственно и есть существенное отличие от лтп когда делают пролью система баз данных то сталкиваются обычно состоящее проблемам первое это планирование запроса а если у вас простой select from типов то все достаточно просто то вы сканируете на всех нотах данные собирательно каждый на 3 и вы даете пользователю а если он скрывается join и джонни попросишь армирование то в этом случае вам нужно перераспределить данные того неудачного отношения которое соединяется не покручу перед тем ка выполнять соединения агрегаты их сложно что что не бывает разные в частности в пузырь занимает юзер define и не что понятно можно выполнить распараллеливание данного агрегата или нет сортировкой по проще но тут то что необходимость отслеживать явные и неявные случай когда кортежа должны идти по плану в аппаратном порядке доставляет на некоторую сложность задачи доступности данных в этом случае существенно возрастает поскольку у вас много серверов и шанс что какой-то из них упадёт гораздо выше вот и поэтому необходимость создавать инструмент или плавные переходы с мастера на реплику и перезапуска запросов распределенной транзакции тоже большая проблема и это основной сейчас тормоз эффективном использовании кластеров и была собака загрузки важно поскольку если вы выполняете запрос параллельно то он выполнить этот момент когда закончится в работу последний самый медленный узел это понятно перед тем как делать свое решение мы естественно хотели посмотреть на альтернативы взять какое-то djebel принц не теперь решения готовы и дорабатывать его и заработать о том что продавать компетенции и подавать до как они модуль к нему вот и на что мы посмотрели мы посмотрели на cytus возраст excel и группа мы посмотрели в их код поскольку информация на сайте всегда находится в урезанном виде вот и что мы увидели cytus это чистая extension он работает следующим образом он преобразует входящие запросы в серии под запросов таким образом чтобы вот эти под запросы могли быть выполнен независимо на всех дистанциях кастера вот если необходимо лишь родирование то cytus динамически перераспределяет данные между после выполнения одного под запросы перед началом работы другого под запроса и ему необходимо это делаем эти материализовывать в памяти есть неуважительного диски вот там реализован изотопной плане и сделаны собственные механизмы реагирования и пудинга ну и также есть выделенный координатор летними родам а базе как это работает покажу как выполняется запрос в цветущий на простом примере из двух нот и 1 координатора здесь у нас есть два отношения которые фрагментированы по дискам этого пластин пусть нам приходит запрос на простое соединение а джейн бы при том отношении а соединяется не по атрибуту формирования б потребует шарди ранее в этом случае координатор генерирует серию по запросов данном случае это соединения перераспределения и сканирования отношений а и b после чего он направляет те под запросы которые может выполнить параллельно на узлы создает там бэг-энда эти бэкон начнет работу сканирует данные и создают временные отношения а штриха и b-штрих на каждой ноги для того чтоб можно было выполнить дальше соединения при этом в процессе сканируя отношения данные перераспределяются для этого существует некоторая функция сортирование которые вычисляются для каждого кортежа отношения а и либо остается капитан той же ноги либо перенаправляется на другую ноду это kyojin когда заканчивается вот сканирование на ноты зашиваются под запросы с соединением и дан и соединяется уже вот эти вот меньшего размера матери зова n'y a штрих и b-штрих независимо на каждой ноги после чего данные выходят пользователю данная схема а создана судя по всему с прицелом на распределенные базы данных генетически определенные с плохими контактами с неустойчивым и соединению и поскольку а она наиболее хороша для того для случая когда он отваливается круто сервер и мы можем часть запроса просто перезапустить на реплики и в некоторых случаях даже не нужно перезапускать этот запрос минусом является то что для а теперь эта схема не очень оптимально нам приходится планировать запрос как минимум дважды на координаты и на в архиве также нам приходится материализовывать промежуточные делать матери зации промежуточных данных что весьма может замедлять работу особенно небольшие нам нужно их спилить на диск разгрыз xl вторая система она уже работает по-другому она строит план запроса один раз дальше она ищет те местах которых необходимо данные лишь сортировать и вставляет то специальную воду для этих задач а также не она реализует собственный планер собственный механизм сортирование пунин как как cytus и работает оно следующим образом в терминах под газ excel in soci которые хранят данные называются дата нодами получив запрос он формирует plantago запроса вставляет то специально ноту выгодную красным светом и дальше этот запрос сворачивает реализует квартиру ему образом и направляет на дата ноды где он разворачивается и ведь в бэг-энд в кафе в бэг-энде и начинается выполнение когда встречается специальная но до вставленных план запроса backend генерирует новый бренд стандартным образом обращаясь к под мастеру через библиотеку ли pq и эти два быка начинают работу независимо данном случае второй баг антон просто сканировать отношении а сканируя он передает данные водительский backend при помощи стандартного телеку соединения и также там есть некоторая по а логичная концы тусу функция сортирования в помощь который может узнать что такое нужно передать на другой бока на другой ног ноту и он это делает и таким образом выполняется резервирование под газ excel предназначен больше для т.п. поскольку вот он всего один разминировать план однако у него есть проблемы в том смысле что ему необходимо вот создавать много брендов локально тогда когда у нас много пересылок данных ну обмен данными через общей памяти через совете локально достаточно медленная штука вот плюс он реализован прямо в коде мозга со при помощи define a и размер его порядка 200 50 тысяч строк достаточно сложно его поддерживать и третья система это система гриб план она от шага по фгос excel строит план один раз она умеет дарить план горизонтально в случае если нужно решил тировать данные и вертикально в том случае если необходимо выполнить если она видит что данная части под запроса можно будет параллельна вот так же у нее есть собственный планер и собственные механизмы реагирования проник как в предыдущих двух систем работает оно следующим образом получив запрос она генерирует план причем вставляют в план ноты выделить зеленым цветом это должен в том случае где нужны данные перераспределять и гавр там где нужно давно и отправить на координатор и по этим но там она делит план на слайс слайс и это такие части планы которые могут быть выполнены из ему параллельно после этого координатор отправляет в средне и сустава соединения с сегментами и отправляет туда столько запросов на создание брендов сколько у нас есть слайс данном случае 3 и после этого серьезную запрос она передает его прямо в эти бренды ром ты выпил есть вот при этом начинают дополнительного в каждом бэг-энде asos со своей точки в первом бы candino его выполняет в самой верхней ноты во втором бык они начинают его память внутрь гдр и в третьем бы крайне начинает выполнять с ноды motion то есть фактически в каждом бэг-энде выполняется не весь план а лишь его сегмент переставать перестарался а можно что-нибудь сделать с этим я перестал рот приключение о спасибо фактически на каждой в каждом боккен девайсов вот такой вот вот план то есть сканирование отношения offer передает tube кортежи ноду motion которые перед рисует в другой backend который боится единение и переадресует их в 3 backend который выполняет собственно доставку данных на координатор сделано это видео для того чтобы максимально загрузить все ядра защитной системы личного кластер а вот при этом там тоже есть такая функция режь родирование которое позволяет переадресовывать данные в бренды соседнего сегменты чтобы выполнить при распаде данных перед соединением посмотрев на все эти системы мы поняли что они не достаточно объемные в них много кода которые реализуют никто часть системы который можно было бы заменить стандартные компонентами они ориентированы каждый но по своей узкой из подола кули по дтп и их достаточно трудно переносить с одной версии подвеса на другую в частности потому что большая часть легализована в коде после со вот и для того чтобы использовать заниматься поддержкой проще купить команду цвету say и брать его таким образом вот поэтому мы решили делать шарма на других принципах мы берём то что уже в имеет пост раз в частых в частности позиционирования для сортирования стоять под названием фатф мы делаем все при помощи extension допускаются почти только такие патчи которые могут быть полезны также самому и друг возгласа работающему на одном узле вот мы хотим чтобы каждый узел мог быть также и координатором для целью т.п. чтобы можно было картин конфигурировать систему подстраивать и как подолог так и подаете пятно в известных пределах и делаете настолько простой чтобы ее в сообщество захотела потом поддерживать ванильном пузырьки если кто не знает сегодня при помощи позиционирования и фото вы уже можно организовывать возраст на пластыре парте цианирование позволяет вам разбить отношении на фрагменты при помощи механизма наследования дальше можно эти фрагменты отправить на инстансы простым копированием или еще как вот и после этого на каждый каждом из россии можно при помощи ходовой прописать скопированный петли перемещенный фрагмент как форинт эбу таблица извлечена другому зле указать параметры подключения к этому злу и таким образом дать возможность плане ru использовать это отношение и при необходимости подключаться к многие сканировать оттуда данные как это работает пусть у нас пришел запрос на соединения в таком случае планер генерирует запрос планирует план в котором вместо сканирования тех данных которые находятся на других надо вставляют специальная надо под названием фокинском это надо занимается тем что формирует курсор и подключается к удаленный надеть сканировать то данные подключается при помощи стандартного протокола rip pq там запускается backend передается запрос запрос планируется разворачивается запускается и данные по мере обращения к ты многих форм скан передаются с удаленным ноды на основную но на ту которая пришел запрос а если сделать такие перекрестные ссылки между нодами перри перекрестно объявить таблицы как фарин то можно получить такой много головы кластер эта система будет работать хорошо в том случае когда у вас хороший запрос например если у вас простой select или for fat умеет отправлять join и на удаленные ноты такие join и которые выполняются по атрибуту шокирования вот даже умеет управлять некоторые виды агрегатов но если у вас джонни по атрибуту шарди рования если у вас плохой ребят то в этом случае данные просто будут собраны в самом начале на одном узле на комбинатор и дальше все операции бы проводится именно там это медленная то плохо и и стоит так делать мы пошли тем путем что мы дорабатываем эту схему уже готовую схему и учим возраст выполнять запросы параллельно с помощью рис схемы и плюс наше расширение а как мы это делаем когда поступивший запрос блонир делают по нему вам в подарочной мы при помощи хуков предлагаем ему альтернативный план мы не делаем свой планнер а мы создаем картонные ноды которые отвечают за перераспределение данные за состояние данных на одной ноги и за обеспечили зации выполнения правильного запроса после чего мы просто делаем в плане предлагаем планируете ноды и даем ему набор правил при помощи которых он используя их может выполнить параллельный запрос в данном случае мы предлагаем а вместо for минска использовать связку локальное сканирование и специальный оператор exechange который будет выполнять пересылки кортежи и отношения в те места где то необходимо вот так же мы вставляем в план это ченчик над операций с соединения для того чтобы выполнить влияние результатов на координаторы и еще одна но да но до диск язык это но до нужно для того чтобы выполнять диспетчеризацию в данном случае от но до диск y при первом ее вызове она сигнализирует план который находится под ней а установит соединение со всеми удаленными нотами на которых которые на которых есть необходимые нам данные переждет да этот план и начать запустить его выполнения перед выполнением будет выполнена операция локализации это операция в которой проходятся все листовые узлы плана и удаляются все операции сканирования которые относятся фрагментом находящихся находящимся на один удар техно не народной ноги таким образом существенно упрощается план вот потом начинается сканирование отношений и в процессе работы оператор exechange обмениваясь как друг с другом а у них есть некоторое соответствие в плане запроса они выполняют перераспределение данных и верхние качаешь выполняется слияние данным на главную ноту таким образом в шарма не удается инкапсулировать весь параллелизм в двух всего в двух но дар и планет ничего не знает о том что у нас есть много но что мы параллельно выполним запрос он просто бьёт правила которые мы предлагаем и строит план также его запускает не орзом мы избавляемся от собственного механизма планирования и при помощи парте цианирования fpv мы избавляемся от собственных министр шарнир родирование что самое главное собственных механизмов рынка в данный момент мы умеем выполнять параллельно select умеем параллельно join просто вставляя надо их женщин нужное место плана запроса на dx женщина весьма непростая но да она состоит из четырех частей и чтобы избавиться от проблем когда у нас сеть перегружена мы должны уметь в параллели выполнять сбор кортежи из других not a отправку кортежи в другие ноды чтения данных с диска и слияния данных с диска и полученных с других not ссылка в планах nobody's toxic это еще одно еще одно достоинство шермана она позволяет нам выполнять параллельно только ту часть плана которую необходимо то есть оставляется не в самый топ план запросу а там где у нас есть новое и стерилизует и отправляет на другие много такого именно этот план в случае если у нас есть запросе в других частях плана хода отношения которые являются локальными для надо на которую пришел запрос то они просто выполняются локально и если план большой и вокальных данных много соответственно мы имеем хорошее преимущество вот причем а план отправляется и запускается на длинные ноги без всякого патчи а при помощи хранимой процедуры которые кладется как в качестве расширения на каждой ноги при установке шарма на настоящее время мы занимаемся тем что распараллеливание агрегаты и сортировки подход с помощью как с помощью которого мы не меняем план а даем ему правила и ноты для как инструментарий позволяет из очень несложно и распараллелить и агрегаты в плоскости уже есть механизм локально параллельного выполнения на одной ноте где у нас есть вам выполняется в арке рим параллельно вот и соответственно есть инструмент для того чтобы распылить агрегаты вместо одной ноты там в таком случае создается две ноты начал y и на лайс агрегат начал вычислять промежуточный агрегат после чего данные передаются финала из он собирает результаты и вычисляют итоговое значение когда-то мы предлагаем по сбросу вместо обычного агрегата вот такую комбинацию почел гналась и вставляем туда но тут x cinch при этом зависимости от логики дальнейшего выполнения мы можем либо использовать его в режиме годам то есть собирать данные после patreon и двигает головном ноги и вычислять у тебя только там либо если нам необходима работа с запросом дальше мы можем использовать и выражением бродкаст и таким образом распространяя все прощал результаты на все ноды мы можем получить на каждой ноги значений агрегата и дальше работ с ним на каждой ноги также в параллельно вот с сортировкой все немного проще здесь все работает как и в случае обычного join a просто мы вводим новый режим в операциях чинить под названием мяч он работает как обычно и сортировка слиянием то есть собирают результаты считая что они отсортированы и вот из приходящие сети и приходящие снизу еще один аспект это место чп с никто передача между узлами кортежей в поисках excel и fci тусе все реализована на базе стандартного липку используются стандартные ресиверы бэкон передает данные своему клиенту вот в режиме каждый каждому план все реализованы при помощи самописная библиотеки на базе сокетов мы пошли путем использования стандартного ли pq нос микшированием connect of the и чтобы уменьшить количество соединений и как мы это делаем назвали tdm пью дымку и часть расширения шармом и при его инициализации запускается обычный по ground war gear которые мы называем dequeue сендер его задача отправляюсь все данные с одной ноты на любую на на другие новый центр создает сегмент в общей памяти с помощью которого он обменивается с бандами кортежами это центр отправляет запрос стандартные запрос на соединить на соединение спас мастером на все остальные но восходящих шаман создается backend которая называет называется ресивер в нем выполняется должная хранимая процедура дымку ресиверу единственной задачей которой является получать данные сендеров и помещать их в общую память того чтобы бэг-энда могли извлекать когда приходит запрос backend может инициализировать в эту общую память сегмент общей памяти со стандартным образом при помощи библиотеки шенкель если ему необходимо играть кортеж он помещает его в эту общую память центры замечая считывает передает с помощью ли pq ресиверу весь север помещает свою память и передает это все дела до конца на другой ноте в случае если у вас есть 2 backend все происходит аналогичным образом через ту же самую общую память достоинства дню что построено ли pq она уменьшает количество коннектов и таким образом мы можем контролировать flower и отслеживать их случае когда у нас был прервано соединение упала но до или просто были проблемы в сети чтобы можно было откатить транзакцию в итоге что у нас получилось у нас получилось система в которой все возраст из танцы равнозначные при этом с ними можно работать по отдельности в отличие от того как генплан и можно отправлять запросы равнозначен на все ноды и доступны практическая вся функциональность которой есть стандартная пользуясь и все соединения между инстансами они имеют они идут только через через гибку и мы можем при передаче кортежи использовать такие готовые уже встроенные функции как например сжатие данных весь парализуем инкапсулируем специальным картам нотах и все что мы привносим в планер это новые правила и отвечаем только за то чтобы они будут корректной что планирует kare kano воспринимать и строить корректный план а морализм задействуется только там где то необходимо только в том под плане где есть распределенные данные если построенных данных нет то возраст будет работать по как работает обычный возраст без всяких особенности задержек и sharding об running работают при помощи стандартных средств позиционирования и фото и также в этом работа обличает нашу систему это делает и существенно меньше и легче в поддержке для у тебя хорошо то что у нас многоголова хорошо то что план запроса нас не держится как во всех остальных системах мы используем стандартные стандартные распараллеливания позволяем планирую генерировать worker of если он видит что у него много и 1 и можно расправить вполне запроса вот вполне запроса не чем отличаются стандартного возраста если у нас из путь столько вокальные данные говорю и задействуется минимально необходимое количество и состав при помощи механизма про него уже встроенного профессио нирования для холлов мы предлагаем возможность параллельной загрузки данных как в случае обычного позиционирование здесь ничего не меняется мы предлагаем пар низкой не join скором будущем предлагаем агрегаты и сортировки вот и доступные все плане руб адрес и без ограничений поскольку не вносим неких изменений в код рот map начинали мы с того что сделали связку фото в спарте цианирования все это обязали скриптами так чтобы система автоматически развертывалась настраивалась настраивались всех подавай connect и создавались автоматически распределён отношения после мы сделали логическую репликацию ну а не пошла она оказалась очень медленной и мы перешли на физическую имитацию сейчас мы сделали scanjet в процессе агрегаты и у нас есть несколько патчей для того чтобы сделать систему уже применима и для нормальной лап нагрузки это не два как детектор это распределенная миссии это та писи фото которые достаточно давно уже висят в коммент кости и мы рассчитываем их за камень и уже не поддерживать его чтобы они уже были в оригинальном возрасте у меня все здесь 2 ссылки верхняя этого ссылка на проект шарман который находится в состоянии мяч сейчас я думаю что в ближе к августу вы сможете попробовать уже пощупать работающий шарман в составе под газ professional либо стандартно его enterprise а если у вас есть к нему доступ и вторая ссылка это ссылка на сайт проекта там есть это и другие фичи все что мы делаем для мастера все можно там посмотреть у меня все спасибо спасибо большое вопросы господа присяжные здравствуйте спасибо за доклад меня зовут антон я индекса бла который клиенты землю за руку я хотел спросить я правильно понял что распределенная пишущая транзакции тоже возможно да конечно но здесь не напишет 2 шарда и уже чтобы согласовано записалась в оба 0 записалась либо вы не записалось а для этого у нас есть распределенные снапшоты вот если от патчу пойдет ванильные поздра стадо это выпускали круто спасибо а еще вопрос если я хочу добавить shark вы столько киеву и пробитую что же сначала определить количество возрастов который будет потому запускаться если вы там захочу добавить можно так это очень интересный вопрос это был главный предмет дискуссии когда начали работать шарман в чем здесь дело делать в том что позиционирование она не предполагает вот сейчас что вы можете увеличивать количество вот партиций но мы пришли к такого мнения что вы можете заранее это длится не с тем сколько у вас есть только у вас будет сортов а с тем какое максимальное количество шагов вас принципе может быть возле этой базы вы их сделаете ну пусть большая часть из них вы наверное можете распылить по надо под низком они будут там хранится его к ним будет с ними будет работать и в случае если вы хотите нарастить количество серверов и просто один там или сколько наших ртов скопировать перенесете соответственно фатер с ссылке вот так переведете и будете выполнять вот таким образом работает это конечно не так хорошо в случае с тем же самым цвету сам но мы жертвуем один вот для того чтобы я снял вопрос-то задаю себе ск руки в небо вопросы хорошо тогда поощрительный приз за самый крутой вопрос улетает в облака значит спасибо большое тебе тоже сейчас будут супер призы"
}