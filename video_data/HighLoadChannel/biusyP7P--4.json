{
  "video_id": "biusyP7P--4",
  "channel": "HighLoadChannel",
  "title": "Как понять, что происходит на сервере? / Александр Крижановский (Tempesta Technologies)",
  "views": 597,
  "duration": 1389,
  "published": "2017-07-30T00:47:27-07:00",
  "text": "на самом деле идея доклада была в том что уже давно и и бегать в картинка пока не очень много видео на фейсбуке и появилась идея высказать по эту картинку но когда я ее на бал в гугле казалось что это уже есть человек который я собственно создал он занимается оптимизации производительности linux и у него есть замечательный блог там не только вот эта презентация где вот эта картинка ресурсам порядка трех презентациям есть кое-то еще документация в общем призываю ну как до призываю сходить на этот блок там он хочу рассказывает план все вот эти утилиты которые здесь перечислены этой картинке единственно мне не хотелось прямо заниматься пересказом эта презентация это и не хорошо будет поэтому я даю здесь ссылку на нее другой стороны у него в презентации есть очень сжаты поток там часовая презентация о каждой из этих утилит по немножко просто что она делает по сути тоже самое что вы можете найти в маниле попаст набрав название каждой из этой утилиты google и я мне захотелось сделать пару примеров о том как можно найти узкое место и понять что происходит второй что бег дает методологии но начинать смотреть методологии как найти узкое место да там пять вопросов зачем и так далее я не ни разу не позвонил методология просто смотрю что-то делал и хочу показать что можно делать к сожалению я когда готовил презентацию у меня небо под рукой стенда с установленными софтом с бенчмарками то есть я не мог бы повторить весь вот этот сценарий я пытался собрать какие-то логе которые меня были чат и плюс еще воспроизводил какие-то сценарии у себя на ноутбуке на виртуалов их поэтому если какие-то цифры к вам покажется подозрительными они действенны подозрительные и давайте смотреть на них немного сквозь пальцы то нам важно будет больше идея о том что порядок цифр и о том как их посмотреть как их узнать то есть первый пример и основное это что нас в кастомное приложение был модуль engine.exe очень тяжелый модуль но логику мы не будем рассматривать прикладным вот там во проблема в том что людям хотелось очень много connect авто есть построить очень мощный points и много коннектов не получалось то есть там остановилась все порядка там 200 50 мегабит в секунду afek входной был очень много параллельных соединений и собственно вот на таком достаточно склонам трафике нас полностью все выжигались ресурсы и ничего не происходило то есть новые к connect и новые запросы по согласовались ну посмотрели первое что мы делаем это смотрим над стад делаем грэм где вам еще один гриб здесь вот у нас уже в нас кстати более 20 тысяч соединений и у нас там вот эти потоки то есть вот понятно что когда у нас происходит проблема производительности у нас система себя чувствует очень плохо и когда мы запускаем staton вот двадцать назад он висит очень долго с гриппом поэтому если есть возможность лучше работать с блоком она на самом деле всегда есть и написать скажем в к скрипт который будет не попами работать а сразу почитают одну строку испуг разберет ее и выдаст вам результат посчитает будет немного быстрее будет комфортнее работать 2 что делаем для понимания того что происходит это ps посчитать входящие пакеты здесь я не использую ни какими сложными вещами просто я беру счетчики пакетов счетчики байтов вот собственно как по получено тайцев и дело стоит на 10 секунд чтобы не видеть какие-то флуктуации и потом дебилка вычитаю одной из другого делю на 10 первое что мы делаем это запускаем топ обычный в топе какая-то картинка она но в целом она ничего такого криминального нету то есть индекс у нас не сто процентов процесс уезд смотрим вот этот экшен тоже в общем принципе нормальный подозрительно здесь то что у нас системное время 33 процента и софт интеравто 52 процента то есть фактически у нас индекс молча делает но у нас много делать виду а кольцо на систему и также мы видим что вот у нас есть две нитки к software куда это вот как раз я воспроизводил себя внутри виртуальной машины и вы там всего два и два болта есть два сетевых поток обработчика они поднялись топ смотрим есть полезная кнопка в топе это просто надо нажать единичку она вам покажет вот не сумма на статистику по процессам для каждого процесса индивидуальную здесь мы видим хорошую картинку что у нас в целом процесс свою работают равномерно если у нас процессор 1 выкручиваться наступая центр другие лежат у нас явная проблема со спреем нагрузку то что в после презентации было например пай mosaics если у нас пакет в основном идут на 1 и 2 на одно прерывание остальные отдыхают здесь у нас распреде неплохой был я люблю вот этим пользоваться это нехорошо она крестьянский метод но в целом gdb с другой стороны дает очень мощный интерфейс то есть вы в цикле можете задать скрипт для gdb по всем вашим процессами джин exam и посмотреть что с ними делается здесь мы смотрим просто верхушку стека первую вторую функцию но в принципе вы можете сделать более интересные вещи вы можете только бактерий собирать вы можете какие-то перемены распечатывать и так далее то есть это достаточно мощный механизм для того чтобы в реал тайме заглянуть внутрь сервер и посмотреть что с ним делать посмотрите в состоянии но при этом сильно не не останавливать то есть вот этот скрипт он как тормозит там понять девушка джексу становится еще хуже но в целом она она работает можно это делать в реал тайме если запустить в этот скрипт не сказалось то в там даже пост вот по несколько процесс в низком потоком можно видеть что они какие-то потоки большинстве своем проводят время в одной из двух функциях это как раз наш battlenet будет если у вас всего один потока или процесс который вас интересует после не сказать запустите и в принципе можно понять что вот постой сам прием не такое ну еще не сказал что в данном случае мы видим здесь просто apple ipad и не очень интересно газа интереснее сама увидели usa списка тут-то в том случае сказал мы начинали там был из списка там было были регулярно выражении который мы обрабатывали там было бы танк в нашем случае сейчас то что мы рассматриваем следующее что мы делаем поскольку мы видим что проблема не в джон exe проблема в системе мы идем в систему смотрим что как у нас учет в себя призван к то есть на данный момент мы уже от секре поделили зону поиска женщин операционки есть удобная утилита пев топ собственно это крейсер едва и он вам может показать вообще все ваши процессы в системе конкретных процессов конкретный процесс как у его код из соответственно здесь мы видим что основное время у нас катится вмф конфликт в целом не очень понятно видно что последние две строчки индекс мы понимаем что там какой-то прикладной код он для нас не интересен потому что мы знаем что джон x уже не наш вот он это то что мы ищем мы ищем внутри операционной системой нас интересуют те первые три вызова соответственно 1 для того чтобы найти что-то коинов к тета п куб опять же удобно иметь исходники ядра под рукой то есть я не говорю о том что всем нужно разбираться внутреннего но просто сделать грэб внутри едва вот то что я сделал вы достаточно можете легко понять или бы тоже просто на благо гугле вызов которого вы видите в пифе он может быть сначала быть непонятным но достаточно быстро можно найти вообще пока мере что это запад систему то есть не нужно знать точно что делает этот системный вызов это эта функция едва вас понимать что из-за по систему в какой по системе у нас тормозит и дом ответ на вот после делаем глеб я на самом деле сделал общей глеб рекурсивную внутри директории я нашел как конфиг где он лежит и там есть описание человеческого то что вам выводится при конфигурации 2 что делает эту систему дальше мы идем в google мы сможем что такое can треки мы видим достаточно много сообщения о том что конфликте тормози а система на входной трафика не имеют смысла в частности для htpc мы их можем отключить для того чтобы убедиться в том что мы действительно нас ну как и все сошлось да все наши данные мы распечатываем качество соединений которые сейчас посадка на треке видим там примерно то же самое число что у нас есть часов установленных соединений конфликте в линуксе это по систему кота по симон боевого который отслеживает наше соединение то есть вот пример ярких типе когда у нас идет одно соединение по нему отдается под и собственного эго должен пастей 1 2 соединений связать их и вот эта система у нее есть достаточно медленно медленно функция которая начинают мочить все соединения на пост работы в холостую мы она ничего не делает поэтому мы ее можем отключить с первым ботаником разобрались давайте посмотрим на следующий in the white честно говоря первый раз там я подумал о том что это адрес какой ты на самом деле опять же делаем глеб внутри ядра уже в конфиге ничего нет потому что упс потому что всегда это все включено но зато энту заводчики то позаботьтесь о том чтобы сделать хороший комментарий внутри исходника и мы видим что просто вот наш процесс это что тратит время впустую он тратит его внутри этого потока этот поток хорошее это значит что у нас поставят процесса какое-то время и мысли ничего не делаем следующее . опять же делаем глеб мы видим что у нас директория блок ссылки и он пони вовчик и мы понимаем что мы имеем дело с пони ящик ввода-вывода значит наверно джексона что-то воли выйдет выводит при этом бог а его это значит о том что нас файл с тем и это не сетевая часть то есть его часть она находится в нету первое что ну как без так происходит мы хотим посмотреть статистику ввода-вывода вот ты а сатана нам помогает это сделать мы видим что у нас идет массивная запись и что вот диск он как-то там используется на 15 20 процентов не очень много но как бы то там тратится время дальше ну вот когда мы сделали посмотрели первых топ мы на самом деле видим что это у нас операционная система проводит в воде выводе это в целом не значит что и джон xpm его делает то есть это может быть к свадьбе да это потому что бывает это может быть какой то там не знаю а bad baby поднялся демон у нас по hon'у который запускает какое-то обновление баз данных может быть у нас там покажем менеджера обновляется что угодно то есть по-хорошему когда мы видим что у нас в системе происходит нагрузка на ввод-вывод нам бы хорошо посмотреть все таки убедиться что кто кто этим занимается и у нас есть его топ аналог обычно топа но для ввода-вывода и он нам как раз показывает кто кто нам период такой вот вывод видим что engine x следующее что мы делаем это смотрим что же нам яндекс делать вводом-выводом есть при клана утилит estrace которая находится между на стыке между описан системы и прикладным процессом она выводит ставит хуки на все системные вызовы я просто взял догадался о том что нас будет в elite я поставляет я до этого специально ничего не делал и получилось на самом деле у нас системных вывод вывоза вызовов не так много то есть здесь вот правильно было вот минус и там white , white в и наверно наверно все то есть вот если мы знаю что файл вот вывод тормозит он там достаточно бы небольшое количество пьяных вызов которые нас будут интересовать второй вариант здесь ну как мне подфартило да у меня как бы чистый вывод у меня есть оно там было очень много таких лайков в реальности у вас может быть очень плохая ситуация когда вы увидите просто мешанину системных вызов там будет и пол обязательном будет какой-то риты сокета да там будет white иногда их там ну тяжело понять что это такое можно также на запустить из мест с откладываем файл потом этот файл глоба твоим скриптом который нам стоит статистику по системным вызовом и мы понимаем какой системный вызов у нас в топе и соответственно вот в топ системных вызовов ищем системный вызов записи это будет white и соответственно вот по уайту мы видим что у нас первым аргументом white идет file descriptor 8 и ну правильно пользовать своего со foam я им так и не научился пользоваться я пользуюсь о кфс я иду в директорию этого вида директория в.д. смотри убью что находится в восьмом дескрипторы это access волк ну не удивительно еще сценарий это презентация на короткое конечно много чем больше последний сценарий это что делать с у нас в топ молчит если он нам показывать хорошие цифры что нас там системе все хорошо а мы знаем что нас не хорошо такой пример вот я просто взял свой биг мак это бишма который нагружают очередь синхронизации в ньют иксах и посмотрел топ что говорит то есть он говорит у нас что у нас очень большой пойду и если мы не из печени и выводим персию статистику то у нас будет порядка 130 процента использование процессов при том что у нас там должно быть 400 то есть видим что как бы статистика вся хороша но ведь маг он по своей идеологии он должен полностью утилизировать все ресурс он этого не делает давайте посмотрим что происходит здесь мы делаем снова из trace но мы зовем уже минус п и минус c здесь вот минус c позволяют нам собрать засечка по системному вызовом почему мы этого не сделали тогда дженкс почему я сказал что нужно брать какой то скрипт и посети вывод с и дело в том что стараясь генерирует в эту статистику по завершению программы которые он пасёт который ту силует и если вас там работает индексу не хотите прервать то вы не получите этой статистики to seek надо собирать маму здесь средстве нам показывает трассу какие системные вызовы у нас чаще зовутся время внутри этих системных вызовов и видим что у нас фьюд экс есть мы берем man фьюд экс то мы увидим что это механизм операционной системы который использовать для синхронизации usa space в этом jx и наши ип ответ ответ воке условно перевода переменная использую как а среди на этот вызов и у такс это значит что у нас проблема с синхронизацией вообще говоря если вы видите такую картину что у вас вот вывод хорошие у вас процессор хорошие у вас вообще все хорошо и памяти хорошо но там количество fps of вы не достигаете какой-то значило контент шин что и вот как раз вот эта цифра 130 процентов она не случайно очень то есть во время его контент шон когда у вас четыре процесса делается за одну блокировку у вас только в каждый момент времени только один процессор может что то делать то есть по сути вы из четырех процессов получаете один и мы получаем еще до панчин и 30 пациентов только за счет дополнительных расходов там на планировщик еще на что-то который вот еще дают нам чуть больше 100 процентов но вот это такая природа коттедж вот все вопросы спасибо за доклад вопрос чуть-чуть такой ламерский но я же junior так что мне можно можешь объяснить в кратце вот ты сказал что лоты вич выглядеть нормально можешь объяснить вкратце что означают эти цифры и как понятно какой хороший какой нехороший ну вот ты видишь это такая к угольниками до вокруг которого часто сходит обсуждений на самом деле он показывает сколько у вас в среднем процессов ну task-ов di2 все на процесс либо поток находится в очереди на выполнение в ожидании то есть у вас вот есть мы на первую цифру смотрим 156 это значит что среднем там по моему первые цифры то там на я на 1 минута в одну минуту среднем у нас там чуть больше 1 1 задача стоит в очереди на выполнение состоит в очередь на вполне и она может либо она ждет пока другой процессор процесс работает на процессоре либо находится в воде выводе то есть его то верит что это некая такая пока показа показать насколько у вас высокая конкурентность в системе из там как часто происходят постой то есть вот хорошего ты вич это когда у вас тут одна задача на каждом процессоре работает она ожидает так плох когда у вас дерутся задачи за ресурсы пор когда у вас ресурса не дорабатывают как скажем мы видим что у нас вот там наборе подождите на время на 15 минут у нас вообще 0 2 задачи стоит это вот такой вот увидишь потому что вот я только запустил рынок сделал биг мак и сразу посмотрет опыта у меня них как бы статистика вот она в моменте собрана на подошли вы будете видеть более ровные более ровно характеристики вот я ответил спасибо за доклад а вот можно вернуться к слайду где профилирования по-крестьянски а да да вот у меня возник вопрос а как не по-крестьянски они крестьянские тапиров а вот перф вот вы тут же нужно собирать вот все вот эти вот дебаг символы чтобы вот эти все функции показывались а это вот не всегда возможно есть какие-то более такие вот упрощенные вот варианты когда мы не устанавливаем на продакшене дебаг символы для функций но в то же время можем провести профилировка вот системных вызовов либо стыка но тяжело то есть если вы вообще engine xiii-2 не устанавливать тяжело ну во первых у вас здесь будет адреса их не при пони нету пример но вот например вместо там цевки ac3 кресс у вас будет нектара дышимости речной вы его можете посмотреть пока у sims это там вас сводка идет всех вызовов наверно там не будет имени функции вас будет там адрес вы нас к насколько лапами есть практика что вы можете выглядеть ваш виду он другую машину с ее иди важной силой то есть в случае бина дистрибутив тандеме на i had вы можете это делать то есть там одинаковые 2 и уже там посмотреть поэтому по этому адресу какая находится функция понял по сил"
}