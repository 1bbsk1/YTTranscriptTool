{
  "video_id": "4eEUrB5oad8",
  "channel": "HighLoadChannel",
  "title": "Выбираем СУБД для хранения временных рядов / Павел Филонов (Лаборатория Касперского)",
  "views": 9461,
  "duration": 3359,
  "published": "2017-04-22T14:48:05-07:00",
  "text": "Спасибо большое спасибо всем доброе утро действительно большое спасибо что пришли я понимаю это достаточно тяжело приходить на первый доклад вообще я заметил одну интересную особенность в последнее время почему-то разные организаторы на разных мероприятиях ставят мой доклад в открытие какой-либо секции с одной стороны Мне очень приятно потому что я думаю ну Наверное они считают что это интересная тема она будоражит ему людей и красиво именно с неё начать а с другой стороны я думаю ну с утра же ещё никто не приходит никого нет может надо Наоборот поставить самый худший самый скучный самый неинтересный чтобы все остальные просто затмили его вне зависимости от того По какой причине я стою сегодня перед вами первым большое спасибо что пришли мне очень приятно что организаторы ое мероприятие разрешили прийти и рассказать о некоторых задачах проблемах которые стоют перед инженерами из разных областей и то о чём я сегодня буду рассказывать касается одной из задач которой я недавно занимался которые недавно решал вот некоторые результаты решения хотелось бы рассказать поделиться может быть вызвать на какие-то вопросы на дискуссию чтобы тема не осталась такой не заме раз потому что меня много неот вопросов может знаете ни Рани временных рядов и почти всегда вот в последнее время в своей практике я замечаю что придумывать что-то новое для решения задач стандартных уже почти никогда не надо почти всегда нужно просто выбрать как выбрать йогурт в магазине Вот вы приходите вот там вот полочка там эти ряды все заставлены и нужно решить какой Вам выбрать привычный попробовать новый либо самый вкусный либо самый полезный и все они яркие красивые с реклам все лучше один другого вот великие ещё давно говорили о том что это большая проблема о том что вот эти вот яркие занавески могут немножко затмить наш выбор как же нам попытаться Ну всё равно честно объективно полностью не получится всегда будет субъективизм в выборе Иначе быть не может но может быть можно как-то этот субъективизм нивелировать может быть зажать в какие-то контролируемые рамки чтобы что-то из этого получило вот сегодня я постараюсь рассказать Какие подходы я применял для того чтобы попытаться как можно больше своего субъективизма выкинуть заменить его чем-то более объективным а субъективный взгляд вставить где-нибудь в самом конце перед этим правда я хочу сначала поговорить немножко о задаче которая стояла на мой взгляд понимание задачи Вот реальной который Ну в каком-то смысле пощупать можно Оно всегда проясняет ситуацию оно лучше позволяет понять Те либо иные решения которые были сделаны поэтому я начну с Джона макклейна Это Джон такой мой герой а а кто вот в детстве когда смотрел как он бьёт террористов хотел быть таким же как Джон макклейн Ну не все Да я вижу Вот я очень хотел я смотрел как он в первой части бил террористов во второй в третьей и мне начало казаться недавно совсем недавно что я чем-то похож на него ну тяжело увидеть сходство я понимаю наверное не внешнее а чуть-чуть чем мы начинаем с ним вместе заниматься в частности в четвёртой части своих похождений он бился уже не просто с террористами он бился с очень вредными кибертерроризма газовые станции пытались сломать линии электроснабжения которые пытались перестроить светофоры в большом городе представляете Что будет если хаотично перестроить светофоры в Москве возможно ничего неме но есть подозрение что не стоит этого делать сразу фильм Вышел в 2007 году он был шутовской юмористические Ну какие там эти кибертерроризма возникла чуть позже после выхода фильма примерно в 2010 году когда Похоже что фильм посмотрели многие некоторые даже прониклись к сожалению не все из те кто прониклись люди хорошие в частности вот фраза название которое середине это один из достаточно популярных зловред который был обнаружен порядка 6 лет назад у которого было много умений много назначений и вот Одно из самых неприятных его назначений было взлом систем автоматизированного управления технологическими процессами асутп и нанесение уже не просто коммерческого вреда путём кражи информации либо стирания чего-либо а перепрограммирование технологических процессов на нанесение физического вреда в частности изза его действий программа обогащения урана помоему в Иране была откинули назад он просто вывел из строя часть установок по обогащению ситуация К сожалению повторялась несколько случаев были официально зарегистрированы были созданы отчёты которые подтверждали что эти заводы выходили из строя Не сами по себе а непосредственно в силу испытывая некоторых Атак целевых Атак на асутп и эта задача начала приводить к поиску решения это проблема Многие считают что это проблема в асутп не всё очень хорошо с безопасностью надо туда привносить новые элементы безопасности и стараться защищать эти объекты Ну что за объекты вот чтобы какой-то образ был перед головами я взял просто какую-то картиночка какой-то заводик скорее всего нефтеперегонный который делает очень важную полезную вещь и нам нужно пытаться его защищать от тех угроз которые могут на него смотреть со стороны Кибер сти эта задача сложная она очень многослойная я бы сказал на этот заводик можно взглянуть с разных ракурсов Например можно смотреть с точки зрения сетевого поведения рисовать топологию сети смотреть кто с кем взаимодействует кому можно с кем взаимодействовать Кому нельзя Это один слой решения можно спускаться ниже и следить за тем как ведут себя конечные станции Какие программы на них запускаются это разрешённые программы или запрещенные программы можно следить за этим слоем Яра вде кото находится нагом ра именно сам технологический процесс как включаются реле работают конвейеры нагреваются баки гоняется жидкость по трубопроводам и мы например смотрим на этот объект Примерно вот так любой технологический процесс по сути есть динамическая система которая во времени меняется она многомерная у неё много характеристик здесь я нарисовал пять рядов для среднего обк может може десятки ме будут выглядеть наши данные глазками и конечно основная задача - это обработка на потоке Ну потому что исторические данные по взлому интересны но не столь Но для того чтобы её реализовывать эти данные Не только нужно обрабатывать но и желательно где-то сохранять для исторических расследований для форен сики например Нам очень важно сохранять большие объёмы исторических данных для обучения наших систем онлайн обработки и вот отсюда начинает возникать уже конкретная Техническая задача если у нас есть вот такие данные про модели расскажу чуть-чуть и у нас есть и характеристики с которым эти данные поступают в систему Как нам наиболее разумно и рационально организовать подсистему хранения которой мы будем доступа для того чтобы проводить исторический анализ либо запрашивать для наших конкретных исследований и Вот так мы приходим уже к проблеме перед проблемой правда немножко о схеме данных ну чтобы совсем чу-чуть по конкретики вы представляли О чём идёт речь уже на таком немножко а конкретном языке Вот одна точка в одном ряду характеризуется обычно тремя числами Это её некий идентификатор номер канала 42 температура 14 давление 13 включение выключение реле возможно момент времени когда что-то изменилось в этой динамической системе и значение на которое она поменялась значение может быть вещественно значные может быть целочисленные может быть логические Ну вещественные значные описывают их все чуть-чуть о характеристиках чтобы было видно что наверное это имеет какое-то отношение к тематике конференции там не так всё просто с объёмами К сожалению для среднестатистического объекта количество таких рядов насчитывает порядка десятков тысяч в исключительных случаях может быть на порядок больше с интенсивностью слава Богу чуть-чуть получше обычно значение сенсоров собираются в среднем раз в секунду Может быть чуть щет чуть медленнее ре характеристики примерно таковы и мы начинаем чуть-чуть уже пытаться представлять себе объёмы в которых нам предстоит работать Это очень важный момент потому что по сути из этих чисел можно начать выводить то без чего Ну я например очень некомфортно себя чувствую без нефункциональных требований когда иногда говорят Ну сделайте чтобы было быстро и хорошо а я не понимаю таких слов я начинаю пытать человека а что такое быстро а что такое хорошо а какие у вас данные ва интенсивности только после того как вот этот чек-лист пройден и основные пункты известны я уже могу начать пытаться хотя бы представлять себе решение но там правда тоже не всё так просто там много решений там совсем но далеко не одно я уверен что каждый из вас может спокойно сейчас вписать в этот список ещё пять своих любимых сбд Конечно все здесь просто не поместятся Они разные какие-то хорошо работают в одном случае какие-то лучше работают в другом случае какие-то наверное хорошо работают именно для той задачи про которые я рассказывал Ну какие Как понять как выбрать это большая проблема Я сталкиваюсь с не часто и постоянно придумывать новое уже нужно очень редко почти всегда нужно просто разумно выбрать как-то из этого набора есть несколько подходов к этому выбору первый Я его назвал не Инженерный подход К сожалению Ну может быть я не знаю к счастью К сожалению иногда пропагандируется Ну какие примеры инженерного подхода Ну например вот такой всё хранили в X Давайте и здесь использовать его же неважно что задача другая предметная область другая мы знаем как работает X или вот такой больной такой способ когда вот мы там Вот его использовали не надо этого делать Вот ни в коем случае пожалуйста я и такие встречал Вот это мой любимый Да дада да я чувствую многие со мной солидарны но опасный чуть-чуть чуть-чуть опасный Да но любимый Согласен мы же на конференции с вами здесь рассказывают про базы данных я наверное не помню конференции Где больше рассказывают про базы данных чем здесь и конечно первое что приходят люди после на следующий день на работу Скат нам там про такую тура сказали Давайте пробовать Вот этот мне тоже очень нравится вышла статья где-то там всё здорово графики просто экспоненциальные наверх летят наверху доллар нарисован все радуются Давайте выбирать вот этот А конечно слайд юмористический но Давайте будем честны А кто вот Может сейчас смело стать представиться и сказать что действительно я такой-то я раньше использовал не Инженерный подход а можно попросить кого-нибудь из помощников вот пожалуйста микрофончик Представьтесь пожалуйста и скажите это смелее я Владимир Мясников мы использовали подход А давайте возьмём и А там уже разберёмся Спасибо большое Вла Давайте пору это как такая часть терапии Вы знаете да чтобы бороться с проблемой Надо сначала её осознать и признаться самим себе Вот Владимир явно смелый человек и многие здесь смелы они готовы признаться что это плохой подход может быть есть другой Давайте назовём его Инженерный Наверное он чуть посложнее может быть он даже как-то структурирован и декомпозировать клада сначала неплохо всё-таки почитать что есть что появилось за последние годы потому что вот я со страхом жду когда ко мне в Фидлер 10 новых баз данных которые вы должны Выучить за эту неделю Я чувствую что рано или поздно это произойдёт поэтому там появляется всё С такой скоростью Что трудно успевать следить и надо знакомиться постоянно с литературы в том числе путём того что вы слушаете на конференциях кто что попробовал кто чем доволен кто чем не недоволен и таким образом мы своё свой опыт распространяем на других людей вообще говоря Было бы неплохо понять если мы будем выбирать По каким критериям цена скорость масштабируемость с ними нужно определиться выбирать по всем критериям невозможно скорее всего нефункциональные требования ваши могут Вам подсказать Какие из критериев в данной задаче и только в данной задаче вам стоит рассматривать в первую очередь а какие во вторую Ну вот это самый интересный такой долгожданный путь Надо же выбрать кого сравнивать должны быть конкурсанты к сожалению сравнивать всех тоже сложно должен быть какой-то предварительный отбор Когда ещё до того как вы дошли до конкретных цифр вы понимаете что это похоже может подойти как решение А это не может Или вы просто понимаете что у вас не хватит сил померить всё И тогда нужно выбирать то что вам кажется наиболее адекватным пока Но конечно из одного пункта список вряд ли этот будет состоять вряд ли даже из двух Вот про четвёртый пункт я буду говорить наверное больше всего если мы выбрали что мы меряем и выбрали даже кого мы Мерием дальше очень тонкий и очень интересный вопрос как мы это делаем потому что даже если два чело взять двух людей и они выберут что они меряют одно и то же и одних и тех же они могут делать совершенно по-разному и цифры могут получаться очень разные поэтому где-то может быть я буду уходить в лишние нюансы но на мой взгляд это самая интересная часть А как мерили это как воспроизвести хотя бы это тем либо иным образом здесь мы посвятим много времени этому Это достаточно такая тяжелая часть потому что потом её надо реализовать она самая такая долгая требует какой-то трудозатрат работ об этом Мы ещё поговорим вообще провести Вот это тестирование для каждого из конкурсантов понять какие Циферки для ему соответствуют это нужно делать руками даже писать код Боже мой кстати Реутов по недостаточно Если вы прине красивую табличку с фми вот результат Ну хорошо и что должен быть анализ цифр недостаточно всегда за цифрами должны стоять нормальные слова которые объясняют их они их раскрывают пытаются донести всё-таки смысл этого результата а не просто оставить е в виде голых цифр сказав Ну всё и так понятно Ну и в конце вки требуются уже какие-то конкретные рекомендации при могут совсем строгие что вот только вот это подойдет и всё на самом деле естественно решений может быть несколько надо говорить Может быть с какой долей уверенности подойдёт то либо иное решение в виде отчёта и конкретных рекомендаций сложный подход вот когда я его записывал больше ТХ пунктов это вообще сложно а тут их получилось аж на целых во и это пого вини затра действительно нужно потратить на это время человека часы как если хотите какое-то усилия Хотя Казалось бы давайте возьмём и А там уже дальше разберёмся подсказать Владимир но здесь если мы тратим время мы для чего-то это делаем где-то мы хотим его сэкономить Вот например я в своё время понял что тестирование очень экономит время на разборе багов может быть и здесь мы можем сэкономить время это возможно Вот кто сталкивался с ситуацией когда Ему приходилось от релиза к релизу в продакшене менять базу данных Да вот мало людей сталкивались А кому это нравилось здесь вообще рук нет Вот это очень опасно если выбор сделан был необоснованный и слепой У вас есть риск не попасть в нужный нам вам не функциональные требования Особенно если они начнут меняться у кого они менялись в своё время да такой тоже возможно поэтому эти трудозатраты они могут быть окупные их трудно предсказать сколько они вам окупит времени но поверьте иногда это того стоит вот наш план Давайте по нему пойдём начнём с критического обзора литературы Я в основном расскажу что мне не понравилось когда начал читать какие-то Вот конкретные моменты например очень много сравнений баз данных для той любой задачи проводят Как вы думаете кто сами разработчики этих баз данных Я заметил стопроцентную корреляцию вот действительно стопроцентную если разработчик придуманный мной только что базы бинго-бонго проводит сравнение то там побеждает Кто знает правильный ответ там побеждает бинго-бонго Да всегда удивительно неважно какое сравнение идёт Меня смущает этот результат я не готов сразу доверять ему вот просто так я вообще я очень доверчивый человек вот по жизни да но когда я одеваю кепку инженера вот я сразу начинаю во многом очень сомневаться например вот в таких обзорах другой интересный момент который меня они получили такую цифру а мы такую цифру у них там были одни данные у нас другие данные у них одни сервера у нас другие сервера вообще что вы сравниваете там тоже не очень приятно Есть и более хорошие источники в конце слайди ков для желающих будет ссылка на то что мне понравилось как раз и большая часть авторов говорит что если вы хотите действительно выбрать грамотно решайте вашу задачу Не смотрите Какие данные у них и какие профили нагрузки у них Возьмите ваши профили нагрузки Возьмите ваши данные и мерите только на них только эти цифры и то не на 100% уверенности вам дадут представление о том как это будет работать дальше длительное время почему не на 100% Скорее всего вы если у вас система должна работать 2 года вы вряд ли будете 2 года её тестировать снит более осно сильно уменьшается Давайте о критериях что мы будем сравнивать Я выбрал для своей задачи самые важные Тут не все критерии по которым можно проводить сравнения я не буду говорить какие я отбросил Давайте скорее оставлю на дополнительные вопросы а почему вы не сравниваете по этому критерию я-то расскажу про то про чего сравниваю например проя способность на запись для меня вот это важно Мне нужно успевать тут чтобы она сохранялась падала на диск И выдерживала те нагрузки которые у меня проса Но вопрос оказался Очень непростой невероятно непростой вот когда я вижу где-то статью г про способность столько-то Я начинаю сомневаться А в каких условиях тестировалась потому что на мой опыт там всегда зависимости Например Она меняется с размером Бача сколько Паке данных за раз мы пытаемся сда записать она меняется От количества клиентов которые Пит Бау данных даже немножко Например если мы пишем 5 минут может быть одна цифра а если 12 часов то там могут появляться другие цифры которые не всегда Похоже на то что называется обычно пиковая производительность и Похоже что этот критерий сам по себе уже не очень триан его уже можно рассматривать с разных сторон вот эти три стороны с которого я в этом докладе буду рассматривать эту пропускную способность дальше Ну мы же не просто пишем мы же наверно потом будем спрашивать что-то будем оттуда читать поэтому нам важно чтобы это было достаточно быстро Ну для моей задачи сравнительно быстро я расскажу ть подробнее когда мы доберёмся а там тоже правда Надо выделять характерные запросы Какие запросы характерны для вашей системы вот в задаче хранения метрик для индустриальных объектов бывает обычно важно за Какой интервал мы запрашиваем нам нужна выборка за день нам нужна выборка заде если оче нужно нам нуж выборка за недели или за месяц интересно посмотреть как зависит время исполнения от вот этой величины может быть короткие запросы Бут отрабатывать быстро А что если нам Обычно нужно за неделю а не за оди час надо будет смотреть на разных интервалах Поэтому в зависимости Ну и очень такая важная характеристика тоже для меня степень сжатия слава Богу даже по самым таким хорошим расм эти данные можно уместить на одну машину я считаю Мне повезло очень повезло что я могу потенциально записать это на одну машину может быть ещё скап дополнительно Но для того чтобы всё равно гарантировать что жёсткий диск не переполниться это очень неприятная ситуация когда на сбд переполниться жёсткий диск желательно понимать сколько всё-таки конкретно нужно потому что если мы знаем объём входной информации на жёстком диске он совсем другой он может быть иногда даже чуть больше за счёт дополнительной Мета информации а иногда сильно меньше Если встроено хорошее сжатие поэтому тоже это следует обязательно померить Вот наши критерии Вот про них я буду говорить в первую очередь ну и начнём мы сной способности Наки это наиболее одна из интересных характеристик не такая тривиальная правда как оказывается А наши конкурсанты скорее всего у многих вас всплывёт Почему Я сравниваю специализированные решения А это они вот мы только это наша вона мы ничего больше не умеем хранить практически СД общего назначения ведь Казалось бы скорее всего ответ будет очевиден что по многим характеристикам специализированные лучше Отт вот Но что если у вас все решения влазят в нефункциональные требования Стоит ли вам городить зоопарк разных систем ведь Скорее всего вы будете хранить не только там сес скорее всего у Вас есть ещё какие-то метаданные и какие-то более богатые по модели данные скорее всего их тоже надо будет куда-то складывать что если не платить зоопарк специализированных решений А показать что одно решение справляется из тем и с тем поэтому мне было интересно взять решения которые в принципе уже для того чтобы посмотреть насколько они хорошо справятся с данной ситуацией для того чтобы в крайнем случае не платить зоопарк вот у кого бывало Так что несколько баз данных в проекте А давайте вот у кого бывало две у кого три У кого четыре у кого пять О вот Осталось несколько людей вот это тоже ведь не очень хорошо Да вот коллеги со мной согласятся Спасибо Не ну это укладывается хорошие требования но администрирования это не очень удобная вещь вот о этих четырёх мы будем говорить Ну чуть-чуть цифро куда без цифр что мы с чем сравниваем здесь тоже этот слайди очень важный потому что я здесь хочу такой дисклеймер вставить и чтобы вы его поняли я буду сейчас замерять не СУБД я буду замерять их в целой связке То есть я меряю автоматически как бы и клиента потому что мне не очень честно горя Интересно как работает цбд я их не продаю Мне интересно как они будут работать именно в моей задаче в моей инфраструктуре с моими клиентами с чем-то приближенным к реальности поэтому учтите и это очень важный момент что цифры которые я буду приводить они касаются не чистых сбд они ещё привлекают всё что здесь описано то что там есть докер Ну куда сейчас без него очень удобно мне нравится там есть специфические клиенты А у которых есть очень одна интересная особенность У них ещё не очень оптимизированные драйверы для хранения Поэтому в некоторых местах там могут быть проблемы с драйверами А И это реалия нашего мира не в каждом языке программирования У нас есть идеальные драйверы для всех тбд которые намм нужны иногда в этих драйверах у божим есть баги иногда эти Баги по производительности и с этим Нам тоже нужно справляться и это понимать Ну а теперь уже к самому интересному вот графики пошли про брусно способность вот очень сложная штука вот я долго пытался понять что же это такое Что это за величина Это число это зависимость это Не дай Боже интеграл слава Богу оказалось вроде бы что нет Я попытался сначала всё-таки понять что я буду мерить И как я это сделаю давайте я попытаюсь прояснить Что такое синий график и как он построен это уже о методиках тестирования У меня есть ручка громкости очень простая сколько я буду пытаться записывать У меня на самом деле две ручки сколько у меня сенсоров в системе И с какой частотой они логит свои значения Например я могу крутить число сенсоров зафиксировал что каждый из них логит раз в секунду свои значения и тогда я начинаю крутить ручку по горизонтальной оси Вот моя как бы ожидаемая пропускная способность то есть 20.000 - это 20.000 сенсоров и каждый из них раз в секунду логит значение Что такое вертикальная вось где собственно синий график отложен А это мы берём вольтметр аккуратненький и начинаем мерить А сколько мы реально записали ВД причём это делать тоже оказывается можно разными способами хитро например Здесь каждая точка Ну они понятно с аппроксимации получена способом сду запу ско назми каждую секунду логи сколько Мы записали в эту секунду строим гистограмму Вот таких вот распределений этих точек и выбираем медиан очень классная величина Мне она нравится это такая осная способность левее которой находится половина ровна из вот этих точек которые мы померили то есть это нам гарантирует что по крайней мере половину времени мы писали С такой скоростью и не меньше неё иногда можно выбирать среднее Но вот здесь оно даст вам меньшую цифру Почему среднее Просто усреднение оно чувствительно к выбросам что если у вас там случайно жёсткий диск был занят какие-то количество времени или кто-то ещё подключился к вашей системе что-то там сделал на пару секунд тогда у Вас могут несколько раз несколько секунд быть провалы такие неплохие вот среднее оно очень к этим провалам чувствительно я здесь его не стал рисовать но среднее Оно всегда меньше и оно в этом случае на мой взгляд не показывает примерно реальное положение вещей медиана показывает лучше что Ну вот мне понятно Что означает по крайней мере Половина времени мы будем писать не медленнее чем столько и вот начинаем подбираться к самому интересному наверно обратили вот пологой уровень то есть мы ручку громкости крутим А громче не становится Ну Казалось бы наверное оно есть вот она пропускная способность вот больше в эту сбд записать нельзя казалось мне сначала Но что ЕС мычу поем способ как мым не по одной точке за раз а по две точки за раз что тогда получится а получится другой график красненький когда на каждый insert мы делаем insert мы вставляем не одну точку а целых две и крутим туже самую ручку оказывается Вот этот порог он поднимается Так что же такое проя способность Синенькая или красненькая И вообще почему так здесь Мне на ум приходит Ну глупейшие пример вы меня Извините но мне он как-то близок мало имеющие отношения к сбд Давайте предположим такую картину что вечером компания хорошо отдыхает развлекается и решает отправить кого-то за бутылкой молока Мне кажется здесь лучше всего подойдёт молоко что делает О одевается обувает ключи выходит спускается на лифте идёт в магазин ищет полку берёт молоко подходит к кассе делает пик берёт это пакет бутылку поднимается раздевается приносит в холодильник Всё мы с вами сделали систему с пропускной способностью одна бутылка молока за то время пока он сходил А теперь мы подумаем А что если ему попросить взять две бутылки молока в чём эта разница будет по времени Ну то что на кассе будет не пик а пик-пик а всё остальное время будет одно и тоже и мы получим систему которая имеет пропускную способность почти в два раза больше если Мы возвращаемся к мирус БД то что как эта сценка будет выглядить Наверное это подготовка запроса открытие сокета установление сетевого соединения отправка запроса на стране сервера на парсинг запроса подготовка его исполнение возможно подъём жёсткого диска подготовка ответа сериализация Ответа упаковка отправка в сокеты на стороне клиента разворачивание чтения Вот наверное здесь если тоже попросить записать две точки не одну мы вот общие кусочки позволят Нам начать немножко экономить Интересно есть другой подход оказывается другая ось которую можно покрутить А что если мы двух человек пошлём за бутылкой молока что если мы будем стать в два потока там тоже есть интересный эффект мы действительно делаем это быстрее чем в один по одной точке зелёненькая - это два потока но по одной точке за раз любопытно кста что они наложили друг на друга чуть поме колебаний но всё равно характерная медианы меньше чем у красненького то есть есть две оси можно ещё две ручки крутить можно крутить сколько мы пишем за раз и можно крутить Сколько клиентов у нас пишет эту систему Давайте их покрутим это интересно вот эти ручки их можно крутить смотреть что получается Например будем крутить батчи это одна из моих любимых ручек она очень проста в реализации просто поэтому я люблю её крутить вот пойдём по другим графикам возьмём разные Бачи эмки построим наши точки Тут видно что для степеней двойки они взяты точки построены точно также в течение 5 минут длится эксперимент и высчитывается медиана из всех пропускных способностей в секунду которые получены для двух конкурсантов и видна интересная закономерность что Да оно растёт Но кстати как-то оно начинает вот загибаться чуть-чуть то есть оно явно раст не до бесконечности может быть не очень даже линейно и другой интересный момент если в каких-то точках они очень похожи и ведут себя примерно одинаково то в других они начинают немножко отличаться и вести себя по-разному Неужели прона способность - это вот эта кривая какая-то зависимость возможно но работать с кривыми зависимостями жутко неудобно их в таблицы неудобно вписывать удобно работать с числами вот что бы нам такое придумать чтобы взять и превратить каждый из них в Фер в число которое удобно мерить больше меньше потому что всех на этот график неудобно размещать они могут начать пересекаться неоднозначности Вот давайте подумаем как это можно сделать первое что вот когда я такое вижу Вот у меня рука сама напрашивается взять ручку и сделать вот так провести какие-то кривулин Ну как бы законы какие-то наверное зависимости потом возникает Момент истины надо очень сильно напрячься и догадаться что это за кривулин может быть Ну как нужно подобрать что-то что похоже по есть много вот один из самых простых и мно любимых применяемых это немножко поиграться с осями что если мы по оси горизонтально начнём откладывать не батчи А вот сейчас надо немножко будет нап логарифмы от бачей логарифмическая ось редко кто может быть знает зачем она применяется Но она очень полезна В таких ситуациях потому что в ней эта картинка выглядит чуть-чуть попроще с прямыми работать удоб что м подсказывает ри действительно прямые понятны наверное даже угл можно посчитать вот название слайда раскрывает даже как это делается есть не очень сложный метод линейной регрессии который нам вот эти углы даст точнее тангенс этих углов А дальше вот здесь вот тонкий момент такой он очень дискуссионный И я очень надеюсь что кто-нибудь мне потом расскажет откуда я это взял ярен это врем оно было иро прино вот вме чтобы брать эти графики возм вот эти углы А точнее тангенс этих углов чем угол больше тем вроде лучше тем циферка больше тем лучше чем угол меньше тем вроде хуже тем и тангенс будет меньше то есть мы можем пытаться Вот это отношение порядка здесь вводить более строго например для наших конкурсантов Ну это не углы это тангенсы углов у меня записано получились примерно такие Вот они измеренная зависимость пропускной способности от размера Бача в данном случае для двух обобщим на остальных и сделаем ещё один приём абсолютные цифры 20.000 100.000 200.000 они шикарны для рекламных буклетов но они мне не очень нужны Я кстати знаю единственно что мне нужен минимум Я знаю например что каждый из конкурсантов по сть укладывается в мои нефункциональные требования даже с запасом некоторые с большим запасом для того чтобы потом сравнивать их с другими критериями я использую простой приём просто нормируемый максимальный и у меня получается такая относительная величина от нуля до единицы Кто больше кто меньше образно по этому критерию Кто лучше кто хуже и явно видно что в этой табличке ещё есть место для того чтобы появились другие столбики по другим критериям Давайте попробуем достроить их например пропускная способность от числа клиентов тоже самое меряем только теперь по горизонтально откладываем сколько потоков пишет У нас получаем эти точечки Видно что они немножко начинают дрожать здесь надо немножко получше догадаться но можно догадаться что крики тоже можно провести они будут логистическими функциями то есть насыщение дест выходят на тако порог и дальше не идут Почему кстати Так выглядит Почему так Странно а на самом деле у нас природа ограничена и например на машине на которой тестируется а точнее ещё средой ограничено количество ядер который может потреблять сбд и я думаю из этого графика сразу видно какое это количество ядер вот я подсказываю а давайте Попро Попробуйте задуматься и давайте сейчас все вместе скажем сколько ядер выдано этой сбд 1 2 3 четыре Ну вот некоторые угадали действительно четыре как только ядра заканчиваются значит значи жуткая конкуренция и работать в этой области фактически уже лишено смысла работать Надо в области раньше поэтому здесь я использую другой подход Я не хочу мерить вот прямо вот эти кривые целиком Я хочу мериться только в тех частях где они линейные где ещё нет этой жёсткой конкуренции мало ли у меня вот эта машина с четырьмя ядрами А что если будет если я принесу на 20 ядер А что если кому-то очень везёт у него 60 ядер там наверное будут другие кривые поэтому здесь Я буду мерить только линейную часть вот там вообще ложится более-менее на какой-то линейный кусочек и приём тот же самый прямая тангенс уклона вот на цифирь можем получить Циферки зависимости образно Да пропускной способности от числа клиентов как я предлагаю в этом докладе это понимать и заполнить табличку уже оранжевыми кубиками квадратиками прямоугольниками получить измерение по этой характеристике идти дальше и глубже например смотреть А что бывает под нагрузкой там вообще происходит Самое интересное это самые дорогие эксперименты потому что они длятся по 10 по 12 часов мы самый длинный эксперимент по-моему ро суток для разных как они себя ведут и наблюдаются некоторые интересные общие закономерности например Open tsdb под нагрузкой в принципе достаточно предсказуемо вс хорошо ино бшм делам что-то там делает Судя по логам она очень активно общается сзм то есть HB что-то очень такое активное делает потом возвращается это кстати означает что к этому надо быть готовой клиенты должны быть готовы это вообще хорошая практика что сбд может немножко уйти в себя не если она уходит навсегда это не нет Вот это нам не надо а немножечко может но в остальном время всё хорошо всё стабильно Молодец 8 тоже стабильность достаточно А даже я вам больше скажу стабильность здесь понимается немножко так формально вот если медиана иногда называют её пятидесяти процентный квантиль это значит половина находится левее то здесь я Мерил десто девятипроцентный квантиль то есть меня интересует чтобы в 99% всего времени запись в сбд была на том уровне на котором я хочу вот на 80.000 действительно так есть в какие-то моменты Конечно мы можем вываливаются 1% так до сих пор выглядит Open tsdb здорового человека а вот это Open tdb курильщика Нет она может на такой нагрузке работать но вот здесь явно девяносто девятый процентиль вы видите это не 100 он явно гораздо меньше будет находиться в себя уходит почаще но можно понять это всё-таки надо выдерживать такие нагрузки и это означает что Глядя на такой график я бы сказал так вот эту штуку под сотней не надо держать в этой установке вот под 80 держите 100 на долгое время не включайте в Пиковой нагрузке она выдерживает и больше но на 12 часов держать сотню я бы не рекомендовал и тогда появляется вот этот порог К сожалению я не смог е вычислить точно эксперименты шли с очень большим шагом Я останавливался на последнем шаге на котором вот эта характеристика удовлетворяла чтобы на протяжение рае Циферки работы под нагрузкой они естественно гораздо меньше чем пиковые Но они в этом смысле Чуть более интересные потому что они описывают как это будет сутками длится А не то ког это будет работать всего лишь 5 минут и вот они синие столбики Ну чуть-чуть капитанство наверное здесь уже прослеживается вот Хотя если смотреть на других там видно интересны уже взаимосвязи об этом е поговорим мы поехали дальше засов ну здесь уже слава Богу чуть попроще откладываем по горизонтальной оси длину интервала сколько мы хотим мы хотим запросить данные за сутки за 3 дня за неделю хотим выгрузить их себе делаем 100 запросов 100 запросов и меряем дено пй процентиль времени выполнения То есть я хочу чтобы 95% запросов у меня выполнялись короче чем за то время которое указано там для меня это более важно поэтому здесь не Медиа Почему Потому что это вот са крити пользователь нажал кнопочку и крутится кружочек и вот меня здесь не устраивает что у половины кружочек закончится крутиться быстрее чем за 5 секунд Я хочу чтобы 95% пользователей кружочек Этот закончился крутиться раньше чем за отведённое время здесь слава Богу Всё достаточно предсказуемо зависимость очень хорошо м дольше ждм тем хуже Поэтому здесь мы берём не тангенс угла наклона а обратный к нему тогда работает обратный закон обратная связь получаем вот эти наши зелёненькие квадратики Дада Я понимаю что сначала немножко капитанство будет но я я старался всё делать честно сам с собой По крайней мере быть честным и просто привожу результаты которые я честно получило и даже могу их воспроизвести я добивался чтобы эти результаты они воспроизводили и эти графики не дрожали допустим чтобы такой график в понедельник не сильно отличался от такого графика в пятницу чтобы они в этом смысле устаканится смотрим сколько сбд заняла на жёстком диске включая всю Мета информацию Даже я не рассматривал что она что-то может по себе дополнительно резервировать здесь я немножко грубо себя ВЛ Я беру просто просто за на ди дополнительно получали коэффициент отношения И вот он коэффициент сжатия Катон кстати был даже больше единицы Потому что много мето информации надо ещё индексы хранить на ещ какие-то дополнительные идентификаторы хранить служебные поля у кого-то было меньше единиц видно что работает хорошее сжатие Ну Особенно для тех кто знал что им будут складывать вещественные числа Да они их очень хорошо жмут действительно получили наш промежуточный результ вро бы Да результат очевиден но я всё равно хотел пойти дальше я не хотел останавливаться на этом графике Хотя здесь уже можно сделать кое-какие выводы если ты хотел довести это до какого-то может быть автоматизма воспроизводимости и подумать если бы ситуация была Чуть более сложной что бы я дальше с этими графиками делал что если бы верхушечных него конкурсанта ведь там очень странно кто-то в одном хорош кто-то выигрывает в другом Как мы можем сделать вот многокритериальной чуть-чуть математики привлечем возьмём ту табличку и перепишем её Ну я бы не сказал это более удобный Но более удобный для нас вид табличка чисел строчки - это наши конкурсанты а Столбцы - это наши критерии вот которые были на прошлом графике теперь добавим вот ту веь которую я долго ждал и думал где же мне её добавить что мне из этих критериев важнее чем другие что более важно что менее важно Я могу в принципе уступить место но коллеги действительно знают похоже подход этот многим знаком этого мы объявляем вне конкурса вводим наше матрицу весов дальше я думаю вы догадываетесь Что произойдёт перемножают он наш победитель что если мы немножко изменим матрицу весов что если мы выделим что-то более важное Я сначала покажу искуственный пример вот нам очень важно вторая критери это зависи способности от числа клиентов если мы тогда сделаем всё формально у нас победитель будет уже другой здесь конечно это всё немножко искусственный пример такое небольшое капитанство потому что того кого я включил вне конкурса и и что я приду к людям буду им рассказывать какие-то лишние вещи Там и так всё понятно поэтому я начал искать может быть что-то что я не знаю может быть найти кого-то кто Ну составит конкуренцию какую-нибудь тёмную лошадку кто может показать себя в сравнении с нашим конкурсанта начал изучать кто выходил последнее время наткнулся на один очень интересный проект последний конкурсант который по рекламным буклети выглядел интересно можно бы почитать они вменяемые мне понравились и было интересно прогнать его через ту же самую цепочку Я наверно уже только покажу финальный результат где начали появляться неожиданные эффекты и уже однозначности такой я в них не видел Если мы теперь оставим только очевидных лидеров и попробуем для них такой же приём провести то вот там он вполне может иметь смысл в равной степени когда всё равно у нас один победитель если мы выделим какие-то критерии как чуть больше важно он другой они начинают меняться и вот именно здесь мы пытаемся внести вот э нашу субъективность но смотрите мы субъективно Мерием не конкурсантов мы субъективно Мерием критерии по которым нам важно что-то выглядывать И зави от этого получаем разные результаты в принципе это ГВ одна из мысле кото те же время у меня уже думаю заканчивается заключение такое капитанское которое я для себя сам пытаюсь сформулировать проверяйте на ваших данных на ваших системах Это очень полезно чуть-чуть математики никогда не повредит поверьте она делает вас у мне и в глазах других и вот такой интересный момент который коллеги Судя по всему хороо знат субъективную оценку тоже можно мерить главно зна что вы в нете в принципе это всё спасибо за внимание кому интересно можно пройтись по ссылочка А у меня всё спасибо я готов ответить на ваши вопросы Здравствуйте спасибо за доклад такой вопрос Вот когда вы мерили под нагрузкой Во что упиралась всё то есть упиралась где-то в железо там в память в процессор или это были ограничения самого движка это скажем так вот э вспомогательная работа которую движок должен постоянно делать то есть понятно что скорее всего запись идёт постоянно сначала в память но надо периодически сбрасывать на диск И в этот момент начинались просадки это было хорошо видно и по логам вот ну и потому как система себя вела потому что я здесь не стал рисовать у меня автоматически писались графики нагрузки на русский диск они очень хорошо коррелировать запросы параллельно идущие записи как с ними дела были здесь я пытался сымитировать реальную ситуацию вот те графики времени исполнения запросов Эта система была постоянной нагрузкой по записи Я примерно ставил правда не сотни тысяч я брал свои показатели по-моему я брал 20.000 в секунду запись держал её нон-стоп именно в этот момент делал запросы и замерял причём я ещё старался вот там я наткнулся на одну проблему я сейчас воспользуюсь возможностью ещё немножко рассказать благодаря Антону а сначала у меня всё было очень быстро Я не понимал Почему а потом я понял я делаю одни и те же запросы А как только я начал рандомно выбирать канал по которому я запрашиваю и рандомно выбирать интервал по которому я запрашиваю цифры сразу пришли в нормальное русло и да магии не произошло это действительно не всегда работает Быстро особенно если мы хотим выгрузить данные там за неделю вопрос можно вы говорили что вам не очень интересно как работает Наверное вы же с какими-то значит параметрами с какими-то настройками их запускали я к чему я к тому что например у той же sdb там Ну много чего можно крутить Ну и у остальных тоже вы брали дефолт или всё-таки там в Open sdb использовали там режим а не compaction ну и хороший вопрос Спасибо большое я на него отвечу так Ну во-первых конечно часть меня ленивая и не хочет возиться подробно с настройками каждой из них и я прекрасно понимаю что если взять хорошего dba и он придёт скажет ты ничего не понимаешь Вот я сейчас всё так сделаю и всё заработает но он не всегда у меня есть Поэтому мне конечно интересны системы которые бай дефолт себя хорошо ведут но где-то Я использовал Линг листы писал людям просил объяснить некоторые артефакты которые я обнаруживал они мне советовали в частности вот mail лист постгрес очень хорошо посоветовал что-то Мне нужно правильно выставить для того чтобы данные у меня Пошли лучше Вот артефакты которые я наблюдал они пропа в частности они мне советовали как правильно использовать вакуум Когда в каких участках Open tsdb Нет compaction я не менял по-моему я что-то менял в настройках реджано Я сейчас к сожалению не помню уже точно что Но честно скажу детальной настройки прямо вот такой все ручки крутить я точно здесь не производил большей частью этой системы который вот из своих докер контейнеров стабильных стандартных поставляются и ставятся на систему Я согласен с коллегой Да сравнение не очень корректно поэтому я говорю а Я сравниваю не сбд Я сравниваю то как я их использую поэтому вот может быть меня это оправдывает А может быть наоборот спасибо Павел можно в продолжение того как вы их используете те Кэри которые вы давали что это за quy используются ли индексы агрегаты какие-то возможности баз данных вот связаны именно с работой с запросами что вы сравнивали там несколько подходов Я использовал ну во-первых которые Open tdb inf у них встроеные индексы поэтому они сразу Их используют по времени для остальных я шёл двумя путями первое Я просто строил индекс хорошо работали запросы но немножко хуже запись и более того очень было неудобно например данные держать в одной коллекции или в одной таблице они разрасталась моментально поэтому там вот коллеги меня простят я сделал очень плохой приём который я очень люблю Я начал дробить по дням просто на каждый день своя табличка и индексы Не использовал После этого у меня конечно жутко усложнили запросы потому что мне теперь нужно было эту информацию протаскивать аж в клиент Зато Например у меня ротация стала очень простой очень удобной дроп вот всё дроп всё дроп всё и запросы стали хорошо работать и на записи на чтени запрос только по временному интервалу то есть цепочки изнутри там очень глупые запросы только по временному интервалу Максимум что это с агрегации допустим средняя за некоторый интервал то есть не в каждую секунду а допустим средне за минуту Павел Спасибо за интересный доклад я хотел такой вопрос задать вы в начале сказали что надо знать свои данные надо знать свой профиль нагрузки и мерить на нём Да и на том железе которой У вас есть Так вот почему бы было всё не упростить и не померить там на нужной пропускной способности сразу же на нужном размере Бача и сразу же сравнить вот в таких характеристиках не надо было бы выводить вот эти тангенсы там всю сложную математику делать спасибо спасибо я могу здесь ответить вот как Да Слава Богу у меня есть прямо вот документ Там написано нефункциональные требования но я знаю что они могут меняться и те 20.000 которые я должен успевать хранить сегодня через год могу превратиться в 40 поэтому Несмотря на то что каждый из конкурсантов укладывался в них мне конечно было бы интересно выбрать То которое выдержит изменение нефункциональных требований это раз второе размер Бача - это очень интересная характеристика за него надо платить чем больше у вас ба тем больше у вас задержка вам нужно где-то создавать буферы которые бутси задерж ваши данные поэтому делайте их очень большими если вам важно Это вообще говоря опасно поэтому здесь интересно можно было бы смотреть как раз и с точки зрения минимальных размеров Бача Но поскольку у меня параллельно идёт обработка всего этого потока онлайн не читается изд мне здесь был в принципе не важен Поэтому Конечно я закручивал потом размеры Бачи практически до максимума что кстати для разных систем по-разному наме уже хорошо работает на А вот 5 зараз Когда вы Пите Кстати я Потом заглянул в стандартных драйверах это стоит как Константа иногда писать 5000 за раз а буфер находится в самом драйвере что мне кстати очень не понравилось Я хочу уметь этим управлять вообще говоря то есть сколько это хранится реально на клиенте когда это идёт в базу поэтому например для inf мне пришлось поверх протокола свой драйвер написать Давайте последний вопрос оста обсуждение перем в жите как-то я я правильно понял что вы настраивали структуру схему базы для каждой базы по отдельности а как-то приложение вы пытались подстроить под полученную структуру конечно особенно когда я вот начал применять этот не очень Может быть красивый подход нарезания по дням каждой отдельной таблички Когда в драйвере поступал запрос на больше о дня Ему нужно было понимать что сам надоть или если база позволяет сделать запрос сразу по нескольким таблицам а попытка использовать какие-нибудь там асинхронные доступ к базе или что-то ещё там Пул что-то вот в этом роде на запись там почти всегда асинхронно шёл Да пул пул использовался в частности если это было http протокол там старался устроить пул коннекшн и каждый пла то есть чтобы не повторять их Как таковой Ну наверное Вот это всё в основном что использовалось Спасибо N"
}