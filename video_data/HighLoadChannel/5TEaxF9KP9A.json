{
  "video_id": "5TEaxF9KP9A",
  "channel": "HighLoadChannel",
  "title": "Использование Comet для создания интерактивных интерфейсов / Глеб Арестов (Mamba)",
  "views": 1104,
  "duration": 2235,
  "published": "2017-04-22T14:45:52-07:00",
  "text": "день меня зовут глеб аристов я представляю компанию мамба в которой работу веб-технологий я вам скажу я вам расскажу про то как с помощью клиентской стороне сделать так чтобы пользователи получали мгновенное уведомление через постоянное соединение через постоянное сидение которое всего на дно на несколько открытых для данного сайта страниц то есть у вас например 10 вкладок данного сайта открыто и только одна вкладка держится постоянное соединение почему это хорошо на сайте на вашем сайте и на нашем сайте это маме есть какая-то какая-то информация которую от который гораздо больше пользы если она доставляется до пользователя мгновенно ну например это личное сообщение это счетчики счетчики новых сообщений давление о последнем саша пользователей и количестве непрочитанных сообщений о нем мы используем для доставки таких уведомлений мы используем кормит а и вно углом long polling запрос может потом соединения такие соединения в огромном количестве если у вас много пользователей если у вас вот если у вас много пользователей такие соединения создают нагрузку на сетевом оборудовании то ждут там наш эти зато в своим волк или непосредственно сервер который ну который общается с пользователем в нашем случае вот firewall например готов выдержать миллион постоянных соединений сервер ком сервер по заверением разработчиков готов выдержать миллион 600 тысяч одновременных соединений при этом сейчас у нас в час пик 600 тысяч соединений кроме этого большое количество одновременных подключений постоянных создает нагрузку на мобильные устройства ну они и так ограниченны в производительности кроме того у них узкий канал передачи поэтому на них тоже полезно сокращать количество на реальных подключений кроме того сами браузер и ограничивают количество одновременных подключений к светлым варьируются от разных браузерах разно образных бразы правдивая и точную информацию можно посмотреть на сайте браузер скоб в разделе так это информация собрана не по каким-то там спецификацию декларацию разработчиков ратинов аль эта статистика собранной с помощью тестов запущенных самих браузеров в большинстве случаев в современных браузерах это у кости одновременное подключение что можно использовать для того чтобы сделать так что было лишь одно постоянного соединения вы можете использовать современную технологию шага 2 сборки это такой технологии которая позволяет запустить отдельный процесс с которым все вкладки могут общаться которые может выполнять какую-то работу в частности подключиться к серверу и держать соеденение вот эта технология части спецификации чикаго 5 кроме того вы можете использовать flash слышно не используем кроме этого наше решение и использовать local storage что такое лодку сторож local storage это постоянное хранилище в браузере которая позволяет сохранять данные на клиентской стороне в отличие от cookies local storage не передается вместе с запросом зеркалом и он он один ну так же как бы cookies он един кроме этого они вам если если у вас никаких система пользователя не не позволяет использовать никакие решения для сокращения одновременное подключение моемся нам нужно обойти ограничение которые создают правду нет для этого можете просто сделать dns-записи которая будет направлять все субдомен и на ваш сервер и преподы когда вы хотите создать подключение вы генерируется случайным образом структуры и прорыв будет рассматривать такой подключение как уникальным и там например к 1 . оценку . плохо кормят 13.1 . он и так далее то есть любой структуры указываете и подключаемся гол лопалась тоже есть полезная ради которая позволяет мгновенно получать любые изменения которые в нем происходят вот например если мы сохраним что-то 1 и вкладке например вот в этой вкладке которая вроде как желтенькая вот сохраним в ячейке значение клэп все соседней вкладке об этом знают если подписываем событию сторож сторож то есть любая вкладку вот например у вас десять вкладок первое чтоб сохранила все остальные девять получится события в котором будет указан ключ то есть и чек который они возили новое значение это событие происходит при любом изменении то есть даже если в течение 20 дней или секунд там 40 раз изменения ячейку будет создана 40 событий с уникальным соответствующим включенные домом значение эти события всплывать во всех вкладках кроме в той в которой та которая производилась изменения это происходит во всех браузерах кроме того в этом особенно браузере событие всплывает только в том случае если текущая вкладка активно то есть если у вас 10 вкладок первая вкладка что-то сохранила вторая вкладка активно на получится события а все остальные ничего не узнают вот поэтому мы сейчас используем для интернет долларов плюс удалены вот что нам в принципе нужно чтобы сделать так чтобы было решено соединения нам нужно каким-то образом разделять данные потому что у нас всего одно соединение разным вкладка могут понадобиться разные-разные данных то есть у вас например может быть вкладка с учетом а другая вкладка просто со счетчиком сообщений и когда данные приходят папка должна определить она может использовать это для себя перешедший да ну или не может вот кроме этого нам нужно знать существует ли соединения или нет чтобы соответственно создать новое соединение или не создавать нам нужно передавать данные между вкладками собственно да данный приходит вкладку какая-то вкладка должна быть все данные распространить по остальные в свою очередь как я говорил может быть могут быть разного разных на мтс разные данные от анны вкладке понадобится чат другой счетчик обновление сообщений и они должны также каким-то образом сообщить основной вклад которая держится единения какие или данные нужны необходимы данная система разделяется с помощью комиксе то каким образом это происходит вот если вы предыдущие tapplock слушали там речь идет о каналах то есть каждый канал предназначен для определенной цели например сообщения передаются в канал для сообщений счетчик счетчик новых сообщений уложенных команд для счетчика могу сообщений и соответственно кроме этого для каждого пользователя если это как несколько по счетчику уникальный для пользователя создается отдельный канал что нужно чтобы получить данные из канала предварительно если мы хотим какие-то обновления получать мы должны подписаться на какой-то канал например на общий счетчик пользователей системе то есть that all users canter мы подписываемся на него есть приложение вашего но в нашем случае это пички приложением должен опубликовать канал в канал новые там она публикует и так как у нас постоянно меня клиент который подписался тут же получает хочу рассказать это с более практично стороны как происходит взаимодействие между двумя пользователями есть один пользователь посылает сообщение духовного вот скажем есть пользователи pyotr который хочет отправить сообщение александра чтобы обеспечить александр мгновенное получение сообщения клиентское приложение должны подписаться на канал сообщений когда пётр отправляет сообщение данные приходят на печке сервер печки приложением передает публик публикуют данные в коминтерна и так как клиентское приложение подписалось есть постоянное сидение александров наверно получает сообщение на самом деле когда пётр отправляет сообщение происходит не только передачи сообщения также печки приложения меня и счетчик новых сообщений а также создает уведомление о том что о том какой кто был последний пользователь который написал и сколько непрочитанных от него сообщений кроме этого в большинстве случаев клиентское приложение будет подписывать александру на обновление не самих сообщения только на ватного уведомления непосредственно сообщение она будет получать только если откроет окно чата данный приходится по видеть это полностью все что приходит от сервера в контексте данного доклад нас большинство не интересует этих данных нас интересует полем читал зеленое в котором указаны канала когда приходит соответственно вкладка может понять и нужно и титана использовать или нет так же вот поле контент где осенняя это непосредственно данные которая отправила приложить ну которая практиковала приложение требующие эстонец еды вот таким образом данные разделяются нам также нужно знать если соединение линии чтобы сделать что оно было только одно наше решение не не не делает проверку непосредственно если соединение ли не просто используется внутренние соглашение что только одна вкладка которая имеет поэтому главная она занимается связью серого остальные вкладки просто делаю то чтобы они обеспечивают чтобы всегда планы кто-то бубнит то есть если как главный промо кто-то должен стать главным главной вкладкой помимо того что главная вкладка общается сервером она должна передавать полученные данные остальным вкладкам остальные вкладки должны сообщать что ему и любая вкладка то есть это в принципе неважно какая вкладкам она стремится стать главной каким образом определяется то есть клада главный в кладах есть идентификатор и этот индификатор может но этот идентификатор генерируются внутри самой в кладке он основан либо на времени вашем случае мы используем время либо вы можете использовать инструмент главная вкладка должна каждым 300 миллисекунд подтверждает свой статус то что она по-прежнему существует кроме этого так она должна каждые 300 миллисекунд подтверждать а все остальные вкладки проверяют чтобы всегда существовал отчет который не старше секунду если есть если отчет последнее от главной вкладке 100 что первых только заметить станет главным при такой системе могут быть коллизий и допускает что бы одну кто может перестать главное быть потому что она может не закрыта просто занята то есть она была какими-то числе ними сложными занятые я на нем не успел обновить отчет и поэтому кто-то другой стал план тогда он справится два соединения в этом случае главное должна перестать болеть функции там закрыть соединение каким образом главная вкладка подтверждает то что нам главное записывает в окна сторож ячейку рекси мастерство идентификаторы и текущее время это происходит каждые 300 миллисекунд а также при открытии новой вкладки которая новая вкладка записывает в увеличении если мастер прецедент свой сертификатор главная вкладка с помощью события он сторож получать эту информацию и тут же создает очередной отчет ну то есть внеочередное как это происходит вот она желтенькая главная вкладка записывает свой отчет в трости 5 вкладки с помощью зеленая вот вкладка с помощью события сторож следить за изменением ячейки где мастер и обновляет отсчет от ванной локального вот диаграмма происходящего во времени вот шкала времени черная вниз направлена в 00 секунд главное записывает отчет второстепенная зеленая получает твои снова поймал на секунду чтобы потом проверить на 300 миллисекунд очередной отчет мы получаем второстепенной вкладка стираю предыдущий тайм-аут , создаем новый но вот в 453 миллисекунду главная вкладка закрывается соответственно 600 миллисекунду никакого отчета не создается и второстепенные пранки никакого отчёта не получают то же самое происходит на 900 миллисекунду никакого отчета никакого получения и на 1200 миллисекунда то же самое зато она 1300 миллисекунду как раз вот с 300 именно секунды происходит проходит секунды происходит проверка если 10 действительно ли отчет устарела целую секунду если это так второстепенная вкладка пытается записать свой отсчет если в течении 100 миллисекунд ничего никто больше тобой не пытался записать создать на она становится главным при такой системе как я уже говорил главным вкладка ну в зависимости от браузера может быть просто не закрытая занят она как-то там тупила браузера не успел записать и поэтому кто-то какая-то степенная вкладка тоже решила стать главный соответственно при первой главное которая купила должна прекратить всю деятельность который выполняет главное нам закрыть соединение и все прочее вот таким образом определяется с помощью соглашения если соединение или нет то есть если есть главное что или не сам знаешь что есть главное не значит есть соединения нам нужно как-то уметь передавать данные между вкладками это нужно для того чтобы передавать чтобы вы главная вкладка которая держит соединение передавала данные остальным и для того чтобы остальные делали заказы на какие-то канал там вот вклад к чату могла подписаться на чат остальные вкладки на обновление счетчика сообщений вот нам нужно общение между вкладками как происходит общение как как главное рассылают полученные данные на я челюсти message записывают необходимые данный вот главная вкладка желтая записывает сообщение второстепенными с помощью события устроишь от зеленый вкладка с помощью станете он сторож следить за изменением ячейки земле сошли если видит что уж некий сбросом связи получает какой из меня понимаешь что это предназначено там конечно новое значение будет обертка вот но вот так вот так в принципе заказывают других вкладок то того какие каналы подключать принципе происходит таким же образом вот второстепенная вкладка зеленая записывается в ячейку и где мастер та же самая ячейка то есть принципе речей к вездесущи служит для передачи данных туда-обратно как я уже говорил любое изменение порождается будете то есть мы никакие данные не потеряли тут происходит запись в вашем посредстве на сообщение о том какие канал нам нужны оборачиваем структуру с помощью которые плавно я получил сообщение понимаешь что это предназначено для нее вот таким с помощью забыть он столь же главный узнает о том что получено сообщение от второстепенно из читает оберткой можно подписаться на канал и вот таким образом вкладке общаются есть такая проблема что если мы закроем вкладку с чем-то главное не узнали то что она закрыта она будет по-прежнему подписаны на канал то там то есть она будет получается ненужные никому ганы и периодически могут закрываться разные вкладки а данным все время накапливается накапливается о смысле поток которые мы будем получать он будет накапливаться соответственно нам нужно каким-то образом отказываться от данных которые а получения данных которые нам не нужны наше решение используют такую схему сначала вкладка сообщают о том что какие книги и к нам нужны а потом каждые 30 секунд она должна это подтверждать если главная вкладка в течение трех минут не получит подтверждение она отключается отписываются от канала кроме этого если у нас есть главная вкладку и кроме этого еще 15 других вкладок и всем нужен какие то уникальные каналы амос раз и главное в планка закрываются нам каким-то образом нужно восстановить все 15 каналов соответственно новая вкладка и когда понимаешь что она стала главный также должна сообщить другим вкладкам что чтобы они заново сообщили какие канала нужны это тоже происходит через ячейки сидим с тоже записывается остальные все понимаю что там запрос на восстановление каналов и рассылают заново необходимые каналы вот таким образом происходит передача данных между вкладками для для передачи полученных от тех же данных гитлера заказов новых данных у нас есть решение которое использует local стоишь событием он сторож это решение прямо сейчас вдвоем она протестирована и работает для интернет эксплорер мы используем субдомена но в принципе можно для интернет эксплорер эмулируется вытяну сторож есть идея как это сделать но пока это не протестировано в принципе мы можем раз какой-то интервал проверять на изменение может интересующий нас лечение в принципе мы знаем какие ячейки нас интересует это детей и где массаж ну xd мастер претендент всего три ячейки вот мы можем например роста секунд опрашивают фокус ночь снились ли изменилась ли данная ячейка вот но эта система не будет работать если мы будем записывать чаще чем 1 100 секунд 1 100 миллисекунд то есть если мы 20 раз 20 записей за ее сделаем там и узнать только самое последнее сообщение все остальные 19 сообщение мы потеряем в первый день мы можем сделать прямо в этой ячейке очередь то есть записывать сообщение массивом мы можем кроме того чтобы не лукас тож не носился мы можем согласно соглашению скажем удалять все что старший 5 секунд и если вкладка какая-то не успела за пять секунд прочитать данные то как выделю проблемы но если мы будем записывать в ячейку сложную джейсон структуру и потом каждые 100 миллисекунд и и парсить это будет большая нагрузка на браузер поэтому хотелось бы чтобы этого не происходило вместо этого мы можем записывать в ячейке не не по строительных очередь ссылку то есть идентификатор сообщения о самом сообщения а записывать в отдельную ричи около стороны то есть вот например мы хотим записать вот такое вот сообщение она записывается не напрямую в ячейку в другую ячейку схожим названием и туда записываются только ее сертификатор 22 таким образом у нас такое нас в данном случае я получил сертификат or и время ну это минута там можно записать и мультфильм при вот и записываем ячейку в другую ячейку а эти from 22 само сообщение то же самое происходит когда мы еще нам сообщение хотим записать в нашу структуру добавляются еще один кипятите секатор еще одна ячейка и так далее потом мы просто раз в какой-то интервал считываем все что старшие 5 секунд внутренняя таким образом это должно происходить быстро потому что вы просите каждый stories он был не сложно сложно джейсон структуру вы можете запомнили там какая была структура приходящая сервера вот более простую структуру вот в принципе с помощью такого способа мы попробуем реализовать из надо протестировать попробуем реализовать события он сторож для интернет эксплорер чтобы там тоже было лишь оно соединено несколько вкладок вот я вам рассказал про то что для нас важно мгновенное давление потому что вот скажем однажды при плановой перезагрузки кого материя у нас пользователь не получали обновление и а тот пересылаемых важных между пользовать людей между пользователями сообщение упал на 20 процентов но и в большом количестве одновременно и соединения создает одновременно постоянное соединение создают нагрузку на сервер поэтому лучше их сокращать если мы решили что мы выдерживать нагрузку мы можем обойти ограничение в браузерах с помощью субдоменов сегодня большинстве то есть ну там большинстве празднику можем использовать локон сторож ну связку комик угол столь же собой тему сторож а в будущем мы сможем использовать связку комикс две формы шахте сейчас который позволит реализовать систему более стабильный и отзывчивый если у вас есть но у нас есть отдельный отдел что в принципе я и не просто игры есть а для подкастах тесты сказать что такое скорее называется как нам сделал студент скулю гликация коминтерн так что все работали ищем где скажи что же там когда разные вкладки пишут область как я говорил любая запись порождается быть и обработка это неважно событие это происходит асинхронно события асинхронных бросили и она не как-то связано то есть ван вы можете записать в одну вкладку сделать цвета этим другой вкладке на вкус спустя 300 такое 30 миллисекунд в зависимости от браузеров событий всплывет выезжайте 330 миллисекунд могли уже сто раз записать если вы будете читать мне ключ сообщение смысле события а непосредственно обращаться блока стоишь вы там не найдете нужное значение скорее всего но вот конкретно в событии вы сможете прочитать точное значение выталкиваться а у вас точно здесь выборе мастера точную и станет чего нет выборе мастер предположим что главная страница которая была настя она закрылась потом 2 с других страниц и сообщений о том что и теперь мастер и каждый из них получает сообщение о том что какая-то другая стоимости первая вкладка попыталась спустя там где на одну миллисекунду попыталась 2 2 соответственно если не успела прочитать ничего она записывает как будто в чем он вала а первое она ждет 100 миллисекунд убеждаюсь что никто больше не пытается систем выполняется и воспитал времени оба из них одновременно так как тоненькие и тайм-аут выставляли по одной секунды и одновременному свое сообщение потому что я теперь мастер но они придут скорее сегодня одновременно как как может произойти запись одновременно еще раз страницах пословица 2 страниц она посылает сообщение теперь я мастер и тут же получает сообщение от другой странице теперь я власть полностью если она получаю сообщение что она что-то на другой мастер она все больше не мастер тасконцы фронта последний сделает этот не будет мастер виде muscular скажите пожалуйста я познал fanta плат у вас некоторые выпечки на диск нет но кратеры я буду ? не отвечу потому что я не принимал участия в разработке бесконечные конкурентного обновлений с ним язык после это отдается на сторону java script он слишком то есть именно java script движок гарантирует нам что искренность будет обновлён слишком частоту каждой 1 максима себя вызовет санджи не он сторож его именная java script овод eget браузера гарантирует нам что совсем одновременного обновления занимаются произойдет а произойдет 2 атомарных обновления с каким-то минимальный приведу когда вот слонимская секунд даже свой нет что она ли посекундно а именно из за того что эти события будут 1-ый очень маленьких но все-таки ненулевым промежутку времени вторая вкладка сначала первых налила их занимаясь после этого вторая вкладка не успел понять что первый обновил она лила сама после этого первый флаг проверяет через 100 миллисекунд 1-ю ли кто-нибудь его снимать видите что-то не слетает зима тиром одну кем-то еще значит это первые блоки не повезло и реального бумажник основном цитирует гладком авто ну а подробнее ну в принципе это чисто java стоит единственное что там в два слоя один непосредственно для проверки кто мастер и для пересылки сообщений а второй слой для для заказа каналов у нас нет таких клиентов понятно для чего просто кой они давно положением на ios 5 те у кого сафари предкам полога 100 выясни много нового сафари программистов которые часто тем меньше у с количеством битов отмены соединитесь сказать а весит лова палату кому бы картинки и другие загрузится испытывали никаких проблем и во первых во вторых если в принципе на иисус просит за плотником не связаны с этими событиями под разные люди разные пишет индус разные я пока таких проблемах не знаю вероятно с полученной вами информация проверим это у меня кабан зигзаги вопрос числа секунд 10 и мы идем или там каких-то расчетов с клиентами сказать за экспериментом борту дождей ну просто катались там уменьшить alliciya то есть если мы увеличиваем как вы повышается стабильность но при этом вы плохая отзывчивость пристало увеличивает там на 300 миллисекунд нам придется увеличить вместо секунды там скажем пять секунд рождать пока идет отсчет от мастером тогда если закрывается страница вам придется 5 секунд клиент останется на 5 секунд без соединения вот соответственно увеличивает время мы не можем уменьшать если будем сильно в жертву в зависимости от разных браузеров это будет прождать коллизии вот примерно такое число которая довольно стабильно ведет себя спасибо так что понимали голосование или кто тебе мать нельзя что про прагу угрозы во-первых своим каждым разом своей то есть он не делится ни обобщается из не сможет полицейским кроме того local storage общей только для домена для было провели для того томмен и соответственно эти соединения друг на друга не как внедрять независимая система могущество хотели что потери сообщение 2 а об этом речь но там взаимодействие все устроено несколько сложней в принципе там есть вот как в прошлом докладе ли рассказа нас там есть пользовательской сессии то есть там обеспечивается сохранность или доставка точное сообщение если соединения разорвалась непонятно когда сообщение будут остановлены непрофессиональный такой вопрос сколько это примерно получилось строк кода для тех а вот всего этого обмена сообщениями для непосредственного вот слой которые делают обмен складками или вместе с тем кодом который делает заказ на самом деле неважно как вместе нет я сейчас не скажем потому что я никто не надо посмотреть"
}