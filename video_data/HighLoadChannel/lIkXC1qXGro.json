{
  "video_id": "lIkXC1qXGro",
  "channel": "HighLoadChannel",
  "title": "Как мы переписали \"жадный\" механизм назначения / Антон Скогорев",
  "views": 3641,
  "duration": 2972,
  "published": "2019-06-28T08:07:49-07:00",
  "text": "здравствуйте берем и я руковожу группой работки эффективности плата мы сервисе сен кто вообще пользуется яндекс такси поднимите руку ничего себя но это очень приятно знаете все мы с вами пишем приложениям и есть такой термин утилизация ресурса ну например выпишем какой-нибудь программой может быть такое что например нам нужно что-то записать на диск и мы мы что-то пишем пишем пишем но понимаем что наш диск ну вообще не загружается достаточно часто это значит что у нас есть какие-то алгоритмы которые не очень эффективно работают то есть мы утилизируем наш жесткий диск или например сеть не на сто процентов и у нас в яндекс такси тоже есть такой ресурс это количество часов водителя на линии когда водитель к нам заходят он нажимает там кнопку на линии и в этот момент он оказывает нам своего рода доверия и ну он предполагает что тот ресурс которую он нам выделяют которого нам а дает мы будем использовать но очень разумно то что у него не будет простоев между заказами то что у него не будет слишком длинных подач ну это наш ресурс который мы работаем и одно из направлений моей команды которые мы занимаемся это dispatch dispatch это распределение водителей по заказам и это в общем то там магия которая происходит когда пользователь нажимает кнопку заказать мобильном приложении все приходит к нам но бэкенд начинается алгоритма все дела вот и не так давно нам потребовалось переписать достаточно большой кусок как раз отвечающий за назначением об этом я сегодня расскажу расскажу как мы внедряли новый алгоритм расскажу о том как мы на какие грабли вы наступили как мы с этим продолжили жить и начну я с того что заглянул под капот яндекс такси и расскажу о том как у нас в общем то сейчас выглядит этап назначение водителя на заказ у нас есть пользователь который приходит в наш бэкенд у нас микро сервис архитектура не удивительно есть micro сервис который обрабатывает пользовательские запросы называется протокол он все что он делает он обработ он берет этот запрос преобразует вот он какой то документ заказы который называется проставляет ему там какой-то начальный статус и кладет базу данных в яндекс такси есть самописный фреймворк который реализует концепцию стоит машины на базе него построен микро сервис он называется там сервис обработки заказов и он умеет ходить в базу брать эти заказы которую нужно сейчас обработать и в общем-то пинает заказы из одного статуса в другой и один из этапов это назначение один из этапов от расписания заказа это назначение назначение водителя на заказ у нас есть micro серость который в такой быстрой структуре данных для поиска по радиусу бил индуска d3 хранит сущность такой сущность как водителя то есть он хранит все текущие состояния системы на данный момент текущая полностью всех водителей от микро сервис называется трекера и он умеет отвечать один такой достаточно тяжеловесные запроса дай-ка мне вот для моего текущего вопроса для моего текущего заказа самые подходящие его водителя соответственно трекера дает водителя и мы отправляем какой-то offer водителю который водитель может согласиться можешь не согласиться если не соглашается процесс начинается по новой там через какой-то период времени ну если соглашается то заказ приходит наследующий state и там уже другой этап в общем то такая ну это архитектура реализуют концепцию жадного алгоритма мы приходит для каждого пользователя мы заново пытаемся найти самого лучшего водителя в общем-то думая о том что в среднем по системе все решение наша вся вот эта цепочка назначение которое позже последует она окажется оптимальным решением и такой же алгоритм очень долго можно прокачивать разного рода и в листиками ну вот одна из них у нас есть зоны повышенного спроса они показывают текущий спрос ну то есть давненько все сегодня поеду домой на яндекс такси и вот рядом с нами будут примерно такие гексагон и вот они показывают текущий спрос и какой-то кратковременный спрос эвристик состоит следующем что если есть какой-то пользователь и 2 водителя которые подходят под этот заказ у них там одинаковых детей время заезда водитель и два пассажира они полностью подходят детское кресло есть нету то эвристик состоит в том что нужно давать заказ водителю не из зоны повышенного спроса ну просто потому что там где сейчас зону повышенного спроса водители сейчас нужнее то есть у него время до следующего заказа будет намного-намного меньше в общем то мы можем очень долго все это прокачиваете вообще это я бы сказал что отдельная наука придумывать такие в листики и мы можем очень долго делать вид что не замечаем слона мы абсолютно ничего не знаем про то какие пользователи в данный момент заказывают также такси как вот и наш текущий текущий заказ где-то рядом где-то в окрестностях и проблема проблему можно показать на таком примере у нас есть пользователь и у пользователя есть так называемый радиус поиска то есть тот самый tracker который умеет возвращать водителя у него есть достаточно грубый фильтр который просто по прямой умеет отсекать водителей допустим там нет смысла рассматривать водители который находится дальше чем 50 километров к примеру и у этого пользователя есть два подходящих водить два водителя который находится в радиусе поиска которая так или иначе подходит и решаю оптимальную задачу ну для этого пользователя мы выбираем водитель и 2 и если вдруг случится такое что есть еще один пользователь с таким же радиусом поиска он в наших терминах сгорает то есть он остается по факту без водителя и все достаточно плачевно заканчивается хотя мы могли бы назначить все совсем по-другому и такой достаточно краевой случай его можно рассмотреть на каком-то вывести какой-то более общий случай когда это становится уже более ощутимой проблемой у нас есть пользователь который приходит какую-то нулевую секунду и пользователь 2 который приходит там всего лишь к примеру на одну секунду позже и есть два водителя которую и пользователь 1 и пользователь 2 видит ну мы естественно решаем задачку для первого пользователя выбираем машину один которая едет одну минуту но пользователь 2 по остаточному признаку выбирает себе не очень хороший вариант ну вот в моем таком синтетическим на данном примере у нас получился эти 10 10 минут ну и в общем если бы у нас было знание ну то есть какой-то контекста о двух пассажиров мы конечно же вы все переделали и назначили каким-то таким вот образом и опять же на моем синтетическом примере это было бы 40 40 процентов выигрыша в общем то понятно что мы хотим мы хотим сделать так чтобы у нас в одном контексте то есть в одном runtime если можно так сказать было знание о по опачки пассажиров и у пачки водителей которые подходят так или иначе под эти заказы в общем-то задачка сводится к достаточно известные задачки о назначениях задачка оптимизация которой состоит в поиске таких пар сочетаний которые будут минимизировать стоимость работ но в данном случае такой у нас будет ответ давайте посмотрим на то как выглядит текущей наша архитектура и становится понятно что мы должны вложить куда-то между сервисом обработки заказов и между трекером ну куда-то сюда давайте запилим такое решение у нас будет новый сервис называется драйвер dispatcher у него есть api который торчит наружу который умеет дергаете которую дергает сервис обработки заказов он там придет приходит с каким-то новым запросам api куда-то этот запрос сохраняют есть worker и которые запускаются как-то периодически берут какую-то не знаю блокировку и в общем-то идут в тот же самый tracker за поиском подходящих водителей решает задачку во piano там потом обратно дается или там на самом деле пушиться и давайте еще раз посмотрим на задачи о назначениях мы еще не раз будем к ней возвращаться в реальной жизни она выглядит не так в реальной жизни это матрица очень сильно разрежена ну понятно у нас в общем то нет такого водителя которые универсальные водитель который подходит абсолютно всем в матрице очень много пустых значений но и в яндекс такси мы оперируем такими сущностями как геозона у нас очень много сработать с газонами у нас есть тарифная геозоны есть геозоны субсидий на есть геозоны настроек повышенного спроса очень многое завязано геозона очень много работы с газонами и с учетом того что наше решение стоит на критическом пути обработки заказа ну то есть мы не можем никак взять избавиться от назначения то есть это дочери что пользователь и так или иначе должен пройти топ нему в общем то применяются достаточно стандартные требования оно должно быть стабильным отказа устойчивым и мы решили завязаться на такие геозона если быть точнее то на агломерацией таких газон и в общем-то разделить наше понимание вот api то есть куда приходит запрос и worker of который умеет обрабатывать теперь маркеры умеют запускаться периодически ну очень часто смотреть на те агломерации который сейчас еще не разыгрались который еще нужно разыграть брать блокировку в базе данных чтобы больше никакой worker не разыгрывал и в общем то что то разыграть если он свалится то произойдет тайм-аут и другой маркер это все возьмет и начнет разыгрывать но все точно также входим в tracker все точно так же решаем задачку назначениях и пушем обратный результат кидаем заказ следующим стадиям и мы это все достаточно быстро запилили и настало время как то протестировать нашу решению и у нас в яндекс такси есть это такая своего рода реклама есть такая классная технология как мы его так называем карманная такси это такой контейнер ированный сервис можете у себя на локальной машине можно на виртуальной машине поднять абсолютно просто весь такси подключиться туда собственным мобильным приложением разработчики мобильным приложением подключиться туда водителем зарегистрировать этого водителей в общем-то назначить самого себя на самого себя или на каком-то другом виртуального водить как а их там тоже достаточно много где все достаточно классно in начали мы с того что решили пострелять по в общем-то нашим непосредственно задачки то есть только по нашему алгоритму без подходов какие-то внешние сервисы мы сняли дам там с продано какой-то там небольшой зоне и в общем-то постреляли по нашему алгоритму нас получились очень очень неприятные цифры на тех данных что мы стреляли около 200 миллисекунд в общем то нам так казалось что мы что-то делаем неправильно мы еще раз решили посмотреть на данные которые у нас были и опять возвратимся к задачи о назначениях это как мы ее решаем есть такой же широко известный как и сама задача алгоритм решения этой этой задачи простите называется венгерский алгоритм него кубическая сложность и он в общем то основан на нескольких идеях идея номер один это то что из всех из и и строки можно вычесть какое-то значение от этого оптимальное решение не изменится то же самое можно сделать с а столбцы он можно и столбца вычесть также какое-то значение обычно берут минимальная от этого в общем то тоже ничего не поменяется финальное решение и оптимальным решением оптимальное решение будут стоять в строках с в ячейках нулевой стоимости и мы всегда жили в той парадигме что у нас водителей намного больше чем пассажиров так мы когда начинаем разыгрывать кажется что у нас там есть пользователь на него там какая то кучка водителей но мы оказались немножко не правы у нас реальный пример у нас есть такие места где не пользователи начинают выбирать не него не пользователь начинает выбирать себя водителя если можно опять же так говорить о водитель начинает выбирать себе наиболее эффективно пользователя достаточно интересные эффекты и с учетом того что мы всегда считали что как я сказал там кубическая сложность но она на самом деле н квадрат на м где иногда у нас n получалось больше чем м и мы решили в этот в в эти моменты транспонировать матрицу делать так чтобы она всегда была меньше чем м то есть просто переворачивали и мы от того что сами на гинер и на генерировали постреляли постреляли после того как все это починили еще раз мы получили там при улучшении производительности в полтора раза что-то нам тоже подсказывал что все еще достаточно плохо нам повезло вы нашли несколько багов один из них достаточно интересный он заключался в том что как я уже сказал у нас матрица достаточно сильно разрежена и это значит что там были пустые ячейки и мы решили как-то заложить это на какой-то физический смысл из за того что у нас есть там операцию вычитания из столбцов и строк мы решили что пусть вот эти пустые ячейки они будут просто какое-то большое число и случилось очень плохое на одном из последних шаг шагов алгоритма у нас там есть увеличение с увеличение ячейках на какое-то число и мы просто столкнулись с переполнением целочисленного типа из-за которого наши решения и там иногда не сходилось иногда сходилось очень долго в общем то там не очень везло с данными мы этот баг там еще несколько тоже достаточно минорных починили получили постреляю третий раз получили еще увеличение производительности в полтора раза на этом мы решили остановиться и нам очень сильно помог метод страз тестирования когда мы брали когда мы генерировали какой-то какой-то поток данных которые мы в общем то даже не могли предвидеть что он будет более-менее похож на нет конечно мы выдумали что в прайде нас может ждать все что угодно так и случилось и не выезжая в продакшн и в общем-то имея зелёные-зелёные тесты которые мы сами себе придумали которые проходили еще на тот момент когда мы начнем все тестировать мы получили получили достаточно неплохой фидбэк давайте еще раз посмотрим на нашу старую архитектуру это как выглядела нагрузка в этой парадигме у нас были сервис и обработки заказов которые приходили с единичными запросами на балансировщик перед у нас ну tracker это понятно это не 1 инстанции о там десятки перед всеми этими и перед всеми инстансами стоит балансировщик он в общем то умеет там раскидывать запросы на на на какой-то наименее загруженный instance трекера запросы были в общем-то запросы приходили равномерно распределялись равномерно там все еще была по дата-центром в общем то нагрузка это опять же выбранный полигон нагрузка на 1 instance выглядела ну примерно следующим образом все был достаточно равномерно когда мы сделали новый сервис драйвер dispatcher а мы сделали таким образом чтобы на физическом уровне опять же это выглядело примерно так мы набирали кучку кучку пользователей и в общем-то таким огромным огромным про огромным количеством параллельных запросов шли на балансировщик он все все тоже самое раз проливал но это было все на самом деле мы просто забили бы пул соединений тот который имеем в сервисе мы решили сразу так не делать мы сделали такой одну большую жирный один большой такой жирный and point который умеет все что умеет это соединять соединять все запросы в один в болтовые такой запрос он был достаточно жирный приходил на балансировщик он понятия не имел что с этим делать отправлял его на один instance трекера остальные при этом курили но вот текущей instant стракера там все хорошо раз параллели вал все было очень хорошо в своем стиле и нагрузка стала выглядеть вот так то есть у нас есть интервал розыгрышам то есть есть там бизнес метрика есть бизнес параметры это вот как бы интервала времени через которые мы запускаем розыгрыш и вот они все видны на графике даже с учетом того что мы все пожар де равале даже за счет того что мы это все пародировали там по гео зонам на все равно оставались достаточно большие города которые есть большой смысл разыгрывать все разыгрывать целый город и мы скорее думы просто умерли бы на на больших городах мы тоже подумали решили что с этим делать мы мы ограничили сверху вот и все мы просто взяли этот поток ограничили вас верху разбили на этот огромный жирный балка намного-намного много мелких банков и отдали нашему балансировщик у тот самый карт-бланш который у него был дуэт он теперь знал что делать с этими запросами они не так не так долго выполнялись он также распределял их по инстанциям трекера он в общем то также выполнял ту самую функцию распределял нагрузку и в общем то такое решение нас устроила и финальное решение стало выглядеть следующим образом да почему вообще мы стали это оптимизировать стали оптимизировать то ну как быстро у нас все это считается потому что ну кажется что чем дольше мы например считаем этот буфер тем больше заказов ну то есть м тем больший интервал тем больше заказов туда попадает ну значит тем эффективнее для системами все это решаем кажется что это большой плюс но с другой стороны это какой-то бизнес параметр это какая-то которая вообще никак не должно влиять на то как инфраструктурное то все выглядит на то как долго мы все это решаем таким образом мы все это запилили сейчас мы запущены во многих городах буквально сегодня мы запустили этот алгоритм с утра санкт-петербурге и из если вы сегодня добирались до конференции конференцию на яндекс такси вы уже прокатились по нашей новой архитектуре по нашему новому алгоритму ну а мы продолжаем его включать ну в общем то на этом все спасибо большое если останутся какие-либо вопросы а то уже ничего не уже не включить у меня было последнее слайдик с контакте коми до можете запросто писать спасибо надо здрасьте спасибо за доклад пожалуйста сказать что вы берете балл по ближним вы берете балка заказов и и вообще ты войти а вы когда его берете вы как-то географически ограничиваете и на самом деле не в курсе как у вас заказа приходит допустим уважает не приходит в одну систему заказы сразу из санкт-петербурга из москвы или или да на входе а какая разница ну на входе больше почему на одном инстанции не может обрабатываться в общем-то разные города форвардера не запускаются им там все равно какое единство и ваши отсеивании этого чтобы дорога водитель не был тонкий если водитель дальше 50 километров то он как уже автоматически отслеживать там достаточно элиту навальная работу то есть там помимо грубого отсеивания есть ещё те параметры по которым водитель ну которые есть в запросе по которым пользователь не подходит после этого еще мы идем в роутинг который начинает который нам отдает в общем-то все маршруты до этой точки из которых мы уже там строим какую-то функцию у нас там даже еще не чисто детей не чистое время заезда там некоторые скоринг от этого но это все же внутри 3 что штамм это все уже внутри трекера это внутри tracker на то есть на tracker идут голые данные без какой-либо фильтрации по географическому признаку ну в один момент времени на трекере да может могут быть могут быть разные сейчас пока вы есть идея о том как это как это дальше развивать как это дальше там вы на и выносить но сейчас tracker помещаются водителя на все либо добрый день 1 раз спасибо за доклад прям близко-близко микрофарад спасибо значит я вижу вы решаете задачи о назначениях ага ну с помощью классических методов мне в зад гориллам вы никогда не думали о том чтобы попробовать например обучение с подкреплением если посмотрите там классическую книгу сатаны борту агам видишь помощи изощренных методов можно например задача назначение мобильных телефонах на там на сотовую ячейку или задачи планирования получить сам оптимальное решение за очень приемлемое время я помню вопрос ну как вы видели мы там починили много багов и нас лично стала устраивать от решение она как вы сами сказали она достаточно классическое и но оно достаточно простое оно простое для разработки оно простое для поддержки для понимания мы думаем над тем чтобы ну как бы работать в этом направлении но мы там как вы видели упирались вообще пока что в другое но про то чтобы заменить венгерский алгоритм на какой-то другой ларин да такие такие мысли есть здравствуйте скрыть просто по такой еще метрики как цена поездки вот в пиковые самые даты когда допустим корпоративы новый год сталкиваемся ситуации когда просто количество водителей которые нужно назначать их недостаточно и когда вывод поднимаете цену но что привлечь больше водителей как это вообще включается в работу алгоритма то есть вот допустим начался сезон корпоративов все хотят заработать допустим стартовая поездка все водители говорят не за эту цену я даже не двинусь что дальше происходит пока я поле ну вообще цель конкретный пример моей группы разработки сделать так что вот у нас всегда был баланс например вот у нас есть как я сказал такая штука как сурж то есть это вот зона повышенного спроса наша цель к примеру не заработать вот денег с того что вот там многие думают что там яндекс такси и зарабатываю деньги когда он там увидит увеличение тарифа там в полтора раза к примеру это делается для того чтобы марш чтобы сервис был всегда доступен чтобы вы всегда смогли зайти в мобильном приложении мы вас ну да за большие деньги но ну как в обратной ситуации вы просто не смогли бы вообще уехать и вот например ну повышенный спрос как раз вот коэффициент повышенного спроса тот сурж который все видят он вот как раз решает ту задачу о которых о которой вы говорите у нас есть еще группы разработки одна из них кстати вот в питере здесь находится они разрабатывают там такую штуку как репозиция то есть мы на исторических данных заранее знаем о том где например у нас там будет там спрос ну там либо этот хит сезона и часы пик либо этот там просто не знаю со стандартным вечером все встало и есть алгоритм который умеет определять такие зоны и на первом брать водители говорить ему там вот езжайте туда там сейчас будет повышенный спрос там сейчас ну по факту можно заработать денег это то что мы им говорим нет как раз помогает нам в том числе вот ну как бы держать этот баланс здравствуйте антон спасибо за доклад тут уже несколько ответов уже прозвучало на частично на мои вопросы вот терпит 1 вопросов там как вы формируете геозоны да вот это для для расчетов ранее я понял что вы их не формируете а всю россию прям за словите и уже ваш какой-то магический алгоритм разделяет их по кластером и шлет их конкретный сервер для расчетов язона вообще это просто сущности их там они какие-то геозоны сами умеют сформироваться какие-то геозоны руками просто аналитиками сдаются ну то есть это такая даст это просто инструмент просто сущность сущность которыми мы оперируем в данными ну то есть в dispacci конкретно у нас есть просто захардкожены и фактически там в базе данных эти геозоны которые там аналитики как-то обвели потому что они посчитали что вот ну вот такую зону надо разыгрывать в совокупности ну еще есть бизоны которые значит двумя что это вот типа вот эту геозона санкт-петербурга и про я понял что вот эти но скоростные коэффициенты там на трафик вы также как я понял вы уже сказали в ответ что предсказывается да не использует текущие данные повторите пожалуйста вопросы не буду но для анализа загруженности пробок вы текущие данные как ты were all to me это все анализируйте или все-таки исторически используются данные для расчетов ну в яндексе есть данные о текущих пробках ну мы когда рассчитываем как вы когда сколько водитель будет давать ехать мы но в том числе рассчитываем это с учетом пробок с учетом пробы в дорожной ситуации ну как бы ситуация тоже разные бывают am типом пробки такие а потом камаз упал что с этим делать я понимаю но ваши схеме это идет через tracker да как как оперативная информация и вы все ноты перегружайте данными пересчитывать все задачи которые назначены были на водителей да да ну да да каждый раз мы пересчитаем эту задачу и сколько времени занимает это вот я на графиках показал то стоит он но все задачи перестать проблем нет 100 миллисекунд это было это был розыгрыш ну вот типо самой-самой задача вместе совсем ну там какие-то какие-то секунды ну то есть это это быстрая штука достаточно ну даже меньше на секунду все достаточно параллельным умеет граф хороший примерно по объемам данных может сориентировать как подъема по объему только те данные которые на графиках были к сожалению подробнее ладно спасибо вот пожалуйста по центру спасибо за доклад вопрос такой а вот как соотносится этот новый алгоритм с прогнозированием времени доест до машины да пользователя то есть когда он еще не сделал заказ просто ему оценка дается как каким образом эта оценка делается вы имеете ввиду то что мы изначально показываем обильное увлажнение открыл приложения смотрю в этом показывает там допустим сейчас есть минут машина может быть то есть вот как в этом случае это оценка делается я так понимаю что не делается же полная оценка по этому алгоритму в любом случае ага прямо сейчас да прям сейчас мы ищем мы показывать там на самом деле есть несколько этапов мы показываем просто мобильным приложением машины которые есть вокруг это полноценно те самые машины которые из которых мы потом будем выбирать то есть антипы абсолютно те же самые алгоритмы детей время заезда которые мы показываем она сейчас но она сейчас немножечко вреда ну вот вот вот вот вот на этом алгоритме то есть она ближе к животному да ну и что что то жадным алгоритмом получается считается или тоже аналогов считается жаным да спасибо но мы работаем над этим в том числе это было очень откровенно сейчас вот справа вопрос здесь меня зовут владимир я пропустил вопросы на 10 повторюсь у меня такой вопрос как вы боретесь с лайфхаками от водителей допустим водители собрались и решили сделать искусственную зону повышенного спроса ну а те водители которые решили не делать зону повышенного спроса на там в других местах сама появилась они начали зарабатывать ну то есть как бы никаких санкций им не будет ничего но она не рожала сама regular регулируется его наш да то есть как бы если они все съехались или наоборот разъехались то в конечном итоге они все равно съедутся ну то есть как бы тяжело придумать такой кейс где вот они все съедутся разъедутся санкции скорее надо против тех которые корр ширинка отгоняют подальше от аэропорта чтобы он такси уехал хорошо вот слева вопрос такой вот яндекс навигатором пользуются как таксист и так очень много других людей вот если какие-то предназ тройки или возможности управления разделять потоки обычных автомобилистов и таксистов чтобы там у уменьшить время поездки там для одних и таксистов и увеличить до других и причалили об этом сейчас нет такого но вообще это классное будущее могло бы быть то есть когда мы обо всех меня зовут сергей пред значит так вопроса а учитывается ли как-то допустим изменение обстановки во время того когда ужинать водитель назначен то есть допустим он ехал перед ним случилась авария и и те и сильно увеличился до первый момент второй момент если это как-то учитывается или допустим да он отказался в случае допустим отказали с одной и с другой стороны это учитывается как-то этим алгоритмом если какой-то скоринг у водителя или у пользователя то есть кое кому то больше назначается кто-то имеют больше boost как-то так ага я понял от как бы вы учитывали но условно говоря если допустим пользователь давно ждал значит и ему вдруг отменился водитель или там сильно увеличился этот детей то я бы ему возможно перрин означал бы водители которые ближе чтобы общее время ожидания этого пользователя минимизировать но я понял это тоже своего рода эвристики просто как я говорил в этом жадный алгоритм вот прокачивали прокачивали прокачиваю прокачивали все что мы сейчас добавили это вот как бы знания о соснут о пассажирах вокруг мы сейчас это также можем продолжать прокачивать тем же самыми эври стиками и в какой-то степени да это делать то есть какой то у нас может как пользователь как-то например разыграться не сразу то есть например мы понимаем что вот в этом розыгрыше у него для него есть водитель но он например там очень далеко он просто на границе у нас там есть какой-то прогноз что там через три секунды будет возможность у него там найти водитель поближе но к примеру вот и такой у нас есть есть пользователь не факт что разыграется вот на на ближайшем розыгрыша справа 1 антон да да спасибо за доклад вот у меня есть небольшое уточнение поправь если ближе микрон до тонн поправь меня если я буду не прав подтверждения в dispatch или приходит получается пачка заявок и пачка водителей и в диспетчере происходит купер группировка заявок а водители находящихся в одном регионе и это пачка отправляется дальше в блокировщики tracker это верно tracker отдает нам водителей то есть мы получаем на каждый заказ который приходит драйвер dispatcher мы собираем пачку запросов пользователей факте фактически и tracker нам отдает пачки водителей которые подходят для этого заказа мы это типа из этого строй матрицу и вот ее решаем как раз а вот эта матрица с строится по группировки по зонам то есть ленинградская область ленинград санкт-петербург фото роза он вернется как вы будете обрабатывать кейсы если например нахожусь на границе ленинградского си санкт-петербурга пример нахожусь и ленинградской области и при этом рядом со мной ленинградского все нету водители хотя при этом и на жесты на границе прямо вот буквально в этом метров сто двести но я все равно круче река скорости и при этом получается я не получу водители и сам петербурга просто потому что и нахожусь не в той зоне получается получить дальнюю подачу это верно сейчас да сейчас может быть такая проблема ну да но мы думаем над тем чтобы вообще динамических как бы пойти в серию как бы найти о планах не говорят но мы тоже работаем над этом это вот ну своего время такой своего рода пилотный запуск то я так понимаю поэтому вас аналитики руками и чертят вот эти вот кастомные зоны для того чтобы обходить вот эти вот так он уже были уже были начерчены на все спасибо это скорее вы как пользователь когда находится ленинградской области смотрите blablacar параллельные там еще смотрите если мы не сможем назначить там всегда есть и фабрики как бы то есть в жадный мы умеем скатываться то есть мы там за какой-то вменяемое времени там по каким-то причинам не назначаем не знаю там все легло например у нас наши новый сервис то мы скатываемся в старой в старый алгоритм жадный уже он пытается вам назначать то есть ну вы потеряете о временном на ожидание но их просто хотел спросить вот сохраняться отводить на состояние водителей в атоме полос распределены по трекерам или это где-то отдельно хранилище как они хранятся вопрос о состоянии водитель собственно откуда подберется трекера вот эти состояния она ежесекундно подкачивает последние актуальные треки и всех водителей ну как бы каждый кличке разводе со всех водителя или как до достаточно памяти то хватает до то будет понятно как это дальше разделять но вот но вот пока не требует то есть ну вводить ряду ну что там несколько координат теперь вот справа у нас дожди антона спасибо еще раз доклад грегори компания опин sonic у меня два следующих вопросах ваша система оптимизирует расчеты исходя из приоритетов пользователи они водителей и пассажиров не может ли получиться так что водитель находясь в какой-нибудь популярной зоне будет все время то есть всех пользователей которые будут возникать в этой зоне будут отдаваться другим водителям с точки зрения оптимальности для них и то есть тот не будет ли за счет такого алгоритма неудачников которые будут стоять и ждать заказов водителя получается вас точно такие же пользователя системы я не уверен что правильно понял вопрос но давайте я попробую ответить так как понял ну водитель не будет один и тот же водитель назначаться постоянно потому что там есть некий фриз то есть мы там даем водителю время ответить за это время то есть там есть другие какие-то задачи решаются мы будем выбирать других водителей то есть если нет я имел ввиду что допустим он стоит в 1 . и рядом с ним находятся другие водители и все пользователи которые возникают все пассажиры которые возникают рядом отдаются другим водителям тоже то что он долго уже ожидает никак не читается то что он долго ждать не учитываться ну это опять кстати ну это опять вопросу эвристик то есть мы можем ну ка бы у нас как я уже сказал не детей ну то есть не в чистом виде и те и мы выбираем пользователя а это функция от скоринга в нее учитываются все эти сужу зоны в том числе сейчас не помню точно сколько водитель там стоит ждет как какой у него там типов но тоже тоже по зонам кажется сейчас и второй вопрос следующего низкого роста можем мы сейчас уточним там же еще рейтинг водителя тоже учитывается предназначение когда их много в одной зоне это такого ниже рейтинг он едет последним вот у кого ниже рейтинг едет последние ну да да уж кого три звезды он дольше ждет заказов чем-то такого 5 звезд я вот это не могу ответить я не помню это не давать 2 и второй вопрос вы говорили что увеличивая интервал на котором вы производите расчет и получаете более оптимально картину не думали ли вы начинать трекать пользователя когда он еще только включает приложение и соответственно понятно что он сейчас скорость делает заказ и соответственно делать какой-то prediction ага ну кажется совсем все просто да там типа машины обучения прикрутила она в общем то про уметь прогнозировать там снимем верта цию конвертацию вот этого включенного приложения в заказ разыгрывать начать намного раньше да вообще офигенно делаем вот здесь слева спасибо антон скажи если какой-нибудь управление водителями в этой системе превентивный перегон водителей в зону с повышенным спросом или push тем кто сейчас не на линии типа ребята и спрос новая отвечал отвечая на другой вопрос ответил уже и на ваш что есть тут буквально здесь bc бенуа разрабатывается такая штука как репозиция да мы умеем брать каких-то водителей которые стоят в зоне зная что где-то в других местах будут зоны с повышенным спросом и умеем их туда отправлять в нем так предложениям открывается предложение из разряда не стой здесь вон там лучше будет они и многие соглашаются те кто offline я не знаю насколько это ну вот у меня таких мыслей пока не в оффлайне ну как какая-то система оповещения но если водитель например согласится то можно сделать я думаю еще вопрос как вы проверили что номер алгоритм лучше как мы проверили что это алгоритм лучше перед тем как что-то делать - аналитики все посчитали ну так как как смогли потом мы запустились и они правы оказались как вы это знаете это все так как эта метрика которую какой то метрика согласно которую можете сказать что-то повысилась скорость ответы в том что такое так ага я понял ну вот у нас я наверное могу ответить так у нас есть зоны где в часы пик детей сократилось на 20 процентов ну кажется что это достойно спасибо за ответ добрый день спасибо за доклад я не учитесь пожалуйста самом конце января день спасибо за доклад еще раз уточните пожалуйста а учитываете ли вы вообще в алгоритме и оцениваете ли вообще в алгоритме свое время простое водителя на то есть вы можете оценить сократилась между его заказами она увеличилась между заказами как это вообще повлиял ваш алгоритм на это или нет спасибо ага мы прямо сейчас считаем это по зонам ну то есть там есть минутам динамически есть зоны где мы считаем что вот но также как вот так же как зоны с ржа где мы там умеем приоритет давать водителям который внизу они состоят то же самое есть простое водителя то есть у нас обычно простой водитель эта характеристика не конкретного водителя это вот ну типа там где он стоит и вот такую штуку мы делаем как изменилась время ожидания вводить но я не помню номер не ел так просто не помню если очень интересно напишите я обязательно найду алексей спасибо за доклад а вот это вы там уже рассказали ушка про скорем куда но вот вы все то как-то почетче можете еще раз только сказать может ли человек там бесконечно долго стоять и ждать когда ему ваш алгоритм то но назначит водителя да и второй вопрос все-таки вы проверяли там сколько в среднем там при скажем от момент того как я нажал на кнопку вы какому-то водитель у меня предлагаете то есть максимальное время максимальное время это все как долго я буду ждать пока одном to blow как у меня водитель я появлюсь вообще это все очень то есть кастом на это все очень сильно нас очень всё сильно зависит от того где мы в общем то находимся то есть ну вы же тоже понимаете что вот вот этот буфер это фактически отнимание времени у пассажира то есть это вот но фактически это вот этот буфер за счет того что пользователь начинает чуть чуть подольше ждать за то чтобы мы в конечном итоге намного лучше все все разыграли и он везде разные я вот вот прям так какие-то цифры схода наверное не назову просто он вообще везде разные что вот эти интервал розыгрыша они могут быть разные что там какие-то характеристики по которым пользователь может там типа еще немножко подождать еще меньше подождать большой кусок индии конечно же есть и ну вот какого то прям конкретного ответа вот там тепло увеличилась там настолько то процент а вот эта метрика его его нет здесь такое конечно вопрос с одной стороны через сколько пользователи закрывают приложение если например бесконечно долго идет ну это же все тоже можно посчитать но если здесь если ты видишь то вот там пользователь через пятнадцать секунд уже закрывает то они не делаю 15 секунд а если пользователь закрыл приложение на поиск продолжается в продолжайте искать закрыл приложение но поиск продолжается то же как и сейчас есть он не не отменил не отменил на она продолжается он жирует так же как сейчас ничего сам не поменялось мне кажется замучили можешь вот этот вопрос последний вопрос и потом поклон не отдыхали росте спасибо за доклад я хотел узнать про силой и кто определял время работы алгоритма который назначает водитель вы сказали было там 250 миллисекунд потом стал иван 120 как вы определяли что вот сейчас уже хватит оптимизировать но мы просто все баги пофиксили которые только может уже пофиксить то есть вы смотрели на код фактически но мы смотрели сколько считалось и там был какой-то примерно не знаю там опыт какое-то понимание что вот что ты тот не должно так происходить то есть это была оценка по времени исходя из вашего опыта просто ну как то так да ну и из опыта и стать те количество того количества данных которые там были ну ну наверно да хорошо спасибо а тонкому книгу подарим за лучший вопрос мне очень понравилось понравились каверзные вопросы вот-вот от господина очень было классно про геозоны вот эти еще одна книга есть еще у нас еще один спикер алена стрип всего хочешь ещё одну подарить ну подожди вдохни часто нет нет я пошутил я только троллил не шутил сначала хорошо это это не за это заплатит вспомни еще раз кто-то раздражает больше всех своими вопросами раздражает больше всех с моим вопросом но сейчас я уже так не ответит уже не красиво ты сделал но вот давай отдадим ну вот человек которым так по прямой стоит который вот из из дверей просто уходил на задавал вопрос хорошо уходя за задай вопрос ну да да хорошо антон спасибо большое всем"
}