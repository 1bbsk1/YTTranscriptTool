{
  "video_id": "eQjNQ2RnjUY",
  "channel": "HighLoadChannel",
  "title": "Железо не подведет. Как я готовлю к бою десятки серверов в день / Артем Артемьев (FirstVDS)",
  "views": 4136,
  "duration": 1603,
  "published": "2019-01-14T00:13:34-08:00",
  "text": "здравствуйте друзья рад что вы таки пришли второй день все устали буду вот но весело стараться чтобы вы не уснули у меня все и того меня зовут артем артемов я работаю в большом хостинг-провайдеры у нас есть м2 своих дата центра по честному первые до центра мы сами построили свое здание свои стойки то привезли поставили сами переживаем за ток и за охлаждение дата-центра это просто два отдельных процесса с которыми я не очень рад как я с ними живу 2 дата-центр это большая комната в большом соде с ней все проще но она тоже есть и того суммарно 60 стоек и порядка 3000 железный серверов которыми устанавливались с моим участием я их трогал ставил в общем железом работа и знаю о чем говорю ну я наверно технический директор и моя зарплата привязана к бта ему напрямую все все еще не считаю получать сто процентов зарплаты но пока не получается изначально в чем была проблема примерно 6-7 лет назад мы поняли что просто поставить операционную систему на сервер недостаточно операционная система стоит сервер готов бою и бодренький запускаем его на продакшен начинаются непонятные ребут и начинаются зависание сервера что делать непонятно процесс идет перевести целиком рабочий проект на новую железяку это тяжело дорого больно и куда бежать не понятно я согласен что современные методы тепло и о которых говорили до миняев соседнем зале кабы позволяет этого избежать ее перевозить сервер за пять секунд но наши клиенты тем более 6 лет назад точно не летали в облаках ходили по земле и использовали обычные железяки какая польза будет от вас расскажу какие методы мы польза пробовали какие у нас прижились какие не прижились какие хорошо запускать руками как все это автоматизировать дам вам советы и сможете повторить это у себя в компании если у вас есть такой потребности работаете железом в чем проблема с по идее проверить сервер нет такой проблемой изначально у нас было то же самое у вас 373 серверов месяц устанавливается есть некий чек-лист садится человек берет чек-лист проверяет процессор память диск и морщит лоб принимает решение да нет но серверов становится все больше и больше больше больше человек занимается непонятный рутиной этот человек стал просто как бы плакать и жаловаться что он прям ему гибнет на работе человек стал ошибаться потому что это рутина но приняли решение автоматизируем человек будет заниматься более полезными вещами мы просто жалко человека можно делать хорошие вещи немного экскурсий да когда я говорю о сервере сегодня о чем я говорю мы как наверное все очень любим место в стойках и используем сервера высокой плотности на сегодня этого два юнита в два юнита влезает либо 12 нот 1 процессом их серверов либо четыре ноты двухпроцессорных серверов то есть там каждому серверу достается по 4 диска нам все по честному очень хорошо плотно плюс два блока питания все резервирования и всем нравится откуда у нас железо железо нам привозит наши поставщики это как правило supermicro intel доводит на дата-центр дата центре работают наши ребята наши операторы они берут сервера пихают в свободные места в стоечки там подключают два проводка также в обязанности оператора входит настроить bios все двери то есть он препрег прикатывать клавиатуру монитор подключает настраивает два параметра это вот restore ion power лосс выставляет значения power он это чтобы сервер включался всегда как только появляется питание сервер должен работать без остановок и первую за их загрузочный девайс мы ставим сеть иначе мы до сервера за учатся не можем как бы то есть не факт что в нем есть диски сразу и так далее после этого оператор открывает нашу естественно панель учета железных серверов в панели учета оператору он до зафиксировать факт установки сервера указываем стойку наклейку порты сети порты питания номер юнита после этого порт сети куда оператор поставил новый сервер переходит у нас в специальный карантинный в лонг это с целью безопасности плюс в этом плане у нас висит цдх цпп haed ftp тут же сервер пошел будь это в наш любимый linux в linux есть все необходимые утилиты запускается процесс диагностики ну и так как сервер остается все еще 1 девайс с 1 глушь надевай спасите то есть евро который уходит в продакшен у них порт переключается на другой фланг и в другом плане нет дтп и мы не боимся что мы свой продакшн сервера нечаянно перри установим для этого у нас отдельный план сервер поставили бывает так что сервер поставили все хорошо но он так систему диагностики и не загрузился случается это как правило за того что в задержке в переключении планов не все сетевые свечи как бы быстро переключает планы так далее тогда у нас оператору падает задача на reboot серве руками то есть раньше не было этими аиф мы часто вели честные удаленные розетки мы просто знали в каком порту розетки сервер дергали розетку спам по сети и сервер шел и будь это сейчас там экономические соображения идти управляемой розетки тоже работают как бы не всегда хорошо мы содрогаемся питанием серверов рулим pipe имя и но сервер новый api ми-1 настроен его можно прибудет только вот подойти и нажать кнопочку поэтому сеть человек ждет лампочка загорелась бежит жмет кнопочку такая у него работа если после этого сервер не загрузился то есть специальный список на починку сервер под эту штуку там попадая сюда который на которых не запустился diag или параметры диагностики которых оказались не очень хорошее тоже есть отдельный человек который любит железо он каждый день как бы сидится разбирается грает разбирается драит сможет почему не работает все хорошо запустилась начинаем тестировать первым тестируем процессор как самые один из самых важных элементов первым порывом было использовать приложение от вендора intel у нас почти все процессоры зашли на сайт увидели скачали intel processing диагностик tool все хорошо показывает много интересной информации в том числе на работку сервера в часах там потребление питания в какие-то мне как было но проблема в том что оно работает под windows что нам уже не понравилось и плюс чтобы запустить проверку это просто подвести мышку нажать кнопку старт после этого начинает проверку когда закончил проверку отображает на экране что произошло никуда не дает экспортировать не подходит нам для автоматизации потому что ну автоматично запустить собрать информацию не получается пошли читать форумы нашли два самых простых способа людей спросили людей как проверяете ника запускаем вечный цикл как девзира впихнул смотришь топе 100 процентов одно ядро потребляется считаем количество ядер запускаем нужное количество caddy взирал жареные на нужное количество ядер все отлично все работает для надежности взяли еще одну утилиту бен стресс она строит матрицы в памяти и начинает их постоянно переворачивать тоже все хорошо процессор греется нагрузка есть отдаемся блюда в продакшен возвращаются пользователи говорят что ну процессор нестабилен проверили процессор нестабильно стали гадать дальше стали расследовать взяли такой сервер который все-таки после наших проверок падает стали выяснять включили в linux ядре дебаг собрали коры до мкада под сервак рябу тица перед reboot он сбрасывает надин на файлик все что у него была внутри выяснилось что в процессов процессорах есть флаги там разная оптимизации работы с плавающей точкой и оптимизация мультимедиа и так далее и если потрогать какой-то один из флагов то процессор и зависает и падает и бен стресс и вечный цикл просто этот флаг не дергает никогда потому что она не требуется ну первым порывом было оставить бен стресс пусть греет процессор потом в цикле пробежим по всем флагом бернем их процессор упадет все отлично покорили думали как это реализовать придумать какие команды позвать чтобы и дернуть каждый флаг читали форумы на форуме оверклокеров наткнулись на интересный проект проект по поиску простых чисел то есть есть ученые ученые сделали раз просто деленную сеть каждый может подключиться и помочь ученым эти простое число и ученые очень боятся что их все будут обманывать поэтому программка работ очень хитро сначала ты и запускаешь и она просчитывает простые числа которые она уже знает и сравнивает в результат с тем что я известен есть результат не совпадает то процессор работает не очень хорошо и вот это за свойственном очень понравилась она склонна к падению прилив рипли любой ерунди она склонна к падению плюс ученые хотят их чисел найти как можно больше и они оптимизируют постоянно ее под новые фичи процессора и поэтому она дергает очень много флагов запускаем ее у себя на 30 минут сама она не умеет ограничение по времени и запускаешь она работает вечно поэтому от используем утилиту тайм-аут 30 минут запускаемым prime потом просто проверяем что в нем в нем не было ошибок также смотрим логи ядра что ядро нам ничем не ничем не сыпет впрок к пмс немного экскурсии простые числа пошел посмотрел совсем недавно во третьего января . 18 года нашли 50 число мэра так называемые которое 2 в степени p в этом числе всего 23 миллиона цифр число можно скачать чтобы посмотреть это zip-архив 12 мегабайт качать не стал ну и для чего нам нужны простые числа как ни странно если кто не знает люблю баир со шифрование любое шифрование с открытым и закрытым ключом используют простые числа и чем больше простых чисел мы знаем тем надежнее ваш ключ и плюс ученые проверяют свои гипотезы проверяют математические теоремы мы не против помогать ученым нам это почти не стоит при этом у нас в win win win ситуация все довольны процессор работает все хорошо осталось выяснить что это за процессор используем дэмо иди коды -3 процессор показывает все слоты которые есть материнской плате и какие процессоры стоят в этих слотах эта информация просто уходит нашу систему учета никак не интерпретируется там дальше разберемся дальше начинаем а ну что ловим на удивление вот сломанная нога gain стресс и вечный цикл какой процессор прошел проверку процессор нагрелся кулер отработал ничего не нашлось м прайм упал долго и гоняли искали как бы открыли ну все понятно такой процессор просто не запустился оператор был очень сильный взял не тот процессор ну поставить мог ну вот еще один как бы прекрасный случай это вот черный ряд это вентиляторы а стрелка то как дует воздух и радиатор стоящий поперёк потока ну как бы этот случай и вечный цикл и им prime нам как бы то есть перегрелись все выключилась память памятью все довольно просто это просто некие ячейки в которые мы в ячейке написали информацию через некоторое время прочитали еще раз если там осталось то что мы записали то данные ячейка исправно летим дальше наверно всем известно есть хорошая программа буквально классика memtest86 запускается там с любого носителя по сети флопе диска сделано для того чтобы как можно больше ячеек проверить то есть любые занятые чеки проверить уже нельзя у программы все хорошо но опять же она не умеет никуда показываю свою статистику отображает ее на экране пытались ее как-то расширить все уперлось в том что внутри программы даже нету сетевого стека тамада собой притащить когда уже linux ядро притащить и все остальное да как бы идти далеко плюс есть платная версия программы платные версии продам умеет скидывать информацию на диск но у нас не всегда есть диск в сервере не всегда есть файловая система на этих дисках как бы там тоже как бы все спорно сетевой диск опять же не можем служить потому что место стыка поэтому как бы стали копать дальше нашли похожую программку называется men tester men tester работает с уровня операционной системы из linux и и самый большой его минус то что сама операционная система и мем тестер занимает какую-то ячейку памяти какие-то ячейки памяти эти ячейки не будет проверяться соответственно вот мем тестов запускаем вот такой команды передавая ему количество свободной памяти минус 1 мегабайт сделано для того что иначе его просто убивает он киллер место занимает всю память приходит вам киллер гейт такое все хватит работать гоняем 5 циклов на выходе имеем вот такую табличку с либо ок либо фиалка бы просто и и отправляем туда себе и дальше анализируем получили вы могли мы файлы ну вот для понятия масштабов проблемы вот у нас самый маленький сервер это 32 гигабайта памяти наш образ linux снимем тестером занимаешься от мегабайт идет 2 процента памяти мы не проверяем но по статистике его за последние шесть лет такого чтобы продакшене вас попалась откровенно битая память не было но этот компромисс который мы согласны и который нам дорого исправить живем с ним но по пути собираем также дни мая ты коды memory отдает все банки памяти которые у нас есть на материнской плате там обычных бывает до 24 штук и какие плашки стоят в каждом банке информация на будущее захотим ся проапгрейдить знаем куда что пихай скука планок взять и пойти к серверу и так далее переходим к устройствам хранения начинали 6 лет назад все диски были с блинами которые крутились отдельные истории было собрать просто список всех дисков там было несколько разных подходов как-то вот не верилось что можно просто лсд fsd посмотреть но в итоге остановились что смотрим лсд fsd звездочка и дефляции ssc 0 д в первом случае это сад одевайся во втором случае тоска zeeco с девайсе которые смотрятся и буквально вот в этом году начали продавать иного мои диски и добавили шатен в моей листам еще а в ком отрезаем все лишнее и послу как собой список дисков пытаемся с него прочитать 0 байт чтобы понять что он вообще как бы блочные устройства и все хорошо если не мать и смогли прочитать то считаем что то какое-то привидение этакого диско у нас нету ни когда не было и он не определился прочитали все хорошо первым заходом было как наверно вы все делаете давайте просто на диск по пишем дефран дома посмотрим скорость как правило были новые диски выдают 130 150 мегабайт в секунду мы для себя решили что 90 мегабайт это та цифра ну прищурив глаз там что это после после которой идут исправные диски все что меньше неисправные но опять же стали возвращаться пользователи говорить что диски плохие и так далее мерили примерно 30 процентов объема диска как бы дописали там по-разному попытались выяснилось что коварная физика с нами опять пошутила что есть так называемый угловая скорость и как правило когда запускаешь д.д. он пишет возле шпинделя если по каким-то причинам скорость шпинделя деградировала то ты как бы это замечаешь с меньшим эффектом если пишешь с краю диска тока вы там все сразу деградирует поменяли принцип проверки теперь мы проверяем в трех местах возле шпинделя по серединке и снаружи хотя наверное можно проверять только снаружи и но вот так встреча сложилось что уже проверяем в трех местах все работает не трогаем ну не грех не никто не спросить у диска как у него дела тем более что диски имеют сами про себя рассказывать мы считаем что хорошего диска нету заре логичен и фильтров то есть все сектора что вышли с завода все еще работают мы не используем диски старше 4 лет хотя они вполне рабочий и до того как мы ввели эту практику у нас были диски и по семь лет по-моему самое большое что я видел но вот для себя решили что после четырех лет уже как бы диск окупился и мы не готовы принимать эти риски нету секторов которые собираются быть за реал окончены ну и ультра дыма crc error это ошибки на проводке который подключен диск sata вам если она есть просто на поменять проводов и будет все хорошо легко чиниться дальше у нас начались ssd вообще прекрасные диски работают быстро не шумят не греются мы считаем хорошие создай больше двухсот мегабайт секунду просто наши клиенты любят низкие ценники и не вас не всегда попадаются хорошие диски хотя серверные модели как правило выдают 320 350 смотрим просто smart те же реала катит по урон и current pending sector плюс все ssd диски имеют очень хороший параметр это степень износа параметрами dvr authenticator мы диски и стираем до пяти процентов жизни когда на диске осталось всего 5 процентов мы его вынимаем и это диск как правило наши сотрудники ставят себе в ноутбуке разговаривают друзьям недавно мне позвонил товарищ сказал что прошло два года и он из терна еще один процент диск у себя в ноутбуке хотя у нас он под ssd cache им примерно за 10 месяцев и стирается до 5 но проблема крылась что не все производители дисков договорились о названиях и вот этот медиа vr authenticator пример у тошибы называется пирс and lifetime бюст то есть ищем вот эти четыре параметра как person to me just for leveling own percent of time remaining либо просто vr хотя есть диски круша у которых вообще нет этого параметра ну ребята просто решили не делать но они падают количество перезаписи диска и мы просто считаем сколько байт мы этот дискурс записали у него есть параметр байт в ракет и простая математика считаем сколько у нас и он проживет если променять меняем рейды раньше было so tired в современном мире я не знаю почему наши клиенты все еще хотят рейды люди покупают трэйд ставят а4 с доски которые сильно быстрее этого рейда которая 6 гигабит как бы то есть да у них есть какая-то инструкция они по инструкции берут и собирают я считаю почти не нужная штука раньше было три производителя adaptec три варианта там была у нас три утилиты мы заморачивались делали сейчас вся и купил всех осталась одна ученица все хорошо когда система диагностики виде трейд она разбирает диски на отдельные логически там на отдельные диски чтобы каждый диск можно было померить его скорость поспать и почитать его smart после этого остается урай да еще проверить батарейку да кто не знает вот батарейка на рейде хватает чтобы все диски еще два часа покрутить то есть выключаешь сервер вынимаешь он еще два часа вращает дисками что в этом завершил завершить все записи сетью у нас все довольно просто верим внутри дата-центра что было 300 мегабит если меньше и считаем что это беда и чиним также смотрим ошибки на интерфейсе ошибки на инте сетевом интерфейсе быть не должно там просто счетчик как бы если есть то тоже все плохо по пути стараемся обновить bios и айпи на эфир верим просто оказалось что мы не все вирусы любим у нас еще есть bios и которые они умеют uefi не умеют какие-то фишки которые мы используем стараемся обновить его автоматически это не всегда получается там как то все не очень просто если нет то идет человека руками обновляет плюс этими supermicro это какая-то просто одна большая дырка мы его не отдаем честно в мир у нас у нас серых адресах через open vpn но тем не менее как бы там боимся что однажды он вылезет и мы пострадаем поэтому стараемся что просто прошивка этими а я была всегда последняя из это не так то обновляем и intel на 10 и на 10 гигабитных из аркадии битных карточках не включает пкм то есть акация суть а сервер 40 мегабит стойке есть только ссора гигабит и посети загрузится не можешь потому что надо крутиться в гибельную карточку вот тоже мы отдельно прошиваем 40 где битной карточки чтобы наконец-то у них появилась poxy ей можно было дальше жить после того как все проверилась у нас сервера уходит даже сразу на продажу ему считается цена он выставляется на сайте продается итого у нас примерно вот 350 проверок в месяц мы проводим из них 609 считается исправно 31 проверка у нас не справляется нет процент у нас считается тахиров неисправна оно связано с тем что у нас богатая история там сервера уже стоят по 10 лет большинство серверов которые не прошли проверку мы просто выкидываем у нас есть три клиента который все еще живут на pentium 4 и не хотят никуда уезжать у них все хорошо в жизни 512 мегабайт памяти им хватает если будущее пришло от если бы городе эту систему сегодняшнего дня вышло очень прекрасная утилита хардвар или сняв она умеет общаться с ядром красиво отображать какой же какое железо у нас есть в ядре что что ядро увидела не нужны все эти пляски и так далее если будете повторять советую настойчиво советую посмотреть на эту утилиту и использовать ее все станет сильно проще ну наверное итоге что компромисс и таки неплохо обычно вопрос цены если очень дорого что надо искать этот уровень когда еще не очень дорого ну и часто очень непрофильные программы классно тестирует вот вопрос как их найти и всем рассказать ну и тестируйте все начало тянитесь спасибо ваши вопросы вот мужчина в конце слева спасибо за доклад очень интересно у меня пара вопросов 1 не думали вы свою тузов уложить его позор сну или продавать за деньги и где вы искали ну идей и вдохновения то есть как свои железы тестирует google фейсбук amazon возможно там тоже можно подчеркнуть и может быть вы смотрели на удивление я ничего не нашел общался вот с антоном турецким из баду у них как будет что-то подобное есть и у гитхаба что до подобные есть как бы тестирует а google я понимаю когда у тебя кубер нить из или его аналог у тебя умерла одна но да ну окей купер отец все разрулит перезапустит дальше то есть какой то я надеюсь что у них вот такой подход а идея вдохновляли но была проблема решали нас начали вдохновлял окей а по поводу 1 вопрос это не планировать его и и выкладывать продавать продавать то наверное не имеет смысла но планировал но руки не дошли но по сути я могу выложить вам по x и образ который вы можете просто посетить за грудь и заботиться он все проверит там подставите свою royal куда присылать информацию он пришлет это не проблема да однажды это сделаю пишите мужчина спереди на первом ряду спасибо за доклад как насчет гopoдa тестируете планируете какие не проблема с током в садах обычно то есть обычно настойку дают 6 киловатт это я могу поставить два сервера скупую вся остальная стойка пустая то есть это те люди которые продают g по у них какая-то хитрая заморочка с током и вам это полбеды ток если ты заводишь 6 киловатт в стойку ты должен с ним 6 киловатт тепла снять и вот я пока не придумал как это решить в масле читал там да у людей два куба воды а не доливают каждые 12 часов который испаряется вот еще мужчина спасибо за доклад а скажите вы как-то тестируйте материнские платы и песчаные змеи девайсы ну in вы мой девайс официально это тот же самый диск ssd ты с него собираем smart как бы по сути все материнские платы но вот только prime95 который по сути очень много памяти и вице погоняет между собой инвестируем шину между процессором и памятью а что там еще осталось материнской плате по сути кстати вот есть такая тенденция что раньше было интересно что можно было память пихать в любой слот когда у тебя 2 процессор на я мамка-то стоишь один процессор и пихаешь память любой слот теперь если ты ставишь один процессор ты можно пихать только первые слоты памяти мне было интересно выяснить почему это так и оказалось что контроллер памяти из южного моста уехал внутри процессора и вот идет тенденция к тому что все уезжает внутри процессора и скорого там процессор побогаче будет внутри мамки общаться потому что сеть тоже уже внутри процессора цепей api там уже есть как бы добрый день спасибо за на кот такой вопрос как вообще пришла идея для тестирования вот этих флагов использовать вот ну совершенно не профильную программу ну я не пришла была проблема мы очень много читали из колеи просто оверклокеры таких мы подумали что оверклокеры за те ребята которые должны на этом не одну собаку съесть на нестабильных процессорах и вот на форумах оверклокеров мы нашли что ребята не используют ни стресс не intel диагностик tool они там все все вместе хором кричат что вот еще простые числа программы склонна к падению добрый день и спасибо за доклад вопрос такое своим тестами процессорами пробовали жить есть по ним какие-то статистике я не против процессоров м д ну вот вот то что были эти сервера компактные у md всего этого нету то есть сами проц и неплохие но вся обвязка как бы для расы для стоек они не делают и делают armor мам даже не заходили на эту тему плюс пытался зайти на много процессов той машины где там по 4 по 7 по 8 и говорят что в москву такие как бы от одну два года но мой мои поставщики типа там одну в два года привозит везут два месяца как мы те якобы это хочешь привезем поставишь его киева до не надо то есть 2 процессор на это как бы самые ходовые польше нет вопросов ну тогда господа урай можно идти домой"
}