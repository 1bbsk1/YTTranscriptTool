{
  "video_id": "b5ogYsvx7_k",
  "channel": "HighLoadChannel",
  "title": "От CPU к GPU: когда ядра решают / Виталий Шутов (VK, ВКонтакте)",
  "views": 537,
  "duration": 2974,
  "published": "2024-10-29T03:08:40-07:00",
  "text": "Всем спасибо что пришли послушать Сегодня я постараюсь вам всем объяснить как работают видяшки И вообще нужны ли вам видяшки И что это такое для начала кто я такое что вообще что-то вам рассказывать последние лет восемь я программирую различного рода системные приложения занимаюсь всё это время машинным обучением развиваю генеративные аай Во ВКонтакте и я люблю когда код работает быстро важно то о чём я не буду вам рассказывать я не буду говорить как взять какой-то ваш код пушные и переписать его чтобы он у вас хорошо работал на GPU потому что это на самом деле зачастую полностью другая программа не имеющая ничего общего с исходной Я в принципе не буду говорить вам как такой код писать однако я расскажу как сделать так чтобы когда он был написано вы понимали то что у вас всё хорошо Вы максимум выжима из железа и что очень важно Я не буду рассказывать о том какие бывают вообще видеокарты потому что это огромный железный зоопарк О чём же мы тогда вообще поговорим прежде чем переходить к такой новой железке мы поговорим о старой о том как в принципе вообще работает Любой Ваш цпш А какие бывают подходы к проектированию железа те или иные и такая небольшая холивар ная тема А а есть ли смысл что-то оптимизировать поск процессоры и их использовать в современном обществе и вообще что такое цис в серединке как бы самое важное интерес как вообще работают видяшки как их правильно использовать и очень важно как их не надо использовать потому что способов отстрелить себе оба колена просто миллион и также когда их стоит использовать когда они просто разорвут перформанс и у вас будет огромный бу по железу по деньгам и так далее начнём сначала цпу очень разные все бывают это знаете илы там райзе Эпики зоны армы там диевские чипы их вообще Огромное огромное множество так или иначе процессор - это некий мозг вашего компьютера То есть он определяет его работу Он занимается тем что работает с шиной данных Он занимается тем что производит какую-то логику какую-то арифметику это по факту и есть такой Ваш компьютер а всё остальное некая такая над ним надстройка А у него есть такие важные характеристики Как нам прикладным инженерам о которых Мы все знаем это какая-то тактовая частота это какой-то размер внутренней памяти то есть количество регистров Какие инструкции мы над ними умеем И сколько у нас там есть ядер включая такие вещи как гипертрейдинг не гипертрейдинг и так далее так или иначе очень упрощенно говоря всё работает плюс-минус следующим образом мы берём получаем некие инструкции непонятно Откуда мы их как-то декодирует с ними делаем может быть мы их загрузим в регистры может быть мы их не загрузим туда потом какой-то Берт эти инструкции как-то их интерпретирует и говорит алу как их нужно исполнить то есть какую конкретную арифметику и логику Нам необходимо выполнить алу в свою очередь может сходить там в какую-то там память не память что-то с регистрами сделать это всё необязательно потом мы результат обратно выгружаем и обновляем программный счётчик всё замечательно У нас прошёл один цикл соответственно чем чаще Мы обновляем наш программный счётчик чем чаще у нас проходит наш цикл тем быстрее наша программа и работает всё как бы очень просто А хотелось бы так сказать но на самом деле всё чрезвычайно сложно вот даже на картиночки это Intel 4004 Это первый шестнадцати битный коммерческий компьютер и Как видно на этой схемки Ну не особо-то вообще Понятно Какой цикл куда что где ун нас сеется и так далее И притом это очень простая схема там невероятно простая любой современный цпш даст ей фору абсолютно спокойно и нужно понимать то что процессор - это что-то настолько сложное что в принципе осознать всю его работу все его хитрости тонкости А мне кажется одному человеку Возможно не представляется Однако мы можем это всё равно разобрать на некие Логические блоки так или иначе почти Любой Ваш цпу кроме какой-то очень странной эзотерики совсем а будет обладать Контрол Юнитон будет обладать какой-то какими-то регистрами и будет обладать неким алу и по частям что же есть что А алу - это такая штука которая состоит из каких-то операндов у неё есть какая-то куда она загружает результат у неё есть какая-то распаянная логическая схема которая выполняет логику Как ни странно и арифметическая выполняющая арифметику и есть какие-то статусные флаги чтобы это всё можно было конфигурировать и как-то поведение задавать алу такая это большая сложная история но вот если говорить на пальцах примерно делает оно следующее У нас есть какие-то входы непонятные и мы над ними выполняем какую-то арифметику логику например мы считаем просто побитовая or побитовая и складываем результаты Вот это такой льно простой лу Разумеется алу которые у вас находятся в ваших процессоров они там в бесконечный раз сложнее но как бы чтобы смысл передать хватает е этой схемки вот у нас есть некий Корол Юнит который уже занимается намного более интересными вещами Это намного такое более умный хитрый агрегат он по факту декодирует наши инструкции и Фет их он и с шиной работает у него здесь всякие программные счётчики у него есть типа часы свои внутри у него есть различные регистры буферов адресов и всё всё всё такое Разумеется в него не входят всякие вещи которые стоят от него но они очень важны например в случае каких-то пушникова внутри есть Это прямо вообще отдельная История это к нему отношения не имеет и есть Разумеется регистры как бы это самое на самом деле важное и главное что нам прикладным разработчикам нужно знать важно понимать что регистры Они вообще все очень разные прямо они очень все разные они бывают маленькие там 16 бита они бывают очень большие по 512 даже по 2048 бит в зависимости от архитектуры каждый регистр может иметь какой-то свой смысл то что вот например на слайди это 886 процессор интелонет некий смысл то есть что вот здесь у нас будет какая-то арифметика Вот здесь мы будем указывать на СТК тут будем указывать на сегмент данных и так далее То есть в них есть какой-то смысл но это так не всегда Да а опять же вот очень много в этих всех моментах есть деталей реализации и очень чётко провести грань где как Что работает практически Возможно не представляется Ну и то прям что вообще Мы обязаны знать когда пишем какие-то приложения с перформанса это как у нас работает то что у нас есть Ram то что у нас есть типа кэш Поша между всеми нашими ядрами L третий и у каждого ядра есть эксклюзивно L ВТО и L первый кэши соответственно чем кэш а выше уровня R1 назовём самым высоким ИТ самым низким тем он быстрее тем он меньше тем он Ближе у нас конкретно к нашему железу а так если просто сгруппировать вот у нас есть некий Корол Юнит он у нас обычно один на наше ядро а но так не всегда опять же разные компы бывают и у нас есть некая наша алу схема которая обычно тоже она одна на ядро Но на самом деле их может быть и две и так далее И вот колт командует алу выполняет что-то над регистрами и вот так наш процессор замечательно и работает в принципе довольно просто Аа есть два способа основных как процессоры вообще проектировать и делава делать это есть рисковые процессоры residual instruction computing Set и cis Complex extraction computing Set А есть Разумеется другие архитектуры подходы это всякие там вли Но это всё прям намного менее распространено чем риски цис Чем же они отличаются вот короче сложно Большая таблица Сейчас я вам объясню в случае рисков прямо ну в названии написано то есть сокращённо у нас довольно мало инструкций они у нас все одинаковые и выполняют какой-то очень маленький кусочек работы в случае циска наоборот инструкции у нас огромное количество они какие-то могут быть специализированый сложными в принципе та модель вычисления как они работают тоже по-разному то есть в случае можете напрямую у вас оба операнда в вашей команде они могут А и читать и писать в память в случае э риска Это невозможно то есть вам нужно сделать явные операции лода и стора с памятью что тоже очень важно из этого следует такое простое свойство все инструкции одинаковые Их у нас мало они одинакового размера и они у нас практически гарантированно в случае риска выполняются за один такт очевидно в цис такой гарантии вообще нет никакой потому что инструкция она на самом деле очень сложная она может делать сразу очень много различных действий как итог пайлан конвейеризация о ЧМ Я чуть дальше расскажу в риске очень простая мы можем очень просто конро наши инструкции исполнять их много штук за раз в случае циска это прям сильно-сильно сложнее Ну и как из этого следует то что риски нужно оптимизировать очень сильно на уровне софта цики в каком-то роде оптимизированы на уровне уже железа и вопрос типа вот а что лучше Вот как бы вот кто считает что лучше рисковый процессор чем ци Окей А кто считает наоборот то что лучше циско вый процессор так я прям польщён Потому что люди не любят циско вые процессоры А я тоже мне нравятся больше риски рисковые инструкции по определению меньше и короче они выполняется гарантировано за один такт что очень круто то есть это быст нак быст прокручивается у нас высокие тактовые частоты А поскольку инструкции все одинаковые а их легко проектировать то есть вот в принципе стоимость вашего железа она падает Потому что если у вас очень много инструкций они сложные то стоимость тестирования возрастает вообще в небеса очень-очень всё это дорого а и пайплайн риска Он намного продвинутый чем циско вый пайплайн так поскольку все операции они одинаковые процессор на самом деле может выполнять их быстрее чем за один такт потому что в один момент времени мы сразу можем выполнить их 5 6 7 8 штук и так далее Это зависит от количества степовка которые у вас есть в процессоре и прям такой холивар момент наверное Многие могут не согласиться но внутри вашего интелонет ваши циско вые инструкции сложные бьёт их на простые и исполняет микрокод а иловый микрокод - это при том абсолютно никакая не новинка есть такой разработчик Терри Дэвис он вот написал H и телос если кто-то знает это прямо такой жосткий Хардкорный сиш нек был а и вот он рассказывал у него был свой компилятор для языка си и Он для своего компилятора для языка си а у него был он рисковый то есть простые инструкции и он такой типа блин возьму-ка я свои простые рисковые инструкции и переведу их на сложные интелонет всё быстро работать а и ри Девис перевёл а Intel взял и обратно все его рисковые о исковые инструкции внутри себя побил на риски и тери Дэвис не получил вообще никакого профита А это очень глубокая тема на самом деле как вообще работает ваш процессор с его всеми микроархитектура там вот тот же бранч предиктор - это настолько сложная вещь что там внутри у вас там машин Le уже какие-то нейронные сети это выбирают Какой код исполнится какой не исполнится и очень тяжело читать документацию интела и AMD потому что там куча томов каждый Том - это 23.000 страниц удовольствия нес Приятных и есть простая PDF там всего 200 страниц и там прям все архитектуры микро архитектуры разобраны и так сухо чётенько объяснено когда Что появилось как что использовать Окей замечательно мы вот примерно разобрались то что есть сыски такой подход к проектированию есть риски А что же у нас с ви дяха а все ГПУ Я думаю без исключений являются рисковым устройствами весь разговор Я буду строить конкретно от диких ГПУ это как бы самый крутой вендер у него самые быстрые видях него самый крутой софт ещ куча всяких железа к этому всему имеется Однако термины которые употребляются конкретно в диких видях они так или иначе применимы и к амдм и к мапу и там к мобильным видеокартам и так далее Однако терминология так или иначе различается Главное отличие оно состоит в принципе вообще в парадигме в модели вычисления как она проводится видеокарты работат по модели вот процессоры пушки они Single extraction multiple Data то есть мы можем взять много данных из регистра загрузить операцию провести обратно и так вот делать а и число процесс трудов у вас ограничено вот если вы наверное пойдёте и купите самый крутой дорогой xon или какой-то AMD Epic у вас будет 128 тредо ой то есть коров не знаю может быть вы купите там на 512 даже но я таких даже не слышал а Но даже какая-то вши Венька 9800 GT которая вышла в 2007 году имеет больше 2000 я эти ядра Они конечно хуже они слабее не такие крутые Ну как бы сам факт вообще а современные видеокарты которые вот именно для кого-то коммерческого использования для вычислений они имеют там 10.000 плюс ядер А и есть такой минимальный квант исполнения вот та минимальная единица которая исполняется она называется вапо варп состоит всегда из тридцати двух трудов и важно понимать то что Вар либо не исполняется Вообще либо исполняется весь и до конца а такая Ремарка её Нужно запомнить если у вас хотя бы один тред в Ар делает работу дольше других все другие треды весь 31 будет его ждать поэтому очень опасно писать код на ифх на видеокартах потому что у вас получается неравномерное исполнение программы вы не можете гарантировать что все треды одновременно подойдут к концу и мы сможем обновить программный счётчик А как какая вообще дальше-то идёт история на этом всё не заканчивается у нас представим модель вычисления в виде пирамидки в самом верху пирамидки у нас находится буковка Т это ТД группируются в варпы варпы группируются в блоки блоки у нас уже дуля на такую вещь которая называется SM стриминг мультипро ссор и вот как раз таки стриминг мультипро ссор - это вот та единица которая занимается вычислениями притом она делают это очень хитро и Умно и у нас есть Грид это когда вот блоки группируются в гриды то есть в отличие от какого-то цпу мира где у нас в принципе ну довольно простая относительно модель вычисления тут видим что она такая сложная Зачем вообще это всё надо а вот мы взяли наши треды сгруппировать варпы замечательно потом наши варпы могут группироваться в блоке а каждый блок состоит из 1024 тредо максимум или ри двух варпов соответственно Если вы забиваете блок меньшим числом трейдов вы не доули зру ваше железо а блоки шеду на наш стриминг мультипро ссор который принимает в себя от 8 до 30 двух блоков соответственно в зависимости от архитектуры модели видях и так далее а и таких стриминг мультипро ссорой выполняют какой-то Warp в какой-то момент времени и потом программа группируется в большой Грид это вот то что уже исполняется всеми стриминг мультипро Сора и вот это есть в принципе софт который вы запускаете А эту штуку тяжело программировать то есть в принципе-то вот даже мы смотрим на 3D это нужно всю информацию держать а данные Они лежат притом видеокарта как раз таки хорошо работает с пространственными данными когда мы их группируют прямоугольную или в какой-то даже куб То есть у нас есть три размерности для вычисления А у нас есть куда это то что нам дал вендер на железо есть другие способы но куда самое быстрое А вы хотите всегда выжимать максимум перформанса из своего железа вы соответственно пишете такой си подобный код который у вас компилируется потом в 5X assem Вы можете компилировать его прота компилятором виден в ЦЦ или вы можете компилировать его чем-то опенсорс типа лма А потом происходит интересный шаг тоже нетипичный для цпу мира а видеокарта она про себя знает больше чем вы про неё она ещё вся проприетарная закрытая это вообще никто не расскажет как она думает что она внутри делает и она берёт ваш пяти иксо вый ассемблер и оптимизирует его вот прямо под себя Потому что она знает сколько у меня там регистров есть например Сколько у меня там памяти такого-то кэша такого-то кэша а поддержана ли у меня там такая-то фича или это фи и происходит второй этап оптимизации вашего кода уже на уровне алера прямо под конкретную вашу видеокарту у вас получается такая вещь как shader assem Или кубин это тоже проприетарная история если 5X Вы ещё можете ЛМ скомпилировать что это за ревер это assem это вообще там ну короче ещё всё хуже ещё большее Дебри и потом уже наш кубин он исполняется на нашей видяшки почему это всё работает быстро у нас очень много потоков У нас очень много трев их типа тысячи и они все работают одновременно и такой очень важный интересный момент у нас очень крутая память это память на видеокартах намного круче чем у вас есть на ваших пушникова вперёд последние АСО имеют пропускную способность 3 теб в секунду Например у них Ram А даже на старых видях у вас на каждый тред которых у вас 1000 доступно 255 регистров это регистр прямо полноценно это сверхбыстрая память она прямо вот распа вот максимально быстро к чему только можно и получается 255 на каждый тред и каждый стрими мультипро ссор имеет десятки тысяч регистров это прямо максимально вот эти быстрые крутые регистры которые мы хотим иметь а у нас крутая архитектура то есть мы можем брать и наше вычисление группировать А зачем их нужно группировать я расскажу чуть чуть дальше И это быстро не только вот у нас одна видеокарта хорошо работает мы имеем инструменты чтобы объединять эти видеокарты в ноды которые тоже очень быстро между собой общаются и в дальнейшем в кластера которые тоже максимально быстро взаимодей там у нас не никаких вобще ни задержек ничего всё просто со скоростью света летает А как примерно устроена наша память видях у нас есть некий рам который типа сверхбыстрый то есть 3 теба в секунду скорость вашей памяти Я не уверен что на цпу кэши как бы могут соревноваться на каждом потом у нас есть как мы привыкли некий общий L2 кэш который между всеми стриминг мультипро ссорами у нас шарится и каждый стриминг мультипро ссор имеет внутри себя ещё кучу разной памяти это регистры которые работают на наших рядах это L1 кэш это ещё более быстрый кэш который делится на два кэша и это очень интересно почему сейчас расскажу и readonly память это константная память и текстурная память то есть она специально оптимизирована под различные задачи Ну текстурная понятна Это какая-то работа с графикой со всем таким константная она всё ж такая General purpose Что крутого вот в этом L1 кше он делится в свою очередь на два другие кша а назовём так логических кэша физически это один кэш это кэш как мы все привыкли то есть в него Данные залетают Когда нужно они оттуда вымываются другие залетают чтобы мы не ходили лишний раз в Ромы и у вас есть ри Memory который вы можете лоцирование физического пространства и в данную SH Memory вы сами пишите что считаете нужным и данные оттуда никогда не вы То есть вы полностью контролируете Что происходит в вашем кше что в принципе в ПУ невозможно то есть вот я не знаю ни одного гарантированного способа записать данные в кэш и чтобы они оттуда никогда никуда не пропали и никак не поменялись и лежали вот конкретно по этому смещению Может есть какие-то конечно великие эксперты чернокнижники но для меня это слишком сильная магия у вас Батл зачастую не арифметика не логика А память Зачем нам такая сложная модель вычисления Когда у нас Дули блок арими мультипро исполняет только один Warp а Суть в том что варп они же ходят в память они что-то загружают туда а мы хотим максимально утилизировать вот нашу арифметику которую мы делаем стриминг мультипро ссор выбирает Какой ваб сейчас исполнять и продолжать исполнять реализует такой Дулин скрывая задержку по памяти то есть мы пишем программу и она никогда не простаивает то есть она всегда что-то вычисляет на любой простой у нас просто берётся Warp выкидывается типа всё подождём берётся другой Warp и исполняется вот типа разберём пример как этот дулик может быть устроен А у нас есть некая арифметика розовенькое есть некая память Синенькая и стрелочка обозначены простое у нас есть некая такая программа это последовательность какой-то арифметики логики и загрузок записей в память Ну и что-то с ним такого и предположим вот у нас есть четыре варпа которые остановились в какой-то точке исполнения возникает вопрос типа как нам продолжать исполнение чтобы максимизировать загрузку нашего мультипро ссора а один из самых простых способов - этото Дулин oldest схема максимально простая мы берём наши варп и помечает возраста Ну просто индексирует первый второй третий четвёртый мы берём первый Warp исполняем до первого Ожидание и говорим всё окей он ждёт мы идём на второй Вар исполняем его до первого ожидания и возвращаемся обратно к самому старому и так соответственно итеративности довести как можно быстрее до конца по факту самый старый Разумеется можно круче например Это эф как раз таки использует идею о том то что у нас память поэтому давайте мы будем выбирать р для исполнения такой что мы максимально быстры приём к операции с памятью то есть мы всегда будем смотреть который вот прямо сечас что-то запит или прочитает Сделано для того что скорее всего по предположению у нас заканчиваются все операции чтения и начинается там чистая арифметика Аа и в принципе подход рабочий А на всяких тестах бенчмарках можно получить 12% перформанса То есть у вас абсолютно та же программа вы ничего не поменяли просто спосо порядок исполнения варпов у вас изменился А я об этом рассказал Ну наверное есть в этом какой-то смысл как бы наверное можно выбрать тот-то Дулин этот Дулин там свой написать а мы опять переходим к неприятной новости мы вендер Лок нуты Поздравляю Вы не знаете какой у вас шедулер вы вообще ничего не знаете про него А все вот эти шедуле разрабатываются учёными в своих академических целях они потом Разумеется реализуются в железе через какое-то время Возможно а опять же это всё делается на ГПУ симе вы вендер локт вы ничего не Решаете вы можете проводить примерные симуляции Чтобы понимать Как ваша виха работает но это прямо уже такой очень высокий уровень сказать оптимизации пря нужно сильно сильно закапывать есть ещё куча вещей почему это работает Быстро Почему у нас Мы круто скрываем нашу задержку по памяти Я уже как сказал у нас есть планировщик врв который нам не даёт простаивать наши схемы всегда работают мы никогда ничего не ждём у нас есть такая штука которая называется Memory Access cing это чем-то похоже на то как у вас работает фенг в вашем цпу то есть ваш цпу смотрит Ага он прочитал 1 2 3 4 Наверное он прочитает 5 6 7 8 дальше я заранее это вш фену а и исполнение ускорится у видеокарты Этот способ фенга намного более крутой намного более умный а скорость Шей их размеры и возможность операции с ними намного круче на хах чем у вас есть на вашем цпу мире плюс видеокарты они могут асинхронно исполнять и работать с памятью То есть пока вы прямо явно в коде пишете я копирую Память из А в B вы в это время же а в тот же прям тайм можете выполнять какое-то вычисление То есть у вас работа с шиной какие-то операции с памятью включая внешнее устройство и внутри ваши вехи они всегда перекрываются то есть мы опять же никого никогда не ждём и очень крутая важная штука - это динамический параллелизм что это вообще значит я вот говорю что компьютер мозг Он всем управляет Без него никто даже сказать и пискнула железе а ви дяха умеет видях добавили такую вещь как динамический параллелизм то есть виха может сама запускать другие программы на видях если вы её об этом попросите То есть вы компилирует код и там говорится о том что как бы вот в этой подпрограмме исполни другие подпрограммы а очень много всего можно говорить про latency hing это такая глубокая интересная крутая тема есть крутой отчёт от Беркли там примерно в 150 страниц но это очень лёгко чтиво очень интересно плюс написано таким легендарным человеком в мире разработки а окей мы разобрались То есть у нас вот есть такая архитектура вычисления есть такая-то Память она вот такая-то быстрая бла-бла-бла Одной видях мало одна Хорошо как бы а две лучше а ещё лучше 8000 нам нужно уметь группировать видеокарты в какие-то узлы вычислительные а узлы соответственно в кластера вам для этого дали Никель Никель замечательно этим всем занимается на Никеле Вы можете построить практически любой массовый параллелизм потому что в Никеле эти операции реализованы максимально эффективно притом Никель он настолько умный То что он даже изначально не знает ше ра о не знает как вы Разместили сетевые адаптеры ещ что-то он е сам на ходу вычисляет и понимает топологию вашего кластера он оптимально обеспечивают все вот эти трансферы по данным по памяти по сети внутри ноды между НОД и так далее Никель очень крутой что в Никеле есть это простейшая операция У нас есть несколько рангов и Мы просто хотим на все эти раги примени какую-то агрегацию например просуммировать про умножать минимум Макси мы их агрегировать и каждый ранг получает копию это broadcast когда у нас один ранг владеть какой-то информации и мы всем остальным рангам эту информацию также шарим это ЮС соответственно если редьюс у нас все получали копию то в редьюс у нас только один ранг получает результат вычислений это All Gazer соответственно каждый ранг владеть небольшим кусочком Информации а мы хотим чтобы все владели всем и вот это тоже оптимальный происходит трансфер и обратна это операция бтка ой нетка перепутал соотвественно у вас все ваши данные делятся на уникальные кусочки каждый ранг получат уникальный кусочек типа замечательно как быстро вообще можно объединять видях друг с другом линки на последних видях а позволяет м достигать скорости до 9б пропускной способности имен по факту шину шириной в терабайт пропускной способности в рамках типа одного конкретного шкафа а там ещё есть более интересные вещи типа свиче и так далее То что мы можем это всё слить слить слить и обещаю то что там через сколько-то времени появятся свичи который обеспечит нам пропускную способность 56Б в секунду данных что в принципе ну объём сумасшедший как бы кто обрабатывает 56 данных в секунду нужно это ВС уметь оптимально трансфери поку Это очень дорого Мы всегда стараемся избегать работы с шины Особенно с PCI PCI вообще тормозной Несмотря на то что PCI там четвёртый пятый 50 Гб в секунду прокачивает это вообще немедленно а вот у вас Если вы какая-нибудь там разбирались со всякими штуками типа Кафки кафку умеет в dma то есть напрямую она с диска пишет ваш сетевой адаптер минуя цпш к видях умеет также есть РД ма вы напрямую Можете писать с ваши видеокарты через какой-то интерфейс например через PCI или infin Band в какой-то другой интерфейс который работает поэтому протоколу что вообще можно-то подытожить веду модели Сита Когда у нас куча трейдов их типа тысячи они все работают одновременно они никогда не простаивают имея платформу для написания кода для этого всего полный контроль над этим всем имея возможность что видях общаются только с другими видях то есть вообще это происходит в обход любого вашего цпу ушник А и такие сказать архитектурные особенности железа всё работает супер быстро в конце будут примеры разумеется Насколько быстро а но как бы не всегда быстро бывает и очень медленно очень медленно Когда у нас параллелизм недоступен если наш алгоритм не параллели кратко вы будете в тысячи раз медленнее поскольку треды они все слабенькие соответственно если у вас какие-то алгоритмы с Ифа Если они какие-то у вас рекурсивные если у вас одна итерация зависит от другой если вы случайно читаете Память то вся магия рушится Вы супер сильно опять же где мало данных если у вас низкий поток данных то просто шина съест весь охд дальше как раз таки это вот будет видно и перейдём к тому где всё работает Супер Круто У нас это векторный поиск такая довольно классическая задача Я думаю многие с ней сталкивались у вас есть какие-то вектора вот по ним хочется Упс уметь искать а приведён график по у у нас количество крей в секунду которое мы делаем по различные алгоритмы Как мы можем делать соответственно поиск по какому-то индексу и сравнение а со и такое Зонк Platinum а сравнение довольно честное потому что Зонк планум вообще типа недешёвый он стоит ты долларов Это такая не рядовая железка и Как видно что Зонк нормально так отстаёт от видяшки при том с видяшка вам довольно легко слится потому что в одну материнку можете ь штук поставить вообще спокойно но вос там во сотов материнки я такого не видел может быть такое есть может кто-то использует но мне кажется вряд ли есть Более сложный график его тяжело читать но я скажу как можно это всё упростить линии прерывистые это цпу А чем они выше тем это хуже потому что н настолько Арей с ГПУ видно то что всегда даже там на каких-то Ну алгоритмы поиска Конечно неточные мы стараемся как-то минимизировать пространство что чтобы как-то найти максимально быстро а Неважно какая у нас типа точность поиска Мы всегда на ГПУ работаем быстрее мы всегда лучше что вообще можно-то использовать куда посмотреть что скачать Какой github это рафт от рапица крутая штука то есть там вообще куча примитивов реализовано Всем рекомендую попробовать это я думаю фаис от меты запрещённой в Российской Федерации организации с которой я думаю многие сталкивались Кто строил какие-то поисковые индексы и от них же есть статья о том как делать поиск на каких-то небольших объёмах типа там 500 млн векторов а прям миллиарды То есть у вас индекс размером с миллиарды векторов как это всё запихивать чтобы у вас всё это работало типа супе оптимально более очевидные примеры кодирование преобразования различного картинок тут графики динг декодинг пега видно что в принципе пу в принципе не вмещается То есть это вот там настолько низкий что ЛК нужно рендерить было в другой шкале в логарифмической чтобы ну там вообще скорость работы абсолютна вот не соизмеримы вообще ни в каком виде это неадекватно плюс это именно только кодирование декодирование А над картинками вы зачастую применяете ещё всякие операции например там у вас веб-страница загружается вы хотите её обрезать кропнутая Тут ещё будет быстрее А что посмотреть есть реализации конкретно диевские у вас диевская видяшка это nvp и п для того чтобы делать Вот все эти преобразования кроп BL и так далее и хочется отметить одну компанию Fast видео они за деньги дают вам СДК который занимается как раз эти всем кодированием Почему примечательно хочется отметить N появился ну недавно скажем лет назад СТ видео сделали свою реализацию кодека кодека со всей обработкой намного раньше чем N NP - это проприетарный вендер это инженеры NVIDIA они всё идеально знают и в ст видео они сделали лучше чем в n види и уже это много лет лучше что вообще типа супер круто меня это прямо поражает дальше кодирование видео тоже недалеко не секрет И тут как раз-таки виден эффект шины а видно что когда мы кодируем какое-то видео с низким разрешением или с низким трейдом Мы даже проигрываем у нас всё становится помедленнее плюс сравниваться примерно одинаково всегда железо это i7 такой домашний в принципе процессор многим доступный и 1060 тоже такая домашняя видяшка она не дорогая видно что на маленьком разрешении у нас оверхед шина И мы мы медленные Мы реально медленные Но когда у нас растёт размер видоса у нас увеличивается битрейт видно как деградирует а кодек работающий на цпу а на ГПУ деградация намного меньше потому что мы мы не упирается в вычисления можем ещё что-то вычислять там можем всякую работу делать что тоже очень круто можно строить всякие сложные процесс обработке меди информации что есть есть видео СК у вас в железе реализованы два кода в зависимости от железки которые могут быть реализованы как на конкретных ядрах то есть они шарят общие ресурсы вычислительные а могут работать как прям типа отдельный сопроцессор это зачастую Так у вас на интела на для работы с видео это Прямо даже На таком уровне может быть реализовано у вас видях есть туторы как поть качество Как поть скорость То есть это такая уже довольно изученная технология и есть разбор на форуме об как люди сидели сравнивали все возможные коды в обсе как Что выбирать какое мы получаем качество битрейт пушные кодеки работают хуже медленнее и качество картин по у них тоже хуже есть это реально руто те математика Ну тут вообще без комментариев как бы кто считает там ML на цпу Ну типа А что есть А вы можете пойти в какие-то популярные фреймворки типа торчи ТФ это короче вообще не Круто А если вы просто читаете какую-то математику то берите прямо Рой кубс это это весело это реально весело А если вы хотите там какой-то очень жёстко заору ий движок с нейросетями Вы можете пойти тоже в проприетарный Q dnn где там тоже там типа git компиляция прямо ГПУ кода и говоря про компиляцию пу кода Мне кажется чики они такие самые продвинутые юзеры будут в плане видях потому что ну для них и строят эти кластера все и область зашла настолько далеко то что вы строите просто Граф вычисления а он очень сложный то есть там чтобы вообще понимать объём скорости работы Вы можете пойти и купить себе самой крутой МД эпи и у него скорость на 32 будет ну там порядка Я не знаю секунд Ну как будто быстро Вы пойдёте и купите себе какую-то крутую видиху и получите на BF 16 4000s как бы вот и вам масштабы вам нужно купить 1000 процессоров чтобы догнать такую же скорость на низком жене А ваши проы вообще низкий прен считать не умеют а он ВХ задачах не нужен а так вот возвращаясь обратно есть такая штука которая называется Tron от Open Я думаю известная всем компания она занимается тем что на ран тайме анализирует ваш Граф и на ранта Гене которы компилируется на ранта вшей а то есть у вас получается такая компиляция кода что типа супер круто это прям такой тренд большой Скоро я думаю мы вообще полностью откажемся от каких-то руками оптимизированных керне всего такого более интересные примеры не классические это аналитика на данных возможно я просто отстал от индустрии все у давно анализируют на видях Но ярен каже нарот вот мо такой пример считали когда-то на дупе всё и ждали там неделю потом стали считать на спарке ждут там день а можно считать на видях и ждать час а есть график читать немного сложно колоночки показывает вам на различные операции какой бус по перформанс вы получаете а ви дяха была Тесла Т4 она такая дешёвенький только так Мега кайф и какой-то Зонк тоже простой а соответственно на какие-то операции Вы можете получать десятикратный бу и как соответственно экономия по деньгам у вас Выходит тоже очень-очень большая есть различные прям чуть ли не дпн плейсменты там вот вы считаете там я не знаю на пансе каком-то ещё на чём-то на спарке а есть Прямо готовые инструменты которые позволяют вам сразу безшовна практически Ну не бывает ничего бесшовного тут практически бесшовной на это всё это конкретно фы это конкретны этеншен к спарку То есть вы можете взять попробовать взять свой запрос на Спарки и взять какой-то ваш датасет его куда-нибудь если у вас нет никакой видях залить куда-нибудь в облако взять просто ваш спарко вый код перекинуть его туда и подрубить этен который все эти вычисления переведёт на виху и сравниться по перформанс А вон те бенчмарки Они наверное не очень крутые потому что блин ну тритий перерост на какую-то операцию это типа слишком жирно По последней сы можно взять руками запустить и сравниться на конкретно каких-то данных есть прям тако довольно неклассический пример это компрессия конкретно на слайде представлен это такая реализация Как видно если на какую-то компрессию мы ещ имеем небольшой Т то на де компрессию у нас скорость достигает типа соте гигабайт даво сли разные компании и институты Например церн у Церна очень интересный отчёт там зон бенчмарк где какой-то сотрудник Церна взял 150 МБ Файлик посчитал время работы с PCI шиной взял Т4 против нескольких там процессоров которые в разы дороже и такой делает вывод Блин что-то типа я не получаю в 100 раз быстрее фигня ваши видеокарты но я обязательно посмотрю де что бенчмарк на самом деле неадекватный и он как раз таки вот Фет то что вам нужно понимать ограничение железа если у вас маленький трут у вас маленький бендвис по данным у вас их мало вам это Не зайдёт вы просто потратите больше денег и всё ни на что есть и более интересный пример сжатием текстур картинок и так далее всего этого сфм где уже адекватный Бема то есть там правильно почита работа шины и всего такого и там результат уже не такой утешительный вот Подводя некие итоги Если вы правильно понимаете ограничение железа Вы можете кучу денег сэкономить прям целую кучу гору в принципе Вы можете решить задачу которую вы в принципе не решили бы никогда То есть вы бы никогда не дождались пока ваши там не россеть обучится ещё какой-то процесс пройдёт там ваш весь видеоархив перекодировать на цпу бы кому это надо пытайтесь использовать всегда максимально бли зада То есть сейчас как считаю есть тренд как минимум всякие дата-центры они переходят на армо процессоры это рисковые процессоры опять же видеокарты есть всякие со процессоры для работы с видео с Медиа со звуком вообще совсем совсем подряд пытайтесь их всегда использовать везде и на бэнде и на клиентских устройствах и даже в браузере везде максимально близко Идите к железу и один момен который всего очень скажем вынуты вы жите с тем то что у вас есть какой-то какой-то там железо вообще Хз что она делает как делает и библиотеки непонятно как эти устроены это вообще типа не ок это ненормально и можно развивать Open Source форматы Open Source решения либо вот как сделали люди из видео то есть не взяли написали кодек которые работат лучше чем них тоже к сожалению можно для людей и тогда в принципе Прогресс обще людской будет ускоряться и на этой ноте я заканчиваю Всем спасибо за внимание Спасибо большое вот здесь уже есть вопросы остерегайтесь людей с чёрными бейджика это спикеры они могут задать неудобные вопросы Дада надо было бежать уже в этот момент Привет Спасибо за доклад Андрей компания Яндекс Хотел узнать насчёт Вот технологии для дата-центров для связывания многих видюхе там что-то типа или это какая-то надстройка над растом то есть ну грубо говоря бы где ты ВНО видеокарты там std stdp Да вот этот std c+ плюсны применял алгоритмы для обработки данных Вот как раз операции МПа редьюс и так далее а тут ты рассказал больше похоже что-то типа это На каком уровне Да это больше похоже на MPI И даже если посмотреть примеры Особенно с первым никелем Там прям явно будут вызовы MPI и так далее Никель в свою очередь он реализует больше Вот именно какую-то коммуникацию а какая-то логика по вычислениям она уже выполняется конкретно на наше видяшки и конкретно там работает ну и плюс на самом деле зоопарк железа экстен типа сетевых он сильно больше у нас есть nlink у нас есть NV Switch и у нас ещё есть inf бенды И это всё связывается то есть там по 400 ГБ У вас сеть всё прям вообще летает Вот надеюсь ответил Спасибо у нас буквально 2 минуты осталось поэтому Уменя Привет Спасибо больш за Давай по порядку Пожалуйста извини пожалуйста э раз да два и потом три хорошо и Потом выбираем кому дарим приз Здравствуйте спасибо Бош за доклад очень интересно было ближе микрофон А понял Скажите пожалуйста а вот часто возникает вопрос о синхронизации между кэша на CPU то есть там вот Мери барьеры вот всякое такое А как это всё реализовано на ГПУ я поняти тут такой момент то что на Ну да короче вс прозрачно всё за вас всё хорошо иногда баги в ассемблере прям в железе только и есть такой интересный момент то что у вас есть синхронизация Прямо как мы привыкли в цпу мире это типа атоми и так далее и там вот всё тоже явно расставляет но тут такой момент что реальной нужды ставить руками атомик нет потому что просто алгоритм сам по себе всегда параллельный Мы работаем над какой-то точкой данных каждый тред и как раз таки когда нам нужно синхронизировать их Значит мы делаем Что неправильно ничего не долж никогда синхронизировать всё должно работать максимально вот асинхронно максимально быстро всегда это вот сложность написания программ то есть вот как раз будет автоматизации вот ранта компиляции чтобы Вот именно вот в этот момент всё это заложить чтобы таких ситуаций вообще не происходило получается да вот такой атоп небольшой интересный был момент до вольты все Вар исполнялись в режиме Степа то есть нас идёт какой-то набор инструкций ассемблер и обязан всегда все треды находиться на одной Аленой строчке это вело к СТМ делом и типа это не справляется ВС если у ва видя старши вольты Поздравляю у вас дедки в железе вот Спасибо будьте добры чит четвёртый ряд слева от центра очень интересный доклад Спасибо большое Вопрос такой фонарь да Вопрос такой ведь известно что Несмотря на то что на видеокарте огромное количество яде коци грани из-за этого например те же задачи рендера картинку на цпу будут делать дольше но красивее в своё время компания Intel решила попробовать обойти это ограничение и сделала такую железку называется Intel xfe где они слышал про такую может быть нет где они попытались в рамках такой же платы сопроцессора запихнуть большое количество ядер но с полной поддержкой x86 Мне вот интересно что ты про это думаешь Дада купи поиграй их уже мало на самом деле на рынке продаёт про то что на будет хуже рендерится Я бы сильно поспорил потому что там они ничего на не рендер есть всякие порен и так далее которые прям нормально так физику симулирует там вообще ВС там качество Короче я у меня зрение плохое я в жизни хуже вижу поэтому нут вопрос мне кажется алгоритм как мы напишем но там вот можно взять Open gel о gel запустить симуляцию на цпу и на ГПУ то есть качество картинок у нас будет плюс-минус одинаково Если нет какого-то Бага в железе Как обычно а а скорость работы там ну вообще как бы небо и земля поэтому я не знаю вопрос основной был Что ты думаешь по поводу того что нет пытаются делать со процессоры в которых пытаются запихнуть большое количество низкочастотных ядер по аналогии с риском который стоит на видеокартах Ну ну вот мне кажется То есть если будущего такого решения если сделают плату как видеокарта но она будет полностью поддерживать x86 Ну вот Intel сделали что-то я про неё не слышал наверное не очень по-моему это был заход в инвестиции но он не выстрелил нене не я её на Авито хотел купить потестить ребята из Авита Просто дайте парню поиграться да будь добр финальный вопрос первый ряд два вопроса очень быстрых первый - это ели какие-то ограничения компания намер по процессорам это или Intel под ко тяжелее писать вот в работе может быть из сложнейшая архитектура которая у них там вот может быть или поддержка вот меньше у ком давай сразу ответим под Intel наверное более Прикольно у них есть всякие типа кли у них крутые профилировщик тю инспекторы и так далее Мне кажется намного круче тун чем потенциально ру быстрее ратат спасибо а второй личный что для себя Кавказа может быть Блин ну я просто верлок я Intel я жертва системы Не ну подожди Какая же ты жертва ты на сцене стоишь тобой скажи а вот этот друг он просто здесь сидит или он тоже от конференции да Давайте значит нужно выбрать двоих а махни рукой все кто задавал вопрос Просто я всех вижу их немного Ты же сказал что у тебя плохое зрение я тебе стараюсь помочь Ладно давайте собаку это собака Я надеюсь отдадим её за вопрос про а собака ВК уходит в Яндекс мо быть кусай Смотри осторожно там может может микрофон там да а второй интересный вот комментарий про иню железку Я короче посмотрю даже мне прикольно ну я не знаю что они делали но прикольно что они такой заход сделали да то есть это мужчине в Клем хорошо и тебе тоже памятный сувенир от Хайда чтобы ты не забыл что в 20 году зимой Ты стоял на сцене и был победителем а не жертвой Спасибо тебе красота друзья у нас"
}