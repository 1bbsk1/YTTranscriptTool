{
  "video_id": "xC6o-_HqYUA",
  "channel": "HighLoadChannel",
  "title": "Зачем и каким образом мы тестируем генераторы нагрузки / Андрей Филатов (Авито)",
  "views": 882,
  "duration": 3131,
  "published": "2019-12-05T08:53:27-08:00",
  "text": "меня зовут андрей филатов я проставленные разработки 2009 года последние пять лет плотно занимаюсь с летними производительности в частности его тестированием провел тысячи тестов как заказанных так ты внутри компании были попроще были по сложнее тесто и сейчас занимаюсь развитием платформа тестерами производительности внутри компания vita давайте посмотрим что такое из себя представляет внутри авито авито это сайт объявлений номер 1 в россии у нас бывают в пике больше 200 тысяч обращений к нашему бренду и вот эти 20 тысяч обращений кринаш выпадают нашу микро сервисную критик туру развернутая в купер нас кластеров которые вот выглядят как пример вот этот кусочек графа взаимодействовать и микро сервисов которые я изобразил да тут всё в все многообразие сервисов тот весь клубок поддерживать десятки продуктовых команд для того чтобы команда решила свой бизнес задачу она у нас является такой некой об особенной сущности которая способна решать все весь спектр задач которые перед ней стоит поэтому на включая себя как разработчиков back on the front end если необходимо так и тестировщиков аналитиков и других специалистов которые нужны для решения задач в том числе в задачи команды входят и проведения тестов производительности и моя задача как члены одной из платформ их команд внутри авито предоставить нашим продуктовым команду удобные инструменты для проведения тестов чтобы они по возможности отнимали меньше усилий и командой на выходе получали более качественные результаты исходя из тех целей к не которые они входят их часто ставят поэтому какое то время назад внутри компании мы начали развивать так и сказал уже нашу внутри платформы тестирования схематично она изображена вот-вот этом слайде и давайте мы немножко пройдёмся по ее архитектуре и рассмотрим какие цели вы перед ней ставили основная задача стояла в том чтобы предоставить именно удобные инструменты чтобы командам компетенции сотрудников 3 которых в плане тестером признательности очень сильно разнится было удобно пользоваться инструментом чтобы те процедуры которые это все включает по подготовке тестовых данных по конфигурированию генераторов по загрузке еще по анализу результатов была для них как можно проще и понятнее поэтому большую часть внимание мы уделили именно вот интерфейс на части который включает себя как утилита командной строке для загрузки в пюре равне тестов так графический интерфейс для получения анализа результатов тестов анализа их сравнение результатов и прочее так и развитый ebay для возможности включения нашей платформы в система автоматизации которого три компании у нас есть возможно это в циклы сиде или какие другие инструмент когда команда внутри себя использует немаловажный элемент помимо интерфейсной части эта система сбора хранения и анализа получаемых данных мы проводим десятки тестов тесты разные направленности каждой командой своих задач и которые оставят это могут тест отказоустойчивость тесты производительности повторяющийся тесты тесты на регресс и вот эти все данные мы храним храним обогащенные не кометы информации понимать каком окружении тест проводился как какие были версии продуктов которые тестируют все прочее потом можно было эти тесты соотносить строить некоторые тренды их поведения зависимости от релиза к релизу и в том числе делать различные анализы с применением сторонник данных например данных мониторинга тестируемых сервисов данных профилировщика в которые были задействованы входят тестируем если такие были и прочее это немаловажный элемент нашей структуры которые мы уделяем много внимания и продолжаем развивать в зависимости от потребностей команд которым пользуется но для того чтобы туда данные попадали нам нужен слой которые эти данные получает я говорю о слове связано с генератором нагрузки если кто-то элемент структуры которые непосредственно участвуют в подаче нагрузки на тестируемые сервисы мы сознательно не стали себя ограничивать выбор какого-то конкретного генератора нагрузки остановились вес свобода выбора то есть базовым мы начали развивать нашу платформу на базе индекс танка и генераторы фантом который поднимет начальном этапе это покрова практически все наши нужды но мы понимали что с развитием нашей выхлоп продукта с развитием отдельных микро сервисов рано или поздно нам его остановить не хватать рано или поздно прямо с какие-то его ограничения и вот спустя примерно полгода после запуска платформы мы поняли что есть кейсы важный кейсы когда мы уже не можем использовать танк и фантом для решения этих задач и начали интегрировать новые инструменты которые могли бы это покрыть сейчас мы в процессе внедрения 2 генератора это индекс пандора мы его уже использовали в ходе тестов для наших других наших про структурных компонентов это сервисы на в пакете кафка и прочее она себя хорошо зарекомендовал как инструмент и сейчас мы движемся в направлении что по используйте и как-то начала как второй генератор перспективе возможно замены и отказы от танка и фантома и построении нашей вас слоя генераторов именно ноги пандора сразу хочу отметить что вопросов не возникало мы стараемся в везде в наших компонентах этой инфраструктуры использовать открытые компоненты в частности в системы сбора и анализа данных мы используем клик house котором было достаточно докладов данной конференции и вы могли оценить его преимущества и недостатки к сожалению не все компоненты есть в открытом доступе который бы нас горит варили те же вещи связанные с графическим интерфейсом мы реализовывали сами можно было взять что-то на подобии граф анны но у нас немного ограниченные возможности визуализации данной которые обратились несколько более полезный для команд сделать поэтому и начать связаны с я им решили за вы сами ну и сегодня мы поговорим в большей степени генераторах нагрузки то есть основных остальные компоненты как система анализа интерфейсная часть это немного важный компонент он достаточно сложен можно отдельной доклады по ним на готовить но сегодня поговорим и минутах часть которой отмечено красным и давайте поподробнее посмотрим как мы разворачиваем генераторы нагрузки начнем мы немножко с другого конца посмотрим что мы тестируем сколько вы же говорю у нас сотни микро сервисов на карте развернутой в кластерах купюрницы по сути сам сервис его бизнес-логика никополь инкапсулируется в докер-контейнер потом с помощью cabernet регистрируется сущности к вернется на физических новых нужно количестве реплик мы не стали закатила секрет в плане разверну генераторов и по сути повторили тот же самый механизм только вместо бизнес-логики сервиса у нас находится генератор рядышком с которым есть некоторые контейнер который релизы ты наш стандартный генератора для того чтобы могли бесшумно подкладывать новый тип и генераторов и у них был бы единый интерфейс которым систем управления могла с ними общаться генераторы подниматься кудрин с их ими управляет поднятой генератор регистрируют системе управления генераторами и становится готовы для подачи нагрузки на один или несколько микро сервис за счет того что мы перес пользовали по сути все наши инструменты и для по одной развертывания поддержки микро сервисов мы очень сильно выиграли во времени именно реализации той части платформы которое связано с развратными генераторов но это принесло нам некоторые головную боль дополнительную как мы видим из данного слайда с вами генераторы теперь стали подобны матрешки то есть они как на нижнем уровне обернуты никакой сущности к вернется и и только потом разворачивается на физических но дах все это вносит дополнительные факторы в их функционирования которые нам хотелось контролировать и первое чем мы заботились после того как нас пловцов даже в процессе током с платформ начала появляться это мониторинге и начали мы с мониторингом и организация мониторинга именно сами генератор здесь сбор от тех данных которые генераторы способны давать о себе тоже пандора и другие знаковые генераторы на базе go они позволяют экспортировать свои внутренние состояния в виде метрик горан тайма джи-ви генератор на базе java сказано я тоже так и зародилось танк и фантом тоже него можно выводить некоторые данные по тому как он функционирует по количеству инстансов задействованных в стрельбах и прочитать информацию мы собираем и отправляем наш мониторинг но помимо этого нам хотелось и низшие слои вот это вот слоеного пирога тоже и содержит следующий уровень мониторинга которым организовать команду на уровне сущностей купюрница носят то как контейнеры и под и нашего сервиса генераторов потребляет ресурсы и опирается ли они в какие-то ограничения именно в тех ресурсы которые выделяются и далее мы спускаемся на самый нижний уровень здесь мы собираем метрики именно физических нот на которых наши сервисы разворачиваться почему это важно потому что не бывает такого на одно физическое нодди как правил одновременно раза вернуть целый набор генераторов какие-то проблемы с генератором могут не проявляться на метриках именно куда сможет не упираться в спа ультит другие сетевые но и каналы то есть он может в помои вполне себе нормально утилизировать повесить его полос которые образы но есть другие соседи на то есть физически ноте которые могут дом нагружать и процессор и и потреблять сетевую полосу эти вещи им на кто как чувствует себя вся физическая мода на которой развернут микро сервис наши гены то нам тоже важно мы тоже соберем за счет того что мы переиспользовать как я уже сказал механизмы организации развернутыми наших микро сервисах из продуктовых команд вот эти все метрики желтые зеленые они к нам приехали автоматом потому что они уже были в компании и это именно те же метрики которые собираются для наших продуктовых сервисов я не буду сегодня рассказывать о том как мы эти метрики собираем как хранить ночью я лишь дам наводки на доклады моих коллег которые были год назад здесь новосибирске и осенью в москве первый доклад им рассказать о том как насобираем метрики с нашей обычной инфраструктуры автор доклада именно вообще про архитектуру сборами 3 которым три компании есть но как показывает практика 1 сбора метрика недостаточно нужно еще уметь их структурировать визуализировать и анализировать и вот именно подход к тому как вот собираемой метрики мы потом структурируем на основе каких данных мы спускаемся ниже понимаем корневую причину тоже важен вот третья ссылка это на доклад петра зайцева который вот на подходах red eyes но прошлом колоде в москве как раз и показывал как можно это сделать кому интересно очень рекомендую с этим ознакомиться мониторинг у нас есть мы собираем метрики можем выводить метрики совместно с ребятами тесты можем понимать пошло ли что-то не так в ходе теста и соотносить результат получаем в тесте с тем что мы видим генераторы в теме режиме которыми работает но нам этого мало мы хотим помимо этого уметь какие-то действия опережать то есть не реактивно реагировать на ситуацию возникшую при входе боевого тестирования мы видим на мониторе к что-то пошло не так мы это дело печеньем и прогоняет а заодно на тему нектар вещь превентивно реагировать то есть мы хотим понимать как себя ведут генераторы в тех или иных ситуациях и уметь моделировать эти ситуации для того чтобы это сделать мы организовали для генераторов отдельный тестовый стенд вот эта картинка отличается той которая была показана в разрезе подачи нагрузки с генераторов на нашу продуктовую сервис только тем что вместо продуктовых сервисов здесь представлены калибровочные мишени как мы называем калибровочной мишени разворачивается как и генераторы на отдельных физических но так чтобы не было какой-то интерференцией с другими продуктовыми сервисами которые участвуют в тестовых прогонов и прочих чтобы мы получить как можно более чистым результаты в ходе нашей тест еще как правило их разворачиваем даже внутри одной стойке чтобы как-то минимизировать сетевые походы то есть они по сути стоит вот на slack со единым коммутатором и сетевые издержки здесь минимальные уходы вот этих тестов которые зачастую бывают очень нагружены они никак не влияют на другие ноды кластером по минимуму влияет все хотели тоже развязать сделать какую более такую лабораторную среды ткачество значит что при что из собой представлять мишени для чего она нам важно и что мы от них хотим получить мишень это такой же микро сервис как и продуктовый любой другой я задача которую переставишь нагло нами контролированное чтобы мы знали что вот по такой то ручки она возвращает потому словно ответ какой-то задержкой фиксированный или с каким-то известно нам распределение или размер ответа на возвращал чтобы мы могли в ходе теста подбирать эти запросы таким образом чтобы протестировать те или иные аспекты работы генератора вести то вечера там контролер для нас есть изначально у нас была записана мишень у нее был набор фиксированных ручек были ручки медленные которые начали медленно мы знаете что эти ручки медленными и ручки быстрые которые чили быстро бли ручки отвечающие xml джейсоном большим размером ты там маленьким размером ответа нами были ручки с чеки авторизации разных видов с разными алгоритмами сжатия возвращаем был такой набор методов который позволял ты тестировать в том числе как функциональные аспекты работы генераторов так и не функциональны но такой подход и самописный сервис мишеней он выпрямленное от времени стал нам очень удобно с точки зрения что он только очень много времени на его поддержку как я уже говорил вас много бортовых команд у них совершенно разные продукты совершенно разные технологии на 3 продуктов зачастую протоколы используются разные поэтому необходимо было постоянно расширять функционал этих решений и у нас просто это не был ресурс так как это отвлекало у нас от наших задач развития других компонентов это уже при структура у нас количество сотрудников моим подразделение так много поэтому мы стали смотреть как мы можем это дело упростить нет ли каких-то открытых решений которые нам помогли это дело и систематизировать одной стороны и за вот так что это от нас не зависело и меньше требовалось или и мы пришли к использованию такой вещи как вич theben это такое сервис для тестирования и че тебе запросов ответов он внутри компании уже у нас применялся для тестировать их то клиентов в типичных и прочего как они работают с теми ответами запросами заголовками так далее код продукта открыто вам еще доступен у него очень неплохо сделано и документация с лагеря он на татаринова внедрили он реализовываем песен флаг сама который у нас был до этого нашими сам описанного мишенями и много помимо этого поэтому его внедрение по сути очень сильно нам облегчило жизнь ближе 6 стран с точки зрения что он конфигурируется именно запросам то есть то как сыч theben будет вам отвечать вы можете конфигурировать в теле запроса нужно чтобы он ответил 50 секунд вы так пишите делай вызов опять делаем 5 миллисекунд сельсовет нужен 5050 нужно чтобы ответил джейсоном определенного размера и джейсон вернет нам формате джейсон хотите авторизацию то же самое и реферат формат запроса нужно ее зазывать это позволило нам с помощью ленты запросов генерируют тестовые сценарии не вмешиваясь в структуру мишени как-то отдельно конфигурирует для конкретного кейса и кроме того это позволило нам вот эту вещь наш тестовый стенд обернуть некий стэн сэндбокс для наших прутовых команд как вы же говорил нам нужен в низкий порог входа команд вот в наш инструмент чтобы они могли им пользоваться самостоятельно этот стенд боксу котором они могут потренироваться посмотреть различные кейсы использования инструмента остановить как себя ведет инструмент при различных запросов на разные ручки как можно анализировать эти результаты он очень этому способствует и мы сейчас планируем это делаю внедрять на уровне кампании чтобы именно команды могли привыкать к инструменту вот в таком изолированном окружении могли с вами конфигурировать нужны тесты идти возвращаемые мишенью корреляционные результаты с помощью вот лент запрос как себе это покажет будем смотреть и того у нас есть тестовый стенд давайте поговорим о том что мы с помощью пытаемся контролировать первое что я уже немножко затронул это функциональные возможности генераторов казалось что здесь такого есть генератор и их сейчас достаточно большое количество открытых платных и прочих кожи 200 ситуация бери спецификация смотри подходит ли он паттае требование бери и пользуйся ну как говорится дело кроется в деталях двое то очень очевидные кейсы когда вроде бы поддержка того и но фусан генераторе заявлено но по факту оказалось частично либо какая то совсем сложно для реализации к типичные примеры с которыми мы сталкивались это поддержка tls внутри вот фантома внутри индекс на как генератор фантом поначалу она не все шив россию ты поддерживал это один из элементов которые ограниченного использования но редкий кейс но иногда вылетает другое дело что сейчас и до сих пор ее вряд ли это будет подчинена он не поддерживает сервисный дикий шум эта сцена и это один из одно из расширений протокол tls которые сейчас повсеместно используется с помощью фантома его не за протестировать это большая проблема она частично решается тем что можно пересобрать фантом указав ему конкретный там вкусным который хотите обстрелять и для отдельных тестов это рабочее решение но как решение для широкого применения на уровне многих микро сервисов это не рабочие и такие кейсы можно отслеживать именно на этапе тестирования вот в изолированном тестовом стенде другие аспекты которые мы пытались рамках нашего тестового стенда отслеживать это погрешности которые вносят генератор что мы понимаем под погрешности погреешься мы понимаем то различие в получаемых результатов между данными между тестами проводимыми в нашем окружении и тем что мы видим при аналогичных нагрузках в против такие погрешности мы различаем первый вид погрешности это методические погрешности эта погрешность связанные с неправильной методикой проведения теста не какими-то допущениями в этой методике связанными с ограничениями генераторов с не может генератор какой-то там сама делать мы в рамках теста его каким-то образом полечили pirelli тест not результаты этого теста они ну будут не очень соотноситься с тем что мы видим реальной эксплуатации давайте поподробнее то есть вот если рассматривать тестовое окружения методические погрешности влияют как правило организация тестового коржей настолько она совпадает с продам систему слой который мы будем видеть в боевых смотаться и вот это вопрос очень жирные очень сложные и сегодня мы не будем говорить потому что действительно больная тема можем судью в кулуарах после доклада но сегодня вот мы методические погрешности связанные с недостатками теста окружений трогать не будем мы коснемся те которые завязаны именно на уровень генератор здесь на ту часть которой показано слева какие здесь могут погрешности с чем они могут быть связаны первые погрешности которые могут быть связано с выбранным генераторов связано с не верным выбором типа генератора или его конфигурация поясню на примере того же яндекс танка и фантома то есть яндекс позволяет управлять нагрузкой в двух режимах либо путем контроля и управление изменения инстансами так называемыми в этом случае каждый из нас по сути это синхронный клиентка сервиса его задача отправить запрос и получить синхронный ответ без в этом он следующий шлет получает обряд то с каким рейтом с каким рпс сомкнется запроса зависит от того как быстро отвечает у вас тестируем и сервис отвечает вам 10 миллисекунд значит 1 место нас будет засунуть него там 100 запросы в секунду соответственно вот имея такое расписание управление те из нас это подключаем 1 2 3 и смотрим как себя ведет сервис при увеличении количества параллельных клиентов к нему как это можно соотнести с с реальным боевым снова где мы видим такое вот так называемую закрытую модель нагрузки в каких случаях мы ее в реальной эксплуатации наблюдаем не хочу сознательно приводить примеры таких выраженных случаев из разряда у нас есть какая-то бык офисная система в которой шесть старушек сидят нажимает кнопки и вот они систем начинать тормозить они начинают больше ждать и реже нажимать на кнопочку и соответственно это закрытая система неких больше потоков кроме как вот от этих людей нету таких примера я не буду проводить приведу пример более приземленный это сервис или систему расположен за неким балансировщик ом нагрузки которого есть фиксируем и количество пул соединений которые что этот вопрос по сути от количества инсов определяет количество соединений которую у нас есть со стороны балансировщика и вот поведение мишени в таком кейсе повторяйте на поведение сириуса за таким балансировщик am что еще позволяет делать танк в плане подачи нагрузки помимо управления низ танцами он позволяет подавать их называем открытую нагрузку то есть нагрузку которую мы контролируем именно поток запросов которые идет генераторов к сервис то есть мы увеличиваем именно количество fps которые мы ходе тест и подаём неважно как себя чувствовать сервис начинает он деградировать начинает он отвечать сильно медленнее чем от него ждали танк согласно свое расписание будет пытаться сослать него the rest то количество запросов которые в нем указано в конфиге засылать он будет с помощью тех инстансы который у него есть то есть сервис начать быстро так как для подачи нагрузки нужно меньше количества венцеслав хорошо сервис начинает деградировать танку вынужден держать количество запросов большим мы просто подключает большее количество инстансов таким образом умудрился когда ему открыто нагрузка присущи интернет-сервисом доступном извне то есть когда у тебя есть к большое количество пользователей которым не которые не знают как быстро или медленно отвечает вопрос тут запрос баннерная система как показывается на разных страницах независимо от того загружена система и загруженность всего запросы на получение ответа на запрос об это будет от вас на и вот такие выбор того методы к которым мы нагружаем зависит от того как система будет работать в против будет или она испытывать открытую за мной груз к то нужно использовать вот такой тип генератор который управляет именно количеством запросов будет ли она там за балансировщик am закрыты каким-то фиксируем поломка но кто то она имеет смысл и на закрытую тестировать не всегда очевидна и каком состоянии система будет приду примерно у нас была суть я работал какое-то время назад в компании занимающейся защиты от ddos атак и те сервисы которые ставили под защиту когда они под защитой они по сути зовут таким вот балансировщик am то есть они испытывают именно закрыта нагрузка они выходят из-под защиты закончился период защитой прочее они начинают испытывать им на открытый тип нагрузки и взгляд таких систем были кейсы когда тестировалась поведение в одно из состояний и все было хорошо когда система выходил из-под за 400 стал снова спать подвержен открыты нагрузки оно достаточно сильно деградировала что там открыть нагрузка достаточно более жестко намного более жестче чем закрыта и для таких систем которых не понятны и так и не будет развернуто или в каких во дни кейсах они так других действо по-другому имеет смысл в ходе теста рассматривать разные варианты и выбирать генератор исходя из тех кейсы которые тестируют в этом случае использовать закрытые знать как себя системы и так потом сравнить как она работает открыто нагрузка и соответственно сделать и же выводы по требуемым доработкам это один аспект другая стали который может влиять на это эта конфигурация генератора вот в этой же схеме с эстонцами танка может наступить момент когда и tippins твинса для подачи нужного уровня нагрузки тонко может не хватать сервис деградировал начинает долго отвечать так вынужден держать большое количество открытых работающих инстансов ждущих ответы от сервиса пытается добавить новых чтобы соблюсти расписание запросов она honda быть не может но что в нем по умолчанию стоит ограничение в тысячу инстансов и тогда мы по сути переходим от того что генератор место чтобы подавать открытую нагрузку становится закрыли начинает подавать закрытую с тысяч параллельных клиентов дамы тест проведем в таком случае он будет но мы не получим те данные которые мы ожидаем и вот эту погрешность она как раз тоже связано с методика проведения теста и ограничением генераторов из-за того что они не достаточно хорошо сконфигурированы с данном случае можем увеличить количество инстансов фантом даст очень производительный генератору может в десятках тысячах и ссср подниматься на физической машине но тут нужно быть внимательнее смотреть на уже другие возможные ботаники там на уровне количество доступных дистриб дескрипторов и прочего там уже другие вещи но они уже не будут связаны именно с генератором нагрузки его ограничению конфигурации они могут спуститься на уровень ниже поэтому здесь тоже стоит быть внимательным что помимо типа генератора и его конфигурация может не влиять я это называл изменение логике мишени дело в том что бывают ограничение генератора который нас вынуждают сделать какие то правки и какие-то модификации в самом тестируем сервиса чтобы иметь возможность сам тест провести коснусь опять того же фантома всем из многим известно что он не умеет читать и обрабатывать ответы в ходе тестов он не может получить ответа тестер maya сервиса вычленить какие-то данные заголовков и listelo ответа и переиспользовать их уже с последующих запросов это относительно большая проблема и очень сильно ограничивает использование так а в связке с фантомом для большого количества кейсов и и в принципе можно обойти это систем действительно нужно протестировать и так вы проявите можно в принципе отключить этот функционал на стране сервисы сказать что мы условно передаем как заголовка которому сей раз просто не будет какой-нибудь crf токен учитывать при обработке формы многие условный пример динамических вещи которые имеет смысл учитывать тесте теста мы проведем все будет хорошо но все-таки этот выключенный финн салон как-то скажется на поведение сервиса и мы получим расхождение между тем чьи что мы видим в ходе теста и тем что мы ожидаем увидеть и увидим так или иначе в прозе это тоже методическая ошибка что еще можно учесть большинство генераторов открытой нагрузки тоже так в режиме рпс могу привести пример еще столько генераторы vegeta написано год они падают нагрузку вот если указано фиксируем количество рпс тысяч рпс они от равномерно будут отсылать запросы значит тысяч рпс под номера секунды между запросами мата не так равномерно шлют в реальной жизни сервис испытывают нагрузка не равномерно как они генерят она все-таки такая бывает более плотно будет более разреженное такая там экспоненциально и прочее уже слышали о мирскими посоны это все вещи связанные с ним насколько это влияет на характеристики сервиса которые которые мы тестируем и полученным и здесь какую-то погрешность с вами с реальными данными тут зависит от но теория черти гласит что в случае когда у вас нерегулярный энтерол поступлений запросов очень велика вероятность того что вы где-то можете схлопотать скопление в очереди и соответственно сервис может себя повести по-иному такие вещи стоит учитывать есть ряд генератор который позволяет это указываете позволяет задавать им на и распределение запросов которые не шлет на если нет возможности использовать такой генератор id позволяет можно к примеру если мы говорим про тоже танка можно пускать нагрузку с большое количество из танцев и съесть оказалось мы запускаем несколько генераторов кратно дорогим нагрузку с них и правильный сне грузим сервис тогда за счет того что запросы идут с разных машинок испытать разные там сетевые задержки и прочее они будут приходить нерегулярно тестируем сервис и вот равномерно поведение будет несколько изменено в целом повторять те вещи которые мы можем видеть в реале эксплуатации чем больше генератор тем больше он будет повторять вот как можно отслеживать методические погрешности вот та часть которая связана с генераторами и конфигурации можно отслеживать на основе внутри fila метрик то есть смотреть эту мудрость высунуться значит что-то не так на чем мы видим плата одна из нас на чему и как сконфигурировать неправильно с этим что-то делать можно анализировать метрики логе тестируемых сервисов то есть относить то что мы идем в прозе по метрикам про да и то что мы видим в тесте и смотреть действительно нагрузка получаем от генераторов повторяю нагрузка который мы видим в прозе и на основе это делать такое предположение что у нас что то не так и методики переде не тестирования так методической погрешности мы к примеру решили сделали стенд который повторяет условный прот сделали настроили генераторы нужен методом выбрали нужно идти генераторы все свои фигуры как надо получаем варится до можем ли мы здесь гарантирую что мы божьи другие погрешностей не получим на самом деле нет есть мы выделяем еще один класс погрешностью первым за это инструментальное для те погрешности которые вносят сам генератор откуда они могут возникать они могут занять из-за того что в код генератора про не какая-то ошибка такие кейсы известны несколько лет назад в генераторе врк какое-то время присутствовала бага с подсчетам при ценителей и вот этот период все тесты которые появились твою версии врк содержали эту ошибку в подсчете данных здесь мы не могли быть уверены в том что вы получаете те данные которые на самом деле испытывает тестируем система это скорее редкий кейс но он даст вполне возможно другие вещи связаны с режим работы генератора то есть в зависимость стал каком режиме работы гиа насколько нагружены сколько утилизируется физическое но до или контейнер который раз этот генератор очень сильно влияет на то какую погрешность он может вносить в результат покажу на примере у нас какой-то рюкзак была задача подать нагрузку на тестируемый сервис который поддерживал совершенно сторонняя компания у нас не было данных по мониторингу из-за чего просто 550 увеличить нагрузка смотри как среагирует система и делать выводы о том стоит ли что-то оптимизировать не стоит как говорю мониторинг нас не было то есть мы видели только те данные которые мы получали стороны генератора мониторинг нам подъезжали через какое-то время скажем сутки или двое потому что такие были процессы взаимодействия взрывай команды вот мы провели тест получили второй график это тайминги видели что на проверку raw нагрузки начинается деградация которые в конечном итоге приводит практически полной деградации сервисов витамин которые там есть они не соответствует тем требую которые к сервиса накладываются мы довольны и начали собирать отчет проходит время подъезжает данные мониторинга но у них смотрим и видим что со стороны сервиса которые мы тестировали данные выглядит вот так вот то есть это деградация который мы видели в ходе теста она совершенно не проявляется на данных мониторинга со стороны тест начали думать что же такое могло произойти real-time monitoring of с на шаге от нас тогда еще не было ну данные собирались начали их поднимать и выяснилось что в ходе теста генератор работали с высокой утилизации циpкa то есть мы дошли до пределов возможности физической машинки который призывает генераторы мы утилизировали циpкa практически по сто процентов и мы по сути получили вот деградацию именно на стороне генератор ты сам сервис и чувствовался хорошо но вот эти вот задержки в ответ и вносил именно генератор почему это происходит давайте рассмотрим из чего советские компонента сайт время ответа здесь как мы видим часть времени тратится на стороне генератора часть времени отправиться на стороне сервисы все это потом складываются и мы получаем по сути вот тот и ресурсным который мы получаем от наших метриках традиционно принято деградация который мы видим во время ответа относить к стороне тестируем сервиса это поняла гипноз генератор дня то обычно это высокопроизводительные все-таки вещь специально заточена для подачи нагрузки и она эффективна и прочее это применимо то есть большинстве случаев типичных тестах действительно this to изменений задержек которые мы наблюдаем она завязана на сервис но это не всегда так и вот в ходе того теста который продал вначале и на предыдущих слайдах микро столкнулись что вот эти вот изменения времени задержки она вносилось именно строим генератор его в том что на отдельных этапов скадовска порывались из высокой утилизации того же циpкa скапливаться в очереди время знаем в которых не конечно и растет с ростом утилизации ресурсов генератор это можно увязать с вот такой известный график под названием хоккейная клюшка он связывает утилизацию и по сути время ожидания в очереди которое происходит при высоких уровнях лет и вот видно что при утилизация больше надо награждай в 70 80 процентов время ожидания растет сильно нелинейные сильно быстро и это вызывает как раз те эффекты которые мы видели высотах теста то есть вот эти вот очереди которые образовывались на планировщики цепова на сетевом интерфейсе на стороне генератора именно они вносили вот тут дельту который мы видели в response time их стране генераторов и такие вещи очень неприятны их нужно уметь отслеживать как их можно оценить нужно наблюдать как за внутренними метрики на генератором синенькая стрелочка но они скорее покажут кит косвенно эффекта то есть мы увидим что там количество инстансов вырастет в это нормально но почему это произошло скорее всего мы не увидим и movie kid косами вещи там старый гарантами прочь и нам нужно спускаться именно на уровне ниже то есть не упираемся мы где-то мы на ресурсы выделены контейнером с генераторами на уровне купюрница или может мы убираем какие-то ресурсы и на самих физической но да такое тоже возможно и вот именно мониторинг утилизации циpкa дисковой подсистемы сети прочего он очень важен не нужно понимать в какие в каких режимах наш генератор должен работать по утилизации этих ресурсов чтобы не вносить вот такие если на то не погрешность котором мы видели в ходе тест так мы разобрались с методическими 100 ментальными погрешностями что какие погрешность еще мы для себя выделяем мы выделим еще один класс погрешности называемых субъективны то те погрешности когда связанные с оценкой получаемых результатов типичный пример который много тебе принять это сравнение среднего и процентили то есть сравнение принятия решения на основе данных по среднему значению время ответов с принятием решений основывающиеся на данных по процентили выглядит он так верхний график это изменения среднего времени ответа в ходе теста тесто ступенчатом ростом нагрузки нижней такой же график но с процентами зеленые желтые красные соответственно с 9 1 цитаты и там 75 процентиля как мы видим если мы будем принимать решения основываясь на верхнем графике мы можем сказать что в принципе вот до вот этого момента где то так вот система вела себя достаточно стабильная и в целом укладывалось его требование которое есть и началась гардер у и только вот в этой части графика но если мы посмотрим на нижний график на вот на них график то мы заметим что высокие проценты ли он сделать один спят и они начали деградировать немножко раньше и вот этого деградация высоких про ценителей она является косвенным признакам того того что наша система подходит к некой ему пределы по утилизации вспомните графики хоккейной клюшки вот чем ближе вы подходите к ее правой части тем больше начинается вариативности время ответа как раз для прядения запросов вырастают количество вырастают высокий процент при появляется часть запросов которого ниц и долго это вот на такие графиках вы является именно появлением таких вот медных части медленно запросов и вот росте больших просителей то есть вот на вот этом нижнем графике вот эта зона она уже для сервиса достаточно неустойчиво то есть чуть чуть и сервис начинает 7 деградировать поэтому в данном конкретном случае гарантировать логичнее все-таки остановиться на более немножко то есть ценный груз который соответствует вот этому диапазону на графике потому что там мы себя намного более стабильно и небольшое изменение нагрузки него не повлечет сильно деградации можем ли мы еще что дополнительно сделать вот допустим сейчас практически все генераторы позволяет собирать данные в представителях об этом типе де провале мыть не нужно мы для себя решили что мы соберем вообще все данные по тестам про все сыры каждый запрос который был отослан моего хранимый потом анализируем уже зависит от того как мы хотим каких разрезах его проанализировать и в частности зовет нам строить вот такие графики то есть это те же сами временно ответа с этим графиком которые были предыдущем слайде но это вот так называемый heat map график который позволяет по каждому в периоды агрегации но сейчас он посекундной им на познали как внутри этой секунды распределялись ответы по времени и видеть какие-то вот полосочки горизонтальные это по сути некие тайм-аут и которые возникали на тех или иных компонентах тестируемой системы вот по этим вот тайма этим пиком можно проанализировав их понять где что сломалось сервисе и быстрее найти им на источник проблем которые входит as the возник то есть собирая больше данных и визуализируя их в разных вариантах мы можем предоставить командам более удобные инструменты для решения их задач в конкретном случае и тем самым снизить субъективную ошибку погрешность который вы за нас и неправильно принятием решений погрешности разобрали что еще мы хотим контролировать производительности масштабируемся наших генераторов мы проводим десятки тестов как параллельных так и последних у нас разные сервисы с разными требованиями разные нагрузки каразин есть сервисы которые не держат ее там сотни gps условно для них держать большой генератор в холостую использовать его ресурсы поэтому мы подходим более гибко к развертка герц мы держим внутри кластера большое количество генераторов разного размера чтобы мы могли более эффективно использовать ресурсы физических наши not ограниченных но при этом соблюдать требования к тестам отдельных сервисы которые есть то есть для тестов которые не требуют больших ресурсов 9 мы просто запускаем более слабый генератор он меньше добавит ресурсов соответственно физических нот и позволять были эффективны и на планировать то как мы и где мы разворачиваем генератора как мы тестируем производительность мы опять же используем наши мишени мы подаем с генераторов ступенчатая нагрузку на мишени и выставляем стабильное время ответа для закрыть нагрузки и но остальным быстрое время ответа потому что когда мы говорим о закрытой нагрузки генератору сложнее работать именно когда си расчищают быстро потому что он вынужден пасовать как можно больше запросов для открытия курске наоборот чем медленно начать сера с тем сложнее генератора при подаче такой ступенчатой нагрузки мы контролируем вот тут дельту менеджер посвятим контролю инструментальную погрешность который вносит генератор в результаты то есть мы зафиксировав то время которое возвращает мишень она стабильна и известно мы контролем в эту дельта между тем времени которое на мишени и тем варенье которые увидели на генераторе и определяем уровне утилизации ресурсов генераторов при которых эта погрешность инструментальное укладываться наши требования сейчас мы остановились где-то на 5 процентов если укладывается пять процентов от времени которые мы выставляем на генератор это это нам допустим а вот но в целом это показывает подход и говорит о том что мы сознательно не до утилизируем используем нами генераторы почему это может провести какой-то эффект потому что мы не сможем в случае необходимости подать какой-то простите нас есть сервис который требует большой нагорский сотни тысяч рпс мы не сможем с одного генератора подать требую нагрузка чтобы у нас не было еще и на портале погрешности поэтому это вынуждает нас к масштабируемым генераторов мы должны уметь продавать нагрузку с множество генераторов казалось что здесь такого подключил генератор подал нагрузку генераторы стоит не шарят в принципе ни на что не должны упираться то есть должен быть линейным пусть я добавил получил вы все понятно но на практике зачастую это не так поясню примером несколько лет назад я работал в компании где мы строили платформы тестирования которая разворачивала генераторы нагрузки в облаках по всему миру в облачных провайдеров на разных континентов разных дата-центрах и прочим и использовали достаточно маленький по ресурсам генераторы подавались них стабильную небольшую нагрузку по моему сложный от 500р ps каждого но мы увеличивали управляли нагрузку просто увеличивая количество генераторов это были сотни многие сотни генераторов которые мы добавляя или убирая которые мы регулировать на груз который довольно сервис в этом и заметили что входит но из тестов мы увеличили увеличили нагрузку по факту она да да сервис оно долетало это начали думать о нас генераторы на разных дата-центрах не использует общих ресурсов в принципе то есть нигде не должны ни на уровне этом сете на чем пересекаться на самом сервисе тоже нагрузка росла и росла и даже начала деградировать к этот момент то есть там тоже затыков нет там все хорошо мы начали неделю выяснили что дело в том что мы насытили канал нашарил система наши real-time аналитики все эти генераторы многие сотни генераторов они часть данных в режиме реального времени отсылали в эта система и мы просто забили и канал и обратным действием она в итоге задавила наших генератор они стали более утилизовать больше ресурсов и в итоге сталин даже нагрузку меньше подавать в итоге мы пришли от по сути так красный кривой которые повторяют не сам закон о масштабируемости вместо линейного роста пунктирного мы получили красном то есть мы сначала добавляем генератор нас вроде все росло потом мы начали затыкаться в канал у нас она стабилизирует потом то тут обратное давление прямо к тому что мы ведь даже деградировали несколько бытовые нагрузки то есть почему хочу сказать что мы стабильность между на верность но ее нужно проверить то есть везде бывает неочевидные вещи которые нужно содержать тот же насколько я знаю время опыта за метром немного но сказано в распределенном режиме он тоже испытывает примерной проводят определён количество генераторов правильных но работа хорошо потом начинаются уже проблемы вызваны тем или иным вещами который нужен высчитывать но именно параллельные запуск ген этого g метров тоже не рекомендуется на к сожалению не скажу почему этого я призы вас контролировать генератору инфраструктуру в которую они развернуты для начала как база это мониторинг если это ваши глаза все вы должны понимать четко что происходит в вашем в структуре чтобы понимать какие погрешности если погрешности какие погрешности присутствует ваших результатов если есть возможности старайтесь тестировать генераторы это постановит вам кучу времени куча итерации проведения теста и последнее не старайтесь сфокусироваться и зацикливаться на конкретных генераторах как правило нет серебряной пули которые шоссе задача диаконов хорошо старайтесь использовать все таки лучшие стороны разных генераторов для одних очень подходит одни других другие старайтесь просто делать от каждого свое большое спасибо за внимание андрей спасибо большое давайте так один два вопроса потому что цикле июлю пожалуйста добрый день спасибо за доклад в в докладе в своем упомянули о том что фантом и создаст на яндекс танк не может вмешиваться в выполнении запроса и анализировать результат но это ведь не так он может можно написать потом узкий скрипт который будет анализировать все делать это ты говоришь про я именно говорил про танк связке с генератора фантом кинер больше говоришь про bfg и кастомную пушку бедой я говорил что использование танк именно связки вот с генератором фантом там такого замучены это не может влезть в то как он работает и спасателями это я мне всю скручивает гермин стройка идет позоре танк по большому счету если так брать это такой некий фреймворк который позволяет использовать разные типы генератор патонг можно подсунуть вот фантом джей метр bfg к основная пушка на питоне и все что угодно если ты напиши к нему адаптер для так вот если мы используем фантом в качестве генератора то ты не можешь анализировать то что прилетает ответы от сервиса и использовать какие-то данные из них в последующих запросов так он написан ему нужно знать все запросы заранее просто их отправляет получит ответ если ты хочешь это делать используй bfg это рабочий вариант но там есть другие нюансы он не очень производительны и там уже в питоновские вещи с режимом и прочим упирается сталкивались учениц велика ли я воспользоваться лайфхак он выступал на 15 минут дольше зато вам название спасибо большое вот такая 1751 давай играть быстро кроме танка радость по танк можно закроем все чего надо люблю любого генератор вы именно танком до для этого пользуйтесь или прямо другие и нибудь фреймворке такие используйте мы смотрим мы сейчас вот как я говорю в начале уходим от танка и будем переходить скорее всего на пандору от ульяновска и решение его можно использовать связке с танком как 11 пока генераторов но мы не будем использовать напрямую вот то есть генератор песчаным нога ну хорошо ложится в нашу экосистему в плане там языков и компонентов поэтому будем на используем напрямую без обвязки виде танка уже бюджету можете мы можем но мы вегета не используем потому что но нам пока хват то есть тех возможностей действие дети нам принципе от танка хватает памятные призы от конференции но само по себе больше надо повесить все гордились всем спасибо"
}