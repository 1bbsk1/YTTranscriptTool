{
  "video_id": "3Beuc28NjYc",
  "channel": "HighLoadChannel",
  "title": "Хождение по граблям PDO / Валерий Горбачев (Delivery Club)",
  "views": 264,
  "duration": 1864,
  "published": "2023-10-06T07:20:00-07:00",
  "text": "Всех приветствую Давайте знакомиться Меня зовут Валера Я работаю по старшим разработчикам Delivery Club Ну на PHP пишу давно и Кроме этого я занимаюсь в своем родном городе организации митапов немножко на них же выступаю и на своих и на чужих и также я занимаюсь пинсорсом вот об этом опыте и поговорим ну конечно же я буду рассказывать только про то что знаю сам у вас может быть абсолютно другое мнение по этому поводу Поэтому если вы нашли ошибку либо считаете по-другому вот QR Котик что со мной связаться поехали вот так примерно выглядит классическая кривая обучения Но на самом деле в моей жизни все проходило конечно же не так Я начал степированных структур которых хранил файлах затем перешел там на dbf и только потом пришел каскуэлю начал читать книжки документацию и мне казалось что работать с базами данных это вообще но максимально Просто я там писал такие вот запросики иногда инвалид Чтобы как-то хоть обезопасить свои запросы и всем Как приходится сохранить строки Я не исключение я вот хранил Вот так и меня однажды взломали так я узнал про уязвимости начал на эту тему гуглить с коллегами посовещался и такой хоп начал делать Вот так просто обычные скипирование в какой-то момент когда мои SQL расширение за депрессии или я начал думать о других решениях Ну и как это вообще было так как бы есть в 2003 году появился затем ПДА появилась затем ребята решили избавиться от лицензионных ограничений оракла и перешли с либо SQL на Майское НД под капотом msql там было с этим несколько конечно изменений интересных и вот все ребята избавились от этого и решили что небезопасного расширения моей Сколь подчеркивание надо избавиться в этот момент я понял что со старым кодом надо будет что-то делать и мне говорят Мы там хотим версию обновить Давайте надо переходить Майской Ай или п.до выберем один из двух стульев Ну я вот сравнил их преимущество мы несомненно но я его выбрал в первую очередь для себя не поэтому я выбрал потому что можно было просто добавить буковку быстро пройтись по коду и всё станет хорошо но про особенность ПВО что всегда Можно перейти на другую с OBD про эту особенность я такой запомнил ну и соответственно я жил в мире розовых пони То бишь фреймворков использовал рынки кори-билдеры делал вот так вот а на старых проектах даже чуть-чуть пробовал с биндингом и вот в этих вот SA и прочим я путался начинаешь биндить параметр хочешь ставить его в серединку запутался и полетели Мне казалось что вообще лекарство от всех проблем код абстрактный читаемый классно сырые запросы писать не надо они все читаются квалифилдеры это классная штука опять же порог хождения гораздо ниже потому что не надо знать SQL Ну и конечно же код не привязан к движку базу данных Я вот тут внизу примеры привёл ну их Конечно же на самом деле больше у рыб есть и недостатки обобщать не будем я буду говорить у меня основной опыт это Е1 Е2 буду говорить про это нет гибкости как при написании сырых запросов работает Быстро Но все-таки это же надстроечка поэтому чуть-чуть на производительность Мы тоже потеряем сложные запросы это вообще отдельная боль Иногда приходится все равно писать rau SQL Ну и сами понимаем это Чужая библиотека ради вас никто не будет ничего менять То есть вы нашли какой-то косяк вам говорят на тейнеры знаете ребят Ну вот у нас так сложилось менять ничего не будем Извините Ну и конечно же самая большая боль э-э фреймворк старенький и My SQL firs подход когда изначально писали чтобы всё с моей школе Работала а поддержку остальных баз данных ну по принципу чтобы было Ну и вообще как бы я задумался Остановился на какое-то время когда доклад писал и понял что мне использовать там фреймворки в рынке на самом деле всю жизнь мешает То есть я на какую работу не прийду все время мешаю Там сначала я пришел начал клипер изучать это давным-давно было затем я как пользователь не так как программист десктоп решение я узнал что решение могут использовать по сети есть блокировки и такой плюс Билдер Парадокс Вот это самое время Ну переход myscoin mysql понятно когда-то нам сказали что ребят смс-скуэлем Не надо ходить напрямую в базу данных для всего есть хранимой процедуры вы типа заскули только их дёргаете Oracle и PHP это тоже отдельная боль Там тоже взаимодействие было через хранимые процедуры и на одной из работ вообще нам говорили будем ходить в базу данных через API забудьте что у вас есть urm Выпишите обращайтесь копии так Используйте запросы в общем Гарри Поттер Орден Феникса А так можно про каждую наверное по докладу рассказать ну и перейдем к сути один прекрасный день я познакомился с Сашей Макаром на конференции поковырялся в Е2 и мой опыт работы с базами данных он поверхностен то есть я там немножко Майское немножко позлился немножко МС а немножко оракла то есть ничего конкретного всего Понемногу где Это может пригодиться конечно же Это может пригодиться при написании пакет по поддержке баз данных ну и я познакомился с юмором с которым мы все это дело сейчас рефакторим и как вы понимаете в основе пакетов isoftb лежит пдо у рынки и пдо схолдерами это вот такая штука когда подстановка данных может стать удобной всё абсолютно просто Это пример прямо из документации именованные плейсхолдеры подставляем параметры выполняем Все красиво и безопасно возможности тоже зашкаливают желтеньким подсветил только то с чем сам работал Но на самом деле конечно в dbc тоже можно было подсветить потому что периодически Мы через двц тоже в базу данных ходили Ну я думаю что мой опыт совпадет с опытом большинства людей вряд ли кто-то с PHP прям совсем в экзотику лезет Ну и тоже момент что в какой там прекрасный день Майской перестала быть стандартом де-факто и все стали говорить не надо использовать пост гриз Это теперь новый стандарт Ну мы же помним у нас пдо оно обещает быстрое переключение и проблем же никаких не будет но как выясняется проблема будут потому что там лимиты по-другому универсальный код SQL тоже не универсален а иногда бывает так что что-то работает неожиданно и поехали Сначала я расскажу про интересности которые мне встретились это как бы мы все используем в основном вот такой режим для выборки там в ассоциативный массив сложили или в объект как бы все простенько а документация подсказывает что есть куча других интересных режимов например получить там в режиме ключ значения то есть Первый параметр запросы будет использоваться как ключ второй как значение или то же самое но можем получать объект или массив а ключ также первое значение Ну из-за уникальностью надо конечно следить во всех этих режимах иначе запросы будут при повторах перезаписываться о результатах группировка по первому значению где-то может пригодиться не знаю там элементарное меню двухуровневое строите Используйте фичнейт можно использовать если у нас допустим одно значение выборки несколько раз вот как здесь в примере Или допустим вы сделали селик звездочки для таблицы за джойнили по леса впали вот благодаря фитчным значение эти не потеряете А так они перезаписываются и вот это вот прямо любимчик lastype можно взять использовать первые результаты запроса как класс который пдо поищет в PHP создаст объект класса на макет туда значение в общем такая абстрактная фабрика Ну и я там про режим ссылочку сделал И вообще задумался в этот момент если мы все так складываем в объект мы знаем что в PHP 8.2 который должен был выйти сегодня поэтому Шутка не удалась выйдет чуть позже php82 обещали что с динамическими свойствами начнутся проблемы до этого мы могли их спокойно добавлять в объект то тут начнутся проблемы как с этим поступят ребята непонятно Ну еще занимательные флаги это допустим Oracle nulls Когда можем там вместо пустой кавычки пустой строки вернуть Ну и вместо Ну ладно пустая строка на самом деле не 40 не только 40 он работает я с по с грисом потестил всё то же самое Классная штука от кейс это когда в ассоциативном массиве у вас ключи могут вернуться в верхнем Нижнем регистре или там э в нативном режиме э новые флажочки добавляются вот 8.1 можно добавить ограничение типа openbasera только для импорта ваших данных чтобы за импортировать всё это дело есть странные флаги допустим атор мультистоитмент это использование многострочных выражений с которыми все борятся а этим флагом якобы можно включить Ну и два флага добавление имени базы данных и мини таблицы к имени Поля это вот как раз Помните я рассказывал чтобы не потерять значение вот тут классно в ассоциативном массиве у вас будет таблица точка имя Поля В общем короче брикен чейндж будет флагов на добавляли Как поддерживать дальше непонятно кейс как-то раз к нам обратился молодой человек создал еще и говорит Мы схему данных перестали получать типа я перешел на версию 8021 моя SQL то есть обычно переход на минорку и все взорвалось Ну в общем до версии 8.021 Мы в каком виде в запросе написали имя Поля в таком его и получаем а начиная с 8021 нам хоп и возвращает в том как оно создано в базе данных ну как вы сами Понимаете в схемах использовался верхний регистр все по фэншую Ну можно было бы конечно использовать но мы подумали что не будем всем ломать жизненную позицию когда мы взяли на уровне инициализации драйвера соединение сделали преобразование регистра кто-то на это же закапливался у себя в коде Мы решили что мы просто Лавр для схем сделаем и все и такое решение уехало Ну и поехали типичная задача для человека который пишет ролевые модели сохраняет их базу данных то есть настройки вот этих вот всех ролей всего прочего мы пытаемся сохранить Джейсон в не предназначенном для этого поля с бинарными данными вы так не делаете Лучше там Используйте специализированные но слов из песни не выкинешь используем как используем Ну и скуль всё абсолютно просто это типа вы запрос подготовили вставили тут же данные прочитали также строчку которую я привёл пример со строкой соответственно для читаемости всё отлично радуемся У нас всё хорошо берём пост нам вернулась уже не строка началась магия Хотя вроде но документация конечно же отвечает на этот вопрос и говорит да В некоторых случаях может быть для бинарных данных вернуться ресурс Ну и конечно же мой любимый Оракул 40 вам у нас не получилось даже вставить данные и конечно же ответ документации есть что нужен иной синтаксис сейчас покажу как это выглядит В общем помните Да запомните как это выглядело до этого только маленькая строка запроса А теперь надо Вот так мы должны это обернуть в транзакцию подвиндить данные и вот это всё А ну и конечно же специфицировать что у нас ломка в вайнере параметр чтобы это всё дело вставить всё делаем в транзакции заколи Ну с чтением то же самое будет конечно же нам вернется ворот ли тоже поток Я думаю надо потестить эти потоки можно ли их туда-сюда помотать несколько раз все отлично ведут как обычные файловый дискрипторы ничего такого все все так же работает Ну и на самом деле данные вы Как вы помните я говорил у меня не совсем бинарные И я такой думаю надо посмотреть как же обойтись без вот этой транзакции и минимизировать все это дело и вот такой вот Костыль с преобразованием данных запросе решает мою проблему То есть я заинтертил данные Ну короче храните Все равно все специализировано но выход есть Ну хотел такую шляпку себе купить как раз для доклада вроде очевидно вещи рассказываю еще одна задача которую мы очень часто решаем нам надо вставить айтишник получить айдишник только что вставленные нами записи опять же пример из официальной документации есть такой метод у него есть ограничения что не все драйвера это поддерживают и действительно msql сервер даже ребята пишут Почему у меня возвращается пустая строка это просто ковер Flow Да действительно ПТО драйвер massusqv поддержка была добавлена чуть позже но сейчас она полноценная с этим все хорошо И все же И как вы помните существовало до этого ишья И вот таким вот образом Ребята в свое время починили То есть просто мы выбираем из двух системных функций или из той или из той получим результаты у них есть особенности конечно же в этих системных функций Что что-то работает в рамках соединения что-то в рамках скоупа и могут быть нюансы Например у вас на базе данных висит Триггер который тоже инсартит в другую базу данных и вы какой-нибудь из этих системных функций получите не тот айдишник который вставили айдишник вставленный в другую табличку Ну и как бы думаю надо проверять уже раз уж все так кто поддерживает кто не поддерживает Ну конечно мои Сколь позже все отлично они не пересекаются то есть создавал два соединения вставлял в них по очереди и проверял теле айдишники Я получаю которые вставлял Ну 40 сразу сказали драйвер ничего не поддерживает Живите как хотите Но если очень хочется я такой думаю вымескуэле есть вот эти системные функции значит ворот ли должны быть Вот там прямое обращение к сиквенсу и тоже они не пересекаются всё хорошо проверим такой же Костыль для msql решил проверить со свежими версиями Все ли хорошо приставки Ну тоже все хорошо но каюсь не проверил конечно на таблицах с триггерами и мне кажется будет беда Беда новым Мы помним что lastonster T1 возвращают но общая рекомендация не Используйте ласты ID есть другие способы там реперник короче для всех есть кроме mysql старых версий для всех остальных любые другие решения смс-куэлем тоже Конечно есть особенность опять же связанная с таблицами с триггерами И вообще вот Тайги такая интересная штука Был случай из жизни когда заказчики попросили Вот вы нам письмо отправляете прикладываете Файлик А можно чтоб там вот не вот это вот была Абракадабра 40 символьная или там 32 символьная луидовская А можно пожалуйста нам Циферки чтобы нам клиенты могли их по телефону адекватно передавать То есть даже люди в ней идти к сожалению уже знают про наши ласты Ну и еще немножечко Советов Я их очень люблю допустим для согласования соединения кодировки в соединении и кодировки в dsn строке можно использовать settnames мы знаем И вот есть myscoreator init команд туда можно вот этот Снейп сунуть и он выполнится при инициализации соединения или там выключить ему лайк при паре подготовку выражения на стороне клиента обязательно выключайте хоть и там мульти стейтмент поддерживать можно но выключайте это вредная штука Потом расскажу почему Ну и конечно же если выключить эту именованные подстановки нельзя будет два раза вставить запрос особенность моя SQL то есть нельзя допустим инсард и написать там ID двоеточие ID запятая двоеточие ID будет ругаться что количество параметров не совпадает и все такое И не ленитесь Если уж бинете данные указываете какой тип это для безопасности очень хорошо промайскую Ленд на него переехали изменился режим работы с буферизированными запросами тоже помните про это сделали большой заброс у вас всё хоп и вернулась сразу же при выборке А вам надо выбирать постепенно выключайте этот режим для больших запросов переполнение памяти хотя бы не будет Ну и конечно же избегайте многострочных запросов Ну то есть через точку запятой не надо делать запросы но тут тоже есть особенности execud сделали при первом фиче вы получите только ошибку если она была в первом эскуэль запросе А если во втором в третьем то надо по перебирать и вот особенности Я тоже указал если не получилось избежать многострочных запросов Вот как раз тот пример с триггерами нам надо вернуть айдишник мы Для этого начинаем играть в такую интересную музыку Мы Выключаем чтобы нам не говорил нам после каждого запроса я сделал а он так будет отвечать там я сделал одну строку там ноль строк изменил и так далее мы Выключаем это всё дело делаем временную таблицу в неё делаем и потом из неё делаем Селект чтобы получить последний вставленный вот перебираем и до первого результативного значения и его мы вернули тоже есть особенности драйверов для поддержки msqf PHP несколько раньше использовали сибэйс старенький ну его слава Богу сейчас Не используют есть официальный драйвер Microsoft есть добыли Баски Вот Free tds которые а-ля dbc драйвер более такой бесплатный Хотя этот бесплатный не знаю но их два и работает Они тоже по-разному вот тот запрос в предыдущий вернет sms-кулевским стандартным драйвером всего один результат А тут он вернет их три То есть только от декларации временной таблицы нам ничего не вернулось И это тоже было не всегда вот там парашю что иногда не так не иногда раньше были ошибки Даже при попытке выборке nextrals это И вообще тоже про особенности Microsoft SQL сервера допустим есть такая такой вот костыли квите там 2100 написано Если вы захотите бачинцерт сделать То есть много много значений наставлять вас будут ограничивать типа больше 2100 не вставить это прям физическое ограничение есть тишью по этому поводу и вот из-за этого продолжают использовать Хотя Microsoft сам не рекомендует говорит Используйте наши продолжим искать неприятности на свою пятую точку обычный Select Что здесь может пойти не так Итак у нас версия 74 80 С тестами все хорошо приходят ребята которые обновляют до версии 8.1 и говорят А у нас тесты легли у нас начали 81 возвращаться типизированные данные то есть инты возвращаться как инты а не как строчки как всегда мы такие репы почесали делать с этим что-то надо это конечно связано с тем что сейчас флаг перестал припарис влиять на только на поведение Ну и для себя сделали простое решение автор стринги фетч чтобы у нас все возвращалось как строки как раньше Костыль по-быстрому для едва мы это все поправили всё стало прекрасно опять все возвращаем в строках но мне стало интересно почему я пошел в код как первоисточник Это же не документация это же кот вот я нашел кусочек кода как было раньше то есть мы получаем все данные с базы данных и потом если значение У нас есть мы его в строчку с отвалом запихиваем все отлично Что стало после рефакторинга Теперь если данный у нас не влазят вын 64 Только тогда мы это преобразовываем строку Вот такая вот легкая оптимизация которая нам немножко поломала жизнь а я нашел этот тури квест Вот Никита Попов это сделал как это нашел виновника успокоился потом опять же мы идем стремительными шагами к типизации это наверное прям та штука которая меня радует Вот я такой включил включил эмуляцию на стороне клиента использую fitchbound это с привязкой переменной указываю что на int но мне вернется строка Вы же помните что строки возвращаются когда эмуляция включена и я пытаюсь передать и получаю Это придуманный пример но я специально его проверил было интересно Ну и теперь перейдем к транзакциям тут тоже советы сегодня мастер давать советы во-первых включая Не выключайте в режим обработки ошибок лучше выключайте чтобы у вас исключение бросалось их мы Хотя перехватить сможем Если у вас есть SQL запрос в котором какой-нибудь дата дефинишный есть то есть там изменения Альтер таблицы и так далее помните транзакция автоматом закатится молочком вот ну не во всех конечно база данных Но вот в этих точно драйвер обещает что будет ошибка Если документация обещает что будет ошибка Если драйвер не поддерживает транзакции или нет активной транзакции с этим тоже будут нюансы Ну и конечно же не поддерживаются вложенные транзакции во все вот во фреймворках Это обычно через Save Point и сделано то есть такая псевдо вложенные транзакции а на самом деле в некоторых база данных их можно использовать и про вот есть активная транзакция или нет версии 8.0 для msq или погреться сделали чтобы все было по-честному как было до этого просто флажок проверка функция есть там флажочек который 01 типа мы выполнили транзакшен все отлично А если мы написали SQL запросом транзишен драйвер об этом раньше не знал Теперь знает потому что мы такие исходили посмотрели серверный статус и убедились транзакции не в транзакции теперь пример когда у нас вся база данных и надиби одна табличка моя сам мы стартуем транзакцию делаем какую-то невероятную фигню и откатываем транзакцию вы это прекрасно ест потому что он же не знает что именно Эта таблица он же проверил для соединения транзакции возможно и поэтому все данные у нас применяться Хотя обещают документации исключения но исключение не будет как было для себя за до Старого драйвера майкрософта Вот раньше вот такой костыли писали бегин транзакшн Ну короче делали rawl SQL и commiter old back и вот с помощью Таких вот чудесных костылей можно для других баз данных которые поддерживают ложные транзакции Если вы когда-то будете с ними работать поддерживать вложенные транзакции Даже несмотря на ограничения по Ой это история наверное видел весь интернет это про то что если у вас немецкое соединение то там есть вот такой вот интересный символ перевернутый там есть кавычка и mysql Real Escape string вам не поможет Ну и вот почему не поможет Это потому что на самом деле мы просто перед апостро вами идем и добавляем как же все-таки вставить неиспользуемые Сколь Реал скейт string прям вравой Сколь запрос если у вас nsql то вот таким вот нехитрым способом у нас 16 значение расшифрует и вставит вот такое вот решение у нас как раз для тех самых ролевых моделей с джейсончиком Вот так все вставляем новая новый Expression и все прекрасно Спасибо моему коллеге он меня научил этой этому хитрому хаку Я надеюсь вы себя так сейчас не чувствуете А я в процессе так себя периодически чувствовал Ну и в целом вот те самые преимущества про которые рассказывал на первых слайдах что кот абстрактный не зависит ни от чего мокрый от слез разработчиков и если вы когда-нибудь решите написать свое то вы будете к этому готовы наверное Ну и благодарности Спасибо Саша макарову который дал мне прикоснуться ко всей этой шляпе вьюмеру который терпит как мы с ним все это делали фактором Спорим и так далее вообще всем кто занимается опенсорсом потому что ну кто-то же должен это делать литература материальчики их тут много самое главное материалов Я всегда какой бы доклад не было всегда говорю ребят читайте документацию мне ответы на все вопросы Ну спасибо супер Спасибо огромное на всякий случай напоминаю что в карточке доклада презентацию уже можно скачать то что видел что ссылок очень много наверняка там куча всего интересного мой доклад еще не скачаете Извините я забыл HTC удалить но я удалю сейчас Я думаю что мы быстро это пофиксим ну как бы быстро посвящена не является ошибочка так возвращаем предыдущий слайд коллеги вот Отлично вот здесь qr-код который тоже очень полезны здесь еще более полезный qr-код можно оценить доклад написать свое мнение и на самом деле это мнение очень важно для формирования следующей программы Ну а теперь мы приходим к самому к вопросам Ну что друзья после нашей речи какие-нибудь вопросы помните уже забыли я вижу руку товарищи хелперы вот там поднимите Еще раз пожалуйста чтобы ваш руку увидели А вот тогда вообще отлично самое страшное для любого спикера секции самое страшное для любого ведущего когда Вопросов нет Спасибо за доклад хотел бы задать такой вопрос Вы рекомендовали отключать атрибут mulate preparis и меня такой вопрос я столкнулся с этим и хотел узнать А почему его нужно отключать Ведь если его отключить то будет следующее когда мы делаем допустим в цикле обработку каких-то строк for each там и выбираем по строке а внутри ПВО вызывает еще другой Запрос к и Он сорвется Почему Потому что драйвер не поддерживает одновременно два запроса и вот этот атрибут трепарес является кастрюлем в кораунта этой ситуации Что он делает он выгребает все данные в память буфер и тогда закрывает этот статуэт и позволяет делать вложенные запросы А вы рекомендуете почему-то его отключать Хотя в тексте много раз внизу была там равно один То есть обратное включали вот эта ситуация непонятная смотрите первое не делайте многострочные запросы Ну это конечно же плохо Просто второе Когда вы Выключите подготовку у вас биндинг уйдет не в два запроса первый запрос строка с Place кодером Ну запрос сам а вторым сами значения и сервер решит какая у него там кодировка как это как эти данные вставляете безопасно и так далее Это просто чуть-чуть более безопасно Я не говорю что плохо Я говорю Короче я говорю что это плохо супер Спасибо огромное Так ну что если у нас еще вопросы в зале напоминаю если вы смотрите онлайн и у вас есть какой-то вопрос Вы можете не стесняться и написать Ваш вопрос в чат нашего зала просит я его обязательно зачитаю Итак если вопросы в зале нет вопросов зале прекрасно у нас ситуация когда или все понятно или ничего не понятно и мне обидно Окей давайте узнаем прямо сейчас я думаю нельзя отпускать спикера если у него есть такой вопрос Скажите пожалуйста а Было ли всё понятно абсолютно все в этом докладе Поднимите руки кому все было понятно достаточно много Окей опускаем А кому не было понятно вообще ничего по-моему Это отличный результат Короче мне надо было все-таки шляпу купить я понял Отлично Так ну что товарищи хелпера остались ли у нас подарки Отлично тогда дарим подарок за лучший и единственный вопрос Спасибо огромное вы нас спасли и Спасибо огромное на самом деле очень интересно классный доклад чувствуется что во-первых классный опыт спикера чувствуется более организаторами тапов я прям как это собраться обратно а всё это видела Вот и куча полезной документации на самом деле тоже очень здорово когда такая домашняя работа для всех проведена а вам остается только приходить по ссылочкам Ну что спасибо большое спасибо так и смотрите у нас сегодня будет еще один доклад в 18:00 минутку я сейчас зачитаю потому что прошу прощения наизусть не помню и у нас Петр Мязин из форварда выступит 18 часов и пока вы все не разошлись я на всякий случай Напоминаю что завтра в 10 утра будет моя секция review резюме на которое на эту секцию Вы можете отправить свое резюме без каких-либо контактов без емейла без телефона вообще без ничего и мы вместе с Тим лидами сделаем разборе и порекомендуем что можно улучшить"
}