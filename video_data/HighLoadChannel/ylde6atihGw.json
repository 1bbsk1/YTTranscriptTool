{
  "video_id": "ylde6atihGw",
  "channel": "HighLoadChannel",
  "title": "Как не положить тысячи серверов /  Дмитрий Самсонов (Одноклассники)",
  "views": 815,
  "duration": 2900,
  "published": "2017-04-22T14:48:26-07:00",
  "text": "всем привет меня зовут дмитрий самсонов я работаю в ведущем системным администратором в проекте одноклассники в проекте одноклассники основные зоны моей компетенции это zabbix всех engine и оптимизация ядра linux сам проект одноклассники много разных цифр но в контексте сегодняшнего доклада в первую очередь важно что у нас больше более 11 тысяч серверов и 150 приложений которые в различной конфигурации составляют 600 различных кластеров несколько слов о чем не будет сегодня рассказано о чем будет значит во первых хочу сказать что я предвзят в этой теме я участвовал во внедрении хен джуна у нас в проекте во вторых я не пользовался самыми последними версиями в продакшене у нас стоит версия 34 поэтому такие вещи как мишин портал дизайн-центр это все не ко мне в третьих сев engine не питаю никаких иллюзий по поводу этой системы конфигурации а не на том месте на каком находится не лидеры рынка не аутсайдер и но значимый игрок скажем так в своем докладе я не буду сравнивать сев engine с другими системами какого-то полноценного сравнения вы здесь не услышите у меня есть лично у меня опыт использования только сев engine а раньше было значит для начала поговорим про классические системы которые вам всем хорошо знакомы с и части пмс и винкс все эти средства они очень хорошие но не подходят для конфигурации управления большим количеством серверов когда у нас в проекте количество серверов стала сколько больше чем там пара десятков то мы сделали свою оболочку над этими утилитами которые в начале имеют буковку d буква д значит дистрибьютор что они умеют делать они умеют делать тоже самое но на большом количестве серверов одновременно и 3 инструмент который был в нашем арсенале это образ операционной системы то есть как выглядела работа с нашим продакшеном если нам нужно было поменять какой-нибудь конфиг операционной системы то мы проходили с помощью dsh по всему production ну после этого изменяли образ операционной системы чтобы новые сервера тоже были с этим конфигом и считали работу выполненной для начала хочу чуть чуть поболее остановиться на utility ssh команд почему потому что изначально она не содержала в себе абсолютно никакой защиты то есть что ей сказали сделать сто она и сделать никаких дополнительных проверок ничего такого не было здесь мы видим с помощью утилиты и секрет мы выбираем список серверов которые входят в эту группу siken это целая команда которая позволяет получить список серверов из нашей семьи by начну получаем список серверов отдаем его на стандарт input ssh команду и просим выполнить на этих серверах команду фас не все очень просто красным выделен один из операторов которые принимают эта команда это минус t 300 несложно догадаться что это тайм аут тайм аут который убивает и команду которая была запущена и любые команды которые были ей порожден и зачем это нужно был такой очень интересный инцидент у нас сервер работал работал потом бац и упала на нем приложения стали расследовать увидели что в этот момент не один из системных администраторов сервером не работал однако оказалось что за некоторое время до этого все-таки была соединение на server administrator запустил команду и ласов запустил ее без каких-либо параметров а без параметров она начинает сканировать абсолютно все файлы соединения все файловые дескрипторы причем приложение которое было запущено использовала равное количество thread'ов в результате одна команда и лоссов сожрала энное количество гигабайт памяти запустился а м киллер и по убивался значит здесь с такой защитой такой такая проблема уже невозможно что происходит дальше дальше появляется так называемый калькулятор калькулятор это вопрос администратору простое математическое выражение почему именно калькулятор ну в большинстве подобных средств обычно спрашивают из но зачастую еще по умолчанию есть разрешают то есть вот так вот на автомате нажимает enter и все равно все падает то есть подтверждение она абсолютно никак не помогает нам не спасает нас от каких-то проблем а здесь у нас есть шанс задуматься еще раз подумать действительно ли мы хотим сделать именно то что мы написали в командной строке причем калькулятор и тот появляется не единожды он появляется следующий раз через 50100 200 то есть каждый раз в два раза увеличивается объем серверов на которых который мы пропустим без подтверждения она не возрастает в этом нет особого никакого смысла важно лишь внимание администратора мы ввели ответ ответ был правильный поэтому команда начинает выполняться но выполняется оно тоже не на всех серверах выполняется оно сначала на одном единственном сервере почему команда которые выдали может быть просто неправильный если это какой-то войну в онлайне рта очень легко то и здесь у нас есть шанс убедиться что все что мы ввели в командную строку это именно то чего мы хотели и out put который мы видим именно тот который мы ожидаем далее команда будет выполняться на одном дата-центре весь продакшн у нас находится в нескольких дата-центров причем каждый дата центра является независимым то есть мы можем потерять тысячи серверов в одном дата-центре пользователи этого не заметят абсолютно никак все продолжит работать ничего не будет тормозить и так далее чтобы использовать эту этот хороший функционал мы выполняем команду сначала на одном дата-центре то есть если там есть какие-то проблемы с этой командой сложится 1d c и пользователи останутся незамеченными тем не менее потерять целый дата-центр в естественно никто не хочет чтобы этого не произошло в дополнение ко всем уже представленным защитам на этом дата-центре команда будет выполняться одновременно максимум на 50 серверах далее будет опять же вопрос пользователю хочет ему продолжить на следующем дата-центре так пока все сервера не выполнены в конце можно посмотреть лог выполнение стандарт стандарт толпу стандарт rolex статус и так далее все это хорошо у нас есть образ у нас есть ssh однако все это не дает нам абсолютно никакой гарантии что наша сервера настроены правильно самый банальный пример сервер в данном в данный момент выключен когда работает администратор на нем меняют сборную память диске или он просто перезагружается миллион причин по которым на сервер могут эти изменения не попасть именно чтобы такого не было были собственное придуманная система конфигурации и в 2012 году мы решили что настал тот момент когда надо все-таки выделить время на то чтобы внедрить какую-то из этих систем выбор был предоставлен нашему гуру алексею чудову человек который запускал самый сложный проект в администратор ские проекты в одноклассниках и были выработаны ряд критериев здесь много разных критериев я не буду их даже пытаться перечислить поскольку в результате мы пришли к трем основным которые нам показались самыми главными и сыграли ключевую роль в решении что же мы выберем первый такой критерий это производительность не буду долго распыляться лучше покажу вам график нагрузки на оси хен джунг которые обслуживают у нас три тысячи серверов это вот я вчера сделал копию график как море свободного процессор на во времени то есть один сервер может спокойно служить десятки тысяч серверов клиентов с памятью все ровно то же самое я могу вам после докладов с графики едем дальше следующие критерии это зрелость про зрелость опять же хочу показать вам следующий график это шкала появления современных средств конфигурации как видите сев engine как минимум на 10 лет старше всех существующих на сегодня систем конфигурации и это даёт некоторую гарантию его функционал и возможности и надежности кстати не знаю все ли из вас знают какова история появления двух следующих наиболее популярных средств пакеты и чифа разработчик папито использовал всех engine но ему не нравился поэтому он сделал popped потом следующий разработчик использовал popped он ему не нравился поэтому он сделал chef вот такая вот краткая история ненависти систем конфигурации последний критерий это популярность давайте прежде чем мы поговорим про популярность проверим насколько популярны различные средства у нас здесь в зале среди присутствующих поднимите пожалуйста руки кто использует анти был популярное средство большинство кто использует alt очень мало chef столько же popped так это второй популярности проект и сев engine это мои коллеги из одноклассников не стоит удивляться до сих engine в россии не распространен совсем то есть в мире есть довольно крупные компании которые им пользу использовали которые вы использовали то же самое на собьем и linkedin какое-то время им пользовался в россии и вы полностью не распространен давайте посмотрим на исторические данные которые позволяют нам посмотреть google google показывает google тренд есть такой проект вы можете перепроверить данные если интересно как видите сифэн джон был невероятно популярен то есть он был лидером рынка тогда когда еще системах не забраться как таковые были не очень-то распространены тем не менее его популярность падает но в 2012 году когда мы делали свой выбор он был неоспоримым лидером и так мы выбрались я хен джун мы выбрали съев engine поскольку он отвечал в наилучшим образом всем нашим требованиям многие демонизируется хен джун те кто сталкивался с тем как он работает какие у него есть возможность какая у него логика как как у него организованный язык все это довольно специфично тем не менее можно его привести в такое состояние когда он будет достаточно простым в использовании и я собираюсь вам это доказать здесь политика настройки типичного нашего приложения в продакшене название политики об опеке feed она применяется на две группы серверов fits прокси и fits кэш и в самой политики есть название приложения и запускается метод а по пауки как видите даже не знаю синтаксиса серфинг она вам здесь все понятно перейдем к следующему слою следующем уровне абстракции непосредственно политика метод а п п ok в методе а папа ok мы берем название приложения копируем какие-то конфиге выставляем необходимые пермь из перми шины и переходим к следующему уровню абстракции здесь опять же в синтаксиса никто из вас не знает но я думаю что всем понятно что здесь происходит мы вызываем следующий метод files and files мы начнем показывать не буду почему он не буду показывать потому что этот метод со всеми теми внутренностями которые в нем использовать занимает порядка шести 100 строк и на экран бы это никоим образом не влезло но здесь важно понимать что создавая вот эти уровни абстракции все можно сделать достаточно простым всех engine это позволяет еще несколько совсем коротких примеров установка пакетов запуск сервисов кранов далее то есть какие-то стандартные вещи которые делаются быстро и понятно на этом слайде видно распределение по типам наших политик общее количество их порядка полутора тысяч самая большая из них занимает 27 килобайт политика это как ни странно политика настройка настройки забег сервера там описано абсолютно все аспекты то есть можно взять голый сервер запустить политику будет настроено база данных frontend пропатчен frontend где надо все что только возможно еще несколько примеров каких-то специфических вещей которые зачастую системы конфигурации не настраивают у нас это все автоматизировано все road и на всех серверах настройки райт к шее и пима сел в прошлом году у меня был доклад про сетевые примочки всякие если кто видел это все тоже автоматизированное делается cefine джином то есть достаточно сказать какой режим вы хотите на каком сервере все остальное от вас уже не зависит тем не менее асеев н же нам не нравится не нравится нам по некоторым причинам в первую очередь это высокий порог вхождения самая большая более это конечно для новых сотрудников и для тех кто их обучает объяснить всю эту внутреннюю логику конечно есть эти высокие уровни абстракции тем не менее системного администратора который хочет с этим работать важно понимать как оно происходит в самой своей глубине следующая проблема он сильно стоит конкурентов я не питаю никаких иллюзий знаю возможности современных систем или сев engine от них достаточно далек у всех angel нет то никакой системы плагинов сам он написан на си другие системы популярны в основном имеют различные плагины которые пишутся на более простых языках на python и все function таких нет и последняя причина это плохие шаблоны они слабые по своим возможностям каких-то специфических вещей в них сделать нельзя приходится делать просто несколько файлов разных чем примечательна 4 апреля кто знает день системный администратор oniton последняя пятница июля если не ошибаюсь день вы прозрач и когда совершенно верно но это не единственная причина чем популярно 4 апреля как многие из вас наверное знают 4 апреля 2012 2013 года проект одноклассники стал недоступен для всех пользователей длилось это трое суток трое суток мы пытались починить проблема была достаточно сложная то есть все сервера стали недоступны для пользователей стали недоступны для системных администраторов и reboot не помогал то есть это действительно было ну такой случай наверно войдет в мировую историю down time of не побоюсь этого слова можно ли этого было избежать у нас были естественно некоторые средства защиты проверка синтаксиса тестовое окружения review мониторинг как будто боя какой-то минимальный набор защитных мер присутствует тем не менее дьявол кроется в мелочах и то же самое review допустим он хоть и существовал но был необязательным если говорить про конкретно тот commit который все собственно сломал здесь был review его посмотрели как минимум двое администраторов тем не менее это не спасло почему потому что в комете была добавлена в конфиг несколько символов и в общем-то ничего абсолютно криминального не было было трагическое стечение обстоятельств bug1 система наложился на в другой системы и все закончилось когда энное количество тысяч серверов перестает работать за одного единственного приложения то естественно первым шагом было его остановка на всех серверах сейф engine был остановлен и нам пришлось сесть и очень сильно подумать о том как же мы будем существовать дальше будут системный администратор использовать какую-то систему конфигурации и если будут то как в первую очередь хочется отметить что мы сев engine оставили более того до сих пор sea of engine запускается раз в пять минут на каждом сервере и я объясню почему почему это важно потому что система конфигурации в первую очередь дают вам не только какое-то удобства они дают вам гарантию гарантию того что сервер сконфигурирован именно так как вы этого хотите вот я сейчас могу сказать что сто процентов наших серверов сконфигурирована именно так как мы этого хотим те конфиге которые мы хотим те настройки все абсолютно точно мне даже не нужно об этом беспокоиться ходить проверять это за этом за меня это делает civ engine или любая другая система конфигурации давайте же поговорим о том какие мы меры предприняли чтобы подобная ситуация не повторилась первый уровень защиты это гид в детей есть хуки мы использовали этих у тебя все исходники серфинге на политика не у нас находится в гите значит в гите у нас проверяется fuck off что проверка синтаксиса совсем простая вещь автокоррекция стиля все что можно было там автоматически какие-то там отступы пустые строки все что угодно это делается автоматом далее автозаполнение проверка коммент мы освещаться не совсем относится к какой-то безопасности тем не менее в случае каких то проблем легко по номеру тоска найти все комменты которые к нему относятся следующий шаг защиты это проверка в тестовом окружении тестовое окружении он состоит из не каких частей первая часть это once ты был это виртуальные машины которые любой желающий может использовать может их ломать любым доступным ему способом нам их абсолютно не жалко и обновляются не раз в пять минут то есть за пять минут может все сложиться следующий уровень testing физические сервера это их главное отличие то что они физически дело в том что некоторые политики на физических серверах выполняются по другому кроме того в отличие от виртуалок эти физические сервера есть у нас совсем значит соответственно там тоже по-другому могут политики применяться поэтому есть такое вот разделение тем не менее этот слой тоже может полностью терять он раз пять минут обновляется и какая-то ошибка может привести к их полной недоступности но поскольку это тест то никому не жалко дальше следующая защита это так называемый стимул что такое степу в первую очередь надо отметить что с treble это уже реальные продакшен сервера базы данных фронтэнда и так далее на которых сидят реальные пользователи от каждого нового кластера который мы устанавливаем в продакшен если он отказу устойчив по своей сути мы берем один сервер таким образом если мы теряем стебль то пользователи этого не замечают кроме того мы стараемся использовать там все варианты железо именно вот за счет того что собираем с каждого кластера по одному серверу там есть абсолютно все виды железо write контроллеры какие-то виды приложений различные конфигурации этих приложений все что только возможно у нас production она есть в этом стебли такая вот сборная солянка благодаря этой вот схеме как мы собираем собственности был его можно тоже терять пользователи это не замечают это происходит абсолютно прозрачно и stay было опять же могут комитет все системные администраторы они могут его тоже поломать но здесь уже не за 5 минут 1 час все-таки это продакшен нет никто не хочет лишний раз сочинить сервера поэтому мы плавно размазываем обновление этих серверов в течение часа следующий шаг нет ни следующий значит для серверов и соматически контролируется нагрузка что это значит естественно у нас есть мониторинг но конкретно для этих серверов мы дополнительно следим чтобы у них не было ни появилась как каких-то аномалий как мы это делаем то есть мы не просто следим за нагрузкой на этих серверах мы в обязательном порядке держим политики на этих серверах как минимум 2 часа может быть банальная утечка памяти если мы такое сразу отдадим в продакшен то последствия могут быть самые плохие для серьезных изменений это даже не два числа а как минимум сутки следующий шаг перед тем как мы перейдем к непосредственно к production но это ревью review никому из вас не надо объяснять что это такое мы проверяем какие-то стандартные вещи последние версии методов и так далее тут все все как будто бы всем понятно тем не менее это не все что мы проверяем перед тем как политики пойдут в продакшен review и обязательно должен убедиться что эти политики на всех предыдущих окружениях не вызывают никаких ошибок там нет каких-то аномалий с нагрузкой и прошло определенное количество времени то есть как минимум эти два часа выдержан только после этого reviewer может взять этот коммент и отправить его в продакшн еще пара слов про review значит естественно бывают такие ситуации когда нужно все ускорить есть какие то проблемы которые нужно решить быстро можно обойти эти системы тем не менее там тоже есть некоторая защита то есть если у вас там допустим не знаю на 5 серверах нужно быстро провести какой-то commit то вы можете зайти на пять серверов и руками их обновить это возможно на все сервера вы уже так делать не буду есть специальные инструменты которые позволяют обновить на большом количестве тем не менее там тоже есть определенные защиты об этом я еще чуть позже скажу и наконец кто собственно делает review на сегодняшний день у нас действуют двухуровневый review почему это так дело в том что часть системных администраторов работают f и g нам давно имеют большой опыт часть работают недавно и сначала у нас review занимались только старший системный администратор и у которых больше опыта сейчас мы сделали схема таким образом что за review ведь может любой админ это значительно ускоряет работу вам не нужно ждать этих несколько человек можно пойти к своему соседу про review with а вот второй уровень он уже пойдет к старшему системному администратору так называемый пост review последний уровень защиты это защита который у нас есть при распространении этих политик по продакшена это так называемый дартс на этой картинке мы видим часы видим повторяющиеся буквы буквы это аббревиатура наших датацентров то есть вот есть data center data line на букву д он обновляется 3 раза в день с 9 до 10 сейчас у до двух и с 5 до 6 как я уже говорил у нас дата центра являются независимыми и используя такую схему мы можем у нас есть время на то чтобы записать какие-то проблемы то есть если политики обновляются под это центру и дата-центр начинает складываться то мы это вовремя заметил остальные дата-центра останутся незатронутыми но и опять же если мы не успели заметить за целый час у нас есть еще как минимум 4 часа пока есть продакшен сложится это много времени если мы говорим что зелененький там дата line начинает обновляться в 9 утра это не значит что сто процентов до талайна пришли сразу выключили новую политики все размазано по времени то есть по-прежнему мы не хотим потерять целый дата-центр в там одномоментно обновляться с политики все равно будет какое-то ограниченное количество серверов каждый знает свое время это стандартный функционал cf ng раз play класс и он позволяет размазать все плавно в течение часа то есть руками ничего делать не надо это все автоматизировано и дополнительная защита чтобы системные администраторы хорошо спали по ночам политики обновляются только с 8 утра до 8 вечера никто не хочет сюрпризов да и рабочего времени вполне достаточно для всех работ это 5 уровней защиты когда политики готовятся и отправляются в рот но мы решили что этого недостаточно все равно все может сломаться и мы решили сделать еще дополнительные уровни это уже не совсем защиты как нам в общем-то действовать если плохая политика все-таки прорвалась в продакшен что делать значит нас есть план б план б это еще один отдельный абсолютно git репозиторий в котором тоже есть политики но политики эти очень простые и их очень мало и мы туда очень редко вносим изменения то есть если у нас все сломалось aussi fingers встроенный функционал переключения на альтернативный набор политик и это нам дает в первую очередь возможность сохранить работоспособность самого сев engine а как нашего основного инструмента то есть когда он переключится уже на этот ограниченный набор политик мы можем его использовать для починки чего-то более серьезного этого все равно мало все равно все может сложиться поэтому нас в качестве самого последнего рубежа мы написали небольшой скриптик которые позволят нам очень быстро там защиты на этом секунды десяток десятки секунд остановить ее хен джуна всем продакшене ну стоит отметить что с 2013 годом и этим инструментом ни разу не пользовались утилита которой я упоминал которая позволяет обновить большое количество серверов в ускоренном режиме если это требуется она ну казалось бы тоже там может все поломать поэтому мы решили туда тоже встроить некоторую защиту мы не просто обновляем сервера с помощью этой утилиты мы проверяем что они опять же выполняются без ошибок и проверяем это как минимум два раза то есть обновили сервера запустили политики проверим что все в порядке потом еще раз запустили политики и еще раз проверят что все в порядке то есть если между двумя запусками сервер стал недоступен будет ошибка выполнения скрипта становится и выполняется эта команда независимо от того сколько серверов вы дадите на исполнение она будет выполняться на ограниченном количестве серверов и каждый раз это пачка будет увеличивать то есть опять же те же самые 50 сто-двести 400 и так далее подведём некоторые итоги значит тестирование это всем очевидная вещь тем не менее важно делать ее правильно все-таки системное администрирование от программирования имеет некоторые отличия и задача отличаются поэтому и сами эти инструменты хотя нестандартные они должны учитывать специфику значит тестирование политик нужно быть на разных серверах оно должно длиться какое-то время нельзя проверить что политики запустились и сразу же разложить production review ну с review все понятно он должен быть он должен быть обязательный когда политики отправляются в продакшн это не должно быть нет но происходить с копом то есть должны быть какие-то отдельные части независимые друг от друга и их обновления должно быть постепенным и какие бы защиты вы не сделали у вас всегда должен быть план на случай аварии а лучше два еще план на случай если первый план не подошел спасибо за внимание я рад ответить на ваши вопросы не слышно мы вручную колбасин шестьсот строк но надо понимать что мы у нас есть библиотека то есть показывал слайд что несколько сотен различных политика служат нам библиотекой то есть если мы там хотим поставить какое-то приложение мы не будем каждый раз писать что скопирую там этот этот этот конфиг мы этом как я показывал там говорим просто название приложения все остальное все что под ковром она автоматически то есть эти шестьсот строк это шестьсот строк не перри используемых именно уникальных для этой политики можно вопрос здесь можно спасибо за доклад скажите пожалуйста а и вот если возникла какая-то ошибка да вот она раз катилась допустим на весь do the line ее нужно теперь выбрать ну поменять конфиг что вы делаете ждете следующую аскетом через 4 часа пока она по всему dateline раз катится или как-то иначе ну то есть вот это вот отработать как теперь это зависит от того насколько серьезная проблема то есть если нам нужно починить ее здесь и сейчас то это может дойти вплоть до того что администратор пойдет руками поправит это на сервер и у нас есть механизм там отключения частичного отключения себе фоне джона то есть если мы хотим какой-то конфиг срочно исправить то можно его временно это опять же все автоматически происходит то есть мы говорим вот мы хотим поправить этот файл и изменяемого через трое суток он автоматически будет откачивать ее финиш ну то есть у нас есть возможность поправить если на большом количестве серверов тогда ну там тоже можно действовать по-разному и зависимости от того насколько серьезная проблема в принципе мы стараемся не делать нечего в ручном режиме если проблема ждет если она не эффекты пользователей тогда мы будем действовать по стандартной процедуре то есть это к нет потом стрельбу потом review и потом она в течение четырех часов будет ползти но вот m может уточнил вот действительно эффекте пользователей вот причем это не такая что там не работает сервис работает ошибочно то есть нельзя это игнорировать и вот анавара скатилась допустим на половине уже серверов давай то есть что экстренно есть некий план там c какой-то да как вы это все назад от коты-воители что делаете разумеется мы обкатываем откатывается она тут схему построены следующим образом то есть если мы делаем commit в git и сейчас вот эти там этот do the line допустим наполовину обновился а половина серверов еще будет выкачивать сразу же по 100 как мы исправили это в git репозитория вторая половина получить правильный конфиг поскольку они еще его не выключили остальную половину соответственно там уже много вариантов можно там в крайнем случае хоть сев engine остановить и руками поправить внутри четкого плана на пока пока country спасибо спасибо основной план такой что если можно ждать тогда по стандартной процедуре мы максимально стараемся следовать этой вот стандартной схеме а именно для того чтобы в попыхах не поломать что-нибудь еще спасибо закат это скорее дополнение к вопрос от предыдущего оратора почему стоп они аборт то есть почему нет автоматического отката изменений то есть произошли произошел выкладка конфигов что-то началось и лица почему конфиге не возвращаются на предыдущую рабочую версию потому что все фонды не нет такого понятия как транзакция нет такого понятия как какой-то то есть естественно там можно бэкапить конфиги и мы это делаем тем не менее мы не можем знать весь объем проделанных работ который привел к этой проблеме может быть это был конфиг может быть это обновление пакета может быть это рестарт сервиса может быть это какое-то там сочетание действий и для того чтобы их откатить нужно знать что конкретно было сделано это можно посмотреть палубу но это не автоматическая операция спасибо спасибо за доклад выглядит что у вас достаточно длительная процедура деплоя как вам удалось снизить частоту комета в частоту deep love может быть вы как-то объединяете их в один так и как конкурентность у вас реализовано то есть допустим в процессе там раскатки в прато может даже возникнуть необходимость следующих же выкатить я понял ваш вопрос всех engine у нас не используется для тепло и приложений вообще мы его используем скорее для подготовки к процессу диплом для дупло у нас отдельная система на самописная и не как друг другу не мешает то есть мы раскатываем сервер всех engine доводят его до состояния готовности раз раскатываем и не какой-то образ а просто инсталляции операционной системы автоматической опять же серфинге настраивает и после этого другая система уже можно спокойно устанавливать приложение запускать его и так далее . конфиги вы не так часто меняете тут важно понимать закон каких конфигах идет речь если мы говорим о конфигурации работы приложений то есть именно как приложение ведет себя относительно других приложений и пользователей то для этого используется еще одна система которая позволяет это делать с некоторым другим функционалом то есть там там огромное количество различных фич которые запилены конкретно для для этого процесса здесь раскладываются именно конфиге которые нужны для того чтобы за деплоить приложение чтобы его можно было запустить то есть там параметры для джавы какие то такие вещи которые нельзя уже сделать из самого приложения просил страсти мне маленький вопросик я просил внимание что у вас есть стоп-кран котором вы три года не пользовались он не заржавел за три года все проверяете не заржавел проверяем то есть у вас есть как процедур тестирование когда вы регулярно что-то там у вас что-то падает и вы это понимаете у нас есть план действий при аварии которую мы регулярно проверяем и мы стараемся во время этого тестирования различные сценарии придумывать в рамках которых нам придется делать такие вещи которые мы не делали может быть там пять лет или даже больше то есть придумаем какую-то такую вещь который у нас вообще никогда не было каких-то таких специфических аварий и пытаемся решить эту проблему вот на лету потом соответственно делаем выводы в общем-то результате этих тестов у нас много было изменение в том числе и в этих инструментах там вот еще до вижу скажись то есть я правильно понимаю что у вас всех и джон работает в по модели на каждом сервере вас есть какой-то демон какой-то но сев легенд который по крону запускаются ну примерно тогда не по крону там есть демон который запущен постоянно и он сам в по какому-то расписание может запускать агенты которые же выполняют политики это схема с массив антенн там нельзя ее поменять то есть полу модель она вшита в саму конфигурацию я не понимаю как вы делаете как в этом случае можно раскрутить очень мы очень плавно ну какой то не знаю я не зная работаю с по пятам я запилил какую-нибудь пакет в пакете вот у меня это значит что если я работала по модели знает что у меня на весь мой проект раз катится новый пакет ну как-то консистентной за какое-то время там ну либо скрыты задержкой сена если вы как то более менее одновременно как вам удается вот вашем случае вот вы просто был рассказывали там аналог station привыкаешь и zing как случае с по моделью удается раскатывать так как вам нужно я объясню значит я показывал вот так называемой дартс и часики эти часики естественно у нас не существует они существуют в виде кода в виде кодов то есть виде политики на каждом клиенте то есть клиент знает когда он должен обновлять политики у него есть расписание дата-центров он знает в какой то это центр он относится и дополнительно этот спрей класс который позволяет именно размазать это на промежуток времени есть такой функционал стандартный всех engine называется плей квас с плей класс он defined классы в снг не это не совсем классы в традиционном понимании то есть это какой-то маркер который может заде фаниться один раз в час соответственно сев engine то есть этот агент и когда запускается он либо дефо нет этот класс либо не дефо нет как только он задыхался раз в час он начинает обновляться таким образом но ну и там используется хэш-функция для того чтобы сервера были размазана в течение часа это стандартный функционал именно самосев engine сейчас вы говорили что я не знаю эфиром но у вас есть несколько инвайтов то есть поддерживает январе чтобы применяли вот эти все вещи нет на тесте как вы делаете как мы это делаем но на данный момент у нас это делается отдельными папками то есть из одной папки выкачивают одни сервера из-за другой папке выкачивают другие сервера но с таким же успехом нет полностью 1 этажа инфраструктура просто но здесь используется на самом деле примерно тот же механизм который для обновления используется сервера знает в каком он дата-центре кроме этого он знает в каком он varmints поэтому он знает из какой папки ему нужно взять эти политики у меня вот такой вопрос есть со временем какое бы количество политику вас там не было до их применение но все-таки вызывает на финальной стадии некоторые изменения тут кто-то может быть туда руками зашел уже и так далее через какой-то определенный промежуток времени у вас сервера про которую вы думаете что они у вас идеально так сказать идентичны на самом деле это не так вот как вы решаете проблему configuration дрифт вот в этом случае на самом деле это так почему такой не была у вас смеются была инфраструктура я объясню почему в принципе да то есть если поставить себе целью поломать политики на каком сервере чтобы этого никто не знал потратить на это какое-то время ну наверно можно там вплоть до не знаю починка ядра было бы как говорится цель у нас диверсантов частью не то вы в команде поэтому что происходит если мы изменим политики на сервере то при следующем запуске агента он проверить соответствие всех политик того какие они должны быть то есть верит их с хабом если есть отличие он их откатит если это допустим не знаю там ему то был флаг поставлен на файлы файл изменен тогда агент закончится с ошибкой у нас это выскочит системе мониторинга если пользователь изменил какой-то файл тогда серфинг следующие следующем запуске сравнить его с той копией которая у него есть что она соответствует потому что нужно если есть отличие он его откатит если администратора изменил файлы поставил маркер что он этот файл изменил какие-то временные изменения пройдет трое суток маркер будет удален файл будет откачан то есть ну то есть вы рассказывайте по сути что вы пытаетесь вот политиками покрыть все возможные кейс его творя вариативности частично политиками частично это функционал самого сев engine то есть он работает и но если мы там меняем файл то при каждом своем запуске все конфиги которые он должен контролировать он их проверяет спасибо конечно ну невозможно проверить то о чем система ничего не знает но не все конечно но все ключевые компоненты то есть что мы автоматизируем мы автоматизируем те вещи которые мы на серверах меняем если не знаю там пользователь настроит какой-нибудь принтер в дата-центре на сервере ну тут мы ничего сделать не можем писать политику на все возможные пакеты какие только есть в репозитории там тысячи пакетов и по тысяче конфигов это невозможно если какое-то приложение использует папку с конфетами то мы будем контролировать всю папку целиком да именно для этого мы его и используем еще вопросы оператора ходите толпой сколько времени требуется на поддержание вот этого всего кода finder на при обновлении по или там операционной системы и так далее то есть у меня больше времени уходит именно на поддержание вот этого чему же просто на решение задачи скажем так ну под поддержкой вы наверное подразумевается изменения с другой операционной системы там уже что давайте я тогда в двух словах расскажу как мы обновляем операционную систему ну наверно никакого сюрприза не будет мы берем какое-то количество серверов ну для начала один обновляем там пакет и смотрим что изменилось и поскольку сейф engine все конфиги контролируют если что-то изменилось он это сразу откатит мы можем посмотреть что он откатил какие были изменения если надо мы их добавим если нет то оставим тоже зафиксированы не везде то есть если это если нам важно на какой то версии пакета остаться то она жёстко прописано я бы не сказал не знаю я не могу сказать что обновление операционки то какая большая боль процесс конечно занимает какое то время но больших проблем в этом нет мы используем centos если интересно и на серверах в принципе пакетов устанавливается минимальное количество сам проект написано джами для java нужно java и это все еще вопросы ну тогда спасибо большое за вопросы и спасибо что пришли"
}