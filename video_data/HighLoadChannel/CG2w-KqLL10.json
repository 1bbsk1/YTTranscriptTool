{
  "video_id": "CG2w-KqLL10",
  "channel": "HighLoadChannel",
  "title": "Хранение графов в Tarantool: реальность или миф? / Александр Горякин",
  "views": 861,
  "duration": 1603,
  "published": "2022-03-21T13:13:02-07:00",
  "text": "всем привет следует начать с того да что я работаю в отделе в транс и которая занимается разработке тем для внешних заказчиков и очень часто мы сталкиваемся весьма нетривиальными задачами то есть одна из таких задач в это хранения графа к нам пришел заказчик это один из крупнейших банков и предложил сделать систему они фродо система которая предотвращает мошеннически операции вот на основе этой системы и соответственно построен мой текущий доклад вот начнем с постановки задач и да у банка есть довольно-таки большое количество клиентов которые каждый день каждую неделю каждый месяц каждый год проводят транзакцию то есть они переводят средства с одного счета на другой будь то оплата в магазине может быть там перебор кому-то до родственникам там рабочим неважно вот мы считаем что этой системе да то есть каждый клиент банка мы можем считать его вершиной в график и соответственно любая транзакция который провел пользователь да это ребро грамма вот как выглядит эта ребром да это вид записи будет такой то есть счет 1 это исходный счет с которого мы переводим средств еще два целевой счет сумма которая была переведена корпус и квартал для возможности идентификации записи изначально заказчик предоставил нам данные которая содержит где-то граф за один год то есть это список всех транзакциях загар однако они хотят хранить данные за пять лет как можно понять это очень большой и колоссальный объём данных да то есть у нас количество записей в этом графе примерно 5 миллиардов то есть пять миллиардов записи это там где то 10 миллионов вершин по объему и занимает 2 терабайта то есть в оперативной памяти удержать такой объем очень сложно и на самом деле проводить какие-то операции поиск таком объёме данных это тоже довольно тяжело вот цель этой системы соответственно сказать клиентов который проводит мошеннические операции вот нашей целью было построить систему которая во первых можно сохранить robo графа во вторых она может делать запросы как по индексу так и запросы графова поиска вот одна из основных сложностей которыми столкнулись это соответственно да какие запросы у нас есть у нас есть 3 вида запросов которые хочет сделать клиент это соответственно связи первого порядка они представлены так они представлены зеленым связи второго порядка да это желтая и и связи 3 порядком это красный поговорим более подробно о каждом из этих видов связи связи первого порядка это по сути непосредственно транзакция то есть вот вы взяли перевели кому-то деньги да это довольно таки самый простой вид связи здесь мы можем использовать по сути в поиск по индексу то есть нам известно исходный счет нам известен целевой счет и время когда была проведена операция год квартал сумму нам неважно связи второго порядка да это чуть более сложный вид связи когда транзакций участвует один последний например вы хотите там перевести деньги в рабочему да но контактов рабочим у вас нет то есть вы переводите кому-то кто знает контакт этого рабочим например ваш родственник а он переводит этому рабочим и сам здесь в этом виде связи там применяется графу поиск он довольно таки простой a word поиск связи третьего порядка самым сложным алгоритме то есть это по сути поиск в графе пути длиной 3 когда могут проводить такие операции например мошенник хотят вывести деньги со своим чего-то черта на свой счет проводят они этот через промежуточные счета но при этом им нужно использовать как можно меньше формируем часов так как тогда за каждый перевод берется комиссия какая особенно если сумма большая вот здесь уже применяется полноценно алгоритм графова поиска и соответственно операции да то есть с чем с какими сложностями вы столкнулись реализации данной системы основными сложностями это были требования заказчика то есть мы должны были уложить соответственно во время выполнения запросов нагрузку которая должна выдерживать система и во время во время загрузки данных то есть нас загрузка данных полная холодная загрузка должна выполняться где-то за 7 часов система должна выдерживать случай поезд связи 1 и поиск связи второго порядка нагрузку где-то 43 тысячи транзакций в секунду то есть это именно транзакции по переводу то есть это не операция внутренние до которая делает производятся в самой системе это именно вот перевел человек транзак сделал человек транзакций вот эти бизнес транзакции и в случае графова поиска мы должны были уложиться в своей где-то 10 запросов в секунду исходя из этого на самом деле возникает вопрос а есть вообще какие готовые решения да почему бы не воспользоваться этими решения да такие решения есть это графова и базы данных например иран греби титанов у джей также есть различные системы обработки графов например прегель и если используйте trample есть на самом деле его реализацию нового вот и также можно использовать для хранения графов реляционные файловой базы дома атаку всех этих решений есть свои недостатки так например графова и базы данных в нашем проекте мы не могли использовать так необходимо было импортозамещение то есть у того же ранга дебенов аджилити то но у них нет русскоязычной поддержки и нам нужно было использовать еще средства разработанной в россии также у этих баз данных не все они могут хранить например ребра как требуется нам до нее хранят вершины не все базы данных ранят мета информацию которая необходима для поиска по индексу более того у каждой из графах баз данных есть собственный язык запросов так например ранга детей цель у него fuji это сайфера у титана это гремлин каждый язык запросу да они накладываются собственно свои ограничения точно реализацию алгоритмов графова поиск вот что касается также ищут титан они все в основном титаны он не использует например свое хранилище с него нет своего хранилищем качестве хранилищ использовать либо кассандру либо ходу то есть по сути файловую базу данных почему мы не использовали бреге изначально прибыль не может выполнить запрос по индексам и так же в нашем случае если бы мы использовали ложь на реализацию которая специфична и между таранку то она упирается в ограничения виртуальную машину в то есть за она будет очень медленным по поводу использования реляционных файлов баз данных тут тоже можно сказать что он во-первых эти базы данных они будут работать очень медленно потому что данные хранятся на диске тарантул хранит данные memory в оперативной памяти во вторых запросы на графа вы поиска они очень сложные то есть вот на слайде представлен пример esquire и запроса на поиск связи второго порядка здесь 24 join a и по моему 21 условий фильтрации то есть запрос очень сложной до его как написать сложно его сложно читать и по сути он еле еле помещается на floyd теперь давайте поговорим о том почему мы взяли именно тарантул до для реализации такой системы одно из основных преимуществ да почему мы взяли мы умеем работать с тарантул мы знаем как его приготовить как посчитать необходимое количество инстансов как его сконфигурировать правит кроме того что ран про очень хорошо работает поиск по индексу то есть он может работать и по первичным и вторичным индексом это будет очень быстро кроме того тарантул позволяет реализовать случае когда вам критично производительность вы можете реализовать модули на компилируем языке например на языке си так изначально тарантул написан на си с использованием виртуальные машины вата модули можно импортеру и соответственно реализована и закись его можете реализовать сколь угодно сложные алгоритм графова поиска что касается данных тоже можно отнести к преимуществам мы изучили данные который нам прислал заказчик и изначально это был один большой грамм но мы смогли разбить его на много маленьких что позволило нам оптимально что радировать данные и распараллелить обработка приз распараллелить поиск это также возможно благодаря тому что тарантул позволяет сортировать данные под конкретные данные под конкретные задачи про конкретные нагрузки исходя из этого следующий следующий пункт что мы можем использовать более эффективную репликацию а которого мы поговорим немного позже почему мы отказались от использования файлов баз данных изначально у заказчика все данные хранились группе и для выполнения при выполнении запросов поиска они делали это через х и соответственно очень много времени уходило на очень много времени и ресурсов отдел она похожа по сети вот тарантул да он как бы этих прям этого лишь он по сути и что еще ходу даты и заказчика выгружал данные из х руб а вот кто-то там выгрузить данный можешь на внести форматах это там сисви арк нам приходили в данной формате а вы кружка данных занимает тоже где-то 7 часов тарантулов по дефолту работе с данным форматом не умеет поэтому нам пришлось написать импортер на языке год который построен уже на основе существующей библиотеки так как там данные были очень большие соответственно выбирали необходимые нам поля ими насчет один еще два года квартал и сумму и импортировали данные здесь также стоит отметить что так как данный пришли нам за год а заказчик хотел данные за пять лет про в процессе загрузки нам приходилось эти данные мультиплексирование размножать соответственно с условием того что мы мультиплексирование данные с условием того что мы условием репликации то есть этих данных да у нас загрузка выполнялось всю жизнь за час они за 7 часов то есть мы в 7 раз ускорили загрузку данных после того как вы определились тем как мы будем загружать данные нам нужно было понять и как их хранить сразу стоит отметить что данный мы храним ни в одном инстансе тарантула мы храним их кластере кластер должен с помощью приборка tendulkar лишь о нем на самом деле будет рассказано более подробно в следующем докладе но скажу немного о том как вообще определяется instance тарантул соответственно нас есть несколько видов инстансов это роутер и маршрутизатора они вор да и есть соответственно 100 раджа хранилище срок ароматизируют запроса хранилищем хранилище это соответственно наборы реплик то есть у вас есть . ничем не ври приказ это у вас есть мастер и есть реплики как мышь ради равале данные данные то есть изучив данные мы увидели что у них есть общие полях горды квартал и нам показалась вполне логичным гарнировать именно по этим двум полям то есть у нас каждый шар это квартал определенного года поэтому мы для запросов для поисков порядков мы построили первичный яндекс по полям счет один шар 2 года квартал так как этот индекс в принципе удовлетворяет нам все наши всем нашим требованиям для поиск транзакций и также для реализации графа у поиска мы построили вторичный яндекс по полям еще два года квартал как он используется я расскажу и как я уже говорил используется более гибкая репликация то есть больше запросов больше реплик когда это работает изучив данные да мы поняли что например в данном более свежим который там за последний год и за последний квартал и к ним будет больше обращений потому что так как это более свежий транзакции да и они нам более важны соответственно для этих данных мы увеличиваем до хранение этих данных мы увеличиваем количество реплика реплика сети таким образом мы увеличиваем во-первых скорости обработки этих данных во вторых мы увеличиваем откажу устойчивой системы то есть даже если там упадет мастер запроса пойдут на реплику мы все равно сможем прочитать оттуда данные следующие проблемы с которым мы столкнулись с реализаций алгоритмов поиска у нас в одном кластеры как тарантулы хранится 10 миллионов узлов 5 миллиардов записей мы изначально по всему дата сайта построили распределения по степеням вершину степени вершин это соответственно сколько транзакцией выходил ну происходило с текущего счета то есть исходящей связи после того как мы построили распределением увидели что у нас есть вершина из которых выходит там 100 и 100 тысяч и миллионов связей поэтому если мы будем перебирает наверное поиском ширину все эти связи то нам придется перебирать где-то 1 миллион связи но это очень долго поэтому на и влипаешь в ширину у нас не работает тогда мы стали искать другой способ как бы мы могли облегчить уменьши количество перебираем их связей и облегчить запрос мы пришли к такому выводу у нас есть первичное вторично индекса помощью первичного индексом мы ищем все вершины то есть все транзакции который производил листья спорного черта на какой-то счет связано с каким-то вершинами берем эту множество вершин и вершина 1 и пусть мощь этого множества будет м так же у нас есть вторичный индекс который позволяет найти все вершины из которых транзакции приходили на целевой счет назовем это множество вершина 2 и пусть мощность этого множества будет к теперь нам что необходимо сделать на по сути два шага алга графу поиск мужа нашли два шага путина minaj нам осталось найти только связку между этими двумя множествами теперь мы перебираем и наказ вот этих пар из множества вершина один множество вершин на 2 то есть по сути дела и монако selecta мы ищем связи между этими двумя множествами тем самым мы существенно уменьшаем количество вершин которые нам нужно перебрать и соответственно увеличиваем скорость работы алгоритма по поводу поиск связи второго порядка работает примерно так же но немного проще здесь мы с помощью первичного индекса ищем все вершины которые связаны с исходным счетом помощью вторичного индекса мы ищем все вершины которые связаны с целевым счетом и потом мы ищем просто пересечение этих двух множеств то есть все вершины которые есть и множестве один о множестве 2 они являются посредниками в транзакции после того как мы определились логарифме графу в поиском и приступили к их реализации и реализовывали мы их тремя разными способами трех языках реализовали мы их налог на и спел и носи после того как мы это сделали нам необходимо было сравнить производительность но для сравнения мы выбрали самый простой запрос а именно поиск связи и первого порядка как видно из таблицы хуже всех себя показал в он самый медленный лучше всех себя показали процедура носи процедурные склеили они показали запрос показали себя более менее нормально но у и скверно в таранто ли есть одна особенность он работает только в рамках одного intenso то есть он не работает по классу поэтому нам пришлось отбросить данное решение и логичным кажется использовать решение носил атаку решение носи тоже обнаружился один недостаток а именно сложность реализации алгоритма то есть алгоритм графу поиска который мы реализовали он очень громоздки он очень большой и его сложно писать тогда мы стали искать чем мы можем заменить сен каким компилируем языком но при этом до чтобы производительность нас осталась такой же наркоза было меньше мы воспользовались раз там мы написали хранимой процедуры на растя они получились меньше где-то в 5 раз скомпилировать и соответственно динамические библиотеки то есть модулей и подключили их тарантул также как и модульность производительность мы получили примерно такую же как и носи то есть но кода меньше про раз сейчас параллельно идет доклад как раз по моему в третьем зале кому интересно можете прослушать запись будет довольно таки интересно должен до что касается этого подхода получили какие результаты мы получили соответственно мы уложились уважительным устраивании заказчика до уложились более того мы превзошли требование заказчика так как также загрузка данных у нас выполнялось за час случае поиск связи 1 порядке поиск второго порядка мы смогли обрабатывать даже уже не 3000 и 4000 заказывать транзакций в секунду в запросах графа поиска нас работает 18 тысячи транзакций в секунду стук также стоит отметить что в случае графова поиска если мы выбираем то есть когда мы построили распределение обнаружу вершины с одним миллионом связей и там со статьи с чем связи ведь если мы будем перебирать эти вершины до даже случайно мы выберем вершины то такие вершин это тарантул все равно их обработает то есть мы сможем вернуть путь который если он есть между этими двумя вершинами на это будет просто выполняться дольше но при этом система не упадет не откажут то есть она не откажет да и вы все равно получите результат на выходе исходя из этого можно сделать вывод что хранить графов коран при возможно возможно это в том случае только если вы изначально изучили данные знаете как их можно распараллелить как можно сортировать до чтобы распараллелить обработку этих данных так как тарантул позволяет гибко гибко сортировать данные про конкретной задачи нагрузки и про конкретные данные также есть случаи когда вам критично производительность нужно реализовать какой-то сложный алгоритм вы можете воспользоваться компилируемый язык амины например стиле раз там для написания более эффективных алгоритмов да и написать его это может соответственно меньше вложением силы если вы это будет делилось на россию вот на этом у меня все спасибо за внимание это александр корякин друзья спасибо огромное я уже вижу первую руку если микрофона кажется сейчас на втором ряду это будет классно тогда когда вы в онлайне у вас рядом с экраном трансляции есть специальная кнопочка выйти в эфир нам придет сигнал и нас кое-что онлайн без очереди задаст вопрос нажмите заранее и так микрофону человек которые спрашивают прошу здрасте а загрузка она осталась на гол или тоже на 1 хотели бы переписать или переписали можете пожалуйста еще если решили что раз настолько круто подходит загрузку данных в базе оставили на голландии или тоже на раз решили переписать или хотели но не переписали ну смотрите мы искали решение которое будет принципе работать также как также быстро горшки galant он все таки будет немного медленней любом хоч да тем более еще был модуль написано epam компании когда-то созданные таран туров ну и нам захотелось принципе воспользоваться попробовать да этот модуль что он вообще может мы им воспользовались и это оказало довольно-таки эффективно по скорости мы не проиграли ну то есть именно загрузка в тарантул из исходных данных тарантул тарантул исходных данных оно происходило с помощью коннектор год тарантул мы загружали данные по сети по бинарным протокол это все таки быстро тоже ну то есть это однократно 1 краснодар но в случае если нужно это делать соответственно там каждый день до раз в день то это тоже можно делать потому что это не так долго раньше там я не помню по моему раз в неделю данные загружались и выгружались друзья поднимаете руки заранее что пример нам ориентироваться кто хочет задать вопрос следующий если вам они нажмите кнопку над нас сказать что тебе предстоит выбрать лучший вопрос для это должно быть больше 1 и хочу все понятно а вот есть люди которые мне все понятно спасибо вам огромное и у нас потом еще будет вопрос вот задних рядов ним здрастя расскажите потянуло так сильно просел по скорости по сравнению с и скорик можете пожалуйста москва у вас был слайд со скоростями луи склеили есипов а почему она настолько медленно оказалось ни слова потому что использовать виртуальная машина пришло и изначально соответственно интерпретируется этом интерпретируется виртуальной машиной и работает он медленнее саму интерпретируемый язык они компилируем поднимите руку еще раз черную отлично здравствуйте denis компания систематика консалтинг у меня такой вопрос точнее даже 2 1 если бы не тарантул то чтобы вы бы использовали но если бы у вас вы бы не были связаны с этим импортозамещения my и прочей ерундой и второй вопрос если ваша база данных вырастет еще в 10 раз то что произойдет спасибо да по поводу первого вопроса если бы не тарантул ну возможно для нашей задачи наверно подошел баран бе-бе ну что он умеет не только в графа да он умеет и в теле а насколько я знаю и как бы для то есть там можно тоже подшивать индексы в принципе это будет работать еще раз можете посмотреть пожалуйста второй вопрос если ваша до база данных вырастет в 10 раз какие у вас скажем так тайминги будут о производительности запросов по поводу сайдинга фэт надо считать я сейчас так сходу не скажу я не думаю что прям скорость обработка меньше а вот а вот смотрите я помню я же чуть чуть учился в институте там было там сложность алгоритмов ума от у большое ты not единиц от логарифма ну так приблизительно чтобы понимать вдруг вдруг вы думали в нем это просчитываем про помню про считается но я ща любые теоретические изыскания все равно потом практическим способом или проявляются или галлона еще вопрос пожалуйста если онлайн если вдруг я вас не вижу сделайте так чтоб я вас услышал классно был три вопроса но прежде всего мучным благодарна тебе за этот рассказ спасибо что ты приехал этого первое вступление надо ж спасибо тебе огромное за решимость и за смелости зато как ты поделился"
}