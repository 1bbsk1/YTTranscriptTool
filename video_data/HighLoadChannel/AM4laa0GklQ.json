{
  "video_id": "AM4laa0GklQ",
  "channel": "HighLoadChannel",
  "title": "Как профилировать, когда perf видит не всё? / Максим Кокряшкин (Tarantool, VK)",
  "views": 381,
  "duration": 2394,
  "published": "2024-04-17T01:10:21-07:00",
  "text": "рад всех приветствовать на втором дне конференции Сегодня у нас зал открывается таким хорошим хардкором То есть я надеюсь все любители хардкора здесь собрались И я рад поприветствовать на сцене Максима как ряшкина это разработчик из Тарантул это Мой коллега мне очень рад его представить он занимается довольно хардкорной вещью То есть он дебажет внутренности лоджита У нас очень мало кто понимает как это всё внутри работает и сегодня он нам расскажет Как можно профилировать составные системы То есть когда у вас внутри одного приложения есть какой-то другой runtime и в общем вот это всё нужно смотреть и разбирать как оно работает поприветствуем Максима Максим давай Всем привет Как вас Бодрость духа после Афтер пати А у кого-то видимо еще и автора пальцем Я в общем впечатлен что вас так много и что вы решили прямо с утра загрузиться жизнью Надеюсь что вас останутся силы на другие доклады сегодня днем что мы сегодня обсудим мы обсудим в первую очередь то почему системы со встроенными интерпретаторами сложно профилировать почему это вызывает трудности Какие они бывают обсудим способы решения этих проблем с одной стороны научим перв видеть внутренности вашей виртуальной машины вашего интерпретатора встроенную в систему с другой стороны мы посмотрим как можно написать свой инструмент если по каким-то причинам адаптировать первых вас не получилось вы столкнулись с какими-то сложностями похожими на тех с которыми столкнулись мы и как минимизировать боль в этой ситуации для начала Давайте ведем немножечко контекста а я работаю как уже было сказано в тарантуле занимаюсь поддержкой logitar разработкой нового фич него Тарантул это платформа для in Memory вычислений это база данных плюс Application Server Вы можете писать произвольный сложности бизнес логику на алоэ можете хоть веб-сервер внутри базы написать фактически Для всего этого у нас собственный forklogite внутри и еще очень многие компоненты Тарантула написано из-за этого рантайм становится очень тесным переплетением вызовов как нативного хода написанного на оси так и коды написанного налого Это очень сложный сэндвич с несколькими слоями переходов лоа и семерых связанные несколькими способами Первый из них это модули для Лова написано в общем все понятно с другой стороны Вы можете делать вызовы си функций из вашего кода через интерфейс и наконец Вы можете вызывать функции кода через секунда Через много способов того как они могут между собой переплетаться задача Да вот вы получаете эту сложную картинку что вы начинаете и дальше выходите в Возвращайтесь и так может быть много много раз а как это профилировать ну можно вот так если вы совсем бедный человек запускать ГТБ шишку из Баша каждую секунду сбрасывается так Trace Все вы великолепно надеюсь так никто не делает не делайте Да понятно Ну а если серьезно то у нас есть по сути два основных инструмента для профилирования У нас есть перв это в общем де-факто стандартный профилирования на линуксе с ним все понятно с другой стороны у нас есть джетп это встроенный владжет профилировщик но как бы есть нюансы посмотрим на них более детально Сначала посмотрим на как я уже сказал Да этот де-факто стандартный профилирование в линуксе начиная с ядер версии 2.6 Он построен на LG в ядре userspace одна компонента которая находится собственно в керннеле и собирает вам события называется perfevents то есть у вас есть эти события разных типов есть события которые собираются отдельно под компоненты вашего процессора который называется pmu или перформанс-менеджмент он собирает события вроде того сколько у вас инструкции исполнилось Сколько раз я вам США промазали очень много разного рода таких вещей с другой стороны бывает более сложные которые уже вам реализует ядро оно собирает какие-то более агрегатные метрики более высокоуровневые и чтобы понимать насколько это огромный комбайн первенц вот столько и каждая звёздочка здесь это на самом деле группа ещё из пяти и шести специфичных эвтов и если это кажется много то это тоже не всё на самом деле их вот столько много и perf может ещё и трассирование много других вещей это просто огромная машина для того чтобы анализировать исполнение вот с другой стороны ложится Для лоон более приземленный из его плюсов важно видеть что он умеет дампить данный формате Граф Кто знает поднимите руку чудесно все знают Отлично Да у него есть три фронтендо первый фронтенд это параметры командной строки Вы можете просто при запуске лоджита указать параметрами Что вы хотите профилироваться что вы хотите собирать собственно вы получите свой профиль у вас есть логопе чтобы делать это через слово код запросить профилирование там задать параметры также Если вы хотите писать код наси какие-то модуль для логоси опять же важный диагноз Что при использовании API а не командной строки вы увидите возможность задавать callback свой Где вы можете дополнительные действия например как-то агрегировать информацию собирать дополнительные данные сделать какой-то важный вам анализ но большой недостаток в том что он видит исключительно мир нас не устраивает естественно теперь поговорим про визуализацию для визуализации дальше будем использовать везде флайнкрафт реализации бренда макгрегора это такой замечательный человек из netflix который очень любит профилирование у него есть огромный сайт где он рассказывает разные про него вещи Очень рекомендую ознакомиться если вам интересно его фотография Он легковесный у него очень простой формат данных на входе Именно поэтому выбрали формат простой вот настолько вы просто записываете стейки Где у вас время разделены точка запятой указываете их количество всё Выиграли вы получаете классную визуализацию за бесплатно практически теперь перейдем собственно к проблеме более явно посмотрим на неё вот у нас есть вычисления Этого числа Фибоначчи написанные на C аналогичный код на луну Ничего особенного и драйвер который в течение 10 секунд поочередно их вызывает Казалось бы что может пойти не так давайте натравим на это дело perf и мы увидим вот такой вот картинку мы видим хищный стек вот какие-то вызовы А дальше в общем здесь пустота Там что-то должно быть наверно интересно с другой стороны профилировать GP мы увидим ЛуАЗ тег дырку очень знакомого размера и в общем тоже часть информации потеряна нет вообще ничего а хотим Вот такую картину Мы хотим волшебные проектировщик который покажет нам всю красоту переходов между силу мирами и собственно эта цель которой мы будем идти весь сегодняшний доклад пути решения нашей проблемы есть два как адекватные люди хочется пойти в сторону адаптации perf А вот но вы уже слышали другие доклады ВКонтакте вы знаете в какой компании Я работаю понимаете где мы окажемся в конечном итоге я думаю на какую сторону автобуса придется пересесть Чего нам не хватает чтобы адаптировать мы будем иммигрировать адекватных людей первым доклада Конечно нам в сущности не хватает того что во-первых научился видеть символы виртуальной машины все знают что такое символы поднимите руку пожалуйста отлично а И еще нам нужно учитывать разматывать стек виртуальной машины собственно мы не первый кто решает проблему ребята вот в jwm пытались решать ребята из netflix мы будем сравнивать опять же весь доклад нашего подсох опытом чтобы понять каких случаях какой подход вам больше подойдет начнем со стеков для размотки стеков у перфа есть три механизма Первый из них самый простой понятный фреймпоинтер Я думаю все понимают Как это работает потом есть дворф кто-нибудь слышал про двор поднимите руку отлично для тех кто не слышал Не беспокойтесь мы перейдем более детально разберем чуть дальше и есть орк которые вряд ли вообще много людей слышали потому что это очень новая вещь и она очень специфично скорее для разработчиков ядра Linux но тем не менее разматывать тоже умеет кратко напомню когда-то регистров было много было мало процессоры были дорогие слабенькие и решили разматывать так не такая частая активность регистр Нам все-таки нужен поэтому забрали регистр мы используем его как регистра общего назначения вычисления стали быстрее но для размотки стаков теперь нужны более сложные механизмы хорошо для Староверов сделали флаг компиляции поинтер пожалуйста профилируйтесь вас в finpointer будет в регистре все замечательно ли виртуальной машины такой флаг конечно в молчанию никто не делает Поэтому если вы хотите использовать такой подход собственно все что от вас требуется это сделать аналог флагов для вашей виртуальной машины джависты так и поступили Вот это буквально кусок их подчан Ну за вычетом моих русскоязычных комментариев к нему который реализовал собственно необходимый функциональность Вот это осмысленно его часть они убрали регистр РПП из Пула регистров общего назначения и сделали вот классическую вещь прологов всем знакомую в результате они пришли к успеху они получили свои стейки восстановленные символов там всё ещё нету Там просто непонятно что находится но стек при этом есть адреса есть у нас так не получилось Тарантул использует лоджита не Джим слава Богу с одной стороны с другой стороны двм это Монстр написанный гением И в нем виртуальная машина Это несколько тысяч строк ассемблера написанного вручную и как следствие это много неявных зависимостей на регистре поэтому пройти и вот починить вот это все аналогичным образом это вообще непростая задача еще гарантировать что они сломается также легко сделать не выйдет поэтому пришлось обращаться к альтернативным способом то есть двор дворф это широко используемый формат данных даже если вы никогда не слышали вы должны знать что каждый раз когда вы прописываете флаг компиляции минус gfc генерируется вот это вот радость большой вероятностью в нем есть вся информация которая может понравиться люди начиная В какой строчке что написано и заканчивая тем какие функции для размотки стеков для нас самое важное есть сейчас будет очень страшная таблица которая вызывает первобытный страх Приготовьте крепко зажмуритесь пугает Да но сейчас мы разберемся не так страшно на самом деле в чем идея размотки стека с помощью дворов У вас есть позиция в программе которая однозначно задается положением вашего instaction Point регистр айпи Вот вот тот столбец выделенный соответственно каждому положению в программе Вы можете сопоставить способ как вам восстановить значение региста в текущем контексте делается это следующим образом у вас есть то что называется CF и connonical framaters это адрес относительно которого вы можете взять смещение и восстановить значение нужного вам регистр собственно везде дальше Где вы видите это таблички буковку си Это значит что это буковка соответственно нет способа восстановления и дальше соответственно Вот вы берете значение сейфы доверять от него смещение поэтому адресу достает значение регистра вот так здорово соответственно ваша регистров необходимо просто сохраняются в память уже не так страшно Но такая табличка очень большая и она может быть больше чем даже размер своей программы поэтому естественно никто так не хранит а хранят изменения между строк и миг кодирует Вот в такой страшный байт-код И двоев на самом деле это стоит машина но мы в этом разбираться не будем Потому что это совсем ад И это для очень Смелых как это все хранится конец следующим образом хранится с помощью двух сущностей У вас есть то что называется Frame description 3 это запись которая соответствует тому как вам восстанавливается так в этом конкретном фрейме но зачастую многие фреймы разделяют какие-то общие части состояния Поэтому чтобы сэкономить место их выносят то что называется Ci или comman Information and вносится общее их часть соответственно чтобы осуществить размотку вы находите нужный вам френч-крипшнэнтры вы проходите в общую часть выполняете какие-то разделяемые начальные инструкции это стоит машина дварфа затем возвращаетесь обратно выполняете инструкции специфичные для вашего фрейма все выиграю Ну все еще страшно поэтому Давайте пример разберем Как это работает для того чтобы функцию Back Trace написать через двор вы собственно извлекаете текущий контекст значение регистров затем Называйте начальную инициализацию под капотом два шага происходит во-первых вы определяете в каком вы находитесь разделяемом объекте В каком конкретном или файле из подгруженных к вашему исполнению находите внутри него хедер который хранится индекс по сути этих а затем достаете значение IP РСП и делаете шаг но делайте шаг звучит просто наверняка это более сложные происходит правда Давайте заглянем в шаге происходит следующие вещи Вот вы находите поэтому индекс как я сказал ваш крипшен затем делаем вот ровно то что обсуждали на несколько слайдов назад мы делаем переход для информации выполняем общую часть восстановления контекста затем выполняем свою специфичную все Мы научились разматывать графом ультимативный инструмент всё должно быть хорошо Нет во-первых у вас растет размер бинаря потому что если хотите дать клиенту возможность профилироваться Вы должны поставлять ему дебаговую сборку София дибаговой информации такого наверное не все хотят на старых ядрах Linux если вам нужно это работать не будет Для нас это было довольно критично потому что у нас есть всякие клиенты которые пользуются цента 7 это ну неприятно Ну и самая большая проблема что если у вас есть джид или вал подобные конструкции вы попадаете в ад потому что нужно актуализировать вот эти вот все Family scription 3 когда у вас либо появляется какая-то новая функция runtime или у вас что-то скопилировалось А у нас лоджит джид есть в названии логично что мы будем страдать но И даже это не самая большая проблема для нее есть решение мы обсудим позже самая большая проблема проистекает из особенностей того как лоджит в случае трассировщик калькулятор как он считает компиляцию мы положим у вас вот такой вот код есть у вас есть просто функция которая в цикле вызывает другую функцию которая делает инкремент Казалось бы что может пойти не так но когда оно скомпилируется но вы получите очень неприятную картину сначала из всего этого быть рожден Лова байт-код здесь все еще есть Явный вызов функции все хорошо Это отслеживаем здорово Вот он там кол Но как только вы начинаете это компилировать в сторону машинного кода и получаете внутреннее представление компилятора ТО происходит оптимизация ваш Колл исчез Там просто инкремент вы больше никогда не узнаете что там когда-либо был то есть такие инлайны мы отслеживать не сможем разматывать такие стыки не сможем и проблема в том что ладно это будет один вызов функций но там их может быть очень много вот так спрятанных собственно решили проблему можно генерации на лету есть механизм для этого в дворфе Вы можете регистрировать нужные файлы появляются какие-то исполняемые куски коды новые но это очень опасная вещь за руками чтобы этот индекс оставался актуальным и верным и вам нужно решить проблему функций которые онлайниса либо научиться их определять в моменте чтобы информацию либо запретить это делать вообще на этапе профилирования в общем-то не очень здорово но дворф тоже В общем не так прекрасен даже с учетом всего что сказано и вот что о нем говорят великие И когда это все дело попытались затащить в ядро торвальдс в лучших традициях всем там накидал в панамку и сказал что мне этого не надо Давайте вот уберите с ваше стейт машины какие-то все ненадежно там еще никто нормально этот дворф байт-код генерировать не умеет безошибочно Мне не нужно чтобы меня в ядре размотка разваливалась такая там состояние какое-нибудь не то будет чуть-чуть Вот он так часто слово opting Hold здесь использовал в письме что ребята которые в итоге написали орк такое шуточный расшифровка и придумали вообще назвали его Упс или военко побить на самом деле они просто решили полный состав из Варкрафта собрать в сторону варфа Эльфа И всего того что там уже было Да Из плюсов в результате всех этих наездов орк устроен значительно проще Вот мы сейчас не будем опять проделывать Вот такие ментальные упражнения и он работает быстрее чем два в среднем где-то в 20 раз хотя автор орка утверждал что где-то до 40 Иногда доезжал у него из минусов он занимает больше места оперативной памяти на 50 процентов но в общем там она в целом мне так много места занимает чтобы это большой проблемы было его ставил он предельно просто Это буквально структурка соответствующим вашему репу которая говорит вам э-э Возьмите вот адрес сколько смещение и Достаньте все нужное значение исключительно нужное для разработки всё великолепно ничего сложного э-э но что делать если по каким-то причинам вы не смогли воспользоваться например вам нужно работать на старых Ну тут соображение такое вы легко умеете снимать стеков внутри виртуальную машину у вас есть для этого специфичный для неё способы вы также легко умеете снимать стыки на Хосте у вас там есть функция позиционная например ещё там разные библиотеки для этого сделайте модуль просто собственным виндером который будет читать это символ маторов programming можно Попробуйте в банк затащить какой-нибудь который захочет профилировать просто Попробуйте предложить модуль ядра поставить такое никто не пойдет конечно собственно здесь Мы возвращаемся к тому Чего нам не хватает если мы проблемы со стеклом смогли решить нам подошел двор флиорк то дальше нам остается еще такая проблема символами соответственно таблица символов самом деле не является такой большой проблемой Если вы запустите аннотирование процессинг perfe когда соберете профилем обнаружите что перв на самом деле ищет символы при начале анонсирования Вот и Да выясняется что достаточно сделать вот такой прекрасный Файлик куда вы положите информацию о следующего года вы положите начальные адреса всех ваших функций их размер и он прекрасно сопоставит адреса в собранном профиле с вот этим мампингом ладжит такое умеет генерировать для трассы но не для всего остального Но это небольшая проблема в общем-то это не сложно написать было бы джависты написали получили вот успешную картинку классных Граф у них всё замечательно стейки символы всё волшебно тоже на самом деле не все так радужно даже у джавистов во-первых Этот папинг опять будет остревать если у вас есть джид у вас появляется новый символ Будьте добры его актуализировать это надо делать на ходу Если у вас есть и вал подобной конструкции Снова новый символ актуализируйте mapping устарел у вас все разъединится еще ваш интерпретатор иногда может сделать реалок и буфер с исполнением кодом просто унести куда-нибудь не добавляя новых символов отслеживайте обновляйте mapping Ну решение есть тем не менее первое решение избрали люди в Джаве они сбрасывали маппинг вначале в конце и потом очень крепко молились чтобы она не разъехалась там совсем сильно Вот но так жить нельзя не в какой-то момент решили и написали один который делает это когда нужно посмотреть на него можно вот тут Вот в общем понятный вопрос нам к сожалению не подошли подходы поэтому пришлось по классике пересесть на темную сторону автобуса и пойти грустить очень надолго и мы вспомнили Вот тот кто самый размышления о том что очень легко снимать стыки виртуальной машине очень легко делать на Хосте сложно это совместить но теперь-то мы можем не утаскивать это все в кирнельный модуль а сделать это все внутри виртуальной машины потому что теперь мы можем это делать и остается только вопрос о том как эти статьи соединить отобразить там переключение runtime Ну для лоджита рассмотрим пример у вас скорее ситуация будет примерно логично У вас есть какие-то понятные точки входа виртуальную машину в нашем случае это функции кол все хорошо У вас есть понятная точка входа всемир Это в нашем случае Вот такая вот еще важный факт что Влад GTC и функции присутствует временный НЛО астеки и насисты эти дальше соответственно вот пусть нас есть два собранных стека чистая клостек мы встаем курсором в начало сестренного стека встаем в него начинаем идти курсором заполнять результирующий стек вот мы идем идем доходим до луа и кола На этом этапе мы переходим в лостек встаем в него курсором начинаем добраться дойдем до конца либо не дойдем до сих функции Ну вот у нас 3 функция одновременно с этим и конец на самом деле вот встаем обратно в хищный стек и докидываем все что у него до конца все мы соединились те которые отображает передачу управления осталось разобраться символами Ну внутри виртуальной машины вы будете снимать каким-то специфичным вашей виртуальной машины способом Тут ничего особо не скажешь на Хосте логично использовать механизмы которые вам предоставляются для анализа ваших разделяемых объектов вас есть рогом хедер Вы проигрываетесь по всем вы можете также отслеживать вас подгружается и отгружаются какие-то модули разделяемые с помощью это счетчики того сколько было подгружено и отгружено у вас объектов То есть если вас какой-то модуль новый подгрузится например для вашего языка написано и вы сможете это отследить и символы из него также сбросить самый лучший способ сделать прямо в Эльф и достать из него прям полную таблицу символов включая статические сделать мы сейчас обсудим собственно делается это следующим образом вы открываете прямо Эльф как файл смотрите прям его linkingview и данькать оттуда секцию стартап который символов Но это на самом деле просто чаровский буфер сплошной это не здорово и вам ничего не даст поэтому вам нужна метаформация которая лежит вот здесь там написано на каком адресу это что соответствует какой размер имеет функция ровно та информация которая нам для мампингаперфа нужна была на самом деле вот отсюда Вы можете извлечь если по каким-то причинам У вас есть ограничения вы не можете заглянуть прямо в этот файл Ну печально тогда Воспользуйтесь альтернативным способом да Или Трейд вам прямо в память подгружает куски Ильфа которые вам нужны для динамического исполнения для динамической клинковки там есть символьная таблица её можно прямо посмотреть достать все символы Но это подольше потому что механизмы быстро узнает сколько там символов лежит Нет А вам это Нужно будет узнать И для этого придется прооперироваться по всей таблице которая там нужна для того чтобы эти символы смотреть и затем всех этих подходов вы получаете заветную картинку Именно они были реализованы в seasprofi это профилировщик платформы в тарантуле у него есть режим работы может собирать просто счетчики он может собирать последний Frame счетчики может собирать полный дам стека у него есть высокоуровневого просто хотите кода запустить посмотреть что-то быстро у него есть низкоуровневый seapi если вам нужна тонкая настройка Вы можете задавать там собственный разборчики дополнительный анализ делать я прям замечательно и вот так этим можно пользоваться и зло очень просто задаете интервал профилирования задаете куда Вам что-то сбросить режим и погнали собственно примеры реальной жизни У нас есть такой Волшебный скрипт внутри команды которая делает миллионы replace мы его долгое время использовали чтобы так грубо оценить производительность иногда Но по профилировали вот этим профилировщиком который отображается переходы обнаружили неприятную деталь как-то для профилирования база не Здорово У нас получается много влияния лу у нас сели люди тыкаться делать какой-то более удачный бенчмарк для грубой оценки взяли К6 вот здесь использовали потому что система на которые очень старая там в общем беда А вот свой профилировщик удобно смотрели много времени проводим Ну покрутили нагрузку добавили там в ушек добавили в К6 более Удачного параллелизма встретить попытки смогли подгрузить вот видно какой у нас все классно отображается в том числе даже когда это просто хищное исполнение Да У этого всего конечно есть свои недостатки и они решаются очень больно поэтому хочется чтобы люди либо контрибутили вопенсорс смело либо вот хочется когда-нибудь кого-то этим нагрузить но не делать самостоятельно чтобы не испытывать весь Спектр страданий мы пока не умеем разматывать машинный код для Лола сгенерированный То есть те самые трасса компилятора нет можно давать либо дополнительные отметки на них Чтобы не терять вот те самые инвалиды которые я говорил либо генерировать какую-то свою отладочную информацию дополнительно это тоже больно В общем Надо придумывать нас мало функционала относительно перв потому что естественно самописный инструмент здесь можно писать больше скриптов для интеграции с инструментами для perf а дать людям возможность пользоваться привычным инструментарием для анализа уже собранного профиля Ну и оверхед конечно печальный и залу То есть можно теоретически сделать очень плохо написано программу в реальной жизни где из-за того как она будет сделано будет аж 28 процентов это прям ужасно но такого в жизни не бывает в жизни чаще всего в среднем она бывает вот такое Это самый самый маленький возможный интервал профилирования то есть Ну ожидаемо конечно но тоже есть куда стремиться вот выводы такие если вам нужно профилировать сложную сэндвичную систему вы первым делом должны пытаться сохранить рассудок и пойти вот сюда Для этого вам нужно сбросить mapping а для стеков вам нужно либо сделать аналог Frame Pointer либо использовать два либо использовать орк тогда вы выиграете Если же вы совсем смелый то можно и сюда сходить в целом это не так убийственно если все-таки вам нужно на темную сторону то для своего профилировщика вам нужно сбрасывать символы например через Daily Trade но можете делать это любым удобным способом и снимать стейки отдельно простые механизмами которые вас для виртуальной машины для Хоста а потом пост процессе уже после такого собрали весь профиль соединять их оффлайново собственно на этом все я буду ответить на ваши вопросы Спасибо Максим предлагаю всем задавать вопросы скажу заранее что у нас за вопросы припасен не один подарок как обычно А даже два У нас есть один от непосредственно Тарантула и один онтиковский и я сразу напоминаю Вы можете задавать вопросы в чат зала я их буду читать я их могу озвучивать даже если вы не находитесь в этой аудитории вы можете написать мы если успеем мы их отработаем Оцените пожалуйста доклад не забывайте Спасибо большое за доклад очень интересно было небольшая поправка Брендон Грег уже не работает в netflix Он работает в Intel вот на будущее А вообще хотел бы спросить по поводу и bpf думали ли в эту сторону досмотрели но опять же нам это не очень подходило мы хотели добиться В общем того что либо Мы интегрируем со стандартом инструментом в виде перфа который точно есть у всех потому что тоже есть сложности например там точно есть проблемы компилировать будет через gc например там будут проблемы мы хотели чтобы это было максимально портируем и переносимым на Очень большом количестве платформ работаем вот и мы еще хотели предельно упаковываться чтобы клиенты не заставлять ничего ставить тащить дополнительно не заставлять в этом пользоваться флангом не менее так далее Спасибо И второй вопрос У меня по поводу овцу вот это все про CPU Да вы методы которые насыпал сейчас а вот про овцепов это вот мне кажется не менее интересная тема Может ли вас профилировщик профилировать в CPU что подразумевается Ну то что у нас не на процессоре а всё остальное swopping потом работать с дисками с сетью Ну такой нужды у нас не возникало в целом то есть запросы на это нет если он когда-то появится наверное в эту сторону покопаем Просто у нас есть большая боль команды которая занимается лоджи том что нам приходят говорят сделайте нам пожалуйста профилировщик платформу тренировщик памяти Мы уходим бандитом на полгода приносим это люди такие я вам очень рекомендую посмотреть это не менее интересно чем CPU Всё спасибо большое Спасибо за доклад очень интересная схема про сэндвич силуа сила в текущем мире есть сэндвич из запросов в другие сервисы когда предыдущий вопрос был прав цпу Я подумал а если построить флайнграф как только уходит по сети сервис в другой сервис вам смотреть Спасибо Спасибо Спасибо за доклад скажи я вот профилирование памяти ты заикнулся Но насколько актуальная проблема вообще смотрите ли в это какие профилировщик памяти Достаточно давно называется мем проф он вам может рассказать все то что у вас происходило в его исполнении Где у вас что там потекло где выделено было и очень классно самом деле работает он в связке вот с рокеровщиком CPU неожиданно на самом деле то есть например вот здесь был слайд где мы там видели очень большую нагрузку на гармошка Лектор вот которая показывала и иногда полезно увидеть здесь большую нагрузку на карточку Лектор потом прийти короче к память и посмотреть из-за кого она возникла и починить там какой-то маленький кусочек кода две строчки по-другому сделать и у вас резко нагрузка на процессор падает потому что вы разгрузили гц памяти он показывает потребление показывает все локации вообще какая-то происходили сколько где кто что сделал время жизни процесса но за время работы Спасибо за доклад у меня такой вопрос возник Я посмотрел на рисунке и так понял что вы профилируетесь где-то уже на runtime системе То есть вы не просто отлаживаете А у клиента смотрите как она работает мы пока это внутри гоняли то есть Прямо клиентам мы это не отдавали потому что это все-таки было достаточно Экспериментальная Вещь Вот она только наверное в текущем релизе более-менее стабилизировалась потому что было очень много специфичных виртуальной машины проблем которые стреляли очень внезапно и неожиданно Я так понимаю это планируется Да конечно Вот и с этим вопрос Там оверхед всё-таки есть вот посчитали около 12% на то что производить профилирование на готовой системе А вы не задумывались над тем чтобы допустим поделить готовую систему на какие-то модули профилировать по нагрузке на отдельным модулям если что-то в нём не ток не то то уже заниматься профилированием не на работающей системе А где-то у себя на отладке но мы так сейчас и делаем сейчас это используется внутри команды чтобы понять как у нас вообще дела с перформансом внутри и дальше мы можем корректироваться а потом если вдруг клиент захочет он может запустить все локально посмотреть как нужно практичный сервер клиенту может быть полезно профилировать свой код какой-то и он у него тоже может быть сэндвичным то есть Клиенты пишут в том числе модулей на hitaranta его используют редко конечно Спасибо Спасибо большое за доклад Скажи пожалуйста а Сколько времени заняло Осознать что автобуса нет светлой стороны и сколько потом времени еще прошло до каких-то готовых результатов у вас Мы очень долго хотели верить что это мы глупые не мира жесток настолько поэтому мы месяца наверное три пытались усиленно интегрироваться с перфом Вот Но когда поняли что это все совсем тупик на то чтобы сделать наверное месяца два а потом Мы периодически ловили проблемы внезапно выстреливающие из-за того что Ну вот написан гений и смертным понять его сложными стали там есть места где очень неожиданные вещи происходят которые Ну например самая простая понятная вещь Когда вы хотите снять лаваш Так вам нужно чтобы он как минимум Был консистентен но сейчас так виртуальной машины Вот иногда бывает так что стоит виртуальная машина которая в состоянии показывает просто флаг говорит У меня все хорошо я консистентна а на деле вообще не так вот и таких мест много и иногда мы выясняем что мы отловили не все такие места и приходится героически решать эти проблемы Вот в общем сейчас есть ощущение что всё да отловили до конца Понятно спасибо большое Привет Спасибо за доклад вопросик такой ты говорил что можно написать и веб-сервис А можно ли потом из-за этого веб-сервиса динамически включить на какое-то время профилирование Да конечно есть можно прямо вот фронтально сказать хочу профилирование вот сейчас Спасибо за доклад вопрос у меня следующий а не получится ли малой кровью для тех клиентов у которых уже новое ядро из-за использовать орк например с большим количеством функционала вы не думали в эту сторону Нет не думали но я думаю что это небольшая проблема Да если есть можно пользоваться норком это не так сложно завести Спасибо кажется у нас все и я тебе задам самый сложный вопрос выбери двух спрашивающих так мне мне понравился вопрос про Ну пусть будет вопрос который про светлую сторону темную сторону потому что это прям очень личные и больно Вот и был еще вопрос про bpf это тоже очень классный вопрос мне нравится погружение потому что правда тоже еще как один из вариантов долго рассматривали это вот хорошо Подойдите пожалуйста Давайте еще раз поаплодируем докладчику спасибо"
}