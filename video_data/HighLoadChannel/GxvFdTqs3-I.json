{
  "video_id": "GxvFdTqs3-I",
  "channel": "HighLoadChannel",
  "title": "Повышаем живучесть Raft в реальных условиях / Сергей Останевич (Tarantool, VK)",
  "views": 227,
  "duration": 2647,
  "published": "2023-10-06T07:15:23-07:00",
  "text": "спасибо Ну как Женя уже упомянул я Сергей саневич Я работаю в компании VK над проектом Тарантул и В сегодняшней презентации я вам расскажу о том как мы имплементировали алгоритм рафт в наших условиях для того чтобы все рассказать я начну немножко вкратце про рафт Потом расскажу про особенности репликации Тарантул И после этого расскажу С какими проблемами мы боролись и каким образом рафт это алгоритм для достижения консенсуса в распределенной системе и собственно его предназначение чтобы ваша система работала более или менее однозначно чтобы у вас не было ситуации когда вы обратились в Один узел у вас одни данные вдруг на другом узле у вас другие данные необходимо каким-то образом обеспечить довольно прост Почему собственно его огромная популярность он обеспечивает консистентность ваших данных путем выбора одного единственного лидера на весь кластер который будет обеспечивать запись данных и как следствие записи данных между собой не будут перемешиваться о чем собственно дальнейшая описание будет вкратце при этом алгоритм вводит некоторую терминологию которая тоже сейчас расскажу то есть алгоритм развивает время на некоторые куски которые называются Терм и в рамках этого куска времени он обеспечивает нам наличие всего одного лидера каждый из выбранных лидеров записывает все записи которые вы подаете в кластер в специальный журнал и этот журнал распространяется по всему кластеру при этом гарантируется что эти записи будут идентичны на всех узлах записи пронумерованы некоторым последовательным номером который мы просто называем локоть вкратце о том как алгоритм работает изначально все узлы в вашем кластере стартуют в состоянии фолловер то есть они готовы слушать От текущего лидера что там происходит и что им нужно записать если некоторое время ничего не никаких никакой информации не приходит они приходят в состояние кандидат и первым делом повышают свой термин на единичку рассылаю всем вокруг Я хочу стать лидером если по прошествии определенного времени собственно который предназначено для прохождения выборов узел так и не получил ответа то узел возвращает в состояние фолловер и продолжает ждать появление лидера Однако если он сумел собрать достаточное количество голосов для того чтобы стать лидером Это означает что все Точнее так большинство но участвующих в вашем кластере проголосовали за него он переходит в состояние лидера начинает принимать запросы на запись он остается в состоянии лидеров вплоть до того момента пока кто-нибудь из этого кластера не скажет что у него термо выше чем у этого лидера и лидер вынужден снять себя полномочий и возвратиться В состояние фолловер все На этом собственно весь алгоритм закончился при этом алгоритм обещает нам следующие гарантии в каждом из термов у нас будет ровно один Лидер каждый из лидеров производит запись в наш журнал последовательно он не пытается откатить назад предыдущей записи или что-то еще каким-то образом модифицировать журнал То есть он дописывает журнал записи последовательно этот в свою очередь позволяет нам говорить о том что все что записано Однажды в журнал везде будет одинаково что прописано в следующих фактически трех пунктов о том что у нас записи с одинаковыми номерами совпадают во всех журналах о том что любой следующий Лидер видит все записи предыдущего лидера и не будет каким-то образом там менять и наконец третье что запись применена на одном сервере будет точно такой же на всех остальных серверах если это все вот этот большое с более-менее сгруппировать то эффективно мы получаем для нашего использования кластера буквально следующее что Лидер в кластере рано или поздно найдется то есть выбор пройдут выборы пройдут ровно с результатом что нам появится один Лидер и это соответственно обеспечить нам все предыдущие гарантии и второе что в пределах одного этого тюрьма у нас никогда не появится два лидера это тоже важно потому что иначе они вдвоем одновременно могут производить записи это может нам всё нарушить Ну все конечно хорошо когда вы применяете этот алгоритм с теми ограничениями которые там введены в частности очень часто кластер рубят любят устанавливать в двух обрабатывающих центрах и если вы оказываетесь ситуации что один из центров у вас приходит негодность фактически ровно половину кластера вы выключаете и алгоритм не может сам выбрать лидера потому что в этом месте большинства нет то есть абсолютно большинства Нет об этом завтра я вам очень рекомендую послушать доклад первым докладом в шестой шестом зале Сергей Петренко будет рассказывать как раз вот про о том как мы позволяем эту ситуацию разрешать но не бесплатно поэтому про ограничение надо помнить и ограничения дополнительные которые существуют в оригинальном рафте это что в классе должна быть нода которая имеет необходимое количество связей с другими нотами чтобы выиграть выборы и второе что у нас вот такая времянка по времени прохождения информации по нашей сети во-первых время которое мы устанавливаем как необходимое Время ожидания до следующих перевыборов фактически это время фейловера то есть у Вас например сломался мастер через какое-то время кластер должен самоорганизоваться выбрать нового мастера и соответственно с этого места у вас опять кластер будет доступен на запись это фактически вы устанавливаете Но это время нужно установить побольше чем время прохождения по сети иначе вас просто постоянно не будет завершаться процесс выборов Ну и третье это то чего так хотелось бы чтобы оно ушло вообще в бесконечность это чтобы у нас сеть не ломалась чтобы у нас машины не падали чтобы там трактора не работали поверх наших оптических сетей Итого мы сталкиваемся с самой неприятной вещью рафт нам все пообещал там все было по пунктам Но это было чисто математическое обещание Дело в том что Терм который упомянут неоднозначно связано со временем то есть Терм это некоторый кусочек во времени но больше ничего не сказано как они там плотные друг идут друг за другом может быть они пересекаются ничего об этом не было сказано поэтому приведем пример вот у нас очень простой кластер из трех нот желтая нота это лидер Он находится в Терме 15 он Лидер все его признают все получают от него соответственно записи которые он принимает и тут у нас он отваливается по сети оставшаяся вторая и третья ноды выждав тайм-аут для выборов спокойненько проводят выборы третья нода выбирается теперь она Лидер в Терме номер 16 но до 2 знает что он лидер лидер в термина номер 16 все теперь записи принимает третья нода но на первую ноду по-прежнему ходят клиенты и этот Лидер если он использует синхронную репликацию как она реализована в тарантуле скворной записью никогда не сможет набрать кворум на запись никогда не сможет подтвердить клиенту Да все я принял твои данные он будет либо просто молчать либо отвечать ну знаете нет возможности тайм-аут это очень неприятная ситуация потому что фактически половина ваших клиентов могут видеть что у вас Лидер один вторая половина может видеть три фактически мы получаем либо если мы работаем асинхронной репликацией в случае синхронный соответственно все клиенты номер один будут висеть в ожидании и отваливаться чего бы нам хотелось Ну во-первых чтобы Лидер не просто был выбран в какой-то Терм за какое-то время чтобы его можно было выбрать быстро чтобы это процесс то есть мы во-первых мы ждем сколько-то времени прежде чем мы начнем выбор а потом еще сколько-то времени выбираем второе Мы хотели бы иметь не более одного лидера в кластере не в какой-то там эфемерный Терм а конкретный момент времени чтобы у нас в классе никогда не было двух лидеров и третья проблема про которую я отдельно здесь проговорю если мы отключим ноду и подключим её опять это запросто может привести к снятию себя полномочий лидера пока мы тестировали наши реализацию без всех настроек которые я про которые сегодня рассказываю мы выяснили что наши клиенты Ну хорошо тестирует вот если вспоминать предыдущий доклад Сергей Бронникова они тестировали лучше лучший способ тестирования иметь побольше клиентов давать им сырую технологию и они вам все тестируют найдут проблемы когда они построили кластер нифуешь А вот так вытянули линеечку они сказали Ребята у нас какая-то проблема у нас бесконечные перевыборы мы начали на эту тему копать и почти сразу накопали такая же ситуация случилась в cloudflare в двадцатом году причем Cloud Flare использовал базу данных itcd в общем-то очень распространенную известную всем очевидно было что проблема решать надо что ж перейдем ко второй части расскажем про то что у нас в тарантуле из особенностей репликации во-первых то как это описывает рафт журнал в кластере ведется с единым индексом который записывается каждым следующим лидером последовательно то есть на картинке я постарался изобразить не знаю насколько удачно два туда две ноды то есть наверху одна нода внизу 2 лидером в первом Терме была первая нода желтенькая она сделала две записи это желтенькие 1 и 2 во втором под после чего она потеряла лидерство по какой-то то не было причине нодой лидером стало нода 2 сделала одну запись После чего первая нота забрала лидерство назад и сделала еще три записи мы видим что влоги это выглядит Раз два три четыре пять шесть они как бы сквозные они подсвечены Но на самом деле влоги об этом никакой информации в общем-то рафт не требует Главное чтобы эти записи были сделаны последовательно чтобы они везде реплицировались одинаковые были Тарантул исходно был разработан для поддержки мультимастера Это означает что у вас одновременно в кластере Бога находиться несколько пишущих нот и соответственно они должны писать с каким-то своим собственным лсм поэтому была введена такая терминология именование журнала влог это векторные часы которые просто записывают помимо того что порядковый номер записи еще и Собственно сам это монитор Ага собственно и сам узел который делал эту запись поэтому желтые записи у нас получают первые идентификатор единичка нода на 1 сделала первые две записи потом надо два сделала следующую запись И после этого нода номер один продолжила со своей нумерацией 3 4 5 в этом собственно и есть суть этих векторных часов которые записывают записи в каждом из в каждом из инстансов ваши базы данных идентифицирует это в общем журнале Если обратить внимание то сумма по всем компонентам влог А вот последний Да все равно и все равно 6 То есть их столько же первая нота сделала пять записей вторая надо сделала один Ну собственно Оно так и есть это такая особенность просто мы ее запомним вторая особенность это рассылка данных от всех ко всем в рафте записи которые сделал лидер Он рассылает всем кто его слушает это все То есть если мы сделаем запись на узле номер один слева рафт справа Тарантул то запись сделанная на Первом узле по репликации доедет до второго узла Как видите он там появилась единичка красненькая то же самое сделает Тарантул доедет по первой компоненте Вы клока во вторую ноду Однако на следующем шаге рафт классический ничего не сделает потому что связи между 1.3 нет и эта запись не попадает в третий журнал 3 ноды Тарантул при этом распространяет эту запись опосредованно то есть мы реплицируем ото всех ко всем фактически То есть если у меня в журнале появилось что-то я это обязательно отдам соседу не важно я это записал или нет и наконец последняя третья особенность которая у нас есть в тарантуле это что результаты голосования за кандидата в лидера Мы распространяем не только лидеру но мы распространяем всем нодам то есть мы отправляем ответ опять таки broadcast поэтому все участники знают о том что надо номер один была выбрана в качестве лидера более того в этом месте у нас есть потайной карман мы можем добавлять в сообщения дополнительную информацию без нарушения обратной совместимости То есть если у вас стоит власть ресторанкулов и туда вводите новый узел и он вдруг начинает расширенные сообщения посылать расширенные ладно вот если новые Но об этом впереди Итак перейдем к обсуждению тех проблем которые у нас были и что мы сделали для их решения во-первых недоступность кластера после восстановления связности допустим у вас был кластер Ну все точно также желтая Лидер остальные ее слушают допустим отвалилась какая-то совершенно левая нода Ну вообще то есть она она не Лидер она не принимает активного участия вообще в жизни кластера То есть она является Возможно там с нее делают чтение или она является запасным игроком После того как она не видит лидера какое-то время она начинает запускать выборы первым делом повышая себе Терм Ну Софа сугут потому что как бы ну повысил тюрьму Ладно сидишь там опять дождался нет никого еще раз повысил все нормально Однако когда мы восстанавливаем связность этот термин доезжает тут же до лидера и все что он может сделать в этом случае по рафту снять себя лидерские полномочия и следом должны будут запуститься выборы на этот промежуток времени мы получим кластер закрытый на запись мы не сможем писать это очень неприятная ситуация хотелось бы чтобы ноды которые пропадают потом назад появляются не валила за собой весь кластер хотелось бы чтобы если это нота сидит Вот и ждет на своем Терме 3 ей никто не отвечает она ждет и никто так и не отвечает она так и не стартует выбора а когда у нее восстанавливается связность она узнает что Лидер уже есть и собственно что тут стартовать Поехали дальше Кроме того есть вторая проблема ровно с тем же самым ровно с той же самой как это называется исходной точкой сервер который просто физически вот прям напрямую не видит лидера будет постоянно его прерывать Подходим к той проблеме про которую говорил довольно популярная компания столкнулась и билась над этим что-то в районе шести часов очень было неприятно в чем была проблема был нормальный кластер из трех нот разорвалась связь между первым и третьим всего-навсего то есть не полная катастрофа третья нот горит А где мой Лидер Я хочу это давайте жить уже нормально повышает Терм запрашивает у второй ноды Давай голосование второй надо говорить ночью собственно тут у меня 3 этот хочет 4 Давай вперед теперь у нас Лидер стал третьим второй снял себя полно первый снял с себя полномочия и буквально через тайм-аут на выбор говорит погодите А где Лидер говорит у меня Терм 5 Ну и пошло-поехало Да весь кластер все время занимается только тем что пытается выбрать себе лидера вот ровно с этим Значит Пришлось столкнуться даже боевой ситуации в Club значит и как хочется при этом видеть ситуацию как только нода которая не видит лидера говорит Давайте давайте голосовать ей кто-то берет Ну кому она прислала погоди погоди погоди Лидер У нас есть все нормально и тогда соответственно это надо говорить а есть ну тогда ладно все все как жизненно то есть мы хотим чтобы действующего лидера со Зря никто не принимал не прерывал то есть когда у нас есть возможность продолжать лидерство Пускай он будет мы видели три варианта решения и первый вариант описан практически Один в один в основополагающей статье Диего Ангара про рафт можно перед началом выборов например запускать предварительное голосование то есть не повышая тем рассылать сообщения а давайте может быть это я бы хотел бы повыбираться и вот как раз на такое сообщение отвечать не надо не надо у нас есть Лидер и тогда если тебе ответили что Ну да давай будем голосовать Ты стартуешь нормальные голосование после получения корма соответственно сможешь стать лидером проверим работает или нет Вот у нас стоит значит 3 Ну да оторванная запускает в ожидании кворума хочу значит предварительные выборы Да хочу хочу голосовать и никто не отвечает она не может набрать необходимый кворум для тех кто за неё в принципе может проголосовать так оставаясь в Терме 3 соответственно если связанность восстановить никаких выборов не произойдёт а теперь вы пример номер два собственно Когда у нас Мы не видим лидера и точно также Мы спрашиваем У второй ноды Может это того по голосуем а вторая надо говорить нет подожди Лидер У нас есть так что не надо есть одна проблема это требует введения новых типов сообщений Это уже не сообщение о выборах это сообщение давайте начнем выборы Если да то тогда уже сообщение о выборах это нарушит нам обратную совместимость поэтому мы решили что этот путь нам если он и подойдет то уж как бы запасной подождем Посмотрим может быть есть что-то еще мы пошли посмотреть другие варианты в принципе можно было бы игнорировать выборы голосующими которые видят лидера но если рассматривать ситуацию вот с полным отрывом и соответственно если я вышел в терн номер четыре и если мне кто-то присылает этот термин номер четыре это я его игнорирую не не как бы Лидер есть Однако если я пришлют самому лидеру это приведет к тому что Лидер с ними себя полномочия соответственно решение не является полным и тоже не захотели его делать но зачем нам половину решения мы пошли в ту степь про которую про секретный карман про который я говорю За счет широковещательной рассылки в даже не применяя никаких дополнительных сообщений просто за счет сообщений которые у нас идут для поддержания текущей репликации то есть мы регулярно либо рассылаем данные либо присылаем друг другу пинги в этот Пинк можно положить еще информацию о том Кто у нас лидеры вообще какой термо вообще что вообще как там это политическая ситуация в классе сложилась соответственно туда добавились эту информацию и если кто-то из тех кто присылает нам информацию прислал Лидер жив Значит все что выбираться-то лидер-то где-то там есть где там и главное что данные как я вам сам тоже рассказал данные через кого-то через 3 к нам конечно приползут проверим а может или нет в этом случае Значит у нас как только восстанавливается связность у третьей ноды с данными которые реплицируются ей приедет информация до сих пор является лидером во втором случае который был у Клауд флэр вообще эта информация постоянно будет приходить вне зависимости от того если видимости лидера напрямую поэтому мы решили что ну это решение эквивалентно тому что в предварительных выборах зато мы сохраняем обратную совместимость Ну так мы и сделали в общем-то это все уже у нас в Мастере и можно использовать вторая проблема которую я хотел бы подчеркнуть это сплитву detection это ровно про то что выборы у нас могут длиться по рафту счастливым окончанием но без гарантий по времени то есть вообще неизвестно когда они там между собой берутся и так далее К сожалению мы можем получить долгую недоступность кластера на запись после потери лидера просто потому что каждый раунд выборов в результате которого голоса разделились между нотами кандидатами таким образом что ни один из них не брал абсолютно большинства заканчивается запуском нового раунда Но прежде чем новый раунд будет запущен Мы выжидаем полностью весь тайм-аут мы должны дождаться до конца мало ли может кто-то еще сейчас нам принесет там их решающий голос как сейчас это вот нет не Филадельфии где у них там сейчас последний голос и никак не посчитают они вот вот мы его несем у них тайм-аут там чуть ли не до нового года Ну нам так это не подходит Да вот поэтому мы не хотели бы ждать этот самый Хотя если выбор успешный То есть если кто-то набрал прям вот сразу большинство то это происходит очень быстро потому что время пинга она очень маленькая по сравнению со всем остальным и выжидать вот весь тайм-аут для выборов нет нужды вот если голоса разделились тогда Мы висим и ждем очень неприятно Ну что ж у нас есть широковещательная рассылка отданных голосов осталось только все ноды научить их считать как только ты сидишь на ноги и видишь что у тебя три голоса у другого три волоса а всего голосов Извините 4 ты сразу же понимаешь что дальше ждать голосования нет смысла соответственно если ты ведешь подсчет голосов за всех Adidas Ну допустим Если у вас три кандидата и голоса разделились Так что между двумя из ними уже между двумя нодами разделилась большинство голосов очевидно что большинство уже не наберет вообще никто можно тут же стартовать новый новый выборы Поэтому собственно это нам удалось реализовать и это дало нам до 90 процентов экономии времени вот для таких раундов выбор когда голоса разделились и невозможно выбрать честным голосованием приходится там ходить подтасовывать и наконец третья надстройка которую мы сделали это фенсинг ну название фенсинг конечно не совсем Уместно я сразу и предвосхищаю большое количество вопросов как бы фенсинг это скорее защита от старых записей но в этом месте мы пытаемся избежать на самом деле появления двух лидеров в один момент времени Итак есть у нас есть текущий Лидер то в разных тюрьмах мы все равно как мы видели можем получить сразу два лидера и мы бы хотели этого избежать то есть вот один Лидер в термин 15 другой в тюрьме 16 и очень нехорошо было бы если бы наши пользователи по-прежнему Ходили бы к нему и все бились бы и там в зависимости уже от схемы данных как мы выберем да или там синхронная репликация тогда она не едет либо это асинхронно и тогда третий Лидер Просто может все это перетереть потому что ну там Бог его знает что там было значит Кроме того только что упомянутое приводит которые позволяет нам информировать о существовании текущего лидера может привести нас в состояние заблокированного кластера заблокировано конечно же на запись допустим в нашей конфигурации была пять узлов один из которых вышел из строя Но это было только начало проблем потому что дальше у четвертого узла отвалились все связи Ну точнее так кворум связи отвалился у него остались какие-то связи достаточно для того чтобы распространить на кластер информация о том что он лидер Он Лидер Но если в него пытаться писать записи либо не будут получать коварного подтверждения Ну то есть вы не сможете произвести записи будете отваливаться либо этому лидеру надо просто куда-то сойти дорожки но при этом никто из нот первой второй и третий не может запустить выборы потому что Лидер известен значит из вариантов решения которые мы рассмотрели были следующие Значит мы можем расспрашивать все ноды Каково мы видим про текущий термины состояния или дерон или нет Если найдем Лидер рассказать А ну Лидер есть переложить определение этого самого лидера на кого-то Извне Но это как бы я сейчас это расскажу тогда подробнее чтобы не это самое значит вот первый вариант Когда мы определяем и спрашиваем всех подряд Лидер или нет не решает проблемы заблокированного кластера потому что лидеры есть одной известен при этом время недоступности на запись увеличивается потому что прежде чем мы начнем определять Кто у нас Лидер это потребует дополнительного времени Вот и все клиенты которые будут ходить в классе должны будут реализовать Это для того чтобы опросить А кто там вас сейчас Лидер текущие как бы а термо тя какой да А вот все самый большой Терм нашел я в него буду ходить Но это все равно это реализация во всех клиентах будет занимать достаточно много усилий второй вариант Как переложить на дополнительную систему ну как бы это не очень хорошо потому что у нас инсталляция появится еще одна система что само по себе не хорошо вот это будет какая-то сторонняя точка отказа про которую мы сами не знаем вообще как она хорошо Нет мы что-то знаем а про вновь поставлено значит и осталось последнее То есть как бы хотелось как бы нам хотелось это сделать в тарантуле значит во-первых хотелось бы оповещать лидера но проще всего оповестить лидера клиента но проще оповестить если он как к тому кому обратился скажет что я больше не Лидер извини все и может быть еще сообщил Кто лидер в таком в такой конфигурации точно так же лидер номер четыре говорит А я больше не Лидер всё как бы ко мне больше не ходить и тогда запустится выборы и соответственно Лидер который следит за своими соединениями может сразу же сказать А у меня вообще нет формы Я больше не могу подтверждать ничего поэтому я не буду лидером давайте я буду снимать себя полномочия когда мне не хватает форума на записи например мы рассмотрим простой вариант вот у нас три ноды Лидер что-то пишет время пока эта запись доезжает до его фолловеров оно некоторые пока от фолловеров доезжает назад ответ оно тоже некоторые квадратики вот эти зелененькие квадратики тайм-ауты У лидера был тайм-аут на репликацию допустим он получил ответ как раз тот самый окончание но тут же после этого случилось разрыв сети и тайм-аутере один начался немножко раньше чем вообще-то У лидера появилось сообщение о том что все нормально и он до сих пор легитимен поэтому по прошествии этого тайм-аута фолловер 2 запустит выборы сети нет follower 2 с фолловер M1 очень быстро могут договориться потому что у нас там ускоренные выборы все уже рассказал их всего двое например и мы получаем что между 2 и Т3 У нас существует два лидера одновременно неприятно какой крайний случай Мы можем рассмотреть Когда у нас сообщение от лидера до фолловера летит очень быстро а назад летит ровно столько сколько у нас вообще тайм-аут и это значит что Лидер получит от нас весточку ровно тогда когда у него закончится его перевыборная этот самый период и нам чтобы не начинать новый выбор надо иметь удвоенный тайм-аут что собственно мы реализовали то есть для на фолловерах если на фору их поставить тайм-аут в два раза больше то перевыборы запускаются позже после того как Лидер уже снимет себя полномочия при этом мы решили сохранить обратную совместимость даже с тем решением которое у нас было до сих пор поэтому мы обозвали это отдельным конфигурационным параметрам fensing который может быть либо вообще выключен либо быть слабым это когда у нас эти самые таймауты равны и собственно то что было на исходной картинке с красным этим перерывом связи Ну или наконец Мы можем поставить более сильный фенсинг он приведет немножко немножко большему периоду перевыборов то есть файловер немножко замедлится Зато у вас будет гарантия что двух лидеров хоть в разных формах не будет Итого ожидали мы буквально следующего мы получили буквально то же самое то есть Мы надеемся что то что мы реализовали будет иметь большой практическую значимость Мы очень надеемся что Тарантул станет вашим решением Ну а по поводу доклада Вы можете обращаться на страничку или находить мне в кулуарах Пишите в Telegram чат у нас поддержка Спасибо большое Отлично просто Просто отлично друзья я напомню Всем нашим онлайн слушателям что у нас есть чат в телеграме куда можно задавать вопросы нужно задавать вопросы потому что за лучший вопрос мы даем подарки и обязательно я буду зачитывать вопросы вашей из онлайн Я надеюсь они будут И даже если лучше вопрос станет вопросом из онлайна то мы все равно сделаем так что подарок онлайн слушатель получит друзья вопросы Из зала ручки вверх Добрый день два вопроса Первый вопрос пытались вы как-то решить проблемы связанные с лэттенсе да то есть ну с геораспределенных кластерах каким-то образом увидеть и часто бывает с этим проблем и второй вопрос Когда вы рассказывали про вокуок Не совсем понятно как При таком клоке вы соблюдаете консистентность потому что ну Насколько я понял из термо и ЛСР на каждом из мастеров как получается не путать порядок записи При этом Ну начну про гео распределения специальных решений Мы конечно не делали но конфигурирование выборов и конфигурирования репликационного тайм-аута позволяет вам довольно как это сказать гибко управлять тем Каким образом то есть например у вас две два дата центра причем один из них находится где-то где вы считаете что это Например в Москве Чтобы проще второй в Новосибирске вам очень не хотелось чтобы в Новосибирске вдруг выбрался Лидер потому что как бы туда очень далеко перенаправлять клиентов которые в основном ходят сюда Для этого просто делаете тайм-аут на перевыборы в Новосибирске побольше А на тех узлах которые в Москве Ну чтобы они там быстренько могли как-то других решений специализированных у нас как правило Нет ну потому что мы полагаемся на стандартные сетевые протоколы мы полагаемся на то что сеть это более низкий уровень нежели наши алгоритм который будет реализовывать консистентность и про We clog значит исходя из того что у нас в кластере всегда только один Лидер это уж мы пытаемся гарантировать ростом Это значит что записи последовательно могут идти только от одного лидера вновь запускаемые записи предваряются одной специальной записью промоутер то есть прежде чем будет записан промоуд другая нота писать туда не может Поэтому у нас все записи будут записаны как бы упорядочены по там по той ноте которая пишет фактически по терму есть особенность рекомендую очень завтра с утра повторюсь прийти послушать Сережа Петренко в шестом зале по поводу ровно вот этих вот промоутов и по поводу термов и как это вообще происходит и как следить за тем если у вас вдруг случился Не дай Бог они потом там подружатся Что там с данными будет вот чтобы этого избежать Сережа завтра расскажет отличная история создали небольшую интригу Да дальше вопрос у нас был здесь командная игра Здравствуйте спасибо за доклад У меня полуоттический вопрос про первую половину Где вы рассказывали что нету прямые связанности до лидера и между злами и так далее И мне не передалось время мысль А что если просто перенести эту проблему по-другому не трогаем Раб а учим узлы типа быть слегка коммутаторами когда теоретически у нас остается связанность Вот вы говорили мы просто ему сообщение все это выглядело как по сути наследование психических пакетиков сети и выглядит как что если условно вот этот сетевой уровень как бы чуть-чуть отнести то все этих проблем нет и не нужно пытаться поочить это сам раб Ну фактически только что вы говорите то же самое решение что мы сделаем Просто мы его сделали фокус на рафтовые сообщения и соответственно Вот вот рафтовые сообщения мы как это называется пробрасываем на соседние узлы и этого нам достаточно если мы будем пробрасывать на соседний узлы вообще все я думаю что это будет очень большой увеличение трафика просто не совсем все вот именно такой так сказать вот какой-то прикладной слышать сетевой уровень видели что кажется эти решения можно использовать проблемы не уникальные думаю для роста и вот эти решения может быть при использовании в других алгоритмах банальных скорее всего не могу ничего на эту тему ответить Я считаю что прикольный Я считаю что вот то что мы реализовали оно фактически то же самое Просто вы предлагаете перенести на другой уровень ну у нас рафт Поэтому нам Мы ростом ограничились спасибо Мне очень понравилось в вопросе фразы если исключить сетевые проблемы если исключить сетевые Проблемы то в принципе в распределённых системах проблем Мне кажется нету Вот мне кажется где-то там у нас был ещё один вопрос прав я руку поднимите там еще где-то в середине Привет Большое спасибо за доклад смотри у меня два вопроса Первый вопрос Вот ты сказал что у нас теперь Лог он в общем каким-то образом разделяется и мы отдельно получается храним ну как бы записи которые отправляла нам один Лидер в каком-то Терме мы просто помечаем типа их парой Да просто вместо лсн который вот одно число последовательность 100 запись на запись но до 2 5 запись дальше И тогда получается определение того что за комично какая-то команда на общем не меняется то есть абсолютно то что это просто нумерации возникали какие-то проблемы с тем чтобы применить вот из HD алгоритм который для конфигурации то есть Был ли что-то интересное когда пытались менять количество пла про реконфигурацию могу сказать Ну просто боюсь если у нас достаточно времени Ну я очень коротко отвечу реконфигурация записывается в э системной Space это является данными они реплицируются Если вы хотите произвести реконструкцию вам нужно быть лидером Если вы Лидер то записав новую ноду себе в список кластеров вы автоматически повышаете себе кворум о'кей и это по сути как будто мы просто в наш Лог в общем-то добавляем служебную команду конфигурации Окей спасибо Серёж У нас есть онлайн вопрос Ох уж эти ваши технологии не говори распределенные сетевые между прочим возможно Я прослушал А у серверов есть приоритет приоритет чего Перед чем Ну например задавайте каждому серверу приоритет например первые 10 второй 5 3 1 и когда отвалятся 2 и 3 нода но до с приоритетом 10 будет всегда лидером Ну отчасти это ровно то что я уже однажды только что отвечал да мы можем настроить тайм-ауты на перевыборы мы можем нескольким нодам Назначить тайм-ауты на перевыбор очень короткие поэтому они будут первыми забрасывать Я хочу стать лидером по факту приоритет регулируется Да такой неявный Это скорее конфигурационные вещи которые нам нужно наверное проработать в качестве готового решения потому что пойти до этого там докопаться в потрохах конфигурации Тарантула там конфигурационные возможности очень большие и Давайте на задних рядах еще был один вопрос Здравствуйте Сергей спасибо за доклад вот в первой половине мы как бы описывали уже реализованы китаеристики Вот Потом мы придумали какие-то свои чтобы решить проблемы микрофончик чуть-чуть поближе возник такой вопрос как в это не знаю либо пытались формально доказать либо тестировали что Вот точно точно эти в листики работают нет никаких там багов в коде Ну на самом деле формально верификации не самого алгоритма реализации алгоритма мы не делали Не новых вещей тоже нет формальной верификации мы не проводили вот однако все наши реализации они основаны на той же самой статье Диего Ангара и используют те технологии Тарантул которые фактически оттестированы уже годами использований Так что ответить мне к сожалению формально про формальную верификацию ответ ее нет заложились на то что вот есть статья Ну вроде кто-то проверил и считаем что это правда но мы убили примерно два месяца на мозговой штурм как бы это можно было сломать обломали там вариантов 5-6 которые мы по пути придумывали и эти очередные уже седьмой вариант он был в нашем представлении кажется что то что надо Ну уж найдем или нет клиенты покажут Спасибо большое краткий анонс до следующего highload в Армении в Ереване чем доказывать что рафт работает Вах клянусь тем что там выступит наш сотрудник который работает в другой компании расскажет такую вещь коллеги смотрите Да за докладом друзья Сереж Спасибо тебе большое какой вопрос Лучше а ну так надо из оставшихся выбирать правильно Давайте про формальную верификацию Отлично Да да у нас есть специальные монетки эти монетки сейчас вручаются и с этими монетками надо подойти на стенд Тарантула и там получить тот самый заветный подарочек прошу"
}