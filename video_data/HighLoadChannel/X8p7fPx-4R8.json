{
  "video_id": "X8p7fPx-4R8",
  "channel": "HighLoadChannel",
  "title": "Spark: практика разработки высоконагруженных iOS-приложений / Андриан Буданцов (Readdle Inc.)",
  "views": 972,
  "duration": 3338,
  "published": "2017-04-22T14:47:48-07:00",
  "text": "да всем привет всем кто пришел предпоследнее доклада задержимся от эндриан я тех directory дал вы если у вас есть iphone или ipad вы можете знать про одни из наших приложений делаем pdf эксперт сканер достаточно популярные продукте витте приложение вот у нас делаем их довольно давно у нас 6 достаточно больших а и вас кодовых бас вот в этом докладе я буду рассказывать про spark это не апачи spark open source проект наше приложение для работы с электронной почтой вот мы задумывали написать почтовый клиент еще в 2009 году довольно давно потому что бизнес и продукте ведь это наш профиль и в принципе почтовый клиент такая достаточно важное приложение с которым многие люди работают изо дня в день и нам казалось что на ниве почтового клиента нам здесь что сделать есть достаточно интересные листики которые можно попробовать и улучшить работу пользователей с почты и последнее время становятся мы дне машин your link и со временем мы рассчитываем на то что внутрь почтового клиента можно перенести что-то по-настоящему умная вот кодовое название этого проекта была smart mail незадолго перед релизом команда маркетинга выбрала названия spark вот а вы все знают что на ios уже есть один почтовый клиент и львиная доля людей именно ими пользуется поэтому чтобы у нашего клиента был какой-то шанс и был юзер bass то как бы для конкретного пользователя мы должны заменить как бы стать лучше чем стандартный почтовый клиент вот и в принципе тяжело наверное сказать что наше приложение с лучше стандартного если она работает не достаточно быстро поэтому обеспечить то чтобы наш spark работал достаточно быстро это было для нас приоритетом вот как мы в принципе определяли то что spark достаточно быстрый в принципе такие три можно выделить способа ну во-первых субъективная оценка как только приложением можно было пользоваться мы сразу начинали пользоваться им самим на самом деле цикл разработки был больше года но примерного уже там через четыре-пять месяцев после начала разработки мы как бы приложение читала почту получала отправляла и в офисе многие сотрудники показали почту не установили и получали фидбэк от других разработчиков команды поддержки в общем от тех кому как была небезразлична то чем мы занимаемся вот поэтому как вы проверяли на себя и как только видели что в каком-то месте почта работает не так как вы привыкли к нам бы хотелось то начинали что-то с этим делать как бы второй источник информации для субъективной оценки это наши бета пользователи у нас очень большая об эта программа по нашим канцелярским другим продуктам по предложениям работы с документами и прочему вот и пользователи привыкли обычно потому что наше предложение работают быстро так что мы тоже получали эту информацию от пользователей но это были бета пользователи поэтому мы как бы благодарны им за эту информацию и это позволяло нам обратить внимание на узкие места задолго до релиза приложения вот а дальше как бы более эффективные способы николай вы в докладе до меня уже на них останавливался инструмент xcode в основном конечно это там part-time профайлер вот energy лоб в принципе сейчас работа энергоэффективность такая важная вещь поэтому косвенно данные из этого инструмента тоже полезны при анализе производительности по тестам вот во первых это в иксе тестах бы стандартный метод большой блок вот для он запускает некий блок кода который предоставляется 10 раз вот потом можно результатов и запуска установить качестве bass line а то есть какого то вот минимального уровня с которой этот блок должен работать вот этот bass line такой определенный файлик формата джейсон лежит внутри файла с проектом его нужно не забыть зовет комментить закомитить в репозиторий вот и потом при прогоне тестов как бы можно рассчитывать на то что новый код не должен становиться медленней вот обычно этот беслане содержит характеристику конкретного устройства на котором запускался тест такой менее наверное статистический чистый способ мы начали пользоваться раньше это в нашем тестовом фромборке на ваш собственный маршрут блок в котором можно лимит указать в коде там нету такой четкой привязки к девайсов как в иксе тесте но в принципе намного проще пользоваться и в данном случае это скорее такая защита вот с большой разницы то есть как правило мы ставили время которое на наших бил серверах время за которое там выполняется код поэтому большая разница может быть на порядок может быть два раза она принципе бросается в глаза там тесты лица вот не существенное замедление или ускорение в принципе лето в эстонии и принципиальные вот и как бы третий фактор это в принципе тесты не связанные сами по себе с перфомансом это и white с ты когда нам просто of некий автомашин кликает на приложение отправляет письма получает письма как бы это не там график не основаны на реальных данных просто примерно показывает феномен когда мы делаем приложения быстрее то нашего теста работают быстрее вот появляется некая ступенька когда становится заметно то что стало лучше или стало хуже то есть обычно там приятно когда киеве команда говорит о том что а вот такой феномен людей смогли наблюдать и он говорит о том что теста стали работать быстрее приложение стало работать быстрее вот дальше как бы тоже такой важный нюанс и которым хотел упомянуть тем более что там за через одного докладчик когда меня об этом говорили в целом вот нашем случае производительность нашего кода она как правило связано с энергоэффективностью то есть мы считаем что чем быстрее работает очень мы написали тему она работает скорее всего эффективнее в случае с живу металлом там наверное можно разогреть процессор используя большое количество потоков вот в нашем случае если что-то работает медленно скорее всего делается какая-то лишняя работа поэтому когда в приложение выбираем источники неэффективности то это положительно влияет и на батарейку критические места какие у нас мы выделили в спарке да вот начну с таких вот самых заметных заменой самое заметное то просмотр вот то есть даже если там как бы пользователя ios привыкли к частоте 60 кадров в секунду поэтому если кадр там где-то занял больше чем одна шестидесятая секунды это уже заметно потом обработка почты там пользователя отправили письмо мы письмо скачиваем там проверяем вот на нем работают наши листики получаем из этого письма там ссылки даты подписи выделяем блоки где кто-то цитировал кого-то вот и в принципе вот на первом запуске мы делаем это для большое количество почтой там или первые запуски или запуск после перерыва вот в процессе использования на одиночных письмах это не так заметно но в целом если код к работающей с текстовыми данными в письме работает неэффективно это тоже нагружается и в том числе и батарейку вот но и получение почты то есть именно вот такая часть когда всего скачивается вот это связано с сетью и тоже связано с холодным стартом отправили письмо он знает что вы уже отправили или ему пришел push и и письма еще нету в целом это тоже такая такой простор для оптимизации вот я начну в том же порядке с конца вот с тем чем мы столкнулись в просмотре почты вот ну наверное в просмотре почты вот нашем приложении самая важная часть это фредбер то есть когда вот уже заходим в конкретное письмо его читают вот-вот трэверс парка вот его томск роль от и вот тут можно заметить то что в это время скролла вот он подтормаживает я специально записал видео которое так вот замедлением и чтобы примерно вот можно было понять о чем идет речь может быть на большом экране там пропуск кадра не так вот существеннее но в руках это чувствуется особенно там пользователя ios привлекли к очень хорошему performance у как что вы как бы здесь происходит наша первоначальная реализация она использовала его и collection я и лейбл и внутри это всё ли я училась автореал там вот white collection возьмем эти письма все лежат одно за другим письма которые текстовые то есть подавляющее большинство переписки живых людей это текст вот и мы этот текст устраиваем выстраивали разными enables вот как бы для того чтобы их выстроить вот так потоком нужно считать их ширину высоту от ширины и либо и ширина там фиксирована но в принципе поскольку строка приходит переменной длины этого высота ее меняется вот и там of the layout дальше собирает из элементов из разных вещей был вот вот такое письмо вот и весь этот процесс работает главном треде то есть вот то замедление кадра которые вы видели это вот результат того что так на главном потоке он его блокируется и вот при скроллинге вот появляется такой артефакт тут есть еще дополнительные причины есть известный феномен усы автореал там то что в принципе когда of the layout относительный относительно родительского то там как бы есть связь его производительности с количеством и вот вот график флориан куглер в себя в блоге опубликовал там него графика перерисовал для презентации вот там более полные данные вот и в принципе тут как бы начинается вот на этом графике 1 . в районе сотни view что в принципе уже достаточно близко к этому практическому количеству с которым мы работаем и там в то же время подбирается 0,4 секунды 035 по моему что в принципе для вот такой вот блокирование потока на это время главного потока это проблема и с ростом количества видел как бы время растет еще существеннее да поэтому как бы вот of the layout в нашем случае явно вот был тем первым камнем преткновения который с которой мы столкнулись и мы перешли вот в обработке писем в строй двери на ручной layout вот там приходилось самостоятельно считать фреймы всех лейбл вот из нас который возвращается she says и в коде лейаута как вот я собьюсь складывали там вот поддерживали переменные и выкладывали и а и лейблы один к другому то есть принципе когда мы знали как это делать и это делалось относительно не относительно общей вьют общем наш код в данном случае работала эффективнее поскольку выполнялось меньше операции они там более были заточены под то чтобы показать письмо вот тем не менее это порождало много кода и с точки зрения до работы как бы вот определение размера или было но тоже происходило на главном потоке и там тоже был некий простор для улучшения вот начале мы как я уже упоминал в четырнадцатом году работать над почтовым клиентом и примерно в этом году летом появился про вот facebook который называется осин дисплей кит вот идея этого проекта очень простая существует некая абстракция над явью или над севером которая основана на in subject из которой можно безопасно работать из любого потока вот там можно получить ее view и там вставить ее в обычную рафию views но вот с этим самым с дисплей ноуту который интерфейс очень похож на view она как бы можно работать с других потоков и как бы позволяет раз проверить создание элементов и а я вот то есть в нашем случае нас больше всего интересовали а из тex ноут то есть это аналог вот твой лэйбл в синтез пакете то есть мы создавали astek сноу то он в новом потоке определял свой размер и в фоновом потоке дальше происходило ялте вот если какие-то картинки были там элементы интерфейса как работа с ними тоже происходит фоновом потоке то есть после того как эта вся работа по вычислению размера текста и в том числе и по вендору текста в картинку будет выполнено уже на основном потоке а тренды реальная картинка ставится во вью это обычно очень быстро вот как бы это очень хорошая и в принципе наш вот так он перешел на саб класс а с range контроллера это такая асинхронная белой collection у которая умеет бэкграунде создавать там дополнительные элементы которые скоро будут показаны но еще не показаны вот и наш саб класса из тex ноут дело в том что так снаут он там нету таких вот вашего простой вещи как выделение блока текста то есть как вот люди привыкли что они на айфоне могут скопипастить кусок текста вот эта функциональность и не было ее пришлось записать вот примерно как она выглядит в йерархии бью то что вот сверху как бы вот эти вот интерфейс выделения кусочков он в данном случае наш собственный там используется обычный view в принципе потому что выделение текста или нету таких вот интенсивных уже в себе sleuth известен просто нужна помощь пользователю выбрать там прямоугольник многоугольник которым будут попадать экс который он хочется скопипастить вот а кроме этого у нас в приложении есть еще такая возможность листать почту то есть когда открыться это письмо можно с вайпами смотреть следующее предыдущее письма как бы так вот таким образом быстро посматривая свой почтовый ящик не возвращаясь к списку писем вот благодаря тому что мы перешли вот начали асинхронный работать с холтом писем то мы там смогли реализовать вот такой подход создавая под низом основной view вот здесь это должно быть лучше видно даже немножко в цвет добавил анимации чтобы видно было свои вот то есть мы под письмом который видит пользователь кладем следующее письмо пока пользователь хотя бы там доли секунды смотрит на свое текущее письмо там уже фоне успевает отрендерится и поместится и вот он следующее письмо которое на которой он flyknit обычно времени пока вот пользователь свайп это достаточно чтобы там все загрузилось вот там на случай если пользователь хочет вернуться то там как бы есть еще слоев и с предыдущим письмом по ю а ю еще такая важная вещь интерфейс мастер лист то есть песка писем там пользователи тоже очень много времени проводят в этой части превышения да вот там здесь показаны тут много целом так вот и есть еще разные режимы то что мы называем smart inbox то что вот обычный входящие вот там пользователи имеют обыкновение по нему вы достаточно быстро скролить это тоже кстати вот вариант видео которые вас небольшими тормозами их видно а если в этом скачаете spark установите к вам iphone и у вас там старше 5 и фона то он будет работать быстрее чем вот в этом видео а здесь несколько проблем на медленных устройствах потому что когда мы начали только писать sparkvue еще поддерживали 4s вот эти все ей w целы вот они по всей видимости в будто мне справлялась с тем чтобы вот обеспечить их быстро скол вот кроме этого мы создаем эти целые более агрессивно чтобы поддержать вы тоже более быстрое сканирование более быстрого переключения между разными table view поэтому когда они вот момент когда они создаются это тоже блокирует немного главный поток в данном случае мы перешли к тому что вот каждый сау конкретный вот этот вот это неё там внутри не собью у него а там реализован гроулит метод который просто как bitmap рисует все содержание цело они в принципе содержание цело не меняется там никак его анимация тоже на него не влияет если что он сдвигается полностью поэтому это позволяет нам принципе отложить работу с содержанием целая до момента как он появится на экране это в принципе целом занимает относительно небольшое количество там площади экрана и рисуется быстро вот поэтому вот вот такой вот метод данном случае он позволил решить проблему хотя потенциально вот синди spiked который упоминал возможно тоже бы здесь показал хороший результат не менее там тракт в целом вот для такой задачи оказался пригодным до перейду к следующей секции обработка почты вот наверное такой вот самом общем виде наш стек обработки почты это был core библиотеках которые мы используем для получения почты на вот поросят расти 822 контейнер в котором почта приходит дальше там может быть хтмл или xml вот дальше мы активно использую рога ксп для того чтобы в письме найти в разбить его на разные блоки найти кто кого цитирует найти там части которая там письмо было от форма решено найти да ты там достаточно много всего ищется вот и мы активно используем steelite для того чтобы работать с базой писем они там все лежат вы скрываете по ним ищем вот я начну вас нескольких таких вот оптимизации которые врага экспертно казались нам полезными первое это альтернативные группы то есть вот там вот сверху большой рога кс в котором сидят разные указатель от того что это там вам это форвард означает то есть это в тексте письма мы ищем на разных языках указания того что там снизу будет перестану текстом такому вот дальше итальянские там разные языки вот там вот эти вот полки означает что вот эти вот там к великому элиту вот на чем будет какой-то одной из двух слов находящихся между этими палками так вот оказалось нам принципе то что если вынести первые буквы из каждой такой альтернативной группы и поставить вот этот вот такую альтернативу в самом начале то это заметно ускоряет вот буквально на 30 процентов на там фиксированном тестовом наборе заметно ускоряет вот меч то есть вначале как бы машина виртуальны регулярных выражений будет искать вот такую работать с короткой группой и только после совпадения вот первые буквы дальше будет идти обработка каких-то из более длинных альтернатив есть это так вот по-видимому лучше работает на частях которая является негативными ответами вот и как бы быть markets подтверждают дальше в принципе тоже такая вещь примерно как наверно при работе с игровыми выражениями простая и дает ощутимый результат то что они срубили expression ну в принципе он так вот компилировать регулярное выражение и после того как регулярное выражение создана лучше от него не избавляться памяти они занимают немного и как бы уже будучи созданными они работают существенно быстрее поэтому если где-то есть код который постоянно создается на своего expression вы здесь есть benchmark но это в принципе не очень часто потому что как бы если мы заменили вещь которая занимала этом некую константу времени а теперь она не создается у нас уже есть готовая то в принципе там будет столько раз быстрее сколько раз мы будем применять это регулярное выражение просто как бы в конкретном тесте которая была у меня получилось так но на самом деле это сильно зависит от количества регулярных выражений и кто и чистоты которые они используются вот в нашем случае это помогло если одиночные регулярное выражение которое редко применяется ну может быть там можно пожертвовать немножко производительностью но в целом так крайне эффективная вещь вот еще пример штуки тоже как бы она не всегда используется это кейс он сенситив части вот то есть вот сверху регулярное выражение которое в скобках вот такими вот префиксом и таким вот суффиксом это на языке регулярном деле акте регулярных выражений используемых во пол означает что посередине вся часть кейса сенситив то есть может использоваться в любом регистре поскольку для unique данных строк кейс intensive это такая достаточно сложная вещь это резко расширяет множество того что регулярным выражением нужно проверять и в целом вот как бы использование кингстон сенситив тогда когда это не нужно может очень сильно замедлить то есть тут в принципе такое позитивном ключе нарисовано как если убрать ненужные то становится быстрее но в общем случае если они нужны и есть там и делает медленнее поэтому если у вас и написано много регулярных выражений то проверяйте нужны ли там кейсом сенситив и по возможности от него избавляйтесь иногда даже каким то конкретном случае проще помочить там два варианта чем вставить как бы лишь некий сам сенситив на всё регулярное выражение вот по слою хранения и обработки данных вот мы в самом начале проекта решили использовать тиски olight чтобы избавиться от лишнего слой абстракции ну как бы не правление cordata не р.м. вот мы используем sql lite амальгамой шин то есть если кто знает как распространяется и skylight вот не тот который встроенный на айфоне лежит а тот иски light который можно скачать исходники они распространяются двух файлах там большой файл ситом килобайт 800 и заголовочный файл exe файл содержит уже себя склеенные все исходники skylight а вот и там по разным причинам сейчас расскажу дальше мы вместе с парком поставляем свой собственный steelite вот для работы с sql lite нам используй объектную модель foundation объекте все мы используем дтп с там в принципе кто работал там способ использовать и стринги там dictionary вот при работе с базой данных он практически не создает никаких дополнительных абстракций просто как бы такое минимальная наверное набор инструмент для программистов и использующих и сделай вот по базе данных да ну в первую очередь индексы стоит упомянуть в принципе так вот но главное не забыть наверное те кто если кто работает со скал этом напрямую в принципе дальше нужно записать кроет индекс создавать индексы понятная вещь в некоторых случаях если запрос там потенциально использовать разные группы индексов на него можно посмотреть используя скрывать русскую команду explain вот он выводит не такую красивую таблицу как это делает маски или этому стоящие серверные базы данных там нужно и уметь читать но в принципе повод expo ну понятно был использован индексы если был такой также важно добавить составные индексы они там тоже есть определенные нюансы того как создавать составные индексы иногда сервера доступны как бы сервер great серверов баз данных умеют использовать первую часть составного индекса для других запросов и это может не всегда сработать вас киева йти то есть опять же надо смотреть за тем там так вот выполняется запрос и используются ли там так составной индекс как вы на то рассчитывали вот и воспевайте еще есть диск индексы то есть индекса которая упорядочивает данные по убыванию то есть списки писем ну пользователю приходится почтовый клиент обычно читать письма с более нового и вниз поэтому вот это как бы идеальный случай для того чтобы создать там диск индекс в общем то так вот для индексируемых данных там будет не супер существенная разница но все таки как бы на какой-то креста проверок меньшей они будут сразу расположены в том порядке в котором которым нужно вот дальше поиски лайту большой раздел full так search то есть у нас в приложении есть поиск писем по тексту по в этом более таким сложным запросом о которая в конечном итоге преобразуется в фулл так все запросы вот всё найти есть расширения они называются авто с вот там их несколько версий вот мы начинали работать расширением фтс 4 вот она была суть уже некоторое количество лет было доступно и работа с фтс 4s парке мы столкнулись со следующими проблемами как бы язык запросов несмотря на документацию не всегда там правильная комбинация необходимой нам комбинация and енотов для текстового сброса вот срабатывало так как мы ожидали то есть не получалось так вот у нас есть группы запросов по нескольким фил там например мы когда ищем письма от одного человека у которого несколько раз на he may love вот в этом пишем эти запросы там использоваться он чтобы совпали эти email и эти имейлы и в итоге он возвращается только одна группа вот дальше при первом запросе sql lite должен почитать фтс яндекс и получается что вот первое обращение к поиску после запуска приложения может занять много времени вот потом такие странные задержки до 10 секунд при индексирования то есть вроде почта индексируется но иногда вот попадается письмо которое добавляется в яндекс дольше в принципе так вот читая документацию поиски лайту этот пункт оказывается документирован то что вот в процессе добавления вот текста в яндекс там внутри skylight может захотеть смотреть несколько бинарных деревьев и это создает нагрузку на оси peewee там действительно речь идет о том что да вот может такое произойти это будет занимать секунды вот в в ts4 там нету еще релевантности на принципе вот на текущий момент мы ее не используем то есть обычно мы считаем что вопрос который мы в конечном итоге формируем он достаточно специфический чтобы пользователю можно было показать результаты просто людей на вот хотя это была бы хорошая характеристика в будущем вот в принципе вот многие из этих проблем они были учтены вот в новом фтс 5 которые вот появился совсем недавно на него просто очень перейти там создавая вот некую виртуальную таблицу для full-text search of using of test 5 в принципе как бы ну он появился с версии 39 поэтому нужно скачать версию 39 из исходников ее нужно скомпилировать с нужным параметрам и skinlite на apple of the space кстати текущая версия уже больше чем 39 поэтому лучше конечно здесь более новую вот а и основные преимущества фтс 5 это то что нет задержек для индексирование то есть теперь процесс более предсказуем и индексирование существенно стала быстрее вот попали эти задержки в 10 секунд вот язык запросов стал работать предсказуемым образом то есть там and are not запросы меч группе теперь находятся то чего мы ждали вот и вот наш тест наши тесты показали что целом вот скорость поиска вы при использовании в f5 выросла как бы 17 процентов незначительно мы на это не не рассчитывали в первую очередь но в общем-то это ты приятно вот в рассказе вский light еще хотел несколько трюков упомянуть внутри приложения используют несколько баз вот основная причина то что некие локи которые выполняют происходит при выполнении каких-то запросов например вот у нас отдельная база для поискового индекса если эта база хочется то основная база в которой хранится почта на факт с этим лаком так что вот такое вот разделение файла помогает как бы обновление поисковый индекс они настолько критическая операция она спокойно себе он потом добавится и пользователь предложат работу вот нашем приложении существует тоже там механизм миграции на выходят новые версии они работают с обновляют файлы баз данных вот так вот напоминаю что вот вы скрываете в отличие от многих серверных баз данных добавления колонке то бесплатная процедура вот какой бы большой не было таблицам это просто не зависит количество строк что на самом деле очень хорошо вот для других изменений там необходимо таблицу пересоздать что в принципе вы делает это все похожим на мой сиквел но как бы планируйте заранее до ну и в принципе при миграции помогает то что вот использование нескольких баз что можно просто создать новый пустой файл с базой отдельно вот с помощью sql запроса attach одной сессии подключить несколько баз и сделать там insert select поменяв структуру нужным образом и вот записав новый файл вот это работает по идее более безопасное там немножко быстрее кроме этого в нашем случае мы еще используем все функции в сделайте то есть в некоторых запросах там мы конвертируем там структуру флагов которые ставятся на почту и вот как вот нам показалось что вот дублирование кода уменьшает движение функций языка sql вот позволяет нам убрать дублирования кода из объекте всего тех местах где как бы нам это делать регулярно выполняется вот из такого простого трюка есть еще ключ при сборке по-моему он sql 3 atomic райт называется вот дело в том что на тех файловых системах которая поддерживает atomic white light может работать быстрее но проверка поддерживаете файловая система вот возможность атомарных записи она достаточно дорогостоящая поэтому потом разработчики рекомендуют выполнить ее предварительно и вот при сборке указать если поддерживается и в принципе на ios файловая система поддерживает atomic райт поэтому это просто вот факт который ускоряет запись ok еще один раздел получения почты вот spark это ой map и я ws клиент вот time up такой самый популярный наверное сейчас клиент для получения почты вот я ws это вот еще ничего services клиент пусенька протокол получения почты сообщение части миров я вот в основном буду освещать им а потому что еда был местом тянет на отдельный очень большой доклад да ну вот в первую очередь отличия штате пьет и бафов для тех кто многие работы или существительные многие работали самому вот в принципе и move тоже работает поверх эти цепи и вы может стоило сам вот и map стоит full протокол то есть при подключении к серверу поймал протоколу нам нужно с ним поговорить послать нам логин определенным образом авторизоваться вот потом выбрать папку ну то есть как как ftp если кто то знает а есть просто обмен командами туда-сюда вот поэтому в целом вот до установления рабочей сессии с эм апом до момента когда можно качать письмо проходит обычно больше времени поскольку происходит обмен в степи пакетными в несколько сторон вот как бы больше чем выше туч и если где идет рак вас response вот многие imap сервера например google они еще используют x-files авторизацию то есть такая разновидность aus когда мы не посылаем пароль от вашего google аккаунта вот по имаму а посылаем специальный talking который до этого нам дает поищите by google вот она собственно да и маг не поддерживается на собирался шины группа классов класс рассчитывает на работу по если теперь вот и я упоминал постоянный обмен короткими пакетами вот логин ноги ну кей там вот цель folder lock folder гей такие штуки а как бы аналог полинга и длинного полинга для и мапо этого команды нуб и idol то есть вот команда ну позволяет постучать и map серверу и сказать в этом случае отвечают статусом текущей папки то есть можно постоянно опрашивать папку и узнавать и привез это новое письмо вот так командой дал такой длинный полинг который если вдруг придет человеку письмо то клиент там получит определенный ответа сервера вот мы работаем с ума протоколом используя библиотеку mail core и там по мере работы иногда приходится мне добавлять небольшие изменения в принципе малакор хороший и как бы хоть большинство случаев вот при получении почты в этом важной характеристикой самого начала было получение пользователям push сообщений и в целом конечно хотелось бы чтобы это работало только на стороне давай со поэтому вначале мы пробовали бэкграунд режим работы там ей багром смотреть когда приложения периодически будет и из позволяет ему поработать и но может выполнить некоторую работу вот и там случае чего там отто весил около push notification но вот наши проверки показали что это работает недостаточно надежно во первых то многие пользователи убивают приложения когда с ними не работают выходят и экспой пути наверх и после этого у вас не перезапускает предложение вот слушать да и в общем-то и багром от матфея но как бы работает не настолько надежно сколь как она работает как работает мой лапы 1 который умеет проверять ящики дам поэтому мы шлём push сообщение сервера то есть мы поддерживаем свою инфраструктуру тут минус кабакам да вот это наша инфраструктура в claude мы используем google cloud и айос девайс отправляет нам параметры авторизации вот мы их у себя складываем в басу там вестники менеджер который распределяет дальше аккаунты между квартирами worker это такой большой сервер который одновременно вот ожидает события получение почты для сотен тысяч imap аккаунтов и как только какому-нибудь пользователю приходит письмо моего дальше проверяем нужен или по этому письму слать push сообщения и если нужно то что мы во на айос девайс вот вот примерно в дамы в начальном том запросе я прислан авторизацию пересылаем публичный ключ девайса и правило по которому можно определить нужна ли поэтому письмо письмо присылать push сообщение на девайс вот мы его формулируем на таком листы вот он стал лишь это вот пример для презентации он выглядит немножко менее читаем обычно но вот в общей 2 сохранён вот вот после этой реализации всего этого механизма мы заметили еще одно узкое место от момента когда вот пользователь получил push до момента вот она него нажал и должно вот открыться с парковаться текст она открывается и дальше spark отдельно подключается поймал по начинает там авторизовываться качать письмо и на это тоже уходит время и вот этот вот момент он создает ощущение плохого перформанса который как правило чисто вот ограничен сетью да поэтому мы вот нашу инфраструктуру добавили еще загрузку писем поясе теперь вот тело писи меньше двух мегабайт это в принципе по моему там 97 persantine вообще все почты скачивается нашей инфраструктурой дальше мы его шифру им публичным ключом девайса то есть моего шифру ему уже расшифровать мы его не сможем поэтому у нас хранится почта пользователей короткое время и зашифровано односторонним асимметричным шифром вот и дальше пусть сообщения которые мы отправляем на девайс она содержит уже шли типичную ссылку с нашей авторизацией но вот этого зашифрованное письмо вот и в ios 10 появился пустой раз extension который видит эту ссылку и как только push сообщение получено сразу начинают его качать вот и таким образом обычно вот во времени от момента получения пуша там пока мы про пиликает пока пользователь достанет iphone из кармана вот этого всего достаточно чтобы в этот момент уже письмо начала качаться и скорее всего она успеет скачаться вот то есть там в нашем пока не теперь вот появился мэл старридж куда кладутся письма которые по которым будут отравлен push вот мы перешли на и city 2 вот это скорее такая теоретическая часть потому что реальных тестов не проводилось вот такой общий консенсус то что шли цепи два быстрее более эффективный вот начиная с 9 уже поддерживается всеми устройствами там с этой заголовки передаются кроме этого нашей pr у нас он реализован для отдельных аккаунтов и у многих пользователей настроена несколько там домашний рабочая почта и вот по идее используется одно сити присоединением но multiplexer у этой вот по нему передаются запросы для вот двух аккаунтов пользователя по идее это эффективнее и в принципе все это указывает но как бы какие-то научного графика по этому поводу у меня нету еще хотел упомянуть то вот на что вот вы обратили внимание но пока такой фазе research а это алгоритм новый от apple называется lfs я вот и плывун адаптер здесь и представил вот речь шла о том что алгоритм быстрее чем стандартный за клип ну которым жмется http ответ и вот и там при лучше или там сопоставимый как бы рэйчел компрессора и 6 уровня сжатия вот в принципе вот посмотрели на тесты вот там некоторые из этих тестов доступны публично вот некоторые просто как бы собрать и проверить и действительно с одной стороны вот lfs я вот на 40 пациентов быстрее вот с другой стороны там и так в принципе речь идет о достаточно высокой скорости за клип тоже сильно оптимизирован поэтому для пользователя spark вот примерно мы прикинули что за сутки экономятся порядка 1 секунды процессорного времени что в общем то так вот даже при самых таких пессимистичных оценок потребление энергии наверное не является победил то что одну секунду больше нажималась почту пользователя мы все еще смотрим на сжатие может быть этом вот как бы сейчас очень хороший я еще обеспечивает bzip2 старый добрый вот и новая группа алгоритма в брод ли разработанную гуглом они уже получили все стандарты вот и данном случае вот тут вот более узким местом будет являться времени сжатие на сервере потому что там приложение сейчас бесплатная инфраструктуру мы его поддерживаем платную поэтому так вот все еще скрытый вопрос что мы выберем для сжатия перейдем или мы что-то вместо да вроде бы по основным моментам все там вот коротко упомянул про запуск приложения для меня докладчик очень подробно рассказал в принципе святого климента которые мы делаем applications and finish launching весов шанс мы создаем не кислый менеджер загрузки приложения которые параллельно начинает вот те фазы кондиционера ции которые можно выполнять бэкграунде параллельно начинает делать параллельно вот и вот такое распараллеливание тоже этом нам помогает сэкономить там сотни миллисекунд на запуске в принципе вот этому подходу достаточно много времени поэтому у меня тоже нету сравнение между тем что гипотетически могло быть и что стало но вот в сущности на нам кажется этот подход правильным vod-ok в принципе вот вот это такие некие практически и заметки о том что мы делали что если есть какие-то конкретные вопросы я готов что еще рассказать спасибо спасибо за доклад так мне два коротких вопроса пауз вот я пробег часе него сейчас спрашиваю то есть у алсу он вас реализован в виде micro series какого-то или составная часть вот всего вашего пока не приложение речь идет о aussi который например gmail у себя реализовал то есть вот джи mail вот уже не любит то что вот мы возьмем не будем у себя хранить пароли от google аккаунта пользователя поэтому надо это булавки als понял так теперь по узнаете дату для того чтобы лжи приложение там как подержишь шифрование там вы должны соответствовать там стандартам экспорта шифрование вот нам про сейчас это предстоит делать и вопрос хочу поинтересоваться насколько сложно долго все вот это делается с точки зрения разработки это никак не затрагивает все то есть это вот как бы наша команда которая юридическую поддержку обеспечивает нам все необходимые бумаги заполнила там по моему такие вот общее перечисления то есть в основном это практически тот же количество усилий которые необходимо выполнять вот даже при наличии тенниса в приложении ну то есть обычного дтп с а многие разработчики этого не делают в принципе те которые делают в то что они делают уже достаточно чтобы там шифрование вот так же этот случай покрывало и вот такое вот шифрование хочет понял спасибо какой алгоритм шифрования риса и рассада должна симметричный растает 2048 бит ключ понял я просто не знаю точно а там если вообще выбор там как какой мид шифрование алгоритм применить ну вот он случае вот когда мы там шифру им мы на самом деле там rss и аяз потому что нам письмо он может быть 2 мегабайта поэтому там и дней он случайный ключ им шифру им письмо и вот а ключи шифром в россии и этого полностью нашей воли как что выбрать могли выбрать и что-то другое основном это американский да то есть triple des там еще что-то внутри плода сейчас уже почти не используется как что вот а в теннисе но как бы в обычном вот подключение плохо дтп с или вот по лесу там правит о шифровании к частично указываются на сервере вот при настройке сервера и частичного там вот как это называется автором в процитируйте технология которого разделить появилась можно указать что использовать под клиентам но опять же на юридические аспекты это почти не влияет потому что там идет речь нам симметричное асимметричное шифрование вот с сайтом да вот на практические аспекты в принципе тут тоже мало влияет там я понимаю что есть просто гос . да вот почему вы не довольно то над тем чтобы там гостовский вариант шифрование применить том числе я понимаю что это там денег не дает там все-таки но сейчас apple позволяет там свой там алгоритма шифрования использую как бы не своя может быть просто если патриотичность потрясите говорит одну российский газ просто бы не из россии поэтому она не приходила в голову использовать российский гост вот я не знаю что сказать по этому поводу вот наверное это возможно то есть на самом деле вот это наша ответственность перед пользователями за то чтобы их данные предавались безопасно вот предложение бесплатно и в принципе как бы мы хотим как бы вот и стремление сделать лучше вот выбираем популярные алгоритмы то есть я уверен что если бы нам был известен алгоритм который бы обеспечил там существенно больше вас более высокий уровень безопасности то там apple обычно очень либерально силовых структур они приходили нам там ключик чтобы почитать ну вот этой точки зрения обычно говорят что приходят вот к тем кто эту почту получают вот то у нас как бы почтовый клиент поэтому я думаю да вот лучше гуглу приходиться информации чем канал все больше вопросов нет и разработки вы как-то занимаетесь но оптимизации приложения с точки зрения вот и спой утилизации батареи но чтобы он как можно более эффективно использовал менее нагружал батарею ну вот там есть инструмент который она же вечности вот vx коде мы на него смотрим но в принципе вот такое основное правило то что код который работает более эффективно с точки зрения производительности он будет ли работать более эффективно с точки зрения использования батареи опять же это идёт речь о том это вот этой вот эффективности когда не делается лишь не работы то есть когда регулярное выражение начинает проверять там вот лишнее группы символов которые не нужно это происходит на большом потоке писем это реально есть больше батарею вот поэтому мы как бы самая доступная метрика для нас это производительность но как косвенное его плюс это то что там делая меньше мы экономим больше батарею вот сейчас подход такой ну как бы вот скачивание писем поищите теперь это тоже экономить батарею потому что там будет более эффективный сетевой протокол хотелось бы делать больше но пока как бы вот с пособираем то что на поверхности спасибо хорошо ещё немножко вот на с точки зрения вот использование программ там вас таблицы используется как я понял для того чтобы стать для того чтобы листать вот слои между собой там просто view используется один по другим лежит а просто не то есть не таблица не коллекция ну вот таблица списке писем томата с эндрю вот это синтез прикид аналог ей collection вот аналог коллекции как бы написать или на свой ну а синди спайки этого facebook написал у них там нет есть класса и strange new и вот на нем можно написать такую асинхронную collection new ну здорово хотел бы узнать как вы разбираете случае там изменение этого списка то есть понятно что письма не так часто могут приходить соответственно обновляться это раньше будет не так быстро то есть что будет например если там человек читает а тот ему где-то внизу списка находится ему письмо приходит она вверх куда-то перемещается да правильно нас письма считаются сверху вниз призвана снизу появится а внизу вот и письмо уже получены не меняются поэтому в данном случае честно говоря у нас тут много других приложений и в данном случае на самом деле проще чем вот в другом случае потому что там история не меняется вот там вот это письмо хоть нарисовать можно будет мы делаем со списком писем в отвечай как там будем просто нарисовали картинкой уже полученное письмо там ничего не сдвинется вот поэтому дан там внизу появится письмо вроде понял вот я был когда письма приходят вы решаете то через push-уведомление да но это в том случае если письмо было от важное для пользователя у нас есть такие smartsheet то есть на некоторых пользователей это все почта на самом деле зависит от пользователя вот параллельно мы слушаем вот пойма протоколу вот открытый socket который вот там вот сервер уже напрямую этом гугловский или какой то напишет туда выскажут пришло письмо мы начнем его качать вот начнем делать эту процедуру вот там не совсем понятно момент вот и схему появился может я просто посмотрите вот у вас когда письмо приходит новое да вот как раз то что вы только что озвучили это получается вы слушаете я ем ап и push notification одновременно apple же он пишет что push notification не является гарантированным средством доставки сообщений и для для этого вы использования про нет но у нас все еще и map клиенты он по-любому вот сходит к на сервер и там рано или поздно получит список писем и начнет их качать если до этого вот у него уже в нашем приложении это письмо уже не лежит скаченным поэтому у нас мы активизировали оптимистичный случай и пессимистичный случай нас равно будет работать у нас использовать или у которых почтовый сервер , но и вот эта вот вся картинка вот с нашей инфраструктурой вот она вся вообще к ним не подключается там вот вот этот вот worker пытается подключиться вот скажем вот сотрудники apple у них вот почтовый сервер нему нельзя подключиться забрать почту из публичного интернета и вот мы как бы в этом случае приложение для них работает во чисто какое map клиент вот это же все продолжать работать только нету push сообщений устав 1 ну понятно кроме этого приложения вы много других разорваться для в том числе но у нас порядка 6 погнуть и приложение а можно еще какие вы разрабатывали что вы если что факты знать к воротиться открою второй слайд множество парк бесплатный вот пожалуйста фоткайте ты в конце были мои контакты если что пишите спасибо я чищу вопрос о кого-нибудь нет спасибо большое докладчика спасибо"
}