{
  "video_id": "bLJ7M7d6uWE",
  "channel": "HighLoadChannel",
  "title": "Опасная сериализация / Иван Юшкевич (Digital Security)",
  "views": 1047,
  "duration": 2099,
  "published": "2018-01-16T12:30:14-08:00",
  "text": "замечательно день добрый совет соответственно зовут кирпич иван и сегодня упьюсь рассказать несколько интересных вещей про стерилизацию насколько она может быть опасна какие узи масти в ней встречаются всякие другие возможны интересные вещи пару слов обо мне замечательный слайд собственно я работаю аудитором компании digital security делаю всякие рандомные вещи иногда очень занимаюсь разными секретными штуками очень то наверное это и все какой план общий план презентации сегодня сначала я постараюсь рассказать немножко что такое сериализация где ее встречают в общем с чем ее есть потом расскажу о некоторых уязвимости которые могут встречаться в ней связана стилизация объектов и тому подобное как искать те или иные баги как можно было бы защититься и возможно кто-то если кто-то прослушать это все до конца получится это какой-то профит это будет интересно собственно что же такое у нас есть реализация цивилизация это некоторые процессы хранения состояние объекта в некоторую последний байт можем сохранять объект на файловую систему в базу данных передавать это последний байт по сети то есть по сути дела это всего-навсего некоторые представления объекта в качестве некоторые паслена стебать то есть некоторый формат данных здесь реализация соответственно это честно процесс обратный формат представления этих данных может быть также абсолютно разным начиная от каких-то бинарного представления как шоу сериализация абдулла прессе я на тому подобное какие-то смешанные представления как баннере xml или джейсон и боль уже человек читаемый формат и как xml ямал ну и на самом деле их очень-очень много кто кто во что горазд где можно встретить соответственно на сегодня у нас у каждого приложения огромное количество компонентов эти компоненты взаимодействуют друг с другом по сети через файловую систему до через что угодно на самом деле и необходимо обмениваться некоторыми данными этот обмен данных можно сделать двумя способами первое городить свой протокол про какие-то данные вытаскивает создавать объекты а дальше с ними работать второй вариант это использовать реализацию для передачи данных то есть мысе режим объект передаем au cou это кому-то другому компоненту он одессе реализует то есть уже решает за нас всякие либо возможные проблемы связанные с вытаскиванием параметров и формированием объекта это возможно у этого есть некоторое достоинства первую очередь потому что если мы хотим внести какие-то банки и полям объект то нам достаточно просто поменять соответствующий класс или компонент нам не нужно менять какую-либо логику обработки то есть довольно легко с точки зрения и специализации довольно . легко делать какой-либо рефакторинг кода использовать повторный год в разных компонентах стерилизация также может использоваться как для каширования объектов то есть например мы сохранили какой-то объект в базу данных которая находится в памяти и быстро можем алла туда стать и дальше дело с ним чего захотим может использоваться как cookies токины в общем сохраним становление объекта я только угодно как у нас в общем случае в данном сейчас я буду рассматривать все для языка java потому что я написал о нем целых пять hello world of вот поэтому имея некоторый скиллу как происходит самореализация у нас есть некоторые он сжег input stream который получает определенный набор программный набор байтов который возможно приходит даже от атакующего после этого вызывается функция парус этот набор и вызывается функция resort класс и вытаскивается из этого набора имя класса я получил пытается получить из приложения некоторые метаданные по этому классу это очень важно в данном случае поскольку сразу уже на этом этапе можно определить дозволены этот класс для сериализации или нет это все делается циклично после чего вызывается некоторая так называемое можно их назвать магические методы которые будут вызваны всегда это reject или republic на у дата их на самом деле довольно много они служат для того чтобы заполнить определенные параметры в классе и сад но собственно поляк поля в классе заполнить после чего вызывается другие методы и производится расставание к определенному объекту поэтому если с точки зрения атакующего очень интересно вот эти замечательные функции поскольку они будут вызываться всегда то есть если они есть у класса они будут вызваны то есть если он найдет каким образом можно их про эксплуатировать или передать какие-то данные с помощью которых он может получить удаленное выполнение кода это всегда замечательно для него это звучит а сам очевидное самоцель в качестве основных таких основных таких магических функции это они представлен на данном слайде то есть первую очередь при поиске каких-либо уязвимости которые могут присутствовать при реализации или здесь реализации объекта необходимо искать именно их в дальнейшем я расскажу что можно и не только их использовать собственно самый такой хрестоматийный пример то есть у нас есть некоторый объект который которого есть функция reject которая так или иначе вызовется и в ней происходит выполнение кода то есть атакующие очень легко может достаточно ему реализовать такой объект установить переменную команд как например калька где и в таком случае когда объект будет реализован вызовется эта функция и у нас вызовется калькулятор но это все работает топ стране единорогов не знаю дельфинов на которых ездят динозавры зачастую в реальной жизни такого встретить очень очень сложно ну давайте перед тем как посмотрите как что же можно встретить реальной жизни немножко углубимся и посмотрим как это сделано дальнейшем я честер но еще раз повторю буду рассматривать с точки зрения я вы на данном слайде представлен некоторый код которые на самом деле делают одну простую вещь он берет класс юзер у которого есть некоторые поля это имя является администратором картинка он себе лизу it и рисует его после чего здесь и реализует в качестве объекта у контейнера используется файл и описывает имя пользователя давайте посмотрим что же содержится у нас в этом файле который получился после стерилизации объекта на самом деле получилась какая-то бинарная шляпа но на самом деле в ней ничего сложного нет то есть если мы откроем этот файл с помощью какого-либо hex-редактор а мы на самом деле используя википедию или что то еще можем легко разобраться что же там вообще нас они внутри но для начала мы видим указания из двух байтов что это у нас и файл arocs цивилизованные данные после чего мы видим версию протокола дальше указание о том что это у нас новый объект обозначение нового класса дальше уже по сути дела начинается описание этого всего объекта из двух байтов мы видим это длина имени класса естественно имя класса его идентификатор также поддерживает ли этот кластер реализацию и количество полей которые в нем присутствует как вы можете помнить класс use содержит три поля это имя переменную из обмен и картинку дальше у нас идет о тип поля и длина имени этого поля в данном случае в данном случае длина сейчас прогревается как из админ то есть всем бай ответственно дальше это все упаковывается где-то здесь на этом слайде можно даже увидеть имя пользователя как устав и тому подобное в общем это как оно устроено внутри на самом деле абсолютно ничего сложного какой-либо бартер для сериализации можно самому написать для бинарных частности за довольно ограниченный промежуток времени или использовать уже готовые вещи теперь по поводу уязвимостей какие они есть и вообще с чего можно искать есть и как их искать общее какие они встречаются первую очередь это нарушение работы логики программы когда мы передаем какие-либо данные с помощью цивилизованного объекта и эти данные уступая дальше культа которого флова этого кода всего они нарушают заложенный алгоритм работы заложенную идею бизнес-логику различного рода ошибки связанные с валидации данных пользовательских данных важно отметить что цивилизации не решает проблему какой-либо кого-либо сын тайзен к обработке фильтрации то есть злоумышленник передал вам передал кавычку он получил кавычку на стороне сервера ничего такого и возможности иногда даже получить выполнение произвольного кода даже когда вроде бы вы не используете каких-либо вызовов как же лобзика где я к тому подобное даже в общем никогда их не ждешь самая важная цивилизация это то что понять грубо говоря что данный приходят не из не доверенного источника они также могут быть модифицированы так же легко как и параметры которые передаются в приложению и чтобы ты не была в качестве примера некоторые уязвимости которые были обнаружены в конкретном сериализации в различных продуктах крупных компаний как например german там к от groovy и тому подобно android даже по 2015-ый год это всего лишь маленькая часть из всего того что было обнаружено то есть это в общем не просто какой-то кастомный код а код который использовался в крупных продуктов на самом деле багов цивилизации очень очень много то есть по 2017 год наверное сейчас больше может быть даже больше ста уже каких-то крупных продуктах а сколько и в кастомном коде то кто может сосчитать почему она самом деле наверное это все так происходит можно считать что поскольку сириза ванны и данные когда их открываешь например с помощью блокнота или чем-то не было выглядит как какая-то мешанина то все остальные люди также видят как мешанину что и передачи этих данных оно безопасно потому что их нельзя не поделать не изменить в общем-то не повторить ничего с ними нельзя сделать также зачастую иногда даже бинарный фарм формат он часто понятен даже как его открывать здесь стоит отметить такой момент что может быть реализацию информации реализации стоит отнести как проблему с безопасностью пускать и графически безопасностью поскольку там есть такая условии что жив и можно считать нолика трофическую функцию безопасный только в том случае если она открыта каждый может посмотреть как оно устроено если ты не знаешь как оно устроено на неё нельзя считать безопасный это и стоит еще раз сказать даже лизации это всего-лишь всего-лишь формат представления каких-либо данных то есть ничего больше давайте рассмотрим некоторые примеры тоже самый базовый пример уязвимости связаны сериализации у нас есть некоторый класс в котором есть несколько полей это uid имя пользователя и предположим флаг который отвечает администратору или нет после все лидер нации этого класса мы можем видеть как он представлен в серьезном виде бинарном и этот класс он может например использоваться стерилизованный класс в качестве уке пользователя вот он будет при этом при а zion кожи с помощью bass 64 и приложение которое будет работать с этими данными она получает эти данные и скуки пользователя здесь и реализует их и дальше уже как системе работы давайте посмотрим например как это может выглядеть в берпи какая-то строка в 4 общения не понять что то есть здесь эльза фу можно увидим какую-то бинарную кажу вроде бы выглядит довольно безопасно на самом деле нет то есть все вся проблема заключается в том как с этим работать давайте посмотрим дефиле завод это если мы начнем объект мы видим что переменная из админ в данном случае она выстлана как 0 falls и тогда наше приложение скажет что привет пользователь ты всего-навсего юзер однако ничто не мешает злоумышленнику если он получил этот объект data with от него не муж приходит приложению изменить эти данные каким-либо образом и в итоге например просто поменяв одну из переменных стать администратором системы давайте посмотрим немножко более реальный пример то есть это опять хрестоматийные там же где и единороги но как это выглядит на в реальной жизни в качестве примера давайте возьмем замечательный фреймворк на php кода где-то он позволяет он использует позволяют установить в качестве cookies пользователя некоторые и реализованные плеч и объект он также он позволяет его чтобы никто не мог его заменить произвести некоторые следующие операции защиты первую очередь вот эти cookies который представляет собой серьезный объект они могут подписываться с помощью мт5 который считается как до 5 от объекта плюс некоторые секретные ключи данном случае это вот представлены на слайде также эти cookies они могут быть зашифрованы с помощью а с этим же секретным ключом но если а если у нас почему-то нету или он не включен то в определенной версии эти cookies шифровались помощью к ссора ну это уже отдельная песня как они шифровались но здесь важно отметить что если злоумышленник поскольку это md5 он же знает абсолютно все эти значения ему достаточно просто zion ходить переходишь данный объект и он получите значение алгоритм он знает ему крайне легко подобрать этот ключ шифрования и после этого зная этот ключ он может изменить этот объект и если здесь какие-то держи какие-то интересные данные ну давайте предположим айпи адрес он используется для лакирования что какие пользователи входят например мог бы получить какую-то инъекцию но это все как я говорю это дальше уже нужно смотреть по логике программа но вот этот довольно яркий пример или или если там же он мог бы где-то встретить указатель указатель того что вот смотрите например userdata у нас есть да если например она бы была выслана как там что он является администратором как был показан на предыдущих слайдах он также мог бы например нарушить лойко программой получить доступ в административную панель не доверенный давайте предположим смотрите следующую ситуацию у нас есть некоторый класс юзер в котором есть некоторые подклассы как permissions но объекты типа permissions которая про для этого права например какая то информация пользователя я которая статистика и у каждого это классы есть некоторые поля то есть эти поля могут быть использованы для различного рода запросов которые могут происходить внутри программы то есть иными словами перезаписал один одной из таких полей мы можем свою очередь в данном случае выполнить какой-то из qr-код или например если поле тульская картинка использовалась для указания пути откуда будет засчитана файл что потом передать его клиенту он может с помощью установить специальное и значение получить доступ например файлу этот эпос в.д. к чему я веду что дальнейшая работа с цивилизованными данными то есть неправильная работа с данными которые считают что они безопасны и могут привести тому что появится огромная куча других уязвимостей из вас му топ-10 или чего еще то есть как некоторые такое некоторая ремарка что необходимо всегда контролировать все эти данные которые пришли от пользователя они получены из не доверенного источника да и сигнализация не решит из-за кого какие либо проблемы связанные с той же самой из коллекции микс ссср и довольно самом деле неважно то есть это всего-навсего формат представления данных гаджет или давайте рассмотрим более такой детальный пример предположим у нас есть два класса класс кэш менеджер и класс команд ask a classic ешь manger есть необходимая магическая функция рядов же который так иначе будет вызвана у нее есть некоторый параметр и нет хук который runnable и у которого в свою очередь когда он делается ран вызывается некоторая команда то есть на сколько у нас эти классы вложены друг друга та цивилизация в процессе реализации они все будут реализованы эта команда так иначе будет вызвана как нас будет выглядеть мы получили некоторый набор байт и пытаемся в одессе реализовать получили что у нас имя класса это класс менеджер вызываем функцию reject которой соответственно дальше вызывается устанавливает некоторые необходимое значение для и нитку к в которой мы передали значение команды после чего она это всё сделала вызвало и нитку кран которую свою очередь вызвал y который в свою очередь вызвал калькулятор то есть даже в принципе нам даже не нужно знать что в каких-то магической функциях конкретно в них присутствует какой-то уязвимый код этот код может быть стриги рен в других классах которых которые могут быть использованы это на за разом пол не только магические методы могут быть использованы для эксплуатации какой-либо эксплуатации что у нас есть в языке java возможно использовать различного рода прокси который позволяет вызывать сторонние функции давайте качестве примера рассмотрим следующий код соответственно магическая функция greet обжиг которая так иначе будет вызвана в которой всего-навсего вызывается а что вызывается называется просто получение из структуры map по ключу какое-то значение ничего страшного так или что-то страшное кто знает я я не знаю вот поворот ничего страшного нет я тоже не вижу у нас есть например другой класс hitler у которого нет магические функции которые нам необходимо ли добрых но есть другая функция общества и также он является ян го кришны ходлер так называемой и вот у него уже есть вызов джека с некоторыми аргументами как можно заметить эти два класса они абсолютно никак не связаны то есть у этого нет указания на хендлер у этого вообще нет 3d джек как вообще можно было бы их связать можно подумать о пробовать соответственно для этого у нас есть так называемый едва крышек хендлер поскольку классное класс уложенной мы можем создать некоторые прокси между структурой map и и всеми функциями и другим классом иными словами каждый раз когда будет происходить вызов некоторых методов класса этот пункт будет перенаправлять и позволяет нам выполнять какие-то определенные другие реализации очень что у нас здесь происходит значит мы определили мы сказали что у нас вот наш гаджет это создали новый класс гаджет дальше конечно немножко и корректно но давайте начнем с этого мы установили в качестве объекта map некоторую переменную прокси к классу горы что же это является прокси мы сказали что прокси и то есть указания на класс аж которую свою очередь является hitler то есть теперь когда произойдет вызов из-за redox это произойдет вызов классами точнее метода get close up вместо того чтобы получить какой-то объект по значению произойдет вызов конкретные наши функции то есть конкретно конкретных функций 2 кат хэндлера иными словами я что хочу сказать что это конечно особенность уже самого конкретно языка но разные методы также могут быть использованы даже когда принципе вы не используете каких-либо уязвимых функции говорящими названиями как системы казак и чтобы для того как может быть равно уязвима почему это происходит потому что все приложения они используют как иначе как и или в библиотеке если посмотреть например библиотеку commons его развернуть один из пиджей мы увидим там огромное количество различных классов которые также писали люди которых также может задержаться какие-либо уязвимости и которые в свою очередь также могут быть использованы для сериализации например довольно много было обнаружено узи месте связанных с популярными библиотеками которые в свою очередь позволяет с помощью того же самого и докера производить выполнение какого-либо удаленного кода и самое что важно что все эти библиотеки они используются в разных приложениях то есть они находятся в разных папках и а пропатчить какую-либо конкретную библиотеку становится крайне крайне сложно то есть про пачку это приложение стать крайне крайне сложно то есть что может произойти что если мы посмотрим где находится той или иной версии библиотек то мы видим что куча различных пряжа не стирается на разные пути и нам все эти пути нужно будет каждую библиотеку этом пути нужно заменять еще не факт того что в последующем не против каких-либо конфликтов исправлено библиотека будет нормально работать то есть довольно сложно это все обновить это подвержена не только на самом деле язык java в качестве примера давайте рассмотрим php есть он также имеет возможность реализации объектов срезаться объектов выглядит он в принципе точно также указания что у нас есть класс юзер что у него некоторое количество полей их длина их имен их значение в общем-то все тоже самое только в более может быть всюду почитаемого формате давайте рассмотрим некоторые гипотетический пример который на самом деле частенько встречается на практике связаны спичка и ним кыш-кыш наверное как всем известно очень круто использовать для каких-либо данных чтобы быстро получить оттуда постановить сессии там кит страницы и тому подобное частенько при развертывании инфраструктуры memcache забывать закрывать то есть и к нему возможен неавторизованный доступ поскольку он у нас является у нас является доверенной средой то есть который приложение кладет данные и по логике тока она должны класть и получать данные таких проблем вроде как быть не может предположим что у нас есть некоторые приложения которые используют ним каждый кладет туда серьезный объект пользователь в котором также есть некоторые некоторое значение файла который будет учить поскольку ммк что у нас открытый любой человек может подключиться к нему и сделать какой-то свой объект и соответственно поместить его по определенному кричу после этого необходимо вызвать приложение и всю очередь мы сможем получить возможность считывания любых файлов почему это происходит в первую очередь не потому что mem cache виноват потому что виноват люди которые его устанавливали они его не закрыли и поскольку он является доверенной средой еще раз повторю это из него получается данные то приложение полностью ему доверяет и данные которые поступают из эту вроде как доверенного источника не обрабатывается должным образом то есть еще раз проблема связана с обработкой пользовательских данных как искать как находить возможно use масти связанные с точки зрения сериализации если в коде то в первую очередь искать различного рода магические методы для помощи для помощи в этом поможем вам могут помочь различного рода утилита или программы как fine бакс сериала easier возможно какие-то корпоративные среды как их маркс и тому подобное для такого полевого дефекта того что приложение используя реализацию можно искать по некоторым паттерном а вот магическим байтом который используется то есть указание что серьезный объект для виде формат обычно 4 и на самом деле многое многое другое то есть когда мы находим такой объект да мы точно знаем что используется какая цивилизация что в принципе дальше можно было бы с этим сделать для эксплуатации сериализации есть уже сделаны различного рода утилиты которые позволяют сформировать нужный объект с помощью которого получить возможность выполнение произвольного кода в частности о данном слайде представлена утилита you сам сериал который имеет различного рода колоды для collection с различного рода версией для грузии для java гляди-ка 7 и тому подобное и с помощью нее вот все мать объект передачи в какой-либо приложение и получить возможность выполнение произвольного кода на удаленном сервере как можно было бы защититься от этого всего первые довольно самое очевидное это использовать sandbox то есть когда мы получаем некоторые да когда мы получаем некоторый объект то есть он начинает может выполнять какие-либо действия с файлом то есть действие какие-либо действия щитовать файл пытаться создать процесс что очевидно зло может лишь нужно получить б connect вот попытаться получить доступ к сети все это загнать с помощью специальных инструментариев песочницу и контролировать все эти действия однако здесь вырисовывается следующая проблема что все это чертовски сложно сделать потому что например если код позволяет удалять файлы дата значит можно удалить и все остальные файлы до нужно который узнать какой файл удаляет все это очень и очень сложно настраивать поэтому есть небольшая другая эти например можно проверять имена классов перед диси реализации как было сказано что сначала мы вызываем функцию get close и получаем имя класса то есть на этом этапе мы можем сразу сказать что например если злоумышленник пытается дернуть какой-то класс и библиотеки скажет у меня так делать нельзя и сразу запретить такой вызов если различными родами у людей которые позволяют это сделать как serial killer контраст подобное можно и свой например партер сварганить как например представлена данном слайде данном случае мы проверяем что если имя класса у нас не равно апликэйшен юзер то тогда выкинуть exception и даже закончи какие-либо действия с этим классом что такой классный записи рисовать другое другая идея что у нас и так уже концепт который иногда предлагают у нас у класса есть некоторый набор магических метров то есть как я говорил это reject и около пяти шести других что можно предположить мы получили некоторые класс и пытаемся проверить если у него эти методы если они есть мы можем проанализировать эти методы есть получается которые есть и посмотреть находятся они в каком-то black листе то есть если они есть там там на голове rip да этот класс использует метод который находится благости и моего и вызывать не будем потому что это может привести к каким-то проблемам и говорим что не давай к нам чуть другое в противном случае мы продолжаем свою работу другой также возможны метод защиты является whitelist то есть в отличие от blacklist а мы в свою очередь определяет все класса которые могут быть реализованы ми3ча blacklist а у которого есть следующая проблема что мы не можем обозначить вообще абсолютно все классы который является уязвимыми потому что класса огромное огромное количество и новый появишься класс да который у нас не был еще раньше в бла кисти он может оказаться уязвимым а у нас его там нет и довольно через частенько можно встретить различного рода примеры в том что люди находили способ найти те или иные blacklist и поэтому вот лист один из таких вот самых известных вас методов для борьбы судимость связанные с детализацией и самое важное что стоит всегда держать у меня это то что не стараться никогда не серьезного не dice реализовывать данные которые пришли из не намеренного источника то есть даже если это кажется что это невозможно материализовать то этого делать абсолютно не надо потому что все уязвимости именно идут именно от этого ну и да наверно у меня на этом все вопросы коллеги вопросы вам спасибо за доклад хороший глубокий как ожидалось что когда мы завершаем нашу секция посвященной информационной безопасности в сфере разработки спасибо всем кто был с нами с начала и до конца кто присоединялся приятно было вам читать доклада спасибо"
}