{
  "video_id": "6p4JP-HBfrQ",
  "channel": "HighLoadChannel",
  "title": "Сравнение форматов и библиотек сериализации / Антон Рыжов (Qrator Labs)",
  "views": 1040,
  "duration": 1537,
  "published": "2017-05-14T22:53:05-07:00",
  "text": "меня зовут антон рожок в компании куратор labs и сегодня я вам расскажу про форматах и библиотеках здесь реализации данных я расскажу чем разные форматы друг от друга отличаются какие у них есть плюсы и минусы какие фичи содержат те или иные форматы про библиотеки расскажу в контексте питон языка питон на котором в нашей компании мы их используем я покажу бенчмарки и вы сможете сделать вывод подходит ли вам те или иные решения в конце также дам ссылку где посмотреть исходники и сделать тесты для ваших данных чтобы понять какие решения лучше вам подходит для ваших данных так начнем в нашей компании мы занимаемся защита тедас поэтому у нас много распределенных серверов по миру стоят они все обрабатывают трафик и у них много много данных проходят через них то есть у нас там есть логе у нас есть статистика мониторинг иногда нужно взять даже типе дамб и соответственно передаются между сервисами довольно большие объемы данных и чтобы их передать нам нужно их передавать без потерь чтобы данные в процессе не поменялись не изменили свои типы ничего не пропало может показаться что это довольно очевидное требование будет выполнено всеми возможными способ библиотеками но на самом деле это не так компактно и то бишь чтобы данные складывались все реализации и занимали меньше места потому что если данных действительно много то 50-процентной экономия может иметь существенное значение конечно мы хотели бы чтобы данные по ковались быстро и программисты не пришлось бы ломать руки при использовании этого инструмента когда дело заходит о сериализации все сразу представляет джейсон потому что это привычный всем известный инструмент вроде бы с ним все хорошо он такой простой и удобный но с ним есть на самом деле проблема как минимум это не компакта то есть он занимает достаточно много места и давайте посмотрим насколько не компактно например если мы будем передавать какие-нибудь маленькие числа то они будут занимать 1 байт также как они занимали по памяти компьютера но если числа больше то тогда у нас будет мы уже увидим неэффективность в несколько раз если мы будем передавать числа вещественное не целое то в каком-то случае мы даже сможем выиграть ведь три байт это меньше чем 8 как бы она хранилась памяти компьютера но когда у нас числа будут рацион иррациональные то опять же эффективность сильно упадет в одном из сервисов чтобы обойти эту проблему мы даже в передавали отдельный числитель и знаменатель в качестве целых чисел и получали экономию на трафике но конечно такие кости ли реализовывать самостоятельно где так себя можно передавать строки в если мы передаем стойки то мы все получаем оверхед всего лишь два байта это довольно хорошо и ну что будет если мы будем передавать юникодная строки если мы передаем денег одной строки то они будут закодированы вот так вот ее то мы получаем увеличение три раза однако может быть заметили то что джейсоне можно передать опцию возьмем реализациях можно передать опцию и кодировать их с помощью нужной кодировке таким образом мы действительно получим вернем свою эффективность на предыдущий уровень но тогда мы можем потерять в кроссплатформенность и потому что на другой стороне данные могут просчитаться неправильно из-за неправильной кодировке также если бы вам передавать сери объектов то нам придется дублировать ключи этих объектов и если у нас будет их очень много то опять же мы теряем эффективность очень бы хотелось передавать только осмысленные данные и не гонять лишний раз ключи но джейсоне мы это сможем сделать только если сделаем что-нибудь подобное это опять же нужно вручную как то делать на на стороне передающий трафика перед принимающий это тоже достаточно неудобно так же джейсон есть проблемы с целостностью если мы будем передавать какие-то данные например это словари у которого будет целочисленный ключ то большинство библиотека сделает в качестве ключа строку соответствующего потому что джейсон запрещают передавать не строки только строки могут быть названиями полей например если мы получаем какие-то подобные данные то нам придется делать преобразование типов чтобы в словаре поискать соответствующее значение и как ты их сопоставить также есть проблемы с реализацией джейсон из-за этой особенности например в 5 место мы будем стерилизовать объект с целочисленным индексом и ключ к численным ключом и соответствующей строкой то мы получим довольно странный результат если мы сделаем то что мы в печке то мы тоже потеряем данные впрочем джейсон тут не при чем просто пипец странно работает также есть проблемы с бинарными данными если мы захотим передать что-то отличное от строки джейсон нам в этом не поможет мы можем например применить b64 кодирования и автоматически получить плюс 30 процентов лишних данных кроме того если мы сделаем так то нам придется рассказывать использующим нашей бей то что в этой в этом поле у нас не просто строка что-то требующие дополнительной обработки мы конечно можем это как-то подсказать разработчику но это тоже не очень удобно накладывать лишнего вверх от давайте рассмотрим альтернативы что же мы сможем использовать чтобы избавиться от этих минусов здесь таблице представлены довольно популярный всем известные форматы некоторые из них используют схему некоторые нет все из них поддерживают бинарные данные в части из них решены проблемы с типами ключей в словарях кроме про табов и в котором вообще просто нету ключей нету словарей зачем вообще нам понадобилось схема ведь у нас так все было хорошо джейсоне схема описывать данные может являться частью описание и 5 то есть как бы документации к нашему нашему сервису также схемы может уменьшать дублирование данных как мы посмотрели выше если мы передаем однотипные объекты включи мы можем не передавать также схемы может проверить наши данные по типу и соответственно дать какую-то ошибку раньше чтобы мы узнали что данные пришли не валидны кроме того схема приводит типа например если нам приходит данные из какого-то слова типизированную языка того же самого php в котором нет разделений на баннере и юникодной строки то указанная в схеме указаны в схеме тип сможет нам подсказать как правильно их интерпретировать схемы везде минусы во-первых и нужно писать это обычно заключается в том что мы дублируем в файле с описанием схемы то что у нас уже есть программном коде и потом приходится поддерживать и синхронизировать между собой эти файлы кроме того что надо писать иногда и еще надо компилировать некоторые из представленных выше решений в табличке предыдущий требуют кода генерации или компиляции этой схемы в какое-то специальное представление давайте рассмотрим поподробнее решения содержащие схемы потому что без схемные и так довольно просты и понятны и а вот прос содержащий схему есть о чем поговорить первый в списке это был про табов довольно старое известное всем решение хорошая документация его любит в интернетах потому что в бенчмарках он всегда показывает себя довольно хорошо у него есть минусы у него ограниченная поддержка типов как я уже упоминал то что он не поддерживает map и также список списков реализовать напрямую нельзя приходится какие-то обходные пути придумают все можно реализовать и передать но это все мини удобно вот так выглядит схема в прато вов нужно в последние цифры в конце обозначают номера полей нужно их вручную нумеровать поддерживать эту нумерацию что тоже не очень удобно следующий формат а3 вт его разработал фейсбук отдал в apache потом продолжил разрабатывать самостоятельно получилось две версии такие вы не очень совместимой наверное местами у него так себе документация в интернете есть довольно известная статья 30 замесим гайд что собственно красноречиво говорит о том какая официальная документация также protocol позволяет описывать рпц клиент и сервер и большинство библиотек содержат их реализацию что тоже достаточно удобно так выглядит схема все тоже довольно просто понятно лаконично 3 протокол со схемой это патч ковра он еще более новый он содержит хорошую документацию и они принципиально отказались от кода генерации мы просто написали схему и сразу с ней работаем это тоже довольно удобно так выглядит схема она задается в джейсоне поэтому она достаточно многословной длинная неудобная в поддержке руками писать не очень удобно предыдущий были лучшие но с этим тоже можно жить так же авра заставляет раскладывать типы схемы для разных типов в разные файлы таким образом файлов so схема у нас будет очень много если мы будем это пользовать и как же вот эти форматы нам помогут передавать разные типы данных вот например мы передаем менеджера и сколько это занимает соответственно интеджер это значение 0 1 2 и 4 байта вы и цифра мы можем увидеть то что формат persona 300 использовали сразу максимальный контейнер и не стали optime пытаться оптимизировать аппарат оба во время сеть pack постарайтесь выбрать размер поля в зависимости от того какие конкретные данными передаем если мы посмотрим на флот и то здесь ситуация противоположная все выбрали сразу максимальный максимальные контейнеры используют его однако массе чпок про добавкой авра который здесь итак показали самый хороший результат они позволяют задать в единичной точность вместо добыл использовать тепло от таким образом у нас будет еще меньше потребление потребления давайте посмотрим как передаются строки стройке передаются тут же соответственно графики для пустой строки строки и саске символов и извини кодек символов ожидаем что и негодные символов два раза больше потому что там представление и тех если мы будем передавать большие строки которые содержит 1000 символов то мы увидим то что все библиотеки одинаково эффективно потому что в них не такой большой вверх от если мы передаем данные большими большими кусками если у нас большие стройки ходят то в принципе можно взять любое решение и оно будет достаточно эффективно если посмотреть на передачу поэтов то это опять же графики для 0 и 10 байтов можно увидеть что некоторые форматы выделяют много места как бетон и 3 вт и плохо справляются с короткими с короткими поэтому массивами некоторые наоборот очень оптимально и хранят если мы передаем много байт то опять же нет никакой разницы кроме джейсона который получает свой 30 процентов из за использования b64 если мы будем передавать массивы то вот это значение для массива из 1 и 10 элементов это элементы это пустые строки то мы получим вот такое распределение обращу ваше внимание то что про тапов а нету значения для массивы пустого он действительно вообще не передает никаких данных если массив пустой благодаря схеме может понять это не передает пустые значения если мы передаем мы по какие-то словари то цифры будут вот такие три все показывают очень плохо здесь почему-то и у брата вафа стоит звездочка потому что он не поддерживает мэр но здесь применен такой официальный обходной путь как все-таки засунуть туда мипо поэтому это нечестно им об атаке схема нам позволяет не передавать ключи в мифах чтобы сделать фиксированные стр акты и передавать их здесь как раз мы видим эффективность этого подхода если мы будем задавать название полей то мы сможем по сравнению с синим столбиком получить красный особенно там авра вообще очень хороший результат хотя конечно это зависит от пилота и длины ключей и количество ключей которые вы таким образом с оптимизировали топ по размеру я расставил их по результатам предыдущих предыдущего графиков в таком порядке хотя опять же напомню то что это все очень зависит от структуры ваших данных и может быть в вашем случае этот порядок будет абсолютно другой дальше провел benchmark про со всеми этими by форматами посмотрел разные их реализации для питона 2 и питон внутри произвол замер сколько требуется нас реализацию дези реализацию таком железе и вот что получилось посмотрим начали на те форматы которые без схемы здесь представлены три библиотеки которые реализуют те иные форматы они все поддерживают питон 2 и питон 3 они все просто устанавливаются из репозитория бетонного пакетов два из них написано и в качестве финишного расширения один написано настоящим питоне никто не требует генерации кода и вот что получилось bison очень медленный не используйте его a massage pack соответственно наоборот себя показывает очень хорошо джейсон ли джейсон это стандартная реализация джейсона и более альтернативная которое обещает большую скорость правда в данном тесте она больше скорость не показала результаты вполне сравнимо к если мы посмотрим на библиотеки для про top of the их три это штатная соответственно библиотека про табов официальные отгулы которая работает только в питоне 2 но ее можно запустить в питоне 3 если использовать автоматическую трансляцию хотя я бы наверное не рискнула и потом пускать production остальные две библиотеки работают только в питоне 3 установка брата пав от гугла занимает некоторое требует некоторых усилий потому что он ставится только из исходников нужно компилировать комбинировать нужно генератор генератор кода компилятор схема потом к нему нужно доставить еще бетона в реализацию просто из стандартного репозитория сепараторов и про top of 3 они просто ставится из исходного репозитория однако для их работы нужен тот же самый гугловый генератор кода поэтому тоже придется компилировать так выглядит код на порталов и все про табов они у них одинаковый ebay все довольно просто и понятно сериализации сериализации порталов 3 интерфейс немножко другой здесь поля нельзя передавать в конструкторе нужно присваивать по одному что не очень удобно но тоже кот принципе довольно простой понятный и вот что получилось с результатами здесь мы видим то что продавал 3 он цифру нету но он в десять раз хуже чем google про табов а все права в десять раз лучше чем опять же google про табов по вот этим замерам получил с разницей в 10 раз зебра добавкой и звездочка потому что он не поддерживает пустые массивы потому что если мы передать пустой массив он просто упадет там какая-то бага он не работает потапов 3 не поддерживает пустые строки и пустые байта это тоже никак не обосновывается просто если вы кто передадите вы получите ошибку это тоже какая-то бага 3 ст реализация 3вт а я рассмотрел 4 это соответственно apache 3 вт официальная версия facebook 3вт это их как бы форк который не развивает параллельно и и тот и другой требует сборки из исходников и потом apache нужно доставить библиотеку из репозитория 3вт в репозитории не представлен возможно из-за конфликта имен потому что он также называется поэтому его нужно тоже ставить библиотеку из исходников опочецкий 3 вт можно довольно просто скомпилировать а вот фейсбук овский 3вт скомпилировать это развлечение не для слабонервных там нужно ставить кучу фейсбучный их угловых библиотек компилировать полчаса в общем там возникнуть потребуются дополнительные хадра очень очень не советую вам это повторять не повторяйте это дома библиотеки 33 фтор w не требуют код и генерации вообще они разбирают схему на лету и сразу ее используют поддерживаются обе версии питона обе используют сайт он ускорения то бишь питон компилируется все чтобы работать быстрее я бы просто ставится пример кода для apache тоже все довольно просто и понятно а во всех станет библиотек он такой же потому что они опять же разделяет и 5 результаты получились вот такие си python тут два замера для дрифта и с типа это нами без результаты на самом деле не кардинально разные сайт он не дал большого и не ну и также мы видим то что 300w показался лучше а все остальные там стоит много звездочек они точно также портят данные 3вт по и и 3 по и при передаче байтов пытается их превратить в строки причем это если мы передаем патронах пытается вернуть и не кодом если внутри будет что-то не содержащая genie код а скорее всего именно так и будет он просто упадет соответственно apache 3вт facebook 3 вт а не наоборот превращаются юникодной строки в байты и опять же нужно как-то возвращать назад чтобы получить правильный тип то есть они путают типа еще интересно facebook 3 вто есть такое странный такой баг если создать структуру который будет больше чем 255 полей то в питоне 3 она просто не заработает потому что они генерируют такой код который является синтаксически невалидным на втором питоне работает на 3 метра три в три дабл ю типа не портят и показывать хороший результат здесь показан предыдущий график на уже с разбиением на кодировку иди кодировку не показался интересно то что сайт он улучшает случает 3 вп а я добавление сайта на улучшает де котировку и ухудшает кодировку возможно не что там неправильно сделали но просто интересное такое замечание apache авра я рассмотрел 3 реализации то соответственно официальная фас тавра которая написана сайта не обещает лучшую производительность и пай авра которая использует бандунге к либо вра соответственно стандартной хищной реализация патчи евро они все работают во всех питонах ставится нет некоторые ставить из репозитории некоторые надо собирать но разработчик по евро приложил shell script который собственно говоря это сможет вам сделать пример код для патча евро здесь библиотека использует интер в качестве интерфейса используют файлы и поэтому если мы захотим просто си реализовать значение в память то приходится использовать строковые по этой потоки эссе реализовать у них это упаковка и это распаковка как мы видим в предыдущих примерах и пока упаковкой распаковка вырезали на один слайд это тоже пришлось но 2 разнести кода приходится много писать фас тавра упаковка похожа на предыдущую но чуть-чуть другая и распаковка а вот по евро в лес на один слайд там кодовых уходит меньше потому что они не заставляют потоками мучиться и вот результат и то же мы видим серьезные различия между первым и вторым четыре раза примерно а между вторым и третьим около 10 раз то есть по евро использующий сильную библиотеку действительно намного быстрее там стоит звездочка потому что во втором питание он тоже портит данные строки опять превращается в байта в третьем питание нормально давайте посмотрим на топ собран из всех предыдущих сравнений это выглядит примерно вот так мы видим то что тут ваш не вошла ни одна референсная имплементация они все были достаточно медленные неудобные здесь только sea pro тапов требует коды генерации остальные работают прямо так без к регенерации и это же можно из этого сделать какой-то вывод о том какой формат нам больше подходит общие рекомендации следить за альтернативами если у нас есть джейсон то не значит что его нужно везде использовать возможно мы возьмем какой-то другой формат и получим получим лучшие результаты рассматривать альтернативу соответственно референсная библиотека не всегда самое лучшее это показал результат то что ни одна из них не вошла в финальный этап потому что они все требуют каких-то дополнительных усилие вроде компиляции кода генерации альтернативной работают лучше но не все потому что вспоминаем про табов 3 в которой в десять раз хуже чем референсная даже и особенно хочу сказать то что бенчмарка верить не надо потому что никто за вас ваши данные не про бенчмарка это если вы передаете например поток байт это будет совершенно одна картина если ваши данные содержат например кучу интерьеров это совершенно будет другая проверяйте на ваших конкретных данных и делайте выводы исходя из этого спасибо вопросы спасибо за доклад а такая просак а вы протокол то в итоге выбрали поскольку у нас сервисов много разных там и где-то начали использовать мясо чпок где-то мы используем три в реализации 3 вп ой потому что в нем есть встроенный рпц сервер и это было достаточно удобно но мне кажется что где-то мы начнем сейчас авра использовать может быть может быть не будем посмотрим такой после большое все-таки попробуйте с бет у брата бафа гуглово она потрите тоже работает бетон и оно реально быстрее 300 и бета я повторю на всякий случай значит там в конце презентации ссылка на значит все бенчмарки выложены в git поэтому если хотите можете прямо отправлять туда окей подчерк листы вот мы добавим по поводу брата бафа все-таки у него есть серьезное ограничение по поводу вот этих типов то что там нету map of есть сложности с листами это конечно решает в версии продам авто рено он пока еще в бете поэтому я здесь не рассматривал потапов как бы мы не стали использовать именно исходя из ограничений формата на сегодня тогда наверно это всё спасибо что пришли ждем вас завтра начинаем также в 10 качеством и"
}