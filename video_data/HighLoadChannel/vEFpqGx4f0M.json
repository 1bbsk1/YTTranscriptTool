{
  "video_id": "vEFpqGx4f0M",
  "channel": "HighLoadChannel",
  "title": "Continuous Delivery, или волшебная кнопка для релизов по запросу / Денис Яковлев (2ГИС)",
  "views": 305,
  "duration": 2291,
  "published": "2017-04-22T14:47:36-07:00",
  "text": "меня зовут denis это же из компании 2гис на самом деле нас тут трое человек десант из новосибирска и третий человек тоже denis и мы он выступает в другой в другой аудитории у нас там шутка ходила при дениса из 2гис а я тут михаила вот я позволю себе немного развить тему моего коллеги да то есть поговорить о континиус delivery то есть континента говоришь надо действительно важная составляющая часть на шоу на нашего процесса но как бы считается что фича сделано только когда она на продакшене да то есть когда ей уже пользуются собственно continues delivery в нашем понимании да это набор практик каких-то инструментарий процессов которые позволяют в нашем проекте commit от разработчика общем любое изменение максимально быстро доставлять на продакшн то есть я тут уже слышал вопрос из зала которые затраты на которые затрагивает мой доклад да то есть я буду немного повторяться ну посмотрим смогу ли не всех ответить в течение моего доклада и так я тут я тоже немного расскажу про 5 да потому что мы работаем в одном деле только немного с другой стороны в других аспектов да то есть справочная кое-как день из уже сказал каждый каждый может получите исчерпывающую информацию о организациях города у нас в системе 2гис это 250 городов большинство из них это города россии но сейчас уже не дав с недавних пор стали появляться заруби зарубежные города это сантьяга это дубай лимассол венеция подаю ну и много то есть мы выходим на международный рынок и это круто вот у нас более 20 миллионов пользователей и наши мопи им пользуются партнер на жену наши партнеры среди которых такие крупные как mail.ru а вот по ссылочке можете подробнее почитать за использовать если понравится для понимания масштаба то есть какой у нас какая у нас инфраструктура у нас три дата-центра 2 в россии это один здесь другой в новосибирске и один дата центр находится в нидерландах в городе дронт он каждый дата-центр это более 20 серверов среди которых апликэйшен ноты до где непосредственно наш код сервисные ноды поисковые сервисы где лежат наши поисковые индексы также база данных очереди много чего другого и команда которая занимается разработкой этого продукта как вот denis тут уже отвечала на поставленный вопрос это 7 разработчиков и три прекрасные девушки тестировщики у нас нашего продукта есть заказчики да то есть это те люди проекты которые заказывают у нас фичи то есть это наши партнеры которые нам пишут письма что вот неплохо было бы у нас еще получить вот такую информацию это наши продукты про продукты компании да то есть это вот сервис отзывов вам это онлайн то есть наш сайт 2гис ru ну и куча там внутренних проектов которые нам тоже нужна эта информация ну естественно пмр который приходит к нам бизнес требованию и и говорят что вот теперь-то мы бежим вот в эту сторону поэтому мы должны как бы здесь вот это вот разработать в итоге получается у нас в среднем от 1 до 5 fitch день готова к релизу то есть и здесь следует понимать это как новая функциональность какая-то так и фиксы багов которые допустим ну пришли там сбоя или от наших партнеров в итоге у нас задача в один в определенный момент стала задача это максимально быстро сделанные нашей печи доставлять на бой естественно ну то есть фактически так грубо говоря сделать кнопку для релиза чтобы просто нажал и новая функциональность на бою появлялась а новые баги нет хорошо интересная задача мы решили выяснить ученом мешает да какие у нас есть ограничения для того чтобы вот так вот взять и быстро выкатывать на бой функциональность естественно самый быстрый вариант да это правильно бою но по известным причинам этого никто не делает здравом рассудке здесь какие у нас ограничение это недоверие то есть было недоверие к тестам то есть тесты должны показывать состояние продукта спасибо капитан все это понимают но тем ни менее напомню у нас сумме по дата-центром около 60 серверов но тем не менее у нас достаточно сложный был процесс деплоя то есть много рощин и в каких-то действий это легко запутаться забыть что-то перепутать недоделать и и прочее плюс еще ну иногда прибегают к нам админы говорят блин чуваки чё вы там понаписали у нас опять когда в этом проблема с производительностью нас контур не вывозит давайте что-то делать вот ну и в принципе такой хаотичный процесс он сильно отжирает времени и нервов то есть нету какого-то понимания текущего состояния то есть где мы сейчас находимся хорошо за этим разобрались обозначили мы для себя вот эти вот ограничения то есть на чем и начали над ними работать первое это тесты мы-то генис говорил да у нас тесты на php юниты их порядка 12000 и нам хочется им доверять да то есть чтобы они у нас отлавливали баги они просто так показывали погоду да вот что для этого надо сделать их надо отладить ну в смысле у нас много падений по всяким внешним причинам нам нужно отладить тесты причем чтобы отладить тесты да то есть это мы хотели пофиксить все баги то есть это как как баги в тестах так и в ходе у нее у нас могли быть но нам мешало сделать но сделать это сделать следующая ситуация да как denis уже сказал у нас время выполнения было порядка шести часов то есть мы очень поздно узнавали о том что у нас что то не так плюс часть тестов у нас зависело от данных то есть прошло 6 часов упали тесты и непонятно они упали как бы они нашли баг в продукте да и или ну упали потому что ну вот так вот звезды сложились вот что мы сделали мы взяли вот определили вот этот вот набор тестов до которой у нас зависело данных слава богу это было в пол были вполне определенный тест их получилось легко локализовать была проблема в базовых классов этих тестов то есть не пришлось переписывать там каждый тест в отдельности ну просто какое-то время несколько там дней мы затратили на то чтобы это все ну найти определить и пофиксить то есть мы зари фактор или эти тесты убрали зависимость от данных вот мы взяли за использовать за использовали парад с чтобы ускорить выполнение нашей tcf тестов и получить бы ну более быстро фидбэк пони по нашему продукту эти эти действия позволили нам сделать следующее мы теперь берем запускаем тест и разбираем падение то есть смотрим что это там баги в продукте баги в тестах может ещё что-нибудь фиксе снова запускаем снова фиксер снова запускаем снова фиксе и помню был сколько было итераций но в итоге мы получили стабильный проход тестов за 50 минут против шести часов вот и добились на самом деле того что у нас тесты показывают состояние продукта и что самое важное да то есть как бы сказала не запускаются теперь у нас регулярно что позволяет нам не запускать ситуацию до то есть что тепло ура мы добились все это это больше потом не запускаем через них проходит некоторое время да и у нас опять такая же ситуация теперь мы внимательно смотрим на результаты наших тестов и что-то упало мы это исправляем оперативно и и тестировщики у нас будет приучили тестировщиков смотреть на качество своих тестов в итоге мы сместили приоритеты в сторону как поддержание стабильности наших сборок вот протесты рассказал идем следующие тепло и да то есть хорошо мы разработали там протестировали все хорошо но счастье до сих пор нет потому что как бы нет новой функциональности на продакшене этой еще как мы помним еще один такой важный шаг до то есть доставляющие нам кучу кучу работы до кучу нервов там неопределенности какой-то вот то есть что нам нужно сделать чтобы парили зить код наш на продакшене да то есть у нас 60 серверов и нам нужно непосредственно доставить этот код опять же если нужно обновить данные если нужно опять же поставить новые версии компонент перри запустить сервис и там опять же тоже если нужно подложить конфиге выполнить какие-нибудь команды в общем очень много чего нужно выполнять что мы сделали чтобы уменьшить нашу головную боль да то есть мы очевидно что нужно все это упрощать потому что количество серверов растет и она будет расти до и уже дошли до какого-то предела где не справляемся не справляется да человек который релизе упрощаем упрощаем как переходим на шеф то есть система система управления конфигурации и шеф которая теперь за нас делает все вот эти вот вышли перечисленные шаги и делает она ну то есть в зависимости от того какая у сервера роль то есть она сад естественный ну как бы последовать команда выполняет вообще знакомы с шефом хорошо вот ну то есть теперь у нас есть командочка даже в клиент которая запускается на сервере и смотрит там мы получает себе информацию какой-то сервер а это вот вот у него такая то роль значит я должен выполнить вот такие того данные то есть в такие шаги до то есть он эти все шаги выполняет и все говорит там типа я поразился я молодец вот но у нас остается какая проблема у нас есть несколько именно сценариях релиза то есть первый сценарий это когда мы выкатываем просто код и обновляем данные да в этом случае мы должны обновить те сервера так где у нас крутится непосредственно код и сценарий когда мы выпускаем новые версии наших поисковых утилит для справки поисковые утилиты это отдельные утилиты которые ходят входят состав нашего piano они разрабатываются другое звено сторонними команда минута же тоже в нашей компании и они как бы мы просто мы их релизе мда потому что они входят в состав нашего api в общем у нас есть два сценария релиза все равно приходится заходить на каждый сервак тазы и там выполнять вот эта вот команда чк у не хочется этого делать мы берем grandeg система которая позволяет вот это вот вот эти вот flow весь автоматизировать как реализуем там зашиваем туда вот эти два сценария и в итоге у нас получается по кнопке то есть в зависимости от того какой у нас набор функциональности пришел в релиз да то есть мы запускаем соответствующий сценарий теперь мы это все сделали но нам все равно хочется чтобы окончательно быть уверены до что вот продакшене релиз у нас тоже пройдет нормально ну потому что ну вот еще что нибудь сделать вот у нас мы вводим репетицию релиза то есть организуем стейджинг то есть это контур который немного в меньшем масштабе повторяет у нас продакшен то есть допустим если на продакшене вот у нас 20 серверов там много апликэйшен not база данных data тут всего там пару apple кыш нот в общем вот такой вот production очень уменьшенном масштабе но там тем не менее присутствует все наши боевые данные то есть если мы до этого вот в тестировании это работаем с какие там допустим с одним проектом или там с двумя там в зависимости тоже от задачи то здесь у нас есть полный набор данных с которыми как который есть вот на бою значит тут мы тоже самое делаем сценарий точно такой же как на продакшене только мы еще добавляем запуск нагрузки да потому что у нас идет нагрузка на продакшене и мы должны посмотреть не изменить ну как под нагрузка себя у нас как процесс релиза поведет себя там не упадет ли чего-нибудь ну вообще просто убедиться то есть раунде у нас опять же запускает индекс танк там подается нагрузка на вход нашего стайлинга и проект производится deploy серверов то есть у нас прошла прошла репетиция релиза все нормально все хорошо мы немного успокоились и можно дальше релизе да то есть фактически получаем здесь вот кнопку нажала и все по релизиться ну еще один парочку моментов эта нагрузка на то есть у нас много пользователей постоянно пользуются опять им там порядка 1200 рпс у нас вот и от наших администраторов стал опрос ну стали поступать жалобы они прибегают говорят блин народ у нас что-то productions ведет себя все хуже и хуже ну вы как-то не могли ну хоть как-то контролировать то что вот вы делаете что она там работает под нагрузкой как это ну хоть что нибудь сделайте пожалуйста вот то есть у нас увеличивается время ответ этого увеличивается нагрузка на базу админы жалуются мы сделали попытались попытались вы решать решить это следующем то есть мы взяли берем логе с продакшна формируем опять же лог для яндекс танка и нагружаем наш стейджинг ну то есть пускаем нагрузку фиксируем если у нас там какие-то 500 ошибки вот ну когда у нас боевые запросы идут на station is и фиксируем время выпал время ответа api а я вот и сравниваем сравниваем вот этот запуск нагрузки с запуском такой же нагрузки на предыдущий релиз и просто смотрим что ну нету каких-то серьезных пока пам то есть это не полноценная до нагрузочное тестирование с кучей имея track там графиками там научными выводами и прочее да здесь мы смотрим так как мы теперь уже релизимся часто нам важно понять чтобы у нас случайно разработчик не случайно не похитил там какой-нибудь sky запрос и не убил там производительность вот то есть просто ограждаем себя от каких-то явных fa cup of вот нагрузка то есть как какой-то класс класс проблем у нас все-таки этим шагом мы от них отгородились еще немного про статус про статус релиза да то есть когда непонятно нету прозрачного процесса до что вот какие то шаги должны сделать чтобы парили зить это очень тяжело выяснить то есть у нас много участников команды у нас много инструментария чтобы выяснить что происходит и что еще надо сделать нужно спросить нескольких людей посмотреть в несколько мест а тут еще накладывается человеческий фактор про то что один не так спросил другой не так ответил или забыл или не или не до ответил в общем выяснение затягивается это может релиз а рильд мы должны выпускать мы должны быстро вот ну те причины которые проговорил мы решили это дело просто буквально не знаю в течение дня было написано такая система когда даже борт в которую все наши используемые инструменты репортят свои шаги то есть что и что что сделал когда сделал и с каким статусами это завершил в итоге любой теперь может зайти на страничку и посмотреть да что сейчас вот допустим как здесь видно нет да у нас 142 релиз да то есть он у него там создались релизные branch и прошла регрессия ну и общем все шаги которые у нас основные составляющие все у нас завершились и release the station прошел хорошо теперь не надо бегать выяснять никто никому там не сидит перед монитором и не понимает чужие вообще происходит все зашли страничка стало все понятно какие выводы мы сделали теперь да мы можем релизиться по требованию то есть мы специально ну какой то перед ввели такую попробовали такую практику до чтобы релизиться там каждый день ну чтобы обкатать нашу систему то есть у нас каждый день на продакшн выезжала все сделанные фичи на самом деле нам так часто в реальной жизни релизиться не надо но мы теперь уверены в том что если вдруг понадобится да мы возьмем и быстренько парили зим то что у нас есть какие выводы мы еще для себя сделали что но поначалу казалось ну не понятно да то есть что надо сделать так как как вообще с чего начать как подойти к этой проблеме данного теперь мы сейчас понимаем что это задача вполне нормальная она решаема просто для неё требуется комплексный подход да то есть если вы задумались о внедрении таких такого процесса да то есть про обычным внедрением инструмент одну кого-то подходящего инструментария эту задачу не решить требуется еще перестройка процессов работа с командой с людьми нам нужно объяснять почему мы это делаем зачем это делаем почему вот так вот будет лучше она раньше была не очень а мы хотим сделать еще лучше вот и в нашем случае как единиц по моему уже говорил внедрение всех этих процессов занималась внешняя команда она в основном как состоялся состоит стояла и состоит из людей которые вот недавно пришли в компанию они это каким казалось плюсом они просто свежим взглядом посмотрели на процессы и сказали что вот мы бы сделали так вот мы нам нам показалось это решением ну удачным решением вот и что вы хотелось бы еще сказать да что внедрение таких процессов надо не бояться ломать существующие устои которые даже если к ним всем привыкли там всем нравятся но на самом деле они ну мешают дальнейшему развитию вот у меня все спасибо пожалуйста вопрос я думал все устанут и не это и не будет вопрос здравствуйте вот сразу же вопрос спасибо за доклад интересно по поводу внешних команду привлечение и почему был выбор на внешний ресурс 1 и 2 долго занял самый процесс то есть здесь можно да м я понял вопрос знаете то есть не было такого что люди сидели и думали как же нам сделать и давайте мы привлечем каких-то внешних людей да то есть пришли люди ну просто пришли новые люди в команду в компанию до разработчики ты там тестировщики у которых был какой-то бы ground и люди стали задавать вопросы почему так давайте как бы что-нибудь сделаем поменяем дай что-нибудь потому что ну как-то сложно жить и было принято решение что ok 1 раз вы тут как инициатива наказуема до новые давайте не будете делать новые фичи едите его занимаетесь вот этими вещами то есть это как сказать лунный а да да да то есть вот сверху революционный а снизу эволюционной да да то есть на самом деле ну это лично мое мнение что этот подход более эффективные да потому что люди стараются сделать как им удобно как удобно для компании будет компании будет мне хорошо будет компании хорошо будет всем хорошо спасибо за доклад вопрос такой вот вы сказали что эволюция все прям идеально но для компании это затраты до на то чтобы этот процесс встроить то есть наняли новых людей которым могли бы приносить профит и вроде как в выгоду а мы принесли профит да понятно но это были затраты на исследования пробы и ошибки во первых какое время у вас за этот процесс чтобы перестроить вот тут от ковра да я вроде ответил поэтому спросил вот и как настолько дальновидно руководство же или доверяет настолько разработчикам что позволило новую команду использовать в целях перестройки процессы смотрите отвечу сразу на вопрос про сколько заняло да то есть это что не ответил мы занимались этим с концам там плюс это где-то с мая до то есть мая и вот на данный момент получили это результат и сколько там около полугода может чуть меньше да вот есть планы до denis по моему их уже озвучил эту практику потом распространить на другие продукты компании до этой минуты на другие команды вообще стратегически хочется сделать так чтобы команды они писали только бизнес-логику до приложение потому что сейчас у тому продукта до у команды отдельное у него помимо то что он должен разрабатывать не последний непосредственно бизнес-логику приложения у него стоит постоянно головная боль как нам это там процессу наладить как нам как нам его заде пой мне еще надо пойти поговорить с админами as admin ну то есть убедить админов короче в общем есть разработка продукта и вот где он сдал это можно назвать и вот это вот devops хочется снять со всех со всех команд предоставить им какие-то рельсы до которые не просто встраиваются и быстро выкатывают выжмут да этот эксперимент пока он идет хорошо то есть мы вот-вот работали с вот свобо pedo сейчас на данный момент мы еще с другими с двумя другими командами работаем но пока результатов нет поэтому я о них не говорю спасибо очень познавательно такой вопрос курс процент покрытия кода тестами так как тесты тесты пишутся до новый естественно он растет как то конкретных цифр и у меня нет потому что ну и я знаю что это тоже такая составляющая процесса и континенты грешно delivery даты смотреть на эти метрики их понимать но вот в своем докладе я упомянул критичные вещи которые мы в первую очередь потушили пожар и то есть в дальнейшем будем внедрять и какой-то анализ кода и покрытие до чтобы понимать и ну когда уже так все будет более-менее стабильная гладко то есть сейчас сейчас пока конкретных цифр у меня нет я только могу предполагать что раз у нас теста увеличивается до у нас увеличивается покрытие сейчас и перепроверяете руками что все окей просто маленький то вы не можете верить полностью дата то здесь я с вами согласен да то есть у нас я не говорю что у нас и грейся покрывает весь функционал но я могу утверждать до что я вот прошлый релиз и я выкатил на зеленой регрессии если вы качу текущей лист зеленой ригла ищите сената с какой-то долей вероятности в более-менее в нем уверен то есть естественном и мы в этом направлении будем работать но сейчас пока это некритично спасибо за доклад про смелость в конце сказали и у меня такой вопрос не собираетесь ли вы объедините команду тестировщика вы и разработчиков то есть чтобы разработчики писали тесты и менеджеры писали тесты то есть я много лет работал в разных компаниях и в стартапы работал и в крупных компаниях и собственно нигде не был отдельной командой сыров щиков и у нас там 97 процентов покрытия кода и все отлично если у вас такие планы ну вы знаете мы как сказать знаю как по-русски по-русски сказать заставляем это слишком группа дому пушек девелоперов чтобы они писали тесты на свою функциональность да то есть это какое-то считаем как бы правильно и это нужно делать да и они у нас но они постепенно у нас ну начинают это писать объединять разработчиков и тестировщиков нет таких планов у нас нет вот просто у нас повышается как сказать тестировщики раньше там много там руками и да я что-то делали того стал но то сейчас у нас и у них а техническая экспертиза повышаются донесет в автоматизацию то есть тут оттуда сдвигается акцент и ответил обиде объединять нет мы пока пока не думаем здравствуйте я вот вроде вижу все хорошо да автоматизировано у нас компания тоже самое только вот интересный вопрос что происходит с тем когда например изменяется схема в базе данных как вас происходит именно переписывание сценария прямо обновилась после схема базы данных изменения схемы база данных у нас на тепло и не сказывается мне как то есть изменение схему база данных это там миграция да как они дельта на накатывается на базу данных все автоматизировано да тоже автомобиля вот-вот шефу которой я упоминал да он в одном из своих шагов то есть вызывает конечно это так уверен jenny lind какой то есть она он вызывает финк афинку же делает ее my great которая накатывает миграции спасибо андраш скажет пожалуйста про не понимаю что у стейджинг один не те же баз данных что и продуктивно да какая там проходит агрессии тестирования она не влияет деструктивный повертев деструктивно термина боевых в базах данных не у них не общее базы данных у них ну физически это разные сервера да просто набор данных у них одинаковый то есть мы в во время репетиций во время выкатывания на сцене jack mono продакшна не влияем никак а то есть там если база своих продуктивно ходится или это не актуальные данные нет дома не там актуальны то есть там свои продуктивно да спасибо да вопрос такой как у вас как вы сбегаете downtime а в случае допустим альтера там кого-то таблицы ну а у нас это полный вопрос даты вопрос интонация была что там еще 2 будет у нас как требование то что кот на штаб их пышных он должен работать как со старой версии базы данных так из новой то есть у нас не следит за этим и у нас нет такой ситуации что мы проапгрейдили нашу базу данных да и наш весь код отвалился да потому что дробность какая-то колонка то есть когда приходит задача до разработчик понимает что надо как-то изменить он поддерживает и новую и старую версию базы данных и на следующий релиз заводит задачу о том чтобы ну там выкрасить то что уже вот старая вот ну так если дин тут же как бы если какой то лог глобальный будет то у вас просто select и там ну допустим лир и сэр ты повиснут допустим то есть вы не сможете обслуживать клиентов ну во первых у нас in sort of нету на сапе ай да мы только как бы отдаем информацию дамы и мы никак не модифицируем база вот так что пока я еще не натыкался на такую проблему значит у меня вопрос такой не совсем вопрос до двух частей первая просто хотелось бы сказать что приятно видеть что где-то континиус integra и шин действительно существует извините во многих по-моему я продолжу дело в том что я непосредственно работу на заказной разработки в условиях контракта которые разыгрываются по тендерам и конкурсам и практически невозможно никогда не когда заказчик не согласиться дата рамках годового контракта убить полтора человека года на какую-то автоматизацию я понимаю раз и собственно второй вопрос он вытекает из тоже специфики этим проектов на которых я работаю регулярно заказчик требует выкатить фичи немедленно или там bug fixes то есть никак не согласую это с разной политика на проекте ответственно привязываясь к вашему процессу у вас фича завершаются тестируется мер jets а в мастер складывается такая ситуация что в один чудесный момент надо значит из мастера собрать релиз но при этом чтобы у него не пошли не все фичи которые там есть как бы вы ни с этой задачей 3 а ну то есть да я понимаю да почему вопрос я понял что у нас такая ситуация с такой ситуации не сталкивались то есть мы если если в мастере уже кстати есть фича которая не нужно на продакшене и мы понимаем это мы выключаем эту фичу в коде то есть это настройка в конфиге то есть она все равно в рис уезжает но она не доступна пользователям и если в то есть завтра нам потребуется его включить и да то есть конфликт переключается да и все она доступна то есть нет у такого у нас пока не было необходимости что-то там выдерживать из столов и стопы зато из-за того что оно не должно оказаться на продакшн и мы его просто выключаем понятно но жизненная ситуация бывает таким про жизни говорю у нас тоже жизнь дениц к одному из предыдущих вопросов эти остатки можно чуть-чуть уточни пожалуйста конечно тренировка проводится на полном клоне боевых данных bunny очень маленькая какими средствами как часто и в какое время этот клон изготавливается но у нас есть месячный цикл каждый месяц у нас приходят новые данные у нас есть процесс импорта просто их им портим 1 месяц то есть они не регулярно обновляемые есть какие то данные которые у нас обновляются каждый день данного я не знаю какой процент это от общих данных мы это очень маленький то есть такая реклама там вот так а это что то что меняется часто а большой вот bunch данных которые там вот как раз все эти организации адреса и прочее это все обновляется раз в месяц обновляется стандартными механизме частью нашего продукта да в таком варианте понятно скажите пожалуйста вот интересует вопрос как вы подготавливаете релизы как происходит изменение в конфигах и кто это делает и кому то есть от разработчика как билл доходит уже до продакшна вы были на прошлом докладе нет нет хорошо тогда я расскажу просто это denis рассказывал дамы коллега либо я могу как бы вам просто лично рассказать потом потому что много народа слышала давайте так давайте вам лично расскажу хорошо спасибо"
}