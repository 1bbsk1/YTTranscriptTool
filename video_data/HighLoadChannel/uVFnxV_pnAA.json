{
  "video_id": "uVFnxV_pnAA",
  "channel": "HighLoadChannel",
  "title": "RoadRunner: ускоряем PHP без фреймворка / Наталья Воронина (Национальный каталог)",
  "views": 582,
  "duration": 2514,
  "published": "2023-10-06T07:22:08-07:00",
  "text": "Всем добрый день Меня зовут Воронина Наталья настоящий момент я являюсь лидом в компании национальный каталог это Часть системы маркировки И сегодня я хочу рассказать о том как мы переходили нарудранер с PHP ускоряли нашу PHP приложение при этом у нас не было фрейворка Итак зачем мы вообще задумали этот переход и какие проблемы перед нами стояли Первое это Увеличение количества потребителей маркировка постоянно растет увеличивается количество товарных групп которые к нам приходят и соответственно увеличивается количество пользователей и запросов которые поступают от этих пользователей также у нас местами была медленная скорость обработки запросов медленно это понятие конечно относительное где-то это было 150 миллисекунд где-то было больше секунды зависело естественно от запросов базу от того там кэшировался запрос или нет В общем это были Конечно разные скорости ответа но видно было Что во многих точках можно было бы ускорить Особенно когда ты смотришь на какие-то скорости абсолютно другие цифры которые ниже 50 миллисекунд также была большая проблема Я на нескольких Ван туманах от команды слышала что ребята дальше видят себя как голлинг разработчики и хотят попробовать писать на гол наверное такая классическая уже история 2011 от 2000 точнее 21 2022 года что многие команды на PHP хотят переходить на гол Ну какие варианты решения всех этих проблем были это снизить количество запросов Это не то что мы могли сделать не могли прийти к бизнесу и сказать что извините новый товарные группы мы не принимаем больше пользователей мы обработать не можем соответственно это не очень вариант оптимизировать код и запросов базу это тот пункт который в любом случае нужно постоянно делать над этим постоянно нужно работать но это точечная работа можете про свои там особо тяжелые запросы и над ними смотреть что в этом можете сделать оптимизировать Где вы можете добавить кэширование где может быть там перенести куда-то в ластик или в общем работать над этим нужно постоянно но это более точечная работа хотела сделать что-то глобальное какое-то ускорение смириться с потерей части команды по поводу Но это конечно было не совсем вариант мы долго собирали команду Лично я и не хотелось естественно терять а и взор пал народранер Я слышал от нескольких команд которые на него уже переходили на тот момент Что же это за зверь это высокопроизводительный сервер приложений PHP Application Server также пишет что балансировщик нагрузки и диспетчер процессов написанный на goland еще была такая игрушка роутеранер и есть такая замечательная птичка но нас интересует именно как Application сервер чем он принципиально отличается от PHP наша печка приложение перестает умирать Под каждый запрос Мы конечно Привыкли что у нас но Здесь мы получаем другой подход у нас наш пикот запускается один раз и дальше он просто ждет запрос получил запрос обработал его отдал ответ мы перестаем тратить время на синтаксический анализ на какой-то генерацию кода в общем вот эти вот вещи мы убираем один раз его запустили и работаем на том коде который Итак какие есть альтернативы это уже такой наверное стандарт у нас индустрия мы как раз таки на нем были есть менее популярные инструменты печки это замеры которые предоставляет сама компания спирала не опубликованы на их сайте что мы здесь видим графики верхней относится к 1000 секунду Нижний идет на 10 тысяч секунду и видно что рудранер лучше всего с этим справляется на 1000 еще с ним борется но есть там еще один график который показывает отказа устойчивости Там есть еще один инструмент самуля его здесь не представлена в замерах на самом деле мы в одной команде мерили ряд php.ruнер и свули в разных сочетаниях слова Равель и симфония но в любом случае на всех метриках побеждал Ну возможно другие замеры Буду рада увидеть Итак классическая печь приложения 22 году выглядит примерно следующим образом нас есть клиент есть и он запускает уже естественно перед все это завернут обычно в кубер перед этим стоит балансировщик есть какое-то основное хранилище данных после ну какая-нибудь любая реализованная база обычно все-таки как основное хранилище реализованку сейчас использует для кэширования какой-нибудь у вас будет наверняка инструмент типа ради самкаша может быть будет специализированный там для оптимизации поиска что-то вроде эластика была хранилище например хаос и какие-нибудь очереди и в принципе так примерно выглядит наше приложение естественно там местами чуть посложнее но как базовая схема Это примерно а что мы получаем Когда встраиваем роутеранер в архитектуру в принципе не сильно много меняется мы можем оставить и балансировщик и кубер и Джинкс заменяем мы по факту PHP на орудранер на съемке примерно представлены как он работает то есть это базовый сервис входа есть дальше мы определяем на какой worker пойдет именно этот запрос А через мы можем вызывать какие-то процедуры например и взаимодействовать с ним база данных House Of Rabbit это все остается по-прежнему Окей вроде выглядит неплохо поизучать все материалы Какие плюсы было в переходе во-первых мы можем получить существенное ускорение скорость ответа об этом говорится во многих статьях есть марки которые показывают этот прирост мы можем строить гибридные печки приложения и покрыть в принципе последний вопрос что команда хочет попробовать и в принципе аргументирован возможность предотвратки запроса на гол Это скорее такой плюс например Вы можете аутентификацию вынести на голову и даже до печки не доходить если у вас или валидировать сон запроса то есть схему какой-то если у вас не все поля переданы Можете откидывать даже не доводя до печки потенциально мы увеличим нашу пропускную способность минусы а так как у нас во-первых нет фреймворка мы достаточно быстро безболезненно не сможем перейти нам придется адаптировать код и разбираться по нюансах работы рудранера переписывать эту кодовую базу возможно утечки памяти об этом точно также говорится во многих статьях но Ребята кто переходил говорили что в первую очередь мониторить память потому что мы пишем код все-таки адаптированный под то что он умрет и зачастую не Чистим а сложность отладки Но об этом у меня будет отдельно высокие риски привыкла таки наоборот это в принципе если мы меняем наш Application Server то естественно это высокие риски и инструмент все-таки достаточно молодой ответов там нас такого слова всегда мы можем найти риски все-таки присутствуют но благо команда очень отзывчивая готова отвечать на вопросы помогать Ну многие из вас наверняка все-таки работают с приемборками и сдаются вопросами А что если у меня все-таки есть фреймворк насколько мне вообще все это будет интересно и полезно Ну во-первых вам однозначно повезло потому что готовые какие-то адаптеры мосты для перехода народранер они есть для большинства популярных фреймворков симфонию все что можно посмотреть по документации постоянно обновляется Ну вот такое самое популярное свежее список там проще переходить но это не значит что все что будет дальше она вас не касается даже используя фреймворк в команде у вас могли использовать какие-то функции которые не поддерживает Итак мы решили на переход жмем красную кнопку И что же нам нужно делать Ну во-первых php8 Plus очень рекомендую перейти перед тем как Вы решились Наруто возможно до этого на более ранних версиях тоже работает но у нас уже был запущен проход процесс перехода на восьмерку поэтому мы уже на неё и ориентировались а писар 7 request response если опять же вы например то это в принципе уже такой во всех приморках но у нас из реквеста бралось много этом испечь пин-пута из массива пост Get и вот эти все вещи их приходилось переписывать с посты Get Там попроще чуть-чуть Ну вот файл прям то что подлежало полной замене то есть начали брать информацию из реквеста и Соответственно ответ формировать если используется сетку метод он не допустим но опять же вы можете сформировать куки которые вам нужны через просто добавление заголовка значение которых доставляется Но это можно посмотреть как она генерируется его сформировать самостоятельно еще один важный момент это чистка состояния важно Очень чистить статику Например если у вас там сессии хранятся в примеру хранится статике коннектик базе статике то соответственно вы их туда инициализируете на Первом запросе Если вы не почистите эту статику то на последующих проходах статика уже будет наполнена в этом Может быть как плюс так и минус но большая часть статики все-таки про плюс я расскажу чуть попозже в контексте база у нас еще была такая специфическая штука дистракция в процессе прохода по бизнес логике формировали массив там товаров которые нужно было отправить в очередь на какую-то дополнительную обработку И в дистракте то есть при умирании скрипта по факту отправлялась в очередь весь этот пул Ну соответственно перестал срабатывать и очередь перестали отправляться сообщения решается это достаточно просто можете сделать статический метод который будет на каком-то на какой-то чистке состоянии все это отправлять в очередь с дистрактом в целом такой себе подход так отладка Это была моя личная боль наверное нас команде было 50 на 50 кто-то сидел на баги на тот же момент когда переходили ну а кто-то как я например предпочитали более старый подход Вардан принтер Дай и там использовать стандартную функцию нашу DD которая поддерживается у нас была своя который позволяет просто обновить страничку и увидеть результат на странице так вот это все перестает работать последних версиях насколько мне известно они все-таки стали работать но они вам все что могут сделать это вывести информацию влог файл для меня это уже какой-то не совсем классический подход отладки печь пикоды Поэтому туда я даже особо не смотрела ну и перешли Мы все дружно на xbok в принципе ничего специализированный инструмент прекрасно можно с помощью него отлаживать Особенно это удобно когда нужно несколько запущенных воркеров отлаживать и вот как раз таки искать какие-то проблемы со статикой это конечно же реально А вот такими это уже не пройдет а локальное окружение Что там у нас подлежит переписыванию во-первых большую часть сейчас докере ведет разработку докер файл спички fpm если у вас джинсы то он тоже переходим на xdpack чем я уже ранее говорила настраиваем конфигурационный файл драйвер основной это он может по-другому называется потому что это конфигурационные устанавливаем необходимые зависимости Первое это сперва рудранер а вот все остальные что типа это зависимости здесь у меня явно указаны какие мы версии берем Но просто в процессе перехода некоторые патчи очень так сильно отличались и стреляли что-то обновился У тебя какой-то старый код перестал работать выясняется что там добавили свойства потом через неделю опять обновился уже все снова работает в общем это все-таки такое развивающийся продукт что когда вы стабилизируете Возможно на определенные версии и ручное управление какую версию вы используете Это неплохой вариант а что делаем снежинксом Джинс в нашем случае мы все-таки решили оставить и не перегружать роутер какой-то дополнительный логикой там политики курс или там отображение статических файлов типа CSS Там фоток за счет этого минимизировались риски при первой выкладки на продакшн и плюс мы не переносили логику Если необходимо нам все-таки использовать через мы просто указываем и прокси вот Обратите внимание что прокси мы там Ставим на PHP порт 8083 дальше покажу PHP здесь это просто алиас контейнера 8083 это там где у нас запускается Windows и D в конфигурации файла Error яма вот здесь как раз таки пройдемся потому что можно указывать в этом файле Во первых для естественно ваши локальной разработки это версия конфигурации именно не самого рода базовые использования если не Укажите в принципе все запустится Ну например логи писаться не будут поэтому его все-таки лучше указывать сервер команд это точка входа нашего PHP приложения То есть у нас там в директории паблик например лежит индекс phps которого все стартует Вот его мы указываем Ну и переменные окружения которые нужны именно для настройки дальше Вот то чем я до этого говорила порт на котором все это запускается он оказывается здесь а самая такая наверное для локальной отладки часто изменяемые и важная конфигурация это дебаг режим в пол дебаг True Мы работаем как бы псевдо таком PHP формате потому что у нас под каждый запрос код все-таки обновляется если мы добавили какую-то новую строчку кода страничку и получим этот Exception Если же у нас стоит и полном горке раз например два уже там запущено 2 worker то чтобы не делали в коде никаких изменений не будет это уже все равные 2 квартира и пока вы не перезапустите контейнер или изменение не применяется по-разному на локальной разработки файл наверное самое удобное дальше прод конфигурации они естественно отличаются httpull num workers Вот это количество воркеров сколько у нас будет запущено оно рассчитывается в зависимости от ваших доступных логических логических ядер Самый наверное важный параметр если сомневаетесь как его настроить либо методом проб и ошибок пытаетесь рассчитать от ваших ресурсов у нас он сейчас по моему стоит 16 но не уверена останется постоянно таким Макс Джобс это максимальное количество проходов на одном горкера сколько он запросов обработает Если вы там поставили 500 то 500 работает и потом будет перезапущен не сможет больше принять запрос эти строй тайм-аут это время которое дается соответственно его уничтожении супервизор это уже отслеживание состояния worker например проверка что worker все еще жив это вот чтик параметр в одну секунду это на самом деле достаточно часто и наверное излишне рекомендую все-таки повыше ставить 10 секунд например Здесь если вы сомневаетесь что у вас приложение может вытекать по памяти то этот отель лучше ставить поменьше поначалу мы стартовали с 30 секунд То есть это время через которое будет принудительно перезапущен worker каждый 30 секунд он будет перезапущен вы смотрите по мониторингу памяти если проблем каких-то серьезных не наблюдаете или что-то уже устранили можно пробовать сейчас мы вроде как дошли до 10 минут если Макс worker Memory это сколько мы как раз таки выделяем максимальное количество памяти на worker и Ну если мы достигли предела Точно также будет перезапущен exect отель это максимальное время сколько может worker выполнять запрос не ограничиваем дальше еще более такие двух относящиеся метрикс это сборы метрики в промтеоз Ну и статус это по факту стандартные халчики для опять же мониторинга коннекты к базе Ну то есть как у нас тоже так достаточно часто живет PHP приложения пришел запрос пришли там PHP создаем новый Коннект Делаем его сингл тоном чтобы на каждое создание модели какой-нибудь создавали новый Коннект закончили там обработку бизнес логику закрыли Коннект следующий квест новый канал если нас это устраивает что нас при каждом запросе создается новый Коннект и закрывается соответственно OK мы можем продолжить так существовать тогда не забываем чистить статику закрывать Коннект и но в принципе мы можем здесь получить прирост за счет того что на каждое соединение не устанавливать новое соединение с базой Можно попробовать не чистить статику Но тогда нам нужно проверять что у нас наш Коннект все еще жив мы все еще можем пользоваться можно там на старте например какой-нибудь сделать или что-то подобное Ну и рассчитать Естественно сколько потенциально коннектов будет и установить соответствующий параметр Макс connections на базу То есть у вас сколько будет запущенных паркеров по факту столько будет коннектов плюс если у вас есть понятное дело в разное время запускаются учесть тоже надо плюс туда нужно добавить еще обработчики очередей и если они там не сами содержат логику а запускают какие-то отдельные Джо мы то Ну сколько Job запускается вот тоже столько потенциально может быть коннектор Ну и в зависимости от этого уже устанавливаем Max connections но тут тоже такой нюанс что если у вас соединение все-таки там как-то испортилась в процессе не знаю там сетевые проблемы Вы по Connection Timeout уже отвалились вам нужно все-таки проверять постоянно что это соединение живо Мы в итоге пока что отказались от этого и перешли обратно вернулись к чистке состояния вообще хочется чтобы наверное какой-то спросить чтобы может быть они сделали на стороне рода и можно было работать с ним Но посмотрим Итак выкатили мы весь наш переход ощущение были Вот примерно такие все горит все упала а чего же нам в итоге все таки удалось достичь Какие проблемы были Ну вот когда мы только выложили тесты с 99 плюс процентов ушли в 35 процентов слава Богу благодаря команде за две недели к релизу Мы вернулись в 99 21 процент Но это было проделано конечно колоссальная работа восстановлению работоспособности естественно мы до этого там очень много это локально тестировали многих Проблем все равно не увидели локальный прогон по тестам первой колонке страницы на которых проверялась чуть больше было на такие какие-то основные на PHP в Перми сколько занял запрос скорости рудранер в режиме дебактру и рудранер в режиме нескольких воркеров Ну и здесь видно что в принципе рудранер с таком формате как тру он в принципе по таймингом и не отличается от печки что достаточно ожидаемо Но как Только мы добавляем worker и перестаем Под каждый запрос собирать то мы получаем прирост где-то видим что в три раза где-то в 10 раз больше в течение 10 раз я не видела но это очень существенный прирост у нас прям очень порадовал уже на тестовом стенде здесь стабильно Мы видим что Примерно там два с половиной три раза здесь больше про rps первые задержки ответов мы видим на раньше видели на fpmy на 75 пользователях с приходом первые колебания еще такие незначительные не супер стабильные мы видим на 180 пользователях а существенные стали видеть на 320 пользователях Но это надо сказать что это не какой-то Там прям совсем стресс скорее стандартный нагрузочное тестирование которое мы проводим перед релизом что мы сильно не просили вот системные проблемы Ну по сети каких-то мы изменений не увидели в целом тоже без все без изменений А вот память как говорилось она подросла причем это график насколько я помню на 60 секундах снятый здесь примерно в полтора раза для моей память выросла над этим что предстоит работать и продолжаем работать что тоже сделано мы продолжаем итоги что нам удалось Чего нам удалось достичь после того как мы перешли Ну из плюсов мы увеличили пропускную способность три раза на предыдущем графике уменьшилось время ответа местами в 2 где-то 8 раз но это результатом автотестов то что нам заключение которое дала команда тестирование Появилась возможность реализовать гибридная печь пигоприложения сейчас пока что мы еще на гошке ничего не делали но потенциально нам теперь будет значительно проще внедрить Ну я честно говоря все равно убеждена что переход народ далеко не в каждом проекте необходим и если у вас там интернет магазин в котором 100 заказов в месяц естественно это будет излишне Если вы работаете с каким-то большим количеством пользователей вас растет нагрузка есть уже метрики свидетельствуют которые о том что вам нужно повышать как-то скорость ответа точнее наоборот понижать скорость ответа и пропускную способность улучшать то тогда да Стоит задуматься мы во-первых переписали большое количество года я здесь пишу что здесь тысяч плюс строк кода был Диф Но это был div на ядро системы то есть такие самые контроллеры которые какие-то классы которые были прям базовыми и трогаешь один метод падает весь проект многое пришлось пересмотреть примерно полгода мы потратили на переход а у нас все еще есть проблема работы приложения с памятью над ними продолжаем работать ну и разрабатывать стала чуть-чуть сложнее конечно текущая команда достаточно быстро смогла перейти адаптироваться но теперь взять команду Джона который вот только прошел какие-нибудь курсы на улицы нас точно вряд ли получится все-таки люди должны быть уже с более высокой квалификацией а как я говорила я подготовила такой маленький проект где вы можете пощупать попробовать поиграться с рудратором Можно перейти в репозиторий там реализован пример локального окружения две точки входа это и паблик у нас в одном проекте там четыре точки входа поэтому Как пример Тоже решила привести простейшие и паблик это соответственно простейшее отображение через три постаралась максимально показать фичи которые были полезны надеюсь у вас тоже появится желание поиграть на этом У меня все спасибо большое за внимание отзывы по докладу можно по QR коду оставить и связаться со мной если будет какие-то вопросы или комментарии можно в телеграме сейчас я готова ответить на ваши вопросы Пожалуйста задавайте пожалуйста Вопросы Спасибо Наталья тут маленькая пояснение про нам workers то есть вообще то что памяти много это нормально вообще на workers это вот паятором это когда в идеальных условиях когда нету то есть вот эти количество ядер так можно выставить хоть 100 хоть 200 просто Посчитайте сколько у вас оперативки чтобы не залезть оперативку до конца выставите 200 вы стоите там уменьшаете до 150 до 100 до того объема который есть 16 это очень мало Когда у вас есть ПАЗ грек там не знаю базе куда-то много общаетесь или с файлами общаетесь очень много у вас там прирост еще вырасти достаточно сильно Когда вы воркеры увеличить вообще производительность растет за то что вы в оперативку вот все эти воркеры поместили поэтому столько ест это как бы нормальный подход нормальная ситуация всё в принципе хорошо спасибо большое за комментарии учтем попробуем на метрике Наталья Спасибо большое Валентин компании Соколов У меня на самом деле такой тоже технический вопрос про эти на воркерсы сталкивались ли вы с проблемой сингворкер Error когда допустим этом запускаете какое-то количество воркеров начинаете гнать на них нагрузку повышается РПС и внутри начинает падать сам worker с ошибкой sing worker Error вот мы поэкспериментировали посмотрели решили таким способом что просто подняли 4 инстанса приложения в кубе и каждому дали по два оркера и все он перестал падать Он держит Великолепное количество фпс просто громаднейшее Но если сделать то же самое с одним поводом и допустим ста воркерами он такого сделать уже не может и падает Спасибо такой вот вопросик мы такую ошибку не наблюдали у нас сразу скажу что да тоже это все кубе соответственно это не один год и на каждом поди по 16 воркеров на такую ошибку это я думаю что нужно побольше нагрузку так чтобы на нее уже наткнуться к сожалению или к счастью пока что мы не ловим побольше нагрузку дать посмотрим могу позже написать вам получилось Здравствуйте Алексей компания Соколов окажется вы просто заменили среду работы приложения в чем-то конкретно возросла сложность разработки сложность разработки разросла именно из-за того что мы не смогли какими-то отладочными инструментами пользоваться которыми раньше там пользовались и в принципе получается разработчик пришел посмотрел документацию существует какая-то функция например он не знает очень хорошо если это приведет к тому что там пуки просто не поставится в каких-то функциях это просто приведет к тому что worker будет В общем разные есть варианты но команду соответственно нужно Готовить ознакамливать как работать и Простите еще дополнить когда несколько квартир О чем я говорила что что-то попало и мы ее к примеру забыли почистить у нас там какая-нибудь сессия стала некорректно работать сложнее а до снова Валентин комментарии по поводу отладки Мы тоже сталкивались с проблемой отладки но если честно решилась тем что мы поднимаем просто один воркер на один instance локально и дебаг всегда попадает в одно место им некуда идти и ты никогда не его нигде в другом месте не понимаешь хорошо то есть отладка стала как на обычном статическом приложении как раньше Нет на самом деле из двумя блогерами там точно также можно смотреть в параллель какой запрос на какой worker пришел и какой сейчас состояние конкретно ухода там в этой уборке то есть брайтпоинты там можно ставить и все в порядке два горкера точно также отлаживаются на одном тоже так если Вопросов нет меня появился вопрос ведущего Вот был запросу команды на рост развитие попробовать Гоа драйвер продукт написанный на Гоа но в итоге ваши программисты подписали что-нибудь ногой или пока только рефакторе PHP чтобы когда-нибудь перейти на Go пока что нашим разработчикам был предложено переписать worker один из воркеров который работает Это не рода здесь Паркер а обработчик очереди который можно было бы оптимизировать и переписать на гол но честно говоря ребята конечно у меня там например опасения по поводу ребята изучают кто-то закончил курсы Но это все получается что насколько он хорошо напишет этот вход на гол нам тяжело будет сказать оценить поэтому это тоже очень рискованные такой процесс а брать сейчас команду разработчика с экспертизы Пока что нет возможности так вот еще у меня вопросик созрел а риски опасения по поводу поддержки роутера Вот например если какая-то проблема Аля синьки Error вбиваю в Google 1000 ответов нас такой верфлу тут команда вроде активная в чатиках отвечает но тем не менее материалов наверное не так много плюс продукт развивающийся новой версии выходят как вы чувствуете Достаточно ли поддержка чувствуете ли вы себя надежно с драйвером поначалу чувствовала совершенно ненадежно не могла дойти информацию То есть все что есть это документация каких-то несколько статей нахаб опыте когда команды переходили с чем сталкивались но потом команда активно отвечала и помогала сейчас я наверное не так чувствую какой-то опасности команда помогает Спасибо команде Ну мы Наталья Спасибо за доклад пришло время выбрать лучшие вопросы зала лучший вопрос так я подумаю Спасибо Спасибо большое всем кто пришел брат лодку прокладку вот с той стороны человека а кто про отладку задал можете руку поднять сейчас вам подарочек вот с той стороны молодой человек нет так Впереди у нас небольшой тех толк работа в больших корпорациях особенности вызовы решения они переключайтесь это в 1210"
}