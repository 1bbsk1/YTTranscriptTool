{
  "video_id": "Wxz2Ne7RDPY",
  "channel": "HighLoadChannel",
  "title": "libfpta — обгоняя SQLite и Tarantool / Леонид Юрьев (Positive Technologies)",
  "views": 1082,
  "duration": 3250,
  "published": "2018-08-16T04:46:04-07:00",
  "text": "всем добрый день рад видеть здесь хоть немногочисленные но светлые лица яркие глаза меня зовут леонид юрьев у нас доклад довольно интересный как мне кажется технически он заявлен как сложный были с этим неоднозначности то есть не понятно было то есть на самом деле лезть в глубь или значить что ты рассказать как это использовать лучше чем это красиво у нас компромисс более того значит я буду не один я позвал алексея копытова он будет выполнять роль такого голоса разума то есть чем вы делать он будет что-то пояснять задавать мне вопросы какие-то может быть наводящий что-то прояснять смысл в том что алексей довольно известный человек особенно в узких кругах и он хорошо может понять то о чем я говорю или чего-то недоговариваю и во время это вытащить на свет и как бы правильно подать поэтому я не удержался и решил позвать его лишь представьте да всем привет меня зовут алексей копытов я всю жизнь ковыряюсь по траках москве в основном то есть вот к этому проекту не имея никакого отношения и здесь я буду на маракасах что называется то есть периодически встревать какими-то комментариями ценными или не очень не задавать какие то вопросы почему потому что я уже общался вот по поводу этого проекта с некоторыми людьми и у них у всех по сути возникают одни и те же вопросы или какие-то одни и те же вещи они прут на там просят вот и к тому же по идее-то доклада он занимает там три часа до очень сложно за 45 минут рассказать одновременно и дать общую картину и углубиться в детали там где то нужно вот такой эксперимент диалоговой формы поехали дальше чем случае что мы решили сделать поменять и анонсировать во-первых я точно скажу что мы не успеем рассказать все детали совершенно понятно и собственно я решил не торопиться 5 решил пусть предложить алексею не торопиться просто нормально говорить и больше уделить время интерактива то есть посмотреть ваши глаза посмотреть чтобы спрашивать и что вам интересно и по результату всего этого будет статья даже серия статье на хабре где я постараюсь максимально разумно сразу на детализации и технически грамотно все как бы разложить в том числе ответить на вопрос поэтому увидимся на хабре и как бы начинаем дальше собственно начинаем значит чем занимается чтобы понять не был контекст чем занимается позитив технолоджис эта компания него спокойно на рынке занимается она по надо создает довольно сложные продукты выпускает для обеспечения информационной безопасности в том числе для посредством мониторинга предотвращения всяких вторжений обнаружение так далее и так далее и вот для целей как бы ряда проектов гряда проектов потребовалось сделать такую штуковину который мы сегодня рассказывать что тут важно хотелось бы сказать вот тезисно что это такое наше наше библиотечка наши позитивные таблицы так сказать значит это иным стоить то есть все происходит память есть persistent ность и мы говорим чтобы стая хайпануть фигурами выражения на самом деле быстро но сразу надо понимать что как только мы говорим про память и по persistent ность у нас всегда масса компромиссов что что потянуть наверх по быстродействию что на нем что вниз какие сценарии использования и так далее так далее их бесконечно много здесь можно сразу углубиться в такие вещи там посмотреть на эти проекты как там apache игнайт вот из не ошибаюсь прямо сейчас идет по ним рассказ параллельно можно рассказывать про сабха ну вот рассказывает еще пар массу всяких всяких всяких вещей чтобы я хотел сказать что мы очень хорошо понимаем как устроены те большие проекты и мы достаточно хорошо понимаем что ну мы гораздо меньшие скромней ценю с ними но тем не менее мы нашу задачу решили это не база данных это движок и это движок в текст как бы кейсах для которых он создан он работает предельно эффективно вот это я хотел сейчас как бы донести показать и чтобы это восприняли ну собственно что чего мы как бы начинали с чего вы начинали какая была исходная задача а часть я уже сказал значит что потребовалось такое оперативное хранилище она очень-очень быстро то есть нужно захотелось решить проблему один раз и навсегда но как обычно зовут набили шишку есть проблема хочется как бы ее устранить полностью в то им очень важным обстоятельства что это хранилища dual для локальных процессов то есть принципиальный сценарии его использование изначально это когда система стоит на одном может быть сильно большом сервере но на одном есть некий набор локальных процессов которые с этим хранилищем взаимодействует то есть это не отдельный сервер в сети это не кластеры это не что-то это один сервер на котором работает много процессов тут не будем шафта снять вот хотелось бы чтобы от хранилище любил без излишеств потому что как бы разработка мы не можем себе позволить делать что лишь не универсальные делается некий лунный минимум и но так чтобы можно было развивать это исходные как бы водящий чего мы начинали мы взяли вы сделали сделали такой автомат калашникова здесь есть лукавство какого толка что взять и сделать что-то подобное там за год там усилиями одного или двух человек зачем сложно и это не так то есть дальше просто скажу что движок слоёный он состоит из древних частей это отдельный библиотеки ну походу будет ясно еще добавить лишь на следующем постановка задачи так сказать чуть более детально вот акцентирую какие были важные моменты ну во первых то что я сказал взаимодействие локальные данные лежат локали на сервере по сети к ним ходить не надо более того посетить на самом деле посетим их ним ходить не можем потому что это в частности долго это накладные расходы это сама сеть это не наш сын и локально и данных они помещаются память то есть их немного это никого начни база данных ни в коем случае это даже не сценария к тебе когда у нас там данных больше чем в памяти или там не тарантул винил у нас данной точно в память помещается это тоже важно следующий момент вот это все должно быть быстро это такая система которая знаете как пистолет вот вам не нужен пистолет который стреляет задержкой нажали он должен выстрелить если он что-то не делает сейчас и моментально он не нужен вот здесь именно тот принцип что если медленно тоже не нужно то есть нам принципе не нужно никаких операций которые могли бы сильно замедлить базу ли выполняться долго они может быть потом понадобится но мы всегда должны суметь прежде всего выстрелит когда нажали курок следующий аспект очень странный непонятный вот долговечных данных называется 2 ability а но это свойство нам иногда не нужно есть разные сценарии использования но все-таки часто это не нужно почему супергерои обелить бывает разный доводка кости осипов говорит о перейти на я 90 ядерной войны довольно об солим и собственно хороший durability это вот как там коллеги подошли не знает в мегафоне но всегда стоит 4 сервера два с одной из с того конца города например 2 другого конца города такой полна связанный кластер между ними оптикой репликации так далее вот если такую систему где-то взорвать она будет работать нормально durability есть ее выключить она будет работать все хорошо я немножко отвлёкся значит что нам-то нужно фишка в том что мы работаем практически за с реальным временем и если нас выключили по какой-то причине это плохо но если питание пропала что-то случилась какая-то авария она не нашего уровня и те данные которые мы обрабатывали который мы накопили они могут устроить большой долей вероятности они могут быть бесполезные вообще ну не то чтобы вредны может быть даже и вредный но в принципе вот такая durability в ряде по четко не всегда на в ряде случаев сценарии нам не нужно довольно тонкий момент сейчас сейчас сейчас дам слово он сильно завязан с высокой готовностью опять-таки нам с одной стороны нужна такая durability часто не нужно иногда это изменять не нужно иногда нужно но при этом и себе точно не можем позволить какие-то другие операции какой-то долгое восстановление когда нас отключили вот подали питание мы должны раз и сразу как пионер быть готовыми что если этого не сделать то тоже непонятно зачем мы нужны понимаете вот поэтому минимальное время восстановления это крайне важно и следующий пункт но сейчас потерпи дам тебе слово он на нём очень много заложена и часто это считается невозможным то есть у нас есть процессов на севере которые работают в том числе предположим некий абстрактный сервер базы данных падения любого из этих процессов не должно не только данный не ломать но у нас сами данные должны не должны исчезать все остальные процесс они как бы должны как работали так и работают и вроде бы не понятно как это возможно на самом деле если у вас данные лежат файле условно говоря да то вот у вас чтобы там спеть этот процесс не падал пока файлы есть у вас есть данные то есть на сам деле возможно поэтому у нас фактически нет никакого выделенного сервера потерять чуть забегая вперед и поэтому такая система она именно как калашников что-то в ней есть от этого есть можно ее пилять вам киллером kill -9 а данные будут живы да то есть вот это математически точное описание целевой кейс но довольно абстрактной может быть не очень понятно да я вот как голос разума пытался понять что это на что этой суке было я понимаю что леонид он не все может рассказывать по коммерческим соображениям но вот если пофантазировать то это мог бы близко к кареты какой-то мониторинг до каких-то real time of даны какого-то рилтайм состояние системы когда скорость и доступность до скорость принятия решений доступность данных гораздо важнее теоретически потенциальной потери данных вот вот вот такой вот такой вот мониторинг качества развитого да например да немножко про то что будет дальше это краткий такой обзор содержание доклада обзор дальше это собственно не доклада обзор начать наших нашего решения нашей табличек что-то можно что нет чтобы примерно был еще она состоит дальше я постараюсь максимально подробно остановиться вот на целевом и неправильном сценарии использования потому что чтобы было понятно как можно это использовать как нет практика показывает что вот разъяснение этих двух как бы моментов она дает на самом деле правильное понимание чем мы сделали ли чему это пригодится она вам или нет плюсы-минусы то есть абстрактно будет рассмотрены все наши плюшки бантики и соответственно недостатки без которых никуда если успеем там самое вкусное для меня да то есть пофантазировать что мы хотим сделать они пофантазировать поделиться да и шестой пункт он когда-то был в самом начале я вас пустил потому что никак не успеваем это ответы на вопросы фактически там мы как бы раз я рассматриваю отвечай на вопросы почему нам не подошли вот целый ряд решение каких-то там таких пытаемся разобраться в этом деле теперь я пользуюсь тем что вы здесь есть хотел бы спросить вопросы у вас есть вот их лучше задавать сразу то есть я приветствует можно будет я очень хотел написать большую статью там называется с унижением я вы если совсем грубо выражаться потому что я в на сам деле прекрасный язык просто если от него требовать его использовать там где не нужно получается больно и тот проиграет все эти смотрите очень сложно этот рассматривая этот ряд до и отвечай на вопрос очень сложно вовремя остановиться и никого не обидеть потому что он бесконечен примерно то есть вот на то что вы его продолжать носить и исследовать так может только этим профессионально заниматься и замечательно непонятно только круто деньги платить и еще есть данный момент чтоб если начали начинаешь какое-то решение рассматривать значит во первых чтобы его нужно просто вот в каком-то конкретном кейсе до его пытаться взять и применить применить может быть там чуть поправить нужно там есть какой то недостаток по крайней мере разобраться во всех там крутилка это действительно большой большая работа и часто как он сказать объем работы довольно солидный то есть я как для себя как для разработчика часто понимаю что вот как оно уст внутри устроена что она мне не подходит таким причинам при этом я могу ошибаться я могу как бы я на себя принимаю риски но когда пишешь статью на хабре вот эти риски все или какие-то свои интуитивные решения их надо как бы изложить да и аргументировать и это большая работа я вам скажу просто под описание этого текста поэтому вот писать статьи по таким сравнением я буду там это очень поверхностно будет опять таки поймите меня правильно то есть если я начинаю начать ходить или выискивать недостатки условно говоря да так тоже как снаружи может воспринято там в apache и гнать на меня все любители java начинают значить говорит и java не понимаю что не умеешь ее готовить и начинается как такой негатив перетягивание каната в чем-то это как бы интересно но часто это уходит вот сам дурак поэтому статья на хабре и вот все что здесь будет я прежде всего постараюсь рассказывать про то как у нас она устроена какая была логиков тех вот когда был выбор сделать так или иначе почему мы сделали так почему пошли направо и налево об этом и соответственно в этом есть некая инженере то есть когда другой человек какой то пытается начать оценить ему подходит этот проект или какой-то другой что он считает и минут головой строятся карта решений начнет понимать примерно как она устроена да как это делается и в частности например многие пытаются начать моего сэм движках дела какие-то алтайские решения потом удивляет почему они иногда не работают они не падают но некий страны результаты получается еще вопрос еще вопрос скажите пожалуйста это решение только для x86 архитектуры или она квартирам это 1 и второй момент я правильно услышал что там локальные процессы если возможность взаимодействия между kerastase fathers осиба примерно так там никаких явных ограничений привязок x86 нет просто есть местами совершенно понятна завязка на порядок байт она исторически как бы шла это уходит формат б.д. база данных буквально файла который дает на диске запланированных и рефакторинг который ту проблему устранит буквально это чтобы она заработала не на x86 ну там какие-то может баги есть потому что что-то что-то что-то где-то там с выравниванием вот такие вещи понятно с размером страницы нет размер страницы влаги подчинены я практически уверен что есть баги сравниванием вот до для arma ii есть баги с порядком байт вот это точно есть их надо просто когда вы смотрите что понять не было да вот такие баги они как бы есть но откуда не возникает то есть когда есть выбор начать есть часть кода унаследованного и мы должны его как бы катить вперед да то есть мы должны сделать что-то полезное потом вычищать если мы вначале мы сделаем будем все это вычищать нам просто скажу да идите вы нафиг результата нет поэтому начали делается некий результат который можно поставить production который будет работать а потом до его вот вторичные вот эти сценарии типа запуск нами он все это все это можно сделать никаких проблем нет а что касается значить взаимодействие с squarespace юзер space значит там в принципе я хочу задействовать си плюс плюс но задействовать так чтобы точнее там уже есть и плюс плюс на все сделано так чтобы все это можно было скомпилировать виде модуля ядра раз на основную часть и по крайней мере использовать но очень важно понять вот что вам нужно в ядре что нужно на самом деле да то есть нужно вики выглядит одна вещь есть какие то там таблицы из какой то не дай бог у сквере дата довольно странно защитит от это туда вот если к и вылета это отдельная вещь это опора нижн в мире движок его он сейчас носи его я думаю можно скомпилировать там с какими-то правками в виде модуля ядра и дальше чтобы с этим взаимодействовать а местные что нужно учесть ну базовой вес когда вот данный класс отображается вот работа с базовыми т с вами технический момент давайте дальше пойдем там есть тонкость это все с пересекается немного с другим проектом вот эта тема в четырнадцатом году я там рассказывал про обмен сообщениями там бла бла бла вы там много решений было параллельных kb так помоги ответил на ваш вопрос еще вопрос есть да давайте быстро только под и вопросы можете всего как вы говорите что это локальное хранилище и во всех голове вижу что это здорово для каких-то к яше использовать вы не строительство star on the rocks db прочем с киева или хранилищами вы не сравнивать ну рокс бы и такое вылью собственно я вот если вы зайдете в тезисы если вам интересна эта тема значит там есть опорный там есть в конце кризиса в час актуальных ссылки на 2 статьи извечно два доклада один доклад кости осипова как работают там примем или базу данных а второй доклад на мой доклад 15-го года про отпор медвежонка и были там больше информации и вы по вы сейчас поймете как бы где как мы коллируем дальше по ходу дела вы задали вопрос прав давайте последний вопрос и поедем дальше спасибо огромное вот мне как раз вопрос когда начнется второй пункт вот вот этот вот то что надо было да да все все все точно что у нас вот это клип f5 ли понятно да и в 5 это быстрый позитивные таблицы сокращение такое что это такое значит это компактная библиотека с лицензией gpl это не отдельный какой-то процесс не отдельные грешника это именно библиотека сесть и плюс api и лицензией gpl сейчас лицензии или теперь я скорее все будет двойная но теперь то есть она будет как бы вот примерно так он намерен такие движок внутри двухслойный и вот он состоит из отдельных компонентов причем я стараюсь делать так чтобы этих компонентов была некая самостоятельной ценностью их можно было взять отдельно использовать что там внутри вот есть такой lip and bags это как раз таки и к и вылью хранилище поверх которого делают всякие таблички вторичные индексы и все остальные прелести слепым dbx имеет некую свою историю совсем кратко скажу значит это то что получилось в результате починки упал до по для внутри петер сервисов для мегафона тот сейчас работает мегафоне пример три года в продакшн довольно такой специфический код рекомендую вот зайти там есть доклад 15 года там я довольно подробно мне кажется по это рассказываю значит этот движок изначально сделал не я его сделал к врачу вы ворчу это автор и такой основной мужской самый крутой чувак выполнил даппи он там нас работал еще где-то работала очень нормальный чувак но вот он пишет совершенно ребус ный то есть иногда понять что там происходит очень сложно есть сейчас вы заглянете внутрь вот этих исходных кодов именно вот туда ну вот именно думаю это вы почувствуете занимаюсь и факторингом вот сентябрь и на него убил ну вот там еще работы много ладно требовали оставили в покое и пошли дальше значит есть кортежи тд apple значит если мы делаем некую базу данных которые из таблички нам нужно как-то хранить строки сами строчки таблицы и обычно все это делают никаких котлах кортежах почти везде в разном виде в tarantul это же свои этапы у нас тоже свои у нас и неспецифический а дальше про них расскажу они заточены на тестовой работы которые нам нужны для машины они прям при 2 мы эффективны и по них можно сделать отдельный доклад ну и последняя штука она здесь по объему год совсем небольшая такая хэш-функция есть кто не знает это примерно самая быстрая функция портабельной которая есть сейчас это по компонентам вот движок состоит из этих частей но в принципе он двухэтажный снизу у нас к и велел сверху назначить таблица со всеми этими прелестями что еще важно вода у нас таблица с утиной схемой что такое утиная схема я поподробнее потом расскажу но я уже рассказал то есть таблицы примерно представляете что такое есть российские индексы всякие там свойства стальные у них так далее так далее далее вот это движок и виде библиотеки он все-таки экстремально быстрый и все вот это вот под одну эту линеечку все заточено быстро-быстро-быстро ничего лишнего именно так чтобы для машины это было оптимально некоторые вещи оптимальны для машины но не удобны для человека иногда это вот даже видно вопи но вообще принципе мне кажется нормально то есть никаких там extra extra кошмарных решений нет что важно вот если сравнить с другими со всякими решение у нас нет вал вал от евро это hotlog значит у нас его нет вообще в принципе как с ним мы живем почему так получилось дальше расскажу я чувствую что нам понадобится самим вал поэтому он как бы запланирован к реализации но пока его нет ну собственно стану я сказала движок похож на многие другие но как только начинаете использовать обязательства всё не так все по-другому лишь хочу сказать там нет предыдущему сладости были бы не понятно да вот можно сделать вдоль вопрос я надеюсь вы дать порцию информации а потом значит почти все у нас как у всех значит есть набор таблиц у них есть колоночки как-то там описывается некая как бы схема есть машины и типы все они именно машины они ориентированы на формат машины то есть то как машина работает байтами кашле ними так далее там есть дата время строчки учимся все все стандартно вроде бы а дальше есть курса есть все основные операции важно что курсорами и всеми операциями то в принципе видеть данные вы можете только изнутри транзакций транзакции любой транзакции ощущения либо транзакция записи когда вы и стартанули у вас данные есть как таковой транзакцию как бы закраины остановили вас даны испаряются потому что кто-то другой процесс может взять их у нас есть темпе чем угодно с ними сделать вот это все все что было но для роя локальных процессов это много процессов которые локально работают у них там много трендов они там толкаются живут своей жизнью в этом такая мешанина что у нас принципиально отсутствует потому что нам перри всего не нужно ну тоже называется внешние ключи и join и есть все чтобы их сделать нам просто это не нужно опять-таки join и могут быть очень сильно тяжелыми да и кроме всего довольно важно что для того чтобы делать join и делать нужен некий довольно сложный язык запросов или какой-то интерфейс их создания на мат было не нужно для текущей сценариях поэтому их нет но есть курсор и которые предельно эффективны поэтому сделать там join и все остальное проблему составляет до вот я общался с разными линии люди пытаются понять что это такое продается примерить это на то что есть у них ли пытаясь понять как они могут себя это использовать и вот если так это все просуммировать то можно сказать что для людей с грел мира нет многих вещей привычных там не только фарингит join of нет также триггеров там нет агрегации нет там грубая а то потом ибо и прочего неотступность крыло и стрелка киска запросов а для людей из но и скилл мира наоборот ведь многие приятные плюшки как вот курсор и например они не во всех но я склеил есть транзакциями сессии и собственно строгая строгая схема при желании это очень мал есть да вот что такое промежуточно да про схему вот про еще про все вещи по походу я думаю да расскажу так что у нас внутри шутки понятно было но пункт 1 значит есть некие в некие данные да это линейный файл на диске и он отображен в память вот это самое первое самое важное любви все данные отображены в памяти дальше мы с ними в памяти ковыряемся из этого вот только про это можно говорить там еще час что это дает что это отнимает какие эффекты но крайне важно еще раз у нас мэппинг поддерживается ядром да то есть умывается керна bucket каширование нет все у нас он за нас очень много делает ядро она как бы с одной стороны прозрачную другой стороны если что-то в ядре у вас не так крутилки нити или вы как-то с ним в другом месте плохо на него влияете данном уровне там какие-то рассказать пропорции да там грязные страниц или еще что-то мы могут быть вот старалась странные вещи которые и мы никак не контролером они нам могут мешать но тем не менее вот это крайне важно сидаш про то что происходит внутри нужно начинать думать стал начиная с того что данный отображены в память дальше внутри у нас дерево страниц бы плюс 3 или бы звездочка 3 там как угодно можно сказать это дерево и страниц относительно классическое такое дерево у него есть свои там как сказать добавление выполнить дальше расскажу но самое главное тайна дерево это не л.с. и соответственно примерно один файл с данными примерно один файл там дальше будут тонкости связанные с доработками но сейчас это файл данных один и он заметно память дальше есть весит эти там со звездочкой потому что ты durability он как бы вы как хотите можно включить можно выключить он контролируем и это случаев и будет понятно почему начать и раз нету вал то и только дерево соответственно большой вов в этом для 1000 фактор и полный durability после каждой транзакции может быть для вас сильно дорогие но не для вас и для диска и в общем все это может быть так но тем не менее есть весит работы по верхом и сиси ну и миссию надеюсь все знаешь что такое значит самой сети реализовано посредством copyright на уровне страниц вот в этих трех пунктах 80 процентов того что происходит внутри отсюда можно ноги выводы дальше построить но если если вы как бы разрабатывали база данных у вас сразу все проясняется если нет то ничего не понятно поэтому дальше расскажу что еще есть важно начать вот к этому добавляется значит у нас есть кривые люках кого есть картины или кортежи как уж парочки список таблиц из колонок как таковой большой фиксированной схемы такой как есть во многих вот база данных понятия схема но фактически не да есть список таблиц список колонок или даже список индексов и хотите такая особенность дальше у нас внутри нет имен вот это может быть кошмарно выглядеть на самом деле внутри индикаторов имен таблиц как таковых элемент колонок нету есть только дайджест как только вы начинаете с базы данных работать у вас дай раз превращается значить ли здесь имя там чего-то превращается даже если внутри базе данных только даже стоит карлица ну очень просто это 64 бита вместо стоковых опирался это просто быстрее поэтому вот так вот этого начинается как бы некий хардкор некое отличие когда производительность важнее какого-то может быть удобства или понятности и собственно я сказал да это все предельно эффективно для машины там кашле нее так ты вот это все и пытаюсь считать по мере возможности как бы делать как можно лучше и соответственно нет ничего лишнего и ничего не эффективного то есть приходит аналитику словно г какой-то говорит сделай мне вот эту фишку нам она нужна я понимаю что может быть не сильно нужна но плохо будет база данных плохо будет движку от этого вот внутри будет не так ничья начинаю либо его уговаривать либо трансформируя задачу либо как ты обрезать и пока это вот удается поэтому там внутри все довольно экстремально быстро точно поэтому такие результаты родиться звездочки хочется поговорить не 400 до сих пор самому ты мне все понятно там наверное долго можно не знать сейчас или вели потом на последних сбивала понятно что в любой суп и есть некая крутилка между скоростью der ability да но здесь-то решено несколько оригинальным образом давайте мне там можно сейчас сказать смотрите если у нас данный отображены в память в частности мы их можем отобразить на чтение и запись даже да и даже на диск не писать и сразу данных памяти менять ну примерно у нас есть такой режим работы соответственно даже когда можно работать база данных так что на диск ничего не первую системных вызовов не происходит все происходит памяти но здесь не есть риск что если у вас плохое приложение записала куда-то значить по-плохому колотили но можете непосредственно разрушить базу данных потому что за 3 данная память и ну сами выбираете но что здесь есть какая интересная вещь если мы данные отобразили в память меняем и в памяти и к нам прилетает kill -9 не важно от кого он киллер или просто там неважно по какой причине отрубают сигнала то ядро само запишет данный на диск вот и для нас вот этого вот такого дела ability она вот то что вначале говорил это просто но вот такой золотой случай да то есть как бы все бесплатно если на срубили тоже можно запишется если выключили питание или rosette нажали но начать тогда можно другой durability его мы тоже мы можем обеспечить но какой ценой значит сейчас дальше расскажу на что опирается что нужно изменение записать на диск у нас изменения двор не страниц все страницы которые поменяли надо записать а если у нас диск пильный там и начать его ему будет тяжело болтать головка значит все это делали очень тяжело вот собственно дальше мы сейчас поговорим с утра происходит при полной durability такого с полность полностью сигрун режим каждого каждая запись на страницу что происходит на сплит и нам нужно navi дерево да и где-то под посередине выключим питание до на всякий случай если будет непонятно есть доклад на слова года там подробно раз под заниматься и слайдов расписано как что происходит я сейчас объяснять на пальце экрана следующая у нас дерево мы изменяем листочек нас copyright то есть изменение был копировали страницы при изменении применяем данные в дереве в листочки листочки и же странице соответственно эту страницу целиком мы копируем старая у нас осталось у нас им процессе ее кто читает новым и сделали копию теперь чтобы такое пи увидеть на новые данные мы должны начать поправить ссылку на эту страницу в узле то есть та страница который содержит узел этажом ножом как бы выше в дереве эту страницу тоже копирую меняем и так до корня дерева поэтому любое изменение она как бы в дереве так просекает такую черту вот корня долю . этой черте все страницы меняются что это значит что любой апдейт он затрагивает значить изменение по дереву высота дерева судейство логарифм от количества место количество входов сколько записи у вас базе данных и вот этот логарифм потом нужно записать то есть это н страниц высоту дерева можно записать на диск эти страницы внезапно они могут быть у вас ну хорошо я не последовательно идут это очень хорошо ну часто когда у вас значит там нет управления начать местом базе данных скорее всего не лежат непоследовательно это вот одна из до работа которая буду делать чтобы было более линейной но тем не менее у вас н страниц нужно записать файл в разные места диск это самый тяжелый случай для шпили ней дисков и над записать собственно все вот в этом проблем записать вы дать команду чтобы все было хорошо надо выдать команду значит набором файловой системы она передаст драйвера диска он передаст нам контроллер по цепочке если чтобы по был полный durability на самом деле на всех дисках нужно вот эту команду сброса очереди привести до диска и часто вот этот путь он вот отдельное как отдельные как бы доклад а насколько честным durability значит в ssd-дисках там и так далее но чем этот долгий путь может быть очень долгий но без него никак вот вопросу что произойдет если мы потеряем питание в процессе обновления дерево да я насколько я понимаю вы просто частично обновленная часть она будет присутствовать на мы и не увидим мы просто видим старую старую старую веру . мы повторяем доклад нас два года но смысл значит у нас есть в базе данных некая carnival даже не корнями эта страница их несколько значит и каждый помечается номером последний транзакции и когда мы данные записываем на диск уже про самый последний момент мы обновляем эту страницу и потом начать смотря на них на всех можно найти последнюю версию соответственно если у нас все правильно все записалось там и и смета странице выберем самую последнюю версию которая была записана и даже все данные на диске будут если мы этого дед где-то не делаем то есть не делаем полный сброс на диск до то у нас значит что-то из этого будет будет сломано и самом лучшем случае в лучшем случае мы потеряем какие-то последние данные которые значит у нас были после последнего синко на диск худшем случае начать там нужно рассматривать как все у нас в базе данных будет худшем случае нас базовых вещей может быть разрушен что принципиально сделано в движке в яндексе от исходного что сделано там сейчас тремито странице раньше было 2 и собственно если рассмотреть вот эту всю унесен хотите потом пообщаемся и все это рассмотреть на мод позволяет что что делать иметь одну надежную фиксацию до иметь одну слабую фиксацию которая может быть успеть записаться и проводить еще одну на ходу не трогаете раз два три то есть у нас три как бы версии база данных надежная слабая и текущая которая сейчас мы готовим может могут существовать одновременно ну и вот поэтому мы можем там так или иначе обеспечить durability чуть лучше имеется виду что худшем случае мы можем делать так что вы потеряете но последнего синко они всю базу но тем ни менее ability на случай ядерной войны вот он надо исходить из того что вам нужно как я говорю в начале основной наш кейс из такого сказать это вот мега-мега быстро и ну если как бы питание выключили то есть если в морг там морг nude но если при этом вашем кейси например я уже начинаю давайте давайте продолжим потому что цена использую на самом деле не подойдет когда и начни подойдет когда наш движок вам не подойдет если у вас много апдейтов и их нельзя потеряет есть нужно каждый раз симки цена риск после каждой транзакции и при этом если вам очень простой при допустим простой начать то есть при включении если была авария то есть можете потратить время на восстановление то вам точно на движок не нужен вам нужен любой движок деюсь вам совершенно понятно тут нечего добавить можно просто как-то деталь не пояснить почему так и мы с этим не спорим пока нет вала вот это не наша нельзя второй момент он более запутанный закинут надо понять почему вот где l s m l s m значит у нас данные в памяти они как бы вся доступны все хорошо поэтому у нас чтение пускать бесплатный взяли прочитали запись у нас может быть дорогой до особенность надо симки что волосами не так с вами с нами волосами чтения не бесплатно всегда но зато может быть дешевой дешевая запись потому что лосиных капец памяти потом журнал туда сюда сюда вот можно очень много вать отдельно вот рассмотреть последний пункт еще там 15 минут про него говорить может легко добавить ну что я хочу сказать если записи больше чем чтение да и памяти меньше чем данных особенно то на движок не подойдет lsm будет лучше то что lsm будет вам выжить на диске ему нет ненужности данных памяти держать он сможет это делать просто за счет подхода поле эффективно ему потребуется меньше операции если это мы будем делать то как минимум все данный придется подкачать память будет подкачка больше я пытался привязать к реальному миру и представить такой вот антип этом худший случай когда вот тут точно нет ни для этого на я понимаю что этот что-то вроде will цепи нагрузки когда нужно строго ядер ability вот онлайн-магазин наверное там не стоит делать это не для него сделано вот когда много записи да и но нам требуется строго der ability скорее всего здесь выигрыш не получите до ног но мной магазин сколько у вас как бы транзакции пройдет то есть если у вас ssd диска там не знаю что транзакции секунду то почему нет просто отказаться секунды после лтп бывает разный поэтому онлайн магазин может быть amazon amazon этом не построишь и точно значит прав волны вал я там еще расскажу потому что у нас есть так называемые фу политика переработки она хорошо работает для backend выделить для кашей сказать для контроллеров с кэшем обратной записи на батарейки есть так называемый называют барбекью никто в жаргон на постоишь не скажу напомните так вот это наоборот идеальный кейс тот был как бы куда ему нет не совсем не никто не подойдем а теперь идеальный вот идеально когда будет когда он требуется вверх предельной производительности есть носить эссе для локальной группы процессов значит если у вас солнце чем здесь суть что если у вас не локальные процессы да а вот по сети или у вас там не да мне нужен висит то скорее всего что-то будет более оптимальные нежели наш движок а далее у нас есть выборка диапазонов и курсор но это свойство любого как бы дерево так или иначе то есть они ключи сортированы и тогда для там специфические вещи возможно если вам это не нужно ненужный курсор в частности то скорее всего тоже найдется другой движок который будет лучше работать свою очередь курсор наличие курсоров таковых показать позволяет дальше на этом использовать их как основу для выстраивания там всяческого и скрыли стройными с чем хотите без курсоров это сделать невозможность курсорами делаем по по учебнику условно говоря дальше идеально если вам не нужен volta тоже идеально когда не нужен вам вал он либо не нужен либо даже противопоказан но вверх если требуется минимальное время простое до после включения то волне для вас можно можно поспорить насколько быстро там делать реплей вала но в принципе чем больше вы пишете вал да тем больше у вас будет время реплеи поэтому если нам его нужно минимально это нужно вал убирать вот такая штука далее если ваша как бы ваш сценарий используем допускает потерять хвост транзакций хвоста до это в после аварии но здесь имеется ввиду именования по питанию котовского просто срубить процесса и таки говорю нас ничего не потеряется мы практически любой базе данных то есть ядро запишет там файловые операции еще что то там но запишет на диск вот и ну еще если все таки м это последний пункт если апдейтов не так много но опять-таки там подумаешь здесь 1 секунду что-то записали ну и хрень извеняюсь так вот если диск терпит в рай complications тот который у нас получается то вполне возможно это будет даже очень хорошо опять таки если у вас просто один апдейт идет секунду вот классический пример начал доп сценарий до 1 когда работает там не так уж много апдейтов да кто-то много чтения обычных удав каталогу там это очень хорошо взяли записали данные на диске зато чтение очень быстро ну и соответственно вот это еще можно как бы обратный сценарий вас м а значит если чтение принципе нагрузка по чтению больше чем по записи и данные помещаются в память то с нами практически невозможно конкурировать я дальше расскажу то сколько у вас есть ядер процессора вот столько la noi будет работать причем без блокировок без ничего узкое место это просто способность память сложно с этим конкурировать вообще все поэтому особенно то же самое говорит что мари данный нагрузка где-то намечается в памяти будут позитивно таблицы вне конкуренции просто в силу дизайна до но тут еще в полу первые встречается для оторвав кто из присутствующих понимаешь такого этом префиксе шины что-то приготовлю означает ok highload уже не торт ну в общем обычно все вот так вот в в английском в английском варианте термин приводит я вчера вечером осенило я понял когда правильно переводить это мультипликативной записи может не очень удобно выговаривать поэтому подала суть очень точный перевод термина что это означает означает отношении реально записанных на 10 данных к тем данным которые пользователь записываясь нам нужно пример обновить там один батиком то поле до в итоге мы там пометим страницу к грязную она поедет а если еще там придется сделать прическу это нужно все дерево в сидели в обновления вашим дереве записать на диск индексы обновить и так далее то есть вот вот вот и соотношение она может зависимости от дизайна база данных я зависимости от схемы алгоритмов работы они могут отличаться мне вопрос сказала можно я быстренько вот правда никто никто не понимает ковра тихо though i wipe cache фактор просто вот честно давайте поднимем руки кто на самом деле знал на поленилась поднять пожалуйста просто по моему это очень крутые слайда прям вообще шикарная но мы теряем время на каких-то базовых вещах и нужно бы нужно прям вот идти перед нам что вот два слайда не были вообще шикарно идеально ребята давайте пожалуйста давайте ждут хорошо давайте но она не такой крутой слайд на все таки пояснения почему откуда у нас какая-то магическая скорость быстро пробегусь значить чтение любой вид у нас всегда по логарифму причем в результате на самом деле попробовать по линейке померить у нас как стб мэк будет либо быстрее быстрее только за счёт того что ключи лежат рядом дата сегодня необычный ростова там разбросаны то у нас они лежат страничках рядом просто поэтому за счет локальности кэша вот этот рентген он работает может работать без проблем на каждом ядре процессора бейсболки без блокировок это крайне важно то есть 1 и поехали без блокировок без блокировок без атомарных операций предельно честно если данный не помещается то будет просто подкачка если данные помещается память спрайтом я уже сказал вот то что просто при повторю тоже логарифм всегда-всегда логарифм от н но при этом стоимость как бы к вот этого а она гораздо больше идет копирование по высоте дерева объяснил уже да и средств на тяжелей там операций гораздо тяжелей операции при этом строго последовательны то есть полностью реализуемость изменений писатель всегда один забегать вперед уже ускоряясь не успеваем мы ожидали что не успеваем это дает много преимуществ тоже и избавляет от проблем тотьмы некий проблема чипов не решаем точно так же как их не делает тарантул и вот у кости есть прекрасный доклад где он это очень хорошо поясняет ну и после значить в рай то фиксации на диске всегда самая дорогая операция по факт ее можно ли делать ли мне делать вот мы пряди случае позволяем этого не делать ну сами понимаете попугай вот этот слайд который наверное стоит показать он одновременно и честный нечестный и это сравнение строк sdb почему он честный значит данные выдраны из доклада 15 года есть код в интернете там где можно запустить скрипт их воспроизвести да и попугай называется и его лорена до попугаю а иногда это бич marc by marc который позволяет протестировать в одном флаконе тут относительно все честно нечестно что что в принципе если подкрутить урок забыли взять и другие сценарии использования больше иначе ну с учётом именно те за того что я вот до этого рассказывал а здесь показан ники условного наш идеальный случай вот когда мы нас использовать правильно будет вот так теперь что здесь значит эта цифра на моем ноуте там всего четыре потока на чтения то что 4 процессора смысла больше не было включать поэтому мы линейно быстрее если было бы восемь было бы еще два раза больше чтение быстрее однозначно вроде бы но относительно скромные у нас четыре раза быстрее потому что как объяснил дальше зелененькая sing это режим синхронная запись и означает можно было обсуждать термины смысл в чем суть некие такие настройки которые нам говорят вот мы транзакцию за к мите ли она записалась на диск можно выключать потом включите мы сразу готов у нас есть эти данные то есть фактически это режим bisbal да как он там рокс db был включен я сейчас не беру строитесь исходники можно посмотреть и режим вот последний красники это некий такой режим отложенные записи да то есть если мы начинаем халявить и писать меньше на диск мы тоже начинаем как бы rock baby обгонять ну опять-таки это нечестный обгон потому что есть выключить durability нормально все будет иначе поэтому нужно это честному как бы воспринимать свою столицу сказать правильным образом и стоимость этих операций и посмотреть на стоимость то здесь вот вывода процессор и места на диске не в память вот вывода у нас больше потому что 22 это окей шин выше но при этом больше но не кошмарно потому что волосами важны будет значить несколько больше операции файловой системы томаш обновление так далее то есть не не в разы больше циpкa но рокс бы съела в этом комплексе декомпрессия иже с ним да мы съели на копирование страниц но совпадает место мы как бы съели больше но это данные 15-го года там в движке в том в тамошней версию не было как бы сказать сразу резервировать максимальный размер на диске усков зарезервировались только и есть и как бы можно было сделать меньше там под данные можно больше опять-таки вроде бы какая-то компрессия есть у нас все как бы нету поэтому не совсем честно некое сравнение она имеет где там есть и полные складе посмотреть полный слайдов то про другие движки и некоторые из них просто значит волосами создали просто огромные объемы лишних данных вот это сравнение там было актуально если как про использование памяти то все просто здесь нет смысла обсуждать потому что сколько какой файл на диске сделали у нас я имею в нашем движке столько он был зам и принципами столько мы памяти съели больше ничего вроде бы сколько там над кэша выделить ей настолько будет как бы использовать в основном так будет это будет влиять на параметры в общем такая крутилка отдельно ну собственно все значит я да сейчас про щелку и просто у нас вот еще не угоняют утиная схема что имелось ввиду нашей схеме описываются минимальный набор колонна который должен быть . бага набор индексов который должен быть а положить если вы можете в данной больше и потом с этими данными роды как хотите поэтому как бы такая полу гибкая схема да то есть минимум его нужно выполнить положить можно больше и дольше работать кортежу до отдельный разговор отдельная из библиотечка анис проективные по как я говорю под под машину чтобы что-то важно сказать собственно в них с точки зрения пользователя важно что есть можно использовать в них есть аналог коллекции то есть одно это уже поле условно говоря можно положить 10 раз его спутники аналог коллекций в принципе да смотрите там массивы еще что то но вот как выяснилось этот вариант коллекции он для пользователя для некоторых очень важен и фишка в том что заголовок чем принципиальное отличие от там massage pack и жизни у нас есть некий заголовок похоже на яндекс если полей не как разумное количество да мы считаем что с там что штук или там 20 даже разумное количество полей то есть не 10 по вот этот индекс он помещается фактически в одну каш линию и сатана мне нужно для того чтобы получить доступ к этим данным нам не нужно читать как вас важен массаж подсчитать значить и импортировать все байки то есть мы этот заголовок прочитали дальше сразу пошли за данным заданными поэтому когда начинаются работать и такая фильтрация манипуляции с данными что все это зина быстрее чуть больше памяти занимает мув ит неважно основной задача вот этих кортежей в том чтобы базовые операции значить сделать максимально эффективными для машины и там чуть немного что для этого сделана дубликаты как-то говорил называется или похоже на премию компрессию в индексов выстрела мире по сути то же самое да если у нас есть многое иное значение со знаком префиксом то нет смысла каждый раз они префикс и это не только приорикс отдельные все под значения отдельно тоже сортируется в отдельном поддереве да у нас пример следующее если есть какое-то поле внутри хранится как мульти вылью то есть если посмотреть регулировать дворника и велю да вот такой модели простой есть ключ и там миллион записей где ключ один и тот же а значение разные вот суть в том что у нас внутри ключ будет храниться один раз а все обозначения не будут в отдельном ложном дереве которые при этом будут отсортированы по ним можно будет ходить курсором и вообще там быстрых искать такие странные плюсы получается внезапный все все еще раз напомню значит что у нас там что вот надо было плавно хотелки ну все вот я буду доступен еще примерно час буду рад ответить на вопросы и на хабре господа исходный код доступен там есть некий набор документации начать читаете смотрите всем спасибо"
}