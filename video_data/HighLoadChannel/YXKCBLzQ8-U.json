{
  "video_id": "YXKCBLzQ8-U",
  "channel": "HighLoadChannel",
  "title": "Миграция приложения Oracle PL/SQL на Postgres pl/pgSQL / Анатолий Анфиногенов",
  "views": 4371,
  "duration": 3119,
  "published": "2022-03-21T13:13:03-07:00",
  "text": "добрый день коллеги спасибо за возможно рассказать про наш их сильно ехать что-то сделать хорошо так то есть начнем оказывается как персонаж мольера я не знал что я работаю в том что называется кровавый enterprise то есть как хорошее определение этого это решение задачи интересные бизнесу заказчика то есть система может работать каким-то образом но решается практическая задача которой стоит перед заказчиком кто мы и что мы и зачем все это нужно мы разработчики некой технологической системы которая стоит на железной дороге отвечает за построение расписание грузовых поездов то есть каждый день на всей сети железных дорог нашей страны строится расписание движения поездов на следующие сутки и на период там до нескольких дней эта система оптимизирует расписание с точки зрения энергопотребления эта система является доказанным распределенным технологическим приложением внедряться она стала сначала десятых годов вот в двенадцатом году мы даже получили первую премию международного союза железных дорог за технологические инновации и то есть эта система работает ну уже выше от начала старта проекта прошло 15 лет от начала внедрение прошло десять лет чем она занимается вот так вот непонятным образом для непосвященных выглядит расписание движения поездов то есть перед нами временные дорожки по вертикальной оси станции по горизонтальной оси время и соответственно все что должно происходить на железной дороге вот на этом графике отражена фактически такой сложный многоплановый прогноз того что должно происходить должны даваться так называемые окна для ремонта пути это желтая правило грамма поезда бывают различных категорий грузовые и пассажирские электрички все что угодно то есть все что будет происходить на железной дороге с точки зрения организации процесса перевозок а это графика это основа планирования если мы планируем плохо мы тогда и едем плохо если мы планируем хорошо мы имеем возможность экономить ресурсы то есть ради этого собственно система создавалась как выглядит наше расписание изнутри для каждой из 16 железных дорог каждый день это сцене разрабатывается помещается в базе одно расписание это до двух миллионов объектов нескольких типов объединенных в одном расписание расписание на бывают разные самые крупные расписания могут весить до 500 мегабайт в оперативный базе содержится порядка 500 активных расписаний то что происходит за месяц она живет в оперативной базе потом это уезжает в архив соответственно у нас очень крупные но достаточно редкие транзакции то есть специалисты которые разрабатывают расписание они разрабатывают согласовывают соседями сохраняют базу читают из базы для того чтобы просто не построить нужно из несколько источников собрать несколько расписание других видов посмотреть что было вчера в общем идет взаимодействие как на низовом уровне так и на центральном уровне вот какие нужны были начальные условия когда встала задача импортозамещения впервые настало восемнадцатом году для хранения расписания у нас использовал с база оракал причем oracle стандарты дешевом то есть enterprise данная фича мы не использовали ну и ради экономии денег заказчика играть того что если они не узнает а зачем собственно переплачивать кратно вот как минус на тот момент пришлось делаются репликацию средствами приложения как плюс это нам пригодилось при переходе на пастбища в этом я скажу чуть позже вот естественно система эксплуатируется 24 на 7 естественно к системе есть в течение дня пик то есть ночью графики не стоит она мне нужно можно заниматься техобслуживанием днем когда расписанию строят она должна работать максимально надежная вот всего сейчас у нас порядка 100 взаимодействующих серверов из них более 50 это количество серверов dd но на тот момент порядка 50 patriotic тур нас классической от разменная есть толстый клиент на си плюс плюс есть тонкий клиент есть первое приложение которое потом к этом работает и стандарты пишем lan и ключевая особенность нашего приложения это то что очень мощный слой хранимых процедур то есть уже на действие с базой реализовано было через слой хранимых процедур почему для того чтобы эффективно отделить собственно то что происходит на низовом уровне как каким образом в базе все это хранится и обрабатывается от собственно нужд приложение которое через стандартизованный опять это запрашивает из базы взаимодействие с базой мимо слой опять исключено соответственно можно изменять структуру хранения независимо от приложения можно эффективно разбираться что происходит то есть логировать профилировать отлаживать если вас не устраивает результат вы записали что поступил на вход вы можете добиваться этого до тех пор пока не добьетесь такое разделение позволяет не расползаться из qr коду по всему приложению если вы вдруг решили вместо одной таблице сделал две других то приложение этого не заметите если вы сделаете это аккуратно и openiv страдает то есть соответственно до того момента как встала задача переключаться у нас в вазе было порядка 200 50 облез все это располагалась в одной схеме ну 50 я немножко гигабайт немножко преуменьшил там от 50 до 150 габарит оперативных данных вот порядка 200 хранимых процедур напились клеили в составе нескольких пакетов вот ключевые особенности которые используются во первых это автономные транзакции потому что приложение база данных писала и пишет отчет о своей работе процедура такая это вызвано с такими-то параметрами ну и по ходу потому что технологические объекты устроены сложно бизнес-логика довольно сложная и чтобы можно было разобраться правильно на себя себя ведет или нет естественно все это довольно обильно влаги блокируется причем логе пишется тоже в соответствующий блок таблицу самой базы данных вот второй момент активно используются временные таблицы если сервер приложений мне в процедуру придает 2 миллиона записей он естественно не может передать их через параметры командной строки он предложенных положить во временную таблицу процедур из времени таблицы эти данные загорают и начинает обрабатывать обратно это возвращается через курсор и ну и то что я уже упоминал такой стендбай в кавычках реализован был средствами базы данных то есть расписание на резервный сервер перемещалась при помощи вызова процедур через database link внезапно мы стали перед перспективой импортозамещения почему после что еще наиболее близко похоже на руку только под газ и запилю сквер похож максимально на точнее pelle погрузку или на максимально похож на павелецкую нет никаких проблем с русскоязычной документации то есть документация на пост выше всяких похвал его русифицирована она хотела конечно я очень по делу вот ну и соответственно есть замечательно команда под гаспра капа-ривер нам морально помогала от нас требовалось поменять действительно на ходу двигатели нашей системы база данных должна была дальше ехать на подвесе время на все это тратился один год силы у нас был были не очень большие то есть дата быстро заборчики это два человека ну и соответственно сервер приложений на переходный период мы принял решение должен уметь работать из урока вам из плоскости что в случае неудачи можно было сказать качестве зерна технологии вернуться на уроках соответственно весь этот год все новые фичи приходилось выпускать уже сразу в двух версиях и для oracle и для подвеса это минус принятого подхода ну и соответственно самый интересный момент под газ пришлось использовать ванильный потому что многие вопросы снялись боюсь тебя использовал пост гаспра которая как раз в точки зрения сближения 40 вам намного лучше проработанным чем ванильный пользуюсь но пришлось использовать бесплатную международную редакцией пользоваться версию на тот момент 11 5 вот но хорошие новости тоже были то есть импортозамещения нам свалилась под конец года поэтому сначала нам удалось отбить перевод на поскольку в восемнадцатом году маленькую изолированную задача который мы просто руками перетащили и познакомились что все такое развит пользуясь для пользователя уроков был получен первый опыт вот и второй момент был что мы в этой предметной области в своем жизнь дорожном мире снились одними из первых это была хорошая возможность сделать нам так как мы считали правильным не кто-то нам стоило делаете вот так вот там сказали вот делайте все как сами разберетесь вот чтобы совершить переход нужно было естественно спланировать свои действия вот постарался на слайде пронумеровать я задача которой собственно мы сели и подумали выпили а какие задачи нам на практике придется решать чтобы жизни 40 он перейти к жизнью уже спас гриссом и получилось в общем то почти десяток функция во первых надо собственно общую технологию понять что что мы справимся делать потом научиться работать с подвесом потом важный момент разработать инфраструктурные решения которые позволят нам потом уже взять лопату и копать но что копать надо сообразить на этапе номер три затем выполнить простую такое даже чем-то механическую работу перенести описание объектов перенести сами объекты вот затем перенести хранимые процедуры здесь у нас уже нарисовался огромный ? потому что прямого соответствия между по элис крыльям и пыль прогресс queen в общем то нет смотрим на пункт 3 инфраструктурный его к раунда их надо было еще изобрести дальше тестирование и отладка оптимизации производительности о чем мы сейчас поговорим там много интересных нашлось вещей дальше собственно сам процесс переключения желательно сделать его как можно более коротким как можно менее болезненным потом нужно уже как положено в энтерпрайзе разработать дистанционную документацию обучить администраторов изменить систему и сопровождения релиза все остальное принос при переезде данных и организация с порождение включая мониторинг первое из нашего большого списка создаем собственно технология миграция нужно было оценить объем работ оказалось что есть 200 50 процедур накопившихся 50 не нужно их можно они остались какие-то ошибки какие-то устарели в общем-то такой пришлось сделать небольшой рефакторинг как всегда до этого руки не доходят но вот переезд поэтому пришлось прибраться и убрать пыль вот дальше выбор версии редакции но я уже говорил пришлось брать ванильное дальше обязательно нужно было согласовать заказчиком собственно порядок и действие работы и здесь удалось принять важное решение которое в одном во многом помогло том что необходимо так называемые переходный период у нас стране 16 звездных дорог мы договорились что на одной из железных дорог мы переезжаем полностью оба сервера будут postgres а на остальных начинает действует переходный период тем более версия международной поддержки к ней нету за счет мы оставляем уроков в качестве основного сервера под газ и оставляем в качестве резервного дальше я покажу у нас такая пара работала именно в связке то что репликации у нас было средствами приложения вот и искать глядя если наш опытный полигон работает нормально потом мы переходный период заканчиваем и всех окончательно прекращаем на пол игры чтоб случае чего проблема нам собирать не повествование а только вот на одном под полигоне подконтрольной эксплуатации вот ну и дальше заказать в числитель на ресурсы продумать порядок переноса данных и так далее дальше надо естественно было учиться работать с газ самое главное что здесь надо сказать что это другая свобода по и леску и не похож на пыль пгс quelle и операторы вроде те же но это другая свобода надо это принять пока это не примешь ничего хорошего не будет дальше обязательно нужно воспользоваться механизмом extension то есть возраст отличается от уроку тем что в нем гольцова на механизм расширение которые добавляют у него очень полезный функционал список расширений и дальше покажу который мы выбрали в нашем проекте ну и плюс нужно естесно выбрать инструменты работы потому что мишка и лютер котором мы пользовались естественно пользуюсь сам работать может но он не раскрывает на сало поэтому мы себе выбрали вот сейчас настей мсс как менеджер любой любой человек занимающийся паскаль сам знает тома кайта понятно почему потому что в общем то все мы пришли из oracal и поэтому тонкой совершенно справедливо говорит что не нужно бояться использовать особенности зубы а нужно их использовать и наслаждаться ими наконец мы переходим собственно к холоду какие нам пришлось сделать инфраструктурное решение первое реализовать автономные транзакции потому что сложном приложение без возможности логирования разобраться нельзя если что-то у заказчика идет не так если какая-то операция выполняется не так надо сверху донизу понимать что происходит как реализовать автономные транзакции в ванильном плоскость ну открыв поиск мы сразу видим что можно сделать до тобой слинг сам на себя от этого и string of passion не транзакционный и тем самым можно в телок таблицы писать что-то но естественно открытие соединение точно дорогая операция на помощь приходит механизмы расширения и спасибо ивано-франково используя спор о которой написал расширение поговорим о то есть если вы открыли дата пришлю их соединения и запомнили его в поговори balls кто это висит в памяти открытое соединение и все дальнейшие обращения выпишите из него это уже практически бесплатно то есть логирование заводится начинает работать дальше нужны временные таблицы в стиле oracle в чем принципиальное отличие ворог ли временные таблицы и записывать словарь данных и существует независимо от транзакции возрасте временные таблицы создаются в момент транзакции то есть apple конечно сервер который собирается писать в эти временные таблицы вот эти два миллиона записи он сам создавать таблицы не должен вам про них очень чем должен знать защитить таблицы должен кто-то создать было поначалу принято неправильное решение мы использовали unlocked таблица потому что они все таки чуть быстрее чем обычная таблице они там не попадают увал они не реплицируются у нас томбой они нужны именно для того чтобы предоставить временное место куда все это пишется и откуда потом в хранимой процедуры своих забирает мы это сделали но по производительности это решение совершенно предварительная верное решение немножко забегая вперед это все-таки вызывать попросить стер приложений перед каждым вызовом хранимой процедуры вызывать служебную процедуру с именем той процедуры которая будет собирать и уже средством борьбы создавать весь необходимый набор временных таблиц работает намного быстрее и быстрее до чего руки вот следующее что нужно было сделать это то что в ворог ли мы привыкли что есть пакетные задания джо бы естественно эти жопу у нас тоже были в плоскости встроенных в базу средств для организации зубов нет существуют расширение существует open-source проекта но нам проще было написать поскольку нас ну там к этого есть java-приложение написать просто на базе того что уже есть свой менеджер пакетных заданий которые бонусом может выполнять еще кое-что кроме там база поэтому пришлось от написать дальше какие мы используем расширение в подписи это во-первых дтп слинг для эмуляции автономность транзакции это под грэс и оракал вдв для того чтобы иметь возможность читать писать данные из баз отгрыз из баз oracle oracle из под доса писать и читать не умеет после сна оборот умеет мы входим из под колеса пока крипто для генерации уникальных яичников репак для техобслуживания питон расширение язык питон мужем как правило есть нужно что то делать файловой системе сервера иногда такое бывает нужно ну естественно поговори был сет тоже и эмуляция переменных пакета можно сейчас поговорили болт и реализация псевдо автономных транзакций вот и пыль погрыз ковальченко это собственно проверка хранимых процедур то есть тоже что шокировало при переходе из уроков плоскость то что если вы написали на по иску или какой-то код то он нет компилируется пока там все поля таблиц на месте не присутствует то есть если он в компилироваться ворог или значит это будет работать если у вас процедур откомпилировать пастбища будет она работать или нет будет известно только в момент выполнения например вы указали поле таблицы которая опечатались такого поля нет когда эта веточка кода по этому пути пройдет и встретится вам неизвестны поле таблицы вы получите x epson но уже в рандоме это не очень хорошо надежность в этом смысле ниже то есть от больше похоже на динамический sql со всеми его проблемами поэтому естественно есть средства которые позволяют проверить ход дополнительно вот в частности расширения по по успеху ли по или погрузка ли чек единственное там есть нюанс если вы используете временные таблицы то про них он ничего не знает и напали временных таблиц запросах он ругается там надо отдельно разбираться можно поговорить вот приходим это мы с инфраструктуры разобрали что есть не имея этого мы не могли собственно код писать теперь мы начинаем переносить объекты здесь вопрос такой как собственно отобразить то что у нас было ворог ли на то что имеется в подкасте в соответствии не везде однозначно нельзя сказать что было хорошо стало плохо после кое-какие вещи как зоны более эффективно например им тоже как привыкли к при всегда максим максимум 38 целое число переменной длины здесь может превратиться в короткое целое целое в длинное целое а может превратиться тоже в такой же им тоже переменной длины которые в общем то практически никогда не нужен обычно достаточно использовать перечисленные выше типы быстрее будет работать и это нельзя сделать автоматические все-таки надо посидеть по анализировать свой ход зачем это нужно искать принять решение вот соответствие между типами слов например это текст текст мозга с большой роу это байт а во например для некоторых задач поиска дубликатов урок ли использовался row row иди в под гаси поначалу мы обрадовались что он тоже есть а потом оказалось что вы использовать нельзя потому что он вот-вот выйдет из оборота поэтому пришлось его потом из оборота тоже выводить patterson оказался внезапный прикрепят вот ну теперь собственно опыт самая интересная часть перенос корневых процедур ворот ли мы активно использовали оператор мерз в подлости оператора мерз нет он на самом деле в плоскости как оказалось есть более удобный оператор insert он commit duo black то есть обычно мерз мужчины не во всем его многообразии а всего лишь для того что выставляете какой-то записи если она уже есть то ее обновить то есть фактически это абсурд ними не мерз полноценной пакетов в под гости тоже нет пакеты эмулируется при помощи схемы если вам не хочется чтобы вас выглядел код примерно так же особенность стороны apple конечно сервера и хочется чтобы вас сохранился такое разделение вот то можно использовать пакетами потом не нужно создавать объектов схеме public потому что он использует большое число расширения и расширения также норовят создать свои объекты в этой схеме public возможен конфликт именную и какое-то приложение у вас будет просто конфликтовать ну и самое приятное поначалу он оказалось неприятным а после того как эту фичу вырос пробуйте ддл в воздухе не вызывает оператора commit то есть операции создание модификации таблиц создание корневых процедур они все транзакционные это как оказалось великолепное преимущество то есть если вы обновляете приложение обновляйтесь предложений обычно как там потертый бал creed что-то вот такой скрипт если вор отливает процесс начале у вас там алтарь ты был уже случился то обратно рыбки не плавают и приходится там устанавливаются из бука по здесь пока у вас все не пролетит до последнего коммита у вас изменения не накатываются это очень здорово эксплуатировать в этом смысле легче сами обновления так следующий момент функции в пузырь могут иметь одно имя но разный набор параметров это будут разные функции это хорошее грабли когда вы вызываете функцию она работает не так оказывается вы взываете нету функция прошлую версию которую создали забыли удалить обязательно надо инструментальными средствами обеспечить уникальность и меня чтобы если вы создаете новую функцию со старой функция с таким именем при этом стиралась потому что можно на хорошо налететь ну немножко отличается обработкой к сексу она не такая богатая но тоже можно использовать именованы exception-ы которые возникают при нарушении бизнес-логики приложения чтобы потом с этим разбираться дальше вот и есть такие цветы и выражения которые оператору виз раньше они материализовались что влево на производительность но начиная с 12 версия этим можно управлять материализуется нейтрализуется это решается при помощи настроек вот следующий набор корабли это отличие в иску или ворог ли пустые строки и нал это одно и то же это особенность только вы знаете в подлость это разные вещи если на основании этой логике она такая неявная приложение принимают какие-то решения то очень внимательно эти моменты надо посмотреть в том числе если вам в процедуру приходит в параметры они могут от приложений приходить и как пустая строка и какнал поэтому на входе на тоже стоит некий фильтр чтобы их единообразного например приводить каналу иначе можно получить интересные проблемы вот следующий момент возраст как положено по стандарту нал обновляет строку то есть контент комбинация строки снова приводит каналу смотрите на в пузырьке обнуляется тропам на у ворот ли строку не обновляет тоже возможно интересные эффекты когда вас вдруг все пропало оказывается где-то у вас было конкатенации особенно это неприятно какие то сообщения для пользователей логе пусто на это обратить внимание ну и обязательно используйте определение типов через объект потому что особенны этапе вот это переноса типы часто плавают и тоже можно получить трудно таких отложенные проблемы когда вы что-то объявили как им потом это сделал сленг процедуре вас остался int а в таблицу желонки и они какое-то время работают а потом разъехались и через некоторыми мне хорошо вот если вы будете описывать тип параметра через при помощи ссылки на объект таблицы тогда естественно все это будет синхронизирован автоматически так теперь как эти наши 60 тысяч строк кода не 6045 выкинем те 50 процедур которые казались мне уже как нам при помощи двух человек или перенести есть такая замечательная open source средства под названием города пиджи которая написала жили до того вот это не волшебное средство нельзя сказать что она за вас все сделает можно ехать в заказчиков но она делает очень важную вещь она делает вот что в приложении где используется процедура они используются как правило ради реализация сложный бизнес логики со множеством всяких рифов и ветвления алгоритма вот это средство позволяет не прошибить при копировании этой логике то есть если здесь был iv то здесь их будет можно поправить синтаксис можно поправить там вместо ныл там королевство ставить то есть синтаксические различия но по крайне мере это анти рует что-то как просмотр работала да она и будет работать после то есть после доработки вот этого три вещи руками у вас логика работы приложения должна сохраниться вот естественно с учетом вот этих отсутствия каких-то возможностей или присутствие новых возможностей в подписи ну и вот теперь добираемся до вопроса авто же у вас было а был у нас вот что когда мы сделали первую нашу большую процедуру сохранение расписания и заказчики хотел сменить а как же как как же а как же вместо 10 минут на самом большом расписание и на достаточно медленным сервере она у нас работало порядка 20 часов результат был слегка обескураживающих заказчик естественно спросила что у нас теперь и так будет все работать мы конечно становишься так у нас работать не будет и мы стали заниматься самым интересным делом то есть оптимизации производительности как она работала вора клей как теперь сделать под гаси свет работала быстро профилирует хранимые процедуры использование хранимых процедур позволяет нам эффективно профилировать происходящие внутри неё то есть вот на запросам докладе я спрашивал что делалось прямо спросил ты его руки когда у вас процедуру сохраняет огромное расписание внутри у вас там 25 и скрыли операторов разместит не тяжести каждый из них выполняется разное время спросить план выполнения изнутри хранимой процедуры и ворог это было достаточно сложно потому что с точки зрения всех средств мониторинга и с точки зрения администратора у вас вызвалась процедура которая работает долго вот 20 часов что там происходило вот нам 25 операторов какой из них работу медленно первый вопрос мы должны проблему локализовать мы должны все-таки внутри процедуры сами средствами приложения замерять производительность это лучше сделать параметрически чтобы она не каждый раз предписал но случаи когда вы что-то разбираете придется делать так потому что воспроизвести контекст при котором вызван этот 23 иска или оператор с 25 обычно очень трудно очень трудоемкое скрещивает контекста вы правильно не воспроизведете поэтому надо измерять изнутри процедура вот соответственно ворог ли мы даже фиксировали плана выполнение ключевых операций которые мы знали иногда могут давать проблемы и и складывали если проблемы возникали процедуру начинал работать долго мы смотрели что был с планом у нас там появился фон скан ага понятно звоним администратору говорим что вот у вас вот так как это разумно на практике возле каждой процедуры мы пишем в коде фазу выполнение там оператор номер группы или группы операторов номер 123 вот они вот от колоночка фаз и смотрим время выполнения и мы вносим какие-то действия по оптимизации производительности и смотрим к чему это приводит как это надо делать вот пробежавшись по плану который мы наблюдали на прошлом слайде вы смотрите как красный столбец это у нас была операция номер 32 там что-то долго был такой долгий стилет после того как мы разобрались почему интеллект был долгим и переписали там с индексами разобрались относительно и время выполнения этого этапа она упала то есть плохая гистограмма когда если процедура 99 процент времени выполняет 11 или оператор вот это на мкаде данную оптимизацию сразу чем лучше мы разобрались с тем что у нас творится в этой процедуры тему нас гистограмма более-менее становится равномерной за исключением конечно если вас там просто одну запись спросить или там 2 миллиона записать это понятно это просто уже по природе оператор но в принципе если оператор и более менее ценные по весу то они на гистограмме должны быть более-менее одинаковые это вот способ как бы быстрой диагностики этих проблем и быстрого их с давление раздавив самый большой фактор мешающие производительности мы тем самым наиболее быстро движемся к оптимизации приложения в целом но для этого мы должны писать без информации нет не получим дальше вот этот большая ошибка которую совершили на первом этапе это вместо временных таблиц мы использовали unlocked таблицы нам не хотелось трогать apple конечно сервер вообще оказалась все таки дешевле его немножко тронуть просить подготавливать временные таблицы чем использовать вот такие вот обходные решения но даже тогда мы от 20 часов перешли к шести часам то заказчика конечно тоже не устроило но первый шаг был такой дальше мы поняли что раз после завел себе свои временные таблицы наверное они работают хорошо вы стали из этих аналогий таблиц не пользоваться ими все для какой-то обработка просто оттуда сразу забирать данные из подавать времени таблица у нас в 600 раз ускорилось то есть возраст подсказывал вам что мы на правильном пути следующий шаг надо было все сразу их использовать в 600 раз мы ускорились дальше под грехи в отличие от oracle а в котором любой не за мы ели оператор приводит к немедленному комету в возрасте внутри хранимой процедуры можно и crate и был делать и анализ ты был достаточно сделать анализ ты был наши временные таблицы оптимизатор наконец понимает как она устроена и производительность еще возрастает потому что джет ли варкал анализ писать внутри процедура в голову не придет он он знает просто чему придет вор но эта другая база с чего мы начали надо пользоваться именно возможность в этой базы дальше ну дальше понятно надо вообще отказаться от используя ноги таблиц это как бы в частном случае вот следующий момент синтаксис иску или конечно он стандартные можно писать одинаково для любой базы но в возрасте есть такой как бы диалект и можно использовать операторы определит именно в диалекте плоскость в нашем случае в наших процедурах это давало еще 40 процентов то есть вместо того чтобы сформулировать в экзист или вере x in какое-то множество можно объединять таблицы приобрети делитель с грошевым способом это тоже дает ускорение дальше немножко забегая вперед наша база там работает периодически возникать проблемы со скоростью пользователи говорят нас стал медленно сохраняться расписание или там архивный расписание на стали удаляться медленно вот пример который ворог работал замечательно и который был механический принесем в поисках таблица точек расписания которые там 2 миллиона записи и там 5 миллионов записи в одном расписание и таблица идентификаторов между ними была связь внешне выключаться он делит каскад то есть я мог удалить основной ключ и точки удаляли с автоматом 40 лет работал хорошо в подгрести оказалось что при выполнении этого оператора для каждой из пяти миллионов записи подчиненной таблице вызвалась строка де литвы айди равно такой-то то есть оля триггер как будто бы это ужасно то есть но после осознания что так делать нельзя и причины почему так делать нельзя опять же инструменте рования из гистограммы оказалось что это все очень просто переписывается снова почитаем тому какое то что он по этому поводу говорил не про эту базу но по-моему тема вообще что не бывает плохих сама добывает разработчики которые еще не поняли как это работает то есть работает вот это вот так то есть под гости можно используя такие выражения выполнить оператор удаление из основной таблицы в рамках 20 сад и и передаст резался это этих пяти миллионов подчиненные оператор который на основании этих пяти миллионов удалит и из второй таблице и не надо никого он каскад делит скорость как мы видим вернемся вот на это ускорилось вот так то есть момента как мы внедрили обновления вот средние время удаления расписания максимальное и минимальное но потому что в сцене будет большие маленькие поэтому там столбики разной высоты ну вот эффект которое привело видим на графике так следующее что у нас было бы было вот что иногда индекса опять же наша таблица . расписания она связана с поездами обычно зависимостью внешнего ключа когда мы читаем большое расписание сначала мы отбираем поезда например там 3000 поездов нас интересует в этих трех тысяч поездов события прохождения каждой станции там около миллиона записей ну казалось бы простая естественно для любой базы данных операция что-то медленно работой пользу читается медленно почти так же медленно читается как сохраняется смотрим что творится вот простой select казалось бы во временную таблицу мы отобрали то что мы собираемся читать из основной таблицы мы это читаем план на экране sex com и время исполнения он сто тридцать пять секунд что такое оказалась на допросе объяснить глубину сбора статистики причем мы делали а на лайвстриме перри собирались статистика у нас план оставался six к нам это казалось бы свежая статистика и таблица простая индекс есть вот указав глубину сбора статистики по умолчанию там стоит 100 мы все-таки заставили оптимизатор обратить внимание на существующий индексу он у него обратил внимание и стал исполнять это шесть целых шесть десятых секунды соответственно вот та же скорость после этого изменения сделалось такая но это тоже результат инструменти рование то есть когда у нас возникает проблема мы смотрим в логе какая процедура в каком месте какой sql-оператор дальше уже взбираемся cisco или оператором к сожалению не вор экране в кодексе возможности кроме как сам описанными средствами изнутри хранимые процедуры из контекста хранимая процедура поработать с планами запросами нет поэтому приходится обходиться вот либо с модельными средствами либо закапываться уже в глубоко влоги нам проще с самодельными средствами потому что эта информация она хранится в базе данных реализуется следствием база данных мы как бы необходимость лишние сущности так движемся дальше до проблем секс канва решили в плане у нас индекс скан появился все хорошо после этого вас того как мы отработали алгоритмические проблемы проблемы с производительностью мы стали готовиться к переключению от обеспечивали переходный период одна дорога у нас переехала целиком остальные дороге приехали но после сработал в качестве резерва вот хочу сказать что резерв не потребовался то есть на самом деле после спячки основной нормально отработал и мы сейчас безболезненно ну подними нас немножко сдержал посте различной удаленку в том числе и на дорогах многие работали удаленку поэтому у нас переходный период продлился не полгода как изначально вы хотели а дождались пока ситуация более-менее восстановится чтобы не рисковать на пустом месте как ситуацию вернулась нормам и приключились работаем на пост гостям вот как собственно сам переход произошёл переход произошел совершенно безболезненно раз у нас в исходном приложении расписание которые появлялись на основном сервере переносились на резервный сервер средствами приложения вызывалась просто процедуру которая новое расписание переносила то процедура реализованы на пастбище обращалась к серверу oracle эти расписания забирала потому что у нас эта система не банковском нас транзакции редки но большие и в принципе даже если вот момент переноса новых расписанию что-то пойдет не то эти расписание пользователь разрабатывает при помощи клиента можно попросить его нажать кнопочку сохранить еще раз и все то есть с точки зрения приложения такая как бы замедленная репликация она не критично но это особенность наша задача но это нам очень помогло то есть все данные к моменту приключения фактически на урок на и на пастбище были одинаковые то есть достаточно было остановить сервер приложение в конфиге сказать что теперь мы работаем не 40-го московской сам запустится попросить пользователя загрузить график построить график в общем выполнить чек-лист его основной технологической операции искать помолясь уйти смотреть как они будут на завтра работать уже не на урок ли она под гостям и прочим спрашивает относительно бесшумно то есть никаких криков никаких потерь графиков никаких срывов слава богу не случилось вот но помимо раз мы в энтерпрайзе тем более кровавым вот кровь это надо разработать документацию потому что жили себе где-нибудь эти люди научились работать 40 с ним работали и тут приходит пользовались соответственно нужно человеку дать инструкции на понятном языке провести обучение вызвать их к нам провести семинар чтобы не по телефону или там по небу чтобы он привык . этому как раз помог в переходный период люди у которых под газ стоял но стоял все-таки не как основной сервер как все резервные они за это время привыкли они научились там backup делать научились там запускать и перезапускать в общем все что администратор средней руки должен уметь они за это время подготовились вот дальше в том числе на базе нашего института моет обучение проводили собственно после того как мы обучили переключили началась эксплуатация из действенность нам стало хорошо потому что огромное преимущество под газ и уже про это говорил то что в одном скрипте от беги надо комета у нас все изменения с базой выполняются либо выполняются целиком либо целиком не выполняются это очень здорово то есть обновление перестали быть такими страшными то есть но что же 100 кгц ложка дегтя это то что все таки у нас ванильный под газ и часть расширение которое мы используем это расширение которое нужно компилировать из исходных текстов поэтому просто сказать на сервере юм апдейт нельзя потому что версия библиотека изменилось скомпилирована под другую версию конечно оно должно работать но никто кровью не подпишется что она будет продолжать работать поэтому по-хорошему нужно вести свой репозитории ввести тестировать именно соответствующие сборки ну либо сделать по нормальному и поставить под газ пробка там спуска справа но и пока вырывался естественно включает и отдельные сборки провод насколько знаю и оракал вдв тоже включают тогда естественно можно обновляться как-то нормально так ну собственно говоря это уже мы движемся движемся к пилотов то есть с 1 июня у нас официально на всех дорогах работает позволит в качестве основного oracle выведен из эксплуатации деньги на лицензиях мы сэкономили не такие большие правда потому что нас если использовался они enterprise edition там и мы еще больше сэкономили вот но собственно экономим и так уже немножко сторону не на том что у нас поиска с места руку из-за того что расписание поездов планируется так что уменьшаются технологической стоянки грузовых поездов в то что пассажирские должны идти по расписанию грузовые идут между ними если оптимизирует расписание так что во-первых по нему реально можно проехать что план выполним а во вторых что количество остановок грузовых поездов уменьшается одна остановка поезда лишние то полторы тысячи рублей просто если пересчитать 6 тыс тонн разогнался он там до 60 то вся затормозил просто так а потом снова разогнался вот это если все посчитать то в рамках российских железных дорог если ехать по расписанию доказанный effect 3 миллиарда рублей в год экономии электрической энергии от упорядочение движение по расписанию это важно это хорошая задача кто чтобы по вам помимо этого упорядочивается использование локомотивов нужно меньше локомотивов для того что обеспечить такие же перевозки можно меньше локомотивных бригад вкусом наведением любое наведение порядка она очень благодарна отключает точки зрения экономики поэтому не только импорт импорт замещение позволяет нам здесь сэкономить но и собственно сама целевая функция ради которой систему написано ну и небольшой эпилог сегодня завершилась успешно заказчику нас получает выгоду от импорта замещения и маленький такой пьес чего бы хотелось пользуйся вот по опыту чего мне не хватает не хватает мне например select for a blade блокировка с указанием времени блокировки в подписи к сожалению можно только бесконечно блокировать урок ли можно было сказать что если ресурс мне освободиться то он через тайм-аут освобождается вот излишняя строгость яндекса иногда мешает не возможность посмотреть план выполнения изнутри процедура по моему в про можно опять же ванильном воздухе нельзя вот утилита по годам к сожалению пока уступает возможностям do the pump экспорта do the pumped в ирак ли можно было при помощи дампа еще сортировать набор данных для тестового сервера взять то мне сто процентов данных указав в взять там какой-то маленький срез но каких-то разумных данных здесь пока нельзя и метаданные тоже на не сортирует можно было бы выгрузив на двух машинах метаданные отсортированы можно сравнить с состоянием штатные средства нет поэтому пришлось сделал свое ну собственно говоря спасибо анатолий анфиногенов спасибо огромное такой стресс тест для докладчика ну который тренировался на более серьезных системах спасибо огромное у нас есть конечно же тебя памятная рамка из венеры по сезону до этого этот термос и шоу архивов а там еще значок есть можно калибром надо она наградную планку оповести у нас я думаю что есть несколько минут а чтобы ответить на ваш вопрос и которых неимоверное количество ребят а те кто не успеет вы в дискуссионной зоне сможет на них ответить у кого микрофон говорите здравствуйте у нас ситуацию несколько хуже то есть нос cbd вид переход на российский софт объем данных существенно больше березку иных процедур там почти миллион строк кода и вот глядя на эту печальку у меня возникает вопрос может быть стоило то есть вы не рассмотрели вопрос не переноса на встроенной процедуры под gresso переносов бизнес-логики на свою беду спасибо вопрос хороший он такой как бы идеологически как правильнее то есть из qr код должен быть на стороне сервера приложений или и сколько должен быть на стороне слоя хранимых процедур я считаю что несмотря на вот эти вот достатке и сколько он должен быть на стороне база потому что так он не расползается по всему приложению и любые модификации любые улучшения любые изменения на стране базы они остаются внутри базы это позволяет как бы контролировать то что происходит с того как все расползлось по приложение в очень трудно загнать джина обратно бутылку найти специалиста которые знают сможет пусть грехи что-то написать что я понял автоматикой автоматической конвертации речи практически идет придется делать рука нет нет может неправильно время доклада сказал на самом деле автоматическая конвертация где-то на 95 процентов выполняется это на самом деле очень высокий показатель то есть стандартные песка или оператора где селекция апдейты делита переменной тип присваиваются это великолепно переносится начинается проблема там где например оператор бердж его надо заменять нет полного аналога существует расширение которое заменяет стандартные рак новые функции всякие н г л н л 2 насчет этого можно тоже не особо заморачиваться надо вот проконтролировать там где работа с новыми работы со строками это все-таки человек должен контролировать это робот не разберется но остальное переносит довольно хорошо аналоги структура раковых тип структуры есть у нас активно используются а звуки лет вскоре кузова структуры да да есть мы просто в нашем проектами стараюсь их не использовать стараюсь обходиться стандартными типами а еще вот что большой плюс под кольца кстати в возрасте в отличие от ворогов хорошо работает xml если я базу oracle 11 версия мог убить заставим сел писать 5 мегабайт на xml поскольку там модель дом он распугал в память там несколько сотен раз с соответствующим посредством здесь xml работает со свистом замечательно работает джейсон вот доклад был олега портного он такой становится все лучше и лучше поэтому сложной структуре данных типов вот здесь работают очень то лучше вы упоминали про прикладной способ вытащить вытаскивание данных нестандартность нее рак новый способ дублирования данных другую базу а прикладной каким вкусом прошлого вечера стал юниверсом описано написали процедура то есть задача просто из бизнес-логики вот у меня хранятся расписание в этой базе новое расписание должен переписать на резерв а то есть на прикладном уровне ада на прикладном уровне конечно мы просто через триггер и через к супер давайте послушаем еще вопросом а какой у вас был план отката если после трех и работы на пожгли вы поняли что там все плохо это первый вопрос 2 какой момент вот один момент самый трудно на взгляд и на нём стоит сразу понимание трудный момент особенно трудных моментов 2 когда собственно все свалилась что к концу года все должно работать инфраструктурные решения еще не найдены когда я нашел чем заменить автономные транзакции чем заменить временной таблицы то с этого момента все пошло но еще разобрался что у ворот u pg работает вот после этого у меня восемьдесят пять процентов уверенностью мы справимся появилась технология отката опять же у нас большие транзакции у нас много функционал сосредоточено на клиенте поэтому в конце концов даже если вот эти вот хождения расписанию то есть сюда не сработали бы можно было попросить клиента заново с клиента пересохранить все расписания которая там стране сделал и мы бы дальше поехали спасибо есть еще у нас вопросы онлайн вы можете нажать кнопочку справа от трансляции подключите задать вопрос из дома ведь зовут есть два вопрос собственно первый вопрос быстрый как вы лидировали то что процедура после переноса процедура может работать но там какой-то пятой колонке вместо там строки начать задавать на а из-за чего рассматривали авто тест мы во второй вопрос собственно если бы вас транзакции были бы частая и критичны и вам никто бы не дал устанавливать систему на какое-то время лет вопрос чтобы делали спасибо спасибо начну со второго конечно принимается персонаж в случае нельзя рассматривать как общее он частный выигрыш от использованных корневых процедур со всех со всем этим логированием всеми вот этими развлечениями он хорош тогда когда транзакции крупные и редкие при частых транзакциях накладные расходы на организацию вот эту инфраструктуру они будут уже сопоставимое собственно производительности приложения вот validation во-первых есть естественный теста но главная валидация пользователя который работает графиком загрузив в себе график он сразу это видит если он десятилетием это график строит вам это вы смотрите там набор полосок а он хоть в углу черточка увидит тут же поэтому потому что эта черточка это поезд за которое его если у него нет ни проложил очень сильно пугают еще вопросы да ваши руки поднимаете заранее чтобы мы увидели куда потратить спасибо за доклад вопрос такой вот вы рассказывали это был отдельный instance или вы еще собирали оля дгр на пузыри оля договоров для того чтобы можно было отказоустойчивый сделать это первый вопрос и второй вопрос были ли какие-то эксперименты с имиджем от green оборок ли они в принципе сейчас из коробки включаются на дистрибутивах но с ними тоже там есть нюансы спасибо отличный вопрос из-за недостатка времени в эту сторону не ходил за счет youtube и же вопрос для меня остался загадкой я собственно на конференции на p&g конфи приставал ко всем и надо ли все-таки включать вич в возрасте или не надо поскольку ответа я получал уклончиво это пока фееричного не используем я жду что кто-то применить на практике скажет да у меня стало хорошо тушь ворот ли действительно успеешь у нас используется это реально давала прирост производительности по здесь и пока мы в сторону не ходим тем более под газ ванильные тут слишком тонкий лед пускай он немножко при работается вот и отказывай устойчивость это отдельная песня ванильный пользуюсь не очень хорошо приспособлен к работе в кластере но если вы делает из палок и подручных инструментов поэтому мы нашим заказчикам столько говорим давайте бесплатно давайте обычный стендбай то что кластера не заставляли нас сделают но проблема не в том что просто плохо работает пример в том что администратора на местах не всегда понимают как это работает вообще и и если выбираете ситуации которая чуть более прост чуть более чуть менее надежная но гораздо более простая и человек который обслуживает понимает что у него работает и ситуации когда у нее черный ящик лучше 2 не допускать друзья мы успеем еще два вопроса задача ответить я вижу второй ряд и первый ряд анатолий они простоят выбрать лучший вопрос выбрать лучший вопрос а спасибо за доклад подскажите какие были проблемы были ли с оконными функциями и вот рекурсивными запросами остроумными функция из connect боев с пассивным запросам как вы делали так connect buy а точнее connect байк ворог ли у меня был только для генерации последовательности фаз гости для это просто есть функция поэтому konig бы отпал сразу рекурсивные функциями опять же в силу задача не пользуюсь вообще оконной функции работают великолепно то есть ними проблем никаких нет они в чем-то даже получив все таки две руки давайте ещё два вопроса да вот девяносто первом году и за ней здрасте спасибо большое за доклад можете пожалуйста подробнее рассказать про тестирование вы переносили огромную часть бизнес-логики насколько я понимаю которого была реализована вот как это все тестировали и сколько ресурсов на это потребовалось тестирование силу процесса перехода у нас получилась как бы само собой по дороге потому что вот то что у нас лежит в базе целиком видит пользователь это редкий случай в принципе вот это выезд потому что вот это сложный объект расписания если он принес я криво что-то не доехал или что-то там сместилась по времени или обрезалась это мгновенно видна на экране помимо того что естественно теста у нас были не не автоматизированы и в этом смысле мы не идеально но заметную часть тестирование это просто каждодневная работа пользователя он тут же видит если что то не так а кто является ваш не пользуется им просто я так понимаю что тестирование производилось частности вот но на конечно пользователя получается у нам наш пользователя они работают на железных дорогах в отделах разработки графиков движения естественно мы к ним не сырым продукта приходили но есть там передовые люди которые на этапе опытной эксплуатации нам помогали мы посылали версия не смотрели на тестовом сервере как всё это выглядит поэтому дай им большое спасибо то есть благодарим мы вот продвинулись конечно постинг заклад один вопрос насчет использования ресурсов удовольствие оптимизировать это количество серверов или а мощности при переходе ну скажем так у нас остались ровно те же вычислительные ресурсы это виртуальные машины причем не очень мощная там 32 оперативки вы 68 лидер и скорость работы на том же виртуальном железе осталось таким-же в которых был до переходе мы считаем это хорошим результатом потому что большой резерв производительности есть в про они там наряде операции вдвое быстрее там временные таблицы нормальные там не так медленно работает автономно этому загса как моя самодельная поэтому я думаю что все таки появится про то будет быстрее задача была не не сделать быстрее чем ворог ли задача сделать чтобы был не хуже чем в рог для нашего конечного пользователя спасибо огромное"
}