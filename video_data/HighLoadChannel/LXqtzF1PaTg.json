{
  "video_id": "LXqtzF1PaTg",
  "channel": "HighLoadChannel",
  "title": "Прогнозирование продаж интернет-магазина с помощью градиентного бустинга / Александр Алексейцев",
  "views": 1968,
  "duration": 3261,
  "published": "2019-05-14T15:04:32-07:00",
  "text": "слышно хорошо всем привет я александр алексеев ли дата-сайентистов озоне вот уже 6 больше больше чем полгода месяцев лидер задачу автоматизации выполнения складом и как ядро этой задачи это прогноз продаж пару слов о том что сегодня мы будем обсуждать естественно большую часть подавляющему что времени будем говорить про машин лёнинг но какую-то частью но затронем бизнес применения этого шиллинга потому что потому что вот такая у меня профессиональная деформация мне приходится не только заниматься машинка мной общаться с загнутыми заказчиками этого машина ринга а это порой порой сложнее давайте начнем с того зачем вообще нужно что-то автоматизировать и почему нельзя делать руками почему нельзя склад пополняет руками но смысле отправлять заявки поставщикам руками такая особенность бизнеса такая особенность этот магазин ozon что в нем огромный ассортимент в нем каждой ручке есть 10 разных вариантов этой ручки каждого платье из 10 вариантов платье нас больше двух миллионов наименований товаров одновременно лежит на складе и больше 50000 каждый день заказа нужно пополнять и заказывать внешних поставщиков с нами работает больше двух тысяч партнеров это наши поставщики только в классической части ecommerce еще у нас сейчас поднимается marketplace но пока об этом пока об этом я даже не ну значит 8 fulnan центров и для к для каждый из которых нужно прогнозировать сколько из какого-то конкретного региона который to fulfill он центр обслуживает будет куплено довольно товары и сколько соответственно нужно поставщиков туда заказать и в какой то момент мы поняли что в отделе закупок то есть это люди которые занимаются отправкой коселек и получения этих экселя к брату же работа огромное количество людей церкви перестали влазить на жесткие диски ноутбуков и если ты работать с таким большим количеством партнеров или такое большое количество людей работают в закупках неизбежно человеческие ошибки неизбежно то что кто-то из поставщиков привезет нам больше кто-то меньше кто-то не то да и не только по строчки на и наши мои коллеги сотрудники они могут случайно забить не ту цифру не в ту ячейку и в общем мы оценивали что любые любая ошибка 1 на 1 процент больше если мы закупим мы вложен лишних десять миллионов рублей в товары товары которые в этих 10 миллионов рублей можно было бы вложить что то что другой вот ну в общем 21 веке уже наверное люди могут заниматься более творческими вещами я вот этих 50 человек который надели закупок и можно их часть их работы автоматизировать давайте переходить к основной теме к вашему ребенку для прогнозирования продаж и начнем вот с чего с очень простого вопроса куда на этом графике пойдут в этот продажи обсолютно реального товара в вашем суть на реальном магазине куда они пойдут может ли кто-то ответить вот в момент принятия решения куда пойдет этот график дальше может ли кто-то ответить на этот вопрос наверное никто не может и я тоже не могу я наверно если кто-то может то он ошибется потому что невозможно на этом графике нет ни оси и не понятно что это за момент времени и что это за товар и таких вопросов можно придумать огромное количество сиунов всего мы не учтены все но не ответим на все вопросы о том что какой бэкграунд этого графика как ответить на вопрос куда пойдет дальше и зависть это может от огромного количества факторов и хочется дать небольшую мы назовем это сразу правда сразу дам правильный ответ но и в тоже время один из возможных способов объяснить почему этот ответ правильный этот способ на нижнем графике есть из график изменения цены голубеньким цветом озон красненьким ци оранжевым цветом наш какой-то конкурент вот и видим что озон цена в какой-то момент упала благодаря каким-то действиям цен образовать или я у конкурентов она не упала поэтому продажи у нас пошли вверх но в какой-то момент этот момент как раз который был закрыт от вас самом начале конкурента же снизил цену и продажа наши вернусь примерно тоже на котором были и кажется что мы довольно неплохо объяснили то почему график пошел вниз на самом деле мы с вами не наблюдали огромное количество факторов и помимо цены здесь ещё играла роль тоже конкретно в этом кейсе играла роль то что большая часть конкурентов этого товаров внутри нашего магазина то есть как эта ручка еще 10 других ручек были недоступны по причине вот и поэтому продажи это этой ручки пошли вверх то есть мы объяснили только часть этого феномена но не объяснили какую-то другую составляет соответственно пытаясь спрогнозировать куда же продажи пойдут дальше и на какого до какого уровня не опустятся снова ногу с вами не смогли правильно ответить даже если бы имели вот эту информацию в самом начале давайте попробуем теперь ответить на то какой прогноз лучше вернемся снова к этому графику и добавим 3 варианта прогноза для такого графика и пытайся давить на этот вопрос он снова начнем с вами спорить о том если мы зададим этот вопрос человеку который занимается оптимизацией количество товаров на складе он скажет синий прогноз лучше потому что на склад не будет завален бог с ним что мы не уловили какие-то огромные продажи в период am начало середины октября бог с ними зато у нас на складе полный порядок если мы спросим человека чеки 5 завязаны только на продаже вам сказать что красный прогноз значительно лучше чем синий потому что мы все продали у нас раствор был на складе а то что никаких проблем на стать нас не волнует если мы спросим еще у кого-то он скажет но оранжевый лучше потому что это не ваши мне нашим и вот в общем давайте действовать что всем было плохо или наоборот всем было хорошо и мы не придем сами к единому мнению если не введём какую-то метрику в какую-то метрику и еще на берегу не договоримся о том как мы будем оценивать умы во первых ждем от прогноза во вторых как мы потом будем его оценивать и вот тут это когда часть касается бизнес применения машины рынка в том что если вы на берегу не договорились с нашими заказчиками что им нужно то потом будет полный мрак потом в каждый момент когда у вас будет прогноз 5 продажи 4 будет начнется паника почему перри прогнозируемо потом у вас будет в одну из пяти продажу уже 6 мы опять бы начать панику почему мы не до прогнозируем нужно договориться в начале пути а метрики понять чего ждать от такой метрики и ждать именно этого не чудо какого то что все будет просить прекрасно ждать именно этого вот этот прекрасный дяденьку которого была какая-то тактика но я придерживался вот примерно примерно в этом я говорю нужно ее избрать и придерживаться мы выбрали для себя в построении модели машинного обучения прогнозирования метрику моей почему потому что в виду особенностей нашей обучающей выборке поскольку в нашу магазин такой широкий выбор большинство товаров в каждом конкретном регионе продаются в небольших количествах какой-то конкретный зеленый платье с конкретным пуговицами продается до 35 штук день в сумме зеленый платье продается много а вот какой то каждой конкретной подается не мог поэтому у нас когда мы сели обсуждать с нашими бизнес заказчиками а какой прогноз вам нужен мы все-таки пришли к тому что до выбросы будут мы не будем на них обращать внимание мы будем стараться предсказывать основной тренд и выбросы могут быть почему потому что пришли какие-то оптовые покупатели купили у нас сразу 20 учебников какой-нибудь классный руководитель попробовать собрал деньги купил 20 учебников бокс с классным руководителем вот главное чтобы в общий тренд продаж с этим бы иметь какие-то запасы главное чтобы улавливать общий тренд продаж давай теперь перейдем к тому как мы двигались в сторону развития прогноза мы начали вот все мы взяли и построили самый тупой прогноз которую может быть это случайное число от 0 до 1000 и получили метрику моей равно 496 из чего можно сделать вывод что это это худший прогноз который можно придумать ну наверно можно прямо и хуже вот на это очень плохо если мы получим такую цифру это значит мы делаем что-то очень плохо и начали дальше играть в людей которые знают как можно предсказать прогноз без какого-либо машины king а давайте предсказывать продажи на неделю как продажи за среднюю неделю продажи этого товара и получили уже метрику 1 из 45 метров у моей это уже значит лучше чем 496 но это еще не предел дальше продолжаете рассуждение мы пошли а может быть не средний продажи важны а то что в последнее время происходит и взяли продажи за прошлую неделю получили метрику уже 126 которые уже лучше чем 145 дальше мы сказали наверно это это важно и давайте возьмем 50 процентов от прошлой неделе 50 процентов от средней недели и посчитаем метрику и попробуем так прогнозировать и получили 123 и в какой то момент мы сказали давайте попробуем собрать небольшую обучающую выборку просто сколько товар было продано на таргетной недели сколько за предыдущую сколько в среднем за неделю и попробуем обучить на этом простенькую линейную регрессию и получили вот такие коэффициент написать 50 46 вот что приятно видеть что сумма 055 046 больше чем один совсем чуть-чуть это значит что в целом наблюдается растущий тренд вот по сравним с прошлой продажами среднем продажи вот и получили мне такого качества 12 и сделала из этого вывод что какой-то какой-то потенциал для применения машин ребенка в нашей задаче есть из или генерить фичи какие еще фичи помимо продажи прошлой неделе продажа среди недели могут быть нам полезно силе генерить фичи и вот тут очень важная штука что мы не те ли это делать внутри команды the silence а мы пошли к людям которые видят эти цифры каждый день мы пошли к людям которые занимается закупками спросили ребята от чего зависит то сколько купит на следующей неделе и мы начали выслушивать самые сумасшедшие идеи которые мы бы нам бы никогда не пришли в голову одна из них это недавно женщина которая занимается закупкой игрушек просто как мы объяснили все что мы учитываем наши какие фичи у нас есть прогнозе она сказала так у меня получается свинок нужно будет руками закупать и группа почему руками мы абсолютно точно главным какие-то тенденции оказался следущий год год свиньи и она ожидает рост игрушек мягких виде свиньи о чем естественно же прогноз знать не может то что нужно 24 года история для того чтобы улавливать эти 12 ягодичные тренды того что что то что содержит название слово с меня будет расти вот и мы насобирали от них огромное количество всего что только можно это были ну естественно такие простые вещи как прошлые продажи а просмотры как меняется цена какая она была до до момента прогнозирования и какое оно будет после а какая дата это под новый год или это 8 марта и собрали из них 170 признаков мы каждый из этих каждый из этих тем развернули на несколько признаков грязь это прошлый прожит продажу за прошлой недели за две за 34 за ровно год назад а какие продажи были во всей категории в которой находится товар за прошлую неделю за две за 34 если это просмотр это тоже неделя 2 3 потом и начинаете комбинированные признаки а какая конверсия просмотров в продаже а какое оно было 2 недель назад а как она менялась за все это время а что это может означать то может означать что товар не выгодно расположен он был расположен где-то выгода на нашем сайте конверсия была очень большой а потом наши коллеги из поиска из поиска из поиска в поисковой выдаче понизили этот товар и конверсия у него стало хуже потому что люди меньше доверяют тому что что находится в нижней части поисковой выдаче и таким образом мы пытаемся пытаемся уловить что что товаром как то как то он эволюционировал за последний месяц и использовать эти знания эволюции для того чтобы сделать прогноз на ближайшую неделю очевидно что если у тя есть прошлые продажи если бы мир был абсолютно стационарным то нужна была только одна фича сколько продали за прошлую неделю вот столько продукты со следующей недели однако все остальные фичи помогают сказать а как же будет отличаться продажи на следующей неделе от продаж за прошлой неделе расскажу о самых крутых вещах которые дали на самый большой фич impotence это ну очевидно счет продаж за прошлую неделю за 2 3 за 4 очевидно что доступно чтобы доступность товара это какой процент времени товаров присутствовал на на сайте почему вы могли купить 0 раз вы могли купить 0 1 потому что его не было потому что его какой-то человек не закупила ли какой поставщик на мне привез это угловой коэффициент по прошлым продажи что это такое мы поставили 7 точек 7 продаж за семь последних дней провели по нему прямое взяли угловой коэффициент таким образом какой-то тренд уже внутри неделя чтобы словить но очевидно отношение цены прошлых будущий дает огромный прирост качества потому что мы должны предыдущем примере виде личность будет огромная скидка очевидно товар начнут покупать сильнее чем до этого количество прямых конкурентов прямой конкурент это я имеется в виду внутри нашего сайта если это ручки значит они есть где там 10 или 20 или может быть в этот раз 2 всего две ручки конкуренты или она вообще единственности категорий тогда продажи будут довольно стационарно двигаться то есть продажи на прошлой неделе будет очень похоже на продаже на следующей неделе потому что по сути никаких альтернатив нет это внезапно оказались габариты товара оказалось что размер масса какие-то на ширина это очень сильно влияет на то как зная прошлое продажи сказать о будущих продаж как это был двадцать внезапно мы пока не очень понимаем почему но но как-то так почему то например длинные и длинные им палки в общем длинные и узкие они значительно больше похоже их продажи на предыдущий на предыдущей неделе будущее тот предыдущий деле это феномен который мы не знаем как объяснить общем вот он есть удочки нападает подходит и полки вот такие дела но и очевидно что номер дня в году подсказывает то какому на каком этапе года мы находимся это под новый год под 8 марта есть киты очень сезонными по продаже очевидно что если в октябре продажи какой незамерзайки они небольшие небольшие поток как только ударят первые морозы наши люди сразу закупает огромное количестве замерзают и вот наша модель признает что из года в год это происходит примерно в какой-то в конце октября ok дальше хочется сказать про сложный фичи в чем сложность сложности формулировках на самом деле не вычисления в том как их сформулировать вот первое это отношение продаж просмотром за все время деленное на отношение продаж просмотром за последнюю неделю что это о чем это говорит это говорит о том что в среднем конвертировались просмотре в продаже вот так а за последние недели вот так и мы нашли отношении этих двух величин оказывается что эта фича имеет большое влияние на то как предсказать по прошлом продажам будущее продажи точно также конверсии просмотров в добавлению в корзину с разных полк на сайте а как с этой полке to work on просмотра конвертировались в добавление в корзину а как с этой полки на полку имеется ввиду это разные области на сайте где то там в версаль рекомендации где-то поисковой выдаче где то еще что то и прикольно что отношения продаж за последний деле по продажам за четыре последних недель это просто есть эта цифра близка к 1 4 то прогноз может принять практически любое значение ну потому что на что идет более менее стационарно за четыре недели продали 4 раза больше чем за последние если цифр далека от 1 4 то вот как раз там и находится самые непредсказуемые вещи там какие-то всплески продаж находится то есть что-то идет какой-то процесс и значит вряд ли можно полагаться сильно полагаться на прошлые продажу но это я рассуждаю как человек если бы меня меня бы обучали по этой выборке но я все-таки чуть чуть чуть одушевляет те модели которые мы который мы обучили расскажу о том как мы собирали обучающую выборку обучающей выборкой это это боль это боль она собиралась очень долго и так происходит всегда когда тебе нужно данные за большое количество времени назад почему так потому что за это время даже в самом идеальной системе сбора данных всегда произойдет что-то в духе эту цифру мы считали его так а потом пришел в том какой директор который уже уволился и сказал что теперь нам продажи нужно читать вот так их начали писать тот же столбец вот это прошло какой-то момент который никто не записал в какой вот еще просмотре мы раньше считали там в каком-то одному сервису которая помогает нам аналитику сайта давайте теперь по кому-то другому начали писать тот же столбец а вот тут у нас сервер какое-то время лежал но мы не записали точность какого дня по какой поэтому 10 и не означает шепнули и для того чтобы собрать выборку мы просто до 2 недели ходили по разным хранителем данных и спрашивали а какие у вас есть данная пила а у вас оказались одни и те же они почему-то не равны но вот и выбирали какие-то катках и какие-то которые оказались лучше см и 2 недель просто ходили и спрашивали просто спрашивали что у кого есть и как собравшие то мы попробовали сначала на панасе написать но не запущу естественно мы попробуем написать на подписчиц очень работал плохо и долго ему отказались от идеи очень быстро и написали на спарке огромный кусок кода который очень медленно работает но при этом он позволяет пережевывать огромные объемы то есть мы лазим по таблицам которые десятки миллионов строк в них мы как-то кодируем какие-то данные то есть вот нам нужно на пляж собрать хочу продажи за последний за последнюю неделю значит нам нужно по всей нашей выборке пройтись по конкретным датам отсчитать неделю назад не дни это не не звучит очень сложно но на деле когда тебя появляются все более и более сложные фич и это становится все сложнее и сложнее мы написали две тысячи строк кода и работают они сейчас у нас в бою ну вот когда нам нужно для каждого конкретного дня до 50 тысяч товаров посчитать пятьдесят два три наверное просто влазит по таблицам в продукте и собирает собирать вещи сам расчет длился четыре дня мы подняли огромные огромные вычислительные кластеры на них считали четверо суток днем и ночью мы следили за тем как это происходит и собрали выборку из примерно 15 миллионов сэмплов после очистки осталось 10 очистка это что такое это когда ты уже смотришь на значение своих речей и понимаешь но это маловероятно и значения скорее всего это что-то аномальная и нам не нужно а в этом обучать нашу модель например какой то товар продавался продавался продавался по потом раз и вот две недели нулей ну наверное просто мы на этапе очистки самих данных не обнаружили тянули ему довольно довольно смело мы выбрасывали сэмплы которые нам показались странными которые нам казались там либо это три сигма либо это какие-то распределения в общем мы довольно смело отбрасывали кажущиеся неправильные сэмплы у нас осталось 10 миллионов сэмплов на 170 вещей вот такой datasette это то чем мы работали в конечном итоге 170 печей это вот у ровно то о чем я только что рассказывал продажи прошлые за две за три недели просмотр и добавление в корзину все что угодно собрали такую выборку и начали обучать на них модели начали обучать на ней модели естественно начали с линейной регрессии обучили и и очень быстро и получили метрику уже одним 15 если помните в последний раз я беру pro 12 это кажется кажется что это совсем небольшой прирост возможно это так и есть в значениях именно этой метрики но когда у тебя 10 миллионов когда у тебя выборка 10 миллионов которые средние значения примерно примерно 5 10 15 вот это изменение в в такие на такие небольшие пятна такое небольшое количество пунктов метрики в и уже дает сильный прирост хотя бы в визуальной оценки качества если уж если в конечном итоге продавать это придется продавать хорошие слова своим бизнес заказчиками для них это повышение радости в общем она не соизмеримость с уменьшением этого мои дальше мы попробовали из клена random forest агрессор получили еще лучше попробовали как живут также будут все было бы хорошо только очень долго очень долго у нас к сожалению не было доступа к вот для обучения и капуста и лепим а у нас были только процессоры и очень долго одна модель на 10 миллионах сэмплах обучалась с теми параметрами которые мы для нее подобрали поэтому возможно если бы тут была джигу чтобы часовых быстрее мы бы остановись на нем они пошли бы дальше нам и попробовать найти что-то более быстро это был и дбм он обучался два раза быстрее к создавался даже чуточку лучше и на этом мы решили остановиться и потратили большое временно то как создать такой pipeline обучение моделей и это на самом деле не так просто когда кажется что 600 секунд это всего 10 минут это не так долго но когда тебе нужно перебрать параметры когда тебе нужно как-то проверить потом того конечное решение отказаться от него обучить и снова подобрать параметры каким трендом сердцем и чем-то еще это огромное количество времени и нам нужно был обучить 130 моделей нам мы разбили все товары на 13 категории по физическому смыслу ноутбуки бутылки воды стал и мониторы и мы разбили метро из таких юмор и дабл кластеры и для каждой из них обучили 10 модели на 10 разных глубин прогноза 5 6 7 8 9 10 дней и там до 15 по моему очень сильно лили до 16 дашь то средняя глубина прогнозам и сейчас расскажу о каких-то шишках которые мы набили в процессе обучения лдпм и о том как возможно этих шик это возможно поможет кому-то здесь избежать этих же проблем первые проблемы это как подбирайте параметры к сожалению в тот момент когда мы находились это было несколько месяцев назад в тот момент мы плохо плохо подумали и начали пользоваться родовая сердцевине то из скверно известные известный tool для того чтобы перебрать параметры и при параметры мы начали ловить то что gbm почему-то на них начал падать то есть ты ему даешь огромный выдает нас там 72 и drunk мир был мы даем улыбки бремя указан джобса но 72 аронова сердцевин джобс один и все не то что вот это хорошо было подала оно не падает она просто за в какой-то мере глохнуть то есть так все меньше и меньше я др я держу используется и ты ставишь это на ночь уходит домой возвращаешься взять не прошло там ее 2 3 каких-то итераций потому что все просто заглохла и не упало при этом и мы очень долго с этим пытались найти google или пытались что-то придумать единственно что работает эта улыбка была у самого к указывается инн джобс один параллели за счет randomizer стиви пролить этот процесс но проблема здесь в том что оно мое сердце и под каждый из этих job начинает загребать память себе в в оперативу то есть я не знаю как это устроено у него внутри но начинает загребать чуть ли не весь dataset себе под каждую одну из таких job и соответствуете нужную очень сильно расширяется объем оперативной памяти которую возможно жертвы даже количеством ядер за счет того чтобы набрать как можно больше пирате вы дальше такой трюк который нам пришел в голову только уже ближе к концу это использовать параметр calls mp3 это параметр d bm который говорит о том какой процент фичи дать каждому лиру мы использовали его сначала варьировали у широком диапазоне остановились на диапазоне 0203 почему потому что когда у тебя работает в продакшене весь этот вся эта машина какие-то таблицы могут отсутствовать в какую-то конкретную нас ночью то что происходят какие-то таблицы могут отсутствовать какую-то конкретную ночь по разным по самым разным причинам и какие то фичи могут посчитаны быть неверно и такое ну скажем так такая регуляризация позволяет сделать так чтобы эти неверно посчитанные фичи эффект или хотя бы не всех линкоров внутри внутри этой сложной а сама модель ну и как-то эмпирически мы пришли к тому что нужно побольше делать количество steam отаров и посильнее закручивать регуляризация вот вот эта схема у нас сработала я не говорю о том что это какое-то единое правило как работает вот эта схема у нас работал в нашей задаче как можно больше 6 метров для того чтобы модель была с одной стороны посложнее и могла уловить зависимости в этих ста семидесяти фичах а с другой стороны закручивать ее регуляризация потому что очень любит очень если этого не делать она начинает очень сильно перри прогнозировать для товаров которые еле-еле продаются только у них происходит какая-то одна случайная продажи чуть более более-менее высокой они стоят перед прогнозировать и выше почему-то мы ловили такой эффект и вот побороли его именно этим побольше и нас тиммейты спа сильнее закручивать регуляции там есть много для этого параметра и альфа революционный там есть и можно максимально погнуть дерево менять в общем закручивали мы пожестче количество секторов делали побольше дальше после того как происходил этот рэндом search мы выбрали 10 наилучших наборов параметров и для каждого из них уже глазами считали дополнительные метрики мы считали моей для разных диапазонов таргета то есть так как мы как мы ошибаемся для таргет of равных нулю как и для таргет of равных 1 2 3 и в каком-то диапазоне мы считали моей для каждого для разных диапазонов торги raw мы строили lernen курс то есть мы выбрасывали например часть часть обучающей выборке обучали снова с такими параметрами где мы находимся новые данные по уменьшают лосс на тесты в браке или нет мы достаточно внимательно изучали вот эти 10 параметров потому что изучает миллион параметров глазами это очень сложно в общем мы разработали для себя вот такой pipeline долго долго работать трендом search отдает тебе 10 на лучших параметров 10 лучших наборов и дальше с ними работаешь визуально если соединить так не один тебе не удовлетворил снова снова range вот так примерно мы работали в в пятером по-моему 5 или 4 5 дней мы вот промышленном темпами обучали модели то есть мы джули ли кто-то ночью кто-то утром просыпался смотрел что там происходит вот эти действия лучше параметров осматривал глазами или за перезапускал либо сохранял эту модель ложился подальше таком режиме мы работали примерно ну примерно неделю вот и в конечном итоге мы обучили 130 моделей как и сказал 13 типов товаров и для каждой из глубин прогноза в каждой был по 170 речей и в среднем мая у нас получалось примерно 1 это с одной стороны может выглядеть круто как бы средний модуль отклонений у вас районе единицы то есть в среднем отклоняйтесь на единичку и тоже вроде очень круто но это очень круто если только у тебя в обучающей выборке этих единичек например не большая часть вот и тогда это как бы уже сто процентов ошибка и как показывает как показывает анализ результатов единички предсказывается хуже всего потому что единичка то что этот товар купили один раз за неделю не говорит на самом деле ничего о том хорошие то товар или плохой покупается он или нет один раз могут может продаваться все что угодно в самый случайный момент найдется человек под какую-то свою конкретную статуэтку он ее купит и это может ни о чем не говорит ни о будущих продаж коня прошлом поэтому единицы предскажет а сложнее сложнее всех и мы нашли этого физически сумму физическое объяснение и вообще не стали не стали из-за этого расстраиваться а что дальше мы обучили прогноз мы закончили математическую часть то есть мог учили прогноз у которого нормальное распределение ошибки с с нулевым среднем до где-то дисперсия больше где то меньше мы закончили часть которая может делать которые могут делать только математики только дата-сайентистов теперь нам нужно отдать этот прогноз в мир и сказать вот теперь вы можете с помощью него как-то закупаться вы можете там покупать ровно по прогнозу можете меньше прогноз больше зависеть от ваших задач и вот теперь в этот момент возникла необходимость как-то применить наш прогноз для бизнеса и мы на скорую руку набросали такой алгоритм который кажется очень простым и даже возможно слишком простым но тем не менее он отлично работает у нас вот уже наверное из кнута месяцев алгоритм такое мы берем мы обучили некий мета алгоритм входом которого является прогноз продаж этот метод алгоритм он имеет всего два параметра к и б и берет от бизнеса от бизнес заказчика по каждому товару некий x это процент времени который бизнес заказчик хочет чтобы этот процесс чтобы этот товар находился на складе то есть он горит на 95 процентов и мы в качестве ксапо сэндерс пять процентов или 50 процентов это кот не очень важно нас товар есть там масса заменители ничего страшного сегодня будет пять процентов из недели на складе мы обучили такой алгоритм который во первых лосс мы оценили стоимость от перри закупки каждого товара и от того что лишние руки будут разворачивать и класть эту стиральную машину на полку ой там 15 минут работы каких-то грузчиков одних если раскручивать ручку то это 10 минут работаю каких то других людей которые получают разные зарплаты и мы попытались посчитать сколько стоит перед закупить и сколько стукнет закупить каждый товар сколько для нас то стоит невозможно учесть это вещи типа имиджевых потерь там если нас не будет какой-то iphone и в первый день продажи айфонов наверно это имиджевые потери но как как их оценить пока не придумали поэтому там скорее есть такие вещи только только но только измеримые и обучили его на такой странной выборки мы взяли часть отложенную от тех десяти миллионов и внесли в нее случайный шум случайный шум с дисперсиями которые мы померили статистически из качество работы поставщиков с нами они нам привозят например плюс-минус процентов 10 от того что мы не заказываем в среднем мы добавили к нашей обучающей выборке этот шум они нам привозят плюс-минус 2-3 дня от того дня когда пообещали мы добавили в обучающую выборку случайный шум и таким образом мы построили выборку которая пытается моделировать реальный мир и теперь мы сказали а сколько нужно прибавить к нашему прогнозу д это дисперсия этого прогноза де-та десясь нашим прогнозам какое количество дисперсий нужно прибавить для того чтобы минимизировать потери в деньгах в нашем реальном тяжелом мире в котором все плохо который выпадает снег машины не приезжают в котором люди болеют и все все все что вы могли учесть мы это учли и обучили эти параметры к и б для каждой модели и теперь к прогнозу добавляем вот эту прибавку прибавку которая также зависит от икса пришедшего к нам от руководства и говорящего что этот товар нам обязательно нужен этот товар может и может и отсутствовать и вот вся эта система в целом уже дает ответ сколько нужно купить помимо prediction а есть еще вот эта прибавка который горит сколько в итоге нужно купить сейчас чуть-чуть отвлекусь от какого-то мужчины линги обучения все вместе это собралось такую большую систему которая каждую ночь в час ночи запускается выбирает для каждого товара наилучшего поставщика по огромному количеству критериев это на самом деле не только цена есть еще кучу всю кучу всего это скорее люди из коммерции могут перечислить какие есть пункты в контрактах с поставщиками там есть масса всего и отсрочка платежа дается еще кучу общем всего 2 что я не очень некая на самом деле куча параметров контрактов с поставщиками из которых можно выбрать наилучшего просто по приведенной цене у кого в итоге дешевле будет купить прогноз продаж и формирование заявок исходя из расписания этих поставщик поставок поставщиков исходя из цифр посчитанных как я показывал на прошлом слайде теперь как это все работает работает это так мы в час ночи запускаемся затягиваем около 20 гигабайт данных из разных и скрыль источников сотни разнородных из с разными поддерживаемых разными людьми затягиваем в себе в pdf с дальше 5 тысяч строк spark о да да это все переваривают и в итоге мы примерно там к шести утра в 7 утра отдаем на стол людям которые отвечают за то чтобы нажать одну кнопку это все улетела поставщика мы отдаем им на стол практически уже вот чуть ли не excel ки просто таблицы которые нужно нажать вот по нажатию одной кнопки улетают поставщикам тасс теперь человеческий фактор хотя бы с нашей стороны минимизирован минимизирован из другой стороны учтен человеческий фактор с внешней стороны вот с помощью этого случайного шума котором я говорил выглядит это все довольно громоздка мы используем air flow для скиллинга запуск алгоритмов один за одним выглядит это все примерно вот так и на первых порах мы те кто сыр flow сталкивался знает что бирлик белые квадратики должны закрашивается зелененький вот снизу вверх или в каком-то порядке ему в на первых порах сидели всю ночь сижу или смотрели как квадратики закрашивается зелененький и я не привел график мы построили для себя график распыления комментов по во время от времени суток и там в общем сейчас ночь и вся штука взлетает и там так часу ночи такой большой спец потом все затихает до пяти утра под опять траты все это где-то падает ну вот и в 5 утра см новая волна и там до семи какие-то сумасшедшие люди программируют и к семи утра все в итоге до считывается вот используем мы r flow и и используем хотел как ветер какая-то дать этому оценку но не стал естественно когда у тебя такая ответственная задача если мы что-то не закажем озон останется без этих товаров когда у тебя такая ответственная задача как я играл ошибку в один процент это уже 10 миллионов ошибка в если вообще ничего не закрыт на сто процентов это естественно огромные огромные затраты мы объехали с мониторинга me мы на каждом самом начале по 100 как данные затянуты мы проверяем автоматически свежести сир данных мы находим столбец в котором указана дата определяемся эта дата отстает от сегодняшней даты не нужно какое-то допустимо для нас величину мы повесили себе оповещение в slack мы дежурим ночью кстати оповещением снег удобная штука тебе в чатик приходит во первых любое сообщение ты хочешь любыми смайликами чем угодно и в этот тред кидает тебе trace ошибки в этот очень удобной штуку то есть тебе не нужно лезть и смотреть в код что там у тебя палате вслед приходит прямо с trace'ом ошибки и ты соответственно лишь кому звонить кто вот это место написал кому звонить кого поднимать мы дать приходился жюль по ночам сейчас уже значительно меньше слава богу нашим дат инженером которые спасибо смысле даже даты инженером которые наложи вот наложит улучшают улучшают укрепляют наши хранилище данных ну и конечно это автоматическая проверка результатов и сложно вот что что как проверить результаты прогноза как проверить что то что мы спрогнозировать на следущей неделе пять это правильно ну проверьте может бы только через неделю правильно это было или нет но есть какие-то вы придумали кита эвристики сравнивать с прошлым неделями и мы знаем как примерно какие-то средние велит средние отклонения продаж будущих от продаж прошлых повесили какие-то эвристические проверки на качестве нашего прогноза чтобы опять же получать оповещение о том что что то сейчас явно пошло не так мы как-то отклонились от прошлых недель как-то слишком странно например на 8 марта это происходит абсолютно легитимно потому что там продажи дейсвительно нас тут очень сильно недели к неделе мы повесили такой прекрасный мониторинг естественно наверное наверное не видно конкретных цифр да они и не важно на самом деле важно скорее некая масштабность этого и подчерк хочу повернуть необходимость этого потому что каждый день ты будешь следить за какими-то метриками качество работы своего алгоритма но ты все равно все равно нужно видеть эту картину в целом и вот если мы посмотрим на верхней столбики такие разноцветные то мы увидим что такая бирюзовая нижняя часть она потихоньку становится не все меньше и меньше это не бирюзовая часть это как процент процент товаров которые мы угадали с точностью от нуля до двадцати процентов нашего ошиблись от нуля до десяти процентов и этот столбец падает это значит наши модели устаревают а это значит нужно переобучать и это какой-то вырезан из контекста пример но он горит вот для нас он сказал вот что что нам пришло время модели переобучать они потухают и возможно появились какие-то новые паттерны которые наши модели уже не знают мы их обучали документам в июле мы знаем только то что было до июля а вот так как прошел как прошла подготовку 1 сентября мы уже не знаем подготовка в смысле все покупаете сотки ручки там и все такое уже этих знаний у нас нет их почему-то сейчас не хватает а рассказал практически все что хотел расскажу классный побочный эффект которые мы получили почти абсолютно бесплатно и этот побочный эффект что поскольку у нас есть 170 признаков мы понимаем прогноз мы теперь берем все эти стойки 169 признаку замораживаем один начинаем менять и смотрим как от этого меняется prediction например естественно самое интересное в этом во всем как меняется при тишина если менять цену таким образом мы взяли построили модель того как меняется спрос на товар в зависимости от скидки которую планируют наши цены образовать или на будущую неделю и что важно что этот что это эластичность она зависит не только от самой цены служб раз зависит не только от изменений цены но и от того какая сейчас обстановка вот этот пример который здесь нарисован это как раз самки летом и одни и те же самые санки летом и зимой сделан такой эксперимент и зимой как мы видим что делаешь делаешь небольшую слова точнее набрать летом если делать небольшие скидки это все но никак не помогает sand комп радоваться а потом с какого-то момента появляется люди которые готовятся они летом и они начали покупать то есть до какой-то скидки вы сюда не можем достучаться до части мотка кто отвечает за планирование зимних покупок летом а зимой это просто работает как для обычного товара делаешь скидку товар продается быстрее наверно на этом практически все отдельно я не сделал отдельного слайда для богов спарка который мы нашли за эти продолжительные положительные месяце написание кода на нем мы конечно надо предаться научились но мы научились в первую очередь от того что сами были с этим не очень знакомы и возможно каких-то вещей если мы короче а самый главный совет читайте читайте догони документацию лезть в интернет и гуглить если вас что то не получается вот мы столько шишек набили себе есть одна вещь которая про который даже spark говорит что они это знают если взять из таблицы заселить какое-то количество столбцов получить одну таблицу потом из этой же таблице заселить получить другую таблицу по джо нить эти две то все сломается хотя казалось бы не должно вот и даже старых знает о том что но это есть и честно об этом признаю ставление о мышлении и спастись от этого можно только тем что сбрасывателе все ленивые вычисление получил какую-то новую таблицу мы даже функцию цель написали на зайцев bump de funes это функция которая превращает в этот фрейм рдд и обратно dataframe то есть это не делает по сути ничего но сбрасывать среднего и вычисления и вот этим можно себя обезопасить от большого количества проблем которые в парке есть и вот вон прямо признается в том что они у него есть осталось совсем немного времени расскажу ещё о двух вещах мы планируем конечно machine building развивать вот тот когда которыми сейчас рассказывал мы и это развитие от нас требует сам бизнес который в кавычках к сожалению планирует тоже расти и нам сейчас уже приходят разговоры о том что это сейчас у вас там цифры по продажам но каких то платье в 10-20 пройдет еще какое-то время васу перехватив будет 10 раз больше мы будем 10 раз больше разных видов платьев продавать и во-вторых они продаются будут 10 раз больше и поэтому ваши обучающей выборкой уже устоит моно морально устареет вам нужно будет сделать новые и мы поэтому потихоньку готовимся вот так примерно планирует озон развиваться и расти и мы для себя до to say this ты понимаем что нам придется придется как-то думать над использованием старых данных каким-то образом это устаревание передавать модели то есть эти старые данные они релевантны но уже для другого магазина который был в прошлом а теперь есть тут магазин который в будущем и как их использовать как модель и передать эти знания мы пока пока а над этим активно думаем ну непосредственно команда которой я руковожу командой дата-сайентистов который занимается этим проектом я руковожу конкретно этим проектом мы планируем мы сейчас активно изучаем пастеризацию временных рядов мы хотим по класс 3 заводь наши товары не по физическому смыслу а по характеру кривой который описывает их продажи ото дня ко дню на самом деле тема очень живая кластеризация временных рядов был неожиданно в медицине очень много где применяется люди научились много чего измерять у человека но пока не научились интерпретировать эти измерения вот читал очень много интересных статей в основном в основном почему-то в китае очень живо эта тема вот в первую очередь в медицинских исследованиях что-то к человеку подключать датчики что-то мере то потом не могут интерпретировать и кластере зуд просто эти временные ряды и дальше смотрят а почему эти пациенты попавшую от кластер чем они похожи в реальной жизни вот так мы хотим просто рисовать наши товары на некие это будут какие-то сезонные это будут какие-то которые традиционно плохо продаются которые традиционно хорошо до этого такой вектор развития в эту в другой ipad и потом попытаться выделить а этим bass фичи которые подскажут на товар только появился подскажут а какой же будет у него паттерн это пока что такая наша главная reset задача мы сейчас занимаемся но если мы хотим увеличить глубину прогноза добавим новый fi чем он как-то подключимся какому-нибудь api который нам поможет подсказывать погоду от нас то очень просят люди которые торгуют торгуют плохое слово которые продают незамерзайку шины зимние которые продают новогодние всяк атрибутику она начинает активно продаваться снег 1 выпадает и очень много еще всего что зависит от от изменений погода зонтики там мы дождемся такое курс валют естественно продаже электроники влияет и пока мы его не учитываем это же собираемся к чему-то подключиться пока еще ни к чему не подключились вот но много еще хотим выдумать классных вещей вот таких вот из жизни просто из жизни чтобы еще мы могли взять и чтобы мы могли еще па-па-па использовать на razon с активно делает рекламу на внешне каких-то площадках там иногда это телевизор иногда это какие-то бигборды возможно как-то использовать эту информацию тоже но и самое для нас интересная это прогноз новинок когда у тебя вообще нет никакой истории как предстоит спина что он будет так продаваться я пока не знаю как предсказать новую книжку кого нет словно у дэна брауна когда она выходит и ее раскупают одну книжку раскупается другую нет как понять что эту будет раскупать это не будут пока мы не таких вещей еще не придумали и вот как раз этим активно занимаемся на этом у меня на самом деле все у меня вот есть такой слайд и я готов от этот вопрос можно да там 1 ну ладно ладно хорошо куда смотреть давайте с меня до красиво всего за доклад вопрос по оценке вот вы говорили что использовали моя но при этом после этого говорили о том что моя не очень хорошо в том смысле что у нас есть очень много товаров я так понимаю наверное там большинство товаров продаются очень мало там один или там еще кое какая то же самое за какой промежуток времени ну да вот и соответственно и не знаю почему это не нормировать например на там усредненные продажи за прошлое время плюс один там чтобы нуле избегайте на ноль не делить вот почему так не делай не знаю почему так не делать это возможно хорошая идея ну ладно мы думали о процентных ошибках но понимали что нам нужно что то придумать не придумали хорошего решения для нулей прибавлять к нему и 05 но мне нравилось по разным причинам единицу прибавляет нам не нравилось к знаменателю почему-то у нас не срослось с процентами а вот эта идея о том чтобы делить на пятна на средние продажи этого товара на самом деле мы просто об этом не думаю но в целом идея классная ну так лапе разрядка стаж идея хорошие да се бо здрасте я тут да я хотел спросить а как вы сравнивали вот когда вы модель сделали и что называется в пруд и и покатили кому это дело сравнивали с кошельками steam что люди делают вы параллельно считали в excel как и в модели и сравнивали конечно 1 1 месяц у нас работало два прогноза наш новый который мы разработали и старый который он там на самом деле не совсем в excel как какие-то дома он был очень примитивный да мы просто сидели и сравним мы накапливали мы накапливали месяц статистику чтобы потом посчитать по ней метрики как вы изменение какие-то в своем прогнозе вы их тоже пускаете так параллельные сравниваете на самом деле у нас за всё то время непродолжительное которую мы разрабатываем было это сейчас всего 2 версия прогнозу поэтому у нас пока что не стоит задача выкатывать какие-то изменения и делать это там с какой-то частотой у нас есть возможность включить его просто параллельно чтобы он писал концу и результатов какую базу подождать две недельки накопить информацию а потом просто сравнить не переключайтесь переключаться после того как ты уже убедился что он работает хорошо вот так на трассе спасибо за доклад возможно глупый вопрос я просто не очень понял как работает предсказание правильно понимаю что вы предсказываете у одной из 13 категорий товаров например каковы будут продажи санок любых видов либо каковы будут продажи платьев любых видов мы предсказуем конкретные санки и конкретное платье для конкретной модели там мы обучили модель для всех санок а предсказывать мужчине для каждой конкретных санок каким образом потом корректируют это же решение все равно принимается вручную конкретным менеджером смотрят на предсказание и дальше принимать решение как бы поверить ему либо добавить скок стрельбу сколько не убавить это не так это решение уже принято нашей математикой в этом ее фокус в том чтобы менеджеры они заказывают ровно столько сколько предсказывать во всяком случае так об этом говорят да новинки которые люди понимают что это будет что-то взрывной естественно мы не беремся мы пока не умеем этого мы пока не говорим о том что мы это умеем их естественно книгу дэна брауна и iphone и в первый момент и какие-то модные штуки о которых мы словом моды пока не формализовали не как мы естественно не лезем в эту сферу и один коротенький вопрос какой фреймворк используете для нейронных сетей мы нейронной сети не используем в единении раны нет этот light б.м. это кредитный банк мы пробовали недавно сеть но ничего хорошего нас не получилось а нам нужно было быстро и вот поэтому можно даже не пробовать потому что был очень не проложили вот еще я так так по поводу метрики ну вот значит выбрали мои да вот очень классно что рассказали что на берегу там определиться вот это а потом наверное все таки бизнес интересует ну даже когда определись на берегу все хорошо по этой схеме поработали вывели в продакшен наверное все таки людей интересуют какие-то уже там к более такие приземленные вещи как померить все в деньгах насколько стало лучше после того как мы запустили вот эту классную штуку вот вы наверное это делали да то есть вот так такой такие вопросы всегда возникают да то есть ну то есть из каких соображений определили то формальную модель дмитрий му а потом уже в реальной жизни надо как это проверить поскольку вообще это все в целом работает вообще да мы движемся в правильном направлении насколько прибыль там улучшается и дело в том что этот прогноз разрабатывался первую очередь он тоже не скажу по одна из причин по которым мы взялись принять тут машина была в том что озон хотел перейти от закупок на фиксированную глубину там на 20 дней на 30 дней перейти к цикличным поставкам то есть когда вы поставщика есть расписание нам нужно заказывать от одной поставкой до другой соответственно и не хранить никаких остатков на складе дополнительных никак не страховаться то есть закупать ровно столько сколько у тебя купят за как короткий промежуток времени и наш прогноз разрабатывается специально того чтобы была возможность перейти на такую парадигму закупок и соответственно нам на первом этапе было очень сложно отделить о какой же в деньгах вклад от перехода на новую парадигму закупок которая произошла одномоментно с выпуском нашего прогноза какую часть от этого внесла это новая парадигма а какую наш улучшенный уточненный прогноз но мы провели тест мы взяли старый прогноз и попробовали его применить в новой парадигме спрогнозировать на эти же короткие промежутки времени и в данный момент сказать сказать о том что как бы правильно выразиться безусловно качественно новую прогнозы она лучше проблема в том что довольно сложно эту эту цифру померить мы сейчас этим занимаемся но мы не можем дать никакого яме не позволяет совесть сказать он что да мы померили получилось лучше потому что мы в мире им сейчас вот так мы миримся с и это на самом деле не просто померьте потому что жизнь вносит огромное количество изменений каждую секунду каждую секунду у нас меняется парадигма то мы подписываем новые контракты с поставщиками по которым вот такие-то таки это у нас ними договоренности а этих договоренности не было в прошлом соответственно поставщики например начали возить как-то более точно раньше они возили менее точное соответствие сравнивать к такие же промежутки времени в прошлом и в настоящем довольно сложно вот виду тоже очень сильно меняется окружающая среда мы работаем над тем чтобы показать эту разницу в деньгах мы работаем над этим вот так то есть ответить не в данный момент ничего не это хороший ответ мыши по поводу еще вот это библиотека как густо вы не пытались использовать самом начале не пытались и получилось плохо плохо да возможно потому что не про не будет по скорости или по точностью по точности скорость нас скорости не было претензий по точность все было не очень хорошо у нас на самом деле категориальный признаком всего один вот насколько мне известно как boost как boost специализируется лишь придется разрабатывался под категориальными ну да не заводил искать играли знак вот остальные 100 69 численные признаки возможно это дело в спецификой конкретно нашей задачи возможно возможно или возможно мы не неплохо вы применяли это тоже по поводу еще один момент у последнее по поводу переобучение модели то есть вы говорите в какие-то модели в какие-то моменты времени по показателям видно что надо переключить на новых данных до что они да да это у вас сейчас ручной решение ручной так сейчас это ручной как они была идея или там может быть по каким то причинам вы не решили решили это не автоматизировать например так также как ночью вы собираете автоматически до настройки прогноз можно живет также сделать казалось бы и автоматическое переобучение модели в какой момент мы этого не сделали потому что сейчас всего лишь 3 версия у нас выходит у нас тот период когда тот момент времени когда мы можем переобучить модели он обусловлен тем когда мы подойдем с новый вид вопрос о том старые модели переобучить и правильно понимать да да ну то есть переобучить но тут просто же самую модель но на новых данных как моментов принять этот момент автоматически запускать мы этого не сделали мы в данный момент успеваем выпустить новую версию раньше чем старая начнет сильно устаревать то есть у нас поскольку как раз в месяц это происходит вот только сейчас мы заметили этот это падение как на том графика который я показывал это было уже сейчас вот 25 октября по моему 20 26 мы только сейчас начали замечать это парту homme и вот прямо сейчас мы катим новую версию поэтому у нас как бы ни разу еще не возникало необходимости старые модели переобучить у нас появляются новые тому давали новые фичи добавили какие-то новые интересные штуки вот у нас не возникает необходимости привычек и в будущем она обязательно возникнет мы же закончим и трясется какой-то момент мы расскажем хватит машину обучение давайте оставим это в покое и будем видно переобучать и вот тогда мы перейдем к этому вопросу на самом деле это фактор молодости этого проекта вот потом еще не нужно было этого делать ни разу вот спасибо большое время вопросов подошло к концу вы можете задать если у вас какие-то остались вопросы в дискуссионной зоне напротив выхода а сейчас александр можете выбрать самый интересный вопрос мне больше всех понравился по-моему самый первый вопрос который был не вопрос вопрос предложения почему вы не сделали так и мне кажется моя беседа попробую сделать так как как молодой человек спросил вот этим мне этот вопрос понравился"
}