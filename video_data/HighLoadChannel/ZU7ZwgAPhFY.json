{
  "video_id": "ZU7ZwgAPhFY",
  "channel": "HighLoadChannel",
  "title": "Сетевая диагностика: новый взгляд сквозь старые щели / Евгений Усков (Qrator Labs)",
  "views": 399,
  "duration": 2169,
  "published": "2017-07-30T00:47:31-07:00",
  "text": "итак друзья но мы не останавливаемся и переходим к следующему докладывал следующий доклад будет про сетевую диагностику вот этот все что надо знать про всякие бюджет и пинги тисе пи дампы лукин глаз и прочее расскажет нам евгению скоб из супер крутой лаборатории куратору labs поприветствуем добрый день мой доклад будет посвящен сетевой диагностики соответственно подводным камням которые могут возникнуть при диагностике и о том как эти подводные камни можно будет обойти значит что же такое сетевой диагностика и зачем она может нам понадобится для ответа на этот вопрос рассмотрим следующую весьма часто возникающую проблему вот значит у пользователя возникло такое окошко соответственно нам нужно выяснить кто же виноват на самом деле конечно причин такой ситуации может быть несколько в первую очередь проблемы могут быть в самом веб-приложение то есть что-то сломалось зависла не отвечает и прочее но допустим что мы в приложении проверили и никаких проблем там не обнаружили в этом случае вполне вероятно что причина лежит в сетевых проблемах таких такие проблемы могут возникать по разным причинам это могут быть например сбои маршрутизаторов перегрузка каналов связи просто высокая загрузка на сетевом оборудовании ну и надо сказать что такие проблемы они проявляются достаточно часто сами по себе проблемы они тоже могут различаться это может быть просто возросшие задержки могут быть потери пакетов они в свою очередь могут проявляться в разрывах типе соединений ну и есть еще другие различные варианты ну и соответственно нам нужно определить в каком же месте собственно возникла проблема и мой доклад он посвящен существующему инструментарию для того чтобы эту проблему диагностировать самое первое чем обычно пользуются при возникновении сетевых проблем это простая всем известная утилита pink она работает по очень простому принципу отправляется пакета семьях request ну или серия таких пакетов и затем регистрируется все приходящие пакеты типа эхо реплей есть обычный ход получив такой пакет он отправляет в ответ red line значит возможны различные ситуации случае сетевой проблема однако обычно ответные пакеты либо не приходят либо приходит с большой задержкой либо приходит не далеко не все что же делать такой ситуации на самом деле если некоторых ос не отвечает на pink то само по себе это не означает что ситуация критическая на самом деле хост может в принципе не отвечать на 7 пакеты вот и действительно такое часто встречается в этом случае имеет смысл попробовать воспользоваться попробовать другие протоколы то есть можно посылать в качестве запросов не только осинки пакеты ну например пакет и tcp syn вот и таким образом ждать ответов тисе пи ask для того чтобы проводить такую диагностику можно например воспользоваться такой утилиты как аж pink она несколько менее известной однако представляет достаточно большие возможности и может генерировать весьма широкий спектр различных пакетов на данном сайте представлены лишь простейшую первично же примеры и использование ну вот например в нашей ситуации может помочь вторая команда вот то есть попробовать отправитесь апельсин для некоторого part on однако допустим что хост нам не отвечает или отвечает не так как мы бы этого хотели что же делать дальше есть на помощь нам приходит вторая широко известная утилита которая реализует трассировка маршрута в unix это соответственно будет утилита прайс раут или ее аналоги это утилита она принципы работы также всем известен вот озвучу его вкратце значит она отправляет серию 7b пакетов с различным времени жизни отель вот есть он отправляет пакеты стр 1 2 3 и так далее соответственно проходя через маршрутизатор маршрутизатор уменьшает значение отель на единицу и если она становится равным нулю то он отправляет обратно пакет что время жизни вышла асимптоты олег сидит мы на нашем источники регистрируем эти пакеты и соответственно сохраняем в 6 затар и от которых который их отправили здесь следует отметить что значит 300 вот может использовать различные протоколы это может быть м.п. или например tcp вот в этом случае утилита называется петрой fraud и не здесь нельзя выделить какой-то самый лучший протокол вот потому что все они могут проблема в том что все они могут фильтроваться вот причем в разных случаев фильтруются разные протоколы вот так что следует попробовать наверное все варианты что может быть лучше чем трассировка маршрута это трассировка в реальном времени для этого можно воспользоваться например утилитой mtr от моей trace road вот она будет генерить пакеты в реальном времени и соответственно мы будем видеть задержки и потери по ну и потеря пакетов на устах нибудь постоянно обновляться на первый взгляд может показаться что 3 ст road это все что нам нужно и что это утилита обладает неоспоримыми преимуществами то есть ну например она сразу же строит весь маршрут прямо до конечного узла показывает задержки показывает места где возникли потери пакетов вот и более того сразу видно проблемный участок однако давайте разберемся так ли это на самом деле для этого мы рассмотрим два простых модельных примера значит предположим первый пример достаточно простой состоит в следующем мы значит сделали трассировку до некоторого узла который находится в крупном операторе спринт и получили вот такой участок маршрутом как вы считаете если здесь проблем и значит с одной стороны сразу же бросается в глаза то что на пятом хобби у нас большие потери пакетов и кажется что здесь что-то не так однако на самом деле здесь всё совершенно в порядке причина такого поведения это де приоритезация трафика на самом деле многие ну маршрутизатор он может быть настроен таким образом что если он получает пакет со временем жизнь равным нулю то он просто дропает его никак не отвечает обратно вот либо он может быть настроен так что он делает этот случай высокой нагрузке вот здесь именно такая ситуация то есть просто 5 хоп он отвечать ни на все пакеты вот и соответственно поскольку на шестом и седьмом копия никаких дропов нету мы скорее всего в этой ситуации на самом деле все нормально теперь давайте посмотрим вот на такой трейси то есть тоже сделали trace до того же узла вот и получили чуть-чуть другую ситуацию вопрос здесь такой где собственно проблемный стык вот на первый взгляд может показаться что ответ совершенно очевидный то есть ну мы видим что до global crossing это 3 4 хоп и все все запросы идут без каких-либо потерь а как только трафик наш приходит спринт то тут же начинаются потери и соответственно проблема должна быть явно где-то на стыке между global проще нгам с принтом вот теперь внимание правильный ответ на самом деле трафик от спринта совершенно необязательно идет тем же путем что и пришел туда например в данной ситуации трафик до спринта идет действительно через global crossing окна показал приз раут а вот обратно он идет через другого крупного оператора level 3 соответственно истра из раута мы можем сделать какие выводы во первых на участке наша сеть global crossing никаких проблем нету поскольку там были нулевые потери а вот на участке наша сеть global crossing спринт level 3 наша сеть проблема есть и таким образом проблема находится где-то здесь большего к сожалению из данного трейси мы сказать не можем значит здесь возникает сразу же вопросы насколько типичная ситуация когда прямой путь не совпадает с обратно и почему вообще так происходит для ответа на этот вопрос значит давайте рассмотрим интернет на уровне операторов связи таком макро уровня вот и значит мы обнаружим что он состоит из автономных систем то есть автономная система это система сетей и мажьте зато raw которые принадлежат одному и управляется одним или несколькими операторами и самое главное имеют единую политику можете зации с интернетом то есть интерн автономная система это представляет с тобой такой автономной как бы кусок интернета который самостоятельно принимает решение о том как ему маршрутизировать трафик с внешним миром и то можете зация она происходит с помощью так называемого протокола bgp значит вкратце это протокол состоит в том что автономные системы они обмениваются информацией о доступности сетей то есть например на этом рисунке автономная система один она соответственно получает информацию о доступности от всех ее соседей то есть систем два три четыре вот получив информацию о доступности она дальше сам об решение о том как ей может визировать трафик значит что же является основным фактором в принятие данного решения ответ очень простой это деньги то есть автономная система on амортизирует трафик таким образом чтобы получать максимальную выгоду а чтобы ей было это либо дешевле вот и значит поскольку у нас экономические отношения обычно не симметричны мы получаем ее пути они также являются часто несимметричными вот на данном слайде приведена сводная небольшая табличка для нескольких крупных операторов мы в ней приведён процент путей которые не являются симметричными и мы видим например что для например автономной системы мтс больше половины путей не являются симметричными то есть ну грубо говоря если мы возьмем произвольный произвольный хвост и и попробуем построить маршрут до него из мтс то обратный путь с вероятностью больше 50 процентов будет несимметричном для более крупных операторов обычно количество несимметричных путей ниже вот в частности вот для тех операторов которые наиболее крупные так называемые тарлан операторы вот он обычно порядка там 25 процентов вот операторы помельче такие в частности автономные системы которые имеют подключения к нескольким императором называемый мульти hound автономные системы для них этот коэффициент обычно достаточно высокий вообще в целом в интернете путь из кореи асимметричный то есть больше половины путей не являются симметричными итак для того чтобы нам произвести успешную диагностику крайне важно уметь определять обратный путь и по крайней мере уметь понимать является ли путь симметричным или нет эта проблема определения обратного пути она к сожалению существенно сложнее чем определение прямого пути вот на данном слайде перечислен существующие инструментарий и мы его сейчас вкратце рассмотрим как ни странно первый в этом списке это уже знакомый нам pink с помощью которого оказывается можно попытаться определить и обратный маршрут значит для этого нам нужно будет воспользоваться опцией минус r которая включает опцию протокола api под названием ripper trout значит эта опция работает следующим образом когда пакет проходит через маршрутизатор маршрутизатор видит что в данном пакете включена эта опция он сохраняет свой адрес специальное поле и пи пакета соответственно так делает каждый маршрутизатор и в результате пакет который вернется обратно он будет содержать как прямой путь так и обратный путь вот то есть например на вот таком простом на такой простой сети если мы попробуем из маршрутизатора один пропинговать можете завтра 4 с данной опцией то мы получим примерно вот такой вот список то есть сначала здесь будет идти прямой путь но в конце будет идти обратный путь данный способ он безусловно выглядит весьма привлекательно он весьма прост и казалось бы мы можем узнать таким способом путь до любого has the city в интернете однако к сожалению здесь есть один нюанс дело в том что протокол api проектировался в те времена когда мнение о том какой будет интернет существенно отличалось от того что мы имеем сейчас вот и в частности это повлияло на некоторые особенности этого протокола в контексте опция court road это проявилось так что поле в которой сохраняются адреса маршрутизаторов она может вместить всего лишь 9 узлов вот это безусловно очень мало поскольку эти 9 узлов отводится как на прямой так и на обратный маршрут причем обратный маршрут располагается в конце вот и ну типичное количество копов притом трассировки она обычно ну как минимум 8 копов вот а в среднем обычно 15-20 вот таким образом с помощью данного средства мы обычно можем получить только лишь малую часть прямого маршрута не говоря уже об обратном ну и кроме того здесь следует отметить что данные зачастую далеко не идеальными являются потому что далеко не всегда можете затар ведет себя так как описано в стандарте вот и нам встречалось много случаев когда например они эту опцию просто игнорируют результате получается такой разорванный часто к сети маршрутом таким образом на этот подход особо рассчитывать не стоит вот и давайте рассмотрим значит то что действительно может привести к положительному результату это так называемый лукин глаз looking нас это сервисы которые есть у многих операторов связи и они их названия она связана с тем что они как бы позволяют взглянуть на мир интернета глазами некоторого другого хоста или маршрутизатора на самом деле конечно не у всех к сожалению операторов есть такие сервисы и если looking glass а нет то оператор он выглядит чем-то похожим на черный ящик looking glass они им позволяют делать обычный стандартный набор запросов позволяют запускать пинге до произвольных узлов делать трассировка маршрута и также они позволяют показывать маршруты которые получается по протоколу бюджет им в качестве примера использования такого сервиса давайте рассмотрим следующую задачу необходимо выяснить как из мегафона трафик пойдет до главного сайта энгл значит ну что нам нужно сделать нам нужно зайти на собственный лукин глаз мегафона и там либо сделать трассировку до адреса и мглу либо посмотреть в джипе маршруты посмотреть на пути которые в этих маршрутах имеется и они в большинстве случаев будут эквиваленты результатом трассировки давайте вас значит раз воспользуемся вторым способом то есть мы выбираем тамби джи пи им значит вводим сеть и получаем примерно вот такую выдачу но на самом деле оно будет немножко больше ту часть пропущены поскольку нам здесь интерес представляет строчки который называется и спад то есть вот непосредственно тот путь в терминах автономных систем который был получен значит данным оператором то есть мегафоном и данный путь он то есть автономные системы в этом пути они расположены в том же порядке по которому будет следовать трафик вот соответственно здесь мы видим что из мегафона трафик сначала идет в автономную систему 3 267 это ранит и затем приходит уже в 2848 этой мгу основной недостаток приведенного только что подхода заключается в недостаточной полноте то есть такие сервисы они есть у операторов вот это не во всех но обычно их нету например конечных автономных систем то есть если мы захотим например посмотреть как трафик пойдет из яндекса донорством и этого сделать к сожалению таким способом не сможем здесь можно попробовать в этой ситуации воспользоваться другим инструментом под названием райп атлас айпад вас представляет собой огромную относительно огромную коллекцию точек мониторинга принцип работы с данным сервисом очень простой чтобы получить к нему доступ нужно взять и установить свою точку мониторинга то есть поставить ее где-то в своей сети в таком случае мы получаем доступ сразу ко всем точкам и можем с их помощью делать стандартные запросы такие как pink trace раут и несколько других основным преимуществом райп атласа является относительно хорошее покрытие всему миру установлена на данный момент более восьми тысяч точек мониторинга и это количество достаточно быстро растет значит покрытие включает в себя почти 3000 автономных систем это уже практически ну чуть менее десяти процентов от общего числа то есть всего сейчас автономных систем около 48000 значит ну и покрытие включает в себя 172 страны ну еще в принципе можно это назвать преимуществом относительная простота установки то есть для получения доступа просто достаточно взять эту точку и поставить где-то свои steam ну и так же плюсы можно отметить наличие достаточно неплохого api из недостатков это значит во первых ограниченный все-таки набор запросов которые можно осуществлять и самое главное то что мы не можем осуществлять бесконечное количество запросов поскольку эти запросы они тратят на так называемый кризис то есть придеться они выдаются за то что у нас установлена . даст . мониторинга вот какое-то количество в сутки вот и соответственно вот в сутки нам дали сколько кредитов мы их можем потратить но больше запросам и сделать не сможем то есть не стоит рассчитывать на то что мы поставим эту точку и тут же сможем со всех имеющихся точек прям вот сделать трассировку райп атлас на самом деле является достаточно мощным инструментом например с его помощью точно так же просто решить задачу которые мы только что рассматривали для looking glass а то есть определение пути от мегафона да и мгу поскольку значит есть несколько точек мониторинга в самой мегафоне вот мы просто выбираем эти точки и запускаем трассировку до интересующего нас х стан соответственно получаем аналогичные результаты райп атлас он позволяет делать принципе более интересной вещи он неоднократно встречался в исследованиях например в исследованиях связанности интернета вот такой интересный достаточно пример это как с помощью райп атласа было можно визуализировать относительно недавний инцидент с крупным интернетах с чем джим am секс расположенным в амстердаме то есть вот на представленной картинке видно значит что происходило здесь по горизонтали откладывается время по вертикали это различные точки мониторинга он соответственно красным отмечены потери пакетов вот и видно что ну пусть вот здесь выделена группа точек которые делали трассировку до некоторого узла в амстердаме и видно что вот в определенный период времени действительно наблюдались серьезные проблемы то есть практически полное отсутствие доступности дальше также кратко рассмотрим еще два инструмента они аналогичные в чем-то похоже на рай патлы вот но все-таки в некотором смысле другие то есть right atlas это достаточно большой набор простых точек мониторинга то есть таких маленьких устройств которые способны делать только достаточно простые вещи рассмотрим теперь так называемый сервис en el ног ринг его отличие состоит в том что это уже не настолько большой набор но зато полноценных серверов то есть правила входа здесь на самом деле аналогичные то есть для того чтобы пользоваться всеми серверами входящими в это кольцо необходимо поставить свой сервер после того как мы это сделаем и получаем по сути полноценный доступ на эти сервера и можем делать более менее все что угодно ну в частности можно делать и трассировку вот но можно делать более сложные вещи из преимуществ можно выделить ну то есть просто то что мы можем сделать все что угодно почти произвольные запросы вот кроме того в качестве бонуса этот сервис представляет бесплатный лукин глаз такой групповой который может обращаться сразу к нескольким сразу ко многим своим серверами то есть мы сразу получаем много путей из недостатков ну собственно большая сложность входа то есть необходимо устанавливать собственный узел и все-таки не слишком хорошее покрытие то есть такое кольцо оно конечно существенно меньше чем рай поют глаз вот она включает в себя всего порядка 350 узлов вот и покрывает всего около 300 автономных систем и есть еще одна очень похожая система анально krank так называемый планет лап вот значит на слайде представлена карта на которой отмечены и имеющиеся точки но тоже server on она действительно очень похожи на 0 и 0 на print точно также набор сервис серверов вот однако основное отличие состоит в том что здесь есть платный доступ то есть не обязательно устанавливать свой сервер можно просто купить подписку и в таком случае мы получаем доступ ко всем серверам вот в остальном в целом особо отличие нету то есть покрытие примерно схожие чуть больше узлов но количество автономных систем примерно такой же и так значит рассмотрены средства диагностики они обладают они владеют основным недостатком вот каким у них недостаточно я полнота то есть если нам нужно построить путь от некоторой точке которые входят в покрытии этого сервиса то тогда никаких проблем нету просто делаем нам либо трассировку либо что-то аналогичное и получаем сразу же путь однако если же наш узел в покрытии не входит то в таком случае сделать что-то уже существенно сложнее вот ну и кроме того конечно недостатком является достаточно большая сложность установки то есть в случае райп атласа еще куда ни шло в случае плане club in allnock ринга нужно ставить свой сервис так как же нам быть если все таки у нас сложилась такая ситуация что наша автономная система в покрытии не входит небольшой шаг в светлое будущее попыталась сделать наша команда в рамках проектора куратор радар был разработан сервис который мы назвали reverse лукин глаз задача этого сервиса она состоит ровно в том чтобы определить как пойдет трафик от заданной автономной системы до нашей ну и кроме того она также умеет определять альтернативные пути то есть пути которые могли бы получиться если бы вот автономная система которая нас интересует она бы приняла другой бюджет и решением значит пользоваться данным средством достаточно просто при условии что у вас есть своя автономная система в этом случае нужно просто значит бить интересующую вас систему соответствующее поле нажать кнопку и мы получим примерно вот такую картину здесь представлен пример для автономность пример определения пути от автономной системы 833 1 до нашей автономная система из куратор и результат выглядят вот таким образом то есть график пойдет через автономная система 9002 это известный крупный оператор ритм на данном графике здесь представлена расхождение то есть вот стрелочки они показывают расхождение бюджет и анонсов соответственно трафик будет идти в обратную сторону то есть от 8 331 к 9002 и затем уже к нам ну и кроме того выводятся альтернативные пути то есть если бы автономная система 833 один выбрала бы не кратчайший путь она бы могла воспользоваться вот еще двумя вот такими маршрутами рассмотрим еще такой чуть более сложный пример определение того какие же будут пути от teliasonera да с куратор teliasonera это автономная система 1299 в этом случае мы получаем что путь уже не один их достаточно много вот но эта ситуация нормальная и она объясняет следующим образом в том что 1299 это весьма крупный идеографический распределенный оператор и он просто как бы распадается на части то есть те узлы которые находятся в одном регионе они выбирают один путь а узлы в других регионах могут запросто использовать другой путь в этом случае они все будут показаны на графе вот таким образом ну и значит точно также выводится что вот есть еще один альтернативный путь но и список активных путей итак данное средство она позволяет определить обратный путь от произвольные автономные системы и кроме того показывает альтернативные пути что же нужно чтобы начать пользоваться основное ограничение оно состоит в том что у вас должна быть своя автономная система то есть она автономная система обычно есть у крупных компаний ну и конечно же есть у операторов связи нужно подтвердить доступ к этой автономной системе для этого это делается прямо у нас на сайте то есть нужно запросить доступ в этом случае будет отправлено письмо на технические контакт этой автономной системы вот и в письме будет соответственно две ссылки подтвердить или отказать если там нажать подтвердить то первый этап пройден второе что нужно сделать это установить виджеты сессию с нашей автономной системой это в принципе делается достаточно просто однако она является совершенно необходимым то есть это не просто вот мы хотим собирать автономной системы это действительно нужно для того чтобы данное средство работала потому что без этого мы просто не сможем увидеть всех путей всех связей конечной автономной системы в частности пиринговых отношений ну в принципе на этом у меня все спасибо за внимание буду рад ответить если стид вопросам да в основе данной модели лежит в основе данного сервиса лежит математическая модель отношений между автономными системами то есть мы используем данные из ряда источников и затем анализируем их называем их с целью определения именно логических отношений между автономными системами то есть под логическими я понимаю в отношении типа к старту провайдер например когда одна автономная система покупает а другой услугу либо пиринговые отношении то есть бесплатный обмен трафика ну в частности то есть не только источников достаточно много нор от туда входит скажите просто а какое количество автономных систем открывает ваш инструмент сейчас можно обратиться абсолютно к любой автономной системе то есть то есть если вы его сделаете вот эти действия то сможете построить будь долю в от любой of the mono системы ну безусловно делается нять данные мы собираем в реальном времени и анализируем их тоже достаточно часто то есть как бы делаем такой предварительный анализ вот то есть обновляются весьма часто там раз в пару часов например в рэпе же есть альтернативные источники здесь получается что вы просто усекаете как бы количество этих источников или что в рай помог то есть используя открытые данные мы к сожалению не можем видеть всех виджеты путей то есть райтон как устроен там есть некоторые ограниченное количество точек сбора вот которые значит но имеет бюджет и сессии вот которые собирают данные и выкладывают их в открытый доступ вот то есть мы видим собирая данные с райпо мы видим интернет как бы только от лица райпо да то есть вот только под их углом этого к сожалению вот только этого совершенно недостаточно для того чтобы определить полноценно уметь определять обратный маршрут то есть здесь именно нужно для того чтобы уметь это сделать нужно именно построить как бы модель логических отношений то есть определить какие решения принимает каждой автономная система вот как именно она выбирает куда отправлять трафик как еще раз просите не слыша это расстройство предпосылка что вы угадали но как как какие они на самом деле есть ну что ниже на как вы же не иметь доступа к коммерческими наши да безусловно то есть ну не то чтобы угадали то есть мы проводим анализ и соответственно делаем некоторые предположения безусловно мы в каких случаях можем ошибаться вот но как бы мы будем работать над тем что процент ошибок был небольшим уже сейчас он составляет не более 20 процентов вот при том что сейчас как у нас бета-версию еще пока но мы будем работать дальнейшем улучшением а еще такой вопрос а у вас есть возможность посмотреть историю изменений так как ситуация изменилась там за последние там сколько это дней недели и месяцев но вот конкретно для маршрутов в reverse кукин glossy я пока такой возможности не было то есть мне пока у нас можно посмотреть только маршрут который в данный момент имеет место для меня александра тоже герой pearl abs time machine задачи понятны и в принципе в pipeline стоит думаю что в течение года сделаем все закончились вопрос спасибо большое"
}