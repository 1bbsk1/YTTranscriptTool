{
  "video_id": "oM6nLUVWlQ8",
  "channel": "HighLoadChannel",
  "title": "Puppet под нагрузкой / Антон Турецкий (Badoo)",
  "views": 169,
  "duration": 2140,
  "published": "2017-04-22T14:45:50-07:00",
  "text": "антон турецкий системный инженер компании баду с докладом со смешным названием popped купит или пакет один из двух докладов конференции про конкретные инструменты антон раскройте пожалуйста тему про пакет сказали инструмент программных пакетов девушек при настройке пластилин ноты в нашем случае называть инженерами по заранее известному сценарию и все предлагают и понимаете еще не нужно вот выбор party ты был обусловлен тем школам когда рассматривали эти впадают остальные системы оказался самым простым точки зрения порога хождений поэтому собственно вкратце моем выходе речь пойдёт о том что такое богат как он вообще работает несколько слайдов будет дальше расскажу немножко о том как увеличить отдачу от кластер обаме мастеров к которым скопировать как пока прийти как восстанавливается случае чего далее вкратце ему такую эличка как асинхронным записей а вы словно вас удалось потому что вы необходимо вкратце расскажу о том как собиратель пуль то зачем они нам нужны и как их потом читать и немножко расскажу о пытались о проделанной работе и как мы анализируем зачем это вообще смотрим вот сначала я хочу сказать о том что память у нас числитель на под нагрузкой и так как мы работаем по dota с яблоком очень сильный мега для примера нашим ресурсы на данный момент времени запись дерево на более чем 160 миллионов пользователей в составе нашей команды всего лишь шесть системных администраторов при условии того что два из них в принципе детей то есть они считаются мать дальше теперь пересчет на цифры у нас получается что 7 миллионов активных пользователей в месяц на одного вина в составе наших мастеров более пуск 2000 здоров если опять же все это дело поделить то получается цифра к приблизительно здесь 130 машин на 1 администратор вот всем этим управлять достаточно сложна и без системы управления а я пока ты это голубей а скорее всего невозможно начнем с таких основ и я попытаюсь вкратце рассказывать о том вообще как устроен бобика работать там происходит взаимодействие между при этом сером то есть изначально архитектура багета предполагает что эта работа в режиме один сервер соответственно на начальном этапе у нас есть но то есть побед мастер как вообще мастер узнает о том что такое но так как они много где она живет к кольца что нужно сделать для этого инициатором соединения является посредством формат но эти есть такая уделит как называется но фактор отливка модульный мой код можно написать на роге соответственно отдачу с этого модулей является строка параметрам то есть любая часть информация в системе быть to the million times темного реминисценций операционной системе либо там ролью каком-либо власти собираются в эти факте ки получается нити набором данных эти данные собираются и обычно с запросом можем пробному соединим это ссылается на мастер я думаю что многие покупают побед использовал и знаете что формата таким данных которые за ссылается является данном формате формате yaml который большой кусков теле по запросу сено нa poль дальше сервер понимаешь что к нему пришёл некий набор входить в входных данных он ноды но также на его стороне присутствует некая конфигурации называемый естественно и которые заранее предопределено всегда понимает что вот приехали к нам факты вот она есть какие-то жесты и на основании этих данных он соответственно компилировать уже этот названием каталог эту тему условия эти параметры которые поедет на нашу много полет конфигурации соответствует каталог обратно цветом ленту засылает мостом потом остается 2 этапом в частности это с отсылкой и порта или отсчет осмотр обратно на покорности в котором мы можем увидеть то как прошло то как прошла нашло наложение конфигурации на одним естественно совсем увидеть если были какие-то ошибки что-то поправить или просто получить информацию места потому что все прошло хорошо и за такое-то время конфигурация была применена после чего репорты в принципе неплохо собирать потому что есть необходимость знать о том что происходило на новых катиф войдите на что заменялись почему они сменялись почему это восстановлен и так далее то есть нам необходимо нее timeline с тем чтобы можно всегда обратиться некое хранилище и посмотреть что общего исходила ответов сервера в качестве либор коллектора память предлагает нам ли бюро то свои встроенного усилителя либо соответственно и ним и предлагают использовать некий сторонний инструмент будь то там сама дисней какая-то штука виде нужно поискать что-то предыстории принципе получается но схема такая покроет скачали войдет мастер скачали прокат клиента получили некую абстрактную схему супесь ливров виде клиентов одной машины от мастера запустили делаем написаны на rue de oz все хорошо работает она слушается дефолтный ford 8140 сне клиента обращаемся сертификаты подписывается все прекрасно все хорошо соответственно делаем вывод о том что система суставе быть начинаем прядь параллельно с тем что мы увеличиваем объем наших интересов мы начинаем увеличивать наших мастера который мантис - с помощью пока мы добавляем их еще и чтобы чем они известны потом мы гуляем на счетчик но еще чуть-чуть кода в итоге получаем что-то из серии там более 30 тысяч строк виде манифестов более тысячи роли клиентов и сталкиваемся с первой проблемой когда побед мастер перестает у нас отвечает перестает у нас отвечать по ряду причин первая причина это то что базовой поставки по 5 мастер представляет из себя единичные дело которые не кажутся непонятными к физическим не было ни я был вот соответственно первое сверну сталкиваемся с необходимостью увеличивать количество процессов непосредственно вадим напали на нашем сервере решение в принципе несколько есть уже готовых обратных сам fight club предлагает нам использованием либо опасливо джинсы рассмотрим бесинджер одном и по чуть чуть дальше не пошли другим путем скажем так как нам нравится что-то новое не совсем наличные вот мы и решили использовать такую телефон называется наверняка на графике видно что и никому позволяет вам запускать непосредственно под собой в качестве вакантной несколько копий побед мастеров настраивается он очень просто поэтому фиде ездить приводить не стал таком удалении почему в принципе него ну во первых потому что интересно все новое и то получим то они обычно затем мы сталкивались ни работа это утилита заключается в том что он сильно русским и происходит на уровне ядра linux все процессы не зависят друг от друга и соответственно могут работать своем окружении то ли сущее обновление или какого-то падения одной из копий процесса мы не теряем все остальные моды сцену наш опрос продолжает работать это касается и изменений в обновления этого демона то есть все стали конец и продолжайте сети два момента это никто со стороны ноги вот и 11 из очень больших плюсов которые мы постоянно пользуемся это то что демоны не коп на может слушать на нескольких сетевых интерфейсов он там и наивным sony тоже нашем случае достаточно полезным как только мы внедрили него веселье по простоте у него был довольно такой нелегкий синтаксис аниме запуска это только тот мастер большого кластер здесь на помощь нам пришла еще одна замечательная утилита программистов на орбиту что им отдельное спасибо называется его вот вот собственно занимается она тем что управляет непосредственно вам процесс у него таких вот кластеров побед да и процесс здесь на слайде я попытался показать о том что у нас есть несколько окружении встречу по сути дела смысл от этого меняется у нас окружении production с такою же не песни и есть отдельно стоящая которая называется партий попить сей нужен для того чтобы которых устраивать кровные соединения между клиентами и вторых соответственно управляйте продлением сертификатов по описаниям сертификатов и собственно говоря обслуживать это кто-то со савельев который должен быть между модой и серым и так дает гарантии о том что во первых никакой отдельно стоящие сервер не получит не нужно ему конфигурацию а во-вторых мы всегда гарантируем что на средства что осело едет а конфигурация которая на него уехать должна то есть он всегда выполнить проверку на наличие валютных сертификатов мастеру говорим сертификация это что его сертификат лежащий локально на 29 соответствует плюсы году заключаются года заключается в том что вам за состоянием процессов может сидеть то есть если например у нас кластер продаж упал сатана без вмешательства системного инженера он поднимет этот процесс по новой либо сообщит нам или по ошибке это не отменяет моментально дори систему мониторинга но это является достаточно хорошим людьми огромный плюс еще заключается в том что мы можем на одной машине физической использовать несколько погружений запускать их там на разных картах совершенно спокойно и кармане это упорство статус старт запускать на мое окружение и перезапускать если у нас есть новый дизайн стал видно или необходимо перечитать и не целиком и полностью в настройки просто до низу вы поговорили о том что просто перенести мастеров который стрижет подальше и прочее вот вы не поговорили о том как например физически машинам одни вечным то есть если у нас нагрузка выросла там до 4000 слов то при всем нашем желании и оптимально написание манифестов мы не сможем справиться с такой нагрузкой нам придется каким-то образом горизонтальными масштабироваться увеличивать отдачу от пластины пакетов и при этом продолжать вынудит нашей машинке талона эталоном конфигураций вот так как само начальство доклада я сказал о том что обращение к этот мастер обычный нож или то когда встала задача о том что нужно каким-то образом балансировать нагрузку на мастера торговое решение как широко использоваться пришла поэтому мы взяли обычно совершенно инкубации который использовать их не совсем возле потерь добавили к ним каких там стримов приземление вас с этим словом сняли на томского полицией и скажем так немножко размазали входящий трафик по нашим интерес к окружению вот твари того как это был такой интересный момент по поводу того что репорты на третьем шаге приходит обратно пакет мастер если у нас есть какая-то информация то собственно говоря почему бы нам не запоминать где-то день и хранить потому как мы данную информацию всегда сможем использовать где-то в дальнейшем для такого динамического изменения нашей конфигурации то есть если мы изменили какую-то гасим хотите кого не только исходя из этих данных что пакетик уже стал новым вам нужно добавить еще каких-то правил здесь схема немножко усложняется и добавляется такой функционал как сохранение конфигов и точнее не совсем конфигов сохранения информации о последними выполнение процессов опять клиент на конкретном учений вот стаканчик это такой функционал который тоже идет на сам хотеть побед он полностью это необходимо для того чтобы сверять поставив последняя последняя обработку конфигурации на клиенте с тем что есть фактор который то есть контакт когда блюдо обращается второй раз уже не первый то нашу базу на склонением конфигов она знает о том какие изменения были сделаны в предыдущий раз ну и соответственно на основании этих данных мы можем делать нити div часто выдать им что и сейчас во первых это нам дает если необходимо увеличить ускорить время компиляции побед мастер потому что какие-то вещи мы можем кэшировать тренироваться еще разве конкретным мы снижаем нагрузку на семью в нашем селе и плюс ко всему для сторонних учинить если что-то нужно для кода или человечьего 30 база мы можем за мной выдернуть указывать на ставки с 2 конфиг предполагает хранению данных москве войти вот это совсем то что нам нужно создать так как в компании широко используется то выбросов не стоял то есть хранение данных решили штурмовать мы решили сделать минутам но как только мы начинаем использовать в москве и такое количество клиентов траун единицу времени берем и день 7 минут и у нас получается что количество обращений на прыгать мастер порядка установка рождает минуты хвалит в конфигурации 200 not течение 2 минут каждая нота обрабатывается наряд какому 20-30 секунд мы получаем в случае необходимости зависла и всего этого базу мы получаем достаточно большую очередь на запись вот собственно говоря это очередная проблема с которыми столкнулись это помянуть во внедрении и эксплуатации вот мы понимаем о том что так собственно дальше жить нельзя у нас растет очередь слышатся на знаешь видно что то есть с этим что то нужно делать каким-то образом это нужно да можно поднять еще дополнительный мостят часть сайта удачно вписать сюда пришли решение о том что есть такая замечательная картина на уровне my face fucking вот замечательная на по причине того что из классовых доставки в принципе все роботы будет возможно что не стать их архиву кому-то больше понравится на это место поставить там приоритете разница со слугами никакой разнести эти гонки у нас спас от того что после того как клиент присылал где бы своей форме данными для судоходства умных отправлял напрямую в москве или отправлялась нибудь роботам позвони мне про очень из которой потом дополнительно процесса по петлю мог десятка например пачку разбирать и поводом одной ноги создавать какие-то данные и асинхронный потихонечку запихивать их майский за момент эксплуатации этих ладно интересные вещи начали когда мы поставили столкнулись с проблемами того что стояли у нас первый разрешенное количество соединений на то есть эти муки играл сообщение защита в том случае если том что на сервер соответственно его туда ночью мы столкнулись с тем что данные очереди у нас раскатывали каких-то неимоверных размеров то есть наконец как это займет порядка 350 и правой больше мы убирались то что у нас не хватало места локальным стороны это если вы делаете не как решение оказалось просто отключить лесистом и в итоге мы получили разборных and tweety получи накачивать прирост выполнения времени обработки как являются на стороне клиента дальше интересный момент того что собственно все мы это настраивали настраивал и смотрели смотрели на машину на столь богата что-то но это и куда там смотрели звали мы не видим того как они у нас скоро обрабатываются как только регулируется вот в принципе чтобы быть всегда в курсе событий нам необходимо каким-то образом и теоретические данные по выполнению собирать коллекцию на них соответственно желательно смотреть в случае каких-то fa cup of что молодильные получают какие-то близкие там сообщения иди смысл или там красные лампочки системы аудитории в базу вы хотите пойдут предлагает нам вот эти вот блины репортов первые леди морт это http запросы в данном случае просто отправляется там по выполнении некий заранее обозначены сектор в теле которого опять же присутствует дам данных которые необходимо каким-то образом 1 гласит разобрать и куда-то сложить что заставляет за нами нем необходимость написать что-то для того чтобы это разбиралась как-то собиралась дальше есть формат логов так mail так называемый это достаточно удобный формат ему удобно отслеживать пример ошибки о котлетку стороны но когда х ставка выше 2000 и периодически тебя присылают сообщение там систем мониторинга email а еще приходится ошибка том что там у нее средствами ты неправильно у нас на какой-то там хоть и настоящему шлем который только и стекло я приехала при понятным причинам они что-то не так не считаете это как сортировать очень такой вариант на базе нашел вот есть еще формат блога обычного прикол про пишутся слова на локальной машине на брутально мешает завернуться слова не обязан поризованных родились и и и уже обрабатывать ошибки потом или думаете и тру на этом сильные вот этот пейзаж и удобное решение но мы его тоже использовать потому что было бы не знал нанесите логии централизовано что-то фильтровать и прочее есть такой замечательный ведь отсчетов называется разыгран в принципе он прекрасно тем что визуально наглядно мы можем сразу увидеть наблюдать что у нас там где как быстро происходит выполняются упрощен вот но минус этого типа отчетов заключается в том что какой-то общий индекс на страничке по всем машинам мы не получаем то есть кран для град формирует локальным директор господь директории где каждый мне уже будет лежать на некий индекс то есть как ты бегать крепость какой-то теме страничку самим не очень хотелось в рамках будет надежда на то что этого не должно быть столь config.sys . они часто заключается в том что дам выполнение за собакой танец ему локальной машине и к файловой системе по заветам узату мадины кто не в конфиге для того чтобы обрабатывать чё-то такого рода это необходимо каким-то образом собирать эти данные непосредственность машины которые так складывать и вот что-то с ним потом делать вот соответственно при нашей конфигурации при таком огромном количестве серверов все вот это вот нам показался название блюда попарил нечитаемым не поэтому мы не стали использовать и в качестве нашего выбора для хранения визуализации просмотра отчетов мы выбрали такую утилитами названием форме потому что но никто не сидят если работать с пакетом это людей вообще составе пакета есть еще такая штучка как парень дашборд вот но на момент когда мы сегодня либо питает молодец и понимать что-то там наш город был достаточно углублений кроме как там арчик пошто полосочек выше уже было не увидеть поэтому он зовет двусторонний продукт потому что он дорабатываем изменяем в поле боя пользуемся им сейчас мы это решение на ледяной которое стало стабильно соседом и в общем это тигра тебя не показывает состояние войск нужно который был сделан живой наши системы ведь презентации дальний graphics круговая диаграмма показывает нам общее состояние машины нам на гнев наших площадках на текущий момент зеленый часть его говорит нам о том что вот столько-то вершине данном случае 1680 у нас в состоянии то есть они за последние полчаса все приходили он естественно получали каталоге готовые к себя загружали проверяли всё что есть на данный момент времени делали будет о том что их конфигурация и долго конфигурацию ничем не различаются они говорили о том что никаких изменений они носили не сделали но при этом они живы и отправляют информацию обратно на мастер сегмент вот диаграмма темно-синего цвета говорить о том что 40 машин за последние 30 минут пришли на сервер взялись пульт конфигурации приняли какие-то изменениями своей стороне этом графике мы не можем видеть какие именно изменение не сделали но обычно если у нас происходит изменение каких-то конфигурация мы заранее знаем что вот если у нас синий часть становится больше то в общем то это хорошо и так надо знать что-то работает вот здесь плохо видно еще кусок светло синего цвета светло синим цветом обозначены те машины которые за последние полчаса или больше не приходили за конфигурация обычно это происходит если какую-то часть кластеры например демонтировали и но из нашего в этот мастер их еще не выключили и он соответственно надежде ждет их и говорит админ потому что с этим машинами в том числе что-то не так и желательно посмотреть диаграмме со столбиками там плохо видна цифра не утихла вместе выделил цифру 200 это вот такое получается что в нашем случае на это пороговое значение сколько машинок обращаются с горизонтальным деление потом в течении трех минут каждый разница между мягким получается глядя на столбцов и и диаграмму мы можем делать выводы о том насколько далеко мы можем еще масштабироваться в пределах одного сервера то есть мы заранее знаем сколько клиентов вот за этот период времени наш сервер выдержит и соответственно когда сюда мы можем принимать решение того чтобы давайте только еще одна машина и произнесем нагрузку счет убирает вот но эта информация достаточно вообще нам иногда интересно смотреть что же все-таки происходит с отдельно взятый машиной какие-то этом-то и марину и что она не очень изменялась семьи за всем почему мы когда она достаточно будет нажать на любой конкретной машины и на ней мы сможем увидеть уже более подробного скажу так внутренности выполнения приложение на круговой диаграмме мы видим график которые график событий по типу которые занимали какое-то количество секунд от общего времени выполнение на этой машине вот в данном случае мы видим то что у нас достаточно много времени занимает видов аллен и еще больше время но занимает конфиг retry вам сил гида файл за не то что получение сервера никого файл это общее время выполнения всех ресурсов типа файл то есть это разложить файлик это какой-то определенный контекст их ради файлика изменить это твое ли калле сделал с ними . время во время конфликта перевал это то время которое уходит в моду на момент момента ее обращения с первого фактом на бабе 21 момента получение уже готова дампа на втором шаге и начала его обработки вот то есть еще у нас вот такая тут замечает на цифру помощь занимает 6 с очистить от их закат некий этих ресурсов которые позволяют выполнить любую производную заранее забыть манду и посредством все так как это внешний какая-то команда нашем случае занимает достаточно долго времени потому что в нашей сети может входить еще и какая то насколько например там отключение гипертрейдинг of прописано какие то лицензии на его машине и прочно столбик сбоку от круговой диаграммы показывает данный потом какие события за моментов из последнего выполнения в этот клиента на машине происходили то есть здесь мы можем увидеть что в общем-то больше большую часть событий было пропущено и не было применено свой не на моем графике это изменения мужчины но это было изменение богу за демоном омывает думаю вот если мой пойдем чуть чуть глубже еще внутри этой машинке мы можем смотреть timeline вот здесь не указана выборка за последние 15 дней того сколько конфигурации применялось к машине я на палочками вертикально у меня все моменты использования по пять лет и два вот на своими занимала вижу 40 секундами на графике отчет любителей провал в 12 октября на это время у нас пока клиент не работал то есть машину машину в статусе оff но при этом клиенту обновляться соответственно никакого графини на в течение небольшого я бы времени будут дальше произошло обновление на память версия 3 и на получены пока не получили прироста которые обещали производители там 50 центов но процентов 35 наверное смело можно я бы получили потому что время выполнения после обновления стало 20 с чем-то сегодня вот и буквально там за один-то дрова день злой доклада один из моих коллег нашел еще небольшой минус выполнение нашел года это проблема была soul делся нет справка сестре ли проблема была в том что и делаться на машинках загружаемся где все виды котором у него есть и пытается что-то сделать то есть от временного порядка четырех секунд после этого ему не ну типа провели свой код я вот обозначила кривой стрелы здесь мы получили прибавку еще в принципе на 4 секунды и если посмотреть на график версии 21 конечном итоге версию три наверное где-то близко 10 процентов нашли то есть если кто то и продолжает использовать вторую ветку в общем то наверное вполне можно обновиться вот итоге по результатам нашего опыта использования памяти мы пришли в таким нескольким правилам о том что стоит делать и как тут вообще стали делать то есть первое что нужно сделать это увеличить количество интенсивно посредством слова побита не того чтобы увеличить отказоустойчивости стрелять нагрузку нам необходимо как каким-то образом балансировать по поводу будь уверен в том что сможешь масштабировать нашу масштабирование заключается в том что здесь конфликт память мастер они из -9 для того чтобы вести строя ещё один сервер достаточно из запустить процессы под юникорн собственность своей все у нас продолжит работать собирать читать отчёты часто очень бывает полезно потому что иногда конфигурации факты могут натирать какие две вещи которые программисты или просто админ могут завести меня есть руками ну и создавайте х синхронно это достаточно такая очевидная вещь потому что мы работали потому что представляется возможным разрушенную страну с он у нас вот этот вал заканчивается озера т.п. а именно сообщения очень или однако бизнеса банка не транслирует этого чтобы попала на конкурс вопрос побед и есть такая не строить общественных действий на него параметрам под масками по моему осин столько завершенность если показывать этот параметр то увидишь и он будет вы должны знаете стоп серую будешь плавать и если возле тостов сел есть отрезаться этот то есть как только вы это делаете соответственно ты помнишь то вам придется понять карман . маленький который я - и вас не будет заранее не должны уже поместился инкассация это конечно разработка спасибо за с варбистов вопросов появился использовать белую форму в качестве самого одно целое на данный момент нет конфет оформленные а чтобы они разве у нас есть сам должен то есть мы пробовали его там настройки он официант с помощью него у металлиста это попытались после смотрели что он в плане настройки и собой и прочим он примет нас есть более серьезные тебе спасибо первом мы просто на самом деле истории с обновлением подняться на вершину деле было сделать этот билет постановки в москву будет а класс на 6 равных советским сферу нашей изучать я пока ящик продаж не то есть это чтобы для нас интересно этого мы пользуемся но на данный момент мы используем cs йошкар-ола концертный зал ну что ближайшая спасибо еще последний вопрос используйте запускаются агентов колонии причина зовут мы отказались от охоты изумительны и собака не злить обещали поправить но потом уж приемлемым уроки боли то есть москве справимся ясно спасибо"
}