{
  "video_id": "F71pLdEN_9M",
  "channel": "HighLoadChannel",
  "title": "Обработка ошибок времени выполнения в PostgreSQL / Иван Фролков (Postgres Professional)",
  "views": 899,
  "duration": 1792,
  "published": "2021-10-04T02:44:40-07:00",
  "text": "и так как уже представили меня зовут волков иван я работаю в компании кузбасс профессионально занимаюсь я там поддержкой непосредственно разработчиков то есть как что сделать как что написатель я хотел бы поговорить о ошибках времени выполнения то есть то что вам сервер отвечает в результате скажем так различных неудачная операция может и удачно как получится рассказать что к ошибкам большинство разработчиков относятся с той точки зрения что их не должно быть к сожалению как вы наверное все разработчики знаете это невозможно ошибки бывают боль того нередко ошибки бывают скажем вполне ожидаемые наиболее типичный случай эта ставка с нарушениями личного включая то есть мы пытаемся вставить строку есть там такая строка уже есть нужно значит уже есть это типичный случай при различных 13 дим патентных операции несмотря на то что такой ошибкой ожидаемо бывают другие естественно и с ними как то нужно уметь обращаться а вот с этим обычно все достаточно грустно наиболее типичный случай для интерактивных приложений мы просто будем сообщение чё-то у нас там случилось обычно какая-то внутренняя ошибка сервера обратитесь к разработчикам ну в общем-то для интерактивных приложений а это вполне вариант обычно оказывается хотя конечно есть возможности что-то улучшить но и нередко общем то и этого вполне достаточно кстати что опять же так не заставляет особо сильно погружаться вопрос о том как надо обрабатывать ошибки для приложения не интерактивно который выполняется более менее под присмотром оператора какого-либо в общем-то возникла ошибка упали записали в лоб и пусть там разбираются этого что-то вполне работает как я уже говорил то есть для интерактивных приложений и для тех приложений которые более-менее под присмотром если же у вас какое-то отчуждаемое приложение вы его куда-то за тепло или по к нему не имеете ставку вас имеет только админы или это вообще раздают в широко или это приложение отправили куда-то на вас должно работать годами без присмотра 0 из минимальном или вот было возможности куда-то уехать в отпуск а чтобы она работала уже конечно такой обработки недостаточно на вас упала надо разобраться почему она упала перезапустить и как этого избежать и наконец к сожалению до сих пор встречается не так редко как хотелось бы когда машег просто игнорируем вот типа типовая ситуация вина за разом ул это и в подкастик такая конструкция есть и ворог ли вот сейчас у нас идет переход 41 posts и я достаточно регулярно натыкаясь на такие вещи возникла ошибка ну и бог с ним поехали дальше это может поставить разработчиков очень удобное положение я очень хорошо помню как много лет назад при демонстрации не проверяли ошибки обработки и от просто у как отвалился нфс все заработало очень быстро прямо так красиво так что ошибочки хорошо было бы проверять что происходит и если возникает у хотя бы упасть с внятной диагностикой когда мы игнорируем у вас что-то не работает где она не работает почему она не работает что там сломалась поди пойми если приложение тем более не очень знакомо подписали невы и или да ладно забыли это может стать вообще мукой и проблемой сумма для сама вообще мы рассказываем к работаю компании фазберс профессиональные то у меня все конечно сильный углом в подвесное то в принципе относится к любой так вот любая cbd относят все ошибки класс говорит не говорит что сломалось или где даже иногда сломалась но с точки зрения приложения то уже не так важно что сломалось интересует что делать а разработчика интересует что в случае ошибки произошло с приложением и базой я вот тут на этом слайде попытался цветом выделить и расписать что может быть настолько типовой случае что например ничего страшного не случилось пришел какой-то warming да что там кодировку установлена такая то ну и может быть все нормально или чтобы произошло преобразование тип ну произошло произошло может быть видите вещи которые стоит куда-то написать в лог например или в мониторинг если ваше приложение где-то работает хорошо чтобы из приложения и избранные не самого приложения можно было что-то отправлять в мониторинг например там продолжаем эту сечение типов попытка и санкционированного доступа некорректные данные попытались увезти ну все нормально но лучше бы об этом просигнализирует что какая-то проблема возникает так как у нас в приложении под особым интеллектом не обладает но может только одно сделать может 2 это просто попытаться пенни выполнить операцию например у нас сервер не доступен если мы предположим запустили приложение она лезет серверу сервер не доступен а мы уехали на рыбалку связи с нами нет то хорошо бы предусмотреть чтобы она пыталась переса единице или подсоединиться к серверу там часть какие-то интервалы времени то есть у нас есть еще один тип операций и операций реагирования на ошибку повтор операции возможно будет что-то специфическое для приложения например мы пытаемся отправить какую-то транзакцию внешний сервер этом говорит что транзакций устарел значит ее нужно сделать по новый там как собрать и попытаться отправить и наконец у нас могут быть более серьезные вещи например у нас физически разрушилась базы мы получаем сообщение что у нас ошибка ввода-вывода что у нас и там и ошибка индекса или например у нас могут быть бизнес критические ошибки то есть у нас предположим система обнаруживает что происходит несанкционированный вывод средств единственная реакция в этом случае просто все остановить нас от легкого сложного и чего состоит ошибку сам граф воскресе два первых у нее есть уровень вот так я не буду перечислять написано может повторить документацией есть важный параметр rascal state о котором я сейчас буду половина на половину рассказывать даже может быть больше ну и различные подробности где это произошло что это произошло какой constraints работал с каким типом данных если это вышло а вот общем то вы из самого сервера можете что-то сигнализировать подробности какие то ну или по constraint например можно разобраться что не сработало и вывести сообщение пользователю там например что телефон указан не верно вот у меня тут примерчик я делаю а 1 прошу сделать чтобы подробно сообщений об ошибках были создаю табличку с с колонкой тексты про верочке чтобы она начиналась цифр и пытайся до 2 ставить значение которое не соответствует этому чеку что мы получаем мы получаем error обратить внимание доз тряпица 514 с описанием detail которые есть схема в которой подошел таблица ими constraint а но как я говорил по константу в принципе ориентироваться какая ошибка произошла и что-то говорить пользователю и начнет sql state сколь стоит большинство слышать кто знает точно что это такое руки могут понять хорошо-то как господи так вот и сколь стоит по стандарту это описание ошибки в которой произошла в базе данных это символьный это не числовой это символьный состоит из 5 позиций первые две позиции это класс ошибок дальше три позиции это подробности этого глаз и ошибок у некоторых ошибок есть название чековая лента модник violation вот у некоторых нет подробности для подвеса конкретно можно посмотреть в документацию приложений а если уйти брать какую-то другую базу там соответственно будет тоже какой-то свой набор ошибок из них некоторые будут совпадать с конгрессом это стандартные у меня указано какие стандартные классы и которые и какие стандартные решения ошибок бывают это первый символ вот соответственно и там они на самом деле еще более-менее подробно ну и есть конечно расширение если брать например русская db2 там очень много всяких ошибок в плоскости их поменьше но тоже хватает и так как у нас есть расширение нам никто не мешает сделать свой особый бизнес-класс каких-то ошибок то есть например там нет товара на складе происходит несанкционированный вывоз средствами что не подобное вот я тут вот качестве примера приведем естественно следует брать тех классы которые нестандартные чтобы не пересекаться в дальнейшем со стандартными в подгрести есть еще дополнительные классы вот бибиси и 10 пиджи это препроцессор стишки для подвеса я им часто не пользовался вот он такой ветер такой бывает суть потому что он активно поддерживать кто-то им пользуется не на кто-то если кто-то им пользуется обратите внимание есть такая вот дополнительные классы я как перечислял что у нас самого легкого к самому тяжел внутри киз это самую легкую и пошел во первых у нас есть класс 00 это ошибка отсутствует но тут он не указан очевидной причины соответственно есть взгляд еще 0102 горник но дата ну вот тут написано каком случае бывает почему ты селе print in strict выбрасывает совершенно странную ошибку которую логично было бы жить но дата была минуту и ну да то оп и 0 вот 002 это как видно расширение ошибки дальше у меня дальше будет большая большой слать мелкий я вот испытываю я не могу просто не дописать чего-нибудь подробно а подробно получается полезно много я еще раньше любил код писатель большой просто не так и и никто не читал но как-то совесть была зато чисто и так вот самый большой класс ошибок 0309 их там много будет это происходит том случае если у нас что-то не так с приложением например там вот 27 3 0 ошибочка такая бывает что-то явно с предложением намудрили в приложении вряд ли сможет эту ошибку поправить ему надо ли было ли бы прекращать работу если это какой-то не интерактивное случае интерактивного режим внутренняя ошибка отправляя подробности оператору там что-то еще 21 30 а я тоже класс особо кстати вот такие вот вещи бывают класс 08 это хорошо бы запомнить это ошибки соединения в адресе почему-то вдв этот доступ форинта то wrapper к удаленным сервером и сервера завёрнут другой класс не 08 а вот эти идут и чьи вот как я уже говорил что мы можем сказать после возникла не такой ошибки что приложение находится в некорректном состоянии а вот база находится как раз корректном состоянием и в общем то другие части приложения другие приложения могут продолжать работу аварийная остановка не требуется но хотя конечно в мониторинга лак об этом написать бы следовало 22 глаз ошибок и to do the exception это ошибка доступа к массиву и но неправильно лбу аргумент для логарифма я правда не когда алгоритм не вычислял но наверное кто-то может участвовал кому-то это надо и прочее как я уже говорил что приложение это явно ошибка приложения ошибка бизнес-логики возможно б д находится в корректном состоянии 23 это особый класс ошибок это integra не контент constraint в elation этого йорке проверки целостности это как раз у нас все находится в базе опять же в корректном состоянии база не дала себя перевести в некорректное состоянии если кто-то ходил посещал нас был шанс онлайн меня там у доклад о целостности базы данных constrain так вот ну вот как раз конструктор позволяет чтобы так баба за не сова не позволял себя сломать в данном случае 23 это в частном случае может оказаться пример некорректного ввода то есть там кит некорректные данные вели . ешь вопрос есть где проверяют данные на клиенте или в базе по моему надо проверять и на клиенте и в базе нескольких местах кушайте где-то в одном ислама сломаются про верным другом сработает ну опять же по случае возникает возникновении 23 можно взять как я уже раньше говорил constraint и поэтому constraint выяснить что у нас на самом деле там произошло что-то показать пользователю предположим или написать лог или специальный журнал ошибок писать письма например загружаем данные у нас для каких-то строк возникает такая ошибка мы можем их откладывать вот эти вот эта строчка не прошла вас не надо разбираться если кто смотрел автостопом по галактике то основная ответ был 42 теперь вы можете понять что это такое было на самом деле и вот это тоже ошибка приложение оказывается главный ответ на вопрос и зеленой жизни и вообще но баллы при этом остается в корректном состоянии что в общем не может не радовать хочет тот хороший осталось над сказать что не все ошибки одинаково часто встречается 0b но леев я например они просто не встречаются я специально смотрел исходники паскаль со на предмет таких ошибок ну я не нашел может быть день там в углу сьют собираются хозяином в клинике указаны а некоторые ошибки возникают редко некоторые возникают часто некоторые нужно уметь ловить 40 это ошибки сериализации параллельного доступа класс еду где те кто то вот нос 40 p01 ее надо уметь обрабатывать вот как раз эти ошибочки это ошибки которые требуют перевыполнение операции это класс 08 за одним исключением и вот дальше перечисленными конкретной ошибки и либо 53 это ресурсы недоступна какие то соответственно нужно перевыполнить операцию возможно некоторые таймауту если для одиноко тайм-аута можно ставить маленькие то для реконнекта наверное ставить немедленно перевыполнять нет смысла там если мы сам подождать хотя бы несколько минут приложение при этом у нас находится в нормальном состоянии никаких ошибок с ним не обнаружена база видимо тоже находится на расстоянии либо вообще не в как он не находите потому что ее не удалось найти случай 08 вот 58 класс это у нас системная ошибка обращая внимание что это стандартная ошибка в отличие от 2x а у нас к сожалению ваня по сгрыз на многие вещи наши расширения говорят нестандартными ошибками хотят хорошо чтобы говорили бы нормальными ошибками такое замечание приложение находится в нормальном состоянии при возникновении такой ошибки а дальнейшая работа базы к сожалению невозможно то есть надо что то делать вызывать операторов и прочего так как у нас есть highload высокие нагрузки то все должны уметь обрабатывать де блоки существует странное такое убеждение что при правильном подходе блока не будет это ошибка не 2 всегда может возникнуть в ряде случаев можно добиться того что из блоков не будет но это вас вот на конкретном случае вы предположим написали код который точно работает без дидло cove через три года пришел вася пупкин добавил триггеры не доки вас полезли все-таки надо быть готовым к тому что они возникнут почему не блоки возникали я написал повторять не буду но хотел сказать что де блок это не ошибка приложения это не ошибка кода это не ошибка архитектуры это более философская концепция она грубая не позвони грубо точно говоря не позволяет нам организовать транзакции таким образом таким образом чтобы они еще не последовательно то есть есть какое-то противоречие возникает у нас получается de blob и при этом после соответственно столько postgres любая любая совершенно база даже не обязательно реляционная не может написать нормально журнал операций поэтому возникает de blob соответственно есть у нас возникнет ног то операцию необходимо повторить она у нас с ошибкой мы ее открываем и повторяем обращаем внимание что повтора могут быть не единожды и она отталкивался лично на то что у меня не блок возникал подряд несколько тысяч раз типовая ошибка это уже оправдание времени выполнения разработчиков что мы в транзакции йорген какой-то внешней сервис то есть предположим у нас стоит на чтобы получше было вывод средств больше какого-то пользователя вот и у нас несколько тысяч раз вводится для него средства можно на этом нарваться очень небольшие неприятности то есть если вы такие операции завершайте то не надо делать дифферин триггера кто значит у них или триггера кстати один человек знает глядите константы в базе данных вообще говоря могут выполнять немедленно при выполнении это какой-то за прошлые операции либо по при попытке зафиксировать транзакцию вот так попытки зафиксировать транзакцию как раз и называется дифферента геральт триггерами нам триггеры бывают и прочие вещи задается на если у нас есть эфире триггер то при к мите у нас на эти триггеры начинают вызываться и что они там будут выполнять это уже неизвестно то есть мы может быть камень и в ответ получить какую-то ошибку к этому тоже нужно быть готовым вот создается если вы делаете вызывать какие-то внешние сервисы иногда это все-таки необходимо то лучше это делать в тех случай когда рефери триггеров нету и непосредственно перед камином вас есть очень большой шанс у что все получится ну по хорошим то мне еще надо предпринимать ротацию движений чтобы это сработало ну грубо говоря в общем приближение именно так так как я работаю компаний поспрашивал хотел бы отметить что жертву люди блока в плоскости нельзя выбирать она выбирать самим сервером в ряде случаев это обидно когда у вас какая-то операция работало несколько часов а потом ее пристрели поди блоку как-то это не очень хорошо какая-то маленькая ну к сожалению этого нет а я этого за вопрос поднимал как-то его зам или ли вот ну правда никто не жаловался ну кроме я там и может еще кто то я не знаю можно пожаловаться итак вывод какой из них блоками с обработки что одиноков избавиться нельзя можно только снизить вероятность их возникновения потому ходу которой я обычно вижу снизить вероятность их возникновения представляется затруднительным потому что обычно подпишем лишь бы он заработал а когда он уже заработал иди знаков вроде особо нету никто не напрягается так что я достаточно скептически отношусь к их снижение вероятности в ряде случаев это можно отследить если у нас большой под большим количеством разработчиков в большая кодовая база это в общем достаточно сомнительно раз уж заговорили о делу как-то надо сказать что одинокие могут возникать не только собственно в базе но и в пуле коллекции если нам требуется больше двух соединений к базе то мы можем налететь на di2 уже сам ампуле если у нас предложен java там или какой-то еще мульти трудно и приложение почему нам может потребоваться больше двух соединений но мы например мы можем ввести аудит операций мы можем проводить не отменяем операцию как я уже говорил внешние сервисы вызывает чтобы нам внешней сервис нормальный вызвать мы должны познать отметки что вот попытаемся вызвать сейчас такой сервис это еще одно соединение если у вас недостаточно соединение в улитку соответственно можно налететь на нетбук уже там такая жизнь дидло как вся сплошная есть такая не сложная формула по которой можно вычислить минимальное количество соединений пуля которая вас должно быть доступно ну и когда каких говорю реки полу не надо забывать что и упадут уже должно быть достаточно доступно достаточное количество изменений самим сервером еще повтор операции это серийный женщин sailor и судя потому что никто не знает как одинок я думаю что с этим тоже наверное будет не очень хорошо под грифом можно запросить консистентной представление базе если у вас не получается его предоставить для приложения вы можете получить такую ошибку надо просто перезапустится если попросить там бы еще и сказать же у меня транзакция будет ребенок это все дела можно сделать так что такая же по не возникнет но это уже достаточно специфический под грязцова вопрос я думаю что тут его рассматривать не надо класс 08 это конечно exception за исключением wot 0 8 p01 нарушение протокола это в принципе требует обычно просто переподключения в общем случае то есть например типовая ситуация что у нас админы что-то намудрили сетью сети у нас полегла приложение у нас в тип продолжает пытаться подключиться если вы уехали на рыбалку админа тем временем сегюр они подняли вот все продолжить с того места где оставил здесь конечно аккуратно написано и вы нормально обрабатывать и ошибки приложение как я уже говорил в нормальном состоянии и будет тоже видимо в нормальном состоянии просто ошибка соединения 50 классных 50-54 это недостаточно ресурсов и лимит превышен у нас еще вполне могут быть бизнес ошибки такого же типа то есть недоступна оператора нет товара на складе кончились деньги там где-нибудь в счету чтобы выплачивать подобного рода вещи может быть для них есть смысл сделать свой бизнес класс ошибок ну возможно этим воспользоваться другой стороны если у нас возникает 5350 четыре ошибки то хорошо было бы об этом куда-то сообщать в мониторим что так и так у нас тут произошли большие проблемы что-то не хватает возможно это все нормально а возможно что то у нас и разрушается хорошо было бы админов как-то уведомить о таких событий 72000 snapshot тула это специфическая борисовой ошибка в общем то она не сильно отличается по обработкой себе зависит все ошибки которые сейчас перечисляю и все требуют повтор выполнение операции я не буду вдаваться в подробности если кому то интересно можно посмотреть документацию тем не менее бдв корректно расстояние к так как потребуют повторы приложение тоже в корректном состояние для как я уже говорил что для некоторых операций есть смысл ставить тайм-аута побольше для некоторых поменьше ты не блок разумно ставить перевыполнение почти сразу а если у нас значит сервер недоступен там несколько минут подождать опять же насчет где блоков если уж больно часто они возникают было бы неплохо что-то об этом писать в мониторе ещё мне очень нравится что у нас есть отдельный класс ошибок почему-то christ not found чем так кейс выделился я не знаю но вот тем не менее он отметился то есть вот он отдельные отдельные случаи есть отдельный даже классно это в принципе хорошо я как-то читал книжку там автор рассказывал что у нас есть зимой празднуют рождество а летом ивана купалу весной празднует равноденствия и осенью казалось бы тоже должны продавать равноденствие но его не празднует потому что обычно сбора урожая он несколько раньше проходит это горит нормально потому что жизнь она всегда немножко косаря когда все симметрично это мёртвая поднимут нравится случай что когда у нас ли отдельный есть класс а вот он немножечко косой и примат показывает что до с этим работали люди это вот для чего то использовали это было нужно это вот пример что это живое если все было бы zeller логика симметрично уже возникает вопросов больно но ровно неужели в жизни ничего не возникло такие из этого можно сделать на этом этапе выводы что у нас есть можно составить нужно составить закрыть закрытый список ошибок для которых допускается повторное выполнение возможно в приложении может быть еще какие-то ошибки для которых требуется какие то определенный бизнес действия и повторное выполнение все ошибки класса 23 это нарушение constraint of это база в корректном состоянии возможного плохие данные надо иметь эту виду все остальные ошибки говорят о за исключением ошибок которые 50 выпили 58 или xx это которые внутри ошибка сервера все остальные ошибки говорят об ошибках в приложении ну как его обрабатывает и зависит уже от приложения либо прекращать работу либо вы кликаете какую-то часть приложения либо там просто говорю внутренняя ошибка но тем ни менее ну и когда конечно нужно писать в лог нужно писать в мониторинг вот мне тут небольшая такая разве девочка по ошибочка я думаю что и зачитывать не буду потому что это будет долго нудно вот я думаю что слайды будут доступность кому интересно можно ее в принципе посмотреть тут мне как раз по классам раскидано что делать не цветом выделена соответственно какие вещи бывают принципе конечно в реальном случае в каждом приложении надо смотрите что и как происходит но тем не менее и так теперь погрузку или ошибочка мне тут торопит я сейчас простите буду быстро и особо не углубляюсь в теперь погрузку или можно ловить как конкретно ошибочка так вот жирно выделенная можно целый класс ловить ошибок при входе в лоб погрыз делает неявный саиф по интенсив ходит на рынок по значку sfp ну вот он делаете явно свои point если у вас много своих пойнтов больше 7 4 могут быть проблемы вот где спрос с этим немножко получше но не совсем хорошо и так как хотелось бы можно в принципе заворачивать ошибки в другие ошибки это стандартный прием принципе не совсем не пузыри совы где угодно используется под погрузку или можно получить ошибочка в детстве диагностик всякие подробности посмотреть можно посмотреть как вызовов и меня сейчас вот любимое будет java я тут на нем несколько становлюсь потому что когда я начинал писать эту презентацию я еще писал ее к осени еду коротко расскажу а джага-джага оказалось что самое интересное и так в жизни жени би си 4 есть своя иерархия ошибок они решили что будет разумно примерно сделать как и я вот говорил там операции повторяются не повторяются ну немножечко немножечко не так конечно к развернуто но тем не менее и выразим такую иерархию вот она возможность скриншот из документации какая иерархия ошибок джинни месси джонни би си обращаю внимание ну возрасту это не относится он бросает калининская liksys вот никто правда не жаловался что он бросает интересно есть угодить бисер н.г. у него свои завихрения то есть он немножечко другие вот в другом себя ведет но зато не бросает hand то есть если у вас грязцова ошибки можно достать хентай манга почему нельзя есть spring is pregnant все знают джаве унес свое представление об ошибках отличается от жени бесить джонни би си 4 вот и плюс класс 08 получить не получается но зато можно получить его в двух типах hinged же небес и кеннет гаррет transaction правда сколь стоит одинаково это выходит красота вот это иерархия ошибок в springer такая джаве но это еще не все идут в принципе в спринга можно прописать какие ошибки возникают вам что они транслируется можно либо свой старшим транслятор либо герой кодексом или прописать стандартный красный тренировок о да соберет но ничего есть ночью гибер нить в берн это как вы догадываетесь своя иерархия ошибок вот там все по своему вот у него картину покороче там поленились есть насчет jal имперцы снится архитектура такая естественно у неё своя орфею арки ошибок но и это еще не все если вы используете you burned как провайдер для джипа у вас может быть что герметики ошибочки будут завернуты в эту башню ошибочки то есть если вы вызываете пиджак жадный ход со стороны вам от туда от базы может прилететь вообще все что угодно и кто угодно необыкновенное разнообразие на чем это говорит это говорит о том что нет проблема действительно и решительней так-то просто единственное что весь мой более менее разумное поведение это пройтись и выдернуть какой ты оттуда и сколь стоит это в принципе можно оттуда добиться кое-как и единственный выход с этим как-то аккуратно общаться все sharpie по моим все попроще не особо не разбираюсь но там можно просто отец could stay то в общем-то и наверное хватит php и гол совсем сильно проще очень сдержанно месте сковали стоит и текстовое описание ошибки ну пока об этом можно еще его можно достать подробности вот php можно так оставить в кошечки вот таким вот образом сколь стоит и хорошие она может и хорошо даже и что все есть вопросы спасибо за доклад давайте запустим вопрос можно ли создавать своих воды ошибок использовать их приложений да конечно можно и даже нужно но при этом все-таки если определять свою ошибку то лучше все-таки посмотреть какие есть стандартные классы ошибок и какие есть не стал бы пусть его нестандартные и скажет либо что если что-то попадает стандартной лучше запихнуть туда у вас мы будет аккуратнее обрабатывается в итоге"
}