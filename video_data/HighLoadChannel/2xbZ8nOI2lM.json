{
  "video_id": "2xbZ8nOI2lM",
  "channel": "HighLoadChannel",
  "title": "Шардируем Postgres не своими руками / Денис Волков, Кирилл Решке (Yandex Cloud)",
  "views": 419,
  "duration": 2544,
  "published": "2024-10-29T03:00:14-07:00",
  "text": "это время да Всем привет Меня зовут Денис вас очень много Я очень рад что вас так много и вы смогли сюда добраться потому что я очень долго искал то эту аудиторию Да тут Кирилл сидит внизу вот пожалуйста Кирилл можно поприветствовать его тоже пум-пум-пум пум-пум Кирил Я сегодня по буду говорящей головой а Кирилл если что мне поможет отвечать на ваши сложные вопросы а Ну всё тогда начинаем Я буду рассказывать о том как шардирование такой штуки которая называется stadel pog quy router или сокращённый SPAR А это вещь которую Кирилл в один прекрасный вечер написал на коленке и из этого мы пытаемся собирать какой-то продукт и планируем делать сервис а при этом так можно момент мне тут не хватает ээ докладчика дадада Ну окей ладно я попробую Так рассказать при этом вот этот SP он по сути является Production Ready У нас есть целый один продуктовый клиент внутри Яндекс облако и ещё условно пачка находится в тестировании как-то так вот наш сегодняшний план рассказом я расскажу Кто мы такие Чем занимаемся собственно расскажу о постановке самой задачи расскажу с своими руками и что для этого понадобится немного расскажу про архитектуру нашего решения о производительности её проблемы ещё очень важная деталь - это доклад про Мы уже рассказывали на разных конференциях я и мои коллеги год назад мы тут были на лоде полтора года назад мы были на ПГ конфе и там суть доклада сводилась больше про в сторону баз данных То есть как работает с точки зрения базы данных сегодня так как мы на Я попробую рассказать больше про внутренность самого икура потому что эта штука написана на Гоше А вот как-то так отлично Кто мы такие куда мы идём Э мы во-первых работаем в Яндекс облаке наша команда формально называется разработка реляционных систем управления баз данных с открытым исходным кодом но по факту мы занимаемся велосипедным ракето строением мы контрибьютор э поддерживаем и развиваем такие утилиты для Ну там условно чтобы Баски работали хорошо в LG Odyssey и вот сейчас ещё spqr Э что такое Post grq managed pog qul в Яндекс облаке ну во-первых э есть несколько инсталляций Яндекс облако не только внешняя но есть ещё внутре индексов инсталляция для внутренних сервисов это миллионы запросов в секунду петабайт данных это 1.000 кластеров в каждой инсталляции по 1.000 кластеров совершенно разными флейра от одного там до 80 цпу С разным количеством хостов и в основном это высоко доступные кластера А зачем шардирование ну минусов нет кроме одного большого жирного если вам нужно как-то масштабировать вашу базу данных то из коробки нет никакого готово решения Обычно когда ваш кластер у какой-то команды кластер база данных вырастает до какого-то критического значения что больше нельзя доки в него ресурсов Ну то есть конечно это очень плохая ситуация обычно всегда думают заранее когда это случится прикладывают линейку но суть в том что приходится шардирование думать На каком из них лежат лежат данные почему это проблема И вообще зачем мы за неё взялись Ну во-первых можем себе позволить потому что мы ракетостроение занимаемся готового решения не существует и мы уже давно боремся с этой проблемой мы сделали несколько подходов кажется у нас получилось вот что мы хотели немного расскажу о постановке задач Так выглядит типичные есть какие-то Хосты мастер реплики Понятно мастер только пишущий читающие запросы на реплики отправляются только читающие запросы между ними как-то настроена репликация валы архивируемых и вот мы подумали что было бы здорово поставить такую прослоек мы назвали её прокси роутером бэнды будут ходить в эту просечку эта просечка будет понимать На каком рде лежат данные собственно вот простая идея при этом мы понимаем отдаём се отчёт что ресурсы шардов могут быть разными они могут разными по пу по оперативной памяти по Ио дисковом вводу выводу и про пропускной способности сети это очень удобно было бы если какие-то данные лежат горячие э на каком-то более мощном рде а условно какие-то холодные данные э лежат на каких-то холодных дисках это условно так вот а теперь я сейчас расскажу как своими руками очень легко написать такую прокси значит смотрите следить за руками э первый первый шаг - это надо научиться общаться по протоколу пог qul То есть это значит надо получать самый сль запрос как строку вот у Вас в гоном коде где-то должна быть строка в которой лежит запрос второй шаг - это научиться парсить синтаксическое дерево берём запрос строим по этому запросу синтаксическое дерево А что это значит что в результате гуляя по этому дереву мы можем вокруг этого навесить какую-то логику какое-то поведение Ну и собственно всё Профит если собрать это вместе вас получается такой прокси вот следить за руками на самом деле Вот так вот на пальцах это объяснить каждый может но код написать наверное возникают какие-то вопросы окей без проблем сейчас покажем вот смотрите Давайте шаг первый Значит надо научиться принимать запрос как строку научиться общаться по по протоколу воспользуемся известным драйвером pgx там уже всё написано очень многое написано буквально открываем Connect слушаем пор 5432 создаём специальный объект frontend в котором уже с помощью которого уже в бесконечном цикле мы будем слушать этот порт и принимать сообщения и как только сообщение приняли и оно типа PG proto 3 query это то что нам нужно всё там лежит строка успех согласитесь довольно-таки несложно второй шаг - это начать парсить запрос но вот тут точно будут проблемы Да не на самом деле нет вот есть такая библиотека PG query Go это библиотека из проекта PG quy а PG query - это проект компании PG условно есть какая-то компания PG которая предоставляет как сервис както диагностика производительности ваших запросов очень удобно можно типа посмотреть какие там запросы и какие-то хинты подсказки о том что Ну как можно улучшить производительность вашего кластера так вот эта компания выложила такую штуку py в Open Source которая просто строит синтаксическое дерево вашего запроса буквально вот есть простой запрос ID From US Боше 18 чтобы его распарсить нужно просто вызвать метод пас тут как бы ну Элементарно А вот потом дальше оно возвращает об ИТ напи кая КАТО следующем есть Дерево у этого дерева есть какие-то ноды и по этим ном можно гулять и вот на этом моменте можно построить какую-то логику как она долж Как она может выглядеть Ну смотрите вот на следующих слайдах какие-то скрины кода в самом куре условно если если нода имеет такой-то тип вот тут будет какая-то логика если другой тип будет другая логика Вот так например реализована поддержка селекта вот мы нашли ноду типа и там дальше что-то происходит И вот так вот можно собственно описать такой прокси роутер Всё достаточно принципиально просто всё вы великолепно теперь это была по сути главная часть самого икура вот этот роутер который роут запросы на правильный шарт теперь расскажу очень кратенько о архитектуре нашего решения Ну во-первых вот есть роутер на него приходит запрос он смотрит запрос понимает куда надо отправить отправляет дожидается ответа отдаёт пользователю тут как бы всё понятно выглядит это следующим образом роутер - Это Гош приложение оно слушает определённый порт и к нему можно подключиться по SQ вот тут например это и происходит делается какой-то запрос и роутер нам отвечает что этот запрос был отправлен на шарт о довольно просто тоже самое можно сделать и с селектором Кто бы мог подумать при этом те запросы которые понят как ть это один один момент Но есть запросы которые нельзя точно сказать На какой шарт отправить условно Create Table запрос наверное такой запрос было бы круто сделать на каждом рде а не только на одном и вот тут Э начинаются такие Небольшие проблемы потому что по идее надо писать какую-то сложную логику которую мы не написали пока и не хотим писать а мы делаем такие запросы которые нужно отправлять на каждый шарт не не транзакционная потеряться но мы это делаем просто из логики best of мы пытаемся всё что лучшее мы можем сделать по крайней мере сейчас сделать например Это очень удобно для тестирования точно также в консоли вот эти мульти запросы работают следующим образом пишешь Запроси они отвечает что отослал на все шды собственно вот всё при этом в такой конфигурации как те являтся один роутер является прекрасной системой точкой отказа ничего лучше придумать нельзя Мы конечно же при проектировании заранее это предусмотрели и роутеров можно запускать много насколько много бесконечно много сся роутеров могут быть запущены пожалуйста у вас будут проблемы только с железом вот во что вы можете упереться только найдется ли у вас желе по 1000 роутеров понятно много на них же какие-то какая-то Мета информация лежит о том где Какие данные хранятся Поэтому нам нужна новая сущность нам нужна нужен координатор который будет как-то менедж это а условно Что может делать координатор он может добавлять удалять роутеры он может добавлять удалять новые шарды а координатор может перевозить данные то есть заниматься балансировкой А ну и да показывает какую-то Мета информацию об инсталляции при этом все данные координатор хранит в некой qdb внутри это etcd база данных вот я тут выписал главные фичи с SPAR Ну понятно мы метим в отказоустойчивость Мы метим в то чтобы было нашу инсталляцию легко масштабировать при этом каждый компонент работает по пост протоколу реализован транзакционный сессионный пулинг запросов реализована балансировка шардов обновление конфига на литу вот эти вот ограниченные кросс шардов запросы Ну и про производительность будет позже Очень важно тут сказать про балансировку потому что это Киллер фича В каком плане понятно что если не использовать SPAR можно в принципе на коленочки в своём приложении быстренько написать Вот эту логику проливая и у вас всё будет прекрасно работать пока не появятся новые данные и в итоге эти данные будет как-то разбалансированный у вас один шарт будет постоянно загружен по цпу на другом Будет не хватать места а третий будет просто пустовать и жрать ваши ресурсы поэтому балансировка - это такая важная вещь которая в испу каре написана но в силу того что ноль клиентов её тестировали мы не уверены как она работает при этом у нас есть такой прекрасный сервис в Яндекс облаке как S3 в котором специалист наш коллега написал балансировку и она работает там точно такое же шардирование но без эпикура и вот эту же балансировку он написал в эпикуреец из классных примеров мы буквально SP очень плохо работал в режиме deb когда роутер логирования был дебаг И вот мы просто заменили лоер и у нас уже типа десятикратный рост производительности потом мы начали профилировать сам роутер и нашли какие-то тупые короче вызовы повторные функции наступили на проблемы в самом pgx которые буквально тоже очень легко подчинились обновлением версии метод PG прод занимал 50% времени выполнения запроса Вот это да следующая простая тоже относительная проблема с которой сталкиваются многие Яндек которые пишут на это переменная её значение в во внутренней инсталляции Яндекса суть см есть такая классная переменная которая используется для инициализации Кост рутин в вашем ратай она устанавливается во время запуска приложения и во внутренней инсталляции э переменная показывает не количество ядер на вашей виртуальной машине А количество ядер на гипервизоры но эта информация она релевантна только для сотрудников Яндекса следующая интересная проблема это неожиданно библиотека PG quy Go медленная Кто бы мог подумать это тоже узнали при профилирования нашего запроса А всё Почему Потому что внутри используется в исходники по и в общем мы долго думали что с этим делать И в итоге решили по индексом мы просто написали написали свой парсер запросов сделали следующим образом взяли пасер из поса выкинули оттуда ВС лишнее и оставили только то что нам получилось Там типа выкинуть 70% и в общем неожиданно мы получили бус производительности прям сильный насколько сильный сложно сказать Ну типа X2 например вот мы тоже выложили его в Open Source можно пройти по ссылочки посмотреть собственно вот этот репозиторий теперь про тесты про производительность то есть можно как бы руками махать очень долго рассказывать какой классный но нужны какие-то цифры насколько классные Вот есть такой известный тест tpc он придуман В девяносто каком-то там году какими-то дядька э смысл в следующем А ну понятно что это тест для измерения производительности там внутри происходит имитация интернет-магазина выглядит тест примерно следующим образом А есть какая-то жирная транзакция в которую изменяется читается изменяется обновляется много табличек а в конце происходит собственно говоря этот тест позволяет сравнить разные базы данных обычно у баз данных Есть какие-то результаты этого теста то есть очень популярная штука И вот мы попробовали запустить тут на графике представлена следующая вещь этот тест измеряет транзакции в секунду Тп есть едини измерения ТП то есть транзакции в минуту представлены по этой оси транзакции в минуту tpmc по Нижней оси представлено количество шардов то есть в этом тесте мы брали один роутер и пробовали его замерять его работу с разным количеством шардов просто очень хотелось доказать что при увеличении количества шардов то есть при добавлении железа в вашу инсталляцию производительность инсталляции растёт Ну в общем у нас это получилось показать и мы Нара 2017 года инженеров из АВС которые проектируют какое-то я бы не сказал похожее немного другое решение но смысл в том что тоже вариант масштабирования Поль называется vs Аврора и мы нашли статью где была представлена Аврора а и там были представлены также описаны бенчмарки и там к счастью использовался тот же самый бенчмарк который а э который использовали мы то есть tpcc - это как бы декларация о том как должен работать тест а реализации много реализация та же самая использовалась Ну в общем при примерно похожих данных при примерно похожем Одина одинаковом количестве железа при одинаковом количестве параметров наш роутер работал примерно на 10% быстрее что очень круто а с аналогичным решением для маэля речь идёт про постгрес но также есть аналогичное решение для маэля которая очень старая и бородатая Ну просто несравнимо быстрее работать скор Отлично Теперь будет небольшое демо Собственно как как как начать пользоваться Как это работает но во-первых я Возможно это ещё не говорил Возможно кто-то не понял весь код выложен в Open Source А в этом демо Я попробую запустить специальное приложение которая агрегирующие rss и AP сервер который эти на парные ленты отдаёт в внутри в базе данных используется всего одна табличка articles в которой есть какие-то колонки но также Вот есть колонка category ID типа in которую которое мы попробуем портировать выглядеть это будет а там внутри используются следующие запросы то есть мы буквально селекти все все статьи по определённой категории ID а также вставляем новую новую арку Собственно как запустить это демо приложение Заходим в репозитории git Clone Make два Бинар запускаем отдельно один Бинар запускаем отдельно второй Бинар теперь следующий шаг собрать SP из исходников его тоже исходники выложены на гитхабе как это сделать заходишь в репозиторий Make Build router У вас есть бина Как запустить Run передаём config Что лежит в конфиге в конфиге лежит какая-то информация понятно там много каких-то переменных там условно уровень логирования или вот вот что-то вот такое помимо этого там есть информация о том как frontend Rules как подключаться к самому роутеру реден подключение backend Rules как подключаться дордо creal подключения до шардов и информация о самих Шарх а то есть примерно такую структуру имеет коф config теперь как только роутер запущен можем подключиться к административной консоли роутера по порту 7432 выглядит это следующим образом обычным поком мы подключаемся и нас встречает административная консоль мы там можем поставить какую-то какую-то как-то информацию системную информацию о инсталляции вот посмотреть список шардов например следующим образом добавляются правила рования SH rule по колонке category ID и вот он пишет О том что добавил такое правило а добавим два ренджа то есть у нас колонка category ID имела TP int условно Пускай это будет принимаемые значения от нуля до X Давайте вот этот диапазон принимаемых значений разделим на два одинаковых от Ну до X пополам что происходит вот тут от одного до X пополам и от x полам до X тотм нашар 1 этот Тим нар 2 то есть вот так Примерно это выглядит мы можем посмотреть что действительно такое правило появилось такой добавился Теперь мы были в административной консоли теперь надо подключиться к самому роутеру это можно сделать точно также с помощью ля Уже на другом порту вот тут 6432 подключимся создадим табли видим заро утила на оба шарда Теперь попробуем ради теста вставить одну статью которая заведомо попадает на первый шарт одну статью которая заведомо попадает на второй шарт а потом поселек их и обоже они действительно на первом рде и на втором лежат вот это да вот это чудеса а ещё раз у нас открытый процесс разработки весь код всегда был есть и будет выложен на github под лицензией Post grq Global development Group не знаю что там написано но смысл в том что вы ру убивать делать что хочешь э можно запускать у себя использовать у себя а мы не будем совершенно против этого мы будем очень даже рады Ну и в Call To Action пожалуйста пробуйте запускать SPAR git Clone mun Заходите в наш репозиторий на гитхабе ставьте лайки пишите комментарии у нас есть Telegram чат в котором можно задавать свои вопросы если вы хотите попробовать ику пожалуйста Попробуйте СР если у вас что-то не будет работать можете прийти и мы оперативно поможем вам чтобы это начало работать Да можно ещё запустить демо приложение Ну в общем Спасибо большое за внимание в Да у нас уже есть руки мы задаём вопросы Я хочу сказать что у нас сегодня Два подарка на этом докладе за лучший вопрос будет два лучших вопроса можно ещё так а мне нужна помощь волонтёров как можно скорее Ага У нас нет трансляции или что скажите мне вслух Мне кажется я первый хорошо вы будете первый А привет Спасибо за доклад Меня зову Привет Я тебя не вижу где ты по поши Да поближе подойду Олег ВК CL делаем биллинг вопрос из двух частей во-первых а мне показалось или у вас там нету пока или может вы планируете делать такую вещь как консистентной хеширование вот ЕС ли оно у вас или нет Может раскрыть эту тему потому что показался вы просто по одной колонке там берёте как-то хэш делите остаток деления вот от количества шардов И всё И потом ты рассказал вторая часть вопроса Что у вас там а перенос данных то есть есть координатор который видимо Как работает перенос данных Да если у вас собственно вот главная проблема Это всегда переш одива не Да когда мы масштабируемые ноды и вот тогда начинаются проблемы Вот есть ли у вас какие-то инструменты для этого спасибо Так ну во-первых там нету никакого как бы взятия модуля по там мы как бы не берм как бы Никакое число по модулю количества шардов у нас правила работа таким образом что мы явно говорим что ключи от такого-то до такого-то значения лежат на Первом рде от такого-то такого до второго то есть кэширования там нет то есть вообще есть два подхода вот один с использованием Вот таких вот диапазонов а второй с использованием хэшей мы как бы хотели это поддержать но просто пока не было в этом необходимости мы это не сделали но у нас это есть в планах Я имею в виду конси когда есть виртуальные ноды физические нод новой ноды что при ВС перекладывать в новые ноды А у нас это работает немного в другой парадигме если ты добавляешь новый шар то мы говорим что давай ты будешь перевозить туда ключи шардирование через наш котор причём будешь маленькими кусками То есть у тебя есть какой-то ключ рования типа там на очень много значений он лежит на втором рде ты говоришь ти давай такой штукой он берёт ключ родирования отрезает от него очень маленькую часть перевозит её комитет как бы и этот процесс как бы долго работает данные плавно приезжают между шарми в каждый момент времени на запись не доступна только очень маленькая часть данных Да ну грубо говоря там десятки ключей Допустим можно перевести это происходит достаточно быстро вот да и там ещё был вопрос как работает координатор Ну это но на пальцах он работает Так что типа вот те есть ключ шардирование Ты хочешь его принести Ну мы предполагаем что то что ты переносишь маленькое иначе в этом нет смысла мы берём и блокируем весь этот ключ на всех роутерах типа новые запросы Ну висят на локе не могут начаться Потом быстренько Ну типа переносим его на другой шар допустим если это гигабайт Ну там 10 секунд он будет копировать потом разблокируем всё ты работаешь Ну там ключ приехал это на пальцах если в деталях то надо Ну долго рассказывать как конкретно это делается О'кей спасибо так Так давайте двигаться от задних рядов к переднему Да вот прямо сейчас Здравствуйте спасибо за доклад у меня вот такой вопрос а на чтение там нужно самому всё делать Или он тоже позволяет ваш продукт запрос обработать Я не понял вопрос Ну ти вот смотрите тексте балансировки запросов ой балансировки данных смыс Ну у вас же данные шардирование для такого типа у нас решение заточено на Ну для одх запросов Да новых запросов мы ей не занимаемся очень активно мы занимаемся Да у нас как бы есть в планах идеи Как можно было бы такое поддержать но пока типа зачем мы пока не хотим И вот второй ещё вопрос В связи с этим А есть решение там ну похожие там citus db там pog Excel и там ряд други нет похожее наверное будет vts да Похоже из похожих будет vts и Это буквально спур только для Куля мы Ну Кирилл что-то писал писал получился они шарди тоже дадада каким-то образом А чем Вот ваше решение лучше оно не лучше просто ничего не было И вот появилось вот всё Ну в смысле цитс работает Знаете вопрос о чем ваше решение лучше он Ну а как на него можно ответить тем что оно наше Ну а почему вопервых Давайте этот вопрос сейчас мы обсуждать не будем можно ещё так сказать у других технологий есть существенный минус Они не написаны в Яндексе наши технологии написаны в Яндексе поэтому как бы вот не Спасибо Да привет ребят Спасибо за доклад как я понял вы объяснили что когда происходит запрос с какой-то Мета информацие на создание таблицы Ну вы попробуйте сделать максимально возможное что в ваших силах Ну может не получится А что если в spqr прилетит запрос с транзакцией вы эту транзакцию начнёте на всех Шарх или как Ну да как бы и всё будет очень плохо Ну мы сечас о сломается Да но будет работать просто медленно Видимо как бы там best of как бы у тебя будет транзакция которую ты отправляешь на первый шарт на второй на третий где-то там что-то не закоммитить Ну блин сорян если ты хочешь создать Типа если ты хочешь создать таблицу мы предполагаем что ты будешь как бы сам катать себе по всем шардам миграцию пока что так А если я хочу транзакцию отправлять Ну у меня транзакция на один шарт но я шлю запрос как бы если если транзакция попадает на Один шар то всё прекрасно вообще но вы её создаёте где где вы начинаете Ну где вын комит делаете на всех Шарх или на одном Вы ведь заранее не знаете на какой шарт прилетит запрос да да типа приходит бегин Вот это кстати прикольный вопрос приходит бегин мы такие типа О'кей круто Потом приходит первый запрос этой транзакции мы его парсим там типа есть допустим CL там по ней можно понять На какой шарт она отправится и вот в этот момент мы начинаем транзакцию на удалённом шарте то есть до до первого запроса типа ничего не происходит пока не можем понять куда отправить запрос Ждём Как только понимаем отправляем може клиенту сказать что типа ты начал транзакцию Хотя по факту Нет ну это не проблема Всё супер спасибо спасибо за доклад у меня здесь вот два таких Ну это фактически один и тот же вопрос д года назад я тоже был на лоде и с большой сцены рассказывали про Ну он фактически решает ту же проблему Но наверно более масштабно зачем разрабатывать новое Нет я понимаю что вы Яндекс и поэтому вы разрабатываете что-то новое но у вас уже в Яндексе есть что-то новое что решает эту же проблему и второй вопрос здесь а вы говорите что меж шардов запросы делать не нужно но как бы а если хочется то делайте на стороне бизнес логики Но зачем тогда нужен СКР Если всё равно нужно делать на стороне бизнес логики Не ну многим людям в действительности нужен СР есть как бы конкретные люди которые ну которые пишут такие за кото реально можно отправить на Один шар у ни в бизнес такой особенный тип сервисов которые хорошо шарди которым не надо делать такие запрос таких сервисов их нормально 9% отличный пример яндекс-почта вот в Яндекс Почте написано своё шардирование и там ключ шардирование - это ID всё мог бы подойти для Яндекс лизан с того что там в почте Ещё где-то ещё где-то среднее решение между всеми что уже написано Ну и плюс мы у нас есть вот человек которому я ну типа он там в аспирантуре учится мы с ним будем разрабатывать мультиш дово запросы но как бы это так это просто Тема со звёздочкой и для начала Мы решили этого не делать как бы вот ребят Привет Спасибо вам большое за доклад было очень интересно а такой вопрос интересный А на какой коленке именно был сделан скор вообще там получилось так что Андрей Бородин написал какую-то штуку чтобы постирочная умеет слушать короче порт по по протоколу пост греса А я в то время писал испур только на чистом си я очень устал и решил что вот типа напишу прототип вот на го вот и пока пишем Ну просто типа го модный как бы синий модный вот там такая логика была Привет Спасибо за доклад когда просто это тоже хорошо на самом деле А у меня два вопроса коротких первый поддерживается ли отмена запросов вот эти бинарные пакетики типа Отмени Вот это Запроси вот а второй вопрос получается у вас вот э па в том числе выступает как баунсер в той части что он имеет несколько котов стримам имет Ну да есть cancel кстати не тривиально было поддерживать у нас стажёр не справился потом сам написал Вот как бы SP он не какер как Одиссея у него там архитектура слиза практически вот так вот Привет Спасибо за доклад Я возможно кое-что прослушал Я хотел спросить как конфигурируется по какому ключу В итоге будет шардирование и можно ли настроить по нем ключам то есть чтобы какие-то данные по одному ключу рвались а ещ может быть другая табличка по какому-то другому ключу мы сейчас работаем кстати в этом направлении У нас есть целый клиент который именно эту фичу попросил и прямо сейчас наш стажёр её напишет Вот ну он её написал уже Он уже написал Да там есть много способов указать как конкретно ты хочешь роваться Да основной изна способ говорило е у тебя в запросе написано типа Sid ра 7 всё Ты руь по ра и то какая именно эта колонка ты это создаёшь Конфи там было типа и так далее вот типа Это основное Первое правило Ну типа самое простое Что можно сделать ты можешь дальше типа мы написали улучшение Ты можешь в комментарии написать типа пофиг какой запрос Мы тоже кста не сказал об этом действительно можно не только из самого запроса понимать на какой шарт но и просто в комментарии приложение может указывать ключ шардирование ещё ты можешь делать Set SPAR sharding K2 типа 7 и после этого жахнуть свой Запроси то есть там есть много способов сказать что конкретно надо сделать вот можно я ещё добавлю фича которая условно половину базы шарди по таким правилам а другую половину шарди по другим правилам условно эти таблицы так эти таблицы так это называется dataspace и она сейчас почти замёрз Это первое Второе условно Бывает такая ситуация когда в одной табличке колонка называется ID в другой табличке называется User ID но по факту Это один и тот же ключ и мы это тоже понимаем это тоже можно задать Да так коллеги я боюсь что ещё три максимум четыре вопроса и время наше кончится Привет ребят Как часто вы думаете о Римской империи Дада значит sar это stateless pog quy rter stateless - Это неправда Да по - это правда quy - это ну наверное не правда роутер тоже не правда потому что там больше чем роутер но мы просто вот у нас флаг висит в офисе мы не знаем как называть новые проекты всегда какой-то бред получается да Ну вот Одиссей там был теперь когда я выиграл Приз за лучший вопрос второй вопрос вы не думали свой роутер использовать не для рнга а такой реализовать То есть если есть в запросе инсерты апдейты тить на мастер А во всех остальных случаях на один из славов Вот это кстати там недавно замёрзли по-моему неделю назад такую фигню ты можешь на один порт приходить с запросами которые всегда пойдут на реплику Да вот А ещё ты можешь в транзакциях сказать Типа се что-нибудь там не помню что типа И тебя тоже будет постоянно комментарии уть Вот это тоже можно сделать буквально можно в комментарии указать на Мастер и на реплику запрос отправлять Просто ты не можешь по запросу на самом деле сказать что это апдейт у тебя может быть типа Select My function короче а там внутри update лежит Да Пожалуйста Спасибо за доклад я правильно понимаю что ваш ваша целевая аудитория - это oltp системы и в основном запись Ну запрос на запись и вот мой вопрос связан с запросами на чтение там есть две большие проблемы это агрегаты и джоны вот и вообще хотите ли вы ээ развиваться в эту сторону какой roadmap и будет ли это новый нпм или это что-то сильно проще Можно я про нпм ltp да А мы метим в то чтобы все запросы оказались внутри одного шарда что у тебя там внутри дальше происходят запросы нам неважно можешь Джони всё что угодно в рамках одного шарда пожалуйста Удачи тебе roadmap такой э вот есть какое-то решение которое вроде как прикольно ну на словах То звучит вроде круто да и аналогов Нет вот мы пытаемся сейчас из этого сервиса собрать вот наш roadmap чтобы в Яндекс облаке можно было в этом постере нажать кнопку шардирование вопросы два вопроса простенькие наверное Но получу ответ сразу что с индексами они также будут через балансировщик сразу на всё создаваться и поле JB оно также поддерживается из в коробке как все остальные поля или какие-то отдельные пляски нужны спасибо Ну да и да потому что ну типа Нам же всё равно что ты напишешь Create Table или Create ind наш парсе рапарт это как к что-то и типа поехали да всё что происходит внутри шарда дело самого шарда нас это не волнует там будет индекс на каждом рде будет свой индекс в целом Да так есть ли ещё вопросы у меня есть собственный вопрос я бы его задал если можно вот я весь доклад страдал Где же ST Почему вы не переименовали его в State А блин А вот обманка случись говорит что вот спкр это вот так вот так вот так это Ложь Это ложь это Ложь Это ложь Всё спасибо Так а последний вопрос Давайте и дальше дискуссия переместится в кулуары Да спасибо за за доклад маленький совсем вопрос просто не услышал А мы же говорим про словарное шардирование А где Собственно сам словарь э да хранится Угу Ну может А ну вот там есть Такая сущность координаторов внутри координатора запущена база данных которы ну там на слайде было qdb которая так вот справа сверху где-то приплюснутой собственно всё и хранится Ну собственно на все сервисы Да поднятые по Ну роутер запускается у него в памяти хранятся правила есть в памяти роутера и они ещё есть в базе данных и в базе данных Да менять ты их будешь через координатор да и ну как бы в догонку А мы говорим про какую гранулярность про диапазоны либо там вплоть до конкретного значени то есть пра можно указать типа один ключ Ну это работает Ну окей спасибо Так Спасибо коллеги сессию вопросов и ответов мы продолжим в кулуарах настало время выбрать Два лучших вопроса мне про бегин понравился во мне тоже прогин понравился Ну ты давай тогда что-то ещё Выбери ну вот человек про спросил Может это мем из тиктока про римскую Империю Ну давай Да мем из tiktok тогда вот будет такой подарок А про бегин будет другой подарок вы пожалуйста к нам сюда получите пожалуйста подарок из рук нашего волонтёра спасибо спасибо коллеги Спасибо докладчиком это прямо хорошо погнали погнали"
}