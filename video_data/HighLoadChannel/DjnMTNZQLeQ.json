{
  "video_id": "DjnMTNZQLeQ",
  "channel": "HighLoadChannel",
  "title": "GraphQL: простая schema провала, или Серебряная пуля для ваших ног / Иван Решетин (Юла, VK)",
  "views": 287,
  "duration": 2426,
  "published": "2023-10-06T07:23:57-07:00",
  "text": "Всем привет Меня зовут Иван решетин Я руководил командой быкан платформой ввели более трех лет и я внедрял граф quel Давайте об этом обо всем поговорим иди доклада появилась после многочисленных вопросов коллег о том Стоит ли внедрять графкель в их проекты но однозначно ответить на этот вопрос нельзя потому что нужно учитывать просто огромное количество факторов и сегодня в этом докладе я расскажу как же принимать решение о том нужно ли вам внедрять график проекты или нет я не буду сегодня предлагать альтернативу доклад вообще не про это я не буду рассказывать и учить вас как его надо готовить об этом есть очень много прекрасных докладов коллег можете с ними ознакомиться и конечно я не буду критиковать саму технологию Она прекрасна Давайте буквально коротенький курс за одну минуту что такое графкель графкель это язык запросов запросов от клиентов центральное место в понятие городке занимает схема вы описываете свои ресурсы свои данные такой схемой описываете как они называются как Они между собой связаны какие у них поля есть и клиента опираясь на эту схему могут делать запрос на бэкенды просто перечисляя Какие ресурсы им нужны какие поля и все собственно все это вот очень простая очень легкая технология вспомню чуть эти преимуществах графки вам позволяет из коробки получить типизацию вашего IP версионирование документирования Это действительно очень упрощает разработку также клиенты могут запросить в одном запросе сразу несколько ресурсов это тоже действительно очень полезно и позволяет клиентам получать только то что они запрашивают и если посмотреть на все эти плюсы они в какой-то степени про экономию экономию ресурсов ресурсов разработки ресурсов железа и как гласит народная мудрость чтобы сэкономить ресурсы надо потратить ресурсы Давайте попробуем вместе разобраться Может быть там стоит чуть-чуть потратить и потом как мы начнем экономить сразу Да этот путь к правильному решению я разбил на 4 шага это объяснить зачем вам это надо провести технический аудит вашего проекта подготовить команды Ну и собственно согласовать все это хозяйство с бизнесом давайте начнем потихонечку попробуем пройти быстренько этот путь и так Объясните Зачем сформулируйте какую задачу вы решается Что конкретно у вас болит вывернитесь у вас много версий API Вам приходится их постоянно выпускать и это плохо для вас может быть наоборот у вас раздутые ручки универсальные для кучи разных частей вашего приложения из-за этого вы долго отвечаете Ну это наверное действительно Да плохо может быть вас наоборот куча запросов там с одной страницы одного раздела вашего приложения и вас это тоже беспокоит возможно сформулируйте задачу какую вы решаете второе Оцените Какие потери у вас сейчас прям в цифрах что вы сейчас теряете Вам приходится много версироваться и вы там каждый месяц выпускать новую версию там каких-то ручек и вы теряете 1-2 дня ресурсов разработки Окей Запишите в цифрах сколько вы теряете Либо наоборот да у вас универсальная ручка на все и она обросла ненужными данными и вы замедляетесь насколько насколько вы ускоритесь если выберете ненужные поля Запишите и посмотрите альтернативы я не про другие технологии Я вот про то как еще можно решить конкретные вот эти ваши проблемы может быть Вам надо кинуть больше железа нанять больше разработчиков может быть в принципе какие-то другие подход распилить ваш медленный Монолит на сервисы использовать другие базы данных Подумайте как еще можно решить ваша задача после того как Вы сформулировали зачем Давайте проведем технический аудит вашего проекта нашего проекта начнем мы конечно с бэкентапе посмотрим что там есть рассмотрим простой пример пример простой такие примеры можно найти в любом Проекте в качестве любого проекта я взял юлу Итак у нас есть два раздела Первое это Лента товаров в которой пользователи ищут интересующие вот товары выбирает может провалиться внутрь и посмотреть полную информацию об этом товаре и информацию о пользователе который его продает а здесь же используются одни и те же сущности Давайте назовем их продукты юзер и там и там используются продукты юзер для ленты для карточки товара Но для ленты нужно чуть-чуть полей для карточки нужно все поля вся информация и кажется что это отличное место для того чтобы начать внедрять графель вот этих разделов Давайте проведем такой мысленный эксперимент как бы мы переводили наш API например на вот этом примере на графике Клик Спасибо Итак у нас был рест и здесь я сделаю сразу оговорку под словом rest Я понимаю оптимизированный rest То есть это ручки которые отдают сразу все данные для какого-то раздела У нас есть ручка Fit которая клиент запрашивает соответственно для получения ленты ручка продуктов с юзером и давайте тоже для примера представим что у нас Монолит на быкандах это монолитно PHP Ну просто для примера Итак для того чтобы внедрить grafql Самый наверное простое решение это было бы внедрение аpega и твоя графеля пиги твоя это маленький легковесный тонюсенький сервис на гошке Ну давайте на гошке возьмем там стандартной библиотека ничего делать не надо прям вот чуть-чуть маленькое Тоненькая от клиентов для того чтобы перевести карточку нашу полную карточку продукта на графике создадим простую схему с двумя типами продукта юзер у нас вложено поле для продукта сделали вообще работает ну типа все типа Все здорово но что будет когда клиент вдруг для какого-то другого раздела захочет запросить только продукт Ну да он получит в ответ только продукт но запрос через аппетии Твои под капотом пойдет в ту же ручку где у нас собирается юзер и Это верхоты мы так не хотим конечно правильней распилить нашу ручку по доменам отдельно продукт это отдельный юзер в этом случае получаем все красиво запросили только продукт получили только продукт запросили продукты юзера запросили продукты юзера но запрашиваем то мы карточку товара по ID продукта то есть запрос у нас приходят на пиги твоей делает запрос продукта иди за продуктом достает его и идет уже с ID пользователем за пользователем мы получаем 20 синхронных запроса Ну да у нас и раньше был синхронный запрос в базу ну так у нас сделано но теперь-то мы получили два синхронных запроса в Монолит PHP Конечно мы очень сильно замедлимся в этом случае что делать Давайте перепишем все на микросервисы вот эти две ручки вынесем в микросервисе напишем их на кошке они будут быстро-быстрые и давайте я не буду рассказывать про то что стоит вынести две ключевых сущности из Монолита микросервиса в этот момент мы сделаем такую как в кино склейку монтаж выпилим два месяца разработки и предположим что мы это уже сделали все у нас есть продукты юзер это отдельный микросервисы быстро отвечают и возможно мы даже ускорились классно Давайте переведем ленту для этого мы расширяем нашу схему позволяет версионироваться все круто и запрос идет через нашу ленту вообще Все великолепно но мы все сломали потому что этот контракт где у нас Лента является массивом продуктов обязывает нас что мы должны уметь отдавать полный продукт Но в отличие от ручек продукты юзера где данные берутся из какой-то базы ленту нас собирается деморализованным хранилищем селастик в нашем случае это отдельное хранилка и как правило большинстве проектов такие индексы поисковые содержат только те поля которые нужны в Ленте что-то не клеится Давайте здесь остановимся прервём наш мысленный эксперимент по переводу и на секунду задумаемся столб у нас был два простых раздела в приложений У нас есть невероятно простая технология и что-то нам пришлось тут половина переписать микросервисы вообще Мы тут с лентами вообще все разломали Почему Потому что правильно все логично Потому что когда надо помнить вы натягиваете rest особенно rest в кавычках натягиваете список награф сделать это один к одному Ну зачастую невозможно довольно часто приходится что-то допиливать Но ничего страшного в нашем случае большой беды не произошло то что нас не хватает в Ленте до полного контракта мы можем легко дополнить наш там поисковый индекс что у нас будет под капотом мы можем замедлиться ну это другой вопрос Либо мы можем просто пересмотреть архитектуру нашего поиска не знаю отдавать айдишники обогащать их через dataloader и Grow quellet все позволяет Но это надо делать прям делать либо можно ставить Волшебный Костыль и отдавать в Ленте только до полного контракта давать дефолтвейлеру я не призываю делать костыли ни в коем случае это плохо Я просто озвучиваю вариант решения их Конечно намного больше случае если у нас вот этот оптимизированный rest ну да правильно распилить это все на микросервис вы распилить по доменам но опять же надо смотреть конкретный проект и конкретно реализацией того что под капотом Фуф Ну мы сделали мысленный эксперимент на двух наших разделах Теперь давайте сделаем эксперимент продолжим эксперимент на всех наших на весь остальной наш Бэкон тапе давайте это в качестве домашнего задания предположим это все сделали мы понимаем в каком состоянии У нас сейчас находится бэкент там что хорошо там надо может быть что-то распилить допилить за рифачить Окей посмотрев на Back and переходим к клиентам техническим Что происходит со стороны клиентской разработки и первая здесь нужно понять клиенты все готовы перейти сейчас на графикель нет лисы страны со стороны клиентов каких-то блогеров может быть нет библиотек может быть вряд ли Да может быть архитектура конкретного клиентского приложения не позволяет вот прям сейчас взять переехать на Граф ql если это так а проект решает переезжать на grav ql А кто-нибудь например веб не может по той или иной причине мы обрекаем себя на поддержку двух протоколов то есть мы уходим с рэста на графике и получаем бывает второе надо вспомнить про старые клиенты довольно часто мобильное приложение Android iOS не имеет Форс апдейта и у вас в проекте в принципе есть поддержка очень старых клиентов которые до сих пор не обновились в этом случае Вы тоже обрекаете себя на поддержку двух протоколов конечно в тех ручках не будет нового функционала Но как минимум держать их для ответа готовыми или там фиксить баги все равно придется И третье о чем надо помнить клиентской разработки это собственно сама разработка Как происходит разработка клиентов вот речь про вашу деф средуэль это схема схема как правило предоставляется бэкэндом Как клиент На вашем ваши Dev среде будет получать эту схему там для своих кодогенераций для того чтобы разрабатывать этот функционал вашей среде А как это будет выглядеть когда у вас 5 бэкендеров делают свои версии и 5 разные версии схемы совсем разные и 5 клиентских разработчиков должны каждый это поддержать как это все реализуемо просто нужно в этот момент посмотреть на вашу среду а как у вас происходит разработка Может быть там все мастер сразу бывает и в контексте клиентской разработки конечно нужно не забывать про коа потому что они в контексте игроки или тоже являются клиентами в среде и все что сказано выше ровным счетом также относится и для автотестов а как они получают схему надо им получать схему Можно ли фримворк автотестов которые вы используете вот здесь и сейчас затащить нет ли блокеров и в конце вот такого всего технического аудита когда мы прошли и бкнд посмотрели на клиентов посмотрели в среду придумали Как реализовать Может быть там все уже хорошо игра в Кейн легко заходят у нас должно получиться примерно схема всего нашего приложения какие у вас есть сущности как они связаны между собой откуда брать данные для этих сущностей и вы поймете чего вам не хватает для успеха может быть надо кинуть железо как минимум там аппетит Фэй надо где-то разворачивать надо вам железо это не надо может быть для дев стендов что-то вы поймете примерно масштаб рефакторинга того что там надо распилить допилить вынести И это не только со стороны бэкенда все еще раз То же самое относится и клиентской стране вот в этот момент вы понимаете размер той огромной работы которая вам предстоит для перевода на gravkl Определите дефинишного данных Определите Что вы хотите переводить что нет что Составьте план что вы будете переводить в первую очередь вторую третью можно поставить точку невозврата после которого до которой точнее еще можно откатить весь эксперимент по внедрению и Оцените затраты прям тоже в цифрах Сколько нужно сторипоинтов там человека дней со стороны разработки Нужны ли дополнительные деньги на железо и еще может быть какие-то затраты вам придется понести приведя технический аудит примерно понимаем масштабы того что она предстоит делать переходим к подготовке команд но команда тоже есть у нас самая же лучшая команда на рынке что ее готовить она все умеет Да она все умеет это действительно лучшая команда на рынке но Она же что-то делает у него же есть какие-то задачи они сидит чай не пьют и с переездом на Граф Киль добавляется чуть-чуть новых задач Надо подготовиться во-первых это новые задачи которых раньше не было И это первое это проектирование схемы Но мы же только что вот в API схему делали что-то почти но нет Там мы поняли какие у нас сущности есть здесь надо уже выстроить финальную масштабируемую схему смысле масштабируем крафт или так версию вообще все хорошо универсанируется когда и хорошо версионируется Когда нужно расширить схему добавить поля и Давайте на пальцах помните пример про ленту лент Лента продуктов простая сущность это массив продуктов но логично Лента продуктов массив продуктов надо расширить добавляем в продукт новый тип не знаю цена в УЕ или что-нибудь еще вроде все просто Что будет если через три месяца к вам придет продукт менеджер и скажет А давай на вместо пятого продукта поставим аватарку нашего любимого пользователя который будет вести на его профиль В смысле у нас же ямка продуктов у нас массив продуктов какого пользователя куда его вставить А если он еще через три месяца придет и скажет Давай вместо десятого продукта поставим вообще какую-то сущность которая в принципе сейчас еще нет вот в природе позволяет это все делать у него есть типы интерфейсы юниуны я не призываю опять же пихать куда ни попадя юнионы но на этапе проектирования схемы об этом надо помнить и понимать Как будет развиваться ваш проект дальше и проектирование схемы на практике занимает довольно большое количество времени второй эта разработка gitway Ну вот это вот тоненький сервис на гошке из одной стандартной библиотеки Да но со временем особенно если не идеальный проезд это тоненький Тоненькая прося начнет обрастать бизнес логикой это очень плохо но такое бывает и это должен кто-то поддерживать Ну и собственно доработка всего остального функционала которого там себе нафантазировали и со стороны клиентской разработки со стороны бэкенда примерно весь интернет переписать второе о чем надо помнить в командах обучение неожиданно когда ты кидаешь в разработчика ссылка на документацию говоришь А давай завтра ты будешь все знать такой подход не работает Ну он и так занят чем-то другим ему вот этот ваш кель не сейчас Но на самом деле неожиданно прекрасно работают приведение внутренних этапов какие-то встречи в совместный просмотр выступлений обсуждение проблем которые возникли у коллег которые уже ввязались в это и поделиться опытом Те кто уже наступили на грабли подводные камни и так далее они могут поделиться своим опытом негативным опытом с коллегами которые только Это предстоит а также это позволит рассказать о новых подходах проектирования вообще вашего API если раньше в rest мы могли вот так вот добавить кучу полей не париться по этому поводу совершенно то теперь у нас схема которая может затронуть всех и добавить что-то куда-то надо хорошенько подумать принципе для этого и можно есть прекрасный орган архитектурный комитет про него говорится наверное с каждого утюга где говорят про график Я тоже сегодня утюг говорю про комитет это может быть отдельный человек отдельная команда виртуальной команды из лидов там ваших ваших разработчиков которые помогут проводить ревью всех изменений схемы это очень важно что любое изменение схемы даже добавление маленького поля должно проходить review еще до этапа разработки и ревью схемы review кода это разные этапы еще Да конечно архитектурный комитет Это просто стандартизацию вообще всего что касается там вашего графика ошибки нейминге типов их структурирование в общем вот всего каких-то общих подходов ой последнее теперь собрали объяснили собрали подготовили идем к бизнесу договариваться и когда мы договоримся с бизнесом конечно нужно рассказать о тех рисках которые нас ждут тех проблемах которые будут и открыто об этом говорить во-первых от тех долг сто процентов действительно с переводом первый самый ручки на графике вы получаете всё ваше приложение видите долго которое нужно переводить Ну всё то что вы определили в виде финишного данных там несколькими шагами выше и с этим тик долго надо как-то работать какая-то культура работа с их долгом должна быть на уровне всей компании и понимать это второе это увеличение Маркет здесь про то что как минимум у нас не хватает сейчас экспертизу всей команды особенно этапе переезда экспертиза в работе с гравюэлем также любое изменение крафт KL требует превью и то есть Сначала мы реджект опять запрос вот а пруф идем разрабатывать это все так же иногда чуть-чуть иногда очень сильно увеличивает время поставки в фичи пользователям и также договариваемся о фиче фризах когда мы переводим какой-то большой кусок на графикель и там происходит какой-то возможно глубокий рефакторинг вот все фичи в старом коде надо новые фичи в старом коде Надо остановить пока переезжает что-то на графике очень желательно разные ситуации бывают понятно но очень желательно остановить разработку в старом коде Потому что когда выкатиться Новый наконец-то вот сделали графики окажется что в старом вас добавились еще какие-то фичи при этом перетащить это Новые поля которые невозможно сейчас переехать фичу фризы иногда очень нужны Да договоримся про обучение выделяем на это время и тоже не только про тех кто учится Это понятно но и тех кто из команды будут помогать и обучать коллег потому что подготовка одного пусть даже внутреннего небольшого метапа может занять там 1-2 может быть больше дней Ну и там обсудить новые инфраструктуру которую нужно это сейчас тоже могут быть проблемы Но Ну вроде рассказали но теперь самое главное что же мы получаем а мы получаем все то что мы писали в первом шаге что-то там про один-два дня разработки или что-то там миллисекунды мы какие-то Ну давайте честно в разных проектах это действительно мы рассмотрим только один пример и в разных проектах вот эти за и против могут быть свои очень сильно зависит от того в каком состоянии сейчас находится проект и на этом этапе очень важно оценить вот эти вот риски и проблемы с тем профитом и тем временем когда вы этот Профит планируете получать то есть когда вы полностью переезжаете на гравюль если ваш Профит не так Если вас устраивает тот временной промежуток через который вы начнете получать Профит и он перекрывает те затраты которые вы будете это время нести то ответ для вашего проекта Да можно переезжать Если же вы понимаете что вы получаете Профит от grapq или через 100500 лет и вас это не устраивает то наверное не стоит рассматривать для переезда собственно вот ответ Давайте перейдем к выводам Какие же выводы вообще вот за два дня конференции куча докладов вот эти вот детали цифры схемы вообще уходят из памяти и хорошо если слушатель выносит одну две три там главных идеи этого доклада Давайте три главных тезиса О чем мне очень хочется вам рассказать Первое grav quel это сложно но можно можно Если вы понимаете Зачем можно если вы понимаете сколько это стоит И можно если у вас есть на это ресурсы второе Профит будет от графке или несомненно будет Профит и вы его получите тем быстрее чем лучше ваш процессы в команде чем лучше команда общаются друг с другом чем идеальный ваш архитектура тем быстрее Вы получите этот Профит И последнее Граф киви это действительно серебряная пуля которая решает много проблем Берегите ноги Берегите себя принимайте правильные решения Спасибо можно там по qr-коду комментарии лайки колокольчики все дела Спасибо так есть номер один пока вот передают передают микрофон преподавателя я тебя как студент студенты хочу спросить а хэппи-энд можно было в докладе дать или ты вот клиент можно сложно но можно это был хэппиант Какие кейсы которых вообще имеет смысл использовать вместо какого-нибудь там и прочего Ты хоть один можешь представить давай спасибо на этой паузе остановимся Замечательно спасибо большое Я думаю я тебе ответил День добрый Спасибо за доклад Вот вы говорили что в самом начале прихода нужно ставить вопрос зачем можете сказать Какой ответ вы на него дали и был ли Профит Вот спасибо как бы так без спойлеров и без мата Да и нельзя да Ну как сказать нельзя знаешь Отвечай на вопрос Это был Давно и давно и правда за гравке отвечал я в свое время давно и я его внедрял и когда ты видишь упрощай этапе запрашиваешь только то что можно Моники сервис начнем вот какой профиль собственно все эти плюсы которые озвучивает все но мы когда внедряли мы на самом деле не ожидали тех огромных затрат ресурсов которые в итоге несут за собой чтобы переехать в нашем случае довольно много пришлось переделывать и мы вместе с этим Кроме того что мы внедряли распиливали потом дошли до Федерации можно посмотреть доклад есть прошлогоднее еще и Ну Профит мы получили Но кажется что между нами можно было этот Профит получить безграмотные в нашем случае Профит был в том что мы переписали нам пришлось переписать Половину бэкенда нам пришлось переписать половину мобилок мы действительно ускорились нас график наш успех вот стрелочка вверх вот Но Был ли он благодаря графиню да Ну вот немножко не прямая да да вот симанов Александр в чате как раз и пишет Вот вот сейчас как начнем А через год куда мы попали нормально друзья еще вопросы комментарии рекомендации вот пожалуйста да раз и потом два Спасибо за доклад Вопрос такой мы говорим про переезд про его цену А вот если начинать с нуля а если смысл начинать с Граф карель сразу и Почему это почему это может быть оказаться ошибочным решением в итоге Слушай кажется вообще жизнь редко учит нас с первого раза Я бы да новый проект Ну я бы всерьез рассмотрел у нас стартап в поле я бы рассмотрел вариант потому что мы не знаем как будет дальше развиваться наш приложение и на этапе вот стартапа когда запустить кажется что внедрять здесь потребует мало ресурсов но потом получится этот буст когда начнет разрастаться что-то выпиливаться что-то добавляться Главное вот не отстрелить себе конечности неправильным проектированием схемы это вот прям очень важно да да не знаю ответил Нет тут а вот это у нас сегодня традиция что следующий выступающий спикер обязательно должен задать вопрос Да пожалуйста Давайте тот первый а вот хорошо отлично Да тут просто фонарь и без руки не видно Да пожалуйста Привет Спасибо за хочется узнать как ты продавал бизнесу именно переход на графель поподробнее Потому что ты написал то что процентов увеличится там томаркет как это продалось это бизнес чуть-чуть про доклад я скажу момент вот все что было описано Это не из книжек или вот типа сказать это вот почти все пункты которые так или иначе выстраданы слезами потом команда разработки как продавал легко тут есть вот классные технологии мы сейчас как ускоримся во минус есть не вообще никак никто не говорит Все говорят идеально надо внедрять Вот тут доклады 20 штук Я посмотрел вот все говорят надо внедрять делать легко окей пошел внедрять До сих пор в чате кто-то пишет Зачем Граф ql если уже есть о дата Нет это риторический Я не сравниваю здесь вот здесь только пока Это не вопрос быстро микрофон работает да Привет Проблема внедрения схемы она очень понятна я у себя в компании внедрил внедрили Open API и его любиме за его простоту То есть это такая штука которая когда тебе когда у тебя программист не может сделать Сложно даже если очень хочет у меня просто нет таких инструментов чтобы усложнить и получилось что у нас продакты могут нас продакт пишет говорят схемы без этого его просто не поймут и между между отделами тоже такое может быть вплоть до того что руководство например начальник отдела продаж тоже может пойти какие-то вещи пока не слил Это видео понапе запросы это всё ещё болталка вот вопрос Вы до такого уровня успели дойти или Граф quel слишком близок программистам чтобы быть понятным например продак то тех писаю или начальнику Слушай в нашем случае граф-кюль далек от продуктов Ну конкретно в нашем случае от там руководителя отдела Нет он как раз очень близок именно вот там другому другого отдела не твоего другого отдела какой-то какой смысл вопрос тогда что другое дело ставят задачу про новый когда я говорил про новые задачи у нас графкель внедрял одна команда это была команда платформа и являлась софтером собственно всего этого всего что касается вокруг графюэля в нашем случае не было проблем шеринга между другими командами были случаи когда точнее Вот когда это все внедрилось и там какая-то схема нарисовалась какие-то подходы приняты другие команды тоже начали внедрять и они просто вот приходили к нам или мы приходили к ним и вместе обсуждали что нужно получить такого чтобы какая-то соседняя команда делает запрос фичеры квесты или Да там за изменение схемы я не припомню У нас очень разделены по доменам это охрененно удивительно когда болтовня начинает превращаться в мир схему и когда команда когда три месяца обсуждается детали думали то что сейчас это за два часа написали ТЗ и ушли а потом выясняется что три месяца уже был как бы уже вокруг бьются разгребая предметную область и она на самом деле вот гораздо сложнее чем казалось Понятно Если у вас такого не было да вот почему вы не отобрали микрофон столько вопросов задал Спасибо большое Иван Кому мы подарим твою подушку мне вот понравился там отлично Всё спасибо Спасибо большое красавица"
}