{
  "video_id": "77_q0cCw9oU",
  "channel": "HighLoadChannel",
  "title": "Танцующий кластер / Алексей Чижков, Дмитрий Васильев, Михаил Кулагин",
  "views": 284,
  "duration": 1515,
  "published": "2017-04-09T09:37:13-07:00",
  "text": "я так понимаю что можно начинать меня я надеюсь слышно хорошо меня зовут алексей чижков я работаю в той же компании которая называется позагорать professional наши лучшие люди али болтунов и федор сигаев вместе с александром коротковым были уже здесь вы на них смотрели и слышали о том что что кластер с multimaster най конфигурации в принципе по грязи будет но не прямо сейчас но в компании по 1 professional есть не только разработчики но также инженеры я например я системный инженер и сетевой инженер и и такую задачу как кластер для пазлы рация естественно решал сейчас я расскажу о своем опыте что мы знаем и видим ну дело в том что что тема кластеров и тем более кластеров возгорелся она очень неоднозначно есть довольно много мнения о том каким должен быть класс что он должен сделать какие особенности по отказоустойчивость он должен выполнять я каким-то образом промахнулся у слайд но это не так страшно вот вот пускай то которым я говорю естественно тех все хотят от кластер cbd чтобы он был во первых очень надежным и не просто надежным а позволять и failover и switch over обеспечивать высокую доступность с минимальным down the римом кроме того поскольку мы говорим здесь на конференция высокой нагрузке очень важно чтобы мы имели возможность сбалансировать распределять по узлам сегодня под грейси мы можем довольно спокойно распределять нагрузку на чтение сделаем новое синхронных реплик распределяем понизить нагрузку и таким образом мы масштабируемся в этом случае поскольку нагрузки не бывает постоянно я все время растет необходимо иметь возможность масштабироваться что такое масштабирование все вы знаете что масштабирование она бывает и горизонтальным и вертикальным вертикальное это когда вы ставите взамен слабо узла более мощный узел а горизонтально и масштабируем когда вы намного узлов распределяйте нагрузку ну естественно любой заказчик хочет чтобы наш кластер он был максимально живущий надежно ну а насколько живуч надежно то придумайте сами сейчас важно сказать несколько слов о точках зрения разработчика решений все разработчики кластером от решений так или иначе сталкивается с тем что существующие фромборке plaster мы и стеки так называемые они все внешние для poses и позже сам не имеет внутренних механизмов для кластеров и организации ну естественно поскольку они все внешние особой любви обслуживания всяких фич возрастов коробки нет блестящая фишка postgres это потоковая репликация вы можете иметь несколько узлов включить между ними это потоковую репликацию и при этом мысу злой не будут выполнять вот эти три роли которые здесь на слайде указанных первую очередь это естественно master 1 синхронная репликой асинхронный реплика их может быть очень много у меня не работает кликеров так вот четкий работает в общем так или иначе все кластерные стыке они подходят для поздравь их многом мы здесь в рамках этого доклада разбирать их не будем поскольку это отдельная тема и не 40 не 30 минут нам на это не хватит нам важно знать если вы сами разрабатываете решение и пытаетесь что-то выбрать знать две вещи во-первых все кластерные стыке одинаково хорошо подходит если они поддерживают роли узлов об этом вот только что говорил алексей с предыдущем докладе исключаю самого страшного врага которая называется с придумаем давайте поговорим о том что такое сплит боинг в общем так или иначе для системных администраторов я говорю сейчас очевидные вещи но все таки для того чтобы охватить более широкую аудиторию лучше об этом рассказать что такое кластер в дата-центре это множество узлов установленных стойки все они находятся в какой-то достаточно связанные сетей и кластер никоим образом на потерю ты связанности не рассчитан вот собственно где ситуация с при drain синие узлы разделились красными как это произошло мы не знаем может быть тот в маршрутизаторе случилось системные администраторы данный момент разбирается на красную звук заодно момент у нас существуют сами по себе синий узлы сами по себе ну примерно так синий ничего не знают о красных красного естественно ничего не знают о синих ну раз уж мы заговорили о спреем давайте поговорим чем он страшен для для кластера под газ очень много говорит о том говорят о том что очень сложно смерть данные из двух мастеров если они вдруг у вас разделились если вашей базе появились два мастера оба при оба этих узла принимают соединения вот то в принципе какой-то double может быть и справиться с этим но есть высокая вероятность что это не получится по крайней мере я не знаю ни одного дуба который возвращался из плита с мир джим данных через 10 15 минут при высокой нагрузке в общем это потерянная ситуацию вам всю базу придется откатывать назад то есть и ну естественно мириться с теми проблемами которые произошли дело в том что существующий кластер нам стеках давным-давно уже придумал механизмом для борьбы со спид браян вот здесь вы видите схематическое изображение кластера он состоит из четырёх нот у каждой ноты есть своя роль допустим каждый кружочек это надо буковка в кластере это ее роль мастера соответственно синхронная реплика и синхронная реплика еще одна синхронная реплика для того чтобы можно было нагрузку на чтение смасштабировать как работает форум если мы говорим о kuromitu мы говорим о том что кластер он или кворум баязид и или консенсус бризов здесь в данном случае в случае сплита кто останется жив решает так называемый core умный или конце или консенсусной механизм в том или ином виде это фича обязательно есть и в том кластер нам стыке о котором говорю алексея и в том которые пробуем и то есть так или иначе она везде есть всем широко известна поэтому давайте посмотрим на неё подробней на самом верху мы видим обычный здоровых запущенный кластер все три воли по сгрыз в нем присутствуют каждая нота в квадратных скобках имеет по одному голосу в принципе если этот кластер окажется в ситуации с при brain то автоматически switch over он совершит подхват роли мастера синхронная репликой одна из асинхронных реплик станет центральный и кластер продолжит работу то есть вот таким образом механизм обеспечения консенсуса простого большинства not он может побороть такие сложные отказы и самые страшные следуем давайте посмотрим теперь на более сложную ситуацию то есть как этот механизм может справляться со сложными отказами когда у вас моду выходит из строя последовательно ну из-за чего они могут выйти из строя допустим застучали диски что-то пошло не так закончилась память то есть вероятность ее причины выхода из строя может быть много вот вы запустили здоровый кластер в легенде вы видите что is not обозначается у каждой ноты у нас соответственно по одному голосу то есть всего голосов 4 мы это называем их встретит вас то есть механизм разрешения кворума он ожидает какое-то количество голосов всегда и корм у нас равен трем то есть простое большинство в этой ситуации равно трем вот что-то случилось в центре что-то пошло не так может быть моргнула питания у нас отказала то есть вышла из строя самое неважное но до 1 из асинхронных принципе ничего страшного не произошло кластер у нас остается валидным он находится в ситуации кварели то есть кворум есть есть простое большинство естественно можно продолжать работу но происходит следующая неприятность беда как известно не приходит одна у нас выходит из строя самое важное но да в этом случае мы естественно ожидаем что автоматически фоловерам нас подхватит роль мастера и перевезет или на синхронную ноду мы этого почему-то не происходит естественным потому что сработал механизм борьбы со сплит барин кластер остановился остановился он потому что он находится в ситуации in the rain как видите за секунду до смерти у него было всего две ноты то есть весь пластик и милостиво два голоса условия кворума то есть это простое большинство он не обладал ни обладал соответственно простым большинством голосов очень медленно работает kreker ok что-то нужно исправить в этом принципе те люди которые уже работали с пластиковыми стенками и кластерными решениями они знают что любой solution состоящий в кластере там из четырех пяти мод он выдерживает всего лишь 11 отказ то есть в данном случае мне кажется что стоимость такого решения с 4 но да она несколько избыточно то есть у вас выходит из строя всего лишь один узел и вы вынужден остановить кластер то есть вы конечно можете улучшить отказоустойчивость серьезно если добавите существенно большее количество узлов например 7 8 9 10 но как я уже говорил масштабирование прогресса она бывает не только горизонтальным то есть может быть вам понадобится недешёвую звуки для горизонтального масштабирования которые вы можете найти у любого вендора какие-то дорогие узлу и с большим количеством процессоров и даже если допустим вы банк и один узел стоит у вас условно миллион кредитов то банки вообще-то они довольно хорошо считают деньги и вряд ли захотят приобрести там еще каких то пару нот из-за того что наш кластер ломается всего лишь после одного сбоя ну естественно учитывая то что наши роли имеют определенную последовательность я боюсь что из-за того что clicker не очень точно переключался я пытаюсь найти это место то есть мы знаем о том что последовательность переключения должна быть определенная чтобы вы не потеряли целостность данных их консистентной есть определенный порядок подхвата ролей узлов любой асинхронная реплика может стать синхронной и только синхронная реплика может стать мастером вот такая поддержкой ролей она обеспечит вам целостность данные в случае любых отказов ну во первых почему так если вернулся опять же механизмом репликации то синхронная реплика она действует всегда синхронно с мастером то есть мастер прежде чем сказать commit он ждет от синхронной реплики того что она это уже сделал вот и все и так мы решили что-то исправить для этого мы мы придумали следующее решение в этом решении мы используем математическую модель эта математическая модель а описано вот этим неравенством мы называем это неравенство неравенством суверенной демократии мы просто потому что это вот действительно так самая близкая метафора который мы смогли найти это именно такая наша задача обеспечить простой перевес голосов мастера и синхронной реплики при этом оно должно быть больше или равно общей сумме голосов деленное на 2 плюс 1 то есть при этом обеспечивать большинство но это ли не суверенной демократии я считаю что именно она и есть естественно таскались ужин школьной реплики всегда должна быть больше голосов чему самые простые ноды у самой простой воды которая является синхронной репликой все количество голосов должно равняться единице есть одно но у этого неравенства есть два случая один случае это четным количеством узлов и второй случай соответственно с нечётным количеством узлов нечетном случае количество голосов мастера должно быть равно количеству голосов синхронной реплики а количество голосов в четном случае должно естественно перевешивать синхронную реплику давайте посмотрим как это работает мы имеем здоровый запущенный кластер управляем в нем голосами вот в данном случае мастер имеет самый серьезный перевес голосов поскольку случай четные у него 3 то есть больше чем у синхронной реплики асинхронной реплики 2 голоса вот и соответственно синхронных реплик всего по одному голосу в этом случае механизм контроля кворума он обеспечивает достаточно хороший отказоустойчивой с одной стороны с другой стороны он готов бороться с любил стеблей то есть если каким-то образом этот кластер поделится мы получим неспособный кластер с единственным мастером и как минимум с одной черной репликой если оно там будет вот первый отказ что-то пошло не так в центре моргнула питания и таким образом если вы посмотрите на цифры в квадратных скобках изменилось количество голосов это изменившие количество голосов необходимые в этой ситуации потому что в данном случае мы хотим оставить кластер в состоянии творит но при этом не потеряв механизм защиты вот мы просто сбойные ноды отнимаем ее количество голосов и продолжаем работу следующий случай более сложный текущей мастер вышел из строя мы еще не успели отнять это количество голосов у сбойные ноды но тем не менее его его снизили мы имеем два работающих узла это вот за секунду до изменения голосов от голоса изменились мы имеем вот такой кластер всего лишь из двух узлов в нем есть мастернода синхронная реплика и соответственно что можно сказать этот кластер в кризисе то есть если сейчас он разделится то есть мастер уйдет с принцем хурнай реплики неизвестно что произойдет что мы должны получить неизвестно поэтому в принципе опять же если вернуться к самому началу к тому что требует заказчик заказчик наверное хочет работать до последнего мастера и мы это можем обеспечить механизмом контроля голосов то есть если мы сборную ноду лишим одного голоса то есть не произойдет сплю краем приду и ныне там просто она отказала то тогда общее количество голосов станет равно двум и перевес естественного останется у мастера у последнего оставшегося в живых которые будет обладать этими голосами ну вот все-таки что-то пошло таскать назад в нашем кластере допустим какие-то роба скрипты и или проснулись все таки администратора которые получили смазку от мониторинга и вернули 11 зло в жизни он получает естественно 1 голос он самый младший в этом скажем так вора me то есть самое меньшее количество голосов еще раз напоминаю у нас в асинхронные ноды то есть у нас по-прежнему неполного количество узлов но кластеру у нас полностью функционален несмотря на то что нагрузка по чтению в этот момент немного ограничена но несмотря на это так сказать процента наш продолжает лихорадить он теряет но до одну за другой и вы едите что в данном случае что произошло если вернуться назад за мгновение до этого события да мы видим что роль мастера была на втором узле вот в случае файла этой ноды эта роль была подхвачена синхронной репликой мы естественно синхронные реплика через какое-то время стала синхронной то есть мастер нас остается сам кластер остается на состояние кварт по-прежнему он по-прежнему в кризисе но тем не менее функционален в данном случае видимо уже проснулся начальник всех администраторов все упавшие ноды были по дням и или просто заменены либо сработали какие-то роботы и вернулись назад имеем мы имеем полностью функциональный край кластер правда уже порядок ролей в этом кластере немножко и но и ну такова ситуация такова жизнь значит что мы получили в итоге с этой моделью вот смотрите слева обычный кластер который вы можете получить из коробки он может пережить всего лишь один сбой узла один сбой узла следующий сбой смертелен то есть вы работа не сможете продолжить вот что позволяет наши скажем так математическая модель то есть мы испытали раз-два-три-четыре критических состояниях со сбоями два критических совсем как-то кластер мог совсем остановиться и вернули все узлы и продолжили работу то есть в данном случае наш кластер полностью отвечает всем требованиям но это еще не все самое важное что вот таким управлением голосами в кластере мы можем совершенно спокойно не обращает внимание на то какое у нас количество узлов чётное нечетное добавили секунды пришли и ушли что довольно тонкий вопрос всегда в любом plaster нам решение давайте добавим одну ноту посмотрим что произойдет все по-прежнему работает общее количество голосов изменилась до 9 мастера и синхронно реплика обладают равным количеством голосов потому что у нас нечетные случай вот ну и остальные ноты они никак не могут составить перевес то есть если вы посчитаете сумму голосов всех асинхронных реплик то вы увидите что они всегда меньше чем су могла собственно конные реплики и мастера либо ну допустим одного из них сумев асинхронный добавим еще одно надо как видите общее количество голосов увеличиваясь до 10 в этот момент мы количество голосов на мастере сделали неравным он имеет перевес относительно синхронной реплики но кластер продолжают работать вот так собственно где работает наша модель вообще обычно механизм вычисления консенсуса распределенный механизм он довольно сложный и его довольно сложно объяснять потому что вовлекается такая сложная суммирую щая математика сложная система сложные теоремы в этом участвуют ну я постарался это сделать просто и я очень надеюсь что мне это удалось ну значит мне бы хотелось подытожить немножко что мы получили на нашем стенде вы можете увидеть зима у нас на нескольких узлах и раз перепаивать уже поднята отказоустойчивый кластер какие-то фичи о которых я рассказал они там уже реализованы такие то нет но тем не менее конкретные вопросы вы можете задать там может быть ещё сегодня но совершенно точно завтра мы весь день там будем что еще мы узнали в процессе решения этой задачи что во первых необходимо отправить несколько патчей поскольку же сегодня чтобы они были сделаны допустим уже завтра то есть за какое-то короткое время ну естественно мы обнаружили в кластер ным стеках определенные недостатки и тоже хотим их улучшить какие именно я покажу сейчас значит во первых apache их впустую стоил мы думаем что необходимо улучшить работу по горева им чтобы мы могли возвращать сбойные мастер к той позиции до которой он вышел из строя нам это позволяет ускорить объем синхронные реплики если допустим мы имеем старой какой-то сбой ный мастер мы его восстановили свои вот там мы довольно быстро автоматически сможем его восстановить если у нас у нас прогревает это будет поддерживать вот еще мы выяснили что необходим некоторые патч который позволяет изменять не изменяет точнее о перечитывать recovery конов не перегружая узлы вот я думаю что ближайшее время он будет отправлен сообщества это обсудит и мы двинемся дальше какие нужны пальчик власти ровных стыков ну дело в том что так или иначе кластерные стайки а не обычный рассчитан что больше желающих вопросов одни если кто-то хочет посмотреть на нашу демонстрацию пожалуйста приходите завтра на наш стенд и я думаю на этом наш доклад можно считать завершенным спасибо"
}