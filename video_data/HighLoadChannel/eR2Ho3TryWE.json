{
  "video_id": "eR2Ho3TryWE",
  "channel": "HighLoadChannel",
  "title": "Как научить сервис сообщать об ошибке, чтобы это было понятно пользователям, машинам / А.Лырчиков",
  "views": 242,
  "duration": 2048,
  "published": "2024-10-29T02:57:08-07:00",
  "text": "Саша Лыков из ядра сейчас поделится своим опытом Встречайте Александр Лыков ядро Всем привет Я Саша Лыков из ядро это правда будет сегодня расскажу как и зачем мы внедрили свой механизм для создания обработки ошибок и как то же самое можете сделать Вы немного как этот доклад появился я гнал первую версию в нашем внутреннем Go комьюнити и выяснилось то что не только моей команде которая делает системы хранения данных это понадобилось но у нас есть ребята которые делают базовые станции для телекома и ещ там парочки команд Поэтому я думаю что многим многим Кто здесь будет полезно Давайте сначала поговорим о проблеме Мы же не просто так это всё делали проблема всегда интересно говорить как какой Фло вообще ошибки что происходит сервис Ну понятно ошибается что-то происходит он генерирует сообщение об ошибке и возвращает его в http ответе Возможно эта ошибка посерединке е как-то обрабатывается Может вы захотите е Загирова или прогнозы пользователю когда проблем в этом Фло в принципе нет Давайте отталкиваться от того какая у нас система представим нашего пользователя который ей пользуется назовём его как-нибудь пусть он будет Джоном и представим что о делает если ваш пользователь Берт в руки попко и Сади наме вы делаете сервис чтобы видосики смотреть пользователь видит какую-нибудь превьюшку захотел на неё тыкнуть нажимает и здесь у вас что-то страшное произошло отвалилась какая-нибудь нода или взорвался сервер Ну кто знает Вы показываете ему какую-то ошибку пользователь видит вот такую красивую обезьянку и надпись что-то пошло не так если вы дополнительно к этому напи у меня упала такая-то нода в таком-то кластере в принципе ничего не даст только запутан Как сидел со своим попкорном так и будет сидеть ему эта информация вообще лишняя когда в этом Фло кликер когда в этом Фло проблема появляются Когда ваша система - это ну ребят когда Шей системе пользователь это инженер допустим он и смотрит Вот вот сюда Это UI нашей системы хранения данных много кнопочек рычажком всё можно поделать и здесь пользователь уже управляет какой-то системой ему нужно как можно больше о ней знать если там произошла какая-то ошибка то как можно быстрее её исправить а не просто подумать само пройдёт допустим у вас есть система хранения данных в ней куча жёстких дисков она у вас стоит где-то в серверной и по какой-то случайности на неё упал молоток жёсткий диск один сломался И что теперь увидит пользователь допустим он хочет создать новый ВОМ чтобы туда записать свои данные он посылает запрос в условный сервис Vol менеджер который у нас там бежит и Vol менеджер внутри понимает то что он не может это сделать потому что диск сломан как теперь сообщить об этом пользователю Казалось бы я сказал мы используем http у нас куча кодов за нас всё придумали всё описали всё их так много что они даже на картинку не вмещают вертикально я её перевернул все мы знаем ими все мы ими пользуемся допустим наш сервис отправляет код 409 Что значит конфликт И что это говорит пользователю Как он может его анализировать это может значить например что уже существует во с таким именем ему нужно чуть-чуть переназвать и отправить Новый запрос Может быть у нас вообще бежит какая-то конфликтная операция взялся чуть попозже попробовать ВС нормально може сломался И тут уже надо его либо менять либо не знаю чинить понятно что одного кода не хватает нужно использовать какое-то сообщение отправим сообщение напишем диск в состояние ошибка О'кей что часто идёт не так в сообщениях с чем многие сталкивались можно отправить что-то не совсем приятное допустим вы не дождались чего-то у вас отворилась операция по таймауту и вы в ошибку прямо запихнули а ошибку Гош ную а то что у вас контекст отменён такого пользователь видеть не должен ещё часто Мы вроде написали правильный код упал это правильно диск в плохом состоянии Но написали на каком-нибудь программистский языке который выглядит не очень а у вас это лицо продукта не хотим такое показывать что часто Нам не хватает чего мы хотели видеть чаще - это детали лучше отправить не просто То что диск какой-то из 100 в состояни ошибка а отправить номер чтобы он не бегал все не перебирал и также если у нас резко Джон станет Иваном у которого весь UI на русском языке то логично ему показывать и ошибки на русском языке которые не будут выбиваться из общего стиля ему не надо будет лезть переводчик и так далее Давайте запишем себе где-то что нам нужно что мы требуем ошибка должна быть понятна пользователю в ней не должно быть какого-то внутри должна быть нормально описана согласована побольше деталей чтобы ода Что произошло и заложим возможность локализации проблемы на этом не заканчиваются проблем может быть больше мы показали ошибку пользователю Что может быть до этого сервис может захотеть обработать эту ошибку сам где-то повыше или ошибка может быть обработана в другом сервисе пока идёт до пользователя когда мы с этим столкнулись Когда у нас появилась Вот это Это сфш кто не знает наверное много кто это для систем хранения данных уже описали стандарти некоторые I есть стандарт запроса стандарт ответа Если заказчик взял вашу систему хранения данных и у него уже написаны скрипты под этот стандарт ему будет легче её использовать появился запрос пожалуйста поддержите для нас вот такой теперь наша схем запроса немного меняется пользователь шт свой запрос сча в какой-то Проси кото реализует направляет уже ну как там перекладывает жей сончик в нашу внутреннюю сервис который был до этого в то же время никто нам не запрещает ходить по старому во внутренней если нам так удобнее мы должны поддержать оба варианта и если есть стандарт запроса ответа то должен быть и Стандарт ошибки как это выглядит сво есть идентификатор её для нашего ситуации с диском был бы какой-нибудь bate у него есть много-много полей Ну основные это сообщение туда напишем сообщение и вставим параметры и описание тех самых параметров их число типы Теперь когда у нас менеджер понимает то что диск в плохом состоянии он посылает наш код наше сообщение и что происходит Дальше А дальше нужно как-то понять в про что произошло видим быку как оттуда по чем произошло Какие аргументы Пока непонятно Давайте зафиксируем то что мы должны уметь это понимать машине машина должна в коде уметь обрабатывать эту ошибку определять её тип брать Аргументы и делать с ними что захочет как это сделать самый простой вариант у нас есть строка Давайте искать подстроки в строке пока вроде классно Давайте попробуем и мы получим вот такую простыню где ничего не видно здесь я обрезал у нас был код где-то Ну раз 10 больше Что здесь происходит берётся ошибка строка которую мы уже в нке получили смотрим Если в ней содержатся какие-то ключевые слова понимаем что происходит если мы описали то это такая-то структур Мы возли у чтото найдено можем сказа unable to find с большой буквы и возвращаем другую структур not found что не так это будет сложно расширять это вы будете постоянно ломать Ну и чинить надо бы после того как сломали например вот такая строчка Когда мы не смогли подключиться к удалённой системе у нас там содержится либо три цифры 401 либо предложение FA на другой системе что-то тогда мы вернём правильную структур Если нет то по дефолту это спится в внутреннюю ошибку сервера У нас есть хорошее покрытие тестами мы смотрим всё правильно работает и есть такой тест Допустим мы запрещаем с помощью IP Tabl отправлять пакеты куда-то и пытаемся подключиться к другой системе чтобы настроить репликацию ожидаем то что сделали все эти шаги и получим красивую ошибку нельзя установить соединение что почему-то мы получаем внутреннюю ошибку у нас валится тест валится вся волна тестов вся валидация нужно пересобрать теряем время но просто так игнорировать мы это тоже не можем нужно разбираться что произошло вы идёте к себе там на C смотрите прогон скачиваете логи Заходите в консоль что-то ищете и находите в комит подключиться к удалённой системе и выкинули ошибку не можем получить ответ А не можем получиться эта строчка дошла до самого верха магическая подстрока Не нашлась и у нас по дефолту всё сло во внутреннюю ошибку это нужно пофиксить давайте это пофиксить ещё одно предложение в наши условия Теперь всё должно работать какое-то время да но потом ВС рано это сломается у наме есть ошибки из стандартной библиотеки также могут долететь до этого маппинга ещё куча куча всего в Юни тестах какая ситуация Они конечно бегут быстрее чем n2n тесты но они тоже у вас периодически будут валиться там происходит то же самое магический поиск под строк чтобы понять что где произошло вот скрин из моей IDE Здесь много поисков это можно мотать мотать мотать мотать Давайте зафиксируем то что ошибки должны быть понятны удобны для программисты мы не хотим постоянно что-то обновлять ломать чинить Нам нужен удобный интерфейс для работы с этими ошибками Как получить тип достать Аргументы и чтобы это просто работало чтобы мы на это не отвлекались не бесились в итоге мы на требовали Ну нормально Так мы должны одновременно и пользователю угодить а реализовать это программно чтобы было понятно машине и программисту тоже должно быть нормас нужно думать что-то как это сделать Ну понятно во-первых что хардко уже не вариант Пора от этого наверное уходить нужно заложить один какой-то стандарт Для ошибок какой Давайте посмотрим что самое простое что можем сделать - это использовать константные ошибки константные с оговоркой все видим слово но иде потто сравнивать и смотреть тип события что здесь хорошо мы уже убрали хардкод как-то формализовать всё по тексту можно определить ошибку но здесь огромный минус аргументы не поддерживаются пользователь не поймёт что произошло написано просто вы отправляете запрос написано object not found какой object догадайтесь пожалуйста сам отмечаем себе то что нам это решение не подходит пользователю всё плохо давайте думать что-то ещё классный вариант люблю его структуры Для ошибок заводим любой свой Гош най тип имплементировать классно Можно с ними работать все ошибки у нас в интерфейсе стандартном uror делаем typecast получаем уже типизированного достаём спокойно работаем с ней есть ещё замечательная библиотека errors для работы с ошибками там можно вообще с ними много всего делать можно вра Пать их ан врать смотреть э содержится ли в рапана ошибки какая-то Класс всё работает до какого-то момента помним что у нас ошибки могут обрабатываться и в другом сервисе что мы делаем перед тем как отправить мы её сериализм маршали нашу ошибку в тело в Джейсон сум его и отправляем этот жей сончик Летит летит по сети все аргументы у нас на месте ничего не потерялось что На другой стороне мы делаем мы хотим получить ответ нам нужно его зан маршали логично теперь встаёт вопрос Куда если у нас больше одной структуры А вас скорее всего больше чтобы зан маршали нужно предо из туда-сюда это сделать но это будет ужасно отмечаем для себя то что всё Конечно работает но через J всё хреново передаётся Давайте резюмируем метод он хороший у нас появляется детализация за счёт аргументов в коде классно удобно работать Даже библиотеки есть но это всё ломается после сериализации если каким-то чудом она дот до пользователя он зат в коде мы пока не знаем как это реализовать нужно думать дальше Ещё вариант который все все используют Все любят Это какой-то один формат заводим коды ошибок пишем код Ну у меня он строковый какую-то структуру условная Мега ошибка туда съём код чтобы определить что произошло и сообщение которое нам нужно Ну сразу отмечаем то что мы опять аргументы потеряли поддержки нет изна оста норма работает Давайте подумаем Как сюда аргументы запихать мне кажется как-то можно в го запихать то не знаю что а потом достать его по имени это конечно у нас мапа заводим мапу аргументов просто в ключ это строка это название то чего мы достать хотим А в значение лежит что угодно в пустом инте перн щается Вот в такой ВМ можем однозначно определять Что произошло и все нужные нам аргументы он долетает до сервиса который ожидает ответ свободно маршали в одну структуру и дальше мы уже с ней Работаем как мы с ней работаем мы берём код чтобы понять что это за тип сравниваем его с константой и Если хотим получить аргументы получаемых берём нашу мапу и по названию аргумента берм у нас не найден объект хотим получить object ID берём в object ID сейчас лежит пустой интерфейс После этого мы его касти к строке и что-то делаем а выглядит классно но все мы любим писать If Error не равно nil здесь ситуация та же каждый О'кей Всё равно нам нужно проверять ваш код постепенно превращается вот в такое добавилось чуть-чуть строчек один аргумент в ошибки достаточно редко если будет хотя бы два то это превратится уже вот в такое А если у вас будет слайс то по там так маршали то что у вас получится не слайс строк а слайс пустых интерфейсов Вам нужно будет взять этот слайс Каждый элемент кануть к строке и собрать новый слайс строк после этого уже с ним работать непотребство с какими ложными структурами я здесь не стал делать можете представить как от этого можно избавиться вот такое классное решение мы вообще не обрабатываем эти океи если что-то не так то мы просто панику и в конце аккуратненько это ловим говорим Ну что-то не так пошло в принципе это похоже на внутреннюю серверную ошибку многи может не понравиться юзать панику Но мой мли убедил меня что это решение Гениально Привет Вова Спасибо ему резюмируем Шиб можем сериализация и десериализация классно работает всё в одной структуре есть аргументы Но эти самые аргументы может быть неудобно с ними работать надо их доставать по ключам строковый и аргументы нужно будет постоянно касти это будет работать это реально работало у нас в одном из сервисов но программисту в какой-то момент может надо есть это самое делать Давайте подумаем вот я помню мне очень тся решение со структурами дать Что лежит в мапе под Каким ключом просто достаёшь аргумент работаешь с ним всё просто работает может как-то можно это сделать чтобы работало между сервисами Мы думали и придумали вот такое мы сделали библиотечку назвали её Terror от tatlin название нашей системы хранения данных и errors классный нейминг что в ней есть в ней есть так сказать база в базе хранится код который должен быть у каждой ошибки чтобы её определять и сообщение это то что должно быть в каждой ошибке Теперь если вы захотите сделать свой тип вы в своём сервисе в коде импортируйте библиотеку Terror и определять такую структуру в которую встраивается базу которая помогает нам определять что это за ошибка а дальше уже накидывай всё что хотите все аргументы Как создавать эту ошибку вы в вашем же сервисе после того как структуру определили определяете функцию для создания которая принимает на вход все аргументы печатаете нужное вам сообщение и заполняете структуру заполняете базу уникальным ком и сообщени которые недавно напечатали кладёте все нужные вам Аргументы и возвращаете собранную структуру Теперь всё классно у нас старый добрый typecast интерфейса берём нашу структуру работаем с ней всё работает в копай тайме IDE даёт подсказки что куда доставать класс после сериализации у нас получается такой Джейсон тоже красивый есть код есть все аргументы есть сообщения он летит и долетает до сервиса который ждёт ответа на этот вопрос Куда маршали мы ответ пока не дали для этого в нашей библиотеке мы придумали отдельную функцию которая занимается А маршалом что ей нужно чтобы понять что произошло мы передаём бо который нам в этом чки прилетел и передаём мапу в ней хранятся не мапи код ошибки на Гош ин структуры Куда нужно залить как это выглядит допустим у вас в сервисе есть две ошибки вы заводите вот такую мапу и говорите то что коду object not found соответствует Вот такая структура object not found И передаёте это всё библиотечку внутри библиотеки Мы сначала берём наш J машам базу чтобы понять что произошло дальше смотрим в мапу наших инстан сов если там есть нужная нам структура мы её запоминаем через лект создаём новую структуру такого же типа и передаём уже в обычный J and Maral на выходе получаем структуру кам её к интерфейсу eur и спокойно возвращаем что теперь у нас стало после того как мы это решение внутриличностного уже что-то делаем тесто ушла ушло Полотно с поиском под строки в строке теперь у нас также всё статично смотрится равен ли аргумент чему-то мы можем проверить не надо ничего искать гадать класс так как мы перекидываем аргументы то мы автоматически закладываем возможность интернационализации из этого Джейсона мы достаём тип объекта ID и состояния и можем написать на любом языке что произошло в нашей системе у вас где-то в U C неважно лежит шаблон где написана строка с холдера вы туда подставляется что вам нужно и уже показываете пользователю резюмируем что у нас получилось в нашем финальном решении возможно насколько подробно настолько хотите описать ошибку удобно с ней работать в Гош просто как с обычной структурой это работает слингом ирлин класс это заходит и пользователю и в коде норм выглядит и программисты не устают не ругаются когда постоянно что-то ломается класс мы придумали Как нам теперь это всё переехать Как нам поддержать первый шаг самый главный нужно решиться У вас есть какая-то система где много чего захард кожено вам нужно во-первых понять что вам это нужно потом прийти к овне репозитория сказать я тут хочу всё переделать хочу на 000 файлов Можно мне пожалуйста всё правда будет хорошо он вам должен разрешить потом вы должны какое-то время сидеть анализировать все ошибки и только потом это всё внедрять решились смотрим Какие ошибки у нас возможны форзу их для каждой заводим уникальный код придумываем какие у него должны быть Аргументы и уже потом пишем функции для их создания это ещё всё нужно конечно согласовать лучше всего А мы делали табличку на конфлюенс и её ревью или ревью или пока не решили то что вот это оно это то что нам нужно в результате у вас будет примерно такой ди Везде где строка ошибки печаталась через printf у вас Замени на вызов функции которая структуру фов будет много это не всё что влезло из наших изменений файлов реально много но Диф несложные сложнее всего реально это всё придумать Если вы уже всё формализовать то там идёт такая достаточно механическая работа заменяйте заменяйте заменяйте Какое можем сделать вывод изго этого для начала Подумайте пожалуста вам нужно это ш пользователь что он делает Нужны ли ему эти ошибки Убедитесь что проблема есть что ему не хватает потом Подумайте Может её можно решить проще Может у вас ваши ошибки влезут Просто в htp коды вы их можете однозначно сопоставить и всё может одним поиском по строки строке тоже можно будет обойтись возможно Подумайте Если вы решили что вам это нужно ваши пользователи требуют крутых ошибок зада решаемая это может быть реально Долго но в конце это упростит жизнь Всем спасибо голосуйте за мой доклад И я готов ответить на ваши вопросы Спасибо Саш друзья задавайте вопросы Кто в зале дните руки высоко-высоко чтобы я их видел Кто в онлайне голосуйте задавайте вопросы в чате так была первая рука вот вве например не рекомендуют строить через эсп потому что есть то есть там всякие сеты что почём паники в что ещё раз извини услышал если мы бросаем эп в весс возвращаем их вторым Амен вторым результатом насколько это дороже по производительно Давай сначала как бы производительно про то что вообще в го ну не очень считается бросать паники мы это сделали потому что код ужасно раздува и всё было плохо это такое Надо подумать и прямо обосновать это решение по производительности Я не знаю на сколько там процентов у тебя будет падать наверное Надо почитать Спасибо так Следующий вопрос пожалуйста по-моему рядом был нет где-то Ага Добрый день я те узнать что бы вы вс-таки сделали со стандартными ошибками Ведь они не подчиняются этим функциям которые вы написали чтобы создать новую ошибку чтобы обернуть её в ваш класс и второй вопрос Что вы делаете с ошибками которые вы не ожидаете то есть ВС равно могут появляться вот как у вас на предыдущих слайдах какие-то Тай которых раньше никогда не было и так далее стандартную Входи если это стандартная ошибка и ты её перед этим не обработал какой-нибудь cont canc то это считается твоя внутренняя ошибка пользователь её видеть не должен Если ты хочешь её показать действительно что-то произошло тогда ты когда получил ошибку делаешь Не равно там же можешь её прологи и потом ты заводишь отдельную структуру Если тебе это реально надо прокинуть и конструирует её можно да Дада конечно спасибо за доклад большо правда интересно у меня тако Вопрос немножко пересекающиеся с предыдущим Правильно я понимаю что вот эти вот преобразования ошибки к какой-то конкретно бизнесов либо к внутренней ошибке они происходят как при получении ответа от какого-то внешнего сервиса так в части сервисов и при формировании ответа Для клиента если это идёт например уже конкретному клиенту ответ А у нас такая логика то что сервис отдаёт другому сервису только готовое он не может выкинуть что-то там э не по протоколу там всегда должна летать ошибка такая как наш Джей сончик если а если это я имею в виду если это сервис за которым уже нет других сервисов он отдаёт непосредственно клиенту ответ Он должен будет перед тем как ответить тоже сделать эти преобразования чтобы опять же чтобы тот же тайм-аут не ушёл наружу чтобы не ушла наружу ошибка с базы данных А ну да у нас вообще в конце Эхо стоит просто варь которая если что-то Неожиданное то она его в infernal eror и конструирует принял Принял спасибо ещё е вопрос в центре Здравствуйте первый вопрос серьёзный второй нет пробовали ли вы прикрутить для распознавания ошибок какие-нибудь ML модели это серьёзный вопрос Если что был а второй вопрос несерьёзный зачем молотки с сервером рядом располагать модели Нет мы не пробовали Я даже неста на самом деле как это можно сделать Возможно у вас получится молотки Ну лежал упал что-то колотили Спасибо так был вопрос ещё по центру тяните руки выше вас не видно да всем привет такой вот вопрос первый в докладе было был разобран пример что мы из нашего целевого сервиса ошибку отдам в прокси сервис из прокси сервиса ошибку отдаём пользователю для того чтобы подержать вот этот новый крутой формат который пользователи требуют вопрос Почему бы не сделать в нашем втором сервисе который выполняет бизнес логику непосредственно по параметру отдачу этого ошибки в нужном формате без какого-либо прокси сервиса сервисов пусть будет 300 они все написаны давно у них свой форт которые они привыкли давно друг с другом общаются везде накручивать эту логику Ну ладно долго Но вообще когда мы это делали то был принцип такой то что сервис ниже не знает то что пользователь требует какой-то там формат Потому что это не только ошибка это вообще всё взаимодействие там прямо описывается как обращение к Плам по Кома адресу к вольюм там свой свой прямо формат понятно во многом получается эта вся система нужна была как раз для передачи ошибки конкретному пользователю потому что между сервисами это как мне кажется зачастую достаточно просто по коду определять по внутреннему не по http коду а сделать какой-то внутренний код и на другом сервисе проверять если ошибка ну можно представить когда кода недостаточно какой-нибудь параметр тебе нужно обработать может если он равен чему-то то выкинуть какой-то Ар что-то отключить в принципе можно представить эту ситуацию но да изначально это чтобы поддержать было спасибо сразу Следующий вопрос рядышком Здравствуйте Спасибо за доклад А у меня вопрос про формат самого джисона в ответе смотрели ли вы на какие-то имеющиеся уже стандартизированные варианты собственно этих ошибок например есть такой rfc который ещё не принят называется problem J А вот это первая часть вопроса А problem JS не слышен http problems что-то такое есть да но там описывается как бы J Да действительно похож но нет какого-то решения как это всё нормально Амар как это должно работать в коде Окей и тогда вторая часть Собственно сам формат этих ошибок вы как-то всеми сервисами поддерживать этот формат мы делали только например для пока для одной фичи г должно быть должен быть публичный он должен быть очень красивый ты можешь постепенно пережать На этот формат это не должно ломать твою всю систему спасибо спасибо Добрый день спасибо за доклад меня у меня есть такой вопрос по поводу Поре У нас есть код и у нас есть фиды и собственно по нему поэтому можем его сгенерить возникает вопрос Нужен ли он или это чисто таки исторические причины очень он помогает когда у тебя есть структура но у неё должен быть интерфейс eur Ладно если там просто подставляешь каждый раз удобно смотреть по логам Что произошло чтобы не сопоставлять код и плейсхолдер А чтобы у тебя сразу было видно пользователю этот месседж Да он не показывается он больше для нас программистов Ещё вопросы есть в зале вопросов больше нет тогда надо выбрать лучший на твой взгляд сложно Сложно давай мне понравился вопрос видимо знающего человека по rfc прекрасно выходите к нам сюда за подарочков почётному спикеру конференции Аплодисменты Саша Приходи к нам ещё и делай доклады"
}