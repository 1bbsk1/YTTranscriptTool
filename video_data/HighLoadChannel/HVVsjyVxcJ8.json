{
  "video_id": "HVVsjyVxcJ8",
  "channel": "HighLoadChannel",
  "title": "Java и Linux — особенности эксплуатации / Алексей Рагозин (Дойче Банк)",
  "views": 5195,
  "duration": 3437,
  "published": "2018-08-16T04:49:42-07:00",
  "text": "доброе утро коллеги меня зовут алексей рагозин и сегодня мой доклад посвящен особенностям эксплуатации джавы на линуксе откуда взялась такая тема java очень распространенная платформа на ней пишут очень разные вещи там у big data кончаем микро сервисы монолиты enterprise все такой платформа распространен и как правило все это тепло и ться на линуксе при этом соответственно те люди которые нажали пишут не зачастую делают это совсем на других операционных системах то есть себя на рабочем месте у них там стоит windows или упаси боже mac os они там пишут код отваживают тестируют после этого упаковывают жальник отправляют на linux и она работает ну то что она работает в этом маги особо никакой нету над привод тому что вот эти вот люди они немножечко это самое засахаривается в своем мире jalas америку раза кроссплатформенность и и очень хотят разбираться а как она на самом деле там работает как бы в реальной операционной системы это одна сторона вопроса в другой страны есть те кто занимается администрированием серверов администрированием linux к ним устанавливают живым привозят там какие-то jar ники варнике и все это хозяйство она с точки зрения мира linux но такое все чужеродное она какой-то проприетарной обидеться не из исходников поставляется каким-то jar никами отъедает всю память на сервере вообще ведет себя не по-человечески и собственно говоря цель этого доклада вот как бы рассказать особенности джавы линуксоидов и соответственно linux джавис там ну давайте прежде чем я пойду дальше вот из здесь причисленных кто бы себя причислил к джаве стан ок так линуксоида окей чуть чуть больше я как уже сказал сам по себе ja west поэтому я допускаю что в зале есть люди которые в яндексе разбираются намного учи меня поэтому если есть желание дополнить то не стесняйтесь после того как я закончу если есть чем интересно рассказать то пожалуйста вот как будет построен так во первых это не будет разбор полетов потому что проблем много они все интересные и снаряд дважды в одну дырку в одну воронку не попадает поэтому как бы затыкать уже известны дыр немножко такая про же низкая позиция вот вместо этого я хочу немножко рассказать про особенности реализации джо омбре особенности реализации linux и как это вот может вместе и стыковаться известно джалла у нас есть виртуальная машина и linux по сути ну как и любая другая современной операционной система это тоже виртуальная машина у нас есть узел space ему предоставляется какая-то абстракция вот платформы надо ли ее у нас в джаве есть управление памятью linux есть управление памятью то есть потоки есть как какой-то и 5 вот соло похоже на самом деле под ними очень часто разные вещи собственного по vsa я будто мы пройдемся он получится так что семь процентов времени я буду говорить про память уж там больше всего всякого интересного остальные два пункта потоки и вот вывод на то есть немножко сквозь и так память как выглядит память с точки зрения желаем сразу говорить что я буду говорить только про реализацию g em hotspot это open джедики это орков джедики то есть возможно там мой беловское java есть какие-то свои особенности наверняка не есть я к сожалению про них ничего не знаю как если мы говорим про hotspot живым-то картина мира выглядит следующим образом у нас прежде всего в джаве есть область где у нас живут объекты java так называемый хип где у нас работает сборщик мусора которые как правило занимает большую часть пространства процесс а она в свою очередь разбита на молодой старое я не буду вдаваться в асу в детали слишком сильно что важно то что у дживы им есть параметр минус x mx который определяет максимальный размер до которого может увеличиться хит дальше там есть много вариантов можно управлять отдельно размерами молодого пространство можно сразу выставлять размер hippo в максимально либо дать возможность ему расти постепенно детали слишком много важно что для hippo есть лимит и в принципе это общий подход ко всем областям которые используют живым то есть практически все области причислены на этой картинке у них есть определенный лимит gm сразу выделяет резервирует адресное пространство исходя из лимита а потом по мере необходимости собственно говоря позволит локацию памяти в этом диапазоне и это важно понимать помимо hippo есть другие потребители памяти наиболее важным из них являются области памяти для ацтеков про потоков аджарский потоки это обычные linux потоки у них есть стек для него выделяется определенный размер чем больше у вас потоков тем больше у вас стыков выделено куча сколько в джаве не редкость что потоков может могут быть сотни тысяч и иногда эта цифра может становиться соус достаточно существенны особенно если у нас какой state vs микро сервис в котором в общем-то hippo там на 200 мегабайт а вот трату он себе раз плодил на 50 на 100 потоков это статья расходов по памяти может выходить вперед помимо этого есть еще так называемые не у буфера это специальные объекта веры которые позволяют работать с памятью в ней hippo и это как правило используется для работы со вел потому что эта память который может напрямую обращаться и java код и секунд и соответственно эту область она доступна через ebay у нее тоже есть максимальный лимит смот остальное это в принципе мета-данные там какой-то сгенерированный код он обычно не вырастает до больших величин там сопоставимых всем же типом но есть помимо вот этих вот специальных областей не надо забывать что джим написано на си плюс плюс там соответственно есть молок есть как бы обычная аллокация памяти есть библиотеки которые погружаются в живем так статически слинг кованые динамические которые тоже могут использовать память и это память она вот в эту картину она не классифицируется по карте это какая-то просто память выделенные со стандартными средствами runtime оси с ней тоже иногда бывают проблемы проблема бывает причем на как бы достаточно ровно места например вот у нас в java код он распространяется вид jar ников жальник это zip архив для работы с ним используется за клип за клип для того чтобы есть что-то разархивировать и и на даваться рвать буфер кого торрентом использовать для декомпрессии и этот буфер потребляет побить все бы ничего но как бы сейчас есть мода на так называемые uber жары когда делается один задраены jar куда копировать и кучу всего и вот возникают нюансы что при попытке старт из такого джара там открывается одновременно слишком залив стримов на распаковку и происходит причем с точки зрения java все хорошо как бы не и хит маленький все области маленьки нового памяти потребления памяти процессом растет ну это вот такие клинические случаи но надо понимать что они бывают и если вы знаете что вот есть x mx и вы выставили джори и xm x 1 гигабайт и и посадили ее в доке русский контейнер с лимитом по памяти в 1 гигабайт она в него не поместится надо там ничего накинуть чуть вот сколько чуть-чуть зависит от многих факторов отчислят количество потоков и от того что именно ваш код делает итак это то как джеймс работает с памятью теперь так сказать для другой части аудитория что такое память в линуксе в линуксе нет никого сборщика мусора его как бы работа с точки зрения память совершенно другая но есть физическая память которая разбит на страница но есть процесс у которых есть там свое адресное пространство ему надо ресурса вот этой памяти в виде страниц как-то там раскидать между процессами чтобы они работали в своем виртуальном адресном пространстве и делали свое дело странице как правило это 4 килобайта на самом деле это не так в архитектуре x86 уже очень давно существует поддержка больших страниц в linux она появилась относительно недавно и с ней пока немножко непонятная ситуация потому что когда она появилась очень многие люди наступили на грабли связанные с performa с дигла дальше нам из-за того что были включены большие страницы и недолго думая все их подключали после этого в принципе какие-то баги связанные с работы больших страниц в линуксе починили но вот на текущий момент какой-то вот четкого понимания там с какой версии это можно включать по умолчанию и не беспокоиться я нет поэтому будьте осторожны если вдруг у вас это самое внезапно на ровном месте растет потребление ресурсов ядром там проблема может быть как раз из-за того что у вас включены большие странице они в большинстве дистрибутивов включена по умолчанию и так с точки зрения ядра у него есть куча страниц которыми надо управлять с точки зрения процесса него есть адресное пространство в котором он резервирует себе диапазоны адресов зарезервированное адресное пространство это не что это не ресурс в нем ничего нет если вы бы обратитесь по этому адресу вы получите сих пор потому что там ничего нет для того чтобы там появилась страница как бы нужен немножко другой syscall и соответственно тогда процесс говорит операционной системы пожалуйста вот в этих адресов нужен гигабайт памяти окей память там появляется появляется она тоже не сразу со своими хитростями ну и наконец то же самое как как бы просто с чистой памятью мы можем на адресное пространство за маппет данные слова принципиально ничем не отличается с точки зрения ядра как бы квалификация страниц выглядит следующим образом у нас есть страницы приватная то есть это значит что они принадлежат одному процессу они доступны и в адресном пространстве только одного процесса и соответственно анонимные и файл bass анонимно это просто память файл без это как бы моим ремонт файлы и есть страницы используемые совместно тут немножко сложнее это может быть либо купи он right то есть когда у нас происходит ford процесса у нас как бы его память она становится доступно будем процессом до тех пор пока она не будет записан и тогда страниц превратятся в на приватное ну и соответственно с файлом если мы несколько процессов маппет один и тот же файл то страницы могут использоваться совместно вот с точки зрения hydra операционную систему все достаточно просто вот но как бы просто да не просто так продолжая разговор о памяти когда мы хотим понять что у нас на сервере происходит с точки зрения памяти мы идем в топ видим там какие-то цифры я надеюсь что должно быть видно вот в частности у нас там есть использованная память свободная память вот кто считает сколько на нормальном сервере должно быть свободной памяти то считает что 5 процентов от физической памяти свободно это нормально поднимите руку а 000 страниц свободной памяти это нормально на самом деле это нормально потому что вот то что мы видим в качестве счетчика свободной памяти это на самом деле не вся свободной памяти и на самом деле очень намного больше просто она как правило скрыто в кэше страниц с точки зрения процесса у нас тут три интересные колонки это виртуальное адресное пространство памяти to rise резидентная марии to shite mo mai внушают mai mare это просто это как бы те страницы которые являются совместное использование а вот среднем все немножко хитрее так более подробно повод этим метрикам используемая ее свободная память метрика достаточно бесполезно потому что как я уже сказал это просто особенности работы вот этого сервера свободная память от значит что сервер немножечко это как бы либо недавно перри стартовал либо немножечко это самое бездельничает поэтому у него свободной памятью еще осталась та память которые никогда не было использовал по большому счету и близко к этому вот почему потому что у нас есть файловый кеш и все современные операционные системы они всю свободную память используют по твоего кэш почему потому что из файлового каша страницу памяти можно всегда взять очистите использовать для более важных задач поэтому вся свободная память она так постепенно уходит в кэш и не возвращается обратно вкус свободной памяти то что в этом смысла большого нет с точки что касается метрик процесса метрика виртуальной памяти это то сколько адресного пространства мы зарезервировали это вообще не ресурс это вообще с точки зрения операционной системы то не ресурс вы можете запросто залакировать там 100 терабайт адресного пространства и и все ну вот вы его за лоцировать вы можете гордиться что с адресатом экспо адрес y вот это адресное пространство она зарезервировано больше а но там не будет использоваться для других назначений но это просто вот как бы диапазон отрезав не больше поэтому смотреть на это как на ресурс и например ставить alert что у вас там размер виртуального виртуально размер процесса превысила какую-то расход довольно бессмысленно хотя такое тоже бывает и опять же возвращать к джаве java все свои специальные области сразу резервировать заранее потому что она написана так что она считает всегда вот эти области непрерывными с точки зрения в адресном пространстве поэтому и всегда на застолбить поэтому грубо говоря запуская какой-нибудь процесс томас архипом на 256 мегабайт вы можете внезапно увидеть что виртуальный размер у него там два с лишним гигабайта почему потому что есть вот всякие области которые ну вот основа на гигабайты и зарезервировали не потому что это гигабайт нужен и не потому что этот живем в принципе способна этот гигабайт когда-либо утилизировать ну просто вот такой от него ни холодно ни жарко так думали те кто подписан живем как бы это не всегда соответствует менталитет у тех кто потом занимается поддержки серверов вот residence айс это наиболее в этом плане близкая к реальности метрика это количество страниц памяти которые используются процессом которые находятся в памяти не в свопе но она тоже как бы немножечко своеобразная возвращаясь кашу как я уж кого кэш это в принципе свободная память но иногда бывают исключения потому что страница в кэше у нас бывают как бы readonly и бывают модифицированы и если страница в кэше модифицирована то прежде чем эта страница может быть использовано для другой цели и сначала надо записать на диск записать на диск от уже совсем другая история и в результате если у вас в некоторых случаях например вы gm пишет большой большой хит дамп делает она это не спешно делает она это на нфс но при этом как она это делает она это быстренько пишет в память операционная система выдает ей всю свободную память под в right by high and cash который у него есть соответственно вся эта память оказывается грязной сбрасывается на диск она медленно и при этом если как бы размер этого тип дампа сопоставим с размером физической памяти на сервера это может прийти к такой ситуации что для всех остальных процессов просто свободной памяти не будет то есть у нас например открывается новое саса шасси для него там надо запустить нашего процесс выделить память как бы процесс идет за памятью ядро говорит ему подожди пожалуйста сейчас вот я чего-нибудь найду находит но когда по прежде чем она успевает отдать эту страницу и счас hd java успевает по пачкать еще несколько страниц записывая свой тип дам потому что она тоже висит на подсчете поэтому как только появляется как бы свободной страница она быстренько просыпается и очень часто успевает от памяти утилизировать раньше чем какие-то другие процессы и в общем иногда это самое на практике такая ситуация приводила к тому что система не только просто решала что сервер к ведь не живое на него с вашим зайти нельзя то на что он не задайте сашу не существует логично логично и за перезапуск но это крайний случай если у вас как бы размер живым ставим с размером физической памяти чем дампа могут быть опасны вот возвращаясь как сказать сути вопроса как соотносятся между собой и вот virtual сайт rezident и вот здесь еще есть 3 величина это комета cs это вот та память которую процесс реально собирается использовать то есть это та адресное пространство при обращении которому вы не получите set forth при обращении к которому ядро обязана предоставить вам физическую страницу памяти что вы могли бы и не и почитать записать в идеальная ситуация вот этот комета президента должны были быть одним и тем же но есть нюанс во-первых нюанс то что страницы могут сводится но это понятно как пауки минусов это полбеды второй нюанс то что память в линуксе выделяется всегда лениво вы говорите linux дай мне пожалуйста 10 гигабайт он говорит бери пожалуйста другой процесс дай мне тоже 10 гигабайт бери пожалуйста 3 процесс дании тоже здесь гигабайт бери пожалуйста дом оказывается что физически памяти всего было 16 а он всем подрал по десять и дальше начинается как бы кто кто первый взял того и тапочки вот а кому не повезло затем придет твоем killer ok это особенности управления памятью linux пару важных фактов про живым первое джем очень не любят когда на системе происходит с walking с весом не жалуется что моё java-приложение чего то тормозит первое что я делаю смотрела нет ли на сервере swapping а потому что есть два фактора первый вжарил нас есть сборка мусора которая постоянно бегает по страничкам и соответственно если она промахивается мимо президент на страницу она вызывает как бы там а и перекладывание страниц с дисков память и обратно ты первый факт второй фактор то что в живым если у нас даже один поток наступил на страницу который в памяти нет это может привести к фрезу все и всех потоков и tdm потому что есть такой механизм сайт который используется там в живём для всякой черной магии вроде перекомпиляции кода на лиду сборки мусора и и так далее они происходят нечасто но происходят в принципе если они происходят там раз низко секунд это нормально если один поток наступил напоить вот и ждет пока я к нему приедет страница то живым не может войти нормально вот в этот состояние своих point а потому что она не получил подтверждение от вот этого потока который ждет пока к нему приедет страницы памяти а все остальные потоки все они себя уже остановили сказали все как бы мы ждем отмашки все стают ждут но это нечестно потока вот поэтому как только у вас начинается пейджинг у вас может начаться очень драматическая деградация перфоманса тех java процессов которые у вас на этой системе работает второе java никогда не отдает память операционной системе вот вы и сказали использовать 10 мегабайт она будет их использовать даже если они ей сейчас не очень нужны она вам их обратно не отдаст технически есть как бы сборщики мусора которые умеют это делать но в речь идет про he и сборщики мусора которые технически умеют это делать не надо рассчитывать что они будут это делать потому что логика работы сборщиком мусора она какая он либо использует меньше больше циpкa либо он использует больше память если вы ему разрешили использовать 10 мегабайт значит он как бы разумно предполагает что лучше я циpкa по экономлю а вот вот эти 10 гигабайт с мусором а не пуская там сидят по это самое лежат за то цикл будет занят чем-то полезным поэтому как бы желание отдавать память обратно операционной системе в г н особо нет и поэтому важно как бы правильно обоснованно выставлять размер m и соответственно если у вас несколько процессов в рамках одного контейнера валенках одного борца делать нормально к пасте пошли опять же если вы сделаете верка мид то у вас потихонечку вот эти вот все живым подрастут а потом у них еще там актриса тоже подрастут и память закончится и начнется swapping и в чем страдать будут все кто находится на этом боксе окей что происходит когда память кончается тут опять же как бы вот казалось бы на это же ситуация очень по-разному сказать обрабатывается в менталитете джазистов и с тем что происходит в линус как у нас это происходит в java вот у нас есть какой-то код нас есть оператор new который выделяет объектом в данном случае какой-то большой массив об happy места нет выделить этот большой массив не можем все на этой строчке мы получаем out of memory р в линуксе все по другому то есть 10 гигабайт пожалуйста дальше вы начинаете что-то с ним работать но это естественно условный код вот жаль такого происходить не может потому что если вы взяли за вас и равале объект ну то есть массив допустим на там 100 миллионов элементов the gm пробежится и зал улиц всю эту память и пока он будет загулять она соответственно вот эти вот все страницы подтянет то есть если даже в системе памяти нету она как бы упадет в этот момент ну так сказать идеологически у вас ситуация нехватки памяти она сработает не тот момент когда вы запросили память а тот момент когда вы начинаете использовать то есть в принципе это может быть совершенно неожиданный для вас момент в джим тоже на самом деле out of memory at большая неожиданность потому что она как бы может выстрелить совсем не в том потоке который там реально сожрал все эти 10 гигабайт нашего hippo условного а совершенно не видно мотоки которые там какие-нибудь две строки дешего сложить чтобы бог строчку записать и тут бац и ему на как бы не хватило печалька exception а этот поток был как бы вот лагер и тот кто его писал он думал этот поток должен работать несмотря ни на что поэтому я поставлю trike с отловлю все exception-ы включая эры и буду их игнорит 2 with out of memory on our процесс продолжает жить но страдает немножко больше деталей как это происходит в java у нас есть называем область молодых объектов будет старых когда мы выделяем новый объект вызываемый продажа tor new он выделяется в пространстве молодых объектов если вместо в пространство и молодых объектов закончена this could молодая сборка если молодая сборка там по каким-то причинам лишает что нет молодой сборки недостаточно происходит полная сборка суть в том что первое если у нас не хватает память у нас происходит сборка и прежде чем у нас произойдет out of man вера это будет полная сборка то есть такая неспешная через весь наш 10 гигабайтный хип в некоторых случаях хочу в один поток потому что как бы fuji see the exception of кейс поэтому в тех сборщиков мусора которые ориентированы на малое время пауз а он просто это самый таскать реализован в один поток потому что все равно уже поздно пить боржоми торопиться уже некуда уже все свои все равно правитель а вот при этом сборщик мусора наверняка чего-нибудь да наскребёт но если этого чего-нибудь меньше чем 5 процентов от размера hippo все равно будет выброшен out of memory р потому что ну это как бы уже не жизнь это уже сплошное мучение но при этом если этот out of memory р произойдет в каком-то странном потоки в котик автор которого решил что ему на все до лампочки его поток должен работать он может как бы эту агонию продлять путем отлавливания exception of вообще в принципе по словам как у вас остального out of memory оранжевым уже не желаю там могу могли не освободится какие-то блоки там как бы вы уже внутри не станем может быть разрушена и есть такая опция которая на out of memory позволяет вызвать какую-то команду шила и вот как бы есть опция возможность сразу убить этот процесс опять же есть нюансы если у вас размер живым сопоставим с размером физической памяти бокса то в момент вот вызова вот этой команды show вас произойдет форк этот форт про приведет к тому что у вас адресная то есть вот это вот образ живым за дублируются и с точки зрения linux может немножечко превысить предел вот это вот максимальной памяти под которой он так сказать это самая готов выложиться и это команда не сработает такое такая проблема типичный для ходу серверов когда вот у вас там такая здоровая hadoop надо начать пытается какой-то питон через шанс запустить операционной системы нет давай не сегодня что у меня память и естественно как бы естественно этому экзо и как вот этому тела столько памяти не нужно просто форк он делает копию всего а потом уже потом уже отдает вот этот потом не всегда наступает вот эти процессы очень большой это как бы нормально работает может быть другая ситуация может быть такая ситуация что у вас хип еще не максимального размера то есть у вас произошло как бы у вас произошла сборка мусора сборка мусора не собрала достаточно памяти джим решил что надо увеличить ип пошла к операционной системы говорит дай мне больше памяти операционной системы нет ну правда как я уже сказал linux так не говорит в другие системы говорят любая ошибка выделение памяти операционной системы с точки зрения джедаем от всех краж без вопросов никаких exception of не никаких волков только вот стандартные граждан по живым процесс терменируют сразу ищут 2 типа out of номере который связан с так называемыми директ мусорами это специальные объекты в жаре которые ссылаются на память вне hippo и соответственно они же ее его целуют они управляют жизненным циклом этой памяти то есть там под капотом сборщик мусора все равно освобождает ну соответственно чтобы вот такими буферами нельзя было за ликовать бесконечно большое количество памяти на них есть элемент это лимит который джим сама себе выставляет иногда возникает необходимость его подкорректировать на что естественно есть магическое xx опция вот это вот вот в отличие от нормального out of memory вот этот out of memory recover был потому что он возникает в определенном месте при вызове о локации буфера и у него есть как бы возможность его отличить от того out of memory эра которые не ли кадров и того как я уже говорил г-н на старте важно знать сколько вы ей память и позволяете использовать про что из этого строятся все эвристики сборщика мусора сколько выделять память и в граммах это вопрос сложно я как бы только основные тезисы сейчас проговорю первое вы должны понимать какой у вас вай все то то есть то количество полезных объектов которые вы должны жить в памятью постоянно не то правильнее всего измерять эмпирических потому что иначе как достаточно сложно производить теста там делать хип дамб и смотреть вот какую какой у вас из чего состоит ваш тип и и как он будет соответственно расти там при увеличении числа запросов привлечение количество данных так далее помимо вообще-то у вас есть молодое поколение которая там либо берется по умолчанию каким-то процентом от типа либо выставляется динамически там например если вы используете дживан коллектор то как раз его фишка в том что сам умеет правильно выбирать размере on space а для остальных сборщиков мусора лучше его выставлять руками опять же исходя из эмпирических соображений вот и того общий размер вашей куча вот этот вот магический минус x mx это размер молодого поколения размер вальс это и резерв резерв сборщику мусора нужен обязательно потому что для того чтобы собирать мусор этот мусор где-то должен в память быть если у вас как бы чем больше у вас память и мусора тем меньше циpкa будет тратиться на там 1 гигабайта света освобожденный памяти это баланс но как бы его нельзя выкрутить в ноль никогда какой должен быть резерв это зависит от того от особенностей вашего приложения это зависит от сборщик мусора ну как правило надо начинать там с цифры 30 процентов и дальше смотреть хуже лучше и но это все относится к сайдингу типа помимо hippo есть еще директ буфера есть еще раз таки потоков есть еще какой-то overhead отжим которая опять же надо исходя из определенного приложения определите эмпирически таким образом у вас footprint процесса в целом всегда будет больше чем xml и надо это понимать и это как бы не просто какой-то процент это вот именно факторы вроде количество потоков и других особенностей двигаясь дальше вот в линуксе есть еще такая штука как у лимит вот из джазистов кто знает что такое у лимита так ну практически никто вот это такая странная конструкция на мой взгляд на мой взгляд как джазиста когда насчет линуксоидов не знаю может быть для них кажется это вполне естественно нас для процесса есть набор квот который соответственно операционная система enforcer кого то есть разная есть там на количество открытых файлов чтобы понятно логично вот еще на какие то другие вещи для вот именно управления ресурсами у лимиты работают не очень потом силу своих обстоятельств его того как они работают с деревом только для того чтобы там ограничивать рисуется контейнера используется другой инструмент вот в у лимитах есть максимальный размер памяти который на линуксе не работает но там же есть еще максимальный размер виртуальной памяти вот такая интересная штука потому что как я уже говорил виртуальная память и она в принципе не ресурс принципе от того что я выделю 100 терабайт адресного пространства зарезервирую операционной системе ни холодно ни жарко она мне скорее всего не даст этого сделать пока я вот для своего процесса вот эти вот у лимита не подкручу с они управляются там на на уровне шоу то есть и соответственно наследуется между процессами вот и по умолчанию вот этот лимит стоит и этот лимит он может как бы помешать запускаться вас вашей jewel особенно опять же если ваш отжимаем сопоставимых размерах физической памяти потому что его default часто как бы считается как раз от размера физической памяти и начинается такой вот немножко недоумение у меня сервер на нем 500 гигабайт я пытаюсь запустить живым на 400 гигабайт она наговорит мы просто падает на загрузке skiing непонятными ошибками с каким-то стектрейсы мы с личного кода и мне не очень понятно вот выясняется что вот она на старте выделяет себе все вот эти адресные пространства и в какой-то момент операционной системе нет четко много загадочного пространство мне жалко и как я уже сказал в этом случае чего им просто умирает вот и поэтому иногда этот параметрам нужен почти не бывает другие клинические ситуации когда люди почему-то решают что вот этот если у нас живым там дней выделено 20 гигабайт вот на этом сервере то надо ей размер виртуального адресного пространства тоже вы строитель 20 гигабайт эта проблема потому что вот какие-то участки памяти которые джем резервируют но никогда не использует ты не достаточно много они никогда не будут использованы вы таким образом намного сильнее ограничиваете ресурсы памяти этого процесса нежели чем вы можете подумать поэтому обращаясь к лицу и там пожалуйста не делайте так жалейте своих юристов пару слов про dota не столько про докер сколько про управление ресурсами в контейнеры в докере управления ресурсами для контейнеров работает через механизм си groups это механизм hydra который позволяет для дерева процессов ограничить ресурсы все возможные ресурсы циpкa память в том числе и для памяти можно ограничить размер резидентной памяти занимая всем контейнером количество slope количество стали замом пленных и эти элементы в отличие от пулемётов нормальный лимиты на на весь контейнер которые там если process for кайт каких дочерние процессы то они попадают в ту же группа ограничения ресурсов вот что важно 1 если вы запускаете java в докер она смотрит сколько на процент на хвосте физической памяти она видит сколько физической памяти реально на х стене в своем контейнеры и из этого считает свои дефолта и очень быстро умирает потому что и есть только не дают поэтому минус x mx как бы обязательно без него не взлетит второе вы делаете контейнер на допустим 2 гигабайта запускаете джеймс параметрам минус x mx 2 гигабайт 32 гигабайта под хит ну как-то взлетает потому что памяти она целуется лениво но как бы потихонечку вот эти вот все страницы они так или иначе начинают использоваться и сначала ваш вот этот вот контейнер начинает уходить в своп то что у него там как бы свой есть вокальный своп а потом просто умирает чем умирает он в лучших традициях он просто исчезает в том самом 11 вы можете там потом найти врага что контейнер превысил свой уход по лесу ресурсов был остановлен так что имейте в виду как бы всегда надо под контейнер давать немножко больше и если она просто стартовала это еще ничего не значит потому что ресурс выделяются реально ленивый какое-то время поработав на поводив потоков там увеличили пас того как раз таки потоков подрастут потому что они тоже вызывается лениво поток стартанули у него там 4 килобайта под старость достаточно то что он еще никаких вызовов не делал а блок вам прилетает какой-нибудь запрос который вы там парте джейсон генерируете html ли еще что то страшное со стрессом на пол 1000 фреймов и внезапно он вырастает на соответствующих размеров и память вашим и из ваших вот и вытягивает потоки что важно знать про джо узкие потоки то что java узкий поток и это нормальной потоки операционной системы когда-то 1 г н у них были реализованы так называемый грэм грин 3d дивизионные потоки когда на самом деле как бы стек java потока это вам ну как-то жил своей жизнью я один предоперационной система выполнял то один java поток то другой вот это как бы все развивалось до тех пор пока в операционных системах не починили нормально многопоточности вот и после этого как бы все это забыть как страшный сон потому что с нативными потоками код работает лучше и соответственно это значит что ваши java фск еэс так trace и на полу 1000 фреймов они реально лежат в том пространстве т.к. который выделил операционная система это значит что это значит что если вы вызываете какой-то нативный код он тоже живет в том же самом фредди и это значит что вы в принципе можете использовать диагностический инструмент который у вас есть в linux для работы с java узкими потоками тоже как найти джо узкие потоки но вот если мы воспользуемся командой ps для gm мы видим вот такую непонятную картину то все потоки называются одинаково но на практике там сначала идут потоки сборщика мусора потом идет так называемый операционный 3g м потом уже идут applications потоки но как бы это так наугад на самом деле если вы воспользуетесь не снимете трендом г-н с помощью команды джейс так из детей то в этом 3 дампе вот там вот есть такой шестнадцатеричное число птиц это если это как быть это реального для нового потока то есть вы можете понять что как какие у вас java потоки соответствует какими потоком операционной системы и погребать ps вот единственное если вы это сама уже как бы видите как вы напишете 1 скрипт который будет это делать не вызывайте джейс так в цикле лучше лучше наоборот потому что каждый раз когда вы вызываете джейс так вы вызываете стоп аут паузу то есть все g em чтобы снять продам по на все потоки останавливает снимает родам как бы идет дальше это обычно быстро то есть это меньше чем было секунду полмиллисекунды прошу прощения в нормальных обстоятельствах на если вы это будете делать 20 раз в секунду это как бы может немножечко за аффекте performance вашего приложения либо можно вытащить эту информацию самой джулиан желаем есть а там свой диагностический интерфейс вот ну и в частности вот можете воспользоваться моим аян злыми инструментом который оттуда эту информацию вытягивает и просто для живем впечатляет а такого-то по потокам помимо циpкa usa же он еще умеет печатать количество интенсивности локации в секунду сколько потока за лоцировать данных на java happy это уже внутренней статистике подводя итог жалкие потоки это обычные потоки операционной системы вы можете использовать обычный тулы есть в современных версиях ну относительно свежих версиях я вот такой ключ к preserve and winter это опция оптимизации jet компилятора который позволяет а вот эти вот стыке java кода сделать парса был для всяких слов типа перф а которые ходят по стыку и соответственно резолвится также есть на гитхабе проект который позволяет экспортировать на лету символы для скомпилирована я укутаю в принципе там тем же самым первым можете получить вполне читабельно stack trace джайнских вызовов вместе там с вызовами tab samsung вот и небольшой напоминаем то что у нас как бы есть еще потоки сборщика мусора если у вас контейнер на которому вы выделить два циpкa то надо количество параллельных потоков сборщика мусора тоже сделать два потому что по умолчанию будет больше и они будут только друг другу мешать другой стороны в тот момент когда работает сборщик мусора все остальные потоки не делают ничего поэтому подборщик можно же был мусором можно выделять вот как бы сто процентов ресурсов контейнеры которые вы собираетесь видеть и networking очень быстро первый тезис сетевой стояк linux надо тюмень проект про это очень хорошо помнит те кто занимается frontend серверами там где он нас крутится всякий джон x и так далее но вот то что то же самое в принципе неплохо бы делать на каких-то плетей шин серверах на пекин серверах проекта иногда забывают и она все как бы работает нормально до тех пор пока у вас к бессистемно не становится giau распределенной не начинает там через атлантику гонять данные между серверами и вот как бы оказывается надо было увеличить лимит на буфера и если вы используете и деби коммуникации и связь кусов работающий через дебит это требует отдельного тюнингом тоже на уровне операционной системы как бы есть опции которые как через ebay на сокетах африке щенку сам должен выставлять но они должны быть разрешены на уровне лимитов операционной системы иначе не просто не работают второй интересный момент это особенность работы с ресурсами в живые у нас есть как бы ограниченный ресурс у нас есть лимит на количество файлов там куда попадают стоки ты так далее для процесса если у нас от лимит превышен там и там не можем открывать соединение не можем открывать файлы для принимает соединение так далее с этим все понятно в java у нас принципе на всех этих объектах есть методы для того чтобы их явным образом закрывать и соответственно освобождать хэнка но если ленивый джавис этого не сделал то сборщик мусора придет и все равно как бы за него все закроет и все бы хорошо если бы это сборщик мусора приходил так сказать расписание он приходит не расписанием приходит когда посчитает нужным если у вас весь фильм забит сокетами незакрытыми с точки зрения hippo это копейки с точки зрения нуф-нуф теперь лежит только условно говоря хаттов мета-данные этого сокета и номер хинду из операционной системы и поэтому если у вас есть вот такая комбинация рисую внешних ресурсов на которые ссылается java код то сборщик мусора иногда может вести себя не очень адекватно в этом фоне поэтому их надо всегда закрывать руками и даже если у вас произошла ошибка на сокете все равно после того как вы сводили этот exception 105 надо закрыть потому что с точки зрения операционной системы то что она вам вернула кода ошибки вы в джаве получили exception это еще не значит что этот socket как бы закрыт он с точки зрения операционной системы будет продолжаться считаться открытом и операционной системы честно будет готова вернуть код ошибки совет последующего обращения к нему соответственно если она не делать то при каких-то там условно говоря мы чуть не правильно за конфигурировать у нас постоянно идет там connection refuse to ошибки , должным образом не закрывается и раз через от самый через два-три часа бы наш лимит на файл и закончился приложение стало совсем плохо есть пару ресурсов в живым которые нельзя освободить руками и но это уже как бы совет потому как писать java код с этим надо быть осторожным нельзя освободить явным образом мама ремонт fava и нельзя освободить буфера памяти и соответственно поэтому с ними надо работать аккуратно и не же желательно не выбрасывать опере использовать с точки зрения диагностики у нас есть тип дампа на которых вот эту всю информацию можно вытащить ну и наконец последнее напутствие выставлять правильный размер g em без этого она не очень работает в принципе учитесь пользоваться инструментами ввести как бы инструменты в линуксе которые работают java достаточно неплохо есть джей ди кей comand line инструмента которые позволяют вытаскивать достаточно много информации именно через кому 2 ментов и студии у нас есть джемете диагностический интерфейс для того что к ним работать нужен как бы другой java процесс что не всегда удобно есть альтернативы частности например можно сочетание плов если у вас есть core dump г-н линуксовые то вы например можете с помощью инструментов джедики вытащить из него аджарский хип дамб и посмотреть его уже хип дамп анализатором нормальным jalas к без того чтобы делать как бы этот хит дам непосредственно живого процесса ну и не забывайте про то что linux тоже надо чинить ним немножечко с ссылок на разные темы на этом у меня все спасибо вопросы задавайте пожалуйста микрофон здравствуйте спасибо так вот настройка xml xml цб это делается а вот немножко подробнее о настройке я наг live site какие принципы поменяйте это очень глубокая тема это как бы отдельный доклад размеры giants это влияет на частоту сборку мусора но опять же он влияет зависимости от того насколько активно ваше приложение работает память и насколько как бы вот этот режим работы с памятью него стационаре то есть если убить всплески и так далее ну проще говоря чем больше у вас елка тем реже у вас будут паузы молодой сборки если вы хотите уменьшить частоту пауз молодой сборки вы увеличиваете янка вот если вас устраивает честно то полосу ничего не трогайте да еще один вопрос по поводу открытых файлов но частности это создаются с соединениями сетевыми да как посмотреть сколько открытых файлов сгенерировано процессом сколько открыто файлов процессом я думаю для этого много не очень воде и linux пламя но уверен что это сделать можно как минимум впрок офис это то точно есть спасибо спасибо за доклад вопрос следующего и мы с помощью xml xml сможем настроить чтобы память при старте было сразу максимально если какие-то способы настроить так чтобы я его сразу же под все свои буфер выделила всю память и больше уже не обращал под все буферы нельзя про хипа но опять же xml xml памяти еще не будет потому что боимся он будет ли него чтобы вся память 2 вы длина еще надо сделать у вас при touch чтобы отжимаем прошлась ее подруга все страницы вот а для остальных буферов такой возможности нет потому что как правило они просто с большим запасом то есть есть например там всякие буферы связанные с метаданными они выделяются с запасом но если в вашем управлении нужно столько метаданных самых ненужных разогревать в линуксе надо понимать правила игры что вот у нас все такое ленивая и заранее зарезервировать все невозможно и еще по поводу опции когда происходит ошибка out of memory если обходные пути чтобы все-таки убить процесс нет ни форка я выделяю все память каких-то простых обходных путей я не знаю хорошему надо это сама чтобы в коде exception-ы обрабатывались адекватным образом спасибо тростян спасибо за доклад мы запускаем в докере jal приложение которое должен и в один большой jar ник и она стартует но очень долго видимо послушав вас это связано с тем что надо их все-таки разделять и dependency выкладывать отдельно и запуск такой медленный точно и разархивировать наверное долго даже если вы как бы рабле разобьете по низким джанни ко всем каждый jamming будет зафером всем этом происходит чтение каталогов всех проспался файлов на стать скорее всего медленный запуск связано не с тем что это один большой дальник с тем что именно происходит в если вы используете роковую джаву товар оковы джаве есть fight recorder который можно включить на старте соответственно он вам сделает regarding старта g em который вы потом сможете посмотреть мишин control в профайле посмотреть по коду за счет чего это тормозило он включается команду adoption то есть вы просто добавлять опцию стартуете вас там через какое-то время появляется файле которую можно открыть профайлер ом и еще вот в интернете есть и оптимизированные контейнеры для запуска java кода там уже говорят что все выставлено правильно настроенной перри переменные под выдача место и так далее вы что-то знаете нет я пока ничего не знаю но наверное это как бы сделать можно но я с такими контейнерами не работал потому что сказать не могу в принципе никакой магии нет надо там просто взять размер контейнеры выставить 7 равен и добрый день мне трудно представить что каждый раз человек кто настраивать систему делает это с ручкой в руках или на листочке если кит автоматизированные калькуляторы для подобных параметров знать какие такие параметры в размерах жевала java машины параметров операционки чтобы это было все в комплексе и как оптимально почиталось нет я про такие инструменты не знаю спасибо за доклад вот такой вопрос можно ли как-то избежать или него выделение памяти скажем есть какой-то как задача где надо быть тут точно уверена что у нас будет сколько-то памяти и заранее будь уверен что физическая память будет доступна как какой память памяти на happy about some terrific и да но если вы выдели объект например какой-то массив который вы собираетесь потом использовать тот момент выделения джером проходятся и все страницы этого массива обновляет ну и соответственно этим триггерит выделения физической памяти кроме того в принципе в линуксе есть еще возможность запретить slapping для процесса вызовом а мог и есть библиотеки которые для каких-то критических сервисов можно чуть живым соответственно замочить чтобы она не свалилась но как это надо использовать совместно я мог это против свой пинга соответственно заранее выделение объектов это для того чтобы зарезервировать уже физическую память спасибо добрый день а вы говорили что разработчики разрабатывают на винде например а потом запускают на линуксе до теоретически можно так предположить что разработчик например напортачила с кодировкой но первое такое что не запустится на линуксе если какие-нибудь вот интересные такие кейсы когда на винде работа это уже быстро а на линуксе медленной и как например это обойти или тому подобное то есть как какие-нибудь practice a для этого то что она на винде я работает нормально на linux работает бухать достаточно такие узкие кейсы которые как правило связаны со о то есть кодировкой в принципе ничего нам партой напортачить довольно сложно потому что распространяются jar файл jar файлы это зази кованый байт-код байт-код он там все все что в нем есть там уже в кодировке utf-8 без вариантов то есть там единственное что там с кодировкой и каких-нибудь juraev можно напортачить вот поэтому вот такие ситуации это все какие-то очень узкие вещи которые как бы универсального решения нет спасибо спасибо за доклад"
}