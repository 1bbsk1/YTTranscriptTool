{
  "video_id": "MnEXuKHjIOU",
  "channel": "HighLoadChannel",
  "title": "Миллион видеозвонков в сутки или позвони маме / Александр Тоболь (Одноклассники)",
  "views": 5304,
  "duration": 3189,
  "published": "2019-01-14T00:09:47-08:00",
  "text": "лично давайте поехали меня зовут александр я формы видео и ленты на одноклассниках а сегодня мы с вами будем говорить про сервис звонков сервис звонков выглядит с точки зрения пользователя довольно просто вы заходите к пользователю звоните он снимает трубку вы с ним разговариваете все снаружи выглядит все очень просто кто из вас знают как делать такие сервисы поднимите руку ну не очень много но человек 5-7 я насчитал хорошо что у нас ждёт в этом докладе я расскажу как вообще работают сервисы видеозвонков расскажу как пробивать над это возможно будет интересно еще людям из игровой сферы кому необходим перту пир соединения вот поговорим про в партесь и про то как он устроен про протоколы которые в него входят собственно говоря посмотрим как можно подтюнить в партесь и ну и собственно говоря сейчас у нас порядка миллиона звонков на одноклассниках и на самом деле это тысячи правильных звонков тут на самом деле не будет хайло да поэтому если кто-то его здесь ожидал то в принципе у вас еще есть время сменить зал отлично поехали на самом деле с чего началась история видеозвонков весов девятом году вот появился такой picture фон он стал крайне дорого использовал выделенные сети вот а в 2006 skype добавил в свое приложение видео-звонки 2010 году собственно говоря flash поддержал протокол rtmp и собственно говоря мы на одноклассниках запустили видео-звонки во флеше а вот в августе семнадцатого года chrome прекратил поддержку flash а ну точнее он 16мм прекратила нам семнадцатом пришлось перезапустить наши звонки на новые технологии о чем сегодня будет мой доклад вот после этого мы в течение полугода затемнили нашу наши звонки получили существенный прирост об этом я расскажу но и недавно у нас появились еще и маски звонках собственно варя архитектуры и тзк звонкам так как я работаю в социальной сети то технических заданий у нас нету и что такое тоже мы не знаем и обычно это все умещается в один слайд это выглядит примерно так пользователь хочет звонить с всё с android приложений другим пользователям другого пальцами может быть несколько устройств звонок приходит на оба устройства пользователь снимает трубку они разговаривают все просто сотни говорят для того чтобы нам сделать качественный сервис звонков нам нужно понять какие характеристики мы хотим отслеживать ну мы решили посмотреть с того что больше всего раздражает пользователя пользователи точно раздражает если он снимает трубку и видит вот такой connecting пальцами раздражает если у него плохое качество звонках что-то прерывается но больше всего пользователь раздражает задержкам звонках а звука нету да ну ладно наверняка многие знают этот стан датчик из камеди и представляют что собственно варя романы татьяна разговаривают интенсивы у раманы татьяны порядка пяти секунд и они абсолютно не понимают кто о чем говорит соответственно latency это одна из важных характеристик звонков и мы для себя решили что ну так вот кажется что допустим старт звонка хорошо делать за секунду делать connecting вас толкатель ответил качество это очень субъективная штука ее можно мерить psn арам соотношением сигнал-шум например но вот там есть пропадающие кадры артефакты мы скорее субъективно мерили качества и оценивали потом уже счастье пользователей ну и lighten7 меньше полусекунды я elite nazi не различаю если light in se больше полусекунды то на слуху уже слышите задержки начинаете прерывать друг друга вот например пример такой штуковинах кто это этим когда-нибудь пользовался вот отлично даже находясь где-то не далеко друг от друга вы наверно замечали что вы друг друга перебиваете вот соседних переговорах внутри офиса лейтон сеанс 1 3 секунды вот 13 секунд это прям уже так чтобы можно было друг друга начать не понимать если вы выйдете на две секунды это будет уже очень плохо по нагрузке так у нас уже была старая запущенная платформам и примерно ожидали что у нас будет миллион звонков день это 1000 звонков параллельно и даже если все звонки за руль и через сервер у вас будет 1000 звонков по мегабиту на звонок но это всего gigabit server 1 железка все можно сделать что нам будет мешать добиться таких классных характеристик нам будет мешать интернет в интернете существуют такие вещи как round trip time которые не побороть и есть переменная полоса пропускания который меняется есть такая штука как над соответственно предварительно мы померили сеть наших пользователей вот мы разбили ее по собственно говоря подключению наших мобильных пользователей посмотрели средний ртт пакет лосс скорости решили что будем наши звонки тестировать вот каких-то средних значениях каждой из этих сетей что еще у нас бывает в интернете интернете у нас бывает пакет лосс ну вот мы намерены 0 6 процента это рэндом пакет лосс есть еще конце шин packet loss если вы очень много вываливайте пакетов свою суде это начинает дропать или роутер ли еще что то этому не учитываем то есть это просто трендом по тепло с нам кажется упадка 0 6 в интернете бывают пещере ordering когда вы отправляйте пакеты в одном порядке он их пересортировать и бывает такая штука джипер вы вроде бы свой видео или аудио поток отдаете с определенным интервалом пакет и отправляйте она клиент они приходят склеенные пачками за счет буферизации и в интернете еще бывают в такие штуки как над на самом деле у нас получилось что больше 97 процентов пользователей находится за на там дальше поговорим потом почему что и как ну как бы теперь все вот эти параметры буквально на простом примере вот я у себя из офиса паппинга вал сайт новосибирского государства университета вот у меня такой странный pink получился собственно говоря средний джиттер здесь порядка 30 миллисекунд то есть пакеты интервал средний интервал между соседними временами пинга нас получился порядка 30 и собственно говоря средний pink получился там 105 миллисекунд собственно говоря что важно звонках почему бороться за птп ну очевидно что если вам удалось установить поэтому по соединение между нашими пользователями например которые пытаются в санкт-петербурге поговорить друг с другом они через сервер который ставить новосибирске мы сэкономим порядка там 100 миллисекунд раунд 3 по сэкономим джиттер у нас будет сэкономим трафик на этот сервис на спорт вообще все будет прекрасно поэтому большая часть доклада будет посвящено тому как бы нам все-таки сделать хорошее про тупо давайте начнем с историей как я уже говорю у нас был один сервис звонков десятого года мы переезжали на другой в 2006 году когда запускался skype flash купил такую компанию а мисима которая делает mfp у флэша уже и так был протокол rtmp который в принципе можно использовать для звонков часто используется для стриминга вот потом в flash залп он открыл спецификацию на свой протокол rtmp интересно зачем нужен был артемов pay в десятом когда мы запускались мы использовали именно арт mfp ну сравним какие требования к протоколам звонков до их протоколом реального стриминга и где граница это протокол rtmp это скорее протокол видео стриминга он использует tcp у него есть накапливающийся задержка если у вас хорошее интернет-соединение в принципе вы можете позвонки сделать на or темп и они будут работать вот а протокол rtmp несмотря на тысячи всего в одну букву это протокол и т.п. он лишён проблем буферов те которые вас есть на 10 вершин ходов line blocking а если кто не знает это когда у вас пропал один пакет эти цепи вам не отдает следующие пакеты до тех пор пока он не зари трансмиссии тот пропавший вот и собственно говоря артемов по умел справляться с на там и переживал смену айпи адреса клиентов поэтому мы запускали веб на артема в десятом году вот потом в партесь и появился только в одиннадцатом и не шел драфты общем он был совсем не живой вот 12 поддержали звонки на ios и android вот потом еще что то там по происходило и 2016 chrome прекратила поддержку флэша и нам пришлось что-то делать мы посмотрели на все эти протоколы voip а понятно что вроде что-то надо собирать но как всегда для того чтобы сделать что-то мы начинаем смотреть как брендов мы выбрали самых популярных конкурентов sky фото ap google до похож на хэнгаутс и собственно говоря ящики решили померить задержку ну как просто можно померить задержку мы это фотография некоторого измерения у нас есть на нем секундомер на нем видим какое-то время 308 дальше у нас есть звонок и на экране мы видим задержку в 10 миллисекунд то есть стал мента как изображение попала в камеру телефона вы его увидели порядка 10 миллисекунд она там прошло вот и потом у нас есть звонок на другой телефон который увидим еще одно время вот google да ну соответственно пока не буду раскрывать все карты но мы сделали так чтобы эти устройства не могли запереться конечно же измерения мы делали в разных сетях это просто пример вот но у нас получилось порядка там 390 миллисекунд у google два skype наверно если вы им пользователи все нам все-таки немножко перебивает вот у skype у нас выходит в случае если ему не удастся заперт у переца 13 секу миле от дина три секунды до тестовая среда у нас была сложная мы тестировали и в этих условиях учитывали и edge 3g и lte и учитывали что канал асимметричные все эти измерения это определенные средние значения также для того чтобы оценить расход батареи нагрузку на процессоры все остальное мы решили что можно померить просто температуру с телефона периметром и считать что это некоторое средняя нагрузка на джипе у телефона на процессор на аккумулятор и в принципе очень неприятно подносить к уху горячий телефон да и держать в руках кажется пользовались что сейчас этот приложение сожрет всю мою батарею так что у нас в итоге получилось самым медленным по задержками оказались a secure skype самым быстрым оказался здесь я добавил telegram это не совсем корректно или нет видеозвонков но зато по аудио конечно у него самой минимальной latency вот при этом еще классно работает вот со порядка 200 миллисекунд hangouts 390 по температуре меньше всех понятно есть телеграм без видео вот больше всех лет skype ну и это время ответа видно что на самом деле дольше всех соединений устанавливает telegram порядка трех секунд в это самый быстрый ватсап и и google да отлично москвы или какие-то метрики мы еще протестировали качество видео и голоса мы тестировали в разных сетях с разными тропами со всем остальным в принципе пришли к выводу что самое качественное видео на google до самый качественный голос на скайпе но это в плохих таких сетях когда уже китай скажем в целом все работает примерно средненько вот sopa самая за мыльная картинка собственно говоря теперь мы посмотрим на на чем это все реализовано ну skype понятно свой проприетарный протокол а вот все остальные остальные используют или куски из в партесь и или вообще напрямую в партесь и хэнгаутс google до ватсап facebook messenger они все работы могут работать с небом и у них у всех под капотом в партер они все такие разные с такими разными характеристиками у них один в партесь и соответственно нужно уметь его правильно готовить вот плюс есть телеграм у которого за аудио часть отвечает некоторые куски свои партии сие есть очка которая ford меловой партесь и очень давно и пошла развиваться своим путем посмотрим архитектуру в целом говорят что в партии есть некоторые сервис сигналь инга пальцер к нему конектится второй пользователь тоже конектится к этому серверу они устанавливают собой между какое-то между собой соединение и после этого обмениваются в голосом и видео ну начнем склоне простого дыма есть там такие простые пять шагов как типа установить его партесь из соединения вот в примере написаны взять видео забрать установить пир connection передать какие-то из сервера сразу в примере будет непонятно что это потом создать какой-то zippy offer и отправить его в signaling и signaling в партии сизо вас никак не имплементировать потом говоришь надо хендрик что-то преходящее signaling и он тоже не входит внутрь в партесь и потом поменяться какими-то кандидатами и собственно говоря вот отлично давайте все таки разберемся что же там происходит что нам нужно implemented есть часть вашего приложения и the web android ios signaling это ваш аппликация это все вам придется писать самим в партесь и вам этого не дает и есть библиотека в партии которая есть уже встроена в браузер поддерживается там chrome и firefox всем чем только можно и собственно говоря вы можете собрать подается android и общаться вы будете с ней через их api и через дискрипшн протокол в котором описывается сама сессии дальше расскажу что в него входит собстна горят план на наш сегодняшний доклад сначала мы обсудим все эти потом обсудим видео аудио и потом напишем свой signaling погнали как установить пир toupper соединение ну кажется довольно просто у нас есть алиса и боб они хотят вина и теперь toppers идеи берут свой айпи адрес у них есть какой-то сей раз сигнального котором они оба подключены они могут обменяться этими адресами они обмениваются адресами и и адреса у них одинаковые собственно говоря что что-то пошло не так на самом деле оба пользователей сидят скорее всего за вайфая роутерами и это на самом деле их локальные сервера ip адреса собственно раутер обеспечит им такую функцию как network адрес translation как она работает у вас есть какая-то серая подсети есть внешний айпи адрес вы отправляете какой-то пакет в интернет со своего серого адреса он подменяет над подменяет ваш серый на белые запоминает mapping то с какого порта он отправил какому пользователю какому порту соответствует когда приходит обратный пакетом поэтому маппингу резал вид и отправляет отправителю все просто как у меня это выглядит дома вот это мой внутренний айпи адрес это мой роутер это внешний адрес роутера и он кстати тоже серый вот если мы это свернем и посмотрим маршруту видим что это мой вайфай-роутер увидим пачку серых адресов провайдера и увидим внешне белый альпин таким образом на самом деле у меня будет два нато один над которыми она вольфа и другой еще у провайдера если я конечно не купил себе выделенный внешний айпи адрес отлично почему же на так популярен ну у нас ищут до сих пор многих айпи вы 4 и адресов не хватает он вроде как защищает сети кто-то говорит вот и это стандартно фича раутером такая те вай фай там сразу над он работает поэтому собственно говоря 3 процента пользователей без над а остальные все с на то что позволяет над над вам позволяет совершенно спокойно ходить на любые белые адреса но если вы на этот адрес не ходили на этот ток вам никто не может стукнуться для установки переступил соединение то проблемы то есть на самом деле друг другу алиса и боб не могут отправить пакет и если они оба находятся за натом это для в партесь и для решения этой проблемы есть такой протокол стану предлагается установить стан сервер как это работает алиса подключается к стан серверу получает свой айпи адрес через signaling от про этого бабу боб тоже получат свои пи адрес у них откроется какой-то май пинк вот вот они поменялись этими адресами теперь вопрос у алисы открыт порт определенный и уже пробить firewall это порт любому открыты они знают адреса друг друга вот алиса пытается отправить пакет бабу боб отправляет пакет алисе собственно варя кто думает что они смогут поговорить поднимите руки никто не потому что не смогут поговорить на самом деле и те и те правы зависит от типа нато на тоф бывает четыре типа вот давайте сейчас попробуем быстренько все пробежать будет трудно но надо сконцентрироваться результат поговорить о ней или нет будет зависеть от то от той поры на тоф которые есть у пользователей базовой версии алиса отправляет пакет нас там у нее открывается какой-то порт бабка кто узнает об ее партии то неважно он не отправляет обратный пакет если у нас это full clannad самый простой мы просто маппет внешний порт на внутренней the box можете отправить сразу же пакет устное соединения и урони поговорят в простой схеме это выглядит так алиса может с любого какого-то порта отправляет на порт стана пакет стан я отвечает ее внешним адресом стан может быть из любого адреса если у вас the fuck он на там все равно пробьет вот и боб можете ответить тоже на этот адрес ура restricted комнат тут чуть-чуть сложнее и собственно говоря если он запоминает не просто порций с которого нужно маппить на внутренний адрес он еще забирает внешне адрес на которые вы сходили то есть если вы пробили дырку то какая пистон сервера то никто другой уже сети не сможет вам ответить и тогда пакет баба не дойдет ну как это решается задача бог может отправить свой пакет алисе и алиса сможет пробить до него над в простой схеме это выглядит так алиса отправляет пакет на стан стан ей отвечает ее айпишник am стан можете отвечать в принципе с любого порта если то вас restrict con над бог не может ей ответить потому что у него другой адрес алисы ему отвечают пакетом зная ip адрес бабы он у него у нее открывается надо богу бог ей отвечает ура они поговорили чуть чуть более сложный вариант restricted con над порт restricted куна все тоже самое только стан должен отвечать ровно с того парта на который и к нему обращались тоже все будет работать и вот самая вредная штука это 7 track над вначале работает все точно также алиса отправляет стану пакет стан возвращает стану не может отвечать других портов ничего страшного бог тоже и не может ответить алиса проект пакет бабу и тут оп вроде бы не смотря на то что алиса отправляет пакет напор 444 mapping у нее в ей выделяется новый порт то есть asymmetric над отличается тем что при установке каждого нового соединения он каждый раз на маршрутизаторе выдает вам новый порт вот соответственно боб в бьется в тот порт с которого алиса ходила на стан и они не могут никак соединиться понятно что в обратную сторону если боб с открытым айпи адресом алиса может к нему просто прийти они установят соединения поэтому у нас получится такая табличка что в принципе от почти все возможно кроме случаев когда у вас 7 track пытается спорт restrict одному становиться или 7 такси метрикам есть вопрос или пойти попробовать пояснить почему собственно говоря спорт restricted не может 7 3com хорошо давайте еще раз попробуем если действительно трудно они всегда могут обменяться у них есть signaling они соединены друг с другом через signaling они всегда могут обменяться всех данными которые они про себя знают то есть алису знают свой api отправляет бобу просто это осталось здесь за картинкой то же самое боб узнает свой api отправляет его алисе вот да окей давайте дальше собственно говоря перту пью как мы выяснили это бесценно для нас в плане задержек клей tense но если этого не удалось сделать то в партесь и нам предлагает еще керн сервер когда мы поняли что у нас спирту пир не установится мы можем просто подключиться к черный он будет прокси ровать весь трафик поэта что вы будете платить за трафик пользователи возможно появятся некоторые дополнительные задержки практика в принципе стан сервера есть бесплатный у google можно их просто взять подставить библиотеку будет работать у утера серверов есть логин и пароль и и вам придется скорее всего поднять свой довольно трудно найти бесплатный мы используем к терн вот примеры гугловый серверов вот какой-то бесплатный терн сервер с паролями собстна говорят все запустили через спирту перу нас 34 процента ходит все остальное у нас собственно говоря пошло через торрент сервер прокси равата что еще интересного есть в стан протоколе стан может вам позволит определить тип на то при отправке пакета можно сказать что вы хотите получить ответ с такого же порта можете попросить станут ведь из другого борта можете просить ответил с другого айпи и вообще другого и перебор то можно просить ответить таким образом за 4 запросы к стан сервер можно определить тип на то мы посчитали типы на тоф и получилось ой почти у всех пользователей или 7 так или cпорт restricted поэтому такая плохая статистика потому что у нас за перелазь только 3 pro c 3 пользователей собственно говоря вот так все сложно зачем нафига вам это все рассказывал можно было просто взять стану гугла засунуть в пар все и вроде как работает а можно на самом деле тип над еще самим определить вот здесь есть ссылочка на java приложения она ничего хитрого не делает она пингует разные порты и разные стан сервера и смотрит какой видит она у себя порт в итоге если у вас открытый флакон над у вас все время один порт может быть привести где у вас на каждый сервер будут свои порты прессе метрики вот у меня в офисе вот такое там абсолютно разный порт но иногда встречается вот такая интересная закономерность что на каждый поход ваш партнер три месяца то есть у многих на тоф настроена так что они part in клементе ты леди клементе там на какую-то константу соответственно можно эту константу найти и таким образом пробить этот 7 track над вот таким образом пробиваем на отходим на один стан сервер на другой смотрим разницу сравниваем и пробуем еще раз отдать свой порт уже с этим инкремента и декремента другому то есть алиса пытается отдать богу свой порт уже поправлены на ту константу знаю что следующий раз у него будет именно такой вот таким образом нам еще удалось наварить 12 процентов перту пера что тут еще можно сделать на самом деле иногда внешние роутеры с одним и тем же api ведут себя одинаково поэтому если по собирать статистику если 7 track над эта фича провайдера они фичи wi-fi роутера пользователя то иногда дельту можно предсказать сразу же отправить ее пользователю чтобы он ей воспользовался и и не тратить лишнее время на вот определение ты разницы если же все таки даже это нам не помогло то когда мы используем тиран сервер и работаем не в порту перри аврелий моде передавая весь трафик через сервер можно еще добавить себе если у вас есть площадка у нас есть свои сидел площадке поэтому для нас было довольно просто мы это раскатали насидел надо было определить куда лучше отправлять человека управлять его населен площадку или допустим канал лучше до москвы это на самом деле не очень тривиально поэтому мы делали случайным образом вы давали некоторым пользователям московские площадке а некоторым выдавали удаленные и сравнивали собирали статистику по айпи пользователя потому на какой сервер ходил и по характеристикам сети по макс моменту сгруппировали под-сети посмотрели статистику и приняли решение нас что когда cam pulsar подключается мы по его айпи уже понимаем какой собственно говоря ближайший терн сервер для соединения ну и собственно варя у нас астаны терн в одном вот ему нужно выдать вот в новосибирске я сидел если у вас все работает через за москву то у вас вот средняя такое то там 99 перцентиль такой-то вот через седин все работает сильно быстрее всегда ли лучше использовать птп соединение и не использовать сервер вот интересные два провайдера optibelt и выбрав красноярске имена провайдеров может быть изменены были вот-вот между ними почему-то связь на пир toupper сильно хуже чем через muse колено и друг с другом не дружки вот поэтому мы тоже проанализировали все такие случаи рандомным образом отправляя пользователей на п тупые для через мск собрали статистику и тоже predicting дальше за титьку нужно управлять поэтому некоторых пользователем и мучимый рандомно их подкидываем куда-то чтобы проверить не изменилось ли что-то в сетях теперь вот мы померили такие простые характеристики crown time packet loss band все понятно как бы все легко как оценить что хорошо что плохо вот что лучше два мегабит из интернета 400 миллисекунд ртт пятипроцентный пакет лосс или 100 килобит 100 миллисекунд задержкой и там мизерный пакет лосс ну на самом деле хрен его знает поэтому мы добавили ну да сид на видео и его качестве то очень субъективная оценка поэтому мы в конце звонков собираем такие звездочки вот и по этим звездочкам itune ли наши константы которые говорили что там не знаю меньше 500 миллисекунд уже то есть точнее меньше там 300 миллисекунд ртт то уже не важно какой да и там важен сам битрейт смотрели какой пакет лосс насколько пользователь начинает заикаться и начать не нравится и вот наши средние оценки пользователей по android ios тут видно что ios пользователи чаще ставят единичку и чаще ставят пятерку вот не знаю почему наверное специфика платформы соответственно по таким вещам мы починили наши константы под то чтобы у нас было как нам кажется хорошо но вернёмся к нашему плану мы все еще сидим на пункте сеть и как собственно говоря и выглядит установка соединения вот потому плану есть какой-то пир connection мы туда отдаем наши стартером сервера он конектится алису знает свой api отправляет айпи signaling боб узнай узнает о папе алисы алиса получает айпи баба они обмениваются пакетами возможно пробивают на то возможно тёрн и общаются отлично собственно говоря вот в наших пяти шагах нам стало хотя бы понятно что такие что такое сервера где их взять и мы поняли что вот это а из кандидаты это собственно варя внешне api адреса это внутренняя и пи адреса клиентов если они вдруг внутри там 1 в альфа и находятся их тоже можно пробовать пробить вот то из кандидаты от наших внешне адреса и мы ими обмениваемся через signaling перейдем к части видео в партесь ее поддерживает видео аудио некоторый набор кодеков он extend расширяем и можно добавить до свой кодек если вы хотите базово там поддержка 264 8 по видео vp8 там софтверный поэтому он сильно живет батарею 264 не на всех устройствах обычно нативный в оттуда тащит вот приоритет стоит по умолчанию vp8 вот по ссылочке есть пример в котором можно в внутри саша исключен протокола существует такой коды книга шершня lga ритм когда вам один клиент отправляет список своих кодеков другой отправлять своих сверлить этом они договариваются какими кодеками они будут общаться вот я его можно пропарсить и поменять приоритеты при 8-ми 264 за счет этого вы можете сэкономить батарею на некоторых устройствах где 264 нативный вот мы так сделали нам показалось что пользователи не стали жаловаться на качество что нет разницы между 8 и 206 4 или мы ее не видим но при этом батарея живется сильно меньше по аудио там опус или g700 11 обычно у всех опус он всегда работает ничего с ним делать не надо вот мы сделали померили свою температуру то после десяти минут использования понятно что мы делали тесты разные устройства вот на айфонах мы собственно говоря живем меньше всех по этому самому по ну температура устройство меньше всего мы считаем что меньше всего используем secu и батарею вторая штука которую можно включить если вы пользуетесь в партесь и это автоматическое отключение видео при очень плохом коннекте если у вас меньше 40 кило бетон будет выключать надо всего-навсего выставить флажок при создании эти 40 кило бит тоже tunes этом есть интерфейс можно поправить что еще еще можно установить битрейт стартовый текущей которые у вас есть минимальный максимальный вот очень полезная штука если вы заранее знаете приставки соединения какой битрейт вы ожидаете вы можете его передать чтобы у вас быстрее начался звонок стала которого нужно они происходила адаптация плюс если вы знаете что вас на канале часто бывает packet loss или просадки то максимально тоже можно ограничить вот тот самый ватсап который работает с очень и мыльном виде он зато очень быстро с маленькими задержками он очень сильно сверху поджимает битрейт в собствен говоря мы бы собирали статистику так у нас max payne 3 легко еще на карту было нанести это примерно и качество стартовая которое мы используем для звонков на это среде понятное дело для пользователей ну и составе переходим к третьей части signaling который вам скорее всего придется написать если вы хотите сделать звонки и там много всяких подводных камней существует вспомним как это выглядит у нас есть наше приложение сигнале нгам которые коннекте c обменивается с детишками вот из детишки внизу является некоторым интерфейсом в партер как выглядит простой signaling алиса звонит бабу на подключается например по абсолютному соединению но это у нас на сами вы можете использовать любой rest это непринципиально боб получает например пуш на свой мобильный телефон или в браузере левка это открытое соединение подключается по веб-сайту и после этого ничего не начинает звонить в кармане телефон он снимает трубку а лиса ему отправляет свои протоколы которые свои кодеки которые у нее есть свои какие-то особенности вы партесь и которые она поддерживает вопли тоже отвечает тем же самым и после этого они обмениваются кандидатами которых они увидели ура звонок все выглядит довольно долго 1 пока вы установить высоких на соединение пока придет пуше все остальное у вас в кармане не будет звонить телефон алиса будет все время ждать думали где живу почему не берет трубку вот и собственно после акцепта вот здесь вот это все занимает секунды и даже на хороших connection ах это может 35 секунд ли в легкую вас занятия при плохих среди них это 10 надо с этим что-то делать ну вы мне скажете что можно вообще все сделать очень просто если у вас есть какое-то уже подключение вашего приложения открыто допустим там рестора connection the galley можно сразу же отправить пуш на установку соединение подключиться к серверу signaling а к нужному и в это время вообще после пуша уже можно начать звонить прямо в кармане все здорово и классно потом еще одна оптимизация даже если телефон все еще звонит в кармане вы не сняли трубку можно вообще поменяться на самом деле информация тех и вы кодеки поддерживается обменяться своими внешними api адресами вообще можно еще начать слать пустые видео пакетах вот и вообще у вас все будет прогретой как только вы снимите трубку все будет здорово но на самом деле мы так сделали казалось что все классно но нет первая проблема которая вам встретится что польза часто отменяют нажимает сразу же позвонить и тут же делать отмену ответственно он у вас уходит пуш на звонок дальше польский пропадает или у него пропадает интернет или еще что-то у кого-то телефон звонит он снимает и собственно говоря его там не ждут поэтому наша примитивная оптимизация с тем чтобы как можно быстрее начать звонить она на самом деле не работает 2 вредная штука которая есть при быстро и отмене и это что если вы генерируете айди вашего конверсий шина на сервере вам надо нужно дождаться response а то есть вы делаете от типа звонить у вас приходит одесской the conversations дальше вы можете с ней делать что хотите там отправлять пакет и обмениваться и в том числе от мини за вызов вот это очень плохая история потому что получается что пока у вас response не пришел вы не можете ничего отменить с клиента по факту поэтому лучше всего генерится какую-то диску на клиенте типа гуидо и собственно говорят говорит что вы начали звонок если вы отменяете отменять потому что люди еще часто идет позвонил отменил и сразу же позвонил чтобы это все не перепуталось делаете гуидо подправляя и отправляете ну ладно вроде все ничего но есть ещё одна проблема если у боба 2 телефона или у него еще где-то браузер остался открытый то вся наша магическая схема с тем чтобы обменяться пакетами установить соединение а не работает если он вдруг снял другого устройства вот стыд на что же делать вернемся к нашей базовой простой схеме сигнале нга медленный за оптимизируем и и понятное дело пушем отправим пушки чуть пораньше пользовали начнет побыстрее конектится но это какие-то копейки вы игры вот что же нам делать самой долгой частью поставок он снял трубку я начал обмен на самом деле тут можно поступить следующим образом понятное дело что алиса знают уже все свои кодеки и она может их выслать на оба телефона баба она может призвать все свои ай-пи адреса это же их может отправить на signaling который это при держит у себя в очереди не будет отправлять никому из клиентов чтобы не дай бог они начали к ней уже в конектится что может боб получив offer он может посмотреть какие там были кодеки сам сгенерировать свои написать что у него есть это же отправить но у боба 2 телефонной там разный кодек не гашиш и поэтому signaling это все при держат на себе и будет это держать в очередь до тех пор пока не узнает какое устройство с ними трубку вот собственно варя кандидатов своих тоже оба устройства с генерят и отправить на signaling таким образом сигналь него получается есть одна очередь сообщение от алисы несколько очередей сообщение от боба на разных устройствах вот он то все придерживает и как только один из этих устройств снимает трубку он это просто перекидывает вот так вот весь сюжет и набор подготовленных пакетов вот это работает довольно быстро у нас получилось вот выйти на те цифры которые есть у google да и ватсап а вот таким алгоритмом вот наверно можно лучше что-то придумать как бы отправить собственно говоря несколько очередей держать не на signaling и отправить их на клиенты потом сказать какой номер на но тут уже сильно не выиграешь мы этом решили остановиться какие вас еще там ждут проблемы бывают такая штука как встречный звонок один начал звонить другому другой звонит классно было бы еслиб они не пытались там как то конкурировать а на уровне сигнале нга добавить вам нужно будет команду которая скажет что если кто-то пришел вторым то переключить в режим к а ты просто принимаешь вызов и сразу же снять трубку вот как еще нужно делать так что сеть у нас пропадает сообщение теряются поэтому все лучше делать через очереди то есть вас должна быть на клиенте очередь отправки и сообщения которые вы отправляетесь клиента должны удаляться из очереди исключительно после того как сервер подтвердил что он обработал ну и у сервера также есть очередь на отправку тоже с подтверждением как собственно говоря это все реализовано внутри с учетом того что мы хотим у нас service 24 на 7 мы хотим иметь возможность терять дата-центра перекладывать обновлять версию нашего по собственно варя клиенты конектится по выпсуке ту на какой-то лот балансер он отправляет на какие-то сервера signaling of разных дата-центрах разные клиенты могут прийти на разные сервера на звуки перри мы делаем лидер election который собственно варя определяет тот сэр сигнале нга который сейчас управляет этим конверсий шинам вот соответственно если сервер не является лидером этого конверсий шина вам просто все сообщения прокидывает другому и дальше мы используем к некоторые распределенное хранилище у нас это не успел поверх кассандры такая хитрая штука на самом деле не важно что можно куда угодно сохранять состояние всех очередей которые на signaling есть кому что нужно отправить для того что если у вас пропадет сервер сигнале нга выключится электричество еще что-то сработать лидер election языки перри поднимется другой сервер выберется лидером он из базы от восстановит все очереди сообщений которые были и начнет собственно говоря отправлять то есть горит выглядит так клиент отправляет какое-то сообщение там не знаешь своего свой внешний айпи на signaling signaling принимает комитета в базу поставок понял что не все прошло он отвечает я этот пакет принял клиенты у себя из очереди выкидывает все пакеты понятно снабжаем уникальными номерами чтобы не путаться собственно говоря с точки зрения базы данных вас используются некоторая отстройка от кассандры которые нам транзакции позволяют на ней делать здесь есть видео про эту штуку собственно говоря что же вы теперь узнали узнали что такое сервера как их передать узнали что есть некоторый station description протокол и собственно говоря необходимо его сгенерировать и отправить на другую сторону узнали что его нужно принять и signaling а передать в партесь и на другой стороне обменяться внешними айпи адресами и собственно говоря начать отправлять видео что получилось у нас мы получили звонки с таким сделаем ниже среднего по рынку мы не очень сильно нагрели телефоны и мы на в топовом уровне снимаем трубку здорово еще такая дополнительная плюшка в партесь и мы поговорим в промо нам за медов в партер в порто c очень на самом деле трудный протокол в плане того что он базируется на ртп который с 96 года из 98 sepo пришел а вот внизу этот огромный список это куча россии всяких extension of car т.п. которые делают ртп выбор tc вот там первые два rfc такая интересная штука один раз и добавляет в пакет и аудиалов а другой roxy говорит что не secure открыто передавать аудиал его в пакетах его шифрует и соответственно когда у вас вы обмениваетесь с детишками вам важно знать какой набор extension of поддерживает один клиент какой другой там несколько даже алгоритмов канзаши на несколько алгоритмов восстановления потерянных пакетов и всего всего всего вот историю него была сложная в одиннадцатом году был первый драфта вы собственно говоря релиз в 13 firefox поддержал потом он стал собираться в тринадцатом на ios android четырнадцатом опера много много лет он развивался вот но он не решает одну интересную задачу а когда алиса и боб подключаются к сигнале мгу после этого они использую этот канал установлю dts хеншель каются устанавливать безопасное соединение все здорово но если это не наш signaling оказался то в принципе у человека посередине скажем так есть возможность по ханши каца и солисты с богом за прокси ровать весь трафик и собственно говоря подслушать то что там происходит как можно это решать ну если у вас сервис с высоким доверием то конечно же используется взять находить ps или томск черный websocket и и так далее а вот есть еще интересное решение сеттер т.п. его использует например telegram кто не в телеграме видел и маджики когда устанавливается соединение а кто ими пользовался поднимите руку буквально 5 человек вот на самом деле да если вы другу скажите ему аджики он проверит что у него точно такие же то вас абсолютно гарантированная пир toupper соединение безопасны как это работает ну на самом деле внутри всех этих протоколов изначально обычный диффи-хеллмана то есть алиса генерирует некоторые числа не буду вдаваться кто хочет прочтете довольно простая штука генерирует некоторые числа отправляют их бабу не все оставляю себя одно бог генерирует тоже у тебя случайное число вычисляет отправляет алисе вот в результате этого обмена у алисы и боба получается некоторое большое число к которой человек посередине который прослушал весе их канал про него ничего не знает не может никак догадаться вот все здорово когда у вас появляется между ними дэйв вы с некоторым дэйвом обмениваетесь этими же ключами у вас получается некоторых ключ к 1 и боб обменивается с дэйвом ключа меня получается co2 вот и не как отследить что у вас этого человека посереди нет возможности тогда делается такая хака мы по эти ключи будут точно разные так как алиса генерировала своих скуд ключи случайно боб генерировал свои ключ цифры знать свои числа изначально случайно то k1 и k2 у девы будут разные вот таким образом мы просто берем некоторых ешь от k1 и k2 и отображаемого вы маджики в яблоке в груше во все что угодно вот и люди голосом просто называют те картинки которые они видят и если эти картинки разные так его по голосу друг друга можете идентифицировать вот если эти картинки разные то кто-то между вами есть и возможно он вас слушает вот ну ладно что у нас в результате в результате мы на маниле на тайп наших пользователей мы статистически оценили что лучше птп relay качество когда нужно делать седины и повысили качество в звездочках точки зрения пользователей вот поменяли приоритеты коды к вам сэкономить немножко батарею и минимизировать задержку на сигнале нге видно что вот это старые звонки были на артемов б потом на в партесь и мы перешли там небольшой пик вниз а потом вверх не все сразу получилось вот и в итоге у нас сейчас количество ставь звонков выросло в четыре раза собственного ряд если вам все это на хрен не надо есть очень простая инструкция можно скачать с в партесь и код его можно собрать подает под android в браузерах он уже во всех есть можно power развернуть у себя к терн написать signaling и в принципе уже будет звонить и будет звонить довольно неплохо всё спасибо вам всем за внимание переходим тогда к части вопросов у кого есть вопрос давайте пока еще думать на секундочку вас перебью пока вы думаете над вопросами скажу вот здесь есть мой e-mail если вы вдруг не успеете задать свой вопрос не успеете сегодня вы вспомните про вопрос завтра у вас вопрос вообще не про видео-звонки а не знаю про video streaming или про ленту вы все эти вопросы в течение недели можете мне задать я обязательно них отвечу или от for jack тому человеку который на ваши вопросы ответит поэтому просто пишите что вы с хайло да я буду разгребать почвы отвечать спасибо вам большое давайте вопросы через неделю почта превратится в тыкву спасибо большое очень было интересно у меня чисто практический вопрос очень сложную инфраструктуру получается понятно что я сложно чистить вы же наверняка построили разные тестовые стенды которые эмулирует работу такого на такси кого на а то за ужа youth канал имитирует таких волос и прочее как вы это сделали расскажи поподробнее ставили разные вайфай-роутер и настраивали есть еще у нас просто есть отдельно тестовый отдел которое этим занимается название не вспомни есть в фейсбуке на ли либо которое накатывается на собственно говоря нам господи на роутер наверно накатывается людей такая коннекте сейфа и выбираете разные профили которые у вас есть для конкретного пользователя вы их получаете если вы спросите в письме я вам отвечу как это называется как это поставить соответственно понятно что мы по настраивали разные типы сетей и тестировали локально ну а дальше как всегда выбираешь часть пользовательской аудитории запускаешь по б новые звонки старые и сравниваешь стало лучше или стало хуже известно обратную совместимость для этих пользовались всех тоже с по звонкам поддерживали в плане того что если пользователь со старыми звонками звонил пользу с новыми они могли поговорить и если новый звонил старым они тоже договорились и понимали что у них только старые звонки могут быть они использовали старые поэтому мы не то чтобы резко все рубанули потому что не знаю android ну у нас в продакшене обновляется больше года то есть для того чтобы хотя бы 90 процентов пользователей в итоге обновились на новую версию приложения давайте сначала здесь давайте вопрос многие роутеры поддерживают домашние проброса портов настройку автоматическую про бруски портов не пробовали это прикрутить мтюм изначально в скайпе был внутри в партии see you paint и не встроен и google говорит что это очень плохая идея потому что не все его поддерживают и что вроде как через тан тюрон это будет лучше мы не пробовали но идею рассматривали принципе может быть стоит попробовать еще вопросы спасибо большое за очень интересный доклад а скажите нет легко не требованию закона по которому к вам может прийти товарищ майор и сказать что а я вот хочу это все слушать и как тогда со всей серьезностью p2p это все будет работать спасибо ну на самом деле давайте я не буду комментировать это все у вас в принципе есть заперта пеппа которому я вам рассказал что вы можете что-то определить а что с этим делать у вас есть вся информация но смысле не может ли быть такого что у вас будет проблема из за того что вы не сможете удовлетворить нервы могут могут быть проблемы дальше отсюда во всех был очень интересно у меня вопрос такое вначале вы сказали что вы отцепи уж liceul de pe для того чтобы ускориться а в конце появились очереди и проверки высовывания пакетов это не очереди видеоаудио это очереди работа сигнале нгам там где у вас потеря какой-либо команды приведет к поломке всего алгоритм обмена сообщениями то есть понятное дело что видео аудио остаются ну и т.п. они дропают как-то это обрабатывается либо на каме либо там уже кодек вскипает пакеты то есть аудио видео конечно приоритетно на и т.п. но если у вас в дипе закрыта он будет делать это по тисе пи спасибо за доклад вопрос я не понял над вы чем пробиваете миссисипи же пробиваете не уточнили только у диппера можно про и такой то такой над до даю т.п. только-только и теперь но на самом деле 90 процентов я не добавил тесла 98 по моему процентов мы оценивали пользователи имеют открытые работающий о типе то есть сейчас если вы знаете протокол к виться от google на youtube если вы ходите с хрома в youtube вы походите по и т.п. звонки пою т.п. игры пою т.п. в общем найти сейчас провайдера который вам год получил youtube и очень трудно спасибо за так вот там мужчина до перекрасить и пожалуйста на кадр fast signaling с базовым signaling am fast signaling он да да да который который не очень рабочий но в принципе неважно можно любой да он да я был вопрос вот эти вот offer answers candidates они все летят уже уже после пушей почему нельзя список поддерживаемых кодеков слать напрямую вместе с пушем тем более он вряд ли часто меняется его дар закодировать можно типа это здешний запрос выглядит да можно и так оптимизировать но я же ну как бы объяснял почему это не работает в плане того что нужно придержать все равно ваш offer a придержать на сигнале нге то есть в принципе можно действительно ну в смысле не offer то есть кандидатов подержать на сигнальной и в принципе ваш offer можно отправить в пуш и принципе можно отправить в пуша да спасибо еще у кого есть вопросы здравствуйте кэширование у вас используется не используется вот как раз на слайде обсуждали используете ли вы кэширования на сигнале нге а что такое кэширование но вы запоминаете для некоторых вас устройство определенные странное происходит на экране определенные кандидат определенные типы характеристики что там какие используются кодеки на устройстве и так далее итак ашер уйти нет ни каширы в принципе устройство довольно быстро это может получить у себя можно попробовать замерить время получения этой информации можно его закрашивать на самом устройстве на клиенте но кэшировать надо на сигнале нге все равно основная штука это кандидаты то есть идея такая вы посылаете push что вы кому-то звонить и и в это время начинаете рисует свой айпи адреса и пробивать над моменту когда он с ними трубку в идеальном случае вы все свои ай-пи адреса уже доставили сигнале нгу чтобы он мог прокинуть поэтому в за это время в принципе вау там получения своих коды кофанова просто ну ничтожно мало но пока вы пробиваете над вы точно успеете получить все свою внутреннюю информацию с устройства это понятно а это не будет лишней информацией но мы же это все все равно отсылаем сигнале нгу это дополнительный запрос дополнительные дополнительные какие-то не знаю затраты на в принципе экономия на спичках это здорово можно сэкономить у вас в принципе видео аудио соединение и меньше от 10 20 кило бит аудио работать не будет уже но в принципе можно попробовать поэкономить пару кило базе на следующий год с такой стороны добрый день спасибо за доклад очень интересно мне только вопрос сталкивались ли вы с проблемы несовместимости кодеков на разных видео кодеков на разных устройствах я поделюсь немножко своей боли и объяснил очами например сафари ну не совсем оттуда it но вот постоянно полгода назад сафари только h264 поддерживал допустим какие-то слабые андроиды поддерживали только в bios что вы с этим делали и но может клубы какой-то или как как у вас это все ничего не делали то есть если они не смогут по кода книга шифрин договориться и одного только 264 а у другого vp8 то мы в данном случае ничего не делаем то есть как бы устройство не сошлись купившим ошибку вот я в принципе думаю что сафари сейчас должен поддерживать уже 8 но и плюс у нас на двести шестьдесят четвертом там не знаю больше ну точно больше 90 процентов устройств поддерживать 264 есть еще х к 1 можно с собой 264 притащить на устройство софт варны если вы претензии пройдете и там например возьмете либо к 264 то он прекрасно запустится и будет работать на вам придется код своего приложение открыть вот что тогда если закончили да если еще есть вопросы если есть время нет я к тому что если есть вопросы их можно дальше уже задавать на дискуссионной зоне и всегда у вас есть еще имела в течение недели до хотим поблагодарить александра за его доклад учить подарки от организаторов и благодарность"
}