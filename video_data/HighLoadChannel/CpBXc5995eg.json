{
  "video_id": "CpBXc5995eg",
  "channel": "HighLoadChannel",
  "title": "Как правильно и надежно убить MySQL / Владимир Федорков (ECOMMPAY)",
  "views": 3314,
  "duration": 2847,
  "published": "2021-10-04T02:44:45-07:00",
  "text": "всем привет мы сегодня будем говорить немножечко о других вещах нет ни от тех которые мы о которых мы говорим обычно просто потому что те вещи которые о которых мы говорим обычно уже всем надоели они скучные поэтому у нас сегодня самое главное что сегодня будет это дисклеймер не пробуйте это на своем роде не делаете это у себя дома потому что все работает ок также все отлично потому что если вы будете делать то чего мы сегодня говорим у вас обязательно будет downtime а мы хотим этого всеми силами избежать почему это доклад здесь ну изначально должны были говорить про всякие умные вещи там про обеспечения стабильности про прозрачность системы о том что коммуникация между эксплуатации разработка это очень важно но мы говорим практически постоянно очень много документации в интернете очень много блок-постов их никто не читает они никому не интересны они никому не нужны постоянно рассказываем об этом на конференциях вы можете погуглить связать из года в год из года в год одно и то же одно и то же система нужно держать прозрачную стабильную делать так чтобы все было понятно делать аккуратно делать тестирование делать аккуратные релизы вообще никому не интересно вот просто некому дождь из года в год продакшен продают одни и те же самые проблемы поэтому мы решили мы приняли суровых ложное решение сменить таргета аудиторию наконец-то донести людям которые хотят повалить прот как это сделать максимально быстро и эффективно и при этом желательно не получить по шее ну вот будут только поскольку у нас перед здесь двое изначально я был один но я понял что я с такой сложной задачей могу не справится я пригласил свету смирнову она работают в тир коне и она вот точно знает как правильно вот идет а вот свет смирнова анна автор книги масику trouble shooting поэтому она абсолютно точно вот с примерами может сказать как как делать не надо работает в таких работала и работает таких малоизвестных компаний как массив в сан оракал ну и вот сейчас вот в пир кони расскажу немножечко себе как ты начинала карьеру я начинала category найти карьеру как веб-разработчик я работала ссоры то есть это такие вот когда пишешь в объектном стиле и программа сама пишет а потом из твоих объектов и сказал запросы но собственно я запер расплачиваюсь начиная с 2006 года когда стал работать именно инженером технической поддержки что люди приносят что они по написанию время мне это приходится делать чтобы она работала быстро да и мы отдельно извиняемся за звук если кому-то плохо слышно мы можем громче орать на лучше не будет поэтому будем будем стараться говорить чуть-чуть четче с тем хорошо слышно поднимите рукам у плохо слышно вот ну можешь суда подвинуться у тебя прям прям пуха говорить вот немножко себе меня зовут владимир федорков я первый свой майский поставил в далеком 2001 году потом я пытался изменять майские лю 40 лам и вас gresso мне зашло со второй половине 2000-х работают с майской или мы высокими нагрузками с октября 2019 года у меня в компе отобрали паспорт и я занимала занимаюсь майский элем там за это время мы совместными усилиями с эксплуатацией разработкой причитали прот сделали так что у нас база и в принципе все остальное уже более менее хорошо работают мы уже думаем о каких-то больших вершинах у нас ставятся рекорды я думаю что подробности подробности вы могли услышать вчера в главном зале но докладе евгению кузовлева вот а сегодня мы будем говорить как дела как мы не делаем и как делать не надо у нас есть проблема в нашем докладе есть а направлять дело в том что убить myspace сам по себе сложно и это это вызывает некоторые некоторые неприятности система слишком отказоустойчивая слишком быстро и честно говоря довольно надёжны потому что очевидные баги уже давно были пофиксен и поэтому простые запросы и простая логика отрабатывают ну лишь com быстро вот у нас 95 процентной persantine времени вы кампай на основной базе в нашем случае 4 100 микросекунд конечно ни в коем случае не надо секунд здесь ошибка в докладе но тем ни менее ошибка слайдах но 4 100 микросекунд у нас есть то есть это не да это даже не миллисекунды но для того чтобы все работал медленно и неустойчиво нам нужна система последовательным образом усложнять нам нужно усложнять конфигурацию нам нужно усложнять запросы и нам нужно усложнять архитектурно приложить сыром чтобы она была как можно более запутанное как можно менее понятный вот тогда у нас все наконец-то упадет и упадет не просто 1 раз и поднимется упадет всерьез и надолго и будет падать постоянно давайте начнем с конфигурацией с конфигурацию нас есть два пути она дает возможность конфигурации та самая простая штука она дает возможность маски реализовывать свой потенциал на каком-то определенном железе и наша задача сразу не дать мы искали вот по вообще никакого шанса configure так что вообще не работала и в этом у нас есть два пути первый путь это не только фигуре и второй путь это перри configured ну давайте начнем с простого вообще без конфигурации то есть краевой эффект вот просто вот такой конфигурации вообще сразу вариант неплохой но что значит неплохой вот раньше у нас в москве и на тебе баффер пули энди be powerful москве или точнее в на тебе который является сейчас основным сто раз женщинам по умолчанию был 8 мегабайт но его к сожалению подняли до 128 мегабайт то есть в принципе разработка на этом может жить то есть когда у вас вообще нет данных вы поставили мыски у вас может что-то получиться и поначалу даже все это будет работать но потом как только у вас данных будет все больше и больше у вас безусловно начнет вы начнете упираться в диск потому что баффер по слишком маленькие данных слишком мало кэш маленький лучшего так и оставить пусть читает с диска ничего трогать не надо делать ничего не нужно плюсы не конфигурации в том что делать ничего не нужно к сожалению в минске иль 8 изобрели там изобрели параметр я точно не помню как он называется про dedicated server да ты выставляешь параметр где дикие то что то что это мои секунде тихие то сервер и он сам как-то все configure вот мы предстоим этих людей потому что это слишком слишком простой путь сконфигурировать mais quel кто угодно так может сделать под вообще и поэтому ничего не пишите в конфиг файл это самое лучшее проблемы в чем проблема в том что когда вас пропадает потому что вас майский отваливается из-за отсутствия конфига это очень можно быстро понять потому что где конфиг нет конфигу на самом деле тут есть такая вещь которую я часто вижу люди право buffer pool они знают они раз его поднимают до каких-то больших высот но есть еще такие вещи например и нади белок files as который определяет размер резала файла куда пишут пишется данные до того как они записывается непосредственно в табл space на диске для того чтобы и он считается только прекращали кадре но проблема в том что он то есть он не используется когда майкл работает до краше recovery но проблема в том что если то место закончилось май скул ничего уже больше и записывать не будет не нужно данные записать файлы можно его ставить на значение по умолчанию и вы тоже к сожалению подняли версиях версии версии 8 но да то есть значение значение по умолчанию это такой хорошей базы метод москве убить точнее убить прод на мои съели но к сожалению он не достаточно надежная мы говорим мы х мы хотим говорить о серьезных методах которые во первых сложно увидеть тяжело пофиксить и практически невозможно с этим жить поэтому как можно больше конфигурации меняем все значения вот мы открываем список параметров и сразу говорим значит вот это мы поменяем вот это мы поменяем вот это мы поменяем дефолтное значение пожалуйста не ставьте потому что люди которые делают дефолтные значения мы съели они же не понимают ничего а вы понимаете лучше потому что вы прочитали документацию которые они написали и лучше знаете что должно стоять в этих дефолтных значениях потому что вот вам так хочется и этого принципе достаточно для того чтобы все поменять дефолтный значений много их все можно поменять но я предпочитаю менять минимум 350 параметров просто чтобы вы еще читаемое скейт конфиг уже устали вот когда вы видите вот эту просто вы думаете да блин может быть ну ее нафиг я просто вот я просто займусь чем-нибудь другим сегодня днем и этом это будет наша маленькая победа поэтому больше значение непонятных особенно которые нигде не используются и ни одного значения по умолчанию важно помнить что наши помыслы чисты мы все делаем для того чтобы майский эль заработал быстрее любая база данных сработает быстрее если она хорошо с configure на правда особенно если у нее все параметры по минин и как мы так так можно убить не только майский если что так убиваются и oracle и подогрев и любая известная и неизвестная базы данных потому что физика всегда одинаково крутим до максимума или до минимума мы же криви эффекты любим поэтому либо в ноль либо в максимум лучше там лучше поближе к тому чтобы им заканчивался вот тогда будет совсем хорошо значит в конфигурации есть 3 место в которой мы можем упереться как и в принципе везде это память диск и процессор ну давайте посмотрим какие конфигураций нужно configure чтобы убить наш нашу память значит как выглядит отвратительно я настройка памяти значит память для чего она нужна память быстрая поэтому все буферы можно либо в минимум тогда все будет все будет очень сильно тормозить либо в максимум тогда к нам придет а ум наш долгожданный и прекрасный дом но смысл в том что если мы поставим маленький буфера то тормозить насчет сразу а если мы поставим огромные буферы особенно из поставим их с учетом свапа который мы сделаем очень и очень и очень больших тогда у нас он не просто придется сначала на все затормозит потому что мы начнем читать и писать и свапа и вот это будет самое прекрасное что мы можем сделать базы данных по должна производить в этот момент закончится ну совсем на пожалуйста предки мое самое любимое то когда люди ставит он тебе баффер пол больше чем размер памяти да вот можно поставить и на земли баффер пол больше чем размер память и либо включить swap либо отключить если вы отключаете к вам приходит ум и вы падаете а если вы ставите если вы включаете своп тогда у вас просто все тормозит при я предлагаю поставить и назибо whirlpool как три размера памяти ослаб включать как два размера то есть она тормозит то тормозит и грохнется тормозит пыталась и грохнется ну и обязательно мы не смотрим на наши данные то есть если у нас допустим 2 гигабайта данных в системе ни в коем случае не ставьте buffer pool как два гигабайта ставьте побольше всему как бы не надо вот эти заморачиваться не надо не надо заниматься аналитикой это приход это приводит к стабильному проду а наша цель другая значение по умолчанию вообще не для нас мы уже об этом говорили важно потом что что нам важно нам уже потом важно объяснить когда он все грохнется почему то что мы делаем это правильно и он замечательно мой любим вообще ответа почему у вас такие параметры а к нам приходил консультанты спирко на 8 лет назад и все это оставило так ребята вы поменяли железо несколько раз после этих восьми лет вас поменялось приложение на параметр ставить ножи sap и да вот еще можно посмотреть куда-нибудь в какой-нибудь блог найти там нужный параметр выставить его в обязательном порядке а потом винить вот авторов этого блога потому что они сами не понимают что они пишут а то что этого шпрот ну извините ну мы же хотим мы же хотели как лучше сами знаете куда нас ведут прекрасное намерение значит диск значит что нам нужно на окажется нужно безопасно и быстро нет нам не нужно безопасный быстро нам нужно опасно и медленно поэтому нам нужно помнить как работает мой скейт нужно своего врага знака мой стиль пишет данные четыре раза если это и на тебе и бинарной логик включены что он пишет он пишет транзакционный лог он пишет до бурой баффер он пишет собственно говоря файлы данных и он пишет бинарный лак что мы можем с этим сделать мы по первых должны быть включите в сен везде даже если нам не нужны синхронные а аккуратные данные нам нужно везде включайте в sing почему потому что и sing медленный кто значит кайтинг кому рассказать один два три я потом расскажу не будем сейчас время тратить потом после после доклада расскажу везде включаемый в sing но только там где он не нужен потому что там где нужен и в sing мы его выключаем и еще мы выключаем дабл райт баффер после этого что такое дабл райт баффер добавлять баффер эта штука которая позволяет после крыши системы восстановить нужные данные именно поэтому мы пишем данные два раза сначала vw рай baker потом сам собственно файлы данный почему потому что когда мы когда происходит запись если у нас происходит отказ а и на себе пишет страничками по 16 килобайт мы можем например записать 4 килобайта а 12 лабать записать не успеть и в этот момент у нас будет некое систем будут не консистентные данные вот если мы будем писать два раза то водил в одно место до запишется и поэтому у нас данные будут консистентной поэтому отключайте wh баффер всегда и везде второй момент нам нужно нам нужно сделать плохо чтобы чтобы стало плохо тиску для этого мы тралим запись и чтение для и на тебе и на тебе aero и thread in a baby right ред либо в минимум либо в максимум лучше минимум ломаем традиционную систему и на тебе log files минимум это то о чем вот мы говорили но и без ноги как можно сломать берлоге свет ноги на самом деле их можно двумя сейчас двумя способами да на слайде тут написано про синхронизацию но моя любимая вещь это когда люди ставят x файлах des такая опция которая удаляет бы налоги и спустя какое то время спустя какое-то время не заветного семью в три дня потом не случается проблема у них бы к потоку недельной давности до то есть прям готовый рецепт берете делаете ставьте ставьте экспорт локтей тс-с-с пар берлог экспертов дайсон там же час секанс уже стоит ставить и гораздо меньше чем у вас время между бы kappa me вот тогда у вас вы тогда вы точно не сможете восстановиться ну и сингл simbin глок включаем там где не нужно соответственно выключаем там где нужно макс белок says the наделаем побольше почему когда у вас malt и маленькие берлоге они очень быстро ротируется с маленькими файлами быстро работать делайте их максимально большими по умолчанию гигабайт вставьте 100 вам че жалко что-ли 100 гигабайт белок релог тоже можно поставить побольше ну так чтобы удобнее было позиция чтобы вас не влезла в int тоже неплохо будет ну то есть креативность креативность это ключ к тому чтобы убить базу данных так у нас остался процессор так память убили диск погасили процессор остался в есть проблема можем есть очень быстрый вещи можем сделать тротлинг использования потоков ну может на то есть моя любимая все овцы то есть я рассказал пример про нам сделать конфигурацию 8 лет назад там часто бывает ограниченное количество потоков и д д б а есть другая еще опция что некоторые люди считают что вот москва поддерживает они читают блоге рассказать показывает смотрятся бенчмарки каждый год что москва все лучше и лучше по его поддерживает мульти процессор наш мульти я терпеть и ставит и на тебе предкам колись это реальная конфигурация это 256 это я видела там 600 999 а при том что и на тебе то есть там что такое на территори от конкор на себе сколько потоков мы на тебе может создать чтобы обрабатывать данные но она не может если она исчезает сильно больше чем количество ядер процессора то есть она получается какие-то вынуждены все время ждать и вот если их мы увеличим до вот таких больших чисел они будут ждать да и у нас есть еще такая штука как возвращение из оверлорда когда у нас и нози би таракан корнин состоит в очень маленькой watch в очень маленьком значение во первых у нас будет не дружит не загружаться процессор в принципе это плюс можно биткоины майнить на на серверах баз данных в принципе да кто не кто майнингом занимается но в принципе чен нам с келли можно там вот у нас есть 80 лидер зачем мы съели 80-я der давайте сделаем 4 а остальные 76 пусть у bitcoin майнер все равно система простаивает вот а еще и еще один очень интересный момент заключается в том что если у нас происходит очень резкий всплеск коннектор и живых запусков майский elta у нас tracks ранен очень сильно увеличивается очень сильно увеличивается и в тот момент когда у нас трек ангар носи стоит очень маленький у нас вместо того чтобы все это уйти на сторону и no debe то у нас получается ситуация когда эти connect и начинают вставать на стороне москве или и мы получаем коли большое количество кортик свичей у нас вы и доится процессор процессор у нас становится очень дефицитным ресурсом у нас приходит еще больше коннектов мы все хуже обхватываем те запросы которые у нас у нас есть и вот мы уже упали что в общем то и хотелось правда поэтому редко нг ourense играйте пожалуйста вот либо в минимум либо вот либо вот чем меньше тем лучше да если у вас не включен к вере кэш обязательно включите почему эта прекрасная штука потому что там стоит что лак и как только вы это вы у вас конкурентность между потоками достигнет определенного предела вы просто умрете там просто происходит то что крепеж была написана очень давно и как то разработчики не подумали о том что будет много ядер и данный момент когда мире конечно нужно стереть предыдущую запись и записать новый принтер и правда эти таблицы а это все ждет все ждут да-да и самое главное что перекос это очень-очень-очень оптимизированная штука да еще один момент и что ее непременно нужно сделать большой то есть если вас допустим это 256 мегабайт достаточно легко щас на современной машине переписать а вот если оно у вас 32 гигабайта да сделайте кве рикошет как половину памяти не мелочитесь но у нас есть проблема дело в том что как бы мы не старались плохо из configure тьмой сквер на если запросов не будет то мы его не убьем поэтому нам нужны запросы и основной удар по базе данных наносят именно они поэтому сейчас мы поговорим о том как сделать плохой запрос особенно если данные пока помещаются в память что такое запросы запросы то что обеспечивает 99 там много девятых тормозов и большую головной боли админов потому что админы по факту не могут с ними ничего сделать лучший мой лучший майский запрос это в принципе тот который до базы не дошел который где-то за кашированного приложение где-то где-то посчитан как-то по-другому может быть в аналитику сходили в клик house where теку куда угодно но это в принципе в принципе это не наш выбор поэтому все запросы как только есть возможность прочитать данные в приложении читайте прямо с базы как можно чаще мой стиль по своему дизайну не может выполнить быстро некоторые запросы физически просто потому что так спроектирован как написать тормозной запрос ну поехали пожалуйста спасибо у нас есть эксперт есть несколько все способов например можно завернуть все колонки функции вот например здесь что происходит что у нас есть есть какая-то колонка отомстим мы пытаемся взять ее узнать день день и от от этого от этого его даты используем что происходит что делает вас как он для каждой строчки которые он просматривает таблицу выполняет это выражение то есть если это фактическим считают всю таблицу для каждой строчки выполняет выражение вот здесь более такой хитрый пример та что справа функция ноу это я на самом деле оно выполняется только один раз потому что я на используется на момент оптимизации запросов но то что слева когда с исполняется в функции дейта это она выполняет себя каждой колонке если переписать ее наоборот что одна у отнять 1 час все это будет спориться индекса и майского будет работать быстро а это неприемлемо да вот тоже хорошее выражение то есть опять-таки все наверное в первом классе учили как это можно переписать что это эти скобки раскрытие вычесть и узнать значение оси int но вот если написать так маску и будет вычислять каждый раз сложения и потом сравнивать это с конца то есть это вообще даже но вы видите выдали даже прочитать невозможно нормально прекрасно же смотришь на это запрос гасит нет я паяю а потом у него посмотрю да почему все так происходит дело в том что есть ограничение дизайна сама самого москве дело в том что acid который позволяет прочитайте данные которые мы записали призови вне зависимости от отказов оборудования сети и прочей он медленный by three работает тоже не для всех случаев то есть например когда у нас есть постфикс ный поиск мы не можем в принципе использовать by three запрос обрабатывается только одним ведром это значит что с одной стороны мы можем очень четко отслеживать нагрузку то есть треть ранен показывает сколько у нас я der заняты в текущий момент но при этом у нас если у нас система если нас один запрос и это запрос очень тяжелый то он не раз параллели c и он принципе один может положить всю базу данных просто потому что он там высосет все ресурсы из и о или сделает ну в общем может может нанести серьезный серьезный вред это в принципе то что нам нужно есть фулл тексты они отличные от длины пожалуйста используйте funtik ст и в full text search в mais quel потому что особенно если у вас больше 10 гигабайт данных он не функционален он очень медленным очень медленно и в общем в принципе то что вам нужно используйте full text ни в коем случае не люсин ни в коем случае не ластик и не сфинкс пожалуйста вот прям full текст индекс давайте чем больше тем чем больше данных тем медленнее он будет работать это прекрасно правителя то мы вообще можем говорить часами но это это это то что ломается практически постоянно поэтому больше используйте странных реплика ционных топологий чем более незапутанные чем менее непонятные тем дольше вы будете восстанавливать свои костра и данные у фильтры замечательная степин из триплекса репликация есть контраст функцию криттер 0 да да да вот как редкость да вот реально часами можно говорить напишите нам мы может быть сделаем метро пройдет фиксации ошибки и репликации тоже очень хорошо сделать опасаясь у вас происходит это пример слои впадает и прикидки air ортез когда вы вводите у вас очень и дублируется надо просто сделать пропустить позицию и лет жить от и продолжите да и ни в коем случае не смотреть почему это произошло чем больше ошибок репликации вы пропустите тем больше не консистентных данных propper contour kit пожалуйста не вспоминайте потому что он может помочь синхронизировать данные ну и вообще в целом пожалуйста вот ну вот наша задача чтобы был просто полный от а еще можно скорее слоев скипперс использовать и написать там большой список и этой конференцию был доклад когда человек говорит у нас вот там сколько даем мастеров я не буду давать компания не называть нас n мастеров но у нас только один синхронны остальные расходятся поэтому мы им не доверяем этим данным а ходим в другое место для того чтобы получить данные по моему это прекрасно это вот то ради чего мы сейчас здесь выступаем для того чтобы пропагандировать такой подход что больше не синхронных реплик больше не синхронных данных ну и вообще чем больше не синхронных в целом чем сильнее вас расходятся данные тем легче у вас получить проблемам бизнес уровня ну например там сделать отгрузить не то или не туда или не столько сколько нужно или заплатить не столько сколько нужно по моему это прекрасно поэтому больше не синхронности как-то как написать еще раз как написать тормозной запрос второй заход пожалуйста май скул есть такая фея что есть индексы поддерживает по которому поиск по таблице осуществляется просто но даже если они у нас есть даже если они с построен настроены правильно нужно сделать так что не дать им шанс а первые никто никогда не используем а равенство то есть почему потому что москва когда сравнивает что-то например там нужно найти чего-то май скул и большинство индекса это бетрия некоторые представляете вас нужно объяснять кому то что кубе 3 да кто кто знает что коби 3 поднимите руки пожалуйста почел сюда пришли вообще да то есть пабе 3 очень легко найти и когда что-то чему-то равно но вот если у вас выражение предме равно единице то есть надо пройти найти все что не равно единице то есть мы просматриваем да не кроме случаев собственно чему иначе может быть быстро это неприемлемо да то же самое вот списке not in стоит у нас несколько значений но не в этом списке тоже мы просматриваем да вот у нас была ситуация когда есть несколько значений которые нужно выбрать по идее то есть сделать сделать из там 15 статусов нужно выбрать 3 вот лучше дела лучше так не делать не делайте так как мы делайте not in и все остальные это же очень просто не вытащилась ты такой обратно случает когда in the с одной стороны это может даже использоваться индекс а когда очень много значения вы например 5 тысяч ну ты знаешь о пяти тысяч москаль еще есть шанс у шеста да лучше сто а еще можно таким образом я увидела случае использовать человек использовал таким образом хотел чтобы работал именно яндекс по этому полю чтобы был такой вот выступление скорее you seen you seen индекс я пыталась понять вообще почему ну как бы как быстренько станет это был специально специально чтобы увидеть и пусто красивую страхуюсь индекс когда читается полностью индекс как вот есть full-time вся таблица полностью индекс до помните что били 3 это префикс на яндекс поэтому такие выражения как что-то там начали они просто как бы они будут читать всю таблицу и все все будет очень медленно ну вот когда у нас это значит процент в конце к сожалению у нас не получится сделать плохо маску или потому что она слева направо все прочитает это вот верхнюю строчку пожалуйста и если индекс есть стараемся делать раньше ска и на простой такой раньше screen это когда у нас среди несколько часов спустя год 10 меньше ста и вот пример где и немного значений это фактически много-много-много рычишь скинов и вы можете значение таким образом что что они будут очень много маленьких раз сканов то есть это хуже чем один на парижской большой где можно просто взять кусок и 3 индекса а там не получится так сделать но почему флота и блузка на ту дорого но очевидно когда у нас есть огромная таблица и мы ее читаем то это это просто долго но это не просто долгое дело в том что когда мы читаем мой стиль вынужден вытаскивать все эти данные в баффер пол вы на тебе баффер подъезд у нас пользуется ими тебе а все что мы говорим это относится к нози би как где фазного сторож женщину у нас вымываются данные то есть те данные горячие которые у нас находятся в баффер пули они вот этим вот большим чтением часть из них может вымыться и мои съели потребуется еще раз прийти на диск для того чтобы их достать ещё раз а диск у нас в тысячи раз даже ssd у нас в тысячи раз медленнее чем пара чем обращение к памяти поэтому мы грузим диск мы грузим процессор тем что мы вытаскиваем и обрабатываем все эти все эти строчки одна за одной мы греем атмосферу мы потребляем электричество в принципе делаем все как при майнинге биткоина но бит нам bitcoin нам дает хотя бы какую-то надежду на деньги а здесь у нас вообще никакой надежды нет то что мы делаем салют на бесполезную работу запросы крути словах мутится заставляет использовать индексы он есть выход этот выход называется высоко селективные запросы запросы которые запрашивают сразу много данных вот например как случай select a star где таблицы пользователей где пользу адаптивные то есть это может быть а вина таблицы и в принципе тут неважно сидит старта есть играемся функциям и какую-то функцию берем как к аккаунт от старта есть мы все равно вынуждены просмотреть данные которых у нас половина половина таблицы индексы здесь не помогают потому что собственно просматриваем половину таблицы в любом случае даже если у нас есть еще шанс что оптимизатор решит что ну его нафиг такой индексы мы просто сделаем фото блузка но он будет дешевле есть еще другие варианты то есть можно агрегировать с такие функции как сумма а вероятность есть такая пример идея что логику в базе данных и удержать не нужно и вот можно довести ее до совершенно высшей точке то есть и не использовать даже вот такие функции как сумма и average лимитов сет тоже очень хорошо то есть мы прочитаем вот эти вот что это вообще за это миллиарда кто такое видел поднимите руки кто такое писал поднимите руки ну вот вы понимаете что это версия то до цветоносе это составлять вычитать а потом выкинуть все данные кроме последней страницы то есть это то же самое что влад говорил про султан был складывается данная из баффер пула и полностью эмулирует full time as can даже на очень удалось неплохо ну вот это вот наш победитель ордер pair and и то есть даже если этого выбирать одну страницу строку мы сначала ассорти мы сортируем таблицу по случайному числу и потом берем к сожалению я такое видела даже как рекомендацию для решения каких-то бизнес-задач ну есть проблема писать плохие запроса руками опасно даже я даже от опасно еще дядю стопу и вроде проблема в том что в гите все видно как в лучше отказаться от версия versio нирования я вспомнила я ходила когда ты сюда москва собеседовать тоже так удивилась что люди писали школы запросы они не versio не раване это никак также как я пишу tes tes тестовые задания это ваша у меня запроса поломался поломался что делать вот но чем лучше от этого отказываться поэтому никто не скажет что вы что-то поломали а то мог найти заставить переделать но можно сделать запрос еще хуже бога могут от review is выход есть это моё любимое это используем кто использовал римская жители используют кому это нравится уоррен кстати из польши плюс у меня был такой случай в карьере когда заказчик просто решил перейти спуска риску и лана сиквел сервер вот так вот в один день ну сырым это можно было так легко на этом пути такое закончится потому что то готовые запросы любой ужасности еще такая вещь что некоторые ларисе как подготавливают таблицу и человеку допустим советуешься было создайте такой то яндекс человек за тепло и приложение еще один раз и не раз у него синдра все индексы в общем нож на яндексе удалены ненужные даст создать оказывается каждый раз когда предложение пирса сдается она еще и создает удостоверяется что определение таблиц данного пиццы соответствует тому как было изначально сгенерировано программой и тебе эту и можно сделать вообще ничего если вы не виноваты совершенно потому что не вы это писали в написали красивый какой-то объектный код исправить это вы не можете потому что у вас прекрасная модель данных которая которая вот все все это делает да вы чё сума сошли на живут вот код преобразуется сам вы сквере тут вообще не причем очень удобно изменить мое конечно же не можем так вот побольше логике приложения в базе это если в дарема уважаем в целом нам что нужно нам нужно больше логике приложению базе мы хотим замедлить еще тепло и усложнить себе тепло и когда у нас очень много логики логики в базе мы что как как мы это можем сделать ну френки сказка один ладно мы просто делаем где мы где у нас тут грабли казалось бы все хорошо мы делаем shadow таблицу который делает reference на ту же самую таблицу потом мы удаляем из этой shadow таблиц какие значения у нас по каско 1 га удаляются другие значения и в принципе вот у нас уже данные данные не физикой систем ты принципе уже все хорошо уже неплохо флорентийский ли очень серьёзно усложняют нам миграции особенно миграции по тяжелым таблицам ну и в целом да то есть мы мы можем триггер это триггер тоже отлично потому что триггера это в принципе уже неплохо это логика приложения в базе когда мы вставляем в одну таблицу потом еще что-то меняем в другой поток в третье удаляем из 4 что делаем вот так и чем больше вот такой логике тем тем хрен поймешь потом куда вообще бежать а все хорошо когда у нас таблицы на теперь оао триггера используется что-то пишут каталоге вне традиционную таблицу вот чувствуется профессионал то есть берем и желательно в нескольких сторож сторож джиннах особенно крост делал а вот еще один момент мы забыли про чувств мы в общем много про что забыли как убить майский потому что опыта он опыта много но не все можно впихнуть в эти несчастные 40 или 50 минут поэтому cross cross join между разными дата стороны это тоже не плохо но в принципе моя и сам сейчас к сожалению уже все меньше и меньше используется раньше его использовали очень классные мария использовать что memory- может memory можно да а кстати если кто знает что в мае съели есть такая штука называется black hole вот black hole это прекрасный способ выстрелить себе в ногу особенно если у вас один кластер и на одном кластере black hole in 1 1 части кластера black hole есть он другой нет потому что когда у вас происходит с вич то у вас половина данных остается там половина до половины здесь в общем очень неплохо мой скейт предоставляет все возможности хранимые процедуры сразу победа у вас тут же появляются проблемы с выходкой с вы какой новых версий приложений с откатом на предыдущую версию потому что так у вас есть например канареечный deployment да у вас там пять процентов трафика ушло на какие-то фронты у вас там логика поменялось и все а так у вас не будет канареечный дипломов потому что у вас крайне мультика ну и в принципе адаб от по репликации кольцевая репликация хорошо кольцевая репликация без сжатия или вообще отлично большие пачки на запись которые заставляют реплики отставать еще лучше вот честно проходили вот это все в действительности то что я то о чем мы сейчас говорим это не какие-то и истории там из космоса это вот наши грабли которые я вот не личный пример проходил 0 когда ты помогаешь с этим но лида или любить и вообще любые тяжелые миграции это хорошо аль тертый на 150 миллионов строк неплохо да вопросы тем каким есть сейчас мы узнаем если вопрос во первых спасибо за доклад владимир подождите секретом этот оклад еще не закончили у нас есть еще время вроде как у нас да смотрите можно до конца провести вопрос да давайте давайте то нас в принципе очень у нас к зеленой зоне либо вопросы задаем сейчас хорошо хорошо любой тяжелый миграции прекрасно в общем подводя итоги конфигурация это быстро но не надежное решение можно найти быстро поменять запросы плохие запросы гораздо надежнее их сложнее исправить их дольше переписывать потому что это кот их нужно менять логику приложения иногда это очень дорого делать особенно если у вас у веры важно вовремя не увидеть проблему а если вы видите то не говорить explain вообще для лузеров ну то есть как база данных смотрите ваша задача говорить следующие база данных должна отрабатывать любой код который я пишу потому что если база данных не отрабатывает код который я пишу это плохая база данных принесите пожалуйста другую вот нужно запомнить эти слова и как мантру повторять мониторинг вообще лишний это эксплуатация касается вам должны клиенты звонить и говорить что у вас не работает они вы и говорить что у нас тут не работает графики вообще ни в коем случае тут вот человек может правда ради марку на это это очень сложно это нужно аж три команды набрать чтобы его инсталлировать обновить его там тоже надо нажать кнопку в веб-интерфейсе обновить тоже это трудно больше можно нужно придется обратиться к воле руководства пользователей прочитать как это все сделать и очень дорогой тема очень дорого потому что это open source это распространяется бесплатно и с открытым исходным кодом вообще невозможно поставить пожалуйста не делайте то никогда ну и графики вообще в целом непонятная штука можно без этого вот слишком сложно там зеленые полоски синие палатки что это вообще такое другие мудростью до другие мудрости значит увидел промолчи вот увидел что это что-то идет не так помолчи пожалуйста но не не говорит и никому дождись пока грохнется подари товарищем незабываемую ночь особенно в пятницу вечером у кого-то есть планы да и хрен с ними лучше проб поднять два раза чем куда-нибудь сходить на великах покататься лучше deploy когда в пятницу вечером вот лучше лучше тепло и примут абсолютно новую конфигурацию просто что-то новое прям брать и давайте у нас выходные впереди ничего же делать правда а еще знаете лучше всего делать одновременно если у вас обновление одновременно обновлять железо операционную систему и настройки конфигурации морской вы просто вы принесли сказали в поддержку пир в поддержку сказать наша новая версия стала работать с медленней то что вы поменяли все да парни парни у вас там релиз мы сейчас железо быстро переделаем там немножко вилла на пире configure мы еще там немножечко вот здесь вот здесь вот здесь по делаем здесь акур за полчаса уложимся в пятницу вечером а потом пойдем спать самые надежные миграции в пиковое время то есть когда у вас пик когда у вас база плавится вообще жалко что-ли сделайте миграцию для завтрашнего деплоя ну и что что 10 ну и что что пару миллионов строк нужно перелопатить база данных железная а вы спать пойдете и завтра утром не надо будет просыпаться правильно лучше работать когда дежурный ушли спать желательно через час после того как от не ушли в оффлайн возможно они не спят и тогда ваш звонок их особенно обрадует проснулся ночь работой простая простая истина ладно в общем мы здесь конечно здесь по прикалывались но в действительности есть очень серьезная серьезный посыл для этого доклада который ради которого очень то мы сюда пришли пасе большое что дождались спасибо большое что послушали весь этот бред который мы несли дело в том что к вид увеличил нагрузку на онлайн-системы увеличил значительно но кроме этого у нас после к после к виды и после других природных явлений есть такая штука как дефицит электронных компонентов и мы сейчас видим довольно большую проблему с этим и эта проблема будет только увеличиваться у нас воздвигаются строки поставки у нас стоимость идет резко вверх и при этом деньги дешевеют потому что печатают их очень серьезно это значит что сцены скорее всего взлетят и это значит что стоимость масштабирования которые сейчас довольно дешего она будет еще сильнее расти и это значит что об оптимизации нужно думать уже вот прямо сейчас потому что оптимизация чем дальше тем будет дороже потому что будет меньше ресурсов будет будет еще меньше денег и нужно будет думать когда перед тем как вы что-то будете делать поэтому сейчас посмотрите пожалуйста свои приложения и найдите места для оптимизации пмм вам в помощь который делает как он и это самая простая туза которая покажет вам тренды и графики ну и посмотрите пожалуйста то что мы делали там нами то пох на предыдущих конференциях там принципе все это есть все это паша все эти пошаговой инструкции о том как жить с продам для того чтобы рот был быстрым там в принципе это все есть ну что делать приходить на конференции вы вы пришли по адресу здесь был довольно много докладов почитать книги мои секунд работу then который написал свет свет смирнова масику по максимуму которая написал ребята из перк он и они есть даже на у тебя на русском на русский перевод есть и не лечи нет пока нет у нас есть вот ну напишите напишите свете может быть что нибудь сможет рассказать у нас есть румынский эльфы телеграме приходите туда задавайте вопросы там хорошая комьюнити вам ответит и у нас есть онлайн вебинар и доклады у нас и самое главное эта практика практика и практика ну и конечно же почитать если вы заметили у меня вставки с дивов сбор от это прекрасный twitter он очень давно не обновляется но ни одна фраза из этого twitter не стала старой поэтому почитайте посмотрите посмейтесь где получить практику работы с реальным проектом в грамотной команде и с наставником который будет тебя подтаскивать на следующий уровень решать сложные для себя задачи спасибо большое приходите в компоте интересно спасибо еще раз владимир света"
}