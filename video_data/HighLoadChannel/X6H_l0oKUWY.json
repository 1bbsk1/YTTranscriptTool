{
  "video_id": "X6H_l0oKUWY",
  "channel": "HighLoadChannel",
  "title": "Как написать свой индекс в Tarantool / Олег Бабин (Mail.Ru Group)",
  "views": 678,
  "duration": 1970,
  "published": "2021-10-04T02:38:36-07:00",
  "text": "всем привет да меня зовут олег bowen я работаю в mail.ru в tarantul а при этом не являюсь разработчиком тарантул карраско реактивы пользователям тарантула то есть пишу проекты на tarantul а вот этот доклад посвящен я которому эксперименту который я делал для себя в большей степени ну и расскажу вам о том как вот с позиций человек который эксплуатирует скажем так тарантул написать свой индекс попытаться его встроить и что для этого нужно вот давайте начнем с того что такое вообще тарантул если кто то не знает cessna тарантулы то с одной стороны сервер приложений вы можете писать свой код на lua или там носи и кроме этого тарантул эта база данных все знают что или то разу за то что это in memory база данных вот мы на самом деле все не так просто и у нас есть еще и движок для хранения данных на диске при этом доклад будет посвящен именно движку mintex который предназначен который предназначен для написания хранение данных в оперативной памяти немножечко вступления и того как запустить тарантул как начать им пользоваться соответственно когда вы спите там тарантул в одну строчку вы можете активировать все возможности базы данных команды бокс f и g соответственно эта информация потребуется дальше здесь я не указал дополнительных опций хотя их большое количество просто по умолчанию начал создаем space space это аналог таблицы в обычных реляционных базах данных но в отличие от он их баз данных как минимум один индекс первичный должен существовать в торрент для успеха единицами хранения данных спаси являются топлы кортежа и опять-таки в отличие от реляционных баз данных у нас нет ограничения на длину и на типа полей у этих кортежей ограничения на тип касается только полей которые проиндексирована и в данном случае у меня есть первое поле тип on-site я указал это явно и остальные поля никак не фиксированная могут быть различных типов вот после того как мы ставили киты данные мы их можем поселить сумму чего из первичного же индекса с помощью простого selecta и более специализированный случай если вам нужно например извлечь по какому-то ключу поиска то есть мы указываем тип оператора и достаем все кортежи у которых первое поле в строго больше единицы также одной из основных интересных фич тарантула является наличие вторичных индексов вот точно также вы можете создать этот индекс и явно указать при выборке что этот индекс используется и в данном случае мы по силе ксель а кортежи у которых второе поле равно слово world то есть никого планировщика в интерфейсе у вас нету если вам нужно поселить по какому то определенному индексу то вы указываете его явно дальше хотелось бы поговорить о многомерных данных что такое многомерные данные в самом простейшем случае это географические координаты то есть как яркий самый пример то есть широта-долгота и запросы которые мы хотим делать к таким за такими данными это например выбрать информацию которой пролежит некоторые ограниченной области в пространстве но на самом деле задача шире и интереснее попробуем открыть какой-нибудь онлайн-магазин например и выбрать в нем какой-нибудь товар я вот выбрал для себя смартфоны и посмотрим и характеристики есть вообще у смартфонов там диагональ экрана емкость аккумулятора цена марка это вот набор из некоторых непрерывных или дискретных характеристик который мы опять-таки хотим как-то ограничить и выбрать аналогично например с автомобилями и более математически это выглядит как некоторое пространство в котором каждая точка является нашим товаром и мы ограничиваем некоторую область в этом пространстве многомерным и пользователь хочет получить то что находится в ограниченной этой этим запросам области соответственно как это можно решать в самом простом случае мы просто пройдем по всей таблицы и попробуем проверить удовлетворяет запись нашим критериям но это долго и проблему поиска данных обычно решают индексы то есть мы используем специальные типы индексов для определенных запросов и это ускоряет время ответа на яндексе бывают разных типов ну затронем парочку первый тип индекса это b3 он используется по умолчанию в большинстве баз данных в том числе и 3 яндекс по умолчанию используются для движка мем текста ринтали этот индекс не подходит для решения задачи поиска многомерных данных потому что он является одномерным данные в нем отсортированные по возрастанию скажем так и поиск иметь логарифмическую сложность то есть но при этом отсортированный колонка отдельно r3 индекс который как раз подходит для того чтобы решать эту задачу пространство разбивается некоторые ограничивающие прямоугольники и по дереву мы спускаемся в то место которое нас интересует которое выбрал пользователь соответственно попру посмотрим как это решается прямо сейчас tarantul а чтобы дальнейшее примеры имели чуть больше смысла попробуем заполнить пространство некоторым набором данных просто по сетке и выбрать из этой сетки просто квадратик соответственно создаем также space создаем ему яндекс и начинаем заполнять в данном случае я вставляю кортеж из трех полей первое поле не имея не будет иметь никакого смысла в наших запросов просто некоторым антону счетчик остальные два поля это координаты вот самым наивным подходим мы напишем восемь строчек кода для того чтобы получить интересующие нас данные но при этом если у нас данных много то мы просканируем каждый кортеж в нашим спасся то есть что очень долго и в общем-то не приемлемо и как попробуем решить данную задачу с помощью b3 индекс на как я сказал там данные отсортированы лишь по одному измерению и посмотрим как использование b3 индекса может облегчить нашу боль построим b3 яндекс по двум колонкам по 2 3 и сделаем запрос из начиная с точки 1 1 дальше у нас будет идти . 12 13 которая уже не принадлежит нашей области поиска 1420 21 и так далее то есть часть данных которые нам не нужны но все-таки просканируем но зато мы сможем написать такое условие по которому стоит прекратить это сканирование то есть что уменьшит количество от количества перебираем их нами данных но по-прежнему это все равно выпуском и r3 индекс как раз предназначена для того чтобы делать подобного плана запросы заметьте что здесь мы создаем на самом деле и space и яндекс еще раз и данные начинают иметь несколько иную структуру это особенность тарантула эта особенность r3 индекса здесь у нас не три поля в кортеже а два поля при этом второе поле имеет тип массив из двух элементов то есть те наши самые координаты дальше мы создаем индекс rt просто указываем ему другой тип не просто 3 и указываем размерность равную двум ну а в дальнейшем и просто пишем запрос и нам сразу возвращаются нужны нам данные то есть мы не перебираем ничего дополнительно на клиенте в луи так далее ну теперь я заинтересовался можно ли как-то по-другому решить данную задачу и решил рассмотреть такую структуру как кривая зад порядка кривая зад порядка это такая кривая которая каждой точке в пространстве сопоставляет некоторую точку на плоской кривой строится это кривая по следующим правилам мы берем нашу точку в пространстве начинаем побитого перемешивать координаты этой точки вот получаем некоторую биты вую строку как с этим затем работать ограничь у нас есть ограничение в пространстве и граничные точки на диагонали мы можем отобразить на эту кривую вот при этом заметим что часть точек которые лежат на этой кривой между этими границами выходит за интересующую нас область что мы можем тогда сделать представим себе что мы начинаем оперироваться по этой кривой берем точку проверяем при принадлежит ли она интересующей нас области и если принадлежит то возвращаем ее о пользователе идем дальше и понимаем что мы вышли за границу каким-то образом и это поняли вот и какие опции у нас есть самая первая опция продолжить сканировать и ждать пока мы вернёмся обратно в эту область но это опять таки сведется к вулкану или попробовать перепрыгнуть и вернуться в область поиска в тесно вернувшийся область поиска мы снова работаем с теми точками который просил пользователь и возвращаемых ему заканчиваем и когда доходим до верхней границы теперь как это строить тарантул да и в принципе в любую базу данных в общем случае соответственно нужно научиться вычислять эти z адреса сохранить их в отсортированном виде в некоторый контейнер я выбрал b3 для этого ну и реализовать алгоритма поиска для того чтобы можно было как раз эти точки выбирать чтобы можно было делать эти прыжки и теперь непосредственно к со ран тула а что доступно разработчику соответственно я выбрал некоторый список ключевых компонентов tarantul а на самом деле их очень много вот но такие самые базовая хотел бы покрытий и рассмотреть соответственно смол на самом деле это спешилась мемориала катар в таранто ли есть некоторый набор локаторов с которыми он работает для того чтобы максимально оптимальна свои задачи аллоцировать освобождать память вот кроме этого части локатор специально заточена под определенные задачи так например есть и локатор мем пул например и этот локатор предназначен специально для того чтобы аллоцировать большое количество объектов одного и того же размера при этом за адреса в рамках одного индекса имеют фиксированный и один и тот же размер я воспользовался этим типом локатора он подходил под мою задачу соответственно это давало некоторый прирост при аллокации таких строк теперь салат если вспомните 2 славе назад это на самом деле просто набор алгоритмов и структур данных соответственно втором туре есть индексы бесед хэш r3 и эти структуры реализованы в виде отдельных библиотек но кроме этого есть и структуры которые нужны для обычного клиентского кода и на сервера приложения не база данных они также там находятся кроме этого тарантул как я сказал это серый приложений он имеет интерфейс одной стороны влажные с другой стороны у вас есть сильная api вы можете писать хранимой процедуры носи но естественно вы написали какой-то код носи вам нужно как-то про бросить его клиенту сделать это можно несколькими способами это с помощью лу оси api и с помощью гаджетов с инфой потому что самом деле тарантул использовать не просто lua а реализацию языка lua lua jit то есть поддержка jet компиляции ну и си api вы можете писать не только nalu вы можете писать хранимой процедурой носи вот и у тарантулы есть отдельная api который вы можете дергать языка из из россии как например для охраняют процедур так и например если пишете сторонние модули вот ну и куда же без сети обычно тарантулов из тарантул собирают кластер и для этого у тарантула есть отдельный протокол по которому работу все внутренние процессы такие как как как репликация ровд вот кроме этого сторонний коннекторы или сами другие тарантулы клиенты могут приходить и делать запросы ну и кроме этого есть отдельный компонент интернализация свин протокола там аж типе клиент который также взаимодействует с сетью простите не будет мы тут про индексы но сам факт того что это важный компонент стоит отметить честно что понадобилось для того чтобы это в итоге строить написать алгоритмы для работы с z адресами за использовать уже существующие б дерево и битовый массив соответственно так битовая строка которая будет содержать себе z адрес сам интересно что этот отметить это то что данный битвы массив имеет фиксированный размер и всегда будет кратен 8 байтом на этом тоже можно было сэкономить некоторое количество операций и fav и это стоит отметить отдельно то есть это битовый массив константа го размера теперь как работать зад адресами изначально как и сказал единицы хранения в tarantul и является кортеж кортеж можно условно представить как некоторый заголовок и массив формате massage pack тесно для того чтобы посчитать зад адрес мы должны учесть те поля который пользователь выбрал как индексируем и и выбрать их декодировать в примитивные session и и типы чтоб с этим можно было работать но и в дальнейшем перемешать данные ну кроме to pull off пользователь также в запросах указывает ключи но здесь история очень такая же нам будет пролетать массив формате massage pack хранение в бы дереве практически идентичны с тем как это сделано в текущем 3 яндексе на тот момент когда я писал структура хранящиеся в в дереве в 3 для two индекса выглядел вот как сверху это просто указатель на то пол и некоторая подсказка использовали при сравнении to pull off для ускорения сравнения и плюс в моем случае все получилось примерно так же то есть это тот же указатель на то пол и сам z адрес вычислений от этого табло и также интересно покрыть работу с типами с от адреса должны быть порядочными но при этом всегда ли значение и их битовые представления упорядоченны одинаково если мы работаем с by знаковыми типом это все у нас хорошо у нас есть там шесть семь и в битвам представлений они также будут возрастающая располагаться а вот здесь знак ой а вот со знаковыми типами у нас проблемы старший бит у знаковых типов отвечать за знак поэтому все отрицательные числа в битва представлений больше чем положительные решать это пришлось нормализацией и мы просто дальше незадача меняли старший байт из орбит для чисел с плавающей точкой тоже такая проблема стоит на все не так просто но это задача также решается и путем достаточно довольно несложных преобразований они есть и также отдельно захотелось поработать со строками то есть строки популярный тип но поскольку все указанные выше примитивные типы уважаться только в восемь байт то и строки пришлось подрезать до восьми байт строки своем битвам представлений также лексикографические отсортированы и те строки которые получались больше восьми байт приходилось обрезать те которые меньше приходилось заполнять конца нулями соответственно если пользователи не хватало бы такой длины для фильтрации он мог бы отфильтровать на клиенте вот ну и самое сердце можно сказать это алгоритм ногам и который принимает в себя 2 граничные точки и должен пройтись по тем точкам которые выпадают за границу области в пространстве и как я сказал при итерации можем по кривой проектироваться так что . кажется какой-то момент за пределами нужной нам области что делать в этот момент да в общем то просто перепрыгнуть так называемый interception point точку пересекающую границу и таким образом продолжить возвращать пользователю данные примечательно что для этого алгоритма не требуется преобразовывать данные обратных di carta вaм координатам то есть у нас есть просто несколько битовых строк и мы работаем только с ними пример такой это ли не имеет алгоритм имеет линейную сложность от длины этой битовой строке ну ровно также как и сам как алгоритм проверки того что . предлежит заданный пользователем области известно в tarantul и яндекс это некоторая структуру у которой есть некоторый набор методов в ответ на часть из этих методов служебные мы их не будем рассматривать например что при что стоит делать если индекс обновляется также не будем рассматривать те и методы которые ручаюсь за статистику то есть размер индексы сколько в нем элементов какую память он занимает но при этом есть интересные методы для именно работы с данными например метод get в у вас у себя в работе я его никак не использовал потому что метод get работать только с уникальными индексами в моем случае обеспечить уникальность индекса было достаточно сложно именно из-за работы со строками то есть две строки могут иметь одинаковый префикс но при этом быть совершенно разными по этому соблюсти уникальность не получалось поэтому индекс всегда не уникальный опыт как и встроенных тарантул r3 также есть метод replace который на самом деле не только риплейс но еще и далит апдейт insert вот если нужно удалить the new то пол будет равен null если это как отличить insert от реплей со да в общем-то по параметру до при place мод то есть insert это операция едем патентная то есть уникальный индекс а не смогу вставить одну и ту же запись дважды а вот риплейс может заменять сколько угодно ну естественно с помощью этого параметра до при place мод это можно различать но в моем случае он даже не понадобился потому что еды всегда не уникальный не crate итератор то есть когда мы делаем либо pairs либо select создается итератор который потом последовательно обходят интересующие нас данные ну и как раз за этой функции находилась вся логика итерации по кривой зад порядка когда индекс был написан нужно было задуматься о том как пользователь зло через но будет с ним работать соответственно попробуем решить примерно похоже дача тем что были вначале тесно создаем индекс первичный задаем он должен быть уникальным у нас индекс не уникальный поэтому опять-таки воспользуемся монотонным счетчиком создадим индекс из двух частей для простоты визуализации и понимание ну и заполним его дальше дальше можно сделать просто поиск по в некоторых прямоугольной области нам все вернется поиск отдельной . на самом деле поскольку яндекс не уникален на могла бы вернуться больше одного значения но в данном случае мы указали . поиск с открытым интервалом то есть по оси x у нас есть ограничение по оси y у нас нет ограничений ну и также полу интервалы по каждой из осей теперь как тестировать с чем сравнивать это решение было написано захотелось понять насколько она адекватно и стоит ли продолжать развивать это все дело и стоит ли это все contribute сам тарантул соответственно изначально как я говорил b3 не подходит для решения задачи поиска в многомерном ногами среди многомерных данных и наиболее логично проверить вообще стоит ли игра свеч сравнив это дело с fuse к нам есть ли хоть какой-то выигрыш но я проверил тест apple достаточно коле ночная и получал и заключались в следующем я брал миллион точек и в располагал их в некотором пространстве затем увеличивало размеры с этого пространства и смотрел как изменялась время выполнение запросов не стоит удивляться что время поиска снижалась при увеличении пространство для на кривой зад порядка просто преувеличение пространство меньше шанс того что . упадет в область поиска то есть и селективный целиком и в некотором интервале и в общем то здесь все выглядело обнадеживающий то есть да это лучше чем в узком при этом если задать данные определенным ну в общем не неравномерно распределенных точек дух ситуация несколько менялось то есть если я часть данных выводил за область поиска чтобы дерево практически тренировалась по пустой области а вот у зад кривой возникали лишние паразитные прыжке ну и соответственно сср 3 та самая структуру которой как раз и предназначен для решения этой задачи в по нескольким критериям здесь уже имело смысл сравнивать и скорость записи и память которую потребляет данный индекс и как искать в прямоугольной области время поиска и запись выглядело тоже обнадеживающий то есть практически в два раза на больших размерностях зад кривая работала быстрее примерно та же самая выдел и в памяти потребляемый это индекс на основе зад кривой получился компактнее а вот с поиском все получилось достаточно проблематично соответственно на больших размерностях те которые пустые дерево просто сканеры выбиралась пустой области а вот у кривой зад порядка возникали проблемы собственно поэтому я ты осталась в рамках эксперимента который на самом деле получился не особо удачным в плане итога но тем не менее все равно интересно вот ну кроме этого за год все изменилось и в tarantul и появился менеджер транзакций самым сам по себе доклад про manger фразах и к сожалению не попал в программу презентации но теперь надо если захотеть подержать это в текущей версии нужно подружить кривую зад порядка с этим менеджером информацию о мы начали транзакцией вы можете найти либо на ю тубе либо вот прочитать статью на хабре минутка рекламы ну и что получается нечто было сделано и считаю все таки что отрицательный результат тоже результат и теперь я поняла как работать сам тарантул делюсь этим этой информацией с вами ну и в чем то чувствую себя уверенной а когда разрабатываю на тарантула при этом тарантул это open source продукт и вы можете прийти на git хоп посмотреть исходники что-то для себя узнать что-то изменить предложить нам эти изменения но не не бойтесь экспериментировать вы если у вас есть какие-то желания вы можете прийти к нам и оставить и шью в репозитории git коби ну и так же присылать свой пыл request если все-таки хотите помочь проекту спасибо за внимание вопросы олег спасибо за доклад давайте вопрос сдаем нашего мои слушатели тоже могут вопросы задавать там есть специальная кнопочка на плеере поэтому не стесняйтесь олег спасибо мир вот этот олег спасибо большое за такой а скажи пожалуйста сколько у тебя за него времени вот на этот прототип сколько ты потратил чистого времени разработки и тестирования всего этого но чистого времени то есть это было это писалось свободное время я могу слышать потратил там два-три месяца именно вот разработка прототипа хотя сама идея вот раскуривания сортов тарантул тоже заняла до этого часть времени но именно разработки но вот в свободное время несколько месяцев я вот занимался задачи и и второй вопрос сразу в ту же тему большая ли код в базу тебя при этом получилось сколько строчек кода примерно но это уж сколько строчек кода в моем патча получилось но я думаю там две три тысячи строк получилось с учетом того что часть кода было достаточно шаблона то есть нужно было реализовать интерфейс и для того чтобы соответствовать интерфейсу индекса в таранто ли микрофон не работает секунду так этот теоретический вопрос если ты не слышал то я повторю соответственно тарантул сам по себе однопоточный и если делаем один запрос на баланс достаточно быстро но если мы начинаем делать узел последовательность запросов то они становятся в очередь и выполняются уже медленнее до тарантул однопоточный но это все таки эту проблему можно решить ответственно как это работает на низком уровне мы делаем запрос например вставку после этого 3 мы передаем управления скажу так другим клиентам вот и в это время мы ждем записи вал когда записывал проходит мы возвращаем управление если мы хотим делать это большое количество запросов то здесь есть два вывода выхода если мы делаем это из одного клиента то есть смысла обернуть все в одну большую транзакцию тогда мы делаем кучу запросов и они бачок записываются в red hat лоб а про select запросы до select и будут последовательно выполняться это так но все select и делаются с оперативной памяти но ну да и из и выполнить один запросе остальные клиентов будет ждать это так сейчас я видел задачу это уже не знаю road map не road map задач на создание raid view для больших запросов и соответственно в этом случае team for кать отдельный трек или файбер для того чтобы делать большие запросы в таранто ли им на параллельно но пока это лишь идея в онлайне на снял образовать простите спасибо за к у меня два вопроса первое это да какой размерности выдавших доходили многомерных индексов где еще работала потому что подогретым стандартный боксу столь вон там да размеренную вместе стол больше не работает в tarantul и r3 имеет ограничение на размерность 20 здесь я тоже решил для сравнения используют размерность 20 но в принципе там поднять до 30 32 ну вот есть возможность потому что дальше начинаются манипуляции светлыми мазками там все бы скорее еще больше игра der овала но вот эта размерность 20 максимально возможное для создания и второй вопрос вот вы показали как вы можете с данными в яндексе работать но во первых если втором туре include к индексу то есть видимо не возможность положить данные рядом с индексом от стройки нет но это и не нужно ну то есть это дисковый движок и если и яндекс это отдельная структура и хранит физические данные только первичный индекс мы делаем запрос к вторичному индекс у нас лежит там указатель над apple поэтому никого там проигрыша в производительности у нас нету то есть мы просто по указателю берем какое-то значение еще вопросы спасибо за доклад хотел еще узнать о наскок там отличается построении индекса для движка винила лишь к вот вами макс ну это вообще два разных мира про движок движок винил в нем всего один тип индекса и это lsm дерево вас там такое нельзя сделал да там ну там придется заморачиваться с тем чтобы это всё ещё на диск сохранять ее особо винилом я это не смотрел даже с исходите винилового самом деле вот только смотрел момент но если хочется побольше узнать и винил то в принципе на предыдущих аллодах также проекта рассказывалось и можно найти видеозаписи еще вопрос для винила сами индекса они хранятся также рядом с данными на жестком диске вот на жестком диске насколько я знаю да то есть если мы делаем вторичный индекс то он включает себя некоторые указать они сейчас там еще включается часть указателя на первичный индекс то есть первичный ключ и по нему мы потом достаем те данные которые уже нужны пользователя спасибо не целиком до хранятся то плод во вторичном алексей еще вопрос вот b3 дерево но хорошо мы если там добавляются данные мы еще добавим еще парочку у колонок в яндексе там можем задать специфичный там комиссии колонок там пример 10 то и нам нужно ускорить какой-то конкретный запрос мы можем там выбрать там четыре колонки по которому создать яндекс вот вопрос от про ваш эксперимент и вот как можно комбинировать и ваш поиск и вот поиска да у нас все дополнительные фильтры которые хорошо ложатся на бы три дерева звуковой тасовал горит моими намджа индексов нету ответственно нужно писать какие-то свои условия небольшой скрипт на ло которое будет сканировать по индексу и потом дополнительно отфильтровывать коды по пользовательскому условию данные мы уже скажем так на уровне lua снова приложениями на уровне лишнего приложения ну или там не знаю иску или за использовать в тарантулов есть и сколько спасибо если больше вопросов нет поблагодарим нашего уважаемого спикера сегодня состоялся ты как я понял на хайло де дебют на выступление поэтому эту это вдвойне почетно призы в студию далек еще выбери пожалуйста вопрос лучший который тебе понравился так лучше вопрос вот давайте последний вопрос про хотя сейчас зажмите не понравилось больше тут просто было долго данных в много вопросов именно про устройство самого тарантула давайте вот самый первый вопрос кино про яндекс который был"
}