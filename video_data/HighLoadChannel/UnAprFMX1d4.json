{
  "video_id": "UnAprFMX1d4",
  "channel": "HighLoadChannel",
  "title": "Causal consistency: от теории к практике / Михаил Тюленев (MongoDB)",
  "views": 1873,
  "duration": 2953,
  "published": "2019-12-05T13:16:12-08:00",
  "text": "я буду рассказывать про казал конце ственности эта фича которую мы который мы работали mongo db я работаю в группе распределенных систем и мы то мы сделали примерно 2 года назад и в процессе пришлось ознакомиться с большим количеством академического research потому что это фича ну достаточно хорошо изучена и выяснилось что она абсолютно не одна статья никаким образом не вписывается в то что требуется вот в продакшен базе данных виду весьма специфических требований которые есть наверно в любом продакшен апликэйшен я вот буду рассказывать о том как мы являемся потребителем академического ресеч и готовим из него что-то такое вот что мы можем потом вот я не знаю преподнести нашим пользователям качестве готового блюда которым удобно безопасно пользоваться вот но для начала я хочу вообще в общих чертах сказать что ж такой козел consistency вот здесь два персонажа леонард и пенни если вы не смотрели теорию большого взрыва посмотрите вы будете знать то они такие и предположим что пенни в европе леонард хочет сделать какую-то для нее сюрприз тусовку и для этого ничего лучше не придумывает как выключить выкинуть из френд-лист а послать всем друзьям апдейт нафидить и подавайте порадуем тени вот она в европе там пока спит не видят этого всего и не может увидеть тому что она не там это конечно моменте удаляет этот постирает его из вида и значит восстанавливает акс ошибана ничего не вообще не заметил скандала не было вот это все прекрасно но давайте предположим что систему распределенная вот и событию пошли немножечко не так может например случится что ограничения access a penny произошло после того как появился этот пост если событие не связаны между собой причинно-следственными связями вот вот собственно говоря это пример когда требуется наличие козел консистенции для того чтобы выполнить некоторую вот бизнес функцию в данном случае вот это на самом деле достаточно нетривиальные свойства базах данных очень мало кто его поддерживает но давайте перейдем вообще к моделям консистенции перейдем вот что такое вообще как модель консистенции в базах данных это некоторые гарантии который распределенная система дает по поводу того какие данные в какой последовательности клиент может получить вот это в принципе все модели консистенции сводится к тому насколько распределенная система похоже на систему которая работает на одном нодди например вот там на лаптопе и вот насколько система которая работает на тысячах но так я где а распределенных похоже на лаптоп вот которым принцип все эти свойства выполняются автоматически вообще поэтому к модели консистенции а не только к распределенным системам и применяются все системы там которые раньше существовали работали на одном вертикально масштабировались там таких проблем просто принципе не был там был один баф ракета из него все вычитывал всегда ну и вот собственно самая первая модель at a strong или линия реза делайте как ее часто называют это моделька сентенции которая гарантирует что каждое изменение как только ну получается подтверждение что оно произошло от сервера но становится видно абсолютно всем пользователям этой системы вот это вообще говоря создает глобальный порядок всех событий в базе данных это очень сильное свойство консистенция но вообще очень дорогое тем не менее но достаточно хорошо поддерживается она просто дорогой медленно им просто редко пользуются вот называется линия разобьете есть еще одно еще более сильные свойство которое поддерживается с по мере называется external консистенции году про него поговорим чуть позже вот следующие научиться пользоваться этой штукой получше следующая итак о зал как раз сто про что я говорил между strong указал на самом деле еще существует несколько там таких подуровни я которых они просто не буду говорить но они как бы все сводятся к заказу это важная модель потому что она самая сильная из всех моделей самой сильной консистенции с при наличии а разрывов сидели портишь смотка за это вот собственно ситуация в которой события связаны причинно следственной связи очень часто их воспринимают как риты и он rights с точки зрения клиента а также если клиент наблюдал скажем какие-то значения он не может увидеть значение которые были в прошлом то есть он уже начинает видеть как бы префикс на и чтения вот ну и так далее вот это вот собственно все сводится к одному и тому же козел это модель консистентной sti в которой это частично упорядочивание события на сервер и таким образом что со всех клиентов они наблюдают в одной и той же последовательности данном случае вот леонард и пенни вот ну и соответственно третья модель это и венчал конце снасти это вот то что собственно поддерживает абсолютно все распределенные системы это минимальная модель который имеет вообще смысл оно означает что когда у нас происходит некоторые изменения в данных они в какой-то момент становится консистентными в какой момент модель ничего не говорит если бы она говорила то оно бы превратилась в экстерном конце снасти это было бы совершенно другая история но тем не менее это очень и очень популярная модель на самом деле самый распространенный это по умолчанию все пользователи распределенных систем используют именно венчал концерт вот так и вот я хочу привести некоторые сравнительные вещи то есть что эти стрелочки означают лейкен сие при увеличении сильно силы консистентная не она становится больше ну по понятным причинам потому что нужно сделать больше записи подтвердить подтверждение от всех хвостов от всех модов которые участвуют кластере что данные там уже есть вот ну соответственно увеличил консистенции конце ственности там самый быстрый ответ потому что там просто а как правило то можно даже в memory закомитить и это уже в будет принципе достаточно оставила белый ти если это понимать как возможность система ответить при наличии разрывов city park шанс или каких-то отказов рассказы отказоустойчивость она тоже возрастает при уменьшении к модели конце снасти потому что нам в принципе достаточно чтобы вообще один ход жил и при этом выдавал какие-то данные потому что венчал конце еще не гарантирует ничего по поводу данных это может быть все что угодно вот мы при этом естественно возрастает количество аномалий и ввод в строй к естественности их как бы не должно быть вообще никаких почти что вы венчал конце затянем могут быть в принципе какие угодно вообще возникает тогда вопрос почему же люди вообще выбирают увенчал конце если она такая не очень содержит аномалии так далее но ответ в том заключается что практически винчи вулкан численность модели они применимы то есть аномалии существует в короткий промежуток времени например всегда существует возможность использовать мастер для чтения скажем и более-менее читать консистентные данные и и часто и есть возможность использовать сильные модели консистенции то есть практически это работает и количество аномалий всегда очень ограничены часто ограничены по времени в том числе но когда вы видите слова консистенсии availability что вам приходит на ум вот-вот правильно cup теоремы как оно произносится вот я сейчас хочу вот на мой взгляд развеять миф вот я не знаю это не я им как бы этот миф есть мартин клэпп на который написал прекрасную статью очень прекрасную книжку укаб теорема это все был как принцип который был приором сформулирован 2000 там нулевых каких-то годах о том что консистенция villa bella эти партии шин стайка нету вот и нельзя сделать выбрать 3 вот это вот балу это некий принцип был он был доказан как теорему несколько лет спустя там жил bird and fitch по-моему это сделали после этого вот просто это стало использоваться как какая-то мантра систему стали делиться си си си пи это мы и так далее вот это все началась вот я хочу вот что сказать что вот эта теорема на было доказано на самом деле вот для каких случаев во первых a well и билотти рассматривалось никак мы может быть прогну люди которую пользуется базами данных и рассмотри моими на некое непрерывные значение от нуля до сотни то есть от нуля вообще система мертвая 100 она как-то там отвечает быстро а это свойство алгоритма который гарантирует что при всех его execution он возвращает данные про время ответа там вообще нет ни слова и принципе алгоритм которые там возвращать данные через сто лет совершенно прекрасная вилла была алгоритм который является частью вот этой вот теорема cup теоремы первое второе доказывалось теорема для изменений в значениях одного и того же ключа при тем что эти изменения линия рай забыл вот то есть это означает что что практически на самом деле они не используются потому что модели другие венчал консистенции strong консистенции там может быть вот то есть все то чему это говорит что cup теорема она практически вот именно в той форме в которой она доказано неприменим редко просто используется а в теоретической форуме она просто каким-то образом все ограничивает но это получается такой некий принцип который интуитивно верен но он в общем то никак не доказаны вот то что сейчас происходит как правило практически это все три вещи то есть качественности его ловить можно вообще получать при наличии партий шанс вот в частности козел конкретность как раз такая модель которая самая сильная модель консистенции который в конце снасти которые при наличии портишь нас то есть разрыва все те все равно работает вот то есть поэтому вот она и представляет такой большой интерес мы собственно поэтому и занялись потому что она во-первых имеет очень упрощает работу разработчиков приложений наличие вот такой поддержки со стороны сервера когда все записи скажем которые происходят внутри одного клиента гарантированно придут в таком последовательности ну где-нибудь еще на другом клиенте вот а во-вторых она выдерживает портишь вот ну и вот сейчас все таки помню о том что ланч вот мы перемещаемся на кухню вот и я расскажу про модель системы а именно что такое манга дебит для тех кто может быть 1 слышит первый раз и такой базе данных вот я буду исходить из этого mongo db это распределенная система который поддерживает горизонтальное масштабирование то есть sharding и внутри каждого шарда она также поддерживает избыточность данных точек репликацию вот sharding в mongo db выполняет автоматическую балансировку данных то есть каждая коллекция документов 0 таблица в терминах реляционных данных man где бен не реляционных баз данных каждая коллекция разбивается некоторые кусочки и уже сервер автоматически двигает между различными шар даме и вот клэри раутер который собственно распределяет запросы и для клиента это просто является некоторым агентом через который он работает он уже знает где какие данные находятся направляет все запросах правильному там шар ду и в общем все как бы там работает вот еще важный момент омон где by the single мастер то есть есть один праймари который может брать записи которые поддерживают вот в данном те ключи которые он себе содержит нельзя сделать мальте мастера its пользуюсь случаем поскольку вот мы сейчас только сделали релиз 42 там появились новые всякие интересные вещи в частности ставили люсин поиск а вот именно их экзо куда бы я вы прямо вот мангой там стало возможно делать поиски через люсин такие же как вы ластики вот и сделали новый продукт чарте он тоже доступен на атласе у банка есть клаус свой называется атлас их есть фридер и вот можно поиграться с этим начальство-то посмотрел на самом деле не очень по нраву просто визуализация данных но она такая очень интуитивное вот и теперь возвращаемся собственно cказал консистенции по поводу ингредиентов то есть я вот насчитал порядка 230 статей которые вообще были опубликованы на эту тему то есть от если lampard до наших дней вот сейчас я с памятью своей вам их донесу какие-то части этих статей вообще все началось со 100 тела если лампа рта который был написан в 70-х годах и вот до сих пор как вы видите все равно продолжается какой-то ресеч какие-то исследования в этой теме на самом деле сейчас отказал качественности переживает такой вот интерес связи с развитием именно распределенных систем вот о чем какие ограничения есть все это одно из самых главных моментов потому что ограничение которое накладывает production системы сильно отличаются от ограничений которые существуют в академических статьях они там часто достаточно искусственные вот во первых манга тебе это сингл мастер как я говорил это сильно упрощает вот мы считаем что где-то порядка десятков тысяч шар дав система должна поддерживать мы не можем какие-то архитектурные решения принимать которые будут явно ограничивать вот это значение потом ну есть конечно у нас к облака но мы все-таки предполагаем что должно оставаться так же ситуация когда человек скачивает баннере запускает у себя на лаптопе все прекрасно работает мы предполагаем то что вот как раз в рисе очень редко используется что внешнее клиенты могут делать абсолютно что угодно вот манга 9 пан source и соответственно клиенты могут быть достаточно умны и злы такие вот хотят все буду хотеть все сломать соответственно мы предполагаем что вот византийские филлеры могут происходить для внешних клиентов которые за пределами периметр важное ограничение если эта фича выключена то никаких ты форма degradation не должно наблюдаться вот ну и еще один момент который вообще в его как правило анти академический совместимость между предыдущими версиями и возможными будущими то есть старые драйвера должны поддерживать новые апдейты база данных должна поддерживать там старые драйвера и в общем вот это вот все накладывает ограничения и я вот сейчас расскажу про некоторые компоненты вообще если рассматривать козел конце связи можно выделить блоки то есть мы выбирали из работ которые относятся каком-то блоку первое это dependency tree конь потом соответственно выбор часов как эти часы между собой можно синхронизировать и как мы обеспечиваем безопасность вот это примерный план того о чем я буду говорить ну давайте начнем с эти ценности треки зачем она нужна и нужна для того что когда данные реплицируются то чтобы каждая запись каждое изменение в данных содержал в себе информацию о том от каких изменений она зависит вот но и самые первые наивные изменение это вот когда каждое сообщение которое содержит себе запись содержит себе информацию предыдущих сообщениях вот ну в данном примере допустим вот эти номера в фигурных скобках это собственно нами раздав допустим запись иногда там даже целиком эти записи со значениями передаются на до версии какие-то передаются но суть заключается в том что каждая изменение содержит себе информацию о предыдущих примут явно но несет это все по себе и full ну полный траппинг то есть почему мы решили не пользоваться таким подходом ну потому что очевидно этот подход ну вообще не практически никак по любое изменение в социальные сети она зависит от всех предыдущих изменений в этой социальной сети передавай скажем там фейсбук или вконтакте в каждом тайцы очень непрактично тем не менее есть много research вот именно fool to die пряности through any то при социальные сети для каких-то ситуация действительно работает вот следующее это более ограниченные здесь expressed through an то есть тоже рассматривается передачи информации но только той которая вот явно зависит это как правило определяет уже applications то что от чего зависит и вот уже когда другое скажи данные реплицируются при запросе выдаются только ответы когда предыдущие зависимости все были удовлетворены то есть и были показаны то есть в этом собственный суть как это козел к ответственности работает она видит что скажем запись 5 зависит от запись 1 2 3 4 соответственно и она ждет прежде чем клиент получает доступ к изменениям внесенным там восстановлением access a penny когда все предыдущие изменение позже прошли в базе данных вот собственно и все вот но это тоже нас не устраивает потому что s равно информации слишком много и это будет замедлять вот но тем не менее есть такой подход как называется lampard лог он очень старый вот и лампад как он подразумевает того что вот эти dependency они сворачиваются в скалярную функцию который называется лампадку лаком вот скалярная функция это не к тычет некоторое число абстрактные совершенно вот и вот допустим часто его называют логическим временем и вот она при и получению при каждом событии аккаунт увеличивается также каждое сообщение этот каунтер переносит cantare который в настоящий момент известен процессу который его посылает понятно что процессы могут быть рассинхронизированы у них может и совершенно разное время но тем не менее вот таким обменом сообщениями систему как-то вот балансирует часы вот его что происходит в этом случае соответственно я сейчас разбил тот большой как бы шард на 2 той чтобы было понятно что вот фрэнд скажем могут жить в одном ноги который содержит себе кусок вот этой вот коллекции afet может жить вообще в другом роде в котором содержится кусок этой коллекции то есть понятно как они могут вообще попасть не в очереди то есть сначала fit скажем реплицироваться потом фрэн то есть если система не обеспечивает каких-то гарантий что fit не будет показан пока зависимости френда все в коллекции frends были тоже доставлен это от нас возникнет как раз ситуация про которую я говорил вот ну и вот вы видите как увеличивается логически время кантер на федей но и вот соответственно таким образом основным как бы свойствам вот этого lampard клок и козу качественности объединенный через lan порт клок заключается в общем если у нас есть событие a и b и событие b зависит от события а иногда ещё говорит там что ahead and be for события b то есть а случилось раньше чем события b это вот некое отношение которое частично упорядочивает все множество событий которые вообще произошли вот то из этого следует что local time out even the она меньше чем logical time в нтб вот в обратную сторону неверно то есть в этом на самом деле один из основных вот минусов lampard как это частичный порядок и там есть понятие о одновременных событиях то есть события в которых не обязательно то есть не eventos hip and even be given the penguin а это может быть ну примером скажем какой параллельно и добавление в друзья кого-нибудь еще леонардом и который вообще никак не связана и даже не леонардом а скажем шелдоном вот ну это еще один персонаж таким образом вот это вот и есть свойство которое часто пользуются вот именно при работе с lampard часами то есть смотрят именно на функцию из этого делают что может быть эти события зависит от того что в одну сторону это верно что если а меньше logical тайма меньше чем можешь круто им бета бы не может happen бифа а если больше то может быть вот следующие часы которые на самом деле логическое развитие вот lampard клок это векторные часы они отличаются тем что каждый not который здесь есть он содержит себе свои отдельные часы они передаются как вектор вот то есть ответственно вот тут в данном случае вы видите что нулевой индекс вектора отвечает за фид первый индекс векторы отвечает за france то есть каждый из этих модов и вот они сейчас будут увеличиваться то есть with a нулевой индекс виды вот он увеличивается 12 сейчас 3 то есть при записи чем вектор клок лучше тем что позволяет разобраться какие события одновременные когда не происходит на различных ну нах это вообще очень важно для системы шарди рования скажем как манга деби однако мы это не выбрали вот по той причине что хотя эта прекрасная штука вообще и замечательно работает все и нам наверно подошла бы если у нас 10000 шар дав мы не можем передавать 10000 компонентов даже если мы как-то их там сжимаем еще что-то придумаем все равно и полезная нагрузка будет там в разы меньше чем вообще объем вот этого всего вектора поэтому скрепя сердце есть зубами при зубы и вообще все мы отказались от этого подхода и перешли к другому вот ну вот для я говорил что будет рассказ про спайнер это вообще крутая штука вот это прям такой вот двадцать первый век то есть атомные часы gps синхронизации там идея какая что spanner это гугловской а система которая стала даже недавно доступно для людей как и стоили они приделали к низкой вот и там каждая транзакция имеет некоторые таймс тем поскольку время синхронизировано вот в этом основная проблема почему lampard club из ним нельзя использовать время потому что часы никогда не синхронно на распределенных системах да они могут расходиться там даже при наличии он тебе все равно работают не очень хорошо а вот спайнер используют атомные часы и синхронизацию с точностью там да помоему микросекунд поэтому у них каждому событию можно назначить некоторый time stamp у них есть время ожидания после которого гарантированно происходит уже другое время то есть ответственно к таким образом просто записываю в базу данных и ожидая какой то период времени автоматически гарантируется вот эта сериале ази сериала и забил эти события это у них самое вообще сильно contessa если модель который принципе можно представить то есть она externally consistent вот проблем почему мы не выбрали это но у нас нету мы не предполагаем что у пользователю наших есть в наличии атомные часы встроена когда не появится уже встроенный в каждого топы либо будет какая-то супер крутая там gps синхронизация вот тогда да в это пока что лучше что возможно это amazon bass station вот для таких фанатиков этого дела вот поэтому мы на самом деле использовали другую другие часы а именно гибридные часы гибридные часы это вот то что фактически тикает в manga тебе при обеспечении кожу конце ственности гибридные они в чем гибрид это скалярное значение но стоит из двух компонент первое это просто и не кто вы и эпох а то и сколько там секунд прошло с начала мира в компьютерного вот и второй это некоторый инкремент тоже 32-битный ancient and вот это собственно все это вот есть такой подход то есть вот эта часть которая отвечает за время но все время синхронизируется с часами каждый раз когда происходит некоторый апдейт а вот эта часть синхронизируются с часами и получается что время всегда с более-менее там правильная инкремент позволяет одну различать различные события которые произошли в одно и то же момент времени вот почему это важно для вас манка тебе потому что позволяет делать какие-то backup restore и на определенный момент времени то есть события индексируется временем вот это вообще важно когда нужны некоторые события но для базы данных событий это изменения в базе данных определенно которые произошли в определённый момент времени или промежуток определённый момент времени то самую главную причину я скажу только вам пожалуйста никому не говорите мы так сделали потому что на самом деле это вот таким образом выглядит упорядоченны данные индексированные данные в мангу тебе облака блок это да структуру данных которая содержит себе абсолютно все вот изменения в базе они сначала попадают waplog а потом уже применяются к собственных старриджа в том случае когда я это рипли пицца реплицирования дата или там шар и это на самом деле было главный причин потому что все таки че тут еще и практически требования к разработке базы это значит что но должно быть просто молоко да как можно меньше сломанных каких то вещей которые нужно переписывать перед тестировать это вообще идеально просто влекло то есть то что у нас оказалось гибридными часами проиндексированы a plague это сильно помогло и вообще говоря позволило сделать правильный выбор это действительно оправдала себя то есть как то она прям как то волшебно заработало сразу на первом же прототипы был очень грудам вот ну а теперь как бы как эти часы вообще можно между собой синхронизировать несколько способов синхронизации опять же описанных в научной литературе я говорю про синхронизацию когда у нас есть два различных шар да то есть они между собой не обязательно то есть если одна реплика с этом никакой синхронизации не нужно это сингл мастер у нас есть вообще говоря о плох в которой все сам все изменения попадают и ну и понятно что в этом случае уже все на самом деле секвенцию леонард в самому блоги и так ноет если у нас есть два разных шарда вот десинхронизации времени важного тут вектор на часы бочку могли вот но у нас их нет второй подход это хард биты то есть можно обмениваться некоторыми там с сигналами которые происходят каждую единицу времени но харбин слишком медленным и не можем деятельности обеспечить нашим клиентам вот нутру там конечно прекрасная штука но опять же это наверное будущее вот ну хотя в атласе кстати говоря уже можно сделать уже есть на самом деле быстрые синхронизаторы времени amazon узкие там у них есть такие сервисы но это не будет доступна для всех вот и вот глаз и pineta собственно когда просто все сообщения включают в себя время но это вот примерно то что мы используем то есть каждые вообще сообщение в manga деби которая а между нодами она там он к тебе это является драйвера раутера собственно дата но воды вот абсолютно все это вот какие-то элементы базы данных компоненты базы данных которые содержат себе часы которые тикают вот у них везде есть значение вот этого гибридного времени она передается это в общем сколько там получается 64 бита это позволяет это можно ведь не всем вот теперь давайте посмотрим как это все работает вместе вот происходит не сердись я рассматривал одну реплика сет чтобы чуть-чуть попроще есть primary и secondary понятно что секунды делает репликацию и не всегда полностью синхронизирован с праймари вот происходит insert в праймари с некоторым значением времени этот сорт увеличивает внутренний контур там на 11 если это максимально или он будет проверять что значение часов и синхронизируется по часам если значение часов больше то есть это позволяет упорядочить это минут таким образом по времени вот ну вот после того как он делает запись происходит важный момент часы манга деби инкрементироваться только в случае записи в блог это вот является и событием который меняет состояние системы то есть классических во всех во всех абсолютно статьях событием является некоторое попадание сообщения вот внутрь сообщение пришло значит система изменила свое состояние я связана с тем что ну там не совсем можно привезете понять как это сообщение будет интерпретирован а мы точно знаем что если она не отражено в блоге она никак не будет интерпретировано в целом то есть и изменением состояния системы является только запись в блог опять же это очень сильно все нам упрощает и модель упрощает и позволяет ввести упорядочивание в рамках одной реплики сета и много чего другого полезного вот то есть возвращается вот это значение которое записано же waplog мы знаем что в во плоти уже лежит чение у него время 12 вот а теперь происходит чтение скажем с другого но до secondary вот и он передает уже вот авто кластер time в самом сообщение говорит мне нужно все что произошло как минимум после 12 или во время 12 то есть это то что называется козлы и consistent кат то есть такое в теории понятия что это вот некоторая срез времени в которой consistent на само по себе то есть можно сказать что вот это во дворе в состоянии системы который был в момент времени 12 данном случае вот сейчас еще пока здесь ничего нет потому что это как бы имитирую ситуацию когда нужно чтобы вся конторе реплицировать данные из праймари его тут ждет ждет ждет вот и вот данные пришли и он возвращает уже назад эти значения так это примерно все работает почти что это что значит почти что почти что насчет ваш давайте предположим что есть некоторые человек который хочет посмотреть прочитал код понял как все работает понял что каждый раз вот происходит к этот кластер тайма но об треть от внутренние логические часы и потом следующая запись увеличивает на единицу да это ровно так все и работает там эта функция занимает 20 троп ну допустим что человек вперед и просто передает максимально означает максимально большое 64-битное число минус единицы и вот почему минус единицы потому что внутренние часы поставятся в это значение потому что это ну очевидно самый большой возможно и больше текущего времени и потом произойдет уже запись в блог и часы инкрементируем еще на единицу и уже будет вообще максимальное значение там просто все единицы дальше некуда on site and и вот но и понятно что после этого система становится абсолютно недоступно вот для чего ее можно только выгрузить вот как-то почистить найти вот много ручной работы такое полное новелла белости причем если это реплицируется еще куда то то это просто ложиться весь кластер абсолютно неприемлемо ситуации который в общем-то ну любой человек может сделать очень быстро и просто поэтому мы осматривали вот этот момент как один из самых важных на самом деле как вот его предотвратить вот наш путь был подписывать кластер times то есть вот собственно так оно передается в сообщении доллар кластерной мы там внутри вот этот вот times ст м вот но мы стали еще и генерить подпись вот подпись генерится ключом который хранится внутри базы данных которые там внутри защищенного периметра сам генерируется тома птица как-то очень пользователя этого ничего не видит генерируются хэш и соответственно каждыми каждое сообщение при создании оно подписывается а при получении нового лидеру its а вот но наверное возникает тоже вопрос у людей насколько это все замедляет потому что я же говорил что должно быстро работать особенно при отсутствии этой фиче то есть люди могут не пользоваться что значит пользоваться козел к честности в данном случае это вас показывать вот этот автор класс 3 times параметр то есть это вот как бы включить козел консти снасть а без этого он просто будет передавать эти значения в любом случае то есть go степень начиная с версии 36 36 работает всегда вот если мы оставим генерирование подписи все время то это будет замедлять ситуацию то есть даже при отсутствии течи что абсолютно не соответствует как бы нашим этим подходом и требованиям мой поэтому вот что мы сделали вот достаточно простая вещь ну трюк я не знаю поделюсь кому то будет интересно значит нас есть кэш в котором собственно хранятся подписанные данные все данные идут через cash cash подписывает не конкретно время подписывает range вот то есть когда приходит некоторые значения мы на самом деле генерим речь маскируем последние нам 30 16 бит и вот это значение мы собственный подпись поэтому с подпись получается как бы то есть мы ускоряем ситуацию 65 тысяч раз таким образом она прекрасно работает когда сделали эксперимент потому реально 10000 раз сократилось время но когда у нас последовательно апдейт понятно не совсем разнобой там этого не получается но большинстве практических случаев это работает и вот два позволило использовать вот комбинации вот эту подпись и ренджа вместе с подписью позволила решить эту проблему security вот ну и как бы уроки которые из этого извлекли ну а ты все конечно первое что нужно читать материалы вообще с истории и кстати потому что много чего интересного есть когда вот вы работаем какой-то фиче особенно сейчас мы транзакции делали и так далее ну надо читать нужен разбираться это занимает время но это на самом деле очень полезно потому что стало понятно вот где мы находимся мы ничего нового как бы особо не придумали вроде бы да то есть мы взяли ингредиенты вообще разницу мышления вот когда академическая конференция как on сигмон там например там все фокусируются на новых идеях той самое главное в чем новизна вашего алгоритма вот здесь такой особый прям новизны нету это скорее новизна заключается в том как мы смешали вместе существующие подходы поэтому первое нужно все-таки читать классиков начиная словам порта вот ну далее понятно что продавцы в продакшене совершенно другие требования уверен что многие из вас тоже сталкиваются с не со сферическими какими-то базами данных в таком абстрактном вакууме а ну с нормальными реальными вещами у которых существуют проблемы по одела белый тёплый такси и по отказоустойчивости вот но и вот последние пожалуй это то что нам пришлось рассмотреть разные идеи скомбинировать несколько различных вообще статей как бы вместе в одно подход потому что скажем под подписывание пришло вообще из статьи которая ну так она как бы рассматривалась это access protocol который для не византийских федор внутри авторизационные протоколы для византийских за пределами авторизация ну тут а кому-то врут ровно то что мы собственно и сделали то есть как бы нового здесь абсолютно ничего нет но при этом вот как мы это все вместе смешали все равно что сказать что рецептом салата оливье это ерунда потому что яйца и майонез и огурцы уже придумали все так что чего тут уже говорить вот это примерно та же самая история вот ну и вот на этом я думаю что я закончу спасибо спасибо михаил давайте переходим к вопросам вопросов много пока девушки несут вам микрофон я хочу извиниться за casual сработал эффект красных пик спасибо михаил за доклад вот тема про время интересного используйте гости pink сказали что у всех есть свое время все знают какое тут свои локальное время я так понял что у нас есть драйвер призрак клиентов драйверами может быть много каире плееров может быть много сортов у нас много а к чему скатывается система то есть если вдруг возникнет расхождение кто-то shut up кто дальше что на минуту впереди кто-то на минуту позади где мы окажемся отличный вопрос на самом деле вот я как раз про шарды хотел сказать вот значит какая ситуация как вот я правильно понимаю вопрос если вот у нас есть шард 1 шард 2 чтению происходит с этих двух сортов у них расхождения они между собой на самом деле не взаимодействуют да потому что время которое они знают они может быть разные особенно время которое у них существует в блогах допустим шар до 1 там записал там миллион записей шар 2 вообще ничего не записала запрос пришел на 2 шар доён вот все и у него есть это автор кластер то им больше там миллионы допустим да вот в такой ситуации как объяснил шаг 2 вообще никто не ответит этот вопрос вот эта вязка я хотел знать как они синхронизируют одно какое-то время так да да да да очень просто синхронизируется это ну ладно уж вопрос был хороший а с расскажу shard когда к ним приходит вот это автор кластер time и он не находит времени в блоге он инициирует нового прайд то есть он руками на самом деле поднимает свое время до этого значения то есть это что на самом деле означает это означает что у него нету события которые вот отвечает вот этому запросу он создает вот это вот событие искусственный таким образом становится козыря consistent более к нему после этого еще приедут какие то события которые допустите где-то затерялись а если они после приедут просто шар так устроен поскольку это сингл мастер что они уже не приедут они если он это записал то они уже не привет они уже будут после то есть не может так получиться что что-то где-то застрял а потом это сделать новую райт а потом эти события приехали нарушил и сказал к ответственности то есть когда он делает но upright они должны приехать раньше он бы их подождем очень хороший вопрос предрассудок спасибо спасибо здравствуйте меня зовут антон меня есть несколько вопросов относительно череде и смотрите этой скажу к следствию лагаешь то есть очередь определенные если которые нужно сделать что произойдет если у нас один пакет один вот хоть одно один state пропадает от нас вот вот вот у нас пошел 10 11 12 пропал а все остальные ждут поклон исполнится вот вот и в нас вдруг машина умерла всем ничего не можем сделать то есть у нас есть как она тут сразу скупать миску вопросы к нему если максимально на очереди какая-либо которая там копятся прежде чем выполняется а второе что именно происходит с какой fatal филе что происходит при потере какого-то одного состояния тем более что если мы записываем что есть какое-то состояние предыдущие то от него же мы должны как-то отталкиваться от него не оттолкнули на прекрасный вопрос тоже значит что мы делаем то есть манга деби существует понять как форумных записи форумного чтения каких случаях сообщений может пропасть когда запись не кворум на или когда чтение не форумные тоже можешь прочитать какой-то гарбич вот поэтому мы совета есть на самом деле вот по поводу кузов консистенции сделали такой достаточно большой экспериментальную проверку вот и результатом этом проверки было то что в случае когда не кворум ные записи и чтения возникает нарушение козу концы снасть утром то что вы говорите поэтому наш совет использовать все таки кворум ных как правило как хотя бы к ровные чтение при использовании кузова концерт в этом случае пропадать ничего не будет даже если форумной запись продает пропадет но кворум на и чтения но то есть это это артека ортогональная короче ситуация если человек не хочет чтобы пользователь не хоть чтобы пропали данные нужно использовать провод полную запись то здесь а кварка злокачественности не дает гарантии durability гарантии dior белки дает реплики шин и machinery связаны с рипли течь ну спасибо прекрасно вопросе ответил да и небольшого продолжению коллеги которые прошла вопросы там про время все-таки когда создаем какой таинственность которую наш шар sharding выполняет снимать зарослей известно он опирается на unix время собственной машиной или он опирается на время мастера синхронизируется в первый раз то ли там впереди я сейчас поясню sharding sexart то есть горизонтальные партии там всегда есть праймари а у про уж орда в нем может быть мастер у него могут быть реплики но шар всегда поддерживает запись потому что он должен поддерживать домен некоторые domine там стоять праймари в шарди то есть и все зайцы сугубо от мастера то есть это всегда используется маэстро время да принц при время как бы можно такого рассказать что часы тикают когда происходит запись в мастер waplog и получается клиенту тоже не то есть у нас есть какой-то клиент котором мой канал птицу ему не нужен время в вообще ничего не нужно знать то есть если говорить про то как это длина клиенте то есть у клиента когда он хочет пользоваться козу конце снасти ему нужно открыть сессию но сейчас сессии вообще все там и транзакции в сессии и ретро я был rights тоже в средстве то есть сессии это не которая вот-вот упорядочение логических событий происходящих клиент вот если он скрывает эту сессию и там он говорит что он хочет казал конце ственности а по умолчанию сессии из поддерживают кожу качестве все автоматически работает то есть драйвера вот запоминает вот это вот время и увеличивает его когда получает новые сообщения он запоминает что вернул предыдущий ответ сервера который вернул данные потом следующий запрос будет содержать вот это автор кластер time больше этого клиенту не нужно над ровным счетом ничего про это абсолютно для него не прозрачна позволяет что делать если люди пользуются свечи во первых можно читать cdr с безопасно вот это важная вещь то есть можно писать на праймари а читать с географический реплицирующихся countries и быть уверенным что это работает при этом даже можно передать так сессии которая записала на праймари можно передать его на сайт анри некоторые так делают то есть можно использовать ни одну сессию а несколько спасибо так давайте мы сейчас здесь вот вопрос мой мужчина сразу поднимал руку и потом туда еще один вопрос зададим привет спасибо за доклад меня зовут андрей вот с темой и вершил консистенции сильно связана новый пласт компьютер сайт сердите типы данных конфликт при рипли кришна рассматривали ли вы интеграцию этих типов в базу и что то можете сказать об этом хороший вопрос вообще прям сердите имеет смысл для конфликтов при записи мол к тебе сингл мастер понял вернемся если кому-то нужно прояснить я могу пусть пуще снова здрасьте у меня вопрос от devops of в настоящем мире встречаются в принципе такие вот языческие ситуация действительно затем файла происходит злые люди внутри извините защищенного периметра начинают втыкаться в протокол специальным образом крафтовый пакет присылать злые люди внутри периметра это все равно что троянский конь какой-то там ну ну как бы злые люди внутри периметра могут сделать много плохих вещей не тот смысл такой что понятное дело что оставлять в сервере грубо говоря дырочку через которую можно там зоопарк салонов просунуть обвалить весь кластер навсегда потребуется время для ручного строева восстановления операции скальпель и над апломбом и так далее мягко говоря неправильно с одной стороны а с другой стороны любопытно вот что в реальной жизни встречаются ли там в практике ситуация когда натурально вот подобные внутренние атаки производит ну в реальной жизни я поскольку не часто сталкиваюсь именно стикере teбe речами просто не могу сказать может и не происходит конечно вот но вообще если говорить чисто вот девелоперская философия да то есть мы считаем что у нас есть периметр который обеспечивает ребята которые делают security вот и вот это вот это замок и вот эта стена внутри периметра уже можно делать все что угодно но понятно что все таки есть еще использовать или с возможности только посмотреть а есть пользователи с возможностью там стереть каталог например понятно что разные права и зависимости от прав в domyos который пользователь могут сделать это может быть мыша может быть услон в зависимости от прав на вас оппонент пользу с полными правами может вообще все что угодно и пользователь с небольшими правами скорее всего вреда может причинить существенно меньше в частности он не может сломать систему но это не вопрос из разряда под названием пользователя в рамках штатного протокола взяла и зашел под рутом и соответственно не ну можно по конфликта вашей с начальником разработчик который случайными какой то можно прицепляться центр представиться потом я конечно уволили но данные уже пропали может претендовать под названием защищенном периметр и натуральный тут полезному в протоколе неожиданные пакета формировать для сервера чтобы раком поставить сервер а если повезет и весь кластер уайтли на стоках ран ни разу не слышал про таких штук про такие вещи наверное наверное бы услышал вот то что вот таким образом можно завалить сервер это ну как бы части вообще не секрет вот завалить внутри находясь протокола будучи пользователя авторизованном который может там записать в сообщении что-то такое на самом деле нельзя потому что все равно будет верифицировать есть возможность отключить эту of the half индикацию для пользователей которые не хотят но это тогда их проблемам то есть но они грубо говоря разрушили сами стены и можно запихнуть туда слона который растопчет вот а так можно вообще одеться ряд как ремонтникам прийти там вытащить давайте зададим еще один вопрос вот здесь и потом уже у нас эфирное время здесь закончится спасибо за доклад сергей индекс man где есть константа которая имитирует количества голосующих членов реплика сети и это константа равна 7 почему это константа почему-то не параметра какой-то в конкордию какая-то константа которая количества голосующих членов членов replicas оттуда в чем она равна 7 да нет на самом деле там чего угодно у нас и реплика сайта бывают по 40 нодов и там всегда majority я не знаю какая версия под не в репликах эти можно не голосующий не вижу да но голосующих может быть максимум 7 и как в этом случае переживать выключение например если у нас реплика свет растянут на 3 дата центра один дата-центр может запросто выключится и еще одна машинка выпуск это уже немножечко за пределами доклады это общий вопрос по манге my может потом мы можем да спасибо еще раз михаилу давайте мы поблагодарим за доклад симон"
}