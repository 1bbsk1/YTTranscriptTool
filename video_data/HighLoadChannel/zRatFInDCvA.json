{
  "video_id": "zRatFInDCvA",
  "channel": "HighLoadChannel",
  "title": "Щи, или Распознавание 330 млн лиц на скорости 1000 фото в сек / Александр Тоболь (Одноклассники)",
  "views": 9813,
  "duration": 3004,
  "published": "2018-11-20T12:16:02-08:00",
  "text": "разговариваем и сегодня про то как распознать пользователей на фотографиях заливаем их соц сеть собственно варя как выглядит задача пользователь заливает фотографию juke вжух вжух и на выходе у него все его друзья подписаны и он доволен кто из вас знает как решить эту задачу поднимите руки ну в общем немного пользу людей знает как это решать отлично концу докладываю все узнаете как это делается я на самом деле с распознаванием лиц встретился еще в далеком 2005 тогда пользователь datasette с лицами на которых мы тренировали модели выглядели вот так они были черно-белыми люди смотрели в кадр это больше было похоже на фото на паспорт вот тогда я использовал скрытые марковские модели для распознавания они работали невыносимо долго там порядка 1 секунды на моем телефоне на одно лицо вот точность давали 95 процентов и это было очень круто сейчас у нас 2018 год мир нейросетей цепью и собственно говоря распознаванием лиц уже никого не удивить вот но если конечно у вас не такая специфическая задача как социальная сеть в которой пользователи делают все что угодно только не смотрят в кадр многие фото мутные с какими-то эмоциями гримасами вот при этом у вас 330 миллионов пользовательская база и к вам в день заливается более 20 миллионов фотографий и вы хотите по решать эту задачу не завалив дата-центр новым количеством огром огромным количеством нового железа вот еще теперь немножко про вжух вжух вжух вжух подразумевает что мы должны справляться с нагрузками в 1500 фото в секунду в пике и хотим чтобы наша система выдавала ответ на загруженную фотографию меньше чем за 200 миллисекунд для чего это нужно вы фотографируетесь и моментально после загрузки фотографий синхронно получаете всех своих друзей на этой фото и дальше уже их подтверждаете эти пины удаляете с этой задачей мы тоже будем бороться неверно тем кто знает что такое нейросети как решать задачу будет хотя бы интересно узнать как уложиться в 200 миллисекунд при такой нагрузке ну собственно варят что у нас сегодня будет в докладе вы узнаете как распознавать лица как это делать быстро с высоким роботом и я расскажу что нужно скачать где это нужно оптимизировать когда это нужно да обучить в докладе не будет обзоров топологии нейросетей какого-то матанализа но будут встречаться такие вещи как cnn свёрточная нейросети косинус на я мера но все эти определения мы будем вводить по мере нашего доклада и так собственно говоря главный pipeline распознавания фотографии загруженный соцсеть фотография заливается с десктопа или телефоном она попадает в детектор задача детектора найти лица и вырезать их они попадают некоторые викторе затар тот как раз от сопоставляет каждому пользователю щи то есть вектор вектор размерности у нас это 128 дальше этот вектор попадает на некоторую систему поиска которая сравнивает пользователя по basin и подписывает и на выход вы получаете за 0 2 секунды отмечен фотографию с отмеченными друзьями отлично а кто из вас тренировал нейросеть ну не так много людей для тех кто не знает что такое нейросети их не тренировал сделаю очень небольшой экскурс у предположим нам нужно нейросеть которая по вашим подпискам в соцсетях будет предсказывать придете вы на конференцию рид + + или нет собственно говоря о ваши подписки можно представить вот таким бинарным вектором подписан не подписан это у нас данные идут на входной слот нейросети там есть какие-то появляются скрытые слои скрытые слои наделены какими-то функциями которые там суммируют значение что-то делают и попадает на выходной активационный слой тут у нас он состоит из одного нейрона на вход к нему приходят значение с предыдущего слоя он их суммирует некоторые там суматра есть и функция активации очень простая пороговая собственно говоря если вы набрали определенное количество баллов вы придете на рид если нет то нет но тут видно что там не знаю подписка некоторые паблике могут скорее негативно на вас сказываться вот если вы подписаны там на highload еще на что то вы придете вот как таки нейросети учатся есть различные алгоритмы у которых задача того что как это вообще происходит берем всех пользователей кто был в прошлом году на рид и смотрим на что они подписаны и берем тех кто не был и заставляем нейросеть работать так чтобы оно давало максимальный отклик на пользу ли кто пришел и на тех кто не пришел вот разными алгоритмами вроде там обратного распространения ошибки или еще чего то мы выучим нашу нейросети вот но сегодня мы будем разговаривать с вами про фотографии и собственно говоря как работать фотографии фотография это не вектор и собственно для этого служит свёрточная нейросети максимально просто свёрточная нейросеть состоит из этапов can value шин полинг то есть свертки некоторые фильтрации эти этапы постоянно повторяются вот давайте посмотрим как двумерное изображение трансформируется выходной вектор предположим мы будем искать лицо на этой фотографии это вот такая бинарная фотография если включить воображение то вы наверное увидеть на ней глаза и рот вот соответственно у нас есть некоторое ядро свертки это первое это первый этап свёрточная сеть и мы этой свёртка и сканируем наше входное изображение и отклик на эту свёртку записываем в некоторую чем а вот первый элемент реакция на свертки у нас просто как произведение чисел матрицы их сумма вот такой поп и собственно варя ничего не реагирует во второй тоже не реагирует не интересно в третье есть какая-то минимальная реакция видно так пробегаем по всей матрице ну и на глаз именно это ядро будет реагировать максимальная с максимальным откликом заполняем всю матрицу увидим что у нас максимально отвлеки здесь таких я деру нас много их понятно это в примере здесь там два вот второй для рта приведен в реальной жизни там десятки и следующий уровень куда попадает это на уровень буллинга его задача он сворачивает размерность работ обычно это выглядит как мы берем два на два квадрата выбираем из него максимальное значение записываем размерность падает два раза все просто вот наша входная матрица вот мы применили два ядра потом свернули размерность стало меньше слоев стало больше так продолжаем продолжаем вот собственно пример отверточные нейросети как раз к январю шин pulling которая сворачивает изображение вектор здесь видно в общем отлично фухх вернемся к нашему pipeline у минимум теории у нас уже появился и так разговариваем сейчас за детектор фотография загружается задача найти лица выделить прямоугольники с этими лицами отлично на вход входят пользовательские фотографии там jpeg png что пальцы залил наша задача вырезать выровнять помним фрукт 1500 фото в секунду к нам заливают и мы хотим укладываться основная наша задача это делать быстрее чем за 200 миллисекунд всех же пью скупили майнеры и сбербанк на тот момент вот большого количества мы не располагали зато у нас было много старенького железо и мы решили использовать именно сепию ну собственно варя как решать такую задачу идем в интернет смотрим там самый популярный детектор виола джонса он есть в upon севи прикручиваем смотрим что у него довольно низкая точность есть более сложные детекторы на рсн но они требуют же пью работают долго но зато с высокой точностью и есть решение состоящий из каскадов и мать и cnn и вот мы смотрим и вроде у него точности отличная и время нас inference она sepia вполне устраивает вот по этой ссылочке вы ее можете скачать все здорово запускаем вот на таких фотографиях она работает у нас там больше двух секунд приходится разобраться как она работает открываем статью по которой написан этот детектор смотрим принцип его работы он идет окном сканирует фотографию это окно подается на вход вот такой свёрточная нейросети и на выход мы подключаем отклик виде того насколько он уверен что в этой области есть лицо то есть мы получаем в регионы уверенность так как лица на фотографиях разного размера то входные данные resizer то есть пирамида изображений берется оригинальный размер и он сжимается сжимается и сжимается для того чтобы мы лица всех размеров могли находить фактор пирамидки там 07 каждый раз там на 30 процентов меньше дальше эта вся штука немножко усложнено и там используется три нейросети 1 нейросеть работает очень быстро но у нее высоких фолз позитив высокая вероятность ошибки вот видно на первой картинке левый верхний угол как отрабатывает 1 нейросеть она выдает очень много кандидатов дальше количество кандидатов сжимается и передается на следующий уровень следующий уровень работает дольше но соответственно на вход у него уже идут только вот эти вот области на которые указала предыдущая сеть и собственно говоря таким образом вот через каскад из трех сетей мы находим лицо между каждым уровнем видно что он находит очень много прямоугольников и используется но он макса прошина алгоритм для того чтобы их сделать чуть поменьше идея такая что мы берем прямоугольники с максимальным откликом нейросети и оставляем их а все прямоугольники которые с меньшим откликом перекрываются с ними на какой-то константу на примерно 80 процентов там площади вот мы их выкидываем ну кажется что здесь можно сделать лучше а можно если взять блок детекторы залпом севи можно построить вот такой heat map и подать ее на вход сейчас расскажу как со всем этим поступить блок детектора такая штука которая на сером изображение вам ищет наибольшее из губки и выдает центр вот на вход этому блок детектора мы подаем уверенность нейросети в том что есть лицом и находим такие центры лица и потом эти цены на эти центр элит ставим наши прямоугольники которые будем отдавать нейросети здорово эта вся штука нам позволило сделать на 60 процентов меньше прямоугольников но за ускорились мы процентов на 15 потому что сам блок детектор у нас занимает какое-то время что мы ещё можем улучшить предположим с первой нейросети у нас приходит какой-то прямоугольник и мы еще в нем лицо нейросеть кроме того есть там лицо или нет она дает уверенность и предположение о том где она находится вот что можем с этим сделать вот это второй этап нейросети с 1 нейросети пришел такой прямоугольник мы поняли что здесь есть лицо но недостаточное под порог то есть по порогу это не проходит на лицо но очень близко тогда мы смещаем наш прямоугольник в эту область и говорим о кей да и попробуем еще раз но вот здесь это нам позволяет сделать повысить точность этого детектора вот он более устойчив к выбору вот этим входных прямоугольника встал и за счет этого мы смогли уменьшить фактор входной пирамиды то есть уменьшать июне на 30 процентов а прям в два раза вот таким образом ускорились ещё на 20 процентов и при этом даже немножко прибавили в точности собственно и того ускорение там на 1 4 раза среднее время от 70 до 100 40 миллисекунд зависимости от процессора и худший случай стал укладываться в 250 миллисекунд фух отлично все это запустили на 30 серверах они справляются с нагрузкой 1500 фото в секунду получается 25 фото секунду на 1 и дров среднее время 140 миллисекунд вот на картиночке нагрузка на этот процессор то у нас какие-то mdm тираны нам об терон и нам нашли вот и среднее количество лиц на одной фотографии заливаем ее социальную сеть 1 и 3 лица фух смотрим наши pipeline следующий этап у нас это тот самый викторе затар который каждому входному иисусу поставляют чин отлично кто из вас знает что такое косинус на я мера так немного хорошо не будем сильно вдаваться в подробности у нас есть два вектора и мы вводим на них некоторую косинус иную меру ее можно посчитать как скалярное произведение векторов на норму но если у нас селектора в вк ледовом пространственно армированные на и длиной единица то это очень простая мера то есть принципе не вдаваясь него что можно сказать что ее можно посчитать для там 128 вектор размерности с 28 можно посчитать за 128 умножение 127 сложений вот соответственно если два вектора одинаковая на единица если они ортогонально на 0 итак задача задача сопоставить каждому лицу щи лица на фото 1 и 3 140 миллисекунд мы уже потратили на предыдущей стадии осталось 60 миллисекунд нагрузка 2000 фото в секунду накопленные ну и соответственно хотим уложиться вот уложились в 6 же пью как мы это решали ну как я говорил да лицо сопоставляем какой-то вектор на расположенный на сфере идем скачиваем как обычно ссылочка откуда скачали иначе скачать можно много чего можно скачать space метод google можно de pays от facebook они все учились на миллион на миллион их базе размеченных базах таких баз у вас нет поэтому начинает что-то учить с нуля это плохая идея вот смотрим как они работают есть datasette либо тв сны wild он довольно старый у многих у них точность довольно высокая ну вот на более сложных дата сетах от ютюба и от одноклассников точность вес нетто уже пониже ну вот я недоволен точность в 94 процента что такое a currency 94 если понять такой точность ну кто в терминологии тпф по ориентируются тому хорошо кто нет про скажу просто у нас есть алгоритм который сравнивает лица как определить его точность мы разбиваем людей на пары пары когда у нас фотография одного человека и пара разных людей обычно их примерно одинаковое количество про гоняемся на нем мы говорим скольки случаях мы правильно угадали что это люди одинаковые и что это люди разные вот такая точность например 94 процента она мало о чем говорит то есть вы можете в трех процентов случаях не находить правильного человека что не страшно и в 3 процента случаев ошибаться это плохая мера поэтому добавил некоторую еще меру как полнота и lyrical она выглядит как отношении всех найденных к случаев одинаковости людей ко всем случаям которые в вашем тестом дата сети были одинаковые то есть мы взяли все положительные случае посмотрели сколько мы нашли и поделили ну например точность девяносто семь процентов говорят что вы в трех процентов случаев не угадали вот и понятно что он никак не фиксирует у нас фолз позитив то есть ложные срабатывания поэтому обычно используется такая мера как recall при фиксированном фолз позитив то есть мы говорим что мы хотим фиксировать фолз позитив например мы фиксировали на одной тысячной то есть на одну из 1000 фотографий мы можем позволить себе ошибаться и смотрим на какую максимальную полноту мы сможем себе позволить вот на нашем дата с этим оригинальный вас нет давал полноту там порядка 47 процентов при фиксированном fpv одну тысячную собственно почему так плохо дело том что по весне скорее всего тренировали вот на таких фотографиях которые можно там по краю лить гуглом еще что то они у них красивые четкие а что у нас у нас много фотографий детей друга и этническое распределение людей да еще и очень часто фотографии в общении людей что делать на самом деле datasette а у нас готового нет у нас есть правда миллиарды фотографии залитые пользователями вот ну и хороший нейросети мы для решения нашей задачи найти не можем пробуем по хотите берем вас нету берем наших наших миллиарда фотографий выбираем оттуда каких-то пользователями и прогоняем при этом аккуратненько класс there'sa им без к нам смотрим чтобы фэйс нет хорошо их класс there'sa вал людей и дальше это datasette на нем в баньку ним нашу сетку файз натовскую и с этой уже сеткой строим новый datasette на фотографиях которые у нас есть вот так мы циклически повторяем обучаем нейросеть варить 35 раз до готовности в итоге мы говорили 37 миллионов лиц на 77 тысяч аккаунтов вот что еще при обучении россетти важно есть такая штука как функция потерь вы легко найдете обзоры там по софту макс триплет loss так далее какая у него задача мы эту функцию минимизируем при обучении нейросети а должна выглядеть так чтобы заставить работать нейросеть так как мы будем ее использовать дальше в продакшене то есть если нейросети выдает виктора ноосфере то наша задача чтобы она выдавала для одного пользу вектора максимально близко лежащими но при этом кластера разных пользователя на разносила максимально далеко ну что придумаем свою лосс фанкшн вот ласло спонсон который мы будем минимизировать у нас есть тем базинг лица и это x и некоторые пользователи с индексом t мы хотим чтобы этот embedding максимально близко был расположен к центроида лица но центроид лица этот центр масс кластера этого пользователя то есть для этого польза вас есть другие фотографии там есть центроид мы хотим чтобы эта фотография лежала максимально близко соответственно мы как раз считаем косинус ну меру вычитаем у из некоторые константы она у нас обычно единица вот и добавляем квадратичную функцию чтобы нейросеть старалась максимально сжиматель кластером вокруг центроида и что мы еще хотим хотим чтоб она это других всех растащило вот для этого мы считаем сумму расстояний до всех остальных центроидом но нет ни сумма расстояния которую функцию которая выглядит как косинус этого входного вектора x до до центра масс другого кластер а вот и мы хотим чтобы он за близкая за близость к ней штрафовал вот тут у нас коэффициент получился порядка 055 для размерности 128 если размерность делать меньше коэффициент будет другой вот его надо подбирать отлично за использовали эту функцию потерь стоило ли так упарываться собственно ответ да стоило вот вас нет до обучения и после того как мы его по обучали видно что полнота при фиксированном фолз позитив у нас 040 выросла почти в два раза для еще про верочке мы проверяли на fv оригинальный файл который мы скачали он давал точность девяносто девять и три нефа после нашего обучения мы эту сетку главу до девяноста девяти семь дотащили буквально месяц назад google выпустил обновление во сне то она сейчас 99 65 но все равно наша сеточка чуть чуть получше же работы чем вас нет время работы наши нейросети 2 с планом 3 миллисекунда на джипе и что еще можно делать при построении data set of если у вас мало данных данные можно аргументировать то есть если у вас мало фоточек или там люди очень часто снимаются вертикально вы хотите уметь распознавать повернуты изображения то можно просто входные фоточки повертеть немножко и научить таким образом нейросеть поворотом вот отражением resizer мы еще пробовали фотошопить шляпы очки все остальное чтобы лучше чтоб иметь таких примеров больше в нашем дата сети но нам это не дало какого-либо серьезного успеха кухню в итоге что мы сделали мы запустили вот этот наш обычный викторе затар на джипе ум используемый всего шесть же пью 1080 они справляются с две тысячи лиц на в секунду то есть 33 лица в секунду на одну джеппе юшку совсем а верх этом на ремонтные вызовы все все все мы укладываемся в 20 миллисекунд это график загрузки cuda-ядер используем мы тендер флот и как я понял он не умеет пролить операцию запись записи и вычисления на карте вот поэтому у нас не получилась утилизировать на сто процентов куда ядра но мы не стали с этим заморачиваться мы это умеем делать на кафе вот но ради 3к еще джикию карт решили не ничего не почти не улучшать вот еще интересный кейс помним тот фейс детектор которая вам так классно рекламировал такой быстрый затененный но у него есть одна проблема детектора немцы cnn страдают фолз позитив и он довольно высокий там почти к двум процентам подбирается ну на самом деле вот примеры лиц надо еще разобраться где лицо где животное где не лицом вот и на самом деле пытаться улучшить тот детектор который есть по одной довольно трудно зато все за детективные лица они попадают на викторе за то что мы видим в викторе затари на самом деле вот такие классы как животные статуи лица из мультиков они всех тоже кластеризации в одном месте соответственно мы где-то порядка 30 таких кластеров описали вектором и небольшим радиусом вокруг него и соответственно мы их просто не распознаем считаем не лицами их еще можно хорошо плоскостью отсекать кто знает детские лица мы решили детей не распознавать с момента что мы с этим может быть и можем хорошо справится но чтобы не дай бог ничего не напутать все-таки дети мы их тоже таким же образом исключили мы тоже нашли область где у нас есть дети тоже и и отрезали и них не отмечаем отлично значит мы за дтп или лица сопоставили каждому лицу некоторый вектор теперь надо поискать так как мы будем искать искать нам придется 2000 фото в секунду осталось у нас на все про все не так много времени порядка 40 миллисекунд вот и хотим мы это сделать вот ну на усно 12-ю получилось какая проблема поиска викторов по базе в 330 миллионов на самом деле так такой классический треугольник типа выбери 2 хорошо не получится это либо вам нужно очень много железа либо вы начинаете сделать это слишком долго либо начинаете терять полноту то есть recall за который мы так боролись там 98 процентов 90 есть он начинает снижаться интересное вот решение брутфорсом на самом деле если взять все вектора пользователи загрузить их в карту то можно заодно умножение матриц и там на вектор получить все расстояния и собственно говоря was brought forth там за один такт цепью назовём это так ответить на вопрос кто из них ближайший это очень просто мы посмотрели 2 миллиона пользователей влезают на одну копию но у нас их порядка трехста просьбу купить 150 карт и при этом при масштабировании при добавлении новых пользователей соцсеть постоянно масштабировать и количество карт вот но работает очень быстро и recall стопроцентной еще можно было бы нарисовать нейросеть заставить ее выдавать некоторый бинарный вектор и искать по прямому совпадения ну наверное найти по прямому совпадению в яндексе очень легко объем индекса будет небольшой вот но мы потеряем в полноте и мы тут сражались тоже за проценты вы представляете вы допустим recall станет 90 процентов начать что мы ваших друзей на фото будем одного из десяти не узнавать ну просто потому что нас так by нарисовалась тоже плохое решение есть библиотека от facebook в по из которая позволяет вам за всех пространственных структур данных решить эту задачку нас немножко для нашего объема было большое время мы не укладывались в time limit и не хотели все-таки продолжать терять recall для ваших друзей друзей поэтому мы вот как взглянули на эту картину ну в среднем у пользователя 200 друзей ну пусть 500 но пусть 1000 если взять со средним количеством друзей то друзей друзей у вас еще 40 тысяч и есть еще порядка тысячи каких-то странных людей с которыми как-то взаимодействуете бываете может быть на одних фотографиях но они у вас них друзьях так как вот так косинус на я мера который мер используется как мера сходства в нашем решении считается очень быстро то перебрать порядка 100 тысяч человек для нас получилось уложиться там 80 кун вот поэтому просто по хотели перебрали друзей и друзей друзей возможных друзей запихали все викторов кэш порядка там 180 гигабайт у нас в одной машине такого каша туда 200 миллионов влезают пользователей но и hit rate у него порядка девяносто девяти процентов супер мы уложились 8 миллисекунд что мы отсюда узнали что на фотографиях в 47 процентов случаев находится автор 34 просто слушать друзья 14 друзья друзей которые достигаемую по графы еще пять процентов некоторых людей отлично собственного ряд финальные результаты на детектор мы потратили 100 40 миллисекунд его фрукт 1500 фото в секунду работает на 67 о викторе затар у нас работать 20 миллисекунд на 6g пью картах и справляется с двумя тысячи вещей в секунду из поиска за 8 миллисекунд позволяет перебрать там порядка 100 тысяч гектаров и и у него нагрузка там 180 миллионов умножений в секунду 12 пью очень простая косинус номеров быстро работает перед запуском было немножко ссыкатно все это запускать вот и мы в начале решили почистить еще на коллегах что мы сделали мы взяли для всех коллег построили профиль и прогнали их за их для всех фотографий заливаем их на портал то есть день у нас порядка 20 миллионов у то заливается мы их cessna всех них ищем лица прогоняем еще по коллегам и если срабатывали фолз позитив люди жаловались то что то не то мы аккуратно tune ли границы то есть одной границы мы ищем для друзей с другой для ввс 3 для третьих лиц и вот что мы интересного узнали из этого значит слева находится у вас фотография той самой бабушки на который мы проводили все эксперименты вот а справа есть фотография 1 фотография 2 это некоторые срабатывания на эту бабушку кто думает что бабушкой присутствует на фотографии1 поднимите руку отлично а кто думает что наша бабушка на которой мы все тестировали на фотографии 2 отлично кто думаю что на фотографиях 1 и 2 бабушки нет класс на самом деле наша бабушка это наш коллега который играет в театре он на фотографии 2 и нейросеть с некоторым порогом после тюнинга отлично справляются с этой задачей и профиль построенной по бабушки потом говорит что этот человек находится на этой фотографии класс это наш pipeline по распознаванию лиц мы их распознали нашли но не вас немножко обманул там еще была такая штука что для всех пользователей уже построены вектора поэтому нам надо еще в каждому пользователю социальной сети сопоставить вектор как мы это делаем мы проходимся по вашим фотографии в вашем профиле детектив лица потом их пластеризуется выбираем самый большой кластер и пишем все здорово но в социальных сетях данные у нас несколько странные у некоторых людей на аватарках звезды в некоторых семейные аккаунты у некоторых фотографий детей или жены в профиле больше чем их самих поэтому нам пришлось еще по решать эту задачу в общем подход выглядят так мы заходим в профиль находим все лица на фотографиях пластеризуется чем класс there'sa вать мы посмотрели на то как выглядят наши кластер а таки довольно причудливых форм понятно что мы изначально не знаем количество кластеров людей в вашем профиле поэтому алгоритмов не очень много чем можно пастеризовать это affinity про повешен меньше в деби скан rebirth вот остановились на не бесконечен com нам показалось что он довольно простой и решает нашу задачу и так пластеризуется пользовательский профиль деби scan находим кластером вот размер кластера имеет значение конечно чем больше кластер тем больше вероятность что этот владелец профиля но бывают исключения поэтому мы дополнительно еще проверяем пол и возраст профиля с тем с полом и возрастом которые есть на фотографии конечно многие скажите что в социальной сети никто не указывает честно свой пол возраст вот есть ссылочка на видео там небольшой доклад на 15 минут как по вашему имени фамилии узнать вас ваш пол или по окончанием которые вы используете и как по возрасту ваших друзей кластеров ваших друзей узнать ваш настоящий возраст вот этим всем пользуемся верни мне большую модельку которая по тому какие фото находятся в кластере выдает какой-то вес этого кластера и выбираем самый большой кластер в итоге алгоритм трансформируется в такую штуку пробегаем берем там 100 фото у пользователя детектирует викторе зиру им дальше эти вектора пытаемся класс терези ровать с учетом пола возраста было ли это фото на аватарке отмечали ли пользователя на этой фото и если у нас не выделяется явного фаворита следить кластеров то мы повторяем этот процесс берем пальцы еще 100 фоток и так пока эти фото у него не кончатся или пока не определится фаворит для крайних случаев мы разрешили сохранять несколько векторов в профиль и если пользователь будет потом удалять эту отметку на фотографии что это не он мы этот вектор сотрем кажется все просто но как обычно у нас 300 миллионов пользователей 100 фото в аккаунте и если мы хотим в продакшен периодически выкатывать обновляющуюся модель то нам хотелось бы хотя бы за неделю перед тренировать все профили тут мы просто задавили железом мы конечно немножко потемнели детектор чтобы он работал быстрее для этой задачей не так точно вот но для того чтобы уложиться в неделю fruit нам надо было иметь 16 тысяч фотографий в секунду тут нам на помощь пришло наше облако и мы использовались облачной сепию который у нас там по ночам простаивают с джипе ушками ничего сильно по хочет не получилось пришлось на время в аренду взять 60 г б ю вот и собственно говоря не справляются с этой задачей на скорости 2000 фото в секунду две тысячи лиц секунду финальное решение выглядело вот так то есть у нас есть все время в продакшене работающий оператор который нам позволяет обновлять сеть по профилям и новую модель и есть некоторый набор детекторов для работы в реальном времени на котором пользы загружают чуть по другому затюнены это все попадают на результаты работы на викторе затар который абсолютно одинаковый вот и соответственно либо виктора профилей записываются в базу либо вектор ас фоток прогоняются по этой базе финальная тут мы для итерации завалились железом вот приведены цифры порядка тысячи там я тёр в облаке 60 же пью потребовалось собственно говоря сторож это у нас для этого мы используем кассандру и архип кэш из джавы мы юзаем для того чтобы хранить тот самый кэш векторов для быстрого поиска ура получилось теперь когда мой друг заливает фотографию со мной я моментально получаю уведомление что есть на фото а он может меня подтвердить или не подтверждать на этой фотографии и так надеюсь что теперь вы узнали как работает в жок жок жок и собственно говоря как распознать фотографии лица на фото мы познакомились с pipeline am когда фотография входит на вход crop ается викторе суэца ищется все счастливы собственно говоря с какой проблемой мы сталкивают проблему мы решали мы решали проблему того что у нас 300 миллионов пользователей больше 20 миллионов фото и мы очень хотели уложиться хотя бы в 200 миллисекунд и грязной аккаунты для этого всего нам пришлось скачать детекторы его по хачить всячески чтобы лица во время то есть если у вас к эта система не требовательна к финальному времени можно взять просто готовый вот детектором этот опробуем собственно говоря на 20 миллионов фото в день прекрасно работает нам пришлось побороться с тем что у нас не было datasette на у нас были очень специфические данные и нам удалось полноту повысить почти в два раза сеть мы взяли вот тут собственно говоря мы придумали свою ложь function который нам позволило хорошо обучиться мы пока чили задачу с тем чтобы не попадать на снижение полноты при поиске паре 30 30 3 100 миллионов пользователям вот мы собственно говоря этапы того как мы этого водили в продакшн мы обе скачивали смотрели где это долго работает оптимизировали если это не работает то до обучали не стоит пытаться там сразу хвататься говорит давайте сделаем свой datasette и попробуем потягаться с google иногда может быть стоит уже использовать те наработки которые есть и просто их до обучить или оптимизировать еще мы провели собственно говоря такую акцию с ночью музеев наши нейросети на рассказать не только лица но еще и лица на фотографиях распознаёт вот соответственно мы для наших пользователей залив ших во время акции ночь музеев в сэлфи с картинами выдавали vip статус и вот там несколько тысяч фотографий залили на это мероприятие вот так что она даже для этого подходит фух спасибо за внимание да сейчас наверно у нас будут вопросы и ответы давайте пока вы думаете над своими вопросами я вам скажу что вот там есть мой e-mail если у вас какие-то вопросы будут потом вы про них друг вспомните вам будет что то интересно напишите мне об этом я обязательно вам отвечу так же я знаю здесь дают какие-то подарки за лучший вопрос он один подарок второй будет подарок от одноклассников за лучший вопрос поэтому собственно говоря будет выбрано два лучших вопроса поэтому давайте задавайте вопросы чтобы перевести должен там же те же силы да ничего не стоит тот же самый тендер плохо запустить на джипе и у нас просто так получилось что момент запуска у нас не было огромного количества карточек как бы я как я и сказал собственно говоря их скупили майнеры сбербанк тогда вот на рынке не было и соответственно мы решили воспользоваться старым железом вот собственно варя мы так и планируем переиспользовать карты под то чтобы запустить там джипе детектор а когда выводили из своего станка ну вы обучали признает просто убираю у него последний слой или брали какой-то готовый архитектуру и рыбачка до обучали вас нету с близнецами мы глазами тоже и силами модераторов отсматривали то что на каждом шаге у нас обучает нейросеть и иногда братьев сестер похожих людей она иногда умудряется разводить абсолютно специально на близнецах мы не учились это я вот озвучил вопрос про близнецов давайте следующий спасибо за доклад очень интересно хотел спросить кажется довольно когда пользователь загружает проблем вот как раз одно из этих почему мы оценивали возраст профиле то есть обычно все-таки польза ли заливают сейчас уже свои текущие фотографии поэтому при построении вектора профили он учитывает возраст в профиле и при загрузке мачек именно свежие если вы зовете свои детские скорее всего он вас не узнает здравствуйте спасибо за доклад вопрос такой вот было приведено время обработки работы горизонталью 20 секунд это месяца в виду время работы алгоритма на самом же мейджи белье но я так не могу без времени передачи данных и джимми и обратно если да то как вот вы уменьшать влияние удино загрузки выгрузки данных две-три миллисекунды это именно время отработки уже там загруженных ну время отработки фотографий которая есть в памяти не растет загружено на карту вы ее подаете она вам находит все суммарное время которое я показал так сейчас еще буквально чуть-чуть задир head of вот совсем а вверх и дома на у нас получилось 20 миллисекунд это когда у вас ремонтный вызов на вход там gp конова распакует туда-сюда то получилось именно 20 миллисекунд 20 миллисекунд учитывать время работы сети распаковку g пега загрузку данных обработку выгрузку ответа и ответ это все время работы рпц а сама нейросети сама отрабатывает за две-три миллисекунды вопрос модели production ну вот один из примеров это как раз когда мы просто прогоняем коллег и смотрим на 20 миллионов фото в день сколько у вас фолз позитива вот чего-то более специального мы не делали то есть мы про гнались на своем дата сети получаем какие-то данные дальше раскатываем смотрим если все станет плохо прибегут коллеги с воплями а меня находит на каких-то странных фотографиях там до такой еще вопрос на переобучение моделей в fly нам делать или онлайн когда смысле как переобучить модель обучения но смысле вы миссию сделаем циклическое до обучение нашей сети как ее вывести production да в оффлайне конечно мы и обучаем от с не оцениваем метрики нашим дата сети принимаем решение что нужно обновить и дальше у вас получается задача в продакшене у вас есть старые виктора от пользователей вы для всех них и тренируйтесь и пишите но вы и через две недели поставку все-все-все обновили вы можете переключить ваш продакшена новая модель то почему мы хотели хотя бы в неделю укладываться чтобы выводить это впрок спасибо за доклад вопрос такой как вы обрабатываете неполные фотографии то есть либо бейсболку либо закрыта какой-нибудь muse и накладные очки темные как они проходят проверку ну в бочках она ищет то есть частично закрыты и лица тоже иногда ищет особые цели для того чтобы там бороться с полузакрытыми лицами там или отражать пол-лица до использовать там туже нейросеть чтобы достроить не хватающего изображением этого ничего не делаем вот можете попробовать но у с очками работы то есть понятно что в исходном дата с эти были такие фотографии в которых был сильный поворот головы и были очки и так далее она частично этому обучена раз подскажите я правильно ли понял что вы по фотографии тоже пытались определить возраст и пол если да то с помощью чего по-моему вы не сказали да у нас есть ней рассеять которая собственно говоря по фото выдает вам там три категории возраста грубо говоря о молодой средних лет старше и выдает вам пол у вас есть это смысле новой смысле она общедоступная то есть я ссылочку на память не скажу но если вы мне напишите обязательно вам пришлю где ее взять то есть что-то из упорство да а у вас улус функции есть два magic намбер а вы как их подбирали собственно говоря на глаз чтобы в результате на при проверке на dt сети она давала максимальная точность это полное переобучение или между эпохами меняли я думаю что полная еще может быть есть вопросы все нету больше желающих небольшое продолжение по поводу этих магических цифр почему бы не загнать их тоже в модель и над x на тех самых теста вот эта сеток которые вы гоняете на своих сотрудниках не сделать даже самый и подобрать их вы про вот эти коэффициенты да да эти коэффициенты отлично можно в оффлайне подобрать надо то сети на пользователях это надо схеме коллегах это скорее такая валидация уже общая для того что вы не сделали что-то неправильно когда вы на весь пруд выкатывайтесь рассказали о том что вы их вручную подбираете там как то так на глазок это не на глазок вы же прикажет следующей операции оценивайте насколько хорошо у вас выросла точность надо то сети соответственно если оно у вас выросли до 100 просто можете подобрать этот радиус так чтобы точность у вас на каждом шаге улучшалась на каждом шаге обучения улучшалась все больше больше и больше то есть в итоге это все таки цифры которые были подобраны алгоритм ну да можно сказать так спасибо спасибо за доклад такой вопрос было ли какая-то проблема распознавания лиц европейского типа лица допустим или афро-американцев да вот как раз изначально у нас был немножко другой этнический состав людей от того на чем учили вас нет и это как раз то почему нам пришлось учить на своем дата сети то есть именно она хорошо решает нашу задачу если у вас есть задача там запустить ее для другой социальной сети с другим этническим составом тост конечно надо и по обучать еще зимой еще может быть есть вопросы но тогда все всем вам спасибо может быть тогда перейдем к понравившимся вам вопросом но у мужчин а в первом ряду он прям сделал все чтобы выиграть да да конечно а что вы с ним делаете мы моему клеем специальные наклеечки и в конце конференции 29 мая эти наклейки можно будет обменять на призы ага отлично тогда ему еще уходит вот тот пакет от одноклассников там есть очки футболка толстовка еще что то давайте скажем спасибо за хорошие вопросы"
}