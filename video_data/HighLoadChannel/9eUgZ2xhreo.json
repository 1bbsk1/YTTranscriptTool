{
  "video_id": "9eUgZ2xhreo",
  "channel": "HighLoadChannel",
  "title": "О тестировании JS API Яндекс.Карт / Денис Хананеин (Яндекс)",
  "views": 129,
  "duration": 2062,
  "published": "2017-04-05T14:21:41-07:00",
  "text": "здравствуйте меня зовут и из honey i'm я разрабатываю интерфейсы api карт компании яндекс собственно работаю разработчиком интерфейсов пишу java-script практически все свое рабочее время примерно 110 его процентов и сегодня я чуть-чуть расскажу про тестирования джесс эпикард как мы пишем ей тесты с чего мы начинали наш длинной-длинной большой пути к чему мы пришли в конце концов а также поделюсь с вами наши болью проблемами через что мы прошли и как на наши проблемы решали ужасно для начала что такое тестирование для чего она вообще нужна я буду говорить больше в целом a unit тестах потому что ей тесты ближе всего к разработчикам это первый этап когда человек сам пишет разработчик тесты смотрят все ли у него работает что он написал и как она работает и поднимите пожалуйста руки кто пишите in test о крутяк а поднимите руку к вас заставляют на работе писатель тесты кто это делает там потому что это workflow рабочий ухты получается мы все держимся на энтузиазме это очень круто сколько я ни говорил с ребятами с коллегами готовясь к докладу все сходятся во мнении примерно к одному и тому же unit тесты дают вам какую-то степень уверенности что код работает что то что вы написали она запускается и отрабатывать ровно так как вы этого хотели зависимости конечно того сколько все покрыто in тесты кроме того если вы что-то переписывали рефакторинг либо делали еще что либо вы понимаете что та часть системы который вы не трогали она не сломалась и это очень важно если у вас более менее большой проект если вы заботитесь его будущем и не хотите его каждый раз полностью тестировать отправлять его какому а тестировщику или команде тестировщик на полное тестирование ну и собственно как мы будем говорить про джесса пикард про тестирование собственно что такое вообще жертва пикард эта штука написанная на java скрипте очень большая штука которая позволяет встраивать на ваш сайт карта карты большие маленькие все делать всякие штуки с ним том числе дам интерактивные многое другое все это было 2008 году первая публичная версия очень-очень давно все это выглядит сейчас примерно так что у нас есть карта меточки балуны это выпадающие штуки много-много разных control of и с этой карты можно делать все что угодно все это работает на java скрипте и собственно про историю отчего мы шли к чему пришли через что прошли история большая 2008 год первая публичная версия и собственно сначала мы не писали тест 2008 году тестов не было для пи проект был не такой большой карты работали и время было такое смутное на самом деле 2008 год но в какой-то момент не писатель не писали тесты тесты писать пришлось это было не совсем свое желание произошло это в один из моментов когда мы выкатили версию екак ты там не очень до конца протестировали и api сломалась сломалась очень нехороших в местах вроде там валуна или метки или что-то случилось с картой в общем это происходило пару раз в разные моменты времени и стало понятно что без тестов жить уже не как и сначала мы начали смотреть что же мы будем использовать в качестве там фреймворка для тестирования выбрали какой-то нонейм фреймворк на гитхабе в котором там не было звездочек практически была пара коммитов финишного кометном так далее очень запустили станем поняли что были так жить тоже нельзя вообще не вариант это 2008 год может быть 2009 уже переходящий и на тот момент выбрали я хуею она была как космолет в нем было все это библиотека который сегодня уже умерла но мы тогда сели на хвост на первую версию потихоньку переходили на я хуею второй версии 3 использовали его для тестирования вот ну и тесты находились в стимул файликах api уже тогда была модульным и они собственно копировались в каждом тесте была такая штука то есть сам тест тут на файловой структуре один модуль сам модуль map and и рядом с ним файлик с тестами в котором там описано такие вот штуки для начала первое это подключение окружении так это каждый тестовый файл html в нем нужно было подключить во-первых api во вторых тестовое окружении от этого окружения подключалась относительным путем потому что мы разрабатываем ся на разных машинках локальных не локальных разработчики hda серверах причем кто как вот самые трабла это были точечки если модуль лежал как где-то очень низко файловой структуре приходилось править точечки это выносила мозг потому что с третьего раза попадаете в нужное количество чтобы выйти там на тот уровень от балды их конечно писать было очень неудобно и все это используется копировать вставить край точек сами тесты выглядели тоже не очень удобно потому что они передавались ну там было обертка в обертку нужно было передать хэш имя хаша и это имя теста внутри тестом и там что не делаем пишем assert какой-либо и днем по сути неудобно несколько вещей первое это само название теста йаху говорит что тесты нужно писать так имя тесто должно начинаться с префикса теста дальше вы там что-то там пишете его название не было 2 второй вариант аннотации он выглядел как стандартный формат пдд этом edge утрата то но они говорили что так писать тесты нормально но мы так и писали и никому этого не очень понравилось конечно я не помню почему это прижилось и разрослось и собственно 2 это сердце сердце были бесчеловечными их не было души они не жили не дышали не общались нами выглядит как бездушный там набор логический штук в случае чего выдавался error читайте было реально сложная и для 2008 года совсем нетипичную штука асинхронность аякса уже тогда был конечно давно уже сильно использовался но вопи он был такси не очень-то нужен всю эта штука асинхронная появилась немножечко позже тестировать тогда синхронные интерфейсы было дико неудобно потому что внутри вот это вот с кейсом нужно было написать там за свет поставить какой-то таймер какой-то обработчик навесить случае ошибки и дальше внутрях мы там писали что когда нужно продолжить тестовый кейс когда не нужно и все это накладываясь друг на друга в общем был полнейший от тесты не нравилось писать аще и никому но нужно было нас заставляли писать тесты мы сами понимали необходимость сами пишем тесты это входит в стандартную рабочего рту и тогда же мы задумали переезд переезду проходил в несколько этапов это было начало 2014 года мы все вышли из отпусков после зимних праздников к слову еще через полгода я хуя его еще умер они его закрыли сказали что больше не поддерживается поэтому мы вовремя даже задумали так переезд начинался с того что нам нужно сформулировать было вообще что мы хотим куда мы хотим двигаться к чему прийти мы посмотрели вокруг карт что там творится тогда же писалось новая бета который уже сейчас выключенную на всех продакшн и тогда же разрабатывались новые народные карты которую может кто-то из вас видел собственно посмотрели что у них есть и сформулирую себя что мы хотим вот современной технологии хотим моку хотим se non stop писать всякие стопы и хотим какой-то более человеческие а сердце мы хотели шут чай там или что-нибудь подобное но выбрали expect потому что у нас еще есть и 8 а когда мы от него откажемся мы не знаем и еще достаточно много пользователей сидит на нем хотелось дико выпилить копипаст это всего печку с точечками когда их много много нужно оставить и хотели запускать тесты в браузере это наверное aif.ru запускали всегда их в браузере хотели запускать в терминале собственно у нас с этим требованиям связано очень теплые воспоминания потому что у нас была большая такая отмазка какая присущи программ местом у которых код компилируется у которых компилируется много кода либо дизайнерам которые собирают 3d модель у них было сюда отмазка почему там пьешь кофе у меня компилируются он почему-то пьешь кофе у меня там в рендерится вот у нас была похожая почему там пьешь кофе там ходишь общаешься с коллегами у нас тестов прогоняются тесты про гонялись 6 минут потому что их было очень много и и они все отрабатывали в браузере а порой приходилось их запускать и ни в одном браузере то есть стандартный во всем зоопарке разных и так кроме того 2014 год уже всего пара про миссию во весь рост асинхронный интерфейс и мы хотим их тестировать удобно масштабы проблемы были большими за эти годы мы накопили огромный багаж сундук тестов старых неудобных порядка 220 файл вот кроме того у нас были уже к тому времени довольно много модулей вопи это порядка тысячи ну самого пену само по себе очень огромные кучи наследование мам мел мелких модули кучи того что мы даем пользователям что внутренняя держится и у нас было семь человек в команде которые делают api и всем было чем заняться мы выходили из бета у нас была работа нам нужно было как можно скорее дописать продукт выкатить его в продакшен сломать обратную совместимость там где мы ее можем сломать потому что потом нельзя будет потому что мы там поддерживаем фигова туча версии в которых мы не имеем права ломать обратную совместимость а можем только переписывать внутренность мажорная версия это один из маленьких моментов когда это можно сделать в общем нам нужна была стратегия у нас это была стратегия как мы переедем на новые тесты вступим там в новый светлый мир с единорогами радуга и и не знаю там ванильными реками вот у вас это может быть стратегии которые рекламируют как внедрять и пить и как внедрять ваш продукт тесты а если его старые продукту наверно вы столкнётесь с той же проблемой что вас были старые тесты и вы хотите как-то перейти на новые запилить новую продукту итак вариант первый вы садитесь переписывайтесь переписывайте тесты всей командой это в какой-то мере долго потому что не все и не всегда знаю там последний современные технологии от выбирают как правило самые последние ну вот и команда получается пишу только тесты и это дороговато потому что это займёт всего с уже много теста накопилось или есть у вас проект большое какое-то время мы себе этого позволить не могли но как бы из плюсов это что вся команда в один момент разбирается как писать тесты и потом как бы не возникает вопросов вообще если проект не очень большой если тестов там не так много например было или собираетесь писать то это лучше наверно вариант съесть и перепились все тесты вот вариант второй это логичный вариант найти крайнего если у вас есть в команде человек который вам не очень нравится или который напакостил или вообще который просто не очень хороший работает вы можете посадить его в темный угол сказать им вася вот тебе компьютер сегодняшнего дня ты пишешь тест все подарить ему танкует рок не знаю какой сувенир пускаешься все на самом деле это один из вариантов он тоже неплохой если у вас небольшой проект то есть какой-то стажёру или практикант который хочет с ним познакомиться влиться в него это очень здорово потому что юнит-тесты то лучше документация кода как говорят многие вот ну и команда работает есть ответственны за эти тесты ну вот ну конечно может быть там и негативные последствия вроде eyvaz я тут штуку запилил запилим не тест вот ну я надеюсь все сознательные люди взрослые так не буду делать третий вариант демократичны долги вариант упорные вы садитесь делайте продукт и фоновом режиме пишете тест и аккуратно медленно идете к светлому будущему кто сам к тому самому с единорогами но из минусов это у вас в проекте какой-то момент если вы переписываете живут две версии тестов если вы просто пишете тест с нуля то у вас проект медленно покрывается тестами ну как вариант тоже неплохой ну кроме того если у вас какая-то более меня большая команда и которую не очень знает эти технологии там фреймворк а сердца и так далее которые будут использоваться в тестах есть время хорошо так основательно подготовиться прочитать все это познакомиться посмотреть примеры ну мы конечно выбрали демократичный вариант у нас был выход из бета нам некогда было все команды там терять неделю при нашем объеме тестов по краю все тесты сосна демократии не бывает без правил везде нужны какие-то правила которые позволят наиболее качественно и быстро переехать к новым технологиям нас это была следующая это первое если ты правишь какой-то код редактируешь модуль будь добр как бы перепиши и тест старые удален если у вас всё это можно также только там старый модуль удалять не нужно второе если ты пишешь новый год новый модуль ты покрываешь его местами согласно там стандартный покрываешь api основные из кейсы и смотрят чтобы он проходил работу ну и конечно если такие ситуации если у вас переезд если что-то подобное нашу ситуацию то в случае рефакторинга сломался там чуть чуть поменяли интерфейс придется переписывать кучу тестов в этом случае допускается просто поправит а мать 12 тест как старые тесты поправить чуть-чуть который использует интерфейс чтобы не переписывать нам их кучу-кучу-кучу таким образом в проекте живут две версии тестов но постепенно количество от них уменьшается количество других увеличивается и тем самым достигается критика дан достигается критическая масса новых тестов старые можно просто выпиливать быстрый переписать либо одному человеку лига либо командой вот напомню как расскажу как у нас выглядит самим тесты каждый unit-тест у нас это отдельный модуль у него есть имя модуля ей зависимости зависимость который не посредством тестируют и дополнительные которые нужны там для проверок что все действительно так ну собственно стандартные там модульные системы они все похуй все попробуй нас используются модульная система нашего коллеги дима филатова называется vm или лай модус и собственно все api также стоит на ней если кому будет интересно я потом дам ссылки вот сам тест ничего такого вверх и до в нем нет то это обычно я мог а в нем там есть какой-то диск райп в нем мы описываем какой модуль мы тестируем и собственно дальше формате там бдд мы описываем что там должно произойти вот кроме того важная штука что наконец-то мы начали удобно тестировать асинхронность и и современные технологии современной фреймворке позволяют очень удобно работать как с кроме сами так из xhr запросами и многим другим в данном случае там достаточно просто вызвать аргумент дан который является по сути функцию вот и к чему пришли у нас сейчас не так много тестов как было раньше тут порядка 130 файлов но api в этих файлах намного лучше покрыта тесты месси раньше писалось среднем два три кейса каких-то там основных пользовательских сейчас людям понравились в команде писать тесты они вошли в раж и фига что там по 50 тест кейсов по 30 на каждый модуль чтобы наиболее полно его протестировать вот и все ключевое протестирована что не процитировано она не ломалась по сути или у нас не дошли руки но по сути если бы что-то сломалось мы бы сразу покрыли это uni тестами потому что у нас вот такую careful ну и без теста сейчас мы не можем выкатить проект production потому что и как только только что-то сломалось сборка падает говорит что нет я никуда не полезу исправляй меня и потом все будет хорошо и вроде бы все готово вот оно светлое будущее максимум пришли но была еще одна большая проблема во время этого переезда анон дон длился долго несколько месяцев мы неспешно знакомили с технологиями переписывали потому что 2008 года накопилась там куча старых штук которую мы хотели применить в будущем для тестирования и за это время разработалась куча новых ту которую было бы полезно использовать наших вин тестах собственно саму api выглядит примерно так сначала у него грузится загрузчик он определяет какие модули нужны текущему клиенту какие там у него используются события touch домом pointer lancer другие и исходя из кучи факторов там подключая этому зависимости от браузер от клиента системы свои дополнительные модули которые нужны чтобы хорошо функционировал api вторым запросам загружается именно эти модули программы а третьим запросам примерно грузится всякие разные представления там макеты картинки css и другое вот и вся проблема с которым мы столкнулись тестирования синхронных интерфейсов была в том что тесты маки в частности запускаются в одном скорбь и то есть однажды подгрузив скрипты подключив их все тесты прогоняются в этом же окружение независимости от того что могут понадобиться либо другие либо еще что то если вы используете какую-то библиотеку какой-то фреймворк или api например там google карты яндекс карты либо другие которые погружают за собой что-то вы потенциально риску щества в мусс с этой же проблемой мы столкнулись с ней когда у нас было уже много тестов модулей и и это почти поставила крест на тестирование быстро нашли решение для начала я расскажу пример синтетически который может случиться у вас и за подобные подобного flow то есть вы в одном тесте создаете input в этом mind выйти что-то набираете и все и забываете его случайно удалить то есть забыть удалить input омс теста это вообще нормальная ситуация в другом тесте случайно вы проверяете там что никаких input of на странице нету с конкретным айтишником у вас внезапно он падает и вы не понимаете почему и найти там допустим если у вас парад с овсянку томида найти в одном тесте что что-то не удалено довольно просто а если у вас их там 70 и в какой-то момент что-то падает то все становится больно и плохо мы с этим столкнулись у нас было на семидесятом тесте все валилось мы плевались долго смотреть но все идеально написано все хорошо как бы всё ок а внезапно тест падает там рынок стики или все в чем-то мы смотрели смотрели отдельно запускаем работы запускаем небольшую кучку тестов работы запускаем весь проект все ломается но в целом очень мы придумали как это решить как запускать тесты абсолютна изолирована как сделать чтоб асинхронный интерфейсы который там за загрузка работает вообще никак не влияли на скол то есть нужно до бального простая схема у нас есть но доска эту за который запускает грубо говоря много процессов мог этом фэндом джесс райнер и и вот эту вот вторую часть можно пока закрыть глаза примерно оставить ее в голове я объясню как она работает вот это нодов скоту за пробегается по нашему проекту собирает он тесто из указанной папки и из них она берет имена модули и берет соответственно весь контент склеивает это все в один файл там глобальная переменная получается с семенами модули и весь контент далее мы берем все имена модули и потихоньку начинаем их прогонять передавая в тестовую страницу где там подключены все наше окружение основное какой-то get параметрам имени модуля она запускается там каждый раз когда запускается новый экземпляр fingers a story проходит они там образуют очередь один заменяет другой и по сути каждый раз запуская новую страницу они запускаются изолирована напомню а но сначала грубый такой парсинг get параметров в страничке он до банальности простой нас как я говорил уже используется модульная система она позволяет рик варить только нужные модули вот суд на чем мы и занимаемся мы запрашиваем только нужный модуль теста таким образом запускается только он один все остальные как бы они просто находятся в том же файле напомню что тестовый модуль выглядит вот так ну и таким образом далее мы запустили тот у нас есть семена модули все эти вот эти вот штуки раннеры они прошли отработали свою запустили страницу получили какие-то результаты тестов и вывели их просто в стаде out общем там в мока фэндом райнер и других райнер ах есть возможность указывать reporter там можете использовать джейсон ли джейсон очень удобно парсится вот таким образом тестовый примерно так в терминале когда они проходятся на деле попробую запустить вот запускается там указываем путь в проекте он пробегаете по нему запускает каждый райнер с отдельной страничкой по сути и выдает результат что там все прошло все наши тесты прошли и успех короче вот мы обрадовались что все мы решили нашу проблему и теперь у нас больше нет никаких проблем и на самом деле большая часть наших проблем решилась то есть мы запускаем тест и в разных браузерах не только в терминале у нас там есть еще кармы джесс который позволяет там в удаленным selenium гряде подключаться и запускайте начинает ее 8 до всяких экзотических устройств но вот это как бы в браузере мы еще не научились запускать тесты изолирован они как запускались своей кучкой толпой так они там и запускаются но при этом бывает необходимость там запустить юнит-тесты на кухне из старых android вских девайса либо под не знаю windows фоном на которую невозможно просто актом подключить виртуальную машину или еще что-то и собственно сейчас мы хотим в какой то момент когда появится время оформить все это наше решение в npm пакетик чтобы если вы столкнетесь с подобные проблемы с подобными штуками вы знали что делать куда идти либо там в общем как решить эту проблему и второе это попробовать решить штуку запуском в браузере нас уже такая была с я хуею мы и делали и этому мы также по аналогии сделаем позже для этом моки чтобы это было удобно ну и собственно будем продолжать делать мир лучше презентации находится здесь да кому интересно вот информация об api если вам интересно карты вы можете спрашивать либо у меня по полезным ссылкам этот тех где находится документация примеры клуб разработчиков едим наша команда отвечает на вопросы ну и всякие сосед очки сосна меня зовут denis задавайте ваши вопросы а спасибо за доклад а сколько длилась переход вот с одной версии тестирование тестов на другую мы уложились месяца три в таком фоновом режиме очень то есть мы не торопились прямо браться и переписывать но через три месяца у нас набралось критическая масса тестов которые запускали будут только в терминале под конец там за неделю все критичные местам и еще дополнили тестами вообще можно переписать всей командой за неделю покрыть там за пару недель тестами это будет наиболее быстрый вариант в том числе один из таких самых удобных спасибо за доклад я может быть упустила но у вас вот там была проблема с ней там да что же нужно было дождаться когда исполнится год ну при асинхронных каких-то там вызовов вот мы просто используем сейчас капибару вот бочка к интеграционное тестирование постоянная проблема вот со слепым и синхрона и сами там что не всегда корректно отрабатывает я это даже касается не только аякса это можно даже взять любой эффект какой-нибудь css и что пока он не закончился я не могу там оттестировать дальше функционал мне нужно дождаться когда закончится анимация даже ну любой а вот можно поподробнее как у вас от решается мы пишем основу unit-тест национальное тестирование у нас занимается отдельный человек потому что у нас довольно специфический продукт и и мы редко пишем функциональные тесты на практике его не и на еще что то подобное но в целом варианта либо 2 там если вам нужно дождаться анимацию это слушать transitions and если не получается просто подписаться на транзишен это нужно какие-то специфически то увеличивать тайм-аут ждать подольше а у вас фреймворке вашим что для каких-то синхронных вещей вообще а мы как бы не фреймворк я просто рассказал наше решение что мы запускаем тест изолирована полностью чтобы один тесте влиял на другой не как и чтобы окружение каждый раз подключалась там зависимости вот тестируемого модуль или еще что-то потому что часто бывает что допустим в одном тесте нужно подгрузить еще что-нибудь там либо картинки либо добавить что-то в дом вот и могло получаться так что в другом тест проверяется именно вот эти вот данные чтобы что-то подгрузила что-то добавилось оно не должно было добавить а вот то что вы ведь было на одном слайде благодаря удобно было тестировать про асинхронная интерфейсы ну то есть у нас была проблема что здесь фейцзе среди ум как бы нам не нравилось интерфейс он был сложный он вкладывался в друг друга иногда часто даже что в одну ручку сходили из него потом в другую сходили по результатам в третью дошли в случае там моки вот этот стандарт мог ojos в нем это решается просто вы передаете аргумент функцию и вызываете его когда все готово когда уже все он тест прошел все что нужно вы проверили вы вызываете дан и он говорит что ваши асинхронная операция закончилась спасибо то есть это очень удобно попробуйте посмотреть там еще и promise можно вернуть в мойке дорадо есть promise и если там а еще не читал of не вчитывался но под кроме много чего заточена в тестовых фреймворков это очень удобно единиц спасибо ещё раз за доклада как вы справляетесь с большими цепочками тестов либо просто с большими тестами которые зависит опять же от других тестов ну там у нас просто в проекте бывает так что нужно написать тест который зависит от другого теста не там прям по цепочке достаточно большие получаются и очень неудобно с этим справляться как у вас решается проблема если она у вас вообще но у нас есть какой-то публичный api а есть не публичный то есть мы идем от того от минимальных модули к самым большим из про тестирование минимальные какие-то там компоненты то ясное дело что у более большого которое использует их будет гарантий что он работает повыше в нем соответственно мы тестируем публичной интерфейсе возможности которые он предоставляет получается да в некоторых местах очень много мы их разбиваем на несколько то есть прямо по файлам делим потому что допустим это тестирует события это тестирует api это опция и так далее то есть в таком формате до приходится иногда делать то есть еще раз в формате что можно несколько раз инстанциировать один тот же модуль там протестировав его по-разному таком формате мы работаем тоже эра все еще вопрос спасибо еще раз сейчас у нас часовой перерыв и потом по расписанию начнем как обычно приходите"
}