{
  "video_id": "5Qld5krWjvQ",
  "channel": "HighLoadChannel",
  "title": "Does the latency matter? / Юрий Мусский (Big Data Technologies)",
  "views": 1204,
  "duration": 1859,
  "published": "2021-10-04T02:44:38-07:00",
  "text": "всем привет я начну с того что есть исследование от google которая говорит что если ваш сайт открывается доли более чем три секунды то вы потеряете около 40 процентов пользователей а для мобильных пользователей вы потеряете более 50 процентов также есть reported амазона который говорит что для амазона каждые 100 миллисекунд дополнительного леденцы стоит им один процент продаж и в объемах amazon а это миллионы долларов в зависимости от вашего бизнеса вам стоит тоже ответить на вопрос да златан симметра я представлюсь меня зовут юрий мусский я работаю как системный инженер уже более 8 лет хочу с вами поделиться опытом который я получил в процессе решения задач в компании big data технолоджис у нас есть какой-никакой хайло тв пикета 30 fps и вопросы отнести довольно остро стоит перед бизнесом когда разработчику ставят задачу улучшить латинские что обычно делается открывается google идет разработчик на google pagespeed insights прогонять свой домен смотрит сколько там выдала попугаев и смотрят какие этот сервис дает советы например мини фиксировать же с с использовать изображение правильного формата и более двадцати других советов но что делать если все эти советы уже выполнены но локалхосте уже все летает а вроде для каких-то юзеров вы испытываете высокой летальности или например вам вообще этот сервис не подходит и у вас api его sape все что вам нужно сделать это нажать ее в 12 вашем браузере открыть developer консоль зайти в раздел раздел network тайминг и там ваш браузер вам а сам рассказывает структуру леденцы от вашего приложения а со стороны клиента и тут вы увидите много пунктов которые ваши приложения вроде как не касаются это dns latency на установку тисе пи соединений установка шифрования на все это уходит 100 миллисекунд и только вот последний блок стендин уайтинг recieving это уже ответ от вашего приложения сейчас мы пройдемся по всем этим пунктам я посоветую без проект с и какие-то протоколы которые помогут вам про тюнить личности в докладе я считал статистику использовать следующий методология я использовал утилиту дикс ключом trace которая позволяет получить не кошель не кашированные dns ответы утилиту сиирэл она же куру с ключом w который показывает тайминги дело всегда тысячу запросов и считал 99 процентили также на слайдах может увидеть out put усилит их этот пост от которая показывает красивую визуализацию сразу забежим в конец что после всех настроек которая сегодня посоветую вы сможете получить boost от 2 до 10 раз но в абсолютных значениях это около секунды для клиентов на оптики для клиентов который на мобильных телефонах эти цифры могут быть значительно больше если 1 секунду для вашего бизнеса это хороший boost тогда вам стоит обратить внимание на советы которые буду далее давать первая тема которую мы затронем это dns и как решить какой name server быстрый и вообще как понять стоит ли нам использовать текущего провайдера хороший ли он можно воспользоваться например публичными сервисами такими как dns перст . комп или создан с точка ком там есть какой-то топ в который показывает latency топ между рейтингами очевидно не одинаковый но в целом очередность одинаково клад флаер будет вверху списка фрейд арк в дне списка а amazon выше чем google но это рейтинг только этих сайтов и зачем нам его используйтесь мы можем легко сами посмотреть и померить я взял 7 различных донёс провайдеров это три основных облака дтп и ws мейджор взял клауд флаер как лидера рейтингов взял и фрейд арк как аутсайдер рейтингов и также взял одного российского и белорусского провайдера д.с. я проверил домены которые хочется у этих донец провайдеров и у гугла и так уголком очевидно ауре игру это ребру а вот у амазона это не amazon.com потому что amazon сам себя не хочет в рот 53 он использует два других dns name-сервера это ден dns и ультра днс dns есть две стороны это резал героином сервер и чтобы не проверять google гуглом и иметь более частную статистику я взял еще и 4 популярных донёс резон рессорой прогнал круз тестом тысячу запросов на все один с ним сервере и более наглядным и результаты на графике что публичные рейтинге нас не обманули клад флаер как был в топе так и остался при этом мы можем видеть что у amazonas на 40 миллисекунд лет он все лучше чем у гугла аль игру в два раза лучше чем хостер buy и если вы захотите сэкономить и возьмете максимально дешевый на им сервис на рейтинга то вы можете получить и 400 миллисекунд разницу на каждый запрос и вы можете подумать что 50 100 миллисекунд это очень мало можно не обращать на это внимание но есть например ваш бизнес производит какие-то life транзакции например то бирже или банк то это будет существенно также есть еще такой кисть что бизнес имеет свойство расширяться и возможно вы пойдете в какие-то другие географические регионы например в азию или в южную америку и вы внезапно можете увидеть рост лет инсте который будет очень сложно за трубу сузить просто потому что ваш текущий день с провайдер не представлен в этих регионах и гоняются 1с запросы через океан первый шаг это dns resolution или dns lookup мы рассмотрели возьмите топовые name server и проверить какое вообще у вас идем дальше следующий шаг это которая делает ваш браузер это установка типе соединения для этого требуется всегда 1 round trip time на установку хан шейка и вроде бы с этим вообще ничего не поделаешь и но есть здравый смысл который нам подскажет что чем ближе наши юзеры локально до наших серверов там будет то будет менее длинный сеть маршрутов поэтому логично хостить ваши приложения близко к большинству ваших пользователей но что делать если вашей юзеры gear s поделены классический ход это использовать силен для статики менее классический ход это включить сидя на для динамики и это стоит делать потому что у вас все равно будет boost за счет того что между селеном и вашим сервером уже будет всегда установлена эти цепи сессия а юзер буду ходить до ближайшего сидел сервера но самый интересный вариант это разнести вашу инфраструктуру по гео принципу предположим вы подняли всю инфраструктуру в разных регионах но как донести пользователям чтобы они ходили до ближайших до них серверов с этим нам поможет такая вещь как g1s это extension в dns который позволяет dns резольвер у пробрасывать к нам сервер маску подсети клиента то есть dns провайдер может вычислять клиента пайпе ну определять его геолокацию и отдавать для разных клиентов разные значения а записей многие dns провайдеры не поддерживает g1 с новой ws рот 53 такой функционал есть на скриншотах видно как это настраивается в данном случае мой сайт по дефолту хочется в японии но для юзеров из европы будет отдаваться айпи европейского сервера я провел провел краш-тест латексе сервера и ws в европе и японии как клиент до серверов google cloud европе и японии и тест показал что даже на таком небольшом расстоянии как из европы азию между нами нет океана япония передовая страна но мы получаем boost волатильности за счет d1s 250 300 миллисекунд и это на каждый раунд rip и это уже намного больше чем 50 миллисекунд от выбора dns резольвер а также в рамках тисе пи есть такой протокол довольно мало известны как тисе пи фас толкин который позволяет вам сократить 1 round trip на установку хан шейка для второго и последующих соединений до нуля тисе пи соединение будет устанавливаться сразу же при ответе сервера на слайде вы видите как это работает первый запрос у меня занимает 260 милисекунд а второй уже с ключом и степи фастов он занимает 4 миллисекунды настраивается довольно легко нужно просто включить настройку в cis ктл и на веб-сервере протокол этот работает с помощью так называют его cookies когда при первом соединение генерируется собственно файл cookie который в последующем перри используется когда сервер видит валидны cookies от клиента на стадии синта на стадии si no knowledge уже устанавливается соединение и можно не ждать полных in шеек но вы скорее всего не слышали про этот протокол потому что есть ряд проблем и основные the tracking и metal box и что такое metal box это какое-то старое или в дорогое продам на из печенье или железо которое не знает про протокол тифа отец типе так устроен что если железо видит какие-то непонятные настройки они просто будут отбрасывать эти пакеты и сессия будет нужно устанавливать заново получается мы наоборот проиграем на времени на установку типе соединения и таких middle боксов интернете довольно много было произведено исследование их там порядка 14 процентов трафика будет проходить через них и будет требоваться повтор найтись присоединения но самая большая проблема это треккинг в браузерах есть такой функционал а как приватные вкладки и если мы будем использовать эти фифа столб он будет полностью скомпрометирован потому что сервер сможет потов и у cookies определить юзера вне зависимости того в приватной вкладки или нет соответственно для браузеров это неприемлемо и но все же в браузерах есть support for но по умолчанию он выключен его нужно зайти включать настройках но есть один кейс где можно использовать это при общении server server когда вы предоставляете какой-то api ваши клиенты это тоже сервера я и расположена вы географически далеко то вы можете просто включить тофа и выигрывать 1 round trip на примере да и от европы до японии это 300 миллисекунд второй шаг tcp это и ниша la connection или connecting мы рассмотрели используем а сиди иен пробуем d1s и если вам подходит то можете попробовать эти фифа столб он следующий шаг ваш браузер при отправке запроса это он устанавливает лес соединения протокол очень старый он развивается но все его развитие до версии 12 было направлен только на улучшение безопасности от отказ от скомпрометирован их алгоритмов шифрования добавление более сложных устойчивых алгоритмов но налетать это не влияло абсолютно никак это был полноценно 2 round trip time но с выходом tls 13 протокол изменили из коробки он стал тратить 1 round trip то есть для установки шифрованного соединения достаточно одного пути клиент-сервер клиент год назад на апрель 2020 по данным ослаб только двадцать два процента из топ-100 50000 веб-сайтов использовать лес 13 но прошел год и уже эта цифра 44 процента и этот резкий скачок судя по датам обусловлен тем что не так давно браузере депре кейтель и старый протоколы ts11 и администраторам было несложно вместе с deep реки этом старых протоколов добавить support tool с 13 но все же 44 процента это даже не половина интернета которая перешла на этот протокол сейчас увидите вот путайте лидкор и лишь сиирэл в котором в котором видно как при протокол tls 12 нужно 2 round trip тайма это два блока in на картинке сверху для протокол tls 13 уже всего лишь один блок и как это работает при t с 13 клиент сразу же при запросе клиент хеллоу генерирует так называемый пск решают ключ и отправлять его на сервер а сервер с помощью этого поиска шифрует свой ответ сервер хеллоу добавляют туда необходимую информацию и клиент уже следующем вторым запросам вместе с финиш может отправлять шифрованных тот по запросу наглядно хотят и поста час покажет как отличается от вас 12 из 13 прицел с 12 и мы получаем 600 миллисекунд лет инси а при t с 13 мы получим 300 соответственно это полноценный round trip time но только разовые запросы им нельзя верить и поэтому мы собираем статистику на статистике явно видно что мы получаем 1 round trip benefit просто за счет включение этого протокола ноу-тилл с 13 есть еще такой функция как zero round trip он работает очень похожи как тисе пифа столб on client при втором и последующих соединениях может использовать файл эрлидо то который добавляет добавляется в клиент халлоу сервер во лидирует эту эрлидо то и отправляет финиш то что позволяет установить лес изменения за веру round trip и как это включается довольно просто вам просто нужно не древний веб-сервер не древнюю операционную систему в которой у панаса цели не старше чем 111 например это 18 бунта а 16 не подойдет и три строчки в конфиг engine x это версия протокола цель эрлидо то он и добавление специального хедера эрлидо то или под другим любым названием который сможет обработать ваш backend этот хедер необходимо для защиты от так называю их реплея так когда человек середине может взять слепок шифрованного трафика и начать его повторять и если ваше ваше приложение уязвима например в банк и вы явно не хотите чтобы запросы с транзакциями повторялись бесконечно то вам нужен на бэг-энде обрабатывать этот кастомных ядер но по мне это не очень большой limitation чтобы получить отличный boost your но мы к сожалению можем проверить талас 13 star ли дата но мы можем проверить с помощью утилиты апаны с цель в данном примере мы при первом запросе генерируем file station м а при втором мы его используем с ключом эрлидо то и если на сервере правильно все на встроена вы увидите дату was accepted эрлидо то в отличие от тифа включена во всех браузерах по умолчанию и вы получите boost от ваших клиентов сразу же также в рамках отец хочет поднять такую тему как длина и рсо-а ключа по дефолту сертификаты на private lesson крипто шифруется ключом длиной 2048 бит но вы можете купить более secure на сертификат шифрованный включим в 3000 или 4000 бит но при этом всегда надо держать у меня что время на ферме нацию трафика будет увеличиваться в шесть-семь раз за каждое удвоение длины ключа у меня есть реальный кейс из практики security team купила за недорого как они считали более secure на сертификат и выкатили иван опрос и вечером просто пришел вечерний лад и у нас просто началась деградация prada сервера начали задыхаться по циpкa и это решилась только увеличению процессорах мощностей rudkus что были обновлены с цель сертификаты мы поняли только на следующий день последние в рамках tls что я хотел бы затронуть это прекрасный сайт ссылкам фиг dot mozilla до торг в котором можно просто накликать конфигурацию вашего веб-сервера например взять engine x выбрать модерна указать какая версия office цель и вы получите сгенерированный конфиг пользуйтесь третий шаг то ли сетапы или же с целью мы рассмотрели включаем то в с 13 и включаем эрлидо то и вот мы пришли к самому интересному это наш ктп запрос от клиента в браузере и по данным в третьих на апреле этого года 49 процентов от топа 10 миллионов веб-сайтов поддержит hd2 то есть пятьдесят один процент интернет не поддерживает ктп 2am и в 2021 году а с 2018 года уже идет активная разработка протокола к тета п 3 о которой уже очень скоро нужно будет переходить но сначала обсудим зачем выходить p2 по дефолту веб-сервера будут настроены на ктп 11 и многие просто не знают что просто включение протокол http 2 может улучшить response для ваших клиентов один из бенефитов который нам дал кто-то по 2 это возможность параллельно отправлять ответы и запросы по одному тисе пи соединения для протокола 11 в у каждого браузера есть захардкожены и цифра от 6 до 9 10 соединений на один домен и запросы ответы будут идти последовательно в рамках этих типы соединений протокольных тп-2 вы можете для второго и последующих запросов отправлять ответы в рамках ответы в рамках одного соединения также есть такая технология как в дтп 2 сервер push которую вам позволит отправлять клиенту больше данных чем он даже запрашивал например вы точно знаете что запроса на яндекс html нужно отправить gens qui css q и вы можете предна строить так что юзеру будет отправляться дополнительные данные и это могло бы дать хороший performance boost но сервер push почти не используется на самом деле потому что есть проблемы с браузером кешем вы не можете знать что есть в кэш его вашего юзера и поэтому отправка css может быть наоборот лишний если юзер уже имеет это css у себя в кэше наглядный пример разницу между scp-112 возьмем большую картинку разбитую на множество маленьких для увеличения скорости загрузки кейс множество файлов на сайте отлично показывает лимит из-за последовательных запросов и ответов но сегодня мы уже очень близки к т т т т т т т т т т т т он же quick quick эдипе internet connection протокол который изначально придумали в гугле чтобы решить проблемы с растущим трафиком на ю тубе и а теперь это уже почти законченный официальный протокол к тета п 3 под капотом хоть и тб-3 все что есть при классическом despise изменение но только все завернутая в ю т п а когда мы слышим youtube и мы знаем анекдот про ю т п которая если до вас не дошел то я вам его не повторю проблема use pieta потеря пакетов и can женщин control концерта контроль потока и в квики это решена за счет так называемой абстракции как quick stream который также кроме этого решает проблему с вич инга сетей у ваших клиентов например клиент пользуется вайфаем с телефона потом переключается на 3g потом пересесть на 4g переключается обратно на вай фай и в рамках тисе пи где определение клиента это его айпи адрес и порт при смене сети каждый раз нужно будет устанавливать соединение заново а при клик стримах которые присылаются клиенту можно продолжать переиспользовать соединение при switch инге сетей давайте протестим как работает этот p3 как и внедрить на текущий момент поддержка quick джинкс в разработке и чтобы включить в индекс нам нужно у скомпилить к счастью есть мануал по которым довольно легко это можно сделать а можно перес пользовать мой докер-образ который я уже собрал и все что нам нужно сделать это в engine.exe добавить две строки в конфиг это собственно в директиве листа добавить quick и добавить специальный хайдер аль тест в c и в нем указывается версия протокола сейчас и 329 это версия драфта и порт на котором собственно у нас в дтп 3 ну когда мы это все включаем скорее всего у вас ничего не заработает потому что ну или хочется верить не заработает потому что вы точно забудете открыть на фаерволе 443 пою т.п. кто вообще открывать youtube и открываем порт и идем тестировать окном этот сделать можно зайти на сайт ктп тречок dot net и там прогнать ваш домен и он покажет включен ли у вас кто-то p3 на каком на кой версии протокола он включен но онлайн тест это не наш путь и давайте с вами просто проверим карлом что нам мешает но как оказалось чтобы проверить карловна да и курил тоже скомпилить открываем мануал или используем докеры мышь который оском пилил и наглядно видно что на мой запрос в engine и в слогах хотя тб-3 200 более наглядный от пут от карла тут нет привычно установки соединения здесь мы видим вот этот блок ev3 который создает quick stream в браузерах на сегодняшний день уже в пили на поддержках тб-3 ее нужно включить настройках но например в хроме уже катится тест на 25 процентов юзеров которых эта настройка включена по умолчанию также в кроме она включена на домен гугла есть хороший вопрос вообще зачем нам нужно ходить по 3 дает нам вообще культа boost полотенце и я провел тест на один и тот же dobby на этот по двойных это с батареи boost показал из разных точек мира от 14 до 50 процентов преимущество вроде бы неплохо но самые свежие новости нас ждут впереди и я везде я походу доклада упоминал что эти все мы boost и работают для второго и последующих соединений или запросов первый запрос сейчас любом случае по дефолту прилетит вам на ктп 11 увидит там redirect на хтс увидеть тома и стс если вы его сконфигурировали увидит там хедер а это своей только потом уже перейдет на ht3 или по два как этого избежать и у нас новый dns-записи сейчас идет утверждение в инжиниринг интернет task force новых dns-записи и хотя tps мы создаем дополнительную длине запись и браузеры и будет запрашивать вместе с записью и наш самый первый запрос уже прилетит плохо ттп 3 на слайде видно что в club flyer уже можно добавлять эти записи и наслаждаться это довольно крутой boost который нас ждет mozilla уже поддерживает эту dns-записи fest gps также поддерживает сафари но в chrome еще в разработке это находится еще пару слов рамках дтп скажу про компрессию и кажется тут все понятно что чем меньше наши данные тем быстрее они будут у клиента но это не совсем так нам нужно еще добавить время на сжатие этого контента я сравнил два протокола старый добрый zip и модный братли и в принципе получил схожие цифры на разных уровнях жать они ведут себя по-разному что-то лучше сжимает что-то быстрее отдает на моем тестовом файле лучше response time я получил на среднем уровне сжатия вам нужно понять какой вас трафик и эмпирически поиграться с компрессией но включается и и определенно нужно ктп кэш юзайте кэш это его очень легко включить он гибок если вы будете использовать так называемые strong хедер и полотенце будет 0 миллисекунд потому что все будет закрашена в браузере клиента подведем итог используйте быстрая ns сервера используйте силен и если вам нужно использовать и гео-локацию если вам подходит попробуйте т.к. включите tls 13 включите early дату про подключать их и ттп 2 включайте компрессию и кэш и попробуйте повесить их этот ep3 он может вам дать значительный boost ну и первый redirect а вы тогда лишитесь тут есть мой сайт который на ht3 и есть репо там где я считал статистику там есть все скрипты как я это делал там есть настройки яндекс для каждого случая и там есть дополнительные данные например не по 99 по 50 процентиля в этом все спасибо большое и начинаем сессию вопросов-ответов и вы если есть вопросы поднимайте руки если у вас в онлайне есть вопросы тоже там поднимайте руки онлайновым способом у вас выйдем на экран и постучим ваш вопрос и сразу тебе говорю your невидимая я тебе очень важно выбрать автора лучшего вопроса хорошо итак все начинаем юрий большое спасибо за доклад олег x5 у меня такой вопрос я правильно понимаю что вот эти вот рецептики которые вы сейчас рассказывали да вы опробовали на своем продакшне на своем хайло де и я насколько это повлияло на его стабильность то есть вот там вот отель эти вещи типа твои лишь теперь я не поддерживаемая до были какие-то грабли включение да ну в рамках твоя вопрос попробовал нам не подошел потому что с браузерные клиенты у нас включена последний т с у нас включен hp2 hp3 я жду когда все таки в engine.exe она будет в мастер ветки но на каких-то фронтэнда у нас по три уже включен потому что мы хотим их вклад флаер и там просто галочкой это включается не обязательно свой веб сервер compiled для этого проблем как таковых но только в рамках тестирования я где-то полгода год назад я уже включила сам сайте дтп 3 и и тестил это и например у меня при заходе на мой сайт крошилась mozilla я нажала баг репорт и на следующий день прилетело обновление от mozilla и это все починили то есть это активно развивалась но это было еще прямо на месяцев десять назад сейчас каких-то ищем вообще не встречаем и как только ht3 появится в браузерах по дефолту мы включим прям сразу спасибо 1 2 здравствуйте здесь большое спасибо за доклад у меня два вопроса но они очень короткие 1 я видел там на одном скриншоте что был скриншот на одном слайде что был скриншот из dev tool видимо хрома при из цепи три правильно я понимаю что поддержка да вот нет нет вперед вперед вперед mozilla носил ладно правильно я понимаю что семантика в части 3 остается та же что вы себе 211 и что браузеры там все devtools поддерживает нормальное изменит да ну мы не столкнулись еще каких-то проблем разработка тоже тут с тела все поддерживаются соответственно дата довольно долго как раз на уровне браузеров тесниться поэтому даже до сих пор это не включена по умолчанию и внезапно сафари самый передовой игрок в этой схеме которая включает всю самый первый в этом видимо apple заинтересован the poetry как же google понял спасибо и второй вопрос если какая-то статистика по использованию петри мировая по сайтам до на самом деле есть клауд флаер по умолчанию включил возможность включить к тета п 3 галочкой и уже по моему семь процентов от то по 150 веб-сайтов 150 миллионов веб-сайтов включила поддержках это p3 собственный объем club flyer в мире ясно спасибо спасибо за доклад сделали вы анализ потребление ресурсов циpкa памяти на клиенте и сервере при включении естественно tls 13 и http 23 прицел с доделали мы даже получили benefit там у павла я не могу точно цифры сказать но где-то процентов 15-20 мы получили уменьшение потребности циpкa этот ключ от насчет л.с. насчет к тета п 2 нет не мерили но все спасибо"
}