{
  "video_id": "qJw-Fr1y7JI",
  "channel": "HighLoadChannel",
  "title": "VML — нет времени объяснять, создавай виртуалку / Алексей Шабалин (Базальт СПО)",
  "views": 89,
  "duration": 2702,
  "published": "2023-10-06T07:19:44-07:00",
  "text": "Привет Меня зовут Алексей Шабалин представляю отделы руководитель является руководителем отдела разработки систем виртуализации и облачных технологий в компании Базальт и хочу представить Вашему вниманию проект нашего коллеги который был именно сделан разработан В недрах нашего отдела в первую очередь для облегчения жизни Нам же самим а что это такое вмл давайте начнем с этих трех букв вмл с расшифровки V здесь понятно это virchel а ML она осталась от предыдущего кода когда код изначально был написан на окамол и Metal Language в дальнейшем у нас не все срослось слишком мало для использования было доступно библиотек которые требовались и поэтому код переписали на Расте Но с другой стороны имя так и за ним закрепилась за этим за этой программой что это такое Это очередная надстройка над кем у которая позволяет запустить виртуальную машину Скорее всего в первую очередь не просто виртуальную машину А Облачный образ виртуальной машины образ который специально предназначен для запуска в облаках а что означает специально предназначен для запуска в облаках в первую очередь это образа которые встроен клауденит кто-нибудь здесь сталкивался раньше с клауденит с облачными образами замечательно то есть но я все равно расскажу значит зачем мы начали разрабатывать весь этот проект мы как компания разработчик дистрибутива Мы изготавливаем не только ISO образы для установки нашего дистрибутива но еще и готовим наши же инструменты те же самые замечу которые готовят iso-образы они позволяют еще и готовить сразу же виртуальной машины Сразу же Root FS для контейнеров В общем помогают нам делать все задачи которые необходимы именно при выпуске самих дистрибутивов здесь возникает необходимость проверки результирующих проверки что же мы получили рабочий образ виртуальной облачной которые мы изготовили нерабочий первоначально мы это все делали и проверяли в своем карманном облаке построили построенном на базе openstack и это облако Как вы знаете если за опен стеком очень долго не присматривать оно имеет свойство потихонечку со временем разваливаться при обновлении одних модулей питонов все начинает ехать разъезжаться в разные стороны и ну скажем так оно потихонечку умерло своей жизни и нам не было смысла вкладываться в его поддержку и не было скажем так и у клиентов желание вкладываться в эту поддержку то есть мы можем быть и помогли бы кому-то но сами для себя решили это не делать Что же делать в этом случае когда сейчас прямо у тебя у себя нет площадки проверить Облачный образ Ну как бы логично что воспользоваться каким-то публичным облаком на тот момент были mail.ru Клауд Ну сейчас ВК clow Да и дальше получается Следующая история мы изготавливаем образ мы его отсылаем публичное облако мы делаем шаблон на базе этого образа мы создаем виртуальную машину на базе этого шаблона мы запускаем эту виртуалку мы запускаем там тесты во всей этой истории самым долгим самый большой промежуток времени занимает на самом деле закачка образа виртуальной машины в публичное облако Да у нас у компании не слишком большой канал в интернет там еще наверняка не все так хорошо чтобы можно было образы закачивать на космических скоростях одним словом возникла идея А почему бы не написать маленькую небольшую утилиту которая будет прямо здесь локально и по месту изображать из себя какое-то мини облако потому что Что такое вообще облако и почему я вспомнил про клауденит во всех облачных образах у нас так или иначе скорее всего встроен Агент под названием клауденит и какова роль и задача этого Агента в первую очередь во втором столбике Обратите внимание это количество разных типов облаков которые Он поддерживает весь фокус в том что каждая облако в котором мы запускаем Наши виртуалки в каком-то своем формате каким-то своим способом доставляет во внутрь виртуальной машины метаданные что к этим методам может носиться имя Хоста нового создаваемого пользователя ip-адрес либо настройки динамические настройки для сети ssh ключ Рута либо ssh пользователи и куча куча других различных настроек и вот эти все параметры каждое облако практически генерирует некоторым своем формате соответственно первая задача у клауденит это понять В каком облаке работает и обработать конфигурационный файл Согласно этому углу причем и методы доставки внутрь виртуальной машины тоже везде разные где-то это http запрос Ну например в Клауд стекла в Open Stack это http-запрос на конкретный адрес с уидом который равен нашей виртуальной машины там генерируется файл с метаданными отдается этой виртуалке и клауденит его уже начинает обрабатывать в других облаках этот файл настроек с метаданными доставляется другим способом генерируется при старте виртуальной машины создается например это образ диска iso-образ подключается к этой виртуалке как виртуальная cd-rom и клауденит уже монтирует этот виртуальный синдром и также получает этот файл с настройками и как-то его обрабатывает вторая важная часть которую производит клауденит и что необходимо обеспечить это именно поддержка различных дистрибутивов Казалось бы все линуксы у нас одинаковые с одной стороны это везде ядро Linux везде определенный набор утилит Но как Только копнер уже чуть поглубже они оказываются все чуть-чуть до раза у одних Linux настройка Ну например в Red Hut в центр сейчас они перешли на настройку сети через Network Manager раньше использовалась для серверных и вот облачных систем использовались настройки нет в деве до сих пор серверных дистрибутивах скажем так используется тоже скрипты etc network-интерфейса Если не ошибаюсь абунте уже перешли на другую подсистему настрою по сети нет возьмем it Linux который мы добавляли поддержку в клауденит тоже ресурсами нашего отдела естественно когда-то клауденит ничего не знал про Альф Linux какие-то основные базовые моменты Понятно Они одинаковые во всех люксах но Вольт линуксе мы поддерживаем как настройку сети как и через Network Manager как через систему dnet даже нет план Мы можем установить При желании его использовать Кроме этого в альфиновке есть своя система скриптов настройки и сети нет Все зависит от того как мы приготовим этот Облачный образ и какую под систему настройки установим и Наша задача была чтобы клауденит это понял и начинал ее использовать таким способом Вот как раз задача у клауденит Это прослойка между самим облаком и виртуальной машиной и первоначально основная задача это первоначальная загрузка виртуальной машины и конфигурирование в соответствии с теми данными которые передаются Да важный момент надо сказать что клауденит на самом деле можно использовать И не только с виртуальными машинами и не только с облаками на самом деле из простыми металл и даже в конце ионизации ЛСД тоже возможно первоначально настраивать наши контейнеры либо виртуальные машины реальные машины по сути настройки клауденит вот здесь самый простейший вариант настройки клауда под названием Угадайте No Cloud и здесь мы создаем некоторые файл в котором описываем какой ssh положить какому пользователю создаем на основании этого этот файл упаковываем высокий образ команда это из набора утилита есть набор таких утилит и в дальнейшем при запуске тему с указанием что вторым диском мы подключаем первым диском Как вы видите подключается образ Облачный образ скачанный откуда-то с просторов интернета сайта ubunty скорее всего а вторым диском наш изготовленный специальным образом iso-образ и вот по большому счету Мы здесь уже изобразили минимальное Облако которое для проверки наших облачных образов здесь мы можем проверить насколько правильно у нас интегрированы внутри образа как минимум он у нас должен отработать пройти все стадии своей работы влогах показать что сработало что не сработало и уже получить какой-то результат положительный либо отрицательный а Что же делает сам Для чего же мы делали вмл То есть сейчас я откатился и рассказал про клауденит и весь и вмл именно заточен на то чтобы запускать образы исключительно с интегрированным клауденитом потому что рассчитывает на то что при запуске виртуальной машины внутри запустится из конфигурирует виртуалку так как мы ему расскажем и здесь для скажем так для красоты эксперимента мы покажем прямо на сборке самого vml как его собрать прямо внутри виртуальной машины это не означает что единственный способ сборки vml это нужно иметь рабочий bml vml здесь мы запускаем исключительно как менеджер виртуальных машин Первая команда для создания виртуальной машины vml Run дальше указываем дистрибутив на котором будем это создавать указываем размер памяти количество виртуальных ядер нужен ли нам какой-то специальный usersh и название этой виртуальной машины Как вы видите командный интерфейс несколько похож с докером на самом деле этого и пытались немножко достичь то есть одни команды Ну вмл ран здесь как мы понимаем Если сравнивать с докером в этот момент происходит скачивание дистрибутива ALT если его ранее не было если он раньше не был скачан и он не лежит на нашей файловой системе вот дальше создается виртуальная машина и мы уже можем к ней обращаться по ssh специально никаких опрокидываний сокитов или еще каких-то вот интерфейсов между хостом и машина и виртуальной машиной у нас здесь не делается не производится работа исключительно с виртуалками через то есть на этапе вмл ран у нас также генерируется с ключей для работы с этой виртуальной машиной и с помощью клауденит Они инжектится во внутрь виртуальной машины соответственно клаудений должен отработать этот Саша ключ вложить в нужное место чтобы мы уже могли виртуальной машины Ну а дальше мы уже внутри виртуальной машины можем производить любые действия Сначала с помощью Рута мы по ssh подключаемся в эту виртуальную машину иду устанавливаем все что нам необходимо например компиляторы Rust gcc А дальше от простого пользователя Мы заходим уже не привилегированным пользователям в эту виртуальную машину копируем исходные тексты нашего проекта и запускаем сборку с помощью Rust по факту последняя команда Карго Билд это и есть сборка проекта на то есть самые простые команды которые доступны у нас для использования своим мылем Они как раз немножко и похожи на докер интерфейс то есть доступные образы можно посмотреть запустить какую-то виртуальную машину причем есть полезные опции такие как вот подождать что внутри виртуальной машины запустится ssh это бывает очень полезно именно при написании скриптов когда мы используем каких-то системах для запуска тестов Чтобы дождаться доступности и уже переходить на следующий этап работы Ну и чтобы попасть во внутрь виртуальной машины Это вмл ssh здесь это уже настройка получается не над кем у а над Саша где мы с Саша рассказываем Какие ключи нужно взять чтобы подключиться к этой виртуальной машине с чем работает а с чем работает здесь нарисованы логотипы дистрибутивов которые доступны для работы в качестве гостевых машин это CentOS Ubuntu Fedora суть дебен арч совсем недавно ребята из проекта Арчи сани случайно там не случайно нашли наш проект добавили поддержку мы не знали просто где у Арчи лежат облачные дистрибутивы прислали нам мешали квесты были приняты без проблем Почему две иконки Linux и Базальт потому что один это базовый образ Облачный сделали на основе скажем так комьюнити дистрибутива альцлеанукс а второй Базальт он еще особенный тем что в нем встроена графическая оболочка то есть с полемати Да это не совсем подход Облачный запускать графику где-то в облаках но иногда нужно что-то проверить Какие какие-то задачи и с графическим интерфейсом а по факту получилось что решая одну задачу это тестирование самого Cloud имеет тестирование интеграции клауденит в наших дистрибутив Alt мы создавая инструмент для быстрой работы и локальной чтобы нам не требовалось пересылать никуда большие объемы данных тут же изготовили дистрибутив тут же у себя его проверили и тестировали добавив поддержку облачных образов других дистрибутивов мы получили инструмент который быстро позволяет получить виртуальную машину с любым наиболее популярным дистрибутивом и Горизонт использования и применения программы сразу же и немножко изменился и увеличился решали скажем так одну задачу решили для себя несколько больше задач мы сейчас всегда можем довольно быстро и оперативно посмотреть как же это сделано например федоре какие-то механизмы работы Для этого нам не нужно долго и муторно устанавливать виртуальную машину одна команда в eml Run Федора такой-то версии и после скачивания облачного образа у нас запускается виртуальная машина Итак Казалось бы все а чуть не забыл Но это то что касается Что работает что поддерживается внутри виртуальных машин что же того где На каких кастовых операционных системах может работать в ML он на самом деле может работать Везде где будет достаточно версии роста чтобы его собрать из компилировать мы первоначально ориентировались на наш стабильный дистрибутив индекс десятой версии соответственно старались все новые релизы выпускать чтобы он собирался на нашем стабильном баранче вот совсем не очень давно у нас в стабильном раньше обновился раз с версии 1.59 на 161 соответственно нам уже нет смысла держать совместимость со старым растом и он тоже будет поддерживать сборку в ближайшее время только уже на 161 соответственно если в дебене слишком старый раз то скорее всего собрать вмл на дебине не получится и использовать его там тоже не получится здесь понятно да Казалось бы все хорошо но есть маленькая проблема и как всегда проблемы эти связанные с сетью все что я вам до этого рассказывал относилась рассказывала про то что мы изначально пытались добиться чтобы вмл работал от простого пользователя без повышения привилегий без рутовых привилегий то есть по сути для того чтобы запустить запустить виртуальную машину нам не нужны рутовые привилегии если нам нужна поддержка КВН аппаратной виртуализации нам достаточно чтобы был просто доступ Где в КВН для запуска виртуальной машины но если мы используем в простых сценариях и для сети у нас используется именно настройки Тап Network или юзер Нетворк то никаких проблем нет кем у даже умеет настраивать эту сеть и включать snad и у нас Мы можем ходить из этих виртуалок обращаться в интернет или в нашу локальную сеть никаких проблем но как только мы захотим несколько виртуальных машин объединить в какую-то одну сеть Где нам потребуются какие-то бриджи мосты или какие-то виртуальные сущности для объединения виртуальных машин вот здесь сразу же начинаются проблемы потому что нужны рутовые привилегии на данный момент каких-то специализированных хелперов или еще чего-то мы не писали у нас не написано потому что даже в том же тему есть отдельные специализированные хелперы для создания каких-то сетевых интерфейсов которые именно запускается с уидным битом кажется что мы запускаем простого пользователя но некоторые подсистемы запускаются все-таки от рута вручную же сеть в принципе не сложно настроить нужно снаружи создать бриджи разрешить некоторые Ну разрешить форвардинг на уровне гидро добавить в эти бриджи интерфейсы и включить Если нужен маскараде вот это что касается сети дальше какие еще возможности есть при использовании vml Ну в первую очередь это то что для него написан динамики инвентаре для ансибула но имея динамики инвентаре мы можем Со всеми нашими создаваемыми виртуальными машинами с помощью ансе было делать все что угодно пишем либо PlayBook либо команды Анси был и запускаем на наших виртуальных машинах то есть на примере как мы используем например billbot запускается Ну пара виртуальных машин одна из них мастер другая worker в дальнейшем с помощью плейбука настраиваются обе эти виртуальные машины и мы получаем работающую систему continuouse следующие Киллер фича вмл это групповое управление виртуальными машинами на основе префиксов имена нашим виртуальным машинам мы можем задавать в виде структурированной как файловой системе имена файлов и каталогов После этого мы можем разными уровнями вот этой вот структуры одновременно запускать какие-то команды на уровне всех этих виртуальных машин которые в эту группу входят Ну для примера У нас есть виртуальные машины с губернатором k8s слеш 12345 одной командой ВМС стоп к8s мы остановим всю пачку этих виртуальных машин еще один из вариантов использования как я уже говорил мы используем Это теперь для тестирования и в системах Ci в своих не только для тестирования клауденит но и например для тестирования губернатос который тоже самостоятельно собираем из общедоступных исходников одной командой а одной командой создаем мастер с указанием сети шлюза несколькими другими командами создаем множество вычислительных нот нашего кластера губернатос и практически одной командой вмсш к8 с Note мы заставляем выполнить команду на всех вычислительных нондах а именно при джонниц вычислительные ноты к нашему мастеру После этого мы получаем некоторые кластер губернанс на котором можем произвести опять различные тесты необходимые нам по месту и по завершении работы одной командой вмл стоп к8s мы можем всю эту группу виртуальных машин остановить При желании также и удалить на этом моя презентация заканчивается Спасибо Спасибо большое друзья так для наших онлайн слушателей я напомню что у нас есть чат Если вы в чат напишете буковки то я эти буковки озвучу постараюсь во всяком случае и из этих буковок может сложиться вопросы которые тоже может быть ответят из тех кто у нас в зале третий ряд практически Да спасибо за доклад такой вопрос я правильно понял что из зависимости в email требуется только тему и все Ну и там Понятно естественно Нет ему нужно тему и ssh потому что он работает с ними все остальное обвязка она написана на Расте в библиотеками и всё обычно компилируется на Расте статический и в один э бинарный файл хорошо А тогда такой вопрос А почему не липвирт то есть можно было бы кажется использовать либид и соответственно отвязаться от интерфейса сейчас холивар начнется смотрите у нас не было задачи тестировать множество различных вот этих вот подсистем виртуализации управления сетями и хранения и прочее нам надо это было первоначально протестировать что мы изготовили образ Облачный что в нем работает клауденит Соответственно по большому счету нам нужно сгенерировать некоторые виртуальный образ его подложить виртуалки чтобы она загрузилась и мы увидели что все наши настройки принялись и заработали и вот в этом вот случае городить надстройку с либертами и еще с чем-то выглядело несколько масштабнее глобальнее и дороже Да просто Но применительно к сети например было бы гораздо проще там либертом понятное дело вот в простых вариантах нам хватает встроенных возможностей тему Я же как уже сказал кем он даже сам умеет натить поэтому для простых вариантов каких-то вот тестирования его хватает для того чтобы сделать уже какие-то комплексные большие системы при тестировании Ну можно и грудь снаружи небольшой скрипцией описать пока в будущем возможно что мы сделаем что-то и для настройки сети но это уже получается уже что-то делать с уидным файлом А у нас в компании очень плохо относится к программам свои длинными правами Хорошо понял спасибо там чуть дальше тоже был вопрос Это ряд раз спасибо доклад А есть ли какие-то примеры какие-то кейсы где то уже используются То есть вы говорите у вас компании а может быть спрошу а может быть это еще пример Но потому что ну вот со стороны первый раз познакомился выглядит масса решение от условно там на башах что-то написать то какой-нибудь перегруженного плейбука и еще варианты где это используется и почему выбрали именно такое решение Спасибо я знаю что это пока только у нас используется и где-то вот со стороны никаких отзывов не слышал у нас это реально используется регулярно при тестировании наших образов облачных в первую очередь Во вторую это у нас сейчас действительно билд на котором идут задания на изготовление самих образов э-э и iso-образов и образов облачных э облачко образов они идут через billbot который запущен внутри вмл с помощью vml ни внутри конечно с помощью vml и также вот эти примеры с тестированием губернация Это тоже не придуманный ради презентации э пример мы его точно так же на Живую себя Тестируем для проверки там того же кабернетизации потому что быстро можем получить э-э нужное количество виртуалок настроенных образов Лёш спасибо Вот у нас даже вопросы за онлайна есть у хаши корб есть такой инструмент под названием пакер вот наш слушательница Анастасии спрашивает А почему бы не использовать пакер И в чем преимущество моей относительно пакера смотрите если не ошибаюсь пакер У нас занимается тем что берет Некоторые из образ какого-то дистрибутива и превращает его с помощью вопросов и ответов виртуальную машину Ну может использовать он запускает этот образ прогоняет их и потом делает из образа первичного плюс скрипты целевой образ вот этот уже сказал что с одной стороны мы можем использовать Да но согласитесь то что у него получилось на выходе если мы это готовим регулярно в виде как производитель актива Мне все равно это хотелось бы все проверить что у меня получилось на выходе Я думаю Здесь вопрос заключался в том что пакер если в процессе исполнения скриптов возникла ошибка он не даст создать целевой образ Почему ошибки же тоже разные бывают Да и поэтому Ну будет там А если у нас без ошибки все получилось и образ создался это же ещё не означает что у нас клауденит корректно отработает внутри виртуальные машины совсем недавно вот новые версии клаудинит у нас отказались работать потому что не хватало файлика клауденит конфиг нет рок-менеджер всё сам Клауд и не был в системе а не заработало потому что не хватало какого-то конфигурационного файла поэтому Ну это один из моментов что пакер так готовит но всё равно может тестировать второй момент почему Хмм я заострил внимание что наши инструменты которыми мы готовим и словообраза они сами сразу же тоже позволяют делать образы виртуа машин и нам не нужно использовать пакер который по сути перепаковывает одну сущность в другую Когда мы можем сразу же изготовить эту нужную нам сущности в виде виртуальной машины но они оба этих варианта не отменяют необходимости все протестировать тут дальше достаточно провокационные вопросы с чата А в мл готов к Промышленной эксплуатации Я с одной стороны как бы готов к этому вопросу пошла Потому что Да С одной стороны Это можно сказать проект одного человека с другой стороны Этот человек ближайшее время от нас уходить никуда не собирается и собирается продолжать работать батарея тяжелая которую он прикован следующий момент проект открытый свободный расположен на гитхаб можно брать использовать модифицировать дописывать присылать свои изменения и ответил если если кто-то захочет использовать в email для Промышленной эксплуатации разработчика основной maint-тейнер будет очень рад да Он будет рад мы как бы ограничений в этом смысле не видим если будет какой-то положительный фидбэк продолжение А можно ли на vml развернуть и затем массово обновлять кластер виртуальных машин обновлять э В каком смысле вот у тебя был первый образ версия одна да там потом что-то произошло появилась вторая версия а обычно даже в облаках принято что вот эти все облачные образы они обычно либо под каким-то новым именем создаются и мы когда виртуалку создаем то мы либо там старую удаляем новую создаем ее на новом образе вот мы здесь как бы Пока что ничего специального не придумывали то есть рассчитывайте что это тоже просто надстройка над кем и никаких Вот таких специальных механизмов здесь не задумано для работы с образами принято в зале вот здесь с первого ряда был еще вопрос потом я так понимаю там еще сзади с первого ряда начнём Алексей спасибо за доклад Скажите пожалуйста несколько несколько раз вы упоминали что вы запускаете там тесты на целевых виртуалках вот можно несколько слов о том что вы там тестируете всегда ли это один профиль тестового и Если там нагрузочное что-то то есть если проявляете ли вы интересно то есть насколько вы тестирует там стрессоустойчивость или просто функциональные тест вот скорее всего именно на тесты связанные функциональные тесты в первую очередь на соответствие того что образ этот Облачный действительно Облачный образ что в нем не залетел каким-то способом какой-то пользователь с именем и паролем Да что у нас не появился бэкдор грубо говоря в этом облачном э-э образе А дальше тестируется именно как настроилась сеть какой подсистемой то есть вот именно такие Ну только доступность да да потому что как я уже сказал у нас вольтах поддерживаются почти все подсистемы настройки сети и даже чуть больше и вполне возможно вариант что мы рассчитывали что нас сеть настроиться одним способом а тут невзначай по какой-то зависимости залетела под система Да нет вроде и настроилась через неё словами мы проверяем что это образ Облачный То есть он может загрузиться и какие-то базовые секируйте правила еще какие-то вопросы друзья у нас традиция нужно выбрать за лучший вопрос человека который задал лучше вопрос можно онлайн можно офлайн и соответственно Этот человек получит небольшой подарок Я бы предложил вот самого смирного первого человека который занят тот кто задавал нам самый первый вопрос третий ряд посередине Спасибо большое Лёша мы тебе благодарны за то что ты пришел за то что нам рассказал интересную очень тему поделился с нами интересным решением от лица организаторов тебе небольшие памятные подарки чтобы ты на них смотрел и захотел ещё раз к нам приходить рассказывать интересные темы Спасибо тебе большое друзья если хотите пообщаться с Алексеем дискуссионной зоне"
}