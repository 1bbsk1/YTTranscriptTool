{
  "video_id": "Qj0YRyKFIic",
  "channel": "HighLoadChannel",
  "title": "Тестируем инфраструктуру как код / Игорь Курочкин (Express 42)",
  "views": 441,
  "duration": 2029,
  "published": "2017-07-30T00:47:36-07:00",
  "text": "а мы продолжаем подкрепись я смотрю глаза горят на надо двигаться дальше сейчас будет доклад от компании экспрес 42 который мы все представляем я Игорь следующий наш докладчик У нас есть стенд где мы разыгрываем книжку проект Фекс первую книжку в России подходите можете выиграть и позадавать нам вопросы а у Игоря между тем очень крутой доклад по теме которым мало кто у нас в России занимается это тестирование инфраструктуры как код А в принципе инфраструктура как код у нас редко где внедрена а тестирование это прям совсем совсем совсем а для нас мейнстрим поприветствуем Игоря потому что в этом деле он собаку съел а Спасибо Саш меня зовут Игорь Я работаю в компании экспресс 42 мы занимаемся эксплуатацией интернет-проектов до этого я работал в компании Квик которую купил компания Skype которую купил компания Microsoft А с системами управления конфигурацией Я работаю около 5 лет видел как маленькие так и большие репозитории сам их создавал поддерживал проводил аудит инфраструктурного кода А в основном я работал сше Но также активно слежу за и также Я активно использую комьюнити код и участвую в его разработке так сегодня мы поговорим про тестирование инфраструктуры про то какие есть для этого инструменты как эти инструменты автоматизировать и про наш опыт в тестировании А зачем вообще нужны тесты а-а когда когда инфраструктура становится кодом то хороший код должен лежать в системе контроля версий должен иметь документацию и должен быть покрыт тестами а тесты повышают качество вашего кода они дают обратную связь а также они за счёт автоматизации позволяют ускорить э написание кода и убрать ручную составляющую которая приводит к ошибкам а также выступают документацией А собственно для того чтобы не тестировать всё это на продакшене тесты и подходят и подходят А собственно когда это особенно актуально а тесты актуальны когда происходят изменения а изменения происходят всегда от этого никуда не уйти потому что выходят новые версии операционных систем выходят новые версии каких компонент и код который Вы написали он устаревает даже если вы делаете сами свои изменения редко например то вы уже забываете какую часть вы изменили и и к чему может привести изменения а также они актуальны когда изменения вносит несколько человек и вы уже не можете быть уверены что то что вы меняете не затронет какие-то другие компоненты а следующий момент когда у вас сложная логика сложная логика связана с развитием вы автоматизирует всё больше и больше больше частей и ваш инфраструктурный код становится сложным и вероятность ошибки ещё выше а также когда это чужой код который Вы не писали например Это коммьюнити код или код другой команды а Работая в Скайпе мы не тестировали инфраструктуру в виде тестов делали это вручную то есть Работая в Скайпе мы перевели инфраструктуру сн на deion с debon 6 на deion 7 И делали это всё вручную то есть прогоняли код в агран смотрели Что сломалось чинили а а когда я пришёл работать в экспрес 42 а мне передо мной ещё стояла задача очень быстро понять как работает код который уже написан то есть мы используем где-то около 6 кубков половина из них - Это комьюнити кбу половина самописный и передо мной стояла задача быстро понять Вообще что как работает наш код и как его быстро поменять как вообще понять как он работает а поэтому я покрыл его тестами и увидел что он работает не так как мы ожидали Аа и тесты Нам очень помогли А собственно к тестированию инфраструктурного кода пришли во всех системах управления конфигураций Но сначала надо определиться что мы будем тестировать тестировать мы будем те части из которых состоит инфраструктура То есть это базовые такие кбу модули роли или формулы которые скорее всего входят в какую-то общий набор который ставится на все ваши сервера и которые чаще всего не хотят трогать Ну потому что от них другие компоненты и их изменение может привести к большим проблемам Так а ну или Другими словами это как бы те части которые вы как инфраструктурные опции например отдаёте разработчикам для того чтобы они строили из этих компонентов Ну свои сервисы так а с тем что Тестируем мы определились Соответственно что мы будем проверять проверять мы будем стиль языка и написание кода функционал интеграцию и результат работы системы управления конфигурацией а для проверки стиля языка используются анализаторы кода популярные системы управления конфигурации написа на двух языках это и соотвественно в этих языках есть которые желательно им следовать для того чтобы ваш код был легко поддерживать и читать соответственно для ру ули называется руко для питона это соответственно что они делают они прогоняют ваш код по какому-то набору правил и выдают рекомендации как его исправить У них есть режим авто коррекции но его нужно использовать потому что он иногда может менять не так как нужно А ещё момент такой что руко он проверяет только RB файлы А например РБ шаблон он не трогает если у вас много логики именно в РБ шаблонах то она будет соответственно в другом стиле и рубоп с ним рубоп его не проверит А ну и соответственно Да если вы первый раз это запустите рубоп ну эти утилиты на своём коде то скорее всего они выдадут очень большой список того что нужно поменять часть вещей можно игнорировать и желательно понимать зачем вы это меняете со временем в системах управления конфигурации выработались свои подходы и появились утилиты для проверки именно стиля кода так называемые нте соответственно в каждой системе они свои в шеф это в пате этоже Нано которые можно дополнить или их можно игнорировать если какие-то вам не подходят Что можно про них сказать Да вроде наверное всё А функционал функционал проверяется с помощью так называемых фикстуры То есть это набор тестовых данных это какие-то входные переменные и ваш код соответственно в самом простом варианте это просто модуль или формула с параметрами по умолчанию в сложном варианте это различные вызовы ресурсов и соответственно чем у вас сложнее фикстуры тем соответственно больше результата вы сможете проверить А результат Ну следующий этап это интеграция кода то есть мы должны выполнить ваш код для этого существует как самый популярный инструмент - это Гран А все наверное про него знают а у него много плагинов Он позволяет запустить виртуальную машину и выполнить в нём ваш инфраструктурный код а Но с ним есть проблема тем что а файл не не очень подходит именно для тестирования То есть когда у Вас например несколько наборов тестов то файл становится не поддержим поэтому можно воспользоваться альтернативной ули Kit Она позволяет делать всё то же самое что и только ещ дополнительно вводит такое понятие как то есть набор тестов в котором вы можете всё это удобно написать в базовой поставке она поддерживает Шеф па она поддерживает через плагины эти плагины активно развиваются а для локального тестирования она может использовать do lxc Ну или то что всё предоставляет она есть драйверы для облачных провайдеров и она поддерживает Kitchen поддерживает несколько тестовых фреймворков в том числе и сервер СК о котором я сейчас расскажу а соответственно результат работы системы управления конфигурацией можно проверять с помощью вот такого тестового фреймворка сервер СК он предоставляет ресурсы для того чтобы проверить что пакет установился в систему что в конфигурации прилетели именно те строки которые вы задали то что сервис поднялся слушает поррт если этого недостаточно можно просто вызвать команду и проверить соответственно её вывод А серк - это отличная альтернатива для Баш скриптов Советую всем пользоваться а соответственно совсем недавно Шеф добавил сервер в рецепты это называется это очень удобная штука стала теперь потому что можно использовать например Шеф атрибуты в серве СК тестах и не копировать Ну как бы атрибуты ещё сек тесты в уже есть похожая штука используя модули СП Можно также проверять что возвращает команда и на основе этого делать дальше И вообще разработчики ла заявляют Что им не нужен какой-то отдельный тестовый фреймворк тесты можно прямо писать в ролях А собственно эти тесты можно запускать вручную можно запускать как-то автоматизировано Самое главное чтобы это было просто иначе Никто этим пользоваться не будет поэтому это лучше всего автоматизировать с помощью например системы я расскажу про trv C А ну и также как можно использовать другие C системы если например они у вас уже используются в компании собственно Travis C trv C - это C система для github проектов а она бесплатна для открытых проектов она соответственно позволяет а при любом действии с вашим кодом запустить какой Ну запустите запустить тест Например если вы что-то за котили или вам прислали а она подходит также для тестирования инфраструктурного кода а но у ней есть небольшие ограничения это то что окружение построено на операционной системе бунта 1204 Поэтому если у вас используется другой дистрибутив то вы не сможете его протестировать а также в окружении есть предустановленный пакет и переменные окружения которые соответственно Ну не будут соответствовать ше окружению И это всё может привести к проблемам а выход из этого использует два инструмента то есть использовать Test Kitchen и Travis C а соответственно а Travis C именно будет отвечать за интеграцию с хабом и запускать используя Test Kitchen виртуальную машину в каком-то облачном хостинге например Amazon или Digital Ocean а если у вас уже используется ваша си система соответственно Вы можете сделать всё на ней также используя Test Kitchen для того чтобы запускать виртуальные машины запускать тесты А собственно когда мы всё это протестировали в се системе для того чтобы всё выкатывать инфраструктурный код в Production в каждой системе есть свои механизмы для того чтобы прогнать этот код и посмотреть что он собирается менять без реальных изменений это так называемый Dr в это режим Check и это что ещё как ещё повысить качество тестирования один из вариантов - это ревю кода Мы в э 42 не используем тако СТ когда обязательно нужно получить изменения для того чтобы вть вобще эта штука очень хорошая и позволяет выработать какие-то одинаковые практики и подходы и обсудить вообще написание кода в вашей команде например А и ещё один из вариантов - это выложить его в Open Source То есть когда вы выкладываете какой-то компонент в Open Source развитие не останавливается Если это конечно хороший компонент То есть если вы выложили какой-то простой КБК или модуль он конечно же никому не будет интересен а для того чтобы выкладывать делиться кодом кажы каждая Компания разработала свою платформу в шеф это платформа супермаркет в пате Forge Galaxy и form каждый из этих платформ имеет свои достоинства и недостатки например в супермаркете есть проблема с именовани кубков должен иметь уникальное имя стандартные имена уже заняты и приходится выкручиваться и придумывать какое-то новое название также в супермаркета и в Forge нужно самим алоди кбу и это приводит к тому что часто есть рассинхронизация между репозиторием сда и тем что находится в платформе для коммьюнити есть платформа Отт проблем с именовани нету также там есть опросник Но им как-то не особо активно пользуется поэтому понять что это хороше или плохая роль сложно Ну можно например понять это по количеству загрузок а formul только появилась и это не представляет из себя просто репозиторий на гитхабе так собственно выкладывая код в Open Source не забываем удалить приватную информацию то есть ключи пароли название каких-то внутренних компонентов а также не забываем добавить тесты статус сборки потому что это повышает Доверие к нашему коду и а будет больше тогда его использовать а не забываем про историю изменений документацию причём сейчас документацию например для шеф кбу ков можно генерить автоматически а есть для этого плагин для нафа который позволяет там на основе атрибутов ресурсов и провайдеров построить ми файл мы им ту позволяет всег держать актуальную документацию кбу также про совместимость и конфликты Если вы знаете то то это указываете и не забываем синхронизировать с платформой и указывать лицензию в Скайпе у нас была с этим проблема что мы не могли использовать сторонний кодд которого нези на основе наших Open sce кбв наш код выложен на гитхабе по любому изменению этого кода у нас запускается bu это может быть comit это может быть request дальше прогоняет OC critic дальше управление передаётся Test Kitchen который запускает виртуалку в Digital Ocean и выполняет на ней наш инфраструктурный код после этого прогоняю сете которые проверяют результат выполнения и если все тесты прошли у нас бы релиз то наш cookbook алоди в супермаркет и нам приходит нотификация в СК о том что Билд прошёл всё ок собственно выводы а тестируйте инфраструктуру автоматизируйте и делитесь сообществом АА на гитхабе У нас есть а примеры тестирования а также на хабра хабре мы запустили цикл статей по тестированию скоро выйдет следующая часть слушайте наш подкаст приходить на наши митапы так Готовьте вопросы за тот вопрос который я не смогу ответить Я подарю книжку собственно Всё спасибо большое заклад книшка у меня уже есть рекомендую кстати всем Вопрос немножко может быть из другого поля но тоже про тестирование как бы функциональное тестирование - Это хорошо понятно в принципе Какое делать примерно хотя бы а что делать с такими вопросами как например перфоманс тестирования Я не говорю там полноценного Как там на продакшене понятно что это фантастика некая а скажем хотя бы минимально то что я там сделал Като сервер стал работать в три раза медленнее это в принципе тесты ВС проходит всё всё вроде Ок зелёное Но это же фейл есть ли какие-то инструменты для этого и то же самое для например Security тестирования то есть какая-то дыра появилась тесты все хорошо функционал работает но это как бы плохо что вот в этим в этом направлении куда копать Ну для этого тоже как бы используются C системы есть э просто инструменты которые позволяют тебе сделать и перф тестирования и сети тестирования а пример инструментов можно какие-нибудь об на скидку или т я не знаю Я наверное так сразу не назову ну как бы это в принципе можно просто встроить в процесс какой-то сборки там например после того как мы прогнали сервер спек тесты Мы ещё например гоняем тесты на производительность Ну используя инструменты которые встроены в софт то есть гоняем какие-то Ну именно перформанс тесты хорошо спасибо Здравствуйте А у меня такой вопрос Как проводить тестирование тех инфраструктурных например рецептов чифе которые затрагивают конфигурацию привязанную к железу конфигурацию там модуле ядра управляющих сетевой картой например на варган нельзя ну там нет соответственно нужного железа Вот как это можно сделать не имея сервера не имея сервера то есть как-то его эмулировать Не ну просто Можно например Это выполнять на железном сервере и всё Ну хорошо но очень тяжело выделять целый железный сервер под тестирование инфраструктуры Не ну если вам нужно его тестировать Значит его нужно выделять Я не думаю что здесь какие-то могут быть проблемы Ну понятно Я просто думал может есть какие-то инструменты которые могут эмулировать хотя бы похожие вещи или может можно как-нибудь протестировать поведение скрипта Я с такими вещами не сталкивался но например в Скайпе мы попадали что мы тестировали вот обновление как раз с deb 6 на deb 7 После того как мы и всё как бы на виртуальных машинах у нас всё было отлично Всё здорово А вот уже когда начали делать всё это на железном сервере то там уже начались проблемы например с загрузчиком с грабом были проблемы у нас сервак всё прошло то есть как бы наш инфраструктурный код был отрон в виртуальных машинах А на железном сервере к тому что сервер просто не загрузился что всё равно нужно тестировать это на максимально приближенно окружение к тому что вам нужно Угу Ладно спасибо спасибо за доклад Вот вы сделали обзор рассказали про разные системы конфигурации какой на ваш взгляд разные система конфигурации плюсы и минусы Чем отличается и какие системы конфигурации В каких случаях стоит использовать сравнени ши вос Ну это как бы можно сказать даже тема отдельного доклада но в принципе наверно подход следующий что если вы пишете на Руби то скорее всего если ваша команда разработчиков пишет на Руби Да и вы будете им поставлять ваш инфраструктурный код то скорее всего они захотят его видеть на том же языке на котором они его разрабатывают То есть если у вас в команде используется ru то скорее всего это будет Шеф или пат если пишут люди на питоне то они вообще не захотят трогать никакие ру поделки и будут использовать именно питонов скую систему это как бы один из вариантов А в принципе все системы управления конфигурации сейчас идут в одном направлении то есть и в шефе например появился вот этот Шеф DK development Kit в пате совсем недавно они это анонсировали у них тоже самое появилось а про тестирования в каждой системе есть свои инструменты есть свои механизмы для того чтобы выполнять например Dry Run есть свои площадки для обмена комьюнити кодом То есть в принципе они сейчас уже все очень похожи и это только вопрос Ну именно личных предпочтений и предпочтений команды то есть и например знаете Вы больше Ruby или Python как-то так А в принципе все инструменты похожи в каждой системе есть своё коммьюнити которое эти уже инструменты например написала и поддерживает вот это skit то что классно его начали использовать не только То есть он начался именно с шефа потом написали к нему модуль и потом уже и и такой хороший появился инструмент для всего для всех систем там вопрос в конце здравствуйте Компания Поти техноло у меня такой вопрос мы используем па для описания машин сборщиков и разработчики хотят видеть соответственно эти описания Какой ваш совет или рекомендация у нас проблема с тем что нам приходится подкладывать вручную всякие ключи пароли вручную прописывать Как объединить что разработчики видят конфигурацию но при этом тоже автоматизировать процесс э подкладывать СЖ ключей и всяческих паролей Спасибо А ну наверное для хранение пароля вот совсем недавно же вышла вот эта утилита от хаши корпа Volt Да она вроде называется а Никита Да вот она наверно Попробуйте её Я думаю это Отличный вариант а-а либо можно использовать э какие-то механизмы которые например там chef Vol тоже именно для хранения а приватных данных Аа ещё я забыл сказать что например супермаркет можно поставить локально Аа если например вы большая компания не знаю там уровня Фейсбука Яндекса э или mail.ru то вы можете поставить эту платформу для обмена инфраструктурным кодом именно чтобы внутри компании Ну как бы видели ваши ваш инфраструктурный код и его использовали Там вопрос есть ли у вас опыт тестирование системы состоящей из нескольких микросервисов такого интеграционного сквозного взаимодействия этих микросервисов Ну вот про что равал это именно тестирование вот отдельного кирпичика То есть это без учёта там именно сетевого взаимодействия А так в принципе например как мы в Скайпе Это тестировали А у нас было несколько окружений соответственно в prq окружения всё выкатывать Разработчики А вот в Q Production это уже всё выкатывать админы и когда мы выкатывать на Q окружение мы как раз учились на этом окружении понимали что нам нужно сделать для того чтобы это всё выкатить в продакшн поэтому наверное как вариант это использовать несколько окружений а автоматического Ну через Jin там с поднятием нескольких сервисов настройки их друг на друга и запус тесто Ну можно да это сделать И на дженкинс Ну как бы то есть что Вы хотите именно здесь поймать именно какой-то в принципе это же можно сделать всё на на уровне одной виртуальной машины просто туда поставить пачку компонентов они все поднимутся и будут слушать просто разные порты то есть точно ли нужно вам тестировать на нескольких машинах Вот в чём вопрос потому что всё равно например это будет отличаться от при и прок окружение и какие ошибки вы там найдёте непонятно а такой ещё вопрос Вы сказали что вы пережили с помощью тестов переход между разными дистрибутива между версиями и вот собственно возникает вопрос Как вы писали те что вы тестировали с одной стороны чтобы не все тесты сразу же развалились при этом и Но с другой стороны чтобы именно ловить то что действительно нужно Ну потому что мне кажется это какая-то чёрная магия А ну смотрите что что что тестировать при этом Вы рекомендуете что Я рекомендую тестировать Нет я говорил что мы как раз тесты не использовали когда переходили там с одного дистрибутива на другой То есть это делали всё вручную Ну то есть просто готовили новое новое окружение с новым с но операционной систе прогоняли на ней наш инфраструктурный код соответственно всё Что сломалось то что мы визуально смогли определить там или зайти на виртуалку руками потестить мы это поняли но часть вещей всплыла уже потом только например на продакшене собственно что тестировать но наверное только Вы лучше знаете что тестировать зависит от вашего кода Ну то что например компонент поставился что он запущен что он возвращает какой-то статус код то что рации прилетели те параметры которые вы действительно хотели то что поднялось несколько инстан сов То есть если например у вас в шефе используется какой-то сложный РП то соответственно все варианты вызова этого РП а также ещё могут быть проблемы Например если вы просто обновляет с шефа одиннадцатого на Шеф двенадцатый то у вас тоже результат работы инфраструктурного кода может отличаться Ну то есть вот э правильно сгенерирован конфиг запущен ли сервис так далее по что у вас ещё может например быть логика в РБ шаблонах и из-за этого могут быть проблемы То есть в итоге в конфиг прилетит какое-то другое значение Но это как бы всё зависит от задачи которая Перед вами стоит тесты вам могут помочь и именно с переходом с одного дистрибутива на другой они могут вам помочь если вы хотите вообще понять Как работает ваш код и также он помогает Например если вы передаёте проект какой-то другой команде Вот например в Скайпе перед закрытием офиса отдавали наш проект другой команде осов и прямо было видно их нежелание трогать наш код Ну потому что не было тестов и они не знали к чему приведёт это изменение они увидели первый раз Добрый день Меня зовут Сева Я здесь Ага у меня есть вопрос Скажите как вы ну вы как-то тестирует допустим откаты кбу ков на предыдущие версии То есть если это допустим не ресурс кбу которые там допустим ставят mysql jav там что угодно а именно кбу которые на них основаны допустим выкатывают на сервер env разворачивают Там должна быть Java должно быть то сё и потом Ну и это естественно связано с какой-то версией апликейшн потом версия алике откатывается и соответственно надо откатить иб предыдущему состоянию чтобы предыдущее допустим там бы меньше верси или что-то такое чтобы было одинаково Вот вы как-то это тестирует мы это не Тестируем пока просто таких не было задач перед нами но в принципе да это как бы Хорошая идея именно тестировать ещё и ЛК в тестах Фло и вот у одной был фу именно из-за того что нельзя версионирование обратно и тут такие Ну много нюансов есть достаточно такая объёмная штука как-то допустим там через версию откатывать назад это как раз Ну то что можно было бы очень хорошо покрыть тестами сэкономила бы кучу времени и сил Да я согласен ещё вопросы вот здесь спрашивает в первом ряду А спасибо за доклад у меня мысль назрела А можно ли на сегодняшний день скрестить сервер СК с использованием тест кина и аут modde шефа Ну то есть чтобы скажем в локальном конфигурации текина заполье при тестировании атрибуты Ну в принципе то есть как бы не пробовали так использовать Нет ну audit Mode это же есть как фактически замена сервер спека а это как бы и мы говорим там о продакшене или то есть локально то есть запускаем делаем прогон тест именно тестовых условиях на там на одной машине и чтобы не писать хардко дом там какие у нас будут пути а именно заполье те атрибуты из клобуков то есть в пределах одной машины потому что audit Mod - это как бы некий такой обсервер который смотрит снаружи на Ну то как и сейчас Шеф по-моему представляет то есть вопрос именно Можно ли использовать серс пеки Шеф атрибуты Как звучит А Да можно там есть пример гитхабе как сделано А сейчас я вспомню а просто в Шеф рецепте идёт импорт атрибутов J File А потом когда запускается сервер СК он соответственно импортирует их уже у себя в тестах Угу спасибо такая там система Ну соответственно не очень э может быть красивая но р работает да всё вопросов больше нет А тогда можно меня ловить в кулуарах задавать вопросы"
}