{
  "video_id": "avzByboOoAA",
  "channel": "HighLoadChannel",
  "title": "Прожарка архитектурных кейсов",
  "views": 1617,
  "duration": 6140,
  "published": "2024-04-17T01:10:25-07:00",
  "text": "и я передаю слово тоже сотрудницы ВК Лида видел жаль Спасибо большое Рома Давайте поблагодарим Рома аплодисментами за блестящий зал который был у нас здесь Спасибо большое дорогие гости полный зал Аншлаг это так трепетно так нервно так чудесно но я знаю что вы здесь Разумеется для того чтобы немножко разогреться сегодня в Петербурге прошел дождь наверняка все немного замерзли и ждет нас чуть-чуть огня в ближайшие полтора почти два часа Мы будем развлекать вас с помощью нескольких смельчаков Итак добро пожаловать на прожарку кейсов в рамках тарака архитектура хайлот и ВК Давайте поаплодируем мы собрали для вас разносторонние доклады об архитектуре высоконаруженных проектов и добавили немножечко практики знаете вот так вот соль на локоть наши потрясающие эксперты которых я вам через минутку представлю будут прожаривать четыре прекрасных проекта разберут их буквально по косточкам Не волнуйтесь мы стараемся придерживаться вот этих вот концепций согласия и внимание мы будем делать все заботливо в первую очередь наши участники согласились быть прожаренными так что А мы их тоже всячески поддерживаем мы поблагодарим мы придумали этот формат вместе с программным комитетом хайла вот плюс и его задача не в том чтобы кого-то обидеть раскрыть подход или э Не дай Бог разочаровать нет идея в той самой передаче опыт опыта Мы хотим чтобы эксперты своего дела поделились где-то болезненными историями где-то тем был интересный опыт где-то Тем где они могут предусмотреть Что может пойти не так И разумеется дать такую вот интересную обратную связь нашим спикерам Ну а вы дорогие зрители тоже не оставайтесь в стороне в первую очередь Зайдите Разумеется в единственном и неповторимый чат нашего синего третьего зала если у вас появится вопросы Пожалуйста задавайте их там я их э немножко цензурирую И после этого постараюсь вежливо э-э спросить или передать э нашим презентам Какой формат вас ожидает в течение 5 минут мы будем слушать тот самый бич архитектуры это имена архитектура там не будет написанного кода но Мы надеемся что там будет достаточно развёрнутой подготовленная повествование проекте после чего в течение ещё 5 минут наш неповторимый ореопаг э даст обратную связь делится своими мыслями задаст несколько камерных вопросов и после этого я перейду э к вопросам от вас небольшое напоминание и для наших спикеров и для вас конечно мы будем очень строго следить за таймингом Как вы понимаете строгость это наше имя тайминги это все пожалуйста мы будем стараться вместе с вами критиковать или хвалить кейсы не людей пожалуйста проявите внимательность и такую вот какую-то Солидарность вежливость профессиональную наличность мы Не переходим Ну и не стесняемся выражать свои мысли у нас тут не защита дипломных работ которые иногда снится в июне вам по ночам Э всё-таки мы стараемся сделать так чтобы это было весело Ну что ж я думаю что более чем достаточно Давайте поприветствуем аплодисментами наших потрясающих поваров на сегодня Знакомьтесь Сергей Михалев директор дата платформ ВК Аплодисменты Серёжа Евгений кузов аплодисменты аплодисменты руководитель отдела в Яндекс Маркете Алексей Лосев Браво и модератор нашей экспертной прожарки шеф-повар сегодняшнего вечера для кого-то известной как Владимир пилиперица для нас Разумеется монсандерсон архитектор Тарантула ивака Клаус Тор ещё аплодисменты Ну что все Мне кажется весело прекрасную приятную увлекательно Все ли вы открыли чат Если вы еще не открыли чат сделаете это сейчас времени отвлекаться на это у вас конечно не будет а я очень рада пригласить на сцену Наш первый кейс и кейс который во многом Мне кажется подходит для нашей сегодняшней прожарки э всех любезных ребят справа от меня и возможно меня вы знаете как вежливых профессиональных людей которые часто рассказывают вам про что-то технический классное технически важное но внутри у нас у всех иногда и сегодня вечером бывает что-то другое мы сегодня дадим волю тому что на самом деле и первый кейс У нас тоже такой снаружи не совсем то же самое что кажется внутри первый кейс озаглавлен как асинхрон от которого хотели синхронность и рада пригласить на сцену Николая шипикова ведущего разработчиков в тень кофе и члена программного комитета подлодка Java Crew аплодисменты микрофон сейчас тебе передаст наш потрясающий хелпер У меня есть классное введение к твоей презентации и звучит он так коротко про кейс я цитирую видишь асинхрон нет а он есть Я надеюсь что сегодня-то нам покажет что-нибудь интересное передаю тебе кликер и твои пять минут начинается прямо сейчас кнопочку вам может показаться что теперь время пошло бегите в этот за продуктами что меня можно было Не кидаться погнали сейчас покажется видишь слайды да А их нет подождем не переживайте мы умеем контролировать время прошу Всем спасибо Давайте сразу кейсу собственно какое-то время назад два с небольшим мне удалось работать над частью системы которая в принципе кажется выглядит довольно стандартно спасибо Вот то есть некий Он входит в наш сервис хочешь хоть наш сервис синхронно Все как всегда сервис тоже вроде бы Довольно простой он ходит почти в другой какой-то сервис получает данные синхронно и дальше идет другой сервис уже асинхронно То есть он закидывает в топе карте запрос Ну и через какое-то время должен получить ответ из другого топика как бы вроде бы это все умеем только трава в том что закинуть мы с одного инстанса ответ может прийти в другой Да и вообще как бы вроде квест обрабатывается одним потоком вычитается вообще хрен знает друзья что делать Ну сделай в лоб то есть взяли базу читать некие инстанс кидает в базу другой instance в цикле while бесконечно бегать бегает бегает Ну естественно тайм-аутом выдирает Ну и отдают наружу Окей протестировали функционально Все ок дальше дали небольшой нагрузку и ну как бы всё развалилось Ну тут надо дать два нюанса первый немножко себя оправдаю я там не совсем участвовал в первом решении Хотя я знал про него а второй нюанс что когда развалилась Проблема была конечно не в этом Там просто не очень корректно сконфигурили полы потоков но как бы уже разбираться начали захотелось сделать красиво собственно что не нравилось база данных тут кажется вообще не нужна Когда в целом у нее тут роль как бы шины только вот Окей значит нам это не нравится должны избавиться от базы данных как бы ну лишних точка отказа Ну и вообще нужно Ну и как бы не круто что запрос блокируется потому что вроде как мы должны ой поток блокируется потому что вроде как мы должны экономить А тут Что делаем бегаем просто по циклу проверяем О'кей давайте избавимся от этого ну надо сказать несколько ограничений первое то что мы не могли отказаться от синхронного похода к нам почти ну потому что как бы это API оно как бы не такой поворотливое как мы ну и плюс тот сервис который делался он как бы был ну заменителем ну предыдущей версии то есть уже был некий контракт и как бы нельзя было так взять просто переделать плюс время было ограничено то есть временно разработку Ну и Да надо сказать что нагрузка на тот момент была не очень большая Там меньше 100 FPS но потенциально она могла там ну в будущем даже не могла должна была расти Окей должны избавиться от баз Давайте избавимся то есть собственно что хочется чтобы хотя бы тот инстанс который принял request он же Ну это квест от гитарея он же и принял э-э response о тосинхронного сервиса тут в лоб было Ну два варианта это что-то пошаманить с ключами протекционирования чтобы ну вот собственно как-то так угадать И вот именно наш инстанс который request prival принял бы response от асинхронного сервиса или сделать в лоб Пусть все инстансы читают все вот Ну времени было мало как бы второй вариант и выбрали как это сделать можно просто каждому инсту отдать свой группа и все нормально Тут наверное чуть оговориться что пайловоды были небольшие в принципе супер страшно Ничего не было Окей это сделать И другой момент это инстанс у нас Прочитал но все равно у нас остаётся что есть трек который как бы висит и ждет ответа и трек который собственно читает за эти ответы вот мы блокируется то есть первое что сделал это у нас было блокирующее перешли на корутины там всё со спины добавили всё как надо О'кей Но надо еще как-то умудриться прокинуть с читающего это помогло то что на тот момент довольно активно пиарили такую штуку как котенфу там шарит Flow вот эта вся история поэтому как бы вжух и это хорошо сработало то есть делаем Flow с одной стороны по сути шина получилась с одной стороны закидываем это вот эмит с другой стороны там фильтр Fine First и как бы готово Ну как бы все то есть Профит все это дело заработало в нужное время вроде даже какую-то нагрузку держала Ну конечно да осталось немножко в душе Вот скрести по сердцу что кафку использовали Ну не совсем по назначению в целом Господа присяжные Давайте жгите рубите Давайте поддержим Давайте поддержим Коли аплодисментами Давайте поддержим аплодисментами сережами халява который очень опытный спикер Но кажется не смог Включить микрофон но сейчас обязательно поделится своими впечатлениями в качестве небольшого спойлера ребята видели раньше схемы архитектуры этих проектов Так что мы готовим сейчасное слово можно открутить на схемку потому что я-то её помню что можно на первоначально назад назад назад ты вперёд крутишь назад назад назад назад там где Ну вот ещё на самый первый допустим смотрите ребята на самом деле что сделали у них была первоначальная схема они сразу поняли что что-то здесь не так и решили убрать пост да типа зачем Затем чтобы ну что они хотели чтобы попроще система была да и чтобы как бы поменьше звеньев в нём было Ну и казалось что-то неправильно Ну что они сделали они после этого из каждого потока стали читать полностью весь топе с ответами то есть они явно пожертвовали производительностью в этот момент то есть они такие будет чуть попроще понадежнее но наверное помедленнее Что это значит они Значит тяжело сейчас сказать сколько у них там РПС они говорили 100 но они уже сразу заметили что у них не хватает производительности и по факту сделали на мой вкус еще менее производительную систему потому что они из каждого потока читали весь топик и сказки вот я-то человек который поднимал руку как человек который любит кафку и поэтому меня это больше всего зацепило то есть в случае если у них Читающий поток падает они это топик Непонятно какое в нём ретеншен был хоть с самого начала вы никак не сделать что здесь минимум можно было сделать Да они могли бы хотя бы читать нужную им птицу Значит у меня флопает микрофон да то есть они могли протекционировать по ключу хотя бы свои квесты или спонсор И хотя бы читать нужную импортицию тогда им нужно было читать но там не знаю какую-то часть из ихнего топика они весь топик но и это даже не все что они могли сделать на самом деле не сказал что их часть которую они могли менять это по факту синенькие квадратики а вот все что оранжевое это типа не к ним Да поэтому они не могут трогать топики на выходе и они не могут трогать ipi А синенький квадратиках реально не так много квадратиков можно выбросить и они выбросили тот который Пациенту смотри тут вопрос Они не могут А почему Ну то есть вот этот всегда то есть Сделай шаг назад пошел там убил кого-нибудь и там типа ну блин Давайте напишем вот такую шляпу А ты представляешь как это дебажить сейчас Коля уволится вот доку не напишет И все будут попадают ответы инстанслят вот этот вот который инстанс один что там кто это А я знаю что произойдет произойдет ровно то же самое с чего Коля начал свой рассказ там была какая-то прошлая версия кода но мы если честно не знаем Чья она и что там было мы не разбирались поэтому мы Ну взвешенная архитектурное решение Давайте честно скажем типа будет чуть легче Я думаю потому что одной системки будет поменьше но я вот последнее что хочу сказать архитектура частенько является следствием оргструктуры в компании все с этим сталкивались ну как бы по-другому не то есть вот здесь типа команда справа отвечала за топики и вот эти риквесты команда слева и Коля за по центру и типа самое сложное в архитектуре это потом пойти вот к этим чувакам справа и сказать и чуваки Напишите нам сразу ответ нам в кафку не нужно синхронную вход для нашего сервиса микрофон выключается подключается можно так Это мой микрофон уже да Все конечно А мне отбиваться можно от вас или Конечно давай просто между собой Так это общаетесь и во-первых как бы проблем-то была Я же сказал она была не в том что там что-то там проблема была просто там плыв Фигово именно к базе данных Там они не в базе к этому к первому сервису были плохо с конфигурированы То есть тут дело не в этом вот по поводу Кафки Да вы правы Но вот по поводу Кафки Вы правы Да но опять-таки из этого положения как ну вот как вот в конце было никто не мешает перейти к работе с ключами и в принципе учитывая что это было сделано в короткий срок то Ну мне кажется Ну Лайт что ещё я хотел отбиться от чего по поводу жёстко забиты гвоздями Хмм слева Тут прямо вот жёстко жёстко потому что это прямо такой бизнес-совый бизнес-сол и монструозный там имеешь в виду говоришь вот то есть ну как бы я и как там этот сервис и предъядеры работал и при бати и при мне и при моих Ну как будет работать поэтому как бы я сейчас всем помогает а я говорю батя помогает сейчас всем да лучше батя только дед да вот и вот да по поводу постгресса Вы правы Вот но опять-таки Ну в смысле с правой части сказать Китай в погреce это Да вы правы но во-первых опять-таки время как бы наверное странно было бы там и давайте ребята прошвырнитесь там нам тут не нравится сделали вот наверное вот такие мои насколько критичные сервисы Что будет если сервис перестанет работать Ну как бы этот ну вот лык которому делает Да она напрямую отвечала за то сколько денег Ну приходит то есть это прямо такая бизнес слова логика насколько я помню там по заведению новых продуктов для пользователей Ну я думаю если бы неделю бы это не работало то но погоди ведь это значит что это существенно важный ключевой можно сказать продукт архитектура которого Вполне может получить чуть больше ресурсов Ну и ребята справа так сказать наверняка будут рады пойти навстречу Ну раз такая Ключевая история Да в будущем а получилось к ним сходить до начала проектирования по крайней мере если нет почему Я честно говоря уже не очень помню вообще если так вот положа руку на сердце мне есть ощущение что этими ребятами справа были тоже мы вот Ну на самом деле тут проблема была во времени в первую очередь вот поэтому не ну потратили какое-то время чтобы подползлился все-таки избавиться и перейти на чтение Кафки То есть это как бы ну всё-таки надо что-то коде поменять но еще с собой очень тяжело договориться всегда нужен какой-то компромисс между собственным временем и собственным временем что ты тот самый дед который всё это построил Ну да как в том этом анекдоте типа что за мы неплохо попали в очередную мысль вселенную в которой мы с вами и синенький и оранжевый Но кажется что это достаточно вообще рекомендация надеюсь что мы и дальше убедимся что ребята всё-таки знают кто у них и ключевой потребитель и ключевой клиент запросами было бы Полезно и интересно а слева там и все остальные а там какой-то силой был на скорость Почему собственно говоря проблема что медленно отвечают Не ну Проблема была изначально просто как бы медленно и медленно какие проблемы если там нет сл Ну ответили Мы за 10 грустить что ему типа там и я хочу там какой-то товар там давайте А мне там не отвечают что На держи пользователям быстрее Хочется вот смотрите вот вы там хотите на концерт вопрос-то какой был секунды или что там ну там по-моему что-то секунд 30 секунд Но если свои 30 секунд Ну кажется по скорости ответа потому что действительно кавкаем это на одной сериализации там что-то типа статус что-то такое уж большая была новый микрофон не там худший насколько я понимаю как раз когда что-то произошло не так вы потеряли свои сеты и пожалуйста прочитайте с самого начала Кафки до конца потому что по-другому никак Ну да каждый релиз убивает систему ну и вопрос как тебе кажется Ну вы вроде разобрались с этой частью синие квадратики Мы префакторили кажется следующей в очереди оранжевые замечательно Какие еще к тебе могут прийти изменения требования что-нибудь новое и Ну чтобы Ты пожелал уже как бы с твоим сейчас опытом тем кто придет переписывает соседнюю компоненту потом потому что мне кажется что здесь у вас получается немножко Круговая порукая мы не можем это менять потому что это безумие фиксировано мы не можем это менять потому что там какой-то Lego City код но впереди же светлое будущее пожелал Главное чтобы работала хорошо А уж как этого добьёмся это неважно Главное чтобы процесс крутится Главное чтобы так было договорились Ну что ж на этой оптимистичной ноте давайте мы поблагодарим Николая за такой интересный формат проекта Николаев за смелость достаются наши фирменные мягкие игрушки Аплодисменты Давайте проводим его со сцены и пока у нас готовится следующий спикер давайте мы попробуем чуть лучше узнать наш потрясающий ареопаг например мне очень в целом нравится истории про то как оно было и как оно потом стало как реальный мир так сказать смотрит в глаза нашему оптимистичному прошлому Мона Расскажи пожалуйста Давай представим себе что мы можем всего лишь на минуту буквально символов на 100 в сообщении текстовом перенестись куда-нибудь лет на 10 назад У тебя много опыта интересных жесть фиктурных проектов какой бы очень короткое сообщение ты хотела передать тебе в прошлое чтобы спасти себя от каких-нибудь архитектурных непредвиденных последствий э-э надо было наверное оставаться в админах они идти в безопасности Разумеется Мы собирали наши несомненное Поварской коллектив конечно в первую очередь благодаря опыту Расскажи какой-нибудь историю самая трагическое или может быть маленькая но нежное Воспоминание из истории про безопасность системе одного очень большого вендора которая стоит каких-то совершенно безумных денег и которые проблема всех этих больших систем заключается в том что не погуглить чё там сломалось Вот и собственно тут на самом деле конечно очень пригодился весь богатый жизненный опыт весь опыт так сказать лоу-лэвел дибага начиная с операционки заканчивая кодом Вот это было неприятненько это была истерика это были это было где-то лет наверное восемь назад Да 14-15 год с тех пор у вендора лежит несколько статей КБ которая написала я они естественно сделали очень хорошую скидку на следующий год и я их очень долго и счастливо полоскала мои же конференции Ну что же хотите стать желанным гостем на конференции крупных Не бойтесь сталкиваться с некоторыми нюансами их продуктов после этого неплохая скидка и приглашение и просят не хакать их продукты но мы тогда не будем говорить Из скольки букв состоит название а соответствующего вендора Спасибо большое моноаплодисменты а я очень рада пригласить на сцену наших вторых гостей это будет целая команда команда молодая команда на мой взгляд очень перспективная и здесь я хочу ещё и ну как бы так сказать Рассказать вам о мотивации по которой мы подбирали команды для прожарки Мы очень рады что мы получили достаточно много идей Спасибо всем кто подавался но нам кажется что разнообразие взглядов очень важно не только среди поваров но и среди наших э Простите блюд э Сейчас мы посмотрим на проект очень Молодёжный это проект от нескольких студентов МФТИ и я приглашаю нас цену а Владимир Смирнова Елизавета не ледову и а Карину коноплёву а в каком-то те они к нам сейчас присоединятся у нас сцене а которые расскажут о своем экзаменационном проекте по курсу проектирования высоко нагруженных систем И что самое интересное на мой взгляд это курс который ведет лично Олег Бунин давайте мы поаплодируем ему нам с вами предстоит уникальная возможность оценить как же Олег в качестве преподавателя кнопочка вперед прошу и у вас сейчас будет 5 минут на то чтобы рассказать нашим зрителям и конечно нашему жюри Нет это не защита дипломной работы расслабьтесь пожалуйста глубоко дышите про реалтаем мониторинг самолётов проектирование сервиса мониторинга самолётов в реальном времени Ну что ваши 5 минут начинается прямо сейчас вперёд Да всем привет вот туда на самом деле Да всем привет еще раз наше вступление немножко украли Давайте повторим мы действительно студенты и сегодня мы будем обсуждать с вами проектирование сервиса мониторинга самолета в режиме реального времени а-а и Да это действительно был наш экзаменационный проект по курсу проектирования загруженных приложений Да итак перед нами стояла задача спроектировать сервис под следующую нагрузку ежедневно совершается примерно 120 тысяч перелетов около 15 тысяч самолетов находится одновременно в небе в любой момент времени и каждый летящий самолет раз секунду отправляет один блок данных своей информации о себе этот блок размером 1 килобайт содержится например его положение самолета положения скорость направления и так далее эти сигналы попадают на приемники коих 20 тысяч по всему миру это с одной стороны с другой стороны от клиентов мы имеем 3 миллиона rps и в Пике это значение может увеличиваться до 10 миллионов запросы от пользователей бывают трех видов во-первых клиент может поинтересоваться историей перелетов конкретного порта Но это запрос самый редкий и его доля в общем числе крайне мало более-менее популярный запрос это Посмотреть информацию о каком-то из текущем полетов и самые популярные запрос необходимость адресовывать самолеты в каких-то регионах то есть в регионах здесь сейчас находится экран а перейдем непосредственно к нашему решению и рассказ о нем я начну с данных во-первых мы разделили карту на квадраты 100 на 100 метров 100 на 100 километров пронумеровали эти квадраты и по каждому ID квадрата мы храним список самолетов которые в данный момент находятся в данной зоне затем У нас есть база текущих полетов То есть это то что прямо сейчас в небе там мы по ID полета храним массив точек в которых находился самолет То есть это широта долгота скорость и конкретное время затем Аналогично У нас есть архив в котором хранятся те же полеты но уже которые закончили свой путь И также у нас есть статические данные о самолетах То есть это картинка с тем как он выглядит странная регистрации эти данные не меняются и мы их вынесли в отдельную таблицу которая размещена в себе что касается сигнала с приемника то они пересылаются на наши агрегаторы сигналов где объединяются в Бачи конвертируются там в запросы на обновление баз и кладутся в очередь откуда извлекаются оркеры и исполняются Да и от клиентов у нас есть два самых популярных типа запро са по определенной зоне Покажи мне все самолеты которые в ней находятся для того чтобы исполнить этот запрос Значит мы отправляем запрос на фронт фронт берет трон понимает Какие квадраты ему нужны то есть какие квадраты находятся в этой зоне и берет их из кша всегда берет их из США кэш нужно обновлять примерно одну секунду и второй тип запроса это Покажи мне информацию о самолете то есть в частности Покажи всю историю полета самолета самого начала Вот для этого нам нужно сходить в базу с текущими полетами и справочник это все мы будем рады ответить на вопрос супер Давайте поддержим ребята аплодисментами я еще раз Напоминаю что наших потрясающих зрителей То есть у вас не только в оффлайне но и в онлайне есть возможность задавать вопросы и пытаться присоединяться к нашей прожарке так вот интерактивно Не стесняйтесь пожалуйста писать их в чат А я тем временем Хочу задать попросить Женю россинского поделиться своими впечатлениями Потому что Женя Если вы например не знаете является автором магистерской программы в Майи знает что-то про авиацию наверное не понаслышке магистерская программа правда про менеджеров войти Так что я не знаю там самолёты у вас полетел или не полетело в бауманском халтурил Вот Но это прекрасный ВУЗ но про самолёт ничего не знаю ты хочешь чтобы я рассказал что я об этом думаю пожалуйста блин на самом деле ребята такие котятки я слушаю прям прям так классно Вот и в общем ну действительно защита дипломного проекта Вот потому что на дипломах спрашивают всякие глупости да то есть половина Преподаватель не понимает О чем вы говорите Вот и я надеюсь что здесь будет немножко по-другому И если мы говорим про такую супер нагруженную систему она должна быть супер нагружена здесь нужно предусмотреть что будет если любой из элементов системы скажет кря Вот давайте пофантазируем а что будет если например сам Ну Плохая шутка вот Выбирай какой квадратик у нас откажет первым квадратике окажется ты Вот то есть Давайте подумаем у вас что-то У вас есть идея который может крякнуть у вас Бэкон который может крякнуть Кафка с воркерами Вот давайте просто быстренько пробежимся что мы будем делать будем ли мы обслуживать пользователей или нет предлагаю начать цдена Ну кажется что обслуживать пользователей в любом случае нужно Пусть какое-то деградации кажется что если отказывать ленту нужно сходить сам справочник возможно и квадраты лежат какой-то справочник он бежит мы вынесли туда только статику под статикой мы понимаем информацию о самолетах например модель самолета то есть в справочнике лежит только Интер информация Обычно я то есть квадраты вот я выделил на карте кусочек квадрата который в него попадают вы все равно напрямую в back идете а на самом деле мы хотим смотрите у нас 3 миллиона rps это очень много если мы возьмем Все размеры всех квадратов то это получится там единицы мегабайт и в нашей голове Мы кладем то есть мы это всегда кладем на фронт в кэш То есть она очень маленькая эта карта и хорошо подложить я не про карту я вот расположение самолетов У вас есть Три квадрата в этих трех квадратах условно 150 самолетов вот мне чтобы отрисовать новое положение самолетов придется в бэкать или в cdn на фронт еще раз фронт во Франции они хранятся в каше и они обновляются раз в секунду через напрямую Напрямую из вас по сути дела Только картинки отвалится при отказе сидеяны да Главное чтобы не отвалилась информация рейсах потому что мы как на бэкенде храним их все закодированы а потом переводим таким образом Как вы пользователю показываете что это за рейс если отвалится фотка с самолетом не трагедия ладно А если отвалится информация о том как называется город отправление город прибытия дискомфорт может быть заметным Ну вот эта информация о том откуда и куда летит самолет она по клику на самолет появляется то есть если самолет пропадет мы не сможем на него кликнуть и кажется не смотрим не сможем посмотреть на то Куда он летит В принципе и сломали получается сломалось не если из сидена не придёт ответ по самолёту и справочников в принципе можно через век дойти до этой таблицы она же у нас существует не только в сиденье Она своя отдельная скорее всего это какое-то отдельное приложение Да ну я не могу на самом деле не спросить вопрос как человек с двумя истребителями на спине и неудавшийся военный летчик мне пришлось идти в безопасности собственно приемники сами сами приемники если мы говорим про мониторинг Ну про историю мониторинга текущие Да там тоже самое FlightRadar да у них свои вот эти вот приёмники разбросаны А из каких источников вы планируете это брать и А что будет если например э какой-то приёмник не ответит А в нужное время на самом деле всё абсолютно Аналогично приёмники тоже свои и сигналы от самолётов они приходят сразу на несколько приёмников в среднем на три Поэтому если какой-то отваливается то ничего страшного не происходит правильный ответ держи конфетку мы заботимся о нашей гостях обычно думаете обязательно Присоединяйтесь в следующий раз божественные вопросы с чата Между прочим я собиралась его задать но артю нет не Артем господину Филипп решил задать его раньше прямоугольники это прекрасно вы как сферическую планету но прямоугольники делить собрались это как бы что за прикол но у нас Вы только не говорите что Земля плоская пожалуйста пожалуйста Земля не плоская договорились но карта же каким-то образом плоская если карту положить то но Глобус он разворачивается в карту и точно так же карту как плоскую уже можно поделить на квадраты условно интересным образом вы подробительно кучу квадратов зону около полюсов которые самолёты ну честно из моего личного опыта летают не очень часто так что Вполне возможно сбалансировать здесь немножко ситуацию вполне можно чуть более интеллектуальным разбиением на сектора К тому же чем ближе мы к экватору тем Ну как-то больше у нас в самолётиков кажется что для вас это тоже позволит неплохо сбалансировать происходящее как разбили так разбили квадраты не квадраты меньше Но в целом вся база вся точнее хранилище квадратами Оно занимает очень мало места поэтому по-настоящему мы немножко там разобрали историю когда у нас идёт равномерная нагрузка на периодически у нас получается ситуация когда Мы все дружно и в пять чем на какой-нибудь самолётик вокруг какого-нибудь острова в юго-восточной Азии или там не знаю отслеживаем перелётами между Москвой и Петербургом сторонах бортов вот э Хмм и в этом случае по факту у нас нагрузка-то она профиль нагрузки немножко иной Получается что все наши 300 сколько там миллионов РПЦ и в 5:00 один самолётик и вот тут вот кажется что могут быть проблемы будут кэшироваться поэтому пользователя вот поэтому был наймём что почему бы это не класть в CD Ну сколько там самолёт пролетит за минуту особенно на карте мира Ну раз в минуту положили в сети давайте без ограничений по нагрузке из того же самого CD справедливо Спасибо большое у нас есть еще несколько вопросов что меня тоже пару вопросиков мне вот на картинке но реально я по сторонам Хочу пройтись вы рассматривали в каких стражах вы будете чтоб хранить но я только по прокавку понял архив текущий полеты справочник это вот где хранится это хранится в разных базах У нас вот карта она очень маленькая ее можно в принципе сделать и Memory базой вот архив у нас наоборот он просто громадный такой огромное количество данных самолётов и ты можешь сделать просто каким-то хранилищем которое будет там шортировано по ID самолёта вот потом текущие полёты Это что-то вроде то есть что по идее полета у нас хранится массив точек И мы можем сразу быстро пойти полеты достать весь путь а вы считали сколько примерно вот Ну ты говоришь что у тебя в киевеле сколько там данных будет Вот 200 мегабайт где это вообще типа очень мало на самом деле типа Какую можно предложить базу чтобы у вас Киева или там все поместилось или или нужно ли вам там какая-нибудь прям крутая Киева либо может что-то попроще использовать нам Главное чтобы по Play ID сразу выдавался ответ но чтобы не собирать это из таблички там куча записей вот поэтому мы выбирали Киеве О'кей предложишь А какую-нибудь сестра Если вы поддерживаете выбор Напишите в чат Напишите пожалуйста в чат подходит на самом деле справочник Это что такое еще разочек для меня справочник это тоже это небольшая таблица Где хранятся данные про конкретный борт самолёт то есть там типа номер это можно в принципе или в таблице сделать в один почему бы Один в Один в один звучит не очень Почему Да ладно нормально Там же сколько у вас там мегабайт ребят на флешку получить метров ну реально но если этот один radies умрет Ну да а такти два поддерживать нужно так архив опыт куда кладем архив это что-то большое какой-нибудь стране умножаем на 300 в год у нас только текущий полеты это 200 Гб вот в этом архив Это сколько там средняя средняя длина полёта Ну текущие полёта четыре часа и в сутки у нас их Сколько сразу получается а 120 тысяч полетов ЕС Но 4 часа и плюс на 60 на 60 где-то одна строка это килобайт Ну в общем очень много не очень много но это только за один день но флайтер радар не один день будет существовать чтобы архитектуру правильно построить нужно как минимум знать сколько тебе данных хранить чтобы какой источник выбрать потому что ну это на мой вкус там все равно мало данных ну типа до 5 ТБ Получается примерно так что этом спокойно может быть и какой-нибудь лицом к вы держите не надо там что-то городить сложно Ладно до пяти терабайты что-что пекитерабайт можно и вы на моему так Это сложнее это сложнеева 5 ТБ Это недорого на самом деле там пять тачек Ну ладно шесть это не слышите они вас что-то плохого учат 5 ТБ вообще типа не проблема а прототип вот этого предлагаемого решения там условный mvp вы уже делали честно и реализацией всё-таки именно с точки зрения нагрузки с точки зрения проверки этой самой гипотезы есть очень большая разница очень много мест может отказать очень много мест могут работать не так как мы от них поэтому я надеюсь увидеть ваш прототип в реальной жизни поняли идем разрабатывать ребят На самом деле вы крутые Молодцы Спасибо понятно что здесь любых кейсах микрофончик понятно что во всех кейсах у нас очереди и Многие знают что я люблю очередь доклады читаю вот дай ему микрофон пожалуйста хорошо другое дело Давайте поаплодируем отлично отказу устойчивость по количеству микрофонов достигнуто значит здесь есть интересный момент обычно очередь используют тогда когда нужно обеспечить сохранность данных какой-то компонент отказал мы Потом довезли но в Real Time системах вот эта очередь она будет скорее вредить то есть нужно выстраивать как минимум два потока один поток который будет возможно с потерями отправлять данные на карту а другой поток который будет складывать это все в архив Потому что если мы сравним например с трансляцией видео мы трогаем те кадры которые нам были нужны две секунды назад потому что нам нужно смотреть текущие то же самое с самолетами Если наша очередь за если воркеры начнут отставать и не успевать разгребать у нас карта будет сильным отставанием Ну не только не только карта это правда очереди Нужно настраивать по-другому то есть одна должна быть оперативная другая историческая или сразу в базу писать Я не понял Я предлагаю в одну отправлять данные с тайм-аутом если они не долетели за несколько секунд они больше не нужны короче он хочет архив и он Демон растащить по углам что очень здорово а лучше текстом в чатик и мы обязательно поможем потому что мы чудесно использовали все микрофоны и мы хотим чтобы вас тоже было слышно в трансляции есть хороший короткий вопрос в чате Спасибо за короткие вопросы Скажите пожалуйста на чем реализовали геофизинг разделение по вот этим штучкам координаты самолета на квадратики Так мы же говорили что пока это только это будет просто там три Ифа или это будет какой-то справочник еще один поиск в каком как по координате найти квадратик но если мы сделаем простое разделение без всяких оптимизаций что полюсов большие то это просто как бы мод и взять и всё супер условно там диване решили что ифы должны быть четыре потому что прямоугольник а-а хорошо справедливо А спасибо большое Давайте мы поблагодарим ещё раз всю потрясающую смелую команду из МФТИ ещё раз напомню Владимир Смирнов Елизавета неледова и Карина коноплёва ребятам достаются мягкие игрушки не только конфетка под Ваши аплодисменты Давайте проводим обратно в зал А я продолжу развлекать нас травматичными историями из детства на наших неповторимых Сомелье Скажите пожалуйста Кому бы кому бы задать Следующий вопрос давай я Женю российского спрошу Скажи пожалуйста смотри как люди на вопросах встали и повалили никому про нас ничего не интересно давай мне главное интересно и я продолжу всех здесь развлекать пока у нас готовится Спасибо большое следующее выступление а-а Скажи пожалуйста был ли у тебя какой-нибудь такой момент на работе Когда вы особенно активно спорили по поводу архитектуры вот прямо прямо спорили и кто в итоге оказался прав постоянно и всегда правы разные люди Вот ну как правило Нет ну слушай а по-хорошему вот есть одно как бы Золотое правило ситио Кто делает тот и отвечает Ну потому что и у меня может быть 10.000 мнений уже не может быть 10.000 мнений Но если ты его не продал кому-то Вот и человек с тобой не заодно то в общем твоя архитектура в любом случае будет полное и никуда не полетит справедливо Сережа тот же вопрос для тебя Насколько часто и ожесточенно у вас происходят в дату платформе споры об архитектуре и кто обычно оказывается прав или ты директор поэтому как-то скажешь так и будет не не я как раз считаю что окружающие меня люди чаще умнее менять Ну то есть умнее меня и моя задача просто типа выбирать и слушать принимать какие-то решения но я очень согласен с твоим ответом Если ты не продал свою архитектуру не доказал какими-то аргументами значит всё ты проиграл Поэтому в принципе постараемся постоянно спорить то есть если у нас нет споров значит скорее всего что-то точно не так договорились я ожидаю что теперь мы в чате увидим больше споров по поводу архитектуры потому что мы переходим к кейсу номер три номер три будет представлять Руслан Сафин технический директор и архитектор бандит авторы преподаватель курса по микросервисной архитектуре в Челябинском государственном университете и вот так что я ожидаю чего-нибудь невероятно интересного Давайте поприветствуем Руслана аплодисменты но требования у нас будут к тебе точно такие же как и к студентам Перед тобой у тебя будет пять минут с того момента как мы перейдем на первый слайд твоей части презентации перейдем на первый слайд презентации сейчас мы не только микрофоны все за отказы устойчивые мной наш любимый кликер Давайте дадим ему еще минуточку Расскажи в паре слов о себе о своем проекте С чего оно начиналось И зачем ты вообще прекрасная Представила Спасибо немножко даже засмущало так всё крекер заработал Я думаю перейдём сразу и тут её да про проект и расскажу Итак я расскажу про сам кейс это приемка товаров на складах то есть приезжают фуры их нужно быстро очень принять разгрузить и отсканировать паллеты вообще понять что К нам приехал То есть как это выглядит приезжают Да водитель у него есть какие-то бумажные заказы система Тоже эти заказы заранее знает и потом администратор раздает конкретные задачи уже специалистам которые ходят тсдэшкой со сканером до сканирует штрих-коды все хорошо Как это в жизни приходит бывает вот Нижняя картинка приезжает фура Там миллион лет миллион штрих-кодов ничего не понятно какой полета К какому заказу какому поставщику относится вообще не ясно А что-то ещё так поштучно накидано да то есть вообще бесполезно без каких-то контейнеров Итак контекст бизнес логика достаточно сложная да то есть там от того кто это привез какой поставщик какой тип поставки То есть это там какая-то прокси поставка или конечная поставка зависит то как нужно будет принимать то есть что пересчитывать насколько доверять этим штрих-кодам и так далее либо вообще поштучно пересчитать требования бизнес-процессы так как сложные они должны быть bpm движке то есть они быть должны быть визуализированы для бизнеса Примерно 15 интеграции с ландшафтом Enterprise ландшафтом нашего заказчика Ну да и это кастомное решение то есть не коробочные решения под определенного заказчика час простоя стоит миллионов рублей Ну то есть если у вас все склады все объекты там сортировочные центры стоят по всей стране а bpmn вот таких вот схем примерно 40 да то есть тут вот ну несколько схем объединены в одно да то есть просто наглядно действительно развесистая логика собственно архитектура зачем мы тут собрались так как bpment у нас в центре стоит комода как регистратор и бизнес-процессов и распределенных транзакций мы спроектировали разделение на две мастер-системы это мастер система по задачам и мастер система по собственному документам Почему так была гипотеза что документы это внешний контур То есть у них зона видимости внешняя документы приходят на вход документы как накладные потом мы с ними что-то делаем актуализируем смотрим Что на самом деле приехало по этому документу что не приехала и отдаем результаты на выход это вот две Кафки на входе Да и две Кафки одна на вход другая на выход и есть отдельная мастерская система по задачам то есть задачи Это что-то в нашем внутреннее чтобы вашатинка абсуляцию Мы выносим в отдельный контур задача никому вовне не интересно то есть эта задача Вот именно на сканирование на пересчет на проверку на брак и так далее только внутри контура также у нас 15 внешних интеграции поэтому очень важно спроектировать правильно accel level то есть антикоррапшнему для каждой интеграции Ну примерно 10 сервисов Да адаптеров на 15 интеграции Вот они стоят по периметру чтобы внутрь периметр не затаскивать всякие костыли внешних систем Ну и общение через фронт идет через BF теперь про проблемы сразу по архитектуре так как у нас команда асинхронная Вот первый доклад первый кейс про это был то есть мы что-то сканируем Да какую-то полету мы должны это провернуть через команду и ответить быстро пользователю то есть я могу эту полету сейчас Принимать или она вообще в другом заказе и так далее То есть мы в команде запускаем процесс что-то делает резервирует место на складе миллион всего и отвечает фронту то есть мы должны фронту ответить сокеты то есть какой-то пуш отправить это первая сложность Вот такая непрозрачность как из асинхронных сделать синхронность вторая проблема Это то что у нас как раз разведение на две мастер системы мы изначально думали что они будут независимы практически по факту нам постоянно приходится джоинить и задачи и документы инвойс накладные и так далее да то есть везде Ну очень часто приходится джойнить из двух баз Ну это это сложно так и третья проблема это состояние гонок да то есть часто бывает что несколько операторов одновременно разгружают фуру сканируют одни и те же ну не одни палеты из одного заказа и состояние гонки оно апдейте статус одного заказа это с одной стороны с другой стороны мы уже начинаем разгружать фуру и тут по этому заказу приходит апдейт из одной нескольких внешних систем в общем возникает параллельное обновление это дополни возможность одна и та же сущность обновляется из нескольких источников сейчас система запущена в нескольких странах да В каждой стране по несколько десятков объектов в России больше всего да на один экземпляр системы Примерно 100 rps пиках вообще на систему и 5 rps на на команду на запуск процессов команде в команде около пяти тысяч запущенных процессов Так давайте назад архитектуру Давайте поаплодируем Спасибо большое Мне нужно мне нужно уточнить у меня бытовой вопрос это 5 rps люди которые сканируют вот этой штучкой генерируют у вас 5 FPS живых людей Ну то есть объектов несколько десятков уже пять стран в одной стране запущен то есть в стране несколько десятков объектов Ну и Да там бывает что две три фуры одновременно приезжают один объект разгружаем уровень получается Неплохо неплохо аплодисменты вопросы в целом Странно что у нас тут диваны Не дымятся Потому что когда мы принимали этот кейс на обсуждение тут коллегам было немножко больно от слова команда коллегам хотел с обнять спикеры сказать дружище ничего все будет хорошо отдельный стол поэтому я пожалуй поэтому кейсы Иначе мы два года так друг друга успокаивали все хорошо Главное привыкнуть А какие средства масштабирования команды использовались использовались и штатные средства масштабирования кэширования и так далее и так далее и так далее а используются ли последняя версия которая дофига оптимизированная по части именно скорости выполнения синхронных запросов так версия команда используется Седьмая то есть на 8 мы не перешли которые уже по микросервисной архитектуре построены Да там есть проблемы с лицензиями в России восьмой версии 7 7 попроще так А промасштабирование то есть когда мы детские болячки все полечились системы Мы не упирались в быстродействие команды и так далее То есть вопрос масштабирования он был чтобы решить вопрос отказа устойчивости да то есть вспоминаем один из первых слайдов там час простоя всей страны несколько миллионов рублей для этого сейчас Мы переезжаем на мультикластер нескольких дата-центрах Да масштабирование команды выбрана самое простое то есть есть мастер-база с несколькими репликами и несколько экземпляров коммута которые как раз мультикластере в разных центрах запущены То есть самый простой вариант который Нас устраивает по быстродействию Хорошо тогда Следующий вопрос вытекающий из предыдущего А кто в проекте отвечает за оптимизацию процессов для того чтобы может быть они проходили более коротким путём это вот вопросы к проблеме что у нас несколько из нескольких источников могут обновляться одни и те же данные одни и те же Да действительно есть такая проблема мы пытаемся решить на уровне аналитики на уровне работы с операциями да то есть физикой То есть как физический процесс устроены на складе Там не только на складе на самом деле то есть Нам же данные приходят из документооборота из общения с поставщиками и так далее сложно конечно это сделать То есть мы сначала нафигачили кучу схем Да но не выработали абстрактное Общее решение уникальное которое потом кастомизировали бы допустим под каждого поставщика сейчас мы из-за этого немножко огребаем как я и сказал но я надеюсь мы к идем вот Да учитывая водную так сказать речь есть отдельно репозиторий тасков и репозиторий инвойсов Да и по сути обработка этого всего А для чего было вот это вот разнесение если так или иначе оно все с собой взаимодействует между собой ну была гипотеза что вот как раз документы их можно быть можно будет легко отчуждения вынести из нашего проекта да то есть в виде канонического объекта выставить документы они полезные большому Спектру систем в ландшафте А вот таски Ну задача это вот именно наша внутрянка то что интересно именно объект внутри склада но возможно это решение было И неверным вот с точки зрения скорости сложности разработки Ну и явно это добавило хрупкости архитектора построить всегда минимально сложную архитектуру которая выполняет функциональные требование Я когда смотрю на вот этот вот картинку виртуальные пользователи смотрю на эту картинку так вот здесь мне кажется вот вот Монолит вот здесь как минимум на уровне базы данных точно ничего бы не испортил А сегодня я ну на каких ли на каких сетапах был наких лекциях в трех ребята обсуждали что микросервисы это какая-то сложная концепция и так далее поэтому мне вот первое что бросается Я бы конечно в одну базу данных это объединял если одна и та же команда разрабатывает таски инвойс репозитории Это точно должно быть в одной какой-то Ну в одном куске кода и вот все остальные осели которые на самом деле не осилили Да понимаете это антикоракша вот там может быть тоже бы затаскивал внутрь но это уже отдельно вот базу данных точно бы как бы что это новый черный ни у кого не создалось ощущение что мы сначала вот на первом курсе на первой лекции Да тут мы заснули фигак поднимаем голову и там вот это вот схема что насколько отличается вот наша Волшебная Волшебный бизнес драматически да то есть отследим самолётики там типа что-то положим в кавку А тут хрен его туча складов Вот и пользователи которые там у него Галя у меня не проходит кот не бьётся звонят и пишут вот туда вот и вот э Я честно говоря снимаю шляпу перед вот подобными решениями потому что чувствуется что вы страдана потом и крови Конечно можно и запихнуть в одну базу Вот но уровень накала э я представляю себе и то что ты вообще вышел с этим докладом это круто Ну да не хочется где-то нам Катя 10 км пробка фур образовать А про базы данных Мне тоже есть комментарии то есть э-э изначально получилось что мы бизнес-логику реализовали видимо налито да то есть это Команда А база данных растащили то есть мы в одном проекте совместили разные стратегии подходят то есть в этом я вижу проблемы То есть нормально было бы если бы бизнес логику тоже разделили по нескольким сервисам и тогда Возможно у нас бы не было таких проблем но вот в одном проекте мы совместили разные стратегии и из-за этого видимо получились сложности или сейчас мы наблюдаем уникальную ситуацию когда прожариваем и прожаривается сам себя да да Ну знаешь сама критика прекрасно как тебе кажется тот факт что вы все-таки ушли на команду и вся бизнес-ланника у вас под одним крылом это какая-то Legacy история Это скорее ошибка проектирования это что-то что ты бы не стал делать если бы ты делал это заново Вот какие у тебя ощущения по этому поводу и я чувствую в чате тоже кому-то не очень любят Если честно я команду люблю То есть я не представляю пойдём запрограммировать Ну запрограммировать Это я могу там моя команда может это запрограммировать но как потом это объяснять бизнесу как это у себя в голове уместить если это там ни с кем капусе немножко большая да и плюс мы Ну кому-то на Что даёт ты прям онлайн Видишь как у тебя токены бегают То есть как у тебя ходит Ну вообще бизнес-процесс где у тебя сейчас там тысяча стоит заказов где там а полеты У тебя скопились и так далее Ну за это я кому-то очень люблю другая проблема что если бы мы сразу словили столько Ну если бы у нас был опыт да то было бы проще но за 3 года мы опыт накопили детские проблемы Пусть больно но и вылечили Ну сейчас я не хочу не посоветую своей команде заказчику отказываться от команды возможно невозможно точно Нужно бизнес-процессы схемы упростить Но полностью ракет команды скорее нет а я правильно понимаю что получается Ну вот весь свой бизнес прямо через кому-то мониторите да то есть прям вот здесь грузовики приехали вот тут разгрузились а вот тут чет Короче не прошло каждая коробочка каждая сковородочка Ну да то есть естественно есть графа нас графиками и так далее но когда тебе их недостаточно ты открываешь команду и смотришь где там ну где затык где там скопились и так далее ну и можно конкретный заказ конкретную фуру конкретную полету найти в команде где она сейчас и плюс посмотреть трейсинг А вот это кому Ну вот вот этим занимается Ну разработкой или если специально ребята которые прямо сидят и смотрят что вот эти вот точечки слева Хорошо двигаются вправо а есть команда поддержки но она естественно разделена там на l1-l4 то есть команды L3 L4 Ну L3 это отдельно выделено команда поддержки Она смотрит и решает простые инциденты если что-то сложное то подключает или четыре это уже разработчики Ну и вот и они смотрят команду все вопрос мне кажется простоватость чата поэтому я его конечно накручу посильнее Глеб спрашивает Возможно ли использование орфидметов вместо штрих-кодов для автоматизации приемки вопрос скорее в целом технологический я тут в магазине была там так круто там прямо в ценник вшитый орхидметка ты набираешь полную корзину значит покупок приходишь на кассу кидаешь всё сразу в пакет а они все пробиваются какие есть клёвые технологии в этом направлении Правда ли что автоматизация этих частей процесса Может в какой-то момент э ну драматические изменить профиль нагрузки на твой сервис и придётся всё переписывать Представьте себе что появится какая-нибудь клёвенький сканер фура въезжает во двор и рентгеном Господи прости сканирует разом все штрих-коды что делать-то будем придётся только одно один маленький элемент системы поменять то есть там где человек сканирует да это заменить на какие-то ворота это было бы скучно Нет проблема в том что у тебя очень сильно изменится профильная нагрузки как сейчас у тебя человек физически Ну знаешь два штрих-кода за секунду я думаю только старшие специалист по сканированию штрих-кодов отсканировать успеет а тут хопа и разум будет батчами такими всё приходить я думаю пока все склады перестраивают на вот такие ворота Мы в коде это гораздо быстрее сделаем плюс такой вот он жестокий реальный мир Давай ещё один момент непонятно что делать если какая-то такая метка слетела То есть сейчас штрих-кода нет мы просто распечатываем болваку набиваем заменяем если метка слетела Как понять что она слетела у тебя там 200 лет приехал 199 на самом деле 199 или с одной одна без метки приехала хороший и слишком какой-то реальный мировой чуть-чуть понакидываю Да последняя давай по-простому там коммунда это Java и Pass gress они на одной тачке на разных команду мы используем сейчас мы используем externatски то есть вокруг коммунда есть Рой микросервисов на ноде то есть мы не на Джаве да то есть это не стен талон Когда кому-то вместе с приложением джаволом до кому-то отдельно там нет никакого кода и скриптов есть вот эти вот хендлеры которые на not JS написанный получается Они обернуты оборачивают команду сама команда использует на каждой ноте стоит где-то получается так вот есть несколько Нотр для отказа устойчивости то есть одна нода команды у нее много делегатов то есть допустим Один делегат он как команда работает там внутренняя очередь на делегация шлет туда сообщение и он не знает кто из микросервисов нужны микросервис подхватывает обрабатывает и возвращает то есть Вокруг коммунда на самом деле вот там Много мелких микросервисов на ноги и кому-то по факту это сама одна или их много кому-то если не брать масштабирование то она одна сейчас одна и сейчас одна база данных сейчас логически одна для отказа устойчивость их несколько несколько экземпляров команды и мастер по агресса и там ну два точности Но для производительности они используются Мы в это не уперлись мы там ну детские проблемы вылечили и производительность Нас устраивает Окей хорошо если сгорит дата центр все будет хорошо если сгорит склад не очень Давайте поаплодируем Руслану Спасибо большое за выступление Каждый раз когда проектируете очередную систему думаете о том как она выглядит физически в реальном мире наш любимый пингвин тоже достается Руслану Давайте еще раз поаплодируем у меня осталось еще несколько вопросов моим любимым поварам вопрос первый в первую очередь прожарка какая лучше медиум-рыр или Medium Medium даже не Medium rare Как же так как же так Алексей Расскажи пожалуйста возвращаясь на телепорте в 10 лет назад что ты скажешь самому себе чтобы спасти себя от каких-то непредвиденных последствий своих архитектурных решений не обязательно непредвиденных в плохом смысле этого слова Я не предлагаю чинить трагедии но какой-то неожиданность вот 10 лет назад нет А вот если там 20 лет назад да я бы наверное Да учиматан очень хорошо звучит И на самом деле вот очень много вещей в том числе по архитектуре набил на собственном опыте а потом в какой-то момент я Открыл для себя Мир книг непереводных А вот тех которые вот там оригинальные Да там стандарты международные и с удивлением узнал что не надо изобретать велосипеды надо читать умных людей и вот если бы я этим начал заниматься 20 лет назад то у меня наверное бы там на спине вот дырок от пуль было бы чуть-чуть поменьше читайте хорошие книги Господа Монст есть у тебя какие-нибудь Воспоминания десятилетней давности о том что стоило бы сделать иначе не то что Воспоминание это скорее так бизнес-решение то есть на момент когда мы запускали наши три ВК было просто его сделать на перле Ну вот многие возможно я много сталкивался что-то можно просто сделать было 20 лет назад Подожди подожди сейчас В общем на тот момент это было очень просто и очень быстро мы его запустили просто за там месяц небольшим но в перспективе это было не очень удачное решение потому что как только я Прекратил учить перловиков они закончились Так подожди я стримы переписали уже ну в процессе а разработчики на Первом закончились гораздо раньше чем надежность разработанного продукта что ж бывает жалко ребят вообще если посмотреть на текущий ландшафт языков наверное на кошке Пользуясь случаем объявляю голосование раз против хаскиля время пошло Ну а я пока что приглашаю на сцену наш четвёртый финальный кейс на сегодня мы его очень смелого коллегу который повидал в жизни разного и расскажет Сейчас о том какой же опыт от этого приобрел Давайте поаплодируем Евгений баба разработчик из вкмаркета расскажет нам про такую классную вещь как архитектурный вынос магазина И сейчас я хочу чтобы мы Ну хотя бы немножечко вернулись обратно в мир э цифровой Нет мы не будем вам рассказывать про то как шоп-лифтить э-э магазин метками Нет будет не про это а в действительности внутри ВК есть очень много сущностей которые мы в разное время называли маркетами магазинами товарами услугами иногда и другими весельями расскажи нам за Ближайшие 5 минут чем же это в итоге закончилось как это выглядит в нашем Светлом будущем так Всем привет Меня зовут Евгений Сейчас расскажу в следующий кейс значит дано интернет-магазин в крупных социальной сети Вконтакте с большим количеством команд разработки бизнес функциональность и бизнес логика интернет-магазина находится внутри кодовой базе этой социальной сети архитектура выглядит текущая следующим образом у нас есть некоторые Монолит есть какой-то бэкенд и в этом бэкенде некоторые модули и соответственно модули ходят в какие-то хранилища Вот и соответственно архитектура выглядит вот таким образом а какие здесь есть проблемы ограниченность так технологий то есть мы ограничены теми технологиями которые на которых написано этот бэкенд много Лего сикода сложноебординг проект потому что проекту очень много времени и в нем очень много бизнес логики соответственно отсюда медленная разработка проблемы с ответственностью то есть так как очень много команд разработки очень сложно выяснять чей зоне ответственности данной модуль или код Ну и частые поломки так как Монолит большой выкатывается большое количество нового кода могут быть частые лббэки и сложно понимать Какой конкретно код произвел ошибку соответственно решение разделить именно данный модуль на несколько максимально независимых компонентов сервисов для построения вышеописанных проблем бизнес контекст еще раз повторю это интернет-магазин строится социальную сеть это marketplace продавцы могут создавать магазины и товары продавцы могут влиять на рейтинг выполняя какие-то задания и получая награды покупатели ищут товары и покупают покупатели могут оставлять отзывы на товары это основные кейсы логика которая есть в этом в этой бизнес-логике продавцы и покупатели являются пользователем социальной сети нагрузка сейчас примерно 2000 rps ожидаемые показатели 20 тысяч rps но мы должны быть готовы к взрывной взрывному росту нагрузки То есть у нас должно быть выполнено подготовка чтобы мы могли легко масштабироваться требования Какие значит функциональные интеграции с проектом то есть должна быть возможность интегрировать товар в социальной сети и их показывать внутри разных компонентов этой социальной сети не функциональные латвинься ответы блоков не должно быть более чем 200 миллисекунд консистентность данных должна быть потому что у нас работа с заказами с оплатами могут есть и масштабируемость может быть взрывной рост вот такая примерная архитектура которая планируется ожидаемое или целевая которая стремимся Сейчас я покажу пункту пройду чтобы подробнее было мы разделили эту всю логику на на бицепс блоки то есть мы вынесли кусочки бизнес-процесса в сервисы У нас есть блок системы управления магазинами которые может разрабатываться Независимо блок система управления рейтингами соответственно тут все про рейтинге и вся бизнес логика находится в данном компоненте блок управления каталогом товаров где пользователи могут смотреть товары выбирать может быть искать и видеть их блок система управления заказами где у нас есть корзина заказа это все пока объединил в один блок но в принципе при некоторых требованиях мы легко можем этот блок разделить еще на меньшие сервисы система управления товарами товары складские какие-то показатели Там могут лежать которые есть у товаров так последняя система управления отзывами всё про отзывы Ну и вот там где написано аппетитвей и монолит это пока будет Одна один элемент то есть вся кодовая база аппетитвы и Монолит Она находится в одном компоненте и каждый из этих микросервисов пушит некоторые события в шину данных и реагирует на события шины данных Посредством стиле обработки этих сообщений хореография всё успел уложился во время поаплодируем Спасибо Женя прошу сразу хочется заметить сходу Сразу одно из мотивации была там надежность отказывал устойчивость и мы здесь на схеме практически в каждом микросервисе микро-макро видим Так и хочется вспомнить известную поговорку топология звезда центр Лек Да совершенно данных тем шино данных поэтому наверное вот здесь конечно Это стандартный подход к использованию проектирования архитектур который очень любили в корпоративных приложениях несколько лет несколько десятков лет назад но Стоит задуматься О надежности этого компонента как в принципе он откажет они откажет как мы его зарезервируем и точно мне кажется не стоит полагаться на прекрасных ребят из инфраструктурной команды и думать что они дали и поэтому оно будет э надёжно работать вот э-э и ещё хочется вот прям вспомнить историю с первого кейса Да когда мы говорили про архитектуру и построение архитектуры из организационных моментов и так далее и прямо задаться вопросом здесь в этих доменах Нет очень важного домена на схемке На мой взгляд этот домен поиск домен поиск это очень важная вещь для магазина по факту это то с чем работает покупатель постоянно у нас поиск может быть например фассетный например полна текст и когда там по тексту когда по критериям ищет и кажется что поиск Один в один вот какой-то из этих квадратиков не ложиться и получается что это какая-то надстройка и чуждый элемент возможно в этой архитектуре вот Как где он в реальности Да отвечу на этот вопрос значит про поиск мы пользуемся некоторым элементом из Монолита который нам предоставляет функцию поиска Вот соответственно мы туда отправляем данные эти данные доступны для поиска и это бизнес логику Мы встраиваем в наш бизнес логику нет подожди это очень подозрительно Давай еще раз смотри мы выносим магазин из социальной сети тут написано вы нас магазина есть ВКонтакте но поиска мы будем пользоваться из Монолита Да в другую соцсеть мы это пока что не встраиваем нет И как Standalone придет конечно из соцсети четверти Да ну что за ним зачем мы выпиливаем его из Монолита что как бы какую задачу мы решаем первая задача Основная это в том что много команд разработки и мы хотим соответственно каждый из этих компонентов пилить Независимо и соответственно Ну Независимо независимая разработка второй элемент это в том чтобы кодовая база именно наша лежала в отдельном каком-то месте Мы в отдельный диплоили наши диплоин Не ну возможные поломки не ломали основной Монолит и поломки других команд не ломали наши то есть все какие-то поломки были прозрачными и мы могли таким образом зарабатывать наши проблемы будут из-за того что у нас есть семь отдельных команд для того чтобы заботиться и с каждым о каждом нормально аргумент Ну то есть это хочет процессные проблемы архитектуры Я хочу что об этом Надо думать если по-другому никак не летит об этом как минимум надо думать и ребята выбрали Такой путь меня вот интересует А как с монолитом это все общается вот на съемке не видно будет Ну соответственно какие-то в какие-то модули мы будем асинхронно доставлять данные какие-то вызовы будут синхронные мы этого уйти не можем здесь какое-то количество магазинов попытаюсь связать собственно вот это вот чудесную значит нашу архитектуру с бизнес-процессами Окей если какой-то компонентов отвалится то вот у нас будет хорошо остальные будут работать если каталог товаров Нет нет я естественно Буду тыкать про увязку магазинов с каталогом товаров которую я не вижу магазин без каталогов и товаров то может существовать А деньги-то кому перекидывать если там магазин грохнуться Да там да да он где-то вот там отдельно от магазинов болтается да каталог товаров с там корзиной заказы что-то тоже не очень Да там вот как бы товары тоже вот если они отвалятся Я думаю магазины будут не рады и я думаю что если заказа отвалятся товаров тоже радостно не будет И у нас получается что единая точка отказа меняется с бэкондом на чудесной API Gateway а и э падение одного из этих чудесных разработанных сервисов приводит к тому что в принципе магазин становится не то чтобы очень функциональным а не задумывались о том чтобы какие-то из этих компонентов всё-таки группировать чтобы это писала одна команда и релизилась оно всё хором чтобы не нарушать кор- логику именно с точки зрения бизнеса метрик и денег банально денег а да Значит стрелочки из какого-то компонента в другой компонент они обозначают то что мы можем ходить за данными и есть некоторая связь то есть например у заказов есть связь с товарами у нас в заказах есть айтишник товаров То есть я показал связь Вот и если у нас падает какой-то из этих компонентов у нас недоступно или не работает только часть бизнес-логики а не вся бизнес-логика в целом Если бы у нас упало это всё как в одном аналитике где у нас соответственно вся бизнеса находится связи магазины с магазином с товарами прямой и Да есть связь я забыла здесь отобразить у каждого товара есть связь с магазином то есть идентификатор у товаров такие связи смотри если у нас упали товары я смогу увидеть в корзине название товара который я туда положил Да потому что у нас данные по товарам для отображения и для того чтобы пользователи могли искать и прочитать находится в системе управление каталогом вот я не вижу связи между корзиной и каталогом но я вижу между корзиной или там заказами и товарами То есть ты говоришь что у тебя В корзине лежит айтишник товара и для того чтобы показать название пользователю тебе надо сходить во внешнюю систему система внешне упала и нет да видимо ошибка каталог товаров у нас находится все данные для того чтобы Вы могли Эти товары показать Вот и ходить дополнительно в систему управления товарами не нужно мы можем показать пользователю только из одного микросервиса не нужно ходить продолжаю Я зашел в оформление корзины упал каталог товаров и отправление я с картинками тогда мы соответственно не сможем завершить и увидеть даже добавить товар надежность Ну в том что мы если если мы каталоги товаров выбрали какой-то товар складывание но перехожу в корзину и в это время каталог товаров упал я увижу какой мне товар в корзине или нет тут Да есть проблема необходимо решить Спасибо хранится на складе на товарах система управления товарами а качество Ну да Ну да то есть если товары падают в корзине из каталога товаров отображается пользователь один оформляет заказ второй оформляет заказ институт склады разъезжаются потому что там была одна штучка не консистентная история вопрос из чата Как решается вообще проблема распределения распределения транзакций распределенных транзакций что кажется что несколько микросервисов могут изменяться в рамках одной прям сессии клиента и мы видим что название товара видимо поменялось какое-нибудь там его описание и испуганные пользователь В панике видит В корзине то что он туда конечно не клал Значит у нас события распространяются ориентированная архитектура мы пишем события в шины данных и каких-то компонентов мы обрабатываем эти события в режиме хореографии где-то Мы в режиме оркестрации находимся и если нам необходимо выполнить несколько шагов для выполнения одного бизнеса мы применяем регистрацию и это делаем если у нас что-то пошло не так мы применяем либо отмену либо компенсирующие операцию на чём построена это Ну пока здесь нету нет конкретных технологий но это какая-то внутренняя разработка будет Ну в смысле внутренняя очень внутренняя очередь или шина которая заработала внутри нет нет Какой велосипед Нет это не Кафка Я к тому что А это внутренняя шина данных она будет обеспечивать гарантией доставки и гарантии приёма Да там есть такое соответственно мы можем полагаться на то что все данные которые Мы записали туда записано А какие гарантии Мы ждем подтверждение от нескольких элементов этой шины данных что данные записались если допустим количество их больше одного два три зависимости стоимость сконфигурируем то мы можем считать что данные точно записались а чтение чтение То есть может быть такое что у нас какой-то сервис получил событие в этот момент упал и просто не за кометел результат своей работы еще раз возьмет это событие или что если у нас сервис взял некоторые сообщения на обработку и так если сервис сделал некоторые сообщения на обработку и упал то мы если еще раз прочитали Это же сообщение то соответственно Мне кажется это хороший под которым стоит вопрос добрый что-то Женька разошелся мочат и мочит Смотри Представь что у тебя есть возможность написать все с нуля забыть про Legacy который там был как бы ты все вот это вот реализовал если ты был демиургом и мог бы принимать решение единолично забыли про процессы чистая архитектура а ну самый главный фактор это нам необходимо обеспечить разработку обеспечить так чтобы бизнес нами был доволен и соответственно те фичи которые он ждет от нас разрабатывались ну с какой-то понятной скоростью Вот и нам необходимо все равно декомпозировать бизнес логику на какие-то конкретные кусочки архитектура осталась бы такой же Ну может быть другая сборка но в целом да есть такая достаточно привычная для ВК история некоторые такое знаете я бы сказала посттравматическая расстройство мы все время Боимся что вот прямо сейчас вдруг что-нибудь невероятно хайповое произойдет и какой-нибудь один магазин какого-нибудь трехбуквенного паблика выложить какой-нибудь товар куда придет полтора миллиона человек одновременно и все пойдет не так Но именно так как мы знаем что это иногда бывает тебе кажется во-первых где ты думаешь что сломается первым и где вы думаете что сломается первым а для того чтобы показать какой-то товар нам необходимо сходить в каталог товаров там у нас с точки зрения хранилища есть несколько шартов которые обеспечивают необходимую нагрузку обработка необходимой нагрузки и тут принципе может упасть но если мы заранее предусмотрим какое-то взрывной рост то мы сможем это обработать Окей товар Я думаю что упадёт чуть раньше то есть смотрите такая архитектура Она говорит нам о том что нам ещё нужно определённым способом выносить эти микросервисы то есть вдруг если раньше мы могли синхронно изменить товары заказы и корзину записав туда одну какую-то не знаю новую функциональность Теперь мы так сделать не можем мы такие вынесли новую корзину от неё зависит каталог товаров Это значит что мы там должны как-то завязаться на предыдущую версию и там как-то она должна уметь работать с новой и должны как-то синхронно выносить эти разные микросервисы и либо там не синхронно но чтобы они умели работать С предыдущей версии из будущей версии и вот там вот самые большие сложности Да когда у тебя типа 7 их тебе нужно точно знать какими версиями ты работаешь и вот там большая сложность там нарисовывается да сложность по выносу кусочков будет точно не только по выносу а в том что у тебя бизнес логика должна ожидать что грубо говоря ты можешь работать с каким-то старым кодом да Или там с новым и там вообще другие бизнес-правила да будем готовиться к этому согласен тут был троллинг тонкий вот не знаю кто услышал может быть или нет ещё раз полтора миллиона пользователей пришли в одну карточку товара как шортирование спасет от нагрузки соответственно у нас есть также кэширование на этом уровне у нас есть реплики куда мы если что можем сходить То есть тут с этой точки зрения все нормально сходим в реплику посмотрим реплику Ну пусть весь мир Подождет купить что-то очень востребованное скорее всего они дождутся не берет то что мне случае ты спрашивала что сломается первым первым сломается техподдержка ха-ха не Жень все намного интереснее первым сломаются ребят которые будут все это внедрять потому что смотри несколько команд вот надо к монолиту подсосаться вот надо поменять процессы внутри договориться теперь Живем по новым правилам и вот на этом они сломаются сначала а потом уже всё что вы говорите если у из наших слушателей есть какие-то идеи где сломается первым обязательно тоже Поделитесь вашими идеями в чате и мы вернемся к ним уже через несколько минут А Женя спасибо большое кусков из Монолита Аплодисменты я ещё раз предлагаю всех делиться вашими ощущениями в чате Ну а теперь по-моему самое интересное часть Я хочу чтобы вы мои дорогие друзья С нами сегодня этот прекрасный Спасибо большое вечер а буквально по паре фраз Давайте слева направо пройдёмся самое надежная архитектура из тех которые мы сегодня посмотрели и то что вам кажется что страшнее всего вот Вот что должно сниться нашим зрителям в ночных кошмарах в ближайшую неделю Ты меня хочешь начать давай Ну смотри здесь очень сложно сравнить что надежное что ненадежное потому что мы видели как внедренные кейсы так и абсолютно какие-то вот мы собираемся сделать вот это мы видели там дипломный проект поэтому сравнивать нельзя я считаю что самые надежность того что уже внедрено и паллеты там фигачат как не в себя то есть это очевидно вот то что там уже несколько лет эксплуатации какой был второй вопрос подожди Тинькофф там тоже вроде работает Прошу прощения Да Тинькофф работает поэтому вот эти два кейса Спасибо что Серёга меня поправил вот эти два кейс они надёжные ребята уже пару раз ночью просыпались и не пару раз наверное договорились И что все забывают О чём всем Неплохо бы думать проектируя архитектуры в будущем про поддержку то что вот потом вот это всё дело надо будет кому-то Вот мы сейчас Гениально какой-то архитектуру запилили Вот и бодренько например уволились из компании или пошли на другой проект И всё И вот остался бесхозной проектик и надо Вот вот эти все огрехи и нюансы которые мы они есть у всех да то есть все мы знатные делатели косяков Вот и вот э хорошая архитектура на самом деле там где команда постоянно с проектами постоянно его сапорте и и отвечают через год через два через три за те решения которые были приняты раньше всё остальное по-другому не работает справедливо ты монстр Ну тут сложно что-то добавить в целом Я наверное присоединюсь то есть архитектура с командой она гораздо более сложная и решает довольно большую задачу просто масштаб задач которые внедрены он разный то есть и с точки зрения интересности архитектуры архитектура со складом она выглядит более злобной скажем так при этом бизнес-процессы Да это вот как раз кошмары которые будут сниться разработчикам которые вообще привыкли к описать из того что мне в принципе нравится мне больше понравился этот радар Ну замечательно молодёжные проекты всем нам когда-то Мне кажется хотелось написать что-то что просто будет работать как самостоятельный проект так как уж она дальше будет разберёмся пожалуйста Слушай ты знаешь прекрасные наши замечательные котики которые вышли э-э это просто круто да ребята не боялись рот на огромный сервис который наглухо высоко нагруженный в Реал тайме и так далее и тому подобное и не боялись вот здесь вот подискутировать с нами и реально круто то чего я буду там лично бояться это это да Справедливая аплодисменты я смотрю После сессии это не так сильно стул кипятится и диван под коллегами как это было в самом начале Да еще вот дым не идет и так далее Все таки коммунда да кому-то работает не трожь знаешь почему не шкварчит потому что не нам это делать только название увидели уже сразу испугались а решение ты действительно хорошее потому что в отличие условно от всех остальных решений это то что прямо вот на земле работает вот руками пощупать можно не вот это вот что-то такое мифическое вот Циферки бегают нормально Суровый грузчики водитель фур которые вот тыкают в это приложение и что-то там оно делает туда побежал Ну как бы самолётики любовь моя вообще в принципе из сферы интересов и трепетная детская мечта поэтому котики просто завоевали моё сердце и душу Вот я очень надеюсь что этот прототип мы увидим виде Вполне себе импортозамещённого сервиса и его тоже конечно руками Алексей с моей точки зрения архитектура это всегда как сделать хорошо одним за счет других вот кейсе с комодой мне вот больше ну реально как бы это Ван Лав Да вот из этих кейсов кейсикс кому-то Мне понравилось самое главное аргумент вот просто огонь бизнесу нравится все что мы делаем мы делаем для того чтобы бизнесу нравилось а если бизнесу не нравится Извините ребята мы что-то делаем не то поэтому здесь вот ну прям реально снимаю шляпу если бизнес нравится если вы адаптируетесь максимально быстро под его потребности Ну какую бы технологию вы не внедряли вы все равно свои детские болезни набьете наберете шишки страшно наступить не на взрослые грабельки Да на детские вот поэтому здесь ну это норм А дальше Почему нет растить развивать может быть когда-то её заметите на что-то другое но главное чтобы вот чтобы вы не делали нравилось бизнесу супер но внесение магазинов это профессиональная будет сниться ночами но по-другому поводу Да аплодисменты Сережа Ну я уже говорил на самом деле что для меня архитектура это всегда только лишь борьба со сложностью Да потому что сложность в любой системе нас рано или поздно уничтожат и как бы вот эта сложность эта штука непонятная потому что иногда проще написать на перле потому что мы лучше всего знаем первым А через год получается уже хуже всего знаю ампер Поэтому вот это вот какая-то абстрактная величина сложность это то что мы как бы год с годом стараемся понять что будет проще впереди сюда в пазгресса или убрать отсюда и выбор который мы делаем плюс-минус там ну может быть не каждый день но каждый сложный кейс как раз этим и занимается как бы нам было бы попроще дальше жить вот с этим вот понятно имплементируя все функциональные требования Спасибо большое Ну что На этом мы наша прожарка подходит к концу Спасибо большое в первую очередь всем кто представил свои проекты это знаете большая смелость мы будем ждать следующие проекты на следующих наших прожарках Спасибо большое нашему потрясающему Шеф команде Шеф коллективу Мне кажется ребята отлично сработались архитектурная стартап команды мечты что ж Спасибо что подключились к нам в прямой трансляции прожарка архитектурных проектов видимо единственная прожарка не вызывающая профессионального выгорания Всё спасибо"
}