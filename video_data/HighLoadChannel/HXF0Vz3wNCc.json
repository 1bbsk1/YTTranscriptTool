{
  "video_id": "HXF0Vz3wNCc",
  "channel": "HighLoadChannel",
  "title": "Пользователь оценит! Повышение производительности мобильных приложений / Руслан Трошков (Superjob)",
  "views": 386,
  "duration": 2199,
  "published": "2017-04-22T14:48:14-07:00",
  "text": "здравствуйте меня зовут росла я занимаюсь разработкой мобильных приложений на android в компании superjob сразу говорю что доклад он ориентирован именно на новичков только для тех кто вступил на будете создание мобильных приложений сегодня будет все предельно просто буквально за как какие могут быть проблемы приводящий к тормозам пользовательском интерфейсе и как эти проблемы найти доклад я разделил такие небольшие части первое это будет проблема в наших методах именно который выполняет в основном потоке 2 это наша верстка и третья это память переключается для обеспечения плавности воспользуйтесь к интерфейсу современное устройство работает что-то обновляет и красота и 60 кадров в секунду отсюда сложно посчитать что время выделенная на один кадр равняется примерно 16 и 667 1000 миллисекунды но для простоты будем говорить о 16 миллисекундах производительность будет строить это уже стройтесь того чтобы уложить все наши вычисления в это выделенное время если мы и попадаем в это время то соответственно будет пропуск кадра уменьшается пропуск кадра что для водителя будет выглядеть дикими тормозами некими некими подергивания интерфейса начнем с того что с первой проблемы это первый возможно проблема это код который тяжелый код который выполняется в основном потоке мы знаем что при разработке приложения особенность это ваше приложение для ночь по ходу мы выносим вещь все тяжелые задачи из основного потока ну например там сложные запросы базе данных какая-то работа с файлами сириза цивилизация больших объектов что если вам предложение досталось на поддержку вы работаете большой команде и вы эти пишете код и что-то начинает тормозить то здесь либо на глаз что займет довольно большое время либо использовать пользоваться какими-то про файерами один из них третью инструмент который показывает время выполнения каждого метода я здесь вы выделил если стал показывать все что он выдает потому что не было бы видно большая таблица с кучей колонок я выделил три основные колонки вот одна из них это на воле важно это сколько раз метод запускался и сколько потребовалось времени на отработку конкретного методом данных очень долго и анализировать их всегда приятный не всегда хочется все люди добывать ли да и лучше не допускать до того чтобы у вас что тормозило было хорошо это в реальном как-то времени сразу проверять как приложение работает есть попроще решение и это решение именно для такого беглого анализа быстрого профилирования встраивать код свой код в метод но каждый год элементарный той засекать время старта методы окончания когда метода радость это будет время выполнения временем в более как это метода можно сделать так но гораздо проще внедрить код сразу во все это ты вашего приложения это можно сделать что член аспектах предельно упростил на самом деле здесь основные точки года это вот stopwatch это засекаем время это тело метода и конец время и влоги выводим просто разность конца и начала получается примерно такой лук мы можем для себя сделать удобно мы можем мы отметаем все методы которые довольно быстро его же поставить какой-то порог примеру 10 миллисекунд как у нас 11 больше десяти в общем чтобы сразу видеть что у вас происходит не так довольно удобно подключив просто телефон кешбек исследовала исследуя конкретный участок вашего приложения сразу видите что у вас там выполняется сколько занимает это время и сразу по ходу прайд следующая проблема эта проблема может быть в нашей излишней сложности сложные и рафии представления а именно слишком большой вложенности слоев друг друга и слишком большого количества наших вьюшек как решение проблемы это либо уменьшение влажности слоев друг друга так и уменьшение количества вьюв но опять же на глаз тоже не есть хорошо не всегда понятно может ничего трогать не надо все работает и так хорошо есть также инструмент называется он иерархию мир инструмент представляет ваш макет виде графического дерево где можно посмотреть сколько времени потребовалось на создание каждого элемента а именно сколько потребуется времени на его вычислили его размеров на расположение его на экране и отрисовка также кликнув по конкретному элементу в дереве можно увидеть соответствие этого элемента и как он выглядит на вашем устройстве каждое время дров оно подкрепляется соответствующим цветом от зеленого красного зеленый значит это время относительно цветовая индикация на относительно относительно половины соседних view вашего пакета отделенного красная и зеленая что элемент наиболее быстро создался то красные означает что он наиболее медленный из половины имеющихся тот ключевое слово относительно вы должны сами определять устраивает ли вас это время если устраивать то принципе ничего править не надо но это сигнал к тому что возможно ваша макете что-то не так как как вариант виллы тиф layout он для расчета своих размеров делает два прохода та же ситуация с линейным layout с весами тут сложно представить какую какие вычисления вы совершать устройства если у вас будет по три-четыре вложенных друг друга рыл и рыл этих layout а если в них в них еще будет и линейный layout с весами при этом еще будет куча view в этом поэтому желательно как я уже сказал либо уменьшаем что юг либо улучшаем количество и влажностью младшие ситуации когда можно в принципе не использовать или теплота а линейный light о том что в том случае если элементы тупо идут друг за другом друг по другу также можно сократить количество входа на 1к дверь отрисовки android он состоит из двух частей это центральный процессор и графический процессор страна причин этого в том числе и происходит вычисление того как будет выглядеть наш макет далее вся эта информация отправляется графическому процессору который преобразует полученную информацию в excel и начинает выводить на экран этот тут возникает такая ситуация когда в течение одного кадра пиксель начинают прописку cразу перекрашивать что приводит к дополнительным затратам тратится время на это что отнимает и по сути времени выделенном на один кадр такой процесс называется overdraw определить его достаточно легко идем просто для инструмент разработчика включаем отладку наложения и идем в нашем приложении ответим такую картину главное стрельца нашего приложения когда-то была есть также этого индикация сие означает что произошло когда шла одна перерисовка зеленый 2 розовые 34 более так раз наша цель сделать как можно меньше красного цвета уменьшить в идеале это синие и зеленые ноготь конечно бела если вас практически макет пищу совсем простой это очень редко убирайся на первый взгляд довольно просто нужно убрать лишние определения свойства бэкграунда как в макете может быть она где-то задаются в коде но и всегда решается так просто приходится так же пользуется одновременно инструмента и архиве rar и любите что-то перевёз давать что-то перестраивать в общем пересматривать логику нашего макета также если вы видите верхнюю поле такую красную траву был также может быть заливка и он не стоит убирать лучше делать прозрачная потому что на android 4 1 получите заливку черного цвета вот следующая вещь в такой вопрос от это разработчики есть возьмите руку пожалуйста ну в общем это второй крат приложения с макетом все в порядке нету на дорогу на нем нет на первый взгляд это это не но все же тут красное где он есть но ну не в макете макете всего оптимизирована связано это с оптимизацией с навигацией создания с типом навигация приложения так вопрос может то знает почему красного цвета после подсказка activity фрагменты вообще приложение но у нас приложение основана к одном активнее и несколько вложенных задников нескольких фрагментов стыке так вот если фрагмент добавляйте к методам это то по сути он ложится новым слоем поверх первого что android ум не знаете что черный сотовых просто рисует первый слой затем второй слой получается вот такая прорисовка многократная поэтому тут как два варианта либо мы фрагментов с так добавляем реплей сам забит заменяя первый слой вторым либо если вы решили делать этом нужно ходить предыдущий слой в любом приложении и есть наиболее популярной странице то есть те страницы которые пользователи пользуются больше использовать больше всего у разработчика взгляд часто за моё делать какую-то фичу отлично все работает закрывает последую потом пререлизе и уже при начинает пользоваться прилетает от пользователя какие-то куча негодовать что приложение тормозит тормозить она может на той причине что забивается память если приложение сидеть на одной странице долго и не при умелом выделение памяти она начала заканчивается сборщик мусора запускается в единицу времени все чаще само по себе сборка мусора на много времени отнимает особенно в android runtime но если это за один кадр происходит сборка мусора по несколько раз то время естественно суммируется что отнимает время прессовку кадра и выражение начинает подтормаживать вот ещё один пример нашего приложения это список вакансий в какие-то который подписок пользователь список сделать больше компонента риса первй у есть придет код адаптера я сейчас объясню в чем здесь суть тут в этом списке несколько типов поэтому их 1 2 4 4 типа это вот если сверху вниз подписки на вакансии переключалка новые вакансии просмотренные вакансии и все остальные это типа это просто сама вакансия в адаптер мы передаем коллекцию из типов выкосят об этих какой типу отобразить у списком и придает через один вот так сделано и он передавался через зайди то есть если войди 1 из 3 constant одна из трех конца написано the doctor определять как какою холдер подсунуть либо иначе если три несоответствия вот эти верхние для всего остального вот показана свою holder 4 4 myfolder специально для списка вакансий а так вот в этом считая по идее это уникальное значение то есть они никогда не совпадает тут есть проблемка если ее кто-нибудь видит вот сразу так на первый взгляд это может быть если нет давайте я следующий слайд скучаю без него чем дело видишь видишь так вот нет не совсем проблемы с памятью специально так вот вся проблема кроется вот именно в том что мы не передаем верните определяет через неделю для экономии памяти он эти view full деруны их перри использует то есть мы обычно за все время имеется его будет течение всего времени работы списка будет какое-то определенное количество в и факторов создаваться а дальше они будут просто перес пользование использоваться при скроллинге так вот в этом случае и со перил не понимает что их можно перес пользовать для него каждый а этом списка он уникальный то есть вот думать что у него будет уникальная какой-то уникальный дизайн и вёрстка а даже ничья так вот я получается если я отдам at all 5 страничек и уже юкагиров 500 штук накопилось если пользователь если будет бесконечный список он в итоге приложению валит вот таких ошибок что тогда глядел тоже не может валится может потребляться много памяти это особенно особо внимания следует уделять именно вот списком элементов и их желательно периодически либо жить снимать дам кучи и проверять что там у них находится то что ошибку довольно легко сделать так же каждый раз снимать кучу совсем удобно и определять утечку памяти можно не поймать что у вас память течет и выкатить как есть до этого удобно пользоваться утилитка такой как ли кинари она подключается в дебаг режиме даже тестировщик может выставить вам баг то есть это как бы гранде анализирует всю вашу память если есть какая то утечка течет activity фрагмент то но вот на экрана выводится такое такое сообщение можно делать скриншот прикрепить выстрелить задачу исправлением подводя итог я бы хотел сказать что нужно все анализировать именно нужны цифры нужно ходится инструментами пропали вы профилирование падения производительности может быть как и в основном потоке что-то недоглядели верстки что-то недоглядели в памяти все спасибо за внимание вопрос а вот ликаны рион в какой момент запускается этот тестировщик тестирует приложение нет ли к даря он запускается мы просто подключается как плагин и он отслеживает жизнь цикл нашего приложения в принципе у нас во время дебаг он работает именно во время дебаг режима в резина верстки работает ну тоже тестирование вот так просто проверяет и он может случайно наткнуться на банк или какой нет он тестирует если есть какой то великая на анализировать на заднем он на заднем фоне на ваше приложение если что-то словила памяти она выкидывает сама она ничего не надо мне запускает не не ли стоит самого именно пользователь время это для сохраняя логов там условно говоря да вы видите автоматизация тестирования только нет она сама не делает но в принципе можно что такое придумать чтоб было сложно и еще вопрос а как товаров тестируйте вот обвинена в авто теста есть возле приложений именно для на производительность нет просто на авто тестом на функционал даже есть да есть автотесты но у нас нет интеграционные тесты гоняется пицца с этом скриншота всего еще есть инструмент снятия дампов на собственном android встроена да когда то есть классе applications можно просто вызывать там память использовать их что а вы их используете да конечно я показал же скриншот это именно дам был памяти это кусок простая чтобы лишней информации не было android studio все устроено довольно удобно это сделано можно как там кубок учинять так можно еще и по времени allocation вот какой подход у вас когда вы начинаете анализировать нами мире лики то есть какие ситуации или насколько регулярного это делать есть какой-то процесс в есть есть да ну при разработал ты мы делаем какую-то фичу и где-то спринта через 2 недели заводите задача на проверку тех мест которые тех задач которые давно делали но еще и перед релизом пару дней мы выбираем чтобы бегло надо сделать это же вопрос еще больше получалось до следующего доклада давайте что-нибудь пообщаемся все пообедали со мной за задавайте задали вопрос еще раз падение мы используем фабрик уровень крриш 3 по фабрика украшались не секрет может сказать уровень ошибок по ней показательно крышка users который фабрик считает здесь я вам не покажу я скажу скриншотов бывает у валим так что там каждую секунду по 10 пользователей падает это было вот недавно случайно мы сделали одну ошибку как бы пользователи по 10 тысяч 20 щеточного пользуется очень много и обновляй обновляется довольно активно если что-то падает прямо при старте так это видно сразу там так уж ветер начинается что нос кредл сумеет показать а его нет да все производитель ст все вручную нет эти пока не собираем это делали была идея сделать ну пока нет не дошли руки до обычного просто принципе можно отсылать свой api написанное будет мы просто обговаривали это уже но дело тут дальше разговоров пока не дошло своих задач что сценарий да эспрессо да запросто эмулятор обычная где не может ставить и запускаете потом с ним часто проблема бывает на бесплатной версии приходится счет периодически перезапускать приходится и действует на север и и перезапускать я так понимаю то что бесплатная версия стоит надо покупать пока я еще не понял почему он такого лица без не не будет нет не будет я без гонять тесты на телефонах сценарий чтобы не аффекте употребление батарейки через юсб поэтому нам нужно придумать какой-то способ его смотрим сейчас на на эспрессо да подождите я вас обманул если все скарпи лица по сути создает приложение к будет будет работать если вы туда залил отключаете да будет конец ну вот это нам надо будет еще интересно узнать как у вас построена работа с крышами от пользователей то есть так понимаю что их довольно много нет плохо понимаете довольно много бывает когда вы что-то выкатим не так это на моей памяти то раза три было за 4 года это там таких глобальной крыши так и для между мной много они в плане количества воспроизводимых у пользователя разных по типу да то есть вот я это минут вы как их анализировать и или такой отдельный человек у вас тут анализируем нет у нас это каждый разработчик может зайти периодический я проверяю с утра прихожу что так много вывалилась заводите body зовут бак в жире всю прямо ссылку кто кто взял тот бред ну мы последнее время начали тестировщиков еще привлекать к там отдела что мы тоже сейчас видели но допустим разработчик взял stack trace посмотрел у него не воспроизводится элементарно на андроиде такое возможно ну а это тупо телефон друга и примеру до этого довольно скоро вы делаете закрывать и меня это довольно сложные случаи мы овладел тестирование отдаем приходится иногда один баг или прямо на неделю коня моего не закрываем это анализировать довольно долго и кстати ему еще пользуемся тараджи не motion that we're виртуальное устройство создать такого типа найти и проверить на нем ну конечно на китайских вот такие тнт такие да если он один бак проявился за все время скажем вот релиз выкатили прошло две три недели один висит на законе смотрим на него времени тратит такого увидел другие задачи делать используете ли вы для тестирования облака устройств нет сейчас там даже как в этот сколько знаю в google play это появилось сделал когда закатывай закачиваешь уже приложение заливаешь вот там все так тестирует гоняет учета качества совсем не то он считает что все хорошо то есть вы пробовали а он сам автоматически запускается но у него всегда все хорошо в итоге на самом деле это не так бывает что я не знаю вот там использует какие устройства непонятная вот вот вот знать вы говорите что вы тестируете там пару дней перед релизом а может поподробнее как в тестировании к на каком количестве девайсов там какое разнообразие девайс чего делаете или просто сидите там пальчиком не просто сидим у нас по количеству девайсов штук десять мы начинают android 4 1 потому что в этом минимальная версия android которому сейчас поддерживаем до 7 ног это из устройства но естественно они все не покрывают приходится иногда на эмуляторе тестировать проверять что-то но судя по падением как вот я повторюсь достаточно много баками с китайских телефонов таких дешевых совсем и они бывают там по одному их может быть даже 20 но везде у одного пользуется только падает на такие устройства сложены это такое найти покупать исключается вы учитесь как бы уже по факту да то есть ошибки появляются в их там вы там допустим такой-то девайс конкретным потом включаете в тестировании при следующих релизах нет или вы как бы там у вас есть какой-то пул девайса на нем тестируйте и как сказать надеетесь на уши у нас был пример было падение такой баг раньше был саппорт лагере в эксплей какой там был косяки с какой-то верьте сапорт l'oreal вообще не работал explay версия нескажу fresh мама назывался он да мы купили специальное устройство на нем тестировали потом начала падать на ком-то miramax что ли который так просто не дойдешь просто вас посмотреть сколько с этого устройства принципе водится нашим приложением потом появилась штук десять мой , марс того в исключении добавил потому что не поправить это питаться por favor и конкретно зависело у нас равно у них будет падать смысл одетому отдавать наши приложения то есть если мы видим что это наш косяк мы направим если видим что костя какой-то библиотеки или самой прошивки устройства то мы здесь еще сделать не можем приходится отказываться от такого устройства да да и скучая да он его уже не остановить нет нет а смысла на зерно не упадет только негатив еще ну насколько мы не знаем какая вероятность просто зачетного такой негатив во весь рост его исключаем отзывы плохие да не довольно зачем мы людей это зря сказать другого найдет другое устройство лучше поставить я так считаю но зачем надежда давать людям все-таки чуть чуть пополам не можете протестировать а вот эти два дня вы как как тратите на что расходуете какие давайте два дня перед релизом которые вы потратите на тестирование что что включая какие работ не на тестирование то именно тестирование море грейси занимается дел тестированием мы этим не занимаемся мы конкретно делаем профайлинг приложения то есть то что берем основные самые популярные места у нас это главная страница список вакансий просмотр вакансий и пробегаем конкретно по этим местам что эта память как она расходуется если утечки но и по последним фильм который мы закладываем на релиз какие-то фича надо сделать это это и это это соответственно по всем этим местам нужно пробежаться и посмотреть насколько там все сделаем рано нет нет ли утечек все ли в самом потоке выполняется кто-то берет завязку кто-то память кто-то именно конкретный момент он продвигается как то так в общих чертах спасибо за доклад был очень интересно мы немножечко не по теме доклада вопрос сталкивались ли вы с ю и дефектами в частности android studio не всегда правильно на конкретный тип и размер показывает в соответствии с реальным устройством идею и дефекты которые могут быть порождены они не всегда воспроизводятся разработчикам то есть если сталкивались как решали дефекты имеете ввиду ну например кнопочка может быть на одном устройстве жена втором уплывать на самом деле вот я могу привести яркий пример и сыну более сложная верстка вы возьмёте к примеру в последней версии android studio и возьмете ну samsung там с 7 например по сравнению с там с 6 там неправильно ну назовет форм актов до разрешение размеры там верстка вот начинает реально плавать и в android студии корректно это воспроизвести нельзя то есть сталкиваемся как рис до конечно особенно с самсунгами это довольно часто мы сталкиваемся мы даже для этого у нас несколько этих самсунгов почти вся линейка идет чтобы на них достигнут особенно вредны и мы считаю самой вредной lime такой телефона довольно требовательна это samsung s3 в лице песни найдем что-то заработала кто будет работать на все население и дальше а как разработчику но я понял кей у вас есть реально устройств и советы если нет полного спад к парка реальных устройств до люди не может вас праздник вашим я отлично просто все устройства они находятся у тестировщиков когда мне нужно посмотреть я делаю какую-то фичу я обычно разрабатываю на 0 6 5 7 5 и 7 еще в . чтобы проверить как хорошо на самсунгах а это обязательно это проверять потому что всегда какая-нибудь ерунда всплывает приходится создавать эмулятор именно скачивать конкретная виртуаль ваши у него то ли машина от с3 там samsung или с4 и смотрите уже на эмуляторе все это дело на фугасе бак просто как-то исторически сложилось до этого стандарта он был дико глючным и как бы как перешли также не можно я им пользовался и он меньше жрет по черед о своём смотрю запускаешь android studio машина начинает гудеть и можно побыстрее плюс там можно да мне удобнее просто удобство и все ну и плюс у нас эти тесты гоняется иной модели можно использовать как бы один инструмента пользоваться ну кто-то на android studio team виртуаль каким а воды использует все спасибо большое за доклад мы уходим на 20 минут на перерыв"
}