{
  "video_id": "UB-w1cRhcgg",
  "channel": "HighLoadChannel",
  "title": "Feature Toggles, или Как выкатывать фичи без релиза / Ян Ашенкампф (KUPIVIP.RU)",
  "views": 4991,
  "duration": 3061,
  "published": "2019-05-15T04:21:43-07:00",
  "text": "да сегодня мы будем говорить про тычут углы а нежели чем флаги или как выкладывать фичи без релиза я буду 1 это формате кейса на примере того что происходило у нас в компании kupivip поднимите просто руки кто вообще слышал про компанию купив когда ведь рук должно быть существенно меньше эта компания среди айтишников не известная она больше известна среди модниц но здорово что вы знаете спецификой его бизнеса в том что у нас очень очень много товаров больше двух миллионов но мало остатков по этим товарам то есть мы быстро выкупаем модных поставщиков их коллекции делаем рассылку быстро распродаем и их клиентам оттуда же примерно берется хай лот это достаточно крупный магазин он входит в топ-10 у него по открытым данным коммерсанта на время когда был сделан этот этот доклад это шестнадцатый год эти события происходили было больше 17 миллионов от клиентов двух миллионов заказов и 16 миллиардов рублей оборот он достаточно быстрый там гигабит исходящего трафика 1000 запросов в секунду но подходит меня зовут я на ashran.com я начинал работу свою в компании крок инженером начала младшим инженером обычным постарше потом в росбанке это же и инженерная карьера если этого отработав в росбанке закончила замом по интеграции потом купили пин начиналось руководитель разработки но потом перешел примерно к середине этой презентации на исполнение роли директора по продукту и технологиям это когда ты отвечаешь не только за код но и за конверсию и за эксплуатацию то есть этой аналитики и разработчики фронт бэк мобилки администраторы а после kupivip а опыт который описан в этой презентации мы с командой пошли внедряется промсвязьбанк коллегии сидячие поддержит о чем сегодня пойдет речь в комиксе никто не знает что сработали ты что поднимет конверсию мы смотрим друг на друга на amazon есть огромное количество идей но какая из них сработает какая нет не понятно поэтому главная цель нашей трансформации было поднять градус экспериментирования то есть дать возможность быстро доставлять изменение до пользователя и от пользователя и до бизнеса доносите эффективность его хотелок соответственно сегодня именно в разрезе этой цели я постараюсь рассказать наш кейс с сич итоговыми мы начнем вот с точки а как любят говорить это такая стандартная модель разработки пройдем через asio сиди изменение архитектуры нашей системы без которых добавление итогов было бы невозможным потом рассмотрим разные виды the glove рассмотрим как это все связано с мобильными приложениями и чем все кончилось какие выводы мы сделали чем можно поделиться в результате сначала расскажу что у нас было за приложение тут речь идет об основном фронте магазина понятно что информационных систем довольно много это стандартное приложение на современные джаве у нас есть а клиенты это либо браузеры либо партнеры либо мобильное приложение яндекс видео балансировщика backend на springer причем там был достаточно современный spring на spring будьте толстая jar очка за ним несколько баз elastic реплика сет в манге mais quel и и микро сервисы всякое rc пуха там логистика гиа кадр статистика рассылки пуше задачи тильда для статических страничек диагностика и шлюз между ними общем это стандартное in уровневое приложение на джаве на спрингз никакой специфики в плане разработки . а тоже было довольно типовая для большой компании у нас были отдельные колодцы были продуктовые аналитики которые писали tz вместе с дизайнерами они фотошопе готовили какие-то макеты это как правило у них занимало до трех месяцев по моему потом разработчики писали код по согласованным задачам мы выкатывали какой то более менее стабильную сборку в отдельную тестовую среду ее руками проверяли тестировщики по-своему чек-листу в excel и если все в порядке собирали build а ночью вы ходили на работу останавливали даже во владивостоке ночью покупаю эту ночь меньше трафика останавливали сервер выкатывали новую версию запускали нас была такая штука как spring профайлы приложение знала запущена но в против pride против либо в тесте тоже очень стандартная модель но это стандартная модель давала свою стоимость релиза получалось делать примерно раз в полтора месяца и только после того как мы выкатили релиз продакшен наши полете ли всегда находили какой-то не очевидный способ функционал наш использовать и мы были вынуждены сделать a34 bug fixes вот сам по себе релиз был достаточно дорогим потому что связан с down time on a связан он был с downtime а потому что наше приложение внутри себя вот три applications сабиров имела довольно много состояния это был реплицируется кэш наказал кости в то время за приложением был мой scoin на одну страничку нужно было несколько сотен запросов для того чтобы эти запросы не делать мы смысле вам расположили в хабблкасте хабблкаст для актуальность реплицироваться между приложениями в общем релиза получались довольно дорогими и содержали много функционала это какое-то время работала пока мы не взяли фокус на увеличение крадусь экспериментирования как увеличить радуется экспериментирования все понятно даже книжку проект феникс читать не нужно на этой конференции об этом сказано очень много мы начинаем себя системе хотелось бы рассказать что к краеугольным камнем нашего соседи стали автотесты эта вещь без которого в том виде в котором у нас есть соседи был невозможен авто тесты были разных видов было полное покрытие на уровне api и какое-то покрытие на уровне модульных тестов причем мы даже оставили тебя и у разработчиков на уровень этого покрытия но на уровне api было полное покрытие после авто тестов мы сделали автоматизированное развертыванию тоже все более чем стандартно особенно для джавы предал и так называемый blue green deployment blue green deployment это когда ты разворачиваешь среду слоев в какое-то отдельное ведро добиваешься работоспособности потом а переводишь туда трафик а если что нетак ты можешь вернуть этот трафик нас на старое ведро для того чтобы параллельно несколько версий могли работать от друг другу не мешать нам пришлось очень сильно поменять архитектуру перейти на стоит лишь и много version ность а что такое stateless я так думаю все знают поднимите руки нет расскажу стоять это когда внутри сервера приложение вас нет никакого состояния и он находится до об обработке запроса и после об обработке запроса в одном и том же состоянии это когда вы можете запросы пользователей балансировать между серверами безболезненно например там просмотр главной странице первый сервер добавить товар в корзину 2 оформить заказ от 3 и эти серверы могут быть еще и разных версий намного version насти это когда мы смысл и систему спроектировали так чтобы работающий экземпляр серверов приложение разных версий в первую очередь не портили данные друг друга то есть если старый сервер видит какие-то новые данные тонны хотя бы не перетирает и не конвертирует свой старый формат а если новый сервер видит старые данные тонных потихонечку совместимым образом объедет там происходит что-то вроде экспанд контракта параллел czech так же хотелось бы сказать что мы на этот момент постарались избавиться от тези и главным артефактом которые путешествовал по нашему плану задач стал тест кейс с кейс итак главное что у нас было это единственная необходимая и достаточная вещь для того чтоб можно было делать задачу причем определение тест кейса было такое тест кейс это такая такой артефакт который ты можешь дать человеку которую ты поймал в коридоре посадить его перед системой и он скажет выполнена задача или нет вот ничего кроме этого разработчика мне нужно было для для начала работы то есть как проверить я расскажу на примере оплаты кредитной картой можно писать за как подключить processing как он должен работать что там должно быть внутри а можно просто сказать захожу на страницу чекаута убиваю в элитную карточку списываются деньги у заказы и меняется статус на оплачен вбиваю не валютную карточку вижу ошибку именно так разработчики принимаются до чуток тестировщики и роботы потом ее тестирует вот примерно авт а в том же моменте мы начали экспериментировать с переходами на как рос функциональные команды из своих от колодцев мы их начали объединять в трубке собирающихся вокруг найти куратора заказчика тут написан и я куратор product аналитиков фронт дек дальше я расскажу как произошёл переход на стоит лишь начинали с архитектуры где стоит хранится внутри джавы вот а именно внутри каши находил кости и балансировка на engine.exe сделано так что запросы стремятся попадать на на один и тот же сервер то есть каждый сервер обслужит какую-то свою часть клиентов подальше по j&d sticky сашины ничего интересного здесь нет вот потом мы переместили данные в гибрид кэша и база которым мы выбрали мангу причем мы их переместили ни один в один как были в mais quel из двух станет табличками мы их сильно объединили в деревья чуть позже я расскажу какие именно то есть как количество запросов снизилась очень сильно и это не совсем база в том смысле что эти данные не ценные это гибрид базы и кэша она быстро она актуальна но если ее удалить либо если какие-то данные удалить то все эти данные будут доступны из смежных систем например там заказы хранятся в системе обработки заказов товары герпес системе как ленты все рынки это все быстро мимо то есть это просто большой кэш сами серверы приложений столиц существенно меньше и что я здесь еще добавил на слайде это внутренняя архитектура приложение не хотелось бы сильно туда погружаться но это архитектура похоже на стандартную м весе с одним только дополнением что у нас был контент легашей think you резольвер и наши контроллеры они умели отдавать как странички для браузеров так и джейсоне но для всех остальных клиентов то есть абсолютно все глаголы все архетипичные интуиты вообще весь функционал который у нас есть он имеет работать и для человека и для машин и именно этим мы и называем наш и 5 именно это позволило нам сократить кодовую базу и сократить пространство для ошибок первую версию это состоятельность штуки мы запустили в продакшене меньше по моему чем на десятках тысяч строк кода для современного иди-иди коммерса это очень мало после того как мы перенесли данные а в мангу мы сделали следующий шаг от и вынесли каталог товаров на эластик сирачу потому что манга не очень хорошо подходит для построения faced of там не очень хороший полнотекстовый поиск поэтому абсолютно все запросы где нужна какая-то выборка товаров но это или категория там какие-то брюки вещи armani либо красные все где есть несколько товаров она отдается из пластика то есть пустая java гибрид кэша и базы в виде манги и л л и ластик рядом для обслуживания каталога понятно что манкой ластиков было несколько понятно что рядом была обвязками микро сервисов прекрасный длинный текстовый слайд про многом version настя уже уже рассказал общей переход состоит full на stateless у нас занял около 3 месяцев мы стараемся сохранять совместимость то есть нету versio нирования просто добавляем новые поля а потом удаляем старые мы несколько раз делали подходы к написанию или использование каких-то айрым окно arms много version ностью тяжело дружит там приходит происходит в что-то вроде на шаблонные от is ii + плюсов похожи поэтому закончилось тем что по своим applications сервером мы просто таскаем документ это хэш map архитектурное решение уже сказал что api и и страничке отдают одни и те же контроллер и это очень классно уже сказал что у нас есть по лукаш полугода и манга хотелось бы сказать то что манга она не дает вам три индукционную целостность данных поэтому вы как программист знаете где какой уровень вот этого event конкор нэнси window вам нужен и поэтому в большинстве случаев вы можете просто читать с реплики получить немножко отставшие данные в большинстве случаев вы можете только ой в некоторых случаях вы можете только читать с мастера например очень маленькая как глубина резервов товаров поэтому если вам надо проверить может ли пальцев купить товар тот кто на реплики это делать бесполезно потому что все пользовались наши модницы кнопку нажмут одновременно вот и если вы что-то пишете в мозгу то нужно на уровне приложения самим делать традиционную целостность вот мы сделали что-то вроде инвестиции она работает через об апдейтов и вк и в коммент с повторами если запись успела обновится и рандомными задержками в целом это работает достаточно хорошо там единицы к лизе происходит сзади власти com search им было тоже интересный лайфхак мы обязательно храним source это исходный товар как он был бы был в манге потому что стандартный сценарий был какой использовать мощности ластика для расчетов ассетов и получение списка товаров она самыми там за самими товарами слазить а в мозгу по разу на каждый товар ну или одним запросом их вытащить это все лишнее трафик они прекрасно ложатся власти kion их вытаскивает тем же хитом что и страница каталога это это очень быстро это происходит где-то там за пять шесть миллисекунд на большой боевой нагрузки фронт мы пакуем прямо внутрь нашей толстой поджарки но да и и принудительно сильно каширу engine.exe этим мы избавляемся от разливания под формат фронтом я имею java script и картинки вот это вся статика которой каждый релиз меняется поэтому вот жирным выделены сто пятьсот это позволяет работать сильному кашу на engine.exe под сильным кэшем я имею ввиду еще заголовки отправляемой на компьютеры politely чтобы браузер даже запрос не делал если он когда-то видел уже документ этой версии все он он даже не спрашивает на сервере и ты так как у нас много общения между разными экземплярами аптечный серверов и всегда надо понимать что у тебя распределенной системы там ответ может или прийти медленно это самое ужасное кстати или не прийти мы везде используем his tricks я очень рекомендую библиотечку всего-то две строчки на метод 2 режима работы circuit breaker вы должны понимать что запрос может не прийти в то время которое вы хотите обязательно нужно читать тайм-аутом причем чем ниже тайм-аут тем лучше то есть у нас большие случаев там а вот этой единицы секунд не 30 секунд вам не надо блокировать от red apple конечно сервера пока вы чего-то ждете не смогли значит не смогли их и his trucks дополнительно хотелось бы ещё рассказать про библиотечку spring rest dogs кто программирует ногами тоже очень рекомендую на позволяет вам превратить ваши тесты вы всегда актуальную документацию и это документация мы пользуемся сами отдаем нашим партнерам так как и пиа и на сто процентов покрыт тестами все действия и просмотра товаров добавления в корзину все поиски вот spring раз dogs вперед ваши тесты делает из них example и для партнеров они потом с и током объединяются в противнику такую пачку то есть у вас есть всегда актуальная документация с примерами использования вашего api бесплатно и вы знаете что она работает потому что эти тесты прошли иначе банане выложилась теперь расскажу немножко подробнее как мы сделали стоит лишь и что мы примерно храним в базе вот на картинке справа и и плохо минтамбл будет потом в раздатке поэтому я буду рассказывать что там это кусочек выдача нашего сайта когда вы добавляете к ключ mediatek джейсон ну или заголовок акцепт type же сон для обработки каждого запроса мы фильтре сразу при аутентификации пользователя до того как дело дошло еще до а контроллеров лезем скобка в коллекцию от аккаунт только поедишь нику это очень быстро то есть это работает единицы миллисекунд и мы получаем всю информацию не просто о пользователе а всю информацию которая может нам понадобится для того чтобы нарисовать для этого пользователя страничку понимаете то есть то что раньше в миску или мы брали из нескольких источников час мы вытаскиваем из одного аккаунта и корзина пользователя и непрочитанные сообщения какие то уведомлений все его настройки какие товары последний он видел какое-нибудь персонализированное меню есть как какой вид рекомендации он он хочет какие баннеры он он он уже плиту все это вытаскивается оставляет на фильтром при аутентификации за один хит сразу и уже доступна в контексте для всех контроллеров при этом она актуальна потому что она не запретишь на сервера приехала as as манги вот пример справа мы такую запись создаем для всех клиентов даже которые не не оставляют нас своим email поначалу она очень маленькое здесь проявляются преимущества манги что она позволяет хранить документы разного состава разного размера то есть в начале у нас там а просто идешь ник и откуда человек пришел на наш сайт впервые потом и и дополняем дополняем дополняем тему смотрел если он к он он кликнет по какой-то ссылке которая позволяет его учетку связать с другой мы их мир джим если он зарегистрировался дополняемые в итоге она несколько килобайт имеет вытаскивается одним хитом несколько раз мы хотим ее обновить обновление собираем землю сиру летный фильтром и через сервисе отправляем вот это то волшебство которая позволила сделать там сайт с тетрисом чем закончился сейчас идея довольно предсказуемо мы начали выкладываться хотя бы без downtime а днем это позволило нам несколько ускорить или релизы по разу в неделю за счет этого релиза а стали более компактными и управляемыми но здесь начались уже проблема о которых собстна этот доклад раньше пользователи но под пальцами между заказчиков раньше заказчики требовали какой-то большой функционал мы писали код когда функционал готов мы его выкладывали а теперь появилась такая ситуация когда релиза происходит чаще чем дописывается fuck салата и допустим релиза каждый месяц лук каждую неделю а какой-то функционал надо делать месяц или больше месяца например там какая-то программа лояльности вот это существенное изменение и непонятно что делать с этим кодом на время промежуточных релизов можно его хранить на компьютерах у разработчиков но это совсем приятно если разработчик один мощный какой-то спешить например от спешить но тут тоже продвинутые человечество все придумала фича branch и мы использовали стандартную модель deslow довольно легко на неё и перешли где словно кстати кто слышал праге слов о красота все мы разрабатываем в developer если надо делаем свечи branch надо релиз релизный branch мастер всегда смотрят на продакшен нужен hotfix мы знаем что у нас выложено на продакшене делаем из бластера не буду подробно рассказывать вы все знаете чем раньше но получилось то что эти фичи branch и имеют тенденцию к тому чтобы жить достаточно долго и происходит то что он называется маршал постоянно надо выложить либо develop в эти фичи branch и и это такая однообразная изнуряющая работа бесполезная самое обидное то есть разработчик ничего не не делает полезного когда он занимается разрушением конфликтов не дай бог там приехала какая библиотека новая или библиотека кора которая за собой еще дальше толстый ластик взгляд и ты мерзнешь а потом с основами jyj и снова вершишь притом ладно если мы часто мертвым develop афишу branch потом ведь у нас еще нарушить об обратно когда работа казалось бы что завершена оказывать только 50 процентов сделано надо интегрировать этот код интегрировать его например по безопасности по протоколом обмена в общем самая веселая всегда возникает в конце когда мы можем фича брать в диалог его выкатываем и еще один очень не 1 сеанс с и чем раньше me это непонятно где их тестировать то есть понятно разработчик у себя на компьютере запустить все по тыкает его легкий об apple течь на сервер а затем все эти мы развернем всю эту рассыпуху в отдельную среду это довольно дорого потому что там много сервисов но развернем но в этой среде никого не будет там не будет ни товаров актуальных а из наши специфики это важно у нас функционал завязан на эти резервы на то чтобы они быстро обновлялись правильно работал поиск рекомендации и там не будет реальных клиентов то есть но разработчик потыкать тестировщик подвигает тестирование ли это авто тесты про гонится в каком-то смысле тестированию надо неполное это основная проблема в чем раньше не очень понятно как их как и кем их тестировать и эксперименты с загоном туда боевого трафика на вершины все это весело пользователи удивляются но могут меньше покупать мягко скажем вот о чем идет речь я рассказал как мы прошли стоит лесу который позволил нам выкатывается чаще и что мы долгое время жили с и чем раньше мы где мы откладывали не готовый код как нам завещал любимый наш мартин фаулер в последнюю очередь пробуйте фичи тогл и ну вот мы перешли на это на эту технологию начали с тестированием на продакшене то есть первый вид пишут о глав которые мы использовали он называется канареечный или тестовый это когда ты разрабатываешь какую-то фичу вас в основной ветки просто но у тебя прикрыта каким тарифам или чем-то еще ли и injection нам ее видят только часть пользователей то есть для каких-то запросов у тебя код включается для каких-то выключается с опытом мой доклад наверное о том что я 45 минут рассказываю как скот добавить их и всякие нюансы этого используем но помогло вы знаете помогло мы и избавились от а до большого количества фитинг which a branch и а стали разрабатывать в devil api что самое при на приятно мы стали показывать этот функционал не до конца готовы и заказчику обнаружили два очень приятных побочных эффекта часто заказчик или говорил о класно уже выкатываем на прот то есть мы потратили ещё только 30 процентов планируемых ресурсов сделали три из десяти fitch а ему уже нравится мы сэкономили остальные семь уже в наши реальные польза ли видят изменение пока конкуренты там еще branch интегрирует и 2 заказчик ведь нет на самом деле я этого не хотел я хотел другого вот фотошопе он этого понять не может даже в интерактивном макете на и движение он это понять не может а в реальном функционале когда он добавил какой-то товар пусть не красивый ну то что называется часами mvp это понять может он или говорит уже круто или говорит на самом то деле я хотел вот этого или говорит нет я передумал и в том и в другом мы встретим случае мы экономим время разработки фича работает в боевом окружении на боевых остатках она сразу интегрирована по безопасности по протоколом обмена по всяким внешним сервисом в общем релизные течет углы это добро да и добавлять их очень легко чтобы добавить там 1 того я написал меньше недели но это меньше дня добавляешь библиотечку примитивную примеры кода для тех кто имеет писать их или умеют но гуглить не хочет а слева сверху мы описываем какие фичи есть о каких они категориях справа сверху пример конфигурации этих фич снизу включение мышц так как программировали на джаве то использовали готовую библиотеку для этого она называется the gals рекомендовать ее смысл абсолютно никакого нет потому что функционал там крайне прямолинейный ее можно написать за выходные самим она просто хранит флаги и позволяет вам в ваших и цехах их использовать но мы и взяли за такой вот симпатичный от админский servlet за готовые стратегии активации дальше будут ссылки для других языков на такие же библиотечки почему это храним в той же основной базе ну коллекция очень мелко как теперь это идет релиз тот же самый blue green разворачиваем новую группу серверов выкатываем туда новую версию причем у нас нет такого что пока последний бегун не добежал взвод не добежал если раньше релиз пусть даже соседи собранный она вливался если какой-то функционал не до конца готов сейчас мы можем его смело выкатывает до тех пор пока тесты проходят а повторяюсь тесты покрывают сто процентов и пи ай ай пи это все страницы там тесты просто не покрывает интерфейс полицейский вот то есть мы раскатываем новую группу серверов переводим туда трафик серверов довольно много потому что это highload но не легкие их там много десятков а потом переключаем фичу везде есть новое поведение долго ли коротко ли мы разбаловались и начали использовать эти фичи углы и не только для бизнес тестирования точнее не только для функционального тестирования но и для бизнеса тестирования это известно это же почти всем тема об этой стае я их назвал а а бэ тесты потому что это тоже важный нюанс на к которому мы пришли на на практике apts ты очень опасная тема и нужно как минимум иметь две контрольных групп и которые должны сойтись между собой для того чтобы сам тест был валиден но представьте у вас конверсия ну условно один процент у нас была не такая значит один шаг из ста покупает вы тестируете 1000 человек как как казалось бы это приличное количество людей для социального вопроса например у вас в одной выборки 499 в другом 501 количество почти такое же но в одном у вас будет 9 покупателя в другом 11 разница в конверсии почти 20 процентов случайно это ничего не значит есть статистически инструменты которые позволяют высчитать валидность теста по количеству по трафика по уровню этих дельт но мы всегда делаем apts для контрольными группами если контрольной группы меж собой сходятся тоже мы радуемся также изменение показателей который мы получаем после фича она часто не соответствует ожиданиям продуктовой команды то есть недостаточно того чтобы фича было сделано технически корректно и выполнялся от с кейс а нужно чтобы люди например больше покупали либо меньше но более дорогие товары либо те товары которые мы хотим продать либо просто сидели на нашем сайте дольше то есть всегда есть какой-то показатель на который мы хотим влиять и если вы водите фич учили вставал в нашем случае все было устроено просто примитивно мы экспортировали эти углы в google gtr google google аналитика нарезали сегменты и смотрели поведение полюс или там можно все что хочешь посмотреть вот пример ежу понятно что код эсэмэски на чекаут это неудобно checkout страница оформление заказа какие-то люди отвалятся не захотят оставляет номер телефона свой либо не захотят поводить эсэмэску либо просто передумаю то есть это снижает конверсию но с другой стороны мы получаем лучше качество номеров телефона мы получаем больше выкупа и масть товаров потом мы ассоциируем эти данные от о голах в в аналитику и мои мы видим то что грустью нет на этих заказах выше либо более качественные адреса это такое очень by засовывает thread'ов либо например на карточке товара как в амазоне можно сделать не обращайте внимание на книжку проект феникс можете и не читать хотя лучше нужно прочитать вот на кнопку купить в 1 клик понятно что она конверсию увеличивает для наших постоянных полюсе ли мы знаем их адрес мы знаем их способ оплаты в случае фацио на наличные он нажимает одну кнопку курьер поехал к нему но сколько так можно курьеров без бесполезно гонять если несколько заказов их надо склеивать в окупаемость а снижается конверсия растет чек падает он так может на корзине мы бы ему еще добавили новых товаров или рекомендации показали а так он ушел только с тем что хотел можно тестировать разные алгоритмы персонализации ранжирования всяких поставщиков полезная штука эта штука достается нам не за миллионы долларов а на нашем трафике и так сажали на такие цены за счет двух тел библиотечки когда-то голы стали полноправными гражданами в нашей системы мы начали на них навешивать часть функции контроля доступа например для сотрудника функционал для программы привилегия какие-то ранние последователи вот после этого уже три вида the glove это канареечный экспериментальные и разрешительный для контроль доступа но это еще не все есть 4 with the glove которые хотелось бы рассказать этот угол и операционные это функция который пользователь не видит они нужны например для для грейс пул деградации например мы проводим а стресс-тесты в нашей системе мы знаем узкое место мы понимаем что elastic search очень тяжело считает фасеты это действительно тяжелая задача пример запрос красное платье armani и задачу то что фильтре красные нужно посчитать фасеты без учета цвета но по платим и по armani фильтры платья о красном armani и и фильтры armani по красным и платьем то есть какой бы запрос не был если мы хотим красиво посчитать пакета для поле для faced это вот эти цифры серенький немаленькие очень тяжелые в расчете но нужны для навигации то он нам надо просмотреть всю базу товаров этот это долго даже на мощный ластик . store и мы сделали асинхронный расчет по сетов мы сделали заранее его внедрили в систему и на черной пятницы когда он понадобился и нагрузка снизилась в разы больший кликнул увидел фазе это ни кликнул не увидел а иначе обеспечит углов пришлось бы делать в мыле новый релиз собирать его автотесты конечно проверит но пока разработчики что-то напишут заноза deep ловится чтобы сзади плоть нужны из пула вывести часть серверов и дальше будет как домино о чем все еще идет речь где хранить не готовый код это либо фича branch или бы фичи toggle и либо если хотите ставьте и какие бывают виды the glove разрешительные экспериментальные операционные и релизные примерно к тому времени у нас накопилось большое изменение в мобильном приложении а мобильное приложение это важная для нас тема мы входили в топ и бесплатных этапа обычных на приложений в очень высокой конверсии хороший человек там миллион установок каждый год на минуточку поэтому это для нас важную а на тот момент модерация apple занимала около трех недель и несмотря на то что вы ставите галочку пожалуйста рассмотреть и моё предложение быстрее там bug fix три недели через 3 недели они заходят осмотрит еще неделя нужно чтоб она скатилась по устройствам пользователей если не дай бог какие-то показатели в вашем релизе и изменились не туда куда вы хотите то следующий шаг еще через 4 недели или вы хотите вы хотите функционал одновременно с сайтом мы подумали уже есть и что-то голых моих отдаем в.п. почему бы их не использовать например тот же facebook обновляет приложение каждые две недели он здоровенный что изменилось вообще непонятно вот у каждого из вас свой facebook ань итоговыми переключают ленту и навигацию и всякие новые фичи раскатывается по регионам если что-то пошло не так взяли выключили и или включили для части и посмотрели растет ли чок поэтому для мобильных приложений это наверно даже больше в москве в чем для доступных которые обновляются быстрее при этом полете будет получать согласованным функционал между сайтом и приложение мне надо подгадывать например когда в appstore у нас утвердили приложение тогда мы можем слава богу раз катить сайт и пустить рекламу по телеку нет заранее все раскатились согласовали рекламу включили пустили синхронный релиз google и встал довольно много по факту у нас их в какое-то время было две сотни это очень много и это уже проблемно хотел бы вкратце рассказать какие есть отрицательные стороны у этого подхода это производительность потому что мы обрабатываем это эта сложность тестирования самая тяжелая тема сложность кода сложности вместимости api а так как нету века и сканирования то весь api тоже быть совместим со всеми клиентами и удивление пользователей производительность решилась просто стратегий кэширования в базе там килобайта и мы их каширы очень коротко проблема нет а сложность тестирования заключается в том что происходит комбинаторный взрыв количество вариантов которые вам надо протестировать тут даже автотесты не помогут если у вас есть там много chocolat новая карточка персональное меню пока их единицы вы еще можете все со всеми проверить когда их становится десятки сотни нет решается тем что надо делать возможности независимые друг от друга фичу тогда которые тестируются относительно какого-то состояние по умолчанию если нельзя сделать независимые тогда нужно тестировать их в группе зависимости внутри то есть и эта группа будет относительно умолчанию основных то глав и недавно вот я слышал про такой техникумы и не применяли надо был оставить может быть вы будете спорить и это первое 100 testing там статистически показано что если тестирует парами вы покрываете почти все баки а количество вариантов существенно снижается там 200 на 200 не факториал сложность кода мертвый кот стоит денег сопровождении там могут какие-то баги побочные эффекты мешает просто читать тоже очень легко на практике раз в два месяца субботники выпиливаем титулы которые либо всегда включен и уже хорошо работают либо всегда выключены это достаточно редко чтобы не тратя на это много ресурсов в то же время они не успевают накапливаться по совместимости api хорошего рецепта я вам не дам потому что эго не существует некоторые делают versio не рование у нас экспанд контракт прекрасная статья уоллера есть это значит мы всегда добавляем что-то новое ждем обновления наших клиентов а когда все клиенты обновились убираем старое и также хотел бы рекомендовать располагать добры тогл и подальше от ядра то есть все ядро весь весь уровень сервисов в терминах м висит от спринга у нас оставить лес и там the glove нет тогда нужно располагать поближе к уровню представления иногда их можно даже в шаблон и пихать ну шаблонов как бы кода не должно быть но тот тут ура петти хоть можно то есть это или контроллер или шаблоны или толстое тело нативных приложений именно вот на этом уровне должно решаться к какие сервисы мы дернем а то что в ядре у нас будет два сервиса старые новые они друг другу не мешают то есть они мешают пони сложите коды но не мешают по несовместимости и 5 как кто-то вызвал этот а кто-то этот палец или могут удивиться если он открывает дома один функционал лили или цвета либо на рекомендация до работе другой или в мобилке другой решается очень легко ни коем случае не активирует углы от adsense и их надо привязывать к пользователям так как мы для каждого полете создаем мини аккаунт то у нас это решилась автоматически привязываем а о стратегии активации даже ты тестируемые абсолютно все они статичны и относительно пользы ли . b подходим к концу нашего доклада очень быстро и часто я итерации настолько быстро что у нас был релизные расписание это релиза вторник четверг потому что надо все-таки еще программировать и usb успевать но на практике за полгода было больше 500 релизов все релизные поезда мы больше ничего не ждем смело в выкатываем из из за последние два года ничего из этого не упала стабильность была очень высокой больше половины задач которую хотел от нас бизнес вот то что они привыкли получать за полтора месяца собак фиксами меньше трех дней понятно это лукавая статистика это медиана это естественно простые задачи длинные задачу дольше но все равно раньше это было невозможно сейчас по крайней мере поки или м выпивки мы выкатываем очень быстро заказчик смотрят на живой продукт как говорил о сеансе день бесплатный иструменты тестирование и собственно самое важное именно за счет этого мы и смогли найти делать неочевидные штуки которые в итоге нам подняли конверсию настолько что практически был карт-бланш на все этих тип на технические решения на продуктовые решение пока ты зарабатываешь в бизнесу хорошие деньги а это можно сделать за счет экспериментирование быстрой проверки гипотез теперь позволяется делать в твоем королевстве все что ты хочешь выводы так как в тезисах докладов было как применять в чат углы мелкие изменения сразу fav транг несовместимый фича branch если есть какая то им интеграция со внешними системами то лучше использовать фич итогов потому что она позволит вам максимально рано охватить проблемы интеграции понятно же что я имею виду под проблемами интеграции пойдет поднимите просто руки так рук мало проблемы интеграции это связь со внешними компонентами причем связь нет не только по прямой 1 косвенно это и а остатки и всякие сертификаты и производительность что данный компонент например отбирает какие-то ресурсы вот табло позволяют все это схватить максимально рано и еще на этапе mvp и сразу узнать о том что надо это или фиксить или не делать ну а в сложных случаях совмещаем оба подходы фичу такое прекрасно живут внутри врачи постскриптум мне хотелось бы всем вам пожелать видеть глаза напуганного релизами заказчика который просит вас выкатить какую-то фичу выбираете и при нём не включайте без downtime а без релиза без разработчиков просто берете включаете эти глаза этого стоят но видимо в бирюзовых как как компаниях они всегда но у нас это было очень хороший эффект полезные ссылки будут в раздаточном материале гуглится все очень легко переходим к вопросам пожалуйста микрофон здравствуйте спасибо за доклад а скажите пожалуйста а вот получается приложениях мобильных у вас а не включается через сервер да вот эти все наработки и вместе с разработками на серверными да если таковые управляется на сервере приложение просто на каждый запрос в ответе сервера получает список активных и неактивных the glove они в ответе api и так таким же образом и получается и меняете интерфейс приложения не всегда never seen но до частично большой микрофон можно сюда спасибо большое за доклад такой вот вопрос вы говорите что вас api не версия nero ванна вопрос как тогда устаревший мобильные клиенты себя чувствуют то есть у них они выходят момент не катят работу мы сохраняем совместимость то есть мы отслеживаем какое количество клиентов какой версии к нам ходит и когда все клиенты обновились тогда мы убираем это старое поле из выдачи а долгое время мы добав мы отдаем параллельно и новые поля и старые например там полное имя было одно поле стало три вот какое-то время живут четыре поля чтобы из и старые приложение свою формате увидела и новые а когда все приложения обновятся тогда можно почистить смотрите мобильные клиенты не полностью никогда не обновляются то есть какой-то процент пользователь все равно останется на старой версии нет на практике обновляются то есть вот мы уловили легкой проблемы мы мерили в плане в влияние на бизнес и и я понял что есть а старый iphone и но нет на практике обновляем от отправляешь сообщение хочет покупать и и иди за но мы фоном и все спасибо просто микрофон сюда и сюда добрый вечер интересный доклад вопрос вот небольшой все-таки когда что-то такое большое меняется допустим там версии nhibernate аватары мы используем повысили версию тут тяжело как бы то голам управлять ну тогда вы что ждете и большого релиза или как это выглядит у нас по-прежнему есть и чем раньше например вот версия спринга обновляется и тоже не операционный то угол и не мы по-прежнему использовать which a branch и тогда когда это актуально и обновление важной важное обновление библиотеки идеальный пример для этого спасибо спереди раз хорош доклад хотел спросить вы сказали вы привязываете тот же аккаунт ног персонального уникального как вы их раскатываете самом начале когда вас выходит вич а у нас начну с того что у нас для каждого пользователя уже есть аккаунт всегда потому что да как у нас обстоятельствам надо где-то хранить нету у нас анонимов во-вторых мы прилагаем сильные много усилий для того чтобы склеивать палец или то есть например в поиске вмс как все ссылки если вы нажмете то мы проецируем вас с этим аккаунтом то есть мы знаем как у пользователя остальные говорит либо прикладываем всевозможные усилия чтобы знать что это влияет на покупки и все наши стратегии активации итогов то есть код который описывает для вас от того включен или выключен даже экспериментальный они берут это это в расчет то есть они считают грубо годах и шатой кишки юзера и диапазон этих хорошей распределяют то есть прошу вы распределяете допустим 3 10 процентов вы хотите включить мото есть еще штука она редко очень используется называется эпсилон жадный алгоритм это когда вы тестируете не поровну а вы играющий алгоритм получает больше пользы что вам больше денег заработать пока идет тестирование если кто-то выигрывает нам идет об обратной связью увеличение процента эпсилон жадный алгоритм этого сделать нас но яичник или выходить cut in forma заполнителя по использованию воды или нет это делаться до основе айтишника нет спасибо я тут тоже ждал очереди немного соответственно меня тут пару вопросов одно такое предложение смотрите а как быть пользователем который не захотел новую фичу то есть я услышал просто был в коридоре соответственно вы сказали что есть возможность раскатки новых фич на мобильное устройство потом включение их соответственно для пользователя это мягко говоря может быть неожиданностью и какой фидбэк идет поэтому второй вопрос а у вас fitch ведь они могут зависеть от других вич как устроена работа зависимостями это был второй вопрос и 3 но лагерь порядка буду отвечать чтобы мозг не перегружать чуть-чуть про просто реплика последняя а чем это отличается от с джей на 1 2 только отвечу вот и первый вопрос это это как быть пользователем которому не понравилось такой пример он у нас был и для важных пользователей например там программа привилегия которые звонят у них миллионы и заказы так как мы распределяем фичу популяции ленту ты его можешь просто внести в список 1000 не будет видеть до тех пор пока оно еще в тестировании рано или поздно она выкатиться на всех если она хорошо работает либо мы превратим ее в разрешительную ну например как у нас программа привилегий то есть некоторый функционал мы в итоге включаем на всех некоторые выключаем на всех а некоторые сегментируем ну например там какие-то сортировки лучше работают там для айфонов в москве а для андроидов в регионах они работают хуже с точки зрения бизнеса пользователи могут об этом нам сказать позвонив а могут своими действиями в приложении хуже покупать начать и 2 даже важнее но исключение полиция у нас есть даже как и включение принудительно в какую-то группу а второй вопрос был ну по первому уточнения нет тут ситуация какая как пользователь может повлиять на включение или выключение в группу тогда полосе рассказать нам написать там есть какой-то vb кнопки везде не в тогах везде мы выстроимся вовлечь пользователя в диалог потому что мы его процессе счет рекомендую что купить хорошо и второй вопрос был про зависимости если у вас какие-то где деревья зависимости и соответственно какой вот это очень больная тема надо стараться чтобы их не было то есть нужно помимо по мере сил постараться чтобы toggle и были независимы друг от друга относительно какой то вот это как микро сервисы которые все тестируются относительно мастера друг друга не проверяется каждая версия с каждой а если они зависимы и но на мир там новые рекомендации только на новой карточке товара тогда тестировать их внутри своей группы вниз и все ток мы со всеми проверять внутрь этой группы где они друг от друга зависит понимаете это просто снижает как моторику право уезжай класс спасибо за доклад работает работает очень интересно про фича тогда все понятно вот про x-plan контракты multivision нас не очень понятно а если у вас таблички миллиард записи она альтере цену часа 2-3 только как вот by zero dawn time а это манга она альтареса по мере необходимости то есть у нас миллиард записи какие-то из них мы всегда остается нас там со старыми она при доступе альтареса и не для всех записей для верно если не манга ну наверно можно у нас такое правило проблема возникала потому что мы можем постепенно об абеде данные у нас нету жесткой схемы у нас не падает а р м потому мы таскаем везде hush pop и и каждый сервис он ответственный за свой кусочек этого кошмара понимает вот аккаунт сервис буквально что в аккаунте он толерантен ко всему остальному если хотите подробнее то у валеры это 20 аранты читатель просто спросил вас там не только мунга еще моя судьба мое склеили для интеграции и миску или для интеграции там шина чего сделан до подскажите пожалуйста правильно ли я понял что с учетом наличия 200 флагов в принципе можно считать что каждый примерно метод на сервис там уровне или на уровне controller'а будет состоять из колбасы и fav и вообще-то довольно таки серьезные сложности с сопровождением такого кода должны быть это правда это сложность кода о которой я говорю она не на уровне сервисов потому что сервисы от о голах в божестве случаев не знают и все равно они разные то есть новый функционал это новый сервис но на уровне контроллеров может быть колбаса языков если вы делаете зависимы итоговые надо с этим бороться сейчас у нас 100 голов меньше там на уровне 70 и второй вопрос почему именно вот такая библиотечка использованы если правильно понимаю она на каждом сервисе вести да и в каждый сервис должен сходить и выставить флаг почему не использует централизованное какое-то хранили хранилище property типа звуки пера или консула все флаги хах охраняться централизовано то есть несмотря на то что каждый сервис на каждый запрос смотрят какие-то углы включили он это берёт из из общего хранилища это можно хранить авка в консоли просто почему это не храните гонки ну можно хранить спасибо в тот же самый из который мы это уже вытащили справа страдал вы ответили на один вопрос который коллега задал получается по факту это про зависимости второе это касательно архитектуры так понимаю на вас микро сервисные что бы вы посоветовали тем кто на монолите хорошо говорит что она микро сервисная мы в эту сторону идём но наше приложение представьте себя огромный шар ник который запускается java jar он внутри состоит из сервисов он написан очень правильно да это один целостный пакет а вокруг него вы уж уже разные сервисы и и сейчас мы идем по сторону microserver архитектуры от него откусываем кусочки но вообще в монолите это работает прекрасно нет причин по которым она не работала джей мы вынуждены закончить если еще и остались вопросы можете пойти в дискуссионную зону хотели отблагодарить это небольшой презент от нас спасибо за выступление спасибо"
}