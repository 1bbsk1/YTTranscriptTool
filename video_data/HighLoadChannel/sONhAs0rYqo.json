{
  "video_id": "sONhAs0rYqo",
  "channel": "HighLoadChannel",
  "title": "Модерация миллионов объявлений в день через state machine / Дмитрий Кубицкий (Авито)",
  "views": 2612,
  "duration": 3485,
  "published": "2020-07-17T06:35:50-07:00",
  "text": "меня зовут дмитрий которые сказали и сегодня вам как работ c барре то так пару слов о баре то самый большой сайт объявлений в европе у нас более 50 двух миллионов активных объявлений на сайте у нас больше 300 сотрудников и т.п. и они пилят микро сервисы которые крутятся в кластере купер найти наши нагрузки это 35000 руб с бэк-энд у и наши пузырь с базы у меня держать до 20000 транзакций в секунду каждый день модерацию приходит более 3 миллионов версией объявлений не каждый из них нужно проверить почему так происходит мы запускаем проверку даже если вы меняете всего лишь одну букву потому что это может кардинально поменять объявление или скрыть какие-то нарушения и что будет если их не проверять я попробовал найти у нас на сайте плохие объявления с какими-то нарушениями над и было достаточно трудно потому что модерация работает вот и правило соблюдается и так зачем же нужна модерация во первых для поддержания порядка чтобы все играли по одним правилам представьте если модерации не будет то ваша поисковая выдача будет полностью забита дублями мошенники будут предлагать вам несуществующие товары пользователи будут размещать свои объявления в неправильную категорию и выезд вы не сможете их эффективно искать например будете искать iphone он будет лежать запчастях то различные юридические риски мы не размещаем оружие наркотики и девушек легкого поведения и какие-то защиты интересов бизнеса собственно которое помогут заработать компании деньги для решения всех этих проблем у нас есть ручная модерация и автоматическое и я тот человек который как раз работает аманде модерации и чем наша команда занимается мы разрабатываем интерфейсы для ручной модерации у нас на проверку приходят не только объявления на например магазина отзывы на продавцов а также аватара пользователя мы разрабатываем инфраструктуру вокруг автоматическая модерации и я написал новую версию экосистемы о которой хочу вам сегодня рассказать прежде чем мы начнем хочу сказать пару слов о чем мы не будем сегодня говорить игр уже за того вопрос и среди вас очень мало нарушителей поэтому это будет не очень актуально я не смогу ответить почему вы заблокировали или отклонили почему у нас платное объявление не смогу ответить на какие-то да и вопросы всякие числовые продукту в метрике и подробности как работает наши ручная модерация например за какое время мы моделируем объявление сколько у нас сотрудников и так далее все это продуктовые вопросы о нас конференция техническая также мы не затронем вопрос как устроены наши машины leaning модели а потому что разрабатывается отдельная команда вот но у меня в презентации на последнем слайде есть ссылочка на доклад так что оставайтесь до конца не уходите сможете послушать сегодня мы будем говорить о php и посмотрим какое собственно путь проходит объявление через модерацию как устроена наша инфраструктура вокруг взаимодействие с автоматикой и как мы работаем с демонами на печке давайте окунёмся в историю когда авито был маленьким все объявления на сайте проверялись от причину вот но продукта развивался криса пиление росло и чтобы всех проверять мы не могли линейно увеличивать количество наших сотрудников потому что им нужно оплачивать труд где-то их размещать ресурсы ограничены и нам потребность какая-то автоматизация чтобы справляться с растущим потоком и мы решили воспользоваться дата сайнс и машину лёнинг так зародилось система анти фронте фрод это аналитическая система которая предсказывает нарушение помнить в котором этом мы смотря на последние числа найти щенка и думаем заблокируйте отклонитесь или пустить выдачу вот носит конечно шутка и мы даем предсказание именно по самому содержанию этому об этом чуть попозже далее антипода тоже была своя история эта крупная система и можно выделить два таких этапом когда он только зарождался это были простыни на python и они крутились на каких-то железных машинах запускались запускались баш скриптами и могли давать только лишь какие-то подсказки и справляться в маленьком количестве случаев и давать какие-то подсказки модератор вот но система развивались и теперь наш род справляется более чем в 90 процентах случаев и люди у нас проверяют только самая сложная и запутанная кейс и это привело к тому что у нас в модерации работает только эксперты которые знают все тонкости наших правил и мы живем в парадигме которые который мы назвали him on in звук звучит довольно забавно как это работает модераторы дело какое то решение по объявлениям эти решения уходят аналитиком они на этих данных до обучаются модели они фрод начинают подсказывать еще эффективнее снова присылает объявление на модерацию в интер атор снова их проверяют и так по кругу до бесконечности собственно на этом слайде представлен брата протокол взаимодействия между анти фродом и нашей системой мы отправляем какой-то джейсон мы отправляем огромное количество полей повеление больше ста здесь упрощенный вариант схемы чтобы не городить простыню день фрод нам в свою очередь отвечает тоже действенным и какими-то решениями для нас он выступают в роли черного ящика когда они флот был разработан старой версии стоял вопрос как же провести интеграцию найти пруды с монолитом и сначала бэра был реализация на редиса были очереди на радио синод и было неэффективно и мы воспользовались очередями и на работе давайте посмотрим как же объявление приходит модерацию пользователь создает либо обновляется по объявлению запрос приходил в монолит потом мы использовали парику для для того чтобы надежно доставить это событие базу данных поднимите пожалуйста руку кто знает что такое парики или использовать его как тут никого не вижу по каким это очередь на подвесе она крутится в той же базе что и где лежат таблички с сайта нами и вы можете прямо в транзакции создать запись в таблице с объявлением и транзакционных добавить события это гарантирует дает гарантию 100 процентов что она не потеряется это разработка skype насколько знаю вот потом монолит сам же вычитывает и тут прыгаю собирать какие-то данные по объявлениям отправляет их в ребятенку который вычитывает анти фрод они фронт делает свою черную магию дает предсказания также закидывает ответ обратно wrabel монолит вычитывают эти ответы отклоняет блокирует либо пропускает выдачи ваши объявления вот но монолит такая громоздкая махина которая медленно неповоротливая она росла и компания тоже росла нужно было его распиливать появилась система для взаимодействия между сервисами database нам нужно было вынести перед нами встала задача вынести наш processing из монолита тоже сервисы и мы подумали почему бы не воспользоваться моментом никому не упустить время и не сделать какой-то рефакторинг к тому же у старого подходы были свои минусы мы высчитывали по одному объявлению за ребятам и не могли сделать какую-то пакетную обработку чтобы снизить нагрузки у нас все сообщения лежали скопом припяти и мы не могли как ты не управлять пока все не вычитаем также мы не могли понимать на каком этапе у нас происходит проблема по той же причине что все находится в одной куче и были участки кода legacy в которых уже мало кто что помнил вот и можно было их зари factory теле вовсе удалить здесь мать и что представлен путь который проходит каждое объявление при попадании в модерацию есть какое-то событие которое триггерит события которое триггерит отправку модерацию это не обязательно будет или клеит поэтому про леванте фрод получим этим предсказания и применяем действия либо проблем на ручную проверку после этого мы завершаем нашу работу все это очень похоже на state машин у нас объявления проходит через несколько состояний мы перекладываем и снова в другое до финиша стоит машин от абстракция которая моделирует систему как несколько явных состояния и переходы между ними я уверен что большинство из вас профиль на образования и вы знаете этот термин и я не буду вдаваться глубокие подробности теориям потому что доклад а нас более практично более про практическое применение но в конце доклада будет ссылочка на книгу мартина фаулера который описывает стать машин и посещайте целую главу мы выбрали алгоритму и подумали чего же мы еще хотим если вы понятие как на фары кто знаком с ним поднимите руку до труженик незнаком на фары так называемая не функциональному и требованию системе есть какие-то фичи которые описывают поведение это функциональное требование а и на фары они писают свойства системы мы захотели чтобы она была масштабируема работало несколько потоков что было чтобы было достаточно производительно не создавала какие-то большие нагрузки при всплесках потока чтобы было расширяемое например новое состояние объявление можно было просто добавлять чтобы было прозрачно мы могли быстро устранять аварии и чтобы она была устойчива к ошибкам вы могли спать по ночам сладким сном и не волноваться давайте теперь рассмотрим нашу реализацию мы выделили состояние через которое проходит наше объявление финиш написано абстрактном потому что мы на самом деле в него не переводим а сразу удаляем из это состояние чтобы не строить какие-то garbage collector и на кронах которые бы и чистили таблички потом мы составили граф переходов здесь самое важное это первое состояние без импорт его может она обладает наивысшим приоритетом его может стриги рить события которое говорит что этому нужно моделировать и в него можно перейти из любого состояния там получается минимальное количество проверок счет на специфичное состоянии это error когда возникает какая-то ошибка мы переводим в него а если эта ошибка например мы не знаем что с ним делать вот и финиш topstar окна из статус как я уже сказал затем мы составили небольшую схему нашей системы сейчас кратко рассмотрим я дальше буду рассказывать про каждый про каждый из элементов эта схема будет всплывать еще не раз здесь на этом сладит что это стоит отметить database event который управляет события оно попадает к нам в сервис мы вычитываем происходит транзишен ту импорт и она попадает в очередь на по сгрыз очередь на по сгрыз это можно сказать ядро нашей системы 30 and на я очередь которая хранит объявление в различном статусе и какую-то дополнительно нету информацию о них почему мы выбрали такой подход как таблицы очередь на таблиц в базе данных ну во первых на реляционные базы данных как пост раздает нам все гарантии и сито там изолированность консистентной надежности тамар нас которая нам нужны там есть сортировка блокировки ворот доит функционал ский плакат одним расскажу попозже если рассматривать альтернативой например редис или манга то кажется что они не обладают таким функционалом и база она получается из коробки более эффективно решает наша задача если рассмотреть например кафку почему бы вы не хранили все в кафки то она мы пришлось как-то вычитывать из него в какой-то буфер тоже куда-то складывать для надежности это все накладные расходы трудно разрабатывать вот и так далее и используя в таблице на базе данных у нас есть запас 12000 транзакции секунду на одной машине это нам хватит на на приличное время для роста почему под раз потому что нашей компании работают эксперты в этой базе данных но я рекомендую вам выбирать то в чем вас больше всего экспертизы в москве тоже есть такой механизм с восьмой версии а тоже называется ский плохо и новый так примерно так выглядит наша табличка с очереди наших объявлений каждое объявление может находиться только в одном состоянии также мы используем версии они были скажем на чуть позже и есть дополнительная поля для организации очереди этот запрос получение пачки объявлений из этой таблице мы используем колонку шаги ляд для того чтобы реализовать механизм какой-то отложенного запуска то есть мы можем случае бизнес требования или случае ошибки делать какой-то сдвиг будущее и например обрабатываете табеля не а через несколько минут плюс сортировка позволяет нам и сбегаться избегать зацикливания поля locate it они используются во первых как флаг о том что строка заблокировано а во-вторых коктейль например если worker закончилась папочкам потом упал мы через например через минуту можем взять объявление заново другим маркером и функционал for одесский тлог один из наверно самых важных здесь он позволяет вовремя прочитывания таблице не ждать пока спадет биологическая брекетам блокировка на строку а двигаться дальше таким образом у нас могут работать несколько маркеров они не ждут пока каждый завершить свою работу могут набирать какую-то пачку работаем дальше также важно вы построить правильный индекс чтобы все это работало быстро насколько быстро это работает на этом графике представлен представлен 95 person тилль за который работает эта хранимая процедура и 95 persantine превышает 40 миллисекунд даже в случае каких-то аварий на слайде выделен участок когда у нас произошла авария и размер очереди превышал и и естественно размеру на несколько порядков вот сразу хочу отметить что вся очередь так как она обрабатывается нормально ее размер всегда стремится к нулю мы оному таким образом может полностью помещаться в памяти выборов в подход очереди на пост для себя мы получили многопоточности масштабируемость у нас есть метод позволяющий получать пачки объявления унижать блокировки и мы можем запускать сколько угодно маркеров мы получили пакет на обработку мы выбираем например там по 50 поста по тысяче объявления за раз и тем самым снижаем нагрузку на базу данных нагрузку на сетевые ресурсы у нас есть запуск по расписанию случае чего можем откладывать и вперед и есть авто разблокировка и это дало нам прозрачно мониторинг простым запросом с группировкой по сайту мы можем узнать сколько сообщение у нас находится в текущем стоите и таким образом если какой-то размер будет расти мы поймем что проблема на а проблема сейчас именно там дополнительно мы используем колонку как твой они локатор фолз например если worker взял пачку обрабатывает ее падает если он перепады не из он сможет взять и заново и мы не будем ждать время разблокировки и как я уже говорил на снят гаррош подобных удалений потому что таблицы могут пухнуть из-за аварии например или worker крон они будут справляться и это все за дополнительно нагрузку какие-то фруктов теперь перейдем к следующим элементом нашей системы это стоит процессор это обычный класс он реализует какой-то демон мы запускаем стоит процессор и в разных в нескольких экземплярах и его задача в том чтобы выбрать объявление в своем состоянии за которые он отвечает потом используя data collector о котором я скажу позже собрать данные сторонних ресурсов обработать их а потом вызвать транзишен на этом коде можно увидеть почему только что сказал следующая любят система data collector мы инкапсулировать всю нашу систему всю весь сбор данных в 1 класс мы использовали газу чтобы как-то распараллелить хоть как-то раз проверить запрос и потому что параллельности там больная тема в печке мы почти типе ходим в разные сервисы с помощью мультик ура и таким образом снижаем общее время сбора информации по объявлениям и на выходе мы решили отдавать единый класс resort вместо того чтобы давать там десяток аргументов потому что это удобно и в нем внутри находится массивы и коллекции где мы просто по этим один там за константное время в игорян данные стоит отметить что то как это демоны нужно не забывать закрывать метрику использовать фонарь например у вас может случиться исключение она выбрaться куда-то наружу до закрытия метрики не дойдет и вы не узнаете что вас например тайм-аут и потому что метрика просто не будет писаться плюс мы каждое исключение приводим к своему собственному для удобства и предан туда привез следующий элемент транзишен имели не менее важна чем остальные его задача заключается в том чтобы брать объявление и просто менять ему в базе данных стоит на другой он открывает транзакцию под блокировкой выбирает объявление с базы делает проверки правильного в правильном листы эти она находится поэтому потому что могут быть гонки проверяет версии проверяет worker а вот и делает собственно говоря апдейты потом комиссии либо откатывается мы вынесли все проверки языке ли запросы на стороны печки чтобы это можно было проще покрыть тестами и так же хочу отметить в конце строчку запись в репозитории истории за это тоже отвечать транзишен мы записан данные в мозгу мы живем в параллельном мире многопоточном и конечно на сторону не обходят не обходят проблема гонок и нас это очень часто явления и у нас есть способ способ защиты от него рассмотрим типичные кейс гонки пользователям дети свое объявление и через несколько секунд подумал что о блин можно добавить еще более красивую картинку или забыл поставить запятую обидеть и во второй раз мы уже успели отправить прогноз отправить данные поэтому вонзив рот вот или же они просто пришли в разном порядке потому что очередь не гарантирует нам какой-либо порядок мы применили действия сначала на прогнозе для последней версии объявления все хорошо но потом приходит старая версия и там например решение может кардинально отличаться конечно же нам нельзя такого допускать мы очень активно используем версии у нас есть версия объявления она на три месяца на каждый апдейт и у нас есть версия прогнозы анти фродо который мы ожидаем то есть если нам приходит более старая версия чем у нас сейчас есть мы не просто откидываем и ничего с ней не делал коротко нашей инфраструктуре все это кроется в кубер найти поднимите руки кто использует камерной цепи чки отлично каждый пот выступает у нас демонам и основной процесс по да это печки и отсюда все вытекающие обстоятельства если скрипт падая с какой то ошибкой1 а под тоже падает и купер нас начинает его перезапускать вы решили это какое-то время у нас минус один работающий instance как эта просадка по нагрузке ну и купер на и сам следит за всем и никакие супервизоры здесь не нужны но супервайзеры можно использовать ничуть не хуже чем шире lingq обернется для таких данной печки до нас очень много демонов на печке и есть конечно же подводные камни они сейчас расскажу первая из них это connection pool и собственно его в пищу и нету у нас одно состояние у нас одна соединения если connect базе рвется такое происходит довольно часто то приложение просто перестает работать оно стучится закрытый connect его скупиться ошибки бороться с этим можно двумя способами либо прокидывать исключение наружу тогда ваш демон упадет и перезапустится тем же самым супервизором или кудрин этом и есть второй способ по которому мы пошли мы обрабатываем ошибки от сервера базы данных и костюм их в исключения broke in connection и делаем disconnect то есть за 0 объект видео таким образом происходит disconnect она следующей операции мы делаем проверку коннекта если у нас видение разорвана to connect происходит автоматически отключение вопрос n дальше для того чтобы для того чтобы логика приложения и обработка ошибок в нем продолжали работать как было задумано вторая проблема это не закрытая транзакции в демонах она особо astra например если у вас есть какие-то супервизоры на транзакциями которые на уровне печки запрещают запускать транзакцию в транзакции у вас просто в памяти выставиться флаг который будет некому снять у вас получится не закрытая транзакция в которые будут случаться другие запросы и пофиг сиди там можно только перезапуском приложения также стоит отметить обработку сигналов на каждой итерации если вы например захотите плавно завершить ваш скрипт или же сразу прибить его и ручная отправка метрик потому что обычно оно вызывается на деструкторы в режиме работы веб-сервера а в гимнах вы можете не не дождаться этого вызова например из-за того что while true будет ждать чего-то там также стоит учесть что в режиме работы веб-сервера памяти не очищается и это может то есть в режиме работы демона память не очищается как в подходе slip сервером так нам запрос пришел и умер это может проявляться например при использовании симфонического я потому что там объект как синглтон если вы не перенесу riser уйти свойства на следующей итерации демона вы можете получить свой со со старой терпите рации это может сломать вам логику но это можно отключить помощью флага шериф фолз который устанавливается в конфигах сверхнизкого dio перейдем к теме в стоимости обработки ошибок у нас вокруг агрессивная среда все так и норовит взорваться либо сломаться и упасть и наше приложение должно как-то жить этих условиях ведь мы хотим чтобы у нас было крепкий и здоровый сон не вставайте 4 утра и не фиксить ошибки что с этим делать тут никакой магии нету мы использовали подход что мы крайне детально работаем с ошибками и очень подробно he have обрабатываем вначале мы выписали все ошибки которые только могли придут смотреть на листочке потом мы проработали для каждого рода ошибок то поведение системы которая бы мы от него не ожидали ведь каждый такой необработанный кейс это не определенное поведение вашей системы вы просто не знаете что будет происходить мы выделили для себя внешне сбоя например отказы шина данных отказ ребята какие то http сервисов или сетевых обращений ведь как известно сеть ненадежно аварии базе данных профилактические работы или например простой простой paramount слои вода мастера и внутренние сбоя мы не застрахованы от синтаксических ошибок в коде от приведения типов например к нам приходит джейсон мы его парсим и там оказывается строка нет в методе у нас так int int и у нас может выпасть нам нужного лидировать данные которые к нам приходят ведь если придет неправильный формат мы просто не сможем бизнеса вы его корректно обработать к вам в очередь может кто-то запушить несуществующей ой там и вы об этом можете не подозревать кто-то может просто ошибиться или может произойти какой-то переключение сред или какие-то ошибки и этот атом может болтаться вас бесконечно в очереди такие кейсы тоже нужно обрабатывать это различные другие исключения которые спички и не закрытая транзакция которых я уже говорил когда мы выписали ошибки продумали что если мне делать мы начинаем писать надежный код все оборачиваем в треке затем а каждое исключение в печи мы описываем отдельным блоком и реализуем ту логику которую мы выписали до этого в конце мы все-таки перестраховывается его им срок был и для сразу мы задаем какое-то дефолтное поведение которое бы мы хотели ожидать от нашей системы в случае какой-то новой ошибки или непредвиденной в нашем случае мы сделали анлок все пачки объявления и просто сдвигаем ее на 30 секунд вперед чтобы попытаться сделать следующей итерации и в итоге получается что вас кода на обработку ошибок гораздо больше чем бизнес слова но это нормально и приложение будет у вас очень устойчивым надежном будет будет переживать всякие апокалипсис и отключения и так далее закладывайте время на обработку ошибок и на теста но всего не предусмотришь ведь мы не пророки система развивается меняется могут возникать новые ошибки и нам на помощь придут таких штуки как логирования метрики и тестирования они будут помогать устранять на то что мы не вы не выявили на предыдущем этапе про логирование я америку не открою мы лоббируем каждое исключение и не скипом его если вы быть и скипать вы по этому будущему потратите очень много часов дней на дэбак или ваши коллеги или это ждет ваших коллег но был один кейс мы хотели понимать что же произошло с объявлением например вчера или позавчера возник какой-то баг но сейчас объявление уже совсем другом состоянии система тоже поменялась мы можем искать но ничего не найдем мы захотели это решить решили писать всего в мангу посчитали размер заказали сервера сделали копыт коллекцию и помните слайс транзишен им каждый транзишен пишет в репозитории истории мы туда складируем 2 сонечки где есть эта информация по объявлению его дичь ник версия транзишен откуда куда был произведён переход какой то дополнительные данные можно пробрасывать какие-то свойства других объектов в этот массив чтобы знать какой слепок было тот момент времени ну и сама сама время это уже помогала нам не раз таким образом мы смогли выявить гонки которые в простом случае вы велели очень долго следующий стоп нашей помощи это метрики мы пишем огромное количество метрик покрываем ими буквально все например полное время конвейера которая проходит наше объявление время каждого запроса к базе данных количество тиков демонов количество пустых тиков размеры каждой очереди сколько действий мы применяем появлением за какое время как у нас исходящий и входящий поток его разницу на этом слайде я хочу кратко рассказать про такой метрику как мы назвали empty logs бич что означает пустой заблокированный пустая заблокирована пачка каждый демон стоит процессор выбирает пачку из базы мы смотрим если на пустая мы сделаем слитно несколько секунд чтобы экономить время secu не создавать нагрузку и такая метрика пишется у нас графа ну и она отображает вот если смотреть на верхнюю границу метрики она показывает нам запас прочности наших демонов то есть сколько холостых тиков система совершает и если происходит какая-то авария например как здесь то мы видим что запас прочности резко падает и все наши демоны становится становится загруженными сигнализирует о том что произошла какая-то аномалия нужно разбираться на этом можно повесить например alert в графа не к сожалению демоны не передашь клей чтобы проверить его ручками мы пишем много тестов наш пытка вериш более 90 процентов мы подымаем ribbit мангой по сгрыз как внешние зависимости и работаем с ними в тестах напрямую чтобы быть как можно ближе к реальности а что тебе сервисом и мог им использованием печь keddy нет хочу отметить один кейс наверняка вы захотите чтобы не каждое исключение заваливала ваш пот и не выкидывать его наружу вы можете захотеть глушить ваши исключения но как тогда быть как проверить кейс что произошла ошибка если она заглушена на каждую ошибку me мы пишем метрику а затем в тесте просто проверяем была ли эта метрика увеличена или нет итак мы разработали две системы и перед нами стояла задача как как собственность переход со старой на новую чтобы не делать большого downtime а бизнес и страдала и так далее мы выделили две крупных части это наш processing который применяет действие у нас исходная данная монолит обрабатывает весь поток мы решили пойти путем фич итогов добавили несколько fitch итогов монолитен затем мы средствами ребятенку скопировали очередь в которой пишет div рот и начали подсчитывать прогнозы еще и в сервисе но вычету или холостую и ничего с ним не делали затем мы включили вич итоговый номер один мы начали мы отключили обработку тестовых объявлений монолите и начали обрабатывать их в сервисе посмотрели что все хорошо решили приступать к настоящим объявлением но так как пробросить какой-то канала между сервисом монолитом достаточно накладно мы решили детерминировать заранее какие объявления у нас будут обрабатываться в сервисе взяли остаток отделение нас решили поработать с одним процентом запустили сначала на пять минут раскрыла некоторые ошибки и моих пофиксили написали тест и потом запустили на денек и в конце запустили на неделю посмотрели что все работает включили 3 фич итогов полностью отключили обработка в монолите и у нас сервис как бы все процессе следующий крупный элемент то импорт он отличается от процессинга тем что мы отравляем больше ста полей по каждому объявлению чтобы по ним принять какое-то решение здесь нужен был другой подход мы решили сэмплировать наши datasette а из монолита и из сервиса чтобы затем сравнить их мы так как у нас вложенные структуры массивов мы решили все привести плоскому виду с помощью array dot да все пакеты или my night затем мы отсортировали и с помощью родив а мы просто искали дефо между этими силами также воспользовались кич итогам с помощью что вы отключили запись в очереди из монолита и начали писать о черт очереди за ребята но не обошлось без аварий я перепутал название хатидже и очереди там было . и нижняя подчеркивание вот но все хорошо закончилось у меня был фич итогов я обратно и включил маркеры монолите начали писать в очередь для нтв рода все было отлично а сервиса просто откатил и удалил нечитаемым очереди вот какие выводы мы можем сделать из моего доклада что модерация это инструмент который позволит вашей команде ваша компания получить какое-то конкурентное преимущество соблюдать порядок на площадке зарабатывать какие-то деньги и доносить счастье до пользователей модерацию можно реализовать как конвейер ведь сущность можно перекладывать из одного состояние в другое между различными внешними системами очень удобно интегрироваться очередями например с помощью рабби танки а против гонок можно бороться versio не рование каких же показал очередь на базе данных надежное производительна и можно организовывать свои блокировки и worker и не будут мешать друг другу следует обрабатывать ошибки подробно тратить на это время чтобы системы были надежными и устойчивыми для удобства можно лакировать цвета по конвейерам чтобы потом как-то разбираться что же произошло у нас день назад и какое решение мы там принимали если у вас большие системы вы хотите произвести как это переключение кто не обязательно делать 01 и переключайся но ментально можно использовать гора дуальные выкатки и и что угол тоже удобный инструмент чтобы как-то безболезненно делать переключения ну и на печке все-таки можно писать демоны кто бы что не говорил вот как я уже обещал я привел здесь 2 ссылочки первое этот доклад моего коллеги про автоматическую модерацию как работает машин лёнинг у нас более 200 моделей которые ускорят а это моно разные нарушения вот танцы тоже достаточно интересно и книжка мартина фаулера простоит машин также вы можете оставить отзыв про мой доклад вот спасибо за внимание и я готов ответить на ваш вопрос дым спасибо за доклад мы бы хотели тебя благодарить и вручить тебе сертификат и колонку так неожиданно покажи всем окей и теперь мы готовы к секции вопросов не забудь пожалуйста выделить два лучших вопроса чтобы мы их тоже наградили книжниками здравствуйте разговорилась за доклад два вопроса есть вы упоминали что сложно тестировать демоны и руками и большое покрытие вас если у вас автоматизированные тесты которые проверяют вот этот механизм в виде черного ящика на вход какие-то данные там объявления на выходе фиксированный результат это первый опрос 2 вы упоминали что в случае если коннектор рвется соединение перри устанавливается непонятно в это случае соединения перри устанавливается неявно для вызывающего кода или выбрасывается исключение которое отменяет текущее транзакцию перри устанавливается и со следующего со следующей операции соединение восстановлены ну и следующее сообщение обрабатывается да я вас понял сразу начну с этого вопроса мы делаем disconnect когда получаем ошибку и как вы сказали кидаем исключения дальше и код думает что у нас произошло исключение и собственно логика как бы продолжать работать в режиме ошибки а потом на следующем запросим базе данных мы просто устанавливаем connect вот я ответил да благодарю и по поводу первого вопроса этим иди фронт он занимается отдельная команда для нас это черный ящик и мы его не тестируем команда сама пишет свои тесты укрывает вот у них python машин drawing и у них там что-то свое я в этом особо не разбирался и видимо я не очень корректно сформулировал для речь не про сам вот эту систему indev рода а про ваши демоны которые реализует механизмов с эмо изменения состояний объявление вот этот механизм покрыта в до тестами или только unit тесты и ручная проверка давайте вкратце расскажу про наши тесты это тоже интересная тема значит тесты запускается на каждый push подымается отдельная тестовая среда в тоже в кубер нити подымаются под и rabbit по сгрыз манга настоящие под и как будто настоящая база дальше мы инициализируем базы какими-то изначальными значениями и потом в сетапе каждого печенья теста накатываем миграции в каждое мнение тесте мы записываем базы какие-то данные и после прогона теста мы ходим базу запросе коми и смотрим а правильно ли там все записалось вот и в случае ребята мы закидываем в под какое-то сообщение вот и вычитываем его туда благодарю вас просто спасибо за доклад вы говорили что у вас демоны на php и что есть такие проблемы что у вас там память утекает потому что это все таки php и параллельности не хватает потому что это снова таки php и тут собственно вполне думаю многих возникает вопрос логически почему вы пишете демоны на php когда есть такой замечательный инструмент как гулдинг который очень легко позволяет вам написать быстрые многопоточные работающие хорошо с памятью и бережливо вот написать все это нагул инге и тем более что вы для если вы там не знаю использовали бакунин тепло и рф на печке для того чтоб тепло эти у вас были бы проблемы или даже в анси были там с микро сервис небольшой архитектурой уже на кубе рн это сюда у вас уже там система с кодами которая подразумевает как раз таки работал с микро сервисами где очень легко развернуть большое количество демонов на гол почему все-таки решили писать их на печке и почему продолжаете их писать на печке когда уже как бы многие доказали он на своем опыте что писать демоны на гол это трубы и там вот я развернул спасибо за вопрос в случае утечек нам помогает купер нес наш пот течет по памяти падает купер на себя просто перри подымает в случае многопоточности нам также помогает купер низ мы запускаем можем защитить не демон там 20 30 в 100 экземпляров у нас будет 100 пудов они например в сто пудов для применения 10 к объявлениям они не будут мешать друг другу каждый будет обрабатывать свои пачку по поводу га ланга дело в том это все диктуется с продуктовой точки зрения и мы работаем в режиме что носит какой-то лимит на разработку мы не можем постоянно мы не можем тратить время на рефакторинг у нас уже была написана часть кода час логике на печке которая требовалась для этого у нас были очень сжатые сроки нам нужно было все быстро перевести мы не хотели рефакторинг 1 час логике нога лонг и вот тратить на это время к тому же на печке все вышло написать достаточно быстро но принципе будущем эту систему можно переписать нога long при условии что будет достаточный достаточное количество ресурсов и времени вот еще вопрос здравствуй спасибо за доклад правильно ли я понимаю что если у вас добавляется новое состояние у вас добавляется соответственно к и тапочек определенная обработчиков можете целом описать как вот добавить вашу модель новое состояние хорошо мы до полярного состояния сначала добавляем константу в класс state потом делаем новый транзишен который будет переводить это состояние кстати хочу отметить что у нас есть только переход в у нас нету из а в б у нас есть только в.б. потому что у нас может происходить переход практически из всего ко всему заводим транзишен потом заводим стоит процессор который будет вычитывать или используем уже имеющийся он вычитывает объявление в sims 3 потом делать какую-то логику в коде и видит условия и мы туда в эти условия добавляем перевод в новый стоит то есть правильно ли я вас понимаю что на каждое новое состояние у вас плодиться новый демон который умеет выбирать именно эти объявления именно их он обрабатывает то есть добавление нового стэйта равно добавления нового демона нет не всегда но не если нельзя использовать имеющийся уже да там ну да получаются если у нас есть какой-то новый стоит который мы хотим обрабатывать и тоже с ним что то сделать там и обсудим новый демон да и песчаными музыку до самом деле ну сложно по моему с той точки зрения что ну как бы демона плодятся можно было сделать то есть часть в логику кода перенести немножечко то есть максимально простой выбор по состоянием до соответственно все-таки какие-то события происходят который подталкивает на переход из одного сатане в другое то есть какой то выполняется правил значит перехода правильно да ну смотрите вам нужно будет выбирать объявление в какой в разных стоит их правильно потом вам нужно будет как-то сортировать посты и там чтобы сделать пакетную обработку и передать дальше в это время может что-то произойти пока будете сортировать все это будет лежать в памяти я принципе вас понял вы хотите сделать какой-то роутер правильно единый демон там свечи ну да единый демон которые можно масштабировать а роутер он такой банальную словно ты в этом состоянии находишься есть обработчики состоянии все он знать что нужно делать год ну у нас с этой инкапсулированным в каждой демоны мы решили не делать имею универсальные большие системы ведь если понравится эта работать это фичу это защитит все а так у нас есть каждый macy's класс отдельный и мы реализуем логик только в нем и никакие не до него просто что-то там все все в кучу пихать да там как бы просто я вот сам подход то что там есть один демон которая там занимается условно это выбор когда там и дальнейшей как была вика уже инкапсулированы в каждом классе да там непосредственно состоянии просто не надо будет добавлять на каждый новый state новый демон если выпускаться наверное плохо объяснил можем потом все хотите еще вопрос добрый день добрый день спасибо за доклад надеюсь он по достоинству будет оценена перформанс review желаю найдем успехов 8 вопрос про гонку вы сказали что когда вы собираетесь обрабатывать некое состояние которое больше того что вы ожидаете вы просто это откидываете вот и не пояснили как вы дальше с этим работать правильно ли я понимаю что как бы если вперед пришло состоянии объявления но не приходил состоянии об изначальном объявлений то вот то состояние таким ты просто но она никуда не денется и вы никогда это не обработайте никогда его не отвалите рать я наверно здесь именно виду что-то другое смотрите например приходит объявление стоит на импорт она переходит происходит против рот у него меняется стоит ждет ответа танцев рода мы выбираем объявление в этом кстати чтобы за процессить и тут же к нам приходит в этот момент что объявление опять надо отправить на импорт и получается может произойти гонка и мы выбрали batch котором сообщение уже могу быть другом устоите получается или за время пока мы у нас памяти это было сообщение мы собирали данные по нему и отправляли в рябит intel за это время могло прийти то же самое то же само объявление и нам надо бы заново и пустить по всему конвейеру я понятно объясняю относительно понятно то есть но мой основной вопрос он в том что не получится так что так как вы откинули ну вот одно из сообщений в очереди то не возникнет такой ситуации что версии объявления 2 которая почему-то пришло позже версии объявления 1 никогда не будет право лидера wanna и таким образом можно хакнуть вот в этом уж anti-fraud нет версию 2 мы не откинем потому что она больше чем версия 1 который мы сейчас обработан если мы обработаем версию 2 приходит версия 1 мы откидываем вот я именно про эту ситуацию когда приходит версию долго точнее когда они вот в том порядке когда вот вы подкидываете через это никак нельзя сломать ваш мотив рот нет никак не я fine упаси вопрос первый ряд я здесь тоже там тоже страус спасибо за доклад хотел спросить по поводу профилирования приложений вы описали то что вы метрики которые прямо из real-time а записываете в мангу дальше отображать его графа не я правильно понял не для для метрику нас своя инфраструктура его лета и для этого мы используем там коллектор метрик называется были на по моему вот и кли-кли house я понял почему вот эти друзья давайте еще один вопрос после которого фирма риру приду я вижу после которого дима выберет два лучших вопроса и все следующие обсуждение будет уже в кулуарах привет спасибо за доклад у меня один вопрос точнее два маленьких первое это даете ли вы время пользователю исправить свое объявление перед тем как он будет отправлено там на удалении ну или по нему будет у кого-то принято решение потому что человек разместившие коллекционных не ок мог через минуту понять что он совершил ошибку и как бы отредактировать его тогда вторая версия будет в принципе валяный то есть если у вас какое-то выгнал лак перед принятием решения по объявлять ним и второй вопрос я предполагаю predict самого самой токсичности там объявлений или ошибки грязи что нужно принять поход решение занимает какое-то время вы отправляете запрос и там питон модели машин и все такое то есть ограничители вы как-то по времени сколько раз я могу в минуту редактировать объявления нет это никак не ограничивается вы можете меня сколько хотите хоть там раз в 3 секунды если вас не забанит антиспам мы все это конечно отправляем на проверку вот могут возникать гонки и мы мы лишь принимаем сообщение и как ты их обрабатываем мы не ставим какие-то задержки пользователям или как-то препятствием добавление объявления и ответил про задержку до интересный вопрос мы мы можем давать задержку благодаря вот я показал есть колонка шею этот мы например можем схлопываться наш поток нас нам примеру приходит первый апдейт мы ставим на 30 секунд вперед к нам приходит второй пока еще три секунды прошло мы можем переписать его вот но мы не стали никаких задержек мы работаем как есть почему нет он сможет сохранение пользу сохранения объявления редактирования она с модерацией напрямую не связано мы лишь как последствия его действия то есть он может делать там зритель сколько хочет мы ловим каждое событие апдейта и отправляем это все на проверку нет мы за пользователей ничего не делаем это результат ваш ваш почти не влияет на само объявление она просто сигнализирует модератора о том что я плохой ну она либо дает подсказки модератору либо если уверенно сама его отклоняет или блокирует вот собственно в этом 3 вопрос тема примет стопроцентное решение что объявление плохой пользователь еще его ридак просто нажали и нажатии на кнопку сохранить что произойдет объявление тоже не существует ваша система а переделаю чему не существует объявление но оно удалено или закрыто там она период кроется просто если мы например отклонили объявления пользователи вовремя редактировать то она просто попадет выдачи опять провериться попадет выдачу zdravstvuite может так вопрос смотрите то есть у вас на каждое сохранение по сути отправляется запрос на валидацию я правильно понимаю смотрите поститься там объявления сохраняет у вас направляется запрос сразу наблюдаться он через пять минут и редактирует примеру да если у вас прошлый запрос как бывали дерутся и снова отправляется запрос на валидацию то есть у вас постоянно идут запросы на валидацию version ность и исходя из это version насти у вас постоянно там одно и то же сообщение может вам разные версии вам могут в лидеру современную да может такой приехали хорошо что вы делаете в случаях когда вот вы его свой сайт когда ну и высосать из на рассказывали о том что очень сложные вопросы у вас занимаюсь свалятся ручная да а если у вас будет один человек просто вас память одним и тем же сообщениям редактировать там две три буквы 2 3 цифры и все эти запросы будут как бы по сути сложными что вы будете делать в этой ситуации ну мы то есть вы просто спамить и получается ну человеку то сидит оператор который у него просто работа растет а по-хорошему извиняюсь только он там два-три слова 23 символов сообщение тому же картинки меняются ну то есть как то вы муж вы думали как то вы лидировать такие вещи там от одного и того же пользователя либо если человек изменяет сообщение то версию которой уходит 1 даже если она там момент находится там на состояние валидации и и сразу обрубать как-то и по сути дальше итак вы не отправлять я понял я раз когда показал структуру нашей табличке говорил что у нас есть колонка секундочку которая позволяет управлять расписанием вот мы можем пользоваться этой штукой и вы будете где каждый 10 секунд редактировать объявление мы будем case di секунд перезаписывать и она всегда будет на самом начальном этапе конвейера и дальше по нему не пойдет вот но в этом смысла мало зачем вам при датировать в объявлении ведь она не попадет выдачу вы каждый раз будете редактировать она полежать модерации подачи не попадет итак спасибо дальше мы можем продолжить обсуждение с димой дискуссионной зоне спасибо еще раз спасибо санта сила"
}