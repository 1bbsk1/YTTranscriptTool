{
  "video_id": "RDWz8_xuoWE",
  "channel": "HighLoadChannel",
  "title": "Распространённые ошибки изменения схемы базы данных PostgreSQL / Николай Самохвалов (Postgres.ai)",
  "views": 5572,
  "duration": 3047,
  "published": "2021-10-04T02:47:02-07:00",
  "text": "всем добрый вечер добрый вечер вот это правильный слайд меня попросили сделать красную тему спасибо что здесь пришли послушать тема очень интересна будет тема которая так или иначе у всех проектов вылезает в случае изменения схемы базы мы знаем что очень часто бывают проблемы с производительностью и не только и как раз как сделать так чтобы этих проблем было меньше мы сегодня будем обсуждать еще раз меня зовут николай самохвалов как уже было сказано времени на представление нет я скажу только что более тысячи за свою карьеру изменений схемы реляционных базах но прежде всего позвольте я сделал или заревел то есть я считаю что у меня есть некоторый опыт чтобы стоять на этой сцене и моя компания довольно молодая после сияй мы как раз сейчас специализируемся опять же на том чтобы улучшать управление в том числе изменениями в частности и делать это автоматически о чем мы сегодня тоже будем говорить сразу скажу что конечно же бывает слышишь в докладе была реклама ну во первых от реклама открытого продукта то есть это пан source во вторых это реклама моего продукта который моя команда и я делаем так что я считаю что то меня полностью извиняет если кто так считает иначе но напишите в комментах это еще раз я почитаю вот этот главный самый главный слайд видите какое мне имя удалось легко запомнить битве хайло . 2021 вы там сами можете найти эти слайды они останутся открытыми и мы можем с вами асинхронно продолжать если у вас есть вопросы или вы если смотрите вот в ютюбе в записи я кстати призываю всех смотреть holod материалы в записи очень много выкладывается полезную полезного и одна довольно медленно устаревает я всегда когда краз лечу через океан и я смотрю какие нибудь материал из прошлых конференций так что пожалуйста идите вот по этой ссылке и комменты там открыты ну google аккаунт уже о чем чем мы сегодня стоит ожидать во первых конечно же вот доклад называется таким образом самые популярные ошибки которые делают люди так как я приму комитете холода я за это все эти годы там 2007 года хорошо выучил что если сделать такой доклад то это привлечет внимание и конечно же я собираюсь показать какие-то примеры но это не главное главное чтобы вы запомнили принципы какие то что все примеры слишком много ситуации которые бывают слишком много разных ситуациях что-то ломается и постепенно надо к ним готовиться по мере роста проекта вы делаете то лучше и лучше но главное усвоить принципы как готовятся не только но но он announce да то есть не только не как известно мне известно но еще и канон анонс то есть некоторые это очень сложно но есть некоторые методы они они сегодня поговорим как быть готовыми к совершенно неизвестным вещам чтобы не было downtime а при изменениях схемы а также чтобы еще в целом у нас или заделались бизнес обычно требует чаще и качественнее да ну и соответственно я хочу показать вам конкретный путь как выстроить это именно в этой вашей организации кстати поднимите руки пожалуйста кто спас гасом работает до есть люди процентов на меньше десяти процентов не с поясом удивительная картина главное сцена холода и большинство работает с подвесом 10 лет назад это просто было сложно было себе представить здорово те кто не с поясом вам тоже будет я надеюсь интересно и и некоторые вещи они общий здравый смысл но конечно же некоторые штучки было чисто по засовы и мы увидим это а терминах д м л д д л я надеюсь все понимают у на всякий случай да это мы many places онлайн кэш и да это и финишный лак le male to select апдейта insert одели ты ну еще можно tranque туда засунуть и наверное еще вы их то есть сети недель это alterg рейд alter дроп все вот эти штуки и что такое database мигрейшн дурацки дурацкое название оно пришло я подозреваю что из мира ruby on rails там так ну прижилась на самом деле слово такое перри использована перегруженная потому что миграция это обычного там из-за уроков по фгос мы иммигрировали ли еще что то когда мы меняем схему мы никуда не мигрируем да мы там колоночку добавили но почему-то назад так вот никто называют дтп с различают это бы с кимом игре шанс это поезда и там играешь нас отдельно но очень часто это эти темы переплетены как раз в 2019 году доклад назывался дорогой делить я там больше про изменят данную говорил сегодня про изменение схемы но еще раз темой переплетены и изменяя схему в иногда вынуждены и данное менять но в целом это это тема называется до 8 грыж нас еще вот из википедии можно увидеть data may change management с кем over шиллинг схема evolution общем вот такие термины есть целом это планирование планируемое изменение в схемы базы и с той же википедии мы тиражи первых рядах читая плоским о мая гришин увидим вот эту фразу что изменение это то тот момент когда система может упасть это большой риск все мы знаем такое понятие как кот fries & fitch af из когда менеджмент говорит что вот сегодня никаких изменений никаких релизов пожалуйста потому что у нас там не за маркетинговой кампании мы не хотим увеличивать риск проблем их можно понять также тут а так такая ремарка что вообще в целом это сложная тема менять схему онлайн без downtime а без проблем в реляционной субд и и это настолько сложная тема что даже иногда появляются продукты которые говорят давайте мы вообще не будем менять схему а будем все хранить джейсон и вообще цикл это плохо и вот он много деби привели появляется да то есть и тут сложная тема и она правда сложная и плоскость в подписи у нас реляционная традиционное управление схемой то есть вы можете открыть транзакцию поменять несколько вещей и закрытию вас будет атомарные изменения если у вас какая-то будет ошибка то у вас вся транзакция не будет применена это очень классно но тем ни менее огромное количество вещей в плоскости не готовы и вы должны откладываться разными алгоритмами чтобы так или иначе не подвергать систему downtime у и деградации ну то есть у нас риск возникает повышенный когда мы что-то меняем и это относится не только к идти систему это понятно давайте подумаем какие у нас бывают вообще в целом разные типы изменений разный тип ошибок когда мы делаем изменения в схеме 1 самое простое нём даже стыдно говорить но вы не представляете насколько он часто встречается это у нас на проводе другая схема не ту которую ждали да то есть у нас вот у нас допустим мы используем какую-то систему very санирования схемы и это нужно делать например там бликовый bass flywire sketch поднимите руку кому из слова известны видно вот сейчас меньше половины да это плохо то есть ok у вас может быть есть там в рельс рельс друга нравился у них свои миграция есть джанкой свои миграции но так или иначе вам нужно держать схему в гите ну или какую систему контроля версию еще в наше время можно использовать и все изменения трогать именно через гид да то есть это маст хэв наши дни и вот у нас там что-то лежит она пройдет немножко другое и это бывает такая ситуация кто-то руками построил яндекс или триггер навесил и у нас из-за этого наша миграция может просто упасть это очень частая проблема я просто ну как бы стыдно про это говорит вот оно есть и дальше у нас есть какое-то тяжелое изменение например какая какое-то изменение схемы подразумевает перезапись всей таблице знакомая ситуация же да и такая вещь она довольно сложная вещь то есть она там букет проблем дальше мы может быть допустим делаем релиз хотим что-то поменять но нам не дают это сделать потому что какая-то транзакция удерживает какой то какой то лог канту который конфликтует с нашим локоны вот мы заблокированы или же наоборот мы четвертый пункт блокер мы что-то делаем и мы заблокировали кого-то каких то пользователей а то и вообще всех там не знаю словно там можно все можно повесить лог на базу и заблокировать всех или 5 это мы все сделали хорошо все хорошо но со временем идёт деградация система потому что наши изменения допустим привело к увеличенному блату либо же мы убили какой-то индекс который нужен раз в месяц и вот первого числа он стал понадобился то есть у нас какие-то последствия уже после релиза вот в целом пять типов ошибок которые бывают если вы знаете 6 скажите потому что я долго довольно думал я не мог ни одну из известных мне проблем а я довольно много их видел сделать придумать еще что было не попала в эти 5 то есть вот эти пять это похоже что все теперь давайте чтобы их почувствовать эти проблемы сделаем вот четыре оси это 4 осени 2 то есть мы такую еще звездочки будем рисовать 4 конечно и вот эти четыре характеристики проблемы да то есть вниз нас по оси y и ось y смотрящий вниз это у нас слишком много работы которые нужно делать прям щас например мы должны обновить там гигабайт данных миллиард строчек в таком духе да а верх это много работы которые предстоит полюсу этом суде ваши сделать потом потому что мы там что-то сделали заложили какую-то бомбу замедленного действия то есть вниз много работал сейчас вверх много работы потом ясно что они не взаимоисключающие еще раз это две разные оси и посей по осям x влево asics это значит что мы заблокирована либо вообще упали при изменении ось x право это значит что через блоки на doors это значит что мы кого-то заблокировали идеально изменение выглядит вот так очевидно да то есть мы делаем изменения и их из этих четырех характеристик мы не встречаем изменение которое связано с разъяснением схемы выглядят вот так мы просто не можем сделать релиз потому что мы добавляем колонку она там уже есть либо мы дробим индекс а его там уже нет например то есть мы разъехалась схема до харе кришна выглядит вот так то есть мы не только делаем работы много сейчас но мы ещё и сами можем быть заблокированы когда мы обновляем много строчек например мы можем мы не можем получить эти локи например или же мы блокируем другие другие изменения в базе потому что здесь на изменение конфликтуют если мы в одном запросе будем миллиард строчек обновлять мы захватим лог на все эти миллиард строчек и 100 пользователи это точно заметит если мы допустим не можем получить лог то вот это выглядит вот так но еще и тут цвет видите другое вправо да еще мы можем может быть мы не можем получить лук но еще и других начинаем блокировать я вам это покажу и в конце концов вот если мы просто кого-то блокируем она выглядит очевидно вот так а пост изменение выглядит проблема вот так то есть вот такие характеристики и что как как эти характеристики выглядят с точки зрения бизнеса да то есть вниз ну мы можем мы делаем много работы скорее всего мы загрузим ресурсы и может быть какая-то деградация но я она будет сразу это хорошо я сделал более красным вверх потому что отложенная деградация это менее приятная вещь потому что вы не видите сразу вы не понимаете в чем причина дольше диагностировать и исправлять когда у нас случился по случилась проблема но это все самое хорошее если она если у нас если мы соломку постелили видит всяких таймаутов и мы покупали но тема релиз отменили это очень неприятно бывает но зато пользователь ничего не заметили поэтому это наименее красное влево до ну и самое плохое когда мы начинаем блокировать и мы вас получается либо частично либо полный downtime частичные у нас какие-то функции отвалились на нашем сервисе полный вообще все легло и там весь сервис слег или все сервисы я не знаю если у вас там монолит начнем с очень простого примера там пример вот красным схема mismatch да если мы создаем таблицу и пытаемся ее выполнить на про диана уже есть вы увидите вот такую ошибку всем известную да то есть пользуясь лишь напал риддик xii ст все хорошо и дальше начинаются разные вариации решение этой проблемы который я наблюдал жизни одна из команд посмотрев на это решило окей у нас флавий довольно старая версия нас нет нет онду никаких шагов fly вы описывают только все время движения вперед и у нас возникла на каком ты сын вариантов такая проблема давайте просто что сделаем добавим if not exist да вот кто-то начинает смеяться и правильно делает но не смешно на самом деле потому что вот мне так и не удалось этой команде выкорчевать этот но он он так распространился и стал об общей практикой что в общем довольно сложно от этого избавиться это некоторые уже такая травма на всю жизнь короче то есть люди начинают писать это везде if not exist ifixit и все время предполагать что возможно это наше изменение уже было сделано чем это плохо это плохо тем так чем это плохо мы обсудим попозже давайте посмотрим на характеристику но она очевидно да то есть вот схема mismatch вот я буду показывать вот такие вот глобусы и мы видим что у нас только по одной из этих четырех одном из четырёх измерений у нас как раз вылезло вот я рассказал только что история там файлы был может быть еще ничего не было такое тоже бывает и люди такие у нас нет времени внедрять систему управление змеями схемы поэтому мы пока там скриптами своими мы написали хорошие скрипты они сами все владеют мы в гите все мы все держим в общем все это какой-то момент разъезжается и по хорошему как должно быть вот у нас есть система управления которой версии вот одна из этих да это мне просто описывается движение вперед а как я уже сказал движение назад если мы движение вперед и назад можем описать это классно потому что ну по многим причинам я кстати вот тоже в википедии это повторяет мысли которые очевидно если вы вас есть эдуарду вы можете в не production in вариантах откатывать изменение назад да то есть вы можете накатил откатил вы можете еще раз повторить его то есть тестеры становится немножко легче хотя есть более хорошие способы тестировать о них попозже скажу таким образом в идеале вы должны поместить в сиай тестирование ваших дуан ду шагов она совсем в идеале и как я всем рекомендую и некоторые уже сделали это надо дуан да еще раздул почему потому что повторные ду тестируют этот онду если вы неправильно написали онду например вообще его не написали то у вас 2 ду упадет понятно же мысль да то есть вы создали таблицу у вас пустой онду вот задача еще раз он у вас падает только если не у нас чертов if not if not exist существует он как раз у нас такая заплатка такой костыль который делает возможен игнорировать он душах вот именно поэтому его не надо использовать это плохая практика то есть это реальный антипа то изменение схемы он приводит к запрятала нею потенциальных проблем которые потом могут дойти до продам вот соответственно рекомендация не используете их но таксисты таксист направо и налево используются только с умом иногда он все-таки нужен нужно понимать когда он нужен и старайтесь описывать еду и онду и положите их всей и тестируете вот в такую цепочку дуан дуду соответственно также что люди делают например вруби о нравился нас есть там возможность переключиться на строка char . и сквер и после каждого измене только дельта вот эту и alter клеит недель не только дилер описаны держать в ките но и всю схему мы damping там рельсы сами это делают на можно повторить для всего чего угодно и в гите всегда есть представление о том какая должна быть вся схема база это легкая операция с добиться тему и так но таким образом нам позволяет контролировать и сверяться с продам да то есть мы можем на прозе тоже дам 5 схему тоже легкой операция и дальше смотреть даже может просто div файла вас уже может вам может показать расхождение там конечно будет версия передам положено но это можно сделать игнорировать это можно игнорировать вот и не игнорируйте ошибки не надо заплатки делать надо их просто решать как выглядит вот раз можешь про тестирование поговорили то есть мы про seo и поговорили как общей ландшафт тестирование связанные с разработкой вреда то есть мы забываем про всякие инфраструктурной сдача пробег об этом аппликацию как ландшафта выглядит вот мы можем тестировать и схему и данные данные тоже можно тестировать мы можем делать статический анализ можем тестировать схему например там мы не хотим чтобы им поле в котором есть название mf было типа данных текст и у него не было индекса по lower потому что мы хотим игнорировать кейс давайте мы их будем использовать и текст либо обязательно будет индекс функциональный индекс на lower от e-mail такое тесто можно писать их тоже держать держать sketch позволяет описывать тесты у него есть дуа нду диплом revert еще есть very fine dry файл можете на языке sql или пережить записывать тесты и каждый раз их вся и гонять по можете тестировать данные например вы решили что ради признательности вы выключили внешние ключи так иногда бывает не всегда конечно это хорошо что не всегда у вас нет внешних ключей вы можете данные всякими select a mi протестировать и убедиться что нет строчек которые ссылаются на данных ну да мне на что ссылаться да то есть внешний ключ нельзя было бы и навесить можно динамически тестировать вот как раз та тема сегодняшней мы можем изменения в самом деле тестировать либо dml тестировать и как раз чтобы это делать мой подход который я кросс всем предлагаю это делать это на пол размерных базах и расскажу сейчас как то есть мы делаем это не только на пустышки или на какой-то маленькой тестовые базе но мы это делаем прямо на копии продакшна который развернули быстро за счет тонкого клонирования ну и также можно тестировать разные запросы и там бенчмарки делать уже другая тема и если мы говорим конкретно про тестирование именно изменений вот и как как делать их надёжно вот есть такая все знают пирамиду маслоу да вот эта пирамида маслоу для change management of в реляционной базе то есть на самом нижнем уровне вот эта система контроля версий который вас обязательно должна быть это ли кай бай sketch fly ваэль васу встроено в ваш прям work следующий уровень то есть вы как бы все все трека эти через гид следующий уровень у вас есть тестирование duende желательно дуан дуду всей третий уровень у вас есть процесса review если у вас нет процессора view это очень плохо то есть не это еще хуже чем в коде не не иметь процесса review потому что вот вы сейчас изменение это то что приводит к проблемам она повышает риск проблем соответственно если нет процесса review нет вторых глаз которые посмотрели на это изменение то у вас проблема еще больше риск возникает то есть это вы помочь им нужно внедрить в путь найти вторую пару глаз чтобы человек посмотрел но опыт показывает что если процесс review ручной то дальше все зависит от культуры опыта и усталости человека который делает review иногда конечно мы все этим грешим но очень бегло посмотрели и нажали а пруф хотя на самом деле вроде нормально все было а потом downtime потому что мы там что-то просмотрели чтобы не было вот этого на зеленом уровне на оранжевом уровне у нас тот уровень на котором мы краж с работаем чтобы он был нам нужно каждое изменение прогнать сначала до деплоя на полноразмерной базе то есть вы прогнали автоматически потому что если вручную тут скипать вот если она автоматически прогоняется всей это наша гарантия что изменения мы прогнали на копии prada собрали диагностику как она себя вела где-то там сохранили и после этого мы можем уже говорить что да это изменение можно править то есть оранжевый уровень это самая классный уровень но очень мало компании до него дошли например некоторые наши клиенты такие как git лап они дошли до этого то есть у них есть если создается маршей квесты в нем есть миграция дтп с до того есть мы грешим то в этом случае автоматически все происходит проверка на тонком клоне всех изменений есть еще вишенка на торте это на самом деле оранжевый уровень не видно что он тоже не полностью защищает это очень хороший уровень и мало кто до него дошел до него дойти нужно всем я считаю поэтому наш продукт топом source database ли он open source но есть еще конечно же что-то дальше это что-то это например вы делаете изменения и тут неожиданно пришел of the vacuum и он не уступает вам дорогу как известно of the vacuum он он блокирует нас то есть если мы хотим alter сделать of the vacuum нас блокирует но обычный of the vacuum он нам вступал уступает дорогу автоматически потому что он видит там через секунду что он кого-то блокирует ионов то убивается сам но убывая такой of the vacuum который в режиме forst transaction ai de ropa раунд привинчен да то есть он прилла почивают freeze дело это он про почивает таблицу из того что у нас 4 байт на идиш ники он фризит тупые кортежи соответственно он нам дорогу не уступит в этом режиме и к сожалению иногда бывает такая ситуация что была изменения очень хорошо протестирована миллион раз но вот именно напротив в три часа ночи мы сталкиваемся с тем что of the vacuum не не уступает дорогу и вот такие проблемы они требуют небольшого опыта и уже дополнительных соло маг например вы делая большие изменения заранее делаете фриз сами контролируйте когда of the vacuum будет таком в таком режиме запускаться именно конкретным таблицам и так далее это только одна из возможных проблем да вот эта вишенка этот эти a noun announce да и оранжевый уровень он позволяет приблизиться ко мне уменьшить эту вишенку что сейчас вот без оранжевый уровня у вас огромная вишенка и вы просто не знаете что там происходит вот пример да то здесь я не рассказывал not do the best lap эта штука которая позволяет делать тонкие клоны для любых бас не важно где они под газ аббас конечно только пост без пока что они могут быть под вашим управлением они могут в облаке по сути вы разворачиваете специализированную реплику для вашей базы и на одной машинки вы можете держать сразу там 20 клонов 30 клонов и каждый клон он полноразмерной и независимой то есть можно гонять все альтеры все там клеит индексы в своей базе и это может делать разработчик тестировщик можно развернуть такой клон чисто для тестирования полноразмерной то есть вас появляются полноразмерные среды разворачиваем и за 10 секунд то есть у вас 10 работ база аккаунт прозрач его это за 10 секунд эта тема отдельного выступления и они были вот и на холоде и тоже зайдите на плоскость . и я и посмотрите как это работает может быть попробуйте себе поставить уже многие то ставят но в целом здесь мы говорим про изменения поэтому я вот демонстрирую изменение с помощью бота который поверх этих тонких клонов работает и я просто ну мне так удобнее он дал дополнительные штуки привозят здесь я вот просто создают таблицу не знаю видно не видно вообще да видно ok вот сверху видно что создается таблица 10 миллионов строчек от строчки от одного до десяти миллионов in and 4 до 4 байт на инт плюс какой-то рандомный текст неважно какой и потом внешний ключ на идиш ник повесили вот джоном рассказывает о том но там делать некоторую диагностику о том как вообще изменения происходило то есть что чем мы там занимались видим что огонь и которые были нос вот 14 секунд выполнялось это изменение отлично 14 секунд мы создали таблицу дальше мы допустим хотим обновить что-то и мы говорим мы хотим заменить там 0 1 5 9 на большой с аджита просто просто для прикола неважно мы хотим такое изменение сделать если мы делаем вот такое изменение вот если просто его так апдейт с это вот так вот написать то случится следующее в подписи будут все 10 миллионов строчек обновляться то есть даже если реплеев не случится если она обновит а когда в нас обладает плоскости происходит как вы если вы еще не знаете вдруг то старый типа венчается astral строчка физически помечается мертвой создается новая строчка и грубо говоря у вас таблицы увеличится физически в два раза вот хотя может быть этот реплей сообщение кусочку не задействовал это очень неприятная проблема и конечно же такое изменение вот оно здесь я специально поставил начали с statement поймал 15 секунд чтобы показать вот так мы можем упасть это тайм-аут нам нужен он должен быть на продакшен да то есть у нас защищает от того чтобы мы не делали когда тяжелых действий но у нас случилась проблема как раз мы не смогли за релизиться делаем такое изменение она не выкладывается и как раз вот эта демонстрация то есть если мы тестируем на полноразмерной базе мы как раз увидим что проблема то что на маленькой базе у нас может быть там за полсекунды все выбрал там за 100 миллисекунд все выполнялось и мы думаю хорошо все хорошо но нет на большой базе мы как раз увидим на большой базе мы увидим что именно проблема именно в этом и здесь это очень неприятно и вот это изменение потому что она всю таблицу обновляет это тяжелая операция прямо сейчас мы можем упасть из-за стоит мы тайм-аута если у нас есть либо мы можем быть заблокированы и потому что кто-то может что-то с этой таблице делает какие-то строчки сейчас обновляют не отпускает мы будем ждать это это этот лог а еще мы блокируем другие изменения с этой базы то есть это точно заметят пользователю вот так делать нельзя если же мы тайм-аут уберем да мы выполним это изменение но вот он здесь вот она видно что она была 44 секунды и вот эти 44 секунды мы будем блокировать записи в этой таблице на изменения такой пользователь точно могут заметить и общему тону сместился акцент здесь нарисовал череп потому что это реально очень плохой из плохая ситуация мы блокируем всех плюс плюс еще смотрите вверх по оси которая y вверх а мы у нас появилась проблема почему потому что если мы меняем всю таблицу апдейтом мы создаем вот 10 миллионов мертвых кортежей даже если придет of the vacuum их их всех памяти у нас будут свободное пространство физическом loyalty это так называемый blot вот именно так он объем он появляется массивной операция приводит к болоту да то есть таблицы раздулась и нам потом нужно там репак запускать и так далее вот именно так сделать нельзя и поэтому у нас по y вверх появилась измерение потому что мы приводит к тому что больше тяжелой работы в будущем какие будь сканы замедлится то есть мы ухудшили работу на будущее мы это можем не сразу заметить там через неделю чё ты как ты там деградация пошла ну конечно делегациям и блок сами себе на ровном месте устроили если посмотреть под микроскопом вот как раз этот бот он привозит этот план точно так же да и транслирует его здесь я не показал но он транслирует его в мы поняли что обязательно добавь epc включать когда вы explain анала и сгоняете чтобы видеть сколько данных не только в логическом уровне rose а еще сколько именно физически данных мы потрогали там хитрит этом за записью dirty to ride in da чтобы мы видели эти числа и чувствовали как операция работает на физическом уровне и мы так же заметили что хорошо бы это еще в байты переводить то есть обычная страница по умолчанию в возрасте 8 кибибайт то есть мы умножаем просто эти числа на 8 кибибайт и переводим вот гигабайта мегабайта мебибайт один гигабайт соответственно так мы видим что этот апдейт у нас было 459 гигабайт хитов конечно там многие страницы были фитиль из много раз это понятно но мы почти гигабайт там 700 мегабайт мебибайт мы читали с диска там скорее всего с диска тут или тут на этом уровне не видно потому что это возможность краска shape рациона system now видно что это очень тяжелая операция и это не то что вы хотите получить в релизе вот как раз здесь я демонстрирую о том что если мы возьмем строчку у нее физический адрес под-сети одета скрытая колонка вы всегда можете ее за select этих любой таблички для любой строчки вот начале у нас тю полна что есть кортеж лежал по адресу 01 да тут у меня есть миром а вот он лежал по 0 0 1 то есть он на 1 на 0 странице 1 тепло а когда мы сделали апдейта причем мы ничего логически не поменяли видите сет вообще ничего не изменилось но мы видим что адрес изменился потому что цвет на тот тип он был помечен мертвым у нас новый живой тепла родился вот именно вот так у нас проблемы возникают даже если мы ничего не меняем вот это был со очень тривиальный example давайте подумаем что здесь можно делать конечно же прежде всего надо сократить количество работы в в одном шаге да то есть нужно разбить на бача такую такую ситуацию на кусочки и возможно вам потребуется или временно индекс для того чтобы по этим патчем быстро находить следующий патч до то есть чтобы вот пойди вы должны идти еще как-то у нас возможно если индекса еще нет мы должны его сделать и конечно очевидной оптимизация если у нас там вот возвращаясь к риплейс у мы можем если у нас этих символов нет значения но не нужно эту точку вообще трогать и потому что бы это приведет к новому мертвую кортежу зачем он такое вот а дальше интересный момент вот мы разбиваем на даче и там какой-то скоростью движемся во-первых моя рекомендация не думать про параллельную обработку вообще один поток хватит чтобы вы можете грубо вот на скидку миллиард строчек в день можно сделать обрабатывать если возможно я машина вы должны на марс точек день уметь обрабатывать на фоне да и не сильно мешать пользователям конечно зависит от конкретной ситуации нагрузки ресурсов и так далее это в довольно довольно много но если вы начинаете проанализировать вы себе как бы режется сук на котором сидите на самом деле то есть вы сами собой будете там конкурировать и убивать производительность лучше в один поток все делать но очень важный момент какую какой размер бочче подобрать вот очень простое если вас в цепи то есть этого свой мобильный сайт либо веб-сайт то простое простой как метрика это секунду и ту же медленно да то есть ваша будет замочат определенное количество строчек и пользователи могут это заметить если это будет длиться несколько секунд очень большая вероятность что они будут недовольны а пользователи обычно вот 100 миллисекунд это еще более менее быстро хотя уже заметно 1 секунду я тоже медленно а там 10 секунд недопустимо пользователь просто будет считать что все ничего не работает тормозит и так далее вот поэтому надо бате так подбирать чтобы быть меньше секунды слишком дробить тоже плохо потому что есть этот традиционный оверхед если вы раздробите там по одной точке будет обрабатывать все 10 миллионов и увидите как у вас общее время увеличивается есть транзакционные вверх это в целом это не хорошо то есть вы бы хотели побольше baci но то же время вот есть такая метрик вот одна секунда это золотое золотое число которое вот для для всяких обновлений как раз подходит вот ну и есть еще хорошая практика контролировать размер количество дать уполз ебло то с помощью дополнительного анализа и смотреть нам иногда немножко паузу сделать чтобы of the vacuum отработал либо даже вакуум самим прогнать вручную ну не вручную автоматизировано если у вас реально очень много стоящих обновляется вот ну третий пример вот мы хотим у допустим у нас есть айдишник я вот как раз табличку сделал 4 байт ней айдишник многие наверно с этой проблемы уже сталкивались вы хотите вставить 2 в степени 31 и видите вот такую ошибку хорошо если в эту ошибку увидите где-то в не production окружении потому что если вы увидели и production окружении это очень неприятная проблема не такая неприятная как транзак шнайдер up around конечно то есть касается только сегодня той таблице но если это таблица центральная вашей системе там в сервисе в этом это очень в общем очень у меня были ситуации когда это приводило к down down time этого сервиса до несколько часов слава богу это было громко 2008 был очень неприятно с этим дело иметь то есть вы хотите знаете об этой проблемы заранее хотите поменять на что на 8 байт най янг этот личный ключ как это можно сделать но вот так это можно сделать и вот для нашей 10 миллионной таблицы это заняло 4 спальни минуты это самый самый самый плохой пример да то есть видите что он по всем осям плохой то есть очень много работы сейчас мы раздули таблицу много работы на потом мы скорее всего будем долго пытаться получить лог мы будем блокировать всех-всех это это отвратительная вещь то есть вот так вы можете сделать только если вы разрешаете себе downtime maintain and swindle обновили дальше поехали вот но в целом это очень неприятно я сейчас у меня совершенно нет времени чтобы прямо окунаться нас а мне нужно час минимум чтобы в всякие детали различные решения этой проблемы я могу рассказать в кулуарах на самом деле я рассказывал на после вторники у нас есть в ютюбе у нас есть такие вот онлайн митап и rupes газ можете поискать учебе и там рассказывал об одном из путей решения этой проблемы под названием новая колонка да есть два пути новой колонкой новая таблица вот есть такие еще пути там есть можно перестать туда писать конечно да и или же многие вот такие а мы же можем негативное значение тоже использовать потому что ведь у нас почему там 231 они они 32 потому что этот это sunt in то есть у него есть негативное значение но там не всегда это возможно то есть либо у вас в коде что-то не так выйдет ли был там в общем это не очень такая идея хотя принципе она имеет право на жизнь но это все уход от проблемы да нормально решение проблемы это либо новая колонка либо новая таблица но очень коротко новая колонка там вы создаете но эту колонку делаете триггер чтобы трека все новые строчки вы подражаете старые данные и делаете это так что то есть указатель на но старые данные по сути увы синхронизировали да уже новый конкурс со старой и дальше возникает проблема которая очень интересно что до 11 по фгос а она нормально не решается то есть вам а ну то есть две вещи да вам нужно во-первых что первичный ключ на новой колонки объявить вам нужно уникальный индекс создать то есть если вы просто дропните привычно ключи создадите при вишни клеющего опять же получите блокировку пуском полной таблицы опять тоже самое все почти тоже самое но неприятно поэтому вы должны заранее создать уникальный индекс на основе которую при вишняков будет работать но это еще не все вам нужно но знал потому что просто уникальный микс он разрешает налы а первичный ключ ему нужно чтобы над на лбу и вот-вот нал самое интересное да нам нужно еще забудется внешних ключах но уже не будем этих мелочей касаться хотя они тоже могут есть кучу времени значит индекс вы конечно же будете со словом конкорд le concorde лет очень важно и вот как раз если вы допустим использовать все автоматизированным средством тестировать если вы забудете конкорд ли это будет отловлено и на продакшен точно не пойдет потому что без него мы блокируем ся вот я тут уже пропущу немножко давайте потому что времени не хватает значит до 11 под газ а у нас не было никаких возможностей сделать нот на без блеска на все таблицы соответственно alter the ballad altro can not now добавление она за она приводила к скан усе таблицы это была тяжелая операция и это про вообще никак не обходится к сожалению в одиннадцатом под гаси так как сделали не блокирующий дефолт то есть вы можете добавлять новую колонку и говорит что дефолтом что-нибудь это не приводило к перезаписи всей таблице то есть дефолт он такой виртуальный все старые строчки получают этот default виртуально мы можем вот какой-то момент меня осенило мы же можем при этом еще и нотном сказать и старый с точки а ниже уже заполнены и мы им им и они как бы они не заполнены они виртуально заполнены этим -1 дефолтом и поэтому нагнал он не будет приводить никакому скан он будет очень быстрый и таким образом мы можем сказать not наладив от минус 1 до новые колонки которые 8 байт на и это будет очень быстро то есть это было прямо открытие которое с 11 подвеса и позднее она доступна этим надо пользоваться потом мы водка заполняем все старые строчки -1 превращается уже в настоящее значение в старое значение которое все меньше чем 2 в степень 31 -1 и или равно этому значению и дальше мы уже убери можем дефолтом -1 свое дело отслужил можем его дропнуть у нас состоянии колонки готовы к тому что первичный ключ навешивать это вот как раз такой трюк который очень помогает вот таким сложным операциям вот newtype к сожалению такой вот реально минимум полчаса что просто выпускать алгоритм поймаете меня в кулуарах расскажу с удовольствием это очень интересно и там интересные разные проблемы возникают которые могут стрельнуть и я помню как раз как мы все для одной крупной компании американской мы прижали все эти проблемы и в три часа ночи окраса forces of the vacuum не позволил зарелизить хотя все проблемы были париж он повешены то есть это краса новым on on on on on приехал вот напоследок членов blockers от очень интересная вещь то есть если вы у вас есть вы хотите просто альперт apple id колумб просто добавить колонку and 8 любую вы знаете что это очень простая операция для подвеса но вот так получается что вы почему-то не можете добавить либо вы начинаете добавлять и видите что все ложится такие ситуации бывают почему если у вас открыто транзакция причем кстати на первом месте даже это вот старые слайды похоже не обновили я специально сделал первую сессию там был select то есть просто select из этой таблицы andro загса еще не завершилась как эта транзакция поработал с этой таблицей сделала select шерлок какую-то строчку мы делаем alter и мы не можем это сделать потому что мы ждем когда то транзакции закончится это ещё не самое плохое было балки если мы просто не могли получить лог то мы упали самая главная проблема что мы начинаем вообще запрещать все запросы к этой таблице пока мы ждем то есть возникает цепочка блокировок наш alter если есть долги транзакция к этой таблице незавершенные он по сути ждет когда когда будет окошко до чтобы влезть и если у вас есть долго транзакция вы можете реально положить таким вот не все до этого доходят то есть вам чтобы это почувствовать нужно чтобы проект вырос до но вот тут капри этот скрипт который позволяет увидеть дерево точнее лес деревьев блокировок потому что их может быть несколько деревьев вот это дерево там видно прям что вот у нас там этот запрос блокирует то есть у нас alter возникает все демки этой цепочке но в реальной жизни он там у него очень много детей которые которых он заблокировал да и это неприятно как это решить вот совсем там недавно там чуть больше года назад депеш поднимал эту тему в своем блоге всем кто в полку с теми знают депеша hubert hubert любашевский он пока он описывал что можно делать ретро и но он описывал это с помощью там баша либо питона в общем какого-то внешнего средства и это классно но на самом деле бывает сложные операции когда транзакция состоит из нескольких шагов и делать ретро и вам же нужно в стразах отменить эти шаги приходится повторять кто-то в комментах а конкретно михаил великих его не знаю но он молодец а то есть он очень классный предложил рецепт мы можем с помощью переписки ретро сделать такими локальными и не отменять все предыдущие шаги транзакции вот здесь маленький кусочек кода пусто там можно ссылку java на слайде дал так что вы можете пройти по ссылке есть открываете эту ссылку до битвы хайло 2021 соответственно вот этот это то что должно быть у всех у всех altar of это должно быть у вас поставляется лог тайм-аут например там 50 30 миллисекунд 50 миллисекунд нормально и после этого мы мы делаем допустим там 100 попыток получить сделать alter каждый попытка будет длиться всего 50 миллисекунд и мы будем так вот че хоть чуть-чуть да то есть мы на 50 секунд если у вас не получается лог мы блокируем всего лишь написать милисекунд милисекунд все от 50 миллисекунд мы заблокировали дальше следующей попыткой мы не выходим из на заказ и мы внутренние вот бегин exception м тут этот балкон позволяет это делать и если там нам не хватит там тысячи попыток ну извините нас упадёт миграция пользователя вообще ничего не почувствуют это очень классный рецепт вот вот он вот так выглядит по нашей классификации видите оранжевый . в середине больше у него нет никаких негативных эффектов именно вот так и нужно делать все альтеры вот я буду заканчивать потому что у нас уже совсем нехорошо со временем да очень простые слова которые как раз я хотел бы донести моя философия в деби и области это тестировать все то есть даже самому себе иногда не верить идти попробовать если в чем-то сомневаешься возьми и попробуй я вижу что иногда люди там сомневаются идут какие-то там в чат задавать вопросы попробуйте сначала сами и чтобы пробовать реалистично и что было пробовать удобно подумайте в сторону тонких клонов посмотреть этот чем мы занимаемся после сияй наград делаем туда тестирование удобно то есть вы можете там терабайт в 10 утра байт ную базу от клонировать за 10 секунд попробовать выбросить ее именно вот этот подход к росту тестируете и сделаете среду тестирование удобные для себя вот ну да то есть тут вот я немножко еще про дтп слеп то есть мы без этого то есть мы сейчас в этом году к 1 плотно занимаемся темой чтобы эти тонкие клоны тестирования на них именно миграции было всей автоматическая как я уже сказала если нет автоматического значит кто-то когда-нибудь начнут забывать и либо нет времени и пропускать этот шаг все это обязательно будет сделано вот без тестирования всегда вот эти вот эта вишенка огромные этот прогноз если взять это был слеп у нас прямо вся и появляется клон тонкий на нем мы тестируем там есть интересные вопросы безопасности и как это делать так чтобы там персональные данные не язык использует чтобы никто их не видел мы все это решили то есть это за рамками доклада но это все решаемо но я уверен что в этом будущее тестирование миграции то есть именно на полноразмерных базах нужно их прогонять всегда вот ну это куда можно пойти чтобы этой темой поинтересоваться у нас есть slug telegram нраве на русском под предстоятель к нашему телеграмму и если вам тема интересна то посмотрите еще вот на эту страничку у нас есть кастом едва или групп который мы набираем сейчас чтобы именно по теме тестирования миграцией на тонких клонах если у вас есть позвольте вам проблемы это близко по присоединяйтесь заполните формочку мы с вами свяжемся и обсудим именно вашу ситуацию вот минутка рекламы вот все то есть мы можем общаться в кулуарах я могу на самом деле продолжать но у нас помогут склоняться временем да то есть как со временем то смотри либо еще две минуты ты выступаешь ли вы берем да давайте лучше вопросы наверно давайте два вопроса друзья руки в небо смотри вот раз два остальные тогда в зоне цифровых кулуаров можно будет продолжить разговор здравствуйте пасибо большое действительно очень жизненный доклад скажем так и вопрос про дуан ду и вот их not exist вот вы говорите что это прям какое-то такое очевидное зло но вот к примеру есть большая табличка нужно сделать alter вот как пока был пример alter и нужно сделать это не блокирующим способом например способом новая табличка до каким-то фановым и вот как то есть этот процесс может в любой момент упасть например чисто теоретический вход мент когда будет перри накат он пойдет заново все это делать так вот как в этом случае убедиться что мы не будем заново всю эту новую табличку переливать пересоздавать и он просто проверить что же все накачены и выполнится давайте разделим у нас есть схема есть данные что вам мешает разделить это изменение на несколько шагов первые изменения будет только про схему оно должно быть быстро вы оборачиваете вот эти ретро и логика вы получаете это то есть я не понимаю зачем нам там иметь какой то эффект и внутрь здесь да то есть а дальше уже данные данные там больше а ты что там что-то пойдет не так упадет ну и там можно insert selecta мы либо там копи какой там откуда-то и это уже будет другой шаг до то есть у вас первый шаг завершился зафиксировали то казачек появились тогда как в игрушки да то есть а дальше уже второй шаг делаем правильно то есть да ну вот второй шаг он же допустим вот на втором шаге который переливает данные например он падает и вот да ну смотрите там вы скорее зависит конечно от данных но как правило мы там это одним шаг одним запросом делаем ensure select и все то есть он падает он как бы отменился нас традиционная и синди система и она просто все от меня то есть вам там никаких этих действий он не нужно будет если вы я видел ситуации когда люди пытались шаг разбить на кусочки чтобы не допускать долгих транзакций но и такие к чему хорошему не приводила бы то есть правда у нас не было долгих транзакция но разъезжались данные то есть это там не хорошо и второй вопрос вот по центру андрей ван young смотрите я может быть пропустил мы вас ничего не было сказано прадед локи у вас случаются такие в подгрести такие вещи когда вы накат и выйти на например лики бальзам апдейт транзакции падают в продакшене я из мира и mssql то есть я честно говоря не очень работая спускаться мы только планируем нашей компании вот и как бы с этим как как вы обходите подобные проблемы с дидлами у нас есть как раз крупный клиент по которой рассказывал там как раз тоже уехали с microsoft sql это нормально то что люди приходят в мир после существенно так и ну да блоки в любой cbd они есть лагает он их определения в плоскости есть настройка td 2 тайм аут после который случается проверка помолчать 1 секунда и если долг наступил происходит убивание одной из сторон да то есть с газ и и я понимаю но в этом случае понимаете давать это говорю . это говорить всегда когда наступает до двух еще простое правило независимо от свободы и свободы нормально реализована и полы sim 1 к 100 спейсеры в этом плане нормализована это ошибка клиента то есть он неправильно спроектировала допустил такую ситуацию нужно забираться в каждом случае бывает очень сложно бывает бывает даже на самом деле что мы допускаем что у нас там немножко дотла как бывает в день там сколько-то и так спроектируем приложение что это неизбежно если это касается именно миграция но нужно садиться разбираться конкретную ситуацию тут нет универсального рецепта а вы вы не пробовали понижать приоритет бедрока приобрети и пытаться со своей стороны увеличивается м этот лак тайм-аут ну вы мы с келли мы можем например поймать ретро edit log со стороны апдейта и попытаться обработать эту ситуацию на эти чем переписывать клайн тут очень сложно говорить какие-то общие рецепты ну во первых там можно до доктора молот увеличить может привести к нехорошим последствиям что дальше можно делать как правило локи которые мы транзакции достиг а правило это так и есть все логе которые мы захватили они будут освобожден только в самом конце когда случится commit и rollback поэтому мы стараемся тяжелые локи обычно вкусом и на самый конец приносить этот общее правило да то есть не торопиться но если мы хотим миграцию сделать возможно имеет смысл сделать локтя apple самом начале потому что то поделать и потом уже за к мите да если мы делаем локти бл был уже рабы уже одни из этой таблицы на один да мы можем локти был обернуть тоже в такую же вот конструкцию даже нужно это сделать street роями до чтобы если на слух не получается что мы других опять же не блокировать даже selecta блокируется при этом мы вот при троих лог получили и все до конца транзакции таблицы наша вот наверное вот такая такой подход в вашем случае может быть имеет смысл то есть луис пораньше"
}