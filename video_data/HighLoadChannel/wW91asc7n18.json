{
  "video_id": "wW91asc7n18",
  "channel": "HighLoadChannel",
  "title": "Мульти терабайтный Sphinx HA кластер / Вячеслав Крюков (Ivinco)",
  "views": 746,
  "duration": 1958,
  "published": "2017-04-22T14:46:44-07:00",
  "text": "приветствую слушателей highload 2013 вячеслав крюков я из компании венка который занимается высоконагруженных масштабируемых проектов на сфинксы других технологиях речь сегодня пойдет о сфинкс кластере который имеет чем речь пойдет сеня а пластыря который имеет следующие параметры по нагруженности и объему данных это от 100 запросов в секунду в пике и не менее пяти терабайт в индексах на данном слайде представлена упрощенная архитектура такого кластера sf это сфинкс форвардер и которые представляются более обычные функции которые не имеют локальных индексов имеет только дистрибутивные и транслирует запрос на конечные сервера и обратно дают резал цвет а также есть набор серверов на каждом из которых присутствует четыре ноты для данного кластера возможна ситуация когда он начинает работать медленно и ему становится плохо при разборе ситуации что происходит дается найти сервер на котором возникает проблема и вправила даже ниже но дано который возникает проблема примера почему такое может быть это установка в запросах высокого тайм-аута по максимальному времени выполнения запроса и если от одна из но там или целый сервер испытывают проблемы с ресурсами например нагружается чем-то еще индексация какие-то другими вещами то получается так что все for better и ждут пока выполнит это надо запрос и производительность кластер ограничивается таким образом применим тайм аут все но высокое то получается что кластер работает медленно можно конечно попытаться решить эту проблему а снизить поймал то есть сделать его маленьким и тогда мы будем иметь ситуацию потери данных в результатах потому что то что работает медленно она не будет возвращать результатов и какие то моды не будут давать результатов а может даже целые сервера вячеслав извините перебиваю я здесь могли бы вы держать микрофон чуть чуть повыше или говорить погромче чуть-чуть хорошо спасибо поэтому для такого кластер актуально стране этих архитектурах arrival ability и далее буду рассказывать об этом таким требованиям мы хотим такую систему с поставите нам нужно устойчивость ко всякого рода инцидентом если выражаться более кратко нам нужен определенный уровень доступности в цифрах это может выражаться имитированными как три девятки от девяток как правило переход это каждого такого уровня на более высокие это очень высокие затраты многократная избыточность и чем выше тем эти затраты становится все выше и могут там десятки раз превышает то что нужно было для более низкого уровня и так какие требования это адаптивный balancing означает то что мы не просто выключаем какие-то части системы но для сервера которые испытывают проблемы к примеру если таллина ну да или сервера могут все таки обрабатывать запросы мы даем им запросы на меньшем количестве следующее требование это эмаль на использование избыточности ресурсов которые необходимы для построения очень архитектуры и также важно иметь простой способ добавления новых ресурсов как построить такую архитектуру показано на этом слайде это достаточно просто между форвардер мы нижележащим серверами надо поставить боксирую щий сервер и настроить репликацию техническое решение может быть несколько можно использовать уже предположим очей прокси пытаться построить такую архитектуру но мы пошли другим путем мы заказали светским встроена фичу в сфинкс свечей она сейчас уже находится в стае был ветки и и можно пользоваться для нас это был коммерческий проект если переходить уже потому что получилось это будет такая архитектура получается что чей по сути встроим нас форвардер и и внутри фонда осуществляется basic и основная работа такая архитектура подразумевает под собой наличие нескольких зеркал здесь показана 2 то есть фактически мы имеем удвоение войну избыточность у нас есть по сути копия кластера такая архитектура имеет недостаток если у нас один из серверов выходит из строя то на другой ложится вся нагрузка которая на него на сердце нагрузка труба предназначена для них двоих и это может вызывать дополнительные проблемы поэтому актуально применение архитектуры использующие избыточность более эффективно здесь показана то что мы перемешиваем ноды на мастерах таким образом что если у нас один серверов выходит из строя то мы фактически перестреляем нагрузку на всех оставшихся каким образом это система более устойчиво стоять аппликация здесь будет более сложная должна знать взаимосвязи то есть есть свои плюсы и минусы теперь о собственно самым важным чей имеет так называемые стратегии балансировки и здесь присутствуют четыре стратегии две из них хорошо известны это случайный выбор то блинова зеркало и выбор на основе алгоритма round robin а вот два два других метода они как раз являются сутью этой разработки и заключается не в том что для белых пинга используется анализ по следующим параметрам это лет инси то есть насколько тот или иной сервер может быстро отвечать это набор параметров словно которые можно назвать ошибки вардинге и на основе этих параметров за определенный период времени который называется андреем в настройках печей период карла шляется расчет весов и после этого расчета существует вот по этим двум алгоритмом две возможности первый алгоритм но dc он менее чувствителен в целом к ошибкам более чувствителен к пенсии то есть он не будет сильно обращать внимание на ошибки нам больше будет стараться переставить нагрузку до где запрос обрабатывается более быстрым образом второй метод как раз ориентирована больше на то чтобы запрос отдавался туда где возвращается меньше ошибок при этом в этом си ми не приоритетна в документации есть подробное описание этих стратегий сходить и почитайте обязательно теперь о конфигурации как мы конфигурируем секс очень кластер это достаточно просто мы в настройку дистрибутивного индекса прописываем агенты с новым видом синтаксиса где через pipe указываем соответствующие зеркала ну и прописываем индексы между которыми шляется балансе там же мы прописываем стратегию то есть для разных дистрибутивов индексов может применяться различные стратегии а в секции sich die мы настраиваем период пинга и стресс на корму первый показатель это в миллисекундах 2 в секундах с тестом документации тоже есть описание этих настроек можно почитать с помощью специальной команды шоу и джин статус можно посмотреть текущее состояние и ч и увидеть все указанные параметры их их величину но здесь простой случай мы не видим ошибок ну мы видим соответственно сколько составляет время выполнения запроса вот несколько миллисекунд на запрос из-за одного количество успешно выполнявшихся естественно видим зеркала здесь показана два зеркала для примера а теперь посмотрим как во времени от шляется basic я специально подготовил кейс который был отработан на продакшен то есть это не тестовые данные прямо с продакшена здесь на этом графике показано время выполнения запроса для двух серверов которые являются зеркалами друг другу и вот эти всплески который синим цветом видны это в списке которые были вызваны вот выполнением такой штуки это утилита которая очень помогает админом понять насколько диски обладают хорошей пропускной способностью по чтению записи и видно что когда я запускал эту утилиту были всплески значительные как же вилок вел себя basic на этом графике показаны относительные величины количество запросов по зеркалам и видно что красный графе как раз в момент когда шлялся основной всплеску он пошел вверх даже он пошел вверх а когда был более маленький всплеск ранее что принципе подтверждает что это фича работает на этом графике уже показана данные в абсолютных величинах то есть количество запросов здесь видно что суммарное количество в момент всплесков было где то соответственно 100 запросов в секунду но этот график он приводится для одного из форме дрофа ford рф plaster несколько то есть реально общее количество запросов она еще выше и так что еще важно есть в кластере какие процессы важны для того чтобы собственно построить кластер это вот данных в постоянное место хранения вот это достаточно сложная сложная технология потому что здесь требуется водитель большое количество данных за за маленькое время то есть обеспечиваете быстро-быстро появлении новых данных также есть собственно процесс индексации которые нужно производить на всех серверах и обеспечивать проверку индексов обеспечивать их синхронизацию и последнее это собственно апдейт данных в индексах в случае с висячей архитектуры нам нужно будет ответить на два раза большем количестве серверов во всех местах теперь по связи с перформансом печей нам обеспечивает перформанс на более широкой полосе пропускания то есть мы фактически можем подавать больше количество запросов и речь не идет о том что мы перформанс улучшаем мы улучшаем имена устойчивой системы а сам перформанс нужно улучшать отдельными методами и высокая доступность мы должны соответственно обеспечивать также мониторингом в процессе разработки проекта безусловно возникает необходимость вводить новый проект проверки вот я здесь перечислил то что у нас была актуальна конечно это важно смотреть шоу джин статус потому что там появилось очень много важной информации и это можно использовать для мониторинга обязательно нужно смотреть и формы с конечных ну то есть там где крутятся локальные индексы и соответственно настраивать alert system monitor если что-то происходит не так мониторить диски мониторить использования циpкa также ошибки вардинге крыши как ни странно swings крошиться желательно чтобы он не крошился вообще но иногда бывает так же по индексам важно чтобы индексы были новыми то есть не было не было их устаревание то есть они вовремя индексировались ее видно что это не старый индекс их валидацию потому что при индексации может учиться так что индекс будет битый если его стратегий то может получиться крэш ну и синхронизация это для сфинксы ч я нужно обеспечивать синхронность данных иначе результаты данные будут результаты поиска будут различными если запрос идет на тот или иной кластер теперь поговорим о том на что еще можно улучшить и какие новые новые вещи можно в таком кластере предложить здесь отображается такая вещь которую называем distributed в яндексе это система которая в себе централизует все что касается управления процессами индексации раздачи индексов соответственно синхронизацией валидации на этом слайде показаны некоторые требования то прежде всего индексация в не собственно самих серверов где крутится инстанции sich die для того чтобы не грузить их и меньше влиять на работу соответственно при этом мы можем проверить индексацию чем успешнее это будет осуществляться тем соответственно меньше времени будет на то чтобы получить новые индусы их тратить как говорю важно расширять валидацию ну и доставка это собственно из этой системы является доставку на конечной сервера что важно система тоже может масштабироваться то есть если у нас них не будет хватать курсов то есть мы не будем успевать индексировать все необходимые индекс этом за определенное время мы можем эту систему масштабировать таким образом обеспечивать необходимую intense по значит процесс индексации также там обязательно есть файл over управление конфигами централизованная то есть а если раньше там это может быть это отдельные скрипты которые не совсем взаимосвязана с друг другом то сейчас это все едино ну и самое последнее это и balancing принципе хорошо если получается построить такую схему когда ребаланс не нужен то есть когда все равномерно но иногда такого не получается сделать тогда периодически возникает необходимость ребаланс инга и на такую систему тоже возлагается таких функций либо нзинга теперь важных темах которые определенным образом могут влиять на работу кластера в том числе и на его структуру а также на планирование его ресурсов важный момент иногда требуется иметь возможность посчитать сколько ресурсов потребляет тотальный запрос тот или иной клиент для того чтобы плане планировать ресурсы и если это потребление адекватно то соответственно мы оставляем это дело как кисти если она неадеквата то мы ограничиваем потребление этих ресурсов так вот есть некие проблемы в этом деле например по диску это достаточно просто то есть мы можем узнать количество операций и можем знать о собственно размеры этих операций посчитать и соотнести с пропускной способностью диск вы знаете сколько тотальный запрос tuttolina клиент отъедает у нас соусу по диску с процессором намного сложнее андрей не надо про предиктор макс time который позволяет ограничивать более стабильным образом выполнение запросов и там используются счетчики которые рассчитывают предиктор и вот на основе этих счетчиков можно также считать собственно потребление ресурсов здесь есть важный момент к сожалению эти счетчики не срабатывают случаев у сканов поэтому есть затруднения в том как использовать их с учетом того что нужно считать все все запросы пуск она тоже бывают не последнее мы использовали новые технологии для обработки текста так называемый розита лингвистика платформ целью использования это анализ азиатских текстов которые позволяют их цементировать более качественным образом вместо того чтобы получать набор просто аэрографов мы получаем некий комбинация то есть это уже более более соответствует правилам языка то если на поиск становится по этим языкам более качественным и что тут важно как это может повлиять собственно кластер качество стоит индексация растет но резко падает скорость индексации 4 там до пяти раз поэтому требуется изменение структуры индексов их дополнительно фрагментация чтобы параллельно можно было обработать можно больше индексов естественно за более быстрое время сшить индексацию принципе все подскажите пожалуйста репликация для репликации нодов plaster а вы используете какое-то кастомное решение или вы можете нужно посоветовать мы используем использовали р sing но он достаточно медленно работает вот попробовали натка эту намного быстрее работает вы упоминали некоторые усложнения логике репликации если ноты перемешивать тоже симптом это все реализуемо ну собственно взаимосвязи реализуются хранением некоторых схем там в базе данных и так далее сама передача она организуется тем же над эту вот связанные с этим вопрос здесь значит при этом каким образом вы обеспечиваете целостность индекса то есть как бы если вы используете арсен колин откат то же самое они копируются хитрым образом то есть сначала осуществляется копирование с не с заданным хитром суффиксом до копирование совершилось очистилась проверка то что скопировалась осуществляется переименование ротации а ясно значит ещё такой вопрос вы упомянули в восточные языки вот об этом может быть чуть чуть побольше вот мы имели опыт с японским для других задач там были там штуки связанные с деревьями решений когда и в целом не вполне просто с ними работать вот может быть скажите пару слов и с какими именно вы работали ну вот розита лингвистика платформа собственно на на коммерческий продукт то есть это набор библиотек который можно получить сфинксу то есть сфинкс уже настроил интерфейс подключени теперь для тех то чтобы их использовать вам придется покупать лицензию и и тогда вы сможете все это сделать но самое главное астрология слова уже умеет работать с этим то есть там что-то типа уфологии там какую-то там есть определенные овцы и настроить моста тесно так и на такой скажем так глобальный вопрос в целом у вас же то есть в общем то коммерческий продукт то есть по какой причине сфинкса нильсена color просто как бы там и конвенте побольше но решение есть уже как будут готовы то есть вот в чем в чем прикол сфинкс принципе этот хороший продукт ребята как будут сделали вот местные да то есть как бы здорово ну то есть для костюмеров наверное тут ну на разных этапах разные были причины в какое-то время он быстрее других работал в целом у нас устраивает если мы что-то хотим мы просто со свинским сотрудничаем и на коммерческое основании нам дорабатывает не едет мы вращаем то что нам надо вот вместо того чтобы этом как-то другие проекты пытаться наш проект адаптировать хорошо посему не только в утиль женщины сидят на мальту dolls in real-time а я фунгицидов will not like a pally да да ставьте лайки об этом месяце он и ягод и use nagios жизнь zabbix на getz стоматит и сам alerts весов чеки дня волоча наборов параметров повысит сомов патенту топовыми to do the novel стендовых ставь лайк да тараканов slow and you get you think this would get instant flash нас оба способа полностью you might get any около 100 ден ден сам а-а-ай торт свою о финансовой нарушенный feel like a skin is a сосульки в кино mxm диска tion of the man who comes into the singing the index is a young and нитки от дессау сока на слово you might be канцлер не kings сам thing like облака новый пакет shooting guide for profit сам кинг like the one piece of applications to get instant ипотечного indexes краски are not very quickly но баба мы by мы кендис coast of the makers еще если у меня есть время чем есть опыт использования это индексов был давно не очень удачный поподробнее можно какие проблемы ну собственно ярд индекс эта реализация обычных индексов специальные обертки скилл местами и на том этапе когда мы пытались там были проблемы научишься том что требуется очень много память и достаточную крыши бы честно говоря мы периодически думаем о том что у вернулся к этой теме но вот на тот период был ник негативный опыт возможно мои вернуть топот был приобретен и велось или какая-то работа по улучшению оптимизации что мы провели какое-то количество тестов пытались построить некий функционал даже что-то на продаж на пыталась там быть выложена ну в общем не пошло вот собственно были некие методики по улучшению ситуации даже на блоге на сайте a wing ew.com потому что то есть на эту тему может она уже устарела потому что принципе работали с 2009 года по этой теме и много воды утекло как репликацию пытались вот настраивать в индексах ну у нас не было и чем тогда репликация не нужно бы а вы имеете ввиду что заливка да да сам мартин бек со или что мир аппликации левка и синхронизация с репликами ну принципе заливается через swiss qu'elle формат луны была песен возникает задержка просто даже синхронизацию она в любом случае возникает главное минимизировать ну насколько я понял его час у вас схема с хитрым переименования он там нет такой проблемы ну да в этом случае здесь не переменную просто здесь нужно сильно две копии джексона на медь вячеслав спасибо спасибо"
}