{
  "video_id": "bcRo--JlR14",
  "channel": "HighLoadChannel",
  "title": "Зачем нужен мультимастер? / Илья Космодемьянский (PostgreSQL-Consulting LLC)",
  "views": 7146,
  "duration": 3234,
  "published": "2017-04-22T14:48:16-07:00",
  "text": "продолжаем у нас на сцене так сказать нашего театра Илья космодемьянский человек которого с каждым годом представляет наверно снами человек которого нужно представлять ВС меньше и меньше руководитель из крупнейших консалтинговую пригодных для жизни поре условиях И вот сегодня как раз Илья будет рассказывать такой вот частичку свое опыта делиться это Как люди используют мультимастер Нужно ли его вообще использовать когда использовать как использовать работает ли он вообще или нам на самом деле наврали что он может жить Ну давайте коллеги поприветствуем Илью Да СБО собственно говоря оче было зание основано на основании массового опыта потому что мультимастер - это такая штука которая почему-то очень любима всеми Ну вот Обратите внимание на самом деле очень простая вещь доклад называется Зачем нужен мультимастер У кого возникают вопросы Что такое мультимастер есть кто-нибудь у кого такое 1Д 3 4 5 но постепенно вопрос начинают возникать Обычно когда в эту тему погружаться но в принципе на слуху все как бы о ней говорят но как бы людей которые признаются что её используют довольно Немного это намекает конечно на некоторые мысли но тем не менее ну Давайте попробуем разобраться что это такое Тем более что последнее время об этом разговор идёт всё чаще и чаще есть много самых различных решений Вот примерно о чём мы сегодня будем говорить порядок не случайно ровно такой когда делают какую-нибудь систему которая под собой имеет какое-то серьёзное хранилище задаются вопросом Ой мы хотим мультимастер и вопрос Что такое мультимастер обычно возникает несколько позже но мы попробуем разобраться и с вот этим и с тем собственно говоря А что такое мультимастер с чем его едят и так далее а дальше посмотрим как на практике можно какое решение имеющее некоторое касательных целей его можно использовать для те или иных ле его можно не использовать Это должен быть достаточно такой интересный момент я надеюсь По крайней мере вот ну собственно говоря мультимастер называют по-разному идея проста и банально Когда обычно архитекторам или администраторам или разработчикам приходит в голову идея что мы хотим мультимастер они исходят из простого тези - это такая штука можно на ноды мы пишем только на одну и этим лимитированные если у нас репликация мультимастер это значит мы можем писать на любую ноду Да постановка задачи ровно такая что писать мы можем на любую из этих НОД то есть они желательно равнозначны или по крайней мере есть несколько равнозначных нот Как правило больше чем одна желательно Но на самом деле как бы интересные задачки с мультимастер а там как-то ещё туда туда-сюда а вот когда их начинается три и больше вот там уже уже начинается Интересно как все любят и в принципе идеи основных две во-первых это повышение надёжности потому что ну как бы мы же Привыкли что у нас всё должно быть зарезервировано там на атомном ль доколе Ленин было два реактора чтобы не дай Бог с таким названием во льдах не заглохнуть Ну в общем в принципе хороший принцип помогает не всегда спасает от этой проблематики но бы помогает вот поэтому идея такая что у нас нету точки отка отказа единой на запись И для этого мы используем мультимастер Это хорошо а опять же в идеальном мире но это уже такие мелочи а вторая идея которая например очень типична для администраторов Oracle состоит в том что у нас резко повышается возможность быстро свериться То есть у нас произошла проблема и поскольку у нас AC Active нам не нужно тратить время на промо стендбай А нам не нужно тратить там время ни на какое переключение не надо организовывать какую-то экстренную службу так ли это Это вопрос тоже сложно это зависит от многих организаций Но идея такая что вот если у нас есть а актив актив решение то значит будет всё хорошо а при этом как бы если у нас а Active H standby или там dat Guard или что угодно то мы потратим какое-то время при том неизвестно Какое потому что афа вещь такая со своими приколами а соответственно тся руками Ну мало ли там все администраторы Пьяные там и в общем никто ничего не может это самое это не шутки это как бы вот это реальное обращение клиентов Да звонит Клиент говорит у меня все администраторы пьяные 23 февраля Что делать то есть Бывает такое второй момент состоит в сокращении времени отклика и эта задача на самом деле гораздо более жизнен потому что ще возникает допустим ставте магазино которая разнес географически по каким-то не очень приятным В смысле доступа по сети регионам да или там ну вот типичный случай когда у нас есть там что-то что должно работать по одну сторону Атлантического океана а что-то по другую там хоп никогда не бывает быстрым Да не дай Бог это ещё в Австралии это будет как бы всегда очень медленно и печально вот там эта задача она как бы приобретает такое важное значение Потому что если мы применяем там топологию то у нас начинаются проблемы потому что для каких-то запросов Мы ещё как-то ближе к клиенту становимся а для каких-то нам нужно ходить через океан и это никогда не бывает быстро это всегда добавляет каких-то достаточно серьёзных издержек Ну это всё ожидание Архитекторов То есть это то из чего люди как бы исходят а есть на самом деле ещё и реальные проблемы существующие в этом мире и с ними бывает не так как бы хорошо Ну вот Давайте пора что там могут быть за и почему с ними бывает нехорошо потому что Т совершенно непонятно если на самом деле всё так хорошо почему до сих пор используется мастер с репликация кто вот использует в постгрес Мастер С репликацию А кто не в постгрес А кто использует мультимастер в продакшене в продакшене кто использует рак роши проект Вот видите на самом деле тут немножко больше как бы жела ещё репликация май то есть Видимо что-то это вот как-то вот так вот что-то в этом есть Давайте разбираться что собственно говоря беда всегда одна во всём виноваты транзакции и с транзакциями всегда было очень непросто и на самом деле чтобы ну как бы есть такая идея что транзакции - это плохо они всё замедляют ког люди начинают писать свой новы с движок они обычно как бы считают что у нас транзакций не будет потому что так быстрее потом вместо транзакций берётся одна глобальная блокировка и становится всё медленно но а без блокировки как-то данные в тыкву превращаются это не очень приятно ну поэтому мы так сказать чтобы не заглублять максимум мы примем На Веру что транзакции нужны поверьте транзакции нужны Я думаю что большинство людей так считает и при этом скорее всего транзакций иначе с целостностью данных будут большие проблемы а это не аксиома это на самом деле теорема Но примерно вот кни книжка с этими теорема она такой толщины достаточно нудно читается но как бы один раз прочитать стоит искренне советую там будет объяснено почему это как бы нужно важно и полезно А и главная проблема транзакций Как таковых когда они живут ещё локально в одном сервере ещё не не дошли мы до этого самого мультимастер состоит в том что возникают конфликты сериализации то есть когда у нас много конкурентных запросов пишут что-то нам это нужно каким-то потоком направить там на диски в результате у нас возникает проблема что возникают там целые классы проблем там тонны диссертации на эту тему написаны какие именно проблемы как по виду расписание транзакций расписание стерилизации опознать что проблемы те или иные Ну вот как бы это сложно но можно для того чтобы эти проблемы боротьби транзакций наверное слышали слова двухфазное блокирование есть мультивена версия двухфазного блокирования детекция дедков вот это вот всё оно существует работает и работает хорошо В распределённой случае начинается некоторая проблема проблема заключается в том что добавляется целый новый класс конфликтов поэтому когда вот мы говорим поддержки транзакций в нераспределенной Master slave это на самом деле не распределённый случай мы берём транзакции обрабатываем их все на Мастере и уже готовым от сериализовать Да он не совсем готовый сериз ий могут возникнуть конфликты восстановления но это уже совершено другая история её гораздо проще решить Поэтому вот сейчас в постгрес H standby живёт и много лет работает в окле есть datag масле Вроде теперь тоже есть репликация Она тоже работает вот и как бы это хорошо и льно Но вот когда возникает распределенный случай начинается самое интересное из-за чего возникает куча проблем проблемы которые добавляются вот те самые конфликты носят общее название так называемые византийские конфликты Conflict задача о двух генералах или там задача что это такое Это такой род конфликтов которые возникают непредсказуемо изза каких-то действия между внутри Федерации серверов особенно если она гетерогенная но в гомогенной тоже проблемы возникают даже е сервера одинаковые особенно если этих серверов много В чём основная идея вот Представьте на этой на этом схематическом чертеже тигра в имени Конечно нету но тут нарисовано как бы вид сверху две горы которые заслоняет две армии стоящих рядом осаждающих крепость заснят их друг от друга При этом они не видят как саму крепость им нужно согласованно наступать на эту крепость чтобы её взять они не видят самой крепости и они не видят друг друга потому что это холмы между ними но при этом между холмами имеется Долина А в которой может находиться А может и не находиться враг и задача генералов командующих этими армиями договориться между собой когда они начнут атаку Ну у них Дарк фабера не было в те времена и прс тоже поэтому как бы им нужно было послать Гонца а то есть это уже так начинает быть похоже на tcpip немножко но проблема возникает следующая что гонец Может просто не доехать окажется что там в ваш бинке то враги притаились и Ну вот О'кей это проблема И мы туда соответственно как бы всё его потеряли Но это проблема решаемая потому что ну вряд ли как бы если этот если гонец не вернулся первый генерал вряд ли будет наступать он решит что как там что-то произошло не так а если соответственно ко второму гонец не приехал Ну у того и повода нет наступать да А задача именно такая что типа ну она же естественно математиками придумана а не византийцами Вот и Да проблема состоит в том что если они как бы пойдут в наступление то не синхронно они проиграют если синхронно выиграют А дальше возникает ещё более сложная задача допустим он доехал до второго Генерала и начал возвращаться и тут-то его и поймали в ложбинке то есть второй генерал имеет указание что нужно наступать Но не может это сделать вернее как бы может сделать может не сделать это вопрос такой но первый не получил подтверждение то есть вот вы уже видите что здесь возникает огромный список проблем которые потенциально могут возникнуть ничего не напоминает это типичный обмен сообщениями между серверами и мировой компьютер Sci должен был довольно долгое время выдумывать решение этих проблем то есть статья о задаче о двух генералов в годах авторство са кото им портовые часы Вот здесь у меня на слайдах приведена ссылочка слайды я естественно опубликую и организатор наверно опубликуют там есть полностью э статья там всё на самом деле гораздо сложнее куча классов этих конфликтов и всё Это довольно плотно разобрано но тем не менее что с этим делать Я немножко сэкономлю время то есть как бы Несмотря на то что когда эта статья была написана мне было 2 года я её потом прочитал это не всегда случается со статьями но как бы надо это делать В принципе для борьбы с византий Существует несколько подходов два из этих подходов Ну я бы сказал 2 с половино но два из них это основные первый - это сделать разумный протокол с реализации распределённых транзакций то есть когда вот мы посчитаем Сколько нужно минимум гонцов чтобы обменяться этим сообщением вот тогда может быть нам наступит некоторое счастье нот сво ноте менее можеть Когда в Федерации начинается большое количество серверов конечно с двумя этот случай более-менее простой но как бы на беду вот это вот вся математика она была придумана очень давно то есть там уже к началу девяностых к середине девяностых более-менее там стало понятно некоторые вещи и сейчас как бы компьютер Science пытается заниматься этой задачей но как бы не уверен я что очень прорывной успешно в принципе сейчас основная как бы задача всего баз данного компьютер Санса - это не придумать какой-то новый принципиальным образом новый подход к сериализации распределённых транзакций а решить как же нам быть с тем что это очень тяжело и плохо А и В основном подходы э делятся на такие две очень большие группы первая группа - это А давайте мы как-нибудь сделаем циклическую репликацию это довольно просто да мы реплицируемый но просто в две стороны у нас неизбежно возникают эти самые византийские конфликты и мы как-то их пытаемся разрешить Вот например годами существовавшая мультимастер репликация в масле Она работает ровно таким же образом Ну если работает Конечно вот и в принципе как бы это путь он не в редком случае я могу сказать что он не был сделан в пикони в пикони Он кстати ещё хорошо сделан на самом деле изначально в старом масле я не могу сказать что изначально был сделан плохо просто как бы это задача такая да то есть там всегда будут сложности Но дальше компьютер Sci занимается в основном такими вещами попытка Ну и ОТП и вроде как бы вот без двухфазного комита без сложных алгоритмов И основная задача у них такая они пытаются ослабить консистентность каким-то образом базовая идея такая мы делим транзакции на важные неважные важные у нас двухфазный коммитом А неважных у нас очень много И вот как-то так они в конце концов как-то волшебным образом станут серие в принципе в основном это носит э чисто Академический интерес всякие вот эти алгоритмы шедуле а жёлто-синий э чёрно-синий транзакций и так далее но на практике в бою это применяется очень редко хотя в принципе ну если так вот подумать то э всякие там решения типа галеры и так далее они тоже как бы реализуют схожие подходы А ну и работают соответствующим образом сходно Давайте тем не менее разберёмся чтобы нам разобраться нам нужно понять что вот это такое скажите кто понимает что тут нарисовано ты знал особо хорошо смотрится фонарь У тебя над головой при этом Вот это так называемый диаграмма транзакций Я не знаю как это лучше перевести на русский язык это в общем идея такая это Линия времени кото там вот транзакция исполняется на сервере там обозначает вот мы транзакцию её исполнение занимает какое-то Время оно там пошёл вот этот отрезок здесь для примера изображён begin Weight дальше BW Это значит что кто-то там что-то заблокировал и пунктир обозначает что мы чего-то там ждём и дальше у нас идёт собственно говоря в какой-то момент комит для чего это делается Когда мы обсуждаем алгоритмы сериализации для наглядности мы рисуем вот эти вот линеечка длину внутри них происходят какие-то Элементарные операции ну и соответственно это помогает нам понять как же нам обмениваться этими сообщениями например для того чтобы с делом разобраться Давайте теперь посмотрим на живой пример а не просто пример того как вот эта вот сериализация транзакций работает живой пример называется алгоритм двухфазного комита и это в принципе такой фундаментальный алгоритм работы любых распределённых транзакций вариации у него при этом существуют очень много Здесь три узла за каждый изних отвечает своя стрелочка средний узел у нас выступает в данной ситуации в роли координатора в принципе в настоящих распределённых транзакциях координатора може быть какой угодно то есть мы в принципе можем перерисовать эту картинку чтобы транзакцию начинал верхней или нижней или нарисовать их 10 штук и очень долго потом рисовать стрелочки стрелочки рисовать любят все программисты поэтому как бы как-нибудь вот вот советую Просто попробовать на Большой доске так сказать и как бы вот ощущаешь себя сразу так вот нарисовал стрелочек так вот идея следующая что каждый из участников должен уметь локально исполнять транзакции то есть они у него локально должны нормально Дули и в какой-то момент координатор исполняет транзакцию она доходит до состояния когда он в принципе готов сказать комит если бы он был бы просто локальным здесь вы видите дальше идёт стрелочка вверх и вниз это он начинает распространять эту транзакцию на тех кого он координирует на тех кого в данном случае считается его Свами Хотя они также точно могут выступать в роли мастера и отправляет он им не просто сообщение Он им велит исполнить эту транзакцию и подготовить её Да потому что иначе это может там занять очень долгое время нужно сначала её подготовить и когда все участники процесса будут готовы закоммитить и отправят соответствующее подтверждающее сообщение Ready они получат от координатора ещё одно сообщение что Вот теперь коммите и тогда они быстренько все за комит и только после того какда они все за комит наступит глобальный комит который на средней линее обозначен буквами gc Global comit и в этой ситуации как бы всё произойдёт Как нужно эти транзакции будут абсолютно равноправными то есть один сервер управляет и он почему называется двухфазный в два в два захода отправляет сообщение на другие на свои свы чтобы они сначала подготовились к транзакции а потом когда им дадут отмашку быстренько-быстренько всё закатили Какие проблемы возникают с этим алгоритмом ритм хороший как бы там доказывается то что это ВС реализуется всё как бы хорошо и правильно основная проблема возникает как с теми нми Сколько гонцов нужно послать на этой диаграмме видно что в случае даже трёх серверов послать надо в общем довольно много гонцов и эти гонцы могут быть достаточно увесистый скажем так зависит от того какие вы транзакции гое другая проблема заключается в том что делать если у нас один из слоев отвалился Как вы помните одна из задач мультимастер часто бывает Это мы хотим в другой географический регион что-нибудь распределить в Америку поставить другую базу и так далее Насколько вероятно что эта штука отвалится Ну примерно на 146 про рано или поздно это произойдёт То есть тут никаких вариантов нету И в случае если у нас один из серверов отвалился у нас получается ситуация Ну вот в рамках той картинки которую нарисовал это предельно упрощенная версия этого алгоритма что у Нани глобальный комит потому что по идее сервер должен дождаться пока все ему ответят и далее возникает следующее что у нас вот эта как бы система становится сломанной да то есть у нормальной как бы локальной системы с транзакциями только если электричество отключили или там что-нибудь в таком роде произошло она считается сломанное и надо делать восстановление в распределённых транзакциях уже в этой ситуации нужно делать восстановление потому что один слев отвалился нам надо принять решение то ли мы его вообще КЧР выкидываем то ли мы его там поднимаем включаем Совершенно ничего непонятно то есть в рамках реализации этого двухфазного комита у нас должна быть предусмотрена система как откатить транзакцию назад и в этой ситуации да описана Опять же в больших статьях куча различных вариаций этого алгоритма которые описывают каким же образом нам нужно его откатывать что в ситуации если один СВ отвалился мы по очереди откатывать все остальные и потом откатывать на Мастере и так далее и в принципе если двухфазный комит используется в продакшене в той или иной реализации чаще всего это бывают очереди сообщений синхро очере обмена сообщениями то эта ситуация возникает крайне регулярно и она в общем является достаточно штатно потому что Ну мало ли Сеть гнула важно не то что вы откатились консистентные и не ушло какое-нибудь там письмо счастья О несуществующем налоге не списались лишние деньги и так далее обычно это в такого рода системах должно применяться увы не всегда применяется Вот и в общем это начинаются достаточно большие серьёзные проблемы с этим алгоритмом потому что эксплуатация его мягко говоря не сахар в Независимости от реализации я суммируют что у него за проблемы это во-первых высокая сложность во-вторых огромный объём обмена сообщениями и в-третьих это масса эксплуатационных проблем то есть вот как бы оно нормально и просто не работает никогда это нужно как бы глаз до глаз за этим следить Ну за некоторыми исключениями на самом деле ся Для каких зада применять Давайте теперь посмотрим как же это В каком виде реализовано в жизни какие есть решения которые можно взять да пощупать Ну во-первых есть Oracle Но если так вот сказать по честному Oracle R - Это не совсем Эта история Oracle сделал свой рак очень давно И основная идея на самом деле которая вероятнее всего у них была то есть это не Open sce Никто не знает какие у них были идеи нельзя посмотреть и хакер и выяснить что они там думали но в принципе была проблема того что не хватало CPU мультипро ссор архитектуры были далеко не столь совершенны и как ни странно база могла быть во многих случаях особенно там если умные jav программисты в неё ломились многопоточное или что-нибудь в этом роде она могла быть с кучей проблем производительности и поэтому была очень простая идея давайте мы возьмём одну базу данных сделаем в неё шарен ий доступ и несколько инстан сов могут с ней работать инстансы могут жить на разных машинах соответственно таким образом они скалится C рак с тех пор конечно сильно эволюционировал тот кто помнит orle де с раком на каком-нибудь HP тот как бы в цирке уже смеяться не будет особенно из первых версий сейчас это как бы довольно серьёзное хорошее решение но у него есть там куча проблем что во-первых он не решает те задачи которые мы изначально себе ставили то есть географически распределённый Application CL это это большая боль Там в документации написано что между ими быть дорого и больно ну и на самом деле там всё равно возникают проблемы производительности очень серьёзные во-вторых рак - Это очень дорого то есть мы как бы знаем что это такое в-третьих рак это надо специально уметь администрировать и ещё более того специально писать апликейшн под него то есть умелые программисты могут убить э рак в общем очень быстро это типичный пример в окле есть такая штука называется инверсные индексы обсуждение их создания для постгрес сейчас вот проистекает как раз по тем же причинам потому что начались а креативные программисты которые быстро всякие новшества привлекают инверсный индекс - это обычный индекс но просто если в несколько инстан сов в несколько потоков писать очень много данных индексные страницы перегреваются в часто обновляемой таблицы Можно так сделать чтобы они перегрева И часто так делают нет Естественно да но иногда как бы всё-таки мы ещё 2 гекта посадили пускай подавится клятый долгоносик А позиционирование вообще это задача из серии чем лучше джип тем дальше за трактором Но это отдельная история Вот и основная проблема в том что индексные страницы перегреваются и Oracle придумал что давайте сделаем Просто в обратном битовом порядке просто страницу держим Ну как бы по primary Q искать можно по ренджу нельзя Ну и Бог с ним ну то есть как бы Довольно простой изящный подход но это говорит Много о том как вот походит к таким вопросам Ну в общем я бы сказал следующем что скорее предназначен для задачи удобного обновления да то есть что ты выкатил обновился на одной ноде потом на другой и так далее ничего при этом не убил он скорее Вот про Вот это не про настоящий мультимастер потому что у него есть это который у него один пол по массе путей это в какой-то момент стало оче модно и все стали делать сво какие-то лае из них XC потом появился его for Excel и немедленно разошёлся куда подальше но при этом как бы основная идея что это такие честные двухфазные штуки то есть там действительно есть несколько мастеров туда можно писать они честный двухфазный комит выполняют а Excel больше заточен на массовую параллельную обработку данных у него там немножко по-другому устроен координатор У него много чего устроено по-другому XC - это больш так вот действительно там разнести на много дата-центров и что-то там делать Ну насколько успешно Это вопрос уже дальше будет сложный потому что у них все Те проблемы которые есть у двухфазного комита и решений которые его поддерживают а именно тяжело сложно Я уже объяснял Почему этим плохо управлять в гресе появился С тех пор и это в общем я бы сказал такой если честно Потому что фактически репликация которая базируется Нам же обычна используется и соответственно данные идут в две стороны А в этой ситуации на самом деле возникает очень простая проблема немедленно возникает куча конфликтов Кто первый приехал конфликты могут быть очень замысловатые зависит от того насколько замысловатые идут запросы и как бы если Вы посмотрите в принципе большой плюс посо состоит ВМ что Ирин там например если они возникают они там пишутся в отдельную таблицу там по таблично пишутся их можно проанализировать на каждый из вариантов конфликтов написать своё правило как их разрешать Вот вы понимаете к чему я клоню да то есть вот Представьте себе что у вас есть масса транзакций какая-то такая нормальная Уте нагрузка на вот такую вот штуку Ну конечно хорошо что саран научил хорошо эту штуку хедли эти конфликты но ничего с этим не сделаешь потому что ну вот вывалилось у меня за последнюю ночь 100.000 конфликтов в BD репликации и что я с ними должен сделать да Каким образом я должен это самое заглянуть в будущее и в прошлое и представить себе как постгрес это должен был правильно стерилизовать А откуда я уверен что это будет хорошо добиться там идеи когда ты с двух счетов переводишь сначала 100 руб потом 200 а на счету оказывается вместо 500 руб то ли соответственно 600 то ли 800 как бы это Это совершенно запросто то есть там как бы эта проблема происходит но ниша у него в принципе есть которая как бы можно использовать но только очень аккуратно А именно это когда надо герас небольшое количество понятных данных то есть тогда в принципе потенциально будет не очень большое количество этих конфликтов Ну это как бы бабка надва Я сказала потому что сначала у нас данных много мало потом внезапно много вот а во-вторых как бы эти конфликты можно будет разрешить хоть каким-то образом Ну и плюс К тому overhead на самом деле там тоже очень здоровый потому что мы написали 2 3 4 5 А через 5 лет 125 правил разрешения конфликтов и довольно типичный кейс будет когда у нас на мастер всё более-менее пролетает на тот на который мы в данный момент пишем разумно а Алай этого на слей которые это будут принимать будет при этом занимать 100% цпу потому что они будут там очень плотно работать над тем как разрешить эти конфликты тем не менее ниша есть и я бы сказал что э ниша Вот именно не массово там поставить две ра назначенных ltp базы в разных местах а скорее какая-то Такая филиальная сеть какой-нибудь там каталог расписать на магазины или что-то в этом роде Зачем при этом нужна репликация в две стороны это вопрос отдельный но мы как бы сейчас им пока не настолько задаём а следующая вещь Она старая и проверенная временем а именно слони и в принципе как бы я бы не сказал что она нерабочая базова - это там триггерная репликация не знаю есть люди которые не застали слонов вообще в репликации Когда не было Стан бая то есть Все пробовали с слонами работать вот в принципе хорошая вещь идея очень простая есть триггерная репликация обвешана достаточно хорошим инструментарием как соответственно взять данные положить туда-то проблем с ней масса особенно Кто помнит первые версии это как бы Ночной кошмар админа был всегда Да ну в принципе При некотором навыке вот у нас есть pgs там есть скрипты для того чтобы добавлять с этой в репликацию и так далее Пожалуйста берите Пользуйтесь там все грабли как бы уже сложены упорядочены и закамини очень похожая когда внезапно нужно зафи там какой-то сет таблиц должен обновляться с одной с одного нода с другого нода И они должны синхронизироваться обратно это в принципе рабочий вариант и я бы в данной ситуации выбрал бы слоны вместо диара потому что работают они надёжнее предсказуемый нас есть ряд клиентов Где Вполне себе живёт такой механизм Когда у них несколько баз в разных местах Ну и у них есть какой-то сет таблиц которые едет на каждый из этих словов в одном направлении и такой же сет таблиц который едет в другом направлении Они между собой мерж самое главное не пытаться сделать Как сказать взять всю базу обвесить слонами и реплицировать целиком туда-сюда Вот это естественно как бы работать будет Никогда потому что базово будут те же самые грабли что у BD а именно такое количество конфликтов которые вы никогда не грете и здесь ситуация такая что с одной стороны да получается мультимастер а с другой стороны вы выбираете какой-то очень небольшой датасет для того чтобы его использовать и обменивайтесь этими данными под строгим контролем ни в коем случае не пытаясь волшебным образом гонять туда-сюда всё можно ли это назвать мультимастер тологон наверно не назвал бы это мультимастер B слоне не упомянул нй потому что у нса с этим гораздо всё сложнее его гораздо сложнее шутить Это довольно специфическая вещь Ну и будем честными его разработка в данный момент не то чтобы очень жива слони живые всех живых живой разработчик слони У нас вот в будке сообщества по на выставке присутствует зовут Ян он как бы пон решимости ещ есть несколько человек которые Вполне себе помогают потому что у этого дела есть свои плюсы опять же bdr - это всё идёт через вал это репликация через логический декодинг Я знаю как программисты пишут приложение И сколько вала может сгенерить база данных при должном подходе в принципе решать двунаправленный вола в час это будет очень и очень плохо поэтому Тут уж лучше как бы понемножку и может быть слоны здесь более лучшее решение в сухом остатке я бы сказал что нам важно понимать двухфазный комит обеспечивает целостность и это более-менее единственный рабочий способ её обеспечить но его крайне неудобно использовать и в общем-то Это скорее решение для очередей сообщений Когда у нас есть там какие-то гетерогенные эндпоинты у нас приходит информация с одного Хоста кладётся в очередь передаётся на другой если всё упало Мы точно знаем что у нас упало Где У нас что персистирование просто как бы иногда очередями сообщений называют zer MQ rit MQ и имм Легион их каждый день какие-то новые придумывают вот очереди сообщения - это как правило то что реализует хотя бы GMS идеологию потому что там есть нормальные распределённые транзак они нормально работают как бы если вы интересуетесь какой-то очередью которую вам модно посоветовали первый вопрос должен быть как там реализован двухфазный комит Как часто там выполняется восстановление Как разгребая происходит и так далее как правило если на эти вопросы ответов Нет это не очередь Это что-то странное Вот Но для того что реплицировать всю базу целиком и равнозначно гонять запись нано двухфазный комит будет тяжело и больно в принципе имеет свою нишу как я уже сказал для того чтобы синхронизировать небольшой объём данных который достоверно нужно куда-то распивать географически Ну как бы опять же я не сказал бы что она про хотя в принципе пон решимости её в ядро в Десятку уже более мене что я бы сказал что у людей часто бывает завышенные ожидания то есть базовые те же самые слони но как бы только немножко посложнее и Да хорошо там через вал работаем и в принципе если у нас есть bdr то мы наверное можем к этому постгрес с таким же успехом подвесить и просто СВ для чисто подстраховки но мы и к слонам можем подвесить просто СВ это вполне себе не отменяет одно другого то есть для отказа устойчивости одно для каких-то таких задач другое в принципе и то и другое отказоустойчивости подходит плохо потому что двухфазный комит И решение которое на основании него сделаны там как бы будет сложно выбирать как отказоустойчивость обеспечивать отвалился слей и теоретически весь кластер под вопросом жив он или нет если отвалился мастер если отвалился один из участников слей и один координатор участвовавший в транзакции то всё как бы это уже это теорема опять же е доказал рекер который постгрес сделал кстати в бы годы Вот и как бы эксплуатировать это становится довольно сложно никто не говорил что это катастрофа устойчивое решение от падения метеорита там вообще никак Ничего не защищает А в нише bdr Я бы в принципе Отдал бы предпочтение слонам Ну как бы у меня работа такая мне надо не шашечки мне надо ехать мне надо поддерживать клиентов у которых как бы э это их родные деньги крутятся внутри этих баз и я не могу себе позволить как бы экспериментировать на них может быть Посмотрим через 5-6 лет bdr станет настолько же надёжным решением как и слоне Ну если слоны начнут загибаться это кстати будет верный признак того что стал лучше но пока что это ещё не время и пожалуй как бы самое главное в этом докладе на чём я хотел бы практически уже бы его завершить и как бы вот я специально подчеркиваю что это наверное самый важный месседж который можно из него вынести случаев когда пользова стром вме обычного необходимы Без этого никак нельзя обойтись исчезающим мало Если вы хотите воспользоваться мультимастер очень много проблем работать будет нужно много иногда по ночам но как бы если очень хочется то почему не попробовать в конце концов как бы это в принципе про Hot standby надо рассказывать на конференции lol А как бы такой конференции почему-то нет вот не знаю кто хочет на такую конференцию сходить а вот что-то нас как-то не так уж много Ну в принципе по мере использования мультимастер на такую конференцию начинает хотеться Ну и что я могу сказать если у вас есть какие-то вопросы их у нас есть ещё некоторое время наверное 5 минут чтобы спросить оба дня я буду на будке российского сообщества пог SQL где меня можно будет на спросить ВС что хочешь и ещ много у кого ещ не только у меня ну если есть вопросы то спрашивайте ро У нас есть ещ какое-то время Да у меня один вопрос Вы всё сказали так плохо Никто этим не пользуется Может это потому что решение хреновое скажем так я не сказал что этим никто не пользуется Я сказал что просто достаточно плохо Просто у на допустим решение да то есть мультимастер используется повсеместно и мы им прям крайне довольны у вас просто рак Да но это не мультимастер потому что он шарит тот же самый Stage под собой или у вас гело распределённый э рак теперь стоит Нет просто рек из со стэнд бая Вот так это не мультимастер это другая задача и это на самом деле это разумный компромисс почему бы нет то есть он как бы Он позволяет решить несколько задач например апдейт удобно такого решения в постгрес Пока нет На таком уровне Да ну как бы Леха бе до начала она А вот если по опыту использовать BTR только для iner таблиц никаких конфликтов не должно вылазить в этом случае это очень сложный вопрос как бы хочется просто делать инсерты в параллель Ну как бы рано или поздно придётся что-нибудь про апдейт на самом деле При этом insert в постгрес как бы ну он тоже может чем-нибудь закон това вы там какой-нибудь Селект добавите что-то там пощи А у вас эти данные ещё расходятся между двумя узлами Ну insert into что-нибудь там и из-под запроса что-то достаёт Да вот вам самый простой конфликт А их там ещё будет очень много да Ага а такой вопрос мультимастер для одного слева то есть чтобы в один слев писалось несколько мастеров А как такое развитие вот я видел в последнем масле 5,7 они ввели вроде бы такое что срем будет как вообще видите такие вещи Ну пока что слава Богу такого функционала нет в принципе я могу научить сделать это с помощью слонов и более того я наверно мог это научить сделать 10 лет назад То есть это вполне себе можно было сделать другой вопрос Что вы хотите этим решить Я хочу решить геолокацию разбросаю сейчас продумано кольцо вот Но если выпадет один из серверов то вся дорожка прервётся на этом месте и сделать так чтобы все мастера со всех мастеров получали данные то есть нужно распространять Ну это вот на самом деле типичная история Когда в зависимости от объёма и критичности данных либо нужна система со слонами либо нужна система с двухфазный котом и очередями в принципе как бы ну не то что прям кольцо может состоять из разного количества серверов Чем больше тем хуже будет это всё работать но вот и говорю У нас есть живые примеры когда есть там четы машины в разных регионах есть некий которые нужно синхронизировать на них на всех и на любой машине может произойти запись вот они слонами ходят есть отдельная совершенно схема отвечающая за каждый из словов и такая схема есть на каждом Вот этот слев пишет сугубо туда и дальше специальный процесс ходит Это всё ржет Но много ручной тяжёлой работы как бы а у меня есть вопрос Вот вы упомянули Oracle rck а такой философский вопрос Когда у нас будет СНР который Google spanner который гео распределённая это который который раньше был Big Table да И они потом сделали там был пепер такой интересный Я не знаю если мы скинемся и подарим коммьюнити несколько тысяч источников точного времени на Руби вых парах и GPS станции то может быть Ну они же они же пишут что это дёшево типа 100.000 долларов Да это там 10 серверов грубо говоря и в один дата-центр на один дата центр можно поставить Ну в смысле может быть у меня розовые очки там сильно розовые очки если почитайте внимательно те статьи которые они как бы знаете когда рассказывают о новом особенно вот таком сильно не традиционном хранилище очень полезно читать эволюционно то есть мы прочитаем где-нибудь там в vsm databases первое сообщение об этой системе потом второе потом третье там очень любопытно наблюдать эту самую такую эволюцию сначала у нас там не было никаких блокировок вообще ничего не было потом у нас добавилась там такая блокировка потом мы решили что блокировка - это медленно Мы везде добавили чек Это я про спаннер кстати рассказываю прямо это вот не фи ре потом мы добавили чекса на всё потому что у нас они как-то вот с блокировками медленно всё работало потом мы выяснили что 20% чек самов они какие-то почему-то не такие и не совпадают мы долго думали что с этим делать ничего не придумали поэтому Просто все эти данные нафиг выкинули и как бы это самое потом мы поставили источники времени на рудих порах Ну как бы вы понимаете был такой ну сейчас есть Дай бох здоровь который писал операционную систему О ну как бы на самом деле об этом хотел сказать времени ещё много потому что смотрите в семидесятые годы база данных тоже обезопасить себя снапшота они снапшоте с туда и никогда не могли упасть потом где-то к девяносто четвёртому году придумали алгоритм писания лого с чекпоинта и так далее и так далее То есть в принципе как бы чтобы Фантом действительно стал устойчивой системой похожей на базу данных у него есть ещё 20-30 лет как бы Google spanner демонстрирует ровно тоже самое да то есть ничто под луной не нового это на самом деле очень очень тупая математика Да она вся есть берите книжку читайте там всё написано и как бы можно я не знаю так упражняться у меня один был знакомый который занимался довольно много обсчёт статистики для медиков всякой Ну дата Science такой делал Вот у него было любимое развлечение он в паме находил рандомную медицинскую статью смотрел на результаты закрывая методику и пытался по цифрам которые В результатах получились угадать сколько было пациентов взято для исследования Там два-три и так далее вот в принципе можно так же точно преду си я честно говоря не считаю что это самая такая вот хорошая веь в постгрес довольно много люди заботятся об распределённых транзакциях для начала там вы знаете что в постс дный комит в коробке поддержан в принципе можно просто вот как бы делай не хочу берёшь делин обшивает вот готовая очередь сообщений Да там немножко придётся попотеть Это я не хочу плохому научить сразу это можно если там достаточно амита для некоторых зада достаточно пи прокси скайповский который в отлича от нй довольно неплохо разрабатывается какие-то задачи им можно в принципе на запись решить то есть Вот например мы часто клиентам его ставим для того чтобы архивировать данные на какую-то удалённую машину Ну базово это да вот Мастер и мастер на эту пишется на это пишется перенос данных мы осуществляем с помощью P Proxy Да есть свои нюансы но как бы работает да ещё вопрос Скажите пожалуйста вы не упомянули работает слышно слышно Вы не упомянули пул Это конечно не вполне Не вполне мультимастер репликация но в режиме когда работа запись логическая идёт на два сервера равноправных позволяет как раз делать гео занесённые сервера а читать с них соответственно отдельно при этом имеем Ну единую фактически одинаково и не нужно блокировок Ну я бы сказал что блокировки всё равно понадобятся но с пгм другая проблема Дело в том что пгпу реализует вот эту вот репликацию параллельную запись на разные мастера примерно так как делал этот мультимастер там не знаю там версия 51 или что-то в этом роде То есть если Вы посмотрите документацию на соответствующую версию там есть такой список функций небезопасные для репликации в ПУ базово тоже самое не дай проу которых сильно зависит от внешних условий не мутабельных Вот и как бы и Привет да То есть вы получите разъехайся данные чем больше серверов тем больше разъехайся по которой совершенно нельзя понять какие какой из этих кусков данных правильный Ну Ну и что вот это как бы что с этим дальше делать мне совершенно непонятно если честно поэтому я вообще не советовал бы использовать в продакшене вот такую синхронизацию данных ппо это очень плохая практика и источник таких костылей которые потом будет очень тяжело найти самое главное Да ещё вопрос Вот спасибо за доклад А у меня такой вопрос что бы вы порекомендовали для решения задач онлайн переключения мастера в геора раскрою почему Ну в принципе вариантов только два дба который может проснуться посмотреть на то что происходит и принять правильное решение при том если как бы инфраструктура сделана правильно то есть есть нормальный мониторинг нормальное оповещение он может всё посмотреть он очень быстро поймёт что произошло то ли гнула сеть между апликейшн Прим СМСку и вообще всем остальным миром То есть как бы вот это определить довольно просто дальше возникает другая задача есть вариант Авера когда Это должно сработать автоматически и это как бы ну я как человек зарабатывающий на поддержке баз данных Я не могу не одобрять идею Авера то есть вот это любимое это сразу можно заработать очень много денег потому что история такая у нас есть а вот куда мы будем ставить этот самый мониторинг чтобы О как бы грамотно выяснял что нам надо сейчас Фло верить что действительно упала сеть там где нужно и это действительно нужно реагировать вызывая ато фловер по-хорошему нам нужно на всех участников этого мероприятия расставить по чекал Ну как брокер дагар раковый так и делает базово на самом деле а потом он каким-то кворум должен между собой договориться и это на самом деле очень непростая история как ему принять это решения то есть базово все эти не доступны они доступен доступна ли с них база и так далее эта задача на самом деле в полный рост тот же самый двухфазный комит без распределённых транзакции между мониторингом мы этого сделать не можем потому что мы не поймём Что упало Где где нет коннекто и так далее ввиду сложность этой всей штуки ну как бы на мониторинг на который завязан афа вешать распределённые транзакции Это несколько уже искусственно я бы сказал бы дальше мы приходим к тому что это очень сложная система у которой есть большой риск ложного срабатывания и вот здесь вот начинаются как бы основные ви если помните несколько лет назад Там уже лет UB таким образом ЛК на несколько дней потому что базово что происходит Окей автор решил что пора ловери свелся У нас мастер превратился в тыкву появился новый мастер с его зали раз ему что-то пришло в голову он опять словил Через несколько секунд е один Мася в кву пока его с меньше его зафоловлен там не форил больше трёх раз подряд Там есть много всяких раундов но это очень сильно усложняет эту систему и всё равно проблему глобально не решает по моему опыту ещё есть один такой важный момент что когда мы стараемся обеспечить автоматический фловер мы стараемся повысить доступность решения да то есть чтобы вот время простое было меньше чтобы переключение происходило быстрее Ну вот у нас есть там 5 лет эксплуатации нашей системы так сказать в перспективе Ну два-три раза она упала там дба значит соответственно там проснулся Его переключил там минута на тикало в другой раз он там проснулся переключил на тикало ещё одна минута дальше там было 23 февраля он был пьян это у него за него 15 минут пока его дозвонились А следующий раз мы падали летом он ушёл там соответственно поход куда-нибудь где не берёт телефон ну кто-то там нашёл ротовой пароль и там стартовал базу Там через там 15 минут вот мы в итоге получили меньше часа в ситуации с автоформ вероятность того что вы упадёте так что будете собирать базу потом по кускам полдня она очень высокая вот перспектива 5 лет Вот так мы потеряли час Вот так мы потеряли полдня и массу острых ощущений получили То есть по-хорошему как бы более дешёвый и разумный вариант на мой взгляд Спасибо не работает микрофон не работает Т Ага раз раз ситуация жизненная с автором можно Ну чу раскрыть тему момент такой то есть есть мониторинг который срабатывает Ну не всегда оперативно То есть это минута это ни разу не минута это полчаса то есть покажу посмотрит да то есть что-то загот покупайте кмет пока где парни из кмет Пока светится с маршрутной картой там и найдёт исполнителя пока м дозвонится Ну не минуты всё равно вот то есть ну хорошо 15 минут если есть маршрутная карта исполнитель системы эксплуатации в большой такой конторе Я не понимаю почему там нет при этой системе которая настолько критичная дежурное смены а денег надо это это проблема Не та которая решает автолом Ну то есть ваше мнение Он вообще не нужен Ну я Я опасаюсь если честно Я никогда не видел чтобы он работал хорошо я пожалуй рискну согласиться что у ама в п сле и в окла в дата Гарде он наиболее разумно реализован но это не делает его хорошим хорошо Спасибо ещё вопросы нельзя ли решить проблему аром просто добавляя новые сервера Да мы посадили ещё Пусть он подавится надо просто смотреть в перспективе как такая ситуация обычно развивается обычно это не та ситуация где кто-нибудь вообще может что-нибудь добавить потому что это происходит в че не минутное система с помощью абла там автоматизировали новые амазонок такой ситуации но контора обанкротилась потому что пока пришли админы как бы коллеги у нас на самом деле время подошло к концу Яя не буду сильно так сказать ажитированная"
}