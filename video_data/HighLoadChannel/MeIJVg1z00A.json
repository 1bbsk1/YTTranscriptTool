{
  "video_id": "MeIJVg1z00A",
  "channel": "HighLoadChannel",
  "title": "Как мы ускоряли WebGL / Мстислав Живодков (2GIS)",
  "views": 463,
  "duration": 1828,
  "published": "2017-04-22T14:47:58-07:00",
  "text": "меня зовут готов из слов и я работаю в компании 2 диски мы светская эти компания и мы помогаем людям облегчить навигацию по городу наши основные приложения это звонить точка руб и приложение под мобильные платформы у нас довольно большой технологический стык в компании я пишу джесси кто-то москве кто-то на к а кто-то на таких карт кормят языках как тип плюс плюс я работу в компанию для два года и наша команда занимается и 5 карт вы возможно могли ими пользоваться но открытая и может любой пользоваться это же ebay используется на нашем сайте товарищ точка ру но последний год наша команда занималась таким интересным проектом как этажи этажи это часть проекта 20 точка ру вы можете зайти на него интересный вам торговый центр и посмотреть его план чем примечателен этот проект он работает на технологию джен и когда мы начинали разработку этого проекта никто из нас команде никогда не сталкивался с этой технологии никто из нас никогда не работал тогда графикой вы можете спросить нари к торгам использовать такую технологию если можно было сделать так обычные карты дело в том что мы хотели сделать наиболее естественно навигация для пользователя мы воспринимаем себя в трехмерном мире поэтому трехмерная карта окажется наиболее естественно что же ждать от этого доклада скажите небольшой эксперимент то есть басс использовал уже технологию в джеме поднимите руки пожалуйста а кто только хочет будущем начать ее использовать есть какое-то желание клёво этот доклад как разные вас но это я не буду здесь рассказывают каких-то от здоровых штук без 3d графики это как раз на тех кто только хочет начать использовать эту технологию нам очень понравилось работать с этой технологией но мы столкнулись с рядом проблем и лучше бы мы об этих проблемах знали заранее так вот я вам расскажу как можно тренд recent который хранится более тысячи объектов и неуверенным как построить пользовательское взаимодействие с ними делать и приложение с jira о том что стоит иногда и фиксируете свои велосипеды иногда они очень полезны и о том что вам придется менять подход к работе если вы делаете проект на такой начнем с нашего приложения та часть приложения которое относится к виджетов состоит из двух основных частей первая часть это какие-то трехмерные объекты это стены комнаты площади отлично та часть которая принято называть карты ее можно вращать приближать делать с ней все что угодно вторая часть нашего приложения это маркер и маркер и это не трехмерные объекты это скорее элементы интерфейса записан первый прототип нашего приложения мы поняли что мы где-то честно говоря наговорили потому что наше приложение выдавала максимум 20 кадров в секунду 20 кадров в секунду это очень мало если вы будете пользоваться таким приложением она будет у вас дико тормозить дикой лагать вам захочется разбить экран своего айфона если вы увидите мой телефон вы поймаете в общем мы начали читать какие-то дополнительные материалы смотреть и первый совет который говорится во всех материалах посвященных производившихся в джед такой совет как объединять геометрия что же это значит смотрите геометрия это набор вершин какой-то чтобы ее построить нужно вершины вершина состоит из трех кармен от nyx увильды если понятно цвет говорит о том что вам нужно стараться всякие метры на сцене окне допустим у вас есть комнатным комната состоит из четырех стен и пола 5 вершин от кометы вам нужны их объединений у вас было программная 5 массивов разных набор вершин вам нужно получить один почему это важно так вот почему бюджет это общение с вашей видеокарты любое общение с вашей видеокарты это узкое место вашего приложения вам нужно стараться сводить это общение к минимуму поэтому мы взяли торговый центр года нас без как к примеру и мы уже получили 300 разных геометрий чтобы трендов геометрию вам нужно вызвать операцию отрисовки и передать эту пирамиду таким образом идеально работающие приложения джед это 60 м2 psi ком бы 60 раз 300 геометрии вызывают 300 операции секунду происходит это очень видно огнев все геометрии мы подняли на шкаф с 20 до 50 вам может показаться что вы не сможете проделать ту же самую операцию ваши объекты могут быть слишком разные скорее всего это нектария даже если ваши объекты имеют разные какие-то наложено текстурного титанит на какие-то влияет цвет она гасит они скорее всего вчера но вы сможете их обвинений вам придется написать свой цели предыдущий докладчик немного упоминала про шейдеры я не буду сильно углубляться скажу лишь то шейдеры это программа написанное вами программы исполняемая видеокарте и абсолютно для тусовки любого объекта вам придется использовать шейдерами так или иначе с ними столкнетесь не надо бояться в итоге старайтесь сводить к минимуму взаимодействие с видеокарты от меня объект другая часть нашего приложения это маркер маркер и как я уже говорил это не элементы это не трехмерное объект на это скорее элементы интерфейса и какие то круги надписи на карты поэтому мы как люди привыкшие работать с обычной картой бедно карты первая наша реализация была и маркеров ложки мы здесь есть ряд проблем когда таких маркеров 30 ваше приложение работает хорошо но когда их возникает типа и количества около 1000 все начинает очень тормозить каждый маркер это отдельный дом элемент как вы наверное знаете дом очень медными логичным решением было перенести маркеры фиджи мы используем такую крупную технологию почему бы не использовать ее на полную катушку снаружи в бюджетном не сдает еще одно преимущество обычная карта лежит в плоскости вашего экрана как она делается маркерами вы создаете какой-то родительский элемент и помещаете мне и отыщем актив пользователь двигает карту вы двигаете этот родительский элемент если маркеры браузер с двигается работает принципе не полным но с вашей трехмерной карты такое не пройдет она уже не лежит в плоскости экрана и вам придется вычислять координаты каждого каркера по отдельности в крипте это очень медленно чтобы сколько этот процесс отдельно очень помогает вы можете перенести все вычисления маркера положение маркеров отдельных shaders shaders тем хороши что они работают очень быстро и параллельно для каждого бракован для каждого маркер таким образом перенеся маркеры биться html бюджет последовав предыдущему совету а и не в парке в одну геометрию это было несколько сложнее сделать потому что маркер это динамические объекты как статическая карта сложно но возможно мы повысили наш с 50 до 60 здесь есть небольшой нюанс когда вы арендуете маркеры с помощью мейджера вы вы же не можете легко кастомизировать с помощью css ты вы привыкли вы не можете легко поменять ему цвет или использовать еще как это привычные рамки с атрибут если вы хотите сделать кавер вам придется создать отдельную гонку который вы будете заменять если маркера повесим пользователь зайдет курсор на маркер еще одна проблема которая появляется с вами джелем это интерактив какой-то пользовательское взаимодействие обработки событий были больше не можете легко подписаться на событиях дом элемента какой привыкли отлить mauer на вас бюджет приложение тела then do many men can нас все общее действие все объекты рисуются именно в нем поэтому все взаимодействие и обработку событий вам придется делать самим так как мы были новички в эти технологии мы использовали наверное из самых угарных оценки как джели этот реджис она нам очень помогла на начальной стадии разработки она обладает очень большим функционалом для работы с фотографиями помогла нам и здесь есть такой класс который костин что же такое это луч который исходит из точки положения вашей камеры в трехмерном пространстве направление куда показывает сейчас курсор мышки он достиг 3g осуществляет все пересечения этого участка размеров она как-то не ваши стены и выдает ванна таким образом вы легко поймете где я происходит где находится сейчас курсор над каким объектам но здесь мы успеваем некоторые с предыдущим советом мы уже объединили все трехмерные геометрии объекты по но геометрию на сцене мы не можем понять куда же водитель критики у нас 11 как можно решить эту проблему смотрите у вас есть одна сцена в которой содержится все трехмерные объекты но мы в одном километре сцена и постоянно рендерится и показывается пользователям вам нужно создать вторую сцену которая никогда не будет рендериться когда не будет видно пользователь она просит у вас будет храниться в программе вы не и помещаете все трехмерные объекты но уже не меняли форму геометрия когда вы хотите сделать обработку события вы просто используете именно на этой сцене все проблема решена маркеры с маркерами другая ситуация как я говорю марки не трехмерные объекты ли кастер вам здесь не поможет но маркеры с ними ситуация намного проще они их размеры не зависят от расстояния можете двигать как угодно карту и их размеры не будут меняться поэтому вы легко можете вычислить границы маркеров на экране если вы знаете кранец маркеров на охранника легко поймете куда попадает сейчас трусов задачи работает быстро но если у вас 1000 маркеров возможно вы захотите ускорит лен я рекомендую использовать библиотеку и bosch bosch это библиотека написанная создателем лифлет а если вы знаете что это цвет это наверное одно из самых популярных решений для карт или так он библиотека создана именно для такой ситуации просто строят дар дерево на основе перед на границе поэтому работает быстро на наверное самый крутой путь которые я считаю который мы не смогли еще применить мы просто не успели тут объединяет в себя все предыдущие варианты и маркеры и трехмерные объекты он обвиняет себя абсолютно любой объект который вы показываете пользователю следующем вы также создаете отдельную с целом вы помещаете в нее а также все объекты ядра мерные мортиры вы можете их даже линий для ускорения с одним условием каждый объект имеет уникальный цвет таким образом когда пользователь делает клик в целом несмотря на то что мы евреи земли и все равно можете не показывать пикселя точки где находится курсор на этой сцене так как все цвета уникальны и понимаете над таким объектом сейчас происходит взаимодействие с каким какой-то момент мы поняли что наше приложение получилось очень большим а это очень критичный могли нас показатель потому что она устраивается наш like this . проанализировав код мы поняли что большую часть нашего приложения занимает наша библиотека выбранная нами это 3g она весила более 500 килобайт тут джордж случилось связь слайды в общем красное это 3g с осени и это наш код написан и лично нами есть библиотеки 3jet обладает очень большим функционалом который мы использовали самый минимум с него логичным решением было написать собственный библиотеку в которые перенести мы выберем slide какие то лучше практике ис-3 джесс и только то что нам нужно мы написали в библиотеку и назвали и 2g мы заходили размер практически в 5 раза мы сделали ее также открытой она умеет рисовать передам ее геометрии и маркеры а если ваши задачи похожа на наших пожалуйста заходите используют мы будем только рады кроме уменьшения размера мы получили еще один мы сильно увеличит производительность поскольку библиотека была заточена только под наши задачи таким образом велосипеды и никто не очень полезным другая часть связанное с размера это данные ваше приложение рисуют трехмерные объекты для того чтобы адресовать трехмерные объекты вам нужны координаты то есть данные данные обычно получается очень тяжелым к тому же вам нужно будет триангулировать ваши данные зачем это но а потому что бюджет умеет работать только с треугольники слову триангуляция это разбиение ваших геометрии на треугольник вот что вам нужно знать эту операцию первое это то что сама триангуляция сильно увеличивает количество данных и второе инфляция затратная операция вам нужно будет решить в ее делать и на клиенте или на сервере мы сделали на сервере но если вы решите все таки делать я на клиенте то есть передавать пользователю меньший объем данных но зато делать какие-то впечатления на клиенте то советую вам использовать следующий библиотеку и откат эта библиотека от компании ибо бог сам вопрос это так компания которую жизнь сделала трехмерный картера geely и они как раз используют триангуляцию на светлана клинч с помощью этой библиотеке ваши данные скорее всего это координаты нашествию значит какие-то числа логично будет неред не использовали при передаче на клиенты числом который в итоге приглашается гниющим строк а использовать какой-то свой бинарный формат если вам лень придумать свой и нарын формат вы можете использовать prada bag на добавь курируется буквам но его использует уже очень много компаний где же попов не существует очень много реализации для этого формата под разные языки заходить использовать другая проблема очень больная для нас проблема потому что мы с ней столкнулась уже прямо перед самым релизом в конце это сглаживаем если вы хотите чтобы ваше приложение выглядело очень красивым вам скорее всего понравится использовать сглаживает мы использовали нативно сглаживание которое весь браузер и практически в конце мы поняли чтобы работать на везде дольщик отказа сглаживание может быть очень много это может быть ваш браузер ваша видеокарта и просто клево поставлены драйвера что же делом вам нужно решить нужно ли оно вообще если да то есть например вариант написать собственное сглаживать как поступает компании магазин чтобы адресовать дорогу и начали рисует основной контур а по краям закрашивать и и градиентом таким образом они видны все эти кривые пикселя и тем более панский ли сегодня нужно будет использовать такой сглаживание на всех объект она понадобится поэтому вы значительно сможете ускорить свою задачу производительность то есть важные детали которых стоит помнить вы используете технологию ворчим а это достаточно новая технология которая доступна только в новой правдин поэтому используйте все фишки в этих новых правды например бисером властью обрабатывайте большие объемы данных типизированные массивы были созданы как раз до этого они работают я может быть и больше какой то момент мы просто они начали искать все маску и фиксированный это на очень чтобы сил быстродействие worker и ваша проводили скорее всего доступны в ордера каждую задачу старайтесь раз параллели перенесите все вычисления mobile для чтобы пользователь не заметил никаких подлагивания тем более если вы используем лицензированные массивы скрипта то типизированный массивы это практически единственное объекты в джинсе которые можно передавать сборке-разборке не тратясь на операции просто посылки передается и профилированным ваше приложение или рендере вается 60 раз в секунду таких условиях код который выглядит обычно нормально может вызывать неожиданный подлагивать профилировать таким образом используются типизированные массивы старается параллели задач в цель это совершенно другой мир это не остров горн и кафе это непривычно вам backstage немалом css здесь могут встретить совершенно вам непонятной проблемы скажите вы знаете что это такое такая ситуация больше 2 3 мерных объектом нравится друг на друга когда мы ее положили мы не смогли даже это загугли кто знает решаем короче мы очень много поверить над этим но потому что слоем найти она имеет очень короткое название это z fighting как его избежать я знаю два способа первый это просто вырезать один объект из другого а второй на прямую бюджет указать какой объект равен первым а каким вторым с веджем вам придется менять подходы к своей работе это новая технология не похожая навык реальные случаи жизни когда дизайн окна пришел и сказал ребята давайте мы будем выделять комнатами когда пользователь на них наводят мышками мы поменяли цвет и добавим вот мы подумали таки очень выдает вы работали с css css это просто сделать там давай заговоры бардак ну наверно бюджета же мы провозились с этой задачей около недели и мы не смогли мы легко поменяли цвет и тон мы не смогли добавить охоту на пришлось отказаться от этой и смотрите наша комната это набор треугольника как в этом наборе треугольниках найдете именно те треугольники и те грани этих треугольниках которые находятся на границе комнаты это очень сложная задача мы ее решили не делать помните сводите к минимуму взаимодействия с видиокартой объединяйте геометрию не бойтесь писать свои велосипеды они очень помогают я вам рассказал несколько примеров как то стоит взаимодействие использовать и я уверен что небольшая команда любителей сделать его размеры зависимости потому что может сделать один вопрос и дополнения господина чем использует чем пользы для проектирования что использовали как инструмент оценки производительности профилирование то бюджет мы не прошивать код шейдеры травами и дополнении мы в программах используем для эффектов интерактивности как раз render to me и тесла стал это когда правит бог омыл очереди направлении потому что будет удивительно столь правильно просто причине что когда вы тратите буфер цветами вам нужно потом за цену большую страшно операцию pixels прощайтесь любители которая может заблокировать потолка на очень очень долго и но это было релиза объемным способом то есть просто там будет такое решение как экран подобное крепится сидел прочный долга в самом самом самом топе пропали раз отрывом развиваться следующего года в итоге сейчас работы так что будь интерактивности он сильно меньше он констант на размер 12 12 большими шкафчик хорошо и java когда продуманного ртути в сторону кастинга сцену и аналитическое чтение нативной точка зрения на и джерри до нас спасибо я начинаю просто сказал а точнее забыл об этом сдавать the pixies опять же общение с видеокарта и опять же какой то но у нас просто другая немножко ситуация мы решили запретить какой ты по ценам действует пока двигается карта пользователь сдвигает карту и после этого мы рендером всю эту сцену и оно происходит там щеку умели секунд 10-20 и чувак просто не заметив этого если бы мы янтарь эту стену постоянно оттуда можно еще подумать кстати а вы не могли схему с задержки в интернете вот дедом элементов то есть сделать обычный дом элементы которые были реагировали сделать их невидимыми то есть реально существующими удивительную так как они невидимы и они будут отрисовывается позиционирование можно и балансить чтобы она редко всплывал его можно несколько тысяч их рисовать на экране все что у нас есть комнаты который маркеры помог запрос должны придумать на самом деле смотря на все просто больше работать очень быстро проблем с ними нет проблемы именно с реальными объектами взаимодействия маркеры спальными сделанный из марки насколько я помню в 3d с меткой нормально у нас встречаемся пошло потому что там спрайты маркер и их размеры менялись бегаете крафту одни станции такая поэтому у нас немножко любой ситуации этом фага нет раза вроде есть а еще вот по поводу депо горшенин шейдеров насколько я помню есть такая штука шейкер monkey как так называется она для поджега или нашей развёртке сюда и подходит в джерри в минске шейдеры и тот жил без то есть это просто поджала кишит я не слышал шейкер банки я читал про джеймса в демре катара что этот проект будет ему наследников проявить inside пробежки типа игорь так далее я посмотрю dx прошу подробнее все что ты там увидел было выкупал фона зависимая работа наставление силиката ни как-либо просто как раз ты вроде зависимой вроде и самая крутая туда это visual studio новая там вот шатры очень эффектным круто отваривать но они правда потеряют x что не вариант если у кого-то есть какие-то советы у нас та же студия много крутых услышать потому что как говорил мой нынешний в этой технологии и мы не знаем"
}