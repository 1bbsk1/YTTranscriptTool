{
  "video_id": "m5CDfrQLzrs",
  "channel": "HighLoadChannel",
  "title": "Кафка. \"Описание одной борьбы\"  / Денис Карасик (Badoo)",
  "views": 15414,
  "duration": 2825,
  "published": "2020-02-26T11:59:31-08:00",
  "text": "итак доброго утра всем меня зовут дениц и сегодня я вам расскажу как за последние полтора года кафка у нас году выросла из эксперимента одном сервисе до полноценного решения или стала одним из ключевых инструментов внутри компании но перед тем как начать рассказ пару слов обо мне кто и такое стоит ли вообще меня служит я работал в компании буду в отделе платформа 2014 года и в нашем отделе мы решаем различные инфраструктурной задачи мы развиваем поддерживаем свое облако занимаемся и системами хранения данных и активно занимаемся инфраструктуры очередей и вот как раз на очередях и мы решили поэкспериментировать это был первый проект им внедряли кафку нашей целью было непоправимо улучшить время доставки с тех пор много воды утекло и сейчас у нас три plaster а кафки в двух дата-центрах в каждом патрик мастера более 10 ключевых сервисов работают на кафки и все это мой танец всего два админа этом большой о чем я сегодня буду рассказывать сначала мы очень быстро пробежимся по основным аналогии кафки затем мы затронем очень важный вопрос надежности как не потерять данные потому что мы ты их теряли потом я уделю внимание структуре кластер как убрать кластером и что с ним делать и последний финальный блок это будет о мониторинге диагностики проблемы коллеги я принципиально не стал выстраивать свой доклад как очередную секс истории я очень скептически отношусь создается впечатление что люди которые их пишут либо о чем умалчивают либо я и все с кем я работаю это криворукие инженеры которые регулярно натыкаются на всевозможные баги и проблемы мне очень важно чтобы во первых не повторяли наших ошибок и у вас все было нормально и и вторых вы поняли что кафка дайте действительно мощный и надежный инструмент но каждое ваше действие должно быть осознанным любая ошибка может вам очень дорого стоить и так кафка начала коротко карте что это такое ну по сути это распределенный лоб горизонтально масштабируем распределенный лак с возможностью публикации подписки по сути основная задача это доставка сообщение от продюсером которые пишут кластер долл консьюмер of до подписчиков кластер кафки состоит почти всегда из нескольких not именным их брокерами и координации между нодами осуществляется с помощью демона закипит и так как продюсеров пишет данные где не там хранятся данные в кафки разбиты по топиком и каждый топик состоит из определенного числа партиций так вот платится это и есть та самая скажем так единиц основная единица хранения данных буковки имена в partition хранятся данные и если вы зайдёте на обороте на файловую систему вы там неких топиков не увидите топик это лишь некие логически контейнера вокруг партиции каждая портится это упорядоченный неизменяемый лодками тов то есть каждый продюсер может записывать данные только в конец не может никак со своей стороны повлиять на уже записаны данные не их менять не как-то удалять и каждому сообщению присваиваются некий уникальный порядковый номер ну мы овцы по записи немножко разобрались как и шкаф cqe и мы читаем ну есть два способа первый способ мы указываем консьюмер топик указываем консилиум номер партиции и указываем отец которого начинает читать в общем-то все консьюмер будет учитывать совсем как вот в данном примере два когда он найдет до конца партиции будет ожидать новых сообщений которые тоже потом будет вам возвращать но в таком случае вы должны как-то вне кафки миниджек хранения все там запоминать и где если вы не хотите так делать то вы можете создать контейнер группу то есть указать какой-то уникальный идентификатор группы и тогда кафка сама будет вас придать птицы и сама будет запоминать сохраним ваши записи на все ты внутри специального топика общем-то это примерно все что я хотел сказать их водном слое парковку да это достаточно быстро и скомкано но поверьте для понимания доклада вам этого точно хватит и так мы переходим к очень важному вопросу вопросы надежности почему он важен но смотрите мы внедряли кафку не только для того чтоб все стало очень быстрым для нашей бизнес логики очень важно не потерять сообщение и давайте разберемся как капканом может обеспечить надежность как я уже говорил кафка распределенная система и когда мы говорим о распределенных системах и забываемся надежности то первое что приходит на ум это репликация то есть продюсер пишет данные в какой-то топик который живет на каком-то блоки но мы хотим чтобы этот эта partition любая платить 100 пика как тори прицел оси присутствовал на других брокерах вот и кажется что указали мы факты репликации например как в этом примере 3d и все у нас будет хорошо данной никуда не пропадут всегда останутся и все быть замечательным а вот так ли это давайте разберемся чтобы ответить на этот вопрос нужно разобраться как кафка пишет как данный пишутся в кадке как работает внутри аппликация смотрите продюсер всегда пишет данной в какую-то партицию он всегда общается с одним брокером они со всеми этот брокер будет называться лидером и вот на всех слайдов и будет такого красивого рыжего цвета более того консьюмер а они тоже читают данные всегда в одного брокера с этого лидера реплики нужны только для того чтобы место сидиром случится что-то плохое а не посмотрел занять его место в них никто не пишет никто не читает они сами подтягивают сообщения от основного блоки от лидера нужно понимать что брокер у нас является для многих партийцы виде раму для других партиции он будет репликой да то есть не какой-то один волшебный брокер лидер для всех что произойдет если мы запишем сообщение как я уже сказал продюсер запишите в лидер и оно появится именно там но в этот момент когда она появилась в видео но не будет доступна для чтения ни одному из консьюмер of вот это важный момент вот на рисунке показана линия high water маг так называемые вот слева от нее это уже успешно записанное сообщение которое доступны для чтения справа от сообщение со всякой 3 она еще не до конца ночь не считается успешно записан и никому не доступны и чтобы оно стало доступным все реплики должны его себе подтянуть все то есть начало какая-то одна его потягивает вот потом какая-то 2 и только потом видео узнать о том что все реплики подтянули сдвигает линии вотермарк а и сообщение становится доступным для чтения и в кафки нет никакого кворума на запись вы никак не можете указать например пускай половина реплика подтянет и тогда она будет доступна на запись его на чтение или пускай только у лидера она будет и вот тогда можно читать нет все реплики должны обязательно подтянуть и то есть по сути мы пишем данные со скоростью самого медленного брокера более того и за проследует что все брокеры в идеале должны быть одинаковым конфигурацию если вы не хотите где-то в облаках и у вас своих дата-центра как у нас вы не сможете собрать брокера из любого подручного железа у вас будет потери производительности и по этой же причине вниз можете разделить брокер 1 класс тебя по разным оценкам это очень сильно будет ответить запись скорость записи как можно на эту скорость повлиять ну во первых есть такой параметр вот он сверху указан да по сути это то время как часто блоки реплика будет опрашивать видео зачем по умолчанию 500 миллисекунд мы его выставили в 200 у себя и тут вот 1 point не рассчитывайте что в кафки у вас по умолчанию будут какие-то адекватные вам подходящее значение всегда для важных параметрах устанавливать их в посол осознанно в нужные вам значения хорошо тут на подкрутили что мы можем еще как мы можем еще повлиять на на запись ну здесь ощущение что мы можем что-то указать в конфигурациях продюсером да там действительность очень важный конфигурационный параметра ax это по сути определять тип подтверждения которым мы будем получать от лидера при записи данных и есть ощущение что он влияет и на целостность надежность данных и на скорость записи давайте посмотрим как это все работает каким может принимать значения вариант первое значение 0 то есть мы никакого подтверждения не ждем тогда у нас продюсер отправляет данные вот какие то сообщения об отце отправляет их вот партицию на лидера и оправданный все все о странной пули вылетели дальше у ничего не волнует вы уже получили какое-то подтверждение дальше не как там запишутся и скорее всего ну не скорее всего очень легко вероятны что какое-то сообщение у вас не дойдет до кластер вы никогда об этом не узнаете и явно что такой вариант не подходит для важных данных вы почти гарантированно будете первички что-то терять второй вариант мы ожидаем подтверждение когда лидеров записал у себя сообщение и кажется что вариант весьма такой приемлемой смотрите что произойдет продюсер пишет сообщение она записывается в лидер помните сейчас то сообщение еще никому не доступно но еще не сыплет сыра валось никуда в это время леди отправляет утверждение продюсеру и все кажется неплохо все кажется неплохо пока у вас в этот момент лидер не уйдет в небытьё такое вполне может случиться он может просто моргнуть из-за каких-то там сетевых проблем и что произойдёт сейчас причем мы делали реплики правильно одна из реплик скорее всего в тут же станет лидером когда наш предыдущий брокера вот вообще вернется он поймет что мужчине леди и синхронизируется с новым лидером и просто сотрет у себя затронуть летит сообщение который был сам сок внутри и вы опять же можете потерять сообщение более того вы точно будете терять прикид и сетевых проблемах этот пример тоже не подходит для важных пунктов и остается последний вариант когда мы честно будем ждать подтверждения от всех реплик сообщение будет записано в лидер потом какая-то реплика его 1 потянет потом подтянет 2 и только тогда продюсер получить подтверждение и вот этот вариант он надежный и он на самом деле самый честный то есть получив подтверждение о записи мы сейчас точно знаем что это сообщение уже доступна на чтение и концу я могут его забирать и вот начала мы говорим здесь один параметр фактор аппликации и оказывается нужно еще где-то там подстроить акс следует сказать что акс это как бы протокольный параметр то есть продюсер с каждым сообщением его отправляется на кластер вот все лет или нужно мне что-то еще в виду на самом деле может получиться ситуации она тоже скорее всего вас будет это происходить когда реплики выходят из строя а я говорил что для того чтобы запись была успешной нужно чтобы все реплики его подтянули ну на самом деле в этом утверждении с небольшой нюанс не совсем все а только те реплики который на данный момент находится в статусе in sink то есть они живые и они успевают затягивать последние сообщения с брокера лидера выражаясь попросту есть конфигурационный параметр у брокера реплика макс лаком с которую по умолчанию равен до 10 секунд и это очень много то есть у каждого брокера реплики есть 10 секунд чтобы затащить последним самое свежее сообщение и если у вас реплика по каким-то причинам выпала из строя то лидер будет ожидать чуть 10 секунд условиях нагруженной боевой системы это очень долго и но у себя мы выставили в секунду повторюсь не рассчитывайте чтоб кафки будут адекватны дефолтное значение и при такой записи при такой ситуации у нас продюсер отправляется общение оно приходит живого лидер лидер всегда msata sensing затем она реплицирует на оставшийся в живых реплику и потом продюсер получает сообщение ну точнее получить подтверждение что все хорошо запись удалось его можно читать все бы неплохо здесь но возможно ситуации когда у вас две реплики выйдут из строя и что будет тогда тогда лидер останется один он будет один списке живых реплик как бы in sink и он будет просто один отправлять подтверждение продюсер фактически мы вернулись ситуацию когда у нас мы тут мы выслали агдс равна единичке как будто мы ждали подтверждены только от лидера очень тонкий момент вот сейчас вас две реплики упали на запись у вас при этом ускориться потому что никакой репликации в этом сейчас не будет лидер будет получать сообщение видеть что других реплик нет и сразу же подавать продюсеру но может случиться вот такая беда что в документ у вас лидером станет плохо причем настолько плохо что он еще и потеряет данные вы наверное частным эти ноты какие там страшилки рассказывать такую жизнь никогда не будет перебрать я была из них все три как-то вылетели вот я вам скажу так и нас такой ситуации столкнулась мы уже первые полугода у нас два брокера находили за одним switch'ем в дата-центре этот switch приказал долго жить и мы потеряли двери я прикину вот соответственно оставшийся в живых брокер честно решил стать лидером на части портится для которых он до этого был репликой и не выдержал нагрузки и прилег совсем прилег и данные там не сильно побились мы очень долго не могли бы запустить и это была очень большая проблема потому что когда мы починили switch и оставшийся реплики вернулись ни одна из них не смогла стать лидером по муж тани статусе out of seeing они знают что они в части данных нет а не буду ждать лидера видео у нас умер раз и навсегда вот и как с такой ситуации быть как с ней бороться ну давай сначала решим как и у не допустить так вот в конфигурации топит есть очень важный параметр который называется мин ен сен креп приказ и обмазывать мина sr для краткости и очень жаль что в документацию никак не выделен большими красными буквами там какой-нибудь разноцветной рамки потому что когда мы поняли как он работает в тот момент мы уже часть данных потеряли у нас уже были аварий сожалению потому что фактически он определяет то число минимальное число реплика статусе интриг выключая лидера которая необходимую для успешной записи грубо говоря если в предыдущем примере мы бы выставили мин ен сена с r значение 2 то в таком раскладе когда у нас две реплики ушли при попытке записать лидер бы отрапортовал ошибкой недостаточное количество реплик живых и мы бы не потеряли данным и просто бы ожидали когда что-то там починиться ситуация такая опять же очень важно вот этот параметр не на с он работает только если вы посылаете акс равный минус 1 ну то есть вы ждете всех реплик если вы акс вы были какой-то другой например сообщение ждите ответа только от лидера то он ничего не произойдет в таком случае не важно какой у вас мина sr стоит до лидера данные дошли вы получите подтверждение все и все таки хорошо инстинкте приказ мы как-то разобрались это уже третий параметр заметьте что делать когда он все-таки waiting a ситуация как у нас когда лежит лидер мы его не можем поднять есть какие-то две реплики статусе out of sync у вас есть 2 варианта вариант 1 это все-таки поднять идет потери данных и тогда чуда не произойдет оставшиеся реплики просто синхронизируется с ним и вы потеряете все данные портится к сожалению в нашем случае вот реально так и получилось мы немножко поторопились и в тучи и лидера и он был с битыми данными был с пустыми партициями мы потеряли данные было очень неприятно был второй вариант ну точнее есть второй вариант рекомендованной вы можете потерять только часть данных которые вот были на лидере но их не было в репликах то есть вы должны зафорсить лидерство у какой-то реплики который был once that out of sync и сделать если вы это сделаете то у вас поднимется пустой лидер синхронизируется с новым лидером вы как-то продолжить работать с частичной потере данных так вот чтоб выбрать в качестве лидера такую вот реплику аутсорсинг вам нужно выставить настолько в топе канут параметр англии лидер election не был в значение true вот немножко об этом параметры смотрите это очень важным параметром и он очень полезен бывает когда он уже что-то починить и вот с версии кафки 20 вы можете у меня динамически то есть просто выставить этом настройках не нужно там ничего больше перезагружать или стартовать все сразу применится но по умолчанию рекомендуется вообще не выставлять вдру оставлять волос без понимания как он работает иначе если он выставлен по утру и вы забыли в минуты фолз у вас спокойно могут быть ситуации когда лидер по каким-то причинам с данными моргнул не знаю на несколько секунд выпал из кластера и у него была replicas to take out of sync то есть без нужных данных и она станет лидером и вы какой-то хвост опять потеряете причем глоба этом никогда не узнаете все произойдет прозрачно и в этом узнаете уже потомка да как нибудь придет и спросит где мои данные и вы узнаете много нового себе я кромки вот поэтому да слова к таму разработчики комки сделали этот параметр по умолчанию волос вот беда была в том что сделали с версии начиная с версии 011 до этого приоритет отдавался в пользу отказоустойчивой тени пользу надежности сделал нет не просто к по пожеланиям трудящихся есть замечательный проект вот кафка empowerment пополз да это фактически предлагаемые улучшение вы даже самим нужно чтоб написать и это очень важный проект потому что смотрите когда у вас начнутся какие-то проблемы с кафкой они вас рано или поздно начнутся вам нужно отыскать решение и далеко не всегда там stack overflow или гугл вам помогут скорее всего куда у вас туда или на redirected так вот в этом проекте разобрана очень много пограничных кейсов там очень много полезной информации включая тот так это всё там внутри работает вы не найдете то в документации более того там есть много ссылок на жил в канун компактную жиру где есть этикете где тоже очень много обсуждений и вам потребуется понимать как кафка работает внутри и вам просто необходимо будет как-то по этому проекту ходить постоянно читать что происходит более того там сейчас есть новые типы о том что будет в следующих версиях это тоже очень хорошо узнавать заранее до того как вы что-то обновить и на продакшн так смотрите вот суммарная сейчас рассказал про пять параметров которые влияют на надежность данных а до этого мы предполагали что нам хватит лишь одного факта репликации вот их 5 и только понимание как работает репликация как идет запись и скажу так умело и конфигурирование вас спасет от потери данных мы теряли данные по трем причинам паттерн уложились первое это отказ оборудования на него очень сложный повлиять второй фактор фактор это человеческий фактор но люди всегда ошибаются от этого вы не за страхуетесь и третье это как раз были не очень безопасные параметры в наших топиков и продюсером и вот на это повлиять можете давайте сделаем выводы во-первых выводы по разделу это еще не конец во-первых внимательность к всем параметрам кафки не только к этим пяти явно задавайте все значения не расчитывайте что по умолчанию будет стоит что-то адекватной вам подходящий во вторых никогда не используйте акс 0 единичка для важных данных вы гарантированно будете их терять и вряд ли об этом узнаете и что из этого факта следует смотрите по умолчанию почти во всех клиентах значения оксана 1 то есть по умолчанию будете ждать подтверждение от лидера если у вас в компании как у нас много разработчиков и все хотят закалкой и все будут писать своих продюсеров кто-то точно возьмет значение по умолчанию получит проблемы и вам с этим придется разбираться гораздо удобнее предоставить какой-то инструмент и оградить ваших потребителей кафки от самостоятельном конфигурирования ну и конечно нужно понимать как работает механизм репликации как работает запись обязательна как это всё устроено внутри а для этого есть проекты тип жира но документацию тоже полезно читать там далеко не все описано и последний вывод обязательно проводить учение и обязательно продакшене вы должны уметь учитывать брокеры и потом все это поднимать назад иначе вы получите в ночь на 1 января такую проблему и будете очень рады всем этим заниматься так мы плавно перешли к такому короткому разил о структуре plaster смотрите вот я вам рассказал про конфигурирования всех этих параметров и допустим если один кластер из трех брокеров а первый наших бластера были на такие как мы можем конфигурировать топике мы можем явно задавать факторы приказ 2 мин sr1 и тогда мы как бы ему доступности тут все нормально в этот момент в любой брокер можете выключить ее записи против не будет остановлено но как мы видели вот мина sr1 не очень хорошо плане надежности окей можно сделать факта репликации 2 именно из r2 тогда с надежностью все хорошо у вас будет всегда две реплики с данными и вы их вряд ли потеряете ну можете потерять на минимизируйте этот риск но тогда у вас все плохо доступностью если хоть один брокер выпадет вы станете не сможете писать пластин а kapkam которую нельзя писать она в большинстве случаев бесполезно и остается третий вариант наиболее подходящий для кластер из трех блоков факта репликации 3 именно sr2 тогда у вас и с надежностью все более-менее ему и запись в из доступности все более-менее хорошо но есть ощущение что при такой конфигурациями как-то не очень рационально используем ресурсы кластер до 3 брокер мы всегда выставляем в акты репликации 3 плюс если например вал сетей брокера то каждый брокер является лидером для какого-то для каких-то партиций если 12 тебя выходит из строя по два остальных блоки они случае если у вас репликации настроена они из реплик превращаются для этих партиций в лидеров и на груз на них возрастает и это может быть очень критично вы потеряете часть производительность в лучшем случае если даже хуже у слушаю вас просто другие брокеры могут выпасть поэтому мы решили что 3 брокеров нам не хватает и стали наших мастерах добавлять брокер и сейчас нос мастера из пяти брокеров печи брокером все гораздо проще у вас гораздо больше свободы для выбора конфигурации вы можете сделать последней строчкой сам атаку про на дальнюю конфигурацию факта репликации 5 мин с e3 потерять данные тут очень сложно ну или можете воспользоваться такой стандарт и подходящий для большинства людей у пользователей в катаре при кации 3 мин sr2 и при этом у вас с доступностью нормально безнадежностью нормально и более-менее как-то у вас сбалансировать свои куска покласть хорошо власти у нас есть конфигурации все примерно понятно полос подстерегает дальше ну во первых у вас всегда будут возникать какие-то рутинные задачи в ренне кластером это добавление удаления брокера мы например уличили кластер с 3 до 5 2 дня дальние топика измени количество партиец изменив акта репликацию топика ну и очень важный такой вопрос это обновление своего власти а то есть обновление по обновления новой версии комки какие тут могут быть нюансы так вот практически все кроме обновления кластер а так или иначе у нас завязаны на перераспределение партиций ну к примеру вот добавили был усталости расстрел брокеров и как-то на нем были партиции распределенных добавили мы 4 брокер чуда не произойдет у вас существующих топиков партиции так и останутся на этих у трех брокер вам нужно как то вот сделать какие то действия чтобы они распределились с удалением выводом брокера есть plaster такая же ситуация нужно руками чтобы распределять ну и в общем-то кафка предлагает с собой инструменты для этого например вот такую учили тору и все с ней будет хорошо она умеет генерировать новый план не и распределение уметь его накатывать и уметь выдавать вам информацию о том как сейчас происходит процесс при распределении мод план рио сайн ап лампе распределения будет примерно так это обычный джейсон файл в которой сын формация какие партиции каких топиков на на какие реплики микки брокеры поинты но у этой утилиты есть очень большие недостатки во первых она не очень удобна работает с фактором репликации если вы захотите увеличивать вам ну практически плюсы руками генерировать плана но что самое важное она не умеет экономить перемещение партиции по брокерам и это очень критично потому что плохой план может привести к деградации кластера очень легко у вас пойдут все партиции и в тот момент вы будете наблюдать катастрофический рост ну можете наблюдать катастрофический рост в этом си и ваш бизнес метрики могут зайти за линию с лэйн это очень не хорошо соответственно какие есть альтернативные инструменты на первых есть туза от я куколка менеджер такая она с визуальным интерфейсом там можно нажимать на кнопочки но она честно это тоже не очень хорошо строить планы перераспределение есть отличная скрипт наруби а дима сам дима спасибо тебе кто-то не был большое потому что это выбор редакции это отличная маленькая утилита которая позволяет вам сгенерировать план экономично и отлично умеет работать с мини факта репликации вот ну и для тех кто живет в java мире а мы в нем не живем есть достаточно мощные утилиты от винта и на но мы их не смотрели но они как бы подписание должен делать все тоже самое так вот как пользуемся мы в мы берем это тут тузлук конкуренция тут генерируем карту генерируем план а потом уже используем скажу так и родные утилиты и все бы здесь было неплохо но если не выставить не выставить значение too tall в какое-то адекватное значение несмотря на не на любой экономный планку и все равно потенциально можете все хватать и остановить этот процесс будет невозможно пока он не сломается либо не закончится успешно всегда обязательно выставляете тротлинг при рассмотрении партиций и так и киева смогут проблемы не оптимальный план это можно контролировать неверный не указанный тротлинг надо указывать что же делать и к сожалению иногда в комки бывают баги вот мы наткнулись на одну из них когда процессе реально просто брокера по доступа interception ну в общем то ничего страшного но упал упал перезагрузим но так как то неприятненько к чести разработчиков кафки на стены быстро его пофиксили все бы хорошо но вам нужно внимательно следить за этими версиями которые у вас на продакшне и что в них происходит что делать если процессы таки сломался но на самом деле тут все просто у нас сломался достать сейчас это почти утиная процедура дал том что когда стартует процессоре assign a в звуке перри я говорил что звуки пир у нас активно используется в кафки есть у создается такая но да вот риос а не против нее нужно просто удалить посмотреть руку мало что все состояние что клада ехала чтоб на не доехала и как-то подкурить и подкорректировать по шутеру план запустить заново в общем-то ничего особенного тут делать не нужно еще такая значит удаление топика и она вообще говоря очень тривиально и если у вас настолько кластера выставлен параметра делить тот миг не был в true тогда вы можете просто все утолить с любой тулой можно даже вот воспользоваться тоже идет в комплекте но зачастую этот параметр выставляет фолз из соображений безопасности например что какой-нибудь нерадивый админ не перепутал продуктовый кластер с дизельным и ничего там не поудалял i buy дизайн в таком случае как бы официально удалять ничего нельзя но если очень хочется то можно ибо даже не используемый топике они все равно генерируют требует ресурсов от класть и так вот вот то что я сейчас вам буду рассказывать и показывать это такое знаете очень безопасный процесс это такой к тёмной стороне силы как бы сказать ответственна за него мы не несём предупреждаю сразу но тем не менее он работает вариант 1 когда мы просто убеждаемся что в топик никто не пишет не читаем и потом до на каждом брокере на живом брокер рабочим удаляем файл с партициями удаляем топик и звуки пера и делаем перезагрузку всех брокер вы знаете ни разу нас не подводил в общем-то даже для нас мне показался очень небезопасно не говоря уже обо у официальных источниках поэтому мы решили все таки удалять вот примерно так то есть мы по-прежнему убеждаемся что топик никем не используется затем переносим поскорее а сами все его против на один брокер а потом действуем по старой схеме при этом когда он все платится и лежат на одном блоке у нас все кластер а его на эту миду настроить так чтобы можно было всегда потушить один брокер без потери производительности мы можем даже спокойного потушить все почистить или стартануть ну примерно так мы сейчас единственный действуем что можно сказать по созданию топика тут-то общем то все тривиально создаете и работайте дальше но есть нюанс те кто еще помнит первый раздел с чего я начинал этом говорил что конфигурация очень важно от неё зависит надежность и вообще к классу это будет жить поэтому если у вас как у нас несколько кластеров с кучей топиков вы никогда не узнаете что там происходит какие там параметры вообще есть особенно если вы предоставляете всем своим разработчикам возможность создавать топики поэтому мы решили сделать такое узнаете единую точку правды единый конфигурационный файл для класть я со всеми настройками топиков то есть каждый пользователь который хочет воспользоваться кафка хочет создать свой топик он ничего в комки не делать он просто заходит этот файл указывать имя топика какие-то основные параметры затем перейти он запускается пищи и скрипт которые подтягивают файл накатывает все изменения и вуаля все готово более того он еще и проверяет что все настройки указаны в файле совпадают с теми которые реально есть на кластер вот казалось бы зачем это все нужно но вот мы запустили такую процедуру где-то уже месяцев через восемь работа с кафкой и мы запустили кружит у вас куча куча просто топиков продакшене неверно те топки которые должны быть кто-то говорим на одинаковы и различаются и это потенциально опять же потеря данных это очень не хорошо мы сразу всю нашли почистили поправили ну и чтобы это все работало опять же повторюсь явно задавайте для каждого вашего топика значение по умолчанию не рассчитывайте что в капкане будут какие-то адекватные повторюсь и буду повторять это же много раз и более того если вы их не зададите то вам нечем будет нечего будет сверять и вот мы переходим к такому важному вопросу как вообще обновления класть обновления по до что здесь может пойти не так и вообще какие тут могут быть вопросы сомнения даже нашей команде у нас был такой дискус надо ли нам обновляться регулярные как часто с одной стороны новой версии новой возможности которые наводят очень классные нужны нас другой стороны но все же работает до о вы работали под стабильной версии нафига обновляться все и так хорошо новой версии зачастую ну почти всегда устранять какие-то ошибки и это классно но зачастую в них бывает новой ошибках убедились когда мы выкатить до мажорной версии и получили ну пойнтер эксепшен перри асане нет никакой гарантии что вы удачно сможете обновиться с версией 011 до версии 4 там 5 когда она когда-нибудь выйдет поэтому конечно регулярное обновление тут лучше но более того у вас в принципе нет особо гарантий даже если вы обновились на ближайшую какую-то мажорную версию точнее так если вы живете в java me и обновляйте всю свою к систему то скорее всего у вас все будет хорошо эти гарантии есть но мы не живем java мире у нас наши клиенты написано других языках использует другие библиотеки у нас был реальный кейс когда мы поторопились обновили версию катки до мажорного релиза который устранял куча багов мы это очень релиза очень ждали и вот момент она сломалась и а наша работа с красивыми группами это было очень печально очень хорошо что в этот момент наша работа с какими группами никак не аффект тела пользователей продукта то есть нападок что никто ничего не заметил ну просто где-то там у разработчиков не доезжали логину подумаешь там пострадал полдня вот им и смотри течение дня обновить все наши клиенты потащить новой библиотеки опять же нам повезло что разработчики библиотеку себя их уже обновили под новую версию ему все быстро починили но потенциально мы могли положить весь класс тебя всю работу на какое-то время я откатываться был бы очень сложно и после этого мы вы бы ты такой алгоритм сначала мы выкладываем ну версию на данными кластер то есть там ничего нет там только запускается теста мы проверяем вообще все ли наш тузы работают скалкой затем мы кладём на наш тестовый стенд где уже работает весь функционал аналогичный production ну ну просто то там тестовый там ну а если жить какую-то карантине ну пускай будет там 14 дней примерно по две недели и в это время мы активно мониторим кип и жира вдруг какие-то проблемы будут найдены и вот если за 14 дней мы у себя ничего не увидели ничего не появилось а теперь уже и все хорошо вот только тогда мы выезжая в продакшен выводы по разделу ну обязательно следите за трафиком при распределении партиции деградации кластер может быть очень критичны единая . правда это хорошо центральные конфиге это замечательно это очень вам поможет миниджек несколько кластеров с кучей топиков очень очень сложно почти невозможно все держать в голове обновляться нужно нужно регулярно но никогда не спешите с этим особенно скалкой и вот мы перешли к последним важным разделом мониторинг и диагностика проблем ну как вы уже поняли мы мониторим конфигурацию топиком ашими говорил до этого естественно мониторим отставания консьюмер группы логично и для консилер глупо нас также есть единый файл конфигурации где перечислены все консьюмер группы для которых мониторим разницу во всех мы мониторим ноги ошибок и но вот тут пару раз нужно сказать смотрите все знают что влоги лучше смотреть при появлении проблем у нас есть как бы механизм я описаны в статье на хабре когда мы у нас все сервисы собирают оставлять свои логе власти ксир есть механизм сертификация me то есть мы можем задать какой-то фильтр его в каждом отдельном окне посмотреть есть ли что-то в этих влогах и нет чего-то например мы всегда можем посмотреть есть ли запас не пять минут какие-то в блогах ошибки казалось бы для чего все это нужно но очень просто мы активно используем кафку не только как для стриминга как еще систему хранения данных и в папке есть так внутренней thread который занимается комп акции с хлопаньем данных неважно как он сейчас работает просто мы заложили что он будет работать и в какой-то момент что-то пошло не так и тот и тот валился и мы об этом как не могли узнать все остальные графики все это все работало все было хорошо в нашей сервисы стали дико тормозить от этого и мы нашли информацию о том что что-то пошло не так только влогах ошибок только там это было поэтому решили ты за мониторить и теперь если с внутренними thread'ами компью что-то случается об этом есть записи влоги мы сразу об этом узнаем и так что нет дальше у нас ну мы конечно же всегда мониторил чтобы все реплики были в статусе in sink обязательно и мониторим перекос на boker что это такое и зачем это нужно смотреть и если вы делали какой-то и assign если у вас какие-то блоки выпадали появлялись заново у вас возможно ситуация когда какой-то брокер является лидером для большого числа партиций например в топике бла 10 партиций и сейчас вас какой-то брокер является идем для восьми из них это большой перекос по нагрузке это очень плохо для производительности всегда больше случае нужно стараться так чтобы нагрузка распределялась по блокером равномерно поэтому это нас здесь за всем этим смотрим ну и последнее так называемые функциональные мониторами смотрите то есть по факту мы мониторим кафку как некий внешний сервис мы создали тестовой топике вот с такими параметрами и у нас есть небольшая утилита которая постоянно пишется параметрам aks.ua ну или -1 в данном топике и мы смотрим всегда время записи честно и время записи в старших мир санте лях ну и соответственно параллельно у нас есть тренд который все это дело читает что проверять лак чтения зачем мы все это делаем поймите мы внедряли кафку не только для того чтобы вышел на сцену и вам все это рассказывал нам нужен был добиться быстрой доставки сообщений почти мгновенной и соответственно даже если у вас всего работает нет никаких ошибок все блогеры живы все авто ту sensing вам нужно чтобы ваш бизнес метрики были в нужном статусе чтоб записи всегда попадала в некий не кислый в некие как бы обещанные или нет и так вот эти все эти все пункты они влияют на губы на зажигание лампочек если что-то идет не так загорается лампочка заварим ответственному человеку он там лезет разбираться что тут происходит так вот куда еще можно смотреть от лампочки горят надо что то делать кафка само по себе отдает очень много метрик через джеймс джалла менеджмент extinction ну повторюсь мы не в java мире нам нужно было использовать плагин gmx агент joe locke это мост между джеймс и http соответственно мы все эти метрики собираемый активных смотрим их там сильно очень много я вот этом страшном слайде перечислил некоторые из них на которые мы реально просматриваем насладитесь на страшный ну ничего страшного всего один вот-вот 1 метре когда network процессором уже idol смотрите по сути дела это важная метрика она практически говорить нам насколько у нас свободно сетевые ресурсы вот чем ее значение больше тем лучше и в какой-то момент вы просто видели что блин нас фактически сетевые трейды в комки заканчиваются систем патентовать больше нагрузки на свободных трейдов не останется просто посмотрели увидели уличили конфигурационный параметров власти увеличили количество тредов предам стало больше как бы сказать проблему мы немножко отодвинули на потом то есть сейчас мы все хорошо помимо дмитрий кафки самих джим x нашей компании используется zabbix для мониторинга там можно ведь очень много параметров сирота серверов параметров цыпочки женщин и awake лот на это все желатин тоже смотреть не просто смотрите как-то реагировать да как а все-таки the persistent на и хранилища на работы с диском поэтому нам очень важно чтобы запись на диск была быстрой и и хороший поскольку у нас к пк одни два человека которая параллельна занимается мистер ним всех наших моя сколь серверов они послу опыту знаю что изменение а я scheduler а для систем х нет данных вместо дефолт ирма севки у на она подает вот такой прирост производители в записи ну и заодно поскольку мы используем половую систему f4 мы выставили параметр дата муравин white back это нам сильно позволило снизить как бы сказать проблемы записи на диск но вот я щас такие вот штуки он показал сделайте вот так вот смотрите такая конфигурация она вообще хорошо подходит для власти не для карточных серверов если у вас на машине какое-то еще сорту склонен какие-то важные сервисы он очень внимательно относитесь к scheduler и как настойка файловой системы потому что сделал хорошо для комки вы можете сделать большие проблемы для каких-то ваших других сервисов и так ну в общем то время мои уже практически стекло давайте подведем некоторые выводы вывод основной кафка это не авто пилотируемый аппарат у вас не получится после запустить и благополучно смотреть как она работает вам всегда придется за ней следить и для надежны записи о нужен быть за куча параметров отважные это акс никогда не выставляйте в ноль единичку и всегда следите за нужным параметрам мин а с централизованная конфигурация это очень хорошо и очень спасет вас если у вас моря топиков и это достаточно дешево сделать обязательно мониторить и все что важно и по возможности мониторим должен быть автоматизируем плюс обязательно проведите учение чтобы проверять загорается у вас вашей лампочки или нет обновляться все-таки вам нужно регулярно потому что действительно многие проблемы уходят после обновления главное следить что мне будет за новых ну и постоянно читайте кипру жил чтобы быть укусив чаще всего чего происходит вот если вы все это сделаете тогда да тогда как она летит на мощное классно и надежная и все у вас будет как в рекламе вот я не сказал еще очень много всего что могло сказать подходить к нам на стенд это мне это все буду рассказывать спасибо всем спасибо круто вопрос один потом еще один потом петербург потом новосибирск а вот если бы эксперты по свету приглушили вот этот фонарь который нам прямо в лицо вот готов а сейчас микрофон должны принести до или беги сюда возьми мой оба смотри бежит тебе человек в красном проход проход проход проход проход проход такого рода проход проход у меня тоже вопрос ай ай ай ладно поехали первый вопрос вот здесь одинец большое спасибо извиняюсь антон ленок программисты сбербанка denis большое спасибо за очень интересный доклад я новичок в мире кафка мне очень интересно в нем и у меня родился вопрос на основе того что вы нам рассказали не рассматривали вы такую ситуацию когда можно было бы использовать 2 кафки например для каких-то важных данных которые бы нам не хотелось потерять и можно было бы выставить настройки окно лишь минус единицу и вторую кафку которая нам бы хотелось ускорить поставить окно лучшее подтверждение только от одного брокера там можно было бы ее побыстрее обновлять можно было бы смотреть есть баги или нет и вообще смотреть как себя ведет сеть я понял ваш вопрос смотрите во первых 0x да это правильно продюсеры они в классе то есть вы можете использовать спокойно один кластер для всего и как-то регулировать зависимости от вашей задачи именно строй кинопродюсер вот ну вообще как бы у нас несколько кластеров катки но как показала практика везде в основном запись должна быть надежной и данные потеряете везде очень критично но повторюсь настройками продюсер все это решается спокойно в одном власти кафка очень хорошо масштабируется и зачастую вам 1 класть а может хватить для решения многих задач и проблем спасибо так вопрос прямо из под сцены еще один потом в санкт петербурга отправимся на две-три yandex вот вы упомянули термин учение очень заинтересовал нельзя ли поподробнее такой термин учение по теме они выглядят то есть а то из против прям выводится switch приходит человек и switch отключает или к вину смотрите ну к сожалению не всегда можно отправить человека дата-центра не у нас иногда далеко находится но дамы по жесткому тушим брокеры именно ну можно в штатном режиме тушить до можно жестком лучше рассмотреть все варианты сначала все это обкатаем на de ville а потому что ну не приятно получить ситуацию когда в на продакшен все потушили и не смогли восстановиться и к этому всего покатали на 9 что дамы как бы теоретически умеем восстанавливаться теоретически мы живем без брокера вот тогда мы обязательно программу чине на продакшене по жесткому тушим ну зачем они тоже потому что обычно свечами много всяких серверов обычным и тушим по жесткому непосредственно брокер вот или там один или два один обязательно как минимум и смотрим разрулим ситуацию это очень важный пункт если вы не умеете с этим работать и вы получите проблему я ответил на ваш вопрос спасибо перед тут yandex не угрожай со сцены из не уметь этим работ так а санкт-петербург мы смотрим на вас на экран denis жгите прямо в микрофон и громко и со больше она становится больше и мы благодарим вас за доклад и задаем вопрос пожалуйста меня зовут михаил во первых спасибо за интересный доклад о вопрос у меня в том на каком железе у вас крутятся брокеры и сколько в среднем портится приходится на каждый брокер узнаете вот и цифрах я варился если хочешь глаза смотреть вот так давайте так я осознанно не делал слайды с каким же с москвой брокеры по память я еще сам этом не скажу но если это интересно можете связаться с нами я вышли всю конфигурацию это не какая-то тайна да просто я об этом не хочу упоминать мне до тот был очень короткий сколько в среднем партиций на блоке рану сложно сказать потому что у нас несколько кластеров есть plaster где там по платится что значит маркете где брокер reader там бывают пану несколько сотен партиций на брокер вот есть кластер где их там несколько десятков ну вот как-то так примерно он порядок назвал искал свяжитесь с вами это куда написать у нас есть как бы сказать пиара дел упаду мот и ну можно задать вопрос или можно найти меня я хотел сказать имя на стенде ну вот на стенде найти не получится что-нибудь придумаем социальные сети вк асоциальная сети по моей фамилии очень легко находится на фейсбуке можно найти меня там лоне на стенде facebook и тут есть м году когда же новосибирск задайте свой вопрос пожалуйста мы смотрим на вас артем привет привет да у нас есть вопрос я передаю слово автору вопроса нам на пожалуйста камеру добрый день ведь вам станцию в дыру большое спасибо за интересный доклад у вопрос мой будет про жуки пир скажите а вот зуб теперь у вас в квартире в ансамбле или как насколько я понимаю если упадет у вас закипит никакого толку от вашего отказоустойчивого кластера комки не будет ну спасибо да вы абсолютно правы закипел нас ну в своем собственном классе у нас там несколько нот звуки пера и так получалось что нам наверно тут везло за все полтора года звуки пивом существенных проблем у нас не было добыли момент когда 1 года выходила из строя но как это быстро чинилось и тут я вам особо ничего тут такого хитрого не не подскажу почему-то нам повезло и ты вас реально не было проблем нас хватал даже трёх нот в кластер звуки пера даже 5 устанавливать по моему не стали то есть у вас три да сейчас пока да если не ошибаюсь у нас три ноты сумки 1 делим к власти дайте закипит использовало столько только под ну только под кафку мы не в java мире нам ты других целей за кибер не нужно новосибирск спасибо большая super tennis отстрелялся у нас для тебя есть памятный приз назвать всех спикеров есть памятный приз сейчас тебе его вынесут с обнимашками и ты должен сказать какой из первых двух вопросов тебе понравился больше о я уже не помню такие первые вопросы были икру чем сами хорошо забирай спасибо большое"
}