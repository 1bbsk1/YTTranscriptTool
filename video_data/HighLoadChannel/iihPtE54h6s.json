{
  "video_id": "iihPtE54h6s",
  "channel": "HighLoadChannel",
  "title": "Как \"добиться\" времени записи 200 мс на NVMe-дисках / Андрей Копейко (VK (Mail.Ru))",
  "views": 111,
  "duration": 1379,
  "published": "2023-10-06T07:20:51-07:00",
  "text": "Добрый день нет речь пойдет не об увеличении а наоборот уменьшение вот там добиться в кавычках она написана не зря Значит вся эта история началась примерно год назад когда знакомые знакомых знакомых пришли с вопросом у нас тормозит Стал тормозить возраст Помогите полечить что тут можно сделать после короткой переписки Выяснилось что они в течение суток собирают в погрешность там куча данных а потом им нужно построить по этим собранным данным какие-то агрегаты статистики суточные недельные месячные то есть нагрузка на этот возраст она и транзакционная она собирается она и аналитическая прошу прощения Ну после того как выяснилось я зал простой вопрос А что говорит ваш мониторинг о том что тормозит и вот примерно то что он в этот момент говорил мониторинга не было Через два дня на Хосте появился мониторинг и стало примерно Понятно причина вот к сожалению здесь Вам наверное Видно плохо Циферки совсем плохо можно будет потом посмотреть это график времени ввода-вывода то что вниз это чтение то что вверх это запись и видно как на базу подается нагрузка и все начинает тормозить Вот первая горизонтальная линия это 100 миллисекунд следующее соответственно 200 миллисекунд Ну что отсюда можно какие сразу сделать выводы во-первых доклад назван неправильно надо было называть Как добиться времени чтения 200 миллисекунд И вот оно достигается время записи 200 миллисекунд это вот может здесь работает но все равно не видно вот этот пик который уходит вверх там тоже получается 200 миллисекунд он не такой продолжительный а как на самом деле должно быть Вот здесь в таблице собраны типичное время записи для различных дисковых устройств видно что там для шпинделя Нет примерно одинаковые в районе 10 секунд а при улучшении технологии получается ускорение в 10 раз типичное время записи на nvme диск технология TLC подключенный по интерфейсу экспресс с четырьмя линиями оно на три порядка лучше чем мы видим на картинке дальше я не буду рассказывать подробности как значит это все расследовалась и выяснилось а Расскажу уже с обратной стороны как вам такую штуку получить вот если вы будете строить конструкцию с нуля это тезисах она там вот прошурке названа Анти доклад это рассказ о том как делать не надо не делайте так вот собственно это 8 кораблей на которые вы будете наступать Там не все на самом деле грабли Но вот 8 шагов успеху каждый при этом значит хочу сказать что каждый из этих шагов в отдельности он абсолютно правильно он логичен он описан в рекомендациях соответствующих вендоров и в большинстве случаев она помогает в реальной жизни но если мы это все совершаем вместе вот Вот в такой последовательности как мы будем идти по этим шагам то результат может Вас мягко говоря разочаровать первый шаг значит простой Мы берем железку довольно мощную железку в кесаре там свежий ryzen 12 ядер сейчас на 24 тренда набиваем ЕЕ памятью и поскольку база у нас значит большая будет нагружена подключаем туда дополнительно интерпраздные в мги дисков честно ли такое возможно это будет вам что-то стоить и первое значит хорошая рекомендация мы на этот диск ставим файлы системы и включаем компрессию потому что нам надо хранить много данных шаг абсолютно логично абсолютно законный а поскольку железка Большая нам нужно сделать много разных дел мы на эту на этот сервис ставим prox Max для того чтобы порезать его на виртуальной машины и все диски этих кв-вертолог мы будем складывать на ZF с пол который мы нарежем на этом диске собираем делаем виртуалки там 5-8 10 штук при этом прокс мозг нас не ограничивает никак не в количестве виртуальных ядер которые мы выделяем этим виртуалкам не в количестве памяти который мы им выделяем в памяти там на самом деле есть ограничение он отслеживает Но вот по ядрам нет 10 машинок там Каждому по 10 ядер чё там жалко что ли каждому подъезде гигабайт и наконец мы строим большую толстую витовку который мы будем ставить собственно основную нашу штуковину опять-таки в этом постгальте мы хотим хранить много данных поэтому мы файловую систему у него форматируем снова в zfs и снова включаем там сжатие все Вполне логично все законно всегда так делалось и все работало дальше в эту большую вертолк Я уже не стал рисовать все подробности накатывается постгры и накатывается Биби это хитрое такое расширение для позга которая делает нужную нам магию магия состоит в том что там скиллди би позволяет хранить данные не просто в таблицах А в гипер таблице он делается за два простых шагом сделаем простую подрисовую таблицу вот здесь таймс темп и два каких-то значения и функциями функция ей там скилл тебе мы творим из нее гипер таблицу гипер таблица устроен на самом деле просто это портифицированная таблица с точки зрения позга это процитированная таблица портицирована по дате как мы попросили и партизация таким образом что вот данные за какое-то число будет сложены в отдельную партийцы при этом там скилл диби делает сам всю магию которая обычно нужна для такого портирования в пострессе нам не надо строить не триггеров которые будут создавать эти партии и относить туда данные при записи большой таблицу нам не надо значит внешне скрипты делать которые нам заранее сделают таблицы там партийцы на неделю вперед он это все сделает самостоятельно удобно же и опять-таки абсолютно законно всегда так работает и мы же хотим хранить в нашей базе данных много данных а поэтому мы средствами Тау Скейл диби включаем на нашей гипер таблицы сжатия делается она двумя командами сначала объявляем что вот в этой таблице Мы хотим сжатия а вторая команда создает capression policy в этом случае делают такую магию он запускает отдельные барнградный воркер и пережимать он будет партийцы то есть чанки в его терминологии только те которые старше от трех дней То есть сегодня вчера позавчера у нас будут храниться в обычных таблицах А все остальные данные будут хранится сжать в таблице сэкономим место на диске данных нам надо много и очень много а как сжатие в томскел устроено Ну документация обещает нам просто райские чудеса сжатие в 20 там 23 раза делается это таким образом вот у нас есть таблица обыкновенная в постгальте там каждая строка хранится в одном тупле И за что после часто ругают пинают это за то что к каждой Каждому кортежу каждому топу он добавляет 28 для хранения своей служебной информации а Times Skill db делает хитро он из нескольких строк исходной таблице делает одну строку сжатой таблицы То есть у нас получается в каждом из атрибутов хранятся массивы каких-то значений и массивов и таких строк он может объединять много вот документация говорили что до тысячи записей стандартной таблицы могут быть объединены в одну строку нашей сжатой таблицы с точки зрения пускгроса это будет выглядеть как оверсайз атрибуты и в погреce есть технология которая умеет с такой штуковиной работать это тосты и тосты как раз в погребе хранятся сжатыми Ну и последний шаг к успеху Мы берем в нашего вот этого тигренка желтенького заливаем 28 терабайт данных они это мы можем их копить в течение жизни системы или залить Не суть важно через какое-то время мы обнаруживаем что у нас на диске на физической машине занято 99 процентов место использовано повторяю это zfs и с компрессией и все Вот мы пришли к успеху вот такой простой вопрос запрос Прошу прощения Дайте нам из нашей таблицы все что происходило за одну неделю он и приводит к тому что график чтения начинает выглядеть вот так график времени обращения к диску при чтении почему так происходит И что там вообще происходит происходит это из-за того что толстый в фосгросе хранятся сжатыми во-первых надо было дорисовать Еще кусочек значит когда мы просим данные за неделю вперед планировщик знает что нам вся таблица не нужна нам нужны только партии которые относятся там к сегодня вчера позавчера и 8 дней назад там могут быть данные за интересующую нас интервал остальные мы смотреть не будем Потому что там Таких данных нет совершенно точно нет партий за сегодня вчера позавчера это обыкновенные партиции с ними работает совершенно нормально довольно быстро а дальше начинается магия толстые как я уже сказал хранятся после сжатыми Поэтому если нам надо получить какое-то значение из этого тоста нам надо весь этот тост прочитать с диска дальше нам надо его сжать и только потом мы можем получить там нужное значение поскольку у нас тайм скилл диби магически объединяет по тысяче строк даже если это таймстеп 64 бит 8 получается сколько 8 мегабайт это много Но мы эти там 8 мегабайт из диска читаем эти 8 мегабайт читаем с zfs файловой системы которые включено сжатие соответственно для того чтобы прочитать эти 8 мегабайт который как-то там побиты по ZF на блокам пример 128 мегабайт нам надо и все прочитать и разжать И после этого можем вернуть после данные но и это еще не все это файловая система виртуалки она сама сидит на ztfs разделе в котором сжатие поэтому мы для того чтобы прочитать там больше 8 допустим 80 половиной мегабайт данных нам надо с физической диска прочитать данных больше там процентов на 10 9 мегабайт допустим и только после этого мы можем работать уже с диском то есть начинаем работать с диском при этом мониторинг нам показывает только лишь вот это вот время то есть сжатие в постггасе оно обрабатывается в userspace мы это видим как нагрузку как позарос значит процессор Ну хорошее дело работает а отдельные проблемы составляет то что сжатие zfs в виртуалке и сжатие zfs в Хосте оно реализовано в ядре Поэтому просто так топ его не видит не показывает Мы заходим на хост там вроде как работает процесс виртуальной машины пожирает процессор Ну нормально он работает мы заходим в него там видим процесс он тоже уже процессор а выжирание процессора на сжатие-разжайте на zfs Мы не видим при этом вот если в эту картинку перерисовать в масштабе то диск будет диском а такой маленькой серенькая палочка он сам по себе быстрый Мы помним что чтение чтение запись на диск это там 20-25 микросекунд ну это если верить спецификации вентера в реальной жизни будет 50 ну 100 микросеку 0 секунды при этом диску самому такая жизнь тоже не нравится если мы посмотрим смарт-ктель то видно что за 7000 часов за 10 месяцев мы уже записали на диск почти четыре петабайта если обратиться к документации вендора у него вообще тебе давал терабайт в ритм диск это 9 без малого 10 терабайт при этом гарантируется срок жизни 5 лет А мы уже за одну десятую от гарантийного срока 16 процентов мы уже записали 40 примерно процентов диск не доживет до конца в своей жизни сдохнет гораздо раньше вот собственно все какие мы отсюда можем сделать вывод во-первых возраст не виноват это не он тормозит это мы его поставили в такую конструкцию в такой ситуации что все вокруг происходит медленно почему оно происходит медленно потому что мы последовательно накручивали рекомендации тех или иных вендоров не задумываясь о том что происходит под капотом Для каких ситуаций эти рекомендации будут правильными инвалидными в каких ситуациях они наоборот могут нам навредить Ну вот как следующий а третий вывод Ну это прям вот таксиома если вы используете zfs сжатиями сажайте не заполняете ее большим 90 процентов у вас начнутся тормоза просто вот Адские тормоза и последний вывод конструкция данная конструкция неперабельная здесь ничем помочь нельзя по итогу она все-таки была переделана немножечко там там были свои проблемы Про некоторые проблемы чистовые я буду наверное рассказывать в апреле на пока конфе приходите будет наверное тоже интересно Вот по этому qr-коду можно там оставить фидбэк по докладу Если я правильно скопировал qr-код это не какой-то общий А если у вас есть вопросы то пишите Андрей Большое спасибо за доклад Очень интересно очень прикольная Матрешка В итоге получилось у нас есть время буквально на один вопрос У меня у меня есть вопрос есть вопрос Спасибо за доклад поскольку мне знакомый прочие вот прослойки Какая версия это зол ZTE Linux в чем два один ноль восемь бунту 2004 lts дефолтные настройки скорее всего это проблема уже решена в zfs 2.1 есть отдельный статья от пост газпро на хаббре о том Почему zfs может портить жизнь после виртуалки Это первый доклад и второе есть мы только из одного из одной ячейки выпрыгнем а там еще за счет того что волк сайз выставляется равным 64 килобайта или 128 КБ об этом есть доклад блог сайт это размер самого вала блок блока хорошо по умолчанию 4 килобайта если выставить 64 или 128 время резко упадет а в этом есть доклады от поздности Ну хорошо игры вокруг Я как раз буду до ПК Конфи рассказывать да супер спасибо Так как у нас всего лишь один вопрос я думаю данному человеку Мы наш подарок отдадим Да Андрей Большое спасибо за выступление за то что поделиться опытом У нас есть для вас небольшой подарочек вот большое вам спасибо"
}