{
  "video_id": "1_55KPHjVTU",
  "channel": "HighLoadChannel",
  "title": "Расширяем и дополняем Kubernetes / Андрей Половов, Иван Михейкин (Флант)",
  "views": 4461,
  "duration": 2909,
  "published": "2019-05-07T13:25:36-07:00",
  "text": "вы смотрите от прыщей дополнение к обернется а меня андрей и последний мизес план там и там собственно мы повидали всякого и в последнее время мы очень плотно занимаемся cabernet сам и хотим поделиться своим опытом в зале сидят пару моих коллег которые мне помогали с этим докладом и в конце я их приглашу на секцию вопросов если надеюсь такие будут и так делал мы живем с вами в очень интересное время и можем видеть как губернатор переворачивать нашу отрасль и меняет подходы к администрирование которые давно устоялись губернатор дал нам замечательной абстракции и теперь мы оперируем не такими понятиями как настройка конфига или запуск команда как это было во времена шефа и ansi бла сейчас мы пользуемся такими абстракциями как группировка контейнеров или сервис или какой-нибудь ещё лот балансер неважно еще благодаря купер нету суммы теперь можем готовить наше приложение не задумываясь о нюансах той или иной инфраструктуры той или иной площадке где-то приложение в будущем будет работать будь то голое железо или облака в амазоне или в гугле тоже неважно мы наконец sq бернетт а сам нам стали как никогда доступна для внедрения лучшей практики организации нфр и я имею ввиду всякие техники масштабирования самовосстановления и прочее отказоустойчивости но если бы все было так гладко я бы здесь не стоял и кубрина то с не мог не создать каких-то своих вызовов с которыми нам пришлось бы иметь дело давайте разберемся о чем речь вот смотрите есть у нас три devops инженеры петя маша и артем и у всех у них в своем какую-то активе есть какие-то свои площадки ну свои серверные какие-то площадки у пятен есть собственное железо у маши есть учетка в амазонии а артем есть только свой ноутбук и все а не для каких-то своих нужд подняли по кластеру губернатор и эти классе ранних замечательно работают но очевидно что эти кластер а у них получились разные почему у всех этих кластеров совершенно разные подхода к организации дисков к организации сети ну и наконец по организации приема клиентского трафика ну и возникает вопрос это что губернатор это какой-то комбайн который умеет все и вся и который умеет учитывать все нюансы всех возможных инфраструктур и на самом деле да но не совсем вот смотрите постирал ребят получились разные но все эти кластер а содержит какой-то свой функционал и если разобраться то окажется что далеко не все эти функции уникальные и есть такие функции которые присутствуют абсолютно в каждом классика именно за эти функции отвечает и друг у брюнета со и действительно если бы cabernet из пытался нравиться всем и решать все проблемы всех пользователей он бы действительно превратился в комбайн но он гарантирует работу только тех функций которые гарантировано есть в каждом кластер и у каждого пользователя и но с другой стороны он дает замечательные возможности для расширения и именно расширение дополнения кубрина это отвечает за все остальные задачи за все задачи пользователей которые какие-то уникальные ну и давайте посмотрим что же нам даёт самбо и друг оберните сам тут все в принципе просто куприн это слеша при деляет базовый набор примитивов например для группировки контейнеров или для управления трафиком и для многого другого если эти термины вам не знакомы или вы хотите просто поближе познакомиться с кубер нету сам то очень рекомендую вам доклад нашего tigger а о нашем опыт низкой брюнет оси скутер на этом и в этом докладе очень подробно разобраны все основу cabernet со и на этом с кедрон закончим и перейдем к дополнением что же это такое и кто за эти дополнения отвечает а за дополнение отвечаем мы с вами это мы должны выбрать настроить и установить в кластер такой набор дополнений чтобы наш кластер обрел нужную вам форму и давайте посмотрим что за эти дополнения бывают на примерах первый пример есть у нас пару нот в кластере и на одной ноте работает пару кодов и если вы не знаете что только под то считайте что это просто контейнер так будет проще для понимания на еще одной ноги у нас работает один под и очевидно что нашим кодом иногда нужно друг другом общаться и не только в рамках одной ноты но и в рамках всего кластер в целом и установив купер notes мы выясняем что сеть то не работает куплен это с никоим образом не гарантирует нам эти связи губерн эта слизь определяет интерфейс для организации сторонних дополнений которые мы с вами должны поставить мы устанавливаем дополнение и это дополнение берет на себя работу по настройке сети в кластере ну собственно это наша задача еще пример иногда нашим приложением нужны диски и очевидно что дисковые решение бывают совершенно разные и так исторически сложилось что все эти реализации этих дисковых решений находится в ядре но с этим на самом деле активно борется и все новые реализации каких-то новых дисковых решений принимает только через специальный интерфейс который называется свисая котором только что владислав рассказал и все те решения которые сейчас уже находятся в ядре полежат там еще какое-то время из соображений совместимости но пройдет время их оттуда вы метут в пользу этого интерфейса еще пример ваше приложение не имеет смысла если вы это приложение не опубликуете в интернете или где-нибудь там где он там надо и на этот счет у каберне тасс есть решение называется ingress контроллер и на опять же поставив кластер мы выясняем что ingress контроллер никак не реализован он только определен и опять же наша задача выбрать какой-то из дополнений поставить кластер и ingress заработает еще пример есть замечательная компания let's encrypt я думаю все вы не знаете благодаря не мы можем бесплатно самое главное автоматически заказывать сертификата для своих доменов и весь же это здорово и удобно иметь такую возможность в своем кластере и на этот счет есть специальные добавления которое решает эту задачу называется сирт менеджер что делает сердце менеджер он определяет свой примитив или кастомный ресурс если хотите и к этому примитивом он дает контроллер который реализует логику общения с лучшим крип там за отвечает за отметили g и как это все работает и как или пользоваться сет менеджер работает где-то там в кластер также в кластере работает наше приложение у которую естественно есть ingresso с какими-то доменом если мы хотим к этому домена заказать сертификат мы создаем все до сертификат который определил сердца менеджер сет менеджер получает об этом сигнал забирает из этого примите вы какие-то свои настройки едет ключик к этому ключи cugini лице сырку и отправляет в центре пт далее он проходит снимок метелин и получают случае успеха готовы к употреблению сертификат остается выкинуть нужный space is respect заработал очень удобно мои любимые дополнение идем дальше есть еще один пример дополнений и это на самом деле не пример просто дополнение какого-то одного это пример целого семейства дополнений и серб менеджер о котором я только что рассказал это частный случай оператора и что же такое оператор в общем смысле оператор определяет примитив или несколько примитивов а может эти примитива вообще не определять еще к этим примите он дает нам контроллер ну или опять же несколько контроллеров и логика которую реализует эти контроллеры на самом деле ничем не ограничены только нашей фантазией и например мы можем завязывать такой контроллер у которого мы можем создав примитив заказать готовый к употреблению кластер база данных то есть мы создаем примитив контроллер это дело замечает и разворачивает готовый кластер то есть он берет все настройки кластер она себя и для нас база в этом случае становится не набором контейнеров и настроек к этим контейнером а всего лишь примитивом обычным обычным рядовым примитивом к которым мы все привыкли и операторов подобных написано огромное множество на данный момент но хотя большинство из этих операторов на данный момент мягко говоря не готовы к продакшеном то эта ситуация рано или поздно изменится эти операторы допилят и мы с удовольствием перейдем на этот самый пресловутый уровень абстракции когда для нас софт станет примитивом они чем-то иным ну еще пример если нас deployment и мы сказали ему создать нам три реплики нашего приложения и все было хорошо до тех пор пока не пришел трафик и нашего приложения на какое-то время природу и чтобы не допустить рецидива что мы сделали мы взяли of those келлер и попросили его если придет снова нагрузка накинуть нам еще одну реплику таким образом нагрузка размажется и сайт будет спасен вроде бы здорово ну вопрос а где of those киллеру взять данные для принятия решений он что должен сам ходить по кластеру их спрашивать и узнавать собирать эти метрики или он должен собрать эти метрики из какого-то источника а из какого может быть из прометея напрямую или исак метра или может быть из data дога может быть он должен ходить в какую-нибудь записку облака который нам предстоит облака простите за он вор ну и на худой конец он что должен zabbix обращаться и как всегда губернатор пошел по своему любимому пути так как вариантов реализации какой то техники много то он не стал изобретать комбайн а сделал следующий он делил он отделил интерфейс от реализации и дал нам интерфейс который называется метрик и 5 а реализацию которая бегает по кластеру собирать метрики и публикует их через метрик сыпей он загрузил на сторонние дополнение собственно выбор как всегда есть еще пример все мы хотим собирать статистику и мониторить наши мастера и тут казалось бы ставим примите стаями графа на вопрос закрыт но как всегда все не так просто и которыми мы должны поставить еще целую кучу дополнений например мы должны поставить keeps it метрик для сбора метрик с объектов кубе мы должны поставить над экспортер для того чтобы собирать метрики с not еще если мы не поставим трикстер который тише руют запросы к прометею то какая-нибудь более-менее серьезные дашбордов графа не уложит наш прометий а так же если вам например интересно хранить метрики долго то вам в этом случае потребуется еще одна инсталляция прометея но уже с меньшим резолюшн и как обычно мало это дело поставить нам еще это надо строить мы должны настроить права для прометея мы должны решить вопрос аутентификации примета системных компонентах ну и наконец у прометея очень много нюансов в конфиге который тоже надо учитывать а также зачем вам про мид и если вы не собираетесь настраивать свой alert а лет это ж надо настраивать графики кастомные наверняка он тоже понадобится потому что стандартного набора нам всегда мало и поэтому я вам сейчас рассказал на примерах какие бывают дополнения и на самом деле это вообще далеко не полный список и дополнение этих существует целая гора например мы для себя в атланте выделяем 29 дополнение которое обязательно ставим в каждый кластер и все эти дополнения в сумме создают каждом классе по 250 объектов куба и если раньше нам для работы хватало одного ingresso когда мы только начинали заниматься кабинет сам-то сейчас мы без этих дополнений не видим жизни без не видим жизни нашего кластер а общем если такая что без дополнений ваш кластер далеко не уедет с этим надо что-то сделать сейчас я вам расскажу ещё пачку примеров но уже из другой области из области автоматизации вот смотрите первый пример есть у нас кластер и в кластер работает наше приложение а ещё у нас есть приватный registry что значит приватную превратно это значит что в нем надо логиниться иначе если мы не залогинимся наши имиджа не смогут скачать и соответственно приложение не будут работать и так и на этот счет куприн it is предполагает что каждому коду должен быть привязан специальный секрет в котором собственно лежат логин и пароль вот registry и наша задача обеспечить нахождение этого ключа мы спейси чтобы под и могли скачивать образом ну и как это вопрос гарантировать в принципе можно раскладывать их руками но приложение может быть 200 штук и ключи иногда надо тоже менять отпадает и тут на самом деле если мы обратимся к коммуне более-менее опытному инженеру и спросим вопрос как нам автоматизировать какой-нибудь рутину в кабинет оси то он ответит популярным ответом старшим последнее время он попросит скажет напишет и оператор и вопрос закрыт и ок и действительно операторы для этого и созданы мы в этом случае в нашем примере например можно написать такой контроллер и оператор который будет ждать события появления на и space of классики и когда это событие произошло он это дело заметит и забросит ключик в нашем space еще пример пусть у нас кластере по умолчанию доступ в интернет и спадов запрещен ну иногда такие это доступно на данном разрешать и хотелось бы чтобы механизм разрешения доступа выглядел как-то попроще чтобы тот кто этим будет пользоваться не не нуждался в каких-то дополнительных знания в каких-то понимание работы полисе и прочего и поэтому давайте условимся что если на экспрессе висит лейбл какой-нибудь определенной то в этом на экспрессе доступ в интернет разрешен как нам это сделать 5 же с помощью оператора пишем контроллер который ждет события появления лейбл н.с. на и спейси и закидывает в этот не space полисе и в результате доступ в интернет открывается ну еще такой же пример аналогичный пусть у нас есть кластер и соглашения что если на ноги висит определенной лейбл с определенным префиксом например то на этой же но я должен быть и аналогичный paint с таким же префиксом и как нам это реализовать опять оператор и получается что написание операторов для решения каких-то задач кластере становится тоже неотъемлемой задачей для самого кластера и вывод опять такой что без этого никуда и давайте подведем итог всего что еще сказал если мы хотим комфортно работать с нашим купил эту сам то нам необходимо решить две потребности это устанавливать дополнения и писать какие-то операторы для решения каких-то повседневных админских задач и давайте сейчас об этом мы поговорим начнем с операторов как нам написать оператор все вроде бы понятно берем описку губернатор изучаемые вспоминаем какой-нибудь язык программирования желательно go потому что для него из специальных фреймворк под это дело ну и собственно пишем контроллер все понятно но выясняется что apes какой пир на этот это достаточно нетривиальная вещь и с ней надо повозиться программирование это тоже не для каждого это надо тоже уметь ну и самый фреймворк тоже содержит какие-то нюансы которые тоже с которыми тоже надо разбираться и в итоге для того чтобы написать контроллер мы должны затратить существенные ресурсы на изучение матчасти и ладно бы если бы мы писали что-то великое например мы бы писали оператор для мы склеили то тут объем работ на изучение матчасти занял бы какой-нибудь не существенную долю всех работ и нам было бы не так обидно но у нас как правило ситуация попроще и задачи у нас тоже попроще и в этом случае объем работ который мы потратили на изучение матчасти окажется существенно больше того объема который мы собственно сделаем полезной работы и в итоге мы попадаем в классическую ситуацию садимся делать решать задачу правильно тратим время время идет задача не решена и мы понимаем что у нас еще куча дел и давайте-ка мы сейчас напишем скриптик а с операторами потом разберемся в общем вопрос решен и получается мы перед дилеммой потратить ресурс и обрести мощный и нативный инструмент для написания операторов или действовать по-старинке но быстро и мы хотим с вами поделиться решением которое стоит между этими двумя крайностями мы хотим предложить решение с помощью которых вы сможете писать свои операторы быстро и называется это решение shell оператор давайте сразу как он работает если нас кластер в классе рис работает где-то пишу без нее никак также нас кластере работы под в котором работает котором лежит бинарник нашего оператора это бинарник нагона пись рядом с этим бинар ником лежит набор хуков о них чуть попозже и шел оператор подписывается на какие-то события cabernet если и когда эти события происходят он запускает соответствующий хук но тут вопрос а на какие такие события подписывается шел оператор и какие хуки он при этом запускает как он понимает какой хук запустить когда какое-то событие произошло а именно эту информацию передает нашему шоу оператору сами хуки и делают они это очень простым механизмом вы смотрите хук это на самом деле обыкновенный скриптик на баше или любой другой язык ютубу можно находить на себя хоть на питоне не важно важно что он должен поддерживать единственный аргумент конфиг и на этот аргумент он должен выплюнуть нам простую g сумку в которой нам скажет какие объекты в интересуют и на какие события этого объекта реагировать вот и все и сейчас мы с вами реализуем один из примеров которых я показал выше и вы поймете что тут нет ничего сложного давайте например растиражируем ключ и поныне по новым на и space он как мы это сделаем давайте начнем написание хука тут все просто сначала мы обрабатываем аргумент конфиг и на этот аргумент мы выплываем простую джейсон qv не пишем что нас интересуют на и space и еще у нас интересуют события создания на и space и получается что нам остается написать логику тут тоже в 2 достаточно простых шага узнаем ушел оператора какой namespace так что был создан и купцы целям в этот на исповедь забрасываем наш секрет вот и все весь кук больше разговоров осталось что сделать и давайте этот хук положим передадим каким-то образом shell оператору как это сделать шел оператор поставляется в виде докер образа и наша задача взять наш куб и закинуть его специальную папочку хупс оставалось потом сбил день до пухнуть вот и готов наш образ этот образ теперь осталось сзади плоть в кластер и для этого надо сделать два достаточно простых шага сначала пишем обыкновенный deployment драку бернеса в котором мы указываем два важных момента первый момент мы указываем наш свежеиспеченный образ который мы только что сделали и второй момент мы так как пишем все таки какой то системную системный компонент и нам как минимум нужны провода для того чтобы подписаться на событий в к вернетесь и а еще нам нужны права для того чтобы раскладывать секреты панаис пей сам и поэтому нам нужны особые права а раз нам нужны особые права то мы указываем особый сервис аккаунт для к вернется ну учетку если проще осталось deployment есть осталось собственно эти права настроить и тут я в детали вдаваться не буду тут достаточно просто но длинна поэтому скажу лишь только следующие вам потребуется создать собственный сервис аккаунт который мы только что указали в deployment и к этому сервису аккаунту создать набор правил далее останется этот набор правил объединить нашем сервис аккаунтом с помощью обыкновенного бенин к собственно ничего сложного и получается что мы решили нашу обычную какую-то рядовую по проблемам нативным образом для кабинета со то есть мы написали целый оператор который решает такую простую задачу но мы можем жить спокойно и быть уверены что в каждом новом на и спейси появится ключ есть еще ряд моментов которые я должен сказать прошел оператор возможно вам не нужны абсолютно все объекты какого-то определенного типа возможно вам нужны только такие обе ты на которых висит какой-то определенный лейбл и shell оператор поддерживает под такой selector и на самом деле его синтаксис очень похож на селектор губернатор то есть мы можем указать так подобный лейбл в лоб или можем использовать мальчик мать expressions об этом поподробнее в документации следующий момент актуален больше для для апдейтов почему допустим у нас есть диплом and a что такое дипломе с точки зрения cabernet со это огромная тусовка который у меня даже на слайд не влезло и на самом деле это же джейсон к живет очень насыщенной жизни у нее тут и там что-то меняется что-то происходит и каждое такое изменение генерит события которые возможно нам не интересны возможно нам интересно наблюдать только за каким-то одним параметром например за количеством реплику тёплыми и на этот случай мы предусмотрели специальный механизм с помощью которых мы можем преобразовать эту огромную g сумку в маленькую рисунку и реагировать на события только те которые происходят в этой маленькой g сумки и теперь то что происходит за кадром нам не интересно но как только что-то тег нет в нашей маленькой g станочке мы на это сразу среагировал еще момент shell оператор на каждый event передает нашему коку информация о том где собственно что произошло и собственно все вам наверное больше не потребуется еще момент события на которые можно подписываться и реагировать вовсе не ограничиваются руками от каберне то спросите ивентами от кабинетов и кстати мы можем подписываться не обязательно на какой-то один тип ивентов одновременно мы можем подписываться на несколько объектов сразу так вот ивенты не ограничиваются ивентами от кубер нет с мы также предусмотрели ивенты который генерит внутренней планировщик кота crontab и опять же таких планировщиков можно указать несколько а также есть один хук один ивент который происходит единственный раз в момент жизни кода в котором работает shell оператор это он стартап и мы на него тоже можем подписаться ну и напоследок мы можем эти никто нам не запрещает все эти винты которые только что перечислил как-то комбинировать и указывать несколько ивентов на один хук еще важный момент шел оператор работает и синхронно что это значит это значит что с момента как в губернаторы что-то произошло и сгенерил события до момента как это событие поступила на обработку fuck может пройти очень много времени и например мы подписались на создание объекта и пока мы реагировали этот объект уже кем-то был удален и соответственно этот момент надо учитывать в наших руках ещё один важный момент что если наш экзекутор выполнит хук и получит ошибку то он будет ее ретро и до тех пор пока не получится access либо мы можем попросить его об обратном ну и напоследок шел оператор exported метрики для примет то и тут все просто с их помощью вы можете понять работает ли ваш шел оператор в принципе вы можете понять количество ошибок которые прошли на каждый хук а также так как он работает и синхронно значит у него есть какая-то очередь и вы можете размер этой очереди узнать с помощью и экспорта метрик вот и все моменты и как итог мы вам предложили решение для автоматизации каких-то рутинных задач причем автоматизация нативным для кабинета со способом а именно написанием операторов и этот чел оператор на самом деле берет на себя львиную часть по изучению мать части и позволяет сосредоточиться только на написание логике которые нам нужно и надеюсь это решение вам будет полезным и так с операторами вроде бы разобрались но я все равно подведу небольшой итог для того чтобы решать вопросы автоматизации мы можем у нас есть выбор например мы можем никак не автоматизировать это то что нам надо автоматизировать например мы можем что-то раскладывать руками если нам надо иногда это работает крон скрипте ки это тоже рабочий вариант и мы закроем скрипте ки никого не осуждаем они работают но лучше такие решать вопросы автоматизации нативным для губернаторов способом а именно написанием операторов и сшил оператор поможет вам сделать это просто и как они конечно если вы пишете какой-то великий великий оператор то лучше наверное использовать фреймворк тут уже вам решать и если с операторами мы разобрались то давайте перейдем к установке дополнений и расскажу я вам этот момент про например на нашем примере на примере того как мы шли к нормальному решению которым пользуемся сейчас итак когда мы только начинали заниматься cabernet сам у нас на обслуживание было там пара кластеров и мы для себя никаких других дополнений кроме ingress контролера особо не выделяли не обращали на них внимание а почему мы на игре с контроллера внимание обращали да потому что в каждый разный кластер его надо ставить по-разному и для того чтобы как то этот вопрос упростить мы сделали несколько я бликов один для головы железо один для около для веса ну и все кластеров у нас еще мал и шло время привыкла стира прибывали на наше обслуживание и соответственно в нашей коллекции прибывали все новые облики а также мы активно начали тюнить ingress контроль как и под какие-то свои нужды и получилось что на кластер а под нашим управлением стали разнородными то есть где-то у нас актуальный ingress где-то не пропатченный где-то совсем старый и нам это дело надоело и мы поняли что как-то надо это дело все приводить в порядок и начать решили с малого как минимум мы просто написали скриптик который который принимал аргументом тип кластеров которые мы хотим за тепло и ца и рендерил нужная малик сам и вы катал его в куб вот и на самом деле с этим скриптом началась эпоха наведение порядка с установкой дополнений и мы начали собирать опыт для того чтобы сделать это решено решить этот вопрос нормально и первый момент который мы положили в копилку свою опыта что нам нужен какой-то шаблонизатор нам же нужно земли кирин дарить и поэтому без шаблонизатора нам будет тяжело на тот момент мы заморачиваться не стали и рендере люси диком шло время кластеров все больше они все еще разные и мы поняли что без автообновления мы далеко не уедем и мы опять же решили вопрос в лоб положили скриптик в git и по кончику его пулим и запускаем тут все просто опять же идет время и мы поняли что мы хотим такой же скриптик но уже для прометея и с прометеем получилась такая ситуация что ему нужно гораздо больше данных для него нужно ответить на гораздо большее количество вопросов чтобы этот прометей установить и мы для себя поняли что чтобы этот скриптик что эти данные которые мы один раз мы увели надо где-то хранить и лучше где-то централизовано да еще и в кластер и и для себя мы этот вопрос никак не решили на самом деле мы при повторном запуске просто бегали по кластеру и по объектам выдирали данные которые нам нужны но для себя отметили что централизованное хранилище какой-то настроек нам таки нужно а еще мы поняли что вовсе есть такие параметры которые не обязательно спрашивать у пользователей мы их например можем верить на лету я имею например мы можем генерить пароли тоже момент еще момент шло время и нам стало страшно за наша система обновлений кластеров много и риск выкатить какую-нибудь login на все кластера растет не по не по годам значит и что мы сделали мы поняли что нам нужно как-то среагировать наши инсталляторы и мы сделали просто мы завели несколько веток и в гите и настроили кранчик на разные кончики на разные ветки то есть какие-то кластеров на столе стабильными какие-то кластер а у нас остались тесты ну и напоследок через какое-то время мы поняли что нам доставить для это очень много боли выход с помощью крепится теплая почему потому что он не до конца декоративен что это значит это значит что он умеет то как создавать объектов cabernet оси но не умеет принимать решения и удалять эти объекты и поэтому нам он не совсем подходит но в тот момент наши скрипты просто обросли удалением каких-то старых ненужных более никому объектов но скрипт из такие образцы и наконец у нас родилось два уродца которые таким или иным образом как-то решали наши проблемы но мы все равно очень любим благодаря ним мы собрали необходимый опыт для для поднятия какого-то нормального решения а еще было несколько моментов которые мы в принципе даже костылев не стали например мы поняли что мы толком никак не контролируем процесс обновления кластеров то есть да мы получали какие-то alert если где-то обновляешь конгресса упала но мы например никак не мониторили ситуацию когда кто-нибудь закомментировал крон на как он кластер то есть мы об этом никак не знали еще момент опять же есть такие параметры которые не обязательно спрашивайте пользователей и например случае ingress и мы можем сами спросить у кластер а как на какой площадке он работает зачем нам это спрашивать у пользователя каждый раз ну и например с прометеем нам опять же не обязательно спрашивать у пользователя сколько ресурсов нужно для работы прометея мы можем посчитать их на основе количества метрик которые нужны пользователю тут просто прикинуть и получается что процесс discovery настроек автоматически нам тоже пригодится ну наконец если есть discovery то пригодится и continues discovered что это значит например у нас есть кластер есть ingress контроллер которому если не сказано обратного он выкатиться на все ноды в пластике и например мы хотим чтобы в ситуации если у нас появилась выделенная но до в кластере ingress сам как-то это понял и перри выкатился с новыми условиями это называется континиус discovery и так мы накопили багаж опыта и такие начали делать решение как она выглядит берем шел оператор берем пачку хуков и эти хуки как и раньше реагирует на событие в кабинет оси и запускаются к этим хуком мы добавляем хранилища в и льюс а также к хукам мы добавляем фильм чертик и создаем компонент который следит за хранилищем в и льюс и если там что-то меняется он это дело замечает и просит фильм перри выкатить наш чарт и получается что теперь мы можем среагировать на событие в кабинет оси запустить хук из этого хука внести какие-то изменения в хранилище и наш контроль компонент это дело заметят и попросит him перри вы хоть и чарт вот такая схема и на этой схеме мы выделяем два компонента набор хуков и херачь артик и называем это модулем и модулей может быть несколько к этим модулем мы добавляем еще понятие глобальных хуков к этим глобальным хуком мы добавляем глобальное хранилище вылез и еще компонент который за этим глобальным хранилищем следит и теперь когда в куприн если что-то происходит мы можем на это отреагировать с помощью глобального хука и изменить что-то в глобальном хранилище наш компонент это заметит и инициирует выход всех моделей в кластере вот так вот вот вся схема и получается что эта схема удовлетворяет всем тем требованиям о которых я чувствую что рассказал что за шаблонизация из-за декларативность отвечает фильм он и шаблонизатор он и сделать декларативный выход вопрос автообновления мы решили следующим образом мы написали глобальный хук который по расписанию ходят в ridgid re и если видит там новый образ нашей системы то перри выкатывает весь рту перекаты всю систему целиком то есть сам себя перекатывает вопрос хранения настроек кластере мы решили конфиг мамам в которой сложили первичные данные для наших хранилищ и при старте мы эти данные подгружаем в наше хранилище вопрос генерации паролей discovery и continues discovery мы решили с помощью хуков и они с этим прекрасно справляются стыд жирование решил и само собой благодаря тегом который поддерживает докер из коробки ну и за контроль результата мы загрузили на выгрузка метрик аналогичный шел оператору мы выгружаем метрики благодаря которым мы можем понять выкатился наш модуль сколько там произошло ошибок и так далее и самое главное теперь мы взяли все эти компоненты которые вы видите на схеме и объединили в единственный бинарный который называется аддон оператор и схема теперь выглядит немножко проще и на этой схеме мы можем выделить один главный компонент это набор модулей до теперь мы можем не потратить немного усилий и написать какой то модуль для дополнения и быть уверенным что это дополнение будет установлена в каждый ваш кластер будет обновляться само собой и реагировать на какие-то события в кластер и и подстраиваться под эти события мы этим дополнением мы этой системы мы этим решением пользуясь и больше и более чем в 70 своих бластеров и на данный момент мы опубликовали только альфа-версию на хабре в понедельник мы планируем сделать анонс и зарелизить уже настоящую бету итак мы с вами на примерах показали какие было что такое операторы и почему вам возможно понадобится их писать и также предложили ряд решений в том числе и свои разработки также мы простите рано также мы поделились с вами опытом по установки дополнений и надеюсь этот опыт помог вам разобраться какие могут быть проблемы с установки дополнений и какие решения могут быть в этих проблем но опять же я свой я вам рассказывал только про процесс установки дополнений и тут может возникнуть вопрос а где собственно взять модули и да у нас есть внутренняя коллекция модулей который мы пользуемся сами и да мы понимаем что шел оператор это всего лишь инструмент и база моделей в нем особого смысла нет но с другой стороны без sl оператора мы считаем невозможно управлять дополнениями удобно и собирать какую-то в меняю коллекцию своих дополнений и да мы хотим и планируем опубликовать свою библиотеку дополнение но это будет следующий шаг который мы сделаем летом а сейчас я хочу вас поблагодарить за внимание хочу извиниться за стойкой такой объем информации и попрошу ой господи и попрошу не забывать ставить звездочки на гитхабе мы их очень любим мы очень много сил и труда вкладываем в эти решения и каждый звездочка для нас этот бальзам соответственно прошу своих коллег подняться на сцену они мне помогут ответить на ваши вопросы это ваня он автор половины софта который я только что озвучил андрей внес наибольший вклад в нашу внутреннюю коллекцию моделей спасибо микрофоном у нас на вас не хватит поэтому вам один отдам вы разберетесь спасибо за секунду до спасибо за участие в первом петербургском хайло де сейчас сейчас одарим людей или по потом давайте сейчас да вот вопросы пока готовится большое спасибо за участие и первый вопрос был вот отсюда андрей спасибо за доклад чувствуется у вас очень большой опыт я как человек из продуктовые команды и и devops хочу задать такой вопрос вот вам троим с большим опытом скажите если есть советы как нужно делать то есть советы как не нужно делать а именно если граница до которой не стоит начинать работать к оберните сам и если есть то где она расположена какие критерии не знаю наличие кого-то какие-то человека который будет заниматься оберните сам или какой человека часов свободная то есть где границы находится когда стоит впрягаться когда нужно использовать изоленту порода кладов назад выступали ребят из amazon и они мысли сказали что они поощряют попытки не удар которые не удались бизнес не поощряет эти попытки в этом проблемы соответственно надо пробовать даже и скорее всего зайдёт то есть это подходит для любой командой неважно размер там мне трудно представить ситуацию где бы к брюнету для каких-то задач не подошел и не очень понятно что за команда и чем они занимаются хорошо тогда это в кулуарах я так давай . крутую очень строгий образ здравствуйте спасибо большое за доклад мне тут такой вопрос просто мне кажется что пилить и целый модуль который вы будет закидывать в namespace секреты для registry это полный overkill не проще ли будет просто например закидывать сами секреты используя систему сияй то есть у нас кого получается в кибернетику же допустим есть нам space у нас там есть deployment и и они же там как-то появились то есть они наверно появились использовали систему сиай и раз уже мы как бы туда закинули дипломат cersei не можем и тут же решил закинуть уже секрет это по моему будет намного выгоднее по времени чем писать все свои модуль я понял вопрос и на самом деле его предусмотрел и в одной из версий доклада я объяснял еще и эту возможность да но тут надо понимать что пример у меня синтетически и он лишь иллюстрирует возможные проблемы с которым может столкнуться но опять же если у вас 200 приложений и вы деплоить и вместе с каждым приложением ключ от registry то в момент когда вам придется это ключ поменять он придется сделать 200 комментов ваши приложения чтобы поменять ключ то есть это тоже не очень удобно и вопрос такой спорный поливаный андрей стас компания reyvel я знаю вас большой опыт работы с сетями и я столкнулся с такой проблемой что я не могу в кубер найти за деплоить приложение которому требуется динамически открывать и закрывать порты допустим что-то работающая по выбор тисе или что-то работают связанная с телефонией это физически невозможно архитектурный невозможно в рамках кубер notice кластер и решали ли вы такие проблемы и каким образом я могу посоветовать только вкусный торт так я решил но то есть у вас не было опыта бог миловал спасибо не пришлось здравствуйте спасибо за доклад скажите вот есть какие там скажем так границы что ли но такие очевидные когда ваше решение shell оператор недостаточно для того чтобы решить задачу нужно начинать изучать там опять каберне тесто есть какие-то прям известные вещи которые не реализованы не планируется и я могу 1 2 до меня слышно решение на полноценном языке программирования на том же голос библиотекой с полноценным юнит тестированием к сожалению у нас не все модули покрытые эту и тестом июня тестами лучше использовать какое-то монолитное решение какой-то язык с какой-то конкретной библиотекой когда у вас есть программисты вас есть конкретный кейс которую можете полностью описать тестами вот тогда лучше использовать вариант с оператором это еще раз что-то среднее между костылем и чем-то хорошим мы не претендуем на всеядность могу добавить что но иногда понятно нашел скрипте да то есть ваши я там парочка команд запустила как задачку решил и дальше вот это вот кусочек шел скрипта я хочу показать там другим командам например сказать вот ребят смотрите раздел и просто пишется хук и все понимают как это начинает работать то есть это не решение каких-то как говорил андрей великих вещей типа майского или оператор там кафка оператор вот быстро пойти что-то сделать и растиражировать другие кластером вот для этого спасибо большое вопрос на это видимо кончились большое спасибо за доклад и ответы обращение в как будете лучше вопрошающего выбирать голосовать господи по-моему самый близкий к теме доклада был вопрос про границу между написанием нативного оператора но полноценного или использования оператор по моему простить ребят я возьму этот выбран себе мужчина заслуживаешь мужчины с бородой сахарным отличие"
}