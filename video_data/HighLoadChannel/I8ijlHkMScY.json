{
  "video_id": "I8ijlHkMScY",
  "channel": "HighLoadChannel",
  "title": "Изобретая синхронную репликацию / Владислав Шпилевой (Ubisoft)",
  "views": 933,
  "duration": 3151,
  "published": "2021-10-04T02:47:02-07:00",
  "text": "гутен таг меня зовут владислав я работаю вообще full time baby soft еще чуть-чуть и работаю в страну ли сегодня буду рассказывать про синхронную репликацию tarantul доклад пойдет по следующему плану сначала я расскажу что такое репликация затем поведаю историю ее развитие в tarantul и после чего покажу как работает алгоритм ровд как по нему работают синхронные транзакции как выглядит интерфейс для работы с ними чем это отличается от ровд и какие будут планы на развитие синхронной репликации долгожданный в тарантула репликация эта технология которая позволяет поддерживать актуальную копию данных сразу на нескольких инстанциях и зовут эту группу рипли кассет обычно один dance выделяют как главный его зовут мастер остальных зовут репликами и он принимает этот мастер все транзакции иногда все чтения и бывают еще мастер мастер репликация когда много эстонцев могут одновременно применять транзакции нужно репликация для многих задач в том числе для поддержки какой-то резервные заначки данных с которой можно было бы новых новых мастеров или новой реплики поднимать и для балансировки запросов по всем инстанциям чтения транзакции если до multimaster и все все эти задачи они делятся еще на два типа репликации синхронной и асинхронной а а синхронная репликация это когда для коммента транзакции достаточно чтобы она попала в локальный журнал с его создателя мастере и выглядит ее жизненный цикл так она появляется на мастере после этого записываются в его журнал на диск после этого сразу комитета ее изменения становятся видны клиент который и создал он отпускается уходит все у него типа нормально и где-то попозже начинается репликация на реплики его падает от транзакции в журналы реплик здесь есть проблема не всегда очевидно что если между шагами 35 мастер и stance откажет то транзакция будет просто потеряно уже после коми tab a100 к клиенту и увидел то есть потерянные данные показываю пример есть клиент банка он кладет деньги в банкомат и это превращается в транзакцию на мастере она записывается в его журнал на диск после этого она комитета клиент видит на экране банкомата сообщение что счет пополнен и тем временем начинается репликация теперь я мастер instance был внезапно уничтожен полностью в радиоактивный пепел от него ничего не осталось вместо него был выбран мастером 2 instance на нём этой транзакции нет теперь клиент на банкомате нажала кнопочку спросил сколько у него денег и он получит удивительный ответ что банкомат деньги сожрал и ничего у него жутко него больше нет денег значится даже если эту проблему попробовать решить как будто этого мало есть еще одна проблема называется грязные чтения грязное чтения тогда когда запрос выполняющие на чтение способен видеть данные которых транзакции создавшие эти данные еще не закончились то есть незаконченное данные может видеть и это приводит к богам это появляется если вы пытаетесь предыдущую проблему сами решить у себя в приложении и может приводить и так интересно богам типа вот такого клиент кладет деньги через мобильное приложение на свой счет это превращается в транзакцию пишется в журнал теперь он ждет репликацию вот я все сделал в коде приложения что он будет ждать он не будет отпускаться сразу но изменение то на мастере уже видны репликация пока что не работает поэтому вот они сидят ждут их ленту стал ждать он пошел совершил покупку покупка пройдет потому что баланс на мастере у него уже виден новый это клиенту вы еще самый не видит это превращается в транзакцию которую тоже попадает журнал тоже ждет репликацию теперь пополнение счета с тайма училась она откатилась откат это тоже транзакция которая вернет его счет к состоянию дополнения и теперь репликация заработала снятие денег и откат обратно сработали и клиент совершил покупку в 3 раза дешевле чем она реально стоит я-то уж плохо если вот только я не этот клиент синхронную репликацию рыб проблемы должна решить тем что в ней репликация гарантируется до того как камень произойдет изменение станут видны только после того как она разведется на реплики и жизненный цикл транзакции меняется до такого она появляется на мастере пишется в его журнал на диск после этого реплицируются после этого пишется в журналы некоторого количества реплик после этого уже commit ответ клиенту клиент отпускаем все работает и вот это некоторое количество реплик она называется кворум синхронной репликации обычно его берут как половина реплика set a + 1 минимальное большинство и это называется канонический кворум который именно такой из-за того что синхронная репликация она очень тесно связано с выборами лидера где очень критично чтобы решение принимал и большинство в кластере так эти алгоритмы устроены и отсюда пошло пошел вот этот вот минимальный карл половина + 1 но вообще его можно и больше ставить в таранку ли можно 90 процентов сто процентов гарантии будут расти и хотя к месяца будет медленнее как это почти нет проблем с потерей денег клиент кладет деньги банкомат пополняется счет на мастере транзакция пишет журнал но пока еще ее не видно теперь она реплицируется пишется журнал реплики все еще ее не видно теперь крепли к отвечает мастеру подтверждения что она журнал свой записала эту транзакцию мастер видит что реплика это подтвердила и пишет журнал специальную запись commit которая транзакцию отпустит ее изменение станут видны клиент уже теперь видит сообщение на экране банкомата что все нормально и только теперь вот этот еще факт коми то он реплицируется на реплику асинхронную но алгоритм он так устроен что даже если факт коми то потеряется низ реплицируется почему-то то все равно транзакция данные короче выживут алгоритм это умеет переживать теперь если мастер инсцес будет уничтожен и будет выбрана новым мастером вот этот второй in 100 на 100 клиент запросит свой баланс получит ответ который он должен получить ожидаемый что счет пополнен почему не использовать синхронную репликацию всегда если она такая замечательная все данные сохраняет гораздо лучше потому что у неё ещё есть куча проблем во первых она медленнее очевидно потому что для комета транзакции теперь нам надо ждать пока она по сети куда-то сходят это плюс миллисекунды во вторых легче сломать кластер до состояния только чтение потому что даже если мастер живой он может не быть не способен к метить новые транзакции если в кворуме реплик не хватает то есть его можно будет только читать в третьих трудней конфигурировать потому что это просто более сложный алгоритм нужно понимать что этот кворум значит каким его надо выбрать разные другие опции появляются в четвертых нет поддержки мастер мастер асинхронной репликации на уровне алгоритма по крайней мере того который в tarantul и используются вообще мне неизвестны алгоритма который мастер мастер синхронные умеют но зато взамен мы повышаем получаем повышенную надежность хранения данных их просто становится сложнее потерять после commit и это может перечеркнуть вот эти минусы для каких-то применений придумывать с нуля эти алгоритм асинхронной репликации не требуется они уже есть вполне себе существующие почти что прям стандартные уже и доказанные везде опробованный много реализации куча пейпер of panic не по нем есть которые показывают как они там хороши или плохи стран туре используются конкретно ровд потому что он самый простой всех который есть и очень легко понять очень легко релиза относительно легко реализовать но прежде чем я перейду к тому как вода реализован я расскажу историю как вообще до него дошли в tarantul и началось в пятнадцатом году тогда считали в тарантулы синхронная репликация еще не очень-то и нужно и занимались какими-то другими задачами поважней а потом постепенно стало очевидно что на самом деле она нужна в некоторых местах без нее очень тяжело обходите ее на уровне приложения повышается стоимость ошибки стоимость разработки и в некоторые места просто гораздо сложнее становится зайти чем-то сложнее чем просто кэш перед другой базы данных например куда-нибудь банкинг и тогда решили что надо боюсь делать поставили одного человека и и всю запереть в одиночку он ее не запилил и вообще уволился и не доделал и это было еще до меня тогда решили что надо бы эту задачу побить на кусочки которые мы могли бы делать параллельно по чуть-чуть маленькими шажками и появился план на вообще там было очень много задач ну я перечислю основные самые крупные и порядок тут совершенно случайный не в том порядке они появились порядок на самом деле в текст просто вот так будет идти сейчас вниз мне так понравилось первое нужно было реализовать модулем и нужно было это для того что в raw те он прав то он состоит из двух частей независимых выбора лидеры синхронная репликация и если очень постараться то можно из выборов лидеры вы говорите что третью компоненту которая отвечала бы за обнаружение отказа старого лидера она будет говорила пора начать новые выборы то есть по сути мониторинг такой он говорит какие узлы доступны какие нет и swim очень хорошо эту задачу решает и еще разные другие задачи решили вот мы его сделаем ее синхро его запихнем следующие решили что надо сделать ручные выборы лидеры это такая функция бокс стиль про mode который у зовешь на любом инстансе он становится лидером старого лидера вырубает остальных делает всех репликами я не про но его лидеры знают думали что самое сложное в синхронной репликации это автоматизировать выбор лидеры что из них сделаем ручными то мы решим часть задачи какую-то простую далее нужно было сделать огромное количество маленьких и не совсем маленьких задач по оптимизации репликации какими-то функциональным доработкам без которых ровд считалось что у нас чувствовать не может они типа были блогерами и еще нужно было реализовать модуль автоматического проектирования потому что враг те говорится что если запрос пришел читающий или транзакция на реплику ты его надо перенаправить на на лидера реплики сами ничего вообще делать не могут и вот мы думали что мы сделаем этот прокси поднимем его на каждом тарантула и он че все запросы будут через него проходить и он либо будет предприниматель принят применять их локально если это лидер либо перенаправлять прозрачно для пользователя на настоящего лидера и завершится это должно было реализацией синхронности транзакции на уровне журнала и автоматизации уже сделанных выборов лидера то есть ну ровд завершался этим в пятнадцатом году этот список создали и постепенно пополнялась внутри года он никакой не разгребал вся команда занималась другими вещами типа разработки es que el дискового движка винил шарден гам и они в принципе тоже полезны но вот синхронная репликация стояла и в восемнадцатом году появились ресурсы начали делать бог статей про mode его даже как-то сделали появился патч ну куда него никуда не вошел потому что довольно быстро выяснилось что чтобы его сделать корректно нужно сделать почти весь рост то есть он тянет за собой ну вообще все его делать отдельно стало бессмысленно пусть это было не под задача это был почти целиком ровд и он в итоге ничем не кончился на тот момент после этого параллельно с этим делались дело с реализации модуля проектирования он сделался тоже был патч но после этого процессе review выяснилось что к нему есть много вопросов технических поведенческих к интерфейсу как его поставлять отдельный модуль не отдельный как в нем должна работать авторизации вопросов было так много что модуль просто ничем не кончился он как-то и не завалился и протух в конце восемнадцатого года начали делать разработку модулю swim и за год и и завершили он вошел в релиз как публичный интерфейс который могут любые другие приложения пользовательские доказательства его применять и у меня даже есть доклад отдельный зачем можно его потом посчитать но конкретно для репликации им оказался как-то не очень полезен в самом начале он по сути ничем не помог и приблизил синхронно не как его туда потом можно будет запихнуть наверное но сейчас он так тогда он вообще ничем не помогал оказалось что можно было его и не делать параллельно с этим весь этот срок делались разные мелкие мелкие подзадачи по репликации по подсистемам тарантула которые должны были упростить ровд приблизить его как-то одна из этих вещей вообще казалось вредное и решили не делать и закончилось это как-то так вот тем что по-моему это тоже ничем репликацию никак не не синхронную репликацию никак не приблизило это можно было на самом деле это и не делать какую-то в перспективе потом видно стало тогда же велась разработка синхронности транзакции на уровне журнала человек который я делала сделал ее почему-то не прав ту там были баги в реализации человек команду покинул за ним ушел еще один сильный разработчик и потом нас вообще покинул citigo который был автором больше большей части вот этих всех задач и прогресс асинхронной репликации к 0 и вот бросился почти и тогда сменилось руководство вместе с со сменой подхода к разработке что давайте мы не будем пытаться делать сразу это все идеально мы сделаем mvp минимально рабочую версию которым будем развивать но мы вниз фиксируем публичный интерфейс чтобы пользователи его могли сразу использовать и развиваться обновляться как бы прозрачно на какую-то новую функциональность баг фиксы и прочее и тогда за несколько месяцев получилось сделать и синхронную репликацию и выбора лидера в одном из релизов тарантула летних и чтобы понять как он там реализован нужно немножко знать алгоритм ровд я попробую очень быстро и очень рассказать кратко и по части синхронной репликации чуть-чуть про выборы в росте каждый instance может иметь одну из трех ролей это лидер кандидат или реплика лидер и таинственно с 1-го реплика сети который принимает все транзакции все чтения и отправляют изменение реплика реплики это все остальные инстанции которые из лидеров все скачивают на него все перенаправляют и следят за его так сказать здоровьем если лидер стал недоступен то реплики превращаются в кандидаты уже пытаются стать лидером сами изначально все инстанции являются репликами когда кластер только зовут стропил ся или когда in sri стартуют они тоже сбрасываются до реплики а все время жизни кластер она делится на термы это такие пронумерованные промежутки времени что-то вроде логических часов этот терн внутри которых происходит выбор и и внутри которых работают транзакции помещаются этими термами и каждый instance номер термо свой номер термо хранит индивидуальные они оба мп и когда видишь что лидера нет надо начать новые выборы или когда видит у кого-то другого терм побольше чем свой и используется этот терм чтобы старые в основном чтобы старые сообщение из прошлых термов игнорировать из каких-то старых и не закончившихся выборов изначально вот они все реплики видят что лидера долго нет и они начинают становиться кандидатами становятся они не одновременно уж если они все одновременно станут кандидатами они станут пиратами проголосуют за себя и никто не победит там есть некий элемент рандомизации чтоб от этого защититься поэтому один instance или два они обычно раньше прочих просыпаются становятся кандидатами голосуют за себя собирают голоса кто большинство соберет становится лидером теперь он способен принимать транзакции в этом своем новом терме он их реплицирует собирает подтверждение от реплик когда он собирает кворум он делает commit этой транзакции отвечает клиенту изменение становятся видны остальных до гоняемся синхронно как-то позже главное было кворум собрать и синхронность транзакции здесь гарантируется за счет 4 этапного от камина во-первых транзакция попадает журнал лидеры потом она попадает журнала реплик потом происходит commit в журнал лидер и потом комедийного реплик и ровд и так устроен что на любом шаге отказ любого инстанса он не приведет к потере уже законченных данных покажи его больше половины кластера в том числе в ровд этого добивается за счет того что накладывает ограничения и определенные правила что должно храниться в журнале и как там хранятся транзакции понятное дело но вместе с ними еще хранятся термы когда их создали и блок yandex logo индекс от идентификатор транзакции уникальный монотонный который лидер генерирует для каждой новой транзакции в журнале а реплики они вот эти транзакции следи раскачивают и у себя применяют и они как бы являются префиксом лидера и до него до гоняются кроме этого по мере репликации лидер следит какие реплики что уже успели скачать у себя применить и смотрит на какие уважают записанных транзакций есть кворум и на них в конец запихивает еще камины помимо коммитов в рафти еще есть понятие отката транзакции но оно такое условное она происходит только тогда когда откат происходит только тогда когда реплика раз синхронизировалась с лидером то есть на ней как-то появилась транзакция который на лидере нет происходит это в следующем сценарий вот есть три инстанция в первом терме один лидер он сделал транзакцию реплицировали языками тел он сделал еще одну транзакцию и ушел в офлайн он никому ее отправить не успел теперь выбрался новый лидер он у него кворум есть потому что 2 из 3 живы он в новом терме победил и сделал еще 2 транзакции синхронных игроками тела потом 1 instance вернулся и он видит что у него есть транзакция которой на лидере нет и префиксом лидер он не является и кстати мне может он не может догоняться теперь до лидера ровд говорить давайте тогда вот эту транзакцию и как бы не видел никто так что можно ее просто выкинуть тихонько и никто как бы не заметить что она была и никогда никто как бы не заметить что она была и теперь лидеры теперь вот этот instance он стал префиксом лидеры может до него догонять и утверждается что это безопасно вот это выкидывание транзакции с конца журнала потому что это там за акция не была закончена после нее нет ни было commit а потому что подтверждение не были собраны значит ее изменения не видели ее можно спокойно и журнала удалить и вот реплика починилась теперь опять с лидером на vsync ранее tarantul начинаются сложности уже с того что у нас идентификации транзакции отличается от равта враг те и каждая транзакция инфицируются линейно только одним числом logo яндекс tarantul и двумя числами сразу реплика иди и lsn реплика аиде это уникальный идентификатор инстанции который создал транзакцию а л с э но вот его сын это то же самое что логин dex но только внутри данного реплика иди такая идентификация по двум числам она пошла с поддержки мастер мастер и за счет того что из-за того что инстанциям нужно уметь делать транзакции одновременно чтобы их не как и синхронизировать потому какие кто и лосины будет писать мы позволяем писать какие угодно его сын и но только со своим уникальным префиксом реплика иди и если на какого-нибудь инстанции взять и собрать из него из его журнала все транзакции которые у него есть от всех реплик от которых он что-либо получил и взять по ним максимальные и лосины то получится такой я вектор где индекс эта реплика иди а значение это lsm lsn это лак sequence number я наверно забыл сказать расшифровывать значение это л.н. и вот по этому вектору можно точно сказать что этот instance от кого когда-либо получил от какой реплики какой последний лосин он скачал и называется этот вектор v клок и размеры у него максимум 30 два элемента потому что максимум в tarantul и реплик может быть 32 до 31 0 число зарезервированы обмениваясь в клоками инстанции могут друг другу сообщать кто там кому чего должен дослать кому чего не хватает показываю пример есть три инстанса один из них сделал транзакцию записала ее в журнал обновил свою часть его клок а первое потому что у него реплика ad1 он ее разослал на реплики там оно применилось точно так же с тем же репликой де с тем же его сыну в первую часть вы клок другой instant сделал 2 транзакции обновил уже свою участь его клок а потому что у него репликой di2 ионные razr пли церовани там она на других инст их разрыв ветировал и на других инстанциях она они применились тоже в ту же вторую часть вокруг и потому что источник был реплика эти два и вот по этим выкладкам инстанции могут точно сказать кому чего не хватает кому чего дослать вот механизм синхронной репликации я буду рассказывать на примере цикла жизни синхронных транзакций в тарантулы так будет проще всего и здесь первое что важно за то что синхронность стран то ли это не свойство вообще базы данных не свойства инстанций не свойства коннекта это свойство каждой транзакции по отдельности то есть вы как пользователи вы можете выбирать для каких данных вам синхронность нужно для каких не очень то есть вы не будете платить например большим light in sick для тех данных которые можно и так комитете асинхронные и синхронные заключать на каждую транзакцию для этого транзакция должна что-нибудь менять в синхронном спейси space это типа sql таблицы в тарантула и синхронный space от в тот у которого установлена опция из sing в true теперь любая транзакция которая что-то в него вставляет удаляет обновляет она будет всех ровной больше того эта транзакция она может менять данные и в других в обычных space ах но если хотя бы в одном синхронным она что-то делает на все станет тоже синхронный и сначала своей жизни до начала коми то это синхронная транзакция она не будет ничем отличаться от асинхронный точно также она живет накапливает изменения и в журнал она первый раз пишется тоже как как и все прочие записи журнала и транзакции просто ее данные туда попадают после этого надо дождаться для этой транзакции репликации чтобы собрать на нее кворум и сказать вот теперь мне о корм есть ее можно комитет этих транзакций много и надо и все где-то хранить пока они не закончены в tarantul это место называется лимб лимб вообще это типа место такое куда попадают души после смерти откуда их потом рассортировывают в ад или в рай вот в таранто ли туда попадают транзакции после записи в журнал и оттуда рассортировывают в комент или врал b если упрощенно лимб это на самом деле вот просто очередь в своем ядре куда эти транзакции накапливаются и где ее сначала мы смотрим какие первые транзакции собрали кворум новые дописываем в конец но если шире говорить-то лимб это целая такая библиотека подсистемы внутри тарантула где содержатся все ядро синхронной репликации вся ее логика вся сборка кворумов решения записи к метафоре албегов и прочее посмотрим как он работает вот появились транзакции синхронные попали в журнал на мастере теперь они попали в лимб в очередь они там сидят ждут их пока не видно клиент их не видят репликация происходит они попадают в журналы реплик теперь они попали на репликах в лимбо реплика видишь эти транзакции синхронные потому что на ней те же спайсы она тоже видят что эти стандарты и трогают синхронные space и но lymph на реплики вот у нас синенький потому что он специальный он проще чем мастерски лимб потому что он не принимает никаких решений как вот прямо по росту в raw те реплики не какие решения принимать не могут они не собирают подтверждение не пишут никами то нирал бекки и в tarantul это же лимб на репликах это вот буквально просто тупая очередь она ничего не делает но они там сидят в этой очереди ждут реплика отправляют подтверждение мастеру и мастер собирает эти подтверждения собирает кворум ему надо уметь быстро считать для каких транзакций кворум собрался для каких нет потому что их много подтверждение приходят постоянно для этого в лимбе и есть такой специальный виток не такой же как в тот который описывает журнал в нем индекс это тоже реплика иди но значение этой лосин но только там все значения этой ла-7 лидера но они не одинаковые они описывают какая реплика какой well as and лидера успела выкачать то есть от 32 версии журнала и лосина лидера в том виде как его видят реплики показываю пример на мастере появилось четыре транзакции они записали журнал попали в лимб мастер тоже участник форума поэтому транзакции будут там в этом лимбе сидеть и обновился лидерской лидерский компонентов и клок а транзакции реплицируются от реплик приходит подтверждение они попадают в этот же лимб подтверждение и обновились в соответствующей частью вот этих вот вот это вова клок а соответствующие репликам мы теперь видим что все три инстанции получили транзакции с его сыном меньше либо равным 4 и есть кворум можно комитете транзакции теперь пусть еще пять транзакций появилась они тоже попали в лимб обновился лидерское обновилась лидерская часть цикла kalimba происходит репликация один из нас уничтожен сразу были очень тяжёлые транзакции еще один ответил только на первые четыре она последнего не ответила это подтверждение дошло и мы видим что вот первая реплика получила от лидера первые восемь транзакций лидер сделал 9 а третье instance только 4 получил мы видим что кворум есть на 8 л с н и меньше потому что на двух из трех инстанциях он есть напополам + 1 9 9 он только на линии его нельзя коммитить как только олимп видит что что-то можно комитете он начинает действовать вот показываю на примере есть в лимбе очередь там 100 транзакций лидерская часть выкл о kalimba уже обновлено в эту в это 100 и пришло подтверждение от 1 реплики на первой транзакции мы видим что кворум они достаточно было что 5 пополам плюс один этот и а значит на 1 л с н только два подтверждения лидеры одна реплика его к метить нельзя ждем дальше пришло еще два подтверждения видим что на вас n меньше или равной двум к вором есть потому что его подтвердили три dance танцы из пяти пополам + 1 а третий вот на него уже не откорма того что только на двух из пяти так что комитет lsn 1 и 2 для этого лимпопо пишет журнал специальную запись confirm л а с н и вот этот вот и losing последний который к митинг эти транзакции slimebaff удаляются из памяти удаляются клиентов отпускаем изменения видны сразу две транзакции одним махом подтвердили теперь приходит и щепочка подтверждения ото всех здесь легко посчитать что максимальный lsn собравший кворум три из пяти это 7 л с н и меньше на 8 вот уже нет потому что он только на двух из пяти комедиям 7 сразу пять транзакции за один раз can ферме одной записью журнал и strand ли вообще много чего делаете вот так вот пачками мы эти транзакции confirm пачками в журнал они попадают пачками на реплику они посылаются пачками все клиентские запросы приходят и отправляются ответы тоже большими бочками по мере возможности avrdude вот прям 5 транзакций сразу подтвердилось чтобы экономить место на диске даёте confirm и они попадают журнал журнал реплицируется значит conform и доедут до реплик и в лимбах реплика не то то же самое сделают они подтвердят вот эти вот первые две транзакции следующие пять транзакций на репликах отличие только в том что вот этого вы клок а там нет некие подтверждения не приходят то есть там все гораздо проще и помимо этого в tarantul есть и щетка от транзакций но не такой как в рожден он нужен для защиты от бесконечного роста лимбо потому что комитета транзакции могут медленнее чем они приходят и тогда очередь в лимбе будет расти бесконечно мы этого не хотим в реальном мире они в научном пайпер и поэтому нам нужен нужно оказать защита в таран плита тайм-аут мы его конфигурируем один раз и если какая транзакция самое старое то есть первое в лимбе в очереди с тайма училась то она откатывается и вместе с ней все остальные транзакции в лимбе тоже почему это происходит потому что они могут быть зависимой по данным даже без грязных чтений они могут быть зависим и через например 3 участника который создал вот клиент создал несколько транзакции он создал их такими что они по данным зависимы мы не можем предполагать они как зависимо они или нет поэтому откатываются все чтобы сохранить линейный журнала для этого журнал пишется записи рбк лосин начиная с какого lsn откатить и откатиться все сытого и alsina до самого oral-b к то есть он в скобки когда берёт транзакции которые надо откатить и здесь на самом деле есть очень такая не тривиальная вещь в том что рубикон вообще не гарантирует ничего потому что у нас нет кваруман oral-b как вором на кворум нурлыбек и так далее рубикон гарантирует только одно локальный откат транзакций больше ничего conform он хотя бы гарантирует что данные есть на кворуме реплик при этом самого конфирмат а может и не быть разбег он вообще ничему не гарантирует из этого может произойти любопытная ситуация что транзакция после брал бека все равно закомитить на другом instance происходит это как на примере самый простейший случай 3 инстанция одну транзакцию лидер сделал отправил и всем видит кворум пишет confirm сделал еще транзакцию всем послала подтверждение не дошли сеть отрезала но транзакции он отправил и он не знает вообще дошла она или нет он ждет тайм-аут пишет ромбик потом выбрался новый лидер потому что кворум остался там в другой части кластер 2 из 3 он выбрался написал confirm почему он не мог написать рубик потому что здесь есть только два варианта что делать этому лидеру новому либо пишет confirm naturana что возможно был ромбик либо он пишет рбк нато на что возможно был confirm здесь надо вот немножко побыть ведьмаком и сделать выбор из двух зол либо мы выбираем большее зло мы делаем ромбик возле confirm а это перечеркивает всю суть синхронная репликация либо мы делаем confirm после райбека вот мы делаем confirm после райбека потому что так менее плохо причем можно этого избежать если хочется классический ровд можно просто тайм-аут бесконечность выкрутите она будет правду работать и здесь такая тема еще что вот этот инстинкт старый он он в класть уже вернуться не может потому что он с лидером раз синхронизировалась а прямо как в том случае который я рассказывал про рассинхрон лидера и и реплики в raw те но только мы tarantul и не умеем удаляются транзакции с конца журналов силу его устройство не потому что мы не хотим и поэтому такой бизнес придется пересоздать вручную в кластер его обратно добавить как свежую реплик пока что это делается вручную но когда-нибудь будет автоматически и в транс или представлен следующий интерфейс для работы синхронной репликации во первых можно выбрать свой таймаут на сбор подтверждений после которого будут роль бекки и можно выбрать кворум можно выбрать его как константу можно выбрать как формулу на над переменной n где n это количество инстансов в рипли к сети формула удобна тем что она будет сама автоматически пересчитывается каждый раз когда состав рипли кассета меняется то есть вам не нужно будет ходить эту константу обновлять во всех конфигах когда новый инст нас добавился или старый удалился каноничный кворум тогда будет выглядеть как он пополам + 1 вот формула для синхронных транзакций нужен пока что синхронный space сопли из sing и это можно в том числе на существующую спейси включить если вы обновляете новую версию тарантулы хочется синхронность уже для имеющихся данных получить и есть мониторинг помимо большого количества ручек мониторинга вообще репликации в целом таран тульской есть еще специальные мониторинг для лимбо там можно посмотреть размер очереди которые успела накопиться и посмотреть кворум вычисленным кворум вы можете сами свои не знать потому что в формулу например написали и вы не знаете чего что он и вы числилось вот здесь можно посмотреть во что она посчитала boxing синхро corum и синхронная репликация прим он она очень тесно связано с выборами лидера поэтому я не могу про них вообще ничего здесь не рассказать я покажу интерфейсы и какие два типа выборов у нас есть подробно это целая тема отдельного доклады здесь про это не будет есть во первых автоматические выборы в tarantul и они конфигурируются так можно выбрать instance'а одну из трех ролей кандидат гола избиратель или никто а кандидат это типичный instance прямо вот паров тупо пайпера он он является реплик и скачивает изменение с лидера смотрит жив ли лидеры сам иногда пытаются им стать избиратель все тоже самое только он лидером стать не может сам и не будет пытаться это удобно если у нас instance слабой машина слабой или он далеко от клиентов мы не хотим чтобы он делал транзакции на мы хотим чтобы он поучаствовал в кворуме и помог выбрать нового лидера и есть никто это если instance это просто слив для для репликации туда тупо данные реплицируются и этот intent не должен вообще ни на что не как влиять можно выбрать тайм-аут выборов после которого они перри запускаются если примеру произошел сплит vaude большинство ни за кого не проголосовала и можно выбрать ковром можно заметить что кворум это здесь точно такой же как и в синхронной репликации потому что они очень тесно связаны и то и другое и выборы или синхро они отвечают за сохранность данных и они вот связаны через этот к вором вместе но это все по автоматике аппарату работает можно еще сделать ручные выборы если у вас уже есть свои выборы и вы не хотите использовать встроенные но вы хотите sync руб потому что грязные чтения вы починить не можете в принципе на уровне приложения как следует поэтому можно сделать ручные выборы но и полную возможности sync'r использовать для этого новый режим появляется миньон ручной он работает как избиратель то есть он сам лидером не будет пытаться стать но будет голосовать но на нем можно позвать функцию бокс цель про могут которую наконец-то сделали уже поверх целого рафта недавно она проведет за этот instance голосование в новом терме или он либо победит станет лидером либо проиграет и получите сообщение об ошибке он может проиграть если на нем данные не самые новые или за него просто и большинство не проголосовала тогда можно перезапустить его попытаться и кворум здесь тоже нужен потому что это связано с синхрон и нужно большинство для выборов иметь чтобы победить посмотрим на примере простом как это работает конфигурируется вот я указываю рипли кассеты с 3 инстансов один лидер две реплики я выключаю специальные опции грязные чтения и указываю кворум сто процентов потому что мне так для примера будет удобнее для наглядности но вообще у вас сто процентов он обычно быть не должен здесь он был бы 2 если бы он был канонический а еще лучше он пополам + 1 константы лучше не писать надо было здесь он поставить ладно я выключаю все проверки доступ и потому что доклад не про них они здесь не интересны на репликах я указываю все тоже самое только опции синхронности я опустил все потому что лимп на репликах он ничего не делает на него эти опции не влияют ни как то есть их можно указать вреда не будет за конфиг у нас везде будет унифицирован один и тот же но вот здесь или для компактности не указал я сделал синхронный space создал транзакцию проверяю что она сработала потому что кворум есть теперь я одну реплику остановил и создал еще одну транзакцию в новой к рутине чтобы не блокировать консолью новые к рутине это сделал пост транзакция но сейчас зависла потому что она ждет кворум теперь я проверяю транзакция действительно не закончена ждет кворум я ее изменения не вижу теперь я поднимаю обратно эту реплику и смотрю транзакция завершена стран за а и изменение стали видны вот я прочитал этот ключ транзакции я его вижу все закончилось она дождалась кворума чем это все отличается от raw то суммарно во-первых векторный формат журнала самое большое отличие в tran phu ли у нас журнал это на самом деле много журналов соединенных в один в руке это 1 линейный журнал и это сложнее но зато нам это потенциально открывает дорогу к синхронной мастер мастер аппликации когда-нибудь в будущем следующее отличие в tarantul и журнал ряду то есть его можно только проигрывать самого начала его нельзя откатывать с конца по одной штучке как ровд умеет в raw те журнал видимо предполагается онду потому что он позволяет с конца транзакции по одной штуке удалять нижние транзакция вообще записи журнала по одной удалять в нем есть для этого информация нужна у нас вот трамп ли так нельзя из-за этого иногда эстонцы приходится вручную пересоздавать пока что вручную еще таран стран туле можно читать реплики даже при синхронные репликации потому что нам у нас нет такого ограничения что только новые данные можно читать иногда достаточно читать достаточно новые но главное чтобы они были консистентную чтобы не было каких-то половинчатых транзакций появившихся там с мастера незавершенных вот реплики в трант или можно читать уровня нельзя еще трантон есть поддержка откатов транзакции по тайм аут чтобы очередь синхронных транзакций не росла бесконечно какие планы на развитие асинхронной репликации в tarantul и во первых есть известные баги над починкой которых ведется работа публично api может быть будет расширяться но уже очень маловероятно что будет меняться и я призываю вас пытаться как-то этим воспользоваться приносить фидбэк какие-то баги запросы что еще не хватает мониторинге такие фичи может быть еще нужны далее мы уже запланировали реализацию синхронности буквально вот каждой любой транзакции даже без синхронного спайса просто опцию бокс коммент указывают любая транзакция станет синхронный над любыми данными и кроме того из за того что там в синхронной репликации play doh все большой но больше чем в асинхронный наконец иногда хочется побыстрее этого комента избавиться клиента отпустить и для этого можно будет бокс commit сделать чтобы не блокировал текущую крути но отпускал на сразу законе тициана попозже сама и это удобно если у нас критичного клэйтон все приложения мы хотим сразу клиентов отпускать а результат транзакций мы потом придем и проверим попозже закончилась она или нет и следующее это триггер и на выборы на смену состояния инстанций то есть можно будет подписаться своей функцией нато когда инстант становиться репликой кандидатом или лидером или что-то мы с ним еще может произойти спасибо за внимание значит вот и пожалуйста ссылочки еще на моем на мои другие доклады в том числе на этот и там будет полное значит текст моего выступления почти слово в слово и последней ссылке можно посмотреть наши прочие доклады на этой конференции получить мерч поучаствовать в конкурсах и пока по последней ссылке можно посмотреть наш канал смелыми пар тарантул пожалуйста подписываемся все переходить к вопросам вот соответственно можете задавать их тут к вам подойдут девушки в красном и выйдут микрофон либо если вы смотрите нас онлайн вы можете написать текстом я вопросы зачитаю или выйти сюда к нам в онлайн эфир и за лучший вопрос как обычно есть книжка в it's love выберет погнали здравствуй вадим подольный не вот очень интересно вот вы говорите multimaster синхронная синхронная репликация когда у вас есть несколько инстансов и они по сути обладают неким консенсусом зачем вам транзакции вот технология sucdem 21 века особенно распределенное говорят о том что знать оценить надежность и консистентных данных точнее так консистентной консистентной и данных в кластере достаточно чтобы оценить собственно говоря актуальность информации то есть было транзакция по сути или не было зачем ее вообще отдельно как какой-то объект обсуждать почему нельзя перейти полностью на консистентную модель данных отказавшись от понятия транзакция по сути если вот понятно какой вопрос задаю или нужно как-то более его номера телефона транзакцию и тоже как бы единицу консистентную если половину транзакцию применилась это уже не принц и стенку или тратите время и на подтверждение consistent насти транзакции и на синхронизацию этих транзакций традицию лишь вы хотите просто консистентную но безнадежность вам необязательно синхронно использовать есть а синхронную репликацию стран туалетом пожалуйста не надо ждать никакие подтверждения транзакций попала на дисках общего commit иногда этого достаточно даже больше того обычно этого и достаточно все понятно надежность вот синхронность появилась спасибо за доклад меня зовут василий вопрос такой не понял из доклада относительно лимбо где хранятся данные которую лимпопо дают это оперативная память конечном итоге до оперативной памятью транзакции этот объект в си плюс плюс там все структуры просто где список или изменение вот она поменяла в таком типе сета в этом-то в этом это и вот этот объект они там просто в списке лежат в лимбе очереди еще вы оттуда потом удаляются когда к мите little big а в таком случае есть какая-то рекомендаций относительно размера оперативной памяти на insta зависимость от количества инстанса пыль от нагрузки или ещё как-то по лимбо у меня пока сложность отрекомендовать пусть мне неизвестно его использование в продакшен асинхронной репликации она буквально появилась совсем недавно то есть если там есть желание вот завтра короче прийти и сказать о классном начинаем использовать и дать туда какую-нибудь нагрузку на 500 транзакций в секунду но это не чтобы но смотрится равно плод для для этого вот сколько там ей из-за гигабайта оперативной памяти это будет зависеть уже от того насколько далеко реплики находитесь каждая транзакция будет к месяца по полчаса тогда 500 транзакций в секунду это очень много накопится дофига из транзакции комитета очень быстро за несколько миллисекунд как это обычно втором туре бывает ну то есть мы знаем что асинхронные транзакции они у нас на них тоже подтверждение приходят просто commit на них не ждет в трант ли мы знаем что обычно это порядок мире секунд то есть если 500 транзакций в секунду можно тайм-аут выставить этот мы большая связка если к эмпирическим путем это можно выяснить да да эмпирическим но если прям хочется то можно можно и ограничение на размер очередь пытаться сделать из этой кому-то надуты мы сделаем так еще раз чем отличается порядок порядок логе обычно один и тот же нас окрепли как только некоторые из слогам так или в случае только порядок транзакции строго один и тот же везде они никогда не препарируют но там лаги есть данном случае каких и патологических ситуации возможны расхождения но тогда реплика дропа еца которая отошла я не расслышал последний случае патологических ситуациях возможно что будет разный порядок но тогда нужно дрогнуть всех тех непорядок не будет разные никогда благодаря вот этим вот вы коком и лосином транзакции строго упорядочены по и лосином и они никогда не переупорядочить исходя из одного instance то есть если это один из сделал 2 10 транзакции все остальные инстанции с реплицируют их ровно в том же порядке в котором их применил оригинальный instance унитаз был случай когда мастер терял соединения да но туда не было перри прядущего не я тогда осталось транзакция который просто некому отправить не успели то есть и не вниз чем было при упорядочиться ее на лидере в принципе не было добрый день и спасибо за доклад такой вопрос вот у нас есть мастер реплика конфигурация то несколько реплик один мастера случился ковром транзакция записалась но что происходит при чтении то есть как мы можем гарантировать то что вот данные закомитить на каком-то там сети реплик есть кворум и мы хотим их прочитать на прочитать гарантированно то есть чтение просто не будет видеть эту транзакцию пока кворум не собралась то есть ее как bennett пока она не за камина звезде кворум собрался и на каких-то реплику нас и транзакции еще нет ну да туда-то мы и пока не будет ли стам попытаться прочитать но она потом приедет вместе с комментом там применит но чтение но когда мы читаем мы знаем на какую реплику мы придем или мы читаем с рандомной реплики вот уже от вашего приложения зависит вы можете знать может прийти проверить это мастер элемент если такая ручка boxing бокс бокс info election и там указано роль инстанции это лидер или реплик или кандидат и вот если хочется на реплики не ходить то можно проверять если мы пришли не на лидеру то уходим смотрим кто лидер и тогда еще маленький вопрос в рис панси я там когда корм случился можно ли как-то получить именно какие реплики именно поучаствовали в корме то есть на каких оно гарантированно оказалось нет пока так ну вообще можно это вычислить у нас есть ручка боксе на фаре плетей шим там указано какие реплики какой lsm с лидера выкачали из нее можно вычислить какие реплики подтвердились лидера все спасибо добрый день спасибо за доклад мухаметшин евгений вопрос такой асинхронная реплика она может стать мастером нет понятия асинхронная реплика есть только понятия синхронные или асинхронные транзакцию да то есть мы когда включаем реплики в репликацию да мы говорим какие реплики на какие реплики синхронны идет транзакции или на какие-то оси трудно не то есть мы просто говорим что вот есть такие реплики и у них есть такая роль в плане выборов но в плане синхронную репликацию реплик нет никаких есть опасения всех этих ролей здравствуйте хотел уточнить вот из доклада не совсем понятно было точно ли можно например записать на мастер и сразу же после этого прочитать со слова то есть если я например записываю сразу же шлю чтение нас life точно ли это гарантирует что эти данные там появится то есть вот на мастере произошел commit туда это гарантирует что вот на кворуме реплик это транзакции теперь есть я знала прямо сейчас сразу прийти просто невозможно что вот в какой-то там на на секунду все таки это не будет потому что я видел в конце идет подтверждение о том что он принял подтверждение как это вы так делаете что мгновенно все еслы вы и мастера в пролётный моментов карьеры я понял понял да они и не не будет гарантии потому что надо факт коми то он реплицируется асинхронно поэтому если commit завершился на мастере не знаете что коммент уже доехал до реплики то есть если сразу прийти то там может ее пока не быть то есть какой-то финансовую систему нагружены делаем все равно если мы читаем то лучше писать с мастера и писать и читать с мастер можно так да если мастер справляются с этой нагрузкой почему нет спасибо"
}