{
  "video_id": "HpaBL2-4Kms",
  "channel": "HighLoadChannel",
  "title": "Сверхскорость. Единая платформа экспресс-доставки Яндекса / Сергей Хорошеньких (Яндекс Доставка)",
  "views": 1403,
  "duration": 3079,
  "published": "2023-04-28T06:19:52-07:00",
  "text": "так Всем привет я сегодня расскажу про единую платформу экспресс-доставки Яндекса вот тут еще есть название съев скорость но если честно меня попросили добавить это слово оно относится к чему к тому как мы делаем именно быструю доставку вот речь будет про то как мы строим платформу которая позволяет доставлять быстро то есть быстро искать курьеров и быстро соответственно чтобы они привозили чего-нибудь Сначала я Ну расскажу что мы имеем ввиду под словом платформа почему она единая кого она объединяет или что она объединяет вот потом собственно обсудим как-то платформа устроена поговорим про алгоритмы под капотом То есть если супер коротко то платформа позволяет разным людям разным командам Яндекса писать алгоритмы единообразно алгоритмы доставки Вот и соответственно нужно понимать как эти алгоритмы работают как масштабируются иначе ничего не будет работать если алгоритм плохой и в конце будут какие-то выводы когда мы эту платформу делали мы много чего поняли и причем выводы разного рода и про процессы rnt потому что ну задача была такая исследовательская и про инфраструктуру немножко и про алгоритмы вот поехали О чем речь Ну на прошлом докладе например упоминался Яндекс поиск да но Яндекс это уже давно не только по поиск а еще и вот про Покушать то есть как вы наверное знаете есть несколько сервисов Яндексе Например Яндекс еда Яндекс лавка где нужно быстро доставка Ну потому что если человек голодный надо быстренько его накормить понятно и эти бизнесы еда и лавка например они как бы разные то есть они решают разные задачи но так получается что у них есть какой-то общий компонент то есть нужна быстрая доставка экспресс-доставка при этом курьер у них разные Как вы знаете они там разного цвета по городу ходят Да вот ну и так далее пандемия показала что быстрая доставка нужна вообще говоря много кому Да полезная штука и кажется в девятнадцатом году от Яндекс такси отпочковалась скажем так оттачиковался небольшой на тот момент бизнес такой эксперимент его назвали Яндекс логистика но переименовали сейчас называется Яндекс доставка Короче говоря в Яндексе теперь Уже довольно долгое время есть отдельный сервис отдельный бизнес сделанный специально для доставки вот если еда и лавка просто имеют доставку как часть своего бизнеса то здесь мы специализируемся конкретно на доставке Ну и стало понятно что вообще-то логично объединить всю экспертизу например в экспресс-доставки между разными сервисами чтобы это было более-менее единообразно Но помимо того что это логично еще Возникала следующая задача вот у нас уже есть аж целых три сервиса которые доставляют быстро и надо их как-то объединить для того чтобы курьеры одного сервиса могли как-то выполнять заказы другого Ну то есть вот Яндекс доставка это сервис общего назначения и Яндекс еда может например захотеть курьером и доставки привозить заказы еды потому что пользователю Ну все равно кто именно доставит ему еду правильно вот и чтоб такую задачу решить уже нужна какая-то платформа то есть нужно какое-то место где разные команды могут реализовать какие-то свои алгоритмы свою бизнес логику и так далее Вот то есть единая платформа экспресс-доставки она вот про это мы сейчас посмотрим как это у нас устроено Для начала я хочу очень коротко очень приблизительно вообще описать жизненный цикл заказа то что происходит вот в этом заказали себе чего-нибудь из магазина что происходит Дальше Ну во-первых вот если ваш заказ он попадает куда-то вот в облачко которое я здесь которым есть собирательно называю вообще весь бэкенд Яндекс достатка Ну то есть заказ надо сохранить там статусы его отслеживать и так далее мы этого касаться не будем просто есть как бы какой-то кусок большой системы и это этот заказ от разных сервисов заказов унифицируются и заказ переводится вот в то что я дальше буду называть заявка Просто некоторые единый универсальное представление заказа то есть что везем куда везем откуда везем Какие требования То есть если это еда наверно нужна термосумка Если нужно супер быстро наверное нужен ку на машине а не пешей что-нибудь такое и вот такие вот заявки унифицированы они попадают как раз к нам вот в этот прямоугольник по которой я дальше буду детально рассказывать Что делает вот этот прямоугольник какую задачу Он решает по сути Он решает одну задачу но супер важно этот прямоугольник то есть наша единая платформа она назначает курьеров на вот эти самые заявки то есть создает маршрутные листы Вот то есть это такой термин который как раз означает предписание курьева А что делать как то есть в каком порядке идти по точкам кому У кого что забрать кому чего отдать и важно что курьер в принципе может вести несколько заявок сразу вот и это супер важно Почему Потому что в этом например отличие есть от такси да то есть когда вы заказываете такси вы не очень-то ожидаете Что кто-то к вам подсядет даже если это для вас будет дешевле для этого заказывали такси А вот когда к вам едет доставка то если к этой доставке кто-то еще потя Ну наверное ничего страшного если к вам приедет быстро то О'кей Вот примерно такая идея И это важно потому что если курьер везет по нескольку заказов по нескольку заявок сразу то это пост будет дешевле для вас и в этом вся суть задачи то есть уметь заявки вместе объединять и вот это объединение это наш жаргон но настолько важно что я его вынес это батч вот такое множество заявок которые вместе исполняются называется патч и наш и задач вот этой коробке по сути делать Вот такие патчи Ну и требования заявок если они есть они тоже как-то там объединяются вот эта коробка отрабатывает возвращает свой ответ доставки Ну и дальше мы уже конкретным курьером предлагаем вот конкретные такие маршрутные листы Вот это в двух словах вообще про место той платформы в более общем цикле заказа теперь я вам расскажу собственно о самой платформе сначала коротко обсудим технологический стек Вот Потом обсудим самую важную часть это то как написать в этой платформе алгоритм Ну и посмотрим как вообще там сервиса живут стек у нас на полюсах то есть мы пишем на оси плюс конференция хайлот плюс плюс логично плюсы хороший язык да Все наверное согласны быстрый Вот а еще есть клевый фреймвок называется ю сервер который Яндекс недавно Выложил в Open Source и в этом блоке есть куча плюшек То есть это фреймвок который сделан для того чтобы удобно было писать микро сервисы то есть там например есть под капотом корутинный движок Очень клевый Он позволяет например эффективно ходить там по сети например да ну то есть со всякими ожиданиями всяким прочим и при этом он еще умеет CPU intence в таске тоже как-то оптимально шедевлить То есть если у Вас например мало похода по сети а вот какая-то просто числа молотилка которую надо провалились то вот этот корутийный движок он догадывается например на разные труды раскидать ваши цепой интенсив задачки А если вас какая-то смесь и все это надо сходить и ботинки помолотить то вы можете как бы единообразно пользоваться этим фейсбуком и все работает хорошо вот у нас как раз такая же задача нам надо и сеть ходить где-то просто запускать какие-то алгоритмы молотить чистилки отдельно хочется выделить такой момент что мы используем для разделения разных алгоритмов от разных бизнесов Яндекса мы используем юниты что это такое Это по сути у нас все еще один микросервис но внутри этого микросервиса есть выделенное железо под запуски алгоритма Например Яндекс лавки отдельное железо под запуски алгоритма Яндекс отдельно под доставку Короче говоря вот алгоритм внутри этого разделены Строго по железу Ну это позволяет как бы не аффектить плохим ходом написанным в одном сервисе если что-то с ним не так он не зафиксит никак вот есть там небольшая баска у нас подвесную и для кэширования мы используем редис тут в принципе стек довольно довольно стандартно сказал а вот что нестандартно это собственно то А что же на этом стейке мы реализуем вот то есть вот я говорю что у нас платформа Что это значит платформа Ну есть у нас разные бизнесы Яндекс надо им свои алгоритмы реализовывать так вот для этих алгоритмов нужен какой-то универсальный интерфейс скажем тогда и мы разными командами собрались так подумали А вот у наших вот разных алгоритмов что общего то есть если вы хотите решить такую задачу назначить оптимально как-то заказы на курьера как вообще выстроить алгоритм этот алгоритм вот как здесь картинки нарисован в принципе зависит много чего от того какие доступны кандидаты Что там на дорогах творится если фотки или нет Вот того какие сейчас заказы в системе Какие заказы уже в системе исполняются Ну и так далее куча всего вот можно было Конечно все это алгоритм подать на вход но мы сделали вот как мы на вход алгоритма явно подаем только только заявки и маршрутные листы То есть те заказы которые уже как-то исполняются в системе А все остальное вот этот алгоритм он уже тут переназван моего планировщик чтобы более конкретно ими иметь вот все остальное что нужно алгоритм для работы он уже как бы под капотом как-то там вызывает нужна ему дорожная обстановка Окей там ходим Яндекс карты и так далее То есть интерфейс у него Вот такой на входе заявки маршрутные листы Ну и на выходе опять какие-то новые маршруты то есть какие-то новые назначения вот планировщик это вот Центральная часть нашей платформы так сказать то есть использовать платформу означает написать планировщик Да это абстракция для алгоритма назначения И каждый бизнес Юнит Ну то есть вот в Яндекс лавке есть свой планировщик свой алгоритм Яндекс еды в Яндекс доставки какие-то свои и как эти планировщики разделять Ну собственно пока что эвристика довольно простая Что каждой планировщик может назначать на какой-то один тип курьеров вот эти три типа три бизнеса Яндекса у них там например юридические или финансовые разные курьеры Ну и сильно проще если планировщик назначает на какой-то один этот планировщик работает итерациями технически это выглядит примерно так я сказал что у каждого планировщика свое изолированное железо так вот на этом железе запускается какая-то таска вот периодически она запускается принимает на вход все что должна принимать то и все заявки все текущие маршрутные листы что-то делает возвращает ответ и все и Потом следующая операция То есть можно было сделать Не так на самом деле можно было бы сделать планировщик как сервис который принял заявку в запросе выдал в ответе курьера Но тогда мы было бы сложно заявки объединять вот поэтому такой большой алгоритм Да на входе итерации как уже на картинке было есть все заявки все маршрутные листы А вот что на выходе то есть Какой ответ может выдать этот планировщик Ну очевидный ответ первый заявка назначается на кого-то мы нашли курьера решили что ему это подходит и все поехали и возможно мы несколько заявок сразу на курьера назначили или курьеру до кинули какую-то заявку можно заявку не назначать Ну такое тоже вполне допустимо потому что иногда это это выгоднее То есть сейчас свободных курьеров нет И мы назначим кого-то очень далекого но при этом заявки не люди Они иногда умеют ждать и иногда в свойствах заявки самой написано что меня нужно там отвести в течение трех часов Окей за три часа Мы точно кого-нибудь найдем сейчас не будем назначать и самое интересное происходит здесь мы можем решить что заявка передается на вход другому алгоритму и пусть другой алгоритм с ней разбирается То есть это опять же одна из самых веских причин Зачем иметь платформу затем чтобы вот обмениваться заявками между разными алгоритмами при этом ничего сильно не испортив и чтобы это было как-то оптимально Вот теперь я вот ту же картинку с прямоугольником Я чуть перерисовал вместо прямоугольника теперь как бы более развернутое описание чего-то прямоугольничек делает и здесь устройство в целом довольно простое есть какая-то какой-то хитро какая-то часть сервиса которая отвечает то чтобы состояние этого сервиса там было актуальным Вот она отвечает за наполнение множество заявок вообще для общения с внешним бэкендом доставки в том числе и есть несколько планировщиков то есть несколько юнитов внутрь внутри этого сервиса который между собой могут общаться через базу вот как здесь написано у нас есть небольшая баска пост рисовая Вот и они могут как-то использовать базу напрямую потому что все еще один сервис Вот либо они могут ставить задачки в какой-то асинхронную очередь Например если планировщик решил каких курьев кому назначать он асинхронно отправляет свой ответ дальше во внешний мир не надо ждать пока внешний мир ответит вот примерно примерно вот так про масштабируемость бы надо сказать Да потому что ну количество заказов оно растет постоянно людям все-таки нравится заказывая себе еду или еще чего-нибудь вот как же все это дело масштабировать ну во-первых очень хорошее свойство конкретно нашей задачи состоит в том что у нас экспресс доставка она внутри города обычно поэтому можно по шарнировать по прям по городам Ну или по свойствам заявки если в общем случае по факту это просто по городам То есть как бы есть шарф например где вообще мы назначаем только в Москве но и Московской области чтобы объединять заявки есть например может быть отдельный шар где будет назначаться санкт-петербург Вот ну в общем как-то можно объединять заявки по каким-то признакам и это объединение У нас сейчас статическое Вот то есть мы заранее решаем По каким свойствам мы раскидываем по Каким свойством на шарнируем вот по географии По сути и шарды то есть запуски вот этих алгоритмов они просто независимыми работают ничего только не знают все супер просто вот тут надо рассказать пхо то как именно самую сложную часть как бы самую нетривиальную про то как именно планировщики обмениваются заявками Ну в принципе учитывая что они смотрят в одну и ту же базу Там наверное ничего не должно быть сложно Ну так оно есть на самом деле Давайте на примере покажу то есть вот у нас есть заказы Яндекс еды и например Мы хотим чтобы заказ еды Ну нет сейчас курьеров желтыми значит термосумками Да в городе куда-то они все делись и поэтому какой-то заказ надо доставить курьером доставки по какой-то причине как это происходит Ну каждый заявки в базе нашего сервиса то есть внутри внутри вот этой платформы указано указан список планировщиков которым разрешено вообще эту заявку назначать изначально для заявок еды это только планировщики вот дальше у нас между планировщиками задано Ну строго говоря отношении частичного порядка проще говоря мы знаем какой планировщик следующий то есть для каждого планировщика может быть определен как бы следующий кому передать если у самого не получилось назначить кому передать вот схемы это как вы видите не ошибка сложно выиграть Примерно вот так то есть заказы еды могут отправляться в доставку и заказов тоже могут отправляться доставку вот и все Вот и с точки зрения программиста Вот это решение принимается Так что есть специальный метод в API в нашей платформе которая позволяет передать заявку следующему планировщику То есть можно заявки вызвать метод пасс Вот и тогда заявка передастся следующему планировщику доставки в данном случае вот и что произойдет в базе просто обновиться список активных планировщиков заявка будет параллельно начаться и там и там дальше кто уже быстрее относительно не сложно вот конечно это никакая не гарантия для того чтобы он хорошо назначал и был сам по себе масштабируем поэтому мы сейчас заглянем внутрь черного ящика и посмотрим как реализован очень упрощенно как реализован один из таких планировщиков планировщик доставки какие там под капотом алгоритмы Итак еще раз В чем основная задача вообще вот такого алгоритма основная задача в том чтобы уметь объединять заявки вот мы ее так формулируем по крайней мере Потому что если заявки не объединять а просто как-то для одиночных заявок искать курьеров то это не сильно сложная задача не чем от такси не отличается Ну как вы наверное тогда будет дорого Да ну как такси как минимум вот поэтому нужно заявки как-то объединять чтобы экономить эту задачу мы формализуем я сейчас покажу как там будут картинки Все будет понятно Я надеюсь мы эту задачу формализуем а именно Мы из задачи доставить пиццу делаем по полную задачу найти оптимальное назначение на взвешенном гиперграфе вот так потому что мы не ищем легких путей Да решаем задачу В общем виде и дальше алгоритм который вот достаточно планировщике реализован поток как этот гипер построить найти там оптимальное назначение вот здесь на картинке такой модельный пример вот у нас есть два курьера три заявки что для простоты теперь заявки еще и в одну точку едут чтобы глаза не разбегались вот и что делать да Ну вот с этим Ну можно по-разному можно по-разному назначить курьеров на заявки И как я сказал главная Фишка в том что мы в принципе можем заявки объединять если это не сильно растит время доставки Вот и да задача алгоритма объединять заявки в батчи то здесь нарисовано что вот курьер один может повести отдельную первую заявку отдельно вторую А может их как бы объединить и повести вместе Вот соответственно курьер 2 либо вторую либо третью либо вторую третью вместе может повести То есть как бы вариантов назначения довольно много как между ними выбрать Ну мы считаем что для каждого такого варианта назначения известен некоторые Профит Ну то есть какая-то чиселка по которой мы решаем насколько нам выгодно в любом смысле пока неважно В каком смысле выгодно вести Вот именно такое назначение и задача состоит в том чтобы из этой картинки когда все возможные назначения есть вывод какой-то оптимальное назначение то есть мы хотим Назначить на всех кандидатов причем также еще чтобы суммарный Профит был максимальным то есть из предыдущей картинки вот оптимально получается именно вот такое назначение все вот такую задачу будем решать и эта задача на самом деле Вот и называется поиск оптимального сочетания на гиперграфе вот что это такое Что это за Зверь такой здесь показан показано вот это вот математическая сущность гиперграф на самом деле не особо отличается от обычного графа вот просто у него ребрами являются не обязательно пара вершин А какие-то подмножества вот здесь вот множество где один курьера 2 заказать тоже ребро У него свой вес вот и оно треугольником Короче говоря вот это вот конструкция называется двудольный Взвешенный гиперграф соответственно задача нашего алгоритма такая мы строим двудольный Взвешенный гипергафф на нем ищем оптимальное назначение и здесь да для опять для некоторых ссылки такой есть ребра обычные известные из теории графов есть такие более сложные штуки гипер у них свой вес в своем множестве вершин но как бы как бы на практике будем называть все это ребрами вот эту штуку будем называть просто графом потому что для наших задач там Этого достаточно и наш алгоритм он выглядит Вот как-то вот так в нем несколько этапов мы по ним коротко пройдемся посмотрим Чего они делают чтобы понять Вообще что там под капотом лежит и почему эта штука но хоть как-то масштабируется более-менее алгоритм ход принимает заявки и каких-то кандидатов которые уже везут какие-то заказы там отдельно есть этап чтобы на занятых кандидатов назначить он вот тут справа сверху отдельно есть этап чтобы заявки объединить потом еще где-то есть бизнес логика фильтрации то есть на какие-то объединения считаем хорошими какие-то плохими вот бизнес логике Куча и она более-менее локализована дальше мы ищем кандидатов Потом мы взвешиваем все это дело Да навешиваем вот эти чистилки профиты и получив Граф мы строим Ну ищем оптимальное назначение в нем Вот давайте начнем с первого кусочка ребра для занятых кандидатов что тут происходит Ну смотрите вот у нас есть такое множество кандидатов тут есть три кандидата улыбающихся Вот и они везут какие-то заказы какие-то заявки Вот Зеленый он уже проехал часть пути от A3 вот светло зеленый еще не начал маршрут Ну короче То есть кандидатов известных координаты известный координаты точек заявки точка означает там точку где забрать а точку б точку где отдать вот что мы делаем на каждой итерации алгоритма строим гео индекс вот из таких вот точек то есть и занятых кандидатов по сути дальше для каждой входной заявки А у нас на входе и заявки кандидата для каждой входной заявки мы ищем в этом гео индексе кандидатов как раз вот мы ищем вокруг точки Откуда забрать вот мы нам нужны координаты кандидатов здесь в кружок попали два кандидата соответственно двое Нашлись 3 мы не рассматриваем дальше мы нашли каких-то кандидатов Но из них не все подходят потому что ну например вот как я начале говорил иногда там нужна термосумка иногда может быть не нужна если еду не везем Да иногда там нужен курьер на машине иногда подойдет на велосипеде иногда можно и пешего назначить поэтому еще дополнительно проверяем найденных кандидатов подходит не подходит по свойствам заявки вот той заявки из LB вот конкретно для нее подходит кандидат или не подходит если кандидат подходит то мы вот эту заявку как-то оптимально Ну просто перебором всех вариантов добавляем ему в маршрутный лист и вот этот кандидат вот этому кандидату мы предложим ввести не старый маршрут а 12b1 B2 а новые вот за один а потом а два и так далее Вот в общем ничего сложного просто просто используем гео индекс и за счет этого получается получается Нет не особо тормозить дальше оказывается что в нашей задаче мы если не знаем кандидатов то все равно можем догадаться а стоит заявки вместе вести или нет то есть идея простая вот у нас исходная картинка где были кандидаты если мы кандидатов уберем то все равно понятно что первый со второй заявкой логично объединить или вторую или вторую с третьей то есть мы воспользуемся структурной особенностью задачи скажем так то есть мы будем объединять заявки которые расположены друг другу близко геометрически довольно очевидная идея но алгоритм можно было написать И не так если время останется я расскажу как как можно написать такую алгоритм неправильно может быть Вот И здесь тоже есть два этапа поиск соседей и построения маршрутов то есть Давайте начнем с поиска соседей то есть мы зададим какую-то меру близости между заявками вот Представьте что у нас есть какие-то входные заявки то есть точки А это точки начала точки б точки конца таких заявок здесь получается 5 штук Вот они так расположены раскидана на плоскости что мы делаем опять делаем индексы Ну очевидно логично Что надо использовать для поиска вот такую структуру данных то есть Когда деревья строим отдельно по точкам А по точкам забора и отдельно по точкам б то есть по точкам вручения Сейчас объясню зачем это нужно смотрите и теперь для каждой заявки из того же самого множества то есть для заявки АБ например мы ищем отдельно соседей среди точек запора отдельно среди точек вручения получаем Ну какое-то количество точек И дальше из близких точек мы находим близкие заявки Ну то есть мы просто берем пересечение смотрите мы для точки А нашли H4 точки в нужной нам окрестности но только у двух из них а два и А3 есть соответствующие точки в во втором ответе Вот и соответственно например на точку А1 не нашлось точки соответствующей В1 заявки такие не считаем близкими вот короче говоря мы вот так вот алгоритмически задаем понятие близости между заявками Ну и в итоге получается что мы нашли пачку близких заявок вот мы аналогичную процедуру можем проделать для остальных для остальных заявок из входа Но для заявки А.Б Ну вот нашли нашим методом пачку близких этого еще недостаточно То есть пока что мы просто понимаем что вот эти заявки Ну наверное Ок вместе повести как-то Осталось решить как нам надо построить маршрут и на наших объемах А я дальше покажу какие там объемы вот на наших объемах вполне работает Просто перебор вот здесь на рисунке опять пачка близких заявок и чиселками обозначены Ну расстояние просто для для наглядности и например нам нужно построить объединить заявку об с какой-то еще вот и мы можем по ходу еще какие-то проверять ограничения Ну то есть например мы не хотим строить объединять заявки больше чем подло вот нам из-за этого множества из трех заявок надо как-то построить выбрать две оптимальные чтобы оптимально их развести Ну никаких проблем лучше алгоритм на небольших объемах это перебор Стартуем с той точки с которой можно с точки А и дальше Просто строим дерево построили один слой тут на ребрах этого дерева написаны расстояния суммарные это дерево перебор или дерево или дерево поиска Одно и то же потом построили второй слой Из точки мы можем пойти в точку б а потом Из точки б мы можем пойти куда Ну вот либо в А3 либо 2 в точку бедва не можем потому что мы еще 22 не сходили да Ну короче вот так вот продолжаем строить какие-то вершины сразу можем отсечь потому что например Мы хотим Бачи длины 2 и если мы пойдем из точки А в точку А2 а потом в точку А3 Давайте отмотаю вот из точки А в точку 2 и потом в точку А3 то получится что может три заявки должны исполнить не хотим 3 хотим 2 по каким-то причинам Вот поэтому отбрасываем так до тех пор пока у нас дерево не закончится конечно Тут Я немного лукавлю тут Конечно есть всякого рода эвристики которые не позволяют этому дереву экспоненциально расти но лучше как-нибудь отдельно расскажу чтобы не перегружать вот а в целом вот объединение заявок она вот так в два этапа работает потом у нас есть важный шаг Довольно простой фильтрация Ну очевидно что нам у нас есть какая-то бизнес-логика какие-то маршруты мы считаем хорошим какие-то плохими то есть где-то слишком долго а где-то нормально Вот и нам нельзя делать плохие маршруты как Мы это можем понять ну можно маршруту приписать для маршрута посчитать какую-то метрику вот ну то есть например Сколько времени мы экономим на маршрутке то есть смотрите здесь заявок если мы их Независимо назначали да то тогда суммарное время потраченное курьерами на исполнение этих заявок было бы равно 63 + 3 опять же здесь уже на ребрах вот этого графа слева время нарисовано Вот а если мы объединим вот как показано на рисунке то окажется что для того чтобы пройти этот маршрут нужно меньшее время Ну и вот и как бы есть какая-то экономия это первое а второе мы сейчас посмотрим что для того чтобы достроить крафты конца нужно еще сходить во внешние сервисы какие-то И нам тоже нужно уметь контролировать нагрузку во внешние сервисы и как вариант как мы делаем мы Просто для каждого для каждой заявки оставляем какой-то топ маршрутов то есть не все рассматриваем не для всех вычисляем находим кандидатов вычисляем веса А для какого-то фиксированного количества и мы можем отсортировать и взять то по какой-то метрике например вот по той же самой которую я нарисовал вот а что же за внешние сервисы такие первый сервис это поиск кандидатов вот и это совсем отдельная большая штука которая живет в инфраструктуре Яндекс такси и знает про наших курьеров и рассказ про неё это еще один рассказ на highloady вот поэтому к счастью мы и пользуемся просто как сервисом Но это узкое место известная узкое место алгоритма и его можно оптимизировать как-то но в целом мы просто пользуемся поиском кандидатов как сервисом это супер удобно Вот с точки зрения там бизнес логики и всякого такого вот это супер удобно примерно очень упрощенно я вот описал какую-то процедуру поиска кандидатов когда мы рассматривали сразу вот самый первый кубик Да вот ну там Конечно все сильно сложнее сильно больше данных и так далее а вот второй внезапно это тот который веса назначает Хотя Казалось бы мы можем же в нашем Серви написать какую-то формулу которая по маршруту какой-то вес находит так вот оказывается что вот в этом скоринги то есть вот в этой развесовке живет такое большое количество бизнес логики и настолько непонятно как эти веса ставить что Пусть лучше этим занимаются наши аналитики но чтобы аналитики этим занимались сильно удобнее вынести это в отдельный сервис но тут есть риски один раз мы себе так вообще все сломали когда написали вот в этом месте неправильную форму но мы поняли как так не делать Больше так не делаем хорошо И последнее это собственно поиск оптимальных назначений то есть вот мы уже вот здесь достраиваем Граф до конца Вот теперь очень коротко как мы ищем оптимальное назначения нам вообще надо по полную задачу решить но она маленькая и поэтому мы можем себе позволить запустить как разные эвристики и выбрать лучшую из них вот я пишу одну из эвристика она называется венгерский сэндвич Почему венгерский Потому что если бы у нас не было вот этих сложных то задача бы решалась венгерским алгоритмом это известный очень старый алгоритм Но поскольку у нас есть Надо что-то придумывать поэтому мы делаем сэндвич то есть два запуска венгерских А между ними что-то Сейчас посмотрим что здесь пример вот такого гипергра который нам надо как-то оптимально назначить первый шаг это как бы первая половинка сэндвича то есть мы делаем выбрасываем все гипер ребра убираем всю сложность Составляем нормальный человеческий Граф и на нем ищем назначение венгерским алгоритм они вот такие получаются дальше Мы берем вот эти назначения И жадно просто жадно пытаемся строить назначить вот такие гипер ребра или Бачи Вот первый попробовали прекрасно подходит все выкидываем все с чем оно конфликтует вот попробуем второе нет второе гиперри по конфликтует с первым его не будем брать Вот и у нас получается мы выкинули ребро какое-то из назначения И вот то что мы выкинули выкинули мы только одиночные назначение вот бачей у нас то есть больше нет потому что мы жадно все попробовали остались только одиночные мы их до назначаем венгерский алгоритм опять же здесь это просто только одно ребро Ну все итоговые назначение вот такое просто объединяем вот такая еще раз взглянем супер коротко на алгоритм и какие-то ключевые моменты моменты вспомним то есть чтобы искать чтобы строить для занятых кандидатов надо просто их эффективно искать и все никак Ничего там особо умного нет Вот поэтому используем к этой дерево для этого чтобы объединять заявки тоже нужно использовать какую-то структуру данных поиска когда дерево Ну и маршрут просто будут Форс отлично работает дальше у нас есть какая-то бизнес логика и плюс контроль нагрузки и эта вещь Она капсулирована в каком-то конкретном месте что позволяет быстро менять логику и редко ломать потом мы ищем кандидатов потом мы назначаем веса ребра и там тоже куча бизнес логики которую легко сломать поэтому надо быть осторожным ну и наконец оптимальное назначение ищем какими-то эвристиками поверх известного известного в математике алгори вот Ну хорошо А собственно вот этот алгоритм он вообще что делает Может она ему делать ничего не нужно Ну вот сейчас он обрабатывает Ну я бы сказал больше 300 тысяч заявок в день вот здесь цифра 300 тысяч заявок в день она из официальной отчетности вот официальная отчетность была опубликована ну довольно давно сейчас просто больше но порядки Вот примерно такие и в Пике мы можем в одной операции обрабатывать примерно тысячу заявок Вот как то так соответственно поэтому у нас работает вот но при этом уже нужно следить за нагрузкой во внешние сервисы на итерацию мы можем себе позволить примерно 10 секунд примерно столько и тратим Вот то есть нам достаточно подумать 10 Ну то есть нам Ок подумать 10 секунд перед тем как сделать назначение Ну и сложность такого алгоритма получается потому что для каждой заявки условно мы ходим в индекс с такими же заявками вот сложность в среднем и за счет использования геоиндекса у нас алгоритм получается не квадратичный Что хорошо Вот вот я писал такую штуку большую тут и платформа есть какие-то алгоритмы Ну и вы наверное догадываетесь что что все это заработало Ну надо постараться да то есть надо чтобы все это настроить там вот я говорю какая-то бизнес логика скоринг как мы там все сломали Да вот как вообще что мы поняли из всего из всего этого как не ломать и как запускаться запускать такие умные алгоритмы относительно быстро с хорошим качеством первый тип выводов он будет про процессы а именно про процессы в исследованиях и разработке и Как водится мы знали как не надо то есть мы делали не с нуля А у нас уже был какой-то алгоритм тоже там тоже как бы платформа тоже для разных сервисов Но работала Ну не очень мягко скажем мы уже понимали Как не надо и поэтому мы смогли придумать как надо так вот то есть на основе предыдущего опыта мы могли переделать архитектуру все передумать и сделать правильно вот и в этом месте я хочу подсветить отличия между двумя такими штуками Вот иногда говорят там mvp какого-то продукта иногда прототип для себя я понял вот какую разницу прототип это когда уже понятно как делать Просто ты делаешь пять процентов или 10 процентов А вот mvp это когда непонятно как делать ты делаешь как-то понимаешь как надо Как не надо и Пи выбрасывается после этого Вот это вот прям супер важной и всем очень жалко это делать Да вот ну наверное многих такой опыт был когда что-то сделали оно как-то работает Ну и хочется это докрутить там до улучшать и так далее Вот иногда надо просто выбрасывать конечно еще важны Вы ранде супер гибкие эксперименты Я говорю что даже скоринг то есть мы позволили аналитикам писать на JavaScript на минуточку форму ки которые веса рассчитывают Вот и вот аналитиков к разработке есть определенные требования понятно что нужно дать аналитикам кучу ручек Но самое важное требование что аналитики должны понимать алгоритм и это требование к разработке вот ну очевидно что и аналитики тоже да но и к разработке то есть нужно свой алгоритм еще сделать так чтобы аналитики вы смогли понять Вот это прям супер важно и супер ускоряет Весь процесс про инфраструктуру ну здесь довольно простая у нас Задача в том смысле что у нас есть естественный шарнирование по географии Вот и мы им пользуемся и рекомендую всем пользоваться каким-то естественным шарниром довольно очевидно вот и что важно если алгоритм по какой-то причине может не справляться с нагрузкой то нужно заложить какой-то размен скорости на качество вот ну то есть у меня там было по контрольной нагрузка на внешние сервисы это вот оно ну и последняя супер коротко про алгоритмы если вам нужно какой-то умный алгоритм придумать то в первую очередь Посмотрите чем ваша задача отличается от какой-то общей вот Какие ваши задачи есть структурные особенности это позволит сильно Ищите в листики ищите что-то Что отличает Ну если у вас какая-то задача для которой решение неизвестно то вы можете найти Похожие и просто Пользуйтесь жадными в листиками все это сработает вот в общем-то у меня все спасибо Спасибо Сергей друзья Задайте вопросы Поднимите руки пожалуйста будьте добры вот Раз и два только фотограф Вадим уже дважды воспользовался вашей доставкой вот за время твоего выступления и как понравилось но когда вернется камера из ремонта тогда понравится конечно пожалуйста Привет Спасибо за доклад сколько заявок сутки Ну я могу по наш сказать здесь Было 300 тысяч Примерно вот поскольку у нас платформа не удалось согласовать цифру с едой лавкой К сожалению Ну вот такой алгоритм этого я писал типа сотни тысяч в день может обрабатывать И на самом деле может больше а пока вот столько Окей спасибо спасибо Следующий вопрос тут потом еще раз два три У нас есть четыре У нас есть немножко времени из лучше если можно встать пожалуйста да Еще раз спасибо за доклад А у меня такой вопрос а как вы вот эту всю инфраструктуру тестируете То есть у вас есть какой-то тестовое окружение какие-то заранее известные данные с руками посчитанному Или как это все происходит да Это хороший вопрос во-первых Да есть тестовое окружение когда просто создаются тестовые заявки и мы смотрим что с ними происходит есть понятное дело Юнит тесты есть такая супер крутая штука которая позволяет писать тесты на питоне очень такие гибкие очень сложные плюс еще у нас есть симулятор доставки мы реализовали имитационную Модель которая умеет запускать доставку прогонять все алгоритмы в каком-то упрощенной модели мира Вот и мы делаем несколько таких на синтетических или на реальных данных и смотрим как оно работает вот то есть сразу несколько Ну и конечно бы тесты спасибо Вот спасибо за доклад очень интересно насколько мне известно Яндекс сейчас объединяется с Delivery Планируется ли какой-то технологическое объединение алгоритмов не знаю других каких-то вещей с точки зрения архитектуры это тоже классный вопрос технологическое объединение какое-то будет но в нашей архитектуре в принципе поддержаны разные варианты того как можно было бы объединиться скажем так сейчас пытаюсь найти долго буду кликать Извините то место где что-нибудь осмысленное нарисовано смотрите есть разные варианты Как нам объединиться вот она картинка например что мы могли сделать просто вот алгоритмы написать как еще один прямоугольник здесь вот мы могли бы просто алгоритма занести в какой-то из какой-то из имеющихся планировщиков можно было бы какой-то комбинированный вариант иметь то есть основная проблема Ну точнее основной Челлендж Да скажем так он такой курьера Delivery Club Они же это Они получают зарплату там от кого-то Да к чему-то В общем как-то трудоустроено и тут еще вопрос финансовой юридический Как именно они будут дальше работать и от этого тоже зависит как мы будем их поддерживать но мы сможем в принципе любыми способами вот Спасибо вот смотрите там стажер из ВК руку тянет быстро второй ряд поясните два момента Вот первый момент как вы назначаете вес в графе на основании чего я не очень понял и второй момент почему для маршрутизану для определения кратчайшего маршрута не был использован dextra алгоритм Почему свой разработали Да почему свой начну со второго свой как бы свой самый простой Вот то есть чтобы он ищет между двумя конкретными точками да то есть если есть Граф и нужно найти конкретный маршрут между какими-то двумя точками можно использовать тексту у нас чуть-чуть другая задача то есть Нам нужно одновременно решить Какие заявки объединять и по какому маршруту вот это немножко немножко не то И как я сказал на наших объемах Мы просто не думаем берем используем потому что там же еще ограничения надо вот у меня было в примере что мы из трех заявок как как-то объединяем две Вот и как вот это надо Экспо переложить уже сложновато Поэтому пока просто Boot Force вот вопрос Как назначаются веса в графе это супер секретная бизнес логика не могу сказать А еще я не знаю но смысле вот это штука она ее делают аналитики То есть я примерно знаю как она работает но суть в чем Ну грубо говоря мы хотим сэкономить как можно больше времени на доставке вот чтобы наши курьер в итоге могли вывести большее количество заказов Примерно как то так Короче у них есть стратегии Они ее придерживаются Добрый день Вы упомянули в своем докладе о том как у вас отвалился скоринг и это все поломало я хотел спросить как вы такие выводы Вы из этого сделали как вы это будете предотвращать Как с точки зрения процессов Так возможно технических со стороны технических решений в будущем Спасибо Да если у нас отвалился скоринг что делать Прямо сейчас мы рисуем распределение скоринга Вот и по распределениям просто понимаем что корень работает адекватно или неадекватно Ну и пока Если честно все То есть у нас нет пока никакой автоматики которая это ловит и мы еще все-таки аналитиков иногда вот это тоже пока что помогает не падать Но тут еще есть куда расти и финальный вопрос на сейчас потом пойдем в кулуары пожалуйста Спасибо за доклад Подскажите на одном из этапов вы упомянули геошордирование на по городам не упирались ли вы в ситуацию что как бы на Москву приходится большая часть заказов и как бы шортирование перестает работать так как должно себя вести если уперлись то как бы как вы это решали Да конечно упирались конечно упирались и способов решения несколько один из способов это Москву как-то распилить напополам там же речка есть можно по речке Ну или примерно так вот мы этим способом пока не воспользовались это экстренный вариант скажем так пока что у нас узкое место в алгоритме это поиск кандидатов и вот на самом деле этот поиск кандидатов можно организовать так чтобы так вот достраивание кандидатов на этой схеме можно организовать так чтобы Чтобы поменьше упираться то есть чем идея что мы смотрите какая тут есть эвристика вот мы есть заявка где-то там на отшибе мы ищем для него кандидатов не находим ищем еще раз не находим еще в 10 раз не находим надо искать в 11 Ну наверное не надо можно как бы пропустить несколько итераций Да вот и такой нехитристикой Мы тоже пользуемся и сокращаем нагрузку Сергей спасибо большое тебе памятные призы от хайлоуида и скажи пожалуйста две пары носочков кому дарим одну и вторую За какие вопросы но мне понравился Про Delivery Club вопрос вот Отлично вот одна пара здесь так а еще и последний вопрос про шарнированию последний вопрос про шортирование и кому секретную сумочку черную дарим еще вот за третий вопрос третий вопрос Напомни какие были еще Нет ты эксперт Ладно ладно третий вопрос у нас был так но мне еще но на самом деле Хороший вопрос был про то как мы Тестируем потому что он прям вскрыл что-то что я не успел в доклад поместить вот отлично и тогда подходите Вы потестируете что там что там Газпромбанк положил сумочку Все спасибо красавец"
}