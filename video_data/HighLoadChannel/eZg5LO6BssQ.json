{
  "video_id": "eZg5LO6BssQ",
  "channel": "HighLoadChannel",
  "title": "Как мигрировать тысячи сервисов между любыми дистрибутивами Kubernetes / Максим Чудновский (СберТех)",
  "views": 567,
  "duration": 2487,
  "published": "2025-01-17T02:34:25-08:00",
  "text": "рад вас всех сегодня видеть будем говорить как обычно прор без лишних слов Давайте начинать смотрите пару слов обо мне соответственно Я работаю в сбертех врх я главный Пош я отвечаю за развитие этого продукта соответственно делаем мы сеш уже Достаточно давно это зрелое решение оно используется сотнями команд обслужит десятки рах Нару в дополнительно мы делаем много чего полезного интересного вокруг се как раз об этом будем сегодня говорить В общем Заходите к нам на Будет очень интересно там всегда есть что посмотреть Ну а сейчас давайте начинать ребят Включите таймер сейчас давайте начинать соответственно поговорим про тему доклада тема доклада у нас миграция приложений между разными кубер соответствено про эту миграцию будем говорить смотри У нас есть некоторая компания которая занимается разработкой инфраструктурного софта этого софта очень много она достаточно известна но её продукты К сожалению нам больше недоступны Давайте будем в рамках доклада называть эту компанию синяя шляпа и вот у синей шляпы один из продуктов называется открытый сдвиг открытый сдвиг - это дистрибутив кубернетес который Ну наполнен дополнительным слоем контроллеров операторов которые реализуют платформенную функциональность В общем такое законченное пользовательское решение которое Ну получила достаточно широкое распространение и мы хотим Ну в первую очередь мы хотим заменить открытый сдвиг от синей шляпы на какой-нибудь другой кубернетес и по большому счёту неважно какой А в докладе будем говорить про то что это просто ванильный кубернетес Но это может быть любое решение которое можно найти на рынке вот в нашей истории мы использовали дистрибутив кубернетес который называется Выбрось приложение Может быть кто-то знает Вот Но в сути своей кластер может быть любым В чём суть задачи смотрите открытый сдвиг обладает специализированным набором API соответственно для скели приложений Там могут использоваться deployment Config для управления Ире трафиком это РАУ соответственно для управления конфигурациями узлов это будут машин конфиги в общем там есть набор специализированных API которых в ванильном ку бенес нет И с этим нужно как-то работать при этом э синяя шляпа довольно давно нас покинула мы не получаем обновление и соответственно ванильный кубернетес его Стрим достаточно далеко ушёл вперёд и версии компонентов будут разные скорее всего мы в целевом кластере встретим Ну схожий набор платформенной функциональности а но версии будут разные и функциональность тоже на самом деле может быть разная она будет похожа но всё равно разная потому что где-то будет тот же сервис smh где-то его не будет соответственно где-то будут демоны которые обслуживают воркеры где-то их не будет И с этим нужно работать конкретно в моём случае история осложняется масштабом а открытый сдвиг достаточно стал достаточно популярен им пользуются сотни если не тысячи команд соответственно это тысячи сервисов десятки тысяч ямо файлов сотни кластеров и всё это желательно нужно мигрировать не инвазивным способом без боли для того чтобы никто не заметил подмены Ну ещё важный момент целевые кластеры они не такие как исходные То есть например у нас есть исходный кластер он очень большой в нём 300 машин соответственно о целевых кластерах будет Ну всего 10 и соответственно нам нужно приложение перенести таким образом чтобы они разместились уже в десяти кластерах на самом деле Исходя из этого анализа задача не выглядит как супер сложная и собственно Мы тоже так подумали и тут же рождается решение которое я назвал тривиальным В чём суть смотрите Есть такое мнение что кубернетес - это самая лучшая база данных для ямо файлов и по большому счёту мы решаем задачу Как перенести данные из одной базы данных в другую и так делают в общем-то Достаточно давно и подход Для этого называется etl extract transform laat что я имею в виду смотрите вот у нас есть релизный конвейер У нас есть Application какая-то машинерия cic CD которая доставляет наше приложение до целевого кластера А который его обслуживает нашем слу сеча целевой кластер это открытый сдвиг что мы можем сделать мы можем снять с этого кластера просто к этому бэкапа мы можем добавить некоторые правила трансформации чтобы ресурсы стали подходящий под целевой кластер и соответственно с чистой совестью загрузить это в новую базу данных то есть задеплоить в целевой кубернетес и задача будет решена это максимально тривиально и простое решение и выглядит как максимально работающее посмотрим в деталях соответственно для того стать данные из кубес можно воспользоваться просто консольной утилитой Её все знают соответственно мы просто полим API ресурсы которые доступны в кластере и потом по каждому API ресурсу достанем данные Ну и смм их куда-то на диск в итоге получим большую кучу я файлов эту кучу я файлов будем как-то обрабатывать обрабатывать очень просто ну в моём случае мы просто сделали на койда ма тривиальной логикой какой именно Ну смотрите вот один из примеров есть который используется в открытом сдвиге для того чтобы управлять входящим трафиком соответственно здесь есть все данные для этого в кубернетес есть аналог он называется Ире и соответственно Ну не тривиальная задача из Раута сделать Игрес просто переименовать некоторые поля потому что данных достаточно по аналогии можно поговорить про СН и соответственно трансформировать deployment config в deployment здесь очень интересная история потому что сотрудники компании синяя шляпа нашей вымышленный они достаточно много cont в Open Source имеют влияние на развитие Как кубернетес так и всего Cloud native Community И на самом деле деплоймент config который появился в открытом сдвиге стал прообразом деплой который потом появился в кубернетес поэтому здесь в общем-то вообще особо думать не надо оно практически одинаково Вот такой вклад ребята внесли за что им Спасибо есть Более сложный сценарий Когда у нас есть вот такая простыня из ямо которую читать сейчас не нужно соответственно Это пример фильтра Так мы тонко настраиваем сеш сеш в целевом кластере другой поэтому эту простыню яму нужно распарсить и потом поменять пару строк для того чтобы просто проайти версию и загрузить это на целевой кластер и собственно всё это вся трансформация которая нам нужна но есть один момент смотрите мы сняли п с кластера кубернетес провели трансформацию Ну пытаемся установить это в целевой точнее сняли бэкап с открытого сдвига трансформировались загрузить в кубернетес у нас не получилось Значит мы ошиблись трансформации чего-то переделали повторили ещё раз у нас получилось потом со временем кто-то что-то задеплоил в первый кластер у нас опять всё сломалось нам нужно понять где сломалось и повторить операцию ещё раз и этот подход он вот такой постоянный итеративный это важно потому что мы не можем с сказать что мы решили задачу миграции и все наши не целевые кластера все приложения оттуда перенесли в целевые кластера Ну и с точки зрения загрузки тут тоже всё тривиально все знают команду п пожалуйста У нас есть тысяча готовых ямо файлов новых мы просто загружаем в кубес если кубер если кластеров несколько то просто устанавливаем правильный контекст и всё задача решена собственно так и есть она решена Давайте подведём итоги Какие плюсы у этой реализации тривиальная и простая здесь нет никакой сложной логики или какого-то ноу-хау и что главное не не требуется участия команд разработки то есть авторов приложений мы их никак не трогаем они живут самостоятельно мы сами как-то перенесли приложение из старого кластера в новый это очень удобно но есть и минусы во-первых это разрыв релиз конвейера Ну то есть команды теперь с промо не работают они работают с вымышленным кластером который используется у нас для для рендеринга конфигураций и потом эти конфигурации что-то Ну куда-то загружаем соответственно выкатить какое-то обновление повторить весь этот путь это становится дорого И вдобавок нам всё равно нужен кластер который называется открытый сдвиг Да теперь это кластер поменьше и он нужен всего один по факту нужен его только управляющий слой для того чтобы рендерить ресурсы но он всё равно нужен он улыбается нам со слайда и кажется что задачу мы тривиальным способом не решили подумали мы и предложили следующее решение которое назвал оптимистичным решением идея очень простая смотрите никто не пло в кубер с сырыми ресурсами И просто текстовыми файлами все используют шаблонизатор и этих шаблонизатор там есть встроенный механизм шаблонизатор со всеми поработать то мы можем предложить новое решение которое я бы назвал трансляция шаблонов В чём суть позволю себе использовать свой любимый приём смотрите вот схема первого решения мой любимый приём в чём если мне не нравятся блоки на этой схеме я их просто удаляю давайте так и сделаем собственно удалили Теперь схема стала намного лучше но задачу не решает соответственно где-то нужно её решать мы делали Shift Left соответственно переносим всю магию про трансформации в наш релизный конвейер и модифицируем CCD таким образом чтобы он работал с шаблонами как-то их модифицировал и эти шаблоны уже разворачивались в правильный ямо файлы которые за деплоя на целевой кластер kubernetes как это можно сделать на самом деле очень просто с точки зрения подготовки данных мы можем использовать рендер который есть в шаблонизатор в случае home это будет команда Home template которая сгенерирует вам из шаблонов плоские ямо файлы с которыми можно работать в случае если это встроенный механизм открытого соответственно вас есть команда которая делает примерно тоже самое рые данные получили дальше их нужно как-то трансформировать соответственно первая трансформация произойдёт та что мы уже делали потому что мы уже ну набили руку У нас есть набор кейсов И мы преобразуем данные здесь Ну всё повторяется есть вторая трансформация которую я называю платформенная Она выглядит на самом деле точно также тоже консоль Уно ль бизнес логика и сейчас я объясню почему я говорил что в дистрибутиве кубер который называется открытый сдвиг есть очень много дополнительной платформенной функциональности например хуки которые что-то меняют в ранта и операторы и соответственно для того чтобы нам вот эти ресурсы всю эту логику повторить нам нужно сделать глубокий реинжиниринг платформы и повторить вот эти вот трансформации но в дизайн тайме в лизм конвейере для того чтобы информацию в целевые кластера примером такой функциональности могут быть хуки которые добавляют сети контексты на поды открытый сдвиг очень любит добавлять R Group делает он это из который ассоциирован см это очень полезный функциональность и её нужно повторить А с точки зрения операторов ещё хуже я взял простой вот здесь семь строчек это эти семь строчек и соответственно в реальности вот эти чево и так далее для того чтобы работала платформа функциональность и вс это нужно повторить зато если мы это повторяем то скоп у нас фиксированный потому что мы провели реинжиниринг платформы соответственно изменили повторили всю её логику И теперь нам больше нечего делать это очень сложно но есть важный нюанс чаще всего платформенной функциональностью не пользуются команды разработки структурная часть поэтому объём использования сильно ниже И поэтому это вс-таки реализуемо с точки зрения загрузки на кластер история точно такая же мы опять-таки получили готовый яму манифесты которые можем загрузить на кластер у нас получается команда тели и всё работает никакой сложности решили задачу сейчас решили задачу вроде бы как получше Давайте посмотрим что получилось вопервых больше не резного кон сист мылом в целевой кластер что очень хорошо и открытый сдвиг нам больше не улыбается его нет он нам не нужен То есть мы завершили миграцию полностью у нас в парке только целевые кластеры кубернетес но есть и минусы во-первых это очень высокая вартисть шаблонов мы не можем работать шаблонами нам нужны Рендеры и сложности реализации потому что глубокий открытого сдвига зада ста прямо со стопроцентной точностью то ещё и очень долгая Ну и самый важный фактор это это заключается в том что нам нужно модифицировать релизный конвейер команд понятно что команда может сделать это сама но когда счёт команд идёт на сотни и тысячи Это колоссальное количество труда часов а которое мы Ну не хотели бы потратить и Исходя из этого для того чтобы устранить этот гэп а появилось третье решение которое я назвал неожиданным смотрите Мы с вами уже знаем что открытый сдвиг изменяет ресурсы ратай через вебхуки операторы для того чтобы реализовать свою платформенную функциональность и что-то к вашему приложению добавить и подключить И на самом деле никто нам не запрещает повторить этот механизм И точно также в ран тайме все старые ямо манифесты модифицировать таким образом чтобы они стали пригодны для целевого кластера и просто развернулись в ванильном кубернетес а можем можем подумали мы а и нашли решение которое называется ю блаты вообще когда я говорю с кем-нибудь про ю блата мне задают чаще всего два вопроса во-первых Что это такое А во-вторых почему вы это так назвали начну с конца а назвали это исходя из слогана соответственно qbl - это кубернетес Лате и его основная задача - Это автоматизировать сложный сценарий использования кластера кубернетес для того чтобы человек который инженер который работает с кластером делал это простым понятным образом А в свободное время наслаждался чашечкой любимого напитка а что в сути своей представляет собой ты это policy Engine для кубес и вот когда я говорю чтоб - это poc Engine для кубес мне сразу задают третий вопрос Что такое policy Engine Давайте немного разберёмся поговорим Что это такое Я кратко затрагивал тему вебхуков и смотрите как это происходит когда вы деплоить что-то в кубернетес и сделаете команду п то прежде чем ваш ресурс сохранится в хранилище кластера в базе данных etcd его можно можно вмешаться в процесс обработки этого ресурса и как-то его либо проваливать либо мутировать это называется вебхуки их два типа и А сам механизм Амин контролеры соответственно мы можем вмешаться в этот процесс и каким-то образом на литу например изменять приходящие ресурсы для того чтобы всё работало из коробки собственно poc Engine это и делает это такой genic webhook сервер который принимает ADM реквесты от Cub API сервера А в ADM реквест говорит Уважаемый webhook Вот есть такой ресурс я его сейчас хочу сохранить и дальше будет он обрабатываться контроллером не хотел бы ты его как-нибудь изменить и соответственно mation менеджер говорит Да хотел на меня загружена такая-то политика меняет его добавляет Security контекст какие-то полномочия что-то убирает и отдаёт целевой ресурс соответственно чтобы это настраивала динамически прямо серве встраивается оператор который работает со своим набором crd в нашем случае это темплейты и триггеры и таким образом реализуется genic сценарий мутации если мы не хотим мутировать ресурс а хотим его просто проверить то есть следующий подход который называется validation в данном случае рве спрашивает Дорогой а можно ли сохранять ка ресурс вообще брать в обработку и дальше в зависимости от политики которую вы загрузили на Engine решение будет принято можно использовать этот ресурс или нет в нашем случае чтобы настроить это дело используется ресурс который мы называем скопами и третий момент это Creation или Generation это когда нам нужно по некоторому шаблону сгенерировать сразу пачку ресурсов кубес например есть какой-то типовой сценарий использования он требует пти файлов там config Map deploy и так далее мы можем нить его одним или вообще аннотацией и соответственно сильно упростить жизнь разработчикам для этого у нас тоже есть специальные crd и вот если мы переходим на полиси Engine то у наша архитектура решения тоже модифицируется смотрите первое решение тривиальное которое нам не очень понравилось потому что здесь был открытый сдвиг второе решение которое стало лучше но всё равно нам не понравилось потому что требуется модификация резного конвейера применяем мой любимый способ удаляем со схемы всё лишнее и получаем целевое решение которое нас Ну хочется верить на этот раз полностью удовлетворит и как-то станет эффективным подходом для решения подобного рода проблем поговорим про детали реализации такого решения соответственно всё что нам нужно это сделать политике мутации а используя шаблоны для мутации и триггеры - это события для наступления мутации и написать политики генерации те же самые шаблоны за исключением того что здесь ещё будет генерироваться как их писать И как мы их пишем соответственно первый момент - это темплейты темплейты как не сложно догадаться - это шаблоны всех целевых ресурсов они выглядят Вот так это может быть либо полностью яма манифест либо его часть которая будет использована потом для мутации либо для генерации можно сделать сложные сценарии добавить через поддержку го низации соответственно мы можем рендерить темплейт любой сложности на основании входящих параметров Ну в общем всех которые придут в исходном запросе дальше эти темплейты нужно как-то применить В правильной точке и правильную точку определяет ресурс который мы называем триггеры соответственно триггеры говорят нам когда мы должны запустить мутацию и на каких ресурсах в данном случае я хочу чтобы были замурованы все деплой ий которые приходят в кластер дополнительно к этому Триггер обеспечивает связь шаблона с точкой мутации соответственно Мы хотим применить именно такой шаблон или несколько шаблонов соответственно из этого нем спейса или из другого нем спейса и мы хотим здесь же задать стратегию применения этого шаблона Мы хотим зарей Сить исходный ресурс на наш шаблон или мы хотим как-то замёрз это или хотим Более сложный сценарий когда мы что-нибудь зарем и сде эффектом добавим дополнительные ресурсы а соответственно всё это здесь поддерживается едем дальше И это последний самый любимый мой ресурс он называется iger instance он мой любимый потому что он почти всегда выглядит вот так в нём не семь строчек а шесть вот содержательно из них только имя а соответственно это своеобразный э Триггер Но для ситуации когда у нас нет исходного ресурса то есть мы ничего не мутирует чему привязаться нет исходного деплоймент и так далее но мы хотим сгенерировать так Ага но мы хотим сгенерировать бандл конфигурации и в дальнейшем его использовать и ещё рир инстансы выступают своеобразными якорями для работы встроенной в кубернетес уборки мусора есть механизм он называется own reference соответственно у вас есть базовый ресурс вы его используете в качестве оура все дочерние которые вы Прив к нему Удалите основной ресурс ВС остальное удалится сработает уборка мусора и в общем и целом все останутся довольны Таким образом мы подходим к финалу нашего третьего решения которое Ну хочется верить Нам нравится у него есть очень много плюсов не разрывается релизный конвейер не требуются дополнительные кластеры ничего не надо модифицировать самое главное ВС это может быть доступно н где-нибудь в кластере но есть значимый минус нужен полиси менеджер такой как те про который я долго рассказывал его Нужно как-то настраивать А лучше ещё и разработать и это может стать проблемой для применения такого подхода и смотрите на самом деле очень часто в докладах на конференции так и происходит соответственно люди рассказывают про какую-то проблему про Том про свой опыт как они решили эту проблему соответственно можно взять либо идеи которые были использованы либо посмотреть что есть в опенсорс и как-то попытаться повторить эти идеи на оных продуктах мой доклад не исключение он в целом точно такой же но есть один важный нюанс чтобы вам было проще мы выложили qbl в Open Source Вот и соответственно ты доступен на площадке gw Вы можете это использовать э для всех своих сценариев Вы можете повторить сценарий миграции Вы можете придумать свои собственные сценарии В общем заходите на gw есть Community Edition она там давно она полностью доступна для использования А как ещё её можно использовать как мы это делаем смотрите во-первых мы реализуем шаблон generic Site Car Injector соответственно очень часто по этому шаблону реализуется платформенная функциональность Мы хотим добавить контейнер для журналированием на сопровождение А в эту же историю идёт с автоматизация типовых сценариев использования я взял примерно сервис smh Аа В чём суть Например у нас есть 100 команд и для 100 команд есть требование трафик приложение должен покидать кластер через специальный компонент который называется IG S Gateway выходной шлюз соответственно для этого нужно сделать 10 конфигурации на ISO и если есть policy медр можно повесить одну аннотацию и все эти конфигурации сгенерирует автоматически соответственно это нравится всем это нравится разработчику потому что нужна аннотация это нравится там девопсу или Асе потому что не нужно проверять каждое приложение можно проверить только политику и соответственно всё сработает Ну помимо инжекта таких сценарий можно инжектить тве и централизованно управлять ратинген наших подов разработчика об этом думать не должен владелец кластера об этом может подумать Потому что у него может быть гетерогенный кластер с разными узлами этим нужно как-то управлять и можно управлять через политику можно генерировать Network polic например вы создали mspace и сразу закрыли к нему сетевой доступ по дефолту и к нему и из него для того чтобы это было безопаснее потом открываете всё это настраивается через политику и собственно например автоматическая локация ресурсов создали Найс и к нему сразу же создаётся ресурс квота чтобы не выпасть границы всё это сценарии которые доступны на policy менеджер и основная идея которую я хочу сейчас донести что на самом деле этих сценариев ещё очень много вот они ограничиваются только нашим опытом и по большому счёту нашей фантазией поэтому обязательно заходите на ТВР Заходите в репозитории ты создавайте ises делитесь вашими идеями Предлагайте что-то новое и всё это будет добавлено потому что ну технологии без людей не живут и соответственно для того чтобы жил policy менеджер нужно непосредственно ваше участие а мы тем самым Подходим к финальной части доклада и начинаем подводить итоги смотрите первый тезис миграция - это сложно и это достаточно очевидный тезис потому что к любой задаче нужно подходить так как будто она сложная Потому что всегда и вот мы из примера увидели что тривиальное решение не подошло оптимистично не подошло потому что скрылись подводные камни Поэтому нужно осознанно подходить задаче и выбирать правильное средство для её решения желательно анализировать то что происходит а во-вторых Конкретно задача миграции прекрасно решает полиси Engine и он доступен в Open Source его можно использовать прямо сегодня принести в свой кластер и сделать своему кластеру хорошо Ну и конечно есть очень много других сценариев для использования policy Engine которые вам доступны которые вы можете принести в свои кластера берите и пользуйтесь на этом У меня всё спасибо большое за ваше внимание голосуйте за доклад задавайте вопросы буду рад И у нас 20 минут на вопросы а Берегите мне хелперов да спасибо Максим за доклад очень интересно Скажите пожалуйста а ну вот когда на всё это смотришь вспоминается сразу вот прямо каверны вот первое что в голову приходит Почему не взять как бы каверны и немножко его не повернуть зачем писать вот прям новый инструмент и повторять мем из xcd Вот который про стандарт да Это хороший вопрос смотрите на него есть хороший ответ когда Мы начинали проект лата кивер просто был недостаточно зрелый под нашей задачей не подходил Исходя из этого получился наш собственный полиси менеджер А впоследствии его развитие обусловлено тем что мы сейчас полностью владеем коном Мы полностью владеем Ну как бы вектором его развития соответственно хорошо адаптируем под наши задачи Поэтому нам выгодно инвестировать именно в этот проект при этом мы как технологическая компания очень хотим держаться Ну делиться наработками с коммьюнити поэтому мы выкладываем в это Open Source Можно ли повторить те же самые приёмы которые я писал в докладе на кивер э Да можно Некоторые из них будут не такие изящные где-то придётся сильно повозиться Но в общем и целом Да как бы у вас это получится и это на самом деле хорошо потому что есть разные решения они конкурируют друг с другом и как это становятся драйверами для развития друг друга потому что если сравнить с функциональной точкой зрение то что-то есть в КБ Чего нет в кивер но что-то есть в кивер Чего нет в КБ но в скором времени там например добавится или не добавится вообще в общем здорово когда есть выбор Спасибо пожалуйста Да у меня вот возник вопрос про то как тепер поживают разработчики они получаются Встань пожалуйста мы теку покажем Окей как теперь поживают разработчики они пишут деплоймент под открытый сдвиг или всё-таки вы планируете перейти на какие-то специфические ли кубернетес штуки и не видите ли в этом проблему не консистентность то есть где-то проекты на старом стеке А где-то на новом Да хороший вопрос смотри разработчикам доступ доступные инструменты миграции как сервис соответственно они ну заходят на портал заказывают себе кластер У них есть кнопочка для того чтобы появился инструмент миграции кластер прикинулся открытым сдвигом и дистрибутив прямо без изменений туда зашёл То есть можно на этом ограничиться и не делать ничего но понятно что в как бы в масштабе вот этого вот большого процесса по переходу на новое Решение вот всё равно рано или поздно придётся Ну как бы исходный шаблон под открытый сдвиг переписать потому что ну держать его бесконечно не нужно но здесь политика очень простая если приложение живо оно развивается дорабатывается выходят новые фичи то Дописать этот шаблон не проблема ребята сразу это сделают и собственно это не будет боль Ну как бы не будет стоить дорого а если приложение Ну не так динамично развивается и стоимость изменений в нём многократно превышает пользу от работы этого приложения в ран тайме то можно ставить всё как есть и дать ему спокойно умереть при этом решив задачу по переезду с открытого сдвига спасибо Вот буд добры Здравствуйте Большое спасибо за доклад и за Кубла Мне кажется что мы его обязательно используем У меня вопрос Ну такой прикладной совсем просто ситуация была у нас такая хотел спросить вы вроде уточнили про создание нескольких ресурсов ситуация была такая у нас там есть объект который управляет там десятком каким-то ресурсов то есть один ко многим связь и нам надо было мигрировать это в один к одному связь то есть создать десяток управляемы управляющих объектов позволит ли такое сделать Кубла Да конечно там Можно настраивать и делать любую связь но собственно У вас есть Якорь это тгр instance который служит точкой для генерации произвольного количества ресурсов и Связь может быть один к одному или один ко многим пожалуйста а дальше собственно этот trier instance вы просто ну либо используете как есть и тогда ты становятся некоторым аналогом на самом деле обычного кубового оператора Либо вы можете подвязать это ну к триггеру и например чтобы эта штука срабатывала в момент мутации Вот пример который я приходил к нам приходит ресурс он называется Ro соответственно UB API его получает Вот и дальше нам нужно сделать и мы же не можем замуровать Да потому что это другой ресурс нам надо новый сделать именно поэтому есть механика сайд эффекта когда мы просто вместо того чтобы мутировать Ro мы создаём trier instance и получается ИС Аро сохраняется как есть но в кубернетес нет оператора или контроллера который этот роут обработает и он остаётся просто как якорь для того чтобы была вся цепочка Ну и там прямо видно что к нему всё подвязать параллельны земле и не дальше чем 2 см от лица Ладно я понимаю что это не так сложно как ку но вс-таки вот Спасибо за доклад хотел бы спросить следующее у нас получится всеми тремя способами мигрировать Когда у нас сильно меняется инфраструктура То есть когда мы например хотим приехать из облачного решения в на прямо железные сервера Ну я понял От смотри короткий ответ конечно Ну в случае там виртуальной или метой инфраструктуры Cub API будет выглядеть одинаково Но если у вас меняется UB API и у вас там какие-то разные сценарии динамические меняется окружение и так далее То тогда policy медр это прямо лучший сценарий для миграции потому что вы реализуете ну некоторую слабую связанность по API Да вот у вас разработчик использует кубовый API пишет там de и так далее а дальше вы отвязывается это от реального кластера добавляете Ну некоторые посредник в виде кю блаты и он приводит это к целевому состоянию и поэтому вы можете менять реализацию как угодно изменяя только шаблон это максимально удобно понял Спасибо пожалуйста прямо под краном смотри Дада Всем привет Меня зовут Владимир и собственно у меня такой достаточно прагматичный вопрос а начну чуть-чуть издалека предположим у нас есть кластер и у нас крутится там тысяча наших сервисов да то есть тысяча команд которые работают в этом кластере и вот у каждой команды условно по своему сервису микросервис или чему-то такому значения большого не имеет а и собственно говоря нам нужно всё это добро как-то замиг пусть будет даже 10.000 этих самых сервисов мой вопрос такой не дешевле ли с точки зрения времени и с точки зрения сил отдать это всё действительно командам на то чтобы они это замиг объясню свою идею если у вас порядка 10.000 сервисов и нет какого-то условного паса шаблонизатор Жалко а это первый момент да А и нужно понимать что в этой концепции мне достаточно сделать пачку изменений в мой условный пас или в мою условную там шаблонизатор когда они это захотят просто возьмёт и уедет в продакшн да И они автоматически переедут на Новый сервис собственно вопрос А сколько времени вы потратили на то чтобы написать решение прекрасный вопрос смотрите с точки зрения не дешевле ли отдать это командам а отдать командам действительно Можно но вот представьте себе 10.000 сервисов Давайте возьмём Ну такой простой коэффициент амплификации скажем что один сервис - это 10 ямо файлов 10.000 сервисов - это 100.000 ямо файлов вот эти 100.000 ямо файлов написаны 1000 человек и прийти к 1000 человек сказать ребята поправьте 100.000 Вот можно но я бы назвал это решение в стилистике доклада бесстрашным Вот потому что явно люди будут не в восторге от этого но с точки зрения компании это затраты с точки зрения разработки этого решения ответ такой А мы на самом деле делали его не для этого мы решали свои задачи и неожиданным образом поняли что для решения задачи миграции Он подходит поэтому решение задачи миграции через ты не стоило ничего только написанием одного человека поэтому намного проще но тем не менее я файл который Ну то есть этот инструмент яфа всё равно придётся закоммитить во все эти 10.000 репозиториев чтобы ну случилось чудо Ну то есть если мы всё равно делаем изменения в этих деся репозиториев и ну приглашаем команды к диалогу к изменениям в этих репозитория вопрос А зачем они могут Просто сесть и смири на ванильный кубер то есть мы Превращаем кластер кубес с точки зрения его API в открытый сдвиг то есть команда когда работает с кластером она думает что это открытый сдвиг Ну то есть все API группы все ресурсы доступны они создаются Вот только потом они трансформируются в целевой набор ресурсов уже под cuber для того чтобы сработали встроенные в cuber контроллеры и операторы соответственно команде не нужно ничего коменти не нужно ничего делать А дальше срабатывает сценарий про который я говорил приложение конда это поправит конечно Ну мы решили задачу миграции не завязывая на релизный цикл команды они выпустят релиз когда-нибудь когда они захотят я сес глубоко убеждён что это правильно что хотят Пускай то и делают это их приложение Вот соответственно они когда-нибудь выпустят релиз поправят заедут на кубернетес им эта машинерия будет не нужна она даже Не сработает Вот а если например команды нет приложения осталось приложение написано в 2018 году лучше его не трогать вот вообще никогда кейс бывают соответственно вот этот технологический долг но он просто будет автоматически забор на новую технологию Да ну с нулевыми затратами Не нужно искать команду под это дело в этом плюс Да а второй мой вопрос а как же и мы все так страдаем за иму infr но при этом этим решением мы берём и разрушаем её Да вот это ещё лучши вопрос действительно Это нарушает подход но с точки зрения того Как вы работаете с Cub API этот подход он в принципе никогда не выполняется потому что вы увидите что когда вы берёте какой-нибудь деплоймент или какой-нибудь ну другой API ресурс Вот вы просто описываете состояние кластера в декларативного виде и кластер его задача очень простая он смотрит Что вы хотите и приводит своё состояние к тому чего вы хотите а приводит он это к состоянию через набор контроллеров а они управляются через свои API группы через свои ресурсы и они всегда там генерируется то есть это прямо в дизайн коде кубера так записано Поэтому в данном случае это не нарушается но мы позволяем себе такие фокусы только с API ресурсами которые доступны в кубес То есть это de serv Ну и все другие это не касается конфигурации самого приложения потому что Да она должна быть UT и здесь как бы можно но не нужно это будет антипаттерн да спасибо большое за ответы Спасибо Ты знаешь Я когда слышу в начале вопросы слово предположим Мне кажется что я опять на собеседовании где-то вот Ну ничего нормально Да пожалуйста Добрый день Спасибо большое за доклад у меня такой вопрос из области практики вот когда вы всё это внедряли Расскажите про ваш опыт какие были какие-то проблемы То есть огромное количество команд огромное количество трансформаций Ну как-то Слабо верится что всё прямо прошло безшовна идеально да А спасибо за вопрос Мы применили очень очень хитрый сценарий не стали мучить команды и говорить им чтобы они меняли свой релизный процесс и что-то делали мы просто добавили новую возможность и сказали ребята есть классный тол Пользуйтесь чтобы использовать Вот это сейчас вот э можно при заказе кластера просто поставить галочку и всё установится само собой То есть это полностью управляемый сервис то есть от команды не нужно ничего для того чтобы это использовать Ну и как я считаю это основной залог успеха к апше потому что ну как бы ноль ресурсов штука вроде бы полезная почему бы и не нет а вот чтобы сделать такую галочку сделать её доступной для всех команд это конечно потребовало определённых усилий определённых согласований Потому что есть множество действительно вопросов и с точки зрения релиз конвейера и вопросы про ю configuration Вот который сейчас задали и по безопасности потому что там могут быть расширенные полномочия и так далее но мы это решили Ну действительно как бы долгим процессом там валидации исходных кодов ло инсталляции соответственно в наших управляемых сервисах используется не просто полиси менеджер А два полиси менеджера один контролирует другой для того чтобы пофиксить ну некоторую узость р баков кубернетес Вот и за счёт этого Как бы мы устранили технические гэпы Ну и теперь главный вопрос к тебе Кому мы подарим матрёшку за вклад в сообщество вопросом и кому сувенир Отт dig ребята Поднимите руки кто поднимал вопросы махни рукой Кто спрашивал мне понравился вопрос про есть матрёшка значит будет матрёшка за вклад сообщества пому я хотел сразу после вопроса отдать но пос это твоё решение Я решил не лезть Да вот молодой человек в бежевом матрёшка идёт с подарок идт за внедрение потому это очень важно внедрять технологии чтобы они были доступны последний вопрос последний вопрос Да а у тебя уже есть ам за подарок Да хочешь второй готов отлично Одень студента вот пусть делает ви что он ходил на Хаде кстати супе история Я заметил тут как-то один один чел просто подошёл можно сфотографироваться и потом я увидел у него вреде он просто сфоткался здесь засто я Напа Спасибо тебе большое мы переписывались тут с коллегами по поводу того как ты говоришь когда ты дышишь Потому что ты говоришь говоришь говоришь говоришь и не слышно на хорошей скорости я дышу заранее до доклада и немножко после учитесь тебе тоже мерч конференции Спасибо большое за доклад ребята Спасибо за вопросы"
}