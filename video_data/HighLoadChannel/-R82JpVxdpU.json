{
  "video_id": "-R82JpVxdpU",
  "channel": "HighLoadChannel",
  "title": "Аспектно-ориентированное программирование в PHP / Сергей Лебедев (VK)",
  "views": 117,
  "duration": 2007,
  "published": "2023-10-06T07:16:57-07:00",
  "text": "Всем привет Меня зовут Сергей Лебедев Я работаю в компании VK старшим бэнд разработчикам и свободно от работы время интересуюсь теоретическим концептом программирования равными парадигмами и пробую их на практике именно такой доклад У меня сегодня будет мы поговорим об аспектно-ориентированном программирования на нашем любимом PHP рассмотрим его теоретический концепция которая его можно практически применить сначала подумаем отпек наверное программирование звучит заморочено но может быть мы уже где-то в быту С ним встречались в своем разработчикам быту и я думаю те из вас Кто работает в симфоне видели такие конструкции аннотация в коде позволяющие проверять валидировать или позволяющий проверять права доступа к какому-то методу те же кто перешел на печке 8 возможно в этой роли видели атрибутов PHP это аннотация атрибуты метки показывающих Где вставляется опектно-ориентированное программирование добавляете какую-то сквозную функционал возможно По всей программе не очень касающиеся основного но тем не менее нужно и как более-менее понятно что это такое Что она добавит коду Но что у него под капотом как оно появилось Как придумали такое начнем начнем с историей давным-давно когда компьютеры были большие память у них была маленькая программисты были такие же ленивые как и сейчас и они не любили писать Одно и то же много раз и они придумали макросы когда они описывали в одном месте что-то логирование например и дальше меткость вставляли отмечали то место где будет этот макроставлен развернут каким-то при процессором и далее готовой программе он будет Вот пример макроса 60 а вот для древнего языка программирования пел 1 дальше появился язык те наверняка кто-то из вас писал на те и знает кто там тоже есть макросы они более продвинутые при процессор более продвинутый и принципе делает тоже самое вставляет какой-то функционал код программы еще там есть Прагма которым можно коду тоже навешивать дополнительные какие-то свойства сквозной функционал дополнительно и по сути макросы праздно Аналогично аннотациям атрибутом этой информации которая что-то добавляет коду и дальше появилась объект на ориентированное программирование где было неудобно макросы какие-то разворачивать где-то можно было их забыть убрать где-то можно было добыть добавить и люди стали думать как это делать дело автоматизировать и одна из первых концепций как это сделать было адаптивный объект на ориентированное программирование когда программист описывал объекты какой-то сквозной функционал между ними описывал связи и из этого генерировать программа которая потом компилировал все это содержало и Вот пример иерархии объектов такой программе кем она только понятная простату нельзя обойтись без вот этого Мема следующая концепция кстати Внизу там идут ссылки на оригинальную работу где были предложены концепции кому интересно посмотрите следующее Концепция это программирование Мета уровне то в своей основе хорошо знакомая нам кодогенерация Все очень просто есть код программа когда кто-то добавляет и генерируете код реагирующий программа компилируется и что-то нужно там есть дальше уже решили вставлять дополнительный функционал wrantime это были композиции фильтров то есть втулки которые на входе перехватывали вызов объектов и могли как-то взаимодействовать входными параметрами или выходными и Тема тут Вот пример работы схема работы такой штуки И она тоже будет фантазия и наконец субъект на ориентированную программирования только интересно потому что там был предложен подход когда объект своей сути определен который что-то делает но для работы другими объектами он предоставлял различные интерфейсы от пекта именно деть появилась слова аспекты и обозначало оно других взаимодействующих объектов на это и наглядный пример этого дерева на который птицы смотрит свои колокольня Можно ли там построить гнездо если там еда Дровосек смотрит насколько трудно отрубить насколько она твердая Сколько денег ему дадут за него и бухгалтер который считает Сколько кубометров дерева привезли как оно стоит и что такое и Вот пример иерархии интерфейсов такого объекта то есть внутри он один и тот же по сути но иерархия интерфейсов для каждого взаимодействия с ним С ним объектов вернее субъекты какая и посмотреть посмотрев на все это центры исследователь центре ксерокс далее строит свою концепцию добавление откровного функционала свободно от недостатков прочих вообще тантрик червь придумали Много чего хорошего чем мы пользуемся сейчас это edernet лазерный принтер персональный компьютер компьютерная мышь планшетный компьютер график интерфейс и даже сама объект ориентирована программирование там я отвлекся вернёмся к аспектам ориентированному программированию Итак предложили выделить следующий концепции Это ответ то что мы выделяем в отдельно Аспект сквозной функционал который мы выделяем отдельно от пят логирование например кеширование и подобные вещи это адвайф реализация этого аспекта и как она добавляется до вызова оригинального метода после до и после там были еще нюансы то после успешного возвращения только она сработает или после возвращения с ошибкой дальше точечное применение аспектов применение аспектов множество точек ставки аспектов например по регулярным выражению название метода или класса это прям реально автоматизировало ещё у них был живет только под названием вивер Ну погодите веер если кто-то играл в игру Dota 2 Там есть вивер Причем он здесь нет Dota 2 дети не причем Ява здесь причем Дело в том что вы разработав все эти концепции их тут же реализовали в виде библиотеки для называемая и главный компонент этой братека была компонент управляющий год аспектов код программы переплетающих как бы еще до этапа выполнения программы его назвали вивером то есть кач он как бы плен структуру плита воединоволокна и как я говорил они свою концепты реализовали библиотеки и так как не зла Может быть но все же корпорация Они тут же запатентовали все эти концепции сама библиотеку даже название разработка программного обеспечения он там у меня есть ссылка на патент И теперь когда мы увидели как в оригинале было предложено ориентированное программирование подумаем как его принципе можно реализовать для какой-то программы программа проходит этапы какое-то предобородке при процессинга дальше компиляция и дальше выполнение и на всех этих этапах можно вставлять дополнительный функционал аспекта и принципе так и есть варианты реализации во время компиляции интерпретации и перехват выдала Фронтайм можно на низком уровне это делать виртуальной машины предложение можно делать на уровне и из этих методов там и правильно вставлять до компиляции или во время компиляцию потому что тогда при исполнении программы уже имеет сеть аспекты в тебе и во-первых это не влияет на его производительность во-вторых выдает каких-то странных ошибок в рантайм теперь посмотрим что у нас как у нас в принципе можно реализовать печки все это а в общем также коды генерации при компиляции перехватывать на уровне виртуальной машины вызова метр перехватывать на уровне века тут как раз средством языке есть магические методы события какие-то И теперь когда мы поговорили посмотрим что практического Как какие библиотеки чувствуют для PSP расширения ориентированным программированию начнем это расширение начнём мы вернее с этого класса подопытного кролика которым мы будем применять аспекты это какой-то счет клиента где у нас есть можно положить на него деньги снять деньги и блокировать счет и мы допустим хотим логировать вызов всех трех методов а при блокировании счета сначала проверять является ли пользователь администратором имеющим право блокирует счет и вот наш класс без применения аспектов мы добавили все о чем я говорил и Кролик у нас получается какой-то развесистый поэтому мы обломаем ему рога вернем клад чистое состояние и будем применять к нему от перца первое библиотека расширение вернее с которой Аспект Она появилась 2007 году представлял собой Даже скорее компилятор потому что отдельная компилятор там были реализованы все сущности включая viving плетение кода программ программа основная программа аспектов и было реализована за счет своего компилятора который при процессорах который все это дело вот из оригинальных работ о нем к сожалению это библиотека быстро устарела и сейчас не используется уже не используется вот так выглядел код на ней я специально оставил так PHP чтобы было понятно кто это именно печку Я никакой другой язык как мы видим она добавляет свои ключевые слова печь перспектов и здесь мы определяем Аспект сначала потом под вечным коде реализуем его и дальше указываем подсвеченным кодек где мы вставляем и пополнить счет и вот такая программа в результате у нас получается и заметьте оригинальный вклад подопытный кролик мы вообще никоим образом не трогаем все делалось до нас дополнительный функционал уже там следующее это расширение печь именно опыт PHP и она интересна только тем кто тоже одна из первых реализации аспектов PHP работала фронтальной вот так можно было добавлять там аспекты то есть мы добавляем здесь проверку доступа к методу и дальше показываем где он применяется подсвеченным коде методы блокирования аккаунта следующие идут уже расширение они изначально написаны для тестирования позволяют подменять классы за счет этого на них можно реализовать велосипед на Аспект на ориентированное программирования подменяя оригинально класс и дело новость таким же названием сначала делающий свой аспектные дела первый эти расширения рамки Вот так бы мог выглядеть велосипедно аспекты на нём то есть мы переименовываем оригинальный метр добавляем другой таким же названием который потом вызывает оригинально и на этом ранхите было реализовано аспектная библиотека который было все что нужно для аспектного программирования код на ней выглядел Вот так вот тут точка ставки аспекта помечается аннотациями написала некий тибактям Берман Кто у нас сегодня правильно автор печеник Я подозреваю именно на аспектах он написал это когда был студентом так хорошо подменяет классы радость следующее расширение опдз оно используется сейчас в основном для тестирования на нем тоже можно на велосипеде аффекта вот так но тут это мы перехватываем именно вызов метров классов хуками вверху определение Кто будет добавлено а внизу перехват собственно выдаст методов И теперь мы наконец Великий и Ужасный потому что используют интерфейс доступа к функциям написанных на других языках программирования структурам а во-вторых написал Александр лисаченков входящих комитет программный комитет пираша Что достойно восхищения для Комитета и для человека успевающего все это вот так выглядит добавление аспектов помощью рефлексия заметьте оригинальный метод я тут не вызываю Дело в том что библиотека настолько низкого уровня что после подмена оригинального класса Она уже не имеет к нему доступ Так это проведено для интересно И теперь мы перейдем к фреймворку где есть оттек на ориентированном программировании там это реализовано на уровне языка и Первый из них это летим он древний Но тогда там уже было AP назывался фильтрами то отсылает нам первоначально вот одно из первых идей композиции фильтров которые мы смотрели выше но он уже устарел не используется следующее фреймворкете он идет как довесок как база для cms под названием чисто рабочий инструмент для неё Зато там тоже есть аспекты здесь они следующий еще для тимпоня второго был банда позволяющий использовать аспекта и там он работал в ранг тайме и там был матча то есть штука позволяющая применять аспекты по регулярным выражениям вставлять и вот здесь пример такого матча вверху то есть мы метр вставляем аспекты В класс аккаунт вставляем вас те методы потому что матч метров возвращать всегда трюк Они же реализация опять же мы не трогаем изначально наш класс подопытный кролик И следующий фреймворк называется потому что китайский и сама актуальная документация в нем на китайском вы там тоже есть матчах Но для пометки точек ставки аспектов он использует уже атрибуты вот так выглядит кот на нем но здесь я показал множество точек для вставка Здесь тоже матча любой метод любого класса он интересен он синхронный асинхронный и тут тоже есть аспекта но я это тоже погонял потому что я синхронный печки пока не использую когда буду попробую этот фреймворк обязательно работает в runtime и правда только помним не очень хорошо и наконец Великий и Ужасный Гоа п великим потому что написал все тот же Александр лисаченко а на самом деле Великий потому что там есть все что нужно для аспектно-ориентированного программирование включая плетение аспектов программы до и этапы его выполнения реализовано это дочерь Каширы через кэширование классов и паркинг из кэша фреймворка так смотрит лежачий в кэше класс содержит себе аспекты или не содержит Если нет то он переименовывает этот класс кэша и делает другой аспектами вызывающими оригинальные и тоже кладет его в кэш и дальше все работает уже кот и аспектов и программу уже есть кэш и не надо его гонять фронтально проверять перехватывать что-либо Это очень хорошо считаешь самым лучшим подход хорошо там есть адаптеры для тех популярных языков программирования адаптеры для них для этих трех лент не самый сейчас популярны но тимфани ларовал с нами их легко подключить к ним легко подключить атспектор И вот так выглядит пример аспектов на нем мы применяем здесь помощью аннотации показываем где мы вставляем Аспект реализуем его Ведь это логирование И теперь когда мы рассмотрели PHP для аспектов я хотел поделиться своим путем хождения в эту тему Сначала ну увлекся простите начал я когда-то я писал на яве там уже есть аспекты в виде аннотации библиотеки я вас prink это очень нравилось Я с удовольствием их использовал потом я перешел на PHP увидел там тоже есть аннотация использовал их потом не стал Интересно как это устроено под капотом я стал писать велосипеда чтобы вставлять аспекты код программы и они работают коды генерации с помощью кода генерации во время одного такого написания одного такого велосипедов я понял Каково приходится разработчикам подобных библиотек копающих тому ткань языка толкнулся таким интересным глюком PHP просто тал падать кордом на каком ты чёткий программа дальше изолировал о чем он падает нашел такую выделил вот такой фрагмент программы это приглядеться можно увидеть пропущен ошибка падает куда Я отдал отдельно допускать этот кусок программы при тех же условиях Как мне казалось он не падал печки выдавал ошибку покопавший дальше на шорт его фреймворке еще был вот такой фрагмент перехватывающий ошибку выдающий второе отключение бросающий в нем И вот это уже принципе не смог перенести двойное исключение ему оказалось не по телом история закончилась благополучно я заре портер за репорт Дори портил это разработчиком PHP они это исправили и дальше она шел уже гол п Она мне понравилась я сейчас использую его в своих хобби проектах на работе к сожалению не перешли и попробовал все это я выработал свои правила для хорошего опектно-ориентирована реализации Аспект на ориентированного программирования это она должна поддерживать Понятно нужные версии PHP она должна поддерживать нужно фреймвор поддерживать автором значит Через год она не будет поддерживать первые два пункта обязательно Там должно быть реализовано добавление аспектов код программы до этапы его выполнения они перехват какой-то вронг тайны должна быть возможность работать по множеством точек точек вставлять аспекты добавлять аспекты до метода после до и после это не везде гейт и должен быть доступ параметрам выдала метра и к тому что метод возвращает про параметры вызова Я за то чтобы это было редон ли доступа потому что иначе можно творить дичь подменяя параметры на лету творят странные вещи и в идеале оно хорошо чтобы она поддерживалась выдел чтобы можно было ткнуть на аннотации она показала где реализован этот аспект это очень удобно И теперь мы посмотрим как применяется Аспект на ориентированное программирование в реальных проектах как применять его это наверное самый вкусный радио потому что При правильном применении аоp ничего Сверхъестественного мы не делаем мы просто выделяем Аспект логирование кэширования защиты реализуем его смотрим где этот Аспект применяется в программе если таких мест мало Мы применяем точно если много то множество точек в результате Все работает хорошо мы немного поработали Нет не вставляли аспекты отдельно каждый раз код программы и Вот пример на ап точном применением здесь как раз используется аннотации Обратите внимание здесь точечное применение важно потому что это кэширование акуширование Нельзя оставлять вообще где угодно второй интересный момент оно применяется до и после вызываемого метода потому что она смотрит вызывалось ли этот метод уже такими параметрами если вызывал кто-то берёт результат Если нет то сначала оригинальный метод получает ее результат и Вот пример с множеством точек на том же голову п Но это пример мы раньше видели и типичные аспекты для которых применяются аспектно-ориентированное программирование это логирование кэширование добавление транзакций данных каком-то запросу профилирования контроль доступа защита программное обеспечение которое должно быть нормально По всей программе в идеале чтобы трудно было ее выцепить обработка ошибок и шутка над коллегами представьте себе мы напишем опек который подменяет возвращаемый параметр или входящих метод параметра и легко тогда получится два равно 5 коллега будет очень доволен которому это подшиваем и аспекты не подходят для модификации основного функционала Не надо так делать подмена получаемых возвращаемых значений и конфликтующих между собой аспектов в каком бы порядке аспекта Не вызывались они должны конфликтовать влиять друг на друга и конфликтовать между собой и что мы имеем в итоге отпекно ориентирована программирование полезно в использовании она просто а под капотом может быть устроено сложно у нас это не касается мы пользователи конечно Используйте Ну как любая технология использует технологию ради интересной технологии надо применять используем для помогательного скважного функционала и только для него никаких вмешательств основной функционал программы и конечно в одной функционал не должен конфликтовать между собой Спасибо за внимание вопросы и да Самое главное голосуйте домой доклад супер Спасибо огромное поддерживаю А если вдруг по какой-либо причине qr-код не срабатывает не переживайте потом все равно придет анкета вот прям можно записывать все комментарии чтобы не забыть и потом их применять Ну что у кого есть вопросы в зале поднимайте руки и хелперы обязательно принесут микрофон если вы слышите онлайн то задавайте вопросы в чате так первая рука пожалуйста микрофончик а аккаунтинг это точно аспект аккаунтинг Это точно проверка текущего пользователя Повторите пожалуйста вопрос еще раз аккаунте то есть проверка текущего пользования на то что отодвинуть Это точно аспект можно попросить еще раз проверка текущего пользователя на то что он Админ это точно Аспект или это что-то другое проверка пользователя да да она точно Аспект Это проверка прав доступа именно но в текущем коде каток который вот вызывается пользователя на самом деле Ну нет Он возникает Он сюда пропал заяц из слоя приложения из волшебным образом может быть это надо делать иначе Блин я просто не слышу отсюда пользователь существует на уровне приложения да Но не в коде который проверяет что пользователь Я примерно это понял Итак вопрос чтобы запись все тоже услышали в коде это было четко пример он достаточно гром бы просто я не мог представить уровень приложения тела поместился на этот экран это был много экранов а тогда я полностью согласен и там должен стоять вызова вызов проверки доступа пользователя написано именно на уровне приложения Окей Спасибо огромное если у нас еще вопросы в зале или в чате Добрый день спасибо за доклад скажите вот этот пример 2 + 2 = 5 и вот этот define True false это наверное удачный пример то насколько можно сделать код потом сложным в отладке для коллег Скажите какой-нибудь интересный кейс что аспекты не помогали а мешали как раз благодаря переусложнению кода и отладки но когда пробовал все это разные библиотека они не помогали когда они работали в рантами когда они работали в рантами возникали всякие странная ошибка уже исключительно в ранены на этапе добавления и Ну один Я пример это привел пример это шутка над коллегами когда там ты добавляешь по множеству точек например по названию метода Аспект на ориентированное программирование которое определено вообще в другом месте подключаете вообще в другом месте это очень Забавно наблюдать Ну я не над кем так не шутил но я представил тебя как бы я долго это искал весело было бы Спасибо огромное если у нас еще какие-либо вопросы в зале либо в чате Так ну что ж тогда у меня вопрос к тебе Я понимаю что это очень сложный выбор Но какой из этих двух вопросов тебе больше понравился Ну где-то у меня так монетка была сейчас она поможет мне ответит но мне кажется архитектурный вопрос он как бы ближе к практике супер спасибо огромное Спасибо это на второй вопрос правильно это был первый вопрос Спасибо огромное за вопросы пожалуйста вручите подарок автору и Сергей Огромное спасибо тебе подарок от конференции благодарим если что Сергей никуда не убегает можно продолжить общение уже дискуссионной зоне за зоне около зала А я вас всех буду ждать а в 13:20 на тик токе с Виктором михайловым из Газпромбанка"
}