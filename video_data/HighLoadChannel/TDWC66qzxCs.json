{
  "video_id": "TDWC66qzxCs",
  "channel": "HighLoadChannel",
  "title": "Девять кругов ада или PostgreSQL Vacuum / Алексей Лесовский (PostgreSQL-Consulting LLC)",
  "views": 18742,
  "duration": 3091,
  "published": "2017-04-22T14:48:17-07:00",
  "text": "у нас лёша лисовский тоже буду без лишних антимоний человек с потрясающей экспертизы в области железо операционных систем и как она взаимодействует базами данных и сегодня верша будет рассказывать свой потрясающий доклад про устройство авто вакуума давайте поприветствуем можете развить добрый день всем спасибо что пришли меня зовут алексей и я буду рассказывать сегодня вам про вакуум я работаю с после сам каждый день сталкиваюсь с ним каждый день вижу разных конфигурациях его и что с ним делают наши заказчики очень большая экспертиза у нас с этим накопилось в этом докладе я буду рассказывать про лакум я буду рассказывать про его внутренности как он работает как он работает с железом как он какие внутри принимает решения и почему важно уделять время вакууму и почему важно ивану настраивать так скажем да и не игнорировать и как это делать собственно как настраивать вакуум и как сделать так чтобы он работал с эффективно и чтобы не было с ним никаких проблем и начну с небольшой истории как быстро сломать под глэсс мы берем postgres ну допустим нас там оптимальная для вору клода конфигурация мы начинаем часто и быстро обновлять какую-нибудь таблицу или несколько таблиц и отключаем там вакуум или просто делаем его параметры неэффективными и можно увидеть падение производительности вот здесь по ссылке есть небольшой тест который можно воспроизвести у себя на домашними ноутбуке или где-либо еще и посмотреть как падает производительность при отключенном вакууме то есть мы увидите буквально за короткое время как у вас транзакций в секунду падают латинице растет и картина становится просто неприятной итак небольшая цель нашего доклада вот перечислено здесь то есть вакуум это важно его нельзя игнорировать если вакууме настроить то будут проблемы с производительностью и 3 кваку мне страшно его можно и нужно настраивать и это совсем несложно о чем я буду говорить дальше я расскажу небольшие основы это как устроен подогрев внутри я расскажу о такой штуке как м в сисе как дальше запускается автово куда как запускается основной процесс как он принимает решение что он делает дальше затем рассмотрим что такое worker до основной процесс который делает всю работу который обрабатывает таблицы заглянем внутрь посмотрим как он понимает что нужно делать там вакуум на той или иной таблицы затем спустимся на следующий уровень еще ниже как обрабатывается таблица какие решения принимаются там как обрабатываются блоки какие действия выполняются над этими блоками и рассмотрим уже самый низкий уровень там что происходит внутри страниц вот во время этого вакуума и почему там возникают проблемы некоторые и у кого есть интернет либо позже есть ссылка на эти слайды вы можете эти слайды ну зайти на эту ссылку скачать ее и там дальше у себя как-то в домашних условиях изучать что такое вестись и им все это реализация в под грехи как устроен доступ к данным со стороны клиентов этот подход он хорош тем что предлагает очень высокую конкурентность мы можем с базой работать с большим числом клиентов у нас может быть очень большое число клиентов и они все могут читать данные одновременно да и могут одновременно их там писать и читать или не блокируют писателей писатель не блокируют читателей и все это такой подход и вести он предполагает очень хорошую производительность и очень быстрый доступ к данным и все хорошо но у как всегда есть некоторые проблемы этот способ не работает идеально то есть он идеально ну не совсем рассмотрим конкретный кейс как работает в висе мы приходим в базу до клиента это и пытается вставить какую-то строчку наша строчка вставляется и ей создается присваивается специальный номер транзакции который вставил эту строку до 123 затем приходит следующий клиент и пытается обновить эту строку но вместо обновления он помечает старую версию строку как удаленную да он помечает ее своим номером транзакции после этого вставляет новую версию строки и помечает ее как новую опять же со своим идентификатором транзакции так работает и вестись и то есть он не удаляет строку он вставляет новую а старую версию помечает как удаленную то же самое с удалением строк то есть версия строки просто отмечается как удаленная и мы ее вроде как бы больше и не видим но здесь возникает вопрос области видимости транзакции и такой стерилизованный список данных не данных номеров транзакций и он постоянно увеличивается это 32-разрядный такой идентификатор который постоянно растет и каждой новой транзакций присваивается новый номер и вопрос видимости здесь заключается следующем допустим у нас мы сейчас находимся вот здесь ну примерно 275 транзакция и у нас запущено несколько транзакций которые выполняются прямо сейчас на это вот красные линии они запустились в прошлом и вот выполняются до сих пор есть зеленая транзакции которая уже закончились и в данном случае если мы запускаем вот в этом месте вот в 275 транзакции да мы запустили до 75 за акцию все данные которые не закончены текущими транзакции мы их не увидим потому что кометы еще не произошло поэтому все изменения еще пока не видны нам но все изменения сделаны зелеными транзакциями которые уже завершили работу не важно за к митиль синий или сделали rollback все эти изменения мы можем увидеть так работает и висит то есть мы можем видеть те транзакции данные тех транзакции которые уже завершились и не видим еще те изменения которые сделали еще пока работающие транзакции дальше нужно рассмотреть как данные на физическом уровне размещаются в страницах вот grease используют для таблицы для индексов 8 килобайт ные страницы это такие небольшие блоки данных в которых размещаются значит у нас все таблы все строки данных да то есть если мы посмотрим на странице есть так называемый федор есть хвост это специальная область таблицы где размещается служебная информация и дальше в начале страницы у нас есть указатели на строки а в конце страницы есть усами строки эти указатели они ссылаются на эти стройки то есть там есть а все ты и они просто ссылаются на номер там на на страничку эту и эти указатели при добавлении новых строк при обновлении они просто начинают расти друг другу и пока не встретиться в середине таблицы таким образом страница заполняется и в таблице выделяется новый блок и ситуация повторяется следующем же образом что дальше когда мы начинаем обновлять строки или удалять старой версии строк помечаются как неиспользуемое они отмечены красными значит прямоугольничка да то есть у нас есть не используемые данные и они должны быть вычищены таким образом нас таблица может распухать и в ней может быть очень много строк помеченных для удаления и здесь мы приходим к вопросу вакуума то есть должен быть какой-то процесс который должен это все чистить и вакуум что делает он берет эти строки помеченные для удаления до простыми словами он их просто удаляет содержимое а указателей помечает как их можно использовать повторно то есть придет когда следующий и клиенты захочешь что-то вставить или обновить он будет использовать именно вот эти вот указатели которые помечены для повторного использования и конечно же вакуум делает дефрагментацию странице он складывает эти вот куски слабо освободившееся место и страница получается снова у нас как бы такая разреженная в ней получается много свободного места и можно вставлять дальше данные и небольшой такой самаре такой итог то есть от вакуум он позволяется бороться с издержками о готовой сиси многие называют это костылем или неправильным дизайном но тем не менее давности и с ней нужно жить то есть есть и весы сие есть вакуум и вот они вот так вот решают друг друга проблемы как запускается вакуум да то есть когда мы запускаем под grease у нас есть мастер процессу называется postmaster он работает в бесконечном цикле и после и своей собственной инициализации запускает несколько служебных процессов в их числе входит и of the vacuum лаунчер и этот процесс postmaster он крутится в бесконечном цикле и если вдруг с of the vacuum лаунчером что-то случится там мы его сами там мы убьем или и вам киллер его убьет то пусть мастер его перезапустит то есть это такая штука которая позволяет фоново процесс ip-адреса поддерживать всегда живыми что дальше когда of the vacuum лончер запустился он делают собственную инициализацию ему нужно как-то работать с операционной системой он настраивается значит на работу с жареной памятью настраивается на работу значит а с сигналами из файловые дескрипторы менеджерами ведь он инициализируется как обычный процесс дальше он начинает создавать список б д то есть основная задача лаунчера это построить список б д который который мы будем обрабатывать а то есть мы выбираем ну лаунчер выбирает кандидата на ту базу которая будет обрабатываться и после создания этого списка так мы запускаем бесконечный цикл и в этом бесконечном цикле как раз в операции 1 этого цикла мы запускаем отправляем сигнал на запуск квартира и этот цикл работает пока не будет получен сигнал от пут мастера о том что мы штатно завершаем ся и в таком случае of the vacuum лончер завершает работу либо может еще перечитать конфигурацию что происходит дальше у маркера о лончера есть некоторый алгоритм для запуска worker а то есть он выбирает базу который реально необходим vacuum vacuum а есть такое поле она называется do the frozen xid idatalink сид это грубо говоря возраст и worker понимает по этому возрасту что у базы есть риск оборачивание счетчик транзакций оборачивание счетчика транзакции то такая проблема которая связана с размером этого счетчика он 32 бита всего об этой проблеме я затрону и и позже когда уже ближе к wraparound лаком под еду ну таким образом в лаунчер выбирает базу ту базу у которой есть риск оборачивание транзакций и если таких баз нет то мы выбираем просто то у базу на который давным-давно не было вакуума то есть если какая-то база недавно обработалось мы ее пропусти мы возьмем ту которая старше там был раньше было обработалось когда база уже выбрана мы берем запоминаем ее имя и запоминаем время от этого выбора да и помещаем ее в шарик мою память время выбора нужно чтобы ориентироваться при выборе следующего candida да да то есть вот этот список баз мы отсортируем по времени и выбираем соответственно на основе временной отметке следующего кандидата когда кандидат выбран мы помещаем его имя в шаре дну you память и отправляем пост мастеру значит сигнал что нужно запустить of the vacuum worker дальше когда postmaster принимает этот сигнал он делает форк он создает новый процесс который впоследствии будет уже маркером и пoсле тoго квартир запущен of the vacuum лаунчер продолжает свой цикл завершает начинает заново и снова повторять свою работу то есть он ищет кандидата запускает worker а и так работает бесконечно пока не будет завершён выглядит это следующий схематично это выглядит так есть пуст мастер да он значит запускает лаунчер лаунчер инициализируется строить значит а список баз кандидатов и отправляет сигнал обратно пуст мастеру пусть мастер получив сигнал запускает worker а то есть все довольно просто и понятно что делает worker когда запустился когда postmaster его for the worker также он делает свою инициализацию он устраивается на работу с операционной системой и дальше он устанавливает некоторые позади совы и параметры которые есть в потряс к вам конфиги но тем ни менее он их явно выставляет на предмет того что если вдруг эти конфиге переопределены параметры переопределены в конфиге эти параметры позволяют не натворить страшных дел с данными то есть мы отключаем обнуление поврежденных страниц мы отключаем тайм-аут и на запросы на локи и делаем уровень изоляции рядками тот это такой более менее безопасный уровень изоляции которые позволяют читать те данные которые уже закончены ну и делаем еще synchronous асинхронный commit локальным чтобы не аффекте тебя производительность на удаленных репликах когда это сделано worker смотрит жареную память и берет то что ему лаунчер положил имя базы то есть он берет вот это вот имя кандидата и уже регистрируется себя ну регистрирует себя что он варки что он запустился и что он будет обрабатывать эту базу и дальше он проявляет а значит пусть мастеру процесс сидиус r2 и вот мастер получив сигнал понимаешь что да все произошло успешно ворчишь запустился значит и можно расслабиться дальше backend варки rooted он лицензируется в качестве позади слова бэг-энда он получает доступ к журналу транзакции он там инициализируют менеджеры работы с хранилищем с файлами и всякие разные прочие штуки и там очень много на самом деле поэтому когда ваш пузырь for каяться много это довольно тяжеловесная тяжеловесной паттерн использование пожгли со и так что делает worker дальше ему нужно получить список таблиц для обработки в этой базе он подключается к базе и берет значит а служебную таблицу g-class в ли условно говоря есть список всех таблиц которые есть в базе и различные характеристики по этим таблицам он открывает эту таблицу и беретту туда только регулярные таблицы мат представления это с таблицы то с таблицы это просто служебная таблицы обычных таблиц которые хранят длинные слишком назначение которые не помещаются в обычной странице то есть такое расширение для таблиц который тоже необходимо вакууме что дальше выбираются только таблицы и представления их можно отследить по служебному полю пиджи класс real and то есть там есть флажок который определяет тип этой ты этого отношения мы смотрим только таблицей им от представления дальше мы читаем статистику из более релог шанс там находятся индивидуальные настройки для вакуума то есть мы можем использовать не только настройки в пузыре скули конов мы можем переопределять настройки вакуума для отдельных таблиц через alt и был команду это тоже важное и полезно когда у нас есть какие-то такие специфические паттерны использование данных дальше запускается фан функция в relations вакано лайс она проверяет что нужно сделать на этой таблице вакуум она lays или и то и другое дальше мы рассмотрим эту таблицу и поговорим про нее функцию и поговорим про нее как она как им какие решения на принимает дальше мы проверяем является ли таблица временно и потому что worker он не может накормить временной таблицы если он у какого-то бэг-энда временную таблицу что там сделает то таблица как бы изменить данные там в ней поменяется и backend можете сообразить почему у него данные без его ведома поменялись и тут непредсказуемые последствия могут быть поэтому таблицы которые являются временными они пропускаются и также если мы нашли тост таблицу мы запоминаем ее ассоциацию с родительской таблицы потому что тоста таблице они потом отдельно лакомятся после основного цикла вакуума и теперь вопрос европы раунда в некоторые люди они очень сильно так беспокоятся о том что вы про und наступит и как-то вот боятся в этом бояться этого события я хочу сказать что это проблема в версии 96 она очень сильно так уже улажено и не надо бояться wraparound он не страшен проблема заключается в чем идентификатор транзакции 32-битный то есть это четыре миллиарда с половиной с небольшим и этот счётчик рано или поздно он заканчивается да и он как бы должен начаться заново и вот это вот оборачивание счетчика у называется в прованс и описать его можно следующим образом допустим вот это вот солнышко верху до на 12 часов это текущая наши вот наша транзакция текущая транзакция то что зеленая это буду это еще не совершившийся транзакции которые будут выполнены то в будущем красная зона это наше прошлое то есть уже выполненные или запущенные транзакции которые еще не закончились например да и у нас есть два кружочка один кружочек на 11:00 это транзакция которая была запущена недавно ну допустим там два часа назад да и транзакция которая на 7 часов эта транзакция была выполнена 7 дней назад то есть представляете себе примерный масштаб времени то есть недавние транзакции есть которые были недавно и старой транзакций которые были давно и вот вот этот транзакция на 7 часов она близко уже от шести часовой зоне то есть когда солнышко будет у нас дальше проворачиваться и новые транзакции будут появляться может получиться ситуация что транзакция которая была в прошлом и и номер может оказаться как бы в будущем для после со это фатальная ситуация и когда в сравнении вот до в сравнении правил области видимости о которых я говорил раньше если он видит что есть какие-то строки у которых номер транзакции в будущем это тоже не понятная для подвеса ситуация и непонятно как такие ситуации обслуживать ip-адрес таких случаях бы он просто у него будет крыш он свалится в после слова в лоб сообщение об ошибке и завершит работу поэтому придуман так называемый wraparound вакуум который вот идет индификатор и транзакций откручивает и помечает их как будто они уже в прошлом всегда-всегда в прошлом то есть это для самых старых таких данных у которые были вставлены старыми транзакциями как это выглядит в полисе есть несколько параметров это вакуум freeze меняешь вакуум фриз ты был лишь и вакуум фриз макс edge условно говоря мы сверяем возраст вставленных строк да и сверяем с возрастами которые указаны в этих параметрах дайте параметр у нас указан в конфиге мы берем текущую транзакцию и возраст строки просто вычитаем считаем дельту если это дельта у нас превышает один из этих порогов мы соответственно выполняем определенные действия первый из порогов у нас определяет возраст для которого мы будем делать полный скан таблице у таблице есть служебное поле оно характеризует самую старую запись в таблице то есть идентификатор транзакции до которая вставил самую старую эту строчку если вот это идентификатор он старше вот этого возраста мы будем делать full ты был скан то есть мы будем все блоки обрабатывать таблицы это накладно для дисковой подсистемы и будет долго по времени если таблице выше конечно следующий возраст у нас это вакуум фриз ты будешь а нет я перепутал вакуум freeze меняешь это когда мы будем фризить строки то есть строки которые старше этого возраста мы будем их значит замораживать full скан это вот fries & blade то есть при достижении этого возраста мы будем делать полный скан таблицы и последнего раза возраст freeze макс лишь когда у нас таблица старше этого возраста вот это ее параметр служебный старше этого возраста мы будем принудительный делать в рыб и раунд вакуум с полным скана мы с полной обработкой всех страниц и проверки всех этапов я всех строк и это что касается вот wraparound вакуума и как worker понимает что нужно его делать то есть он сравнивать леди от времена транзакций и понимает что до нужно делать там вы про und вакуум либо его не нужно делать как вакуум проверяет что нужно делать этот самый во куда как worker понимает что нужно сделать какую-то работу мы определяем вот идет пороговые параметры до из либо из индивидуальных параметров таблицы которые записаны в релог шанс либо берем эти параметры из подрисовок конфига и в случае вот когда мы врп раунд вакуум проверяем нужен ли wraparound мы берем минимальное значение либо из конфига либо из индивидуальных параметров потому что мы хотим как бы wraparound вакуум запустить как можно раньше потому что мы не хотим рисковать поэтому берем минимальное значение для калькуляции этого возраста дальше мы запускаем принудительный вакуум если таблица у нас она есть у нее есть риск оборачивания транзакций то есть это первоначальная таблицы которое необходимо обработать как можно скорее чтобы не допустить этого то оборачивания и вот как раз вот здесь показаны в третьем будете показано как раз идет поля которое мы сравниваем да то есть когда класс имеет 2 2 поля hell frozen хитрил wing seed для сравнения вот этих вот правил для сравнения возрастов чтобы понять нужен wraparound или нет именно текущую транзакцию и и t3l фроузен xit мы их сравниваем считаем разницу между ними и сравниваем с порогом которые определены в конфиге если в рыб раунд не нужен и так получилось что of the vacuum отключен дат это тоже возможно там и просто пропускаем таблицу и дальше мы считаем уже по формулам нужен ли вакуум для расчета используются следующие участки кода я взял из них самое важное то есть нам нужно знать сколько строк в таблице да и нам нужно знать сколько мертвых строк и сколько там строг со времени выполнения последнего она лайза грубо говоря мы высчитываем порог да если мертвых строк больше чем этот порог то мы запускаем вакуум если измененных строк больше чем определенный порог высчитаны да мы запускаем она лайс да то есть правила довольно простое и для высчитывания порогов используются следующие параметры с грехом конфиге есть такие параметры скейла факторы они относятся к вакууму и относится к на лайзу то есть грубо говоря это доля как раз именно мертвых строк и доля измененных строк с последнего она лайза грубо говоря 02 это 20 процентов 01 это 10 процентов то есть если в таблице есть больше чем 10 процентов мертвых строк мы запускаем там of the vacuum если если 20 процентов то of the vacuum если больше десяти процентов то она лайс и к этому же вы ищете много порогу мы добавляем этот небольшой трешолд который полезен для маленьких таблиц и можно задирать этот тур желтом повыше чтобы для маленьких таблицах то вакуум внутри делился слишком часто что дальше подготовка к вакууму известно что вакуум он а мы вот все таблицы проверены то есть мы провели весь список таблиц у нас есть готовый список с которым мы можем работать после этого мы закрываем pg класс и выбираем выбираем стратегию доступа к жареной памяти то есть иногда есть такой миф что вот подвес когда запускает of the vacuum он значит всю таблицу помещает в кэше у нас значит крыш вымывается и нечто такого вакуум используют кольцевой буфер размером 32 килобайт и все все свои операции все чтения таблицам прогонять через него поэтому кэш не вымывается и мы берем первую таблицу из этого списка дальше нужно упомянуть про cost параметры что caicos параметры вакуум есть cost бэйза так называемый то есть мы обрабатываем табличку пачками по несколько страниц потом делаем паузу определенную до отдохнули дальше берем пачку страниц и снова их обрабатываем и так пока не закончим обработку таблицы для чего это делается это делается для того чтобы не положить вашу дисковую подсистему и чрезмерным чтением да то есть мы определён определяем как у то определенную объем работы и делаем лотом с определенным определенными паузами и вот этот объем работы он рассчитывается на основе этих cost параметров и у нас есть здесь три параметра пэйдж хит это когда страница находится в памяти это самое дешевое чтение то есть мы из памяти и забрали и единичку добавили за эту страницу следующая страница на сочетается с диска это пейдж мисс а чуть подороже то есть нам нужно прочитать данные с диска поместить их в жареную память и дальше с ней работать следующий более дорогой cost это cost за загрязнение страниц то есть когда мы в странице что-то вами поменяли ее нужно будет записать на диск это самый дорогой и дальше у нас есть cost лимит это максимальная планка при достижении которой пост будет делать паузу то есть мы когда обрабатываем блоке мы считаем значит этот гост за каждую страничку и как только у нас косо превысил 200 мы запускаем паузу равную cost для 20 миллисекунд по умолчанию это очень маленькие параметры и если 8 килобайт на страничке до перевести вот в эти касты да и почитать с какая максимальная пачка как максимального размера будет обрабатываться то вы увидите очень маленькие значения поэтому эти цифры рекомендуется всегда выкручивать вверх в верхнюю сторону то есть увеличивать размер пачки уменьшает delay и вот эти хиты пересматривать но помните что перед тем как чтобы поменять и после того нужно проверять свою дисковую производительность и сколько вас of the vacuum маркеры нагрузки создают на диске так же тут стоит упомянуть что cost параметры эти газ параметры они не вступают в силу для текущих запущенных worker of то есть вы можете понять параметры в конфиге сделать рилот но применится а не только к будущим маркером который запуститься после после изменения уже параметров для уже рабочих маркеров и номера не сработает и еще одна важная деталь все вот эти вот cost параметры они делятся на количество worker of то есть у вас вот эта пачка 200 до 200 вот этот лимитах который указывал здесь да он рассчитывается чтобы было поровну на всех запущенных рокеров есть это тоже нужно учитывать и вот это 200 она рассчитывается на всех ордеров то есть это тоже нужно помнить если вы подняли макс workers to эти лимиты тоже нужно поменять и схематично это выглядит так да то есть резюмируя наш разговор есть инициализация есть worker он делает инициализацию отправляет значит сигнала мантру и говорит что все окей я запустился после этого он делает вакуум он сканирует pg класс проверяет таблицу что ее нужно вакуумировать потом что дальше происходит он повторно проверяет таблицу вдруг ее в соседней ваку в worker уже отработал на нам нужно перед непосредственно обработкой таблиц снова проверить ее нужен ли и вакуум после чего возвращается и так вот обрабатывает весь список и после обработки всего списка значит он обновляет там свою статистику служебную которое также в подгрести доступная и завершает работу если опуститься на уровень ниже на уровень уже непосредственно вакуума как понять делать ли какой делается вакуум это уже больше относится к пешком-пешком после со и есть либо ручной вакуум вызванный вручную из консоли да когда мы пишем wacom там что-то там и нажимаем enter и of the vacuum обе оба этих действий они приводят в общем-то в одну функцию функцию вакуум и работа в общем то одна и та же логики никакой там отличный между этими функциями в общем то нету и что дальше происходит то есть мы построили список таблиц да смотрим нужно ли делать cost buy зад вакуум и начинаем обрабатывать таблицы если таблицы нужен и вакуум и анализ мы делаем и то и другое если что то какая то операция не нужно на таблице мы ее просто не делаем и после всей работы как я говорил вот обновляется вот эта статистика до для базы и worker завершает работу перед тем как начать работать с таблицей нужно взять блокировку до нужно взять блокировку чтобы как-то защититься от внешнего воздействия на эту таблицу и здесь у нас есть 2 варианта мы берем либо эксклюзивную блокировку это в случае вакуум fulda когда никто не должен работать с таблицей это очень такая злая блокировка которая не позволяет никому больше работ из таблицы только от взявший блокировку работает и есть боя такая демократичная блокировка которая позволяет другим клиентам работы с данными таблицы читать данные вставлять данные и уже не испытывать проблем с доступом если блокировку взять не удалось это особенно критично в случае of the vacuum маркера до то будет сообщение что блокировку не удалось сделать и таблица пропускается и переходится обработка к следующей таблице это не страшно поэтому как бы эта ситуация она оперируется она значит обрабатывается другим уже маркером то есть другой worker придет и обработает эту таблицу возьмем блокировка все будет хорошо если вдруг таблицу удалили то ничего не делаем переходим к следующей либо завершаем работу дальше нам нужно проверить что мы можем от вакуумировать эту таблицу нам нужно проверить что у нас есть доступ к ней что мы либо superuser либо владеем этой таблицей и после этих проверок мы переключаемся войди этого значит пользователя который владеет таблицей и ну и тут по ходу дела мы значит проверяем что мы действительно можем вакуумировать этот этот объект который у нас в списке находится что это действительно таблица что это не временная таблица что мы можем ее значит обработать здесь мы запускаем уже функцию которая дальше нас погружает внутренности вакуум и она называется ли зевак уморил если вдруг ручной пользователь ввел там руками вакуум full то мы перемещаемся уже в другую команду в кластер то есть вакуум full это реализация кластера которая перестраивает таблицы создаёт новый файл и дальше уже сдам делает другую логику и так когда функция вот это вот и зевак уморил отработала таблица обработанному и и закрываем и если в этой таблице есть тост мы переходим к этой таблице мы обрабатываем ее точно также той же самой функцией и алгоритм то в общем то те же самые выезде вакуум реал а делает следующая она определяет параметры для заморозки этих этапов то есть какие-то пл и мы должны замораживать замораживать и какие возраста мы будем использовать здесь мы используем следующие оценки то есть старше freeze лимит мы все замораживаем да то есть мы посчитали этот возраст определили если мы видим строки старшим и их морозим и также полное сканирование таблицы если реал frozen fit у нас ушел за с вы считанный порог дальше мы делаем то же самое для мульти транзакции в общем то логика то же самое полное сканирование и то что мы будем морозить дальше мы сравниваем рилз воздухе с вышитыми параметрами до вот этих возрастов и понимаем что вот у нас есть пороге мы будем их дальше использовать дальше мы открываем индексы начинаем с индексов потому что нужно сначала вычистить индексные указатели которые ссылаются на мертвые строки и делаем вакуум вот этой функции лизе скан хип дальше таблицу мы закрываем у яндекса закрываем и переходим к таблице мы по возможности стараемся обрезать таблицу выбрать у нее хвост это такая штука которая которая но скопление пустых страниц которые можно отрезать и уменьшить размер таблицу если это возможно то это желательно делать чтобы таблицу нас не пухли в размере после завершения работы мы опять же обновляем статистику обновляем количество мёртвых строк и обновляем количество живых строк которые вот у нас в таблице после обработки мы это вычислили все и пишем сообщение влог и завершаем работу переходим к следующей таблице теперь когда ну напоминание большое когда вакуум завершён мы переходим к следующей собственно таблицы либо переходим к тосту теперь рассмотрим лазис can't hide да то есть сначала мы выделяем память где будем хранить вот эти вот мертвые строки ссылки на мертвых строки которым будем позже вычищать для этого используется параметр конфига of the vacuum work мем эту стоит отметить что его нельзя поднять больше одного гигабайта то есть бесполезно ставят 24 бесполезно давать будет всего один гигабайт максимум и мы проверяем начинаем проверять страницы которые мы можем пропустить это нововведение она появилась 96 и призвана облегчить wraparound вакуум то есть мы можем пропустить стройки которые уже были полностью заморожен и или строки которые полностью видим и то есть там находятся строки которые видны всем транзакциям то то есть там нет никаких активных изменений и вакууме там ничего не нужно эти страницы пропускаются и мы ищем только ищем только те страницы где есть где нет этих флагов на то есть где какое-то активно изменения идет и когда мы находим такой первый блок мы переходим к его обработки и еще стоит отметить что мы всегда сканируем последний блок на предмет того что вдруг мы захотим вдруг будет возможность обрезать таблицу обрезать ее хвост и делаем вакуум долей point это как раз проверка не достигли ли мы вот этого вот лимита до вот этого cost лимита после которого мы должны делать паузу вот в таких местах где вакуумка стремится лаком долей point встречается да мы как бы проверяем нужно ли пауза если нужно то делаем паузу и this can skip да эта функция она начинает работу с первого не пропускаемого блока и ищет следующий блок который можно не пропустить ну нельзя пропускать мы потом после проверки блока переходим уже дальше к нему и проверяем эту страницу на предмет мертвых строк до читаем содержимое страницы обновляем та тетка ст переменная и пытаемся взять блокировку для вычищу вы чистки ход цепочек проход с почки расскажу тоже крутая штука не понижает принять чуть позже и если блокировку мы не взяли то блок будет пропущен это как раз вот этот кейс когда люди жалуются что у меня прошел вакуумка ручной ничего не почистил размер не изменился мертвых строк все равно много это как раз вот тот то место где вакуум может пропустить страницу потому что он не смог вычистить ход потому что это очень сложная операция с точки зрения под гриссом дальше мы проверяем страницу на предмет строк который мы можем заморозить то есть мы пропускаем часть страниц которые нам нам не нужны да и проверяем только нормальной странице где есть строки и дальше мы уже проверяем вот строки сравниваем их с вы чаще с вы численными значениями порогов и проверяем эти пороги и понимаем что нужно нам эти строки можете либо нет дальше мы продолжаем цикл проверки и если мы обнаружили какие-то не инициализирован ее страницы или пустые мы значит их как-то вводим в работу помечаем их что их можно использовать добавляем в карту видимости в арту свободного места ip-адрес понимать что их можно использовать теперь немного про hot hot это такая оптимизация которая позволяет делать апдейты без мисс без изменения индексов когда мы делаем апдейт это по сути добавлении новой строчке и добавление новой строчки в яндекс и это очень тяжелая операция поэтому когда мы что-то добавляем мы добавляем это не только таблицу но еще и в яндекс поэтому используется специальная ход цепочки которые позволяют не перестраивать яндекс и это работает только когда мы обновляем не индексируем а и значение это очень хорошо оптимизирует производительность на запись и снижает нагрузку на диске вылета картина следующим образом нас есть ход цепочка и вакуум может и из хлопнуть такого состояния и освободить не занятые в цепочке указатели и после чего схлопывается место и страница снова она становится де фрагментированной и можно вставлять больше данных и так когда мы чистить всех от цепочки мы проверяем все указатели и проверяем все указатели которые мы можем хлопнуть да и если мы нашли что мы можем внести какие-то изменения мы собственно делаем это в критической секции мы откроем критическую секцию обновляем все эти указатели обновляем значит делаем дефрагментацию складываем все вот эти вот таблы вместе и значит убираем отметку что страница полная да то есть мы теперь в эту страницу можем добавлять новые стройки то есть появилось свободное место прекрасно и дальше мы где раз сделали мы какие-то изменения мы помечаем страницу как грязную и делаем отметку вал то есть нас изменения в журнал транзакции записываются об изменениях дальше мы проверяем страницу и собираем информацию о тех строках которые мы можем вакуумировать да здесь есть очень такая интересная и сложная функция хип ты был satisfies вакуум она проверяет строки и проверяет можно ли их вакуумировать условно говоря вакуумировать можно только реально мертвые строги которые не видны ни одной из транзакций если у нас есть какие-то транзакции которые только что обновили строки удалили что-то эти строки нельзя во кумир то есть необходимо чтобы все транзакции которые еще могут видеть эти изменения они завершились и все эти стройки они попадают в наше хранилище которые выделены of the vacuum work мелом да то есть все строки хранятся там после того как мы проверили нашли эти мертвые строки проверяемых снова на в предмет заморозки и когда мы можем их заморозить мы составляем такую небольшую информ оск то есть небольшой такой участок строки метаданными то данной строки и мы составляем этот информации в критической секции в строку его вставляем чтобы это было быстро чтобы вот временно составления много не тратилось и все вот эти вот изменения не делается также в критической секции если что-то и изменилось были заморожены строки реально мы пишем опять же в журнал транзакции о том что мы сделали когда мы проверили все блоки если нет индексов мы сразу вакуум страницу да мы сразу применяем все изменения делаем обновление карты видимости и свободного места и переходим к следующему блоку и так пока не не завершится весь цикл всех но не не завершится проверка всех блоков когда значит все блоки проверены весь вакуум значит отработал у нас мы сохраняем статистику о проделанной работе обновляем количество строк нашей таблице да то есть мы часть вычистили количествах изменилось мы обновили эту статистику если есть какие-то стройке к удалению да мы сделаем второй проход да и обновляем только удаляем указатели в индексах и удаляем стройке из таблицы кажется немного запутано ну да вакуум делает два прохода сначала чистит индексы потом уже чистить таблицу и вот второй проход по таблице он же как раз делается с помощью вот этого хранилища накопленного мертвых строк да и он посещает только те строки которые есть в этом хранилище до память идет только в те блоки в те страницы на куда у него есть информация о мертвых сроках и чистить только их то есть это неполной скан таблицы ничего такого и также мы пытаемся взять блокировку на очистку странице если и не получилось взять то блок тоже будет пропущен в надежде что придет потом следующий вакуум и эту страницу обработает то есть если у вас есть высоконагруженные таблица с большим количеством дельтав тут могут быть проблемы и это надо решать уже другими методами что дальше лизе вакуум тыж это уже следующий такую наш уровень и он чистит мертвые строки и убирает фрагментацию да то есть это уже самая основная функция которая делает всю грязную работу то есть она проходиться по дает строкам который вот есть у него в хранилище информация по этим строкам и чистить эти страницы и затем выбирает фрагментацию и все изменения заносят в журнал транзакций все это также делается в критической секции то есть если вдруг что-то там пузыри все сломается то изменение просто будут неприменимы и так теперь у нас страница вычищена все блоки обработанные таблица просканировано индексы тоже вычищена то вся работа сделана когда таблица обработано мы обновляем карту видимости то есть какие страницы мы можем транзакт какие строки запущенные транзакции могут видеть а какие не могут это все хранится в визе битемап и обновляем карту свободного места чтобы клиенты знали в какую страницу можно заталкивать данные дальше мы обновляем статистику и пишем журнала сообщение о проделанной работе и это уже действительно конец после этого начинается обработка новых таблиц там новых баз данных и на этом работа worker а заканчивается что в итоге этот такие тыкву messengers вакуум себя должен быть включен уделять ему всегда достаточное время не бойтесь его настраивать проверяйте дисковую производительность после этого и wraparound не страшен в версиях версиях 96 риск европы раунда очень сильно уменьшили то есть это не так страшно как многие говорят и вакуум не всегда может вычислить таблицу да эта проблема но над этим работают и нужна отдельная горка раунды для этого и старайтесь избегать длинных транзакций прошли на транзакции они не дают вакууму вычистить строки и соответственно таблицы разрастаются ну и соответственно ссылке вы можете их найти также в слайдах в моих вот в этих если скачаете и собственно все спасибо за внимание да спасибо огромных за доклад вы сказали что не только от ручную вакуум но и некорректные настройки в принципе могут положить сервер вы могли бы привести примеры и вопрос следующий из него есть ли какие-либо приложения для скажем так эвристики от и вести ческой оценки насколько хороши будут настройки то есть пример если меня рабочий сервер я решил на нем поиграться с настройками вакуума оп оп и сервер лег что я я понял я отвечу сперва на первый вопрос когда я забыл первый вопрос так а я понял настройки которые некорректная да это простые настройки у вас есть рейд или rate хранилище raid-массив на котором вы держите базу но у вас дефолтные настройки вакуума и вакуум работают просто очень медленно в результате у вас просто пухнут таблицы вакуум работает по несколько дней и таблицы все равно пухнут и у конечного пользователя но администратора возникает ощущение что вакуум мне справляться с работы не растет и он видит что у него база терабайтный он говорит у меня highload у меня много данных на самом деле в таблице просто очень много мертвых строк которые как будут очень медленно вычищаются да то есть вакуум всегда нужно адаптировать под ту нагрузку которую может позволить себе сервер да то есть если это за диски делаем агрессивный вакуум медленные диски ну значит делаем не сильно агрессивный вакуум и второй вопрос про эвристику таких утилит насколько я знаю нет то есть мы можем только использовать эти вот вакуумные формулы мы можем понять сколько у нас таблицы сейчас должно быть обработано вакуумом вот сидит виктор и гафаров в третьем ряду у них очень хороший го века был plugin подними руку на тебя много смотрю у них ребята написали хороший запрос который позволяет оценивать загруженности вакуума сколько таблиц находится вот но pending сколько таблиц в обработке да то есть скольким таблицам нужен вакуум скольким анала есть очень хорошая штука и насколько помню она учитывая тот индивидуальные параметры таблиц то есть можно такой штукой смотреть но каких то более продвинутых вещей которые оценят до эффективность вакуума к сожалению нету да ну я не знаю раз с добрый день и спасибо за доклад пожалуйста сказать то что очень много проблем полечили в 96 production да у нас есть 96 на одном образовательном портале не буду называть ее там мы используем 961 но вообще мы ждем когда выйдет 2 3 минорный рис но там нагрузка у клиента не сильно большая поэтому мы отважились на 961 и используем и пока все хорошо но нагрузка там как бы не сильно профиль нагрузки там 90 процентов чтения 10 центов записи не сильно так чтобы много но тем не менее используем но здесь польза от этого не так сильно то есть оно не надежной системой небольшая то есть томатов таком у нас много фишек во втором а пользы нет а второй вопрос а вы используете ли вы настройки конкретно под таблицы то есть не в процентах да да индивидуальная таблице мы используем у индианы настройки для таблиц мы используем но таких случаев можно пересчитать по пальцам как правило мы просто делаем вакуум агрессивным чтобы он просто маленькими порциями как можно чаще обрабатывал таблицы и этого вполне достаточно но тем не менее да такие случаи есть мы используем когда например на архивных таблицах например когда отдельный ты был space там с архивными таблицами там вакуум как бы не нужен и евы браун там тоже как бы не нужен особо мы просто там увеличиваем параметр чтобы wacom там три делился как можно реже если допустим наоборот чтобы он еще грехи небольшая один процент от нее там вы можете использовать не процентные параметры а там есть трешолд такой параметр of the vacuum vacuum трешолд называется of the vacuum анала сестра шел то есть это количество строк точно да то есть вы можете указать например 0 процентов до в индивидуальных параметров и указывать и ноль процентов но вы указываете какой то явно перешёл например 100 тысяч строк конкретно под конкретную таблицу можно использовать просто прошел и еще из этого мира вытекает из микро с этим задумались пользоваться но авто лаком колеса worker of ограничено и соответственно если там когда но долги не нужно автоваз убежит дату и уборки все за не скажем так вот и соответственно а есть таблица которая акит изменяется и как бы хотел чтобы до нее autocad бежал из от о соответствии с с настройкой конкретный таблиц но здесь ничего к сожалению не сделает тут либо только увеличивать количество количество worker of на чтобы они быстрее отрабатывали забегали потому что пока вариантов приоритизации таблиц к сожалению нет последнего опроса если у вас без практик для настройки допустим подсад одесские пады создай диски да есть вы можете подойти на нашу стойку и такой ну как бы нет реальный вопрос на на пять минут можете пойти на нашу стойку пузырь искали комьюнити не буду спг pro 2 разных и там можно обсудить я вам расскажу больше пожалуйста мне такое просто сказали что когда вакуум доходят таблицей там условно говоря лог то соответственно пропускает на вопрос в том он сдается сразу или внутрь медленная попытки там искать и лобном а там есть до определенной таймауту значит там кружится какое-то время заслуги до носки локи и потом или может быть деталей lightweight locker решение не скажу и после этого да он как бы сдается и пишет сообщение урока получится такая ситуация что когда ну грубо of the vacuum просыпается в таблице каждый расчёт происходит вот и в результате чего таблицы как бы остается не пропали сложены то есть вы имеете ввиду что вакуум уже работать нет он проснулся посмотрел ухты лог пропускаем встреч нас проснулся потом опять лук да вот с таких ситуациях да и получается тайм-аут но в ручном вакууме если вы из консоли запускаете wacom the vacuum там использует бесконечное ожидание у вас вакуум будет ну консоль будет висеть по кого-то дозировать авто вакуума нет такой проблемы у него есть тайм-аут если он не смог чтобы он не ждал бесконечные до нее было окунуться нет проблема у базы будут проблемы если of the vacuum долго не будет выполняться по id причине но это уже проблема администра нами парятся но это решает проблему бесконечно ожидающего ваку of the vacuum а вот этот ремоут чтобы он не ждал бесконечно можно еще не связанный вопрос тоже такой короткий водка вы сказали что of the vacuum решает запускаться независимо от количества то пол в таблице количество мёртвых там да вот количество тапов просто сказано там просто лежит а количество мёртвых тапов откуда берется то что это берется из статистики то есть когда мы когда бренды делают какие-то операции обновления там апдейта дэвид insert и они меня страничку из просто она лежит то что тоже да тогда то есть статистика p&g из tattletail стали есть and tables попробуйте сделать там несколько апдейтов и вы увидите что у вас апдейты увеличится и and tables тоже нет я просто да просто не кулачный я вынужден прервать и представлен дискуссию приношу извинения время совсем прижимает поэтому давайте еще раз аплодисменты алексею настоящий доклад"
}