{
  "video_id": "Uojy57I-xP0",
  "channel": "HighLoadChannel",
  "title": "Практики, особенности и нюансы при работе с Postgres в Go / Артемий Рябинков (Авито)",
  "views": 28361,
  "duration": 2879,
  "published": "2019-05-07T13:25:51-07:00",
  "text": "я зовут артемий ребёнков кстати собственная rub они авито авито я сейчас за не зданием проекта краткосрочной аренды недвижимости вот вообще его вид а у нас мы долгое время уже работаем с гол раньше у нас был стать печки сейчас уже года два с половиной переходим на гол вот ну и у нас есть под гарсон у нас давно и надолго и поэтому определенной практики по работе с гасом по работе с подвесом связке с головы выработали и захотелось об этом рассказать вот ладно обо мне чуть узнали давайте о вас узнаем есть тут детей поднимайте руки давайте кто теперь один тебе отлично разработчики руки супер но на самом деле как раз ты ты мне нужна я все остальные кто кто не поднял руки окей хорошо ладно а кто пишут на голову ну или хотя бы интересуется гол отлично все остальные тоже непонятно зачем пришли но тем не менее у вот это вообще язык который считается простым и он действительно простое для того чтобы изучить все такое чем его силы его сила на самом деле в том что у него есть большой набор инструментов но у него не так много инструментов которые заточенные под кит общие задачи и мне кажется горьким силён например в гане приняты в рынке и у нас например все запрос который мы пишем это просто головы скурили и как бы вот так мы и работаем и в этом на мой взгляд его сила но при этом мы кое-что теряет давайте рассмотрим какие инструменты у нас вообще в есть когда мы начинаем работать с базой go есть стандартный пакет дтп с sql этот пакет он предоставляет интерфейс для работы с вскоре подобными базами данных это этот интерфейс он нам предоставляет методы того чтобы открыть соединение это для того чтобы выполнить запрос получить результат собственно этот интерфейс кузова и там работать вообще с любой сквозь подобной базы данных вплоть до того чтоб тарантул все войско запросами использовать можно но да и кроме этого вы захотите работать страза акциями для того чтобы работать транзакциями в этом пакете тоже есть методы стартануть транзакцию закомитить елизово почти и объект раза акции поддерживает все то же самое что объект баз данных напросто знаете точно показал в целом вот этого вам хватит вот этих вот команд в восьмидесяти процентах случаев и когда вы начнете изучать как работать с базой вы на конечно такой ресурс почитаете на этом ресурсе как правильно в каком порядке выполнять эти команды как открывать закрывать соединения чтобы вас ничего не вытекало вот и начнете работать но когда вы начнете действительно писать код у вас в среднем получится что то вот такое что-то такое и что здесь происходит здесь происходит следующее мы берем из каждого столбца базы маршаль данные в примитивы гол это неудобно потому что каждый раз вам приходится писать вот такой код вам приходится каждый раз явно указывать какую переменную вам данный язык запихать это поэтому люди сделали пакет который расширяет интерфейс предоставляемой стандартной библиотекой и расширяет он его определенными методами которые позволяют просто удобнее работать удобнее делать запрос в базу ну например если говорить о том как мы достаем данные той существуют вот метод строка который вызывает во мне перечислять примитивы по порядочку а просто взять и скормить ему объект структуры и он уже сам этот skrillex пакетик он внутри возьмет и данные из столбцов базы свойство структуру за маршаль от при этом можно указать аннотацию так вот аннотация можно указать аннотацию в которой будет показывать из какого столбца базы вам данные зама шарить объект структура вот так вот но кроме того когда мы начинаем работать с базой боб у нас есть выбор того какой параметр placeholder подставить не параметры между значения placeholder а в случае например если мы с мускульным работаем то значение placeholder в этом даже представлять ? если мы работаем с возрастом то значение placeholder для параметра будет перечисление с знаком доллара мужской light оба этих синтаксиса поддерживает the oracle вообще по своему живет вот ну как бы об этом изначально не хочется думать каждый раз поэтому существует вас кролик метод либо и отметки рыбой позволяет вам просто взять и подставить ? в любом в любому вашему искры из какой строке поставить ? и он уже внутри себя решит с какой базовый работать и какой действительно placeholder вам нужен удобно следующая печаль столик site in and parameters эта ситуация в которой вы хотите подставляете значение из структуры какой-то в запрос например когда мы делаем там фильтрацию мы можем не просто перечисление представлять отошел читаем и был мы можем поставить прям название свойства структуры и уже нет клэрион вам уже все внутри разрулит тоже удобнее позволяет нам меньше сделать код более быть более читаемый ну кроме того вы конечно почитаете в том ресурсы gtb с sql о том как вам делать запросы там будет все это описано но конечно писать более успеет код там цикл для выигрывания из базы данных не хочется каждый раз они скрылись предоставляет нам такие обертки не обертки как бы методы которые позволят вам проще делать просто упростить написание был петь кода g позволяют там вытащить одну строку из базы select позволяет вам вытащить несколько строк из базы при этом не приходится писать руками весь код там проход циклом и так далее но мы рассмотрели интерфейсы и его расширения интерфейс и расширение но для того чтобы действительности работы с базой нам нужен драйвер чтобы физически формировать запрос к базе по ее протокол и в голову существует два драйвера это существует не два драйвера скажем так на этом слайде показаны два драйвера которые наиболее популярные 1 драйвер lip пике это драйвер который был долгое время он оставался стандартом де-факто и все дефолт начинали использовать его и в документации скорее всего вы увидите именно этот драйвер но на сегодняшний день этот драйвер он потерял свою актуальность и на смену ему пришел джек ди джейкс это вот именно тот инструмент которым сегодняшний день нужно пользоваться если вы об сегодня начнете писать код для работы с базой данных с возрастом конечно то берите именно это драйвер почему ну определенные преимущества есть у pejic sap например он производительнее как заявляют разработчики 63 процента он производители чем-либо пике но как минимум уже за это его можно брать у него есть еще преимущество определенные он поддерживает те типы по сброса которые под блюз реализует вместо дарт sql вам с этими типами еще и удобно работать будет это драйвер пиджи x он позволяет вам удобно реализовать планирования то того что происходит внутри этого драйвера об этом я чуть подробнее расскажу он поддерживает бинарный формат параметров об этом я тоже расскажу это одна из тех вещей которые нам про это очень сильно пригодилась кроме того одна из свечей fedex это то что у нее есть нормально обработка ошибок у него человека понятной ошибки когда вам вернется ошибка выйду действительно сможете понять чего произошло потому что улик пике олимпик и бросает панике о панике все равно это вот не обработана исключение у вас программ просто падает если вы не поймали эту панику вот а паники в голову это вот ну совсем не нужно использовать это не тоже самое что исключения ну и кроме того джексон умеет конфигурировать каждое соединение по отдельности это тоже иногда может вам помочь ну интересная особенность мне нравится x он умеет работать с протоколом логической репликации подвеса который доступен с версии 10 ну хорошо а сам драйвер это понятно печи берем драйвер но что там происходит внутри давайте чуть чуть подробней углубимся в то как драйвер сильно работает но смотрите вот типичный код который вам требуется написать для того чтобы делать запрос базового но именно выгребать несколько значений из базы и что происходит когда вы вызываете роуз next вот вызов на самом деле внутри происходит запрос сеть который путь который наполняет буфер размером 4 килобайта драйвер и джексон внутри себя держит буфер в 4 килобайта и наполняет этот буфер соответственно если во время одного запроса все походы в базу вы выгребли данных там меньше чем на 4 килобайта и все что вам нужно это вот эти данные то все хорошо вы сходили один раз базу получили данные прошли стеклом и получили все что вам нужно но если у вас данные больше чем 4 килобайта в базе этой кстати учит в этом столбцы сами там какие-то эти параметры то тогда вам придется сходить второй раз потому что буфер на 4 килобайта вам не хватит получается что если мы ограничен четырьмя килобайтами то чем больше у нас данных тем больше по ходу все эти у нас будет необходимо сделать тут другая история что у нас например в случае если мы пользуемся таким драйвером то получать что-то что выглядит цветом миллиард запись из базы нам не нужна куча оперативки мы можем просто их молотить по 4 club ну так вот я подумал а может быть можно как-то изменить этот параметр то есть изменить этот размер буфера и получить производительность потому что мы перестанем ходить несколько раз сеть ну как бы оказалось что этого нельзя сделать драйвер pejic я завел еще разработчик драйвера сказал что ну над подумать но вообще говоря хотелось бы you space of когда вам это действительно понадобилось в одно я сделал форк и и и в этом форте в принципе выше он прикреплен там как раз сделал возможность изменить размер буфера попробовал на одном из наших сервисов просто в праге прямо запустил сходу нас этой прямо производительность какой-то высокой не дало потому что нас наверное объем данных не на phatal 4 килобайта вот но если у вас будет такой такая ситуация когда вам нужно проверить это то вы можете посмотреть на форк и за использовать его надеюсь что разработчику итоге у request примет и мы сможем как бы конфигурировать наш буфер хорошо с этим разобрались давайте дальше jigs это драйвер который на каждый запрос на каждый поднять о соединении он делает запрос в базу для того чтобы получить информацию об облик т.д. что такого объекта де позвольте существует такое понятие как обжиг to die и оно необходимо пользоваться для того чтобы понимать того чтобы как бы уникально идентифицировать различные сущности в самой базе ну например там типы столбцов они каждый типов имеет свой облик то иди и драйвера нужно это топ jack to die которого он там из определенной таблицы в базе получает на каждый поднять соединений объекта дима нужен для того чтобы понимать а из какого столбца базы в какой примитив языка данные маршале то есть например вот этот столбец и он винты и нам его надо действительно в int в голову запихать и внутри себя драйвер поддерживает вот такую таблицу такой словарик и в этом словарик из теста ключи на там название типа а значение этого объекта иди в базе так вот чем тут история основная здесь новая история в том что драйвер на каждую поднятие соединения когда мы каждый раз хоть и монтировать соединение с базой он идет делает там около трех запросов в базу для того чтобы получить вот этот список он же кадис формировать словарик и это делается на каждое соединение ну в нормальном режиме от веса посмотреть на этот график нормальном режиме когда у нас все работало в штатном наших количество транзакций вот таких вот поддерживающих и было 15 штук почему 15 потому что на самом деле go есть пул соединений и если мы используем соединение с планом не нужны как бы пири-пири инициализировать но когда наша база начала притормаживать случилось это в конце декабря я не ошибаюсь естественно запросы стали обрабатываться медленней и запросов стало больше в конце декабря и они стали обрабатываться медленнее что произошло у нас будет стали печататься был исчерпываются и драйвер начинает порождать новые соединения он начинает порождать новые соединения она каждый про новое соединение ему нужно еще сделать три вот этих вот поддерживающих запроса для того чтобы получить облик caddy ну чего так произошло количество транзакций на то чтобы получить обжиг to die выросла до 600 тысяч в минуту и причем это ну не совсем простые транзакции то есть это не просто там получить одно значение он на самом деле сканирует таблицу довольно серьезно в итоге нашим база рухнула по сути как бы кроме того что наши пользователи нашу базу начали заваливать запросами вы просто то же количество пользователей возросла под новый год так еще получилось что мы сами свою базу завалили таким вот поддерживаем запросами ну кажется не очень хорошей ситуации я не думаю что кто то из вас хочет повторение истории поэтому инструкция как избежать конфигурации размер вашего пола вот придет сегодня домой прямо откройте но вот посмотрите какой размер вашу плач сейчас ограничивают его сверху вот это две на слайде показаны две два метода которые которые представляют интерфейс стандартный интерфейс должны по работе с баллы вы можете там сконфигурировать эти параметры сделайте это мы не торте что происходит с вашим драйвером текущий момент что там внутри сейчас происходит стандартный пакет это были он имеет метод степс именно тэц он возвращается на пашот состоянии информации о драйвере о состоянии вашей коннектор на текущий момент принципе там есть немало информации но самое основное для вас будет это информации о том сколько соединений сейчас в пуль в пуле и какое состояние они имеют ну конечно pejic он имеет внутри себя тоже пул соединений он умеет имеет возможность предоставить его вообще вне интерфейса стандартного горного возможность работать с базой это нужно то что там более высокую производительность получить и если вы используете этот подход тогда используйте вот у внутреннего pla драйвера есть минус тета он тоже возвращает информацию о состоянии пула на текущий момент это важно и что еще важно еще важно логировать и вот одна из тех вещей за которую очень сильно можете любить pejic этот то что он позволяет вам блокировать что он текущий момент происходит с вашим драйвером как он сделает он предоставляет вам интерфейс лаггера он говорит что дай мне имплементацию этого интерфейса и я тебе верну всю информацию связанную с тем что происходит в он залог позволит залакировать вам всю информацию в драйвере так вот кажется что на самом деле вам даже не придется имплементировать этот интерфейс потому что pejic с уже из коробки имеет набор адаптеров для наиболее популярных в сообществе блогеров сообщества примера юбер за плагин logrus и все это уже есть прямо в пакете пиджи из используйте петлитель но кроме этого когда в тот момент когда у нас произошла проблема когда у нас тут базу упала естественно мы за бегали с горящим диваном и начали пытаться думать как бы нам все ето пофиксить но итог чему пришли это такой костыль который не нужно использовать вам не нужно использовать вроде но о нем стоит рассказать потому что нам все-таки помог он спас жизнь можно сказать собственно в чем идея идея в том что в конце концептуально мы просто взяли и запиши равале объект один на уровне приложения а в чем здесь суть суть в том что у нас есть топдек to die в базе паулюс причем часть этих общих to die они вообще говоря в исходниках поза пирса задано то есть там int и но основные типы int и стройке там они заданы в воздухе прям в исходниках захардкожены другие объекты ради они как бы формируется уже во время жизни самого о самой базы но как бы получается что если у нас база живет и она там стоит стоит мы переходим тоже кстати по идее меняться не должны то есть они как бы один раз сформировались больше меняться не должны это действительно так и на этом основан наш костыль мы сказали если так то какая разница чернов каждый раз делать там несколько запросов по сети и чтобы получить облик то задавайте их просто хранить у себя ну и начали хранить у себя мы зафиксировали на час и таким образом снизили полностью нагрузку на базу с точки зрения получения вот этих вот людей но использую почему это не нужно использовать потому что на самом деле в случае аварии вы скорее всего можете переключать мастер например какой то реплику поднимать до мастера переключать трафик на неё и вот такую ситуацию производить но если вы репетируете бинарной репликации то как бы все в целом будет хорошо потому что вот эти общепита диане как бы не меняются в рамках одной бинарной репликации но если например у вас есть логическая репликация и вы например поднимаетесь использовать во лжи и поднимаетесь из кульбака по произойдет ситуация когда вы ваша база начала иметь внутри себя о джихаде которые отличаются от того что у вас за кэшированных приложение и в этой ситуации все ваши connect и все ваши запросы они начнут валится с ошибкой и не будете понимать что происходит поэтому вот то что я рассказал раньше логирование мониторинг вот это все делать именно это и скорее всего вам это поможет решить ваши проблемы раньше чем ваша база упадет но такая ситуация такая такая история такой костыли к нам очень помог поэтому о нем рассказал ну хорошо вообще кто использует пиджи bouncer внутри которой под использовать сам кто использует пиджи балансер давайте поднимать руки страна был в интересно спросить кто работать после со но ладно почему странно потому что история в том что любой любой исцеляться любой остается после сна она внутри себя имеет bouncer либо одиссей конечно если в яндекс но тем не менее по сгрыз это та база которые на каждое соединение порождает новый процесс вы к ней пришли начали работать с ней и вам отдельный процесс в операционных систем выделился это не очень дешево как вы знаете и поэтому перед базой ставят такой кулер соединение это puller как бы стандартом де-факто является пиджи bouncer его ставят и он уже соединение все обрабатывают уже в потоках и как-то мультик фиксирует их на базу почему пользуюсь кстати больше чем 100 соединений мозга с не выдерживает то есть если уж без bouncy растаять и то больше чем 100 соединений на после задавать вообще нельзя вот ну конечно у нас есть g bouncer как это у нас выглядит все у нас стоят железные сервера на эти железо сервер стоит база данных рядом с этой базы данных встает пиджи балансиры скажем стоит и джебом сироток мы можем вставить в prezi не ухо проксю для того чтобы нагружать разные ядра операционной системы потому что приживался сам себе он однопоточный и он как бы использовать только одно ядро операционной системы поэтому вам этого мало вы ставите несколько пиджи балансиров и как то нагрузка между ними масштабируйте но с этим но джесс так же вам делать вот так вот с правой стороны с правой стороны у нас железный сервер базы данных с левой стороны у нас наши сервисы наши сервисы это те сервисы крутится кубинцев термик убирается это называется потом обычный у нас около трех instance одного сервиса поднимается как это происходит вначале у нас запускается и нет контейнер то есть мы начинаем деплоить у нас запускается и нет контейнер который пытается соединиться с балансиром на железном сервера с балансиром базы называем это серверный bouncer и он пытается накатить миграции если migrate or завершился с кодом один из кода 0 миграции успешными катились мы запускаем наш http-сервер и кроме того долгое время мы жили стыке где у нас а доминировал печки и поэтому мы еще запускали контейнер рядом стоящей с балансиром который работает вот рядом с приложением мы называли клиентский банк зачем это было нужно идея в том что ваш в печке код он не умеет поддерживать пул соединений поэтому если он будет конектится напрямую к серверам banki.ru он и сейчас что он просто возьмет и завалит сергей баланс то есть он будет мешать работать соседям на этом же сервере балансире это нехорошо поэтому мы ставили клиентский баузер рядом с печки демонами письку демоны характере с клиентском балансиру клиентский банк уже коннекте ласок серверному и так все работало но если вы пишете на гол то у вас есть по соединений внутри продолжения и поэтому вам клинский банкиры возможно не нужен носик на сегодняшний день мы до сих пор используем во всех наших инсталляциях именно клиентский bouncer но скажем по историческим причинам и мы собираемся от него начать отказываться такая история пиджи парсер работает в трех режимах он может работать в трёх режимах он может работу с вашим пуль ингео режиме эта ситуация когда вы говорите что у вас каждое соединение каждой сессии она имеет ей выдается в баузером одно соединение и все время жизни от и сессии одно соединение висит одно соединение закрепляется за этой сессии второй режим фразах shampooing у вас есть транзакция пока она работает у вас есть соединение как только транзакции завершилась commit и rollback это соединение пейджу баузера у вас забирает и отдает какой-то другой транзакции этот режим понимаете эффективен потому что он позволяет утилизировать соединение очень хорошо ну стоит он пыльник 3 режимный о нем говорить не будем потому что он деп река это ты он был создан только там это процесс поддерживать все такое собственно матрицу того какие фичи позволены в разных режимах можете проявить ссылочки посмотреть тот режим который выбираем мы это transaction кулер и какие проблемы есть с этим режимом но на самом деле есть особенности по работе с при pst ментами в режиме transaction pulling в чем они заключаются собственно давайте представим что мы хотим подготовить запрос и потому выполнить какой-то момент времени мы берем и запускаем транзакцию в этой позиции мы готовим запрос на правильность запросам при п получаем от базы данных идентификатор вот этого подготовленного запроса а после в любой другой момент времени мы берем порождаем другую транзакцию в этой второй транзакции мы выполняем ума . говорим базе вот тебе идентификатор нашего подготовленного запроса вот три параметры пожалуйста выполнен и как мы ждем результата все работает хорошо до тех пор пока мы не ставим и же баузер его мы ставим сюда как вы помните и потом включаем режим 2 закон pulling чего происходит режим транзакциям pulling происходит ситуация что у нас 22 транзакции могут по родиться в разных соединениях но вот это вот подготовка запроса и стоит над айди который нам возвращается он действительно только в рамках одного соединения то есть у нас в рамках присоединения 4 как вот это на первом блоке он будет действительно а в рамках соединения 12 который на баланс выделил во втором блоке он уже действительно не будет самое партию здесь то что пока мы наследники все это тестер у нас нагрузка с небольшой bouncer часто выдает нам один и тот же конец все хорошо но как только мы указываем этот сброд получается что часть наших запросов получает ни тот ни то соединение которое мы хотели в котором существует стоит над азии и запрос начнет завершатся ошибкой вот такая ситуация но тут конечно вопрос а почему вообще какие-то проблемы с имея имеем вот именно нашем коде на самом деле проблема в том что внутри если мы отработаем с стандартным драйвером внутреннего у нас есть неявный запрос на то чтобы подготовить как раз вот подготовить вот это выражение к ps3 внутри вот эту к вере контекст то есть запрос на то чтобы породить у нас есть двадцать два запроса например и на выполнение и они в двух транзакциях происходит это не происходит 2 транзакциях там и огребаем по полной вот всю эту историю с пиджи балансиром transaction pulling режиме ну конечно мы долгое время работали на печке и как это вообще все работало ночь просто мы не использовали при поистине мы готовили запросам их клиенте внутри драйвером и эмулировать такой препарат мент а внутри кода приложения мы использовали escape литерал функцию который нам escape как раз параметры запроса и как бы это все до сих пор так работает на самом деле но а как мы будем разбираться с этим в гол но первый вариант самый простой давайте просто пережимался переключимся ищем pulling и все будет хорошо у нас сессия установится у нас будет всегда одно соединение на одну сессию это не эффективно потому что у нас соединение получается не то есть и jpanther получается не выполняет свою функцию он просто одно соединение к одному мопед и база получается рухнет как только у нас больше ста клиентов будет больше ста сессий ну поэтому мы сразу отказываемся от этого варианта второй вариант подготовка также как и в пик давайте готовить на стороне клиента в письме кажется люди с этим смирились гол не хотелось этим мириться потому что во первых потенциальной скользим остина понятно даже всех учебниках написано используйте при предстоит на то что такое все будет хорошо никак иначе вот но конечно приходишь писать код по сброс и огребаешь по полное того что ты не можешь использовать при постигнуто но получается если вы эмулировать настроек client искали зв масти и кроме того из кепит параметры кому хочется с кипра метода никому стать больше кода нам не нужно поэтому есть вариант обернуть в транзакцию все это обернуть транзакцию как это будет работать да мы просто пройдем транзакцию а как мы знаем transaction пули mpi у нас одна транзакция пока живет соединение не забирается поэтому мы просто возьмем и в одной транзакции сначала запустим транзакцию потом подготовим запрос выполним его и закроем транзакцию это неэффективно почему потому что у нас получается большое количество сетевых вызвав первый вызов commit транзакции begintransaction второй вызов там pripyat третий вызов и где пьют 4 у , commit транзакции 4 вызова сетевые насколько у нас сильно упадет в этом все конечно это может быть не критично но кроме этого тут еще и кода больше писать ну неудобно поэтому мы выбираем подход не документирована параметр в база данных недокументированных возможностей базы данных собственно позже раз он умеет работать с бинарными параметрам что это такое значит это почитать можно подробнее 5 ссылочки история следующее вы говорите по сбросу что то что вы будете передавать как параметр это не текст а это параметр в бинарном виде и этот подход не рекомендуется разработчиками базы потому что он не документирован он может быть изменён этот протокол может измениться от версии к версии и использовать его вот прямо документация пишу не нужно но мы его используем кстати более того twitch тоже использует так защиту вот о чем этот протокол и почему он нам подходит этот протокол он простой то есть это это просто используйте этот протокол потому что мы в драйвере говорим типа начни использовать этот протокол и драйвер начинает за нас работать с этим протоколом в чем выгода выгода в том что здесь он начинает он перестает порождать какие то при pstn еще что то он просто начинает на стране приложения собирать запрос но при этом этот запрос он кроме того что собирается настроим приложений и летит в один сетевой вызов он еще и неуязвим для скроюсь es que el инъекций потому что параметры летят уже не в текстом видео в бинарном а это значит что база но мы уже базу не обманем с точки зрения построения дерева запроса поэтому подход с бинарными параметрами это просто это производителя может один сетевой вызов то есть мы вызвали получили результат и это безопасно на стране драйвера именно поджиг со этот подход включается вот таким параметром при few simple протокол true таким флажком включаете его и наслаждайтесь жизнью никакого эскейпа на стране приложения никакого никаких проблем с производительностью никаких проблем с безопасностью просто великолепно ну и теперь-то мы готовы работать под прессом на самом деле не может быть вы готовы но у нас вот такая структура была и в этой культуры оказалась одна маленькая проблема у нас bouncer был версии 1 7 как бы вроде кажется нормально но в vans era обнаружилась проблема связана с тем что когда клиенты отменяет запрос к базе bouncer в это время клал банкир как бы отрабатывал хорошо он брал отменял вопрос именно к самой базе клал это соединение используем назад в пул а потом брал и и зачем ты клал информацию о том что соединение готово с использованием в это соединение в итоге чего получалось в итоге получалось ситуация когда драйвер он начинал он выполнял там какой-то запрос происходило отмена запрос со стороны клиента когда клиент отменял запрос драйвер писал информацию пиджи полностью о том что соединение нужно закрыть балансира закрывал сидений и наш драйвер он как возвращал соединив пул следующий запрос начал с этим соединением работать но когда он отправлял поэтому сведение какой-то запрос и ждал результатом в ответ сразу же получал информацию о том что соединение готово к использованию и это вот не было вообще не то что он ожидал поэтому заброс задержал с ошибкой но как бы но самый сок в этой истории то что кроме того чтобы он мог просто получить она expected 3 factory ну вот именно неожиданный ответ могла быть ситуация когда рейдов о кларе bouncer еще не успел положить а в соединением положила формат с ответом запрос предыдущий и могла бы ситуация когда у нас как бы соединение из пула увернулась потом другу другой запрос его забрал и получил ответ не на запрос не не с теми параметрами которые он отправил с температуру кто отправил соседей пользователь получается что мы видели результат на странице там за приложение наши ваш пользователь например мог увидеть баланс счета не свой от чужого человека и это всеми моргалы еще очень сильно но вот такая история как это press почему это вообще происходило в языке гол есть такая такой метод контроля потока выполнение нашей программы как контекст и вот этот контекст он закрывается каскадно то есть грех человек в браузере нажал опять и получается что контекст предыдущего запросам и закрыли все весят контекст он летит через всю цепочку сервисов и как бы и в том числе в поход базу когда пользователь нажимает escape а текст отменяется и отменяется запрос нашу базу в итоге происходит у цвета машинерия с тем что у нас отменяется бал всю разрушается единение кладет нюк кривой результат на ну кроме того что сам контекст он может отмениться пользователям это еще и тайм аут тайм аута тоже контролирует свою контекстом поэтому тот путь в котором мы пошли сразу же быстрый fix подменяем контекст говорим что не важно что происходит снаружи запросы в базу мы отменять вообще никогда не будем просто вот такой таким фиксом таким к старикам мы исправили эту ситуацию ну как бы кастель это нехорошо и в итоге в жбан сыр был замечен fix это проблема джебом сфер перестала возвращать информатор фбр и перестал класть в соединении и к этому моменту мы начали обновляться актуальный панцирь был уже версия 19 мы обновились и что мы увидели на графиках когда убрали это костыль смотрите мы увидели вот этот явно видно что у нас упала light носик базе то есть неурожайным глазом мы получили мы увидели вот профит от того что мы избавились от костыля и действительно начали вот эти долгие запросы по таймауту и вот эти отмены пользовательских запросов по escape отменять корректно увидели падение latency очень приятно оказалось ну вообще выводы какие силуэту не знаю кого то сложилось впечатление что я никогда не буду использовать гол при работе с по стрессом но да я думаю есть качели после моего доклада но история на самом деле не в том что не нужно использовать гол а история в том что во всех других языках вы тоже можете с этим столкнуться и вы сталкиваетесь просто контролируйте размер вашим плов используйте бинарную бинарном представлении параметров не бойтесь потому что за последние версии как бы это этот протокол не менялся его используемый в использует твича не знаете мне верится вид этого поверьте твичу они тоже его использую этот подход конечно мониторить и лаггер уйти от очевидно вот ну и таким образом вы будете достаточно счастливо жить используя по сгрыз и работы с пользой сам с пользой гол вот поэтому спасибо надеюсь было полезно давайте вопросы я еще раз хочу напомнить что у нас идет трансляция поэтому когда задаете вопрос пожалуйста вот микрофон и желательно вставать очень желательно спасибо использую sqx со стандартным драйвером скуку но проблема по моему одни и те же вы рассказали про кто как bouncer некрасиво обращается с connect a mi то же самое и на уровне драйвера работы он понимает если открыть транзакцию что ее нужно через один конец держать когда пул есть но если делать что-то другое кроме от транзакции сет какой-нибудь запихать или при потому что нибудь он этого не понимает вот вы упомянули что есть какая-то тонкая настройка коннектов может ли она это все обернуть все удобно коктейль заставить работать то что должно в один конец она ходила в один конец ну вот это скорее нет как бы настройка коннектов тонкая нам помогла ну вот лесная история почему я хотел бы они веками вершинам она помогла исправить этот костыль с тем что у нас обжиг to die завалили базу вот настройка коннектор это вот вот ровно вот этот метод вот этот call back так как тут что не работает ну ладно в общем вот этот call back at эта история которая вот мы получаем ссылку на соединение дальше мы как-то configure мб откладывая ему кашированные объекта diy вот это история вот то что нам pejic сдал возможность конфигурировать каждого сиденья по отдельности нам дало возможность как бы вот таким castle ком быстренько заплатку поставить на то что у нас утекали соединение в куля там скажем вот вот так вот но кроме этого скорее всего не space of но там конфигурировать историю о том что то есть по сути консистентной какой-то я перемотаю в конец консистентные какое то типа хэширование или consistent ящик для того чтобы при прибивать каждую транзакцию к своему корректор такого я не знаю такого не скорее всего спасибо нас интересно вот слайд дополнительной информации как раз тут в твиче как папа сделают а десерты индекс можно посмотреть такие вещи здравствуйте спасибо большое за доклад не два вопроса первый вопрос так вы используете пока bouncer либо вас голос ну соединение и сам все там управляют не очень услышал вопрос вы используете pg bouncer да конечно я показал инфраструктуру наши просьбы сказали что там у вас какой то свой в есть collection на полу или типа того есть к нашим пул и в bouncer есть конечно полного собственно почему мы ставили 2 балансира потому что печки не было connection pool а и приходилось там понастроили клиента пиджи баузером вот этот пул держать иностранец сервера отдельный bouncer такой получать сказка от полностью две штуки там как минимум как минимум штук стояла случае с голод достаточно одного сервера банкира перед базой вообще все соединения неважно администратор приходит там по потечет на базе еще кто-то всегда надо гнать через bouncer все вот у нас железо сервер единственный способ зайти в него базу это зайти в него через петлю bouncer потому что если мы не ставим 5 волтер то сто процентов мы положим базу по количеству соединений вот еще вы же rest какой то пишите как вы определяете какой хендлер читается какой реплики это там асинхронная реплика или синхронная реплика или какая-то ручка у вас пишет как как вы что эти на какой сервер но на самом деле это вот везде по разному а скажем так у нас ну как бы резкий рост неважно каждый вот тут on point каждая ситуация она по отдельности обрабатывается у нас есть например друг города привод самом большом авито ну и конечно как у всех у нас есть вот такой аналитике и как в этом монолите счетам сейчас надела на историю с тем что у нас есть такой умный кошек который хранит данные в талантливы пытаемся понять я пришел запрос от владельцы тело ресурса если да то мы тогда идем в мастер если нет он на любую реплику или например если ресурс недавно обновлялся мы видим это там в кэше то тоже как-то рулим вот этой истории куда идем на мастер или нас life вот другая история например в сервисе который у нас там и сервис которого ты прям прописан ты ему говоришь подай мне consistent руб то есть ты он тогда пойдет на мастер если ты ему при передышки это параметр и он точно знает что вот этот параметр вон нужно доставать мастер это он идет там тоже на мастер с ты ему говоришь там consistent фолз и параметр какой-то которым готов достать слова он пойдет на своих вот поэтому это улице каждый приходится решать по отдельности придумывать решения вы решаете на какой именно sleeve ребекку с отставанием или вам нужна какая-то там вот это никак не решаем просто идем на любую реплику то есть любую реплику мойку мы просто верим что все реплики отстают не больше чем на какой-то порог и все если какая-то рубрика стоит на порог туда вообще есть нагрузки вырубая хорошо спасибо спасибо за доклад у меня дополнение и помощью погромщиков поводу дополнения есть такая популярная библиотека клубе грейтер может и вот хотелось бы дополнить что она поскольку держит свой connect и открывает свое независимое соединение базе то вот все те вопросы с отключением препаратов надо делать не только не только на уровне и джекил ну и на стороне этого кроме грейтер а вот мы сталкивались и и боролись с тем чтобы подключать везде где только можно этих при перед смотря по поводу вопроса джи ти тысячный драйвера для подвеса умеют сами находить мастера и это очень полезно в случае когда мастер заплела вируса и ехал куда другое место как накамуру не выношу решаете эту задачу 0 д с а у нас сказалось на уровне dns то есть мастер на спрос переключается именно осуществление железного cerato у нас поход железным хирург переключается просто dns мы снова траун так были бы летал и какие у вас там времена кипели этих записей чтобы быстро все все узнали о том что вот эта сейчас борисова честно говоря я какие конфликтов dns и я не готов ответить поэтому если прям хочется узнать поговорим тогда вот она посему спасибо за интересный доклад вопрос по поводу выбора драйвера по сгрыз делали вы делали ли вы какие-нибудь замеры при выборе если делали на что стоит обратить внимание ну вообще говорят pejic стоит брать не только из-за производительности хотя бы уже за то что он во первых поддерживаются olympique уже заброшен а во-вторых за то что нормально работает ошибками но производитель становится приятным плюсом вот это 53 процента то что я назвал это заявляют сами авторы pejic свои как бы естественно на их странице готовят можно посмотреть бенчмарки то есть не делали но не еще вопрос анализируете ли вы значение нет рассматриваете ли вы при обновлении версии библиотек наличие уязвимостей но да у нас есть такая практика вообще говоря в гол насколько это будет удивительно вообще гомиками тим vendor и призеры у нас лежит вендоры мы прям ну по крайне мере хочется всегда посмотреть код мы там иногда осматриваем код обновленных зависимостей вообще у нас есть в целом вся и такая история что запускается хотите курица checker ну просто из каких публичных бас берет информацию об уязвимостях и по не прогоняют наш в зависимости но правда для голос сейчас я не уверен что для главное используются но для первичного кода монолита ну точно используется спасибо вот у меня такой вопрос по поводу того что вы используете недокументированные киты функции мозга со в один прекрасный момент они могут это все отключить даже при минор нам изменение и соответственно получится не рабочий код лично я не думаю что это best practice использовать что-то что вы нашли это же то нет документации но как бы да любой момент может прийти человек в сообщество позволит взять отключить это нам и вообще сделать что угодно но вот обновление базы то не стоит история который происходит как-то автоматически или вообще который происходит тепло ребят сегодня у нас новая база типа все сломалось но нет она не так происходит у нас 96 на припасы как бы понимаете насколько мы отстаём от как бы up up stream альные стабильной версии вот но у нас достаточно долго тестируется и мы аккуратно обновлялись поэтому даже если там что-то сломается к тому моменту когда мы будем к этому приходить уже сам драйвер начнёт поддерживать это поэтому вообще не боимся спасибо еще раз гости насчет стакане кто все-таки какие-то подробности есть то что вчера нам адепты возраста рассказывали что ну там где-то тысячу коннектов вот максимум можно держать плюс у нас в год гарантированно есть пул который точно никуда не уедет выше своих лимитов зачем там вообще bouncer и такие жесткие ограничения ну целом это хороший заметка значит по поводу коннектов по сбросу у меня сейчас под рукой прям нету картинки но я где-то видел гражданам о том что типа вот столько у нас там про язвительность все как надо и же видел то а кстати вот ребята из камню и из под колеса не сделать часовой кулер они делают свой puller то есть прямо типа в ядре и базы будет puller соединение прижимался можно будет выбрать все такое но его и сейчас можно выбросить да если ты используешь голову и ты знаешь что у тебя очень строго распределены эти вот кислоты и у тебя например там у тебя на 510 коннектор на каждом балла на каждом пули соединений настроек приложения у тебя приложение не больше чем 10 гр уговорить а здесь приложение по 10 коннекта в пуле соответственно не больше чем 100 коннекта всего будет вообще не кит проблем в москве кулер работы копать в принципе может даже база выбросить просто писать память в таком случае это никаких проблем но если у тебя нет джо балансира а ты не знаешь сколько у тебя действительно приложение будет у тебя сегодня там у нас губернаторства у нас сегодня 100 приложение завтра 1000 человек пришел и за тепло и сколько ему надо там причем у нас ну ладно в общем из-за этого всегда нужно держать все таки серверный bouncer перед базой чтобы просто тупо не заводить базу к соединениями но по поводу метрик того что именно 100 соединений по моему я видел где-то в графиках как раз историй типа быть маркетинга puller а который сейчас делают внутри самого полиса вот но под рукой нету если прям хочется поискать можно тоже обсудить пока сева спасибо всем за вопросы спасибо докладчику за его рассказ выберите пожалуйста день самый интересный вопрос так ну какой вопрос вот вы задавали там я я помню просто к этому понравился там вопрос концепт задавал ну да напомнить вопрос а да ну нет не тот ну ладно хорошо тогда вот самый активный участник вот и давайте дадим хороша а у кого еще остались вопросы или что-то хочет обсудить с артемию прошу в зону дискуссии спасибо спасибо всем"
}