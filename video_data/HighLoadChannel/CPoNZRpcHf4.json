{
  "video_id": "CPoNZRpcHf4",
  "channel": "HighLoadChannel",
  "title": "SQL/JSON в PostgreSQL: настоящее и будущее / Олег Бартунов (Postgres Professional)",
  "views": 15538,
  "duration": 3521,
  "published": "2021-10-04T02:04:41-07:00",
  "text": "этот доклад я готовил ну больше года потому что прошлый highload не случился за это время у нас голове произошли некоторые изменения и вот видите изменилось название то есть мы назвали уже не просто мы сквозь и джейсон и что-то такое а называли его про джейсон где на стероидах то есть это действительно ну как бы важно и переключение у нас в мозгах этот доклад мы готовили с никитой глуховым которого здесь нет правда я хочу представиться тех кто меня не знает я занимаюсь по адресам с 95 года работаю я профессиональный астроном работаю московском университете и являюсь генеральным директором компании после то профессиональный а также мажорным контрибьютором адреса то есть вот этот слон он составлен из названий проектов которые я кантри beauty of пузырь с наверняка многие из вас как бы знают вот эти названия кто-то делал индекса и так далее я очень рад тем что я приложил руку к этим проектом никита глухова несмотря то что он присоединился к команде не очень давно но он уже очень много тоже сделал это тот человек который занимается с квали джейсоном тот человек который сделал джейсон пас но и вот мы с ним сейчас продолжаем работать над производитель джейсон дэй а давайте я расскажу как все начиналось на самом деле подлез является реляционной базы данных 1 которая в себя включила поддержку слабо структурированных данных вот посмотрите 2 тысячи третьего года уже в подгрести была доступна такой тип данных как эстор он до сих пор живой находится как андре бах это уже был прообраз будущего и структурированного хранилища в совете 2003 год знаете когда появился jason jason появился 2008 так что 2003 уже могли делать гибкие схемы не надо было менять альт р т ы был и так далее и штора является как я говорил уже частью по адреса с 2006 года в 12-м году появился тип данных джейсон это просто текстовая строка с валидации это мне не очень понравилась и поэтому в четырнадцатом году мы сделали настоящий джейсон бит тот самый тип данных которым сейчас пользуется весь мир он уже является это бинарное хранилище поддерживают вложенные объекты массивы ну и естественно есть индексная поддержки чтобы с ними можно было хорошо работать в 19-м году мы оживили проект и добавили поддержку джейсон паса джейсон пас это язык запросов джейсоном той с помощью его вы можете очень гибко описать ту часть дерева джейсона или под деревья джейсон с которыми работать то есть это очень удобно и хороший хорошая вещь а дальше мы остановились потому что надо было делать уже поддержку иску или джейсон функций который является частью стандарта но тут возникли некоторые вопросы и на этом я остановлюсь более подробнее но пока что я хочу сказать показать вам этот слайд по материалам сайта db engine это такая пузомерки для баз данных я построил вот такую картинку вы видите что здесь единственная база данных которое растет это пузырь с то есть ее популярность посмотрите 14 года начала расти и растет до сих пор то время как остальные это москвой oracle mssql они находятся более менее в константе или может быть чуть чуть по про проседают так вот это связано с тем что в паслись и появился нормальная поддержка джейсона виде джейсон бер и очень много мускульных юзеров пользователи пришло к нам то есть наше сообщество обогатилась новыми и новыми запросами новыми потребностями так далее и это началось водитель с 18 декабря 14-го года вот я обещал рассказать что надо что остановлюсь о том что сейчас есть подписи вот-вот подписи есть два типа jason jason б вот видите 2012 год 2014 джейсон б это бояре джейсон и они вот находятся не то чтобы в противоречие друг другом но как бы вот мешаются мешается первую очередь тем что джейсон изначально занял ну как бы название джейсон и нам пришлось делать джейсон b и вроде как бы это джейсон by не является стандартным но люди привыкли и пользуются им вот мы его развиваем джейсон б на этом запросе вы можете увидеть чем отличается джейсона jason jason слева просто-напросто это текстовые хранилище то есть как вы подали джейсон так он и астана они такого такой он и есть а джейсон бер это бинарное в нем ключи сортированный дубликаты вычищены и пробелы всякие white space и тоже удалены это позволяет работать с джейсоном очень эффективно вот джейсон где имеет очень богатую поддержку функции там один список функций там это зашкаливает существуют всякие расширения и существует индексная поддержка так что совет такой сразу когда я спрашивать чем пользоваться пользователь джейсон б очень редко нужен джейсон очень редко то что под grease так хорошо стал поддерживать джейсон и пользователь стали пользоваться джейсона в реляционных базах данных привело к тому что sql sql тот самый из quelle который говорил что никаких джейсону никаких массивов и так далее он сказал что теперь джейсон является с частью стандарта 2016 года то есть вот 22 фичи из нового стандарта это про джейсон из 44 конце декабря 16 года уже является действительно стандартам и так далее сейчас готовится новое издание стандарта в котором будет уже специфицированы тип данных джейсон и мы к этому тоже готовимся ну вот если кратко посмотреть стандарт включает описание модели данных вскоре джейсон в целом это тот же самый джейсон которому мы все привыкли второе это джейсон по сленг вич как я рассказал это описывает проекцию джейсона дерево джейсона вот то чем пользоваться дальше функциях и 9 функций 9 функций которые одни из них которые как бы construction functions то есть как сделать как иску или типы превратить в джейсон значения и каире как джейсон значение превратить войска или типы но тут их достаточно много мы решили пойти вот таким путем то есть мы взяли джейсон big как подмножество и сквозь сон модели данных при этом это подмножество удар от и уникальные ключи опыт показал что этого подмножество для профи всех практических задач и задач хватает и мы реализовали джейсон пас как наиболее важную часть стандарта то есть этим вы уже можете пользоваться это камин закончена в 12 в тринадцатую версию причем я хочу сказать что мы так постарались что 15 из 15 фич поддерживается еще общепризнанно что джейсон поспал risi является самым крутым среди всех остальных баз данных дальше искали джейсон функция функции мы работали над ними четыре года честно потратили время вы видите что 55 версией патча для искали джейсона и 48 версии патча для джейсон тепла вот столько функция столько почти сделано лунами для того чтобы в комьюнити пробить вот на на самом деле все это до сих пор ждет своего review и не закончена на это есть причина я расскажу потом индексы мы реализовали индексы то есть мы добавили в яндексе поддержку джейсон паса то есть теперь уже можно делать использовать индексы для того чтобы искать по джейсон пасу специфицировать но самое интересное что все предыдущие фу индексы существующее уже лежащие на диске те которые вы делали ли джейсон б они теперь поддерживают тот же самый джейсон пас без изменений ничего не надо делать вот список проектов вот за эти четыре года что мы сделали джейсон бер вот вы видите иску или джейсон функции потом мы делали обобщенный и пиа и для джейсона это связанно с тем чтобы сделать джейсон бер стандартным иску или типом это тот стандарт который будет в следующем году или в этом году уже будет признан и мы сделали специальные так лапе который позволял с помощью специальной переменой объявить джейсон by как джейсон так чтобы вы могли писать ваши приложения для одной базы данных для другой и так далее вот мы улучшали индексирование джинсы джейсона мы делали там селективные индексы расширяли синтаксис джейсон паса вплоть до поддержки там лямда функций и так далее вот пытались работать над simple тот наташин и так далее то есть действительно много всего сделано и это все можно увидеть даже скачать и попробовать потестировать я рассказала на предыдущих докладах на но сейчас для нас топ приоритет это сделать джейсон б как гражданин 1 сорт первого класса под алисе то есть чтобы у него была действительно эффективное хранение быстрые быстрые выборки апдейт что очень важно и хороший pr вот почему мы решили немного не то чтобы как бы поспорить немного придержать и остальные проекты а заняться именно этим связано с тем что популярность джейсона вот посмотрите по обзору 21 года в топ-3 фичи джейсон b и джейсоном находится на первом месте то есть действительно это люди реально пользуются вот я являюсь моим тренером канала телеграма позже sq или кто не знает то подпишитесь потому что там виде 6170 пользователей и там низко тысяч в онлайне непрерывно это можно решить любые любые проблемы так вот я сделал дамб и про гребень и оказалось что джейсон находится на третьем месте после selecta иску или то есть люди реально обсуждают джейсон потряси и тут на меня как говорится нашло прозрение о том что при том что у нас недостаточно ресурсов сообществе работать над всем сразу вот всем этим большим количеством проектов не хватает разработчиков review верах коми киров и вот видите сквозь джейсон четыре года мы потратили 55 версии сделали джейсон тайбл 48 версий вот при этом еще кого ни спроси любой стартап он использует подлез и вообще не думает о совместимости 40 лет эмали microsoft sql server кто здесь используют oracle или microsoft стартап ну может какой-то один отщепенец и найдется в целом нет такого нет это не только у нас в россии это и по за рубежом люди используют либо позорить либо манга ну так по большому счету и популярны джейсон дэй который является многим уже матерым как говорятся ну то есть взрослым солидным банк типом данных у него там большая функциональность поддержка вот она говорит о том что надо заниматься именно этим типом данных джейсон b то есть грубо говоря если вы пишете приложение уже вряд ли вы будете писать приложение для того чтобы быть совместимым еще и 40 вам есть по адресу он хороший я вас уверяю он хороший на нем можно сделать все большие федеральной системы россии работают на подвесе и вполне себе нормально так что если вы думаете ваш проект будет ли работает об адресе сразу вспомните яndex там они тадам они работают защите ваш проект сработает тем более что в джейсон бы есть что улучшать то есть и мы как раз задумали сатин а как же нам и что сделать чтобы джейсон бы стал действительно гражданином первого класса в адресе дело то что почему это вот проблема в чем состоит что вы взяли джейсон 2 работаете и вы замечаете непредсказуемую производительность вдруг и стала и всего он становится медленным вот пример классический пример простейшая табличка которая состоит из айди джейсона которые просто длинный массив ну просто 0 и 0 и и вы делаете вот запрос получаете шесть миллисекунд все хорошо просто вытаскиваете ключ аиде шкаф потом вы делаете облить то есть просто говоря добавляете ключ бар у которого значение баз и вы получаете места 6 7 секунд получаете шестьдесят шесть миллисекунд то есть в 10 раз производить ваше просела это конечно очень нехорошо это связано с тем что как раз повысился предел джейсон стал чуть чуть больше чем 2 килобайта и вы зато остались узнаете скатол стата то есть это такое отдельное хранилище для очень для длинных записей то что больше 2 к2 килобайта компенсированных все уходит в отдельные хранилища может вы об этом не догадывались но именно из за этого происходит вот такая такое просят следующий пример это вот популярная ошибка которая ко мне подходит начисто люди конференции говорят ну мы делаем табличку которая стоит просто и джейсона а иди внутрь и нам ничего не нужно и так далее вот сравнили наш производительность двух схем когда у вас а и снаружи и когда один внутри джейсона вот красненькая кратенько вы видите время доступа к ключу кабеля к егэ она постоянно а время доступа к айди которая лежит в джейсоне она зависит от длинны джейсона причем так линейно чем длиннее чем джейсон тем медленнее то есть это такая практический совет не поленитесь делайте таблицу хотя бы аиде вы носите и джейсона тогда будет вам жить легче чтобы дальше пройти нужно рассказать что такое тост толст это такое специальное хранение в подписях к хранения больших данных то есть в самой таблице в хеппи как мы говорим хранятся но значение не больше двух килобайт строка должно быть не больше двух килобайт но кто сейчас имеет такие строчки у нас у всех джейсон и достаточно развесистые таблицы достаточно широкие поэтому все что больше чем 2 килобайта даже после того как yes комп рисовали все уходит в отдельное хранения вот здесь написано здесь картинка такая да то есть ваша пример здесь а иди и джейсон так вот айди остается на месте а джейсон компрессе ца и нарезается на такие чанки 4chan как видите здесь и она уходит совсем в другое хранение то есть грубая невидимая для вас создается табличка для вот этих чанков которых лежат и девчонки и вся проблема как раз начинается здесь как только вы начинаете доставать какое-то значение из вот этого толсто вам приходится делать внутренней jojen тот самый join которую никто нас не любит то есть вам приходится читать дополнительные данные все эти чанки вам нужно потом это жениться и не толстеть в память чтобы с ним что то сделать вот при этом там в этой таблице существует свой b3 индекс то есть вы не просто to which входите вы ее сначала по индексу прочитайте три четыре или пять блоков а потом уже идете в табличку собирать вот эти кусочки чанков вот эти чанки то есть тасс это достаточно такая хорошо работающая но такое скрытая скрытая бомба вы никогда не знаете когда вы попали на это и вы начинаете начинается боль я дальше пропущу это немного теории 4 на самом деле видите чтобы таз произошел нужно сделать 4 шага это довольно сложная а покажу он сразу такой очень такой пример в котором табличка со 100 джейсона me & jason и разных размеров они от 130 байтов до 13 мегабайтах который компрессируются вот видите да 247 килобайт но такая обычная табличка которые запись выглядит так ключик очень длинный ключик и какие то еще ключик и какой-то длинный ключик кей 4 и такой стандартный путь когда вы делаете джейсон у вас разные разные размеры бывает вот и мы изменяем мирим время доступа ключу для каждой строчки тысячу раз повторяем вот делаем и такой специальный запрос тысячи раз повторяем чтобы померить надежно производительность и наблюдаем вот такую интересную картинку посмотрите казалось бы достать короткий ключик кей 1 да это же ничего а мы видим что все ключи вот время доступа ко всем ключам она одинаковая что для длинных что решил для коротких это связано с тем что вам приходится 1 ну разжимать все эти доставайте девчонки разжимать и так далее вот этот плоский кусочек плоский кусочек это как раз там где еще не наступило толст то есть там короткие джейсон и они лежат таблички и никакого толсто нет а вот дальше возникает наш кусочек вот этот кусочек вот этот кусочек это там помещается те джейсон и которые сжались до двух килобайт вот это видео строчка это как раз а вот вот это предел 2 килобайта а вот здесь уже рост линейно это просто вот эти чанки надо читать читать читать вытаскивать ну и соответственно по количеству записи по количество блоков который надо прочитать вы видите что как только наступает толстый вот толстый наступает вот начинается беда вам приходится читать просто очень много это вот такой интересный интересная проблема но это тоже самое только здесь по оси x не размер джейсона такой стандартные а к плиссированные размер джейсона здесь очень хорошо видно вот предел 2 килобайта то есть после двух килобайт начинается другой рост теперь это было все это диетический тест а если мы возьмем реальный тест есть такая база данных доступная свободная называется international movie database но грабаря база по всем фильмом мы взяли оттуда 4 ключа выглядят запись вот примерно так и здесь вот распределение ключей вот выглядит помечено звездочка видите вот аиде это короткий ключ короткий ключ и он достаточно популярный вот роли роли это действительно большой там бывает чуть ли не до мегабайта список ролей это же популярное вот высота это рост роз актера и соответственно мы еще взяли внутренние ольги этой базы данных тоже это видите очень короткие значения но очень популярны вот четыре ключа мы взяли оттуда и проделали то же самое что делали статические теста мы тоже видим здесь что действительно мы видим три участка вот онлайн это то что нет assets а вот этот кусочек это то что онлайн но сжатая и вот и этот кусочек то что-то снится и вот здесь да мы видим что действительно проблемы начинаются с того как происходит тост то есть мы поняли из этого из этих простых упражнений мы поняли что декомпрессия это большая проблема то есть для того чтобы вытащить какое-то маленькое значение вам приходится брать эти чанки и разжимать причем вы не можете сжать только один чан кусочек такой вам нужно все чанки разжать потом оттуда вытащить значение это большая проблема отсюда мы поняли что он вам нужно частично декомпрессия то есть разжимать только тот кусочек который нам нужен вот и второе это то что мы читаем слишком много блоков слишком много вот этих чанков нам нужно брать и чанки кусочек только те танки которые нам нужны но которые содержат то что нам нужно и дальше вот мы начинаем мы сделали проект то есть как мы улучшим вот этот тост хранилище и вот смотрите сколько здесь мы сделали экспериментов то есть мы где компрессируем только необходимую часть джейсона вот мы сортируем ключи по их длине это очень важно потому что у нас короткие значения лежат впереди а длинные лежат сзади и такой типичный паттерн использует джейсона у вас имеется метаданные всякие счетчики так далее и что такое длинные блога и обычно обычно обретет вот эти коротенькие и доступ коротеньким нужен вот существующим джейсоне это все как бог на душу положит вернее как вы назвали ключи существующим джейсоне запомните ключи отсортированы по названию ключей то есть у вас может быть так что впереди лежит большая плюха с коротким названием ключа и она будет портить все что там и так далее вот поэтому мы сделали так что джейсон без сам за вас внутри меняет хранения сначала лежат короткие ключи наиболее такие использованы и третье это частичные де тулуз то есть мы нажимаем мы только чанки нужные итератор такой 4 это онлайн тост дело то что когда я могу показывал картинку про то вас трудно было заметить но при тосте у вас ту полу то есть ваша строка она сжимается до тупо pointer а то есть место самого значения там лежит ой pointer на куда-то на вот этих чанки так вот остальное хранение остальное место в дупле которая лежит вашей таблице она не используется так вот мы решили что а давайте часть 1 чанка обратно положим сколько их хватит места в табличку обратно вернём и есть большая вероятность после того как у нас все сортированы по сдаче по длине значения до подмене ключа большая вероятность что вот этих как раз короткие ключи они окажутся ну и в онлайне и тогда доступ к ним не будет затрагивать вообще вот это толст хранилище этот мы назвали онлайн тасс ну и самое последнее самое вкусное это сделать расшарить и вот эти чанки расширить чанки это означает что что вы не создаете новую версию этих чанков когда вы что-то обретите вот сейчас вы должны что сделать если вы забудете какой-то ключ у вас и перепишется все то есть вся строка и все вот эти чанки они из дуплицировать появится новая версия это не только вы тут размер увеличите таблицы но у вас еще вот это все уйдет вал зачитывал в этот лог то есть если у вас был джейсон там 10 мегабайт и вы меняете один бантик у вас станет хранение 20 мегабайт еще 10 мегабайт уйдет в лоб вал это очень дорого так вот мы сделали так чтобы изменился только тот кусочек тот чанг в котором действительно произошло изменение все сами остались на месте и тогда будет блокироваться совсем мало и соответственно хранение не будет сильно изменяться это вот такой план который я вам сейчас покажу например на частично декомпрессии вот представим все ключи видите здесь пять ключей ключи лежат снаружи а потом лежат значения так устроить же есть андрей и вот слева это мы full пол одесская декомпрессия то есть когда мы достаем например 5 ключ мы должны то есть производительность и одна и та же вы все равно читаете весь джейсон вот размера вот ведь длина видите вот длина это показывает ну большой то есть третий ключ большой справа частично декомпрессия видите мы читаем не все а мы читаем вот кусочки только а джейсона но если мы хотим 5 джейсон взять нам придется все равно весь прочитать потому что он находится там и мы видим что как изменилась слева то что было справа что что что стало видите красненький точки это ключ первый ключ он упал упал вниз вот по оси y время то есть мы видим что действительно произошло что то такое то есть его стала к ней доступ к нему стала быстрее все потому что мы теперь считаем не весь джейсон а как только вы добрались до включая один все остальные ключи они пока читается также какая была потому что мешается вот этот длинный ключ он запер тоже сам мы видим то же самое на им baby а и от роли зелененькая я самое большое и вот мы видим что упала синенькая айди и высота рост человека роз актера упали а вот а и красненькая внутренние иди и роли они остались вот там вверху потому что пока роли запер заперли чем этот а им гибель чтобы это распереть нам пришлось сделать с отсортировали джейсон ключи по длине не по названию ключа по длине и то же самое сделали опять же значит посмотрели тот же самый пример и мы увидели видите как произошло изменение вот здесь вот здесь мы читаем уже не все вот как было вот видите а читаем только вот чуть-чуть потому что уже вот этот ключ он просто другой место попал вот это вот то что вам в свободное время за чашкой чая прочитаете это вот значение что привело видите у нас теперь отвалились все ключи вниз пошли кроме желтого желтой от как раз длинный ключ ну вот и синенький а вот красненькие зелененькие то коротенькие ключи они отвалились и стали чуть-чуть быстрее к ним доступ все потому что мы отсортировали ключ ключи для на мтб произошла примерно такая же картина то есть мы видели что теперь уже imdb иди вот видите здесь красненькие тоже здесь были а теперь красненьких там нет красники тоже упали потому что красненькие стали впереди зелененьких но впереди ролей роли остались они большие они стали сзади вот если вы интересуетесь здесь посмотреть то мы увидим что ускорение уже несколько порядка бывает ну зависимость и так далее дальше мы сделали вот этот битос де тост и это привело к тому что уже мы уже скорость вот доступ вернее access time он практически стал не зависеть от размера джейсона вы видите да что вот здесь была некоторая зависимость от размера джейсона а здесь уже вот видите не зависит фактически потому что мы берем только тот тот чан который нам нужно не не все ну на mdp ади мы тоже видим вы плащ его не и плоская плоская становится опять же здесь если говорить о числах это действительно порядке ведь от одного до ста два порядка ускорение может быть онлайн тост но эта тема такая же он говорил да что мы вот ctos ctos panther добавили некоторые хранение называется inline чанг это на самом деле кусок от первого чанка откушу откусанные и вернул вернули его в табличку в надежде что вот эти все короткие ключи метаданные они попадут туда это тоже облегчает как боится жизнь и действительно мы видим что произошло еще лучше что мы видим мы видим что вот вот эта часть упала вниз упала вниз и мы видим что действительно от и 1 микросекунды до ставились микросекунд мы уже улучшились ну тоже те же два порядка но просто поведение стало уже другое боем baby то же самое произошло то есть вот красная желтая верхняя часть упала вниз но до сих пор существует такой г вот ведь и ступенечку вот это этот ступенечка существует и мы ее как раз здесь убираем с помощью вот жареных чанков вот здесь написано что происходит на ищет я уже вам говорил что происходит когда вы обретёте джейсон вот пример возьмите 10 тысяч джейсон of которых имеется 1000 ключей то есть ключ простой 1122 и так далее и мы можем посмотреть что таблички сама занимает 512 килобайт а хранилище тостов занимает 7 из 8 мегабайт вот такой select надо и и за иногда его приятно посмотреть то есть вы смотрите ведь табличка маленькая а вот это дополнительно хранилище она на самом деле еще очень большой 78 мегабайт то есть сам джейсон это 19 килобайт он компрессируются в 6 килобайт эти шесть килобайт занимает 4chan cotos чанки размером по 2 килобайта вот здесь эти вот этих за запрос и они помогают вам понять как устроено на самом деле хранения не так как вы видите посмотреть табличку а как на самом деле происходит дальше мы делаем облить давайте про облетим колоночку айги она вот находится отдельно она не она маленькая она никогда не попадет в тост просто запрещено для нее для таких и для интерьеров уходить тос вот вы продадите ли занял это 42 дней секунды и посмотрите какой вал всего полтора мегабайта то есть 150 байт на запись при этом если посмотреть на размер толсто он не изменился как был 7 из 8 гигабайт так и остался табличка увеличилась два раза но это понятно почему потому что ну версия пока вакуум не прошел табличка два раза увеличилась tales не изменился а теперь давайте про облетим джейсон вот мы сделаем облетим джейсон мы видим что в 300 раз медленнее стала то есть занял это 12 секунд что такое мы видим что размер вала стал 130 мегабайт 130 мегабайт вместо пел полутора мегабайт ну и соответственно хранения тост изменился увеличился в два раза вы представляете дать чуть-чуть маленькой такой апдейте его все полетело в тартарары все провалилось вот и мы тогда вот как раз и придумали вот этот шарик жареный торс когда вот эти блоки или чанки этого толсто они не все копируются а копируется только тот создается новая версия того чанга который нужен которой лежит грубая вот эта часть атрибуты мы это сделали это опять же такая тонкость как это здесь устроен формат джейсона здесь очень тяжело и вам объяснить что такое но если вы скачаете вы поймете как устроен на самом деле хранение его на диске бинарная вот и как все это выглядит то есть в этом примере мы показываем как на самом деле происходит шарин толсто есть ну давайте я вот сделаю вот пример хорошо апдейт вот первый обдурить мы делаем говорим делаем а равно барр то есть ключ у а добавляем насчет добавляем ключ облетим назначение бар этот ключ и вот вот он верху а и он находится он не толстенный вот эти все бойцы это те где лежат эти ключи лежат где-то далеко видите там внизу тасс pointer вот мы видим что у нас при апдейте а ничего не особенно не происходит от а приобрети c вот есть ключ c у него есть ключ к структура ключ x происходит такие странные вещи у нас появляются новые версии чанков это приводит тому что у нас мы сохраняем и вот при первом дайте ничего не сделали мы сохранили мы уменьшили трафик и это привело к тому что вот видите синенький синенькие они упали вниз они были вместе желтенькие желтенькие то длинные ключи осинки были такие промежуточные длины они отошли то есть стала сильно лучше и на imdb посмотрите что произошло вот этот гэп который был ступенька она ушла то есть ступенька ушла остались одни вот в гордом одиночестве роли ну то есть длинные ключи длинный ключ остался а все остальное она примерно примерно не зависит от размера джейсона здесь размер джейсона меняется от 0 там видите тогда мегабайта то есть это конечно очень хорошо очень здорово однако нас всех интересует апдейт вот посмотрите что случилось в мастере апдейт приводил к тому что ну просто любой аптеке любого ключа приводил к копированию появлению новых чанков новых версий и у нас поэтому вот эта кривая задирается вверх а справа справа мы видим что маленький ключ и они ведут себя совсем по другому то есть они просто находятся на постоянном уровне константа это потому что мы совсем не трогаем тост они лежат но в той области которую не надо трогать промежуточные ключи они упали синенькие они оторвались от длинных ключей желтых но все равно растут потому что они все равно лежат в целости где-то на если посмотреть на вал трафик то мы видим что в мастере вот какой в как вал растет а вот приобрети маленький ключей здесь волкон под постоянной он не зависит от размера не зависит от размера джейсона для синеньких для правильного для ключей промежуточной длины и там действительно происходит тоже рост еще если суммировать все все тот например для синтетического тесто вот слева это мастер а дальше мы делаем по частично декомпрессия к сортируем ключ и частично did a steam далее делаем онлайн толст и следующий шаре тост вот все вот эти пять оптимизации на одном графике мы видим эволюцию как все меняется и мы видим что насколько сильно у нас производительность вырастает производительность здесь видно три порядка изменения при этом я хочу подчеркнуть здесь происходит полная совместимость с джейсоном то есть старый джейсон и новый они могут существу существовать потому что джейсон он внутренне расширяем вот его бинарный формат сделан так что он сам понимает какую версию джейсона читает то есть это вот мы такой эксперимент сделали очень интересно а вот для а м д б та же самая картинка вот эволюция как происходит до взгляну выключаем мы ничего не сделали но потому что как они есть и есть длинные ключи то есть пока мы ничего не сделали и вряд ли че можем особое сделать но короткий ключей те самые метаданные за которые мы боролись они стали вести себя совсем по-другому это очень здорово и теперь вот тут самый пример когда мы начинали что айди вне джейсона один внутри телефона то есть мы увидели что до ситуация улучшилась то есть вот ольги жки принципе можно держать внутри джейсона то есть она немного хуже стало но не-не-не-не существенно а длинный ключом там так продолжает расти это вот количество блоков прочитанных мой можно видеть да как стала то есть если вы читаете айди которая находится вне джейсона или читаете о гектору находится внутри джейсона разница нет по количество блоков вот маленькая просадка производителя свете вот желтенькая на чуть повыше чем красненькая она связана с тем что все таки достать и джейсона надо и вот этот overheat он есть поэтому конечно лучше всего держать айди снаружи но уже не так не так кардинально как как было дальше дел то что почему я люблю такие онлайн и оффлайн и в конференции потому что действительно мы получаем такие вопросы интересные до которые нас мотивируют на продолжают работать я за сегодня вот этого доклада переговорил не знаю с кучами людей получил кучу нашли интересных замечаний идей и вот прошло на прошлой конференции которая была в марте нам подошел человек она была в онлайне то есть где то там в онлайне мне задали вопрос вот как сделать стрим по грехи но это другой вопрос нужно ли не надо not представляете у вас имеется байты да и в их к нему добавляете блоки вот люди делали вы там не знаю фильм записывали ли что-то еще они столкнулись с тем что когда вы что-то добавляете было вы тратите гигантское время до трафик на то чтобы все это происходило в полисе вот пример добавить 1 байт вот имеется 100 мегабайт ни байта и к нему добавляем 1 байт занимает совете больше секунды но это связано с тем что как вы уже теперь знаете есть такая штука как толсто которая носит соответственно вот это 100 мегабайт копирует вал и копируют хранили и хранение александр зовут зовут александр и сожалению не запомнил его и мы серьезно задумались это такой челлендж появился как же сделать так действительно что можно было стримить web адрес и тогда мы придумали мы придумали пример что вот пример мы придумали сделать специальный такой формат данных да там называется подрасти то что передается значит функций и так далее как вот этот самый тасс pointer и еще какие-то inline данные то есть если вы хотите добавить что-то мы сохраняем его в inline данных в ту пле вот здесь нарисована видите вот это тасс pointer у него размер там 5 5 килобайт 5 5 килобайт этот размер вот этих трех чанков а это просто пойти и вот здесь мы добавили их маленькое хранение вот то что не хватает до двух килобайт просто для того чтобы например если вы хотите один бать записать вы прям записываете не туда а вот в это место как бы ускоряется а когда становится больше мы делаем новый чан вот когда мы увеличивается мы просто делаем новый чанка старое просто как бы сохраняем на месте и мы получаем такой интересный benefit до что вместо 14 чанков вот на таком простом примере да там сделали два аду мы работаем семью чан коми ну то есть уже в два раза но это просто кайт примитивный пример реально конечно вот например на том же самом примере если мы повторим мы получаем видите какую скорость в две тысячи семьсот пятьдесят раз больше быстрее ускорение то есть просто стрим занимает меньше миллисекунды вот так добавили при этом генерится таблица размер таблицы оставался то же самое примерно 100 мегабайт и вала всего 143 байта сгенерил ась вместо 100 мегабайт никаких там дополнительных ненужных и чтений блоков не нужно было то есть ну прям такой хороший хороший приятный мотивирующий пример который показывает как можно толст изменить чуть однако у нас вот здесь как раз показано то что есть в пастбище сейчас видите по оси x размер данных у старые стала размер данных и мы вот разные цвета это количество опенсорс то есть сколько вы добавляете к этому к этому размеру 10 байт 100 до одного мегабайта вот мы видим как у нас слева сейчас пользуюсь это происходит то есть у нас время execution time пропорционально длине джейсона и тому кусочку который добавляется а то что мы сделали у нас лети пропорциональность вот это за пропорциональности если вы не знаете я сам не знал вот за пропорциональности да он размер джейсона уже не вышел только зависит от размера того что вы добавляете по моему очень красивые такие картинки да видите как спокойно но это вот здесь вал тоже видно как вал работает стал вал хороший а теперь возникли другой челлендж это мы один раз сделали один раз добавили а теперь давайте сделаем так чтобы мы быть действительно сделаем stream то есть у нас строка строка имеет размер 0 и давайте добьём его до 1 мегабайта маленькими апдейтами например по 10 байт сколько надо сделать по 10 байт апдейтов чтобы дал один мегабайт но от если 100 килобайт вам нужно сделать d110 апдейта всего и мы решили посмотреть как это можно сделать делал то что использовали позже стас that statement для того чтобы вытаскивать время количество блоков и размер вала и действительно вот результаты стрима видеть и в старом возрасте как все происходило мы сразу уперлись просто производительности дело то что один мегабайт мы выбрали не случайно потому что ну просто место на ноутбуке стала вылетать потому что когда вы начинаете обвесить вот такие уже от 100 килобайт так далее то есть у вас начинает вырастать таблица ну очень круто представляете вы 10 10 байтами кусочками облететь его сколько вам нужно там тысячи раз облететь пухнет таблица пухнет вал поэтому ограничить одни мегабайта и вот справа как у нас происходит на щит стало уже сопин добыл байта вот это показывает о том какие большие перспективы то есть ну как бы действительно вполне можно сделать такой тип данных апдейт обл стримить и но это вот здесь показан вал размер вала как растет здесь ведь размер овала зависит только от разряд от размера добавляемого куска а здесь он зависит слева зависит от самой строки опять же ну это вот мы сделали полосу посчитали сколько мегабайт в секунду видите слева у вас вы начинаете вот маленькими вот внизу это вот вы быстрее 10 байт ными кусочками ну то есть действительно здесь у нас начинается там с мегабайта секунду очень быстро мы килобайта секунду спас падаем то есть полоса сайт совсем маленькая если мы увеличиваем все становится очень много лучше но опять же все спорт падает вот а справа мы видим такая постоянная нормальная производительность то есть мы можем предсказать что если мы хотим занять полосу там 20 мегабайт в секунду то надо просто напросто ответить там килобайтами чан коми и не будет его деградации производительности не будет это вот такой интересный пример ну вот здесь я хочу сказать что мы у нельзя было оставить манго в стороне да поэтому мы решили как-то посмотреть как все это выглядит и я отдаю отчет что это абсолютно ненаучное сравнение потому что хороший benchmark это отдельная большая работа которая включает себя там не знаю провели настройки правильно и железо там большой опыт мы просто сделали значит как бы вы видите да то есть мы ищем по а им baby базе данных мы ищем считаем количество записей в которых ешка содержит слова кабирия кабеля знаете ки ночи кабирии был фильм такой вот мы копирующим и после связь memory манга 444 и два варианта 16gb memory и 4 гигабайта это мы как бы половина памяти дело то что здесь мы два взяли случай а потому что после 100 работает в памяти с сжатыми блоками вот эти толстянки они лежат в уфе раху адреса сжатые а у манго ниро сжатые и поэтому манга она занимает несколько раз больше в два раза больше памяти требует чем позарез и если например если например подвес puzzles у не хватает памяти он деградирует естественно но не так сильно как деградирует манга то есть в манге если вы не попали в память выпроси дайте очень сильно это здесь видно вот видите слева мастер вот это мастер а это вот манга выведем что mango выигрывает мастер раза в три и дальше мы добавляем наши оптимизации то что я рассказывал то есть вот декомпрессия ключи сортированный там дето осень и так далее и так далее и мы в конце концов доходим вот до такой штуки то есть мы уже вот здесь шарит толстых начинаем выигрывать мангл но я хочу сказать что все тесты которые мы делали мы делали с выключенной параллельность you вы знаете что у бориса достаточно хорошая поддержкой параллельности да мы ее специально выключили ну чтобы иметь нормальное представление достать она производительности а здесь просто включили параллельность и когда мы включили параллель из мы стали быстрее манги еще во много раз вот маленькая этом он до 16 гигабайт а вот манга 4 гигабайта то есть база половина база только память получилось так вот она видите почти как говорится ну ну почти как пузырится просто как только как только вы не хватает памяти но и как сказал это уже ненаучное сравнение на вещества с полисом ненаучный benchmark буду рад если тут есть колесо и для зная манго и да то есть есть манго или да там и буду очень рад просто сделать benchmark на реальных данных на реальных запросов я думаю будет многим интересно ну вот я тут подошел концу ночи мы продемонстрировали шаг за шаг улучшение джейсон б причем с обратной совместимостью как и говорил джейсон был устроен так что он сам распознает новые форматы хранения и это привело к тому что действительно там десятикратное у ускорение для select of ну и очень очень дешевый апдейт произошел и это наталкивает на то что мы находимся на правильном пути кульки пи джейсону ну так то есть может действительно не только быстро читать делать точечное чтение но и апдейты можно делать этот очень не хватает многим людям тут ко мне подходили действительно говорили что частичный апдейт это очень нужен хочу сказать что частично апдейтом он гонит там тоже там копируются все мы здесь сделаем 1000 апдейт если кто хочет поиграться посмотреть тот вот на гитхабе у нас все это лежит мы отнял не скрываем ничего и как известно слайда этого доклада на ней доступны делать он действительно содержит гораздо больше информации просто такую и торе очень тяжело подробности технически рассказывать но хочу сказать что вот тот же самый подход мы можем применить к любым типом данных у которых есть возможность рандомного доступа к частям например масел и можно сделать то же самое для массивов доступ какому-то определенному элементу массива dat а тот же самый штор можно сделать тип pdf ип документ pdf фонда которому имеется в заголовке имеется просто ссылки на страницы и можно легко делать доступ к любой страница не скачивая весь документ то есть это вот семья на пир возражай когда там встречаю суку на под документ я должен ждать когда весь документ выкачать а тут вы сразу даете ту страничку которую вам нужно вот мы показали что можно сделать open дабл бинарная тип и там мы видим прям тысячекратно улучшение производить тысячекратно и это конечно тоже вот у нас доступна в отдельной ветке это может потестировать нам мы всегда готовы к сотрудничеству вот и внизу две ссылки которые говорят вода два других доклада более обширных в которых уже не просто вот то что я рассказал а есть содержится описание всех других проектов кому-то может станет интересно это вот как бы расширение синтаксиса новые индексы там до обобщенный и 5 для джейсона мы кстати с этим обожженная piarim.biz он а мы сделали возможность ответ сделать джин индекс для джейсона вы знаете что джейк джон индекс существует когда джейсон бей а с помощью того я и пиа я можно сделать и для джейсона и так далее это все вот этих двух ссылках есть что нам нужно сделать дальше нам нужно сделать больше бенчмарков понятно что бич марки должны быть либо общепризнанные такие как в айсе и сбивайся из бета общепризнано benchmark для не структуре новых баз данных или например какие-то типичные из кейсы вот эти из кейсы они конечно интересно какие у вас действительно ли так что джейсон как бы использую так как использует джейсон просто чтобы положить и взять или просто чтоб как как правда и какие ключи достаются что вы делаете с длинными блогами с длинными массивами да это очень важно чтобы мы знали что оптимизировать чтобы мы не оптимизировали сферического коня в вакууме а как-то сделали доброе хорошие да ну и конечно надо пробить маркой пудришь с мангой это очень важно потому что я уже несколько раз здесь суд встречал людей которые сказали что они используют postgres но вот часть данных держит в manga потому что вот и нам как раз интересно и вообще stack overflow дело в этом году обзор и показано что 2 2 наиболее используемые вместе базы данных вообще среди разработчиков stack overflow это пузырь из манго то есть никаких другие базы данных нет пол рис манга и часто действительно в подвесa люди держат использует традиционную структуру до электронные данные а в манго держит вот весь этот мусор джейсон но тем что puzzle is он мы улучшаем подлез мы стремимся к тому чтобы часть вот этих манго и давно потихоньку все-таки пришла к по адресу и этим самым мы будем поддерживать рост популярности ip-адреса и поэтому нам здесь конечно очень важно работать с реальными реальными пользователями очень интересно расширить вот этот подход жареных чанков толстых на того чтобы поддерживать строки массивы массивы джейсон of сейчас мы только что поддерживаем только рутовые объекты а надо чтобы еще может была власть ну и типа иерархии то есть потому что джейсон это может быть развесистой дерева и можно вытаскивать не все под дерево кусочка еще внутренняя вот большая работа конечно поплава был толст у дело то что все что я сказал это очень под вопросом как цвет интегрировать это все в ядро по улице ну то есть отдать сообществу мало сделать ссылку на git хоп и сказать берите нет конечно сообщества надо бороться бороться за то чтобы она приняла как сделать вот этот новый как сделать так чтобы тост был как сказать тост знал тип данных как лучший для как для типа данных сжимать работой например если это просто интеджер ну ничего не надо делать с ним да там если это джейсон то тогда надо использовать вот то что мы наделали если это массив то дальше что то другое то есть мы хотим сделать благо был тостер чтоб можно было сказать там критий был там так далее мы же говорить сейчас сторож extended напье 40 external main player так что можешь было говорить вместо этого можно было говорить название этой процедуры которая наиболее оптимальна для данных для данного типа это вот такой как бы расширяемость патриса ну вообще подумать над сторожем новым сторожем в котором вообще не толсто типа вот в нем лежали оптимизированы для дерева подобных структур в которых есть большие атрибут это то что у нас в голове сейчас сидит и над чем мы сейчас думаем ну и соответственно я уже просил что нам нужны ваши тестовые данные запросы если можете анализировать дата и дать нам мы будем просто счастливы и рады своим по сотрудничать вот есть наши наши email и можете так далее но и хочу закончить вот такой картинкой действительно pausini dos пассос вот я вам хочу сказать действительная 2595 двадцать шесть двадцать седьмой год работаю с пульсом никак не понадобились другие базу данных вот"
}