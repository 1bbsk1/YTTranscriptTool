{
  "video_id": "ae101YtVpC0",
  "channel": "HighLoadChannel",
  "title": "Платформа видеоконференций ВКонтакте – сделано удалённо / Александр Тоболь (ВКонтакте)",
  "views": 2738,
  "duration": 2892,
  "published": "2021-10-04T02:26:57-07:00",
  "text": "и так уже меня представили меня зовут александр и действительно 15 лет коммерческой разработки 25 лет программирования 10 лет разработки media service of a сегодня мы поговорим про платформы видеоконференций ну чтобы еще наверно добавить у меня информации я отвечаю за техническую часть вконтакте и отвечаю за единую платформу звонков почему сегодня про видеоконференции ну наверное все знают началась пандемия и нам надо было где-то разрабатывать общаться и мы решили сделать свои звонки ну конечно нет если посмотреть на соответственно графики которые нам дает то пение bloomberg все говорят что с момента пандемии у нас возникло невероятная потребность в видеоконференциях которая вот на всех графиках отражается большим количеством инсталляций и соответственно мы тоже как бы хотим быть в тренде и вот это все вызвал большой интерес на самом деле в бросить в вопросы и большой hyip вокруг видеоконференции у меня многие коллеги спрашивают друзья знакомые какие-то сторонние стартапы постоянно как устроен зум как устроен clubhouse что мне взять для моего сервиса звонков как не ставить звонки в мой сервис вот на самом деле ровно поэтому мы решили еще пообщаться сегодня прозвонки если посмотреть наверно на все крупные сервисы они уже все обзавелись звонками появилась масса стартапов за последний год давайте посмотрим как вообще крупные сервисы работали с именно видеокоммуникации что запускалась началась пандемия в discord удачно покрутил свои настройки и увеличил количество участников в чате до 50 воцап тоже переделал немножко layout и смог выжить со своих звонков 8 вот как видно все крупные игроки стали торопиться и запускать свои сервисы clubhouse вышел без android google мид запустился бесплатным зуму снял ограничения на 40 минут потом правда вернул ну как бы вот видно что каждый месяц буквально в течение года да сейчас у нас постоянно выходят новые новые апдейты звонков различных сервисов сервисов коммуникации все остального вот в марте появились видео звонки на десктопе воцап а еще в мае нас обещает telegram побаловать групповыми звонками у нас групповые звонки были давно и так же как и все будет будучи в тренде мы на пандемии запустили групповые звонки на 8 потом на 128 и в этом году планируем сделать на тысячу а про что мы сегодня с вами все будем разговаривать начну на самом деле с такого немножко отвлеченного рассказа мне один кандидат на собеседовании сказал что он посмотрел мой доклад про сети кстати кто видел мой доклад просите отлично много много людей вот и он сказал что ему это очень помогло от собеседовать в большую крупную зарубежную компанию вот и пройти собеседование поразить интервьювером я внушительно здорово что не только рассказывать о том как мы что-то внедрили но и рассказывать еще теорию которая на самом деле позволяет вам внедрить что-то свое альтернативное поэтому сегодня будет много теорий начнем вот так вот что здесь куча страшных слов которые на самом деле к концу моего докладываю все будете знать это к план доклада мы начнем как я сказал с теории потом рассмотрим на практике внедрения звонков вконтакте посмотрим как перейти на решение для 1000 и больше участников посмотрим мы конкуренты различные трюки немножко посмотрим на upon source и на то как внедряется и мэр звонки но и общий подход к созданию таких сервисов дисклеймер все из цифры по конкурентам полученные на самом деле путем общих наблюдений и измерений мы никого не реверс инженере ли ну в общем стандартный подход к разработке любых сервисов сначала надо понять что хотят пользователи если вы крупная компания можете провести маркетинговые исследования компания поменьше ли стартап проведите коридорные мы такое исследование провели и заметили что пользователи хотят много чего ваш важного но самое главное это качество то есть все же все пользовали различных видеозвонков жалуются на качество ну и конечно все всегда все хотят бесплатно среди жалоб основная история была на плохое качество видео на нестабильность на зависание на греющиеся телефоны взлетающие компьютеры не комфортное общение как есть мы проанализировали конкурентов посмотрели у кого что есть на самом деле как он видели на предыдущих слайдах самый крупный растущие зум и google нет у них на самом деле отличаются большим количеством участников может быть это и не нужно но потенциально вас можно что вашей встречи соберется тысяч людей это здорово вот почти все крупные сервис поддерживают все возможные платформы звонками по ссылке сейчас никого не удивишь демонстрации есть почти у всех но и запись там виртуальный маски и вся история таки да комплементарной истории какой-то супер серебряной пули конечно же в этом месте нет мы выстояли для себя требования неограниченное количество участников почему бы не потягаться работа на всех платформах и низкое потребление серных ресурсов почему ну мы на самом деле комплементарный сервис нам нужно балансировать мы не можем совсем там идти в решении которые вам дают он прям сервиса но с точки зрения пояса ли это высокое качество звонков стабильность очень просто сделать крутые звонки того чтобы формализовать такую задачу нам нужно ножка разобраться в теории и так на самом деле любые звонки состоят из трех уровней первый уровень это наверное signaling это уровень бизнес логики в котором вы как-то сами подключайте ваших пользователей координируйте этих пользователей и дальше устанавливается некоторые сетевой уровень сетевой канал между ними через который же будут передаваться видео и аудио данные если говорить про signaling то у него задача аутентификации там установки соединений списке участников блокировки зал ожидания все остальное похож на волю ближе всего нам какой-нибудь messenger на высоке тем которая мне к все описали сохранением состояния всего остального сегодня мы будем мало про него говорить про сетевой уровень так как я видел что много людей видели доклад про сети быстренько пройдемся значит так мы говорим про real-time коммуникацию прозвонки то все конечно же будет пройдите про минимальной задержки вспомним чем у нас характеризуются сети вы отправляете какие-то данные все эти они разбиваются на пакеты приходят на клиент с каким-то прорежем нам времени на эти пачка пакетов если вы сложите весь размер пакетов поделите на время получить некоторые бренды с это пропускная способность сети если у вас на пакет есть так новый домен подтверждающий что в этот пакет видели ну или pink например вы делаете эхо запрос датой строя теперь получаете ответ то вот это время ттт ну и наверное еще важно история по которым будем говорить это пакет лосс вы отправите пакет он потерялся wendy's будем мерить в челобитных мегабитах катетер миллисекундах packet loss процентах какие у нас еще будут дополнительные истории round trip и на самом деле пинку это случайная величина можете пинговать хай лола тут я сегодня утром это сделал вот пинк вот так выглядит не знаю что там у нас с вайфаем или еще с чем-то но pink вариативные для оценки а вариаций используется джек джек и у него есть разные механизмы измерения мы меряем его как мы не минимальную максимальную задержку между пакетами есть некоторые тамары все которые меряют чуть по другому но нам было интереснее видеть это так очевидно что когда у вас пакет и приходят группируются пачками вам нужно как то с этим бороться чтобы с этим бороться у вас есть некоторые джиттер буфер который собирает определенную пачку пакетов и выдает и равномерно ну например у нас вот прилетел один пакет предложим в пакет обычного и вкладывает в пакет например 20 миллисекунд аудио вот у вас прилетела 20 миллисекунд аудио в их проигрываете у вас задержалась палочка пакетов вы проигрываете тишину потом пролетела еще пачка пакетов вы играете но вы начали уже там на вот это отставание 40 миллисекунд стабильно отставать вот ваша задержка вот вы отстаете в принципе вот джиттер буфер примерно так идиотом компенсировать задержку следующая история про которую мы поговорим это как бороться с потери пакетов здесь вас помогает farther correction или избыточное кодирование кто видел так вот просить истории я буду ускоряться все равно нам придется тоже послушать вот вы добавляем дополнительные избыточные коды например можем просто показать пачку пакетов добавить к ссор если у вас пропал пакет нам пришел к ссорам можете его восстановить особенность у вас дополнительная вверх от даже если пакет они пропали и можем чинить только фиксированный процент если вы заложили допустим там оверхеды 3 процента если у вас пропала 4 процента вы его не почините фиг очень удобно комбинировать с на ком снега тифа канал и жми там что происходит вы отправляете там три пакета 2 дошли один пропал пускать 4 5 пропал после этого у вас пропал пакет после там пришел 5 пакетов у вас два пропали один починили всяком один не знаете что делать починили на ком соли быстро ускорился вот соответственно вот в этом месте можно чинить негатив окно ложементом пакеты чтобы делиться срал чтобы бороться с раунтри пами надо использовать на самом деле седины вряд ли вам что-то еще пазу поможет мы стали мм сервера в разные города ну тут надо еще знать некоторые особенности работы операторов например если вы пытаетесь найти пир toupper соединения кто-то кому-то звонит из владивостока по вайбу на пир toupper соединение то в разных мобильных операторах может получиться что звонок пройти через москву для того чтобы это починить для наших пользователей мы устанавливаем сидена которые перед с разными операторами и мы можем например в этом случае запустить этот звонок через хабаровск или новосибирск метрики сети понятное дело что в зачем вам рассказывал про сидел метрики сети будут у вас разные это зависит от дел распределенности ваших пользователей от того какого остановлено сервера но вот покажу наши цифры для оценки больших цифр когда у нас большая аудитория мы обычно используем persantine мы оцениваем медиану то есть среднее значение у нас здесь все хорошо он 140 миллисекунд довольно короткий и например 99 перцентиль что он принес 9 перцентиль в 550 миллисекунд prt значит что 99 процентов пользователя ртт звонках меньше 500 50 миллисекунд и мы для себя решили такое требование что наша задача отработать хорошо ну или вообще обращать внимание на 9 процентов пользователей у нас все эти вот примерно такая то есть я сразу призыв цифры продвигаться процентиль проговорю у нас 19 процентов укладываются 550 или секунд у них интернет есть хотя бы 400 километров pocket лосс два и два процента или меньше и у них на самом деле джиттер см10 секундах посмотреть разницу между пакетами то может доходить прям до 1 4 секунды наверное стоит отметить вот мы говорили prophet cынок что при таких сетях когда у вас маленький пакет лосс но большой ртт вам выгоднее чиниться веками что мы быстро узнали сейчас за сетевой уровень что сеть данные передаются в сети пакетами там есть бендис rtti пакет лосс все значения меняются во времени в зависимости от того как распределены ваши пользователи распределён ваш сидел у вас может происходить такая ситуация что одно и то же самое развернутое решение звонков разных условиях будет работать лучше или хуже с точки зрения вас вам необходимо смотреть на цифры на пирс интере не смотрите на средне вот ну и для компенсации джиттера есть джиттер буфер для компенсации ртт band веса мы используем сидена для работы с пакет лоссами у нас есть алгоритм эффекты на перейдем дальше к следующему li.ru мы уже здесь прошли signaling прошли сетевой уровень и теперь аудио и видео история и так теория с аудио по планам большой сложной но собрались на самом деле все будет просто 1 наверно часть которая срабатывает при начале звонка это хак insulation ну или aig акустика hack and slash в чем его суть предположим алиса звонит бабу борису алиса звонит борисом вот у алисы все хорошо цеха конце лишена мы вот у бориса плохо он у него не работает что происходит алиса начинает слышать себя обратно то есть если вы слышите себя обратно проблема не у вас у вас есть звонке какой-то пользователь у которого не работает echo cancellation вам нужно срочно замутить наверное на удаленке вы уже все с этим столкнулись и научились их находить следующая история которая в аудио pipelines всегда встроена неотъемлемой относится брошен в том что микрофон и ваших ноутбуках стоят рядом с вентиляторами если туда от туда забрать оригинальный звук то вас вас будет просто не слышно поэтому есть их подавления которое дарит давид разные шум и белый шум розовые все остальное вот следующая история это вас activity detection он говорит вообще оценивает говорите ли вы в этом интервале времени или нет если нет голос это очевидно можно экономить его можно не передавать на сервер вот и дальше у нас game control это история с тем чтобы у всех было примерно одинаковая громкость мы отправляем эти пакеты кодируем отправляем сеть на другой стороне когда вам что-то говорят вам сразу все приходит по сети тут отрабатывает джиттер буфер мы про него уже поговорили и дальше вы можете что-то починить догнать time стретчинг вот дальше то выпадает на audio mixer вашей системы если у вас много говорящих он smack суеты всех ну и собственно вот про компенсацию задержки вспомним про то что был джиттер буфер который нам создавал задержку то есть если у нас киты пакеты по дергались он немножко отставал у вас появлялось задержкам звонки вы могли друг друга переубивать что можно сделать с тем чтобы ускорить задержку починить это задержку самое простое это ускорять тишину то есть если у вас хороший ватт вы можете ускорить тишину вот склеить просто слова и на самом деле все чем лучше ваш бой с детектором тем лучше вы склеиваете это слова но если вы ничего не можете склеить то вам надо ускорять голос он будет немножко гномика чтобы этого не было есть специальные алгоритмы можно посмотреть в например сонник используем с точки зрения кода к аудио обычно используется опус он хорош тем что он на всем диапазоне частот показывает хорошие цифры у него низкие задержки кровь есть такая еще интересная история пакет лосс консилмент внимательный человек заметил что один пакет на входе джиттер буфер 4 он пропал если у вас потерялся кусочек например длиной 20 миллисекунд его можно придумать вот на самом деле на исходя из вашей речи очень довольна проста коды корпус может 20 миллисекунд придумать так что будет довольно незаметно дальше это будет уже странные эффекты вот чем мы запомнили что пойти класс консилмент маскирует потери пакетов его не надо путать например с веком потому что фиг вам добавляет избыточное кодирование это по сети дорого это опасная история апельси это довольно халявно из 20 миллисекунд используйте тир проговорим право time стретчинг про гномиков и про ускорения представьте такую картину вот слева это вам приходят пакеты пакеты приходит задержки 20 миллисекунд от пользователь но потом у вас случился какой-то стол мачта залипла и потом они пришли подсекай как а их будете поигрывать сначала вы их проигрываете нормально по 20 миллисекунд потом у вас остановилась все у вас нет пакетов но через plc один пакет починили что-то придумали хорошо дальше у вас тишина вы здесь делали фрейда вот аккуратно чтоб щелчка не было и стоит после этого у вас пришли пакеты вы их начали проигрывать здесь у вас задержка проигрывания пакетов стал уже не 20 миллисекунд a80 если вы очень долго происходит играете с задержкой у вас все хорошо то возможно вам нужно ускориться и здесь вы включаете ускорение вот для всего этого придумано некоторые джиттер буфер он на самом деле у каждого voip инженера есть свой кастомный эвристических джиттер буфер который делает это хорошо и он всегда является балансом между лет неси искажениями и того мы поговорили про echo cancellation проносится прошин право ты гей про of the game вот поговорили как у нас ускоряется что это некоторый баланс поняли что выгоднее всего догонять на тишине ну и опус умеет для насытился эффект перейдем к теории видео а тут буду максимально быстрым у нас видео состоит из кадров кадра есть опорные то есть когда у вас кадры нас одна картинка и кадры есть который кодирует div вот опорный кадра вот div когда у вас кадир столько изменения для аудио звонков на наверное интересная история с тем что есть айфрейм и вы раздаете сигнал всем например пользователями если у вас групповой звонок и кто-то подключился в середине между вашими ой фреймами все что вы может увидеть только div у вас распадающейся картинка просто будет поэтому нужно подождать некоторые следующий кадр и это будет серьезная задержка для этого того чтобы этого не делать есть фулл интро request фирм это некоторый запрос который позволяет сгенерировать опорный кадр минус очевидно опорный кадра весит больше чем div и про кодеки много разных интересных кодеков все они отличаются тем что некоторый баланс между батареей и сетью более современные больше вам потребляют ресурсов менее там более старые они более экономичных вашим ресурсом но требует больше пропускную способность сети того поговорили про кодеки поговорили про запрос опорного кадра поговорили про тоже такое фреймы и опорные кадры в целом правой партии наверно многие из вас сталкивались и без этого наверное никак не сделать звонки если вам нужны браузеры это некоторый открытый стандарт который реализован во всех браузерах которые в себе реализует сетевой уровень и аудио-видео pipeline он не реализует никак вашу групповую топологию никак не накладывать на вас некие ограничения и того весь звонок состоит из того что ваши пальцы подключаются по signaling устанавливает транспортное соединение обмениваются кодеками начинают кодировать аудио-видео в этих кодеках отправляют адаптируются чинят меняющейся ваша динамичную сеть компенсирует задержки классная видеоконференция все очень здорово но все пояс или жаловаться говорят 80 процентов распаривают хочу качественные что это давайте потом как это оценить самый простой способ это отправить сигнал забрать сигнал ну и на самом деле как померить качество до на самом деле просто опросить пользователей например стандартный метрикам о свой пи это оценивает качество пользователей новое качество звонков оценками пояса ли они от одного до пяти ставят на сколько им понравился запрос это некоторое среднее для того чтобы каждый раз не проводить большие опросы после вашего очередного эксперимента есть различные алгоритмы которые повторяют действия человека наиболее классная история с низко это алгоритм нейросетевой специально обученный на большом do to say that deep links are и обученный на большом dts эти вот я буду сделать ссылки на писк потому что для если есть voip инженеры они понимают что это но на самом деле внутри мы пользуемся низкое она более клёвое про групповые звонки и и топологии вот мы все рассказывали теорию про сети pro audio pro видео и теперь надо добавить групповой звонок какие есть варианты самый простой способ сделать меж топологию отправить всех всем без серверную например там завод сам так делает есть варианты нам теория говорит м сию я буду тогда называть миксом когда вы отправляете все свои все свое аудио-видео сервер клеит ваше аудио в одно клеит ваше видео тоже какой-то одной отправляет всем другим пользователям очевидно вся нагрузка на сервере вы ничего не делаете здорово и некоторые технологии sf и буду говорить и и forwarding она ваше видео вам не нужно доставлять всем клиентам как в мышь да всем вы отправите только на sera sera за вас ivory transmitted тоже довольно простое решение очевидно что прям аж топологию вас очень быстро растет в исходящий трафик вы очень много декодируйте кодируете видео для каждого участника это плохо больше восьми участников очень трудно завести на этой топологии если говорить про mixto основная проблема это объем циpкa который мы не можем использовать допустим в каких-то комплементарных или дешевых решениях вот и если говорить про sf и он такой компромиссный он с одной стороны позволяет вам экономить ресурсы на клиентах с другой стороны не сильно нагружает сервер на что точно не стоит обратить внимание это на количество участников теория нам говорит что в миксе вы ограничено только тем сколько вы сможете с миксик а например в форт топологии проблема в том что клиент миксер mixed аудио всех говорящих и довольно дорогая история и в партесь и например вам может в браузере позволить на максимум 50 участников по мексике ошибки выбор топологии если где-то прочитали то вот меж завести на количество участников больше чем восемь крайне сложно топологии без серверное это тоже очень трудная история говорят что может дать свои видео потом другому вот так тоже не нужно это хорошо работает для торрентов для рилтайм коммуникации это не работает ну и попытка запустить вой поверх тисе пи тоже странная история сейчас уже меньше одного процента сетей не поддерживают и т.п. проверьте себе работает если у вас 0 packet loss у вас нет джиттера у вас константный битрейт будет работать если вдруг у вас есть остались вопросы можно посмотреть вот этот доклад это как раз тот доклад который помогает проходить собеседование отлично теперь от наса мире попробуем для нас уже некачественные вопросы сделать классные звонке для нас попробуем ускорить и понять что с точки зрения разработки как формально выглядеть наши за нам нужно минимальную задержку обеспечит что большим друга не перебивая нам нужно минимальное искажение минимальное потребление ресурсов на клиенте что нас влияет эта переменная сеть на пользователи устройство браузер доступные ресурсы на клиенте количество участников звонке на что мы влияем у нас есть сетевые алгоритм у нас есть аудио-видео кодирование нашей кастомные джиттер буферы чтобы различные типологии то есть на самом формально функция выглядит так много крита реальной оптимизации задержки искажению потребления ресурсов на некоторым переменах иксах которые есть у вас это различные условия сети устройств и так далее ну это чем вы управляете это различные алгоритмы которые вы можете кодировать для себя мы ограничиваем x некоторым 29 перцентиль им считаем что мы должны работать на 95 процентах хорошо ну что теперь можно делать сервис потому что мы формально определили задача разобрались теории в сервисе будут встречаться такие tricky что если зона зеленое то вы можете просто брать это и применять если зона желтая то надо аккуратно смотреть на метрики расскажу почему и будут сложные трейдов и и перцентиле где нужно будет реально выбирать уже с точки зрения вашей аудитории и так топология для передачи аудио мы можем использовать простой forwarding отправлять всех участников всем другим но если вас много людей говорит то у вас будет высокий входной трафик предположим для четырех участников это четыреста кило бит ну вот вам придется их всех декодировать и выполнил что декодирует больше плести не получится возьмем попробуем сделать микс возьмем соберем всех участников в один аудио поток но тут мы если мы просто это аудио поток отдадим обратно то получит такая картина что вы услышите себя возникнет эхо поэтому на самом деле поставкам из микса вали всю там тысячи участников конференции нам нужно вычесть вас персонально для этого простым вычитанием на самом деле для того чтобы вы не услышали эхом что еще мы вспомним джиттер буфер который у нас выравнивают пакеты по времени который догоняет если нам нужно задержку компенсирует может чинить через пенсий эффект и теперь сравним с цепью и эм си ю то есть forwarding и mix когда вы просто форуме пакета через сервер вообще на них не смотрите в их отправите клиенту и все вот эти алгоритмы джиттер буфер оказываются у вас на там телефонах ваших клиентов если вы делаете микс то вы собираете jitters буфер у себя на сервере собираете один поток отправляйте клиентам 2 джиттер буфер один на клиенте который компенсирует проблемой сети другой у вас на сервере с одной стороны 2 g3 буфера должны внести большую задержку с другой стороны вы починили на одном плече если вы сервер починили плечу от клиента на этом же тыр буфере отправили клиенту клиент починил другому оставили не очень страшно вот мы у себя использую микс мы всех пакуем в один поток у нас есть кастомный джиттер буфера твой инженера вот правда у каждого свой все извращаются как могут на де конинк всего этого аудио и видео мы потратили не очень много ресурсов меньше десяти процентов от циpкa задержка у нас в целом не возникает в микс и вы просто складываете пакет это вообще дешево вот ну и джиттер буфер задержка джиттер буфер сервера будет зависеть от там клиентов обычно она у нас там 60 миллисекунд медианы теперь всякие audio track если вам нужно вообще улучшить звонки то внутрь его партесь и есть некоторые audio network adapter у которого есть очень сложный конфликт про то боффин я просто ссылочку оставлю где можно его посмотреть и подтюнить он позволяет настраивать разные вещи нам позволяет настроить адаптацию аудио битрейта позволяют настроить эффект позволяет не отправлять пакеты если участник молчит вот с чем низкого битрейта можно в моно перейти если у вас уже там не знаю сеть 10 кило бит давайте можно отправлять вот если это все аккуратно потяни то что написано можно очень дешево прям на ровном месте выиграть снизить у себя packet loss round trip отправлять меньше данных в сети вот это очень дешевая история которая нужна вам в любых звонках двинемся дальше посмотрим на то как мы делали аудио pipeline классические pipeline мы рассмотрели в теории здесь мы заменили две истории одного из солдат action in аиста прошин мы решили отойти от классических алгоритмов в партии которые есть в партесь и в аудио детектор сделан нога у своих моделях довольно старая история и шумоподавления тоже у нас эвристическое но мы знаем что чем меньше у нас мы передаем трафика то есть если у нас хороший ватт который хорошо определяет когда я говорю правда тишина и у нас хорошая но из опрошен что я чего-то где-то создают шум вот шум нюансы вырезает вот там и меньше времени тратим на микс меньше передаем данных это все очень здорово поэтому стоит вложиться в свой нойса брошены в ад в ад мы сделали на градиентным bus тенге отыграли у в партесь и порядка тридцати процентов по передаче данных то есть мы зафиксировали ложный reject голоса на одном проценте то есть решили на потому что один процент голосом мы там можем предъявить в тестах вот и при этом в процессе пропустил там 80 процентов шумов 83 мы пропустили 55 целом не так просто отличить голос от шума ну правда тесто сложные были шумоподавление наверняка у каждого есть сосед вот с первой картинке вот который сегодня что дрели или ты вот это все он мешает не только вам но и обычно еще людям которые есть в вашем звонке действительно давайте попробуем подавить шум но на самом деле шумоподавления очень трудная задача у нее высокие требования нам нужен real-time желательно на клиенте и задержки очень минимальные мы при этом хотим чтобы наш шумоподавления работала на уровне state-of-the-art решений например reference есть креспо я и очень классное решение можете посмотреть который вам позволяет подавить шум ну и при этом мы хотели чтобы это все работало на мобильных телефонов нам нужно было минимальная модель размер модели и минимальное потребление циклу мы взяли некоторые исходный сигнал мы его сильно зашумели для тестов собрали конечно большой т-т-т-тут это все посмотрели как работает в процессе то есть от исходного сигнала наше качество пользователю оценивали крайне плохо 1 из 7 в партесь и там чуть-чуть улучшал эту ситуацию ну и мы взяли д т л н на ней рассеять обучили все классно получили хорошие цифры наверное сильно не вдаваясь в историю модели у нас получилось порядка 5 мегабайт мы ее скачиваем on demand мы и подружились опусом и в этом месяце обязательно напишем на хабре статью про то как это детально сделать какие даты с это использовали чтобы все могли это повторить наш эффект от внедрения своих кастомных ваты и но из опрошено мы сэкономили для ps3 30 процентов аудио трафика мы теперь 60 процентов случаях стали меньше заниматься искажениями гномиков когда вам нужно очень быстро говорить чтобы люди быстро отвечали наши запросы потому что вас вас на самом деле потому что ваш ватт не за детектив паузы в словах и на самом деле следующая история это то что мы увеличили на самом деле качество разговора с точки зрения метрика пользователя где тут можно подорваться можно подорваться что когда мы запускали наш клиентский шумодав мы увидели такую странную историю что у нас выросло из починка на сервере искажений то есть починка lightness искажениями то есть на самом деле мы посмотрели чуть глубже увидели что нас вырос джиттер с клиентом то есть на самом деле когда вы немножко нагружаете сепию на клиенте у вас очень быстро на него появляются вариация задержки появляется джиттер это история связана с тем что у вас или кода генерирует джиттера или сетевой стек если у вас цепью загружен поэтому самое важное это быть при запасе пью то есть когда вы запускаете различные шумодав и на клиенте всегда смотрите за какое время в процессе ли тот или иной фрейм чтобы быстро отключить это шумоподавление если реально например на телефоне садится батарея он вам реально резко режет ресурсы и можно не справляемся вот что мы получили у нас аудио pipeline меньше десяти процентов на пользователям мы растим качество уменьшаем трафик все здорово вот мы померили наши задержки наш сервер там в медиа не за 60 миллисекунд перекидывает видео и аудио перекидывает на клиентов в перцентиле за полсекунды ватт у нас довольно дешевый всего 20 миллисекунд константы но это все как бы очень здорово но надо понять о чем и такие классные столько всего намутили что относительно конкурентов ну для того чтобы измерить нас с конкурентами нам пришлось сделать вот такую сложную схему мы просто взяли соединили подключились к телефонам через джек отправить до аудиосигнал забрали оттуда и сигнал из динамика ну и соответственно в один телефон что-то говорим другого забираем сравниваем эти аудио сигнал и меряем между ними лейтон си ее мозг для десктопа существуют такие вот утилиты которые вам позволяют соединить ваше аудио видео через драйвер вам не нужно вот ничего хардвар наделать сравнили нас с конкурентами оказалось что у нас получилось минимальная задержка очень хороший мозг 9 что мы дискорда здесь проиграли вот и еще дополнительно добавили метрику количество в ряд изменений задержки то есть это сколько раз нам приходилось что-то склеивать одиннадцатом и что-то искажали вы просто допустим склеивали тишину очевидно же наш джиттер буфер стремится к минимальному лейтон си но при этом мы иногда часто прыгает теперь вспомним теорию нашего топологии нам говорили что если мы что-то миксе много кэнди то это будет долго лучше просто прокидывать пакеты и там клиент разберется с другой стороны мы помним что если прокидывать пакет этого клиента все придется миксовать и он больше кисти не сделает теперь если мы возьмем в партесь internals посмотрим как работает google мид то окажется что он миксер если он пути почитаем статьи про гугла разум они скажут что они все for added этот вот странная история мы все это померили нашими и утилитами получилось что google мид несмотря на что миксер аудио на сервер оказался самом минимальном полотенце ozum который вроде как по всем статьям у нас forwarding прокидывает просто пакеты он оказался самым медленным другая история что зум вроде как forwarding по пакетам но по документациям но при этом у него максимальное количество участников 50 как они это делают но они делают такой трюк они считают что все сразу 50 говорить не будут и отправляют например только тех кто говорит или от кого идет какой-то шум из минусов очевидно у вас битрейт на клиенте растет три четыре пять человек говорит у вас вырастает битрейт вам нужно всех декодировать ну из плюсов вот у вас есть такой track что вы можете ничего не миксовать выводы на самом деле микс который в теории может быть медленным на самом деле может казаться быстрее не все у вас решается топологии ну а мы на самом деле внутри рынка по качеству и при этом максимально экономим ресурсы пользователя про видео правитель наверно стоит сказать что микс никто не использует это когда вы пытаетесь собрать одно большое видео всех участников это супер дорого поэтому обычно все про используют прокиды вание видео то есть вы отправляете видео она доставляется всем участникам минус мы уже говорили если кто-то подключился с середины у кого то пропал опорник мы потеряли кадра пропал опорной надо ждать следующего ну или соответственно попросить опорным того кто шлет представьте конференцию на 1000 участников у кого то пропал пакет он говорит пришли опорник вы все тысячи отправили ну и следующей истории кто-то подключился супер плохим интернетом вам нужно все качества понизить ok для этого и для решения есть например такие технологии как всему каст который говорит давайте-ка мы на клиенте patrons ходим ваши большое качество еще поменьше еще поменьше конечно решают многие проблемы но не все но при этом требует много клиентских ресурсов есть более крутая технология с висим которая в кодеке говорит давайте-ка мы внутри кодека сделаем качество поменьше сделаем качество побольше что-то поменьше еще супер большое но тоже вам потребляет много ресурсов меньше чем симу coast ну и связь и не поддерживается браузерах мы пошли по своему решению мы помним что для наших пользователей очень важно качество а с другой стороны мы помним что любое дополнительное наброс ресурсов на ваш телефон несчастные генерируют вам лишний джиттер задержки все остальное поэтому мы решили а под транс ходим мы с сервером мы помним что транс кодировать сервером конечно супер дорого но можно сделать такие замечали интересные наблюдения когда вы выбраны как главный спикер вы большой понятно вы отправляете большое качество если вы где-то поменьше внизу там на вас никто не смотрит вы просто слушатель то вы можете отправить качество меньше ну или кто-то вас смотрит в сетке возможно все вообще на вас не смотрят вы просто сидите формально с видео можно выпросить вообще клиента нет нет не отдавать видео высоком качественном говорим клиенту отдавай не больше чем сколько тебя смотрят то есть если ты где так все-таки болтаешься с низким качеством и тебе понижаем можно посмотреть через в партесь интересно вас никто не смотрит мы вообще в ноль уберем и resolution и битрейт это нам очень сильно сэкономили клиентские ресурсы и серверные ресурсы но и это еще не все рассмотрим ситуацию когда все смотрят на меня в каком-то некотором разрешении кто-то подключился и у него совсем плохое качество сети надо под транс кодировать только в этом случае мы запустим transcode а давайте мы на сервере понизим мои качества и тут мы тоже на самом деле увидим что это нужно крайне редко у нас 40 процентов пользователей вообще не нуждается в транскодирование доставляются просто как есть его по сути чистый софью но зато мы этим решаем вот некоторые проблемы теперь сравним нас с решениями стандартные софью понятно мало кто использует потому что много входного трафика на клиент собрать все видеопотоки в большом качестве плохо всему костя когда мы транспонируем все видеопотоки мы всю работу перекладываем на клиента с вести эту работу немножко минимизирует но это же дорого мы на самом деле максимально бережем наших клиентов но при этом перекладываем работу на сервер про кодеки помним что кодеки бывают разные в кодеке бывают которые что-то работают хорошо на определенных битрейтах и при этом могут потреблять больше меньше ресурсов самое простое это на самом деле переключать разные котики зависимости от условий то есть если у нас например вниз высокая пропускная способность низкий заряд батареи слабый телефон мы можем использовать классические 264 ускоренный на пользователях если у нас плохая сеть мы можем включить с of тварный vp9 который вам по потребует больше батареи но сэкономит ваш сеть повысит качество мы ищем мы научились переключать кодеки на лету и того что говорить про видеосервер мы транспонируем на викенде транс кодируем только по запросу максимально стараемся этого избегать если посмотреть на наше время транскодирования очень маленькая порядка 40 миллисекунд мы вносим лейтон си для транс кожинова стрима если вы его потребовалось транс кодировать а требуется его крайне редко ну и ресурсы на пользователя порядка 04 циpкa на пользователя вот она так делятся между аудио-видео здорово х5 напридумывали кучу всего сложного посмотрим где мы против конкурентов как померить нашу задержку против пользователей и против других конкурентов на наших пользователях самое простое это просто показать таймер в камеру посмотреть через какое время вы пришли фотографировать замерить задержки мы конечно же выровняли сеть до серверов конкурентов и увидели что мы по видео на самом деле быстрее всех вот довольно странно ну то есть или также или быстрее скажу почему есть такой момент синхронизация аудио и видео если как ни странно есть много разных исследований тоже референсных по людям если мой голос будет сейчас отставать немножко от моего видео а он реально отстаёт потому что я говорю в микрофон а это лук через динамики вам всем нормально но если мой голос будет вперед видео то я на самом деле начну то вам будет не очень хорошо это будет странно если я говорю раньше чем вы меня видите вот по этим исследование видно что если вы на 60 миллисекунд раньше воспроизводить и аудио то это не очень мешает зато отставать аудио можно больше можно на стол 120 миллисекунд вставать воспользуемся этим трюком мы посмотрели сколько у нас он занимает processing аудио нам бы кэнди сколько занимает processing видео все аккуратненько разложили по перцентиль им вычли 1 из другого получилось что в общем-то бэкенд не так и укладывается в этот диапазон поймешь на клиенте может происходить черти-что но мы отказались от липченко то есть мы на самом деле отправляем аудио-видео клиент не симка это это время мы рассчитываем на то что она сама где-то будет в этих диапазонах в общем если вы поиск нашими звонками и вам не нравится липсинка у вас вдруг что-то кого-то опережать или тормозит пожалуйтесь мы можем включить но пока нам кажется что так работает здорово теперь самое интересное как по какую архитектуру нужно выбрать как нужно построить чтобы вам можно было выдерживать там бесконечное количество участников у нас три наверное основных группа серверов это сервис signaling где вы подключаетесь просто по websocket а передаете какие-то сервисные данные сервис conferencing где реализован в партесь ее прием медиа вот и сервер с и трансформа где-то облачные которые запускают сказал может что-то под транс кодировать делается на лету и всю эту историю кто сейчас где какой звонок processing сделается через гипер как происходит скалирование звонка предположим алиса звонит богу если нам ничего не уже транс кодировать тому просто алиса может висеть на одном сервере болт не другому они могут перекинуть видео напрямую все есть нам нужно например что тасс миксовать у нас много участников нам нужно под нарезать видео мы в облаке запускаем различные процессы например нам нужно под транс ходить бабы нам нужно сместить баба с алисой нам нужно и транс копится лесу там ее заде носит не дай бог еще что-нибудь вот соответственно и там и размазываем по любому количеству процессов таким образом у нас нет какого-то ботаника во всей этой истории мы сканируем ся на любое количество серверов звонке про отказоустойчивость но в такой архитектуре наверно добавлю что мы еще закрываем наши сигналы балансирами от н.ф. вот внутри себя в случае потери сервера вов у нас закипела регистрирует на что перекинуть но и случай 1 америка что то выпадает у нас нет такой истории sturgis звонок грохнулся потому что он висит на одном сервере у вас одни люди на одном сервере транс coding вдруг кто-то моргнет где-то отвалился вот но при этом какие то серьезных проблем не будет вот все posing in через за кибер ладно про уменьшение lightning если вы работаете с медиа внутри дата-центров ну во-первых везде включитесь и пенал delay погуглить с не знаете что это вторая история у нас на самом деле сервера на java и иногда у вас бывает большой gc например может быть время которое latency генерирует вам garbage collector там доходить максимум доходил до 50 миллисекунд мы заменили дживан наши надо это как раз garbage collector ориентированной на минимальной задержки вот и мы уложились в то что наш conferencing который на джаве реализует в процессе у него максимально задержкам 10 миллисекунд и у трансформа вообще при этом оберточка нате вам вот jitsi например самый популярный многие наверное знают он у нас тоже на джаве этот трюк ему тоже поможет что еще нужно про тысячу знать конечно 1000 если вы в порто c придете скажите у меня 1000 участников звонки на забирай работать не будет вот потому что нужно много декаде raw там каких-то стэйта всех участников поэтому мы ассоциируем количество стримов ровно под то количество которое вы видите сейчас на экране и делаем замену видео то есть у вас стрим идет перманентной это того участника но например хотите здесь заменить опять олесуна баба вот в этот момент вы просто говорить окей я хочу заменить олесуна бабу ставить аватарку баба ну что скроллите меняете вот в этот момент вы просите сервис подменить стрима ли сына бога вот у вас пока висит аватарка вам сервер отвечает таймс темпом с которого у вас пойдет в этом же с тремя боб и вы дальше получив этот темп ждете пока он придет возможно вы получите его позже тогда у вас сразу можно включать бабы либо вы получите раньше дождетесь этой задержки вот таким образом у вас получается всего в партесь и максимум там 50 участников но при этом в сервер за вас полностью реализует всю логику по переключению этих зрителей и вы можете лимитировать любым количеством участников на сервере кука ваш сервер выдержит и того же если вы хотите сделать большое количество участников конференции вам нужно научиться горизонтально эскалировать звонок по всем серверам научиться обходить ограничение вы портите popper connection нам использовать например мы называем это решение с латами ну использовать какие-то серверные топологии ну и помнить что вам нужно нейросетевой шумоподавлению ватт и прочие истории помним все что у нас есть много эвристических алгоритмов типа джиттер буфера адаптации растягивания аудио и всего остального и с вами нашу формальную постановку задачи у нас было многокритериальная оптимизация на каких-то параметрах и вот того что мы можем поменять что интересно мы на самом деле можем взять и завести некоторые там например градиентным бу стингом построить модель оценивающую качество звонка до того как вы его начали интересный момент а то есть по пользовательским данным того какой у него сигнал например вот здесь видим здесь сверху вниз обозначены самые значимые параметры в модели предсказания качество звонка еще до того как он случился мы смотрим на качество на смотрим на сигнал наверно из важного насколько вы как у вас работала сеть в приложении до того как вы позвонили сколько быстрого стартовали приложение интересные моменты здесь присутствует например среднее количество ошибок на вот это мои пи адрес и за неделю то есть по вашим айпишник у уже можно сразу сказать будет у вас все хорошо звонке ли плохо и подтюнить тот или иной алгоритм а для тестирования всей этой штуки мы заводим кучу кучу разных vertu браузеров на virtual как подключаем с некоторым тестом дал чтобы любой разработчик мог подключиться в большой звонок и по тестировать различные свои клиенты а ios android web на производительность наверное стоит отметить что есть масса готовых решений я даже прошелся по ним посмотрел какие в них характеристики и цифры скажу что наверное скалирование горизонтальная дрянь и вам вряд ли обеспечит но если вам нужны звонки на 50 там 100 участников то в целом вы можете взять какой-то open source проект который вам больше подходит по стыку на плюсах на джаве и решить свою задачу общее решение такое что если вы не делаете глобальной сервисной миллионы пользователей у вам не надо больше ста участников можно взять какой-то open source добавить к нему шумодав из готовых например крисп вот или использует какие-то готовые облачные решения которые за вас еще и проведут всю работу с селеном с операторами и того что у нас получилось у нас аудитории месячного этих звонков порядка 20 миллионов мы делаем 6 миллионов звонков день всем и это разрабатывали удаленно на пандемии по функциональности у нас сейчас 128 участников наших детей уже позволяет 1000 + вот мы думаю неплохо с ними со всеми по конкурировать еще замечу что в течение всего доклады на мы говорили что зума он какой-то по задержкам странный в общем вообще на все им пользуются тоже интересный вопрос по немножку поанализировать мы заметили что зума очень хорошо работает например на каналах с потерей пакетов 50 то есть пакет lost 50 через пакет у вас пропадают при этом зум не сильно вырастет вам задержку сможет работать например мы там или google мид на 10 20 процентов начинаем уже страдать в целом очевидно что зум используют топологию которая вам гарантирует минимальный лейтон сена разменивает ее разменивает на качество звука на шумоподавления на работу в плохих сетях вот мы наверное в данном случае решение ближе google нет он вот штучная на хочется сказать про а настоящее будущее звонков и про то как извинялся voip вот буквально за последний год нейросетевой горит вы появились везде все мистические алгоритмы такие как аудио detection но и сопряжён все поменялось на нейросетевые сейчас уже есть и нейросетевые audio codecs видео кодеки даже качество звонков мы оцениваем нейросетями почти везде у нас м.л. общий подход к решению таких задач ну понятно определите требование сделать и опросы изучите теорию формулируйте задача это нас она очень полезна когда вы решаете не что-то в вакууме когда у вас есть реально формальная постановка определите где вы находитесь относительно конкурентов это очень важно и уже развивайтесь развивайте сервис опираясь на метрики что можно заметить что чем больше вам нужно участников звонке чем больше вам нужно качеством звонки чем ниже задержки тем более сложное ваше решение но самый плохой вариант если вы пойдете вот вас может получиться такой вариант что вы находитесь на уровне как avanti open source а но при этом в ваше решение супер сложная поэтому всегда сравнивайте с конкурентами смотрите где вы сейчас находитесь и развивайте что у вас сегодня получилось мы с вами поговорили про то как выглядит сеть какими характеристиками она описывается как починить проблемы сети как выглядит аудио-видео pipeline и как можно померить качества в этих звонках немножко поговорили про видео и про кита 3 про разные трюки которые вам могут позволить улучшить качество и также говорим что м л в среднем звонках на от 20 до 100 процентов может улучшить различные алгоритмы классически эвристические что вам с этим всем делать ну можно встроить сервис ваши звонки можно пройти собеседование в культовой команду и развивать чей-то сервис можно например начать свой стартап дали если вы не хотите пользоваться вейпом на самом деле за протяжении за последний год вот мы пробежали то что как изменилась индустрия мы видим что когда появляется какая-то нужда и какие-то там какой-то высоко растущий интерес вокруг яхты сервисов вокруг него сразу же появляется многое мое решение то есть по сути вся классика вайпа заменилась млм и это произошло буквально вот там за последние годы вот поэтому возможно в вашем сервисе который вы делаете вам тоже нужно подумать и посмотреть может быть нейросети градиентный бусинку или что-то может сделать ваш сервис и лучше да"
}