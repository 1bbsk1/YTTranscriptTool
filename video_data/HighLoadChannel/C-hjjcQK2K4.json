{
  "video_id": "C-hjjcQK2K4",
  "channel": "HighLoadChannel",
  "title": "Биллинг в условиях распределенной системы / Сергей Ситников",
  "views": 2723,
  "duration": 2242,
  "published": "2023-01-19T06:56:46-08:00",
  "text": "всем привет зовут меня сергей и я работаю международной сетях компании сегодня речь пойдет про одну из за моих команд до про наш продукт который мы делаем это продукт биллинга но прежде чем мы перейдем непосредственно к продукту давайте я в двух словах расскажу вообще чем мы занимаемся мы предоставляем услуги в различных юридическим лицам в разных странах а по проведению платежей которые могут быть как в пользу этих юридических лиц так и в пользу их собственно клиентов мы проводим платежи в разных странах разными способами и а очень много софта мы пишем сами поэтому с гордостью общем-то минуем hi-tech компаний здесь важно отметить один момент есть термин который я буду в дальнейшем часто использовать это мерчант мерчант это вот наш ключевой клиент торговец про это пойдет речь значит что такое bedding вообще в нашем понимании скажем так в мыслях обычного простого рядового пользователя биллинг это что-то вроде про то что вот раз в месяц да там с меня списывают деньги там в пользу как вот сервиса для нашей компании это не совсем так то есть у нас есть во первых калькуляции комиссия опять же эта комиссия не просто там до восьми нам перевел 10 рублей мы с него рубль взяли и все все довольны и счастливы это развитая система да когда у нас строится некая модель учета от входящих платежной операции по огромному количеству сценариев к примеру у нас есть различные конвертации валют это тоже не совсем простая история это работа с вендорами данных это различные конвертации прямые через какие-то дополнительные валюты кросс-курсы прочее прочее помимо всего прочего есть такое понятие у нас как тарификации тарификации это тоже история не совсем про то что вот к нам пришел наш клиент мерчант он нам дал какой-то договор мы с ним договорились и все классно а система тарификации сильно развитая насчитывает сотни сценариев к примеру вот выпущено вас карточка допустим где-нибудь в индонезии вы сами находитесь к примеру в канаде и оплачивайте какую-то услугу мерчантов которой апеллируем к примеру не знаю с китаем такая вот история скорее всего наш 7 под это будет отдельный тариф а ключевой задачей биллинга в распределенной системе до чем еще не будем много говорить о движении денежных средств является контроль денежных потоков да то есть для того чтобы их контролировать для того чтобы когда мерчант нам передаёт ответственность по сути по расчету с его клиентами да что мы там не дай бог лишнего не выплатили вот об этом пойдет речь чуть более детально далее для начала хочется рассказать про предысторию как мы дошли до жизни такой вообще до распределенной системы изначально у нас был один дата-центр в котором как я думаю большинства да у нас был backend включался воров различных приложений это и база данных шабен гамма репликации научимся как мы любим различные сервисы очередей сервисы кэширования и прочие стандартные компоненты любого современного бэг-энда в чем проблема вообще 1 дата-центра тут наверное сайтов не будет каких-то это надежность платежного сервиса случае отказа дата-центра да то есть если дата центра падает мы все до вынуждены ничего не делать как-то экстренно палками подпирать эту историю и пытаться работать дальше во вторых это дело доступность и конкретных мерчантов то есть для очень многих да и наверное общем-то для всех наших клиентов скорость проведения платежные операции критично поэтому чем мы ближе находимся непосредственно конечному пользователю тем естественно уча думать и мочевина и наконец гибко управления нагрузкой рекомендовались нас регионов они значит гибку управления нагрузкой понятно что метод центрами особо не размахнется да ну работаем в этом направлении до центра встанут все больше и больше и вот наконец у нас появился второй дата-центр у нас улучшилась надежность да то есть мы уже можем манипулировать нашими потоками данных доступной системы улучшилась общем для наших мерчантов но нам не удалось сильно гибко управлять нагрузкой потому что у нас есть такая сущность как баланс баланс нашего мерчанта нашего клиента непосредственно до юридического лица ключевая проблема здесь в том что когда у нас возникает задача контроля да когда трафик идет в оба дата-центра понятно что при реплики шим логах при потребности синхронизации нам нужно каким-то образом либо жесткой обеспечить ассистенты с между двумя то-то центрами до либо разделять баланс и таким образом чтобы на один дата-центр шла одна доля трафика на второе другая вот что по сути гибкости нас в каком-то смысле мы улучшились но но не вал до баланс и что такое баланс и давайте мы а них немножко я два слова скажу это по сути состоянии виртуального счета мерчанта в рамках нашей айти системы когда мы говорим про деньги да естественно деньги лежат на конкретных счетах то есть это собственно счета владимир chateaupers по низкие счета еще какие то мы сейчас говорим исключительно про айти систему да то есть ни про какие то там финансовые моменты по сути это некое число да ну вот если по простому который может увеличиваться уменьшаться ну это самая база в чем проблема куда у нас проблем от конкретной записи которую я сказал и баланс мерчанта в пограничных ситуациях когда мы по одному балансу пытаемся трафик на 2 доцент сесть на может уходить в минус банально потому что ну вот либо мы должны жестко это процесс контролировать либо собственно мы имеем такие риски да и нам с этим нужно было жить как ты работать и тут появился третий до центра стали вопросы достали вопросы масштабирования стал вопрос опять же контроля баланса только теперь уже в 3 этапов 3 дата центрах и появилась потребность фото 4 5 ну и очень мы поняли что мы с головой влетели в набившую оскомину cup теорему я не буду вас супер сильно грузить теории я скажу буквально два слова значит ключевое что мы здесь можем какую можем сделать это то что в распределенной системе мы должны выбирать до между тем что нас данные сто процентов синхронизированы между собой либо у нас сервис доступен на то что доступности к системность по сути наш выбор что делать а как мы вообще подходили к решению этой проблемы мы посмотрели на наших типовых клиентов и на их операционную деятельность и более того мы посмотрели на природу данных именно какие которыми мы управляем которые нужны в моменте и кому здесь я приведу пример нашего клиента давайте рассмотрим банальный таксопарк да вот какие вообще задачу такого клиента пойдем от покупателю услуги к примеру вы после работы вызываете такси эти домой доехали до конечной точке что вам нужно вам нужно чтобы операция платежа тондо с вашего привязанного платежного средства каким бы оно ни было это может быть банковская карта какие-то электронная система коммерция прошла максимально быстро потому что иначе придется там ругаться таксистом еще что то такое делать а вот таксисту надо в моменте увидеть что его клиент операцию акцепта лол да и все в общем идет по плану до чтобы не бросился за вами он спокоен пошли домой к примеру соответственно на основании вот этих размышлений мы пришли к выводу о чем о том что для пользователей да здесь в моменте важна скорость но не супер важно консистентной каком смысле нам нужно лишь передать факт о том что конкретная операция успешно . передать ее статус некий дентифик атор и может быть набор каких-то сопутствующих свойств а при этом например пополнение баланса дату с увеличение баланса на счете мерчанта мы можем сделать асинхронно там до спустя какое-то количество времени непродолжительны на в базе вот этой истории мы собственно говорим о том что у нас есть 2 момента то здесь у нас важна скорость вот в прямых операциях пополнения счета так что с операциями списание операция списание это обычная история когда мерчант опять же вечером там или интервальной нашему таксисту выплачивают деньги долю набор у таксистов вот здесь мы должны уже ориентироваться не на скорость но потому что клиент наш ему важнее надежный то чтобы мы таксиста мы выплатили денег больше чем они заработали к примеру то есть нам здесь гораздо важнее к систем если мы можем затормозить нашу систему для того чтобы все вот эти вот моменты свести воедино отсюда мы делаем следующий вывод что мы по сути формулируем разбиение по операции которые увеличивают баланс мерчанта уменьшает баланс мерчанта когда мы говорим про типа операции понятно что в реальном мире их ну сильно много да то есть в нашем случае там может быть порядка 50 различных типов здесь нам это не очень важно вот почему потому что это уже частности то есть нас интересует именно условно плюс или минус второй момент природа данных да то есть мы уже поняли что какие-то данные нам не нужны в моменте мы можем их игнорировать и на базе этого мы построили логику работы с контекстами приложения да то есть у нас приложение разделены по сути работают в двух контекстах первых контекст это операционной для которого критичны время и мы можем пожертвовать здесь контролем да и все остальное время работать логический контекст логически контекст в нашем понимании это вот та терминологии которая сейчас хочу вам загрузить в голову до что мы разговаривать них терминах эта история по сути пост-обработки да то есть отправка данных какие-то различные аналитические источники вод и всякое такое теперь у нас при всем при этом у да у нас есть теорию нас есть и при контекста работы какое-то понимание того как мы будем строить нашу систему у нас при этом все еще есть наш системный ландшафт который развивался в течение многих лет мы там слэша есть как минимум как он у нас устроено тут куда мы вписываем наше предполагаемое решение у нас есть одной стороны пользователь вот это пользователи конкретные клиенты конкретного мерчанта до которые обращаются к нашей системе каким-то способом способов этих ну в принципе великое множество то есть это различные там девки это api key так кастомные платежные страничке приложение бог знает что еще вот общая архитектура здесь да вот работа сервисами она довольно классическая да то есть у нас есть очередь обмена данными вокруг которой мы организуем различные сервисы то есть когда у нас идет платежная операция ее обрабатывают последовательно или параллельно в зависимости от назначения сервиса различные worker обработчики здесь я на складе отобразил торце с это просто непонимание что есть разные назначение doris control system анти фрод и на этом же уровне мы внедряем собственное решение биллинга да здесь я становлюсь буквально пару слов про технологии ну не то чтобы это критично потому что в принципе подобную схему можно реализовывать на очень разных стеках до конкретно у нас мы используем в этой части для worker of обработчиков печки для очереди обмена данными apache кафка вот значит дальше мы рассмотрим конкретный пример обработки операции то есть вот у нас пользователь что-то делает например происходит операция оплаты у нас биллинговой обработчика нашего ядра посылает данные уже наконец-таки сервису биллинга от нас есть операционной но до биллинга мы туда а посылаем операцию и единственной задача операционный но до биллинга это быстро посчитать и быстро отдать вот этот вот минимальный набор необходимых параметров которые нам нужны в моменте чтобы все было хорошо чтобы операция прошла все были счастливы до то есть здесь у нас контроль минимальный почему потому что у нас идет прием прием денежных средств да здесь что происходит дальше когда я говорил про баланс и я говорил что-то условно абстрактное число на самом деле конечно все сложнее к одной операции платежной мы делаем набор биллинговых операций который в дальнейшем дальнейшем до должны попасть в базу данных там осесть потому что здесь мы сознательно на уровне операционной но до биллинга ограничимся связи мы не можем себе здесь в моменте позволить ходить в какие-то удаленные сервисы вообще ходить в базу данных что-то выбирать искать кэшировать там да это все очень долго поэтому мы здесь банально собираем набора биллинговых операций кидаем их очередь пост-обработки и это очередь пост-обработки по сути является нашим разделителем до для определения где у нас находится операционный контекста гиннеса логически дату с операционной с очереди пост обработки данных уже едут в базу вот здесь по технологиям тоже остановлюсь скажу значит биллинговой обработчика я говорил это php операционной но до биллинга в нашем случае написано нагло ланге почему потому что нам здесь важно история когда мы данные держим под ногами мы можем использовать multipla точную обработку да то есть нам показался то удобным сейчас чуть подробнее скажу об этом дальше внимательный слушатель может мне спросить а как живут до на предыдущем слайде операционная но да каким образом она обрабатывает данные если у нее нет доступа к базе да вот базу мы ходить не можем не можем себе позволить медленной операции мы здесь используем собственно каширу ющие приложение за логического слой то есть в пассивном режиме совершенно до в отрыве от операционного контекста вне в моменте проведения операции найдем базу данных собираем себе кэш и этот кэш грузим в оперативную память собственно нашей операционной но да мы туда грузим сетку тарифов курса валют этом моменте все все все все все все все что нам нужно для изолированные скажем так да для изолирована проведения операции по поводу каша я могу сказать здесь такой нюанс что в нашем случае это ну банально и хэш-таблица да и мы подбираем у атрибутом операции по сути хэш да и выбираем необходимый тариф например да или какую-то сущность я идея простая то есть мы должны выбирать данные за постоянное время вот дальше что происходит да тут мы сейчас рассмотрели вот эту историю добра мх-1 у dc а что с другими дата центрами отправку операции а в другие до центра на осуществляет также логический контру да это отдельное приложение по сути мы понимаем какие операции нас прошли в одном дата-центра какие у нас операции пошли другом дата центры и за счет с от верной репликации мы эти данные просто передаем так и того подытожим задачу приложения логического контекста просто мы к нему вряд ли будем возвращаться потому что такая ну самая простая часть формирование каша настройка для операционных not дальнейшая обработка и отправка данных сервисные системы сервисные системы в нашем случае это ну различные админке да то есть у нас есть 7 департамент риск департамент собственно пользовательские интерфейсы кучу всего туда данные мы можем доставлять там с некоторой задержкой нас нет потребностей в моменте здесь данные держать жестко при битами а вот помимо прочего то что я сказал это отправка биллинговых операции другие дата центры и встает вопрос а в какой момент появляется вот этот контроль балансов распределенной системе поговорим про контроль баланса то есть вот наша схема у нас с одной стороны worker и представим что два это центр у нас одной стороны worker и посреди у нас наш операционной но да и потом вот очереди которые всю эту историю обрабатывают надели на деле контроль наступает в этом моменте у нас от операционную надо биллинга связаны в единый операционный кластер связь это кросс дата-центра вы и надо связаны асинхронно дальнейшую историю сейчас мы будем рассматривать как конкретно баланса движется по нотам я буду рассказывать на примере вот такой картинки да то есть это у нас 4 ну да неважно в дата-центрах они находятся между ними есть сетевая связанность вот отсюда пойдем что происходит пополнение баланса да то есть кто то там в пользу мерчанта или сам мерчанта решил пополнить свой баланс например для выплат а запрос может упасть в принципе в любую ноту до в кластера ну понятно что принял горит никому будем считать для простоты объяснения условно в любую когда мы пополняем баланс ну никакой магии не происходит то есть у нас просто на конкретной ноги данной конкретной ноги появляется наш баланс вот он 1000 остальные ноты при этом имеют свой локальный баланс равен нулю да о чём это нам говорит а что будет происходить если запрос придет не на ту ноту на которой лежит наше 1000 ну к примеру рублей до на какую-то другую да ну классическая проблема я сетевые связи уберу потому что иначе будет просто и удобно смотреть вот у нас примеру тысячи рублей здесь пришла выплата на 500 замечательно что происходит у нас начинает работать так называемый протокол займа средств как он реализуется но до b отправляет сообщение ко всем нотам потому что мы не знаем заранее во-первых где лежат деньги во вторых мы не знаем в моменте доступна ли у нас стива связанность на кареты ноды мы рассылаем сообщение всем в этом пуле вот которая содержит по сути следующее что надо б требуется требует суд рублей до для проведения свои операции что происходит например на ноги c в этот момент нота c получает это сообщение у нее 0 средств но это как в общем даже не важно сколько там денег до 10 ключевой то что это но до ретранслирует сообщение опять же всем то есть каждое сообщение ри транслируется постоянно от каждого каждому нода а получив подобное сообщение точно так же все много дам отправляя сообщение что я ну да передаю деньги ноги бы да и каждое следующее но да это сообщение рассылает вот то есть если у нас примеру в какой-то момент он сетевая связанность между но дай а и б пропало да но надо уже отправила деньги но тебе-то но dc может эти деньги собственно ей передать за счет от такого протокола а что происходит сообщение дошло но добиваться акций акцепта вала получила на свой локальный баланс 500 рублей вот и наконец таки может отдать статусу мы и идентификатором ключевые аспекты при взаимодействии но здесь тоже зафиксируем на час каждое сообщение присылается каждому если нет полной суммы ну к примеру на балансе не хватает до но какой-то кэш есть да но до перешлет те средства которые есть наличие возникает вопрос а как при такой механики сообщений избежать сетевого флота ну потому что я думаю каждому понятно да что если мы постоянно вот такое сообщение присылаем друг другу бесконечности конечно история наша сетка загнется и прикажет долго жить контроль через идентификатор сообщения то есть мы понимаем в моменте под каким идентификатором наше сообщение собрано да и мы это можем контролировать модом понимает что она это сообщение обрабатывала но опять же если мы просто сделаем такую обработку да ну вот мы обрабатывали дату нас просто начнет пахнуть оперативной памяти потому что сообщение миллионы и мы не можем весь пост у себя держать вот поэтому мы собственно добавляем контроль по времени и считаем что если к нам пришло сообщение супер старая моего отбрасываем гладко было на бумаге да то есть это схема в каком смысле теоретизировал ась да разрабатывалась что происходит при потере сетевой связанности что происходит происходит при выходе из строя но давайте разберем во-первых тогда мы говорим про деградацию системы нас всегда интересует вопрос а что мы будем делать когда у нас на конкретной допустим ноги остались деньги да вот доступен только локальный баланс там ну собственно локальный баланс мы можем выплачивать там с этой надо если мы говорим про выплаты при этом входящие операции на пополнение баланса мы можем общем-то без проблем каких-то обрабатывать просто плюсовать другое дело что они не будут доступны в моменте другим элементам системы между нодами b и c нет связи буквально 2 минут назад говорил то есть эта история про то что мы можем здесь за счет вот именно протокола за счет фатальной нашей связности и перри послание сообщения от каждого каждого мы здесь можем передавать средства до через посредников то есть между b и c у нас не связи но бы может получить и передавать средства sc через но туда что мы делаем при потере ноды как таковой каждая но до ведет локальная реестр операции то есть когда мы вообще рассматриваем нашу историю мы говорим что у нас есть момент когда к нам пришла операция у нас есть собственно можно зайти тратах от логом да то есть фиксация на уровне жесткого диска говорит нам о том что операция axapta надо touch если что-то пошло не так мы не можем записаться мы совершенно спокойно говорим системе ядра что операция не проведена мы понимаем что мы здесь не ничего не засек тебя вот что с этими файлами вообще происходит эти файл ареста мы их можем взаимно выгружать и сверять то есть если к примеру в моменте у нас ситуация когда надо передает деньги да там ноги бы при этом но до b выходит из строя а потом входит возвращается в эксплуатацию в ходе ну какие то штатных процедур мы всегда можем сличить что надо а до передала эти средства а надо бы не получила потому что в моменте да надо бы также пишите я получила деньги от моды а к примеру дальше мы помимо всего прочего сверяем операции уровня ядра с тем набором биллинговых операций которые у нас должны создаться да то есть мы когда проводим операцию мы понимаем что у нас есть некий пул и мы можем плюс-минус с лечить до что у нас происходит вот ключевой момент здесь то что когда мы собираем биллинговой операции на операционной ноги и отдаём их очередь пост-обработки мы хотим туда единым пакетом а единый пакет нам нужен для того чтобы собственно также взять его традиционно ставить локальную базу банально вот и наконец полученная информация до что мы снизим как мы обрабатываем полученной информации передается в саппорт для обработки нештатных ситуаций в полу ручном режиме то система автоматизированная могу сказать что полный автомат вот но мы всегда моменте понимаем где у нас риски какие у нас собственно могут там возникают дополнительные проблемы вот и мы можем их решать в моменте выводы выводы по докладу а работа с деньгами требуют во-первых быстрых операций да то есть есть целый ряд процедур когда мы говорим что у нас скорость нам крайне важна дата шнур пример статьи может быть не супер показательный но тем ни менее второй момент честно децентрализации да то есть если мы просто в контур синхронизации закроем всю систему ну быстро это работать не будет при том что в принципе платежной операции эта история про кучу проверка там дополнительные фильтры и бог знает что еще до то что у нас опять же time или анти фрод это всё не быстро плюс есть еще не дай бог какой-нибудь 3ds авторизация ну сами понимаете ну и финальный вывод этой истории и вечно консистенции у нас может работать и там где есть деньги собственно спасибо я закончил такая история спасибо большой сереж организаторов конференции спасибо тебе большое за участие маленький презент за то что ты подготовил такой интересный доклад друзья вопросы из зала к ну давайте спасибо большое за клад интересно очень было я только до конца не понял получается что все-таки баланс хранится на всех нотах и чтобы узнать баланс надо собрать информацию со всех вот смотрите nothing услать отмотаем например чтобы нога наглядно обещал где 500 рублей был никогда вот вот например смотрите то есть здесь история какая вот эти моды да вот это операционный кластер это по сути отражение никого состояния то есть как реально происходит процесс есть мерчант у него есть админка да вот этот сервисная систему куда он заходит и говорит так ребята мне нужно добавить на свой баланс сколько там добавлять тысяч рублей вот она добавляет и в этот момент данные сохраняются собственно в базу данных и идет push в этот класс то потом вот эта тысяча она внутри кластера перераспределяется причем когда мы говорим про перераспределение ну знаете здесь покажу тему можно футбол что рассказывать здесь могут использовать дополнительно механизма к примеру да то есть мы можем в долг например брать больше чем на самом деле нам нужно для того чтобы не за каждой операцией ходить но в целом история про до история такая что у нас на всех модах лежит суммарно то что лежит в базе вот вот так я бы сказал ну да да и получается что эта консистенция должна все время поддерживаться до но с учетом того что у нас слой контроля находится как раз на уровне операционного кластера вот там и тариаль ирия или и реализуем а консистентной на уровне базы данных в моменте то есть абсолютная нам не нужно мы можем обойтись и итоговой согласованностью просто за счет собственно сад верно ли приказу минус он может уйти в минус он не может уйти потому что ну как бы мы это допустим но вот ну то есть если у тебя на конкретной ноги нет денег да да мы их не можем списать если мы за тайм-аут не получили денег с других not do достаточно для проведения операции мы точно так же их не спешим вот а больше денег чем в базе в операционной кластере быть не может потому что база здесь вторичка то есть операция приходит операционно классно а потом попадает в базу если мы деньги не получили получается то будет ошибка да конечно не хватает ну то есть желание может быть и тащим нужно спасибо потом вопрос потом спасибо за доклад у меня в принципе очень похоже был вопрос на предыдущий я бы чуть-чуть добавил собственно баланс и тогда получаются хранятся числом другого просто то есть мы не каждый раз там собираем какие-то у нас последний всей истории транзакции чего-то такое здесь вопрос в том что баланс есть на разных уровнях когда мы говорим например про предоставление данных клиентам вода кисть вот такси пример хочу расплатиться через было да я понял вопрос кажется баланс данном случае не ваш то есть вы в данном случае пользователь да я пользователь сервиса а этим сервисом владеет наш клиент то есть наш клиент по сути не вы наш клиент юрлицо которыми вы платите то есть мы сейчас говорим не продалась ваш да а про баланс клиента вы ему платье средства и они плюсуются в кластер после чего кластер отдает клиенту в вам данном случае ответ о том что операция успешно и сохраняет дальнейшей степ биллинговых операций который вам эти ненужные но то что там вот разводка по комиссии да вот это все это все эти очередь постобработки уже оттуда считается в базу и и а-а-а в итоге нашей наш клиент наш мир chant наш юрлицо он уже в админ кредит информацию из базы либо с дополнительных источников аналитики там еще откуда где она обрастает подробностями то есть туда данные приходят с некоторой задержкой да то есть нам вот вам как потребителю сервиса нужно сделать все моментально быстро в магазине карточка на кассе расплачиваетесь до вам там нет возможности ждать пока он тонизирует произойдет юрлицо а ну ну стань и подождать у меня атомы был вопрос получается я вот в этом кейсе до этого пять из такси то есть мой баланс это не вот баланса которым речь до обычно эквайринг с меня спида дальше грубо говоря уведомление что мерчант когда ты его получит все так нам я понял спасибо вот здесь вот коллега из земли в зато быть друг добрый день раз спасибо за рассказ про беленькую такого просто же правильно понимаю что если в операционном власти ноты будут падать по кругу пять минут они будут все вот просто по кругу падать и подниматься все равно не получится списать больше чем у человека резьба но конечно потому что мы можем в худшем случае смотрите в худшем случае да если у нас вот смотрим что происходит да точно просто коллапс то есть мода выходит из строя там связь теряется дамы в худшем случае операции будем отклонять то есть мы не выплатим больше чем вот есть вот самый по горящей смори представишь нас там допустим в кластере не знаю 1009 из них упал на вот 1 но да вот если на ней есть баланс к выплате вот будет выплачиваться он то есть понятно что ситуация пограничная да то есть криты и люди буду чинить и мерчанта будут оповещены о том что там и выплата работ с ограничениями там до плюс мы можем моменте какие-то манипуляции принимать ну то есть например если надо вышла из строя до к примеру мы можем не сразу и втыкать обратно в эксплуатацию по готовности мы можем понять допустим сколько на ней было средств либо сделать обеспечительный платеж да и и поместить его на тамаду которая сейчас в работе до чтобы обеспечить процесс но это не технически слой все-таки это больше про бизнес вот попросту бур да спасибо за доклад а такой вопрос наверное пограничный случай когда у нас со выплата поступает на носу б далее данные с надо бы вылетают на но туда и связи рвутся между модой и c но при этом они обе имеют доступ базе и вторая часть выплат и поступает на но duo что здесь будет мы зафиксируем только наши 500 рублей так давайте по порядку значит прям будем разбирать еще раз повторить прямо шагом клиент оплачивает то же самое такси по каким-то причинам по каким-то причинам сумму в 1000 рублей проходит в два платежа 1 платеж это соответственно надо б второй платеж под эту нас на но duo оба должны быть зачислены и просуммированы в итоге смотрите эта история про то что мы обрабатываем одну платежную операцию то есть если у нас идет 2 платежных операций то это 2 платежных операции то есть если нам нужно каким-то образом эти данные агрегировать то нам ядро скажет что ребята у вас там списание на сумму a + b то есть это же сервис внутри общее архитектуры ну то есть мы мы работаем с конечным значением то есть я может не понимаю получается у нас всегда только одно значение приходит на одной из ног не может быть такого что она по половине приходит и нараяна б смотрите то есть у нас может ли у нас параллельно выполняться н операции конечно может они могут приходить на разные ну да да там и в рамках одного баланса но в моменте но да она что делает она по сути смотрит на свой локальный баланс да если у нее хватает денег она выражаясь терминах в финансов она холодит эту сумму у себя то есть если к ней придут одалживать денег у нее уже не будет потому что они будут заложены под актив и и да вот под активную операцию понимаете соответственно вот если к нам пришел запрос параллельно мы смотрим достаточно ли на средств на ноде если средств недостаточно мы эту операцию откладываем в очередь внутреннюю да это собственно причину по которой выбирали бы например не печки то есть у нас внутри не очередь мы туда отложили тем тем временем параллельно мы продолжаем обрабатывать это раз в рамках баланса потому что они могут быть как в плюсовые так минусовыми да спокойно вот ответим на вопрос да спасибо правильно понимаю что если собираться соответственно что-то не так талер птица уже человек нет не всегда почему то есть когда мы говорим что с операции что-то не так важно понимать на каком уровне собственно происходит ошибка к примеру да давайте вернемся на кадр где мы собственно говорим про вот эту историю да то есть у нас есть ядра у него есть обработчик и вот мы к примеру на стадии посыла операции получаем ошибку любую сетевой связанности да ну вот мы не достучались не смогли отправить запрос операция не прошло то есть модуль ядра говорит ребята у нас decline как бы извините не смогла спасибо давайте еще один вопрос остальные перенесем цифровой хлор расскажите пожалуйста как восстанавливается общий баланс вот этого кластера если одна нота ми нулем вылетает с концами у нас есть же при этом состоянии того объяснить у нас есть состояние на уровне база данных то есть если у нас но до вылетает с концами мы всегда имеем возможность понять а какие биллинговые операций у нас обработаны the dew поймать то есть когда я говорил про историю журналирования до обратите внимание мы сравниваем не только состоянии not мы сравниваем состоянии not еще и с внешним контуром то есть мы знаем в итоге какую операцию мы обрабатывали если она получила положительный статус да значит ответ был если ответ был то мы можем этим оперировать если произошла ошибка то мы опять же мы либо не создали биллинговой операции и тогда списание не было но если мы уже их от если мы отдалим ядро саксэс то это означает что операций уже ушли в кафку вот это есть фактически div базу данных и того что на нотах удачными один из слоев контроля да а еще 2 вопроса небольшой алгоритмы can access никогда не рассматривали вот я открою вам скажу что рассматривали ему кучу чего от кучу вариантов да и даже вот предложенная скажем так архитектурная схема ее можно реализовывать на совершенно огромному различным стыке технологии да там хайфа не знаю взять еще что то но пока скажем так нет я не могу сказать что проект завершён да то что находится в активной собственно стадии апробации продакшене но все равно еще работу моря вот и куча всего еще предстоит проработать сережки последний вопрос у нас все так прямо есть в онлайне давайте тоже выпустим прошу можете повторить вопрос потому что у вас микрофон немножко шумит чуть чуть и я провел слышала про сколько но сейчас продакшене и как собираетесь масштабировать а давайте посмотрим на точки нужд обрезать но сначала по нодам not у нас на данный момент не так много у нас три dc в конце все по 2 по моему ноды но я как уже сказал мы сейчас находимся на право ционом периоде то есть наши вот этот класс сторон обработать весь поток asus нашего процессинга вот и частично мы уже начали приключение мир фей возможно будем расширяться теперь по точку масштабирования смотрите где мы здесь можем rush the bureau вам масштабироваться ну во первых давайте вот на этой схеме посмотрим да для начала здесь я думаю понятно да то есть у нас очередь кафка класс старков масштабируется дальше печки worker in у печки worker я думаю понятно то есть мы ставим тачки с маркерами запускаем на них новые процессы и здесь этому все тривиально дальше операционный но до биллинга операционным надо биллинга тоже мы можем добавлять в принципе в неограниченном количестве размазывай по ним средства если нам потребуется обрабатывать такой поток но то есть 2 . масштабирования и 3 . масштабирование получили то есть по сути задача максим для нас была уйти от масштабирования по базе вот я бы так это назвал наверно вот я ответил на вопрос спасибо большой сереж все остальные вопросы коллеги в цифровых кулуарах а я от себя хочу добавить что сергей сегодня и дебют в качестве докладчика и день рождения серёжа поздравляем тебя с этим спасибо большое"
}