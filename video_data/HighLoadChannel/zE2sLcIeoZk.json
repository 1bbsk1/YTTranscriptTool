{
  "video_id": "zE2sLcIeoZk",
  "channel": "HighLoadChannel",
  "title": "Интеграционное тестирование микросервисов на Scala / Юрий Бадальянц (2ГИС)",
  "views": 2573,
  "duration": 2765,
  "published": "2018-11-20T12:29:15-08:00",
  "text": "значит вначале я бы хотел пару слов себе я про два года именно работаю программистом начиналось php и java скрипта как я разработчик потом java потом скала и сейчас я пишу на скале в компании 2гис а значит в этой компании я работаю в команде который называется казино и мы делаем три основные штуки это реклама big data и краулер буквально пару слов про каждое из этих направлений реклама более менее понятно то есть мы решаем каких рекламодателей показать каких выключить каких повыше каких пониже bigdata у нас связано с рекламой то есть мы там какой-то персонализацию накручиваем на рекламу плюс у нас ну есть такие типичные для обе даты задачи то есть там аналитика метрики мы какие-то строим королек чуть отдельно и такая штука которая ходит по интернету и ищет сайт организации вот чтобы добавить их автоматически базу то есть три такие большие задачи и они выливаются в большое количество таких более мелких бизнесов их задач и на текущий момент у нас более 25 микро сервисов они на скале вот но естественно это только наш код мы используем какие-то сторонние штуки там например базуку по сгрыз да там помимо под газ а также мы например кассандру используем частенько когда например нам нужно crosse bc кафку мы используем вообще много где используем кафку то есть нас на мысль вас основной есть деревянкин это как legacy с которым мы постепенно переезжаем на кафку но приложение которое работы зеренков пока но они есть есть ходу где мы нашу bigdata храним с парнем и наши bigdata обрабатываем какой-то машин lernen который нам дает команда дата-сайентистов то есть особенно это что касается краулер а там есть много задач связанных вот именно с машиной орден гам и то там понять что общее на сайте где там не останется контактов вычленить из этой странице там что вот этот телефон вот это адрес или на 1 понять что вместо сайта у нас там огромный порно баннер там такое общем лучше не показывать вот и это не все то есть мы используем и какие то другие вещи там в буквально там может быть несколько сервисов я не буду все это упоминать и что получается получается большое количество микро сервисов ну или просто сервисов неважно большое количество зависимостей и естественно все это нужно как-то тестировать как тестировать ну как бы конечно мы пишем ими тесты но с uni тестами в общем можно попасть с периодом в такую ситуацию когда вроде как все работает все зеленая себя и проходит в общем запускаешь и чё-то короче пошло не так не очень и поэтому мы пишем интеграционные тесты я когда пришел в команду это был конец 2016 года было примерно следующая схема интеграционных тестов мы используем гид разработчик пушит в geht es geht а это попадает в team city kimseye тито система на которой прогоняются билды на который происходит сборка тем сити забирает конфиг из шефа кто знаком с шефом окей это короче такая штука типа как ansi был только он наруби ага это короче еще раз это система для управления конфигурацией различных серверов для автоматизации развертывания то есть от меня когда 100 машин и не хочу на каждую из них заходить по ssh и устанавливать вручную все что мне надо вот шер позволяет автоматизировать 6 хранятся китай кончики которые можно жарить вот тем сети знает о существовании шефов забирает и шефа конфиг собирает жарку мы пишем на скале соответственно артефакт который мы поближе мы the jar собрать жарку и заливает на какой-то себя окружении то есть есть какая-то машина куда это окружение заливается там разворачивается наше приложение также есть какие-то зависимости я тут нарисовал вот так в виде базы данных вообще тут вор быть сколько угодно каких-то зависимостей вот они тоже приподняты заранее благодарю там через шеф наше приложение не знает и начинает с ними взаимодействовать следующим шагом тем сити запускает сбт это наша система сборки где там компиляция тесты применяются вот и запускает тест тесты выглядят общем ну относительно похожие по коду на юнит-тесты но они в основном ну имеют такую лайкать и подходи по http вот на такой то адрес тут нашим приложению и спроси танковать метод дерни постричь он вернул оле там сделку это подготовку а потом сходи посмотри что вернулась то что мне необходимо вот что можно про такую схему сказать во первых это работает да это как бы важно легко запускать локально то есть когда у вас все настроено опять же как я уже говорю эти тесты похоже на unit тесты и их просто запускаешь их нормально но в общем на этом плюсы заканчиваются минус это первое то что все окружение всегда включено это лишняя трата ресурсов шеф это статическая конфигурация то есть нужно всегда иметь какую-то машину где он будет настроено настроены все зависимости где будет приложения сама разворачиваться то есть ну это общем железо выходит никуда от с таковы прогоняется ни один заднем все зависимости но всегда включено и тревор сказал да то есть также как с основным приложением невозможно запустить тест и двух веток одновременно это вытекает из предыдущего пункта у нас одно окружении мы просто не можем как бы вот распараллелить невозможно тестировать star стопы restart что это такое общее ты чего это нужно у нас все приложения они содержат и к так называемому огры слушать дауна сказок нам прилетает сик терм мы не сразу там умираем просто сбиваясь там посередине квант процессор мы принимаем перехватом этот сигнал и понимаем что ага надо выключится и тут включается какая-то логика там например да обрабатываем тех степи запросы которые в полете чему там работаем с кафкой там и там все с это к мите в общем какие-то действия делаем чтобы можно было спокойненько выключится и потом когда мы все сделали мы выключаемся вот эта логика она может быть не всегда очень простой и тестировать ее с такой схемой можно только вручную потому что мы из тестов не управляем жизненным циклом приложений а то есть где то там тем сети через шеф как-то там чет развернул а тест у нас вообще в другом шаге гоняются из и собственно не знают вообще как там развернуто наше приложение вот и очень тяжело это все настроить локально то есть много зависимостей у них есть свои конфиги нужно поднять на локальной машине у самого приложения есть свой конфиг он может быть как бы не стал трех значений составить до дома из 30 плюс у самих тестов есть свой конфиг который тоже нужно согласовать с конфигом приложения и там тоже может быть ни одно конфигурационные значение в общем вроде как звучит не так чтобы страшно ну типа поди там конфиге в трех местах поправь но и стильности у новых сотрудников на это могло уходить ну там часы это не очень со временем эта схема преобразовалось немножко в другую ski club msi и докером это произошло не потому что мы там в общем у нас сильно болела от предыдущей схемы а потому что компания просто немножко как бы сменила курс в плане вот административных каких-то штук то есть раньше каждая команда команд много она как хотела или как умела таки разворачивала себе все то есть вот у нас был тим сети у нас там был шеф другие команды могли пользоваться дженкинсом anansie blanc карьера но что хотят то и пользуется вот сейчас же мы двигаемся в сторону локального облака в сторону кубер не tissot и есть отдельная команда инфра строчи на первый шанс которая это все менеджер менеджер битла psy ai managed кубер нить из и команды используют это просто как сервис это намного удобнее намного проще не надо там в ручной все это администрировать и мы собственно такой вот скоблить сам развернулись следующую схему git push со все уже теперь будет lapsi ой а нефть incity incity теперь собирает не jar куат докер-образ и заливает опять же на специально себя окружении суть этом в убирайтесь у нас там все это поднята и конфигурацией хранится прямо в репозитории там разворачиваться приложение где-то в убираете опять же у нас все при зависимости подняты заранее а потом гид лапша отдельным шагам запускает испытаем и запускает тесте вещи так последующем похоже на прошлом схему и принципиально не отличается от прошлой схеме то есть все плюсы минусы будут точно такие же однако важный момент это докер кто только использую она почти короче все из поезда докер все любят или не любят наоборот вообщем докер с доктором можно делать уже какие-то более прикольные штуки и одна из таких прикольных штук это докер кампус значит докер кампус это такая нашлепка над докером которая позволяет запускать несколько докер образов как единую сущность типичный узкий для докер кампус это кафка карте нужен звуки пир и если делать это без dk campus мы отдельно должны поднять звуки пир в докере отдельно поднять кафку в докере держать эти два докер-контейнер а как бы согласованными это не очень удобно и докер кампуса позволяет в одном докер комбо схему файлики описать оба эти контейнеры и просто командой там докер ран кафка джокер компл франков к он поднимет кафку и поднимется теперь то есть одна команда удобно и на docker кампус можно общем построить интеграционные тесты как это будет выглядеть опять же наш гид пусть совсем beetle обсе игил общая просто запускает докер кампус докер compose у нас поднимается приложение поднимаются все зависимости поднимается сбт и и сбыта гоняет с ты к этому приложению все внутри докер com пол за ok что можно сказать про такую схему в общем не нужно держать отдельно и окружение и зависимости потому что у нас все проходит прямо на раньери вас просто на ранили должен быть докеры докер кампус и во время старт он подкачать все нужным разве будет делать там свою работу можем тестировать разные ветки одновременно это вытекает из предыдущего пункта просто все идет на ранее проще настроить локально на все еще нужно согласовывать несколько мест тут речь о том что нам теперь нужно когда мы локально настраиваем все на локальную машину стоять или у нас все прописано tiger компов схема файлики однако у нас все равно есть два места до этого докер кому схему и конфиг наших тестов конечно уже сильно проще но в идеале я бы хотел иметь ну то есть возможность все configure из одного места когда мне появляются новые конфигурационные там ключи какие то я хочу в общем в одном месте камни чтобы она виде как-то там автоматически разошлось в идеале минусы да все еще невозможно тестировать старт-стоп restart потому что из сбт из тестов мы не управляем жизненным циклом жизненным циклом управлять докер компов он чуть чуть сбоку да то есть он запускает сбт и и внутри сбыта запускается тесты то есть norma полноценно управления жизненным циклом приложений нет и есть сложности запуска про вот это я хотел бы остановиться чуть подробнее рассказать значит запуск нови град на docker кампус как было во времена decker campus 2 вот так выглядит декор кампус ямал файлик это nokia му там прописаны сервисы эту сервисе это то что мы будем поднимать в рамках этого докер кампуса в данном случае я взял просто пример из документации джокер кампус тут у нас есть три сервиса это веб редис и база данных на веб а то как бы наше приложение редис баз данных это какие-то зависимости в vip блоке есть такой пункт depends on то есть он говорит о том что наше веб-приложение зависит от какие-то других контейнеров и из каких от база данных и отряде сада они ниже описаны ты каркам пол схему и есть такой интересный пункт кондишен тащу редиса кондишен это сервис started это означает что когда мы будем стартовать веб-приложение он увидишь долга я завишу от редиса по условий сервис started это значит что пока кризис не стартанул контейнер и они будут пытаться стартануть веб-приложение вот у базы данных же кондишен сервис хелси и вот ниже там описан хавчик это уже более интересно это означает что он минут можно не только стартануть докер-контейнер нам нужно еще выполнить к вы the halls чек это может быть ну там любая кастомной а логика там просто мы в тесте описываем что нам нужно подождать случаи жизни мы используем по сгрыз и в конкурсе мы используем расширение пост гис а подвес ему нужно некоторое время для инициализации когда мы просто стартанули докер-контейнер мы не можем сразу работать с после с расширением и поэтому нам нужно там тёплого дождаться вот это инициализации расширение и мы чудом мы просто зачем запросы этом селе кто-то из вершин пока он не будет инициализирован он выдавать ошибку этот запрос когда расширение инициализируется это возвращает на там какой-то версии вот такое то есть это очень удобно и то есть мы ну это вполне логично выглядит мы сперва подняли все зависимости потом наше приложение вот ну окей дальше идем докер campus 3 когда вышел нам видимо потребовались я уже не помню китаева фичи нам в общем мы на него приехали и там в общем такая теперь плашка в документации появилось что-то пенсу больше не будет ждать пока базы данных и редис стартануть depends on он теперь просто описывает грамм в зависимости то есть мы когда говорим blogger.com полос ран редис он смотрит что у редиса нету зависимости и просто его 1 стартует когда мы говорим только пол со ран веб он или что у вербая зависимости и он стартанет зависимости веб но он стар трендах одновременно ничего не будет ждать и следующий пункт это то что конечно больше не туда pension ну соответственно ясно почему потому что логика поменялось и если вы все-таки короче ребята хотите чтобы у вас был вот этот контроль то там вот ну синеньким может быть плохо видно ссылочка на страницу контрольный start a porter где написано как как короче надо делать вот мы все за вас придумали идем на эту страницу общем считаем расстраиваемся и видим несколько вариантов решений первый вариант решения это использовать weight for it is аж что такое я чувствую что некоторые знакомы до теперь немножко по-другому нас выглядит наш докер компов схему теперь у нас depends это просто массив теперь у нас никаких кондишен of нету и в наших но зависимостях мы переопределяем команду что такое в докер кампус можно определить команду с помощью которой докер-контейнер стартует там мы должны написать вытворит sh и вот там три точки кита что этих трех точках мы должны написать чего нужно подождать и оригинальную команду которая стартует этот докер-контейнер то есть мы должны такие ok мы там regis используем надо бы найти пойти докер файл идешь там докер файл ищешь там как найти долю в докере докер файл гуглишь там и находишь все берешь там смотришь там короче вот такая команда окей копируешь пишешь вот эту проверку ваша естественно вот в таком синтаксисе чувствуешь прям о круто к и окей дальше сделали потом идем базу данных делаем тоже самое но общем там еще больше и как-то это не очень потому что ломается абстракция мне не хочется знать какой командой стартует докер-контейнер я хочу просто докер ран все я не хочу там заморачиваться эти эти команды они могут быть нетривиальными не могут быть довольно сложными и в общем такое решение о но лично мне не очень понравилась у нас есть там парочку сервисов которые вы так делают вот ну поэтому я решил что пришло время велосипеда строение да и в общем то игрокам полстраны саша делся у меня что такое тут я уже показал более такой реалистичный пример то есть полу реальной да то есть какой-то пост газ в докер compal схем ли есть какой-то май сервис мое приложение которое зависит от подагры и сбт в котором гоняются тесты который зависит от нашего сервиса вот и вдруг меркам я запуска не через докер ранда как обычно а вот через скрипт с в горьком полстраны sage что он делает во-первых он запускает сперва самую глубокую зависимость моем случае это поза берс и запускает и в режиме демона то есть он и стартанул и как бы терминал не блокирует а потом я жду какого-то условия это практически то же самое что и with far it is аж только но вот как бы вот таком императивном стиле да то есть я жду ну данном случае то что я говорил вот этот пост гис вершин то есть пока по здесь инициализируется и это блокирует терминал точно ждет ждет нас не дождался там выбросит ошибку тест упадут nokia он дождался следующим шагом мы тоже самое делаем с моим сервисом тут уже тесто проще просто 80 порт должен быть за бензин и последний шаг это мы уже запускаем через команду ран наши сбт в котором гоняются тесты у нас как бы уже все там поднята в правильном порядке вот так вот вручную и в конце вызывается функция down что за функции она довольно простая то есть она принимает результат предыдущего команды результат выполнения предыдущей команды если он 0 то все хорошо значит тесты прошли мы просто включаем декор компас если 0 там и вы клёвые многие потом включаем dakine campus надо же как-то разобраться что же у нас пошло не так вот кому нравится такое решение отлично очень я это написал это конечно работает но в общем я вот примерно вот так себя чувствовал когда вот это вот и все написал когда ну медитировал на вот эту страницу не не но мы как бы естественно эволюционно все это развивали то есть ну там один может быть во сервиса вот и руси в той кирком ползимы тестером один сервис вот вопросы в конце ну в общем я подумал ну я думаю на эту тему до меня это волновало впрочем что-то не так и какая мысль ко мне пришла что если у меня как бы и так все докере того почему бы не запускать этот докеры skoda но ok давайте пробовать на я начал искать решение нашел несколько вариантов первый вариант это использовать просто докер клиент то есть в живом мире есть два основных до kirkland это докер j'avais пути файту kirkland что такое это просто но вы пользуетесь докер клиентам из консольки там духе ран докеры аспект муки такие штуки и это общем то же самое только не с руками да там конкатенировать в коде а просто но обычная java это конечно работающая штука и наверняка все вот на этом можно сделать однако это очень низкого уровня то есть мне пришлось там свой как бы докер кампалы грубо говоря создать да там с моими требованиями но в общем такой фильм ворот делать не самое приятное но я общем запомнил это но чуть отложил следующее это библиотечка докер искала она оборачивать вот эти вот клиенты причем оба носит можно выбрать какой backend использовать и она ей говоришь вот мне вот эти вот контейнер запусти я хочу там с ними тесты пойдет только ok хорошо и запускать но минус этой библиотеки в том что об этом не очень гибкое и нету контроля за жизненным циклом то есть как блики зашит контроль жизнь его цикла так он в общем есть окей ну ваще мне это тоже не очень понравилось я пошел чуть дальше и нашел такую штуку как тест контейнер и этот с continues я бы хотел становиться чуть подробнее значит что такой тест контейнер это такая java библиотека для запуска и тестирования докер-контейнер там есть скала фасад из контейнер скала из коробки там есть ряд популярных сервисов на пол весь мой скрин джинс кафку selenium можно запускать любые другие контейнеры внутри контейнера вашего приложения и там давно таки простой гибко пи про который я считал чуть расскажу как работать с контейнерами которые уже приди фанеры библиотечки все довольно просто той библиотеке все контейнер представляются виде просто объектов в данном случае у нас тут под грифель контейнер мы его там создаем можем его стартануть потом можем там с ним как-то поработать в данном случае мы там даст ему него джитибиси url с помощью которого можно к этому адресу прикасается и потом за достаем зама пленный порт зама плену порт это значит но докер внутри торчит портом он вернее postgres торчит изнутри докера под в том 5 4 3 2 1 контейнер он видит этот как бы порт которым торчит по сгрыз и автоматически маппет на какой-то случайный порт с тестов мы видим какой-то там 32000 там 422 вот и этот маффин делается автоматически и вот эта функция возвращает вот этот за мобильный порт мы бы работали до частями сделал реки то запросите покидали и потом можем выключить наш пост рис ну довольно просто картонный контейнер тут тоже все просто общем просто есть generic контейнер который от которого нужно от наследоваться и переопределить там ряд полей обязательно это только и моечным то есть нужно сказать в общем какой докер-контейнер мы хотим создавать можно задать экспо спорт это те порты которым будет торчать контейнер involvement переменные можно задать можно задать команда ту самую класс пас ресурс маппинг и тайну немножко кастомной а такая штука то есть если она позволяет за маппить внутрь докер-контейнер а какие-то ресурсы из класса это очень удобно например если у вас конфиг приложения лежит прямо в ресурсах теста в тестовых ресурсах и у просто markt вовнутрь и все и приложение 8 и доступ к этим конфигурационным к этому конфигу и последнее это выстроить же выстроить же это очень удобная вещь та самая которой не хватало до игр campus 3 и the halls чек фактически там все что нужно это определить о твоих 3g есть несколько при define их в с 3 же например можно подождать что там порт заменится или что-то мажьте типе там по такому-то углу будет отдавать 200 но можно также написать любой свой хелс чек и так как вы пишете хавчик просто своем коде то вы можете использовать во первых нормальный язык да не на баш писать вот а во вторых вы можете использовать но любые библиотеки которые вам доступны из вашего кода то есть хотите там в кассандре как он кастомный хавчик ну и там берете кассандры драйвер там и пишите как их а какой хотите хавчик очень удобно как запускать тесты тут я буду показывать пример со скал а тестом это ну как бы де факто стандарт в мире скалы для тестирования на такой фреймворк то есть вот например мы хотим написать если для подвеса то есть мы делаем такой пост близкий успех и что нам предоставляет даст кантемир скала этот форум тест контейнер критик что он говорит что вот те контейнеры которые ты мне скажешь я буду их запускать перед всеми тестами из топать после всех тестов есть еще four личность контейнер это когда контейнеры будет 100 паца и стартовать перед и после каждого теста вот дальше все что мне нужно это переопределить контейнер то есть вот есть такой поле нужно вырубить этом говорю что за контейнер нам в моем случае это пожгли скале контейнер и потом пишут с ты в данном случае я там сосулька это connection на там беру а джитибиси url username password и там пишу какие-то тесты там на запросе кита по слою если мне нужно несколько контейнеров но обычно для интеграционных тестов мне нужно несколько контейнеров очевидно я могу их вот с помощью такого helper a multiple контейнер создать то есть я создаю контейнер и закидываем и тепло контейнер и вот этот убирает вал контейнер ну говорю что стало что это multiple контейнер с вот этими контейнерами как выглядит схема с тест контейнер get слушаться все видит lapsi diplo общаясь запускает из бтс запускаю тесты и тесты запускают все остальное то есть наше приложение и наша зависимость и также там тесты как бы в этом самом сбт и что получается какие плюсы-минусы эти схемы не нужно держать отдельно окружении зависимости это уже было да то есть у нас все на раньери происходит можно тестировать разные ветки одновременно тоже уже был наконец можно тестировать царство по restart потому что мы можем управлять жизненным циклом нашего приложения у нас есть методы старт-стоп да мы можем и дергать есть гибких all щеки до этого очень не хватало никаких sage файликов репозитории но лично меня это очень рад можно конфигурировать приложение тесты как угодно гибко благодаря вот этому класс посты ресурс маппингу нас все лежит в одном месте мы можем просто говорю я один и тот же конфиг шарить между тестами и между приложением ну или вообще там из из из кода конфигурировать тесты и приложение к хотите и все это одинаково легко запускается как на себя так и локально ну потому что это просто тесты они выглядят как юнит-тесты запускаются каким-то стоит около меня там все в докере поднимается и общем ну как-то очень подозрительно да все вроде хорошо одни плюсы но как вы понимаете так не бывает рыб с которыми столкнулись это проблема зависимыми контейнеры значит о чем речь ну вот есть какой-то тест там я запускаю под гораздо об контейнер вам контейнер я передаю там из-под пресса какие-то значения то есть между же моему приложению сказать что приложение к аннексии вот к этому полису вот по такому url с такими землемам с таким-то по садам все делаю multiple контейнер со но все потоки я пишу какие-то тесты ну запускаю короче вижу ошибку то что за мобильный порт не может быть взят пока контейнер не стартанул что за фигня почему так в общем оказывается то что вот этот вот в третьих for all those контейнер до или фурычит из контейнер они стартуют контейнеры непосредственно перед тестами а вот в тот момент когда я создаю об контейнер а у меня еще нет ни не включен пол и грыз контейнер и я не могу у него взять вот этот за мобильный порт а он нужен для формирования джитибиси url а то есть мы должны же приложение искать по кому url уходить об ортон нету вот и что получается мы пытаемся взять вот этот порт за матный а контейнер еще не включен и у нас все падает то есть ну проблема в том что у нас как бы вот эта точность контейнера на мутабельные и у нее есть как бы несколько состояний донатом вытащенные включена вот туда вот какую такая проблема возникает что можно поделать ну можно сделать лениво то есть сделать наши контейнере лийзи валами и тогда они не будут инициализироваться сразу в конструкторе теста вот и нам придется отказаться от by фонда от форта с контейнер до который представляет библиотечка использовать обычный тест контейнер обычный скал пестовский и фонда втором эта штука которая позволяет мне переопределить метод обе форум и автору и сделать что перед всеми тестами и после всех тестов но в моем случае мне нужна стартануть все контейнеры выключить все контейнеры в конце и там я описываю by pharrell все правильном порядке запуск моих контейнеров суть игры там побег and starting a point стартер и они одновременно и создаются их инстанции инициализируются и стартуют то есть теперь у меня не будет проблем с тем что map спорт он недоступен то что у меня инициализации старт одновременно происходит ну все работать должно то думаю чтобы отработать но очень не будет и теперь уже ошибка в приложении что я не могу при канальца какому-то локалхост 32 787 окей что за фигня но похоже что от но это как бы джи-би-си url почему локалхост на то есть у меня там где бисер идем смотреть как работает джитибиси гуру значит что у нас тут есть во первых это просто конкатенация кейта строк я просто что делать берутся какие-то константы донатом литералы берется get maps порт и мы точно знаем что это счет штука нормально работает мы то можно за костыля ли дата бы и стамину просто какая то опять же константа захардкожены и вот гид контейнер айпи адрес это вот пока для нас тайна да что за фигня в общем начинаешь разбираться и находишь что такую еще на гитхабе и такой окей ребята то есть ну вроде по названию детка тренер айпи адрес ну прям то что доктор прописал но в общем нет когда читаешь что тренд это очень весело и что оказывается что вот этот контейнер айпи адрес он предназначен не для меж контейнерного взаимодействия а для взаимодействия из тестов внутрь контейнера и в таком случае да это все будет работать но между консолями это работать не будет и рекомендация разработчиков создавать network кастомный для взаимодействий между контейнерами то есть вот так в принципе делает игрокам полз он создает network и ну там все сам разруливать ну ладно ребята давайте делать кода все больше да все и сильнее становится вот мы создаем network теперь мы должны в русь ручками сформировать джитибиси url теперь мы также должны закинуть наш пузырь из контейнер в этот на и тогда задать ему алиас но чтобы он был внутри этой сети доступен по какому-то доменному имени наш наше приложение закинуть в это джен и отверг нужно чуть поехали стрелочки ну ладно и в конце еще нам нужно не забыть убить этот network ну что бы они там ни копились вот кто думает что будет работать суток или нет ну короче будет работать так нормально работает конечно кода многовато ну в общем нормально в новой версии да там и шлюзов по заводил да и там мы в общем немножко получше сделали можно опять использовать frautest контейнер и можно использовать multiple контейнер то есть не нужно в be fine до 2 ручками прописывать вот этот порядок запуска теперь multiple контейнер умеет слайде вами работать он там их в правильном порядке стартует и не делает ну вот этой вот strict инициализации сразу по созданию вот чуть-чуть лучше но в общем все равно такое все еще проблема и to make значит о чем речь иногда бывает что не очень удобно создавать зависимость какую-то в игры контейнере например мы используем такой штук экспорт джобс сервер spajic сервер это spark эта штука которая взаимодействует с парком это htp сервер который создает на спарке джубы и контролирует их жизненный цикл то есть что мы делаем мы такие из приложения говорим о & spa jet сервер запустил такую джо план такая окей запустил используем сервер а какой статус этой джебы такая ну типа выполняется а сейчас выполняется а сейчас выполняется сейчас она там завершилась там с успехом или с ошибкой но два метода дергаем да там создай и дай статус вот ноги чтобы развернуть этот сервер внутри докер-контейнер а нужно проделать нормальную работу да то есть сам усама спонсировали дон там недавнего времени вообще не было контейнера надо было самому там особи плюс у него есть пол игр с база который он использует для там своего состояния ну и как бы нужно поднять spark в докер контейнеры что тоже такое себе развлечение а нам нужно два метода блин они такие простые даст простым api плюс можно посмотреть просто в кода и ну и видеть как у как он там что возвращает и поэтому нам проще ну замок от этот сервер и как-то выглядит то есть создается просто http-сервер прям в тестах стартует с таким же a pic of us поджог сервера он инициализируется какими-то данными мы потом говорим что приложение ходила на этот спаржу в сервер вместо настоящего потом дергаем метод какой то у нашего приложения и смотрим что ну то что вернул метод она соответствует тому что мы положили в мог бы такой полу псевдокод на чтобы просто понять идея да что нас есть штука которую мы можем как-то настраивать и использовать в качестве ну замены настоящего сервер вот и нам нужно как-то передать наш контейнер как конектится к этому с паром сервер муку но спортом более менее понятно да мы можем за хардкоре или там в кончик это положить а какой хост да то есть смотрите в чем фишка наш вот этот с парнем сервер мог он запускается прямо из тестов то есть он запускается на хостовой машине а наше приложение она работает докер контейнере который работает в какой-то нашей кастомный докер сети поэтому вопрос как вы думаете что вот я должен вместо трех вопросиков написать тогда я бы тяжело конфигурировать и skoda ну действительности там нужно написать gateway to city в которой находится докер-контейнер как это сделать это вообще если подумать дайте довольно логично да то есть вот там сеть она создана там на этой link свое машине да и она between торчит на локалхост дает айпишник это и будет наш вот этот х 100 выпить но собственно как достать этот гель твой network network gateway ночью не как такого api просто нет однако в конце не шел работает поверх обычного докер клиента и мы можем спуститься на уровень этого докер клиента в том я там первый пункт договорил использовать просто голые дойки рки давайте так делать во первых намазать клиент изъять у докер-контейнер съесть такой д киркланд factory он возвращает этот клиент потом мы формируем команду inspect над work которая нам ну собственно инспектирует этот network и в конце мы из этой инфо которая вернулась достаем этот gateway конечно такое как бы себе но однажды сделав это становится понятно но фишка в том что работает это не везде да докер у нас сейчас запускается на разных окружениях то есть у нас есть windows у нас есть мак докер может быть удаленным и работаете за штука будет только на линуксе но к счастью у нас linux мы все пишем на линуксе и тест он разгоняется налил oxide production нас на линуксе поэтому для нас то не особо проблема и поговорив с разработчиками тест контейнер я понял но они не скажешь что это является основной причиной почему нету такого api в самой библиотеки под но они знают об этой проблемы не чего-нибудь думают вот и что же получается что общем как то она работает но как-то короче вот вот тогда как вот гейтс показывает однако есть надежда есть такой попу узел к новой машиной версии тест контейнер в чем тут основная соль там взяли ребята и разделили ядро тест контейнер с который запускает докер контейнеры и описывает их виде вот объектов и интеграцию с тестами free марками ты сам-то контейнеры java вы он просто гвоздями прибил g-unit у там узко latest а есть какие-то там тоже интеграции с жиндом поэтому носим скальное обертка более-менее органично выглядеть но вообще эта проблема и ребята общем это поняли и решили разделить ядро от интеграции с тестами from орками и api вот эти проблемные места сделать получше то есть например в новой версии там не будет вот такой проблемы с как вот я самом начале показывал до зависимы контейнер на когда пытаюсь достать порт из не включенного контейнера он там будет просто две сущности как в описании контейнер его runtime представления то есть намного лучше если хотите можете прийти там посылочки по встрече что ребята пишут там в общем нормально какие итоге сделать нормальный тест и сложно блогер помогает но тянет за собой кучу особенностей то есть в принципе докер это не самая простая вещь это не самый простой кусок пол с ним нужно там посидеть поразбираться да там наловить десяток кораблей только потом как бы понять что вот этот не твой битовой господи тест контейнер с это очень хорошая либо который решать наши проблемы то есть все что мы хотели мы добились но текущая пи добавлять немножко боль если вы не живым мира и стыки ok смотрите в принципе сам подход очень хорош и вот представления контейнеров виде объектов это но на мой взгляд выигрышная стратегия на текущий момент и очень удобно с таким взаимодействовать для других языков для других я систем есть похожие библиотеки то есть точно есть и tom ford енот же спорт возможно есть порты и на другие системы я просто не знаю и в любом случае у вас есть докер клиент и возможно кто-то уже пилит или вы можете стать молодцом и запилить свой похожий проект вот и на этом у меня все спасибо привет спасибо было очень интересно а скажи писалось я правильно понимаю что это все используется исключительно в тестовом окружении вы никак все эти наработки для тепло и сервисов и используйте так дари тепло отдельно тест 1 но окружение же различается и довольно заметные за контейнер это у нас во первых оберните шла все в контейнерах вот это первое второе это не and the end тесты это интеграционные тесты что ну как бы в целом когда все от поднята она как-то вместе работает то есть это просто слой не самый высокий тестов да ну чуть чуть пониже да но при этом и не юнит-тесты когда мы просто там маленькие кусочки кода там метод или класс тестируем вот так последний вопрос а почему нельзя было тестовое окружении точно так же в отдельном кубики разворачиваете против него тестироваться но это во-первых сложнее во вторых но вот как я показывал да иногда это не очень удобно то есть тут ну например смог амида там уже сложнее будет но spark spark поднять принципе в кубер не тисе этого только недавно они запилили когда то есть мы это все делали еще до того как они запилили это и пришлось бы как-то там но опять же до велосипеда строение какое-то делать это первое второе вот этот подход он позволяет все в коде описать то есть я просто ну просто пишу unit-тест я могу там говорят брейк-пойнт поставить и вот там посмотреть сколько у меня состояние общем все находится потому что мы тоже важно да я там кот поменял там теста запустил носи красное я должен пойти и посмотреть это первая причина вторая причина уже 3 до то что насколько очень много негативных отзывов про куб но мини куда то есть он во первых там по вообще не работать на маке да то есть но какие то там у него в принципе есть проблемы то есть ну короче на это завязываться не хотелось но у нас есть команды другие которые этим пользуются и вроде как нормально спасибо за доклад очень интересно единственно не понял как задать конкретной версии контейнеровоз по какой версии они гоняются танки там мастер мастер всегда завитками не отдавать я покажу да это было короче там просто image name нужно задать тампон сгрыз я 9 и 6 задавал ну допустим у меня и сервис на какой-то у него там версия 2 1 222 там не знаю моя ветка внутри как вот это вот посмотрите подпись каир 9 и 6 по умолчанию себе ничего не задаю там будет ну типа десятка по моему вот то есть имидж это имя контейнера : его твв на проекте что мы делаем у нас просто в конфиге есть этот имидж так да там конфигурационные значение и мы каждую ветку с маркируем определенным тегом там говорим что вот грубо говоря ими ветки и все и соответственно каждый редко независимо прогоняется своим вот этим вот тегом вот когда все хорошо у мастера есть там blade езда теги у них там теги то есть ну то есть оливки должен в конфиге написать имя там моего ну там из вся это подтягивается очень легко ну просто там нет вообще это что-то типа branch на in sludge как-то так называется спасибо еле слышно мне больше методический вопрос в целом по тестированию оказалось это устроено вы сказали что у вас один сервис тестируется то есть он как бы интеграционная но против инфраструктуры больше получается или у вас есть какие-то тесты где несколько сервисов например описан просто интересно как это происходит у сколиоз больше 20 как бы неужели у них у всех есть не убивает интер зависимость которая требуется тестировать спасибо я понял смотрите во первых вот эти тесты это тест они находятся в репозитории самого приложения эти тесты относится исключительно к тестам самого приложения если приложение зависит от других контейн других приложений наших то он просто использовать либо эти контейнеры либо муки в зависимости того какая задача да как удобнее вот какого то вот большого большого интеграционного теста у нас нет мы это делаем в ручном режиме но этим уже занимаются тестировщики как бы full-time тестировщик интеграционные тесты у нас пишут разработчики по крайней мере в нашей команде и они на общем прогоняются там с каждым кометам а вот большая интеграция она нужна не так часто и обычно когда там приходит какая-то одна новая большая фича и там нужно например там окей там android там айос короче вот эти вот эти команды там в общем много всего то есть это нужно не часто ну и опять же это чуть более высокий уровень тестирование вот это это чуть более низкий то есть есть некоторая проблема с терминологией то есть может быть это функциональные тесты в разных книжках там разных статьях а вот это называют чуть по разному где-то интеграционные тесты где-то функциональный то есть может быть это возникло некоторое недопонимание"
}