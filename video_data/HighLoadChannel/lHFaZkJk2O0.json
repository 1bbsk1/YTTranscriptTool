{
  "video_id": "lHFaZkJk2O0",
  "channel": "HighLoadChannel",
  "title": "Как устроена MySQL-репликация / Андрей Аксенов (Sphinx)",
  "views": 5747,
  "duration": 3046,
  "published": "2017-07-29T12:57:50-07:00",
  "text": "так короче я наверняка опять не уложу в бюджет традиционно потому что 40 минут ни о чём вот начинать с вопросов тоже Странно а то тут таймер вообще с сотыми долями секундами и это создаёт ощущение давления на психику поэтому сразу как бы предупреждаю что Короче если есть какие-то вопросы если кто-то значит что-то хотел сильно узнать бы мне победить какую-то наю проблему Вовы Мне ВС потому что я ничего не знаю А во-вторых ну по-любому после этого как его доклада потому что секции вопросов скорее всего говорю не уложу в бюджет не будет Вот рассказывать буду всё тоже самое что всегда ничего интересного Если вы читали документацию хотя бы раз то вы технически уже Ну наверно ВС знаете ноб в том домен обновляется А вре Никто не знает что и где читать там будет короче самый главный слайд один в конце который как я только что понял надо было заменить на другой самый главный слайд Вот надо было здесь написать слайд короче со всякими ключевыми словами типа как бы если вы всё забудете то как бы в доке искать вот эти эти эти ключевики как бы нет никакой человеческой возможности домен сейчас там три основных ключевики они разбросаны по докладу это плохо Вот Ну и как бы понятное дело не будет традиционного введения под названием Давайте короче позырить репликацию там у нас вообще ничего нет Давайте её включим для этого тушим сервер настроим конфиг тут перетащи mysql Dump не просм записать позицию в бинге или включим ключик у mys дампа который это делает предполагается что ну я не верю что это как бы все умеют и знают потому что как бы зачем Вот но громко буду кашлять хорошо но Ну вот подобные значит туториалы под названием как Как взлететь за ону минуту их как бы в интернетах много Ну хотя технически в интернетах вообще всё есть включая исходники Так что вот так значит начнём с традиционно по вобще вот здесь я сделал домашнюю работу и устроил слайд под названием как бывает вот репликация устроена вообще подчеркиваю и заостряет на планете есть несколько основных осей измерения скажем так несколько основных вариаций вот можно сделать типа там синхрон ную репликацию Ну На физическом уровне Хотя это геморрой наверное страшные будет при этом по Спаси Господи пуш модели и мастер мастер Вот это в принципе можно скомбинировать если вдуматься то это а холокост какой-то из выбранных решений Ну вот так как бы наверное основное Что значит интересно здесь это варианты забыл как называется Сейчас вспомню про синхронизацию я их назвал по-русски значит варианты синхронизации той или иной транзакции Ну то есть что нам оно гарантирует остальное так всё вот в обзорном виде как в принципе бывает устроена репликация пропускаем коче полчаса доклада под названием вот репликация бывает во-первых То есть это не миф во-вторых она бывает синхронна асинхронная ещё там всякие интересные градации могут возникать Ну и собственно по модели распространения кто кому изменения пихает шпу Ну и по количеству точек записи либо мастер слей либо мастер мастер вот внимание соцопрос На каком из этих моментов кроме всех хочется заострять внимание или проем цинично все И ныряем в то Как оно устроено в масле А вот все ключевые слова все отлично понимают Давайте Не стесняйтесь всё равно Все смотрят спиной никто не видит Кто хочет подробностей больших чем один слайд один человек три о попёрло попёрло Главное чтобы один хоть поднял так хорошо ладно попытаюсь тогда смка короче ненужные подробности и раском Кать ненужны репликация как бы как вещь в себе что такое а важно понимать что репликация сама по себе это всего-навсего процесс копирования одной и той же базы данных ког свою копию шарда клад на соседнюю машину это тоже репликация которая делает из этой одной копии копии причём Ну в принципе вот можно наверное было ещё на слайд добавить офлайн онлайн репликация типа онлайн с какими-то требованиями по задержке дохожу что вот когда у нас есть эти самые много копий Мы только что доблестно от масштабирование из базы данных если у нас была база данных в которой можно было впихнуть на одном максимально толстом доступном сервере 1000 записей в секунду записей в смысле не строк таблицы а записи в смысле операций вставки вот возможно более сложных чем одна строка таблицы если мы успевали на этом серре впихнуть вставок в секунду секунду 3.000 селектив То и внезапно сделали четыре реплики то селектив у нас будет 12.000 в прыжке на самом деле скорее всего чуть меньше А вставок у нас будет меньше исходной 1.000 просто потому что в случае с репликации у нас с ма сй репликации у нас всё равно одна точка входа одна точка записи вот эти три дополнительные реплики которые мы подложили они работают на чтени они не работают на запись сами по себе и соответственно ну репликация сама по себе вам отма только чтение запись она вам не отма для того чтобы отмаливания My сли из коробки я честно говоря не знаю потому что как бы этот слишком старый и как бы привык делать в ручк вот такой важный момент про про репликацию помните что й просто так не от масштабировать чтение соответственно можно про вот наверно самый важный момент из всех этих возможных осей как бывает бывает синхронная репликация асинхронно и типа полусинтетики на всякий случай чтобы не вводить в блудня из мольной книжечки из краденый синхронно означает что если у вас комит прошёл то база вам обещает что не просто комит прошёл а он ещё и прошёл на удалённых нох Ну то есть мы комит сделали какой-то подключились к одной конкретной ноде к одному конкретному сер эти данные уже должны вдобавок в идеале для того чтобы обеспечить И масштабируемость почтения мы доступность данных они должны улететь на соседние машины и транзакции там должны зафиксироваться вот это синхронная соответственно репликация но Понятное дело что на каждый комит дожидаться ответа от удалённых НОД о том что они и прочитали данные и успешно накатили транзакцию Это довольно долго во-первых и геморой во-первых ноды могут конкретно лагать и транзакция которая на Мастере уже пробежала она теоретически может на какой-нибудь све проиграть сильно потом там говорят легенды я правда слава Богу настолько ужасных не видел что иногда репликация лагает неделями вот причём не специально То есть это удобно для целей бка Прикинь ты как бы сделал на основном боевом сервере и у тебя херак есть как бы 2 недели на то чтобы думать Вот Но тем не менее синхронная репликация - это вот как бы вот медленно соответственно счастья от неё особого нет интереснее Ну как бы не очень интересен вариант под названием асинхронная репликация потому что гарантий нет совсем никаких Ну окей транзакция зафиксировала локально это тебе что-нибудь гарантирует правильный ответ нет потому что возможно возможно все остальные реплики лежат до те данные которые вы вкатили на мастер они у вас бы ну никуда не резервируются Ну соответственно если у вас мастер просто упадёт В смысле SQL сервер упадёт то всё хорошо условно он эти изменения с Лога ещё проиграет Но если у вас внезапно как бы демоническая сила подожжёт сервер он сгорит прямо весь то как бы данные которые вы якобы зафиксировано надёжности Но блин медленно асинхронность полная зафиксировали локально транзакцию и не ждём вообще удалённой реплики но быстро очевидно ничем же не отличается просто от локального комита но никаких гарантий по надёжности ну и соответственно понятное дело возникает промежуточный вариант состояние новый баланс скажем так и удалённые сервера уже скачали эти данные уже скачали эту транзакцию но возможно ещё не успели накатить то ли накат через 2 секунды то ли через 2 недели как повезёт Ну вот это вот наверное значит самый важный момент с которым на практике придётся сталкиваться и может быть там делать выбор настраивать и так далее по-моему Все три варианта есть в масле Как ни странно с тем единствен исключением что синхронная репликация там есть не в традиционных значит привычных всем движках и так далее слышал я одну Легенду о ндб кластере пересказ то ли быль то ли сказка совершенно невозможно понять про ндб кластер всегда рассказывают легенды что там некая вот Адская значит машинка пришедшая к нам из телекома с чудовищным требованиями по доступности всё держит в памяти там доступность 17 девяток синхронная мультимастер репликация одна проблема живьём его никто не видел Ну то есть найти живьём человека кто как бы вот с этим ндб кластером летает это вот сложно Я тоже не из таких И я только знаю парня который знает парня которому который где-то слышал про человека который гоняет ндб кластер вот так вот не Ну технически наверно проще как бы я знаю парня который работает в myq Да даже не одного он наверняка знает который написано Не уда будем рассказывать про мение эзотерические движки привычные на в основном мам и так далее по-быстрому про остальные оси Какая значит ещё теоретически бывает репликация теоретически чисто теоретически как бы можно из Голи и вместо того чтобы работать со внутренними данными внутри базы на логическом уровне с не суть уже важно на СМИ данными то СМИ обрата рациями прямую как угодно но на логическом уровне можно как бы из Голи и суметь копировать базу На физическом уровне Ну в самом деле предположим что у вас есть значит мощный zfs который на уровне файловой системы размазывает все данные которые база успевает писать на диск на значит много-много серверов и хорошо справляется с этой задачей чисто теоретически вот вам репликация с тем только отличием от нормального человеческого случая которые хочется что она вам обеспечивает клёвый горячий бэкап распределённый на несколько серверов но не обеспечивает горячую реплику которую можно ещё и для чтения использовать Но вот как бы технически наверное можно и так я правда опять-таки не слышал чтобы как это сказать-то чтобы было сильно популярно вот на логическом уровне откровенно проще с одной Роны внутри базы реализовать там вообще смысла особого нет На физическом и сильно И даже не то что сильно проще а становится возможным делать Ну не просто капчик который куда-то туда отгружается а ещё и реплики из которых ещё и читать можно вот модели рассылки изменений Ну тут тоже как бы всё понятно кто кому звонит Ш - это если тат изменения сра это ЕС вво к задаче собственно обработке транзакций ещё и вынужден слей менедж вот теоретически где-то бывает пуш Но я честно говоря поскольку как бы помнил это в версии доклада 1.0 А с тех пор подновлённые метод под названием ш когда типа мне транзакцию впихнуть проблема Я короче сервер я занят Я хочу фыр-фыр-фыр а мне надо 30.000 транзакций в секунду Коть вот Ну и как бы есть ещё опять-таки важная дифференциация под названием ма ма традиционная встроенная в My репликация она как бы ма сй Если е то есть есть одна ведущая нода которая принимает все изменения все остальные ведомые реплики которые в принципе технически к несчастью Вы тоже можете рану в какое-нибудь изменение Ну то есть у вас стоит мастер с основной таблицей там и основным балансом пользователей условно говоря вашем маленьком почти пред банкротном банке У вас есть много реплик потому что как бы не клёво хранить Ну с точки зрения креативной бухгалтерии и потом как бы уклонение от уголовного преследования наверное наоборот клёво хранить всё на сервере который стоит в Газеле по Wi и Как только приходит следственный комитет Газель короче уезжает ты с ней сделаешь это частная собственность её досматривать нельзя Вот и вот с этой точки зрения клёво иметь один мастер А в других конечно более приличных случаях хочется иметь ещё несколько реплик вот Мар слей модель пожалуйста есть основная мастер копия есть несколько теоретически редон реплик которые только вытаскивают изменения с основной мастер копии а к несчастью к несчастью иногда в том числе в масле можно найти ведомые реплики ВС равно просунуть какое-то изменение Прямо туда Ну короче на Мастере у нас балансы меняются всё это доблестно разлетается Наре тут чпок и кто-то на одной реплике на одной конкретной берёт и что-то меняет Вот это может как бы привести к бедам о которых чуть позже и потом Ну ещё бывает как бы мастер мастер модель когда много серверов разом и они значит промеж себя этими изменениями обмениваются и пытаются удерживать консистентность данных в общем Ну понятное дело что в момент когда у вас есть мастер мастер репликация то всё значит начинается как это сказать начинается Поистине интересный креатив в самом деле вот у вас стоит один сервер условно говоря в Бангкоке и второй условно говоря в йоханнесбурге там свет-то долетает по прямой за вполне измери время А ворона вообще наверное никогда не долетит и соответственно транзакция которая прошла в Бангкоке как бы хорошо если она не трогает Никаких данных по сравнению с транзакцией которая в этот момент проходит в йоханесбург Но если они обе пытаются менять один и тот же баланс то начинается как это сказать-то начинается масса всяких интересных вещей А в какое время была зафиксирована транзакция здесь А в какое там а насколько расходятся часы А какие данные Они меняют А в каком порядке их следовало применять может возникнуть конфликт какой-то и автосистема может умудриться его автоматически разрешить может не смочь вот ну зато как бы есть в этом определённое счастье иногда подчеркиваю иногда оно помогает скели чтение а иногда нет Если у вас в конечном итоге Извините все ой чтение записи если у вас в конечном итоге все записи должны пролететь на один сервер Ну как вам поможет тот факт что у вас пять точек входа Они же всё равно сходятся в одной конкретной базе и её производительность будет Батл вот ну и для Крос дата центра Recovery помогает а читать понятное дело в любой схеме здесь можно с любой точки то есть есть Что у вас один Мастер и пять реплик что у вас шесть мастеров которые друг между промеж друга умудряются всяким меняться читать понятное дело Можно со всех точек Вот и ещ не знаю насколько это общепринятая наука насколько My specific штука важный момент который там на слайде про logical physical был упомянут про СБ R Mix и так далее А собственно изменени В каком формате передаём между нодами Ну как бы вариантов то немного если подумать можно передавать сами запросы исходные вот пользователь заслали либо можно вместо этого передавать измен и пое плохо подробности будут чуть позже можно смешивать смешивать по-моему вообще Хуже всего такое впечатление собственно ровно на полдороги удобный таймер к заголовочном слово вот термины ввели бывает так и как же Сделано в правильный ответ А хрен его знает товарищ во в зависимости от верси есть разные у сервера Ну то есть как бы там версия 56 она вот может полусинтетики этот комит не только прошёл А ещё и на реплике его хотя бы вычитали М что фито ту или иную в каждой конкретной версии может быть и сделали но при этом она не обязательно вовсе включена а если включена то может работать не так как вы ожидаете но собственно Посмотрим попробуем сделать заявленное чуток нырнуть вглубь То есть как устроено это всё на самом деле где-то там в глубине сибирских руд Ну хорошо асинхронная репликация там или синхронная значит Что значит Это буквально следующее мастер как бы Работает почти как обычно в добавок из-за репликации пишет специальный протокол под названием binary Log он же binlog который собственно будет потом рассылать по сетке вот тот момент что де сказать А что мы пишем в этот binlog то ли сами строчки то ли стейтмент это вот как раз про него про binary Log то есть дополнительная нагрузка на мастер из-за репликации как вещи в себе в принципе довольно невысокая Ну О'кей ведём дополнительный ложи н с Ну и по сет его рассылаем это тоже довольно не напряжно вот единственный момент как бы подлый связанны с архитектурой конкретно и который бьёт в спину заключается в том что нет же никакого маля на самом деле Вот это всё миф и иллюзия Ну то есть есть общий слой который оптимайз репликация и так далее и тому подобное есть физический уровень хране данных вот архите Она приводит к тому что есть запись в она пролетает в конкретный движок в конкретной если то как бы всё просто записали файл потеряли ништяк вот если вы на то как бы всё немного сложнее пишем в память пишем иногда сваливаем странички на диск все эти его знает то для целей репликации mysql должен вести свой собственный бело получается как бы который Но если неаккуратно настроить и мало железа может оказаться довольно нехило в самом деле то у нас база данных Ой не база данных а ST eng то у нас значит движок хранения собственно Ну делает работу хранит данные фиксирует транзакции и для этого вет свой протокол вот было бы кво если бы этот проко можно было использовать для репликации но нет нельзя как раз вот это расплата за то что в Можно втыкать другие сторонние движки получается что слишком много записей на каждую запись и вот появляется дополнительная увы и ах но на самом деле как бы дополнительная Линейная запись вло это как бы не так страшно особенно если вы её из ВХ Да вот на све ВС интереснее потому что сву недостаточно же просто файл прочитать ему ещ поработать надо для того чтобы своё состояние догнать до того которое собственно наблюдается на Мастере понятное дело он как бы может обрабатывать чтение для этого собственно и придуман к несчастью он может обрабатывать вставки тоже вот внутри для репликации основные знат два концепта здесь это который кат данные с мастера или разных мастеров кстати качает вот эти бинарные логи которые лежат на Мастере и складывает их локально вот буквально читает файл по сетке и и локально пишет копию этого файла там мог бы быть SCP или что угодно ещё на команда ЦП через NFS вот по факту оно реализовано ну парой тройкой S SQL каких-то ментов которые как бы с даёт на Мастере после этого ему в сот начинают литься бинарные данные которые он пишет на диск Ну тупо копирование файла по сетке Вот наверное поэтому значит проблема под названием у меня что-то вот там не то с копированием как бы там binlog с мастера не успевает вй Log локальный скопировать они возникают редко Ну как бы задача под названием прочитать файл по сетке она как бы несложно её уже лет 60 решают и научились решать значительно смешнее задача под названием прои вот нам прилетают какие-то изменения с мастера мы должны бы применять эти транзакции вот фарш начинается собственно здесь Ну и Понятное дело что надо отслеживать позиции везде то есть где мы сейчас стоим на Мастере куда мы сейчас записали всё это локально Да ну и вот тут не написано но локально оно называется собственно путь записи как оно работает в Прим как палка вот какой-то клиент писатель подцепил к серверу сунул запись транзакция зафиксировала запись условно говоря попала в таблицу после этого она доступна приложением читателям всё в момент когда появляется репликация путь значит может более быть из Вист оно не только попадает запись не только попадает изменённое в таблицу на Мастере она ещ попадает в binary Log на Мастере что как бы не очень напряжно после этого оно попадает что опять-таки не очень напряжно Ну тупо копирование файла после этого начинается собственно самый интересный момент с проигрывания вот основной тормоза Они здесь они в попадании из Лога в таблицу на сле Ну и отсюда оно уже и Сва доступно читателям вот здесь начинается Счастье то есть читатели могут обращаться не только к мастеру ещ и к свам на чтение уверенно раст хо Как плохо и как посмотреть зависит к несчастью к несчастью гибко настраивается Ну то есть как бы все любят системы где как бы есть одна кнопка сделать хорошо нажал её и тебе хорошо Вот Но к несчастью такие системы научились строить на улице Красных фонарей но не в it Поэтому в it Вот вечно какие-нибудь дуделки верте и настройки настрой какте самы формат про который я говорил sbr rbr mixed либо фиксируем сами запросы прямо в том виде в котором они прилетели от клиента а либо смотрим например что вот мы обновляем всю таблицу с пользователями а пользователей у нас в табличке 10 млн внезапно маленький запрос на 50 байт приводит к обновлению 10 млн строк и что нам значит обновлённые версии 10 млн изменённых строк писать в этот самый лог это вот как бы плохо в этом случае значит сильно эффективнее писать собственно само выражение наверное именно из-за этой логики в основной массе версии mysql оно фолти в statement bas репликацию Ну то есть просто В тупую реплицируемый сохраняет и реплицируемый хотя бы я не знаю стадию парсинга проходит там какое-то бинарное дерево пишет Ну не бинарное на самом деле какое-то дерево разобранное запрос там хоть как-то облегчает работу слев нихера прям как есть вот запрос прилетел в таком виде и будет записан как максимум кавычки вокруг названий таблиц поставят на всякий случай и всё то есть там Возможно не он пишется А С лёгкой трансформацией но по большому счёту как есть только возникает один неприятный момен с этой в ко некие не детерминированные функции которые даже на первый взгляд могут казаться детерминированные они на Мастере возникают что происходит когда мы реплицируемый которые как бы не логинится запрос может проиграть через 3 дня С одной стороны плюс на ней сипин мог случайно забыть как бы тайм зону перевести с другой стороны плюс на ней как бы общий дрифт часов мог как бы устроить расхождение Ну там е на несколько дней со стороны третьей то есть для краткости клёво записать в протокол вот этот запрос его проиграть на реплике на практике у вас обязательно Разойдутся данные вот внутри этого запроса просто вот обязательно даже если вы не заметите понятное дело что если гранулярность достаточно высокая Вам повезло значения на разошлись но это не привело к расхождению выбра во надоть собственно Изе рочки в запрос Вот и тут приходит Как бы идея-то хорошая но приходит пушной зверёк известный вот не тот который вы подумали Опа горностай значит времени синхронно расхождение и к несчастью ещ масса осложнений которые делают запрос не детер см будущем строчки писать как бы больно по той причине что много данных по сравнению с запросом но в некоторые моменты Ну блин необходимо и внезапно приходим к ситуации как бы вот как в том анекдоте Вот чувак а как ты со своей бородой Спишь Я теперь из-за тебя вообще спать не могу под одеяло её суну неудобно над одеяло её суну тоже неудобно statement based репликация Когда у нас собственно SQL запросы Ну как бы вроде хорошо но и плохо одновременно АБ как бы R репликация когда сами копии строк складываются в протокол тоже хорошо но плохо Вот есть ещё вариант под названием давайте как бы получим лучше из обоих миров и будем смешивать называется Mix Там как бы по умолчанию он фолти в тот же самый ement То есть как бы в протокол складируют натурально все запросы которые вы рали к базе данных ну за исключением Понятно селекто которые ничего не меняли но доку откровенно страшно читать то есть как бы чувствуется что там вот такой вот список условий что Невозможно его запомнить в принципе вот иногда оно само переключается на ration как оно работает как бы как оно теоретически работает Я знаю То есть вот Ну видно что оно теоретически должно работать хорошо типа по умолчанию логировать стейт минимизировать тем самым трафик между мастером и репликой но иногда переключаться на rase толь теоретически вс хорошо но на лёгкие подозрения наводит тот факт что Мик формат товарищи из mysql включили дефолт вот в небольшом окне версии что-то типа там с 511 51 28 а потом на всякий случай выключили И вернулись обратно к Stas репликации а потом вернулись опять к репликации в обм не могут никак Определи Собственно как посмотреть что там за данные тму Вдруг как когда-нибудь понадобится там довольно нехитрый бинарный формат который если хочется руками довольно просто разбирать Но слава Богу даже этого делать не надо есть утилита mysql binlog утилита mysql binlog в момент когда оно туда пишет сами SQL запросы Ну показывает прямо SQL запросы весь как бы фарш бинарный который кодирует вот эти все сервер ID позиции влоги и прочие интересные штуки а она форматирует в текстовые виды и показывает запрос без ключика мину V для репликации вам покажут Вот такой вот клёвый дам типа Спасибо что B 64 Спасибо что не Бинар в случае с ключиком мину V оно его немного разбирает и делает из него и делает вид что там как это сказать-то А ну и и имена колонок не восстанавливает Но вот показывает значение которое в этом бинарном дампе закодировано это вот для репликации для репликации повторюсь как бы всё просто у побо просто Лог смотрит значит Окей дальше-то что происходит внутри вот мы наверное поняли что происходит на Мастере когда мы включили репликацию у нас завёлся binary vog в него что-то началось писаться писаться ещё в разных форматах с разными проблемами и именно эти данные будут улетать на слей на реплики Что происходит на слей на све собственно начинается к несчастью всё самое интересное вот Ну да Ой есть с есть который качает binary L локаль пишет в после чего другой сред из этого свеже прочитанные данные проигрывает естественно на све другое имя файла другие позиции в этих самых логах по сравнению с логами и это к несчастью до определённого момента важно потому что видите ли вплоть до версии 55 включительно в масле Вот чувствуется здесь в этом такая Мотя ошибка молодости Все мы грешны я и сам таких Милн совершал но 55 включительно у тебя по большому счёту нету никакого механизма идентифицировать транзакцию которая где-то там случилась кроме как по барабанная дропь имени файла и позиции в этом файле вдумайтесь в эти простые но гениальные слова транзакция значит ваш баланс в банке решительно поменялся идентифицируется вплоть по версию 55 Вот буквально парой на Мастере лежит ф0 ВМ в позиции 57 э транзакция это единственный метод опознать её уникальность единственный был То есть если не дай Бог кто-то слил вместе файлы на сервере или переименовал или они вып и так далее То как бы всё пропало Шеф АС менты свай на колке вот много проблем ровно вот из говорят что когда Как не когда работает всё хорошо то есть проблема в том что когда ломается позиции слетают файлы переименовывают и про интересные вещи происходят вот этот вот механизм идентификации транзакций по имени файла на другом компьютере его нет локально уже нету его у нас локально на реплике йло бенга возможно вообще нет позиции тоже Простите на каждую транзакцию не Похра вот Ну вот как бы это одна большая беда вторая не то чтобы ошибка молодости а скорее как бы ну традиционно отле сначала сделали чтобы хоть как работа потом много лет делаем чтобы заработано фа с однопоточный в обоих местах понятное дело который тащит данные по сети он может очень много данных прокачать по сети тому примером ты Иди загрузи сервер см который статику раздают на 100% CPU удачи в бизнесе А вот тот факт что тред который проигрывает свеже сные транзакции однопоточный Вот это уже убийство как бы ровно изза этого возникает ционный лаг и прое неприятные эффекты Ну собственно Логично у вас мастер значит всей своей тридцати двух ядерной мощью и как бы доблестно умудряется использовать хотя бы 12 из этих тридцати двух ядерно полезную работу он доблестно комитет транзакции А после этого реплика их в один тред ля-ля-ля ля-ля-ля как в известном мультике он пока на четырёх ногах на своей лошади 1 2 3 4 А ты на двух разд раздва вот вплоть до 55 включительно слей раз-два раздва и производительности этого потока Может хватить может не хватить то есть вплоть по п мко слева невозможно нарастить добавлением ядер не успевал не будет успевать только гнать по чистоте и как бы азотную установку для охлаждения вот как бы это грустно эмоции вызывают Примерно вот такие Но к несчастью в тоже не дураки сидят просто тормоза и поэтому постепенно начинают насущные проблемы вот как бы менять в версии 56 значит наконец-то началась борьба с обоими дебильные проблемами сделали мощную фичу под названием Global ID глобальные идентификаторы транзакций которая ликвидирует беду под названием у меня значит всё что происходит на Мастере мы опознаёт имени файла и смещению в этом долбаного файле Не дай Бог что-то с файлами произойдёт Теперь значит к каждой транзакции всё-таки наконец-то добавляется некий уникальный номер и у слева появляется Ну во-первых у него конечно появляется целый новый ряд проблем под названием А вдруг на нём кто-то хера нул запись ошибочную а его запросили до мастера и тогда как бы по Тим Мы же поймём что эта запись должна немедленно разлетаться на все остальные сервера Ну то есть ты на сле Значит убил какую-нибудь табличку как бы ну случайно чисто не нужна была вот и на этом конкретном све оно по про канало потом сле зали для мастера до мастера в этот момент внезапно транзакция прои на всех остальных нода в кластера будет счастье Вот Но тем не менее как бы в целом фича а приятная и полезная по сравнению с потому что как бы Когда сервер может автоматически идентифицировать транзакции по некому уникальному номеру и тебе не надо значит вот так с лупой смотреть на бинарный этот Лог и вычислять Какая позиция в relay логе локальном соответствует какой позиции в исходном Бари логи которые уже стёрли это вот как бы приятно когда этим может заниматься автоматика а она может это вот хорошо кроме того сделали в кавычках многопоточные свы в 565 Ну то есть если вы ль ваши изменения которые льются в одну в терминах по-моему всех остальных баз данных схему так называемую в масх соответственно то как бы кеда Новый Год ничему не поможет Но если у вас несколько разных и между ними вроде как не связаные транзакции томет наливать в неско потоков условно говоря оно не поможет никак только поможет тиды ы понятное дело по-моему немного сажают производительность Но зато потом сильно экономят количество седых волос при восстановления при сбоях значит 57 по-моему вообще как бы в бете многолетней вроде бы ещё не по меньшей мере сегодня в 3 утра не был 5 функциональность под названием Group comit в binlog которая как бы не совсем связана с но собственно позволяет делать Поясни много поточну репликацию в чём счастье а раньше Значит до группового коммита до того как его заставили опять работать транзакции в белок писались Ну блин по одной и после там записал одну делай в Син записал одну делай в Син это собственно с точки зрения общей производительности нехорошо клёво А распознавать транзакции которые в принципе независимые трогают разные данные и влога их флашинг по объёму то их столько же но системных вызовов меньше там райтов инков меньше Вот это binlog ГП комит в принципе приделали обратно ещё в 56 но начиная с 572 вдобавок приделали поддержку этого дела для того чтобы делать тру цию на слева как обычно оно выключено по умолчанию иды выключены И значит вот эти Новые достижения они тоже выключены их надо как бы рукой подпи и включать для того чтобы счастье наступило вам недостаточно прогреться на новую версию вам надо ещё всяк пона включать Вот ещё вдобавок в версии 577 сделали с моей точки зрения странные изменение которое Мне аж интересно стало последовать Но вот пока не успел переключили формат дефолтный формат бинарного Лога 100 лет блин с версией 4.1 жили со statement based репликации оп переключились на Ras репликацию при этом то есть сменили defog формат есть настрое там что писать в bog то ли строчки то ли стейт то ли что но при этом не сменили дел bog R Image это вот Вызывает неподдельный интерес потому что Волшебная настройка binlog Row Image означает вот что в момент когда мы пишем какое-то изменение в это самы У нас есть как бы несколько вариантов что туда Дописать Вот первая идея которая мне приходит в голову - это как бы ну короче у нас записи номер 1 23 Короче ей ставят значение там 4 5 6 в такую-то колонку Ну давайте собственно это и запишем и D1 2 3 новое значение 4 5 6 если подумать Ещё немного для полной паранойи на всякий случай можно записать не только новое значение 456 А ещё и предыдущее значение 455 например чтобы в случае если у нас что-то всё-таки сломалась и транзакции пошли не в том порядке мы могли понять что транзакцию которую мы собираемся накатывать она внезапно пытается изменять другие данные вот наверное Ну не знаю может быть из соображений максимальной паранойи и хер сне с производительностью mysql дефолте в режим Когда в логе хранится не просто изменённые хранятся не просто изменённые данные и идентификатор записи А полная копия всей строчки до изменения и полная копия всей строчки после изменения то есть Это прикольно конечно когда у вас таблица из двух колонок Но когда у вас 3к байна в среднем строчечку А вы в ней меняете Одно маленькое поле это означает что в binlog пишется правильно все 6 КБ из них поменялось Ну соответственно вот те четыре байта которые вы поменяли в числовой колонке А это настраивается слава богу есть чка binlog Row Image которая как бы дется в Full но которую можно перемкнуть в No blop хотя бы либо в Minimal Вот но почему-то оно вот фолти именно в ну как как обычно как бы всё плохо но не плохо плохо плохо Я уверен что есть значит какие-то причины для того чтобы делать именно так но вот как бы мне они неизвестны Но вот надо понимать что вот значит интересный момент в 567 произошёл вот апгрейдить на 577 если у вас явно в конфиге не прописано внезапно формат бенга меняется дефолт сменился при этом сменился На мой взгляд странно но и не знаю не знаю как бы всей полной мотивации которая стоит за этим изменением В общем и целом конечно ситуация с версиями мышками и так далее Она вызывает у сисадмина наверно вот такую вот примерно реакцию каждый день что-то интересное происходит не всегда хорошее но тем не менее жить с этим можно всё равно значит и того итоги развива делают новые клёвые фичи которые бы закрывают старые головные боли 57 с введением Ну ой групповых групповых коммитов и как следствие возможностью многопоточная вообще закры тем самым закрывает старый головняк под названием у нас слев не успевает утни сза старую операционную беду под названием Ну как бы прикольно идентифицировать транзакцию По имени файла где-то там далеко за горизонтом но не прикольно потом разбирать сломанный инс Вот то есть как бы 57 с Тида и групповыми комита и как следственно как следствие многопоточные многопоточный проигрывания изменений на слей прям по это по методичке Если судить то совсем хорошо но понятное дело не в тот момент когда ты Facebook и полгода просто Но даже в тот момент когда ты Феу и полгода выкатывает в конце концов когда вот всё выкатил всё равно пишешь в блоге что да было сложно но в итоге как бы хорошо всё-таки Оно того стоило если 5-7 очков ставить и всякие значит многопоточные штуки включать очко то Ну хотя бы 56 плюс плюс глобальны ID хотя бы так хорошо но традиционно как это традиционно значит принято в My вызывает изумление дефолты дефолты вся новое полезное делают Ну понятно это дело отключено но местами когда эти дефолты меняются они тоже меняются как-то странно вон переключились на репликацию по умолчанию гиру полную строчку Что в моём понимании В общем случае ы холокост и непонятно Стоит ли как бы Профит в оном проценте случаев деградации в 99 Так что с дефолта надо Зорка Ози Ози с одной стороны исто так новый функционал заработать Стороны также немаловажная деталь там где я пишу 57 на самом деле надо иметь в виду 572 или 577 или 5712 где наконец починили стоппер баг или что-то типа того то есть версий 57 56 и так далее недостаточно ещё минорные версии важны вот там где-то было значит вон в 572 добавили Вот это в 577 сделали вот это То есть даже минорная версия может интересно подзь ну собственно вот и всё как бы терминологический словарь рассказали в принципе как оно на базовом уровне устроено в My squl попробовали посмотреть мастер бинарный Лок relay Log проблема с проигрывания в один поток которую чинят в 57 вводя групповой комит и проигрывание Во много потоков А в принципе я считаю всё не так сложно как бы но тем не менее для того чтобы это внятно эксплуатировать и чуть Лучше понимать где у тебя беда надо представлять себе ряд ключевых слов которые вот мы сегодня попробовали себе представить Теперь значит вторая половина доклада на которую У меня нет времени вот поэтому Т предвкушая это дело я сделал вот четыре слайда с надписью вопроса с одной стороны и как бы ряд стандартных проблем Читать вслух не буду Давай время пошло я значит читаю Всё я прочитал я читаю быстро вот как бы есть ряд стандартных проблем и в принципе понятно как ихл пер быть понятно как их чинить в фокусов с репликации там несколько мастеров в цепочку завязать сделать сильно покре атика немножко потра сформировать данные в ходе репликации вот ну и что-то ещё есть у меня ещё какой-то слайд Прям вообще слайд убийца я пытаюсь вспомнить Какой это сильно медленнее чем просто нажать кнопку Но мне интересно А я вспомнил там мас других ключевых слов ТС у мелье количество хло счёт которых можно дальше читать по репликацию вот это вот небольшая часть вот собственно теперь совсем всё и А те самые вопросы на которые нет времени Давайте один самый главный вопрос 42 я услышал если они говорят но ничего больше А кто все боятся Ну хорошо а не не не все г вот то главное как бы обвинить людей вот как только всё-таки микст страшно или нет Вот откровенно не знаю значит как бы книжечка выглядит вот так но Повторюсь меня несколько пугает практика что Вот его включали на некоторое не длинное время вот я пытался значит личного операционного опыта не имею а я пытался найти какие-нибудь значит горести и бложик в интернетах про микст формат но не смог Ну то есть никакой внятной информации про то что микст не трогать трёх футового стороны информация о том что микст как бы божественное решение совершенно непонятно почему не дефолт Я тоже не нашёл какая-то вот такая лёгкая серая зона но всё равно же надо как-то решать то есть там плохо и там плохо Ну какой выбор-то Не ну традиционно как бы все решают локально да то есть как бы втыкаешь у себя там две реплики там или две копии в таком и таком формате потом делаешь локальный Вывод что микст например Не надо трогать дефу палкой и никому ничего не рассказываешь об этом вот я если бы знал я бы рассказал но я у вы не знаю Вот спасибо за доклад Вот вы слайд показывали рассинхронизация Когда у вас используется время в запросе А почему просто такие функции не ситуация более сложная и запрос может зависеть не только от чего-то что подставляется легко в момент начала исполнения запроса то есть Да действительно в этом конкретном случае можно пропатчить запрос в общем случае там фарш с удф ками триггерами юи дами и прочим В общем случае задача нерешаемые не все запросы можно так трансформировать А можно немножко подробнее про мультитоп вот 56 было сказано 562 там что она мультипочта Base А f57 дальше там версия Она вроде как уже Т мульти точная Да в 57 в 56 только несколько один поток может обрабатывать одну базу данных если у тебя изменения в одной таблице и одной базе данных то как бы кеды А в 57 мастер причём что интересно начиная ещё с 56 мастер немножечко детективи Симо транзакций функциональность группового комита она в том числе про это и в этот момент когда у тебя в этих группах достаточно транзакций в бинарном логе в этот момент ну включать с parallel workers оно как бы помогает слей накатывать транзакции в несколько потоков тоже спасибо Андрей Спасибо за доклад давно пора выгонять Я знаю да Я сразу предупреждаю всегда что не уложу в смешной бюджет 40 минут все вопросы как бы где-нибудь там вон сразу около дверей и будем так громко трындеть что будем мешать следующему докладчику докладчик выходи Всем спасибо"
}