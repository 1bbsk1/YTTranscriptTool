{
  "video_id": "vKtNwALHb2k",
  "channel": "HighLoadChannel",
  "title": "AddressSanitizer, или как сделать программы на CС++ надежнее и безопаснее / Константин Серебряный",
  "views": 747,
  "duration": 2388,
  "published": "2017-04-25T16:38:35-07:00",
  "text": "вот уж повезло так повезло уникальная вещь в докладе пойдёт речь о новом инструменте для обнаружения ошибок использования памяти адрес сани тайзер инструмент который находит ошибки использования памяти им пользуется как google для тестирования серверных и клиентских программ так и open source разработчики константин серебряный расскажет что из себя представляет этот инструмент константин серебряный на сцене вообще подход к важно для специалистов область такого средними скоро программы на си плюс плюс сегодня будем инструменте который помогает искать ошибки в этом тяжелым языке короче я расскажу вообще по ошибке на что повторить в этих языках потом про инструмент который мы разработали в московском офисе google давайте начнем с того что я объясню зачем собственно си плюс плюс и почему кому-то интересен поскольку большинство здесь программирует на си плюс плюс что-то для расстрельная все-таки 2 всё написано на си плюс плюс или носи даже если вы об этом не знаете например если вы программируете на джами первые питание все равно там все + + алексей где-то спрятан внутри дживон написано на си плюс плюс и питоновский по-русски интерпретатор носи написаны так далее система баз данных написаны носили на си плюс плюс и вот мой сквозь например веб-серверу этот жар патчи и на самом деле вообще все остальное всё написано на сие на си плюс плюс поэтому это важно немножко про то как на в google используем си плюс плюс вообще наш google и больше ста миллионов строк кода программ но и си плюс плюс наиболее рыжик то есть это реально очень много кода на си плюс плюс а любовь чистого сие написано большая часть серверных приложений я какие-то слова или чисел которые известны публичным а придешь бы кто-нибудь спамер chubby но на самом деле это верхушка айсберга новое приложение которых никто никогда не публиковал chrome написано практически исключительно на си плюс плюс это больше то миллиона строк кода примерно половина этого кода написано в гугле вторая половина это какие-то проекты которые были написаны вне куб прервет китай системы в друге все это все плюс принципе позволяет касается очень эффективный код многие называется плюс плюс современным оценкам это недалеко от истины потому что в во многих случаях программе на си плюс плюс и не будет уступать эффективности программе на тумблер только описать проще одна из крупных преимуществ все плюсы от ручное управление памяти вы сколько хотите выделяете когда хотите память удаляете обращайтесь ко мне прямую без всяких там банки кингом jovi и так далее это очень сильно экономит ресурсы но вот у хорошей стороны есть и плохая сторона а именно ручного использование памяти по улице и ошибки использования памяти которые не характерны для никаких других языков практически распространенные тяжелые отладки это переполнение буфера использование памяти после удаления я могу долго рассказывать почему это плохо и каким проблемам стабильности это проводит но кроме проблем стабильности это привлечет проблемах безопасности практически любой из таких ошибок это открытые ворота для хакеров будто клиентское приложение или серверное приложение не важно это очень большой security только что же делать уже наверное лет двадцать назад были созданы инструмента которые помогали ловить те или иные ошибки использование памяти все все плюс плюсе на сегодняшний момент народ самый популярный valgrind поднимите руки кто использовал гринт а те кто не использовать не знает ну тоже неплохо на рынке сейчас имеется ну покрайней мере дюжина хороших инструментов google еще используем доктор на море также есть and all the rose studio перформанса керн сурков плюс и много других колоссальные проблемы всех этих инструментов эта скорость они очень медленные на страничке документацию в органы забьется или 20-кратное замедление системой мы программы мы наблюдали 200 кратное замедление в общем как повезет и большинство из этих инструментов тестируют только ошибки работы с динамической памятью то есть выход за границу с такого массивного ли глобального массива практически никто из них не находят 2 класс ошибок и 2 класс инструментов которые народ ошибки так называемой отладочной молоке я не делится тоже на два класса что интересно произошло диск ручку отладочные молоке бывают такие которые используют постраничную защиту встроенный в процессор то есть мы можем на каждую на каждые 4 килобайта памяти сказать это памяти хорошего можно трогать нельзя зато когда память удаляется удаленную память маркируется как плохая и некоторое время пребывают в карантине эти инструменты хороши тем что они отдали много ошибок в динамической памятью но они безумно медленно и потому что на каждом alac требуется системный вызов и на каждой free тоже отладочных молоков используют так называемую магические значения то есть он в память там или по границе или левша на память пишут какие-то чисел ки и если по себе какого-то времени он уже нечего течи силки значит кто-то туда записал эти молоке совсем быстро но они ловят очень маленький класс ошибок по нашей статистике меньше десяти процентов всех ошибок таким образом отлавливается стандартный блок в гбц и он принадлежит к этому классу но много нам не поймает данный инструмент а вот только ошибки с динамической памяти последующие слои будут про инструмент который заработали мой инструмент называется адрес и не тайзер как по-русски не знаю если предложите хороший перевод буду благодарен и устроен статус частей это инструменте ru ющий компиляторы библиотека назад мы единство года и полгода назад мои 20 года инструмент вышел вместе с очередным релизом пакета так еще раз давайте культура займемся поднимите руки кто значит такой а те пользоваться нашим инструментом очень просто должны скомпилировать вашу программу с одним-единственным дополнительным крючком комплект немножко лирическое отступление про этот самый компилятор который не который называет clang некоторые называют силы анк и так или иначе эта часть проекта что это такое вот с высокой точке кто такой высоты птичьего полета это компилятор для си си плюс плюс посмотреть это набор независимых модулей которые позволяют вам исследовать программа на си плюс плюс и делать статический анализ отдалась такую диагностику хитрые оптимизировать программы на си плюс плюс и на любом другом языке код для большинства популярных про платформ x86 и безусловно лучше поддерживают все другие с недавних пор это является основным компилятор на платформах форматы mac os и ios так что в общем можете оценить что достаточно развитой системы активно использую google и по нашим данным он сопоставим с же сиси по производительности чуть-чуть иногда отстает на призываю воспользоваться этим компилятором себя итак вернемся к нашему инструменту что же он позволяет делать он позволяет находить выполнение буфера вашей программе причем буфер могут быть динамически из такого и глобальным также находить использование удаленной памяти о самых интересных и до ошибок он еще находит кучу других типа 1 free или причине параметров менку под ним к пину это скучно самое главное про наш инструмент он очень быстрый среднего значение замедление которое мы наблюдаем большого набор программ это примерно два раза иногда в редких случаях когда у нас какого-то колоссального размера бинарник мы бывают видим три или три с половиной раза в основном просто убиваются и каш инструкции на процессы всех газированных приложения глаза это обычно замедление на клиентских приложениях отличать серверных мы вообще не видим никакого замедления в качестве примера бензин chrome или браузер firefox но давайте еще раз руки поднимите кто мне верит что храм не замедляется отлично сейчас я поправлял доказать это я уйду со сцены на некоторое время отсюда меня слышно одна вещь и так как вы можете увидеть браузер почти обычный но не совсем этот браузер собран при помощи адреса нет озера затаился где-то неделю или двухнедельной давности давайте что-нибудь откроем вот это lenta.ru это халат погрузиться в розницу все нормально теперь давайте откроем что-нибудь нас тут вовек не найду это припасенный фармак паники он не покажу потому что он содержит живой explode для хрома то есть дырка мы сейчас его открою и вот такая вот картинка не пугайтесь это так предлагается теперь я покажу конца которую мне на другом экране было здесь сообщение об ошибке то есть как мы могли убедиться браузер работает работает быстро и ловит ошибки если они там есть теперь давайте попробуем вернуться в презентацию кстати обратите внимание умер но ваш браузер остался жив самое главное что эти 8 пользователей я уже сказал теперь нужно каким-нибудь пример и показать вот это пример кода что штук ну давай попробуем так это пример кода в котором есть выполнение глобальных буфером тут в коде всего три строчки значит этот код запускается ключиком отключка мой фокус и не таймер запускаем и на выходе на стадо верный видим вот такую вот картинку инструментом говорит тип ошибки габибов river flow он нам говорит что это было чтения размера 4 он печатает полностью структурой с строчками кода именами файлов что ты мне нравится с этим крекерам итак во всех сколько будет направлена нового голубого мы прочитали следующий пример про stack overflow здесь информация немножко другое мы можем рассказать что за столько выносим здесь присутствует из какой фрейман пришел значит здесь не побитым функции имеем и промахнулись мимо него еще один пример пропущу и самый любимый нашими пользователями примеру the heat of use of the free то есть мы используем удаленную память мы сначала цели память потом дело целовали а потом решили немножко пощупать так нельзя соответственно инструмент здесь водород очень много разной информации он говорит где мы тронули памяти где она была до этого удалена и где dota она была lacie рано я сейчас буду рассказывать как всё это работает она может показаться кому-то скучным и неинтересным папе я предлагаю отвлечься и задать мне вопрос а потому что она делает если есть вопросы у меня на самом деле достаточно простой вопрос вот firefox вы тоже тестировали адрес они-то и замечательно fox будешь firefox к нам приходили несколько раз у них что-то не работала мы помогли решить их проблемы иногда это было проблем иногда наши проблемы и с тех пор не просто время от времени узнаем что они что-то новенькое нашли в общем нам нужно от идеальная схема работает производителя по то есть нас и клиента то есть firefox когда у них все работает спасибо вот у меня вопрос такой вы показывали как алмазы не замедляется с помощью этой утилиты когда она используется но отсутствие замедление это визуальная только или вы программно тестировали что замедление нету тактически и конечно это визуальная конечно инструмент кушают аципол намного больше чем у обычного ходьба на обычных раем кушают я не знаю 10 процентов у меня довольно мощный ноутбук должен признаться на поминки храм кушают скажем 5 или 10 процентов типу инструменти рованный кушает может быть 30 но визуально за них измерение про то не видно серьезное предложение которого кушают что процентов цепов они конечно замедляют существенно вдвое когда больше нас повреждение куча ловит ну и то есть эти баги есть повреждения куча повреждения куча это как как правило либо фер авророй то есть запись заграница буфера или запись выдавленный буфер это не лают а если ты там уже успела сна лоцируется что то есть ли мы записали в буфер который был удалён но это но эта память была снова провоцировала мы ничего не ловим но специально для этого которой который мы с вами специально написали существует карантин то есть память которая выделена она некоторое время пребывает в карантине таким образом что никто ее не можешь заново за лоцировать карантин не по времени а по объему памяти то есть до тех пор пока в карантине не больше чем он мегабайт памяти мы оттуда не забираем память еще и если попадет на там границ каких-то структуру ну служебных в куче поймает конечно и скажет откуда конечно ну круто фокус том что у нас на катер свой собственный поэтому знаем где у нас сидят служебной структуры в кучи и мы конечно защищаем и возможно на этот вопрос будет от вот в следующем слайде дайте последний вопрос и пойдем дальше но последних дополнительно расход по памяти примерно в два в три раза вы сильно зависит от аппликации приложения последний вопрос пока не такой вопрос о выделении освобождение памяти выделения того же участка памяти но сохранились ссылку мы думаем что возвращаем star object такой уловит нет ну а частично ответил на вопрос раньше у нас карантин то есть мы можем огнем старую память второй раз быстро мы в какое-то время поддерживаем но там же существует реальный объект как бы он уже заполнен там конструктором или неважно то есть память выделено по другой объект она нормально проинициализирована вы все держите в карантине для так в карантин попадает освобожденной памяти вот мы освободили память понятно давайте пойдем дальше по уже алгоритму как это работает и может быть что-то понять не станет это ключевое понятие в этой всей технологии это теневая память или теневых байты английский shadow blade давайте возьмём любые 8 боится в нашем приложении или где-нибудь рядом вообще вот в виртуальном адресном пространстве вашего приложения любые 8 выровненных байт на самом деле состояние этих восьми байт всего 9 состояние по отношению к адресу и мостили хорошести 1 аль-байт хорошие их можно читать их можно писать и последние восемь минус n bass плохих в них нельзя ни читать ни писать вот такие погибают и называем отравлены поскольку устаревшего 9 мы эти девять состоянии можем закодировать в одном байте и такой байт назвать shadow вот я уже поверну каско боюсь пользуется здесь восемь примеров разных 8 эбонитовых слов значит зеленые это все будет хорошо а красная это все это плохие о смысле зеленые это хороший будет красный это плохой байт если все мы это хорошо это целевое теневой бойцами значения 0 если все это плохие то чего значение имеет тебе значение -1 если чуть-чуть бы это в хороших и остальные плохие то мы сохраняем то число сколько хороших байтов следующая как мы находим по 8 поэтому словом вашей программе нужно теневое значение просто мы берем адрес памяти и гели биона 8 делить на 8 это очень дешево это одна инструкция сдвиг на три что собственного ждать происходит от на картинке изображена виртуальное адресное пространство в 32-битном линуксе она начинается с 0 заканчивается 2 32 минус единицу верхней семь восьмых виртуального адресного пространства принадлежат вашей программе программа делают там что хочет нижняя 1 раз мушка принадлежит нашему инструменту и программу туда не ходит 1 8 1 8 полностью закрыта самой нижней м protect то есть туда не ходи ничто не псай а вот среднюю часть которого такая светло-синие это там хранятся теневые байт и соответственно чтобы по имеющемуся у нас любому слову получить один синевой быть мы просто делим также памяти на 8 получается на 30 него байта иногда чуть-чуть сложнее нам нужна тень передвинуть чуть повыше потому что по умолчанию в линуксе винду see no make программа программа грузиться в самый низ на сложность увеличивается на одну инструкцию нам надо прибавить одну констант очку с нашим кодом вот был у нас какой-нибудь доступ в память все запись или чтения для начала давайте посмотрим случае 8 байт на и запись или чтения мы вычислим обретение это сдвиг на я про плюс константный офсет который иногда 0 дальше мы читаем этот самый байт если мы почти что то что они нам мы про партийном ошибки как другой вопрос мы можем просто трахнуться можем вызвать функцию и больше следует оригинальный доступ в памяти если у нас доступ память меньше чем восемь байт а instrumentation получает лишних 4 инструкция помимо того что мы должны проверить и него болтуном мы должны еще проверить какой конкретно не 0 он там сидит но добавляет чуть-чуть арифметики немножко самбуру для желающих значит здесь мы видим оригинальный доступ в память о последней мы записываем что твердой и лишних инструкций нас получилось шесть из них одна генерирует трек то есть никогда не выполняются и 5 реально выполняются каждый раз мы же говорим а 3 прибавляем константу какую-то ерунду потом сравниваем с нулем и и все да и прыгаем если но если там не 0 это уже в снг 1 x 8 64 чтобы нам найти проходит нам где-то нужно отметить что он плохой мы называем отравить рассмотрим пример со строковыми переменными вот у нас есть функция в ней есть такой массив такого-то размера мы должны окружить этот старый массив другим массив чеками которым раджо нами арджуна нас в уровне на матрице да значит на слова должны быть разумно и справа должна быть рациона мы добиваем до выравнивание на 32 после этого не вычисляем теневой адрес этих самых рацион и пишем те для рацион какую-то каку данном случае просто все минус единицы и для одно из них более сложное значение все значит тремя время инструкциями записи мы отравили рационы для с такой переменной дальше выполнили код нашей процедуры и когда - процедуру находим тот самый инструкцию торт мы пишем тени таким образом говори все как памяти нам хорошие очень похожим образом мы работаем с глаголами единственно что если стек мы должны отправлять каждый раз при заходе функцию the global и мы отравляем один раз при старте программы если у нас была глобальная переменная типа int и то мы уже меняем структурой в которой сидят int а потом рациона при два байта плюс уравнивания кроме компиляторы какие говорили нашей страны библиотека она занимается несколькими вещами 2 чертят инициализации теневой памяти при стартапе просто вещи несколько несколько вызовов эмма pmp такт наш работе к полностью заменяют системные молоко фри и наш молоко free занимается тремя основными вещами он отправляет области памяти вокруг память вокруг пределах выделенных малак то есть если пользователь запросил 10 байт выделяются 64 и по краешком память отравляется кроме того как я уже отвечал на вопрос здесь память подобное функции на некоторое помещаются в карантин таким образом что сразу они обратно молока не будь то женщина и и каждому злыми лаков и мы сохраняем stack trace чтобы потом вывести его пользователю кроме этого мы вынуждены перехватывать некоторые функции lipsy самые существа ненный типами msi поставлен делается для того чтобы мы могли найти баги которые то есть доступ и в память сделаны этими функциями поскольку мы не инструментарий липцы от ему нужны перехватывают не были устранены funk функции микрометра библиотека занимается выводом сообщений об ошибках немножко трофеях такой рекламных слайд на один из наших ключевых клиентов это безусловно браузер chrome включая вебке системы рендеринга и за 10 месяцев наши клиенты из chrome и нашли порядка 300 ошибок но был распространен но это использование после free потом идет все все варианты переполнения буфера динамической памяти наиболее популярны должен заметить что ошибки кроме находят не только разработчики храмов не только сотрудники google есть довольно большое количество сторонних разработчиков исследователей которые занимаются этим не для чистого удовольствия потому что google и платят неплохие деньги по моей статистике будут заплатил больше ста тысяч долларов внешним исследователям за баги найдены образцы не тайлером в хроме данная статистика по 1 для снять потом мы перестали читать я уже больше 50 багов магазин frame подчиненные выключение вот и которые покажу мы нашли сотни ошибок серверных приложений в серверных приложений google и наверное даже больше чем chrome мы имеется ввиду от меня лично наши пользователи часто даже мы об этом не знаем и огромное количество open source ных проектов нами пользуются или мы предлагаем им иногда пользуется firefox пожалуй наиболее активный пользователь который сам по себе пришел и не уходит for type of young другие товарищи мы немножко помогли разогнаться нашли у них там 1 пары сотни ошибок у каждого 1 видим самого винджа сиси вот пару недель назад мы взяли за моим сколь тоже нашли pompa ток господи есть поднимите руки кто в своей карьере си си плюс плюс не видел баги типа buffer overflow или держав цифре инструмент не идеален для меня есть что улучшить он конечно очень быстро но иногда даже 2-кратное замедление это дорого мы хотим применять статический анализ чтобы делать меньше проверок чтобы чтобы код был меньше выполнился быстрее как я уже сказал монстра монтируем только то что компилируем а следовательно библиотеки которые приходят системы и скажем лице или x11 селенга тыкаем что угодно мне инструменте roach хотим имени инструменте вставки на самом деле они есть в программе мы тоже хотим в общем более-менее знаем как но пока не сделали мы хотим адаптировать эту систему для вибро для linux там свои фокусы не знаю когда мы это сделаем и наши такого наиболее остро желания на данный момент от портировать систему на windows на windows ну пока работаем только для чистого си си плюс плюс ему нас проблемы причем это проблема клайн ага собственно говоря не ношу инструменты короче что же мы про что же я сегодня рассказал инструмента адреса не так давно ходит очень много ошибок в коде на си плюс плюс и я вам всем рекомендуем пользоваться он очень быстро что позволяет его использовать протестируем не очень дешево очень густо эффективно и с небольшой осторожности используйте в боевом режиме мы это делаем the browser который у меня на ноутбуке я использую каждый день на десктопе как основной браузер работает и все разных приложениях мы тоже в некоторых осторожен опускаем часть трафика на инструменте равный код сегодня наш инструмент работают на linux mac os android ну и на самом деле хрома и что же мы планируем рано или поздно портировать у на windows и на ios когда произойдет не знаем адрес частью пакета open source пожалуйста берите пользуйтесь мы будем рады и еще у нас есть два инструмента про которых я расскажу все не собираете но не упомянуть не могу инструмент даниила все сани тайлера ничего все все что-то пшеницы sanitizer уют на что один инструмент ассоциация не тайзер мы над ним работаем и очень давно больше четырех лет но полгода назад мы выпустили новую версию которую мог быстрее что собственным делать он находит гонки или байт rss если вас многопоточный код если вы не очень уверены в его кратности даже если очень уверены то камин дую в отличие от других наших инструментов я тут поддерживает не только си плюс плюс на язык гапр который дмитрий мой коллега рассказывал вчера в том зале треть инструмент он так она хочет только в разработке он находит использовании неинициализированных переменных это касается только си плюс плюс по новации мне пока не предлагаю но если вас интересуют следить и я думаю что через 3 5 месяцев мы его выпустим мне очень много еще рассказать но я с удовольствием отвечу на вопросы сначала ну слушай а замечательно насколько я понял вы защищаете границы объектов то есть в принципе если у меня есть матрица и я промахиваюсь не с крайним элементом а со строкой то я промахиваюсь наш инструмент защищает только границы локации динамической листа cavalli глобальный поэтому если вы промахиваетесь внутри своего собственного объекта то инструментом особо не поможет но если вы подразумеваете какую-то похожую ошибку вы можете в свой объект царь и внедрить дырку ну вот эту зону вызвать эту функцию наши инструменты которые скажут что это дурка и тогда мы будем ловить ваши другие специальные но вот насколько я понял в теневых байтах вы используете не все значения вы используете но скажем палубой до для сигнализации что вот здесь вот что то есть то есть дополнительную информацию может сохранить можно например за защищать заполнять границы объектов разными масками и ловить еще и такие ошибки на мы вне сами границы за больными мы заполняем тем кроме только тише пара скажете о thalasso размеры от зоны 64 байт он там плюс минус сколько-то выходит с выравниванием а что если доступ был такой что перепрыгнул через ряд зону спасибо за вопросы по ним не повезло иногда не повезло на самом деле для как часто такое бывает то есть скажет никакой статистики на самом деле для учит для динамической памяти у нас значение по умолчанию 128 то есть рациона у нас 128 мбайт плюс уравнивание для глобал авто для стока 32 для глаголов на самом деле нет никакой причины сделать у меня больше что происходит если мы промахиваемся если мы промахиваемся к мы попадаем и на следующий выделенный объект тогда не повезло мы не нашли эту ошибку помчимся настолько сильно что может попасть и нибудь другую рад зону и тогда мы находим ошибку но мы неплохо рапортует то есть у нас есть актрис отдельно что произошло и неправильный статус где это было выделено насколько часто встречаются он мало по нашей статистике которые мы собрали на хроме на кроме значит что у нас большая часть так просто use of the free и там неважно мы попадаем сам объект или куда-то на брать зону мы подолгу удаленный объект для которых кроме там было порядка сотни наверное штук 90 промахивается в 1 8 байт то есть они попадают почему а дальше паба па паба вообще экспоненциально я помню только в случае когда выход за границы будет между 64 и 128 байтами но бывают какие-то выходы еще больше их не видели скажите пожалуйста если вы говорите что можно через api а и внедрять дырки в собственной структура данных это значит что эти дырки должны быть выровнены на границу там 32 гбайт ну правая сторона дырки имею так 8 8 8 по умолчанию мы можем сделать более сурово ограничения до 128 байт требования к уравниванию тогда тень будет более компактная но холодно что матирующий будет немножко по дороже по умолчанию восемь байт выравниванием требуем вопрос по полным именем и чтения конечно отлавливает безусловно то есть вы в номере protect dect используйте нет вот в том-то и фокус что мы работаем намного эффективнее чем продукт потому что мы работаем на мозга влажность 1 байт они 1 страница мы каждый байт мы каждым восемь байт отправляем 1 байт нам значение но это одна банка и значение кодируют от каждого из из восьми байт в этом слове и нам всем чтение или запись и это одинаково но от момент обращения то есть про проверяется проверка идет момент обращения к памяти непосредственно повод и вот уже по три литра до обставляет только на силенка пока только сила нг у нас есть прототип который работал с джесси и сейчас мои коллеги его пытаются засунуть джесси шный транг но он еще полу рабочий я думаю что через полгода можно ожидать же session версию вопрос просраться нет азербайджанцами . очень похоже идея промахнулся мы установим instrumentation входу нас системная библиотека разница здесь в том что instrumentation у вас очень простая мы перед каждым доступ оставить что нам вызов как нашей библиотеке а дальше уже делает какой-то черной магии но она тоже использует теневой память к сожалению чери тиго я память если в адрес и не та земля на восемь к одному компактная то в торце нет на земле надо один к четырем то есть она раздувают память программы там в петрос но в остальном очень и очень похожие день и треть инструмента же также вот это что ж если нет больше вопросов спасибо за внимание я здесь не сразу бегаю если что можете мне поймать спасибо"
}