{
  "video_id": "P23gy-0JNgA",
  "channel": "HighLoadChannel",
  "title": "Pluggable TOAST/One TOAST fits ALL/Олег Бартунов,Федор Сигаев,Никита Малахов (Postgres Professional)",
  "views": 1640,
  "duration": 3035,
  "published": "2023-01-19T05:55:17-08:00",
  "text": "сегодня мы будем говорить я хочу сказать очень приятно видеть вас всех здесь сегодня мы будем говорить о таком очень глубоком разработчикам докладе который может быть вам будет не очень понятен но вы поверьте что это очень важно для подвеса и для вашей разработки слайды вы можете скачать уже кстати вот ссылка есть на первой страничке если вы не понимаете эту картиночку дата не не волнуйтесь я надеюсь что по ходу доклада вы поймете что здесь нарисовано но принципе здесь написано нарисован слон разрезаны на части но только каком-то неправильном порядке и наш доклад называется что вот толст он как бы один толст для всех кто не знает что такое тост я тоже надеюсь вы поймете в этом правда на протяжении доклада первую очередь я хотел рассказать о том что вызвало вот в чем причина этого доклада заключается том что последнее время и вы все знаете что джейсон очень как преобладает о разработчиках как тип данных и в пудре си-джей синби появился один из первых вернее так скажем под здесь был 1 реляционная база данных который был реализован джейсон это сделали как раз мы с федором и с тех пор как вы видите по этому графику после ст популярны используется растет в то время как остальные реляционный базы данных ну как бы остается или стагнирует слегка адрес как бы привел к тому что теперь в любой и реляционной базе данных существует поддержки разрешено из кво или стандарт принял джейсон как уже нормальный легальный тип данных то есть джейсон сейчас празднует свое как бы торжествует все пользуются джейсоном и это связано с тем что во первых с рассветом архитектуры микро сервисов для которых джейсон идеально подходит вот связано с тем что большинство стартапов используют postgres и использует джейсон частности джейсон дэй связано это с тем что джейсон позволяет очень легко стартовать свой проект не думая о схемах и и так далее потому что действительно это достаточно тяжелая серьезная работа требующие но профессионалов а стартапа нужно быстро стартовать поэтому все делают табличку который находится один джейсон вот и как я сказал джейсон является один сейчас драйверов того что после спада набирает популярность и он используется как как в клиентских приложениях бэндах базах данных то есть грубая джейсон привел к тому что потихоньку смягчилось противоречия между объектно-реляционная моделью и реляционной модели то есть между между объектами и реакциями объекта и это то что вы используете своих приложениях а реляции это то что вы используете в базах данных так вот джейсон он помог как раз вот это противоречия исправить вы просто работаете везде одинакова с 1 джейсоном но как выяснилось что производительность джейсона она сильно определяется какие-то родовыми проблемами его пол грехе и получился часто случалось так что ко мне подходят и говорят что мы используем вас джейсон б все летает все хорошо когда мы начинаем уходить продакшен начинается рост популярности все начинает тормозить вот для того чтобы исправить вот эту родовую проблему одну из родовых проблем мы и собственно начали работу по по улучшению механизма хранения длинных записей в адресе который называется тост и мы показали что производить джейсона можно улучшить на несколько порядков это конечно очень здорово вопрос возникает о том как все это интегрировать обратно в puzzles это же upon собственный наш проект и мы конечно разрабатываем но для всего международного сообщества вот видите вот картиночка там нарисовано по опросу международного вопросу топ-3 фичи которые используются в агрисе вот на первом месте витте джейсон бер сильно ли лидирует это подтверждение моих слов на втором месте триггеры я третьем это индексы который кстати тоже разрабатывали мы и так я разберу два случая первый случай от как раз тот самый джейсон дэй как его ускорять вот такой простейший пример он просто-напросто здесь 10 тысяч строк в табличке в которой стоит и зайди и некоторого джейсона и первый запрос как вы видите просто мы вытаскиваем один ключ он занимает всего шесть миллисекунд и читается две с половиной тысячи страниц но после того как вы например решили сделать маленькие маленькие орды вы получаете смотрите вы читаете 30 тысяч страниц и производитель сразу падает до тридцати восьми миллисекунд это то что происходит продакшене часто когда люди начинают работать джейсоном по серьезному вот если позже inspect напустить на то табличка мы увидим что на самом деле табличка занимает 64 страницы на каждой страничке захочется 157 couple of откуда возникает вопрос взялась 30 тысяч страниц оказывается если кто из вас не знает уп адреса есть такое такая технология когда длинные атрибуты хранятся не в табличке а в отдельном хранилище и это как раз и называется проклятием тоста вот посмотрите вверх у вас имеется вот айди джейсон хранится джейсон длинный джейсон хранится так он сначала сжимается ведь сжался а потом делится на части так называемой чанки а сама табличка превращается вот слева она превращается в маленькую табличку то есть айди и место самого джейсона там лежат просто tales pointer и то есть это pointer который указывает на вот эти на эти чанки и доступ к этим чангом происходит через b3 существует еще специальный yandex вот благодаря которому происходит доступ чанг у и когда вы хотите взять какого-нибудь ключ то вы на самом деле вы берете не просто из таблицы а вы берете вот этот читает вот это дерево делайте поезд потом идете скрытую таблицу который существует и из нее достаете эти чанки склеиваете разжимая те в памяти и только когда вы достаете ключ то есть таким образом происходит вот как бы это безобразие которую вам не видно это все прозрачно но overheat для того чтобы достать несколько бантиков он бывает так что вам нужно прочитать три четыре блока еще дополнительно их являются индексные блоки вот именно отсюда как раз и возникает вот эти 30 тысяч тридцать тысяч дополнительных страниц здесь просто пример у нас для того чтобы достать ключ вам нужно два толсто прочитать из буфера и 1 из 1 чанг вот и дальше вы просто простая арифметика то поговорить о том что у вас вы в результате читайте 30000 64 странички и за это происходит все это все замедление то есть с этим понятно теперь возьмем более при более нормальный пример где у нас имеется jason jason и каждый из которых выглядит как коротенький ключ большой массив коротенький ключ ну еще какой-то массив и мы мере и в производительности просто доступа к разным ключам и такой типичный пример который эмулирует но в жизни обычно как джейсон стоит у вас имеются какие-то ключевые какие-то метаданные к и довольно короткие и какие-то массивы и вы наивно полагаете что доступ коротенькими тогда нам должен быть быстрый но к массивам длинным там преодолел он действительно достаточно долгие на самом деле происходит не так потому что вот так то есть мы видим что доступ к ключу растет пропорционально размеру джейсон и то есть не то что там вот коротенький коротенькие ключи лежат впереди и должно быть казалось бы быстро нет на самом деле происходит так потому что вам приходится работать вот с этими толст танками вам приходится каждый раз собирать такие большие чанки сжимать и разжимать и доставать вот слева это время а справа это количество блоков прочитанных мы видим что независимо от того какой ключ видите коротенькие ключи это красные зелененький они все равно доступ к ним все равно растет вот таким образом то есть пропорционально пропали размеру к джейсона независимо от его самого ключа размера ключа не зависимо от того где он находится это вот такое положение которое сейчас есть в подписи и с которым вы встречаетесь и боретесь вот мы хотим конечно все это улучшить идеальное вот такая цель у нас это чтобы производительность не зависело от размера самого джейсона и от размера и ты того где он находится а зависело просто например от как бы от от уровня вложенности к примеру ну и соответственно был и апдейт хороший вот то что мы хотим сделать и когда мы начали эту работу год назад практически год назад весь прошлый год я как раз везде ходил по миру рассказывал что мы делали шаг за шагом и вот сейчас мы рассказывали будем показывать результаты где уже все шаги склеены и мы видим суммарное вот то преимущество которое мы получили сейчас вот написаны тем как бы улучшения джейсону вот я не буду их рассказывать до конца как бы в том что время особо нет но я покажу вам картиночку к чему все эти улучшения привели самая первая левая картинка верно хинду этап это старая это мастер и вот дальше мы видим как потихонечку производительность улучшается улучшается улучшается и в конце концов мы видим что время доступа к и коротким ключам вот они самые низкие внизу вот десять тысяч раз тысячу раз становится лучше длинный ключей длинные ключи они тоже ускорились но не так сильно но они на тут потому что они длинные их надо все равно прочитать там еще нужно еще поработать конечно чтобы работать чтобы оптимизировать доступ к элементам массива это пока еще не сделали но как вот так и метаданным мы уже будем обращаться на несколько порядков быстрее причем видеть не зависит от размера не зависит от того где находится ключ кей 1 ключ и третий ключ они находятся в самом низу прекрасно можно с ними работать если посмотреть на относительно и ускорение то вот здесь мы как раз увидели для разных людей показано в стыковая диаграмме показана относительно ускорение мы видим что вот первый ключ верхняя левая картинка вот ускорение видите в 1000 10000 раз для длинных джейсона происходит а третий ключ аналогично ускорение несмотря то что третий ключ находился за длинным jizz длинным массивом у массивы тоже как bus курились но не так сильно но как я сказал что над этим мы знаем что делать над этим работаем если взять агрегированные статистику то просто напросто вот миллион запросов пустили на разные ключи а потом посмотрели от на мастере и нашим на нашем вина нашей версии со всеми оптимизации включенными мы видим что ускорение больше чем в 1000 раз вот слева картинка разные цвета это просто разной оптимизации которую мы подключали справа тоже самое та же самая картинка просто она уже по размерам джейсона вот коротенькие жетоны с ними ничего хорошего не ничего не изменилось просто потому что коротенькие джейсон и они нет они находятся в табличке с ними ну оптимизации никакой и и не должно быть дальше тем в держите джейсон и которые средних размеров которые при сжатие помещается в табличку они ускорились но не так сильно а вот например те которые длинные джейсона этот справа правая колоночка совсем они ускорились вот видите на несколько порядков дальше апдейт это очень больная тема потому что как только вы начинаете пользоваться джейсон он вы начинаете испытывать головную боль а как же его апдейтить быстро вот облететь быстро не получается просто потому что так вот видите слева картинка мастера приобрети потому что вам приходится записывать все переписывать вам еще приходится это логировать поэтому вот такой большой рост станет в мастере когда мы применяем наши вот оптимизации мы тем что видите отдaть вот для коротеньких людей он практически не зависит от размера то есть очень быстрый то есть еще раз напоминаю это тот самый самый популярный кейс использовать джейсона когда у вас имеется не мета-данные ну просто какие-то ключи и значения и к нему при собачьего ются какие-то там был бы большие данные и так далее так вот метаданные оказывается теперь будут ответится быстро хорошо и прекрасно вот та же самая картинка только уже по количество блоков прочитанных то есть мы видим слева я мастер мы читаем большое количество блоков справа оптимизированное эти количество блоков сильно меньше и вау гигантский вал приобрети просто гигантский видите слева это вот то что лакируется изменения в адресе вот и справа практически как бы лица его практически нет потому что лаги руется только изменения ну тут понятно я уже говорил что надо нам работать чтобы на физическом уровне добавить рандомные акт доступ ко чанг а то есть сейчас мы должны эти части все-таки читать последовательно если у нас будет возможность точно сказать какой чанг взять и разжать вот это будет большая победа на физическом уровне мы эту задачу в классифицируем как легкую просто руки не доходят пока а вот на логическом уровне это сделать так чтобы мы могли оптимизировать доступ к элементам массива вот массивах достаточно сложная структура да и не надо уметь доходить до каждого элемента независимо от того на каком месте они находятся в начале массива или в конце это задача на требует некоторой переработки джейсона но мы тоже знаем что 1 и второй случай это append и был buy the bar бинарный тип который часто используются для того чтобы хранить какие-нибудь файлы какие-нибудь там видела картинки и так далее вот и хочется добавлять его например очень быстро вот пример где ловить 100 миллионов байт такой со 100 мегабайт файл и мы туда добавляем один бантик мы видим 1 и 3 секунды на это происходит представляете то есть больше одной секунды для того чтобы добавить только один байтик при этом таблица она увеличивается в два раза вот и еще плюс генерится 100 мегабайт вала то есть понятно что производительности здесь никакой и люди говорят что ну и в баню будем хранить в файлах а здесь будем только ссылку не будем хранить файлы в базе данных однако людям некоторые хочется и вот на одной из конференций а к нам поступил вот именно прим этот запрос и мы сделали второй такой 2 оптимизацию по этому делу то есть мы решили не переписывать заново вот этих чанки как я говорил толсты вот а заниматься только использовать тупой но использовать хранили таблицу для хранения как раз вот этих дополнительных измерений как буфер для накопления вот но есть такие как бы картиночки они сейчас трудами что-то про здесь показать самое главное что мы не копируем все мы копируем только мы у нас появляется только изменение как настоящего пенки у вас имеется неизменяемая часть и мы только добавляем кусочки вот нынешнем нас терем и прими нам приходится все ищите части копировать и за это происходит вот такой обвес вот тот же самый пример но когда мы сделали оптимизировали толст мы увидели что мы увидели в две тысячи шестьсот пятьдесят раз быстрее все стало таблица не изменилось вот столько сто сорок три байта за лакировалась и никаких вот дополнительных буферов ни читать ни писать то есть эта прекрасная победа и вот мы показываем теперь уже наш синтетический пример когда мы просто ободрить им вот в 10 байт добавляем 100 килобайт так далее до мегабайта мы видим слева это мастер справа это вот наше улучшение мы видим что время зависит только от размера того что вы добавляете ну грубо если вы добавили мало вот время коротенькая если вы давали много во время стало больше но не зависит от не зависит ни от чего слева вы видите как все значит резко при даже при маленьких детях время катастрофически растет вот теперь давайте попробуем даже мы решили а что если мы будем стримить то есть не просто делать одиночные обладают of цикле начинает добавлять по батику или по 10 байт этот называется стрим такого раньше в базу данных никто не делал стрим в подвес грубая видела может стремиться туда вот такое делается параметры опенсорс у нас меняется 10 байт до 100 килобайт вот используем расширение позже состоит на для того чтобы читать вот собирать статистику мы видим что слева это мастер то есть мы видим что как только вы выходите за 2к то есть начинает работать тост никакого стрима уже не получится все зарастет и упирается в потолок справа мы видим что стрим продолжается опять же по той же технологии если вы добавляете маленькие кусочки то идет все быстро если вы добавляете большие кусочки ну становится медленнее но она горизонтально то есть это вот такой стрим по времени вот та же самая картинка для валов опять же сколько логировать справа слева опять же мастер мы видим что мыло героем очень много в практически весь поток а справа и мы лагерным только изменения ну и тоже самое по значит это уже как бы мегабайт в секунду то есть пропускная способность мы видим что слева мастер с началом стрима она вся падает падает падает падает ну просто потому что действительно накладных расходов очень много а справа пропускная способность у нас как бы стоит на месте здесь мы не дошли в этом эксперименте до насыщения диска на самом деле при увеличении большого ума размеров добавления мы должны конечно вниз спуститься насытиться вот здесь мы видим что чем больше мы размер добавляем к к тем лучше пропускная способность то есть мы потихонечку насыщаем диск то есть пример показывает как можно придать стримить в по адрес теперь можно стримить адрес у вывод такой заключается что то что мы сделали это очень круто это очень хорошо но возникает только единственный вопрос как теперь это вернуть сообщества это очень серьезный вопрос некоторые патчи мы возвращались сообщества тратя на это лет пять потому что сообщество большое база данных большая это очень ответственный процесс и просто так вот берите возьмите никто не возьмет тем более что у нас ну там под сотню тысяч кода написано это очень тяжело и тут возникает как раз вторая часть вопроса мы должны сделать вот этот тост расширяемое вы же знаете что после с расширяемым можно добавлять типы данных можно добавлять индексы можно писать функции оператора и так далее и вот теперь мы решили патрис расширить еще дальше мы решили сделать вот этот механизм хранения длинных длинных значений не захардкожены а расширяемым то есть любой из вас в принципе кто зайцы мог бы написать свой алгоритм каким образом хранить вот эти длинные значения адресе то есть мы говорим мы хотим расширить расширяемость под риса и приходим как раз вот ко второй части вопроса доклада федя сигаев продолжит меня до утра всем да потому что олег рассказала она не обладает одним свойством это коммент обильно стоит сообщество не согласиться это набор патчей большой как с этим жить ну давайте сначала еще посмотрим как большие значения можно хранить но очевидно можно увеличить страницу nolimit все равно 64 килобайта и очевидно это недостаточный не упоминали но есть такие на джорджик но это было бы они было бы совсем было бы они доступны и сквозь него лесик нуца в серединку вы не можете 1 то есть только скачать него невозможно вот это текущий у него есть как преимущество он может быть за конкретный он в общем то сильные интегрированы хранить данные в такой же таблицы просто она скрыта но тут есть совершенно неожиданный подводный камень то что ли нет у любой реляции яндекс или таблицы вкус gear fit 32 терабайта не нет значение 10 гигабайт значит если вы вставляете 1 1 байт таблицу у вас может быть не больше тридцати двух тысяч назначений в таблице внезапно и с этим вы ничего не сделаете это одна из таких ограничений на них редко натыкаются на по крайней мере 1 раз наших заказчиков на это ограничение наткнулся сам механизм толсто по крайней мере сегодняшний ничего не знает о том что чем он оперирует для него это просто длинные байтовые бен и байтовые массив или строка ли вам с ним забавляется как может очевидно что если вы знаете устройство типа то наверняка сможете компрессию к нему предложить лучше то есть если это у вас там поток сортированных байк то вы всегда можете предложить там war beat is more buy компрессию которая работает эффективнее чем как у нет-нет да и толстый есть проблем поскольку он ничего не знает о внутренностях он будет делать копии при апдейте и на толстом накрепко вшит в стандартный метод план табличная ты была access method was great и если вы пишете свой темп access method to решать проблемы больших значений вам придется самостоятельно ну и единственное наверно единственное преимущество это универсальность trust работает всегда тут работает хорошо это вас работать с любыми значениями этот год существует уже больше 30 лет и он хорошо отлажена правда body все равно встречаются пузырь из вообще говоря отличается двумя вещами это самая тяжело произносимые базы в мире а во вторых это самый расширяемая база в а вот насчет сторон мы хотим это место расширить еще так чтобы это можно было сбоку подойти и про пользоваться там всеми возможностями но принести свой тостер для своих задач как это будет выглядеть со стороны пользователя кейт extension но конечно и толстым это будет в ней кинув говоря терминами опыт некий класс которые им консультируют это интерфейс который инкапсулирует себе все работы с большими значениями и до чтобы вот когда раньше я века я говорили о том что текущий полос не знает структуры структуры типов совершенно не хочется чтобы новый тостер обязаны знать это было обо всех типах особенно трудно это будет с подключаемыми типа мне который пользователь предоставляет например там про около недели турели поэтому toaster должен уметь быть выделенным для до нас для заданного типа он может быть специфическим для какого-то мир клауда вот то что олег рассказывал там стрим append и так далее а более того очевидно что хочется уметь тостер назначать не на таблицу она одну колонку ну просто потому что вы в одной колонке вы можете сочетать разные типы данных даже с разными work лордами ну и соответственно чего совершенно не хочется это что при очередном majira грейте там перри переходится сказано 15 версию пузыри со вам нужно перезаписать всю базу данных естественно этого не хочется хочется сохранить совместимость существующими базами вернем немножко поглубже creed extension конечно вряд ли кто-либо когда-либо в живую будет писать к отдельной команды создающий тостер конечно пользователи будут писать great extent shell extension кто-то написал он тащат с собой запчасти какие-то многие но тем не менее давайте чуть глубже нырнем я не уверена нажимаю кнопку изменить конечно внутри команда 3 тостеров поскольку тостер это на самом деле некий набор специй в свое время если кто следил надеть такая таблица по граму когда-то в ней насчитывалось там 220 плюсом колонок точно не помню потому что там отдельные методы были колонки там были свойства когда каждого access метода это было на самом деле это работало но когда появились подключаемые стало очень неудобно потому что кучу вот этих вот полей их нужно правильно обретёте а практически пользу эти поля не ведут сделали один хендлер который все базе о себе рассказывать так и здесь то есть появляется табличка в системном каталоге пагод остро который содержит воет тостера его название то как вы с ним будете оперировать при работе и хендлер хищная функцию одну достаточно специфического формата которая возвращает на самом деле заполненную структура методов и свойств как это выглядит с точки зрения пользователя который уже сказал great extent and ну например он создает таблицу и указывать что толстая тостер пока это колонки будет такой то и соответственно он может в любой момент тостер поменять ну очевидно что для проведения экспериментов то строит надо уметь менять более того там может вы на какой фрагмент и хоть хотите поменять так что это пока команда тоже есть как посмотреть какой тостеру колонки но естественно есть прямой способ зря есть системный каталог пазуху потому что пузыри со себе самом хранить все сведения о системном же каталоге но более просторный расширенный выводы backsplash d плюс у по иску или и там появляется колонка тостер с названием тостера где это на самом деле знание хранится значит еще раз пузырь из каталог содержит о себе в себе все знания о таблицах в том числе и системных же и там есть такая таблица п г а трибьют который как ни странно содержит сведения себе самой тоже так вот там появляется колонка тостер привязанная к колонке то есть от релит это вид таблицы 1 от name название ну и собственно дальше той пойди тип колонке иф среди прочего сто раз компрессор и добавляется тостера где-то храниться до в колонке все это здорово хранить то есть когда мы в пользу вставляем в таблицу у нас еще значение никакого нет мы берем это значение лезем в описании колонки видим какой тостер вызываем тостер к он режет слайсинг и складывает это на 1 дисков что попадает собственно в таблицу в таблицу попадает так называем тост pointer то есть это вместо значения кладется некий кусочек вот тут для примера текущая ситуация мастер и все предыдущие версии вот у вас есть попал синенький в нем есть заголовок в нем есть там колонки они здесь показаны точками потому что существенного значения они не имеют но вот вместо длинного значения кладется толст интер который в текущей версии состоит из 16 байт содержит в себе размер не нарезанного на них не компенсированного размеры флаги компенсированы если контент рейсе использовалась дальше тот самый вылью о еде это индикаторы записи автобус таблицы и сама будет таблицы толсто 16 байт выравниваем 4 что мы предлагаем мы предлагаем сделать эту структуру не фиксированные почему давайте на нее посмотрим первое что мы видим это размер рук турнуть естественно если не размер столу не фиксированный где-то должна быть ее длина вот это 16 байт извините два байта 16 бит его достаточно для того чтобы хранить на 8 килобайт непроизвольно кусок значит дальше оригинальный размер значения почему потому что во многих местах погреться у нас есть хочется знать размер до того как мы туда залазил например по полезно для статистики ну и создан собственной тостеры которые нарезал который потратил или под дальше идет опциональная часть ее может не быть если острова слишком умный значит в этой опциональной части это ответственно стол от остро что там хранить мы может хранить что он числе и само значение если решит что не надо вообще то есть то есть это итоговый толст по интернет получилось меньше минимальный размер 10 байки slide устрой очень умный и выравнивание 2 вы на это можем экономить пространство но на самом деле не всегда это получается из-за выравнивание окружающих колонок до выводы или следствие тазу той схемы которым и предлагая значит поскольку вольт тостера хранится в самом значение дело в том что когда вы значение вы передаете внутри экзекьютора где-то внутри позы gresso зачастую же теряет сознание в какой таблицы она лежала поэтому собственно говоря нам нужно знать какой то острова на этот порезал таким образом если вы хотите тостер дропнуть вам нужно обойти всю базу данных с поисках тех значений которые вы использовали дуриан здесь такой что ну это очень дорого сделать поэтому пока просто запретили дропать толстый создается до конца жизни инстанса ничего страшного потому что ну по моим ожиданиям удаление тостера будет крайне редки ситуации если только вы не разрабатываете этот тостер но тогда вы можете это грохнуть простым деле там в каталоге и вы вообще kumho tire и второе следствие значит вот эта вот команда alt и busatto сторону тут есть два варианта первый вариант никитина при назначении нового тостеры мы перетащим все значения у вас есть терабайт вам нужно нужно будет перезаписать терабайт так себе решение поэтому приняли решение что старые значения не трогаются измененный тост будет влиять только на апдейты только на inserto и так далее таким образом у вас в таблице мода могут случиться тостеры значения нарезанные разными тостерами поэтому в коде вы должны учитывать то есть всегда de tous доступен это сейчас вот секундой позже то самое api три обязательных методы и нет ну на всякий случай мало ли что нужно сделать значит функция тот который он принимает не потолще на и значения его the state возвращает толстый enter очевидное до толстого наоборот получает на вход тасс pointer возвращает до толщины и значения это прямо на работа в лоб и вы можете ну то есть это можно использовать есть три метода которые опциональные они на самом деле полезные для оптимизации up простых апдейтов возможно копи когда вы делаете копия из таблицы в таблицу то есть электорату когда вы удаляете тасс по каким-то причинам отмыто опциональные методы есть два загадочных метод одет в tribal и тостер в лиды давайте их немножко обсудим в лиды как мы уже говорили что тостер может работать только с одним типом данных или там с одним с одним teeblox с методом либо с одним сторожем так далее песне есть набор который надо процитировать можно было бы вынести это на ускорили уровне но обычно это тяжело модифицировать если вы хотите это вызывает еще кучу лаком on the alter тостер что в нибудь в нем поменять поэтому решение такое простое вылядит это на самом деле по следам индекс access методов есть вы людей которые когда метод вызывается когда вы назначаете тостер на таблицу тем или иным способом этот вольды дарит я могу в такой ситуации работу теле я не могу но если не может то она своей лицо втб virtual тай-бо на самом деле вот то что олег говорил про джейсона но требует очень нетривиальные работы с толстом понятное дело что для каждых типов это вообще говоря там набор метод вам может быть весьма странный экзотичный поэтому заранее в будущее мы смотреть не можем ну точнее мы можем но мы не всегда его видим поэтому решили сделать такой нет который возвращает список методов и там должен быть никита чуть попозже расскажет какой то magic number по которому код опознает что это то самое теперь можно назвать эти методы и где работать эффективно если это так то на конкретное значение пришло из другого тостера тогда нужно идти по простому пути до толст и пошли простой путем к сожалению самые медленные здесь я передаю слово во дни кити малахову кнопка вправо добрый день ну в общем наверно все уже поняли что это все очень круто и сложно потому что действительно круто и сложно это результат нескольких лет работы людей я логически вернусь чуть чуть назад чтобы немножко заглянуть под капот того что мы сделали как уже вот и олег а фёдор говорили проблема все существующего механизма в том что он зашиб 2 кор база данных является неотъемлемой частью метода доступа к таблицам не предполагает никакого расширения никакого никакой специализированные работы с разными типами данных значит и здесь вот как раз происходит самое интересное начинается немного магии мы вот помимо api которая по сути написанное закиси является структурой предоставляющий пользователю не как некоторые список указателей на функции мы вводим еще дополнительный слой который по специальному флагу в входных данных определяет что это вот наш новый необычный вид входного буфера это очень такой важный момент потому что до этого не ну немножко дня было наверное понятно каким образом получается мы разбираемся там это байта данные или j сербия или что то еще мы вместе с нашей доработкой представляем целых четыре различных тостера во первых это штатный который работает штатно для обратной совместимости с этой точки зрения ничего не поменялось а если нет никаких расширений я имею виду новых to stir of the он находится внутри базы и работает как и работал значит это байты тостер специально для в этой типов данных о которых говорил олег как раз у для стриминга чтобы облегчить операцию апдейт и специальный тостер для джейсен для объектов так как джейсон b является очень хорошо структурированным то естественно это позволяет нам применять различные эффективные способы оптимизации они просто класть это там пользоваться обычной компрессии также так как мы не знаем там что придет в голову разработчик насколько бурно разыграется фантазии мы даем возможность закладывать туда свой набор функций например для типа bt нам нужна функция append она очень удобно которое вместо того чтобы создавать новую копию данных в памяти там объем может быть достаточно большой там гигабайт держать только для того чтобы сделать конкатенацию ты наверно не очень здорово значит эта функция дописывает занимается конкатенации такой записыванием как одному значения другого без промежуточного копирования или же для джейсон б тостера у нас появляется очень много всего нового интересного потому что джейсон б то есть раз пользует внутри специальный вид представления джинсы для объектов используют такие методы как императоры и много всего другого интересного и вот это все за счет таблицы виртуальных методов мы можем предоставить разработчику ну собственно почему мы взяли вот байта я джейсон via в этом сказал олег что это очень проблемные с точки зрения хранения типы данных вот на этом я так особо останавливаться не буду графики опять же здесь олег пояснил что штатный тостер он конечно его плюс в том что он хорошо работает но он работает неэффективно тогда когда речь идет о больших значениях и об операциях типа панда нас получается рост и журнала и времени доступа зависимости не просто добавляемого значения аят того что у нас было исходная нашего байта тостер подключается как расширение предоставляет в общем то стандартная функция толстой де толст это сохранение извлечения из базы но при этом случае операция band он работает не так как обычно работает апдейт он не переписывает значение целиком и даже не достает его целиком он достает только хвост всего значение которое добивается новой частью и в журнал и соответственно базу попадает только новая часть старой остается неизменной не перезаписывается не образуется мертвых чанков в таблице ну здесь есть такие подачи пара принципиальных схем как это в принципе работает для того чтобы показать что хоть мы отделили to steer от методов доступа все равно они могут прекрасно использовать функционалу методов доступа никто не мешает это делать дальше значит у нас очень такие интересные графики тоже олег уже это показывал вот но я немножко повторюсь что оптимизация операции up and позволило нам получить в общем время доступа и рост размера журнала зависящее только от размера добавляемого значения что очень важно потому что в общем при большой нагрузке это будет вызывать просто там катастрофические последствия немножко про джейсен be to steer так как принципиальна схема подключения она общем точно такая же вот опять же то что говорил олег у нас получается что при использовании штатного механизма как у нас используется джейсон ли джейсон где используется как правило там для доставания значения по ключу вот в итоге получается что для того чтобы достать одно даже самое маленькое значение нам нужно полностью извлекать из таблиц объект собирать его в памяти доставать это значение это не очень здорово не очень эффективно что опять же показывает собранная статистика дальше мы подключаем нас есть джейсон кидд остер это такой но это большое расширение очень большое котором работали несколько лет и как раз из-за того что в себе и очень хорошо структурирован туда можно закладывать часть оптимизации вы уже сделали и туда их можно закладывать их ещё ещё ещё есть у нас уже есть там в определенные мысли насчет и возможно будут предложений сообщества что можно еще сделать как сделать его еще более эффективным вот опять же есть такая общая статистика которая показывает насколько более эффективна работа при использовании тостера который знает о структуре данных с которой он работает там речь идет опять же как уже было сказано речь идет не там вадим два раза речь идет о порядках вот что есть очень хорошо но при этом у нас еще очень большое поле для работы потому что есть некоторая оптимизации например который удалось сделать в штатном механизме но и мы еще не повторили их в нашем расширение принципе такими ну наиболее логичными возможностями для дальнейшей работы это является да и произвольный доступ физический уровень это использование различных методов доступа возможно там использование к волчата хранилищ все в таком роде я передаю слово олегу осталось совсем немножко времени так хочу поблагодарить вас всех что вы мужественно выдержали вот это очень глубокое погружение в потроха по зрится но это для того чтобы поняли что это все-таки системный продукт и за этим работают люди которые заслуживают большого системного уважения вот на самое главное вы должны понять о чем о том что это open source ная работа значит теперь есть путь для легальный легальный путь для от того чтобы отдать сообщество всех тех улучшений что я показывал своей части если раньше это были просто нашей эксперимента над живым по адресам над потрохами и которое было очень тяжело да и сообщества и теперь мы сделали механизм легальные через которое это можно отдать сообщества более того сообщества значит мы планируем о его в 16 релиз то есть чтобы вы ожидали более того мы расширили мы дали возможность уже не просто писать свои расширения видит для тостера но эти расширения могут быть изданы под любой лицензий то есть дает свободу для коммерческого использования вы можете написать свой к мерзкий тостер который будет там еще лучше и спокойно скажем например его как-то продавать вот на этом слайде я показываю на ссылки по которым вы можете более плотно познакомиться со всем тем о чем мы говорили вот и даже видите вот ссылка есть на каме 200 то есть все это обсуждение она идет в сообществе и это очень хорошо что наше сообщество даже в такие тяжелые времена продолжает оставаться международным таким не зависящим ни от каких там политических проблем с сообществом наук хочу сказать что в этом году вот буквально месяц назад была закончена наша работа которая была на протяжении пяти лет мы делали то есть пятилетние патче их очень много и в 15-ом релизе который выйдет в сентябре этого года будет содержаться вот полностью реализованный стандарт из квали джейсон то есть вы можете уже писать свои приложения нас стандартно и одно из самых таких вкусных вещей что за зака-зака что уже попала в пузырь из является jason taylor j sensible и такой мир такой мостик между джейсоном и таблицами то есть результат ваших работ с джейсоном вы можете представить в виде таблицы и потом этот результат за ним уже стандартными путями можете можете делать join с другими таблицами то есть дает очень большую гибкость для разработчика приложений стандартный путь немного позитивного я хочу сказать когда мне говорят некоторые опытные старики о том что джейсон и таффи что нужно прочитать книжку про электроны алгебре и так далее да и заниматься вот правильным делом так вот я считаю что этот пример мои дети они очень любят лазить по деревьям и конечно рвут штаны и вот можно им запретить лазить по деревьям до можно их научить как то так далее так вот я считаю что джейсон надо не ругать вот людей которые занимаются джейсоном там используют своих стартапах а тем что надо просто научить базу данных чтобы она была умная и понимала вот этих стартап чиков которые берут и делают рейд и был джейсон вот не надо их за это ругать и вот наша работа как раз она позволяет именно стать ближе вот к этим людям то есть стать сделать пол рис более доступным для всех людей ну и последний слайд вот я заканчиваю что все что вам нужно нужен погреться не надо какие другие базы использовать ну можете конечно какие то маленькие для нишевых вещей но в целом конечно все в прогрессе есть я занимаюсь возрастом больше двадцати семи лет и вполне счастлив оси бывают спасибо спасибо друзья у нас к сожаления стопам памятные призы от программного комитета ребята у кого есть вопросы закидывайтесь на спикеров сейчас потому что мы вывалились из вывалились из тайминга через две минуты она вот-вот все кто поднял руки и стесняйтесь встать и накинуться на спикеров сейчас когда они пойдут цифровые кулуары"
}