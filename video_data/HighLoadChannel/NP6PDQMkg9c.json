{
  "video_id": "NP6PDQMkg9c",
  "channel": "HighLoadChannel",
  "title": "Как научить почтовый сервер Exim под нагрузкой 1 000 000 писем/мин. переживать отказ ЦОД / М. Уймин",
  "views": 431,
  "duration": 3086,
  "published": "2025-01-17T02:33:12-08:00",
  "text": "Всем привет Меня зовут Максим и я работаю в ВК над проектом pota mail.ru мы сегодня будем говорить про почту про распределённые очереди А и немножко даже затронем Юз и файловые системы А Начать очень хочется с того чтобы какими-то крупными мазками нарисовать архитектуру почты mail.ru над чем Вообще мы работаем приходит значит к нам пользователь он хочет отправить письмо А лупит какой-нибудь well-known DNS адрес а у нас есть смтп най трафик Есть хттп трафик в любом случае после лупа он попадает так или иначе на почтовый сервер почтовый сервер делает свою магию и письмо от юзера попадает в Stage в качестве почтового сервера мы используем оную программу exim Вы можете зайти на github поставить себе Вот такой же и в в фокусе нашего сегодняшнего доклада будет кейс отказа центра обработки данных Аа юзер этого заметить не должен почта должна продолжать работать штатно вот такую задачу мы себе поставили и сразу небольшая оговорочка Stage у нас уже отказоустойчивый Мы его оставим немножко за рамками и будем обсуждать только вот среднюю часть письма в процессе доставки а дата-центры дата-центры горят иногда они затапливают периодически отключают питание у кого в этом году отключали питание в цоде Ну руки есть вот отключение питания на самом деле довольно страшная история и Давайте посмотрим какая у нас вообще цена ошибки для почты почта помимо большого количество рассылок это ещё билет на самолёт Деловая переписка между организациями чеки от ваших покупок фактор авторизации в кучу важных сервисов для некоторых даже хранилище бэкапов от очами у себя в почте это всё та информация которую пользователь не захочет потерять пользователь ждёт что электронная почта будет работать стабильно и надёжно поэтому ещ раз наша цель почтовые сервера пере отка без простое при этом у нас есть миллион писем в минуту У нас есть экзим в самом ядре наших почтовых серверов и менять его мы пока не собираемся у нас много проприетарный на нём про как я уже сказал мы сегодня оставляем за рамками на одном из прошлых лов у нас был про него доклад можно будет посмотреть по ссылке ия в этой распределенной очереди Я этим проектом занимаюсь 3 года и своих 5 лет в почте о чём мы сегодня поговорим мы сначала рассмотрим какую-то минимальную теорию которую нам нужно знать про почтовый серве чтобы делать отказоустойчивый инсталляции далее мы рассмотрим архитектуру нашей распределённой очереди и в конце чуть-чуть эсе КАТО источники которые я даю ссылки будут в самом конце презентации по QR коду Так что можно не бояться что что-то пропустить А всё можно будет отсканировать Итак почтовый сервер exim что нам нужно про него знать во-первых Он осный написан на чистом си со всеми вытекающими в частности я там видел функции длиной по несколько тысяч строк одна функа е он создат очень много дочерних процессов Прим эти дочерние процессы короткоживущие а у нас возникает Задачка в духе принять письмом - это дельный процесс принимает письмо и умирает или там предпринять попытку доставки точно также процесс живёт очень короткое время в процессе приёма письмам сохраняет письмо на диск И поэтому вот это состояние оно получается неразрывно связано с пом сером могло показаться что я там как-то ругаю им Но на самом деле это не так дело в том что электронная почта - это десятки стандартов которые регулируют общение по протоколу плюс практика применения этих стандартов и практика применения часто стандартом напрямую противоречит типа в стандарте написано максимальная длина строчки такая-то Но если ты её вот поставишь как по стандарту всё у тебя почта перестанет ходить пользователи офигеют от такого потому что фактически на эту часть стандарта почему-то забивают Вот и в такой с такими вводными Нам очень важно чтобы наш почтовый сервер соответствовал всей этой практике применения и был реально совместим со всеми другими доменами в интернете давайте рассмотрим процесс приёма письма приходит нам пользователь устанавливает соединения отправляет письмо быстренько записывает на файловую систему под капотом локальный диск записал на файловую систему отдаёт сразу 250 Ок пользователю пользователь идёт по своим делам Дело в том что письмо - Это довольно сложное конструкция а и в доставке письма может быть много краевых случаев в духе получатели в нескольких разных доменов о доменах одному доставили второму не получилось у него там домен прилёг не готов принять письмо Нам нужно будет это всё ретра ить при этом тем кому мы уже доставили трать не нужно Нужно трать только тем кому ещё не доставили поэтому обработка письма может быть по времени разнесет далеко Там на часы иногда и заставлять пользователя ждать всё это время продуктово довольно плохо поэтому все попытки доставки у нас предпринимаются асинхронно после записи на диск Какая вообще проблема может быть в случае отказа такой схемой они в основном связаны вот с локальным диском во-первых если у нас жет мы как минимум получим задержки в доставке как максимум потеряем письма Сейчас объясню от вылета одного диска Мы в целом застрахованы у нас Рей массивы всё такое А вот если у нас весь сервер вырубается то письма которые мы успели принять но ещё не успели доставить они по сути вылетают вместе срм доставки в худшем случае сервер сгорает вместе с цдо и всё письма потеряны это гипотетическая ситуация но как я уже сказал цена ошибки может быть достаточно велика Поэтому нам такую ситуацию нужно исключить дальше есть проблема с администрированием если нам хочется вывести почтовый сервер из нагрузки нам нужно позаботиться о том чтобы руками очередь распределить по другим серверам чтобы не было опять же простое в доставке и переехать не то чтобы совсем нельзя Но так как это это вызывает дополнительные сложности хотелось бы попроще чего мы хотим в итоге получить Мы хотим получить систему в которой пользователь придёт в наш а вместо локального диска положит письмо в какую-то распределенную реплицируемый эм назм его кою посредине мы будем называть распределённой очередью и ей сегодня будем заниматься в случае отказа у нас экзи должны просто с ловери на другую реплику реплика должна перевырок при этом нам нужна репликация между цоми АФ более того нам хотелось бы чтобы по сути Когда у нас письма привязаны почтовому серверу а к рду очереди нам будет удобнее и в облака заезжать и менить всё это дело и свою распределён ную очередь мы написали на тарантуле и тут встаёт резонный вопрос А почему собственно Тарантул А прежде всего я предлагаю сравнить Тарантул с одним из наиболее распространённых представителей класса брокеров очередей вот с какой первое наше требование - это там кворум ная репликация и авф есть и там и там дальше приоритеты доставки у нас есть разные письма например письма от пользователя к пользователю А есть рассылки там от организации большому количеству пользователей логично доставлять письма от пользователей к пользователям с более высоким приоритетом Можно ли такое сделать на кафке Ну Если постараться то можно можно завести разные топики под разные приоритеты выбирать топик под приоритет письма но тут уже начинаются приседания Аа дальше у нас есть кастомное состояние сообщения например карантин антиспам когда антиспам говорит Ну я пока не знаю это письмо спам или не спам придержи его пожалуйста минут на 10 я подумаю ещё вот такое на кафке организовать уже сложно Сложно сделать какую-то топик в котором письмо не будет доставляться до какого-то конкретного времени т и с кастомными мониторинга тоже проблема Мы хотим наблюдать за тем что письмо покинет очередь гарантировано в течение какого-то отрезка времени что оно не осядет в очереди навечно В итоге позволяет это сделать потому него исполнения лу кода по сути какую логику ты хочешь написать такую ты и можешь вот сделать под конкретную задачу У нас кавка - это реализация готовая Она хорошая но со своими ограничениями по протоколу а к Тарантул можно относиться как к фреймворк на котором ты любую очередь можешь сварить Под свою задачу в частности вот у монса была статья и несколько докладов в ссылочка в конце будет если вам интересна тема распределённых очередей отличная отличный материал следующий Поинт неочевидный сразу у нас в очереди есть два разных типа данных у них разные паттерны доступа и логично сделать Две разных суд сейчас докажу во-первых У нас есть файлы писем во-вторых У нас есть положение письма в очереди файлы писем Это довольно большие структуры у на лимиты стоят до 7м наложение Это буквально там сотни байт то есть Какой комер сейчас ответственный за доставку письма сколько это письмо уже лежит в очереди какой у него айдини Вот примерно такая структур это положение в очереди файлы писем Мы записали один раз Потом почти не меняем мы можем добавлять удалять заголовки в письмо тела вообще не меняем положение в очереди может меняться довольно часто у нас письмо может переезжать от одного почтового сервера к другому и эти изменения будут отражаться вот в структуре положения очереди файлов писем у нас много одно письмо это два-три файлам хранит заголовки и тела писем в отдельных файлах а положение в очереди объединяет все эти структуры в какую-то единую сущность с уникальным дишни В итоге файлы писем Мы решили сохранить ВП это технология на одном из прошлых хайдов про неё был доклад если вам интересно можете почитать вот статью по мотивам доклада что нам важно нам важно что Зета - Это точно та же технология которая используется у нас В итоге в радже получается что мы получаем те же самые гарантии сохранности а положение в очереди как я уже сказал мы сделали на тарантуле написали своё шное приложение и из него мы на файлы м ВП по дишни сся рассмотрим схему работы с брокерами распределённой очереди вот что мы сес обговорили у нас есть и у нас есть две суд таран ИП приходит пользователь с письмом в его получает и первое что он делает это записывает файлы этих писем вту в ответ он получает массив Адик объединяет их в единую сущность с ID письма и отправляет в иксс внл На этом этапе вот можно видеть что конвертик переместился в базы данных мы считаем что письмо легло в очередь как только письмо легло в очередь М может отвечать юзеру 250 ок и локальную копию удалять То есть он завершил свою часть работы он принял письмо далее У нас коню вступает в дело первое что он делает он полит из индекса новое письма и берёт на них аренду аренда - это Лог с известным ТТМ То есть у нас мы гарантируем что никто другой этим с этим письмом не будет ничего делать в течение какого-то вот известного времени как только эм взял аренду он соответственно Скачал себе зеп ашки и по этим ЗП ашкам может выкачать файлы писем из зеп и дальше у на происходят попытки доставки тут возможно два варианта рассмотрим сначала неудачную попытку мы попытались доставить получателю у нас не получилось временная ошибка что делать в этом случае удаляем локальную копию письма и отступи больше не нужно Пусть кто-нибудь другой попозже попытается повторить и успешный вариант Мы также удаляем локальную копию письма когда получатель его собственно получил и и в этом случае из индекса мы письмо уже можем совсем удалить получается что в случае успешной доставки Мы из очереди полностью удаляем письмо Всё оно как бы Остаётся только в ящике У получателя последнее небольшое усложнение к этой схеме вот эти роли продюсер и коню они на самом деле логические физически никто не мешает продюсеру и коню быть одним и тем же физическим процессом Мы только что рассмотрели серверную часть распределённой очереди Давайте посмотрим клиентскую часть Как нам заставить работать со всей вот этой замечательной системой решение вло это там написать свою клиентскую библиотеку слинковать её с экзим и собственно делать библиотечные вызовы этого рения есть одно главное щество это с точки зрения понимания и целый ряд недостатков во-первых мы создам дополнительный ди с астрим версией кма мы буквально вот недавно померли где-то 6 лет фа с астрим и очень не хочется повторять это это было очень больно следующий Поинт у нас связываются циклы разработки почтовой очереди и почтового серра у нас уже был опыт с прота ми которые мы Линку и это на самом деле тоже больно У нас сервер и клиент должны быть совместимы по а клиент и Бинар В смысле исполняемый файл они должны быть совместимы бинарное они частенько приводили к багам типа выкатили кото би нев см поста правильную версию потом решили откатить сервер он перестал быть совместим по В общем связь довольно жёсткая получается коннекты сложно держать я говорил что почтовый сервер очень много форка такая схема сложно ложиться на эту модель многопоточности и с конкурентным доступом те же проблемы давайте рассмотрим Рим Биб ции посередине файловую систему Запишем на сво заменим на своё решение которое будет уже вместо локального диска ходить во все распределённые хранилища раскладывать там в нужном количестве копий все письма какие преимущества и недостатки есть у такого решения Ну надо писать свою фс не самая частая экспертиза на рынке ещё у нас системные вызовы Доро библиотечных будут но и преимуществ тоже много во-первых это заме реализации У нас вот как работал с файловой системой так и работает мы можем примонтировать свою в директорию где письма хранит и всём переведён на новую схему у нас минимальные завязки на какие-то знания об внутреннем устройстве Има и откатываться тоже очень просто если мы решаем что наша система почему-то работает плохо отмонтировать файловую систему начинает работать по старой сме у нас получается независимой по сути Нам нужно только знать как файлы писем называются всё и конкурентным доступом тоже никаких проблем xim умеет разруливает пок блокировок знает что каждый конкретный ча который в данное время ответственный за письмо он значит возьмёт этот и пока он держит этот никакой другой про к этому письму прикасаться не будет то есть наша файловая система просто должна эти покс Локи реализовать если мы решили писать файловую систему У нас есть два пути написать приложение в юзр спейсе на фреймворке Fuse или написать свою тельную реализацию а то есть модуль в ядре ос фьюзов и вариант быстрее отлаживать и проще писать поэтому мы остановились на нём но чуть-чуть пожертвовав производительностью ядро всегда будет быстрее Как работает Framework Fuse вот так по верхам У нас есть слева процесс Клинт он отправляет системный вызов в ядро попадает в подсистему vfs А дальше use вступает в дело F - это вот модуль ядра и библиотека lip F с драйвером файловой системы вй драйвер файловой системы и ядра общ через Connect и там просто rpc притом rpc у всех файловых систем одинаковая подсистема vfs она гарантирует одинаковый интерфейс для всех файловых систем по сути чтобы написать файловую систему на Юзе надо вот слип фьюзом слинковать и свою реализацию rpc сделать А подробнее про мой про мой опыт можно почитать по ссылке у меня недавно выходило большая статья мы не успеем покрыть весь опыт сфом сейчас скажу только что в целом это ну такая занимательная была история если вам интересна внутрянка и свою файловую систему Мы тоже решили писать на тарантуле звучит страшном на бина Тарантула делает на шный Файлик То есть он его исполняет а под капотом лушка делает на и в уже на сиш реализована вся наша логика Вот по работе сзм Почему вообще Ну типа зачем здесь ра Дело в том что он нам сильно сэкономил время нараз во из с Ну первое что нам нужно было бы какой вопрос решить Это вопрос хранения локальных данных мы бы заботились там индексации деревья крутили бы а в тарантуле пожалуйста спейсы индексы все структуры данных готовы бери пользуйся при этом доступ ко всем данным это исключает ситуации гонки и поэтому там не нужно оборачивать структуры данных мми Кооперативная многозадачность в тарантуле позволяет этого избежать Это довольно хорошая база для файловой системы Кроме того мы куски кода можем писать на языке высокого уровня не обязательно всё на сиш делать асинхронная модель данных модель многозадачности у нас из коробки логи метрики демонизация тоже всё из коробки в итог получается что используя готовые ошки мы просто сэкономили время на разработку относительно того если бы мы всё это совсем с нуля делали давайте рассмотрим архитектуру файловой системы Прошу прощения вот тут сейчас будет сложно но Извините в центре у нас наши структуры данных эти структуры данных под капотом любо в принципе фа они объединяются единую структуру сообщения сообщени это два как минимум файла письма заголовки и тело То есть это две идд вокруг этих структур данных У нас есть ошки которые предоставляет таран поверх них мы сделали свои обёртки Ира у нас Кстати этот воо схема получается полностью stateless я говорил в начале что мы берём письма в аренду и получается что если нл шница нам на самом деле не обязательно сохранять текущее состояние а письма просто в индекс вернутся По истечению аренды так вот вокруг внутренних пишек Тарантула мы своей обёртки сделали А курл - это хттп клиент для нашей зеп а Box - это опиш Тарантула для работы с данными непосредственно мы её обернули вот своим файм модулем ТНТ кто работал с Сиран там нужно много дить декоди Маков этот модуль отвечает собственно за сериализации десериализации при общении с боксом и вокруг нет бокса мы построили MQ клиент чтобы ходить в наши индексные тарантулы вокруг наших внутренних Оше у нас строится модель данных Data layer в парадигме ддд это вот собственно модель набор тех кейсов которые мы можем делать с нашими письмами и к этой модели можно получить доступ двумя способами способ номер раз через файловую систему тот самый rpc сервер о котором я говорил у нас крутится долгоживущая рутина в фоне она в не блокирующей манере пот соединение с модулем ядра вычитывает запросе собственно и сериали ответ при этом большинство подавляющее запросов у нас выполняются синхронно потому что они не блокирующие вот та самая напрямую с боксом то есть мы не делаем системных вызовов чтобы не создавать обратных связей в духе файловая система Сама решила заин письмо поэтому сделала си сама к себе и вот через use значит ДРВ работает как-то с сообщениями это ну довольно Сложно даже звучит поэтому мы реализовали способ без получается системных вызовов работать с боксом напрямую какие-то см ограниченным набором операций и этим высокоуровневым апе у нас пользуются ещё две долгоживущих рутины это коню который берёт письма в аренду и deadline keer который следит за тем чтобы аренда не истекла а при этом в сборе система выглядит вот так то что мы хотели получить Давайте посмотрим что получили в итоге у нас посередине две базы тарантулы и зеп работает со всем этим файловая система MFS которая стоит м сзи вот собственно то что посерединке получилась наша распределённая очередь при этом от паттен продюсера Мы в итоге вообще отказались на данный момент мы вернулись к тому что у нас было изначально у нас один экзим и пишет в очередь и доставляет из очереди То есть он получился потоковый процессором при этом MFS потому что и пото письма те Прив к пово в су проще в облако задеплоить и Почтовая очередь у нас порро 60 реплика сетов то есть 60 мастеров фактор репликации X3 Давайте посмотрим как на отказ система себя ведёт у нас в случае отказа Зета мастера пов сделают MQ также xim письма у нас получаются глобально в двух состояниях либо Мы не успели отдать юзеру 250 Ок тогда юзер отвалится в случае отказа сода по таймауту и просто потрать своё письмо Либо мы отдали юзеру 250 ок и в этом случае у нас гарантировано письмо легло в очередь Поэтому экзим получаются отказоустойчивые и МФС МФС могут спокойно потерять Всё своё состояние индексы сами увидят что аренда истекла и разблокируют письмо для других клиентов у нас всего шесть цдо сейчас Поэтому в случае отказа цод у нас 1/6 нагрузки распределится между Закончили с разработкой буквально чуть-чуть про эксплуатацию Мы всю эту историю успели задеплоить в кубер и Самое интересное - это конечно файловая система в куре какое у файловой системы место в куре это там самое необычное относительно простого Stat приложения как это делают обычно если бы мы писали в куд общего назначения мы бы в поде через манифест либо напрямую либо через CL попытались бы себе получить объект persist volum clim у которого под капотом Diamond сем зап persist Vol plin выдающий во клей данного типа снимку билет по grpc общается у этого плагина в памяти есть структур данных persistent Vol и также плагин делает M файловой системы наконец-то мы до не добрались в какую-то директорию атом В общем ВС оче сложно но нам не нужно было роть общего назначения у нас задача проще вот у нас есть файловая система написана Нам её в кубе надо запустить Ну можно взять и запустить Мы в итоге остановились на этом варианте в целом у нас просто общий ВОМ у двух контейнеров в поде в который мы монтируем файловую систему работае смонтировать в тоже интересный вопрос потому что привилегированный Давайте бли режиме Какие проблемы есть во-первых нужен открытый профиль он открыт по умолчанию если не закрывали будет работать во-вторых Нам нужен доступ к девайс нано чтобы установить соединение с модулем ядра два варианта есть либо с може вять лю мы пробовали оба способа оба способа работают в ито нагина остановились дальше нам нужно и вот тут Гром среди ясного неба должен был раздаться потому что ни одна такое не пропустит это по сути рутовые права и тут мы вот такую волшебную команду применили ми ограничивает область видимости нашей файловой системы и ядро говорит такое Ну ладно если твой никто не увидит ты сам себя ограничил тогда можешь монтировать ВС что всё что хочешь у тебя внутри есть и у нас получается не вне привилегированном контексте мы смогли исполнить привилегированный и буквально капельку про мониторинг вот самое кастомное за чем мы следим вопервых выполняются в пределах 100 микросекунд потому что они не блокирующие когда мы только планировали к запуску систему звучали мнения что фьюз очень медленный запросы могут занимать секунды Ну в общем фьюз может быть достаточно быстрым чтобы экспериментировать в проде в топе два запроса которые сотни миллисекунд занимают Это потому что они ходят в сеть по нескольку раз но вот ну фш ходит в сеть Т не ходит в сеть но форгет асинхронный поэтому он может выполняться там сколько угодно по времени его направляет к нам не пользователь а ядро то есть пользователь ничего не видит от гетов Долгих ошибки у нас нулевая толерантность к ошибкам кроме вот этих двух мы их добавили в исключение это на самом деле не ошибки их может быть сколько угодно первая ошибка - Это lookup ответ directory семантика такая пользователь приходит сши а есть ли у тебя файл на файловой системе FS отвечает Нет такого файла Нет валидный ответ не ошибка слка тоже самое примерно юзер просит а Поставь мне пожалуйста блокировку на файл FS отвечает Нет он заблокирован другим файлом ой другим процессом приходи позже тоже не ошибка И последнее мониторинг сколько письма у нас лежат в очереди самая наша кастомная Метрика обращу внимание график с 99% начинает когда письмо ложится в очередь у него мы у него засека тайм та округляем до минут и триггерами считаем сколько сейчас в очереди писем которые легли в эту минуту получается такой массив счётчиков которое мы и инкремент и декрети они в итоге в ноль падают так вот этот массив счётчиков мы пуля в прометеус и смотрим строим распределение А сколько у нас сейчас в очереди которые легли там за последние 5 минут или за последний час и если письма лежат дольше 2 часов мы мониторим это ике разбираемся Приготовьте пожалуйста телефоны там дальше будут QR коды А я пока подведу итоги во-первых мы изолировали экзим от слоя хранения это нам позволило повысить отказоустойчивость и переживать отказы одного цода во-вторых файловая система слой абстракции между приложением и подсистемой хранения на нём можно реализовывать свою бизнес логику если вам хочется тан мы использовали в двух ролях как inor и как сервер приложений в обоих ролях нам было хорошо Он решает наши задачи F позволяет ускорить разработку файловых систем с ним можно экспериментировать в проде и нам позволил привилегированный си исполнить в не привилегированном контексте на этом У меня всё вот тут можно посмотреть все ссылки там на материалы на которые я ссылался Спасибо за внимание делитесь обратной связью Если у вас есть вопросы Я готов ответить Ну я просто Максим Спасибо большое а у нас есть 15 минут на вопросы и у тебя есть три приза поэтому пожалуйста запоминай вопросы может быть сложно кстати так а выбирай ты девушки помогут Здравствуйте спасибо большое за доклад У меня есть два небольших вопроса Вот во-первых вы упоминали что видимо продюсер тоже работает в режиме No w и если он упадёт то Ну где-то на сторедж может остаться мусор вот что вы делаете с этим мусором Хороший вопрос А это связано с архитектурой зеп зеп та у нас хранит э короче запись в зеп идентифицируется двумя 32 числами ба ID и ID баты ограничены по размеру и когда Бат закрывается на запись мы по индексу проверяем А есть ли ссылки на этот Бакет и если ссылок Нет мы удаляем Бакет целиком соответственно тут два кейса мы закрываем кейс первы сылка бы но она удалилась впи писали в индекс ссылки никогда не было оба кейса такой архитектуры удаления закрываются Спасибо И следующий вопрос Вот вы сказали что вот капсис админа это очень плохо на пугается сделаем ашеры и всё будет хорошо просто и там не знаю это классическая проблема если погуглить раз в какой-то промежуток времени не спейсы в линуксе ломаются там разработчики забыли какую-то проверку и возникает уязвимость которую срочно срочно па Почему и не пугает вот такая ситуация вопрос наверное к а не ко мне но мы согласовывали и наший ОК но тут короче есть ещё такой нюанс в куре те же самые используются и вот то что мы Аши руками позвали в современном кубе по п 127 такой же точно есть он делается на под просто нам Короче нам нужно кубер обновить чтобы за использовать нативный Ашер из кубера Спасибо большое Максим Большое спасибо за выступление отличный доклад У меня вопрос был следующий вот если мы хотим всё-таки избежать вот корень всех проблем то что вот отказ сода почему мы не можем допустим поставить перед всем этим каком-нибудь н или Каю другую прокси чтобы она вот получает запрос на вот человек пишет письмо она отправляет этот запрос дописывает там какой-нибудь либо заголовок либо ещё какую-то информацию с видом этого сообщения на несколько разных цдо Как только приходит Потом она они начинают обрабатывать это дело потом это попадает в редж и ред просто отклоняет с одним и тем же видом разные сообщения То есть мы избегаем ситуации то что у нас цод будет ну то есть если цо даже погибнет посередине то есть выруби свет если он поднимется заново он допустим записал это сообщение то оно дважды уже не попадёт в этот самый файловую систему и мы считаем что у нас как бы вероятность того что на скажут сразу дда но она плюс-минус это событие катастрофическое совсем то есть рассматривался такое решение Можно мне Ага спасибо каширу прокси предлагаешь правильно Ну плюс-минус да нет мы не рассматривали можем обсудить подробнее ответов накидку Какие проблемы во-первых нужно правильно выбрать ключ импотент это сложно во-вторых прокси ну нужно понять как прокси сохранит собственно это письмо то есть А ещё у нас трафика два разных Есть сный трафик есть шный трафик обще это тупо сложно и надо продумать А что будет Проси же тоже где-то стоит А что будет если у тебя откажет В общем там есть ряд сложностей Ну это да уже тогда обсудим всё Угу привет Спасибо за доклад а планируете mqf в Open Source Аа Пока не знаю у нас есть вот недавно ввели регламент как вообще согласовывать выходки в Open Source А я попробую предложить но как бы я тут не принимаю решение финальное Понятно спасибо просто кажется это будет хороший поспорить для Тарантула вполне возможно так о так хорошо да спасибо большое за доклад скажите пожалуйста вот вы не сталкивались с такой ситуацией достаточно распространённой просто вот ну банально для файловой системы раз Выра используете у вас в никогда не уходило были Локи но мы починили Понятненько Но Deadlock получается немножко друго немножко подругому он выглядит для клиентов клиент просто повисает и делов Есть два вида В общем подробнее в статье про Fuse в не уходило Ну наверное потому что у нас всё строго в памяти у нас tant in Memory Mod N и в качестве бэнда для содержимого мы используем mfd То есть у нас прямо честный лес как будто бы тут нечему особо уходить в ron Может может пока ещё не словили такую и не было желания у вас потестить Ну не для Писем не для икма а для чего-то ещё вот эту файловую систему А гипотетическое желание есть но надо найти хороший кейс то есть здесь основная польза от файловой системы не в том что она как-то эффективно с файлами работает А в том что она позволяет свою бизнес логику внедрить и у нас допустим имы видят не очередь целиком а каждый свою часть на которую он взял Аренду Да там там просто получается что им он же насколько я помню всё равно не асинхронно скидывает на файловую систему данные а синхронно синхронно Ну при получении письма синхронно Всё спасибо там там бывают ещё апдейты в данные про них не возьмусь сказать но на получение письма точно синхронно Ну вот да вот такие ситуации могут возник в целом какие-то я понял спасибо Добрый день спасибо за доклад Вот в начале девушка Будьте добры микрофончик На первый ряд мужчина очень долго хочет задать вопрос Да вы в начале доклада сказали что письма делятся на по очереди на две части То есть это частные письма и рассылки то есть рассылки немножко придерживаются И вот вопрос в том что рассылки как правило идут это практически всегда там одинаковые письма Есть ли какая-то оптимизация в том что на хранение к примеру одно письмо и на него разные указатели в очереди И следующий ещё вопрос по поводу очереди по рассылке Идут ли такие вот рассылки они с пулом одним отправляются или они разбросаны по очереди А смотри по поводу придерживаемся Или например приоритет при он имеет место быть и нам как бы интересно копнуть и в эту сторону тоже А по поводу дупликации на рассылках сейчас дупликации нет на рассылках и мне кажется мы не очень много выиграем от этого То есть как минимум тела может быть имеет смысл дупли Нони маленькие по объёму заголовки дупли не получится они уникальные и рассылка обычно идт не один и mail на кучу получателей так делают Но в основном типа когда в опенсорс идёт общение например а коммерческие рассылки они обычно на каждое на каждого получателя отдельное письмо чтобы не полить имейлы в поле отправителей вот поэтому дедупликация логичная логичная оптимизация пока у нас нет У нас есть дедупликация на хранении Аче вот там это даёт большой выигрыш такой вопрос Что будет с письмом если в момент записи на файловую систему одна из баз будет недоступна то есть либо зта либо Да смотри отдадим временную ошибку юзеру чесотку юзер порат письмо на приём Вот это если пря недоступ вообще подразумевается ф овером поэтому там ошибок должно быть немного а в случае с диамил Письма к шардам никакими гвоздями Поэтому если у нас вот Тарантул недоступен на запись мы можем в другой шарт очереди положить и вообще без проблем прибивать наверное будем Но не к физическим шардам а скорее к логическим каким-то типа шарт вот вот такого так можно да соответственно вопрос Коли вы затронули информационную безопасность больше не к реализации Да а больше каким-то смежным процессам информационной безопасности А в частности к таким решениям Как там DLP песочницы и прочее то есть предусмотрено какая-то интеграция которая позволит или будет позволять прерывать отправку писем если в них будет находиться какая-то некрасивая вообще таким занимается антиспам у нас то есть мы просто сходим в антиспам антиспам скажет Ага в этом письме некрасивая аяка не доставляете его Ну в этом случае это как бы ваш какой-то в ваш стек приходит ответ что не доставляете Дада и очередь сбрасывает просто это письмо и отдаёт ответ какой-то клиенту Да смотри как как это получится если чаще всего антиспам отбивает прямо в сессию то есть на приёме письма тогда письмо из очереди просто удаляется Мы в сессию отвечаем Нет мы такое письмо никогда не примем отправитель Иди нафиг второй вариант Если вдруг Мы приняли письмо А потом антиспам нашёл что это бяка но письмо ещё не доставлено А тогда мы антиспам нам даёт код ответа Мы удалим письмо с файловой системы файловая система в очередь ответит что письмо типа доставлено и отправителю отправит другое письмо с отм о не доставке типа мы в процессе доставки нашли что это бяка не будем доставлять есть ещё третий вариант если письмо было доставлено нашему пользователю и антиспам потом нашл что это бяка в этом случае если письмо ещ не было прочитано антиспам может прямо Из ящика удалить письмо получается антиспам работает для Ну с обоих сторон как для входящей со стороны соответственно клиента так и для входящего к клиенту насколько я помню Да спасибо Вот А вообще там на случай аварии ещё наверное имеет смысл предусмотреть ручное Удаление из очереди вот тоже работаем в этом направлении Да вот тут вот вопрос был Спасибо классный доклад Вопрос такой скорее общего характера шесть дата-центров довольно большое количество Интересно насколько сильно территориально разнесены ну и соответственно задержки сетевые между ними и совестно см того что от какого-то количества инстанций Тарантула Да при отправке ожидается подтверждение Сколько в итоге получается задержка именно записи Ну в среднем э письма файловую систему там Я помню был слайд не успел разглядеть и тоже Маленький вопрос Сколько по времени писали очень интересно Аа так а для начала про цоды про цоды ответить не готов Аа не согласовывали в общем да В основном Москва санкт-петербург как бы не сильно они у нас разнесены э среднюю задержку не скажу знаю что у нас есть один цот в котором там плюс 6 миллисекунд задержки Ну соответственно где-то вот такие порядки получаются А про письмо на графике был дено процентиль А запись письма занимало там типа сотни миллисекунд в девяностом процентили на сторедж Я думаю что можно быстрее мы пока ещё не оптимизировали этот момент чисто на поход в Тарантул у нас занимает десятки миллисекунд типа 50 миллисекунд может что-то такое вот у нас просто ну не было пока цели заниматься оптимизацией скорости приёма письма почта она нен оптимизирована она больше сру оптимизировано и ещ какой-то по времени сколько писа интересно В смысле какой Ну вот я понимаю что это там как-то по этапам Да но вот от момента когда родилась идея А всё сколько разрабатывали систему где-то 3 года но у нас было не очень много ресурсов на разработку система то есть мы параллельно в команде делали ещё большие проекты то есть мы там на астрим переезжали рейзи 6 лет 6 лет дифа сейчас вот там ещё большие проекты доделываем Круто Спасибо Максим можем взять ещё один вопрос лаконично да О спасибо за доклад подскажите а вы как-то защищайтесь от повторной отправки писем Ну то есть продюсер прочитал что нужно отправить и упал А смотри на индексах У нас есть ключи идим патентно Вот то есть условно если у нас продюсер пошл в индекс записал письмо не успел Вычитать ответ сходил ещё раз в этом случае дубля не будет да если у нас совсем продюсер упал А письмо успело записаться в индекс Мы не успели дать ответ пользователю и пользователь е раз отправляет письмо с нашей точки зрения этова разма оно будет доставлено два раза получится очень сложно здесь выбрать как бы грамотный ключ импотент потому что там стандарт ничего не предлагает насколько я знаю в этом месте условно два письма с одинаковым телом во-первых у них точно будут разные заголовки А во-вторых даже если тело одинаковое в разных ситуациях это может быть как одно и тоже письмо так ива раз то есть ну нет от такого не защищаемся Спасибо Максим три вопроса Выбирай и Пожалуйста говори кому что чтобы у нас две два подарка от вас от ВК и один подарок - это кастомная матрёшка она большая а в ней нет матрёшек вот их надо будет собирать на следующих хайдах Так у нас от нашей компании будут футболки а почтовые поэтому лучшее вопросы для футболок выберем Давайте самые связанные с почтой а мы точно общались про антиспам с кем мы общались про антиспам так а-а про что ещё мы общались Так давайте матрёшку матрёшку мы общались про задержки хайло задержки - это сюда так и ещё один почтовый вопрос Давайте про дубли дубли писем распространённая ошибка вот которая мы всячески стараемся минимизировать Спасибо большое"
}