{
  "video_id": "O247Hq3ego4",
  "channel": "HighLoadChannel",
  "title": "Как смигрировать 50Пб в 32 без даунтайма? / Альберт Галимов, Андрей Сумин (Mail.ru)",
  "views": 1654,
  "duration": 3633,
  "published": "2017-04-22T14:48:24-07:00",
  "text": "давайте я представлюсь я технический директор почты и вот так стоить да да технический директор почты и сегодня Вам расскажу как мы избавились от некоторого количества питат но сначала хочу ра сказать две важные вещи во-первых не я автор решения основной разработчик сидит вот здесь ни писать интереснее чем рассказывать поэтому эта честь досталась мне а второе так как я немножко знаю про почту ко мне очень часто после докладов подходят и говорят вот наша сайт наша система посылает пользователям Нару письма вы их кладёте в спам Если у вас есть такие вопросы можете подойти Мы со всем разберёмся просто чтоб Как бы вы не задавали эти вопросы так как они не в тему доклада А так разберёмся всё решим и предлагаю соответственно начать Если кто-то ещё подойдёт Надеюсь что они попадут в контекст Давайте вообще поймём о чём мы говорим первое что наша почта состоит вот из таких кусков это 50 пиб 15 из них - это тела писем то есть вот те самые тексты которые пишут пользователи и индексы потому что нужно общаться с письмами соответственно есть некоторая система индексации письм она тоже занимает несколько петабайт а остальные 85% это файлы которые прикреплены к письмам Как вы наверное не один раз слышали сегодня во время разных докладов некоторое время назад у нас случилась беда с рублём или или с долларом Кому как больше нравится мы доставляли кажы день она очень сильно возросла И нам захотелось подумать А как мы вообще можем решить эту проблему Ну исходя из этой картинки очевидно что нам нужно работать с файлами на момент 2 года назад у нас файлы лежали вот прямо один к одному В смысле к письму и не было дупликации естественно первое что мы решили сделать это посмотреть А сколько нам принесёт дедупликация по нашим примерным посм Это было около 40% вот этой вот красной полосочки чтом мы рели попробовать сделать эту систему Давайте попробуем е вместе с вами сечас спроектировать первое что нам понадобится это Мета информация о файлах Потому что раньше когда у нас было соотношения Ну грубо говоря соотношения писем файлов один к одному У вас есть письмо в нём находится информация файле и никаких больше проблем нет вы знаете где у вас лежит файл Где у вас находится письмо вам нужно промежуточное звено в виде базы данных и нам конечно же хочется чтобы письма открывались быстро работало всё молниеносно Поэтому Сможем ли мы сделать базу данных такой чтобы она помещалась в памяти поэтому Давайте попробуем в неё поместить для начала всё самое необходимое будем тут слегка оригинальными назовём уфан инто имя файла идентификатором быть не может бегаю наверно да хорошо имя файла идентификатором быть не может ну по очевидным причинам если кому-то не очевидно подходите расскажу поэтому мы взяли в качестве идентификатора файла ша от его содержимого это целых 20 байт по-моему Кози них проблем с этим нету дальше У нас есть много писем пользователям приходит какая-нибудь рассылка в рассылке есть какой-нибудь а и соответственно у многих писем находится один и тот же файл соотношение много к одному Нам нужен счётчик Потому что когда мы получаем либо удаляем письмо Мы должны понимать а когда мы собственно можем удалить файл если не осталось ни одного письма кого есть э этот файл то наверное о лучше освободить место на диске потому что мы хотим это экономить вроде бы всё хорошо но тут возникает первая проблема у нас есть демон который оперирует с индексами писем а и пользователю пришло письмо А письмо есть файлом индекс писем на Stage Наоборот я перепутал у нас есть индекс с письмами и пользователь хочет удалить письмо а соответственно демон который работает с индексами писем посылает запрос на удаление на на storage на удаление на Stage и по каким-то причинам падает э причин может быть много ээ на самом деле Вот когда я только начинал не понял мня слышно потому что такое ощущение что микрофон не слышно когда я только начинал программировать у меня была такая идея что когда-нибудь я напишу софт более-менее нужный пользователям сделаю так что там не будет багов а потом поставлю этот сервер под стекло и всем буду гордиться Но вот прошло 15 лет что-то этого не случилось поэтому Что произойдёт конкретно в этом случае у нас запрос на удаление файла отправится а в индексе о том что файл удалён информация не сохранится после того как индекс восстановится мы сделаем ещё один запрос на удаление файла по тем или иным причинам и только после этого будет Возвращение что Да действительно файл удалён и будет удалено письмо в результате мы имеем следующую проблему Что Письмо было удалено одно а запросов на удаление файлов было два и счётчик если таких писем было два будет равен нулю хотя на самом деле есть ещё одно письмо у ещё одного пользователя где нужен этот файл Как нам можно решить эту проблему на самом деле можно очень долго строить систему в которых попытаться вот это вот всю историю разрулить Я таких систем честно говор Не знаю если вы знаете как это сделать не то что за короткое время просто за ограниченное количество времени найти вот такое решение которое решит все эти проблемы то приходите мы вас возм на работу Мы же пошли другим способом мы сде понятие как эта штука работает когда вам приходит пись с файлом то тот самый демон с индексами файлов с индексами писем к файлу Разде банево письмо То есть у вас есть текст письма есть файл он их разделяет рядом с текстом письмо письма оставляет о и здесь же генерирует просто генерирует рандомно ещё одно число тоже его запоминая и дальше когда он делает любые операции с этим самым файлом он отправляет дишни файлы в виде ш1 и отправляет этот самый Magic И что это нам даёт Давайте посмотрим Итак смотрим в правый верхний угол предположим что у нас уже есть файл и он уже принадлежит какому-то письму То есть у него счётчик один и Magic 345 То есть к письму один назовём его так был сгенерирован рандомное число с мком 345 тут нам приходит Ещё одно письмо читаем теперь слева направо Вот это письмо будет второе а и индекс отправляет запрос на загрузку файла с индексом ш1 и со своим рандомным сгенерированный мэджи ком в виде 123 на сторедж мэджики складываются получаем 468 каунтер тоже складываются получаем два что же происходит Дальше а предположим Мы хотим удалить второе письмо А мы посылаем запрос соответственно с айдини ком файла с тем же самым Magic ки опять вее не опять теперь из одного вычитается другой то есть из текущего пришедший он становится равным 3445 и каунтер уменьшается на единицу Если вы заметите у нас Magic стал опять равен 345 Это означает что данные у нас консистентные и каунтер равен единице Теперь если всё хорошо и удалилось первое можно удалять А если же у нас была ошибка то есть допустим запрос на удаление файла с второго письма пришёл два раза жики у нас Magic в виде 123 отнялся дважды и стал равен быт 222 а каунтер при этом нулевой в этом случае мы понимаем что у нас данные находятся в некон систентки Ну и чтобы док до конца соответственно при удалении самого первого письма у нас ситуация не меняется Если быть честным то Magic - это и он будет там переполняли с чем-то но просто э цифра сюда не влезет Я решил записать так надеюсь что вам понятно Вот тепер имеем роши спосо можем почему там как-то восстанавливать консистентность эта операция довольно дорогая Но по крайней мере нам не нужно очень много памяти чтобы хранить информацию о том потеряем мы данные пользователя или нет это всего-навсего 4 байта А все любят флаги без них к сожалению никуда поэтому мы на всякий случай добавляем 4 байта Ну хотя бы просто потому что вы хотите какой-нибудь файл пометить неудаляемый вот у вас случится такое поэтому по нашему опыту скажу что 4 байта много но меньше 4 байт сделать довольно проблематично дальше нам нужно знать где собственно файл лежит так как у нас система распределённая это д два пишка в виде двух машин это два номера диска на каждой машине по по диску и Казалось бы можно так оставить но есть нюанс у нас файлы не очень большие а диски уже большие и в среднем у нас на диске лежит около 2 млн файлов соответственно если мы оставим в таком виде то у нас получится вот эта пара в виде шника и диска айпишник и дисков будет 2 млн раз повторяться в памяти что не очень хорошо можем эту ситуацию немножко сократить А уносим их просто в отдельную таблицу на их месте оставляем айдини из этой таблицы тоже четыре байта тоже не очень много Ну и конечно же в этой самой таблице у нас будет находиться информация о дисках с айдим дисков плюс конечно же флаги Вы тоже захотите туда что-нибудь записывать Например если у вас пара пару понадобилось поместить в режим ron вот что-то там случилось с одним из дисков мы позже будем это рассматривать и лучше туда сейчас ничего не писать Вот как бы на всякий случай разобраться что случилось а потом уже решать что делать с этой парой Ну и конечно же нам нужно выбирать при поступлении очередного файла в систему Куда заливать эти данные а Для этого нам вообще нужно понимать а сколько на паре свободного места здесь Ф1 это соответственно свободное место на диске но на диски о вроде бы всё то есть всё что нам нужно мы рассмотрели Давайте посмотрим помещаем ли мы в память используем 1 для этой системы я Настоятельно сою вы будете писать что-то своё использовать Тарантул конечно же поновее там он побыстрее и в плане памяти слегка получше но там принципиально вот здесь это ситуацию не меняет У нас есть пять полей самое большое соответственно это идентификатор файла и четыре поля по 4 байта у нас получается 36 байт данных Казалось бы немного но это неправда на самом деле их не 36 так как это система хранения дан тарантуле в бинарном виде то нам нужно ещ по одному байту на каждое поле чтобы знать Какова длина поля то есть ещ плюс 5 байт получается на каждую запись о каждом файле и сам Тарантул ещё имеет 16 байт заголовков к каждой записи системная информация что там в этих 16 байтах Может рассказать Денис который сидит в первом ряду Я подробности К сожалению То есть я узнавал нос точно не расскажу Итого у получается 57 байт на каждый файл файлов у нас 12 млрд умножаем 57 бай на 12 млрд получается 637 ГБ то есть 637 ГБ данных и служебной информации это конечно же не всё Нам нужно искать по этим файлам индексное поле у нас идентификатор ш1 А на каждую запись нужно примерно 12 байт Ну на каждую проиндексированную запись нужно примерно 20 20 бай записи у нас всё тех же 12 млр получается ещё 179 ГБ уже чуть больше то есть всего всего получается где-то 800 ГБ 637 - это данные со служебной информации 179 индекса Но это ещё не всё Мы же строим надёжную систему поэтому нам нужна реплика получается 1Б влом на самом деле не так стно потому что по 256 бай по 256 этих самых гигабайт оперативной памяти а оперировать они Бут с индексами размер которых исчисляется там десятками петабайт и хранится на жах которых около 3500 поэтому как бы в таком соотношении восемь машин не так много можно себе позволить можем конечно ещё посчитать prb но дисков всего около 30.000 это если разбить по парам 14000 записей это на сколько получается на порядков меньше чем фаб куда-нибудь засунем её считать наверное нет смысла Вот первую часть мы рассмотрели информация у нас помещается в память значит всё будет работать быстро если не упр в цпу Ну как бы по работающей системе скажу что в цпу не упр И основная у нас будет проблема Как разно которую надо было решить это память она решена Давайте смотреть что будет происходить с системой дальше в принципе она построена довольно Ну если высоко уровне смотреть несложным образом в том плане что есть несколько машин с лоуми То есть можно в любой из них сказать я хочу загрузить файл и или попросить забрать файл А за ними уже стоять Раджа и лоде между ними распределяют получаемые файлы и конкретно у лора должно быть AP если мы вернёмся и подумаем что когда у нас была система один к одному то есть одно письмо один файл всё было легко загрузить файл удалить файл но у нас один ко многим поэтому мы на самом деле однозначно не можем сказать надо ли сейчас загрузить файл Или надо его сейчас удалить поэтому AP у лоде будет такое увеличить счётчик к Вам пришло письмо в нём есть файл но само письмо не знает ели такой ф настороже или нет Поэтому оно по умолчанию посылает команду увеличить счётчик у файла если такой файл в системе уже есть то есть лодер найдёт его файл db поймёт что он есть увеличит у него счётчик что да появился ещё один потребитель у этого файла и ответит что всё счётчик увеличен Если же файла нету то будет в этом случае ошибка и нам нужно файл заливать операция нетривиальная через пару слайдов мы будем рассматривать в подробностях а ну и соответственно если файл у нас не нужен то нам нужно только уменьшить счётчик удалять файл можно или нельзя Мы не знаем мы только знаем что в этом письме этого файла нет А сколько ещё таких писем это нужно уже смотреть по файл db А ну и самое простое Что может быть в этой системе собственно Дай мне этот файл зачем мы всё это вообще делаем в нашем случае это просто ш иес где указывается имя файла Итак давайте теперь вернёмся к процедуре Up Она довольно мутона она у нас происходит по внутреннему протоколу апта можно про него спорить можно про него нет Можно про него не спорить но он достаточно простой и на примере загрузки файлов мы его сейчас и рассмотрим у него есть первая часть где есть SY - это идентификатор команды То есть когда мы посылаем запрос нам потом отправляют ответ и по Син мы собственно понимаем что ответ относится к конкретному запросу cmd - это конкретная команда то есть в нашем случае это Up ин - это длина всего пакета так как мы знаем конкретную команду мы мы знаем и длину заголовков у этой команды поэтому мы пока вот из сокета вычитывает в которых находятся заголовки Ну вот информация которая находится в заголовках конкретно сечас нам интересует нас интересует то есть длина файла Потому что сейчас нам нужно понять а куда мы будем файл заливать а выбирать Куда заливать файл можно довольно простым способом и эффективным это мы берём все пары смотрим какой у них свободное место на каждой паре и отрезок выстраиваем в ряд друг за другом у нас получается один большой отрезок предположим у нас там свободного места всего 100 100 мб соответственно это число там допустим от одного до и берм на этот большой отрезок равномерным законом случайным кидаем случайное число то есть выбираем случайное число по равномерному закону от нуля до 100 вот если нам выпадает 75 то вот в нашем случае на нашем слайде Это скорее всего третья пара если не знаю если 30 то скорее всего вторая соответственно чем больше свободного места на паре тем больше отрезок он занимает на Вот это на вот этом большом общем отрезке и тем выше вероятность что система его механизм очень эффективный но у него есть проблема Представьте что вы взяли два совершенно свежих диска содрали с них плёночку в этом случае так как они абсолютно пустые если не дай Бог там ещё 8 или 10 раба вероятность того что это можно получить ситуацию Когда весь входящий поток пытается залить на этот диск эффективное решение тоже довольно простое берём корень Ной степени от свободного места таким образом Он слегка ужи мает свободное место на дисках позволяя выравнивать эту историю и не убивая диски новые диски по Асам так как там очень много свободного места но сохраняет сво свойство то что чем больше свободно на паре тем выше вероятность что эту пару выберет система в качестве загрузки нового файла и таким образом чуть дольше будет сходимость но всё равно система сойдётся к тому что все диски будут заполнены равномерно что собственно нам и нужно Итак пару мы выбрали А у нас если помните висит Всё ещё в сокете ipra Мы вычли оттуда вычитали оттуда только заголовки дальше идёт контент файла и надо бы этот файл уже на эту пару заливать но лодер у нас стримит данные означает что если мы начали стримить данные на вот эту пару дисков то тут у нас уже как у сапёров если у нас что-то обломало то пользователю мы можем выдать только ошибку поэтому мы на всякий случай делаем здесь ещё одну проверку а именно берём отправляем на эту пару небольшой фа 4Б разме ефа Окей что да Всё всё нормально По крайней мере мы знаем что вот прямо сейчас эти диски живы прямо сейчас мы смогли на них залить какие-то данные и скорее всего файл который сейчас пользователь пытается залить мы благополучно на эту пару зальём и начинаем собственно вычитывать дальнейшие байты из сокета ш1 считается на литу дальше у нас только контент файла мы его пытаемся залить на выбранную пару Итак вот у нас вот э вот система из лоров которую мы только что рассмотрели демоны которые пытаются Ну получают письма пытаются залить файлы могут ходить на любой из них там Робином они уже по конкретной по конкретным алгоритмом выбирает пару Куда нужно залить дальше у нас собственно Раджа несколько тысяч и они уже должны физически ласть файлы на Дик для рение это выпендриваться не нужно но есть как всегда нюансы Представьте следующую ситуацию у вас на один лодер пришёл файл и он пытается его выбрал пару конкретны вернее конкретных пару дисков пытается на него на них залить файл ИТ приходит ВТО Сафа про отправили письмо двум людям на два письма пришли одновременно оба Лора спросили файл есть ли такой файл им ответили что нет файла нет но они спокойно начали их заливать и представим ситуацию что они его заливают на не то что на это самое на разный сторе а прямо на одну и ту же пару так вот случилось что пара выбрана одна такая тоже есть свободная пара то вероятность её выбрать выше чем у остальных Поэтому чтобы разрулить эту ситуацию мы применяем небольшой трюк вообще честно скажу так как у нас стоит инкс скорее всего сам инкс эту ситуацию корректно разрулит ничего страшного не случится но нам надо быть уверенным поэтому мы на самом деле файл заливаем не под именем ша а под вот таким хитрым именем на самом деле вот эти вот много цифр не пугайте это тот самый ша один есть а тут ещё есть нюанс чтобы файловая система Ну нормально себя чувствовала мы делаем два уровня вложенности Вот вы видите там 60 и 07 это как раз две папки А первый два символа из имени файла и вторые два символа из имени файла А вот таким образом у нас не оказываются папки где очень много файлов Итак р соответственно заливает файл не с именем ш1 а заливает с именем у которого есть in Progress и у которого самое главное есть вот э выделенная красным НМ за счёт этого два Лора при попадании на одну и ту же пару с одним и тем же файлом будут загружать их в разные имена А нам это важно потому что процедура загрузки она не атомарная и Мало ли чего вот а когда файл залит и loer получил от инса 201 он спокойно делает РНУ операцию и уже точно всё нормально И после этого когда второй лодер тоже залил файл свой НМ и сделал ещ одну операцию Ну файл перепиши Но это по факту один и тот же файл поэтому тут всё корректно лодер физически залил файл на диск но файло в системе всё ещё не существует потому что фай нет о НМ информации и тут тоже есть пара проблем Ну во-первых я сразу скажу что ви фа db есть такой в скобочках Space 0 вот у тарантула можно данные записывать в разные спейсы вот конкретно для живых рабочих и файлы которые нельзя удалять Мы храним sp0 у нас ещё есть С1 к нему вернёмся позже просто вот чтобы вы держали у все в голове работаем сейчас со Спей сом где живые нужные данные файлы которые нельзя удалять соответственно нам нужно сохранить информацию о том что файл появился в системе и чтобы в индексе соответственно при запросе этого файла можно было его найти скачать увеличить счётчик удалить и так далее и тому подобное но мы этого просто так сделать не можем Почему Потому что на предыдущем слайде Вы помните что у нас лоде два они соответственно залили каждый по своему файлу в пару дисков А и каждый из них после того как сделал операцию в инсе пойдёт в файл db с попыткой добавить файле Поэтому в тарантуле находится процедура которая Амар делает одну конкретную вещь вернее Амар делает одну из двух вещей либо увеличивает счётчик у файла если он есть либо добавляет информацию о файле если его нет соответственно Когда у нас появится второй лодер который чуть-чуть протор мозиллы файле который был загружен перед этим Таким образом мы соблюдаем консистентность кто-то наверное сейчас сообразил что у нас окажется на паре дисков А если вдруг лоде пошли в разные в разные пары дисков Вот здесь Да секунду вот здесь если лоде пошли не на одну пару дисков А на разные пару дисков то происходит следующее у вас приходит два письма они со попадают на разные лоде лоде загружают их на разные пары дисков а потом эти Лоры идут фа сначала пришёл один сказал что файл есть а потом пришёл второй и файл уже есть и увеличился счётчик и соответственно информация й db о том что на вот этой вот второй паре находится файл не окажется это будет некоторый мусор и как с ним бороться мы рассмотрим чуть позже Итак Теперь давайте подумаем как нам из системы файлы удалять на самом деле тут оказывается такой очень хитрый нюанс что нам вот важно для системы гарантированно записать файл поэтому мы с вами делали там столько проверок Сначала маленький файл отправляли на СТО чтобы проверить что диски живы нам нужно быстро отдать файлы это Мы тоже умеем держать метаданные консист замечательны позво это сде а вот удалять файлы физически с диска нам в общем-то и незачем то есть на самом деле если у нас индекс консистентные то удалять мы можем в оффлайне вот если кто-то из вас постарше может бы помнит был такой фильм про газона косильщика и там есть такая такая фраза что если на компьютере что-то удалили это не значит что его там нету значит Эми своми найти его уже невозможно но физический файл на диске остался его надо просто почистить это можно делать спокойно в оффлайне позволяет распределить нагрузку на диске и в принципе сделать это более-менее Осторожно Поэтому при удалении мы только уменьшаем счётчик и дальше мы начинаем работать со спем ость Удали с сошлись в Но значит у нас ВС консистентной Больше нигде нету И мы перемещаем информацию о файле из спейса 0 в сй 1 там хранятся кандидаты на удаления У нас есть Валькирия это такой демон который привязан к конкретному диску на сторе у него достаточно такая страшная работа он ходит по файлу Один за одним и смотрит что же с этим файлом нужно сделать То есть они просто вот лежат эти файлы на на диске в директории он их перебирает и решает что с ними сделать Итак встретил он очередной файл и спрашивают А есть ли этот файл в кандидатах на удаление в спейсе оди э если этот файл там находится то на самом деле мы можем попасть вот в такую ситуацию у файла счётчика Magic стали равными нулю лодер перенёс информацию о файле Space 1 в кандидаты на удаление но Валькирия до него добралась только спустя некоторое время за это время могло прийти ещё одно письмо и какой-нибудь лодер взял залил этот файл на какую-нибудь пару дисков соответственно в спейсе но у нас появилась информация что файл то уже живой поэтому Валькирии чтобы не попасть в такую ситуацию всякий случай проверяет файл ещё Space 0 но здесь у нас нет никаких гарантий Потому что если мы сейчас попытаемся файл удалить конкретно в этом случае случае могут быть обще Но вот конкретно здесь если мы сейчас попытаемся файл удалить то время между походом в тарантулом и удалением файла оно не атомарное И в этот момент всё равно может кто-нибудь залить ещё один файл поэтому на всякий случай Мы делаем rame R1 Del Это означает что файл кандидат на удаление та - это время когда мы решили что файл стал таким кандидатом мы его называем карантин что это нам даёт Если вдруг у нас случилось какой-то R Con или какой-то баг то и мы удалили данные пользователя скажем так не удалили А пометили на удаление по ошибке то мы в логах увидим 404 но файл ещ находится на карантине мы можем пользователю вернуть его данные пользователь на самом деле 404 не увидит но почему мы это рассмотрим чуть позже ну размер карантина мы как-то подобрали исходя из своих соображений и он может на самом деле меняться поэтому конкретная цифра не имеет особого значения Вот Но мы забыли про одну веь у находится фа специально прямо пометил диск ноль и диск один и на каждом своя Валькирия каждой лопати свой файл и эти Валькирии никак не связаны друг с другом они работают совершенно Независимо и возникает резонный вопрос А когда удалять запись Space 1 а связывать Валькирии друг с другом городить какие-то прям блоки Ну не очень не очень хотелось поэтому мы решили эту проблему Как нам кажется Лучше во-первых давайте сделаем так чтобы каждая из Валькирий для конкретного файла могла понять мастер она для этого файла или с делается Это довольно примитивно Валькирия находит очередной файл на диски Она исходя из информации db знает она на диске но или на диске оди э информация знает она берёт имя файла и смотрит какой Первый БИТ у имени файла ЕС вария на диске но Первый БИТ но она мастер если Валькирия на диске о и Первый БИТ о она тоже мастер в остальных случаях она является словом то есть Валькирия взяв очередной файл знает Она для него мастер или Она для него слей А теперь давайте Мастер и слей разнесём по времени Помните у нас в sp0 был такой Magic который был байта как раз а в сй он не нужен потому что там консистентность проверять не нужно поэтому мы при перее но в SP 1 запоминаем время этого самого переноса в этот самый Magic как раз 4 байта то что нам нужно а и разносим таким образом Валькирии по времени то есть сй делает всё то же самое что и мастер но ориентируясь на AMP Mag делать это просто позже и ровно по этой причине пользователь не увидит 404 если мастер нашл свой фай Space 1 и пометил его на удаление р прил на мастер А по умолчанию мы грузим файл сюда с мастера Ну чтобы распределить нагрузку прил на мастер файл Там не найдёт он пойдёт в с на сле мастер ещё не перенесён не переименован в и соответственно с этот файл спокойно отдаст А на Мастере мы увидим 404 увидим проблему начнём её решать Поль привит потому что по каким-то причинам мастер может ну не работать некоторое время вот просто остановлен демон Мало ли что а в этот момент слей Может соответственно как-то перевалить за свой за время своего отставания достать файл из Space 1 пометить его на удаление и грохнуть запись Space 1 в этом случае Валькирия на Мастере В какой в какой-то момент найдёт файл и об этом файле не будет записи файл db потому что из sp0 его ударил из Space 1 его удалила Валькирия Ну в принципе ничего страшного помещаем этот файл на удаление помещаем в карантин Если будут ошибки разберёмся где у нас бак или где у нас произошёл исправляем восстанавливаем данные Давайте вем е к этому слайду когда одновременно пота зать тот же файл но на разные пары дисков Помните я вам тогда сказал что Станется одна пара где будет лежать файл но в фа db файл этим ша о будет указывать на другую пару потому что второй лодер успел это сделать быстрее загрузил на свою пару и файл db оставил свою информацию о своей паре В этом случае мы ВС е парам на всякий случай им на где оказался фал проверяем что там файл считывается что он что у него валидный ша О что Он целый и только после этого помечает таки мы добрались до хорошей ситуации когда вария нашла фай который который нужен который недо Уда хни карантина ни кандидат на удаление она тогда спокойно проверяет его целостность но тоже Параноя на всякий случай идём на вторую пару проверяем что там файл есть потому что если вдруг там проблема со считывания файла надо срочно восстанавливать вторую копию вдруг что вот осталась самая плохая Но самая понятная ситуация у нас один из дисков оказался проблемным в паре да то есть не знаю там посыпался не читается или читается с проблемами второй диск срочно в read Only и все файлы со второго диска через те же самые алгоритмы просто раскидываю по другим парам А в эту пару уже ничего не пишем когда все все файлы раскидали но админ уже решат Что делать со вторым диском может быть его добавить в какую-нибудь другую пару или может быть тоже он плохой выкинуть в принципе это уже не принципиально А и что у нас Получилось Да у нас было 50 пиб данных из них 85% файлов оказалось У нас 32 пиб данных после дупликации то есть 18 пиб мы освободили А И это нам дало возможность в течение 3 лет не покупать новое железо и не тратиться соответственно на увлечение хостинга вот я готов с альбертом выслушать ваши вопросы на какие-то сможет ответить только он может на какие-то я Спасибо большое за доклад Скажите пожалуйста Насколько часто запускается вотр колектор который вы валькири назвали и насколько Ну в какое время и какой нагрузку создат на сервер запущен он время нагрузку ты не помнишь цифры Альберт у тебя у тебя там микрофон есть только включи его Он в принципе не останавливается он всё время прошёл по кругу по файлам и сначала Ало нагрузка очень маленькая там то есть буквально несколько файлов за за секунду он обходит То есть это всё регулируется админами там есть ручки чтобы задержка между файлами чтобы она диск не не перегружать Добрый день спасибо за доклад Вопрос такой А вы думали что-нибудь делать с файлами которые зашифрованы вот люди же загружают зашифрованные фай не до дублируются да Ну значит они у нас не доду и сейчас в симе Параноя Я думаю что скоро зарастёт обратно Так что Ну я думаю это ближе к облаку всё-таки а не к почте на самом деле Вот это дела там такая штука у нас 50% писем оставляется внутри то есть Поэтому на каждое письмо которое отправляется на половину 000 оно есть и во справно и уходящее и вот там было одинаково даже Ну это да ну при корпоративной мы смотрели вот если взять Вот если взять наш корпоративный домен В смысле кору у нас дубликат 75% там да то есть если здесь 40 там 75 Да ещё важный момент что помимо сэкономлено места мы же и раст тене поэтому там двойная выгода вопросов а для начала А вот вы 18 петабайт За какое время смогли сократить сколько м вот с того момента как вы это вели помоему Да а За какое время в плане разработки или перехода нет Вот вы разработку запустили отладить сколько вам понадобилось времени чтобы эти 18 петабайт убить Ну разработка где-то год и переходили наверное полгода чуть может больше 9 месяцев как-то так а хотел спросить насчёт нового закона с пакетом Яровой А как там прописано Вы должны каждую копию хранить как вот с удалением дуплин их файлов законом ровой Да ну просто как вы под Это построите я к сожаление не юристы поэтому не знаю как там прописано какая разница е фай она он как бы мято информаци Рая бы лежит у разных по ноёт Если е о удали Тода он Удали хорошо А ещё а вы не подсчитывали какой overhead будет в связи с тем что вы должны их теперь хранить дольше В смысле Всё вопрос всё так же про игровую да дадада А мы так и так будем хранить же нет Ну вы же их удалять не имеете права теперь нет ну о пока е Да как летом подписали проверили одобрили по нему уже судят насколько я читал новости я так могу сказать что пока у нас Никаких изменений в связи с законом не было сделано технических А и последний вопрос говорите Вы если у вас пара вылетает вы раскидывает на другие А почему диск диск в паре Да диск в паре А почему вы не используете Hot swop то есть ну запасные диски которые крутятся и на которые потом второй диск на другой машине жите нет в плане на одной машине чтобы Ред контроллер моментально как-то диск в простой тут Тут нет рейдов Понятно давай без таких прогнозов там ляется там Он ещё спросить что-то хоте можно извините Спасибо за доклад хотел спросить по поводу загрузки файлов То есть получается что клиент когда начинает загрузку Он загружает сразу нали хранилище так файл или сначала у вас создаётся запись фай db о том что появился новый файл с таким вот ша О нет нет запись создаётся только после того как файл загружен вот просто вы говорили что возникает сложность Con если сделать синхронизацию через F db это сильно повлияет на производительность то есть это значит Что вы добавляете запись db со статусом допустим uploading и у вас все другие запросы загрузку файла с таким же ш1 я понял Нет так делать нельзя потому что конкретно этот запрос может быть проблемным а у вас ещё 10 параллельно пользователей загружают свои файлы если первый оказался проблемным то все 10 что ли тоже вернуть с ошибкой а так ещё девять спокойно загрузят и всё будет хорошо Ага спасибо ещё один вопрос небольшой по поводу Вы сказали что вы загружаете файлы то есть пользователь стрима файлы на ваш сервер Вот какие технологии использу не Нет там там всё конечно чучуть сложнее у нас если говорим конкретно про почту есть ещё фронты а фронты Ну там AP почтовое оно работает как-то с пользователями и оно уже с этих фронтов идут в Лоры вот на фронтах файлы Там кстати ещё одно облако насколько я помню Да да там ещё Ну в общем для простоты на фронтах файлы давайте так ин складывает на диск а потом фронты через лодер стримят просто конкретно на лоух на дисках файлы не хранятся я понимаю Спасибо А вот вы не можете уточнить не получается не frontend J А вот клиент из браузера Он загружает файлы тоже подстрич Я спрашиваю большие файлы более там 10 гиб они тоже поддерживаются у вас или нет они поддерживаются но они загружаются У нас у нас как это если вы загружаете А есть нюанс много си принимают письма если говорим конкретно про Google допустим не больше 25 МБ насколько я помню поэтому когда вы в нашей системе формируете письмо мы вам даём сформировать письмо как письмо не больше 25 МБ что просто мы не знаем куда вы его отправите и вы можете его отправить туда где ну там сформировали письмо на 100 мб а Та сторона его не приняла А всё что свыше 25 МБ Мы загружаем уже в отдельное облако и в письмо прикладываем как ссылку соответственно конечный получатель гарантированно получит письмо и в письме будет ссылка он гарантированно соответственно откроет файл Спасибо Андрей Спасибо за доклад а такой вопрос почему мы бегаем Валькирии не по не по сй 1 в тарантуле А по диску То есть получается же много охеда потому что нам нужно проверять что файлы все живы у тебя у тебя фа потому что наиболее правильный способ найти мусор на диске это диск а не фай Ну ну да и второе у тебя если файлу не было обращений 2 года мы может быть там уже всё посыпалось давно поэтому нужно раз какое-то время обязательно чекать спасибо спасибо за доклад такой вопрос Вы говорили что на каждую запись файла вы сначала пишете 4 КБ То есть это на каждую загрузку каждого файла вы это делаете складных расходов на это нету то есть не проще ли там помечать там диск неживым Например если не удалось на него записать или Ну какие-то такое то есть тогда пользователь ошибку получит то что пользователь тогда ошибку получит вы предлагаете пользовательскими данными проверять диск диск жив или не жив э опасно Нет ну в смысле вы попытались записать не получилось попробовали на другой диск записать а лодер стримит то есть р положив копию на диск ждт ответа от если он ответит уже например 500 Да потому что диск стоит тогда уже Мы уже не можем никуда положить потому что он стримил данные он не хранит их памяти у себя Ну например если Ну в смысле выделить какой-то отдельный сервис который там каждую секунду грузит 54 кб и проверяет то есть там сколько-то сторедж например грузить раз в секунду по 4 КБ это наверное меньше запросов чем грузить на каждую загрузку пользователя на самом деле прокладка 4 КБ ничего не стоит потому что они всё равно по факту на диск скорее всего не лягут они будут в D pages на самом на самом бэнде Да и как бы задача этой операции проверить что он отвечает что он не ВД Only и что диск приучен на него есть права э на на эту папочку и так далее То есть не в том чтобы физический диск работает в него пойти вот ну то есть это не для упрощения Да а для какой-то надёжности Это для просто для того чтобы уменьшить вероятность ошибки скажем так понял спасибо Вот Следующий вопрос справа вот а Вы как-то стараетесь размазывать свободное место по дискам по что насколько я понимаю помимо того что надо загрузить файлы если это картинки скорее всего их надо ещё показать в виде иконок А кто-то это должен сделать соответственно нагрузка на диске только не на запись ещё а добавляется на чтение и процессорное время вот этим занимается те же самые сториджи или отдельная система какая-то которые всё равно нужно будет выключить как-то два вопроса первое распределяем ли мы нагрузку на диске Да конечно И как раз у меня был слайд когда мы с вероятностью Ну на которой я описывал как мы выбираем конкретный диск и соответственно Чем меньше свободного места на диске тем меньше вероятность что его выберут вот но постепенно диски они равномерно заполняются вопрос будет наверно скорее этого достаточно было или были перекосы по ресурсам нет перекосов у нас по ресурсам не было И второй вопрос ещё вот когда диск умирает и надо мигрировать файлы на здоровые диски это полностью ручная работа админов и тех база данных имеет доступ или какие-то инструменты есть не есть толы есть толы которые это делают есть туза которую админы запускают вручную потому что только админ может сказать что это как бы диск его не вернуть пока что то есть нет схемы какой-то автоматической замены То есть это условно говоря кнопка которая говорит все файлы оттуда идите туда и больше админ ни о чём не думает Да пока так самом поду ваше первый вопрос еци то у горя 10 раз раз то условно говоря 10 дисков Может быть 20 Там они они могут полностью выдержать всю как бы нагрузку на запись Ну просто если посчитать пото что там вся вся запись происходит линейно каждый диск там пишет там где-то 100 м в секунду То есть Ну вот прикиньте какой-то трафик Поэтому если из 3.000 дисков хотя бы 10-20 не полностью забиты то всё работает просто на моей практике у меня тоже есть в хозяйстве тоже по два диска в ноде Да и Валькирия у нас называется Инквизитор очень созвучно это умилило но были ситуации когда запускали но сервер на 36 дисков и он дох Просто я просто помню что бы такая они были как бы случайные То есть каждый новый Файлик Он падал куда-то случайно а непоследовательно в одну и ту же диру и там поэтому были как бы лишние и опции вот тут файлики падают более последовательно Ну на пустом диске Я бы ожидал что они также будут последовательно падать Не ну мы Ну мы вот проводили тесты То есть если в одну папку писать файлы просто подряд то они как бы туда туда ложатся лучше Ну то есть как бы меньше псом и второй ещ нюанс что в этой системе там хранятся только боль больше 64Б и у них средний размер где-то получается 1 Мб а а у Яндекса там в муке там как бы лежит Всё то есть там и маленькие письма и большие и поэтому Там как бы средний размер меньше Но по крайней мере вот так было лет ше назад сес что-то поменялось и как бы когда они больше то меньше иов плюс всё ещё идёт в одну папку случае это там от 1 меб в среднем до 800 МБ файлы поэтому Ну вот тогда по идее должно тянуть Просто вы Посчитайте то есть вот я прямо сам писал руками тест просто вот вы берёте папочку в папочку фигачит файлы 1 Мб там огромное количество и 100 мб в секунду диск даёт значит там где-то ещё Бат отдельно встре посмотреть можно посмотреть там вас нас там сравнить завершающую до гоночка вопрос А вот полный обход всех файлов на диске с целью их проверки существования в базе данных сколько примерно времени занимает А на полностью заполненном диске дня три ну с с чтением всех тел проверка Шей вот дня три где-то обход Спасибо Можно последний вопрос не боитесь когда идёт н ну не ресин а раскиды файлов с оставшегося одного диска а не боитесь ли ситуации что этот диск тоже может умерить и соответственно вы останетесь без файлов вообще то есть обычно Ну насколько я понимаю я конечно небольшой специалист в этом Но обычно используются Фактор репликации 3 именно по этой причине а не два обычно да Нет в смысле почему обычно у Яндекса тоже уже два насколько я знаю поэтому сейчас по-моему везде два И именно поэтому у нас постоянная проверка а вероятность У нас есть расчёта вероятности там она минимальна по-моему вероятность того что будет проблема именно на двух дисках именно на одном именно на двух дисках если они при как бы если пара прибита гвоздями в плане Они не смещаются между собой для для двух разных файлов тогда вероятность потерять из-за того что умрут два диска в одной паре она чем е Ну у вас смотрите у вас 30.000 дисков с одним диском случилась проблема И вам нужно чтобы во-первых Чтоб Чтобы Что случилось с файлом нужна вероятность что выпадет а его диск с проблемой это одна 1 / на 30.000 и плюс ещё и второй тоже выпадет это умножить ещё 1 де на 30.000 Если я правильно сейчас считаю вероятность на самом деле дата-центр полностью испарился то то Представьте себе что один дата-центр полностью испаряется и пока мы копируем данные из второго дата-центра в третий у нас естественно какие-то диски умирают Ну потому что они у нас просто так там умирают раз не знаю в день где-то или в два Вот и Да что-то можно потерять Но это при полном испарении дата-центра это ну вот на самом деле насколько я помню в с рейдом проблем больше просто потому что у вас вот система насколько знаю не показывает что на втором вот у вас есть два диска и на одном из них есть проблемы система вам скорее всего покажет Я просто как бы не системный администратор не покажет что на втором диске сбитые секторы пока она может читать информацию и вот здесь у Вас могут быть как раз вот вероятность того что потерять данные гораздо выше Спасибо за доклад вот такой вопрос Вы рассказывали как уходили от нов и так чтобы у вас гарантированно ВС это записалось но у меня вот в голове такой возник вопрос Вы с одной стороны пытаетесь записать там 4 КБ перед тем как заплатить файл И после этого вы по сути вторым АТП запросом вы заливаете уже основное правильно 4 4Б потом основной основной файл в в этот момент между этими запросами у вас этот ж может уйти вдо правда да но вероятность уже будет сильно меньше в этом случае что происходит уйти в имеется в виду потому что админ поставил в или потому что ну потому что там диск вылетел админ сделал А ну в этом случае будет как бы естественно будет ошибка и она ошибка вернётся к клиенту который который индексы письма и он тело тело Ача станет на месте он не станет его удалять из письма Вот то есть это некоторая как бы деградация с точки зрения цели уменьшения размера потребляемого места Да но файл остаётся на месте в письме тогда в этом случае до этого вы сказали что идёт идёт стриминг и это уже давайте расскажу систему целиком первое к вам приходит письмо Извне это значит и принял письмо и пока ему сторож не сказал что всё хорошо Он держит копию у себя на диске и даже если вдруг там спустя много попыток чего-то не случилось Он пошлёт отлуп в ту систему то есть по крайней мере пользователь будет проинформирован но это ситуация тоже какая-то край Космическая А вторая что это веб-интерфейс идёт и загрузка файла в этом случае у нас ээ такая же точная система оно отдельное но в этом случае у нас пользователь ещё на связи с нами и Ну то есть пользователь прямо сейчас сидит в - интерфейсе и в случае если прямо совсем у нас всё обломало мы ему покажем что не удалось загрузить файл попробуй ещё раз то есть тоже мы не не оставляем пользователя без информации о том что что-то случилось Благодарю вас просто вероят вот эта вот загрузка Она эту вероятность понижает просто в разы там ещё один вопрос это откуда прове Здесь всё ещё здесь Ага а вы уже переходите на SSD вообще доверяете SSD дискам или по старинке на хардах так дорого Ну я просто пользователь Amazon avs там Практически везде по дефолту SSD впаривают Ну тут конкретно для этой системы актуален размер хранилища не опции правильно и получается пря вообще дорого хорошо и понятно И вот вы говорили про карантины която потом разруливает это у вас что люди потом ходят и смотрят где Что накосячил это не случалось ещё раз там есть несколько фаз как бы параноика до этого слоя мы не добирались но как бы процедура проверки как бы всех индексов она реальна Просто она долгая дорогая мутор ная слава Богу пока не разу не приходилось её запускать на почте Спасибо M"
}