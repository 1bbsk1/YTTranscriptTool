{
  "video_id": "nduYZiFIInY",
  "channel": "HighLoadChannel",
  "title": "Импортозамещение BI своими руками / Владимир Сухов (Магнит)",
  "views": 62,
  "duration": 1436,
  "published": "2023-10-06T07:20:10-07:00",
  "text": "они магнит я представляю компанию магнит и мой доклад посвящен разработке нашей собственной биосистемы magreport которую мы выложили в свободный доступ с открытыми исходными кодами кому интересно пожалуйста скачивайте смотрите может быть допиливайте напильником или говорите нам чего вам там не хватает вдруг окажется что нам тоже этого не хватает им это с удовольствием это сделаем вот и будет нам и вам полезно ну для начала Давайте Пару слов про архитектуру Но это у нас клиент Северное приложение у нас нет десктопной версии бывают разные системы некоторые делают десктопную версию некоторые и такую вот у нас это чисто клиентная текстура в центре жалостендел он приложения написанное на спринги клиентская часть это браузерный Веб клиент на реакции написаны сервер взаимодействует с базами данных получают оттуда данные предоставляет их пользователю все достаточно просто и прозрачно в будущем вернее мы уже даже начали это делать Мы движемся в сторону кластеризации кое-что мы уже кластеризовали и это безусловно интересно и для разработчика и для тех сценариев которые открываются с точки зрения эксплуатации системы поэтому Мы надеемся что со временем архитектура немного поменяется и станет поинтереснее ну и посложнее соответственно Ведь у меня таймер не идет Итак вообще биосистемы они совершенно по-разному могут быть устроены И вообще говоря не взаимозаменяемые они не с точки зрения функционала которые не предоставляют пользователей с точки зрения место в экосистеме которые они могут заменять могут оказаться совершенно не взаимозаменяемым поэтому давайте я обрисую общую схему работы магрепорта чтобы было понятно На какие сценарии работы он ориентирован Ну и где может быть полезен где может занять свое место Ну когда человек выполняет отчет Что делает человек с обычной вот биосистемой системой отчетности Он выполняет какой-то отчеты потому что с ним делает когда человек выполняет какой-то отчет в первую очередь параметры этого отчёта и делают это используя традиционные такие элементы биосистемы фильтры в мире систем Вот они называются фильтром их тоже называем фильтры фильтры бывают разные бывают автономные фильтры Ну там например Календарь Да ему ничего не надо он сам по себе календарь и всё этот фильм который взаимодействуют с базой данных для того чтобы наполнить вот свой справочник и дать пользователю что-то выбрать таким фильтром крайне желательно взаимодействовать с быстрой BD Ну то есть когда человек выполняет отчет он может нам подождать некоторое время когда он заполняет что там интерфейс ему конечно нужен очень быстрый отклик ну и соответственно Вот это одна из там вещей которую нами предусмотрены которую Настоятельно рекомендуем использовать это разделение инстансов Ну разделение коннектов баз данных для справочников для фильтров и для собственно самих отчетов дальше в игре получает то что выбрал пользователь и облекает это в какой-то вид запроса к базе данных и отправляет этот запрос базе взаимодействию с базой получает данные сохраняет полученный кусок данных у себя на дисках и дальше вот с этим объемом данных предоставляет возможность работы пользователю тем или иным способом Давайте посмотрим каким именно таким способом традиционный сценарий под который вообще создавалась система это выгрузка в Excel люди любят работать с Excel это нормально и это до сих пор доминирующий сценарий там есть предусмотрен некий стандартный шаблоны экселевский в котором по всем выгруженным полям создается пустая Сводная человек с удовольствием Потом сидит сводный что там делает можно для отчетов предусмотреть кастомизированный шаблон Когда вы добавляете какие-то элементы в Excel там листы с размеченными уже с водными с графиками с добавлять макросы формулы какие-то и так далее В общем позволяйте пользователю получить обогащенный Excel файл и работать уже дальше с ним но другой сценарий который сейчас нам представляет для нас наибольший интерес находится в фокусе нашей разработки это работа со сводной непосредственно в самом макреке в интерфейсе самого мог репорта и таким образом реализация полап запросов которые идут со стороны этой сводной к серверу Мы не сразу к этому пришли вообще мы не сразу пришли к тому что нам это надо все-таки потом решили что надо И сейчас все весь наш фокус разработки в основном на этом сосредоточен Потому что с нашей точки зрения Ну во-первых это для разработчика гораздо более интересный сценарий чем предыдущие А во-вторых это то что позволяет Ну вывести анализ данных на несколько иной уровень потому что у вас тут включается разные такие вот облачные вещи пользователи могут делиться друг с другом выполненными отчётами делиться друг с другом конфигурацией полученных данных то есть уже взглядом пользователя на тот объём данных который он получил в ответ человек может поделиться своей конфигурацией тем самым оно происходит какое-то взаимодействие совместная работа пользователей на совместный анализ пользователями одних и тех же данных и на мой взгляд это очень здорово и перспективно мы сейчас сосредоточены на этом с точки зрения разработки так и с точки зрения Ну популяризации среди наших пользователей этих возможностей Ну и третий сценарий это просто рассылка там отчетов по почте это традиционный Ну и важный сценарий для систем отчетности но с точки с технической точки зрения он мало что добавляет для первых двух сценариев поэтому это просто вскользь про него упомяну Давайте подсвечу какие-то ключевые технические моменты которые с нашей точки зрения представляют наибольший интерес Ну и по которым мы прошлись в процессе разработки и которые которым периодически приходится возвращаться то есть вот что-то сделали до какого-то уровня потом там на другой переключились понимаем что в этом месте которое было доведено до определенного уровня нужно что-то еще доработать возвращаемся в общем мы по вот этим вещам до сих пор ходим первая вещь Это Запрос к базе данных как система делает Запрос к базе данных это Краеугольный Камень всех биосистем сейчас я на следующих там слайдах чуть подробнее про это расскажу дальше следующий момент это то что называется концепцией фильтров безопасности Но это известная концепция в мире биосистем Она позволяет ограничивать пользователя на уровне данных работая с одним и тем же отчетом разные пользователи видят разные данные Ну в том смысле что они каждый свой филиал например или свою товарную категорию потому что у него есть права Вот только на этот филиал или только на эту товарную категорию и тут возникает несколько концептуальных и технических вопросов во-первых разработчик который разрабатывают отчет он вообще-то не должен задумываться кому какие права должны быть предоставлены он в принципе должен понимать что там могут быть разграничения по правам но он не должен задуматься Кому именно что а с другой стороны администратор Ну или человек который отвечает за эту систему прав за безопасность он не должен думать Каких именно что-то это должно быть применено То есть у нас есть некие две точки управления мы должны сделать независимыми но при этом чтобы они образовано работали Вот Но это одна из тех вещей которые нами соответственно сделаны и на наш взгляд достаточно неплохо второй момент заключается в том что конфигурации вот этих прав их может быть в принципе столько же сколько пользователей Ну кому-то доступен один филиал кому-то другой кому-то оба эти кому-то один из тех еще другой и так далее То есть вообще говоря это могут быть тысячи различных конфигураций и управлять ими вручную в общем-то невозможно поэтому должна быть какая-то система автоматического управления этими правами на основе каких-то данных которые где-то ведутся более того эти права они ещё и со временем эволюционируют сегодня пользователи там директор но филиала Завтра вы там повышают директора округа и так далее вот поэтому всё это должно динамически меняться и должно быть просто и удобно в управлении мы это сделали ну и ну в общем это одна из тех вещей которым мы гордимся дальше наша система не самая высоконагруженная система в мире но тем не менее определенную нагрузку конечно она претерпевает и с этим надо что-то делать и там разные есть уровни нагрузки во-первых нагрузка на саму систему а во-вторых нагрузка со стороны системы на базе данных Ну соответственно и то и другое надо уметь как-то ограничивать этим управлять соответственно у вас появляются пулы коннектов к базам данных еще пул воркеров обработчиков запросов человека на уровне самого макгрепорта Вот и эти системы соответственно некоторым естественным более-менее образом совмещаются в некоторую очередь вот которая здесь на картинке семантически показаны В общем Ну достаточно интересный тоже такой момент который требует проработки Ну как-то вот реализован на наш взгляд неплохо следующий технический момент это реализация собственно Lab движка мы к этому пришли не сразу и вообще Сначала мы хотели использовать какой-то готовый лаб движок и размышляли над этим по разным причинам все эти варианты отвели решились сделать собственный лаб движок И ни на секунду об этом не пожалели Мы сейчас с удовольствием его развиваем и нам кажется что за этим достаточно большое будущее все наши усилия сфокусированы на этом и это уже открывает довольно интересные возможности для пользователей формат доклада не позволяет достаточно подробно об этом рассказать поэтому очень скольз так об этом упоминаю давайте я рассмотрю вопрос запросы к базе данных вообще запрос со стороны биосистем к базе данных это Краеугольный Камень Мы всегда занимались не только биосистемами но и хранилищем и плохие запросы от биосистемы они способ перечеркнуть любые другие достоинства биосистем вот действительно так получается И сколько мы наша база страдала и мы вместе с ней вот жутких запросов которые там в результате действий пользователей генерят биосистемы и мы постарались Ну все эти нюансы учесть все известные нам вот эти камни выловить и обработать их так чтобы они ну не превращались в какую-то проблему поэтому мы сделали достаточно такую прозрачную подход Что такое у нас отчет отчет это табличка либо вьюшка в которую добавляется предикат то есть могли добавлять секцию в из чего он его берёт он берёт его во-первых из э-э значений которые выбраны фильтрах пользователям фильтр отчёта А во-вторых и значение фильтра безопасности которые закреплён за этим пользователем подставляет получает секцию V на базе выполняется запрос поэтому Давайте я проиллюстрирую вот некоторые вещи я говорил да там вот что нам известны какие-то проблемы которые бывают у биосистем при работе с базами данных и мы тем или иным образом решили вот несколько примеров первый пример это использование бизнес ключей для фильтрации У нас есть там коды магазинов коды товаров и пользователи очень любят идентифицировать вот свои сущности чем они работают вот этими корпоративными кодами они берут этот Список интересующих объектов и подставляют текстовое поле там в интерфейсе запуска отчеты Ну и все известные нам биосистемы вообще система отчётности делает следующее они берут вот этот вот список этих кодов и подставляют прям в секцию в запросе это не очень для базы потому что базы есть там суррогатные числовые ключи с которыми база работает как известно гораздо лучше Ну и вот нами был сделан простой такой промежуточный шаг это разыменование э бизнес ключей числовые адекватные которые существенно повышают эффективность работы запроса снижает нагрузку на базу которая и без того запредельно нагруженная но это очень важно дальше следующий пример это то что я называю то что мы называем не строгой иерархией не строгой иерархичными справочниками такие справочники у которых отношения между уровнями многое ко многим Казалось бы что за иерархия такая много ко многим на самом деле это просто способ представления данных вот простой пример пусть у вас есть населенные пункты и иерархия которая идет от субъекта Федерации от региона к населенному пункту есть промежуточный уровень в виде типа населенного пункта там город деревня там хутор что-то еще и человек в этом энергетическом справочнике строят отчет он раскрывает например Алтайский край вот как на картинке и выбирает узел деревня логично предположить что он хочет получить отчет по всем деревням края вот биосистема с которыми я экспериментировал не понимают что на самом деле деревня может встречаться в разных ветках и недостаточно просто подставить в предикат условия что человек хочет получить деревню Как они это сделают нужно учесть По какой ветке он спустился к этим деревням вот и Ну вот у нас это сделано тоже мы соответствующим образом формируем запрос учитывающий не только значения узла который выбрал человек но и значение той ветки по которым спустился Но это опять же только для вот этих несгих иерархий и наконец самый страшный бич убдд это справочник иерархический который позволяет выбрать пользователю значение во временной иерархии выше уровня протекционирования таблицы Ну допустим у вас таблица протекционирована по месяцам и человек выбирает целиком год отмечает там 21 постоянно делают Вот это ужас на самом деле это вот раньше был просто страшный сон но они это делали регулярно и ничего с этим невозможно было сделать и в лучшем случае хорошая крутая СУБД умеет делать то что называется Dynamic Partition динамическое исключение партии А субдд попроще будет делать Table Scan Ну и все На этом всё кончится вот мы сделали простую вещь которую тоже мы нигде никогда не встречали это то что мы называем проброс уровней то есть человек выбрал год а запрос подставляется на самом деле просто раскрытый этот год То есть просто месяцы Вы можете сделать указать для вашего справочника что это справочник с пробросом уровней и он будет Вот так работать Ну и последнее О чем бы я сейчас хотел быстро скольз упомянуть это лап запросы Что такое лап запрос человек берёт отчет и раскидывает поля у него есть строки есть Столбцы у него есть метрики он выбирает для каких полей какую метрику ему использовать сумму там средняя количество количество уникальных э Дальше он говорит его интересует только конкретные измерения то есть идёт фильтрация по измерениям дальше его могут интересовать только конкретные значения метрик например там больше чем продажи больше чем миллион Да а то есть это аналог секции хевин в SQL запросе Ну а дальше естественно там он может ещё отсортировать по значению это имеет реки а чтобы это на клиенте всё нормально смотрелось то ему нужно только кусок какой-то получившегося зал Сета передать потому что иначе клиент умрёт соответственно ещё есть э-э диапазон строк диапазон столбцов и вот это всё вот этим всем нужно во-первых предоставить пользователю удобный способ управления в этом клиенте Да там перетаскивать туда-сюда Столбцы во-вторых нужно соответственно на сервере сделать движок который эти запросы обрабатывает и дает результат вот у нас это уже сделано внедрено и дальше мы это продолжаем развивать потому что там разные еще интересные вещи можно сделать Вот То на чем сейчас сосредоточено наше внимание Вот в общем-то Все что я хотел сегодня рассказать Вот ссылка на наш репозиторий в githubic кому интересно пожалуйста берите скачивайте как я уже сказал Используйте смотрите Я сейчас рассмотрел только технические какие-то вопросы потому что у нас технической конференция но не менее интересными Мне кажется концептуальные вопросы вообще почему мы это сделали как мы решаем что делать что нет какие у нас планы куда мы движемся Я с удовольствием сижу эти вопросы в кулуарах кому интересно подходите более того завтра в 14:00 на нашем стенде магнитом мы планируем провести воркшоп посвящённые нашему продукту Я в более спокойном режиме с удовольствием со всеми интересующимися на эту тему сейчас чуть больше расскажу пожалуйста подходите Большое спасибо за внимание Вот мои контакты указаны Пожалуйста пишите Я с удовольствием с вами обсужу все что связано с этой темой Ну и вот qr-код для оценки презентации Все спасибо большое Владимир Большое спасибо Мы ждем вопросы у нас аж целых три подарка за лучшие вопросы Так что давайте не стесняемся вот отлично первый вопрос Дмитрий а вы писали с нуля все это или на чем-то основу Да да мы с нуля все написали Значит у нас для сервера на спринги javas prink Framework клиент у нас реакция с реакторовскими библиотеками там реакции Вот Ну а дальше все собственно сами расширяем искать предусмотрено плагины Вот это хороший вопрос значит мы имеем в голове возможность какого-то такого API чтобы можно было встраивать это Например куда-то а пита в принципе у нас есть но сейчас ориентированно исключительно вот на наш браузерный клиент и оно может быть не очень удобно Для того чтобы куда-то встраивать вот и со временем хотелось бы что-то такое сделать чтобы человек что-то настроил в системе а потом в своём каком-то приложении взял это строил Вы про это имели в виду Нет ну в том числе Да потому что под все кейсы себя как вам было удобно а кому-то нужно будет Мы это держим в голове Пока ещё к этому не перешли но в голове держим Надеемся к этому перейти Да было бы супер чтобы люди не форкать и дописывать свои плагин и подключить Да вот так может быть что-то такое вот если у вас будут какие-то идеи пишите с удовольствием Пускай оперируемся Давайте ещё вопросы Я думаю уникальная возможность у разработчиков собственной биосистемы что-то узнать вдруг вам завтра придёт в голову мысль и чтобы не идти по тем же граблям узнать то что вас беспокоит сейчас Может у вас есть опыт какие-то коммерческими закрытыми системами вот сравнить какие-то возможности вот Давайте да еще один раз Следующий вопрос А как вы работать с ограничением для пользователей на запросы то есть на не могут накликать и там действительно получится гигантский Запрос который час будет висеть есть несколько уровней ограничений во-первых есть ограничения на работу на получение объема из базы значит если там база сама например считает что пользователь запросил что-то не мыслимое это должна обрубить база если база обработала запрос но возвращает что-то очень много что мог грепарт не готов переварить У нас есть лимит там выставляется там сколько-то строк если больше чем это могли порта врубает если отчет там больше миллиона строк он не может быть экспортирован в Excel он не экспортируется в Excel Вот соответственно человек может работать только с внутренним лап движком дальше если человек работает с внутренним лап движком и накидывает Ну он уже может сделать карту произведения там разных измерений у него получится Безумный такой прямоугольник вот если могли понимает что у него в декартном произведении получится Гигантское количество ячеек он обрубает этот запрос говорит товарищ я не буду выполнять Ну вот несколько уровней разных лимитов они там выставляются ими управляются Вот вот так а на vr-ин есть какие-то ограничения то есть там в и там куча айдишников нет потому что миллион позиций не знаю таких нет ограничений потому что у разных баз разные лимит на SQL запрос вот у нас в принципе там мы по jbc с базами работаем если какая-то база предоставляет интерфейс Мы можем с ней работать вот Если уже она сама там скажет Извините слишком длинный запрос получился Ну тогда просто человеку в интерфейсе будет показано что база не может это переварить Да просто бывает что тогда уж проще тебе запросить всё чем передать туда миллионы едишников и попросить да в общем а вот еще два вопроса у нас Добрый день спасибо за доклад вот возникает часто такая ситуация когда в один момент времени Ну примерно в один много клиентов приходит и запрашивает примерно запросто один и тот же отчет А как вы эту проблему своей системе решаете А смотрите значит если они забрасывают один и тот же отчеты но они могут же разные там Значение фильтров выставить мы не отслеживаем что человек задал одно и то же значение фильтров то есть типа того что вот этот уже такой же просил вот вам то же самое нет Почему Потому что во-первых еще фильтры безопасности которые тоже там надо отслеживать и Ну в общем проще Короче говоря на это не обращать внимание другое дело что может быть ситуация когда вы знаете что у вас есть группа пользователей которые там в 7 утра или 8:00 утра выполняют этот отчёт с одинаковыми параметрами Вы можете поставить его на расписание с этими параметрами не на рассылку файла А у них в задании появится они там зайдут и у них у всех здание будет этот отчет вот и он один раз выполнится на базе это вот таким административным подходом решается Спасибо да и последний вопрос вот девушка микрофон Добрый день хотелось бы спросить немножко такой концептуальный вопрос почему собственное решение а не for какого-нибудь Open source-проект Вот это очень длинный вопрос коротко на него существует два ответа первый ответ правильный и самый главный потому что это интересно В жизни вообще все делается Потому что интересно вот а второй Чуть более приземлённый такой бизнесовый потому что это связано там с кучей вопросов там импрозамещения денег и там далее и тому подобное точно соответствует требований Там и так далее и тому подобное про это Я с удовольствием Завтра расскажу Приходите на наш воркшоп 14:00 Владимир супер Отлично Теперь надо ещё выбрать трёх лучших три лучших вопроса три лучших вопроса Мне кажется вот Дмитрий Да вот Дмитрий девушка и вот молодой человек все отлично Большое спасибо И у нас для вас тоже есть подарок сейчас Да Большое спасибо за выступление за вклад в Open Source моё такое вот резюме после доклада вот смотрите очень важно если вы считаете что вот вы что-то знаете как сделать берите и делайте Не обращайте внимания на всякие вот эти вот страшилки что А вы в изобретаете очередной велосипед Кому это надо Вот если вы понимаете зачем вы это делаете вы чувствуете в себе силы что вы это можете это сделать берите и делаете"
}