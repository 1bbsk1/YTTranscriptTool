{
  "video_id": "IZ7qxPVyasc",
  "channel": "HighLoadChannel",
  "title": "Реализация геораспределенной персистентной очереди сообщений / Василий Богонатов (Яндекс)",
  "views": 1282,
  "duration": 4626,
  "published": "2019-12-05T08:26:53-08:00",
  "text": "ответ приветствую всех пришедших на мой доклад спасибо что интересуетесь очередями сообщений сегодня мы будем очень много про них говорить я раскрою даже несколько деталей которые вроде бы не должен раскрывать на очень хочу сначала представлюсь меня зовут василий и я работаю в яндексе в инфраструктуре моя группа называется группа разработки систем поставки данных и если говорить совсем просто и понятно мы делаем очереди сообщений вот мы как раз и про предыдущий доклад и спрашивали потому что фактически тем это пересекается только там их использовали именно кафку а вот мы создаем значит я как раз переходил к плану и вот в на экране видите план по которому мы сегодня пойдем для начала мы обсудим вообще зачем все это нужно вот эти очереди сообщений почему эта тема действительно злободневно какой можно пользовать них ожидать после этого я расскажу про ту вещь про которые люди стараются не задумываться они как правило читаю документации дни и даже не доходит а если доходит они думают ну нет со мной точно такой ерунды никогда не произойдет поэтому ну так и оставлю пожалуй все хорошо после этого мы обсудим две популярные реализации а именно рыба танки и а пачиков к чтобы понять какие то базовые концепции и наконец чтобы было больше такого технического мясо в конце когда мы уже разогреемся и будем готовы выбрать себя глубинное знание я расскажу про то что находится внутри нашей уже очереди одно из тех которые сделали мы на называется индекс мисочку и она кстати доступны еще индекс облаке для использования уже публичный продакшен полностью так что это не только просто внутренняя скрытая технология яндекса вы можете использовать ее и естественно там все это дело описано достаточно очень просто начать итак поехали разогревочных секции зачем все это нужно на самом деле в яндексе у нас огромное количество задач связаны с очередями самая большая самая такая сложная и самое высокое нагружены это доставка логов то есть представьте что у вас тысячи машин десятки тысяч они все какие-то логе генерируют и нужные доставить до надежного хранилища в нашем случае это такой мапри deus и вот наша команда занимается в том числе разработкой резистентные очереди распределенные которые способны проживать всю эту нагрузку вы только представьте себе огромное количество лагов яндекса каждую секунду едет в хранилища с помощью наших очередей и помимо этого это была сама большая задача но есть еще и остальные естественно допустим нам нужно что-то посчитать и очень хорошо раздавать задачи worker он с помощью очереди почему это удобную я расскажу чуть позже помимо этого есть обработка потока событий вот как рассказывали в предыдущем докладе про доставку ивентов это вот примерно она то есть еще есть и такая и поставь использование очередей сообщений ну и наконец чтобы повысить популярно кладу примерно 50 процентов я скажу слово купер нити с микро сервисы и после этого станет понятно что нужно использовать очереди для надежной связи между ними не только сеть давайте поставим за чуть более абстрактно и будем потом от нее отталкиваться потому что самом деле очень летать чрезвычайно универсальный компонент то есть они никакой если проволоки несут и от этого они подходят примерно везде они хорошо заезжают и получается у нас что есть есть продюсеры это некоторые сущности некоторые машины которые генерируют информацию очень ценную либо ткут те сами получают и есть потребители worker и как угодно обработчики это машинки которые очень хотят эти сообщения получить эту информацию но сами откуда получить не могут только вот с продюсеров нам нужно как-то организовать передачу данных как-то связать эти сущности и на иным решением выглядит просто передачи по сети в чем здесь проблема ну на самом деле все хорошо если вам не нужна надежно доставлять вы не боитесь разрывов сети не боитесь дублей после этого вы гарантируете что у вас продюсеры концу игры способны справиться с потоком ну то есть нет такого что кто-то там упал начала что-то капица и в общем не справляется система в общем огромное количество проблем возникает вот такой прямой схемы хотя конечно в плане производительности прямой подход самый быстрый но чаще всего важно не это важно надежно доставить сообщение это квинтэссенция подобных очередей важно доставить что она была обработана и вот тут уже сеть никак не помогает зато помогает очередь сообщений посмотрите пожалуйста внимательно я вставил очередь строго между продюсерами и council мерами никакой связи уже на прямой между ними нет ни даже друг про друга не знают и это одно из замечательных свойств очередей что в принципе дают нам очереди давайте сразу сломаю вам мозг и скажу что очереди это никак структуру данных это место где сообщение ожидают свою обработку вот главная идея дело вовсе не в порядке это просто дополнительная информация о важно что они ожидают и вот очередь как раз это позволяет решить эту проблему то есть если вам не хватает мощности концу меров вы вполне можете поставить сообщение в очередь и концу мире будут работать день и ночь усердно будут полностью загружены вообще не в итоге будут конечно обработаны вся в среднем но конечно мы меняем скучать rialto и масть обработки навык неси на действительно количество ордеров то есть представьте себе очень простой пример допустим нас супермаркете сидел бы 100 кассиров до относительно небольшого супермаркете а не в час пик идеально бы решали свою задачу то есть все клиенты были бы довольны все больше очень быстро а все остальные время пришлось платить им зарплату акт вот не выгодно получается правда наверное лучше было бы чтобы они как-то постепенно все это обрабатывали особенно если клиентам нет потребности вот прям сейчас чтобы это было выполнено и вот очень жди для этого хорошо подходит прямо этого как я уже сказал и в чем проблема именно сетевого голого решение это в том что если мы вроде и доставили сообщение это чертово знает чем все это закончилось то есть не понятно обработали консьюмер сообщение а если обработал то что дальше делать мы и он ужин при вы себя удалили и получается что хорошо бы чтобы этим занималась очередь и она это действительно может заниматься она может контролировать что пока консьюмер не скажешь все я свое дело сделал очередь будет хранить ты сообщение и при необходимости отдавать его следующим консьюмер у который вызывается на это дело кроме этого есть все таки немного продуктовой логики в очередях но это решение конечно скупо опциональной и как кому нравится я сейчас говорю про маршрутизацию это какие-то специальные условия которые ну перемещают сообщить между очередями например или что-то фильтруют в общем что то что позволяет как-то разбивать поток это тоже очень удобно помимо этого есть мои любимые свойства и разработчики слова вот именно его больше всего любит это когда происходит развязка компонент ведь очень здорово когда вас продюсеры ничего не знает про консьюмер of и в обратную сторону это тоже верно есть только одно знание которое они делят между собой и это знание формата сообщения ну чтобы как а это вообще была польза от передачи сообщений tumblr какой должно быть согласованность в логике но прямые этого больше ничего не важно и там я даже выделяют два уровня развязки это логический это как раз про типы про сообщения и физический когда нет никаких ринг поинтов кроме вот endpoint в очереди собой сторон нет никаких лишних данных и что самое главное они могут работать совершенно независимо представьте вот у меня поработал мой продюсер он накидал огромное количество задач в очередь и все он выключился потом сегодня не работает ничего страшного консьюмер потихоньку все разгребают и как видите совершенно неважно какой из них работает такой не работает все же хорошо и вот на основе этого можно выделить даже отдельные свойства про масштабирования то есть что нужно сделать чтобы обрабатывать сообщение быстрее я просто запускаю еще один instance консью миром и все он ходит в ту же сам очень тут же самое into my нет никаких отдельных настроек я просто нажал кнопку в клуб и все мне стало обработка быстрее стало легче и поймай этого некоторые очереди которые мы точно не будем рассматривать они порядок все таки соблюдают да есть такое это совершенно необязательно но они представляют в частности для реализации одной очень хорошей гарантии доставки про это тоже в перспективе мы рассмотрим отлично если очередь такие замечательные то наверняка существует целая куча вот у меня тут есть списочек из самых популярных прошу обратить внимание что перед каждым каким-то имеем собственно стоит ими компании чаще всего которую то очередь сделала и причем даже этих очередей то ни одна скажите пожалуйста кто в зале польз вообще чертами сообщению своем продакшне и поднимет просто руки о замечательно аудитория значит вы понимаете просто я говорю теперь немного разобьем на кусочки кто полез ребятам тоже поднимите пожалуйста руки ага вижу благодарю спасибо ну и наконец то не могу сказать не сказать не спросить про кафку как вас кафка ребята ага отлично тоже много рук замечательно значит у меня как раз две аудитории на которой площади набрасывать прекрасно теперь поговорим про ту часть который обещал не расскажу немного страшилок как же без этого в чем же тут вообще проблема а проблема в том что если вспомнить предыдущую схем где вставил в очередь то у нас нет абсолютно твердых компонентов природе в принципе не существует таких да вы как-то не заворачивайте наказать не что-то пойдет не так и все зависит от того что полет не так в частности самый такой популярный сценарий это просто разрыв сети и что в этом случае может происходить допустим мы хотим отослать сообщение от продюсера череда то есть мы сообщение породили и хотим записать ну что вроде все понятно пишем сообщение в очередь так оао соединение порвалась этот момент чего произошло непонятно потому что она могла записаться в очередь потом вам просто не пришло уведомление о том что то есть ответ не пришел что все ок и не могло не записаться и тоже порвалось вы совершенно не представляете чушь в итоге случилось вас нет никаких идей и поэтому есть всего 2 варианта ретро вить inherit троить если манере тройным потенциально мы начинаем терять данные если мы read троим сделаем повторную попытку отправки мы получаем tuple вот такая вот грустная штука теперь про дубли с дублем надо как-то бороться есть нас есть какие-то специальные механизмы дедупликации что называется то мы приходим к идеальному сценарию офисный механизмов нет у нас все так же остаются дубли если говорить про более такую терминологическую базу то тут есть драма деле название вот это все это гарантии этому ost ланс это когда максимум 1 то есть сообщение может потеряться но больше одного раза принципе никогда не до ставится есть it left vans это когда действительно минимум 1 это наше ретро и и наконец экзарх vivance ровно то что надо то что он прям хотим видеть вас бы зачем нам дубли и потери никакого толка в них нет это плохо немного на практике чтобы разбавить академично сть ну это мост vans где применяется в real time of данных до если у меня какой-то робот я выслала ему какие-то координаты какие-то команды та команда которая пришла та не знаю а 300 миллисекунд позже и мужа на фиг не упал а потому что уже не актуальная ситуация и получается что вот это хочется заставлять именно этот мост vans не доставили ничего не поделаешь а если доставим тоже смысл этого это не будет данные то устарели и наконец то есть пример почты я имею ввиду именно физическую почту как почта россии но не только она теряет посылки а дело вовсе не в том что я хочу кого-то обидеть я просто хотел сказать что смотрите из леса посылка потерялась момент ее передач элементы пересылки вот где-то по пути ее невозможно повторить просто физически тоже ниоткуда и склонировать и получаешь доставка тоже это может vans невозможно заставить дубль либо доставили либо нет все брать лист vans это используется практически везде и люди правил этим довольны то есть у них редко случается сбой достаточно они не замечают лист вонсо если замечают ну ничего не поделаешь горит извините и продолжать работать так же вот но при этом они искренне считают что них xr3 vans которые к слову говоря достигается с очень большими усилиями невозможно достигнуть экзит ливанцы без одновременной работы на продюсере в очереди и на клиенте нет просто способов даже теоретических они все должны что-то делать чтобы получилась именно exactly vans ну где нужны церкви vans здесь вроде все очевидно примерно везде они действительно нужно при подсчете денег если мы посчитаем трафик клиента несколько раз клиент разозлится потому что не хочет платить больше за то что не использовал если мы нету считаем ну уже проблема у нас мы потеряли деньги то есть вроде бы что-то предоставили но денег не получили тоже плохо и вот тут как раз и взять реванш то что надо самый правильный сценария теперь немного математики и неравенств смотрите казалось бы если мы используем что то что доставляется минимум один раз плюс что-то что-то старается максимум один раз то это нельзя криво нс то есть канал если сложить едва не раньше получается что-то диск действительно один раз потому что в этих границах находится на самом деле это и дубли и потери она никак не называется просто но это и только другой вас будет то есть она именно плохо вот и про экзо клеманс тут в принципе очевидно но я хотел отдельно это отметить что если вы вас есть какая-то их взять ливанцы откуда не будет она берется и вы добавляете что-то другое либо то же самое у вас получается не то же самое то есть испортит заклевать как раз плюнуть любом месте может уже случиться так что вас будет нельзя криво нс отлично на этом слайде мы расслабляем глазки очищаем наш разум и готовимся к немного холивар най теме мы будем говорить про пачиков к и rabbit но не версус нет это просто про особенности немного наполни напомню архитектуру для тех кто не знает смотрите значит кафка масштабируется такими фифа очки для им system first in first out упорядоченные и они называются эти маленькие фишки партициями пределах них все упорядоченно именно с каждой и партиций работает там один несколько контейнеров причем важно так как а сообщение упорядоченный есть какая-то смещение относительно начало очереди и концу мире работают а в сетами очень просто на примере можно объяснить смотрите опустим красиво говорит вот у нас есть офсет 100 дай мне не знаю 50 сообщений со все то 100 и вот он дается всего 150 сообщений потом красивы будет все я обработал супер следующий раз приду уже совсем 150 вот так вот мы и блоками обрабатываем и получается здесь дней на масштабируется очень просто за счет именно партиции есть лепит в нем тоже есть некоторую поверхность то есть как сообщение попадает в одну и ту очередь ну какой то порядок будет сохраняться это правда но дальше чаще всего это никому не надо не дать этим не пользуются и как раз вот в рыбе тем очередь сама раздает консью миром вот эти вот задачи вот эти вот сообщения о землю просто подключаются них нет никакого все то здесь самые такая маленькая ниц пар лизма это именно отдельное сообщение и не все могут сгребать по отдельному сообщение по своему который выдуваем очередь и вот так это работает про нюанс вот в интернете хорошую фразу я видел что вот в кафки там очень умные концу миры и сама кафка очень глупо и сам брокер очень глупой то в нем не будет ничего умного нет некую логике это просто фактически репрессированный лак чем как на самом деле является выбить и наоборот концепция тут считается что все worker и глупые им они должны делать то что им говорят а вот очередь умная и вот эти всякие round robin и там по четкому сколько мы выдали чтобы лишние там не накинуть вот это все реализует именно сам риббек внутри себя эту стройку он да такая фундаментальная разница теперь про гарантии раз в начале про эту тему смотрите значит ставкой существует аж 53 гарантии и рассмотрим их значит последовательно вот производство нс и понятно допустим мы скачали сообщение и сразу сделали коммитов с это все после этого наш харкер мог упасть данные которые мы скачали небыль никуда обработан не были переложены они потерялись пролились на пол плохо второй вариант плохо когда мы делаем дупле но это тоже весьма легко достичь мы немного переставляем вместо коммита то есть мы скачали сообщение до кого-то сета потом обработали и тут мы хотим сделать commit но не получается потому что что-то пошло не так сетью и получается что данные уже видите side effect оказали но следующий раз к ней умер другой уже за пустившийся начнется предыдущего все то потому что он ничего не знает ни должников ookami to и вся пачка перри обработается заново и вот наконец версии 011 их кафки появился экзо клево нс которая активно рекламируется прекрасно ищется это в интернете а проблема в том что это не правда то есть как я уже говорил поддержках за клемансо в системах это чрезвычайно сложная тема и там требуется участие всех трех компонент есть если в очередь заявляет поддержкой коллег эванс то как минимум не про ну не может быть правды да ведь вы не поддержали у себя без каких-то отдельных усилий вас ничего не получится так в этой церкви vans здесь идет речь только про продюсером то есть на продюсере сообщения начинают нумеровать чтобы идти в отдельную партийцы то есть политика в это по ним порядка там еще номер этот номер используется им брокером самой кафкой для дедупликации здесь очень просто если я отправил сообщение с номером 1 и я потом управляю еще раз номером один то второй раз общение в очередь не попадет на суре сообщение с номером один раз вот это вот и дупликация с ретро яме который редко казак ливанцы чтобы дойти до конца в этой цепочке нужно чтобы на клиенте на концу мире который уже будет скачивать эти сообщения были сильные транзакции который одновременно и отправляет данные обработаны и кроме титов set если это происходит не от омар на вас ничего не получится у вас будут либо потерю либо туплю же в конце то есть идеальная схема портится ну и выбить и здесь все проще здесь нет никого взять реванш и не заявляется здесь именно все зависит от того как вы ждете подтверждение по сообщениям примерно как в кафки так что и наверно нибудь даже это повторять то есть если мы подтверждаем раньше-то мы теряем если подтверждаем позже то будут дубли но очевидно теперь немного про системное программирование чтобы охватить еще это область это важный действительно момент пожалуйста сфокусируйтесь есть такая функция в ядре такой системный вызов точнее i've seen linux но принципе винте должно быть что-то подобное идея здесь в следующем что для ускорения взаимодействия с файловой системой использовать такой вот трюк что данные который оказал должны быть на диске сначала пишется в кэш этот хэш находится в ядре операционки и он и энергозависимого там у что это грубо говоря оперативная память и может случиться так что вы что-то записали на диск вам кажется что вы записали на диск нет вы записали не на диск вы записали вот в эту память в ядре а когда уж она попадет на диск это как решит ядро и получается следующее что если машинка в это момент выключается то все данные потеряются на диск и нижние как он попадут они же были оперативы вот и теперь посмотрим на кафку с трепетом как они себя ведут в этом случае конечно с точки зрения маркетинга кафка очень хорошо имеет его отнесли там и прочее так они не говорят что у них tf sing не выполняется на каждую запись там i've seen к выполняется каждые несколько сотен миллисекунд я полагаю ты даже настраиваться должно но и из коробки ситуации что сообщение в карте потеряется это реальный сценарий совершенно здесь нет ну никакой дополнительно локи никакого обмана он действительно может потеряться потому что уже сказал пирсинг может не произойти может не успеть хотя конечно store очень редкий и про rabbit здесь получше здесь есть и свято честный f sing и вам запись сообщения в брокера подтверждается только после фсин га тут возникает проблема мастеров этого ребята помимо проблем с мертвым логов там есть проблема с зеркала и мастера то есть мы заперли стильно мастера а реплики идут уже постепенно после этого и получается что мы получили а потом мастеру palm а я прийти не синхронизированы и в итоге включаются новый мастер на старый реплики и хвост очереди отрезается в этот момент все данные тоже потерялись вот чтобы плавно перейти потому что сделали мы надо ответить на один простой вопрос нафиг все это нужно то и зачем выпилили свою казалось будто вы только что там рассказывали про одну очередь про другую наверно даже долг у почитали что-то сами пою залив продакшне и какие же вас были причины тогда делать им так сейчас расскажу первое ну в яндексе как вы знаете огромное количество сервисов не хватит ни пальцев ни рук ни ног одновременно чтобы посчитать сколько их есть у всех там разных магических стейки но очереди зашли всем это я сразу говорю а исторически была так что у кого то было кафка у кого-то был рэй бед и проблем том что они очень страдали с этим то есть команды у нас есть конечно много инфраструктурных но есть много продуктовых так вот продукт у не нужно занимать инфраструктура если казалось бы есть в одежде маешься инфраструктурой и продуктов оккама начинать делать свою то что-то происходит не так ли это банально неэффективно каждый начинает там свой велосипед поддерживать ужасно вообще и конечно хочется чтобы кто-то делает другой так вот так была первая причина одна из самых главных пойми это вам им хотелось какой-то простой и пьянь и чтобы были готовой библиотеки оплаты 5 ну то есть они используют много разных языков и не хотел что-то заново повторять не хотел ждать пока мы там это от ладим общем что-то хотелось такое готовое и в то же время это и кафки и и пьянь вот с этими ватов сетами консиллерами это саша штука сложно это не удобно если вы попробуйте почитать документацию потом голова пойдет кругом то есть неудобно для продуктов атакуем всем заниматься эта ерундистика получается помимо этого у нас в яндексе есть минимум 3 дата центра по которой я не буду рассказывать и очень важно что все сервисы натянуты как и меню на 3 до центра и потерям 1 вот это центра его выключении случае учение или приехал трактор кабель чего угодно не должно никак влиять на стабильность работы в сервис вообще принципе просто 0 должен быть impact и естественно мы это требуем тоже поддержали по поводу хранилища я от не зря рассказывал про i've seen потому что дальше это буду использовать честно моря в свою пользу у нас такой нет никаких условностей если мы что то сказать что мы сохранили уж поверьте оно надежно сохранена помимо всего про и сказанного мы в яндексе любим программировать я надеюсь это тоже знаете это тоже любите и за это время мы пока программировали много чего на программировали и вы получили опыт же самое ценное у нас есть опыт создания таких сложных больших систем распределенных за это время была создана целая платформа которая позволяет строить большие распределенные системы и во многих наших внутренних инфраструктурных проектах именно и используется мы наконец я опять же напомню про тот слайд где я показывал вот список очередей да и говорил там будут смотрите значит название компании очередь название компании очередь это не просто название компании им-то ну конечно них есть и свои внутренние реализации здорово но чаще всего эти очередь попадают в облака и плохо то облако в котором нет очереди сообщений серьезно вот вы наделали виртуалка мужчин как-то связывать не делай mic 1 1 2 это связывать очередь сообщение нет клиент выходит наружу куда-то на вольные хлеба начинает страдать потому что у него там уже сразу двум там поставщикам нужно платить не понятно как это все считаете трафик выходит в общем плохо поэтому очевидно что очень нужна была и как раз она доступна на данный момент отлично а теперь переходим уже к нашей реализации я надеюсь вас убедился она была не просто так сделано я напомню называется индекс мисочку и рассмотрим ее основные свойства какой мы взяли и пьянь мы взяли и pr и ws риск вес почему мы хотели простоты честно скажу там нет никаких супер fitch там есть только простота и все ради простоты и оказалось что это прямо попадание в яблочко чаще всего люди нужно именно она чтобы можно быстрее запустить свой сервис и как раз он он так и называется simple пьют сервис это да и теперь опять не бинарный протокол то есть его принц может удержать даже любая кофеварка в которой из подходящего либо там с питоном наша очередь при системные ну я здесь же уже догадались что это имеется ввиду но я отдельно скажу что это именно запись на диск а то есть и сообщение хранится на диске нет никаких случаев когда сообщение хранятся только в памяти в принципе ни одного то есть если она хранится в очереди она хранится на диске . она причем хранится ни на одном диске она хранится в трех разных дата-центрах в 3 репликах то есть если даже можно поверить выпадение 2 на the center of the prince поверить выпадении трех но очень сложно такого величество я никогда не видел и как следствие мы не тебя данные клиентов не теряли вот получается следующее что я рассказывал про кафку парковку в кафки там есть татя в свет и есть партиции здесь не так здесь больше похоже на репит вот как влюбить и сообщение раздаются а здесь наоборот консьюмер делают пул то есть приходит consuming очередь говорит есть чё и она такая а вот тебе сообщение новым круто отлично буду обрабатывать вот и тут как раз такой паттерн получается компе then can see us as не соревнуются за сообщение и одно сообщение в идеале достанется только одному потребителю это в том числе и еще одна с на свойства простоты то есть это не pops up если вы по не услышали нас на самом деле как я уже говорил немного шире понятия в очереди чем обычно не совсем структуру данных и мы даже порядок не учитываем кроме достаточно непопулярных фев очередей мы конечно тоже поддержали что быть сместим эй по и пьянь но честно говоря ими никто не пользуется там проблемы с производительностью это достаточно неудобно и то зачем они нужны вот это вот экзо климат с ними нельзя реализовать хотя механизм публикации есть но они очень ограничены в основном все пользуются очередями типа стандарт они на самом деле просто можно назвать an ordered a standard почему хочешь просто потому что процентов 90 очередей можно 99 это именно стандарта очередникам уфе фоне нужно я раскрою страшную тайну в продажу продакшне индекса тысячи очередей используется вот именно наши реализации там нет фифа просто ни одной просто не требуется но это именно в этом сервисе конечно я не упомянул у нас есть еще 2 сервис очередей он похож на кафку то есть нормализует концепции карте по-другому я могу потом рассказать то заинтересуется почему просто не просто кафка в чем проблема ну наконец проон гарантии доставки разум их изучили давайте применим посмотрим какая же тут гарантия есть здесь гарантии доставки клифт vans то есть очередь будет до посинения отдавать пенсию миром сообщение на их пор пока они не скажут что все обработано вот больше никаких пит фолов здесь нет вот кстати все это в принципе вот эти четыре метод достаточно чтобы сдать очередь и начнете пользоваться всего методов на самом деле 14 но они очень ситуативные и реально нужно знать такого т4 для начала работы и с некоторой вероятностью вы даже больше не изучить никаких потому что польши и не надобно просто давайте посмотрим под наши любимые продюсер с концу миром между них мы хотим поместить очередь сообщений как мы это должны сделать мы выделяем ресурсы логически просто говорим вот очередь с такими настройками пожалуйста создай проходит несколько секунд реально секунд и все у вас есть очередь можете писать сообщения прямо в этот же момент начинать не стесняйтесь как это выглядит продюсер на самом деле у него есть только один метод вот как то вот прочим нет вариативность нет никакого особого выбора но просто как топор то есть есть только одно действие который может делать оборону привез порубите вот тут она говорит типа отправить сообщение то есть вызвать не цен место в нём отправляет самую информацию такое хочется донести до потребителей и все здесь он свою дела закончил я еще раз повторюсь если подтверждение пришло нас инвестор знающие сообщений точно запер чище на надежно но никуда уже не денется все и клиентам будет доставлено однозначно апреле троих понятное дело здесь возникают дублин то есть никакой дупликация на этом месте нет теперь про концу мира разум испарились его заправить им больше даже принципе может не участвовать зачем консьюмер приходит делает пул то есть он приходит в очень быть есть чё как раз тот самый паттерн говорил ранее и сообщение какой-то которые вот как раз это чего она вот не скрывается из очереди а тамара над инфекционно и отдается консью миру вот так вот просто закрывается чтобы не дайте другим кольцо миром после того как сообщение было обработано вот он как раз контроль обработки одно из свойств который я упоминал ранее с общением то есть костюмер вызывает метод дэвид место чп и в нем он использует recipe хэндл здесь ничего сложного этот идентификатор мы получили при вызове recipe message то есть у нас данных само сообщение каких-то атрибутов его мы получили еще в этот wad айдишник групп горя в очереди чтобы можно было грохнуть вот и мы с ним идём на гривну все я обработала удались те кто имеет опыт с раскаленной с теми сейчас не скажет так понятно а вот сейчас допустим консьюмер получил сообщение она скрылась в очереди и упал все сгорел получается что сообщение в очереди скрыто навсегда что ли и то есть никакого но уже не достать нужно звать администратора копаться в базе что должна делать нет это решаются проще сама и pr и до блеска с и наши получается pinkie pie ой она реализует такой антипатр на стадии распределенных систем ну вы просто мимо пользоваться про синхронизацию по времени это плохо делать но для упрощения 5 сам раз не самом деле тут эта идея правда себя на сто процентов чем синхронизация очень просто если вы даете какое-то конкретное время консью миром на обработку тогда вы можете ожидать что но он должен проб за это время и сделать удаление то есть он получил являюсь там услуга ряд 30 секунд на обработку вот это вот время 30 секунд называется везде beauty time out конечно же это параметр он настраивается для каждого человека отдельно может даже менять его для отдельного сообщения специальным меткам если потребуется и она бывает от 0 секунд то есть можно прям бесконечно получать дубли на разных квартирах до 12 часов если у вас там такая штука тяжёлая долгой обработка случае чего опять же можно продлить им если все еще не хватает и тут на диаграмме как раз я показал что есть несколько состояний между которыми свое сообщение как раз перемещается то есть мы сначала видимые потом его получили она скрылась и потом его удалили если она была скрыта его не удалились затем возвращается вот и все отлично честно говоря я рассказал про все и pr мне больше даже нечего добавить и это в принципе здорово то есть показывает простоту а также позволяет нам перейти к тому как это работает внутри самое же интересное наконец-то раскрою самое главное интригу дня что же там находится внутри вот той супер платформой является индекс дейта bass на самом деле это не просто база хотя по названию кажется что база это именно мощные алгоритм распределенные для построения таких вот систем вот что там находится на такие примитивы и конечно же на основе них есть база сделана уже как минимум какие свойства самой базы рацион и пользуемся в том числе и а первых она распределена и это не просто кучу машинок дата-центре на день балансир не так это было бы ерундой могут можно делать распределенные транзакции которые захватывают с собой например часть таблицы в одном дата-центры часто близ другом и все работает все по эйсида все строго консистентная помимо этого на горизонтально масштабируется то есть нет такой проблемы чтобы не там таблицы нагружена ничего не делать фото и за голову делу еще одну таблицу нет я просто использую больше ртов причем должен идет автоматически она отказывал стой чего и реализации от этого хранилища надежного это именно то что дает нам вот эти три реплики это один из режимов работы 3d прийти по одной в каждом дата-центре как раз это обеспечивает базы данных про если транзак язык я уже сказал очень крутая штука позволяет считать деньги и наконец вам наверно интерес такое строк консистентная вот скажите кто работал с кассандрой пожалуйста поднимите руки или кто понимает что-то внутри находится они так много понятным давайте я вам расскажу есть такое понятие как eventually consistent это когда мне ни какие-то реплики я пишу на какой-то напор из этих реплик допустим наговором но дело в том что записав на кворум я пишу не на все реплики гором это именно пополам плюс один от всех то есть например было бы пять узлов из 9 а все остальные четыре в той же например кассандре они загоняются каким-то внутренними коммуникациями которые заводь всего типами и мысль о том что они не здесь консистенция раз нарушается то есть можно прийти с чтением после записи но до того как пришел гостя с обновлением и получить старые значения вот я иногда этапы если это в принципе не возможно вы не можете пушистого значение ни под каким соусом просто но не получится вы получаете только самые свежие только самой актуально во всех транзакциях однозначно теперь когда мы поняли само ведро можно принципе уже за ривер сити структуру того что находится внутри и начать можно с базовых постулата очередь это набор шар дав но и хотим линейно масштабироваться вот мы линейны масштабируемся шортами это шарды не базы данных это в нашем нашей терминологии шарады что такой шар это набор таблиц вот и все просто какая-то пачка таблиц если нужде другой сорт мы делаем еще таблицы такие же с такой же логикой но где-то отдельно и живущие чтобы разделить нагрузку и наконец операции с очередью это ничто иное как работа с базой данных какие то запросы вот метод есть скелет очереди нарисован от ричарда на самом деле их 4 но мне показалось к россии выглядит 3 смысл в том что есть таблички которые общее там атрибут это просто в тройке очередь отдаляется редко зачем дублировать state это например там считается количество сообщений которые есть в шортах то есть вместе настоятельных городов и наконец вот эти вот шарады вот там к раскаяться данные то есть базовая очень просто идея все данные связанные с сообщениями хранятся где таблицах вот и все где то есть мед информация а есть прим да это вот место джейд он так и называется супер разобрались теперь посмотрим уже более верхние уровни вам я напоминаю что у нас взаимодействия идет по ешьте пи и пай и мы даже разрешаем только учти ps почему потому что мы боимся за безопасным данных наших клиентов мы вообще из теперь устарел принципе чтобы передавать данные по сети это слишком плохо так делать вот дальше запрос к очереди приходит на балансир и отправляется в 1 из 9 узлов нашего сервиса их 9 по 3 на каждый дата-центр санузлы затем взаимодействует уже стоянок в дтп с каким-то своим запросами какой-то своей логикой вот что находится внутри одного узла красу из этих вот 9 снаружи they then джинкс это очень много нам хорошего дает это и логе можно писать и защита от сетевых атак всяких странных там с висящими соединениями но в частности самое полезное это тир минировании что без то есть дальше он делает форвард видишь т.п. здесь нет никакой дыры безопасности и потому что это происходит уже в пределах 1 х 100 то есть это но в же никаких проблем нет с теперь она удобно обрабатывать гораздо проще и парсить и прочее и нашли себе сервер носитель на занимает столько ищите прим он парсит это запрос поменять send message резюме слышь преобразует его в про то путное сообщение о это внутренний формат в котором написано типа чего надо вот и внутрь уже actor на системы резоны вся бизнес лойко который вот это вот чего надо преобразует что нужно сделать в запросы для базы данных и хэнку и дополнительной информации естественно попал докторами системы принципе вы можете открыть википедии посла маркерные системы и там будет вот прямо но я скажу лишь то что важно в нашем случае обширной системы это про модель асинхронности то есть это не просто там потолки мьютекс еще чего то нет здесь этого нет здесь именно обмен сообщениями конечно под капотом там находится new такса и потоки вопросов нет но пользователь для программиста это очень удобно синхронной модель мы мыслим фактически такими 1 поточными акторами и масштабируемся мы тоже акторами эта картинка она чем интересно что актор на систему у нас целиковая это то что делает наши 9 узлов не 9 узлами а кластером из 9 узлов потому что они все связаны друг с другом и как раз это самая крутая фича что есть коммуникация над реакторные системы и в нашем случае она не шибко отличается от коммуникации внутри одного узла не важно может просто указать реактор на другой ноге и все-таки это сообщение дойдет очень удобно теперь посмотрим про некоторые проблемы которые нас настигли в чем вообще говоря сложности вот есть во и на данный момент мне нельзя создать атомарные транзакционные таблички сколько-то штук и в то же время записать данные в другую таблица нам это очень хотелось очень было бы здорово и 2 вторая предпосылка то что вы мы вызвали клетки начали создаваться вот эти вот таблички не атомарный нет индексу она и хвост упал что получилось на западе скит таблички связанные с очереди с именем очереди но с ним нельзя работе не доделаны какой-то мусор получился плохо и что самая страшная может случиться так что мы остались ком-то промежуточном состоянии которые с которого продолжить нельзя удалить тоже нельзя потому что табличка не доделано и это как раз старое состояние дел в новом состоянии делом все по-другому смотрите здесь такой двухфазный громит на первом этапе мы проверяем если вообще таково череда аналогично тем стать еще одно если уже все есть на втором если ничего так и не не был создан мы начинаем делать структуру очереди независимо то есть вот эти все пачки таблиц которая показывала на слайде анатомия очереди они все создаются параллельно для каждого пролить идущего запросам и потом вот эта вот логика пытается за комитете версию то есть вот этот практически имя папки с вот этими под табличками и она кто-то только один это может делать потому что это вот-вот commit именно то есть записью таблица он действительно товарный транзакционных консистентной все дела все хорошие слова и кто-то один побеждает а проигравший знает что он проиграл и знает кто победил я дает корректно ссылку на очередь в итоге что у нас получается 1 корректно созданное очередь и один проигравший который за свой подчищает то что он там наделал потому что это уже никому не нужно в чем профит дело в том что вот этот последний шаг с камином как я уже говорил это атомарный транзакционных и если что-то падает посередине да ничего страшного но будет мусор мы потом автоматически удалим никого не корректно состоянии очередь в принципе не бывает в этом случае потому что очень начинает работать только после коммита а то через какие-то левые таблички ну ничего страшного то есть это ничего не ломает не бывает таких проблем у клиента что вот он не до создал хвост упал и все и очередь сломано нет просто будет какая-то недоделанная версия и на этом проблемы заканчиваются поэтому краз называется отказоустойчивой всегда неё чертим другая штука начала немного вводной вот представьте про наш механизм вскрытия сообщений из очереди до как бы это можно было реализовать во-первых мы как я уже говорил опираемся на знание которые ходят только внутри базы никаких знаний которые находятся в оперативной памяти мы им всем не доверяем это максимку the hand какая-то подсказка того что может там происходить внутри это неправда скорее всего и как раз здесь показана иная архитектура которая была раньше дело здесь вот чем допустим приходит клиент и говорит есть чё как раз тот самый любимый вопрос дании сообщение на сообщение нет мы тоже не знаю какие есть может по очереди сообщение то и нет х столько только что включили запрос уже пришел как быть мы идем в базу говорим сообщение есть какие-нибудь вообще она отвечает да да у нас вот такие то сообщение есть какие-то услугами айдишники мы радуемся в этот момент и отдельной транзакции их пытаемся скрыть то есть если совсем группа мы просто ставим флаг там булевских условно говоря напротив сообщение в этот момент как бы говоря сообщении скр это не трожьте на самом деле там чуть сложнее с интервалом времени потому что к его говорю везде beauty time out но для нашего приближения вполне достаточно такого представления и что из этого лиза этого лизать следующая напоминаю балансер 9 узлов под балансиром все независимы в каждый может прийти запрос по progressive место 6 место и что в итоге мы получаем получается очень грустно я значит спросил базу какие там сообщения хочу залочить прихожу а там все заложено как же так все очень просто случилось гонка просто на другой хвост который отработал быстрее пришел тоже запрос он тоже вычитал и все что мне там был что он там знал тоже залочим в итоге у меня заброску это получился глупой мне клиент даже нечего ответить на сообщение то нет и в итоге получать какой-то пустой ответ прямо жуткого impact on a performance это просто выглядит очень странно то есть количество ответов когда сообщение вроде есть мало пошли зря увеличивается значительно какое решение в этом случае хорошо заехал по крайней мере нам вот джо один из гугла говорит что если у вас нет мотивации дело дейсвительно распределенный до плена момента конечно же до определенного масштаба не делайте распределенную систему вы там не сможете даже расхлебать тот объем проблем которой он собирается встретиться просто будет мизер потому что для этих масштаб чем нужно дорасти год данном случае хватило именно централизации то есть мы убрали в этом месте распределенность и сделали так называемую сущность мастер очереди про что это вообще речь вижу такой мастером мастер это actor и этот актор контролируется что живет один для каждый очередь во всём кластере ровно 1 строго им все узлы индекс меточки знают где живет этот мастер не совершенно точно это знает и они в делают пересылку как раз вот в чем профит актуарной системы в этот узел в мастер вот этих запросов то есть египет приходит на другой узел а запрос сам мы уже внутри сети гоняем то есть 2 сетевое соединение от некого блока нет никаких проблем с этим приходит дел на мастер мастер обрабатывает у него есть кэш сообщений а так как у ни с кем не конкурирует у шона пенна времена один всего он очень точно имеет хорошую этой вот такое же состояние то есть какое сообщение сейчас видимо или скоро станет видимо он знает прекрасно вот помимо этого там много хороших плюшек понес собственно кошель есть еще такой про рыбки митинга то есть за счет того что все запросы сходятся в одной точке мы можем и посчитать их в одной точке и сказать так 200 запросов максимум на запись 200 за чтение все до свидания и это будет очень точные измерения потому что опять же . 1 то есть вы будете до угадывай сколько там все будет хорошо это не распределенное квартира вание помимо этого можно очень точно считать метрики можно за сколько там трафик и проходит через одну очередь еще что-то и последнее но чуть ли не первые по важности это оптимизация потока запросов которое позволило сделать введение мастеров но сначала про проблему дополнительные для внимательных опять же любимый проблема воспаленных систем это выбор лидера да как это можно было бы сделать можно было бы брать совсем группа локи какой-то системе например звуки передо так тоже можно было бы сделать в нашем случае это не требуется нас есть отличная платформа завершение подобных проблем называешь своей baby это не специальный механизм который позволяет выбрать место где поднимется сущность причем этот механизм очень умный и или надо все-таки отвалилась он перевозит and breed поднимайся в другом месте и в худшем случае если брать предельный кейс 8 ноты с 9 могут отвалиться все мастера переедут на дун аду может быть затрещит под нагрузкой но логически все будет работать помимо перфоманса на самом деле как опять же распыленных системах сложно точно сказать что надо живо просто по сети непонятно вас может быть как работать вот я вертикально показываем это запрос от клиента азбуку в кластере ни фига не видно что она работает тушить разрывалось вот такое частично обрыв то есть не полностью все взорвалось не везет а центр там разрушен а вот именно есть парте цианирование получается следующее что поднимается 2 мастер в него идут новые запросы а старые ты еще не помер почему помирать работы и в него и каких запроса вещи висят и мы возвращались в этом случае нашей исходной проблеме когда у нас крыши неправильные потому что друг с другом и начинает конкурировать узлы страшно ли это на самом деле нет почему потому что мы запросто не меняли не нужно было ничего с этим делать даже если начинает за конкурировали между мастерами из начать конкурировать за таблицы запросы все еще понимают они все еще не ожидаю что на мастере будет правильное ведение я напоминаю в памяти hand и правда в базе вот главный постулат и все нормально селектор время когда сеть перестанет глючить поймет в мастер что он здесь лишний старый и помрет то есть это состояние какие-то десятки секунд занимает может даже меньше зависит конечно от поломки и наконец про оптимизацию которая просто не мог не упомянуть смотрите в чем идея у нас есть много запросов прям параллельных допустим нас пришло наш мастер опять же важно что нас есть один мастер вместо централизации 100 запросов на send message то есть нужно записать 100 сообщений ok как можем это сделать наивным решением был бы просто ну сделать что запросов базу конечно есть записать стал строчек базу супер работает до медленно да и как это можно пофиксить смотрите мы же данным методом прекрасно знаем чем мы хотим и мы даже знаем все запросы какие к нам пришли они нас и даже записочек наших актерах типа чего от нас хотят а почему бы их не сгруппировать и хорошая идея давайте так и поступим то есть вот эти вот 100 запросов в базу мы преобразуем ватин запросы базу но он будет писать 100 сообщений и когда он закончит свою работу все очень просто мы вот этим вот 100 запросам и еще типичным отошлём их ответы фразам все хорошо но мы с экономия получается транзакций путь из 100 раз меньше всего одна версия сотню и если рисовать такую красивую румяную диаграмму она объясняет следующее вот пропатчен cda если мы что-то группирую можно группировать очень наивно например ждем одну секунду вот чё за секунду пришло то мы и отправляем базу да здорово такой квант секунду раньше логично нет на самом деле не логично потому что бывает учили который не нагружен то вообще один запрос час или бывает наоборот который вот 1 секунды работают у вас нет ни се получается какое в это если получается целое секунда хотя там меньше сотни миль секунд должно быть как это можно решить здесь используется такая идея взята у на игла на который нарезал в тисе пи я и пестики это именно такой умный адаптивный починку все нас мере очень просто представьте к нам пришло сообщение нам нужно сделать одну транзакцию и мы начинаем я сразу хочу терять ты сейчас трансфокатор них не запущена когда придет следующие непонятно лучше начать сразу таким образом мы покрыли кейс когда в очереди приходится общине мало редко и вот если будет отлично в этом случае вообще ничего не ждем сразу идет она второй вариант это как раз когда очередь какой то на загсы прямо сейчас делает мастер об этом из теста знает про все транзакции и приходит новый запрос на запись еще вот которые запросы на схеме 2 3 4 ведь у них состояние по фред здесь не ждут ждут момента чтобы записаться как только первая транзакция закончила свою работу вот тут как раз начинается вторая и она как раз сгруппировав все запросы делают один такой почтовый запрос и такой адаптивный подчинено сам или очень хорошее решение и максимум какой негативный эффект оно оказывает это некоторое увеличение для среднего случая но средне случайно совершенно редкий очередь чаще всего именно очень загружены либо очень слабо загружены и в целом за счет уменьшения количества транзакций стала быстрее вообще везде просто стала secu мини нагружено базами и нагружен по должны стали делать меньше всякой ерунды и улучшилась на самом деле все совершенно запросы в том числе и средняя давайте подойти итоге потому что кажется мой час заканчивается про очередь сообщение я надеюсь вас убедил кому-то рассказал кому-то напомню что это очень крутой инфраструктурный компонент его надо использование только в гугле то есть кто-то говорит там сейчас дорожить он станет гуглом и тогда а нам потребуется о тебе нет очень ли можно использовать когда очень маленький это просто удобно она очень хорошо масштабируется и за счет этого и и элементарная оставить просто включили и забыли о не потребуется не больше нечего делать то есть вот уж на горском станет уже ближе к состоянию к угла у вас скорее всего помимо этого я рассказывал страшилку про доставку и хочу чтобы точно усвоили что экземы vans если кто-то продает вот прямо из коробки язык ливанцы нас пожалуйста не верьте до принципе невозможно так не бывает нужна поддержка напоминаю продюсере на консилиуме в очереди вот только так со всех сторон и иначе будут либо дубли либо потерям кроме того мы рассмотрели два подхода с умным брокерам и тупыми потребителями и наоборот как раз про трепет и про кафку что еще что важно делать свою инфраструктуру если у вас достаточно большой масштаб если есть потребность ну что не клиентов они не их нельзя удовлетворить какими-то внешними инсталляциями то выгодно делать свои решение по крайне мере нам это принесло огромную пользу ну и наконец про такие технические детали напоминаю что построен на мощной платформе войти п коллеги сегодня и завтра будут еще рассказывать про другие продукт который тоже на ней построен так что убедитесь что это реально универсальная платформа они просто базы данных и наконец про оптимизацию и проблемы и она тоже рассказал и забыл по не только вот что что это вот оптимизация с бочонком увеличила количество сообщений проходящих 160 раз то есть это не просто какие-то полтора-два это реально 60 целая куча была снова 500 mps стала 30 тысяч ну вот мне кажется все спасибо за внимание отвечу на ваши вопросы от 17000 вопросов друзья здесь сейчас продолжается программа в этом зале мы можем остаться в этом зале у нас есть два часа на то чтобы задать василию все вопросы отлично поехали вот отсюда наш добрый день зад геннадий васильев спасибо за доклад очень интересный меня интересует следующий вопрос как в яндекс мысль организована тестирование мониторинг о это прямо в отдельный большой вопрос если я сейчас не успею я готов после доклада рассказать подробно значит смотрите у нас есть юнит-тесты который просто какие-то локальные там валидацию например в очереди проверяют потом нас есть функциональные тесты они поднимают такой маленький кластер маленькую очередь на одной машине и они прогоняют через неё всякие там кейс с многопоточность you еще чего-то но просто тестируют ее пиарь кроме этого здесь регулярно тесты на камин естественно репозитории что все это про гонялась и часть который blue больше всего это тесты которые гоняются в продакшене прям серьезно мы сами себе нагружаем продакшен как это выглядит есть два типа тестов один тест это такой сошедший с ума пользователей он дергает вообще все подряд в тоже в том числе вызывает методы которые не надо вызывать вызывается совершенно дикими параметрами им только вздумается 100pro валидации про такую вот защита от дурака короче говоря проверяет ну и пару раз она все-таки стрельнула и мы про это конечно узнали через наше мониторинге второй тест это тест на нормальный человек нормально пользователя в чем здесь идея очень проста у нас есть реализация такого не знаю эталонного клиенты стали на потом и такой билетик на питоне как раз можно пользоваться как amazon им с помощью нее так и в частности нашими из-за совместимости и pr так вот оно что делает она делать ровно то что нужно от очереди она записывает сообщение в очередь вычитывает и сравнивает что она совпала причем эти сессии там ну много чего вы на самом деле есть на реально часами пишет часами вычитывает вот такие вот вещи то есть я прям сейчас уверен что эта штука работает и прямо сейчас если все хорошо то любой клиент сможет создать свою очередь что-то в ней сделать ну и по принципу подобия нужно также отработать хорошо то есть нас если мы что-то выкатываемся на продакшен нас есть конечно креста и был но я этому всему не верю то есть у нас естественно все конечно при стебли но стать что прямо сейчас на продакшен все работает для меня очень ценно а так как ну клиентов паттерна нагрузки может быть разный подход раза например там человек пишет много читает очень редко или еще что-то нас есть ли такой клиент очной страны но им так нравится получается что на них на их метрик из моих нельзя потому что они соберутся слишком по-разному вот эта модель на нагрузка парализует этого идеального пользователя очень хороша в том числе по ней можно показывать клиентам смотрите тут а меньше 100 миллисекунд в очереди находится меньше than 200 тут зелененькое тут красненькое вот хорошо что под был также нагрузка если что у нас вот этим вот тестером делать совершенно небольшая там не знаю 5 запросов на запись и 10 на чтения то сделал вовсе не в количестве мы конечно можем сделать там десятки тысяч но в этом толку не кого-нибудь на и больше ничего не будет проверять особо вот про мониторинг еще я не договорил превращения значит в мониторингом как у нас есть метрики мы собираем пологом есть графики и не сиськи это пороги на количество например ошибок мы мониторим ну смотрите как называешь тебе и пи ай да значит какие мы хотим штуки мониторить ошибки конечно вот мы мониторим природе пятисотке потому что 500к значит что что-то вот внутри плохо и клиент ничего не может сделать этой проблемой не единственная опция в жизни это за ретро эти вот это очень плохо конечно мы пятисотке стараемся полностью уничтожить хотя конечно спецэффекты сети но не оставляет шансов там а не бывает и мы еще мониторим средств на 4 сотки помимо этого есть отдельно внутренний слой что на что мы смотрим это файлы транзакции то есть клиент может не увидеть моего за ретро или но если постоянно фрица тоже плохо и вторая половина чем еще мониторим то есть у нас же есть платформа из бизнес войко я же говорю про бизнес лойко очередей а еще надо мониторить саму платформу то есть машины сыпью диски как это все загружено и до 100 же естественно есть то есть мы следим за здоровьем кластера в принципе вот спасибо большое спасибо файла репин спасибо большое за то клад очень хорошо все разложено структурирована но есть только момент что вы создали для пользователей идеальные условия эванс это гарантированно но у этого есть своя цена почему такая их не изменяет скрывает сообщение для это нужно изменить более тупая вещь не тот отдельная штука про язык эванс наша очередь не предоставляет их за клемансо если что индекс мисочку и давайте еще раз проясню может быть был не очевидно смотрите у нас не одна очередь у нас я насмешки не используется всем яндексе мысли есть куча сервисов которые используются в том числе и и но это не единственная очередь нас есть или зация кафки более надежный но с теми же концепциями то есть я сейчас не пытаясь продать очередь как решение всех проблем конечно же для каких-то сценариев кафка лучше ну прям точно лучше например прокачивание большого объема данных вот ваньку за счет то что на базе настой баз данных но это не 40 чтобы там реально мегабайты через него какие-то блага плохо вот какая же цена то это была часть насколько оно медленнее кафки если взять отвезут инфраструктуры сколько стоит но это в чем в чем ими измеряем ты их попугаях пропускной способности очень большая ну я говорил что там пропускная способность это именно вот эти шарды там по 30 тысяч сообщений можно закидывать улыбнись и на запись ну не вас 9 там 100 миллисекунд например получается но вы можете писать не по одному сообщение например а по десятке такой патче и это в этом совершенно нормальная доброта клиентов вполне хватает это самое главное но сохранится надежно в 3d c вот почему 100 то есть вот в той же папке за счет отсутствия в sing вот это получается быстрее слышу много механизмов который повышает надежность там типа открывания сообщений потом каждый раз после сообщения записать их на диск это же как и все имеется но друзья я прямо представляю как вы на автопати сидите рядом и долго и подробно разговариваете об этом но як я просто хочу сказать один момент вот по поводу отвечу чтобы на всех эта очередь не никак кафка то есть в ней пробрасывать ты сегодня проходить гораздо меньшее количество данных чем про нашу реализацию кафки то называть слог брокер внутренние да там десятки гигабайт в секунду здесь меньше значительно и здесь дело даже не в этом си ну то есть где то нужно просто простой и pr я вот о чем отталкиваюсь говорю что где-то не нужен непорядок ничего игла что был сохранен надежна и проста как топор это реально вот нужно большинство базе большое за ответ спасибо хорошо когда кот не какая-то можно здравствуйте спасибо за вашу презентацию и такой вот у меня вопрос будет ли open source или что-то похожее примерно стоит ли в принципе хоть как как надеяться на это open source именно реализации похожей системы например там не знаю на крик хаусе хотя он наверное не подойдет для других задач ну пока что непонятно это лучше в нашем менеджера спросить но скорее всего не ближайшее время потому что там главная эта штука находится в раскаленной платформе это такой прям индии ноу-хау супер фичей ну то есть самой такие мощные технологии их просто так обычно но не отдают наружу как эта штука работает снаружи я могу рассказать хоть сейчас там подробно 10 каких соц секретов нет более того я пытаясь как раз всем рассказать чтобы убедить в надежности решения и производительности а вот то что действительно выкладывать без чего принципе не заработает это должно пас данных так ладно тогда второй вопрос у меня вы сказали что обеспечивается бесшовный переход секрет из кейса на amazon aws команда как это было достигнуто просто как бы про притащи на гарантируется в 7 c совместимость с другой про перед аршина и причем будучи 2 проприетарных производителя конкурента как это вообще возможно да если есть достаточно простой и пейзо совершенно подробная тока и немного фантазии ну то есть в чем идея во-первых принципе понятно как сообщи нужно себя вести то есть там протокол очень понятный там описано то как должно отличаться в частном ответьте в виде xml это строго естественно и регламентирована и мы изучали то что написано там библиотеках то что сами тестировали как-то немного amazon то сделали сами запросы ну то есть естественно у нас нет коллегии никаких утечек из амазона которые нам рассказал типа меня сделанного тут вот тут я вам даже пришлось кипятку доставьте о себе у вас будет такая же очередь нет ничего подобного мы использовать только одно что юридически не защищается это и pr вот и все то что все остальные библиотеки которые совместимы получились типа того же под и и прочие там работы из коробки c лари там все остальное это просто следствие хорошие лизации заместим а я пьян ну так получается то есть ну в этом то есть нам удалось добиться самих деморализации конечно же задача в общем случае так не решается если там внутри что-то космическое находится понятно спасибо пожалуйста здравствуйте спасибо за доклад меня зовут илья у меня два вопроса касаемо batch операции которые вы продавали здесь первое это когда вы агрегирует большое количество сообщений пытайтесь ставить базу что происходит в случае если 1 запись бог какой-либо причине не может быть сохранено откатывается вся транзакция или таким образом она перри повторяется в египет остро консистентная база и транзакционный то есть дали бы все либо ничего этого первых но и про патче мы стараемся их не перед накапливать слишком большим я это не прямо в докладе потому что он и так уже занял час но мы по достижения паленого порога тоже их сбрасываем то есть представившего сведет транзакция прямо сейчас нас пришлось за 1000 сообщений на самом деле мы их нарезаем еще на пять матчей по 200 и у шлём от отдельно но естественно если что-то по файлу с пределах одного патча но все 200 не записались получается да они будут как-то записаны в итоге или все они считаются потерянными ну во-первых ретро и на нашей стране где мы пытаемся повторить транзакцию естественно и второе это ретро и на клиентской то есть мы честно скажем не шмогла и в одним пятисотку большинство клиентов ну так реализованные что по умолчанию пятисотке тут же ботан priori троит сам то есть даже не будет видно что внутри там что-то попробовал сделать еще вот да спасибо и второй вопрос у меня был вы частично ответили на него вопрос как вы определяете тогда количество строк в одном патчи для записи на самом деле это не какая-то подбирая величина она была найдена эмпирические во время стрельб эта группа куря ну в данный момент по крайней мере настройка в конфиге на равна действительно 200 с общением и мы замеряли что мы замеряли ну да в этом сие записи versus там количество транзакций нагрузка на кластер то есть мы приз вот этот оптимизировать дела и там получилось 200 то есть там нет никакой особой магии мы просто ну тестировали естественно для какой-то другой конфигурации кластера там хоть не за другой реализации все может быть по-другому поэтому рекомендация про 200 здесь и и не даю я говорю только про то что замеряйте хорошо спасибо большое здравствуйте спасибо за доклад вопрос такой по поводу consistent насти данных вы сказали ваш these что если очередь сообщений отдала что она записала сообщение то значит она его точно записала означает ли это что f sing выполняется на каждую запись и если да то на сколько это несет за собой больше затрат чем по таймеру делать и всем как сейчас модно и второй вопрос где в этой схеме еще репликация на при дата-центра хорошо отлично вопрос кстати про схему значит смотрите там все действительно делать асинхронно во-первых сообщение не подтверждается пока не сделал реальный sing да это удар по performance у но нет у нас нет цели и прокачивать огромное количество сообщений и огромное количество данных поэтому это все достаточно дешево выглядит то есть там до 100 миллисекунд теперь про 3d c ну мы пишем сразу синхронно в 3d c если один из дата-центров стал недоступен хранилища мы все еще сохраняем вот эта вот гарантию то выпадение но он 1 машина дата-центра все еще работает таким образом мы начинаем писать в 2 дата центра но под дверью блики в каждом поэтому смотрите если выпадает еще одна машинам но все так же работа еще один dc все роста это одна копия вот вот так вот то есть мы за надежность получается в кафки там это просто такой грязноватый трюк стали что нога решил все записал на самом деле ничего не записал таким образом качество достичь очень маленький халатности тоже мы делаемся в памяти но надежности и от этого не повышается только уменьшается спасибо очень интересно претендент на книгу мне кажется за лучший вопрос согласен извините еще один вопрос появился возможно у вас есть такая тема что есть очереди для которых нужна разная разный уровень надежности то есть из допустим очередь который нужно быстро прокачать а другие допустим надо очень надежно сделать то есть допустим этих транзакций по карточкам может быть очень мало логов всяких кликов допустим тех же самых на банковских формах то есть это получается решает это задача разные очередь допустим кли house и яндекс с очками у вас до с выбором так пара дим устройте для своих потребителей что типа вот вам нужно надежностью используйте нашу вечную неделю нагружать есть потребность большом объеме значит надо использовать допустим cliff house да нет по не совсем так говорим хотя первый план фразу угадали значит я повторюсь нас ну в принципе час ольгой кликал с не продаю и более того мы срезаем использовать просто другую наша очередь который тоже построенного и т.п. она тоже надежная но она с портится мена как кафка она прокричала десятки гигабайт секунда прям сейчас именно ей маркиным использ когда нужно в активе логе прокачивать им натяжение все прокачанным стандарт такой в компании вот это уже урчит на более продуктовая то есть люди которым в первую очередь нужно было севере если знает такой framework асинхронно задач или там тот направил писал хотя печки у нас не то чтобы распространенный там нога еще чего-то делали вот ему нужно было именно задачей раздавать в тут очередь хорошо наша заехала там например еще видео использует очередь вот это вот военку она не пересылает данные важно надо пересылать ссылки на видео который нужно сконвертировать то есть видите смысл о том что необязательно данные все в очередь пихать он просто прихоть ссылки на данные вот а если действительные логе то там уже лоб брокерах я уже будет это первая очередь самая большая самое крупное типа скажите пожалуйста вот это вторая очередь она open source на или нет как как race 2 которая производительная поймали мы не ну к сожалению она тоже построенного и db2 я тебе не open source на я без нее не заработает не поем все получается open source ведь ну то есть фактически это ноу-хау такое то есть там где кафка сломалась нас ну я честно скажу в компании начала кафка и когда кафка достигла своего предела мы начнет свое решение какое-то много раз лучше с этим справляется нужно река народ здесь не очень понимаю в чем проблема доказать бы всех кафка всех все работает этот чувак asiana заверяет не тряпка не работает ну казалось бы чем что тут можно сказать весит это в объемах если вас словно говоря там шанса выпадения машинки там не за один процент в день у вас там 1000 машин у вас получается 10 машина падает до если вас там он 3 всего h100 ну посчитайте матожидания короче говоря с некоторых объемов начинаем кафка просто перестает работать невозможно контролировать невозможно балансировать тяжелой партиции нельзя перевозить если выпадает узел там просто кошмар какой-то начинается с тем чтобы это все дело поднять в общем страшилки конечно лучше расскажет нашу эксплуатацию более подробно про кафку это тесто не застал но у меня хватило к истории от коллег которые объясняли почему не кафка и получается что вторая очередь она умеет используйте и гибель в боевом из да она использует примитивы vdb так называемые там таблетки там мог пройти все коллеги расскажет а может мне это могу потом по подробнее чуть чуть спасибо спасибо я пойму это будет в следующей тем да я думаю василий заслужил пообедать спасибо большое но кому дарим книжка за лучшие вопросы я думаю сам могу тебя ногами по отлично но это не мучитель это любопытный человек хороший человек неправильно не сдаваться а еще пример это шутка такая что когда тебя страшное этого пан source когда это когда ну вы если хотите все технологии приходите к нам работу ну то оттуда мы нанимаем кстати и тебе тоже большое спасибо благодарность и дополнительные аплодисменты из самых стойких россия польша"
}