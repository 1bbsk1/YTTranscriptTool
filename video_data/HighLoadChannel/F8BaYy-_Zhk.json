{
  "video_id": "F8BaYy-_Zhk",
  "channel": "HighLoadChannel",
  "title": "Геопространственное моделирование с применением методов машинного обучения / К. Измайлов, Е. Макин",
  "views": 771,
  "duration": 1621,
  "published": "2021-10-04T02:44:28-07:00",
  "text": "всем привет меня зовут исмаил в константин это мой содокладчик евгений и сегодня мы расскажем о том как мы используем методы машинного обучения для работы с нашими дел задачами расскажем это на примере такого проекта под названием алгоритмические зоны доставки ресторанов расскажем что у нас там творится под капотом как к вид повлиял на развитие проекта а также посмотрим на бизнес и результаты которые мы добились добились с помощью внедрения данного подхода и так пару слов о нашей компании наша компания за последние 10 лет прошла огромный путь проделала огромный путь и начиналось с небольшого стартапа и сейчас уже является доставка еды номер 1 в россии и входит совместное предприятие mail.ru и сбербанка для того чтобы чуть лучше понять наш доклад стоит сказать пару слов а наши бизнес-модели компании которая состоит из двух частей соответственно первая часть наш компании эта доставка заказа собственными курьерами то есть когда мы как платформы передаем заказ непосредственно в ресторан ресторан готовит заказ к определенному времени доставки затем наши курьеры забирают этот заказ и отвозят непосредственно клиенту и вторая часть нашей бизнес модели это так называемый marketplace когда мы передаем заказ в ресторан ресторан готовит этот заказ и отвозит заказ уже с помощью собственных сил собственными курьерами в каких-то заранее оговоренных с нами зон доставки ну соответственно за заранее определенное время в рамках нашего доклада мы сосредоточимся именно на первой части нашей бизнес модели а это именно доставка заказа собственными курьерами потому что именно данная часть открывает огромное окно большому числу физических задач и как раз алгоритмический зон доставки ресторанов является одной из этих задач и так пару слов также еще про географию нашей доставки сейчас доставка собственными курьерами у нас происходит более чем 80 городов по всей россии и соответственно в каждом из городов располагается более тысячи партнеров и у каждого партнера есть какие-то определенные индивидуальные особенности ну естественно свои определенные зоны доставки но давайте соответственно переходить к непосредственно задача отрисовки зон доставки что хочет от нас бизнес ну с одной стороны мы хотим сделать так чтобы нас было большое покрытие наших клиентов до чтобы когда клиенты заходили наше приложение у них был огромный выбор среди ресторанных доступны к заказу но с другой стороны мы также не хотим чтобы у нас наша доставка была неэффективных с точки не эффективно с точки зрения логистики до чтобы курьера не тратили очень большое количество времени чтобы доходить до клиента возвращаться обратно и чтобы это было достаточно эффективно соответственно с одной стороны мы хотим чтобы у нас было высокое время доставки высокое покрытие и соответственно с другой стороны чтобы нас было низкое время доставки низкое покрытие вот на этом соответственно заточены наши подходы для балансировки между двумя этими частями и так давайте также еще расскажем про то как у нас складывался исторический наш процесс или какой у нас было legacy по отрисовке зон доставки в нашей компании естественно как это обычно бывает все у нас происходило руками в этом процессе участвовал нас порядка пятнадцати двадцати координаторов которые можно сказать скрупулезно ночью работали над данным процессом на слайде тут представлены различные виды отрисовки зон координаторами то есть кто-то из координаторов от рисовал сначала окружность потом из них можно сказать откусывал какие-то куски какие-то координаторы вот вида на средней картинке как раз больше отрисовывать и зоны по графам дорог какие-то координаторы наоборот рисовали прямоугольник и уже из него отрезали какие-то части но стоит сказать можно даже что у каждого из координаторов был даже какой-то собственный стиль в ручной отрисовки за естественно такой подход был не очень хороший поэтому мы в свое время сталкивались со следующими проблемами это естественно непостоянство алгоритма и его непрозрачная логика это субъективизм принятие решений о форме зоны и и характеристиках это однообразный подход к отрисовки крайне низкая скорость естественно ручной труд менеджеров пан бардин был ресторанов и отсутствие возможности регулирования цен доставки внутри зон ресторанов для нашего подхода с помощью которого мы хотели автоматизировать этот процесс мы поставили цель побороться со всеми этими проблемами ну и наверное с чего мы начали виде некого бы зла и на естественно мы решили рассмотреть простой круг естественно да когда он есть такая задача по отрисовке какой-то зоны круг наверное это первое что приходит в голову достаточно быстро сурово просто и соответственно для всех понятно но тут сразу мы столкнулись с двумя проблемами первая это естественная однообразный подход в работе с нашими ресторанами то есть ресторан по доставке кофе и ресторан который занимается кейтерингом получали зоны доставки виде окружности и снимем могли работать ну и второй уже более такой серьезный подход это естественно артефакты зонда ставки будут на пример на слайде видно о том что в центре у нас данной окружности находится ресторан и видите тут например неподалеку находится река тут например у нас видно что есть мостик но зачастую в городах с большим количеством водных массивов этих мостиков могло не быть соответственно отрисовываем окружность и например части окружности заходя за какие-то части водного массивы быть может даже за какие-то технические объекты инфраструктуры мы могли столкнуться с тем что эти зоны просто были недоступны для курьеров для доставки и в том числе например если там находился клиенты и нужно было например доставлять ему заказ 100 курьера приходилось делать просто огромный крюк соответственно мы могли бы получить огромную нагрузку наш колл-центр а как со стороны клиентов которые получали свой заказ с действительно намного большим временем чем мы закладывали с помощью данной зоны или же курьеры которым тоже опять же приходилось для того что выполнить всего лишь один заказ 3 это порядка двух-трех часов на его доставку еще мостике или какие-то переходы в данную зону стоит сказать что мы пробовали в качестве быть line также еще некие усложнения нашего алгоритма используя такие популярные алгоритмы как яндекс full или альфа шейп здесь мы начинали отчасти бороться с артефактами зон доставки но при этом проблем индивидуального подхода все равно оставаясь для нас большой проблемой соответственно со временем мы начали приходить к такому подходу который использовал методы машинного обучения подходы связанные с учетом близ лежащий инфраструктуры для каждого из ресторана и про это мы соответственно расскажем в нашей следующей части доклада а именно в техническом треки жизнь тебе слово да спасибо константин да всем привет меня зовут евгений и я расскажу про наш технический трек и про особенности реализации нашего алгоритма в основе всего лежит такая технология от компании убер который называется h3 вот поэтому сначала пару слов об этом что это такое а система h3 система индексации это такая дискретная сеточная система которая состоит из а мозаики из мозаики гексагон of то есть есть и говоря простыми словами то вот у нас есть какая-то поверхность есть какая-то области мы покрываем ее вот такими гекса гонщиками вот почему мы выбрали h3 зачем эта технология вообще существует несколько способов измерения географической области на сегменты в основном это ручная разметка и регулярная сетка ручная разметка она делать с людьми да она учитывает какие-то особенности местности какие-то может отдельные районы может учитывать но есть некие граничные эффекты которые очень нежелательные данных задачах а также это не мечта беру и мое решение никакой автоматизация в этом нет это большой ручной труд очень долго работа второй вид разбиение области на сегменты это регулярной сетки чем они хороши тем что это такой некий уникальный подход мы по какому-то единому алгоритму разве разбиваем нашу область и в целом это масштабируемое решение этой как раз often автоматизация сейчас существует в принципе три вида многоугольников который располагается регулярно это как раз треугольник квадрат и гексагон самым главным отличие между в них является то что чтобы работать с ними надо хранить для треугольника три расстояния для квадрата 2 расстояния и для гексагон на одно расстояние расстояние до соседних элементов соответственно geeks огонь и одно расстояние это намного меньше по памяти это удобно поэтому мы выбрали его но кроме этого мы что ещё знаем из отличная библиотека у компании убер она реализована на больших на большом количестве языков там на питоне нога там в хаусе также есть соответственно скорость вычислений большая можно делать очень быстро тяжелые какие то вычислений например посмотреть вхождение точки в полигон я или замостить какую-то область это масштабируемое решение потому что мы заранее уже можем определить какую то географическую область и и разбить ее на гексагон и и несомненным преимуществом конечно всех регулярных таких сеточных подходов является то что мы можем хранить в нашем сегменте то есть гексагон никакую не характеристику какой-нибудь свойства теперь непосредственно алгоритм сам создание зон как уже сказал константин мы оптимизируем какую-то нашу целевую бизнес метрику это может быть либо время доставки либо допустим живи живи нашего изучаемого ресторана первый шаг нашего алгоритма мы просто создаем некий набор точек на поверхности и вокруг ресторана и рассчитал расстояние до каждый из них с помощью маршрутизатора ну точки мы сдаем неким образом там допустим чем ближе к ресторану то тем точке должна быть плотнее чем дальше наоборот и еще мы располагаем точки по спирали чтобы облегчить некую работу шути zatarra о том в изучаемой нами области мы находимся постройки все живые здание мы знаем об этом информацию мы знаем сколько там живет людей и поэтому мы можем отбросить какие-то нежелательные для нас постройки нити которые нас не интересуют ну еще помимо мы просто кустари зиру им все наши эти постройки и удаляем точки выбросы что именно удалить мы расскажем чуть позднее то есть как мы понимаем что допустим желтый гексагон вот там оранжевый гексагон на свадьбе можно удалить так же еще чуть-чуть работаем с выбросами мы когда определяем ближайшую ноду на графе yanus изучая нашей точкой если она очень далеко находится то мы выбрасываем такую точку из анализа это обычно какие-то реки острова ну и так далее вот потом мы на наших точках уже очищенных променяем 30 акцию давали почему этот чуть позднее расскажу вот самое главное потом мы опять же в изучаемой нами области делаем сетку регулярную сетку но виде гексагон of это как раз изучаемой нами гексагон и потом так как мы уже ранее сделали от регуляцию до войны мы можем для каждого гексагон а определить к какому треугольником прям лежит и затем для центра каждого гексагон а определить расстояние от центра то есть от нашего ресторана до самого центра гексагон а мы это делаем через аппроксимацию просто патрон вершин треугольника потому что в каждой вершине мы уже знаем сколько идти курьеру от ресторана до клиента дальше самый интересный шаг это как раз оптимизации нашей функции ошибки она зависит от нашей задачи как мы осуществляют оптимизацию это достаточно простой способ мы просто жадно начинаем удалять по одному гексагон от внешней границы какой гексагон мы удаляем опять же об этом чуть позднее причем мы следим еще чтобы наша зона доставки не было разрывной что было у нас обеспечена связанность ну и финальный шаг это просто временное градиент на получившихся зонах мы это делаем для того чтобы у клиента была более точное время то есть last mile последние вот определяется исходя из маршрутизатора его такого способа я не раз говорил о том что мы когда очищаем какие-то точки исследуемые когда работаем с кристаллизацией когда мы оптимизируем функции ошибки мы удаляем какие-то гексагон и как мы это делаем для этого написано отдельная модель которая для каждого ресторана которых ну-ка нам подключается на платформу для каждого гексагон а мы определяем нашу целевую метрику ну допустим этот живи как мы это делаем ну отдельная модель кадет на угу стинга она учится на основе информации о конкурентах а население очевидно самая значимая фича а conversions sti потому что если допустим какой-то ресторан уже к нам подключен мы можем сказать в целом какая там конверсия вот и информацию с внешних источников со всех с различных это отзывы рейтинги ну и так далее вот но последнее о чем хочется сказать от технические особенности то есть как долго строятся зона ну на текущий момент построение одной стандартной зоны занимает одну секунду ну что конечно устраивает наш бизнес это непосредственное является автоматизацией данного процесса на этом все технические терапия озвучил передаю слово константину спасибо итак алгоритмы написанным нагрузочные тесты пройдены и остается самое важное самое главное для бизнеса это внедрение ну тут стоит сказать что мы сразу столкнулись с неким скептицизмом со стороны наших координаторов которые восприняли внедрение данного алгоритма как восстание машин которая лишит их крошки хлеба их машины полностью заменит их работу координаторы буквально во время внедрения находили иголки в стоге сена и очень активно реагировали на любые недочеты но из другой стороны рестораны достаточно с опаской подходили к новомодный фичи не понимая как так может алгоритм решить такую сложную задачу как-то индивидуально подойти к каждому ресторану и отрисовать зону и не понимали почему у зоны доставки не могут продолжать отрисовывать соответственно люди но тут пришел к вид тысячи ресторанов начинают закрывать свои филиалы увеличиваются зоны доставки у ресторанов для сохранения прибыльности сокращается меню меняется целевая аудитория у ресторанов меняется формат работы ресторанов клинер и сотрудники пекари меняет свою профессию и становится курьерами как все об это прекрасно слышали и естественно растет вообще в целом количество заказов на платформе и тем самым наш подход и наш алгоритм оказывается к месту он получает оглох огромный boost и потребность есть как со стороны соответственно изнутри со стороны нашей платформой которая пытается удовлетворить спрос в росте такого числа заказов но из другой стороны сами партнеры приходят к нам и говорят что им срочно нужно поменять теле из или иные условия зон доставки и тогда наш алгоритм соответственно начинает внедряться очень активно в продакшн буквально за неделю мы переставали для 80 процентов вообще всех наших партнеров зоны и они все стояли алгоритмически me но естественно в такой суматохе мы не должны были забывать про оценку того же все-таки что мы наделали возможно мы сделали все хуже и поэтому через какое-то время мы верны возвращаемся к оценке эффекта от нашего внедрения оцениваем эффект мы с помощью так называемого switchback теста который представляет из себя попеременное случайное изменение контрольной и тестовой группы где в контрольной группе у нас были либо ручные решения то есть исторические legacy решения от рисованных за нашими координаторами либо какие-то более простые подходы которые мы упоминали в рамках нашего доклада то есть это либо простые прямоугольники либо это простые окружности зон доставки а соответственно в тесте у нас было два наших алгоритма мы оптимизировали с помощью одного алгоритма это соответственно покрытие фиксируя время доставки и с помощью другого алгоритма мы оптимизировали соответственно время доставки стараюсь его максимально уменьшить но при этом сохранить количество активных наших пользователей и в результате такого switchback теста мы получили значимое улучшение и стабилизацию дисперсии в рамках алгоритма с фиксации зоны доставки и уменьшения времени доставки для соответственно алгоритмов оптимизации времени доставки что сейчас у нас происходит сейчас у нас сервис активно работает в продакшене зоны автоматически строится пока что по кнопке но при этом у нас появился самый главный функционал для тестирования так называемых листьев доставки то есть увеличение стоимости доставки в зависимости от удаленности ресторана от клиента также на текущий момент у нас 99 процентов ресторанов перешли на алгоритмические зоны и в целом наш алгоритмом поспособствовал и явился некой предпосылкой переходу вообще всего нашего бэг-энда на уже упоминавшейся сервис h3 в планах у нас естественно это развитие оптимизации новых функционалов это полная автоматизация процесса on вардинга да сейчас у нас по кнопке хотим все таки чтобы полностью план был автоматически подключением партнера но естественно это ускорение алгоритма в целом говоря про данный подход и про данное решение можно без утайки сказать что оно помогло нам побороть можно сказать к вид и внешние обстоятельства которые нахлынули на нашу компанию также данной данное решение открыла нам огромное окно для различных логистических задач это работа с улучшением временем доставки за счет использования к разбег загонов доставка один из проектов по которым мы как раз в рамках нашей компании работаем сегодня это естественно тестирование различных лесник доставки когда у нас отдельная зона строятся на разные разные удаленность клиента от ресторан если за раньше зона представляли у нас какую-то единую сущность на которую мы ставили какие-то однообразные свойства то сейчас у нас можно сказать это происходит очень точно и градиент на ну естественно это также работа с различными рода рекомендациями для размещения ресторанов когда мы начали получили доступ к так называемой из близлежащей инфраструктуре ресторанов мы понимаем какие клиенты вокруг ресторана у нас живут как а инфраструктуру нас находится внутри и можем отлично рекомендовать например кофейни размещаться рядом с бизнес-центрами а тем же например услугам кейтеринга ну ладно опять же рекомендовать зоны близ лежащих офиса вот на этом всем большое спасибо за внимание мы так же набираем ждем талантливых ребят в направлении до the silence направлении аналитики а также смежные технические подразделения и рэнди всем еще раз большое спасибо будем рады ответить на вопросы добрый вечер спасибо за доклад огонь и вообще очень понравилось хотел спросить не приходило ли нет ли такого в баттлоге трекать перемещение курьеров в зависимости от того на чем они передвигаются вот это же учитывать и в построении ваших зон доставки более точно оценки делать уже исходя из того где они собственно ездит и как они добираются потому что кажется что это прям такой honey pot для того чтобы более точно predict и делать да отвечай да как раз это есть в планах действительно как я уже говорил в каждом гекса бани можно хранить какое-то свойство поэтому если мы видим что допустим или предполагаем что доставит допустим well курьер да мы можем посмотреть свойства гексагон а и поменять вот это вот как раз время отсканировав его на скорость если это авто куверт у ну соответственно поменять тоже на это действительно тоже есть планах спасибо сразу здравствуйте меня зовут егор подскажите пожалуйста были ли проблемы с нижним новгородом там посреди города проходит река и несколько мостов соответственно гексагон и либо нужно какие-то рестораны наверное не хотят на другую сторону довозить другие хотят через мост в обход ехать это как-то влияет скорость как вы решали эту проблему на насколько я помню там как раз мост так вот какая да да помню на двух берегах ну это будет проблемно для тех ресторанов которые как раз находится ближе вот в соседи к двум берегам григору да вот но если это авто курьер это опять же в будущем будет больше за настроиться и потому что авто курьер может легко проехать через мост если пеший то действительно через можно невозможно уберите такой тем более большой вы пока просто делите да да поэтому вот так обрежется с одной стороны только спасибо да здесь даже могут уже пару комментариев дать о том что мы нижний новгород наверно использовали как один из городов для валидации нашего алгоритма потому что очень сюда как вы уже сказали очень сложной биография с ней да и мы смотрели как раз вот вы лидировали наш алгоритм именно вот по таким городам спасибо за доклад меня зовут андрей вопрос такой была ли у вас идея менять у вас доставки зависимости от времени суток то есть например бизнес-центр после восьми не будут заказывать но если рядом там жилой жилой квартал то туда уже буду заказывать чаще до большое спасибо за вопрос да у нас сейчас такой реализацией пока что нет но у нас она прям в баттлоге в наши jiri да когда зависимости от времени суток мы действительно хотим изменять зоны доставки я даже немножко раскрою ответ на данный вопрос в рамках нашего тоже батллога у нас есть такой проект под названием сопла диман баланс который не просто реагирует на время суток но также по размеру зон он также реагирует еще на текущую логистическую ситуацию внутри нашей платформы если у нас соответственно большая нагрузка на платформу мы для каких-то ресторанов автоматически будем сокращать радиусы зон доставки ждал чтобы увеличить частотность курьеров если у нас и тестом логистическая ситуация вся в порядке мы их зон доставки наоборот мы уже можем немножечко расширить для того чтобы как раз утилизировать вот текущее количество курьеров добрый день петр бирюков компания where point спасибо большое за доклад очень интересно два небольших вопросов 1 какой маршрутизатор использовали и второй вопрос он вытекает из первого учитываются ли пробки то есть эти зоны у вас они постоянные или они как-то адаптируются под текущую дорожную ситуацию спасибо да спасибо за вопрос ну наш муж на час а так мы используем osram ну openstreetmap по неким причинам вот а правки учитывать мусором не учитывая пробки понятное дело но были попытки возможном будущем все таки мы построим эту модель которая будет учитывать пробки вот пока без пробок скорее то отвечай на вопрос да мы скорее неявно учитываем пробки через вот контроль логистической нагрузки да то есть мы как бы изменяем размер зон когда понимаем что у нас прям и совсем перестаем доставлять до совсем нас временно достатка начинает увеличиваться вот за счет этого как бы мы вот как бы прокси такое решение к учета пробок спасибо большое"
}