{
  "video_id": "lvZyfuwJhSo",
  "channel": "HighLoadChannel",
  "title": "Dataplane networking acceleration with OpenDataplane / Максим Уваров (Linaro)",
  "views": 299,
  "duration": 2273,
  "published": "2018-08-16T04:46:46-07:00",
  "text": "прости меня зовут максим уваров и я старший инженер в компаниях линара я хочу вам представить проект ооо панда the plain надеюсь он будет интересно что это такое в качестве вступления можем посмотреть как вообще выстроена сеть то есть фактически данный рисунок достаточно простой какие-то пакеты приходят шины поступают сетевую карту поступает операционную систему в приложении и обратно вылетают дальше принципе все кажется довольно легко и реализации данной схемы в ядре linux вот я нашёл такую картинку она упрощенно очень выглядит вот так но смысл не вдаваться сейчас подробности этой реализации а то принципе понять что вещи они немножко сложно то есть прихода пакет приходит в сетевую карту обрабатывается прерывание она scheduled программные прерывания программные прерывания уже берет пакет и втягивает в сетевую под систему в систему софитов и приложения уже забирают сверху этот пакет и системы соки то когда мы говорим о сети точки зрения разработки сети программ насти мы можем разбить данная сеть вообще на два таких компонента два либо три то есть это один компонент который настраивает сети и делают мониторинг и другой компонент и to do the plain компонент который фактически занимаются обработкой пакетов сетевых то есть его задача как можно быстрее перекладывать пакет из разных мест дело с ними различные манипуляции и так далее если мы хотим делать обработку пакетов на циpкa то мы можем примерно представить сложность обработки то есть вот в данной табличке можно увидеть в правом нижнем углу что если мы хотим обрабатывать 100 гигабитный трафик на одном гигагерца 1а а гигагерц очень легко почитать потому что примерно 1 гигагерц это один цикл типа и у нас получается что фактически у нас для обработки одного пакета доступно всего шесть инструкции цб то есть это 6 на на секунду есть когда мы должны взять пакет его рассчитать и отправить обратно и основная конечно а задача это использовать все ядра циpкa к которой есть распараллелить обработку как можно больше делать это очень очень эффективно почему do the plain сейчас уходит в users так почему это не делается в внутри ядра linux а для этого есть ряд определенный ряд проблем связанных с линуксом то есть это задержки когда приходит допустим прерывание на сетевую карту возможно ваш процессор занят обработка других прерываний и вы фактически не знаете когда процессор освободиться чтобы обработать это прерывание или когда сработает трек с of товарный tracks of tartu отряд который программные прерывания вычитает пакет проблема в копировании пакетов из области ядра в область приложения проблема в том что скб буф в линуксе он занимает несколько кэш line of он сам по себе очень длинный его тяжело делать манипуляции соскобов нет поддержки аппаратных устройств которые в последнее время внедряется но недостаточно и один из таких вот моментов что если мы делаем нашу разработку полностью внутри ядра и что-то происходит в таком серьезном продакшене нередко что-то происходит допустим спустя полгода или год от такой нормальная работа то фактически с крахом вашего приложения вас падает все системы и вам нужно что-то с этим делать то есть перезагружаться некоторые систему загружается очень очень долго до the plain можно разделить на несколько вещей это таких областей то есть это когда полностью все сделано в хардвар в железе то есть какой-то asic или бы fpg когда сделано все софтвер то есть фактически используется сетевой картой и центральный циpкa это обрабатывает либо software define то есть когда ваше предложение она определяют такие вам какая вам функциональность нужно и если ваше оборудование может сделать это вы внутри в железе тогда делают именно это в железе и процессору центральному же отдает а конечный результат своей работы теперь что такое проект open data plan то есть это спонсорский проект open source ный проект который описывает айпи ой как управлять do the plain железом чтобы писать кроссплатформенные приложения его смысл такой что разработчики приложений они опишут свое приложение на сетевое под нет некоторые 5 например к это то же самое как опэн джи эль в графическом стыке то есть они используют версии 5 производители оборудования они очень хорошо знают как максимально оптимизировать свое оборудование что на написать реализацию твой пи и о типе как раз является той прослойкой между оборудованием и приложение самого проекта расположен на гитхабе гид хоп слышны наросла шдм он включает себя непосредственно самой 5 референсную имплементацию то есть базовую имплементацию это библиотека которую можно скомпилировать либо статические либо динамически можно ее скомпилировать в режиме бинарной совместимости то есть это бинарная совместимость например вас компилирую и для процессоров arm и можете использовать оборудование как допустим к веум nxp и в других либо в режиме несовместимости бинарных тогда большинство типов они являются онлайновыми и вы получаете самую быструю производительность репозиторий также имеет набор тестов и примеров и документацию для пользователя похожие проекты на уде пи это типе дикий над map и по и frank но в основном эти проекта не а более ориентированы на работу сетевыми картами о зеппе он ориентирован не только на работу сетевыми картами а если мы посмотрим в чем проблема с сетевыми картами при обработке сетевых пакетов то можно смотреть что огромный ботаник это со машинописи и и чем меньше у нас размер пакета тем больше дим дима и транзакции нам нужно сделать и тем меньше у нас пропускаю способность шины то есть вот эту картинку я взял с википедии и вот даже пися и 50 который еще не вышел у него батальная к фактический 40 гигабит в секунду то есть если говорить о типе детей и я пися то есть вот скорости выше чем 40 гигабит в секунду нужно что-то с ними делать если мы посмотрим на сетевое оборудование как вот выглядит напор на торг чип который именно предназначен для обработки сетевой трафик то можем видеть примерно вот такую картину как на рисунке то есть это несколько процессоров различные периферия оперативная память и в квадратиках это блоки которые поддерживаются пар аппаратными ускорителями например крипто блок random blog система таймеров и сверху это блока который отвечает за сеть как раз таки то есть есть программный классификатор scheduler менеджера очередей трафик менеджер и так далее и если есть возможность приложению использовать вот эти блоки в своей работе то естественно нужно это делать чтобы получить лучшую скорость у детей если его разбить на компоненты он выглядит примерно так слева направо то есть поступает rx трафик он попадает на такой абстрактный блок который мы назвали packed in потолок под по китаю а дальше пакет идет на классификатор классификатором он сбивается по различным очередям и scheduler внутри тренда он берет эти пакет из этих хотя очередей их каким-то образом там процессе выдает на выход вот блок который называется трафик менеджер который осуществляет шейпинг основном и через по китаю выдает обратно их в линию модель работы у dippy она вот выглядит примерно так то есть есть одно одно ядро она настроена чтобы запустить worker и выйдет выделить память configure и запустить a worker и worker и они это может быть либо процесс либо thread и поэтому я специально здесь не написал что это как конкретно worker он берет все ядро полностью вытаскивает у от linux то есть linux загружен с опцией и залп циpкa и стоит таскает на него и на максимальной скорости он процессе трафик на этом кадре если говорить о внутреннее устройство как о зеппе вообще вот устроен то есть он устроен абстрактными типами то есть о типе покидаете этот такой абстрактный тип ввода вывода у которого есть функции открыть его старт-стоп взять с него статистику и так далее тип абстрактный и фактически когда какой-то по китаю хотите открыть чтобы начать с ним работать вы указываете просто его имя абстрактный тип сделан специально потому что у разных вендоров по-разному называются устройства ввода-вывода то есть допустим в linux это может быть этично ли течь 1 baby дики это просто цифры 0 1 2 3 в реализации разных допустим это может быть не обязательно физической линии покидают может быть shared memory или что угодно вот этот тип он абстрактной и и он зависит от того как на какой имплементации сделан вашу dippy пакет сетевой пакет представлен абстракции у детей по kitty абстракция очень похожа на абстракцию скобу в линуксе соответственно там имеется похоже функции которые позволяют этот пакет уменьшать и увеличивать брать его размер и так далее но делать любые манипуляции с этим пакетом смысл в том что тоже типа пс этот абстрактный и любой вендора оборудования он может сделать библиотеку т.п. так как ему удобно то есть это может быть например какой то вот пакет может быть либо все там в какой-то памяти то есть числом либо каким-то индексом либо указателем либо так далее то есть у тебя и piano четко не закрепляет соответственно если люди пик компилируется в режиме бинарной совместимости тогда там общий тип для всех платформ но не небольшая потеря будут скорости но зато мы выиграем в совместимости базовый компонент у ди пьета очереди очереди это такой механизм когда поступают пакеты они относительно вас своего потока flow как их разбил классификатор они образуются в очереди и фактически когда у ди пиана читает какие-то пакет из этого из очереди то есть пакет input по китаю он предоставляет себя входную очередь и трек который процессе пакеты он читает пакет исходную входной очереди и также он отдает эти пакеты выходную очередь и интересно что в agepi очередь она приехали сна имплементация она сделана софт порно и и если оборудование не поддерживает аппаратную очередь то имплементация может поддерживаться в тварное но если оборудование такую как nx пеликаном они умеют делать это внутри аппаратно внутри железо-то очередь она будет использоваться на аппаратном уровне очереди бывают разные это бывают параллельные очереди которые рассчитаны на максимальную производительность либо очереди к которые соблюдают очередность пакетов помещенные в эту очередь существуют в дипе несколько режимов работы один из режимов это когда мы не используем scheduler мы просто берем пакет из входной в очереди и кладем их выходную очередь фактически такой простой пример во рту forwarding то есть взяли пакет и отправили пакет то есть вот данный пример вот судить об упрощенном показан вот так вот что фактически создаются здесь у показать неудобно not создаются две очереди packed in и пакета вот из пакеты на мы принимаем какое-то количество пакетов и в пакет а вот мы их передаем другая модель это scheduler то есть у детей вызывает функцию о депеши да и этот shadow возвращает ему какое-то событие event когда мы получили этот ивент нам фактически нужно его dispatch что что что такой за явин допустим это был пакет который там у нас пришел или это у нас был какой-то тайм-аут либо у нас был это событие от крипто блока или так далее то есть scheduling в agepi делается так вот и сам вот этот о depay'a scheduler то есть то что вызывает функцию депеш энн он тоже может быть на некоторых платформах сделан аппаратно значит пол очереди и классе классификатор классификатор в сетевых процессорах это такой блок который стоит на входе на ingress pipe то есть до того как пакет придет в центральной циpкa его видят классификатор внутрь классификатора можно загружать правило каким образом классификатор будет разбивать и пакеты на очереди правило называется парень parent of matching rules идея классификатора это что в него загружать конфигурация и он распределяет трафик по различным циpкa чтобы сделать параллельную обработку на выходе когда мы хотим отправить трафик все эти ставит блок и трафик который давать трафик менеджер трафик менеджер фактически он делает quality of service для сетевого трафика реформе цена имплементация которая сейчас расположена на гитхабе она содержит несколько алгоритмов для трафика менеджера и такие алгоритмы как w red самый наверное используемый там есть тоже все делается вот если посмотреть на айпи а и через типы о типе и как типы то есть идея такая что нужно создать сам instance трафик менеджер создать несколько нодов внутри с параметрами сколько пропускать она выход а трафика как трафик будет распределяться по этим модом и создать какой-то scheduler для трафика менеджер например a round robin как который будет использоваться и фактически когда вы отправляете трафик вы кладете в выходную очередь и трафик менеджер будет его процессить опять же повторюсь что некоторые устройства не могут делать это хардвар на то есть фактически вы все установку делаете один раз на этапе старта предложения на конфигурации и потом просто кладете в какую-то очередь и трафик менеджер будет работать аппаратно приблизительно он выглядит вот его работа выглядит вот так вот есть у него будет несколько очередей в которые вы будете класть трафика не будет определяться на как на какую но да он идет у каждой ноты есть свои полисе и трафик соответственно если вам нужно сделать какой-то quality service в отношении алгоритм он будет либо трогать пакеты либо их пропускать дальше один из компонентов и dp и the crypto блок вот на данном рисунке у меня показана схема когда у детей принимает пакеты пропускает их через классификатор очередь в тред потом берет этот пакет сетевой кладет в крипто блок результат крипто блока то есть а писек расшифровывается протокол в крипто блоки и кладется обратно в кфу и потом этот пакет выходит в линию другой способ это тот опять который сейчас новому dippy будет это то что классификатор может определить что пакет сетевой который приходит он уже ой писек пакет к нему есть определенно секьюритизации шин он может его сказать что да я могу этот пакет раз крипто вать и фактически в в scheduler и в тред уже приходит раз крипто ванный пакет и потом ну допустим его процессе дальше там или там на выход член но смысл в том что в такой ситуации циpкa вообще не задействован то есть cip он у за действом так что что он хочет configure каким образом у нее работа это трафик и писек данные вот график не вот прислала nxp для оплаты л.с. 2088 где они делали вот измерения своего вовсе api аль нас на своей плоти и по оси x показано число процессоров 12 4 и 8 процессах а по оси y показаны проценты измерения скорости то есть это 200 400 и 600 синеньким показано обработай писака в линуксе желтый тем показано обработка вот онлайн это вот онлайн режим которая предыдущие показывал и сером это line рейд то есть расчетные line рейд и идея такая что даже на одном arm ядре фактически мы с одним уходим на line рейд в случае форме forwarding ее decryption список пакетов ну потому что фактически у нас ядро не задействована да у нас вот это вот платонова все может делать аппаратно для у dippy существуют друг такой проект который основан на уде пи опять он представляет из себя лепесток и этот api стек это тоже опыт собственный проект расположен на гитхабе у него есть сайт об инфо спав до торг лицензии везде befree такая же лицензия как у dippy вот стек поддерживается сейчас компаниями nokia инея и ормом и идея такая что когда то есть получаю айпи стек фактически можно выкинуть весь linux новый стек из процессинга то есть у вас есть приложение которое крутится на приложение которые крутятся на библиотеки у dippy linux вас т.к. у вас нет сетевая карта вас стреляет пакета непосредственно в память который видно приложением у вас нет контекст свечей вас оптимизированная библиотека у де пье и ваш процессор получается процессе только вот этот вот айпи стек внутри этого проекта там можно посмотреть есть несколько модификаций например для интереса не запускали джинкс cf p и он тоже проект размещенный на гитхабе то есть и джинкс изменили чтобы он поддерживал cf p это свою очередь поддерживается на audi пи все это работает вот а другая другая модель это а что будет если мы не будем например изменять джинкс вообще то есть с помощью ld preload мы подсовываем библиотеку библиотека переопределяет вызовы к сокетом и вместо вызывания системных вызовов к сокетом оно вызывается функция библиотеки в dp и а так получается что у нас generico приложение она работает без всяких изменений с акселератором вот теперь поддерживается группой компаний которые его развивают это компании как и производители оборудования так и компании которые производители софта известной имплементации для audi audi пианино доступны на сайте мандата плейдо торт например для к avium для процессора тандыр x the missing a free скейл выпускает у dippy уже в своих из детей есть версия для чая калорий и а линара представляет версию которое основано на 9 не значит это о зеппе этого пан собственный проект и сделан в лучших традициях такого позор снова комьюнити есть мэйлин лист для общения есть сайт по вторникам у нас есть митинг звонки то есть любой может присоединиться и задать любой вопрос проект поддерживается линара над working group и в которой ходят вот компания которая там показал принципе довольно быстро вот у меня есть еще дополнительный слайд сейчас мы работаем над драйверами чтобы унифицировать драйвера и использовать по возможности драйвера которые есть в операционной системе linux без их модификации то есть это через а я им м ю маппить память и через wi-fi и фреймворк как раз использовать доступ до письма шины и идея такая чтобы как де не тащить два варианта драйверов одно для ядра linux другое то же самое только модифицирована через ее просто идея сделать какой-то общий такой общего разработка то есть как можно больше использовать driver linux под систему например эту конфигурацию rss просто все это дело использовать систему из linux другая модель это что мы работаем над разбивкой компонентов на модуле то есть это модули dle модули по китаю что это можно будет динамически загружать выбирать относительно того как на какой системе вы загрузились то есть это вот такое требование больших компаний идти пар от хода чтобы войти в свою сборку фактически у них один имидж и должен спускаться на разном железе и чтобы обнаружить какие области можно оптимизировать и и использовать аппарат на то есть нужно некоторые такая разбивка по компонентам вот и также мы работаем над оптимизации производительности пожалуйста вопросах добрый день меня зовут алексей скажите пожалуйста вот вы сказали что опыт do the plain в отличие там например над mapa de и так далее они заточены не только под сетевухи а если в планах интеграция сетевухи с.г. а для того чтобы делать проброс непосредственно сетевого трафика на группу и на группу например обрабатывать есть идея такая то есть мы даже сделали крипто блок вот этот клочок крипты знаю что его of low дели на gpu и шифрации дела делали именно на gpu вот будет ли это но скажем так в ближайшей перспективе назовем так в продакшене в продакшн и именно линара сейчас над этим не работает но если кто-то пришлет patch патч будет в резон это ну да мы его включим просто я видел но скажем так делались аналогичной альтернативы поверх но своих движков и и в том что иди 5-ке насколько я знаю вот спасибо я дам там может быть такой момент чего-то имплементации linux дженерик который который есть да она настроена на то чтобы им можно запустить на совершенно любом линуксе это мина linux то есть другие операционки не знаю там ну пока linux да да и в качестве своего packed into в этой реализации то есть поддерживается как и роуз акита например можно сделать приложение которое будет arrow сокетами а также он поддерживает эдипе дикий и над map ну собственно и русалки того 2 основных то есть принципе линз дженерик работает но достаточно быстро но чуть чуть медленнее чем моде детей потому что в нем использованы менеджмент но фактически там zero копия deep is de поэтому там тоже хорошая скорость вот если туда сделать еще а флот вот на джипе улудаг просто отдельная тема которой мы не занимались потому что в основном мы занимаемся тем что написать ай пи ай который будет одинаков для разного оборудования то есть а вот говорит а джипе а это уже конкретная имплементация вот но будем рады если будет почтена пока этим не занимались спасибо добрый день дмитрий вопрос такой предусмотрен а не какая-то векторизация обработки пакетов vip лепида вы имеете виду вроде такого до было есть патч который почти 35 для поддержки у dippy то есть патч этот в ops 3 мин на проекте пи-пи-пи вот и тоже ну собственно да она работает спасибо за информацию интересно подскажите кто как то остановить или заказчик кому это наиболее всего интересно какую задачу вот ну что это предполагает решить с помощью данного продукта но основной заказчик это группа компаний которых который собрала компании linar linar это такое подразделение компании arm до который арман linux и занимать основном окон сложными разработками которые так или иначе касаются армов вот и внутри или нора была создана сетевая сетевая группа которая занимается сетью изначально планировалось на arm но потом мы решили что мы поддерживаем все подряд и сейчас вот из активных таких контрибьютором для audi пи это вот те кто находится вот-вот в кружочке то есть это с точки зрения оборудования так avium nxp вот в основном и с точки зрения приложения это nokia и cisco ericsson это примеры приложений где сейчас это используете либо там может быть прорабатывать какие-либо поки где-то как-то вот от какой задачу востребования например макси лидировали up on why switch то есть вес он работать надо у детей и но фактически вы можете его то есть искатель на модуль который строился вот envy свечи ли это как то есть это как то есть это что-то заменили то но фактически это пропатченный апнули switch вот он весь вич пропатченный чтобы использовать вместо об инвестиционно работает как либо в ядре linux либо визир спейси используя сокеты то есть его можно отлаживать здесь и здесь вот и просто изменён это топ он весь ведь чтобы он не в не был внутри ядра ядро убираются и весь пакет input идет о судеб и какой-либо the road map какой-то там там там планы что что по тону в какие сроки что будет дорабатываться и там не знаю то есть какой какую цель это в перспективе 5 лет будет преследоваться и сделать но основной род map это то что сейчас наверное в районе этого месяца или в следующем мы выпустим новую версию api у нас будет релиз большой тагир можете как раз будет поддерживаться вот и писек онлайн то есть вот отписок который так работает он будет поддерживаться несколькими сразу производителями оборудования и будет входить в их них в их из dk это вот ну основной такой род map для нас тут если говорить с точки зрения именно внедрение вот и и продакшна то большинство из вендоров делают какие-то собственные проекты я особо не знаю что они делают вот но с точки зрения тампон sponsors а то есть это блин есть я переводил сурикат у на худе пи и потом что у нас еще есть топ anviz c2 pepe ну что-то насчет да то есть но можно найти на на на сайте то есть периодически мы экспериментируем с разными под соснами проектами что насколько их можно внести его положить на 5 dp и не всегда это получается очень гладко потому что например вот такие проекты как сурикаты они фактически делают тоже самое только они делают все софт варна то есть у них там есть собственный пул для пакетов в пакетах они делают довольно большой федору в кадр ума не ставят блокировки мьютекс и и фактически вот эту цепочку если и разложить на уде пи где вот очереди и все это можно сделать аппаратно то есть оно не совсем та гладко ложится и чтобы выйти на максимальную скорость но иногда нужно там большую часть приложения просто переписать там заново это не просто пакет input покидал подкинуть максим спасибо за доклад вы сказали сурикат у перевели на уде пи насколько производительность повысилась и повысилась ли не не измерял не измерял она у меня заработала потом то есть у меня была идея вот сделать базовый порт я его заработал и за пытался за об стримить его туда то есть отправила полу request он там месяца два висел потом нужно было изменить чудо документацию потом чита тесты и в результате вот up stream он так до конца не дошел то есть он лежит у меня от моей директории на гитхабе просто особо нет времени заниматься поэтому еще один вопрос есть какой-то готовый контроль plain по аналогии сотым контроля может быть что то такое которую do the plain свой но если говорить об интеграции с а вес то есть а кадра play на необычное сейчас они управляют у весом его вес у меня есть о-па-на daylight этом яр stick и вот собственно вот вот они используются как контра plain уже готовы вот все какие-то вопросы есть спасибо"
}