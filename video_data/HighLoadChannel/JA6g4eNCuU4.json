{
  "video_id": "JA6g4eNCuU4",
  "channel": "HighLoadChannel",
  "title": "Metadata management system в Авито / Фрол Крючков (Авито)",
  "views": 2327,
  "duration": 3101,
  "published": "2021-10-04T02:42:05-07:00",
  "text": "меня зовут foo' крючков я темницу компании авито был начал как 2015 году начал как разработчик несколько эту провел команды core services который занимался разработкой сервисов для продуктовых команд теперь нахожусь департаменте транснефти где виду команду авито паспорт когда я присоединился к вид а у нас было порядка двухсот человек сегодня это более 600 людей в техи тысячи серверов и сотни микро сервисов ну давайте перейдем теме доклада который звучит как meta data management system а план доклада будет следующий перед тем как я как мы перейдем в технические детали я расскажу о понятиями на данных и как это понятие понимаем мы какую роль оно играет для нашего бизнеса а также за те ним детали чем на не понравилась наша старая архитектура также перейдем в технические детали новой архитектуры рассмотрим плюсы минусы и в конце подведем итоги о том стоило ли это делать или нет итак что такое метаданные согласно википедии то метаданные то данные о данных но что это такие за данные в реальной жизни это могут быть весьма знакомый вам поля заполнения форм которые описывают а данные который в этих полях хранятся вот например на слайде вы можете видеть форму подачи объявления которое состоит из четырех атрибутов то есть это заголовок категория цена описание объявления согласно википедии такой тип метаданных называется descriptive и мета-данные капрала он описывает общие данные у единицы метаданных и позволяет уникальный дефицит собственно сами данные давайте я расскажу про еще один тип метаданных который называется с трактиром и за данные о которых я узнал тогда готовых доклад собственно в сравнении с дескриптивный то данными это тип хранить себе описание связи между данными например это может выглядеть следующим образом на слайде вы видите как два различных сценария один это подача объявления а второй это поиск объявление как правило метаданные в обоих сценариях не меняются то есть мы все и также работаем с полями марки моделей марка моделей цена модели автомобиля но как правило зависимости от сценарий порядок заполнения форм это как и из каких значить из каких списков выбирают пользователей иерархию этих списков отвечает вот этот тип метаданных но как говорится то есть то что я сейчас рассказал это давно известный темой как правило существует достаточно большое количество фреймворков и библиотек написано различных языках которые позволяют делать и автоматизируется эти процессы из таких примеров как вам всем хорошо знакомая например jira которая позволяет хорошо описывать метаданных процессы описание метаданных полей задач также вы можете добавлять свои собственные поля как-то управлять процессом разработки второй такой очевидный пример это система для управления контентом например wordpress которым вы можете создавать контент категории теги как-то и создавать иерархию из этого которое описывает собственный контент для сайтов но что касается сайта в классе файлов или как по-русски звучит это сайт объявлений поэтому для нас то есть для сайтов объявлений работы с метаданными это один из самых критичных элементов о котором мы даже не догадывались сперва как вы видите на слайде от метаданных зависит практически все компоненты сайта то есть от форм подачи и поиска до работы с ценовыми политиками как мы делаем рекомендательные системы как мы моделируем объявление как у нас работает seo то есть по факту метаданные участвует во всех этих процессах и чем быстрее компания умеет адаптироваться под изменяющийся мир описывая его в метаданных тем более эффективно com компания является для того чтобы быстро адаптироваться как правило необходимо вносить быстро в нее изменения но как правило это достаточно сложный этап которые не очевидны сперва то есть как правило внесения изменения формы подачи или форму поиска это это всего лишь один из шагов которые необходимо сделать также нужно подумать о том как новый тип атрибутов будет варьироваться как он будет учитываться в рекомендательных системах или как будет работать в ценовой политике также нужно понять как новый тип индексировать и затем как его использовать в построении your love собственно все эти этапы занимают просто колоссальное количество времени если подумать о том внедрение его в целом на сайт они просто на форму собственно какие у нас были ограничения как правило раньше для того чтобы нам пройти путь объявления добавления изменений в метаданных нам требовалось пройти там потребовать недели до нескольких месяцев то есть как вы понимаете это было достаточно неэффективно так как добавление просто какого-то нового атрибута занимала при привлекало к вниманию достаточно большого количества разработчиков то есть это требовался front and back and требовались депо для того чтобы носить изменению схемы данных но ситуацию усугубляло то что у компании достаточно много направлений такие как авто недвижка услуги и как правило каждый из этих вертикальных стремится как можно более точно под подстроиться под пользовательские нужны и как правило со временем те как в атрибуты которые необходимо было добавлять они были все сложнее с точки зрения их поведения таких точек с точки зрения катит количественного прибавлений то есть все больше хотелось проводить экспериментов различных направлениях на фоне этой ситуации как правило перед нами стали формироваться требования к системе управления метаданными и таким образом у нас появилась концепт инфо модель 20 то есть основные требования которые мы хотели видеть то есть это уменьшить время реализации сценарий по изменению атрибутов под изменением атрибутов имеется виду не только добавлению на поле формочки но как это поле будет проиндексирована про модерировал а как оно будет отображаться на различных платформах также мы хотели видеть иметь такое свойство что мы хотели для каждой платформы иметь свое собственное представление формы подачи или форму отображения атрибутов также один из критических и необходимых условий заключался в том что мы хотели проводить достаточно много обед с тоф один из основных сценариев то есть мы хотели посмотреть как будет улучшит увеличивается конверсия если мы добавим на форму вот этот атрибут а этот уберем нужно понимать что добавление атрибута приводит тому что нужно переделывать систему индексации объявлений они также для того так как мобильной версии с мобильной версии обновляются не так часто например у нас есть версии который мы должны поддерживать два года то мы хотели видеть versio не рование инфо модели так чтобы старой версии все также продолжали жить и мы могли вносить них какие-то изменения и сделать так чтобы это было управляема на момент когда мы пришли к этим требованиям наша архитектура было как у всех нормальных людей то есть все объявления хранились в паз грейси так как объявлений было достаточно большое количество это порядка 1 миллиарда то конечно это базы данных с объявлением была так шокирована по супер категориям и получается что в этих табличках хранились наше объявление как вы понимаете колонки этих объявлений описывали свойства объявления и получается таким образом что колонки сортированных таблиц это и есть собственно метаданные которые приходится менять здесь как бы все очевидно так как все делают но так как помимо этого помимо колонок который описывает свойства объявление у нас были еще таблицы которые описывали свойств этих колоннах например нужно ли этот атрибут должен ли он быть обязательно при подаче или например нужно его отображать при редактировании объявления также на связях также нас был еще одна таблица которое описывало связи этих атрибутов одной таблицы здесь я уже говорю как мы знаем о структурных метаданных попросту например связь параметры его родители то есть наша прежняя модель была устроена таким образом что параметры например модель автомобильный мог иметь только одного родителя например модель модель ford имела только марку автомобиля извините там фокусами марка автомобилей там ford а это делать для того чтобы мы могли выводить правильные списке то есть если вы выбрали там ford необходимо было вывести там только модели этой марки для того чтобы такая схема работала быстро когда когда у нас есть еще одни таблицы для описания метаданных то одним из этапов при сборке сайта как это принято делаете мы брали брали эти таблицы описывающие свойства наших атрибутов и дам пили их с помощью кода генерации файлы таким образом мы могли таким образом мы могли использовать могли а траверсе деревья атрибутов вверх и вниз по не делать запросы во внешнюю базу данных то есть это позволял достаточно быстро производить валидацию объявления или отображать свойства объявления на карточке без дел и не дело никакие внешние запросы давайте рассмотрим как то есть это достаточно классическая схема когда у вас есть колонки и есть табличка описывающие эти колонки и все это дампе cvv код который используется уже в ran to me а давайте теперь рассмотрим основные недостатки которыми данная аж тура обладает 1 и это фундаментальный недостаток заключается в том что если вы хотите сделать изменения в метаданных только правил вам приходится как вправо вам приходится перри выкатывать все ваше приложение то есть как правил вам приходится перекатывать все ваше приложение как вы понимаете таблицей с большим рпс м с большим объемом то есть не очень хочется сделать переулка часто делать изменение в таких таблицах отправил это требует надзора инженеров которые смотрят чтобы все было сделано правильно во вторых такой подход требует перри выходку всего приложения так как необходимо пересборка словарей для того чтобы код может мог работать новыми данными основное ограничение нашей же реализации еще заключалась в том что все параметры у нас были реализованы все были уникальные все значения div катаров были уникальные то есть например как вы видите на слайде сейчас два списка вы видите серию абсолютно одинаковых значений но для нас это были абсолютно разные индификатор и это делать для того чтобы имея всего лишь один индификатор значение понять восстановить структуру заполненного дерево вверх по поверх по зависимостям такая архитектура ограничена на том что нам приходилось делать достаточно большое количество дубликатов также на этапе сборка проекта когда мы делаем дам схемы базы данных в код одном из за вручение заключается в том что конечное количество таких метаданных на момент когда мы начали заниматься перестройка нашей архитектуры у нас было порядка 6000 значений 6000 значение на все категории но от нас требует так чтобы в как минимум в одной категории был 1 миллион а то до 1 миллиона таким образом такая схема перестала работать потому что это приводило к к падению проложения потом просто потому что траверс и восстановление валидации форма подачи приводил тому что приложение просто падала с того что жрала всю память и и таким образом архитектура которая могла бы решить наши проблемы была следующая то есть одно из логические решение нашими ценами проблема заключалась в том чтобы мы могли бы повысить уровень абстракции который заключался в том что колонки таблиц который описывает свойства атрибутов мы превращаем строчки таким образом мы добавляем динамику по изменению наших метаданных но за это приходится платить тем что вместо того чтобы базы дано выполняла за нас функцию управления и контроля изменений схемы теперь это приходится делать а сами самим также такой подход к праву называется entity вылью эти театре бьют в или у модели и так и помимо то тех требований которые налога у нас бизнес к нам добавили еще следующие задачи которые необходимо сделать то есть нам во первых необходимо обеспечить операторов которые делают работу с метаданными самим а во вторых нам необходимо обеспечить консистентной этих меток это метрах данных давайте непосредственно придем к архитектуре к новой который мы пришли как вы видите на компонентные схемы мы выделяем три слоя то есть у нас есть backend это непосредственно сервис который хранит себе все метаданные и сопутствующие сервисы которые его окружают следующий слой мы его называем frontend слой это не фонтан в том смысле что это мобильное приложение или юань а это именно а бэкон сервисы которые предоставляют эффективный доступ к metadata сервису и последний слой сервисов это наши клиенты которые которые используют метаданные в общем ски в общем виде схема прямолинейной с помощью эти ели мы загружаем метаданные от наших партнеров и в сервис мета-данных или заводим их ручками с помощью а затем этими данные которые у нас находится в яви модели выгружается в статические файлы которые затем интерпретируются слоем из frontend слоем east front end сервисов и с которыми уже непосредственно работают наши клиенты давайте подробнее разберем каждый из этих слоев бэкон слой который отвечает непосредственно за эви достаточно достаточно сложно реализован и достаточно это достойно отдельного доклада как это все сделано но я расскажу основные моменты которые нам необходимы здесь как правило во первых он решает предоставляет нашим оператором пользователем во-первых делать изменения работы с метаданными то есть вносить новые атрибуты изменять их редактировать также он позволяет нам заводить различные абэ тесты и также заниматься верси они раване им но так как количество запросов к сайту и как следствие к метаданным достаточно большое то есть мы имеем порядка сорока пяти тысяч рпн это только на один из сервисов мета-данных то мы не можем просто так взять и направить всю нагрузку на сервис метаданных которые традиционно я супер нормализировать а я модель и тогда для того чтобы оптимизировать вот эту читающую нагрузку был придуман frontend слой как правило frontend слой заключается в том что эти сервисы берут статические файлы которые представляют такое статическое описанием мини-программу загружают себе в память делают интерпретацию этих файлов и на основе вот этих меню скомпилированных программ которые находится во front-end слой мы интерпретируем их на основе пользовательских данных давайте теперь перейдем к модели данных которая находится вот в этих статических файлов а как говорилось исходя из наших требований помимо того что мы должны уметь гранулярный классифицирует задавать и контролировать как и наши метаданные выглядит в разрезе разных платформ версии и а bt став то мы пришли к такой концепции как выглядит на слайде то есть это такой понять как layout layout состоит из основных трех компонентов то есть это rolls правило в этом компоненте состоит он состоит из бизнес-правил которые мы можем в юань накрутить сказать например что пожалуйста отобразить более метро если был выбран город москва или там санкт-петербург и вот вот этот первый компонент отвечает за вот эту динамику следующий компонент это relation решены как правило описывают как мы говорили ранее это структурную metadata и описательные метаданные то есть как правило это иерархия атрибутов и и их значение и следующий компонент это формы о них чуть позже то есть примером лейаута может быть форма подачи или поиска или например сниппет на карточке объявлениях то есть по факту это все разные layout и допустим мы можем отобразить форму подачи на десктопе отличную от того как мы делаем это на мобильных устройствах и это будет достаточно корректно также от понятные привычного понимания лейаута как визуальные формы и о том также может выступать например шаблон для формирования орла для того чтобы делать canonical url и для того чтобы оптимизировать seo или например это может быть конфиг для сфинкса для того чтобы индексировать данные как и говорил правило это это бизнес-правил валидации и визуализации то есть это такой джейсон like dsl в котором мы описываем условия при которых те или иные поля меняют свои свойства то есть например отображают какое-то поле делают его обязательно в определенных условиях или делают его невидимым relation а как я говорил то есть это иерархия атрибутов в зависимости от какой сейчас стоит и находится пользователь заполнении формы такие виз списки он выводит и последнее свойство это компонент это layout это форма здесь мы делаем именно манифест того как эту форму необходимо рендерить и когда мы говорим о правилах которые меняют свойства как правило эти правила оперируют над полями формы для того как мы можем какие-то поля менять например если допустим выбрана поле новостройки пожалуйста сделай сделай поле там когда снять сдачи например там не активно ну то есть какие-то такие визуальные компоненты то есть по факту получается что layout и позволяют нам гранулярный контролирует поведение визуализацию и атрибуты из всех зависимости гру 0 арно sti работы до тех пор что мы можем сделать разные формы подачи или отображения разными для android ios там десктопа и при этом мы можем их сделать разные даже среди версии их разных андроидов и при этом это будет все корректно индексироваться модерироваться то есть все эти атрибуты будут правильно распространены в вдоль по всей системе давайте теперь обсудим как мы сделали versio не рование на совета достаточно сложные компоненты по факту там реализован такая сагид система всей базы метаданных по факту мы можем сказать так что вот у нас есть сейчас какой-то state всех словарей всех значений но мы можем сделать ветку в которой что-то поменять и отдельно и и зарелизить что касается релиза что такое что это за понятие такое в юо и сервисы метаданных у нас есть кнопка которая отвечает за релизе текущей текущую версию там метаданных при нажатии на их происходит достаточно большое количество разных чеков мы убеждаемся что там нету никаких циклических зависимостей что все apts ты правильно себя ведут и ник перекрывают друг друга но одним из фундаментальных вещей которые происходят в результате после того как прошел успешно вся вот это нормализировать структура в лекционный базе данных превращается в набор play out of статических файлов которые уже раздаются с помощью engine x а вот этим сервисом из слоя frontend при этом если мы зарелизили какую-то версию метаданных то мы уже никаким образом не можем сделать никакие изменения в нее потому что потому что это уже статика в которую мы не вносим некие изменения если мы хотим что-то исправить то по факту нам всего лишь приходится релизе новую версию tokyo дистрибьюция таким образом файлах позволяет нам достаточно легко масштабировать систему и это обходится достаточно дешево потому что мы можем бесконечно в прошлое вернуться и посмотреть какие у нас были форма подачи или понять какие там были ошибки совершены что касается бы тестирования то это реализовано абсолютно таким же образом за исключением того что у нас есть основная мастер ветка в базе данных и метаданных и есть параллельной ветке как это как принято в гите то есть мы можем какой-то ветки поменять описание поля с она б и таким образом параллельно крутить какой-то apts релиз происходит таким же образом сейчас мы говорили о том как происходит release and model и то есть из традиционного представления мы их складываем на статические к стати к и файлами а как собственно происходит дистрибьюция новые версии она происходит немного не привычным образом потому что мы по дефолту не отдаем нашим клиентам все новые опции только что заряженную версию мы делаем наоборот то есть наши клиенты сами знают какую версию метр метаданных им сейчас необходимо получить такой подход нам позволяет достаточно гибко контролирует то как мы распространяем новую версию и таким образом случайно не сломать каких-то клиентов которые не поддерживают новые фичи системы этот процесс мы называем роутинг клиент имеет road как показано сайте работы это по факту это такая строка которая состоит из трех компонентов это название раута версии версия эта инфа модели и категория то есть таким образом клиент знает какую версию какой и в какой части кода он сейчас находится если он хочет всегда автоматически получать самую свежую версию модели то как правило он может просто указать алия с вместо версии master и таким образом мы доставим до неё самую последнюю версию это данных как это выглядит в действии то есть мы начинаем с пустого состояния формы то есть запрос сервис layout это один из сервисов из фронтон слоя состоять из нескольких компонентов то есть как я говорил с началом отправляем road и описываем какую какой layout мы хотим получить какой категории и описываем evil версию данном случае мы используем мастер а также мы передаем туда текущее состояние нашей формы нашем случае это оно пустое после этого сервис layout отдает ближайшего ли дна и состоянии формы которые можно рендерить то есть это от брата apisto такой текст текст и представления форма отдается на front-end и она рендерится помимо того что там описаны все поля там также описаны все значения которые из которых можно выбирать какие активные какие неактивные после того как пользователь напирали например меняет стоит формы там отдает например выбирать новостройки то мы делаем запрос в сервисный out а уже с выбранными значениями и взамен сервис лают отдает нам следующее валидно и состоянии формы если вы передали какое-то совершенно не валидно и состоянии the service at low допустим выбрали какой-то параметр которого сейчас не существует the service лайалл как правило подгонит следующий state до ближайшего корректного такое поведение такое поведение помогает нам в использовании такой механики в больших в разных вещах то есть как минимум мы можем вы лидировать все данные то есть у нас есть какой то какая то стоит формы которые возможно некорректно или которая была сгенерирована допустим 1 год назад но тем не менее если мы ее прогоним на основе отдадим сервис слоя вот на последнюю на сегодняшний день то он возьмет в последние валидно и состоянии согласно текущей инфо модели также например для того чтобы отобрать отрендерится сниппеты объявление а то есть свойство объявлений то есть мы идем базу данных объявления например ну объявления подали там два года назад и вот мы берем все свойства объявления в нормальной форме отдаем этому сервису и он нам может вернуть текущие корректно и состоянии там полей например если добавилось какое-то новое поле которую не существовало на момент создания объявления то он его заполнить заполнит в дефолтном значением давайте теперь разберемся собственно как устроен сервис layout который делает все эти преобразования при реализации этого сервиса были такие различные сложности то есть как я говорил ранее а сайт должен был работать быстро и количество запросов было большим то есть мы стремились от 10 до 50 миллисекунд на девяносто девятом посетили для того чтобы рассчитывать вот эти все state и помимо этого сервис как я говорил должен работать с целой аутами то есть и layout и такая единица описание метаданных на тот момент то есть нужно понимать что на тот момент у нас были десятки категорий десятки платформ под платформами не только android и айос но также это внутренний сервисы там с винкс например или модерация и вот это количество вариантов которые необходимо хранить память и она там исчислялось тысячами один из одна из самых тяжелых категорий например это авто она могла занимать до 500 мегабайт то есть вот эта вся иерархия иерархия занимал достаточно много места для того чтобы сервис как правило был быстрым да то есть мы делали различные mvp для того чтобы као сок на гейте все данные хранить для того чтобы можно было быстро рассчитывать состоянии мы пробовали разные решения то есть на основе пас gresso тарантула мы даже потрогали графу и база на фиджи загнали туда все у этого дерева иерархии как правило все решение достаточно были они вписывались наши требования по времени но как правило они занимали все также 500 мегаватт с нас ни каким образом не удалось сделать так чтобы один layout занимал там меньше 500 мегабайт собственно это достаточно было ну как бы такое сложное решение поэтому мы пришли к решению а где реализовали свой рид онли сервис в которой хранились с компе не скомпилированные layout и и собственно в нем же рисовали все в логику по интерпретации вот этих layout of так как сервис сервису необходим нет необходимости делать никаких внешних запросов то по большому счету вся вот эта логика про интерпретации достаточно там легко описывалось и покрывалась uni тестами что делал этот сервис достаточно стабильным и достаточно легким к масштабированию потому что у нас есть только рид онли дата который мы можем бесконечно масштабировать под любые нагрузки а полная цепочки цепочка загрузки латов память сервиса там выглядело следующим образом то есть клиент приходилось определенным рау там если сервис видел что этот layout уже скомпилированные находится в памяти то стоит формы отдавался на интерпретацию интерпретация возвращала следующий валидность эти и отдавалась клиенту и если же в памяти ничего не находилось то по факту мы из их они шли на engine.exe загружали оттудова статические файлы в которых было описано состояние программы компилировали ее и на основе этого возвращали следующую форму но как я говорил то есть над на 2019 год количество вариантов которые конкретно вам необходимо было хранить заключалась было до полутора тысяч который не был было необходимо хранить единовременно как навес в 500 мегабайт как бы приводил к тому что это там достаточно такие большие цифры там 500 гигабайт необходимо было хранить в памяти одного приложения как вы понимаете хранить один из такого сервиса на достаточно небезопасно поэтому для того чтобы минимизировать нагрузку на сеть нам там как минимум 10 версии в охране не было необходимо хранить поэтому процесс оптимизации памяти был достаточно критично для нас и как и говорил ранее то есть один основных как и говорил ранее один из ценных компонентов бизнес-правила это это relation который занимал больше всего мегабайт поэтому мы и стали думать как собственно оптимизируйте эту структуру например вы мы взяли дерево представляющая зависимости марки acura и такой вид дерева вы можете достаточно весьма распространен на формах подачи где она имеет много узлов с одним наследником для того чтобы как то это реализовать в памяти и поместить то есть мы сначала попробуй реализовать трой на основе мафах в горном приложений но в силу того что overhead нeкomopыe с одним значением был слишком высок а это не увенчалась успехом поэтому мы пошли следующим путём когда когда имели одну большую мапу в которых хранили ключами которая являлась путь до какого-то параметра значения его это старт стоп индекс для того чтобы понять какие значения для этого узла выбирать 50 мегабайт то есть таким образом мы смогли сбить с 500 мегабайт до ужать это все до 50 мегабайт но это все еще достаточно большая цифра и основная следующая точка для оптимизации была в том что а вот эти relation и которые занимали больше всего места они как правило менялись а реже всего поэтому а мы организовали в сервисе такую структуру данных которая которая перри использовала кусочки под деревьев на основе для других layout of то есть например если какой-то layout версии 1 там касас версии 1 на версию 2 сама структура не поменялось то при компиляции лей аутом и перри использовали вот это под дерево таким образом нам мы смогли практически минимизировать вот эти мультипликаторов по количеству абэ тестов и версии практически к нулю но как я говорил чтобы как бы как бы ты память не оптимизирован не оптимизирована ограничено и для того чтобы как-то понять собственно какую стратегию по вытеснению их выбрать мы пришли как бы к следующим учитывать следующий момент и разные layout и то есть например layout для подачи форм используется на несколько порядков реже чем ваял для отображения сниппетов объявлений и и поэтому например i love you нам не подходил потому что вот эти менее важны из пике по отображению сниппетов вымывали бы вот эту более важную успеху по отображению по отображению подачи также lf youth нам также не подходил потому что могли приходить кроны которые достаточно сильны и пикообразное нагрузки могли вымывать все необходимые спеке но как бы для нас в данном случае подошел pattern of duty free placement кэш который стратегии в течение которого опирается как на частоту такие на так и на историчность использования данного ключа то есть поэтому это привело к тому что наши спеке даже которые имеют маленькие трафика но при этом важные для бизнеса как например подача достаточно продолжали находиться в памяти и наверное последняя оптимизация про которая хотел бы рассказать это ток от мы выкатываем и прогреваем кэш то есть перри выкатка такого сервиса может повлиять на то как работает монетизация или подачи сайта и критически важно чтобы как бы на прогреве кеши мы не мы не давали большой рейтинг и поэтому чтобы обойти эти проблемы в процессе эксплуатации сервиса он дан пел состоянии каша во внешней стороны что все спеке которые используются на данный момент и когда новая версия сервиса выкатывается он шел в этот внешний сторож смотрел а вот эти layout и на данный момент используются а он их погружал и только после этого мы давали на него нагрузку таким образом мы обошли проблему перри выкатки сервиса для того чтобы и никак не повлиять на различные части сайта какие плюсы какие минусы во первых такой подход нам позволил сделать наши функциональные требования то есть мы смогли как минимум без или вы к так достаточно быстро изменять мета-данные то есть изменять форму подачи формы поиска отображения атрибутов при этом это автоматически просачивалась в то как индексируется объявление в модерацию в анти фрод и прочие компоненты сайта также благодаря редон не хранилищем наших фонтен сервисах мы могу можем систему масштабировать горизонтальные практически бесконечно до тех пор пока как бы не съедим ресурса кластер а также система получилась на удивительно хорошо для расширения то есть на такой же подходом по статистическим файлам и описанием правил были реализованы сервисы как по руль и джоном которые делают классификацию объявлений и урал builder который используется для того чтобы создавать войсковой векторов но какие собственно минусы такого подхода как вы понимаете основной минус основные минусы заключать в том что приложение получилось достаточно сильно а прожорлива к сети и здесь мы боремся с этим тем что мы используем бинарный формат передачи данных с нашими клиентами и также достаточно большое потребление сети si peu конечно получено архитектура наверное бесконечно сложная с тем которая у нас была но для ситуации когда у вас там большой классе fight с большим количеством различных направлений в котором вы хотите делать динамические изменения при этом сделать так чтобы каждая команда могла автономно это делает не привлекая вниманию всех инженеров всей компании то наверное это стоит реализовывать на таких масштабах все спасибо за внимание фрол спасибо тебе огромное в этот доклад мы тебе очень благодарны за него и тебе вот бежит наша систем чтобы ручейка персональную рамочку с благодарностью и худи с другой символикой но тоже очень почётный это хайло спасибо спасибо большое ребята готовьте ваши вопросы поднимайте руки у кого не сформировались а есть вот здесь на втором ряду вопрос супер еще поднимайте руки заранее и в онлайне нажимаете кнопочку выйти в эфир для того чтобы задать вопрос привет спасибо за доклад а смотри ты рассказал в начале что вас время выкатки изменения было там от недели до низких месяцев вот но как я понял сейчас как я понял сейчас получается выкатка изменений она все равно требует изменений в клиенте если клиент не подписано алиас мастера и как долго сейчас это занимает я понимаю что телодвижение меньше но по факту наверняка есть клиенты которые сегодня на записи на никита версии и если нужно закрыть до последнего то как долго занимает такой змеи полностью по моему достаточно хороший вопрос по моему нас даже есть где-то на хабре статья как за одну или за полторы минуты там гибкой показано как добавление атрибута можно дотащить до мобильного устройства как она появится на форуме сейчас наверное это исключительный случай для демонстрации но по факту сейчас нам не требуется никаких перри вы к так то есть вот этот конфиг с версиями которые запрашивают клиенты то есть в каких-то случаях они захардкожены но в каких-то случаях вот эти конфиге до наших клиентов также раздаются динамический например клиент попал версию об и тестировать ну он появляется там какой-то в обед с и с этим обед с ним приходит версия какую-какую версии ты хочешь инфо модель получить то есть по факту она больше формальное нежели необходимое техническое программирование надеюсь у меня получилось слева от тебя вот там вот есть глубине зала да нет вопроса ваш шанс задать вопрос ребята скажи пожалуйста это же огромное количество усилий все это сделать до то есть по факту этим занималась ну практически вся компания потому что для того чтобы это протащить то есть мы привыкли то что взять две колонки то есть там пошел дбн жене рискуют колонку добавил потом добавили объявления на подачу но при этом это сломало подачу на на андройде например и по факту для того чтобы фундаментально решить эту проблему и так чтобы вот этих добавлений атрибутов работали корректно это пришлось работать практически всему авито для того чтобы затащить вот эту новую версию поэтому это такая очень дорогостоящая история которую то есть нужно дважды подумать нужно ли делать она ее хорошо у нас есть вопросы середину зала добрый день спасибо большое за доклад было очень интересно один момент хочется прояснить понятно с собой тестами когда у нас проходит абэ тест мы покупки или по другому параметру в принципе понимаем что пользователь видеть на своей стороне какая у него версия параметров формы и так далее но что касается весь versio нирования о котором вы говорили в своем докладе какая у вас глубина истории versio нирования то есть насколько старая у вас самая старая версия формы и судя потому как вы говорили о том как вы перестраивали конфигуратор как вы теперь понимаете на какой версии формы находится сейчас ваш пользователь у которого возможно какая-нибудь проблема с подачей или поиском спасибо спасибо большое за вопрос да то есть аверсе они раване идет следующим образом то есть как я стал дистрибуция происходит таким образом что клиент сам запрашивают определенную версию метр метаданных и как правило он это он если как это происходит проблемы то это информация попадает в логе и мы знаем что вот этот там мобильное устройство конкретно запрашивал вот такую версию и вот вы такой версии у нас какие-то были проблемы что там это поле невозможно там выбрать например или и там форма не валидные в таком состоянии поэтому 10 весьма все прозрачные навроде же позволяют как то быстро диагностировать проблему то есть с вашей точки зрения оправданных хранить достаточно большую глубину версии нирования параметров для редактирования проблем а дело в том что для нас это при почти как бы бесплатно то есть у нас есть мы по факту старые все версии это не что то что находится там в реляционной базе данных и которые там приходится там каждый раз где-то рендерить каких-то юань то есть по факту очень древний версии мы храним просто статикой статикой на сервера которой раздаём джон иксом то есть там если джейсон фани кидать зазимовать то есть они практически там для нас бесплатный поэтому хранить историю конечно важно но по факту не могу сказать что мы там возвращаемся в какие-то года да у нас есть там трехмесячные истории которые можно посмотреть и посмотреть поди пожить какие-то баги получилось от тебя получилось спасибо отлично фол я напоминаю что ты по дороге выбираешь лучше вопрос у нас есть вопрос из глубины зала и дальше будет на четвертом ряду рука фрол привет это я валера вопрос такой как бы вообще искали какие-то существующие решения в интернете похоже может платные как бы мыс да хороший вопрос то есть мы пытались посмотреть но на самом деле я не совсем представляю как можно какое-то внешнее решение интегрировать потому что по факту вроде методах как и сказал мне то данные то есть в сайте объявлений это такая вещь которая связывает абсолютно все компоненты системы то есть мы говорим о микро сервисной архитектуры говорим о том что каждая команда должна быть автономны для того чтобы быть эффективным но так или иначе мы все оперы в одной модели для того чтобы притащить какую-то внешнюю систему и и придется интегрировать во все во все во все во все то есть поиск в подачу в отображения в модерацию то есть и бы те решения которые мы находили то есть но они как бы не приспособлены были к хай-лоу да то есть вот это вся возня с этим статическими файлами вот этим слоем frontend сервисов то есть это исключительное решение под наши нужды для того чтобы очень с быстрой динамикой с большим объемах метаданных удовлетворяют наш спрос но если даже это чисто под вас было подстроено но ведь классе fight of the россии много не вы одни не за это решение как-то унифицировать и продавать или вы или выдать вот indoors но технически то есть это вот можно пойти взять как они там wordpress да там тоже есть формы то есть но это же его заново придется написать по факту под свои нужды то есть наверное а написать система управления метаданными не так сложно то есть еве я думаю большинство из вас сами там реализовывали там делали какие-то ds или которые там в конечном счете там интерпретировались вашим кодом то есть это колоссальная работа конечно но очень важную роль играет то как собственно на больших нагрузках вы можете с ней работать то есть и здесь нужно понимать здесь еще несколько измерений добавляется это историчность и и apts ты параллельно которое будет крутиться здесь такой несколько измерений которые решения мы не видели у нас есть еще два вопроса вот до 1 и перед этим человеком сидит еще один желающим добрый день спасибо за доклад очень интересно один вопрос тоже по поводу versio нирования смотрите как у вас versio не руются сами значения то есть допустим было поле одного значения и значение изменили там схему валидации правила изменили следуете нужно хранить другом формате каким образом вы это делаете то есть вы делать куда миграцию или вы создаете новое поле на основе старого или чтобы подобное да хороший вопрос а как происходит миграция то есть как правило объявления подаются в какой-то версии инфо модели то есть вот сегодня пользователь пришел была версия 2 и это поле существовала и это был список как правило затем это там объявлением мы показали прошло несколько лет потом пользователь пришел но не несколько месяцев а пользователь пришел решил его реактивировать и мы увидели что сейчас это поле уже является там если бы раньше список то теперь это свободный вот например то здесь у нас бывает несколько сценариев иногда мы бы действительно прогоняем миграцию и мы знаем как бы сообщить объявлений которые нужно прогонять миграцию зная версию в которой она была подана либо же мы мы просим пользователя перри заполнить ручками объявления это второй сценарий третий сценарий который у нас есть как и говорил вот сервис layout как и говорил он возвращает ближайшие корректно и состоянии формы то есть технически он может вернуть если раньше это был список то есть он может списочное значение подставить в свободный вот то есть он возвращает следующие корректно и состоянии формой даже если имеется за кости эти значения какие-то то есть получаются то что у вас сервисная вот он сам по себе умеет как будто с какой то да и ли у вас это отдельно описывается версиях то есть допустим в рамках версии 2 мы пишем как иммигрировать там поле x в поле y а вот и так далее да мы хотели вот к такому описательном декларативным способ куда миграции но это было бы просто количество версий сумасшедшее количество изменений большое количество если бы мы заставляем ребят тут описывать еще миграции но это наверно было бы слишком больно поэтому сценарий когда мы пользуемся этим двумя способами ручками иммиграции либо пользователя заставляем либо кастом простых случаев уже в ран тайме мы эти вещи и fixim.ru чеками не заставляем писать как бы описание миграции полей либо же мы можем сделать следующим образом то есть добавить новое поле с дефолтным значением которое мы ожидаем это хороший вопрос когда мы говорим о к кости да вот кости значение было состояние одно осталось другое то есть например такой же подход используется для для того как есть поисковая выдача и поисковой выдача есть поисковый какой-то вектор до набор каких-то значений параметров и пришел краулер запечатлил что вот эта версия что это вот это поисковая строка отвечает у такому такой версии пришел краулер сохранил это при этом у нас поменялись значение такого параметра нет и вот такая же механика против all the позволяет нам пользователю кликнув шую щую на ссылку которая там месяц назад и которых поли уже не существует ближайшим образом отобразить поисковую выдачу максимально похожий к тому чтоб имелось ввиду при этом и нет необходимости делать какие-то там редис с ключами там типов перемат янгом ссылок на новые на новые значения понятие can спасибо супер и последний вопрос после этого ты выберешь лучший и можно будет еще продолжить дискуссию в кулуарах засада спасибо за доклад очень интересно ты много рассказал про изменения метаданных полей о которой потом отображается в фронте в приложениях рассказал что вы можете очень быстро прилететь неограниченное количество как вот эти изменения потом если вы какие то добавляйте новые метаданные поля вы выставляете другие системы потому что если у нас есть там систем аналитики либо еще что то ноги у нас эти это данные зашиты и как бы привязать релиз новой версии к обновлению информации о других системах как я говорил то есть этот процесс дистрибьюции то есть все наши сервисы допустим модерации да они знают какую версию они используют то есть мы их никак не выдам то есть если мы знаем что вот эти версии не критичные то есть то как правило эти авт то есть если ребята скажем так сделали такой хороший грейс пул если какая-то придет новая форма с новыми фичами то и ребята не бояться каких-то там ломающих изменит а они могут указать алису себя как мастер премодерация на основе такой набор метаданных для объявления говорит о том что он там с ним там какая-нибудь там бмв стоит 500 тысяч рублей при этом это там супер свежий год там не бита и все такое то есть скорее всего это какой то фродо и вот эти метаданные которые на основе которых они принимают решения то есть они сами знают версию которая им сейчас необходимо использовать по факту и либо это процессуально то есть они делают это 1 мин как бы там ручками либо они используют алия с мастером то есть я правильно понял к сервису хранения метаданных обращаются не только сервисы которые делают фронта и приложения а также и другие сервисы в которых зашит релиз этих наборы метадон ах да да по факту мы даем клиентам безопасной версии которые они могут использовать для работы по ним по зубам супер и какой же вопрос последний вопрос был самый такой бритый последний вопрос пожалуйста вручить его там да да да да поаплодируем победителю нашего маленького конкурса еще раз спасибо огромное друзья вы можете продолжить и пообщаться с фролом вот здесь сразу налево при выходе из зала а в онлайне подключаетесь зон тоже у вас есть ссылочка для того чтобы продолжить общение"
}