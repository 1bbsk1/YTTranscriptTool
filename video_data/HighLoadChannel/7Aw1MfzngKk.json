{
  "video_id": "7Aw1MfzngKk",
  "channel": "HighLoadChannel",
  "title": "OpenStack: от enterprise к сервис-провайдеру / Сергей Пимков (Селектел)",
  "views": 364,
  "duration": 1495,
  "published": "2017-07-30T00:47:36-07:00",
  "text": "следующий доклад у нас про нижний уровень и прострочить сервис если мы поговорили про всякие разные configuration management и так далее докладывают от ребят которые действительно умеет это делать уже много лет делают компания select all который делает хостинг и в том числе облачный хостинг будет рассказывать про openstack и опыт работы с ним ну и также не про свои продукты которые они сделали на окон стеки сергей пинков из компаний силы кто поприветствуем всем привет мне хотелось бы поделиться нашим опытом адаптации ванильного конспект под нужды сервис-провайдер этот опыт мы получили разрабатываем нашу услугу виртуальные приватные облака долгое время мы разрабатывали поддерживали облачный сервис на снова на основе зовут платформ и нашего собственного толстый к услуга отличалась от всех других моделью оба до употребления ну может быть не от всех но за все это время у нас накопилось большое количество опыта отзывов предложения критики результате чего мы решили разработать новый облачный сервис на основе лучше поддерживаемых и более современных решений проблемы с поддержка были как у нашего собственного толстый к часть которого была написана на хаскеле и соответственно с точки зрения производительности в нем все было великолепно а вот с точки зрения сопровождения не очень проблемы были также и сторонняя компонентов в частности гипервизор zen из-за политики компании citrix за эти несколько лет изрядно потерял своей привлекательности поэтому мы обратили свой взгляд на квн который к этому моменту работа уже очень приличный функционалом и при этом быстро разрабатывался в качестве платформы мы решили использовать openstack у конспект самое главная проблема пустой к кроется в нем самом он немного похож на индусский 3 учебу в которой постоянно что-то строится ломается строится снова и перестраиваться целиком при этом если мы хотим построить действительно современные и хорошие облака в данном у меня тупо так одеться практически нет все остальные решения не заведомо либо менее функциональны либо же закрыт и соответственно таким образом мы оставишь не используем пластика они недостающий функционал решили в случае необходимости запили сами в ходе реализации облака перед нами стало несколько глобальных вопросов о которых я сейчас расскажу ну в таком около хронологическом порядке самый первый вопрос какой возник это где собственно вопрос так брать и как и вадимович в первую очередь мы рассмотрели несколько венгерских решений которые в самом делились на два основных типа первый тип это скажем так обфусцированы и решение видов ключ и получи и никогда не поймешь что там внутри происходит примером такого дистрибутива является продуктом компании python клауд другие решения представляют собой конструктор сделай сам например это правда платформ от red hat там мы есть модули документация поддержка но при этом версия было несколько протухшей здесь хочу сказать что если мы разрабатывали приватное облака под собственные нужды в принципе дальше можно было бы даже и не ходить венгерские решение на тот даже на тот момент обычно про садик windows key и решения даже на тот момент в принципе было посеваю вполне под силу поддерживать парик и фиксируем программистов а сейчас они еще более эволюционировали и вероятно сейчас можно даже не держать штате человека который хорошо разбирался в постельке пока между первого падения и еще один путь добра соответственно учитывая специфику наших задач мы решили не искать легких путей и воспользовались исходным кодом прямо с гитхаба для того чтобы не гепатита все руками мы написали набор по 5 модулей который поседение успешно работает он достаточно узко специализирован и расширяется точно там где нам надо сейчас такой ситуации мы бы возможно воспользовалась очень хорошими моделями от компании мир on this но на тот момент они были еще не вполне готовы для продажи на ну и плюс содержали себе фатальный недостаток будет его reuters лагерь 2 второй вопрос который сразу же мы обратно который мы сразу же обратили внимание это проблема пользовательского интерфейса в пасти входит компонент по названием horizon а это их панель управления она написана на django достаточно но я бы сказал что написано людьми но для роботов или может быть для инопланетян потому что они пытались запихнуть в эту панель весь функционал конспекта совершенно без оглядки на удобство использования иногда некоторые штуки найти где-то в недрах бесконечных меню достаточно сложно соответственно на мой взгляд хорезм пригоден для поставки только в составе готовых решений под ключ всяких приватных облаков который будет един уже настроены и потом там будет работе толки которые будут совсем не просить каша годами нам же требовалось что-то лучше соответственно учитывая то что у вас такие есть открытый api мы написали собственную панель управления на java скрипте панель и и протрите было достаточно быстро и в данный момент она уже проходит свой первый редизайн я вышку для улучшения удобство ее использования панель соответственно как я уже сказал будет обросла дик было реализовано целиком с помощью api здесь я хочу отметить что в принципе это аппетитный вот именно rest api наилучший способ общения с окон стеком там почти всегда все хорошо хотя странности на самом деле хватает иногда приходилось лишь документа существенно документация часто оставалась неполна соответственно здесь есть такой небольшой маленький лайфхак соответственно чаще достаточно часто проще не смотреть документация запустить cansonic людям крючком дебаг и он покажет все запросы которые выполнял удобно мне восприятие формате вокруг команды и так следующих лади пожалуйста следующая проблема она концептуально собственно как это вообще продавать что с этим делать на тот момент в стек уже содержал себе компонент авторизация кистон то есть поддерживал такую модель в которую пользователь мог создавать несколько проектов и несколько пользователей и давайте пользователям доступ к этим проектом принципе можно было бы взять вот это так как она есть то есть каждый наш клиент получал бы свое распоряжение один проект и в нем создало бы виртуальную машину такая модель полностью соответствовала модель нашего старого облака и также десятков и даже сотен других услуг осознанных по такому же принципу то есть плоское пространство в котором есть виртуалке диски и прочие объекты при этом тот фидбэк который мы собрали в ходе эксплуатации нашего старого облака показывала что в идеале пользователь хотели бы видеть лучшую степень изоляции и разграничение прав доступа а на подходе был уже релиз гризли с blueprint аметист он api v3 которая реализовала такую сущность как домен в принципе картинка вырисовывалась такая каждый наш клиент получал враг свое распоряжение этот самый домен в котором он может может самостоятельно создавать несколько проектов и несколько пользователей и каждый такой домен изолирован от всех остальных проекта свою очередь тоже изолировать таким образом говоря по-простому каждый клиент может создавать много облаков и много пользователей соответственно осталось разобраться с ресурсами ранее используемая нами модель оплаты по потреблению как показала практика оказалось неудобно показалась удобной только дали достаточно узкой аудитории в которой которая действительно получала от этого немалый профит имея возможность сэкономить на в каких-то фресках потребления но к сожалению такая концепция носила смятение fm и другой части наших клиентов которые даже не могли хотя бы примерно прикинуть сколько будет стоить их виртуалка соответственно здесь мы остановились на более простой модели это продажа ядер памяти диска и тому подобное но поскольку раз уж мы продаем облака мы не можем просто взять и ограничить юзера какими-то фиксирования конфигурациями или флэйва риме в терминологии пластик мы должны продавать ресурсы соответственно здесь мы воспользовались systemic вот в постельке вкратце администратор проекта имеет возможность за лимитировать проект сверху по каждому из типов ресурсов сожалению здесь мы получаем проблему если мы отдаем этот функционал пользователю то что же делать нам как же нам за лимитировать его самого сожаление на тот момент доменных вот то есть кот кот их не было еще даже видео blueprint где-то и отсюда назрела необходимость реализации нашего собственного компонента который занимался этими вопросами и так этот компонент была благополучно запилен он по сути занимается тем что привязывает у поста к реальной жизни в виде уже существующую систему авторизации и соответственно биллинговой системы каждый каждому для каждого клиента создается домен в котором он может там создавать удалять проекты пользователей проще и назначать квоты на ресурсы чуть позже этому компоненту пришлось отдать еще ряд функционала например выделение плавающих адресов плотины пи и белых под сетей это стало необходимым потому что алгоритм выделение флоте настойки таков что клиент имея квоту в один адрес может со скоростью выполнения запроса перебрать весь пул доступных адресов то есть каждый раз вам будет выделяться новый-новый-новый соответственно простор для рассылки спама например просто шикарный вот соответственно такие запросы мы проектируем сейчас наш собственный компонент ну и не даем клиентам недобросовестно скажем так можно этим заниматься тем чем они хотели бы заниматься здесь могли бы быть и более простые решения например за лимитировать api сам по себе но это понесло бы уже проблемы и для тех пользователей которых мы уважаем и любим который не занимаюсь такой ерунды и так соответственно следующая проблема вопрос с которым мы столкнулись это вопрос подготовки образов виртуальных машин которым часто сначала никто даже не думает мы долгое время исповедовали принцип в котором операцию систему установится на машину с нуля каждый раз этот принцип великолепно обеспечивает уникальность тех объектов которые должны внутри виртуальной машины уникальные всякие ключи еды портится и тому подобное но к сожалению требуют ждать минимум минут 10 пока пиратам система будет установлена пока мы оставили эту концепцию мир двигался вперед и на тот момент мы уже понимали что ожидать 10 минут каждый раз при сварке виртуалке это слишком много это полностью ломает все возможности используя облака и создание виртуальных машин нам demand соответственном требуется мастер образ как же его получить если кстати замечу нет этих чуть попозже замечу нам требуется мастер образ получить его можно сняв как мастеркопию вас уже установлены машины но машины сперва надо установить на тот момент поддержки установки виртуалок ce iso образов в постройке не было он приносит чуть позже из первом появился для машин с локальными дисками только потом авто маме системе center который управляет соответственно дисками это появилась только сейчас буквально в релизе джуна с помощью системам беде его 2 и это там пришлось немножечко про патчи чтобы это работало как надо соответственно navi была использована простая идея здесь взять маленькую и сошку формата business card размером 20 или 30 мегабайт далее раскатать и на диск виртуальной машины и загрузиться с этого диска ядро интернете загрузится в память инсталлятор начал свою работу и весело затрется себя установив операцию всем он этот диск идея пока достаточно странно но рабочих как казалось соответственно далее мы забили ли инфраструктуру которая автоматически загружала свежего и сошки устанавливаем виртуальной машины снималась не заливала их диски в glance хранилище образов и навешиваю нужны нам свойства инфраструктура была написана также целиком на openstack здесь я хочу отметить что мы сперва пытались использовать python клиенты в посте к они оказались не столь и качественно как нам того бы хотелось во-первых они все разные во вторых они часто не совсем функционале относительно api в итоге мы переписали все на request то есть я и до сих пор могу рекомендовать как бы с этими клиентами особо не заигрывать как нам кажется соответственно хорошо мы получили образ но он является грязным то есть в нем присутствует не уникальный вид партиций соответственно в нем есть хвост ключей состричь которая также получается не уникальна все группа таких машин нам это надо чем-то все очистить то есть подготовить диск эксплуатацию уже продакшне скажем так для этого нужно что то что действие выполнено и это что-то это агент который выполняется внутри виртуальную машину соответственно весь этот функционал выполнять наш собственный агент который мы реализовали нашел его к можно было бы спорить использовать клауд и нет мы пока что не нужно это такой инструмент который сперва кажется привлекательным потом в нем оказывается бездну всяких недоработок он примерно это же оперу что я об старт в общем лучше не надо для виртуальной машины этот на старте и таким должен выполнить как минимум следующее действие настроить сеть этот пункт выпадает если используется dhcp но если дождь и пинеток кто-то должен прописать статические конфиге клиент это умеет далее нам необходимо установить пароль и желательности делать это secure кроме того нужно перегенерировать код ключи и видит партиции и расширить диск расширить портится на размер всего диска здесь еще замечу что ключи что пароль внутри виртуальной машины мы передаем в сугубо в виде хэша то есть никого план текста не используется но соответственно все вышеперечисленные наш агент естественно делает будьте добры садик переключайте пожалуйста ну собственно помимо вышеперечисленных вот этих вот глобальных вопросов нам потребовалось решить еще достаточно большое количество мелких задач для чего потребовалось как разработана нами всякие скриптик и инструментики так и те которые представал сообщества примером такого скрипте к которая была изначально и сообществом потом очень сильно допилили эта штука которая реализует failover виртуальных роутеров то есть когда у нас один шлюз падает кто-то должен перенести роутер на другой шлюз сейчас с этим стало становится потихонечку легче потому что вы пластики появился дистрибьютер роутер но раньше этого делать вот таким скептиком в принципе значительная часть функционала которое нам нужно было ацтека он потихонечку появилась например это поддержка нескольких брендов для хранилища дисков центра и реализации ограничения по и общем которые нужно нам в общем-то жизни на необходимо другой функционала он так и не появился поэтому нам пришлось сделать его самим это например почти на поддержку системы квот для глаз охраняющего образов сейчас для него существуют blue print и носом но как бы реализация пока вы постой-ка входе всему это выяснились как достоинства так и недостатки самое главное достоинство это то что учитывая его расширяемость и модульность в общем-то у нас не было ни одной такой задачи которая нам нам не удалось бы решить а недостатки это и низкое качество кода в одних местах и высокая его сложность других местах это целая куча абстракцией с которой надо продираться каждый раз при отладке ну и это бюрократии zero во ность процесса приемки патчи из-за которого скажем так значительная часть наших функционала так и не пока не попала в обстрел у вас просто нет возможности выделить человека который дня либо сидела и ругался с рабочими понс т.к. будьте добры схватив еще в целом хочу сказать что задача в итоге получилось сложнее чем мы думали проводились немного дольше вот и это никак не получилось без команды очень мощных ребят вот соответственно здесь я хочу сказать что в итоге мы получили совершенно чудесный продукт в котором собой страницу пластика с другой стороны нету цвет или возни соответственно и нет своего и не надо покупать свою желез и не надо заводить и специалиста который будет сидеть и изучать окон стек здесь соответственно например для разработки присутствуют такие удобные вещи как вы можете сделать отдельный проект облака упа produce например сделать еще один маленький поддержку и сказать что джуниору россию можно ходить только где в пол of product ему нельзя а если придет еще один джуниору пейте тогда можно развернуть точно такую же кула это будет сделано но за несколько минут потому что здесь у вас есть готовые образы сделать клон облака очень легко ну и соответственно всякие вопросы вроде развертывания 20 дополнительных машин так напакостить на пару часов это тесто тоже все решается потому что тарификация почасовая и здесь в общем то нет никаких проблем собственно здесь много другого интересного но поскольку у нас конференция все-таки техническая перец и долго не буду этом всем спасибо за внимание соответственно вопросам когда спасибо за доклад скажет просто какая вы сейчас версию подставок используется у нас сейчас стоит джоном как вы планируете обновляться а у нас предусмотрено модель rollin камней так то есть примерно через два-три месяца после выхода релиза то есть мы ждем пока появится пару следующих версий которых будут там обычно по 200 фиксов принимается сразу после релиза поэтому немножечко ждем какой у вас систему если тёплую под теплую выпуске новой версии вот руками делается но частично как бы это делается на уровне папито так частично бывает что и руками потому что одноразовое действие их часто не просто нет смысла автоматизировать вашим не одноразовые с какими проблемами в работе конце т.к. в продакшен не столкнулись например но здесь в первую очередь следует отметить проблемы реализации сетевой по системы то есть их это в общем то можно сказать даже общеизвестно вот их система плавающих опять ирисов ванили реализации с помощью виртуальных роутеров она не очень хорошо держит нагрузку на самом деле то есть там и latency растет и скажем так шлюз весьма уязвим банальному дозу соответственно мне очень нравится вот этот момент то есть мы его в данный момент обошли тем что в качестве решения для продаж на предоставляем самый обычный whelan с прописано неслась 29 подсеть угол и еще такой вопрос если у вас поддержку горящую приключений ура тайных машину другую гипервизор если основной падает куда на другой класс d другой хост да естественно то есть если у нас вот этот ход у вас недоступен виртуаль виртуальная машина будет в холодными другой хостом перезапустить этого раздавали киви это вы рисовали гипервизор киваем он в общем то очень хорошо имели умеет живую миграцию на самом деле лучше чем зайн который котором у нас так и не удалось побороть и некоторые проблемы живой миграции из количества связаны железом но тем не менее здесь все работает прекрасно здравствуйте они немного в продолжение предыдущих вопросов да если не секрет назывался инсталляция а пластика какая но смысле по конфигурациям сколько машин она занимает и сколько человек вас обслуживает и но количество хвостов и не скажу вот но для управления у нас используется три контроллера то есть но соответственно троекратное резервирования сядем падает еще два работают два падает то хотя бы один будет держаться так соответственно все api , запущены на вот этих 3-х стах там шабаш заданных реплицируется ну и собственно дальше видимо нужно более детальный вопрос что вас интересует у нас сейчас получается над проектом работает но прямо сейчас в данный момент очень наскучат четверо разработчиков я и есть им администратор не очень крупная команда но очень производительны все вопросов нет я вопрос массива сергей"
}