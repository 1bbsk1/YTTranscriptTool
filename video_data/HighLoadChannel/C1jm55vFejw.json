{
  "video_id": "C1jm55vFejw",
  "channel": "HighLoadChannel",
  "title": "RU, RTB DSP на языке Go укрощение buzzwords / Даниил Подольский (Qmobi Com)",
  "views": 5813,
  "duration": 2726,
  "published": "2017-04-10T02:02:39-07:00",
  "text": "так коллеги Добрый день я технический директор компании куби я одновременно программист на Go я одновременно специалист по высоким нагрузкам ртб я занимаюсь уже практически второй Ну то есть кончается второй год а значит доклад мой про построение ТС коллеги поднимите пожалуйста руки те кто знаком с проблематикой ТБ кто вообще знает что это такое О как интересно отлично отлично хорошо что у меня чуть больше времени чем 45 минут Итак немного оком компания занимается интернет рекламой что Тае технология поставщикам рекламного трафика продавать тот рекламный трафик который они сами утилизировать не могут например Google получает миллиарды в сутки запросов на показ рекламы Google имеет полную информацию о тех кто эти запросы делает о конечных пользователях Google показывает им то что считает нужным сам а вот те пользователи которым Go показать сливаются Гуглом в ртб как это происходит Значит от Гугла на ртб ССП платформ уходит запрос платформ - это сервер который сделает одновременно параллельно Запрос к дей платформы DSP вот о котором собственно пойдёт речью от в ССП вот тут начинается потому что ДСП должен ответить в ССП за 150 миллисекунд это довольно мало значит после того как со всех ДСП которые вообще нашли в себе силы что-нибудь ответить запрос приходит в ССП ССП осуществляет аукцион второ выва тот ДСП который предложил больше всех но выигрывает его не с той ценой которую предложил а с той ценой которая была бы нужна той минимальной ценой которая была бы нужна для того чтобы выиграть этот аукцион Вот так это вкратце работает хорошо что у меня было время этот экскурс устроить Да так вот мы занимаемся интернет рекламой начинали мы с продвижения мобильных приложений довольно быст натки наши можно использовать не только для продвижения мобильных приложений но и для рекламы товаров и услуг Ну в общем это мгновенно выясняется когда ты имеешь дело с рекламой и Мы приступили так сказать к реализации проекта ртб ртб - это много трафика то есть мы не напрягаясь получаем 10 сся запросов в секунду практически полочка правда есть поз что большая часть этого трафика мусорная что те ответы которые мы выдаём на этот трафик они никогда пользователем увидено не будут Ну ну вот что с этим делать неизвестно это сейчас Ключевая проблема ртб И вообще Ключевая проблема рекламного рынка интернет-рекламы Как сделать так чтобы реклама работала возможно Возможно если брать деньги не за показ как это делается в ртб А за лит То есть за человека который не только кликнул по баннеру но и перешёл в соответствующий магазин и сделал там покупку возможно тут ситуация с интернет рекламой оздоровиться но пока этого не происходит Мы будем видеть на своих телефонах всякое Извините Вот все вот эти баннеры маловат нерелевантные странные баннеры которые нарушают parent Control вот это вот всё в этой связи мы с компанией куби и со всеми аналогичными компаниями стараемся как раз в эту сторону работать чтобы реклама была таргетированной кликать Да так вот сй ПТФ - это та часть которая собственно передаёт рекламу То есть это не не техническая это как раз та часть которая завязана на рекламодателя именно на дей платформ Вернее на его части на н desk рекламодатель должен указывать Кому именно какую рекла как сй С С какой агрессивностью он должен показывать в этом смысле это вот экосистема ртб начинается с нас вот мы до этой весны использовали стек технологий dnet Ну тому есть разные исторические Причины нет никаких технических очевидно что для Хада net подходит не очень это на самом деле не совсем верное утверждение нас того что подходит для но тем не менее я люблю его делать потому что не люблю работать с Windows Да так вот благодаря тому что мы сразу поняли что dnet на котором мы писали весь наш йн и на котором он сейчас работает для хауда подходит не очень мы были свободны в выборе Но выбор-то на самом деле не широк Когда вы делаете промышленный проект може выбирать из того что работает на GM Ну начиная собственно от Явы и заканчивая например GR Вот Но в любом случае GM она надёжная Она быстрая вот dotnet тоже надёжный и быстрый просто немножко по-другому надёжный немножко по-другому быстрый вот и всё остальное надо сказать что весь 2014 год я посл написанию и вынужден заметить что вот перл и другие скриптовые языки для этой задачи подходят не очень Не очень но они вообще для хайлоу мало подходит но тем не менее так вот из всего остального мы выбрали го А почему го Э да ни почему Ну просто это модное слово оно Нам нравится Мне лично как техническому директору нравится слово go я им воспользовался Ну в некотором смысле это произвол в некотором смысле весной ещё не было понятно что го выстрелит вернее так многим было понятно Мне не было понятно Мне было просто интересно Так теперь немного о докладе есть некоторая проблема с докладами которые надо подавать в начале сентября А докладывать в начале ноября я подавал доклад по тому материалу который я набрал в августе я подал его те порн по требованию программного Комитета и по собственному почину менял тезисы Но даже последняя версия тезисов меня совершенно не устраивает поэтому никаких я буквально вчера придумал себе новую концепцию никаких цифр и графиков в докладе не будет потому что он не об этом а вообще о чём этот доклад это банальная Success Story у нас всё получилось Мы не встретили Никаких особенных проблем А об этом будет чуть позже про вообще про эту задачу В общем сплошные розовые единороги правда Если приглядеться там кое-где лежит довольно толстый слой радуги от этих единорогов я не буду его от вас прятать я его вам предъяв со всей как бы сказать агрессивностью Вот Ну и основная мысль доклада К сожалению тоже банально что выбран ин стал шире для проекта можно выбирать из dnet можно выбирать из можно выбирать из и можно выбирать из всего остального Я правда не знаю что там осталось То есть вряд ли можно рассматривать c+ как вариант для проекта Не потому что c+ плох а потому что он сложен вот а вс-таки должен быть простым Но это философское отступление так Эс В и С чего он там первый или второй ссылкой получит Т прийдя на сайт Кида Он увидит вот эту прекрасную картинку Кит он предназначен для построения ТБ ССП это некий компонент к которому подключаются четыре компоненты других которые вы должны написать сами и у вас всё получается вот готов ваш тбс намт значительно более сложным образом и значительно менее готовым к тому чтобы к тому чтобы просто вот раз и в продакшн вот что собственно представляет из себя ртб Kit я на нём так подробно останавливаюсь потому что это действительно основа для построения множества проектов аналогичных люди его постоянно используют так вот не надо Kit - это во-первых c+ во-вторых 4 часа сборки Если вы что-нибудь поменяли в каком-нибудь р файле это снова 4 часа сборки Ну все в курсе наверное как работает п+ и его сборка Вот это документация в которой интерфейсы описаны в терминах наследования типа А как мне послать запрос туда-то и туда-то А вот у Следуйте от такого-то нашего класса Спасибо родные запутанная архитектура что я имею в виду в одном Проекте в одной собственно в одном проекте который вот одним куском поставляется используется J конфиги xml конфиги Но это может быть Ладно используется zer для того чтобы какие-то другие конфиги распространять по кластеру используется zq для передачи для очереди и используется редис для персистентность в принципе вот было бы чего-то одного скорее всего редиса Ну тем не менее все четыре имеются в проекте Ну значит картинка Я могу её вернуть Если она кому-нибудь интересна но вряд ли она интересна она здесь есть маленькое вот то что Синенькая это то что есть в ртб ките а то что красненькое - это то что мы должны были бы написать сами должны были бы и написали 2 3 4 5 компонентов были нами написаны и мы получили полнофункциональный ДСП на собственно вот то что мы написали мы написали на Go остальное было на c+ связывалось между собой это всё по http В общем Ну как-то вот как принято Да что осталось от ТБ кита от ТБ кита остался мра за Эх вот Конечно вот тут бы мне надо бы е остановиться на тем как это устроено Что такое Бир давайте я кратко расскажу раз у нас мало людей которые знают что такое ртб Да так вот в тот момент когда на ДСП приходит запрос на рекламу мы должны эту рекламу подобрать и придумать за Кай За какую цену мы гото показывать этим и зачат заго применяет к этому запросу то есть вернее так применяет параметры этого запроса к тому таргетингу которым который у него есть выбирает подходящую компанию выбирает из этой компании подходящий баннер Ну в том числе по размерам Вот и отдаёт отдаёт это обратно чтобы ДСП ответил на запрос Вот это раз и Банкер Дело в том что мы не можем просто отдавать както учитывать те деньги которые мы тратим для того чтобы не было перекрута но это всем кто с рекламой интернет не знаком знает что такое перекрут и почему это плохо Почему пользователь бывает недоволен если мы перекрутил из 20 например Ну тем не менее Да так вот Банкер Банкер снимаем со счёта компании некоторую сумму через некоторое время если мы не выиграли аукцион мы эту сумму на счёт компании возвращаем если мы выиграли аукцион то к нам приходит вин нотификация с той ценой за которое мы выиграли этот аукцион соответственно мы эту возвращаем то что мы заблокировали в первый раз и снимаем то что мы ту цену по которой мы выиграли аукцион Да так вот два компонента нам остались от ртб кита рутер и Банкер при этом рутер довольно неудобный например в нём надо зарегистрировать все наши креативы для того чтобы рутер справился нам на них их подобрать иногда рутер по каким-то своим причинам наши креативы перестаёт показывать разбираться с этим довольно сложно смотреть в этот сипс плюсны код довольно неприятно В общем примерно так так вот может быть если у нас остались всего два компонента может быть их надо переписать и мы их переписали немного о задаче значит это не то что у нас есть сейчас сейчас мы в режиме ограниченного тестирования сейчас у нас довольно мало пользователей меньше сотни но тем не менее рассчитывать мы должны были нашу систему и нагрузочное тестирование проводить на тысячу пользователей по 100 компаний каждый по 100 креативов на компанию Креатив - это в просторе Да так вот 10 млн строк Вот такая довольно небольшая такой довольно небольшой Трейдинг деск даёт нам 10 млн строк вот просто вот так вот и это второе место где эта задача превращается в настоящий ха первый был там где жёсткие ограничения на время ответа это пользователь может подождать секунду две а робот ждать не будет запишет нас в Негодяи 10.000 запросов в секунду - это тоже требование бизнеса мы можем получить гораздо больше нам не надо Дело в том что мы ограничены пользовательскими бюджетами если мы будем выигрывать каждый из 10.000 аукционов в секунду мы сольётесь бюджет примерно за полтора часа всех наших пользователей дневной бюджет нам это ни зачем Не надо более того на самом деле пользователи этого не любят пользователи любят равномерную открутка Поэтому какая нам разница сколько запросов в секунду мы будем игнорировать вот Ну вот Ну то есть всё равно 10.000 - это тоже довольно много более того в конце концов выяснилось что это предел для нашего одного сервера вот что На одном сервере мы не можем а потащили и по некоторым причинам о которых я скажу чуть позже не можем и на двух потащит больше Но об этом позже ещё задача на самом деле в тот момент когда ты берёшь в руки спецификацию ртб читаешь всё это задача выглядит реально прямой как палка и простой как 3 копейки Ну что вот пришёл запрос ты его смал отдал ответ Ну нормально Вот выглядит как хорошо масштабируемая задача потому что это же http Да он масштабируется горизонтально Банкер Банкер не масштабируется баке рди То бишь разных разные компании откручивать на разных банке Вот но невозможно масштабировать потому что нам не дают соответствующую базу данных Какая база данных то есть кап теорема коллеги поднимите пожалуйста руки Кто знает что такое кап теорема Отлично Да так вот C нам не дают Баум дау не дают cons и и Ну вот вот cons для распределённых кластеров Ну как-то отсутствует Нет его такр тоже представляет из себя проблему то есть ровно те два компонента которые нам интересны представля стат изб выбора правильного креатива Это задача отсчёта пересечения множеств по счёту пересечения множеств с низким кардина То есть у нас на одно и тоже значение приходится очень много очень много строк То есть фактически если мы имеем 10 л строк Мы ктис всегда считаем множество 5 млн 5 млн 5 млн и 5 млн вот множество как известно у нас базы считают или сортировкой или полным перебором сортировкой тут беда потому что непонятно по какому параметру их сортировать вот а с полным перебором Ну понятно да полный перебор это прекрасно Это мы всегда любим особенно в лоде вот А ещё после того как мы сделали это самое пересечение изл 3 л результатов Да их нам надо отсортировать по нескольку параметров по приоритету например да то есть высоко приоритетные компании должны идти откручивать Раньше даже если по расчётам нашего робота они принесут принесут нам меньше прибыли так интересно стало громче вот если у нас мы показываем компанию Да она может быть самая выгодная но вки один и тот же банер пользователю показывать ВС время пока начте компании не кончатся деньги Поэтому надо отслеживать ситуацию при которой надо внимательно отслеживать чтобы открутка была равномерной Вот по цене показа понятно Ну мы хотим максимизировать собственную прибыль по остатку на счёте компании Да компании у которых осталось меньше денег должны ОТК меньше менее интенсивно Компани больше боле интенсивно Ну в общем в общем нет в лоб эта задача оказалась нерешаемый я провёл примерно месяц тестирую разнообразные базы данных и пису разнообразные запросы результат меня не удовлетворил то есть в самом быстром варианте в самом таком приближении вот 4 4 с по секунды занимает каждый запрос и это не по всему не по всем 10 миллионам а по тому количеству которое у нас было тогда то бишь в районе там полутора миллионов Ну то есть всё очень плохо А вот теперь то чем что я выяснил про этот ртб проект и выяснил не сразу а Наверное уже к концу сентября А значит в нём есть два типа задач или это тривиальные задачи которые просто решаются и всё Ну садишься и пишешь код или задачи которые не решаются вот э задача с пересечением множеств Ну никак нет способа Вот это Меня очень расстраивает потому что на самом деле способ То есть просто я его не знаю я Плохо учился в институте вот там где вот нам преподавали теорию множеств там надо было лучше там конспект вести например а не просто спать с перейду к его описанию для начала об очевидных технических решений решениях код сетевого взаимодействия Наго триале да то есть из нестандартного из того что нам пришлось взять из того что не того чего не было в стандартной библиотеке это парсер ртб фактически это перевод Джейсона в структу Ну ну не было его Ну в смысле он не входит Не в стандартную поставку там другое стандартное там другой слой абстракции стандартный nginx Знамя русского хайлоу Значит на самом деле в этом проекте nginx был бы не зачем не нужен если бы мы не хотели если наш код Почему либо слишком долго работает ответить в указанное время код 204 это пользователю можно сообщать разные глупости типа у нас произошла у нас произошла соединени с эндом нет вот Т робота ССП это всё не интересует ему надо ответить или 200 и текст ТБ или 204 Что означает что нам тебе нечего показать Вот и наш аккуратно атно не уложились отвечает 204 закрывает соединение В общем как-то как-то обеспечивает нам держит нас в рамках каширование креативов и компаний вот те самые 10 млн строк на самом деле в байтах представляют из себя около 16 Гб Вот соответственно для того чтобы на сервере с 48 ГБ оперативной памяти мы можем зашивать аж на две версии одну с которой работаем и вторую которую мы сейчас обновляем чтобы потом подсунуть вместо первой Вот это очень хорошо но опять же это тривиальное решение все так делают вот даже немножко смешно на такой конференции об этом говорить но тем не менее Вот так и есть значит ещё очевидное техническое решение на отдельном слайде потому что на том слайде оно не поместилось это геотаргетинг да один из самых главных таргетингов в рекламе и в ртб это гео то есть есть баннеры которые мы хотим показывать жителям Москвы и только жителям Москвы а есть баннеры которые мы хотим показывать жителям не Москвы вообще вот этот вот негативный таргетинг он отдельно добавляет прелести во всю эту задачу вот ну вот что такое не Москва Да это перечисление всех остальных кодов вот как построить индекс не Москва никак Вот значит Поэтому мы были даже вынуждены Сначала мы думали что той информации которая приходит к нам в ртб пакете будет достаточно для того чтобы осуществлять геотаргетинг Нет там в очень странном Это был для нас сюрпризом в очень странном формате приходит информация иногда с русскими буквами Иногда с буквой нного пункта написано латиницей а вот та буква которую они не знали как транслитерировать она осталась оригинальной это вот ну в общем в общем вот нам пришлось ориентироваться на те на те координаты широта долгота который нам передаёт ртб нам пришлось превращать их в коды по3 именно по нам пришлось очень сильно поковырять базу Open для того чтобы она работала достаточно быстро фактически выкинуть из неё всё кроме границ областей Штатов графств стран вот это вот всё ну и оставить крупные города то есть по-моему крупные города даже остались только для России Вот потому про всех остальных нам было достаточно региона быстро Ну всё равно мы её ширу как-то то есть мы загру бля эти самые координаты и довольно Ну в связи с тем что примерно половина нашего трафика российского - это Москва Да вот мобильного вот мы довольно часто попадаем прямо в кэш Ну то это всё тривиальное Опять же всё абсолютно тривиально обидно что примерно треть ртб запросов координат не содержит что с ними делать нам неизвестно Поэтому если мы нашли в запросе что-нибудь Что позволило бы нам сделать геотаргетинг мы делаем геотаргетинг по именам кат и сити которые там переданы А если его там не нашлось то просто значит ну этот запрос нам не годится не очень понятно Может быть мы таким образом теряем самый вкусный трафик Но мы же не понимаем что с ним делать Какой баннер показывать вот Так теперь о спорных технических решениях вот тут может стать интересно вот в качестве банке мы используем mysql А ну решение такое да то есть мы быстренько это дело набросали когда нам нужно было создать прототип А ещё в обвязке к ба к ртб киту вот и он прижился вот оказалось что из нормального ТБ ой mql 57 можно извлечь сегодня примерно 100.000 Ой да 100.000 апдейт в секунду на самом деле не 100 а не 100 можно извлечь 10.000 апдейт в секунду на самом деле 20 потому что каждый запрос - это блокировка средств и разблокировка средств и очень редко на самом деле по сравнению с общим количеством снятие средств Ну то есть вот 20.000 апдейт в секунду современный mysql на SSD диске держат знайте это это спорное решение Почему Потому что не масштабируется и даже с поднять на таком количестве апдейт довольно трудно бывает Ну то есть у нас сле самые там где Пик отстаёт очень сильно от мастера но тем не менее Вот ЛОР на inf db Ну db - это такая база случайно так получилось что она написана на это не очень важно она не очень хорошо написана она вообще очень странная например Сколько бы ни было нот в кластере в выборах участвует только три из них и их надо правильно добавить в кластер А уж Если речь идёт о том чтобы заменить то это просто це целая эпопея но тем не менее это Тай серия с база она используется довольно часто для метрик для графана и мы туда тоже пишем все наши метрики и показываем их потом фано В общем в общем прижилась тоже обычно обычно логи пишут влак сч и потом ищут по ним ки Бано Вот но elas sech очень сильно грузит диски потому что elastic sech пишет на диск мелкими порциями а потом читает мелкие порции пишет более крупную порцию и это итерации он повторяет раз п Ну если Вы хорошо подобрали под ваши данные параметры размера этих чанков он повторяет эту рацию три раза минимум это означает это означает что всю то есть весь диск который у вас есть сколько бы вы их не вставили в сервер он утилизирует начисто вот поэтому с эластик см который мне вообще-то нравится по нему удобно строить отчёты он удобно арет по нему можно в конце концов тонизирует соответственно Можно потом по этим токенам поискать вот этого всего от всего От этого пришлось отказаться потому что не справлялась А вот теперь самая интересная часть доклада Я вообще вот очень люблю доклады не про то как у нас всё получилось а про то где мы облажались потому что как у нас всё у меня тоже много чего получилось а вот чтобы Не облажаться хорошо бы учиться На чужом опыте Да так вот как устроен таргетинг Никак он не устроен то есть мы выбираем случайную строку из нашей базы в 10 млн проверяем годится ли она нам под наш запрос если годится то отвечаем если не годится то выбираем следующую и повторяем так до тех пор пока у нас не кончится время или до тех пор пока мы не найдём подходящую строку Да да да вот это работает мы проверили мы сутки гоняли на сохранён на записях из логов мы сутки гоняли получилось за сутки он обработал у нас по-моему полтора часа Или даже меньше что-то 55 минут может быть тем не менее мы сутки гоняли нашу систему с точными запросами которые делают все пересечения множеств которые делают всю сортировку Какую нужно и расклад по компаниям конечно не получился по трате средств по Компани не получился тем же самым какой какой получился при случайной выборке но он и не получился с перекосом то есть примерно примерно Мы со своей случайной выборкой во всё попадаем Ну и слава Богу я на этом месте немножко успокоился Хотя понятно Да как как приятно мне былого самом деле конечно никогда по всему по всем 10 миллионам мы случайно выборку не берём вот по основным таргетингов пасть Да так вот по основным таргетингов прямо в структуру кэша в котором у нас закро все компании Вот и Ну соответственно там Рандом получается в районе на 10 млн записей получается в районе ТХ иногда полутора миллионов Ну то есть Ну всё равно Рандом Да вот тут нам нанёс подлый удар го гоу шедулер А значит как известно в языке Go шедулер базируется на операциях ввода-вывода то есть переключение между с этими самыми нитями легковесные происходит в тот момент когда нить пытается что-то пописать ва версия Мы очень были удивлены Почему так странно работает да пока наша нить бегает по этому самому кшу выбрали не подошло выбрали не подошло о подошло вот все остальные нити стоят на самом деле это не совсем так Ну вот Ну практически так то есть там есть треды по количеству по количеству прост из те са которые у нас имеются Вот они и работали Все остальные Ух ты ВС заканчивается Вот пришлось вставить соответствующую инструкцию куда надо Чтобы едить исполнение В общем всё получилось вот приоритизация вот это вот приоритетов у нас теперь ровно два нормальный и высокий и те компании которые обладают высоким приоритетом просто дважды присутствуют в кше и соотвественно вдвое большей вероятностью попадают в случайную выборку Я надеялся что вы будете смеяться громче вот значит доклад мы подходит к концу что дальше заменить SQL на CL на cons Возможно придётся написать свою базу потому что из всех протестированных а это там добрый десяток ни один так чтобы это было легкого не обеспечивает Ну потому что в них нет транзакций вернее у них есть транзакции на уровне строки А нам нужна нужен Лог по блокировки средств для того чтобы их потом разблокировать и соответственно это получается уже как минимум две табли на две таблиц ни у каких аэрос пайков кодб и вот этого всего нету нету транзакций Вот что с этим делать Пока непонятно вот таргетинг по произвольному про бору параметров всё-таки придётся сделать Второй подход меня это вот этот Рандом бесит реально вот анализатор логов сейчас мы гоняем по ним лайзер банальный Ну просто чтобы видеть структуру трафика Ну понятное дело немножко модифицированный вернее так там есть прослойка которая превращает наши логи в логика в коло чтобы лайзер мог их Нам показать Ну в общем что ещё поэто что тут ещё можно сделать Я не знаю но бизнес до обещал нам выдать к концу ноября каких-то метрик которые мы начнём пологом считать и автоматическая обратная связь на самом деле вот всё о чём я вам говорю это всё делается для как первый этап для создания робота который будет сам выставлять параметры эффективности компании и соответственно зарабатывать для нас деньги мы будем отдыхать на Канарах Ну или даже на Мальдивах а робот будет зарабатывать деньги Такой план Так значит итоге довольно быстрый результат это благодаря языку го потому что он вот именно в этой задаче очень точно попадает в нужный уровень абстракции вот три человека месяца практически всё сделано моими силами там я пару человек привлекал ну так временно как высокоэффективный 10 запросов в секунду Это вся инфраструктура суд суд для компаний кэш для компаний вот это вот всё живёт На одном сервере и Ну правда Загрузка процессора там в пиковых в пиковые моменты 90 с чем-то И тут на самом деле когда загрузка на процессоре высокая Go себя ведёт не очень хорошо то есть Может быть это надо как-то бы разделить например хотя бы базу унести тогда нагрузка на наш на го будет меньше там я думаю что из этого всего го занимает процентов 20 процессора и соответственно всё станет хорошо Да мы упёрлись в mql во что упёрся MQ я не выяснил я вокруг него танцевал с Нью реком я вокруг с него танцевал с перфо На что он тратит время на что он тратит 80% цпу Я не знаю Ну вот куда-то тратит и полностью свой проект то есть контролируем кодовую базу за исключением myq икса но myq eng попадают к нам в виде чёрных ящиков поэтому нас это не очень беспокоит м с ртб китом Это было бы не так всё-таки пришлось бы всё-таки в конце концов нанять в штат си ПЛЮСПЛЮС чтобы с ртб китом разбираться Спасибо за внимание вопросы Здравствуйте спасибо за доклад у меня такой вопрос а допустим у вас есть вот некая dely нода назовём назовём её так да которая на которой вот этот Бир крутится Угу А Вы сейчас пишете в локальный мускул к примеру вы вот пишете у вас счётчики по компаниям инкремент у вас 15 нот параллельно А как не сделать не перепродать скажем так Ну как синхронизировать между нодами как осл не сделать в тот момент когда к на мы отвечаем Бим мы пишем в специальную табличку инсерта добавлением строчку на этот инсертов по это честный к измене делаете в бае я правильно понима скажем так то что вы открутили что-то да Мы идём через стандартный интерфейс мускула кра Мы в базе там Триггер у нас работал он декремент сделал на счётчик некий Да но у нас 10 нот параллельно и компания одна и таже доставляется десятью нодами Ну у первой он декремент у второй для второй этот счётчик будет меньше нуля на самом деле не меньше то есть при документа как до Второй ноды эта информация доедет Я вот про это так они же выстраиваются там в очередь то есть там же в мускули есть блокировка на уровне строки для таблицы на ДБ В смысле у вас какая-то репликация будет как между нодами ноды параллельно работают Вот никакого никакого ло баланси для ля не это быть не может точка А как тогда смотрите у вас одна компания крутится параллельно на двух машинах У вас есть типа нужно открутить 100 пока каждая машина прежде чем ответить Бим ходит в базу и пытается Центральная база в которой эти счётчики декремент как её масштабировать никак вы говорите что 10к rps одна нода держит и говорите Что 10к держит Значит у меня там был пункт заменить mysql это как раз про это вот спасибо извините что недопонял нет ничего страшного Спасибо за доклад один из самых весёлых Наверное на этой конференции Спасибо есть такой вопрос Вот вы сказали что вы запускаете там вот среди этого множества там кучу рутин и они будут выполняться только по количеству ядер То есть у вас четыре ядра на машинки Пополняется четыре ки оста во с этим гипер трейдингом во восемь остальные ждут А какая у вас тогда смена контекста получается никакой нет подождите Мы были вынуждены для борьбы с этим эффектом в каждый цикл вставить строку которая сообщает шедуле что теперь пора забрать у меня управление и отдать мне когда снова будет к мо очередь сам этого не умеет я в принципе понял да но всё равно как-то получается что вы запускаете Там миллион рутин а зачем не проще было какой-то концепции через каналы прийти чтобы у вас постоянно рутины были и они работали Ну зачем Ну всё же очень просто вот этот самый сервер стандартный Гош без всяких каналов запускается функци если нам нужно в нужное место елд вставить это проще чем воевать с каналами и устраивать там действительно четыре рутины Тем более что http серверу тоже нужно время соответственно даже то есть мы не могли бы их запустить четыре мы должны были запустить бы их три например Ну вот эта вот вся логика Она оказывается лишней если использовать елт Ну там не ел а SH Go всё спасибо А можно вот тоже здесь вопрос не лево лево вот а я так понял вы и на ДБ использовали Да в My движок А вы не пробовали там потестить другой какой-нибудь движок Там же их много разных есть короткий ответ пробовали Ну ма сам вообще никуда не годится на этом месте мы его попробовали для смеху но My Сам он имеет блокировку не на уровне строки А на уровне таблицы тут же ещё что у нас довольно много строк мы редко попадаем в одну и ту же строку поэтому у нас редко срабатывает блокировка на уровне базы а ну что ещё ток ДБ оказался медленней что-то ещё мы тести я не помню что Честно скажу Мария ДБ там по-моему фан какой-то есть ещё там нене не Вот то есть на самом деле вот тот мускул который нам продаёт компания Oracle Ну типа продаёт Да вот особенно который 57 Особенно с рекомендованными настроечный быстрый они-то его тестят как следует Вот и только под очень специальную задачу может оказаться Что какой-то другой движок или какой-то какие-то другие настройки лучше так-то Вот вот всё так по опыту Спасибо Здравствуйте Можно да компания Smart ртб Меня заинтересовал вопрос А почему вы по IP GE не вычисляет Это намного быстрее Это хороший вопрос потому что этот IP Ничего не означает К сожалению потому что но это уже из опыта анализа логов Нам видно что например МТС то есть в координатах у него Нижний Новгород А пришёл он к нам с айпишник Московского и это какая-то постоянная история то есть на Мы думали над тем чтобы подключить там где у нас ни один метод не СБО там Подключить IP но но пока не подключили понятно что Макс майнская база и понеслась спасибо всё спасибо А ещё один вопрос А ещё один Да извините Спасибо за доклад Э вы говорили что используете н для отчёта тайм-аутов А можете сказать сколько Ну как часто вы не успеваете подготовить ответ и пролете помаду тем что у нас есть э ограничение на время в самом нашем кэндес промахивается Но вот в моменты когда нагрузка на процессор переваливает за 80% мы промахивается чаще это всё равно доли процента Вот Но тем не менее там вот это Начинает появляться А вот как-то так всё спасибо закончи"
}