{
  "video_id": "jcCLqVQs5No",
  "channel": "HighLoadChannel",
  "title": "Как устроить хайлоад на ровном месте  / Олег Бартунов, Федор Сигаев",
  "views": 42099,
  "duration": 3353,
  "published": "2018-11-19T02:59:55-08:00",
  "text": "здравствуйте здравствуйте очень рады видеть большой зал почти полный я олег бордунов мой друг и коллега всё то сигаев мы на двоих больше сорока лет занимаемся по адресам являются ведущими разработчиками пол риса недавно мы вместе с моими друзьями тоже образовали компании pabrec professional а еще мы работаем московском университете я вот интерьер профессиональный астроном а фёдор профессиональный я тя программист 1 5 км и элера категории до так что сегодня мы будем рассказывать о том как устроить холода ровном месте и сначала я хотел бы с вами поговорить кто знает что такое highload дело что перед конференцией и во время конференции я ходила спрашивал людей вот здесь камни молодых ребят говорю потому что стариком не спрашивал они наверняка знают да они уже все волосы выдрали а вот молодежь я говорю только highload люди говорят это когда много запросов в секунду или говорят когда много посетителей к там ходят но реально народ не понимает что какой лот и проблем это вот тема доклада была выбрана мною потому что меня как раз один эйчар со слезами на глазах спрашивал меня тут ищут highload инженеров я дать не знаешь как у holod она стала рыться в конференциях и нигде не нашла определение хай-лоу да то что и чар от это очень сильно страдают вот я практически вот больше 10 человек спросил и никто не ответил ну как бы уверена что есть проверяя holod вот сначала мы как раз и начнем с того что мы объясним что мы понимаем под холодам это вот списке проектов кто не знает наши списке проектов подписи что мы сделали с федей их тут многие наверное знают наши индексы наши джейсон нашей штор или полнотекстовый поиск это все что мы делали если у вас есть вопросы по эти проектом вы можете нас поймать поймать и прямо попытать живую что он мне нравится и так что же такое highload я наверно знает вот заметьте слайд что bigdata это как секс для подростков их о котором все говорят но никто толком не знает нас вот я его слегка модифицировала и записал что-то highload вот так вот такой шутливый слайд на самом деле в интернете существует масса таких вариантов ответов например что highload начинается сотен запроса секунду при чем это едят не статический контент а именно динамически или говорят что это про масштабирование горизонтальная или когда традиционных подходов или стандартных решений не хватает вот кто то сказал что вот как раз высокую нагрузку как нагрузка с которых железо не справляется ковать причине этот показать небольшой спектр тех ответов которые я услышал прямо от вас здесь на самом деле конечно же вы знаете тот компьютер да мыслитель которого всем с половиной миллион лет считал а главный вопрос жизни вот он через символы на миллион лет он ответил 42 вот эту цифру все знаете до 42 это говорит о том что на самом деле на вопросы может быть не существует правильного но мы решили все таки как бы говорить о хайло де как тем более что вы пришли на конференцию которая вот производительный масштабируемые систему высокой доступности и здесь как раз слове высоконагруженные кстати вот изначальная версия бунина это было слово высоко нагрузочные новым столько нагрузочные звучало правильно но немного по-крестьянски и для того чтобы вы все чувствовали себя и летай высоко нагруженной застали высоко нагружены вы знаете есть такое слово высокая мода высокие технологии а вот вы теперь все принадлежите вот этому клубу высоконагруженных людей инженеров это на самом деле нормально потому что это всё это именно то что объединяет нас всех вместе мы здесь вчера бунина на вручении вот это avarda очень хорошо и проникновенно сказала то что действительно мы здесь все собрались и мы все делаем вот это будущее которое кто-то там спорить о цифровой экономике они могут что угодно говорить да но делаем то мы сами здесь внизу и вот это действительно мы принадлежим некоторые избранной кости вот и хочу сказать что производитель сам масштабируемость обычно уже задана то когда вы начинаете проект большой вам уже говорят меньше одной секунды клиент должен получить ответ ну скажем обычный вербовский сайт это примерно до секунды до скажем фен тех это отбили секунды то есть эти параметры эти две стороны уже фиксированные остается вещь такая непонятно это вот система высокой доступности и вот как раз провести высокую доступность мы и будем говорить вот но еще я хочу сказать что хайло то это чисто русское слово если вы посмотрите на распределение вот двух слов highload и хай вольем хайло татха синий а вы видите да что это гугловский google тренд говорит о том что так мардон извините я занят то есть но самое удивительное то что бунин взял два английских слова это слова разных слов и лот объединил их вместе и сделал их чисто русским словом вы видите по использование тельцу то есть удивительно что вот вся россия вы видите германия тоже использует хай лот и самая удивительная пакистан вот то есть я понимаю что наши люди в германии их много и они там работают они конечно делают запросы и так далее да по холоду это все понятно not например хай голым увидите что это остальной мир это вот канада штаты америка и австралия они используют такое поэтому когда в буржуев скажете про highload веб-сайт он ничего не поймет это чисто наше российское изобретение вот еще одно определение holod еще апреля большое количество сложных запросов греешься железки а также условно говоря то есть жилищный взгляд на highload это когда у вас железки нагретые хорошо работают на груди вот именно как за которой не отвечает или фактическая работа которая делает это никого не интересует до или вот перегруз система выше рассчитанного вот мы говорим так что highload это та ситуация в системе как грозящей отказано в обслуживании из-за недостатка ресурсов то есть в этом определении нет никаких цифр то есть никаких абсолютных цифрах вот она отражает именно то что приходит вам страшном сне ночью вот тех кто пережили вот сидение перед консолей перед консолью и наблюдаете как ресурсы на глазах тают и все начинает тормозить вот те люди поймут что вот это на самом деле основное что вообще не должно волновать потому что производительность масштабируемость обычно все закладывается закладываются текстуру а вот ресурсы это самое главное что не дай бог эти ресурсы исчерпались ваши и слушать перестанет быть доступным и весь проект собственно пойдет к праху и мы будем говорить именно с точки зрения вот этого определения на самом деле конечно нештатная ситуация то есть в идеальной картине мира вы должны заранее знать все параметры вашего проекта то есть бизнес должен вам сказать сколько ожидается вообще пользователей на из кое-какое время распределение запросов географию так далее все должно сделать реально конечно то не бывает прибегает бизнеса и кай начинает что-то кричать вам когда уже все работает вот есть ошибки архитектуры то есть ну конечно любой может ошибиться то есть что-то не предусмотреть ошибки имплементации и очень много конечно ошибка сопровождения и все это ведет к тому что из идеальной ситуации когда сервера мирно журчат пользователи ходят вы сидите смотрите на графики красивые и отдыхаете на сам не все приводит тому что нас тупая ситуация когда ресурсы начинает истощаться и этот недостаток ресурса он начинает приводить как раз к угрозе в обслуживании вы получаете вот такой ситуации видите вот перегрузили иначе после к и обслуживание никакого нет это конечно очень хорошая картинка я долго искал я источник но так и не нашел но она очень показательная конечно начинает спешно вставлять костыли сам я скажу что кастилия костыля наш отношусь нормально то есть документированные костыли они в любом проекте есть то есть вы когда знаете что этот костыль выставили для лечения вот эта конкретная вещь и до что ближайшее будущее вы его обязательно исправить и есть конечно костыли те которые уже там не знаю так нас настолько в мерзли в проект что они уже являются фичи системы но это как говорится вещь такая необходимая вот это еще одна смешная картинка система с костылями больше всего мне нравится вот это потому что она реально работает вот велосипед но выглядит немного архитектурно криво и неудобно но кататься можно кататься можно вот вот в фейсбуке я выстрел от кой она мне очень нравилась картинкой а я на фейсбуке даже устроил некий такой голосование о том что покажи скажите как назвать от картинку там много разных было предложение вот на самом деле эта картинка означает что несмотря на то что вы занимаетесь высокими технологиями высоконагруженных систем и сессия умные хорошие толковые вот придет для девайсе выключить свет и весь ваш проект уйдет туда поэтому это просто для того чтобы нас вернуть жизни что всегда нужно помнить еще эту а дядя вася так о чем мы не будем говорить дальше мы не будем говорить про большую производительность про большие данные большие проекты про рецепты правок у ильи да илья у него за алексея перед перед нами он все очень хорошо рассказывал этого очень много на холоде мы будем говорить про действие которые приводят хайло ладу на ровном месте и не иногда мы будем говорить про известные ошибки но они эти ошибки настолько важное что одних стоит рассказать еще раз а так как мы из мира баз данных то мы будем говорить в основном конечно про подвес вот я знаю что пользуюсь очень популярны и популярные база данных и это действительно так и надеюсь что вот это как раз не будет сильно вас огорчать то есть вот приходим к ошибка проектирования неэффективное использование ресурсов блокируя неспящий процессом кто знает что это такое вот эту ситуацию встречал да вот есть люди которые встречали то есть например люди делают рассылку в транзакции очень удобно да у вас имеется список и имейлах адресов вы открываете транзакцию и начинаете с память весь интернет все как бы хорошо консистентная красиво архитектурно но это приведет к тому что у вас будут будут идти блокировки то есть ресурсы будут ждать пока в этом законе crysis smtp-сервера там отдадите и так далее все это будет тормозить dns прорисовываете дорисовывать dns так далее или например отдачи контент и процессов непосредственно клиенту вот все вы сейчас очень умные и прекрасно знаете что существует несколько слоев существуют backend фронтэнда это там специальная сервера которая оптимизирована в выдачу статике или там или динамического контента до сих пор есть люди которые занимаются этим самым то есть берем большой backend отдают и отдают им контент клиенту то есть сейчас когда у нас средний pink это миллисекунды наверно все знаете за среди pink москве это 10 миллисекунд то есть мы все сидим на купонах на еще каких-то да это как бы не очень сильно чувствуется вот во времена когда мы с федором делали rambler я написал специальную програмку чтобы изучить какой pink средний по россии вот мало того что я завалил сетку внутри потому что эта программка было много 3 давая она пингала ведь всю россию вот так вот выяснилось что средняя было две три мили сик две-три секунды вот что это вам говорит вот вы специалисты хайло ники средний pink 2 3 2 3 секунды извините я очень занят вот это говорит о том что если вы будете отдавать клиенту такому медлен клиенту скажем вашим брендом и лего скажем а почем вы будете держать эти ресурсы эти все секунды понимаете да то есть это большая ошибка которая приводит именно к тому что у вас вдруг ресурсы заблокировались backend ничего не делает просто медленно отдает байтик по батику поэтому модем база наружу но надеюсь все здесь понимает что базу никто не отдают на наружу не когда то есть имеется свечи имеется внутренняя сетка там несколько интерфейсов не дай бог чтобы внешний интернетовский трафик мало того что это не secu на но и потому что весь трафик насчет гулять по вашей как говорится внутренней сетки такое как бы многим очевидно но некоторые это допускают разные сервисы на одной машине это тоже означает что когда вы берете на одну машину складываете скажем веб-сервер базу данных что-нибудь еще этом backend и все это начинает драться за ресурсы то есть по бедности такая же хорошо но если вы ходите в продакшен конечно этого лучше не допускай и такие простые такие вещи остановка мастера при исчезновении единственно синхронной рубрики вот это такая загадка когда мне ведь это сказал я сказал ну но исчезла эта реплика и что так он ест на самом деле как только тонкость в том что вы поставили мастер поставили синхронные реплику мастер обещает что он не скажет клиента что он все законе тел пока синхронные реплика не ответила если синхронный реплика выключилась начал у нас мастер есть нам реплик можно выключить что мастер делает он ждет пока реплика поднимется вы на ровном месте поставили раком всю систему поэтому собственную советы тут разные могут быть от вообще не используйте реплики смешно и конечно но правильный наверное это одна синхронный 1 асинхронные реплика с тем чтобы можно было это первые синхронность перекидывать чтобы у вас был какой терьеров просто одна синхронные реплика понижает вашу надежность повышает видео мы же хотели не давать советы ну ладно и так неправильно недостаточно тестирование вот здесь можно конечно целые доклады делать я сам очень много занимался вот тестированием да и могу сказать что сколько было пролито слез когда вы вытаскиваете значит ваш в продакшен и начинаете видеть совсем другую картину вы знаете что скажем если вы тестируете у базу данных чем вы тестируете в 1 чего люди начинают конечно берут по г блинчики начинают его гонять потом говорят вот у нас у 1000 транзакций в секунду все летают все отлично вот недавно мы тоже с этим сталкивались сами лично когда мы тестировали джейсон вот джейсон летал все отлично мы я конференция говорил что мы лучше чем он gdb вот и все было действительно хорошо действительно лучше как бы вот до тех пор пока мы не догадались что по габенчик по умолчанию дает равномерное распределение запросов ну то есть вы тестируете как бы никакой конкуренции нет никакого контента на нет и все прекрасно хорошо после тут конечно летает вот после этого я сказал что так мы специально сделали ключ новый в по г бенчи если вы сейчас запустить и погибель сейчас появился новый ключ который надо использовать для тестирования он генерит вам запросы по распределению zippo кто знает что это распадение зифа вот до 80 процентов пиво выпивает 20 процентов людей собственно это она да то есть это именно та распределение запроса которые мы имеем на самом деле в реальности то есть люди не читают блок васи пупкина а читаю там на хабре какую статью горячую из mail.ru то есть распределением и на вот такое и когда вы начинаете тестировать вашу базу данных или вашу всю систему вот такими запросами вы начинаете открывать массу нового вы начинаете видеть что погрыз начинают тупить начинает тормозить ваша система тоже становится в кировке сплошные и здесь надо уже что-то думать вот это тестирование они поставили перед нами такие действительно серьезные вопросы масштабирование пол vista на который мы до сих пор думаем до сих пор то есть да и правильное сочтите рование некоторые говорят что мы возьмем у нас база будет строить прапрадед терабайт а мы здесь возьмем потестирую на кусочки этой базы скажем на 2 там на 10 гигабайтах и скажем коннектор там стока подкинем все хорошо все работает вы уходите в продакшн и вы при приплывает и потому что вам не хватает коннектов то есть макс connection вы начинаете менять пузырь как известно больше чем 100 не очень-то любит вот поэтому вам нужно заранее думаете про это то есть тестирование вам это не покажет недостаточно и тестирование она действительно может сильно отразиться на доступности вашего сервера пиковой нагрузки это вообще вы должны просто сейчас с изобретением а облака это конечно стало легче то есть вы всегда можете сказать что как только будет пик мы сейчас возьмем быстро поднимем еще несколько серверов да и они там будут к говорится о отрабатывать этот пиковую нагрузку но это надо предусмотреть всегда вот особенно если вы не в облаке потому что пиковые нагрузки они возникают скажем по времени вот видите по событиям например олимпиада или вот мы пережили мы от с федей одни из тех кто пережили 1 рунет овский highload 1 рунический холо знать кто какой был когда рунет стал уже более-менее весомой уже много стало ресурса много пользователей вот железка была ещё маленькая железку еще были маленькие и вот произошло событие это печальное событие это было затонула подвода лодка курск это 12 августа по моему 2000 года нет это да августе 2002 года згорела телебашня это через две недели лана sang искатели борис род всегда описываю как столкновение подводной лодки курск телебашни вот и это привело это привело к такому хайло воду который рунет еще не испытывал здесь народ молодой но есть старики которую помнят когда сайты лежали лежали сайте никто не мог ничего найти значит самые крутые они переходили на текстовые трансляции вот мы в рамблере конечно со своим пазле сам выдержали этот весь highload то есть мы это пережили наши седые волосы вот это все пережили как поиска это руками держали это эти нагрузки вот это надо было конечно нам помогло что мы изначально думали про это мы не думали о конечно про курс но изначально мы понимали что надо как-то делать архитектурно чтобы могли я как тот масштабироваться аппетит случается на пике случается да ну и вот есть такая штука как это им зоны вот знаете если вы делаете проект который рассчитан на какой-то там страну вы всегда понимаете что с людей страны у которых всего 1 time zone а индия представьте что вы делаете проект и в котором люди утром приходят что работал и еще нет отмечаются вот вся страна и все эти миллиарда до начинает вдруг в один момент в россии как известно много timezone у нас эта нагрузка немного размазана вот но вот такие проекты надо рассчитывать индия там китай зато у нас ночного времени нет да у нас ночного время нет россия вообще уникальная страна мы можем сделать поддержку всего мира у нас так многому time zone что мы можем распределить сделать такую компания который будет поддерживать вообще весь мир разумный отлуп роботов кто-нибудь анализировал свои ноги да вот веб-серверу вы видели там десятки тысяч а может быть и сотни тысяч просто боты роботы и так далее не живые люди так вот они конечно нужны иначе вас никто не найдет не проиндексирует так далее но нужно им конечно вы до выдать как его давать какие-то с какую-то статику и скармливать их такими заголовками не дай бог этому роботу разрешить ходить по вашей динамическим ссылкам тогда вы получите хайло совершенно просто но загрузку систему на ровном месте абсолютно то есть различие мне людьми робот беседует с роботами да так так приходим к ошибки проектирования б.д. вот есть видео расскажет такую штуку пропади нацию кто зайчику pagination да все знают это такая распространенная штука но я не уверен что все знают то что на n плюс одну страницу переходит только три процента тех кто побывал на иной странице то есть очень быстро спадает и до конца доходит обычно очень мало народу и чаще всего это и те самые упомянутые роботы то есть в конец длинного списка люди не приходят именно поэтому кстати у гугла там дальше 1000 результата вы никогда не про не про кликай точнее до 1000 можете про кликать но дальше не пойдете google просто не покажет поэтому собственно примерно приемы разные могут быть нотным говоря базе данных не самый эффективный штук это а вся лимитов сет может быть имеет смысл какие-то вещи делают там первую страницу показывать так а если уж пользователь пошел на вторую такаши веруйте там сразу тысячу и из этого крыша уже показываете ну тем более что консистентной вот этих вот данных если у вас сильно динамическая она будет весьма небольшая при переходе со страницы на страницу вообще любая база данных по крайней мере я не колонн лично я там то что называется дроу orient от постоя построчно у нее всегда есть заголовок кортеж заголовок тупо заголовок строке называйте как хотите в разных баз данных он разной величины у под кресло не повезло со связи с организацией и воем vcc у него меньше 23 байт не бывает поэтому если вы держите там два булата конечно у вас они это собственно занимают два байта но собственно заголовок еще из выравнивания будет занимать 32 байта запись то есть архив большие узкие колонки вообще не очень хорошо не у не узкие колонки узки таблицы широкие таблицы как ни странно тоже плохо почти во всех базах данных алгоритмы которые работают там с колонками они квадратичные по отношению количества этих колонок поэтому там практически предел 50100 вот где рассказал немного теория вам скажу как реальный пример то есть ребята хранят петабайты данных но при тобой сейчас нам уже больше хранили geo geo данные то есть грубо рек координатой а идеи и координаты такая узенькая колоночка скажем табличках занимала там одна табличка занималась коров 60 терабайт после того когда они сделали объединили скажем там 200 точек 200 точек вот таких обвинили в один джейсон табличка стала занимать 10 терабайт вы просто получили сжатие таблицы на ровном месте и облегчили себе жизнь при том что джейсон погрызть и вполне себе нормальные вы можете с ним и хорошо работать и плюс когда у вас данные перестали быть разбросанным по диску они все сгруппировались но в одной строке то есть близкие точки они рядом и лежат вот так сказать один из таких примеров вот широкие таблицы примеры вот я страну например и мы заливаем астрономические каталоги которые там терабайт не каталоге в базу данных погряз в топе когда вы смотрите дебаггер уйти на процесс вы мы видим только одну функцию это как раз то что федя сказал это без бегании по колоночка то есть очень широкая у нас порядка двухсот двухсот трехсот колонок каталоге и там действительно очень тяжело подрисуем становится вот вопрос помолвку или когда не надо это уже такая избитая тема я уже довольно много раз выступал что вам мозга и не нужен вот ну конечно это обобщение то есть естественно есть проекты где на узкую или вообще летает вот но реально конечно связи с тем что люди но есть такой hyip молодежь вообще любит hyip а холодная молодежь она вообще как говорится хочет прикоснуться к чему-то такому манга вот здесь люди салонга сидят манга круто и это здорово надо его обязательно попробовать но конечно пробовать всегда надо у себя на ноутбуке но в породе это часто оборачиваются большими-большими проблемы например что делают люди лично видел несколько раз то есть люди берут закачивают все приложения данные потом с ними что-то делают и потом показывает вроде бы как бы все нормально ему очень приятно джейсоне java скрипта мы все хорошо сделать не на киску или не нужно все хорошо когда в табличке скажем 140 тысяч строк это все летает работает а теперь представьте что у вас таблички миллион строк и вы начинаете тащить весь это ведь весят трафик к себе на сервер а потом у себя еще бедному клиенту который запустил свой браузер у него распухает память нужна си он начинает там все начинает делаться например join и то есть казалось бы join операция совершенно тривиальная да то есть вы взяли просто-напросто отсортировали два массива например даже или пожалуйста но когда это превращается в то что у вас очень много данных и когда вам нужно вы начать понимать что алгоритма join a существуют как минимум три как минимум три это хэш джоин мер jo in st клуб то вы начинаете то все изобретать у себя внутри своего приложения все эти алгоритмы вот это как бы тоже еще ничего но когда вы начинаете joy нет ни две таблицы а3 таблица например то есть данные из трех таблиц вы начинаете понимать что вы пишете пол и рис при том что конечно проще написать на иску или запрос чтобы позлить выдал вам ответ видит о нескольких строчек и все то есть вот такие случаи сша не надо носку часто говорили что реляционные базы данных они очень ригидные жесткие с ними их нельзя быстро менять и так далее но сейчас это не так пузырь сказочная уже то база от которой джейсон является говорится типом данных первого класса то есть нормальный тип класса который транзакционные которого из индексы куча функций так далее то есть грех им не пользоваться поэтому я говорю что долгу или конечно это нужно пользоваться очень умеренно не тянуть туда все джейсон тоже не надо использовать я видел такие таблички например хорошо когда хотя бы есть а иди и джейсон а тоже весь таблички просто g1 джейсон вот все внутри и люди за каждым чихом бегать в этот джейсон это джейсон может быть очень большой вот совсем недавно мы столкнулись с проектом когда джейсон и и были содержали в себе раз травы растер pdf-документов то есть размеров 300 мегабайт и все это запихивали на чистоту в пол рис так далее то есть ну как бы это конечно можно погреть стерпит но это не нужно потому что во первых джейсон в адресе эффективно работает пока он не очень длинный то есть до 2 кило байден есть нормальный обычный джейсон если вы начинает там храм какие то документы которые вот и такие большие данные они начинают уходить в тост мудреца вот есть такая такое сторож тост который сразу резко замедляется работы поэтому надо это все понимать не нужно и точность вычисления я думаю здесь уже все тут все говорят что все знают что если у вас миллиард данных таблички никому не нужно знать этот миллиард с точностью абсолютной точностью людям обычно достаточно иметь некую оценку вот часто бывает так что чуть-чуть маленькая релаксация вот этой точности а не позволяет масштабировать вас по вашему сервису виртуализации докер вот я горжусь понятно выразился я вообще конечно очень виртуализацию когда мне клиенты присылает виртуалку который демонстрирует проблемами не нужно переписать postgres заливать там потом переспрашивать какие у вас на стройке а прислал virtual очку я ее взял запустил у меня все получилось при отладке тоже неплохо там пробовать разные системы а вот в продакшене я скорее против против почему потому что слишком часто натыкался на две вещи то что само по себе виртуализация начинает отжирать ресурсы я видел пример там падение на 2 роста сделаем одну виртуалку на физическое больше ничего нету сравниться и той же физической машины падение производительности в два раза я видел вещи я не знаю кто не знает насколько пузырь зависит от i've seen к ну вот не так много но я скажу он очень зависит то есть если у вас в sing не проходит по каким то причинам то считайте что вы включение режим do to lose равно он так вот когда вы запускаете пузырь в виртуалке у вас есть дополнительный лаэрта есть вызов их sing должен пройти через ядро гости в гостевой системы через ее файловую систему довести до ядра кастовой системы подрасти до ее файловой системы пройти до рейда и так далее все это проконтролирует на самом деле идеального способа не знаю честно время вот эти вот вещи стуку из виртуализации здесь скорее не помогает в этой проблеме мы не сталкивались что у клиентов просто миграции поздравь на живую приводит к тому что он говорит что у меня файл и биты и биты и смотришь на действительно его длина файлами не кратно 8 кило об этом чуть позже сам сделать не может в принципе ну и докера я снимала сталкивался но имеете ввиду докера все-таки основное назначение это запуск процессов которые не имеют собственного состояния база данных имеет собственно отсюда в себе нам проблемы неприятности дальше мы переходим такой очень важной теме грызла degradation по-русски как бы мы не смогли найти их аналогов хорошего вот главное укладывание не знаю плавно и укладывание да то есть вот вот важные самые важные такие вот моменты грыз вот игра дэш на что-то означает что многие делают ошибку какую вы подошли к моменту когда у вас начинает истощаться ресурсы просто сидите видите как все начинает сеть забивается память уменьшается до свободное циpкa у вас все и так далее люди начинают толпиться что делать дальше люди начинают искать но придумывать всякие вставляют костылев стараются удержать и всех клиентов обслужить все запросы да потому что это как бы ему ну ладно да так иначе и дальше происходит вот эта положительная обратная связь по нагрузке иди объясни пожалуйста кто-нибудь усилители паял ну хотя бы читала как делать вот это вот она сама чем больше у вас нагрузка тем медленнее и медленнее на отвечать на система отвечает на запросы тем больше запросов переходит на машину и все это становится до разгоняется единственные способы попытаться избежать ну по крайней мере из рабочих способов не из работе как оно гарантированно работают это пытаться смотреть что если у вас там скажем условно говоря к базе есть за право все свободные слоты запросов заняты то лучше новый не пихать а сразу клиенту отвечать что не шмогла чем пытаться ставить в эту очередь который будет расти в разгонять вот эту вот нагрузку то есть вы тут ваш выбор на самом деле обычно небольшой вы либо никому ничего не отвечаете и все считают что сервис лег либо отвечаете части пользователь там вопрос какой этой части но тем не менее кому-то отвечаете что лучше ну в общем мы мало кто скажет я вообще считаю что лучше хотя бы части ответить но тот кто не думает об этой в об этом он скорее всего попадается ситуацию что никому ничего не отвечает и самое главное то что выйти потом в рабочий режим очень тяжело потому что вы начинаете раз трактовать сервера не начинает пригревать свои крыши пользователи не смогли зайти они начинают тыркать зайти зайти снова и снова и выйти из этого режима обычно очень и очень непросто то есть вот здесь поисковой системы лучше всего ищут в ночь с субботы воскресенья это вы знаете ты тут как раз именно именно поэтому то есть скрыла нее в обычное время не сильно довольно загружены то уехали все эти алгоритмы написано так что они выдают абы как чё то чтобы отдать нас обслужить а вот в субботу-воскресенье вы получите наиболее качественный ответ наиболее четко с гуглом прямо просто проверено это все сделано но собственно это другой подход ни другая третий подход грейс вот игра дайсон и взгляд с обратной стороны то есть как вы двигаете движок качество сервиса сообразуясь со своей нагрузкой до например вы просто это элементарно вы можете когда например у вас большая загрузка и вы готовы лечь вы просто говорите добавляете в поисковый запрос какой-нибудь дополнительный в например то есть вы просто говорите что искать не по всем данным apa например буду гневной данности все вы сразу производитель начнете выигрывать да люди всех счастлив получают ответы но может быть не совсем как бы точно не совсем так далее и так далее то есть это вот один из приемов которые надо использовать а вот про положительно обратную связь это вот вы действительно когда я сижу на пример очень нужными сервисе я сижу жду он тупит люди все начинают начинают ржать еще раз на клавиши там наряжают рилот это вот и есть вот это обратная по лучший выход если пользователь со злости разбил монитором точно тогда новых запросов низ генерит так вот мы переходим по адресу на ожидая вот здесь как говорится есть нелепости дурацкие ошибки самая первая которая дала собственно название это вот забытой клавиатуру на стойке это вот реальный пример цска когда стоят две одинаковые слойки наполненные кучами серверов и вот вдруг сервера вдруг система начинает тормозить из-за того что сервера в одной стойке начинают тормозить по сравнению риме в другой стойке все одинаковые стойки одинаковые сервер одинаков все одинаково всем и начнется через управлял к устью хорошо вот белиз белиз белиз потом вдруг обнаружили что наверху админ положил клавиатуру кто-нибудь здесь понимает что происходит когда клавиатуру положили да вы понимаете да то есть перекрыли чуть чуть чуть чуть отводу тепла это все пошла положительно обратная связь нас вместе то есть стало всё греться если раньше бы просто просто сгорел бы ты сейчас про це умные они начинают понижать свою частоту так что вы когда смотрите на нагрузку вы смотрите еще какая частота у вашего процессора вот отсюда вот это реальность случаи жизни поэтому на есть ну вот еще что приходится контролировать если вы скомпилировались оркам конечно продукты разуме бывает ну это просто из нашего опыта клиент жалуется уж у него на одном сервере нет ли не настройки те же самые все все то же самое на один сервер и два раза медленнее я лично с этим разбирался но афин черт меня дернул посмотреть вот опционам была скомпилирована so sure to measure ты на самом деле ну по крайней мере по зарисовываем могут значительно влиять на производительность два раза просто на ровном месте уж не знаю откуда это вылезло кто-то что-то экспериментировал со сборкой настройки вы меняли настройки спасите их иначе при рестарте вы можете получить нечто совсем странно когда я работал в mail.ru нам пришел новый админ и обнаружил сервер который не растрата волс три года я боюсь и возраст радовать я не знаю что там в результате стартанет но после некоторые события все-таки перри пустили ну в общем это было кладбище разных зомби действительно вот была такая ошибка вот здесь вот неожиданно есть тонкий момент все знают что по-крайней мере в линуксе syslog может достаточно затратим мало кто знает в каком месте он затратил пришел клиент верят меня пузырь с припаянными запросами работает медленнее и заметно почему потому что на prepared запросы выдает вдается два сообщения в лог они одно и на налажено было собственно логирование через syslog и этого хватило что пользователь затормозил почему потому что переключение контекстов чтобы послать и syslog нужно использовать из возгорится послать в ведро раз приключение по контекста это попадет в число 2 переключение контекста анод напишет ядро 3 приключения контекста и этого хватило чтобы машину в основном занималась переключениями контекста это это мы не можем говорить о твоими клиент но каждый из вас его точно знает пользовался это реальная жизнь случаи жизни просто мы сидели экспериментировали с исключением prepared вопросы вроде должна всю летать сайт ложится выключаем сайт работает и вот такая хитрая вещь вот это на понимать следующее но она в общем то ожидаемая вещь это френки все любят там чтобы база следил за своей консистенции консистенцию но имейте ввиду что бесплатной не бывает поэтому френки они могут кушать ваша производительность на вставку но с этим надо как-то жить но один из способов вот у нас все заканчиваются ресурсы и вы уверены в своем приложении отключите а френки потом период низкой нагрузке включите их обратный что не теперь делается точно также триггера с тренерами тоже нужно относиться осторожно они могут неожиданно выстрелить в ногу особенно если вы из триггеров ли эти письма но отправила к которому я следую с curing геями это вот когда вы разрабатываете базу обязательно надо делать эти фу рынке и потому что буллинг и позволяет рисовать вам красивую эти схемы но они помогают с ошибками отлавливать да они вообще полезно а потом них есть умные продаж или вы начинаете потихоньку от включать эти френки и потому что действительно про ваше приложение должно может это все фиксировать и вы отключаете у вас большой запас порно заводите есть клиент столкнулся с ошибочно написанного в ведре курсов он просто выполнялся бесконечно вносит и вот когда пишете рекурсивные запросы в старайтесь все-таки их ограничивать как то хотя бы там statement on time out особенно обидно когда это случается на продакшене обычные исследовать не так просто что случилось если вы думаете что написать бесконечной рекурсии очень тяжело это очень легко вот простая задачка то есть у вас имеется папа у него да то есть когда вы решаете задачку показать всех своих родственников вы можете легко заткнуться на рекурсии вносит бесконечно красилась если например в данных в данные вкралась ошибка то есть вы пишете идеальный код он должен работать до но данное живы не гарантируете что кто-то не даст не сделает грамм у не границу если это нужно обязательно проверять тоже очень легко наступить на 2 курсе давай зависшие транзакции их вообще база не любит puzzles не любит особенно потому что останавливается вакуум ну вот про вакуум я уже говорил то велю спросите фрезы вообще of the vacuum ну имею ввиду то что если вы откладываете и откладываете в триз вы можете пользоваться довести до состоянии что он хочет бы ему нужно провести фриз потому что номера транзакции исчерпались но он не может это сделать потому что чтобы сделать штатными решим вакуумов рис нужно получить этот номер транзакции все вы попали базы данных надо останавливать в сингл моде гонять может снизить за этим надо медан не умер ни использования временных таблиц неймара что их вообще не надо использовать используйте на здоровье более там они зачастую полезны в них можно складывать нам результаты под запросов но имейте ввиду что темная сторона тоже есть поскольку после сохраняет это все в системном каталоге то вы получаете bloat каталога я лично видел примеры когда вакуум тратил 60 процентов времени на системный каталог они пользовательские таблицы не нужные и бесполезные индексы но все знают что не нужный индекс он просто лежит мешает вставки но когда нас на к нам саудитам переходят мы находим индекса который например никто никогда не искал на протяжении месяца поля вещь полезное и нужное для производства тепла неожиданные вещи кто знает своих youtube и джаз ну вот знание потихоньку проникает чуть позже собственно страницы в современных процессов in the love вообще говоря 4 килобайта и когда у вас процесс современной машины большие в них много гигабайт и соответственно нужно очень большую карту держать где чего иной это называется если правильно помню tlb кэш tlb при подключении процесса фоткаешь тебе сбрасывается и собственно говоря процессор начинает тра не может тратить время много на вот это вот и надолбы приключение туда-сюда youtube или джес против против этого помогает размер страница 102 мегабайта на три порядка уменьшается размер этих к шее тоже недавнего времени мы вообще говорили что не надо делать очень большую память то есть уже были машины 96 гигабайт памяти до люди говорили о давайте все выделим всю эту память поджаренной буфера выделяли и оказалось что пользуясь начинал работать медленнее вот сейчас подвести уже есть поддержка how they just a вы их вам нужно строить kerbal правильно потестировать и тогда уже можете вовсю использовать минутами с шифрованием то есть на мой взгляд там у вас должны быть весьма специфическое приложение которому нужно шифровать connect ip адрес помните то что шифрует вот этот ссср а тот же самый backend который выполнял полезный работ когда он шифр от анализа на работу не выполняет поэтому вы за свои деньги обогревается вселенную вот тем что мы сражались летом потом с одним клиентом пришел на этой неделе другой клиент они втыкают кучу своих поинтов но чтобы на них откатываться много очень перехватов exception of philip и газку или они внезапно втыкаются как диагностировать это увидите что у вас много транзакция визин висит вот в этом блоке sap транс контролок вкратце это лог это лог небольшого кэша в котором хранятся статуса транзакций если вы размеры этого каша не хватает для по транзакций то все начинает тормозить потому что на самом деле все это хранится на диске она начинает читать сбрасывать читать сбрасывать и она втыкается при этом диагностика выглядит забавно у вас много процессоров много ядер они ничем не заняты диск не очень нагружен а пузырь с работает медленно вот 1 способ диагностики заглянуть вот он туда нелепости еще это планируемый d-блок если вы написали приложение так что у вас вы ожидаете много белок обычно рекомендация здесь какая что вы если чего-то там направить ее в одной транзакции несколько таблиц правьте ха блин ну как бы не спускайте апдейты insert и delete в одном и том же порядке просто чтобы избежать блоков если вы запускаете в разном порядке вы можете наткнуться множество одна транзакция поменяла одну таблицу 2 2 теперь вторая хочет первую а первые хочет на роль таблицу менять о подлог кого-то откатит еще одно внезапно если у вас сложное приложение которые адресует запрос вы там на декор жалует генетически один оптимизатор жалуетесь что у вас неустойчивый запрос вы его отключили у вас некоторые работает потом в не бронированными приложений все с толковым имеете ввиду оптимизация это факториал от к сложность оптимизации фраг и фактически факториала числа таблиц и индексов генетически optimizer избавляет от этой зависимости и поэтому не знаю не стоит его отключать следующий помните возрасте есть тайм-аута именно до пользоваться чтобы не зависали сходу там накидал список таймаутов то есть от бесконечных зари курсов помогает стоит на тайм-аут от высокой нагрузке на локе помогает лог тайм-аут если у вас приложение ошибкой она держит транзакцию поставьте ой блин transaction тайм-аут чтобы puzzles не висел d-блок тайм-аут это немножко не из этой серии просто имейте ввиду то что если вас планировано запланированы большое количество воды блоков вы будете стукнуться об этот тайм аут потому что пузырь из устроен так если бог не берется вот этот вот промежуток времени запускается процесс который пытается выяснить нет ли ты блоков и собственно и в ваших транзакций занимает миллисекунды на прикол андрей большом количестве идет лохов она у вас будет заниматься секунду секунды до полтава и время здесь пикапы life иногда бывает так что можно убить приложение так чтоб можно пузырь с об этом не знает и не будет знать пока не сработает keep-alive дефолта вайпа на два часа ну нафига вам одни если не дай бог он висел в транзакции вам станет совсем нехорошо камня под которые редко заглядывают действительно они случаются редко но бывают пузырь стемнеет ограничение максимальное количество открытых файлов на каждый процесс он в районе 1000 если у вас сильно больше таблиц и индексов и запросы разнообразные позже будет заниматься тем что он будет призы перри открывать эти файлы нить виду что если у вас действительно много файлов в одной директории даже даст наш замечательный linux в этом случае тормозит у вас тепло будет уходить на работу в системе открывания-закрывания файл дескрипторов выбирайте тоже редко заглядывают но курсов ногу я сейчас не буду туда угла углубляться но действительно по опыту заглядывают туда вере редко эффект тифа и о конкуренции эффекты в кэш says тоже редко заглядывают не жалейте почитайте зачем и почему параллелизм все любят все здорово но имейте ввиду он не бесплатен он не универсален более того если у вас итак машина там low to which больше чем число процессоров намного gedir намного то пролежав скорее всего ухудшит вашу производительность отключи в таком случае отключаетесь режим помогает когда у вас есть свободные ядра то есть реально для хай-лоу то провели за мне нужен ну вот так надо как это ни странно валидола все ставит по умолчанию но имейте ввиду что от минимального до максимального уровня объем в брайдсхед logo отличается в разы и поэтому если вам ненужную там полностью все логировать от понизьте уровень достаточно просто для восстановления random page гост диски современные ssd все знают если рейды то в них там десяток два десятка дисков запихивают оптимизатор исходят вот из этой стоимости из-за этого он может строить странные планы предпочитать например последовательное чтение индекс нам у если у вас запрос большим количеством join увы в процессе исследования вдруг обнаружили что у вас скорость работы кардинально зависит от порядка join of вы уперлись выйти лимиты лимиты на самом деле говорят о том когда сортировать только какого количества можно сортировать join и по умолчанию 8 клиенты сталкивались если вы используете транзакции не поленитесь там либо указывать что они до 3 тонн ли моде если это надо не поленитесь там дефолт transaction readonly поставить просто потому что вы будете транзакция будет обычно redlight транзакция берет транзакций найди а рядом ли нет поэтому вам не очень нужно чтобы у вас wraparound соответственно free случилось раньше еще и редкие камни макс connection не нужно ставить больше чем на на самом деле вам нужно это дорогое ресурс как ни странно то есть очень много зависит от то макс connection это на самом деле внутренняя структура процессоров которые хранятся все описываются все процессы пользовались а иногда ее нужно просматривать целиком чем она длиннее этим это медленнее временные файлы нужно следить чтоб адрес их создавал меньше бороться с ними но есть неожиданная вещь что у вас пользуясь вроде работает нормально а на restart в каком-то странном месте застывает у нас клиент с таким столкнулся у него я не знаю сколько файлов у него был в этой территории временных файлов но полтора часа и минусы reef net работал при том что он там за 1 32 тысячи что лиза стирала или смену цель тоже не отработал за полтора часа после это rmf а я не знаю как с этим бороться я и ему вдруг у этих номер создала другую и клиенту сказал что вот вам тест на классном админа который сможет это у директории удалить отстающие реплики которые они могут отставать по разным причину одна из причин когда вы массово начали грохать таблицы но при этом делаете по одной таблички за раз заодно за транзакцию можете внезапно увидеть что уменьшаете количество от реплика тормозит внезапно просто чтобы удалить таблицу нужно просмотреть все же памяти шарить буфер чтобы грохнуть оттуда буфера и ты таблицы на реплики это да я очень стараюсь срочные костыли не делайте так вот так можно если вы in вам не страшно потерять последние три транзакции вот это вот можно делать если уверены что данные не нужны сильно помогает вот ну и последний вот так вот я очень держал себя чтобы приди и комментировать то что времени мало ну вот последнее это нужен план б то есть когда вы начинаете проектировать систему и выкатывать продакшен дулко тут продаж вы должны уже иметь план б чтобы знать что надо делать когда вы вдруг увидите с консоли исчезающие ресурсы то есть нужно что и нужны конечно полевые испытания то есть то что вы могли переключиться добавить дополнительные машины там перенести в другой дата-центр еще но все должен быть отрепетировано тогда вы конечно можете справиться а вообще-то холо да конечно не избежать последний слайд это вот если вы хотите знать больше об адресе в янгу 4 6 февраля будет вот наша уже 5 конференция по по адресу так что приходите записывайтесь у нас там очень много докладов очень интересных и мы будем прямо рада всех вас видеть все атмы друзья соответственно все вопросы кулуарно лично и глядя в глаза"
}