{
  "video_id": "gIhoarCOAf0",
  "channel": "HighLoadChannel",
  "title": "Митап \"Что на самом деле вернет SQL-запрос\" / Антон Ревяко",
  "views": 1794,
  "duration": 1787,
  "published": "2020-04-14T11:40:25-07:00",
  "text": "пулемет давайте начнем что ислам или вернет ваш запрос вы абсолютно точно не зайти я постараюсь вам сегодня рассказать меня зовут антон реверсия 20 лет занимаюсь программированием занимался вон пройди нанимался прям белом последние несколько лет занимался тех 1019 почти двадцатом году очень много компаний занимаются разработки некрасивом напишем все больше и больше больше микро сервисов нам очень хочется делать меньше работает метро сервисом воду при этом больше как устроена обычное приложение ну или обязательно microserver даже при работе с базой данной это какие-то запросы ответы обид и может быть эту кожу через регистре как угодным комфортно висят то же самое база данных какой-то ответ и все само предложение то есть какой-то контракт на внешние за его действия например jison схемы или какие-то еще другие варианты какая-то внутренней фреймворк контроля моделька со стороны базы у нас поступает запрос который называется вдм в виде текста у нас есть схема базу данных структура таблиц йух всего сердца и в ответ мы получаем массив объектов со стороны базы данных со стороны приложения у нас есть некий шаблон вопросов которые представляем свои данные и получаем пассивку опять же объектов в техниках которые понимают приложений нам бы очень хотелось мне очень хотелось не делать большую часть вот этой работы потому что все что происходит внутри приложение можно сделать автоматически если сейчас рассмотрим тот вариант когда он баз данных ничего нет и собственно то что мы спросили у базы сразу отваренного проблема в чем в том что между всеми вот этими строчками нет никакой автоматически связи jison схема мы написали руками между контроллером и моделью у нас есть взаимосвязь если у нас есть типы в приложении если мы используем копирует у нас есть шаблон тестовый запрос а у нас есть текстовой схема базы данных который ничем больше не связан в обратную сторону у вас есть типа моделей типа контрольные который связаны между собой и тот же сон help которая навык для валидации ответ на и так получается уж нас ведь написано на трех разных языках и сквере джейсон и язык на котором выпишем положение хотелось бы связать все эти типа между собой автомату чтобы не приходилось вообще думать вы какой-то связи между собой было бы здорово чтобы генерировали тысяч чего-нибудь 1 если мы можем это сделать мы есть оставшийся код сможет генерировать из этого одного ну в общем было бы не мог у нас нет иного пока непонятен единый источник правды мы когда наносим каких изменений существует носили приложения приходится редактировать запроса редактировать типа редактировать же сон схемы но это естественно не все если есть ещё какие-то важные взаимосвязи приходится редактировать еще их ну не говоря собственно сама в ходе которого дело если мы их не понесла ему никак не связи между собой типы которые возвращают база очень часто в приложении будут совершенно другими ки например яркие примеры которые как выяснилось из разговор многие считают странным hound строчек в таблице в некоторые языки программирования возвращать string ну многие считают но видимо так задумано баг или что-то еще на самом деле hound базе данных возвращает они and hugh многие ожидают и она bigint в языках и нет began to london бпф жан скрипте преобразует строке чтобы не дай бог ничего сломать соответственно так такая же штука происходит с нами реками то и другими такими китами я не очень знаю как происходит например джори но я подозреваю что если база данных будет возвращать же сон то в java он прилетит строкой потому что но вариант из наверно особо нет ну и вот вот такие что ты если мы вносим изменения запрос схему свои типы внутри таблицы у нас внутри приложения мы должны перепроверить все но по большому счету потому что гарантии что если мы добавили какой-то так как запросе то что мы не забыли его добавить на 3 приложение гарантий нет нет единого источника правда давайте вы найдем как вариант а значит что мы только хотим получить если на источник правда какое-то промежуточное представление типов и в генерацию всего года которой общем вам захочется еще мы хотим использовать только статические методы то есть мы не запуская при этом базу данных мы просто смотрим на станции и говорим о наносите будет так вариант номер один по мск леди кто использует у р н для работы с базой данных понятно когда когда у нас когда у нас структура базы данных зависит от языка от того что ты написал в приложении то есть все запросы генерируются на основании того на деле назвать их так классов которой написано и приложение в общем вариант на самом деле ничего обсуждать моего не болен ряд номер два который но такой самый вроде подходящий у нас есть шаблон запросов которые мы представляем свои данные для того чтобы закирова уже в базе данных и вот в принципе сам по себе кандидат ничего ну вот например так вот он может выглядеть пример из на ноги вопросы соответственно параметры которые представляются могут быть не примете ну через все объекты что довольно удобно но смотря на этот шаблон в общем по большому счету понимаем только именно палит который заложен в обратную получить ну и соответственно имена полей которые мы можем туда засунуть надо как-то распарсить легенд на самом деле саша не подходящая вещь это же проверить как как у нас вообще все то получится давайте попробуем берем значит тот самый давай ну и чем можем делать другая переписать его потом написать несколько страшных организмов которые будут сниться потом еще неделю и вот эта вся распарсить и в итоге мы получим название полей объектов которого папа голосовые на вход и название поли объектов которые нас получится в результате ну такое но быстро сделать попробовать написали не знаю сколько дней не сильно прыгать получили сразу коды генерации упрямо писали шаблоны прямо на любом лежат в котором больше нравится и получили готовую описку целиком у нас есть и ты вопроса и ответа ну сэкономит это около четверти времени на разработку а до утра сервиса что плохого такой специфичный доволен формат запросов которые когда первый раз люди смотрят что-то тут точно понаделал type касты не безопасность что это значит есть пара ярких примеров могу привести опять же ожидая в county and но чтобы честно получите у себя в приложению числом мы его вот таким образом как вы как тут рисовали с костюм канту от подрыва здесь и в момент когда он перевалит за этот самый всё превратится в тыкву и будет исключение и не понятно будет что происходит естественно случится и сразу а очень нескоро и второй вариант очень наглядный если вы работали с майский лим возможно вы знаете что спицы тебе работу власти или со строчками такое что если вы говорите что длина поля 30 символов и пытайтесь занесет кит туда килобайт текста он молча обрежьте серфинг hq сорвали вот в padre это не так при попытке засунуть туда больше чем описано символов он выкинет исключение скажет у тебя все сломалось так не делай все плохо надо если гибкости таким образом данный кадр , что за несет нам приходится это сделать для того чтобы 3g это отработала по времени сорта такой дпс просто обрежу то текст и засунуть его в колонку молча ничего не стоит в общем плохая идея не надо делать ну и вообще приходится писать руками все равно и нет никакой связи со схемой печально давали 3 лет общем у нас есть схема описанная тоже обычным человеческим давайте мы как между собой совместим и попробуем сделать что можно получить ну вот генератор понятно центр 75 времени мы сэкономим потому что придется кишит этими типами и проверять их в общем 2 любые вообще запросы какие угодно другой улице не придется он только написать сами эти вопросы и есть обратная связь со схемой кандидатах когда вы что-то поменяйте и схеме мы перегенерировать получили новые типы все замечательно что вам придется распарсить для того чтобы все это дело каким-то образом совместить но со стороны схемы есть схем и таблиц и constraint илюхина мы очень много все и когда начинаешь что-то делал погружаться много совершенно не очевидных вещей бывает чего оказывается можно сделать создание таблиц вилкой все остального со стороны вопроса это ну понятно что собственно с вами запросы под запросы с этой и что он стал вы а написано join и функции математические выражения indirect это если у вас есть композитный теперь-то вы можете обращаться через точку собственно к полю и получать какие-то элементарные тепло чем вот вот это вот все от как-то собой сплющить очень сложно но мы сделали нанесен потому что на самом деле очень много всего и и доделать эту примут взять это дело снаряда невозможно что серьез поддерживается под газ до 10 включительно в 11 12 есть новый синтаксис который ну например у покрывающий индекс материализованные цветы е.а. надо сказать что естественно вот это вот все 1 классе деревенскому не получится потом режим сразу этот захочет для этого нужен пар серой стае абстрактного синтаксического дерева и работать уже придет с ним если опять же глуп тот захочет такие партнеры форсиер отдельно вынут из пожгли его можно попробовать отдельно ноги на пол до сих еще начнут погоду вот следующем году очень надеемся что будем поддерживать весь синтаксис и еще мой стиль если получится в москве вообще сложно у него нет st парсер который вообще откуда либо можно было просто взять и использовать придется как-то выковыривать его самостоятельно что у нас получилось и по ответам почему только ответов потому что пока только ответа это мы можем понять о луны схемы тип запроса пока получить не удалось потому что стекло не допроса все намного сложнее за пределами презентации я могу потом ответить если тут просто отличная штука которая никаким другим образом кроме как этим инструментом не будет доступно понимание будет ли поле null или нет ну то есть если у вас есть обычная таблица у нас там написано что поле not null мы делаем просто select из таблиц все понятно волокном а что если у нас это какой-нибудь как страшно что если у нас джоли на джоне что если у нас юхана view he срезали кончат очень без поллитры посмотрев пристальным взглядом и запросы сказать будет ли это поле но лари не может не может ни один живой человек это невозможно соответственно ему не теряет как этого узнать также взять и узнать ну можно попробовать заполнить все таблицы всеми возможными вариантами данных которые получаются и наделать селектор там так вот это в общем ну не знаю вот еще что очень здорово если кто-то пишет по их народе используется для про мазь в промо сие есть методы которые не просто запускают ваш вопрос а еще во лидирует его на ожидаемое количество строк что это значит допустим я сделаю какую-нибудь штуку связанную с созданием заказом я понимаю что когда я создаю заказ мне обратно должен вернуться должно вас одна строка the body заказы какие-то его параметры еще что то но если я делаю это все нескольких цветы и может так получиться что какой-нибудь join мне вместо той строке сделать топ 5 да у меня будет хоть и заказывать всегда одно и то же там какой данные члену они будут различаться и вот в пока про мази эту штуку выкинет исключение если я ожидал эту строку вышла борщ на одной строке или вышла 0 ства не так над этим разбираться вот и количество рок соответственно читается не точно tab 1 2 3 10 то есть без классов которые описывают что вообще может произойти с вашим запросам раз таки ни одной строки не вернется вернется 1 или создали ни одной вернется много или много ведь не 1 год это очень классный инструмент для того чтобы не не потерять все деньги если вы тут пишите какие-то финансовые штуки очень рекомендую вот это все мы получили просто запуском статического анализатора на выходе он говорит что вот типолет такой нола был не нужно был и весь твой запрос это вот таких вот такой класс там несколько или какие-то варианты что еще предстоит сделать типа запроса как я стала исключением запрос кубань данных может выкинуть исключение причем вы можете совершенно не ожидать даже не знаешь и они такие бывают яркий пример опять же мы попробовали каунт закосить контор и когда он не сможет это сделать будет исключением или например у вас есть триггер и вот там что то делать вы тоже можете купить исключением еще как выяснилось не все знают можно сделать юху таким образом что база не будет заставлять не будет разрешать вам вставлять или апдейтить данных в таблицах которые задействованы в этой гифки если эти данные не попадают в тоже исключением кому интересно посмотрите третью тантала ни зова в общем съесть не знаю правда кстати используют тем не менее то есть бывает так что ты не понимаешь а вообще не ожидали что может быть какое-то исключение плюс есть всякие штуки когда работаешь же сонам внутри есть внутри функции которые ты вызывающе есть внутренние еще преобразования которые тоже могут рожден исключения знать это невозможно совершенно каким образом это может встретить на практике еще хотела бы сделать ассистент леди баг и что это значит когда вот выходишь гарри что вот пол пульнул из строк будет много места 1 кроме как крикнул теперь вариантов нет сидеть разбираться почему и вот хотелось бы сказать что ну здесь будет потому что вот здесь join без внешнего ключа и много строк будет потому что здесь жизнь внешнего ключа то есть поэтапно сделать вот такие вот вот такой вот подсказку это недавно была пара статье на хабре одна из студия другая жить там тоже статически анализаторе но они там джаву анализируется и анализатор утверждал что может быть каким-то таким единым образом и другим образом быть не можете живой человек смотрит да и то почему я не понимаю объясните мне вот хочется чтобы живой человек понимал почему и так вот какие у нас проблемы были этих проблем нет ни единого разрыва теперь у нас связанные запросы схема типы все замечательно мы не работаем у нас работают роботы не надо много заниматься ерундовый работы которую никто не хочет это сделать но собственно можем в этом нет времени играть в керале смотрите точек мылит работать и не знаю канале кучу времени все это дело можно воткнуть вся и где провериться что чипы не совпадают опять же радость языках мира по разному но можно заставить себя генерировать типы и сравнить их с теми цветами которые есть приложение если они не совпадают все они пойдет то есть бывает так что программисты на машине своей не включают вот эта вся и прям уж этой ночью надеть все это дело со ваша ложится на всяким форте мы можем генерировать контрактов ну не только jassun схем вот кстати джейсон схемы это отдельно вот если кто-то пишет руками я ребята я очень полезную это от особенно там если какие типы есть на 3 воин вот то есть можно генерировать в этих самых контрактов вообще в каких угодно это не проблемы и соответственно на языках тоже не проблема потому что я по которому получили промежуточные представляете мы фактически установлены текст виде критиков и какой-то будет язык совершенно может генерировать либо только типа либо не красавица целиком бывает так что как бы один вас нифига не игра сервиса самым общались и часть похода в базу данных это только часть этого сервиса соответственно весь микро сервиса на фиг не нужен мы берем только тягу можем 9 классы для фреймворков ребята кто вовремя привет то есть я понимаю что бывает так что все-таки приходится ходить руками даже свое равные переписать запросы но можно сделать так так ну вот если я пишу без типу сколько унесет будет нужно до тоже будет должно почему потому что ты точно будешь знать что вернет можешь дальше свое приложение конечно обрабатывать но вот ну и в общем вот так это поразительно выглядит поэтапно сферы скажу тоже я такие вот такой вот на сайт бесплатно ли это пока бесплатно попробовать попробовать можно собственно непосредственно сайте мы запустили playground который экспортирует от вашего типы пока там только typescript и флоп на следующей неделе я думаю что будет во многих игроков и еще кое-что имея такую информацию мы можем сделать много других интересных инструментов и один из этих инструментов статический анализатор для эскель запрос он скажет сразу что что то не так в тексте запрос он скажет что когда ты это допустишь ошибки он подскажет что ты не оптимально неоптимальный твои запросы у тебя нет и индекса или вот перестань и на америке и лови использовать место винтов танки тебе нужно intel предупреждает что так писать нельзя данный момент больше тысячи тысячи правила писаны но я думаю что это центр реально 10 и того что будете приглашаем ребят которые занимаются написание маски или вручную типом участвовать совместно тестирования поскольку экспертиза на всех языках у нас нет было бы здорово если быть что пишут аджарии на торгу наша а потому плюсов всех остались сказали что генерирую нам типы вот так и в общем мы разве не реви ну в общем пишите звоните тестируйте тестируете нашу штуку все теперь я поотвечаю на вопросы кого он доска нет я могу открыть программу просто мнение таких заманчивых запросов которые прям были по action давай чуть попали и подумаем и красивой все настолько здоровый понятно могу сказать чем проблема понимание типов запросов понимаете нет ли ground запустили только чара это вещь где-то через полгода написание этой штуки становится понятно почему это еще никто не написал потому что и я лично знаю что именно вот понимание внутренней стены этого всего где сейчас твоя готовность идет порядка пяти двадцать почему собственно я приглашаю вместе со мной все это дело по тестировать потому что все все свои стили которые меня были я покрыл мне нужны ещё фильтр потому что люди пишут совершенно по-разному хотя казалось бы это вопрос а если с типами ответа все в общем-то понятна и даже если у нас сложные view hits это ешки express шина и так далее так далее так далее мы знаем откуда-то взять у нас изначально и схему базы данных или у вас есть какие-то функций на выходе нам возвращает текст м ap стринги за шесть лет это мы берем из каталога опять же заранее спрашивала каталога болванов просто таких баз данных и запускается вот а когда передаются параметр внутри запроса понижается совершенно странным образом вот то есть балета когда этого примерно счет и мы можем подставить понять что этот параметр по полю торгуйте кого он курит параметр в такую-то колонку и понять что типы должны быть вот такими так чтобы все было хорошо но есть им плите как-то касты которые могут автоматически привести типы внутри вставляешь чан будет текстов нормальный представляешь там еще вариантов по ловле на и бывает дальше вопрос станет таким образом что у тебя параметр за входной параметр используется не только в тех местах где можно понять что это такое но смотри например я делаю select доллар 1 то есть первый держит перед выборами то что я могу на это будет ничего и бывает такое что вот вот вот так вот и плюс еще какие то дополнительные условия бывают что условия такие что они утра до функция может принимать на америк и другая может принимать другие наборы значение все это я должен смочить вместе и предположить что же ты все-таки можешь передать это пока сложно но ведь злому я думаю ну кроме выжить на случай но если вопросов нет присоединяйтесь я думаю мы сделаем отличной штукой месте еще был опять же кроме статического анализатор типов можно еще сделать такую отличная вещь как автоматическим игра автоматически миграции то есть разработчики спокойно себе пишет и нет db добавляет колонки добавляет индекс убирает колонки давали и типы она горит смотри вот у меня мастер нём лежит и он у меня войне там тоже лежит делаем не сам миграцию шоу-ринге очень недолго как сам и вся это все на ну понятно что не всегда так можно сделать но если это можно сделать то сделаю это позже уже следите за обновлениями спасибо большое чтобы всем пожалуйста про извинить"
}