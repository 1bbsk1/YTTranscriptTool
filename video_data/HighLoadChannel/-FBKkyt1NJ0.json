{
  "video_id": "-FBKkyt1NJ0",
  "channel": "HighLoadChannel",
  "title": "Топ-5 провальных решений при разработке на Tarantool / Игорь Золотарев (VK, Tarantool)",
  "views": 1705,
  "duration": 1900,
  "published": "2023-01-19T05:55:16-08:00",
  "text": "всем привет меня зовут игорь сегодня вам расскажу про 5 мнению провальных решений при разработке на таран доля и начну я с того что расскажу про себя немножко правого нашу компанию тарантул если кто-то вдруг и не знают это такая база данных из приложения на флаконе мы себя позиционируем как платформу для инна мори вычислений и свобод в tarantul и начал с разработки витрин данных для одного крупного российского телекома а последнее время я занимаюсь разработкой картриджа это такой фромборк для создания кластера приложений на таран туле на холоде я во второй раз в прошлом году я рассказывал про масштабирование мастеров на картридже если кому то интересно можете найти этот доклад и посмотреть его также тарантул я читаю тренинги если вам вдруг нужно корпоративное обучение приходить к нам мы вам расскажем как к работе тарантул ссылки новые контакты может найти по qr коду и вообще в конце презентации мне будет общий qr-код со ссылками на презентацию также там будут примеры которые можете сами потыкать и самостоятельно поломать тарантул на основе того что сегодня расскажу и откуда вообще взялся этот доклад в основном из личного опыта моего и моих коллег это разные проблемы с наши production решениями которые мы встречали в своей работе также это различные странные запросы заказчиков которые просили нас воспользоваться тарантулом в тех случаях когда не очень подходил и мы насобирали на этом шишки также этого просто тренингов про все это буду сегодня рассказывать а конкретно сегодня мы говорим про кластерные запросы говорим про инь-ян точку отказов пластыря посмотрим как не очень хорошо работать не структуре им данные втором туре посмотрим на мастер мастер аппликацию и на транзакциями в tarantul и начнем мы с нашей всеми любимыми в общей tarantul на грабли это называется select new если выкроить писали на таран то ли вы знаете что такое select new это такой общий тренд элемент достаточно известный у нас даже есть своими мы на эту тему и что вообще такое select new если вы знакомы с клеем это некоторый аналог запрос select звездочка у которого есть ряд своих особенностей во-первых у не дает управление то есть он будет работать пока он не достанет все данные из от рандр расписание стран данной таблице после того как он начался отменить его нельзя и все в совокупности это дает вам гарантированный способ положить энтин странного либо у вас не хватит памяти на то чтобы стать все данные странного либо ваш инстинкт ранд его просто перестань отвечает на другие запросы работать с ним будет совершенно невозможно и как себя можно обезопасить такой ситуации ну во первых сам простое это не использовать select вы можете посмеяться на этом моменте но это действительно то что мы рекомендуем нашему костюмером если вы не использовать заменять его например функцией pairs которая дает вам итерацию класс по ису вы избавите себя от части потенциальных проблем ну если вы очень все-таки очень хочет использовать select может туда передавать параметры лимит и ограничивать количество записей которые вы из него возвращаете чтобы не возвращать весь space доставать его по кусочкам и допустим представим что мы уже научились писать селектор tarantul а решили что мы будем читать наши спайсы кусочками и нам необходимо написать pagination как бы мы это сделали в самом примитивном варианте которые просится сразу в качестве решения это вот такой вариант нас есть функция пирс наши замечательно любимая и мы можем туда передать параметры которые нам откинут тысячу записи и возьмут следующие 1000 записей и как мы ожидаем что это будет работать ожидать что вы пройдемся по записи начиная с 1000 по двухтысячную но на самом деле нет этот запрос пройдется по первым двум тысячам записей и просто отбросить 1 тысячу соответственно если вы это запихнуть в цикл если вы будете читать весь в цикле то каждый следующий car достичь итерации цикла будет работать все хуже и хуже и вы получите тот же самый fools скан держи столь же самый select new что в первом варианте только в этот раз будет все возможно даже еще хуже но при этом будет вам надо отдавать управление и в самом начале таранда у вас будет работать а потом он превратится в тыкву и все таки наверное нам синглу новые запросы в таранто ли не то чтобы очень интересным и все таки наверное хотим работать с большим трампом работать с ним как с кластером и рано или поздно даже раз когда мы научились писать хорошие select и в таранто ли нам необходимо написать какой-то большой кластерный select который соберет данные со всех узлов у это я забыл да как правильно переписать в 11-ю в pairs можно передавать частичное совпадение с ключом и всеобщего можете прооперироваться поскольку начинает склад элемента таким образом можете достать 1000 записей начиная с какого-то ключа рисую берёте пачку данных стран то вы запоминаете какой там был последний ключ который вы достали и потом цикле передаете его обратно в pairs и дальше считаете space по кусочкам и да вот что ученых начал рассказывать это кластерные запросы кластерные join и а точнее как мы их фильтруем давайте представим себе какой-нибудь простенький select которым привыкли писательские реле тут есть какой-то маленький join есть какой то как фильтрации есть какая-то группировка и на скелет запрос выглядит нам всем понятно привычно но когда мы напишем его на тракторе нас получится какая-то не очень красивая хорошая конструкция сейчас я покажу пример кода можете него особо не вчитываться просто оценить масштаб этого запроса в таранто вы о да немножко при форматировании простите в общем выглядит это не очень хорошо сложно читаемое особенно со свежим форматированием в общем это я к чему к тому что запрос который возке или кажется простым в таранто ли будет не очень хорошо читаемым его сложно отлаживать его сложно писать в нем очень просто ошибиться и рано или поздно нас запросто начнет тормозить и мы начнем искать кого бы в этом винить может быть мы там не в неправильных местах одном управления или наоборот не даем управление где то может быть мы используем не те инструменты но на самом деле все гораздо проще и скорее всего виноват разработчик которые написал такой вот поэтому желательно подготавливаться к большим классным запросам в трант или и готовить их заранее давайте посмотрим на другой пример представим что у нас есть какой-то небольшой кластер с двумя спицами которые мы хотим поджоге нить и вернуть пользователю ну а там еще какая-то фильтрация простенький join и как бы мы его называли наивно в лоб ну мы бы наверное сходили на каждый зов достали каждого пачку select of от полевых на роутер там их по джайне рим и вернули пользователю какие есть какие могут быть проблемы у такого решения во первых сам очевидное что вам просто не хватит памяти для того чтобы эти данные за selected либо же там будет слишком большая пачка данных которые при отправке по сети у вас будет занимать очень долгое время потом нам нужно будет пройтись по этой огромному массиву данных еще раз на роутере чтобы их друг с другом по joy нить и в целом получается перст такого решения будет достаточно плохой как это можно было бы исправить на самом деле вариантов тут может быть много все зависит на самом деле от того какие вас данные в таранто лежат вариантов может быть много вариантов решений тоже может быть много все зависит опять же от данных но я покажу один из примеров как это можно было бы сделать например можно было бы достать ключ и по которым происходит join на роутере отправить их на роутер там по joy нить эти ключи в итоге мы получим какое-то общее подмножество ключей по которому нужно сделать select их мы снова отправляем на нашу сторону и настороженных уже выбираем данные по тем причем которые нам подходят снова возвращаем их на роутер и там joining в целом наверное это будет работать гораздо лучше все зависит от того какие вас данные сколько у вас данных в каждом и спецов какие вас запросы как views объем итоговой выборки которая возвращается пользователем и в целом наверное стоит сказать про какие-то общие подходы к таким запросам чтобы они работали лучше всего конечно лучше хранить связаны данной месте но такое к сожалению сюда возможно поэтому стоит применять некоторые правила например фильтрацию данных лучше всего проводить на 100 раджаф то есть вы должны проходить на старжа как можно меньше данных то есть добавлять как можно больше фильтров так чтобы у вас в итогам запросе возвращалась как можно меньше данных если это возможно если вам нужна какая-то агрегация к эта группировка ее можно сделать на роутерах если вы хотите свои данные щупа сортировать вы можете сразу создать яндекс по которому они будут вращаться уже сортированы а дальше вы будете каким-то образом обвинять друг с другом так же если вдруг вам хочется joy какие-то большие таблицы в tarantul и которые не влезают в runtime память вашего приложения вы можете лет в использовать временные таблицы которые в номере у вас будут хранить результат вашего промежуточного запроса ну и какое то самое главное по совету желательно уменьшить количество передаваемых данных по сети и уменьшать количество данных по которым мы проходим все в риме троц ее поспешу и также в конце каждого блока но я будут ссылочки все ссылочки доступны по qr коду которое будет в конце вы можете дополнительно почитать про то как у нас работает бог space select и почитать про крут это наш модуль для написания хвостовых запросов а следующий пункт моего доклада это один . отказов пластыря она на самом деле связана с предыдущим пунктом это опять же буду говорить проку остальные запросы в таранто ли и вообще 11 точку отказов plaster и получить наверное достаточно легко я думаю что многие так или иначе сталкивались с этой проблемой в своей работе я буду рассказать про один стримеров их может быть опять же повторюсь может быть много различных вариантов опять же много различных вариантов решений такие проблемы а расскажу я вот про такую ситуацию с которой я сталкивалась на одном из своих продав представьте себе кластер достаточно большой он сортированный данные на нем поделены на разные узлы и во всех запросах которые приходят этот мастер используется специальный space в котором хранятся неизменяемые или редко изменяемые данные этот space в архитектурно был заложен так что он находится где-то на каком-то отдельном узле тарантула и в этой ситуации у нас появляется несколько проблем например это слишком много сетевых походов на один кластерный запрос то есть каждый запрос который проходит через кластер он падает на роутер дальше он расходится по сторонам и есть на 100 раджа у нас нагрузка более менее распределена то нагрузка на словарь на instant со словарями будет очень высокая и ведь каждый запрос проходит через этот инстинкт таким образом получаем что у него очень высокая нагрузка он в принципе может и не выдержать и рано ли поздно начнет либо тайм-аут сеть либо 500 отдавать в ошибки и так как это общее место через которое проходит и запроса вы получите ошибки вообще всего приложения потому что у вас его сны узел он перестает работать как такой проблем можно было бы исправить ну например можно было бы перенести этот словарь к место где у вас собирается запрос то есть объединить словарь роутерам и это вам поможет избежать некоторых проблем с формированием запрос то есть у вас данные словарный будут храниться рядом с места формирование запроса в таранто ли вы можете так сделать если вы используете карты что тоже можете например сделать свою роль которая за это отвечает и объединить ее с роли роутера в таком случае у нас нету какого-то вверх и до на походы по сети к этому отдельно стоящему словарю данный вас хранятся рядом вы просто ходите на стража возвращаете туда данные ходите в наш словарик который лежит рядом и просто joy нити данный возвращать их пользователям но это все хорошо в том моменте когда мы разрабатываем такой city tour бластера но к сожалению часто бывает так что у нас уже есть код архитектура и выпадаем ситуацию с ним . отказа когда сначала все вроде бы работала я работала достаточно нормально никаких проблем не было а потом внезапно у нас появилось больше клиентов кластер и и увеличилась нагрузка и вас появляется один . отказом как с этим можно справиться в трант или ну например можно добавить дополнительные реплики то есть повысить доступность вашего ребенка сета на чтение написать какую-то балансировку запросов которые будут ходить на этот сторож и доставать с него данные не будут ходить только на мастерах но еще и на реплики как вариант если вам нужна еще и туда писать данные какие то вы можете написать можете сделать нам мастер мастер аппликацию и написать на нее триггеры которую вы будут решать конфликты про это у меня будет чуть попозже либо же возможно вам поможет в этом случае синхронной облигации сам нужно писать в этот три пика set но писать не очень часто блоки ссылку на ссылки на наши кластерные инструменты эта ссылка на лишь арт роутер и на мою статью про масштабирование по мастеров на картридж как я уже говорил если работать с картриджем можете написать роли и объединять их друг с другом зависимость того что вам нужно использовать проблемы мир 3 это не структуре вина данные трандл вам позволяет хранить данные в различных форматах вы можете задать какой-то жёсткий формат в котором вы будете знать тип каждого из ваших полей а можете сдать использовать трандл в качестве такого документа и базы данных и хранить данные без формата просто хранить какие-то джейсон и просто ранее какие-то массивы данных и хочу показать какие с этим могут быть проблемы опять мыслить его форматированием ножка например нас есть space в котором хранятся какие такие бои значения причем в и у нас это какой-то документик например это массив данных или джейсон чик котором хранятся множество элементов и теперь для того чтобы поменять какие-то значения в этом асия нам будет необходимо достать этот тапу потом по нему пройтись и поменять в тех местах где необходимо принять там данные и потом это так у записать скорость этого решения очень плохая на 5 ч но тут немножко съехало на слайде прошу прощение за это скорость во от решения очень плохо у меня на мои магните получилось где-то три десятых секунды что для хайло да наверное вообще какая-то жуткая обида это очень-очень не 1 решение но как от этого можно было бы избавиться например можно было бы разбить наш неформатированный тапу в котором он сохранился массив на на какой-то набор тапов добавить в формат номер ячейки массиве например и отдельно хранить все параметры которые мы раньше хранили в этом массиве теперь у нас первичный ключ к такому по такой таблица будет стоять из ключа который раньше был просто единственным ключом и из номера элемента в этом массиве тогда в торонто вы можете написать следующий код можете создать транзакцию в которой еще будете просто обновлять записывать пачку апдейтов которые вам поменяют все необходимые данные и скорость такого решения у меня получилось 3 десятитысячных секунды это в десять тысяч раз лучше чем предыдущий вариант и согласитесь это уже довольно неплохо помимо этого у низ татарин данных есть еще один подводный камень и про который тоже хочется упомянуть стран то ли из-за механизмы по которым тарантул выделяет память вы можете не попасть размер выделенной памяти в таранто ли и получить ошибку на локации памяти тогда у вас такие неструктурированные tab ли они быстро растут вы можете не попасть в размер который тарантул выделяя для ваших данных и получить ошибку локации это конечно можно починить с помощью увеличения коэффициента для локации памяти но в целом если вы вы использовали в этом решении структурированные данные такой проблемы не было и по ссылкам у нас документация по формату и наса полок факту следующая проблема про который хотел рассказать это мастер мастер репликация без триггеров что такой мастер мастер аппликация это такая топология кластеров в которой мы можем писать данные в любой зло в кластером если мать реплики мы пишем в один узел почитаем например с replied to master master можем писать вообще в любой узел например у нас есть где-то в недрах в к есть вот такой страшный blaster master master топологии не делают представить такой напротив но такое тоже можно сделать в trantridge тарантул позволяет вам довольно гибкую схему топологии сделать и какие могут быть проблемы у мастер мастер решение например когда вы можете сделать на временные изменения на по одним и тем же ключом на разных узлах вы делаете одновременно изменения эти данные по апелляционному протокол операнд в отправляются на другой узел и в этот момент мы получаем что данные которые нам пришли по репликации расходятся с теми данными которые мы записали себя самостоятельным в этом минус происходит конфликт у нас разваливается верификация 370 настроек тарантула он либо перестает работать либо будет работать отдельно друг от друга у вас не будет работать аппликация и узлы за живут своей жизнью что очень и очень печально звучит как это можно было бы починить время написать триггер который будет разрешать нам конфликтом то есть в момент тот момент когда ему приходит какой-то потапова какие-то данные он проверяет нет ли у него уже таких данных по этому ключу спейси если не есть он каким-то образом выбирает какой из этих тапов оставить какой из этих тапов выкинуть например мы можем добавить к нашим данным метку времени и выбирать например тапов который был создан раньше или то по который был создан последним или написать возможно какой-то более сложную систему и решать по каким-то вторичным параметрам какой из ваших тапов более важный этот триггер в tarantul и будет выглядеть примерно вот так то есть у вас триггера этот некая важная функция которая принимает на вход в старый тапу иного этапу есть кого-то из них нет там и этот то просто пропускаем значит это было либо удаление либо первичный черт если же у нас есть обод apple а значит у нас появляется конфликт и значит нам нужно из этих двух то плов выбрать какой-то один чтобы добавить триггер на space мы должны написать вот такую сложную конструкцию я не буду ни подробно останавливаться вы можете почитать документацию как это работает но если вкратце то это нужно для того чтобы ваш триггеры сработал сразу после поднятия трансовый snapshot а в ссылках у нас мастер мастер аппликация статья на хабре и документация на бокс replace триггер и последнее о чем я хотел сегодня сказать это о транзакциях перед лечением креп лики это тоже проблема которая я встречал на проводе она была немножко в другом форме но это была страшная вещь что тогда происходило произошел restart мастера под нагрузкой широко эта нагрузка постоянная запись и какой-то причине произошел restart мастера ну например он там произошло когда внутренняя ошибка он отвалился с ошибкой его restart нули и после восстановления мастера к нам приходят коллеги которые проверяют данные и говорят что они были какие-то данные тарантул сказал что все эти данные записались и стран туда этих данных больше нет я начал эту проблему исследовать и оказалось что эти данные их нет на мастере но они есть на реплики я долго не мог понять что случилось но на самом деле мы можем разобрать которыми подробнее посмотреть что вообще в отмен происходило тарантул входит момент делает свой snapshot откладывать снимок данных на диск потом нему приходят какие-то новые данные он их тоже кладет к себе на дисковых слоги потом он говорит пользователем что все хорошо я все записал эти данные потом расходятся в асинхронном режиме по репутационным потоков на другие узлы а затем происходит restart мастера и по какой-то причине либо из-за какой-то проблемы с диском либо по недосмотру разработчика который случайно восстанавливал узел фронтовые вдаль его их слоги итоге теряются дальше мастер восстанавливается и сразу же после восстановления он начинает писать какие-то данные то не дожидаясь подтверждения от реплики что она ему отдала все что у нее есть в этот момент реплика эти данные возвращают и тут у нас происходит конфликт потому что мы уже успели записать данные с такими родишь никами которые мы получили по репликации цвет у нас конфликт на все снова разваливается либо в самом плохом варианте у нас ничего не разваливается но данный у нас на обоих узлах разные как это можно было бы исправить ну все достаточно просто после рестарта надо было дождаться пока мы бы получили все данные с реплики дождаться пока у нас сойдутся lsn и то есть в таранто ли это можно сделать с помощью проверки или клоков наших ле граф де клоков можно было подождать пока у нас данные на мастере на реплики будут в одинаковом состоянии это может сделать двумя вариантами например можно воспользоваться и прикажет connect форумом это такой кворум который собирается перед тем как узел говорит что все хорошо у меня можно писать данные вы должны собрать питерскую на котором кары не всегда возможно установить его там больше единицы конечно мы это рекомендуем делать для всех приложений но иногда это невозможно потому что у нас пример кластер запускается по частям или производит какие-то работы в кластере в таком случае можно написать какую-то функцию которая бы дожидалась окончания синхронизации с репликой как она могла бы выглядеть ну например вот таким вот образом это простенький циклу который просто сравнивает сны на одном узле и на другом узле и возвращает true когда у нас целая сцена на двух узлах сойдутся и соответственно пока у нас не вернулось true езды функции мы говорим тарантул что ты пока что то чтение для записи не доступен только читать всего можно и такой подход вам может помочь избежать проблем с транзакциями и в ссылках у нас транзакции и репликации стран для можете почитать и разбираться подробнее когда сработает и в заключение хочется наверное подвести какие-то выводы обобщить как в целом не допустить проблем при разработке на таран то ли ну во-первых самое идеальное сама жили в идеальном мире это наверное можно было бы закладывать расширение наших мастеров заранее сразу писать такой код который будет хорошо масштабироваться который будет хорошо работать как с маленьким объёмом данных как с большими объемами данных и это конечно хорошо было бы иметь в виду при разработке ну-ка своим такое не 100 возможно поэтому хотя бы можно держать в мекке это подводные какие-то подводные камни при работе с инструментами с которой мы взаимодействуем и конечно же настраивать всякие вещи которые нам помогут выявить эти проблемы на ранней стадии например делать тщательно вручную тестирование она может помочь спасти ваше приложение если вы можете дать при нагрузочное тестирование какую-то нагрузку которая будет более менее похоже на то что у вас будет на реальном роде это будет здорово это сразу выявит вам множество проблем которые возможно есть ваших приложениях и вы можете их оперативно исправить ну и конечно когда вы уже запустили спрос обязательно встраивать мониторинг следите за тем как работает ваше приложение следить за его perform следите за память другими параметрами подробнее про это можно почитать в наших сетях про нагрузку тестирования и статье про мониторинг материалы доклада доступны по qr коду также и там будут примеры которые вы можете самостоятельно потыкать и поломаете тарантула у себя дома примерно также как про то что я рассказывал сегодня также там будут ссылка на слайды и все ссылки которые есть на этих слайдах а на этом у меня все спасибо за внимание уважаемые коллеги поблагодарим давайте горе и пока вы готовитесь задать свои вопросы а девушки идут пам я воспользуюсь своим таким монопольным правом задать первый вопрос вот ты сегодня сейчас рассказал про 5 проблем какая из них вот значит есть любимая мозоль на который вот сам вот наступил блин я сюда уже наступал вот вот какая из этих проблем тебе больше мозоль мозоли stead экстазы ну наверное все таки вторая проблема стиляг ним это такая всеми любимой авторан то ли грабли и нагара скажутся на мы любим и супер спасибо большое пожарные коллеги поднимайте руки у кого есть готовые вопросы в онлайне кстати можно тоже задавать вопросы мы выведем их на сцену так так секундочку тогда у меня будет еще один вопросик себе вот когда ты заканчивал свой доклад и говорил о репликах и там был такой еще момент что есть возможность посчитать что реплика уже дошла добежала до конца да вот это вот эта возможность она встроенная в суде или и нужно дополнительный блок вот это вот писать и где-то снаружи то есть как правильнее то делать ну правильно конечно вы бы делать ну настройку тарантула первоначально чтобы он сам самостоятельно deal но как я говорил не всегда это возможно использовать и иногда приходится писать самостоятельно такие функции которые будут ну догонять данные грубо говоря уж о спасибо большое"
}