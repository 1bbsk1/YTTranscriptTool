{
  "video_id": "fUkiUgoqGrY",
  "channel": "HighLoadChannel",
  "title": "Реализация асинхронного фреймворка на базе Nginx / Алексей Радьков (DINS)",
  "views": 550,
  "duration": 2843,
  "published": "2020-04-14T11:12:16-07:00",
  "text": "а начмед зовут алексей рачков как меня уже представили я работаю в компании энди на сестру находится в санкт-петербурге небольшой flight компанию это центр разработки для одной крупной американской компании которая представляет услуги в сфере телекоммуникаций вот собственно вот некоторые данные которые можете посчитать это не будем сильно долго останавливаться на этом значит о чем я буду рассказывать значит как бы основной здесь основную роль будет играть engine сказкой модуль я понимаю скажу что это такое я приведу пример как использовать сервисы которые можно написать с помощью этого модуля мы будем собирать статистику по рабочим процессом джинса индекса я таки так говорю могу ошибаться потому что привык уже говорите нужен почему-то посмотрим как реализовано эти сервиса посмотрим что такое разделяемые сервисы и и к и каким образом воздействовать с точки как бы с точки зрения api нас и на сервис и так называемые сервисные хуки ну и соответственно поговорим какие плюсы и минусы хаски как и язык она стоит встретились как бы в процессе работы с этим модулем объем итоге и ссылки это и дает подведем итоги iii доме ссылки на найти модули и дополнительные антиноя информацию значит кратко сведения о хаски джин сказки ли моды но это собственно в терминах engine со это обычный дженкс обычный модуль в том смысле что компилируется обычно статическим образом в момент компиляции энджин оксо представляет из себя код на сим ну естественно для того чтобы обеспечить взаимодействие с к скальным к странным кодом какие-то дополнительные модули уже написанное на и на этом языке которые позволяют использовать его функции написаны на хаски внутри как бы дженкс дал случае внутри can конфигурации мы будем запускать и сервисы прямо из конфигурации джинкс какие существуют варианты решений а я не сказал да собственно что он предоставляет представляет синхронная синхронной задача но это обычный variable хендлеры до предоставляет сервисы что такое сервис сервис это синхронной задачей работающую в фоне таким образом они не привязаны к запросу их время жизни соответствует времени жизни рабочего процесса у них там есть у них там все сложно своим жизни они перри запускаются и я это объясняю что это такое значит разделяемый сервиса это когда вам не нужно чтобы вас много одних и тех же задач фоновых висела на всех рабочих процессах а только желательно только чтобы у вас был один instances его створки rav4 то например если вы куда-то ходите за какой-то информация не нужен 4 копий одного и того же похода вот content finder и но это обычная engine лисовская дело до от отдачи контентов по запросу пользователя но и обработчики по запросов это если вам нужно каким-то образом например крутить запрос зависимости от того что находится в под запросим поэтому жить сам пришел лишь существующие варианты решение всего то естественно они есть можно просто писать специализированные модули носи как бы я потом еще расскажу подробности про это но смысл в том что писать специализировано модулю носила начнет кожа заново переписывать но это же трудно сделать именно как фреймворк это дело нам о личного сизо и модули довольно стандартные решения это когда у вас вы даете какую-то сложную логику на сторону и на этой стороне зала считает вам отдают результат но тут какие минусы нет сервисов то что рассказывал то есть все это request гривен опять разрозненное среда выполнения означает что у вас куча всяких отдельных приложений которые вы должны поддерживать следить за ними и так далее мы хотим чтобы все это работал внутри яндекса worker процессов и соответственно у вас дополнительные расходы на меж процессная либо сетевое взаимодействие между всеми этими компонентами существует еще спицы специализированные звуковые модули такие как луи джинс модуль довольно развитая вещь все его знают и думаю довольно сложной штукой писать можно но в нем опять-таки не сервисов и у него сложный прикладной интерфейс то есть для того чтобы писать что-то в конфиге какие-то вещи вам нужно знать всю-всю реализацию как бы движка внутренним джинсы нужно значит окуривает фаза субд access фазан примерно знать каким образом устроен запрос вот какие поля нем присутствуют в общем то это все очень сложно в этом модуле нет такого нет никаких сложностей там все фактически строковый интерфейс немножко отягощенный и статической типизации вот насчет первый вариант а писать модули прямо на оси какие здесь есть минусы я уже сказал но скажем так давайте рассмотрим как это все устроено внутри engine six обычной событийный механизм индекса это просто обертка над каким-то ядерным модулем типа и полая религию в psd вот и соответственно и пол такая штуковина которая позволяет вас если вы зарегистрируете file descriptor там-то позволяет следить что происходит этом file descriptor любой ваш ультом записи и чтения и так далее и соответственно может модифицировать пользователя до зарегистрировав шива снижение за событиями вот и собственно и весь смысл engine.exe как рабочего процесса заключается в том что просто берем эти события и и выполняем один за одним каким-то образом так как когда модификация происходит мы выполняем действия соответствующего таки был такой уделялось девочкой назначил что труса вас последовать для этих выполнений то есть он может быть это хранить города после модификации там могут быть короткие хендлера могут быть длинные от зеленые длинные с речкой и так далее но все это как бы некий последний процесс есть интерфейс у этой обертки до добавить событию дорисовывать события и некоторые таймер давай таймер таймер значит добавить событие довольно просто создать объект типа яндекс lnt левая сна зависит от idef и мы говорим о структуре я буду говорить это ты значит определить тип события что это такое для чего на что открытого файла диска это на чтение на запись и с от сорта некоторые флаги у него имеются дополнительные который ножкой изменяет поведение ну один из флагов либо то 0 до тус никаких флагов не дали была такой клиент клиент если использует пользоваться тестирование пола это просто h3 горит модель мы и будем использовать сервисных руках на чем отличается если говорить грубо той и сливал прыгает и 4 gold рыгает события это когда вас произошла какая возможна появилась возможность чтения допустим file descriptor и вам постоянно модифицирует об этом пока вы не посчитаете остригают это когда у вас пони тоффи церовани если вы не читаете вас больше не будут донимать короче вот в икеа это называю на пол так и называется с флаг я просто paypal знает и то есть двигает так значит соответственно и джеймса в н.п. эта штука которая на зарегистрировать и в них не передается как бы кастомная дам данные да как правило топе дается вот такой индекс collection ты вот это воет звездочка data and с это вот этот есть яндекс connections ну что тут уже как говорится что мы как бы изначально планируем обрабатывать события связанные с соединениями фактически тут как бы есть намек на request гривен операции мы мы звучим сервисов мы не собираемся вырабатывать request грифом операция собираемся просто обрабатывать фоновой не связанные с ним задачи но в любом случае нам 4 понял переход в конечность нужны потому что у таким образом сделано сделано обертка винт модулей джим и джон икса что они каким-то образом там упоминаются поэтому в своем составе на будет я не своем своих своей кастами дать она будет добавить эти четыре поля в любом случае так вот ручку что сустава всем этом не устраивает но низ колонны и код и необходимость своим писать каждом модуле почему там с могучей за ошибку достаточно легко все-таки си до то есть соответственно главная проблема на нет никакого интерфейса ли файлов конфигурации то есть вы ничего не можете сказать что я хочу там что то вот так вот обработать такое то событие то есть вся но это модуль который спрятан логика спрятано внутри какого-то сильного кода и можно есть не я на пятки соединением это она там не очень но тем не менее то есть как бы все это о том что нет сервисов говоря и вы можете случайно запуска запустить задачу нужен exe которая будет что-то долго ждать в синхронном режиме не и зарегистрирует ким образом что ваш контент просто будет заходить куда-то за информацией о до 80 отличает и вас весь ваш индекс vix повиснет пацан данной скажем так значит мы хотим сервиса дали фоновой задачи и мы хотим возможность объявлять эти сервисы прямо в конфигурации но тут пример небольшой значит на уровне ищи теперь мы говорим что мы хотим запустить сервис вот с таким названием значит название tni tni просто берется название она связана с именем объекта внутри эльф объекта да то есть с помощью далёком формируются мы хотим записать наши результат нашего сервиса в эту переменную reports that вот и соответственно последнее значение это это у нас какие-то данные которые мы передадим этому сервису данном случае это просто строка но это не строка этого сам интер она темперированная которой является портом куда отправлять статистику какой-то сервис куда отправлять статистику собственный я покажу пример который связан с этой c 30 записи значит и в каком-то селе мы считаем какой статистику мы будем почитали если мы как какой-то результат сервис склад записан так безопасный запуск запуск и он спал bound задач это что что такое тут мы хотим что вот эти длинные зеленые стрелочки никогда нам не попадались и чтобы все сложные задачи связанные с ожиданиями со всем прочим мы скидывали куда-то не важно куда что чтоб не повлияло бы на работу но основную работу engine.exe это вот это куда-то синие стрелочки зеленых на синие это в данном случае runtime система гостевая языка нам сочи хаскеле и утра буду рассказывать собственно каким образом их своих их соединить случае вытесняющего поняшка планировщика вообще все здорово потому что ну собственно уже внутри этой гостевой система она может и как быту согласовать эти задачи как хочет и вообще все вращается очень здорово а в каске кстати планировщик именно вытесняющий в каске runtime системе выдающий скажу так статической типизация данных вообще здорово . 1 данные мы можем типизировать и если у нас какая-то несоответствия какой-то не просто строка будет будет какая-то ошибка которая можем заблокировать вратами например и как-то отреагировать на этом мы хотим даже ищет интерфейса чтобы настраивать сервисы нам устанавливает запускать их допустим изменять их поведения каким-то образом так а вот это вот задача которой будет модельной на которой буду рассматривать сюда значит ну чем мы сделаем мы возьмем как бы на каждый запрос будем считать число nico nico nico nico nico то количество данных хотите число отправленных байт к число входящих запросов ну и так на всех на всякий случай просто для красоты средние значения больных байт поставщиками значит статистика будет обновляться при каждом клиентском запросе то есть клиент заходит на какой-то сервер нашего рекламной основной и мы статистику внутри усядет обновляем какой-то глобальном состоянии это глобальное состояние к с остальным кассовым кодом будет обеспечиваться и любыми периодически отправлять куда-то на внешний сервис то есть мы будем эти данные братья отправлять куда-то джейсону виде джейсон request a до дальнейшем эту задачу лучшим лучшим или изменим будем отправлять на встроенный сервис сами себе и замене самих у себя бы получать информацию о том что произошло до как какова статистика в дальнейшем мы напишем и степи интерфейс просто для сброс статистики то есть у нас будет локэйшн в котором будем заходить говорите я хочу чтобы статистика над раз читал азан то есть просто запросам через админскую консоль там допустим какой-то выделенный сервис будет сер к серверу виртуальный значит вот пример для этой задачи файла engine скол виден на белой две строки на уровне чиби мы просто загружаем библиотеку скомпилировав заранее да и запускаем сервис который будет report статистику то же самое что и показал до этого только здесь немножко по-другому собственно то же самое вот и simple service support станция название функции которые мы откроем с помощью dd люпин она будет сформировано с помощью шаблонного механизма шаблон шаблоне zero вание кода на хаскеле фактически нам одном явлении но создает кучу всяких функции дополнительных в том числе и эфа и настройку в фарш интерфейса для того что можно будет сказать гасим дальше вот эту хитрость я почему-то клуб я много чего урал до наук аромат оставил тоже здесь такая небольшая хитрость дело в том что яндекс hinder хендлеры переменных они ленивые если мы не используем перемена то мы как бы ее не посчитаем никогда а вот внутри сервера которые основного до которая на 80 10 марта у нас висит да мы запускаем синхронную задачу тоже на с помощью has коля которая просто создает переменную пример называется хаоса падает стать это примерно нас будет всегда пустая всегда пустая эта штука эта штука апдейт статься до самого функция она просто side of a side effect делает она просто подсчитывает статистику в глобальном состоянии тут же выходит она быстро и очень поэтому она синхронна запускается так вот патологии мы эту пустую переменную результат записан в конец мы влоги никогда ее не увидим в жизни но это нужно чтобы влог фазе яндекс запустил этот этот код и прочитал на статистику просто вот такой вот такой хак мы будем считать вот наш основатель что ничего не делали такие а вот здесь будет на сервер адаманта виртуальный в котором будем выводить что же у нас имеется до значение этой переменной сервисный да что он посчитали это был весь код на has no джин mangens конфигурации скажем так а я то весь ход код почти что на на хаскеле я тут убрал некоторые буквы там всякие настройки дополнительных как бы сказать the extension of которой у которых очень много в жилище сейчас собираются там from новые новую спецификацию принять наносить их старшина будут в нем но я просто убрал душе очень много но всякие разные не нужны им нужно ее они она как бы их очень много поэтому тоже был вот и деталь импорта не основные это вот как раз части х скального модуля который хаскеле модуль которую обеспечивают связь между 7 и остальными функциями 1 модуль это простые экспортирует так называемые они экспортируют именно хаски в ну как бы хищный интерфейс и уже изнутри engine сам может запускать эти функции второе это добавляет типизированные экспортеры плюс плюс еще как сказать она добавляет lifetime policy для сервисов треба объясню ниже ну а третий это просто такая совсем костаная вещь которая агрегирует являет никогда функции которые могут позволяют помогают агрегировать статистику по этому иску такой же большой получил потому что никто вещи за уже есть на счету статистика это глобальное состояние ее тип представляет себя три интернетом условные байт и количество запросов и соответственно строение значит строками ниже и стал сын stones from jason то джейсон после говорим что мы хотим чтобы он легко могли это рассматривать как джейсон без всяких написания постеров и так далее там ну там как бы джин дженерик держали происходит который здесь не видно и убрал но и импортирование и это очень легко работает вот этот статус это глобальное состояние она живет на протяжении всей жизни worker процесса то есть таким образом можем nova pure хрень состояния что очень тоже здорово она представляетесь из себя просто указатель на вот эту статистику которую мы будем обновлять апдейт stats это суп стал так штука которую обновляет статистику она очень простая у нее на входе имеется байт стринг строка которую мы передали и она просто рассчитывать новое значение для вот этих элементов датой стад и просто не просто выходит и при этом она очень быстрая поэтому он запускается синхронном синхронном виде а вот это уже сервис он очень сложно и с точки той точки зрения что он уже использовать типизацию статическую он принимает интрижек на вход он берет это ты как бы интерпретирует как порт и туда запуск помощью report облегает всю статистику отправляет куда-то и под облегает еще отправляет вместе с совсем со всеми остальными данными еще 5 процессор рабочего чтобы какой-то приемной сторона у нас могла и каким-то образом сортировать то что написано что экспорте довольно сложно типизированный вот и он запускается постоянно перезапускается к через пять секунд то есть пять секунд прошло мы как бы отдали статистику 5 очкам прошу снова дали вот как как представлялись что себя прислали жизненный цикл х скальной runtime системы и сервисов для того чтобы как объясни-ка все это работает я вообще пытаюсь на картинке это изобразить сначала открывается естественно вот этот м зеленой зеленой кружочки это мастер процесс engine сам он считает конфигурацию как известно если нужно он компилирует код нас dance record никого не компилируется поэтому это пропускается затем торкает worker еда рабочий процесс а рабочие процессы у себя внутри открывают далек он открывает все символы все функции все названия которые нужны из библиотеки которые скомпилирована который мы загрузили и запускают runtime хаскеле с помощью вот этой функции соответствовать зелененькая штучка это то что рисовал зелёными стрелками такая узкая полоса с мы не можем там сильно-сильно разойтись потому что у нас нет глубины а вот синее синее такая полоска большая да это runtime хаскеле он глубокий тут может быть сколько угодно на мы одновременно можем запустить их задач и ничего ему не будет как бы это естественно отдельные потоки но они работают в адресном пространстве рабочего процесса engineer значит данном примере мы запустили два сервиса с 1 из 2 вот здесь стрелочки которые такие корее коричневые толстые такие пунктирные да это означает что вы передан некий некоторые метаданные внутри внутри runtime а хаскеле это что что-то метаданные это фактически это выделенные в джинсе адреса куда мы будем записывать результаты но мы был заявишься записывать не результаты и и вычислениям и будут а записывать просто адреса который будет находиться в hosts эхо в хаски нам распоряжении аву хаски будет владельцем этого результата а мы будем просто передавать их адреса чтобы можем мы можем попрощайтесь и но это я ниже еще расскажу соответственно от с1 с2 запустились вот эти вот такие прямоугольнички закругленное это аналог тех стрелочек синих но и зачем вы мочкам на и слова вот они значение которыми работают например 55 секунд как у меня как было в предыдущем примере и когда все готово они там у себя кладут от этой точки до как обучалки показал результат лизе быстренько и больше ничем делают они да я забыл сказать что в первой строчке да в этой толстой мы передали мы открываем канал событийный сначала прежде всего событийный канал это если у вас есть возможность это винтов д либо это пайпа винтов да что такое он есть только в linux и он себя представляет канал для нотификации сообщениях все что вам можно править просто единицу там любой число 6 бит на lot of pipe и пайпинг как известно можно понять много чего вот но в нтд нас имеет как бы здесь имеет преимущество потому что в нтд мы не хотим передавать результат на самом деле мы хотим + intel что-то произошел и сам уже engine x-cop будет смотреть что произошло и и на наше и наши данные смотреть соответственно когда заканчивается совместном использованы в нтд когда заканчивается села и завершает свою задачу он в этот ивент fd пишет единицу здесь так показано он получил данные и записал единицу как только он запишет в engine management module и срабатывает хендлер события и у него теперь имеются данные о том где пал где результат хранится и он может его принципе доступ к нему получить вот не знаю может что-то пропустил но если что то спросите вопрос в вопросах начиталась тут с1 с2 два сервиса и они когда базарного работают у меня получилась абсолютно симметричная картина хотя это может быть немножко не так естественно кто-то может дольше работает а меньше но смысл в том что его не назвал обоих рабочих процессах будет одинаково симметричным значит конец когда у вас допустим здесь не вариант симметрично фолд около 7000 у нас будет у нас кажется газет не них и секс не сработает здесь просто мы завершили процесс и мы это не показано чтобы остановить наши сервиса мы запускаем такое сил асинхронно исключение worker process is exciting если наш код костанай перехватила исключение то он может выполнить и какие-то пера систем действия ну чтобы что-то сохранить там и так далее на следующий раз и только после того как мы посылали это исключение это хаски это хаски на исключение оно может касаться их принципе эссе какая разница вот мы запускаем хайес экзит который закрывает нашу runtime и после этого скрывается собственно и в ар крым вот тут значит небольшое как каким образом получить результат и собственно то есть мы в haskell сохранили где-то внутри его внутрь его в данных до потока но нам нужно эти данные каким-то образом получить ночной результат это l-лизин бассейн как называемый он совместим с обычными буферами си строкой но только этот список то есть там несколько чанков существует это все api нам нужна строка строка естественно тоже совместимости шный строкой там это , 40 плюс длина значит собстна все психи преобразование выполняет этот модуль экспорт которые создают экспортеры когда вы пишете кастомный код на хаски который показал то там все просто того у нас интера есть bull есть байт string для того чтобы все это работало нужно этот толстая коричневая старичка да где где все будет передаваться данные для того чтобы записать них результат но не самый результат они некие мета-данные связанные с ним соответственно оберточный код он намного намного сложнее он послал всякие pointer и куда будет записываться вот я взял две строки последние я пытался их рассказать что такое показать да тут первое это указатель на указатель да на нас на нан женскую строку мы просто когда получим blaze бойцы ринг наш результат после того как все он уже готов мы записываем в эти пойнтер и которые нам передала г-н дженкс сторона вы типа интера записываем адреса этих чанков соответственно их количество нужно знать это 2 2 panther ну вот эти это было ли исключения она там тоже я не буду в это сказали сильно и соответственно два важных указателя это pointer так называемый stay был по интеру на результирующую байту you строку но байта востока это собственно объект какой-то хаскеле да это не просто не просто чанки как всегда это все-таки какой-то объект но который может полива золото значит и возвращаемым значением это же оборачиваем , что же такое стал поттер это просто способ каски ли есть горбач коллектор если мы что-то посчитали и мы вышли оттуда у нас нет никакой гарантии что этот результат не будет удален через некотрое время либо вообще сразу а мы хотим им пользовался известно как только мы берем stay был патриарх помощи ньютом создаем внутри х скального кода обертки как только мы своем стоит бтр мы как бы говорим пользуемся этим объектом мы можем его восстановить когда тебе понадобится это гарантирует то что он не будет удален до того момента когда нам это понадобится реально вот соответственно еще такой момент черный момент значит спецификация по поводу стоит был поттер обещает что объект будет восстановлен но она ничего не говорит существует ли объект между восстановлением и и тем когда создали только это такой труда соответственно мы опять-таки камю камю был гарантирую что наши бойцы которым будем пользоваться будет в правильном состоянии есть слава богу гарантия потому что быстренько используют так называемую пинт мэра это означает прикрепленная память она гарантию что garbage collector и не трогает соответственно она будет жить до тех пор пока stay был pointer не удалится оставил пойнтера мы будем удалять внутри хендлера внутри ну до событий на хендера индекса когда нам перезапускать сервис значит внизу основа чанков а у нас сказать интерфейс переменой мы должны их все в один как бы скопировать вот не всегда так а например в контейнерах мы можем напрямую использую чемп к к к к к к к для того чтобы отдавать постепенно до патча на кого в ответим в нашем случае могущим к приводится к нам просто и был пойнтер из листа и был понтормо удалили то в следующем сборщики цикла мусора хаскеле удалить все данные связанные с ним в том числе и наши чанки все эти случая если у нас несет не сервис синхронной задача у них и не рассказывают он по сервисам тем не менее мы этот стиль был пантера удаляем так называемый клином хиндли запроса есть такой есть такой специфичная специфичная штуковина в engine.exe когда вы завершаете запрос у вас есть возможность каким-то образом сделать деструктор если вам нужно нужно удалить это данный решил сотворить у вас есть гарантии что деструктор будет вызван вот это в этом что-то типа деструктора там удаляем стаи был пантера и больше не заботимся о наших данных которые нам больше не нужны в случае сервисов там есть такой момент они могут запуститься они каждые пять секунд за перезапускается допустим а если у вас сейчас какое-то и к используются этими данными variables in дали он взял это указатель на эту переменную им и пользуется что делать в этом случае мы просто делаем копию на ней на некий выделенный ресурс не купила скажем так делаем подсчет ссылок если как только задается значение мы значит значение счётчика салака увеличиваем как только кто-то им пользуется еще с увеличим в клином хендри когда request выходит мы уменьшаем и когда наступает следующий событиям это же уменьшаем этот счетчик и соответственно он удаляется у нас гарантированно когда никто не пользуется и когда больше там много безопасности я некоторые только написал сущий до что будет если еще по на file descriptor она нам нужен либо ивентов до либо pipe нам нужно как минимум один file descriptor вот в этом случае у нас есть возможность понадобилось немного и попробуй слов просто мы не должны не должны складывать из этого сервис мы используем джейкс от таймера он к счастью никаких файла дескрипторов не требует дополнительно открывать так звучит если какая-то произошел exception to the не можем выпустить наружу и заяц и из хаски она го года потому что синий значит не делать вообще вот соответственно все exception ловится внутри обертки у нас есть трогает статической типизация в возможного типа инстанции ритм 100 соответственно просто хаскин ее термо и либо джейсон что тоже как бы вкладку делает класс безопасности грейсон shutdown тоже ohc возможность есть сделать ассистенты акции если мы выходим и сын джеймс и я уже про это говорил с помощью такого синхронного уведомления рабочим рабочим сервисом хаски значит пример запроса два раза сходили на сервис и посмотрели на другом на двадцатом примеры стала запроса где на десятом висит основой сервис на двадцатом мы можем всякие с моей штуки всё вроде бы хорошо но вот кто он знает тут есть фатальные фатальная ошибка и фатальный недостаток чем тут проблема ну что-то знает сразу ну в общем я могу подсказать такая подсказка хорошая почитала может быть может быть будет понятно если мы как в репорт облегает здесь добавили данная периоде все было бы понятно смысл в том что мы падаем мы можем попасть на один в locker если у нас много можем попасть на другой worker в один раз получим что отрекается 2 в другой раз зайдем и удивимся что локации косов у нас ноль и как бы нету нет ни kanebo sensai так далее дело в том что эта штука оно как бы по walkure на и именно именно вот этот вот результат перемены по другому там никак не сделать и за признана нужно сделать что-нибудь что можно чтобы можно было с агрегировать данные либо загримировать либо и каким-то образом параметризовать мопеде для этого существуют так называемый разделяемый сервиса когда вас один сервис работает на всех не на всех она но на одном из рабочих процессов на других он не активен вот для того чтобы вот но здесь собственно хотим что здесь в дальнейшем дальнейшем мы улучшаем пример и хотим создать сервис который будет собирать статистику уже не уже не внешне а внутри он будет изнутри собираю статистику у него есть типизированные входные данные вот это дал случае хаскел термы они не некое некоего скажем риккардо агрегат серого комфорта он ожидает у него есть порт на котором будет слушать а также есть про же интервал от когда выступаем умирают какие-то вагоне вы не хотите хотите долго хранить статистику и через пять минут если кто-то не ответил просто эти данные об этом периоде удаляются вот значит мы будем сушить на на тоже порту из уст заменим на прокси пас если кто-то зайдет на 820 он зайдет на этот сервер на самом деле это самые самые типичные веб-сервер которые достаточно быстро и так далее то снег framework и он работ работа нас прямо внутри одного из в киров hasky hasky индекса все что нужно сделать в каске на модуле добавить такую строчку эта штука просто воздвигается на с помощью шаблонного кода она ожидает стад статься это означает что вот у нас слушать о первых прокси по смогет стации во вторых что там еще начать раздобыл но неважно значит это всего одна строка значит разделяем и сервис и гарантия на имеют один экземпляр если у вас допустим какой-то процесс самолет а там была активность активная уделяем сервис кто-то другой подхватит и и просто гарантия что что это будет всегда так гарантию предоставляет пузик со 2 игры файл локи то есть мы рисуем на этих лаках ждем когда ждем и процесс который не активно ждет когда предоставится возможность захватить его и запустится улучшает сервиса запускаю записывать результат вычисления разделяемая память это логично принципе вот жизненный цикл будет показана из 11 мы здесь превратили в разделяемый сервисы вот на первом блоке я на верхнем он работает вполне себе активно а на втором он такой замороженный он ждет файл когда файлов освободиться и допустим 1 1 вот у нас выходит вот хаяси где произошел и вторую после выхода после завершения зеленые полосы запускается вот соответственно это может быть новый worker который исполнился да а может быть какой-то который уже слышал это небольшой фрагмент сессии но собственно запустили 100 одновременных процессов и процессов этих самых запросов на основной сервер и посмотрели что это вот он же сон 8022 проксирование сервер который направляет нас на наш внутренний сервер на которую находится с на фреймворке который агрегирует данные и же pedi какие были валовой прибыли 5 9 10 и 5 9 11 пишет таймс темпа и бежит какие данные 11 из worker of большого дела всем запросам другой то и но и так это нормально ситуация так так вот так вот в в линуксе происходит так значит давайте напишем что то что позволит нам сбросить наши данные нам примерно мужчин даем смотри что же очень много данных мы хотим с нуля начать не хотим да и запускать сервер яндекс и просто мой для этого создаем локейшн который называем reset в этом же административном сервер виртуальном которые новости20 пишем для него соответственно под на хаскеле довольно простой он про он просто этот глобальное состояние в ноль приводит и после этого все готово мы можем запускать заходить на ари сет после этого будет сразу же сразу же буквально вы получите нулевые значения как только вы будете смотреть вдаль и оч это пример объявления хука на эту в предыдущем варианте не было никаких зон золото шея днем резона здесь она появилась потому что если передаем данные да то есть для того чтобы все все все walkure и посчитали одновременно надо шума них чтобы данное хранились где-то в обмен эти данные могут быть связать времена и так далее поскольку это request driving a server service кокона request гривен как бы обработчик потому что ну как бы обрабатывать за ваш запрос административной принципе сервиса припаиваются вот таким вот асинхронным исключением дал случае нам не нужно прерывать но так и сделано в любом случае они должны посчитать новое состояние что они хотят и перезапустится так значит а как же как так работает что мы зашли вот на один сервер на один буквально вот когда как в итоге у нас же все worker и к вы получили новое состояние то есть здесь здесь такой небольшой трюк что если мы мастер процессе создадим файловые дескрипторы то они у наследуются при фотки в рабочих процессах и соответственно все события которые привязаны к этому файлом дескрипторы будут распространяться на все walkure и известно если мы на 11 walkure зашли сказать ему что-то сделать это же это же событие будет бы во всех блоках точно также обработано есть еще так называемый сервисных у кота когда он просто какое-то глобальное состояние хотим обновить на на разделяемым сервисе и но я не здесь его не показывал в примере поэтому то чисто для информации но ты такой тоже вопросу что будет вот допустим запустили мы процессы до сети нашей рабочие все классно работает несколько раз зашли на lisette допустим и на что-то еще подобное носят плохой пример нам случае но что также что повлияет на сервис и в одно мгновение какое-то у нас допустим рабочий процесс сервисом с активным сервисом умирает на него на место него приходит какой-то ожидающий процесс он все эти события как бы пропустил то есть он не знает ничего них вот что что что будет 8 как бы заново заново начнем сервис с нуля до то есть мы забудем то что мы настраивали это на самом деле не так потому что мы здесь как раз используем есть три геринг модель и пола и фактически она в каком-то смысле как машина времени до того как вы его его не прочтешь это состояние а мы его не читаем ну так специально сделано что мы его не читаем до следующего события которые и запуск и перезапускает когда состояние сервисом и его не читаем и соответственно она хранится как только сервисного и запускается исполнится он это событие получает сразу же автоматически и он может как бы и вас тут же применить совместно как бы по идущие немножко напоминает квантовую запутанность исказить как бы объектами квантовыми являются вот эти вот в файл вы файловые дескрипторы которые одновременно я одно целое одновременно не разрозненные и соответственно мы можем запускать из из прошлого ну в общем понятно что то сам уже запутался но смысл том чтобы из прошлого можем прошлые события как бы записать и за перезапустить сервиса с этими прошлыми событиями которые произошли до того как вообще еще существовал фактически так плюсы и минусы yax слава богу мамону закачиваю плюсы и минусы hasky hasky hasky такой язык я думаю 7 известен ну как бы мало кто его возможно это обследование появилось много любителей вот и профессионал тоже плюс и его зелёные потоки да то есть это то что я говорил что ртс до позволяет запускать огромное количество потоков и это не страшно потому что они не используют системные потоки это просто у него свой скин который каким-то образом абьюза спейси их а тасует значит это к тому же точно стоят с стесняющие поняшками задач . - у машины клод это очень здорово мы можем использовать просто подгружать помощью дрели у пана библиотеку и все очень хорошо скорость у вас будет соответственно хорошая если вы там конечно со всякими не попадете в известные капканы типологию и шины и так далее то есть как бы нужно таки знать на скорее это это даже каком смысле минус то есть хорошо понимать что происходит у вас с вычислительным процессом внутри строгая система типов да тоже существует это это очень хорошо когда асинхронной задача и вы допустим пишете код который вы хотите чтобы ожидал на чем-то примерно событий вы тогда можете с помощью задания типов гарантировать что у вас не будет никаких эффектов внутри вот этого кода то есть вы можете него не смотреть просто смотреть на тебе скажет вам ничего такого не не будет никаких ожиданий даже минус это вот эти вот не привычной концепции там математика теории категорий на все ерунда потому что принципе просто как бы нужно получить ничего страшного там уже не там также под не используется сборщик мусора может элемент непредсказуемости это правда то есть можно пускать когда угодно и он поэтому стоп зе ворлд да ну как бы сейчас идет улучшение этого сборщика в следующей версии они выпустят параллельной воде как для старых поколений объектов будет параллельной сборы это как бы очень сильно улучшит юзабилити ну зарезал не люди большое количество данных это тоже будет как новая сейчас все поправят не просил программ комитет немного прохазка production сказать ну суп стал то есть такой ресурс на нем можно увидеть что всякие товарищи довольно известная пустых выписал и использует его в какой-то мере кто-то продакшен тут еще чем то наверное очень часто часто используется финансовой среде барклайс standard chartered bank и и какие-то финансовые организации стандарт чат кстате это были люди которые проспонсировали изменения внутри гарбич коллекторы погадаю то что говорил что тоже очень радует очень известный пример facebook 7 этаж anti-fraud система которая facebook используются тоже написано haskell она и ту же естественно продакшене и соответственно чем она известна так хорошо потому что они не стесняются и по все это в блогах пишут рассказывает как с какими трудностями столкнулись какие баги джеси по пофиксили и так далее это очень здорово вот есть наша организация петшоп тоже называется вот мне николай кудасов предоставил мне эту информацию они используют х скрины продакшене у них насколько я понимаю какие-то рекламные рекламные сервисы вот и ночных сервисами написан оступаться на каско на серванте очень но не очень может не знаем хорошая такая нагрузка от но это не за себя говорю поэтому так получается я не могу отвечать за других использовать для логики плане запросу в основном конфигурацию на у них написана на языке дышал это такая штуковина которая тоже написано свою очередь на хаски и она известна тем что она тюнинг неполная и они этим гордятся ну там спецификой если если почитайте на достаточно интересно в итоге здесь у нас получилось что написали синхронный фреймворк с простой асинхронной семантикой и соответственно можем выпускать ограниченное количество задач это хорошо поэтому не боятся что они там затормозят наши жены касс основной основной горкой процесс значит мы можем эти все задачи легко записывать конфигурация как они будут запускаться и как они будет настраиваться и так далее у нас есть разделяем а сервисы с надежной схемой перезапуска за счет этих файлов есть надёжная реализация сервисных рукав это вот эти вот api и у нас есть оптимизируй обмен данными без всякого копирования что вообще очень здорово вот это последний слайд здесь код проекта на гитхабе есть у меня ссылка вот эти модули которая не входит естественно в проект но их также можно по отдельности поставить помощью кабал простую систему это хаскин ее модули самое последнее такая небольшая небольшой баловство это как бы реализация дашбордов у себя в блоге описал с помощью языка как бы и реактивной программе мы там не всякий шайни то есть как бы такая динамическая картинка это как бы все спасибо вот если есть вопросы благодарим нашего спикера за его доклад но к сожалению время приходит концу и времени на вопросов у нас не осталось получился но вы не переживайте у нас есть я дам дискуссионная зода и я считаю что надо наградить нашего спикера об аде смерть но естественно luja святые вы уже рык родили можно еще раз да ну и небольшой презент от highload ошибок и сумка спасибо благодарю за первый клад"
}