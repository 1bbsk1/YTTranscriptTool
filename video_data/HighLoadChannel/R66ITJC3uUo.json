{
  "video_id": "R66ITJC3uUo",
  "channel": "HighLoadChannel",
  "title": "VK Звонки: оцениваем качество видео объективно / Алексей Шпагин (ВКонтакте, VK)",
  "views": 247,
  "duration": 2704,
  "published": "2024-04-17T01:10:18-07:00",
  "text": "один из долгожданных докладов для меня лично в нашем зале Алексей будет рассказывать про один из сервисов которые мы ВК очень гордимся про ВК звонки Давайте встретим его Алексей Здравствуйте коллеги А сегодня хотел бы вам рассказать о том как мы ВК звонках измеряем качество видео а два слова обо мне Я руковожу командой бэнда проекта VK звонки в целом в средствах связи в видеозвонках в ip-телефонии Я работаю порядка 10 лет начинал Я как c++ разработчик моя команда и я лично разрабатывали Медиа сервисы сервисы по работе собственно с медийными данными звук видео а-а значит постепенно Я перешёл э-э в менеджеры этим Лиды потом в инженерных менеджеры и соответственно сейчас вот на данный момент руковожу командами порядка пяти лет для кого же Хмм сегодняшний мой доклад значит ну в первую очередь Наверное он для специалистов в области видео это может быть видеохостинг Клауд гейминг что видео стриминг что-то ещё я надеюсь что та информация которую я дам по тем методом оценки качества видео которые мы применяем Надеюсь что она будет полезна э-э и другим специалистам э-э в этой области Но кроме узких специалистов на самом деле я так подумал что ведь сейчас наверное нету ни одного it-специалиста который бы не участвовал в митингах и не пользовался бы видеозвонками как каким-либо сервисом Zoom Google МИД ещё что-то и Вы наверняка все наблюдали вот такую вот картину вы в звонке кого-то не видно кого-то видно плохо у кого-то артефакты у кого-то мутное всё И вот в своём докладе я в том числе попытаюсь м-м немножко приоткрыть Вот эту вот пространство так сказать под капотное и рассказать как вот работают звонки А ну например и нашего сервиса он на самом деле принципы они в общем-то схожи для других сервисов И почему же вот получается вот Такие артефакты в видео и как с ними э-э можно побороться а пара слов про наш сервис выказываем Ким а-а значит это сервис для видеоконференц-связи можно звонить perto pierra со звуком только можно включать видео можно делать групповые звонки в том числе наши звонки подходят для обучения для всех видов рабочих встреч у нас даже есть клиент нас есть клиентские приложения под все платформы в том числе есть приложение для комнат для конференс комнат и хочу сказать что мы сами внутри ВКонтакте пользуемся нашими ВК звонками сейчас на ежедневной основе То есть это основной наш рабочий инструмент все совещания рабочие собеседование с кандидатами просто какое-то общение происходит сейчас всё в ВК а Еще минутка рекламы я на предыдущем хайлоде который был осенью 22 года делал доклад про оценку качества звука вот Дело в том что есть очень много общего между общего в том как передается видео и звук то есть там детали звука и видео конечно немножко разные но есть общие моменты по передаче через интернет звука и видео поэтому э в данном текущем докладе Я некоторые моменты сокращу и буду делать отсылки вот к этому докладу который был осенью поэтому значит первая ссылка слева - это собственно ссылка на сам доклад в системе highload значит и Кроме того мы с коллегами из зонтика опубликовали нахабре статью э по материалам вот этого доклада поэтому тоже вот рекламирую ссылочка на слайде а Итак что же мы с вами сегодня посмотрим а первое посмотрим Из чего складывается качество видео Какие составляющие его а второе а Посмотрим Почему вообще может снижаться качество видео почему оно снижается дальше посмотрим а как что мы можем сделать мы как разработчики сервисов что мы можем сделать чтобы качество видео сохранить А И последнее это собственно основная наверное часть доклада посмотрим А как же измерить а-а качество видео Итак поехали с первого раздела про качество видео нужно сделать небольшую оговорку что мы будем говорить только про видеозвонки и видео в контексте видеозвонков то есть мы не будем рассматривать там какой-то видеохостинг Cloud Gaming еще что-то а в свою очередь для видеозвонков основной паттерн это вот я его так называю в кавычках Говорящая голова и собственно говоря вот на представлена на слайде вот этот вот симпатичный молодой человек нам поможет сейчас посмотреть а из чего же складывается качество видео Итак первое самое на самом деле очевидное может быть слайд такой капитанский немножко это разрешение картинки значит соответственно 720p картинка относительно большая много деталей всё видно Всё хорошо значит справа картинка она уменьшена но она уменьшена из сделано из большой картинки Поэтому в ней тоже всё ещё более или менее нормально но в целом понятно что чем картинка больше чем для пользователя лучше Вот но интересно следующий слайд значит здесь ситуация следующая здесь из исходно маленькой картинки исходно маленькой картинки растянули большую и вот что получается то есть значит мыльная все плохо видно какие-то квадраты вот значит мы вот потеряли это достаточно может быть тоже очевидно тем не менее вот вопрос разрешения хотелось Так вот проговорить явно а следующее это степень сжатия или битрейт значит картинка слева хорошая качественная 2 мегабита в секунду но достаточно жирная 2 мегабита это относительно много значит справа картинка очень сильно пережата 62 к- Зато маленькая по объёму 62 КБ Вот Но зато квадраты это уже всё плохо и качественный конечно правую картинку назвать тяжело а это такой слайд шутка Это как бывает на То есть тут растут совсем все плохо Тут и низкое разрешение 168 пи И зажата вообще Значит до 16 килобит это это реально очень маленький поток Ну и вот результат соответствующий то есть пользователи часто видит что-то вот такое вот конечно же Наша задача Так не делать поговорим дальше про количество кадров в секунду А собственно посмотрим на конкретных примерах Вот например видео два кадра в секунду вот лично у меня такое видео вызывает ощущение Ну какого-то технического сбоя каких-то проблем Ну то есть явно что-то не прогружается тормозит Ну в общем то есть плохо Вот технически плохо вот идёмте дальше а-а следующий пример 8 FPS Значит тут уже дело получше но в целом всё равно двигается немножко рывками я бы сказал что это дискомфортно то есть более-менее аплика был но дискомфортно Пойдёмте дальше 15 фпс Вот это уже более-менее нормально для видео с веб-камера Если вот мы говорим про видеозвонки это в принципе даже более-менее хорошо я характеризую такой вот FPS как удовлетворительно а и вот еще пример 30 фпс это как бы совсем на пятёрку это совсем отлично опять же Ну мы не говорим про окуню гейминг где может быть лучше 60 для вот камеры для такого говорящей головы 30 Просто отлично Вот но естественно нужно понимать что чем больше у нас кадров в секунду тем больше объём этого видео и мы впоследствии сейчас мы про это поговорим а мы будем снижать FPS в угоду соответственно э-э уменьшению э объёма видео и соответственно э подстрахуем подстраиваться под полосу Но это чуть позже а значит подведём промежуточный итог по этому разделу Из чего состоит качество видео первое из разрешения картинки Чем больше тем лучше а из степень сжатия Чем меньше зажимаем тем лучше но он вынуждены сжимать ролл видео Мы никогда не в сеть не пытаемся загнать потому что это будет совсем безумно большой объём А значит количество кадров в секунду Чем больше тем лучше но естественно чем больше кадров тем больше объем тоже помним про это и важна комбинация этих параметров что я понимаю под комбинацией например это вот как в первом примере с двумя FPS картинка была четкая большого разрешения но мало FPS то есть пользователь конечно же скажет что это картинка некачественная И наоборот если будет много FPS но при этом разрешение будет маленькое и всем будет мутная пользователь также скажет что э-э ну общее впечатление от видео негативное вот Пойдемте дальше посмотрим А почему же снижается качество видео первый момент мы уже об этом говорили мы не пытаемся протолкнуть все эти ролл видео всегда есть кодек кодек всегда нам немножко портит нашу картинку мы можем настраивать насколько будет высокая степень сжатия и насколько нам кодек э картинку испортит следующий момент а-а при кодировании видео У нас есть так называемые ключевые кадры и некие Дельта кадры э-э которые кодируют не весь кадр а только div э между ключевым кадром и текущим а-а значит вот на этом разделе на самом деле подробно Останавливаться не буду это такая широко открытая информация Вы можете если вам интересно прочитать детальнее по вот эти вот айфреймы там ещё бифреймы Но они в нашем наших видеозвонках не используются вот я же немножко дальше проскочу здесь побыстрее а значит что хочется сказать что ключевые кадры они на самом деле э-э занимают больше всего сетевого трафика потому что это фактически кодирование целой картинки и вот снизу вот под кадрами вот эти маленькие синенькие квадратики - это пакетики Вот соответственно видно что ключевые кадры занимают больше пакетиков Дельта кадры занимают меньше пакетиков и э на что же это влияет В чём собственно говоря проблема вот а проблема в том что в наших сетях особенно в реальной жизни не в лаборатории не в синтетике А вот в реальной жизни у нас с вами существует пропадание пакетов пакет-лосс нас существует дрожание в сети существует задержка существует перестановка пакетов местами А вот как вот показано на картинке например пакет i3 он вообще пропал А значит и а i3 - это кусок э ключевого кадра iframe и получается вот по картинке что мы вообще не можем восстановить э-э наш ключевые кадр И вообще всё пропало Вот кстати говоря подробнее может быть тоже чуть-чуть подробнее я рассказываю про вот эти сетевые аспекты в докладе про звук там проблемы претерпевают собственно за пакеты со звуком Но в данном случае не важно проблемы все те же самые значит хочу вам показать парочку примеров то есть вот как выглядит то что что-то в сети пошло не так и какие-то пакеты пропали значит пример первый такой лайтовый для начала значит вот эта картинка хорошая То есть это пока ничего не пропало и раз следующий кадр уже видимо артефакты что-то зелёное какие-то пошли квадраты артефакты Вот вот так может немножко под развалиться картинка вот вследствие некоторых сетевых проблем Вот и следующий пример немножко пожёстче это скриншонг собственно демонстрации экрана Вот и тут у нас что-то всё как бы всё совсем плохо Вот что-то потеряли всё развалилось ничего не видно э пользователи жалуются подведем короткий промежуточный итог по вот этому разделу из-за чего же у нас может снижаться качество видео первое значит данные у нас передаются в реальном времени То есть у нас один пользователь что-то сказал его изображение закапчилось и нам надо быстро быстро его передать дальше в сторону следующим другим пользователям поэтому у нас нету возможности что-то длительно восстанавливать что-то ждать буферизировать и так далее То есть у нас Real Time надо быстро проталкивать в сеть все а следующее значит перед передачей видео оно зажимается кодеком Априори снижается качество картинки при сжатии значит э-э при потере в сети у нас наблюдаются артефакты Ну мы собственно вот это видели на примерах А И последнее значит Проблема в том что у нас есть ключевые кадры и они самые жирные соответственно раз они самые жирные у них вероятность того что с ними в сети что-то случится что мы не сможем протолкнуть именно ключевой кадр она наиболее вероятно то что испортится Дельта кадр естественно тоже есть вероятность но она там немножко меньше предположим вот а ключевые кадры и проблема в том что ключевые кадры самые ценные самые ценные а при этом есть вероятность их потерять вот такое вот такие вот проблемы и перейдем к следующему разделу значит что делать то есть как нам это качество видео всё-таки сохранить несмотря на ту проблематику которую мы обозначили самый простой первый э долго Останавливаться не буду первым момента jetter буфер это вообще Маст хэв Это для звука для видео всегда нужно всё-таки немножко накопить данных э подождать какие-то пакетики которые доходят но делать это надо в разумных пределах Потому что если у нас будет слишком большой jetper у нас возрастёт лейтонси опять же вот в докладе про звук я рассказываю может быть чуть-чуть более подробно почему лейтонсе Что такое Лейтон или как вот джипер баффер нам э его так сказать увеличивает и так далее сейчас позволю себе немножко проскочить здесь вот нак негатив окно legement значит это технология Ну да Сам на самом деле очень простая То есть если мы видим что пакет пропал Мы можем перезапросить какой-то пакет опять же в докладе про звук рассказываю чуть-чуть подробнее вот сейчас немножко так поверхностно проскочу А вот это фича уже поинтереснее называется фир э-э Full Inter request это запрос ключевого кадра то есть вот ситуации когда Допустим мы потеряли какие-то пакеты не можем их восстановить и не можем соответственно докодировать ключевые кадр мы можем попросить э передатчик прислать нам ключевой кадр заново в этом смысле обнуляются все промежуточные фреймы все Дельта фреймы сбрасываются начинаем с чистого листа просто кодировать с ключевого кадра а следующая фиг Форвард correction ну этот такая штука она математически может быть сложная для понимания она простая то есть мы добавляем некие редандант данные к нашим при кодировании такие что при декодировании мы можем восстановить часть данных если последующие пакеты потерялись то есть и там пакете содержатся дополнительные данные которые мы можем использовать для декодирования если и плюс первый пакет у нас пропал в сети например естественно работает в некоторых ограниченных пределах э-э потому что ну то есть много редан данных увеличит слишком битрейт поэтому конечно же всё это ограничено мы вот используем в upfact Например э-э если брать конкретно говорить о технологиях вот следующая так называемые временные слои это интересная такая штука это грубо говоря в одном стриме видео кодируется сразу а два или более это настраивается два или более таких под стрима и эти допустим два возьмем и вот эти два под стрима они идут с разным FPS то есть кодируется с нормальным фпс Стрим А еще есть как бы прореженный Стрим который с меньшим FPS но при этом когда у нас есть потери в сети а высока вероятность что пропадет пакет из какого-то одного слоя а из второго не пропадёт и соответственно и даже если у нас допустим пропадают пакеты из слоя с высоким FPS мы можем снизив FPS но всё равно мы сможем поток как бы спасти в кавычках то есть мы просто докодируем кадры из потока из более низкими FPS User Возможно это заметит что снизилась количество кадров в секунду но тем не менее хотя бы не будет там чёрного экрана ещё чего-то какого-то разрыва явного а всё-таки э видео поток продолжит своё существование а-а следующее такая технология называется транспорт кондэшн-контрол вообще это очень большая тема она заслуживает отдельного доклада А сейчас я только намекаю основную идею значит идея в том чтобы чтобы определить полосу пропускания между сервером и пользователем и подстроить качество видео под эту полосу А если мы вспомним первый раздел из чего зависит нас качество видео это разрешение степень сжатия там количество кадров в секунду вот мы можем играть вот этими параметрами например можем чуть-чуть поменьше по размеру сделать изображение тогда битрейт снизится и может быть в плохую сеть это видео пролезет Можем немножко побольше сжать например э-э соответственно тоже может пролезть А можем снизить FPS но снижая FPS слишком сильно опять же вспоминаем первый раздел мы можем так сказать пользователю не угодить сделать плохо потому что Если слишком низкий Face пользователь не понравится вот поэтому штука тонкая э-э везде там нужен баланс вот этих параметров Э что именно мы будем менять пытаясь просунуть Наше видео в полосу Вот в общем куча эвристик тонкая штука но но и как бы эффективная хорошая Итак посмотрим теперь кратко итоги по вот этому разделу что мы можем сделать для сохранения качества видео первое Значит есть методы компенсации сетевых проблем ну так скажем общего назначения это вот различные перезапросы этот джипер буфер они опять же почему общего потому что они используются в разных доменах и тоже для звука и для видео и других каких-то вещах вот есть методы специфичные для видео например вот тот самый эфир Full interre request tempro scalability что-то ещё вот есть специфика вот есть редант информации это Фиг И на самом деле я отдельный слайд не делал Если ещё так называемый Red это напрямую от слова редандон Red вот используется иногда комбинации фека и эда а и э последняя мощная штука - это подстройка под условия сети Вот то есть Измеряя сеть мы можем подстроить Наше видео вот это вот сеть Итак подойдем к нашему наверное основному самому интересному разделу это собственно сами измерения как вот мы измеряем качество видео должен здесь опять сделать небольшую оговорку Может чуть более подробно на этот раз мы будем рассматривать только видео в контексте видеозвонков То есть это паттерн Говорящая голова мы не будем здесь говорить про видеохостинги про Cloud Gaming не будем говорить про излишний динамичное изображение как допустим спорт там гонки какие-нибудь ещё что-то Вот потому что измерение э на самом деле измерения качества видео оно отчасти зависит от содержания этого видео Вот и то есть есть специфика своя слишком динамичном изображении вот мы будем работать вот с таким вот изображением как повторюсь ещё раз Говорящая голова а кроме того значит мы используем для измерения нашего видео а-а метрики на базе референса Вот мы сейчас естественно подробно рассмотрим что это такое Вот Но есть ещё без референсные метрики которые вот Ну так сказать мы их мы ими не пользуемся это как бы просто для информации мы только на основе референса Итак как же выглядит наш стенд для оценки качества видео но это на самом деле стенд будет еще более подробно это функциональная схема значит просто принцип Да какой Значит мы подаем некий референс в звонок из звонка выходит видео с некоторым искажением искажения возникают это подробно посмотрели из-за того что у нас кодек из-за того что у нас сеть у нас всё плохо значит и мы получаем искажённые видео потом мы подаём в алгоритм оценки и референсные видео искажённое видео и алгоритм оценки соответственно выдаёт нам э нашу оценку А теперь поподробнее посмотрим а-а вот я сказал подаём референс в звонок А что же что это значит как непосредственно мы подаём А значит тут есть следующий подходы значит можно использовать встроенные средства приложения например Google позволяет прочитать видео из файла и засунуть его в качестве условно виртуальной камеры То есть просто подпекнуть вместо камеры это в тестовых целях значит но это возможно если у нас Клиент не на Google Chrome Да там что нам делать то есть нас нет такой возможности вот если это наш клиент наше приложение мы Понятно Можем написать туда такой код который читает из файла например но если мы говорим про стороннее приложение то есть мы хотим допустим сравнить наше приложение со сторонним приложением то получается что стороннее приложение мы уже э ну и этим путём пойти не сможем для стороннего приложения вот а поэтому есть значит альтернатива можно использовать какую-то внешнюю камеру и тут есть два варианта либо это м-м виртуальная камера на основе какого-то софта например obs или виртуальную камеру можно в принципе написать самому Вот либо можно использовать физическое устройство какое-то например э Разбери пай вот у нас был такой опыт это интересно э то есть э действительно Малинка подключается в компьютер симулирует камеру вот и это всё здорово это на самом деле наиболее Мне кажется технологичной и более такой правильный А подход но он сложен это надо разрабатывать нужно ментейнить эти разбери э если это автотесты то они должны подниматься автоматически В общем это сложновато но можно делать Вот теперь второй вопрос как же нам захватить видео на приёмной стороне Значит тут тоже есть принципиально два подхода в общем-то такие же как предыдущие То есть можно воспользоваться функциями приложения если это наше приложение то мы можем сделать запись файл если это не наше приложение то тоже Значит так не получится а переходим так сказать ко второму варианту это захват внешними какими-то средствами значит можно захватывать экран просто весь у этого есть недостатки а можно а взять устройство которое Хмм называется HDMI capture и для приложения это будет выглядеть как просто монитор на который приложение это видео показывает а по факту мы там Файлик откладываем его вот с помощью такой коробочки чёрненькой вот Пойдемте дальше посмотрим какие же инструменты для измерения мы используем вот на самом деле мы используем два основных инструмента Первая это персонар это такой на самом деле старый добрый способ его наверное все кто с качеством видео как-то взаимодействует Вот они его знают с ним работают значит он по факту оценивает не видео как таковой А по кадрам То есть он оценивает картинки на самом деле Вот и второе инструмент который мы используем это вимаф это уже штука поинтереснее это алгоритм от компании netflix а сейчас наверное вот он наиболее такое распространённый м-м неплохая штука значит но сравнение тоже по кадровое как его пересаров и мы сейчас увидим с вами как вот мы готовим наш референс с учётом вот этой оговорки что мы сравниваем по кадру но перед этим посмотрим как устроен наш стенд Чуть более детально значит вот этот человечек в углу это наш кью инженер или разработчик который хочет оценить качество видео сейчас и он идет в тимсити и запускает жопу teamcity поднимает тестового клиента номер один и тестовый клиент номер один делает звонок в нашу систему система может быть в лаборатории может быть продакшн система это выбирает человечек выбирает это э в Тим Сити на каком контуре он так сказать собирается делать тестовый звонок значит система соответственно наша она э делает исходящий звонок в сторону тестового клиента номер два э между ними устанавливается связь по сигналингу и соответственно начинает ходить Медика то есть аудио видео после этого Медика пошла значит тестовый клиент номер один проигрывает референсное видео э значит в сторону э-э нашей системы А наша система соответственно а-а полученное видео соответственно загоняет тестового клиента номер два таким образом тестовый клиент номер два он является получателем видео и а затем полученное видео и референсное видео подается в вимаф для собственно говоря оценки Vim of дает оценку и наш довольный пользователь соответственно наблюдает эту оценку Ну вернее инженер это не внешнепользователь имеется внутренний наш довольно инженер наблюдает наценку вот в своей сборки в teamsity Вот кроме этого мы умеем портить сеть между клиентом номер один и сервисом и между сервисом и клиентом номер два что позволяет соответственно симулировать различные э-э вот эти вот сетевые проблемы и оценивать Как ведёт себя система с точки зрения качества видео при наличии вот этих сетевых проблем Вот отдельный интересный вопрос Это подготовка референса поскольку мы сказали что у нас покадровое сравнение Вот то значит мы должны обеспечить ситуацию когда а и в референсе и в полученном видео набор кадров одинаковый Вот и как же мы это делаем Ну на самом деле сейчас кадры мы чуть попозже перейдем для начала Мы маркируем каждый фрагмент тестового видео вот такой вот шахматной доской значит зачем это нужно вот имея такую шахматную доску А мы умеем с контролировать границы видео вот смотреть нет ли геометрических искажений в видео то есть никуда там оно не уехало и прочее а и Кроме того вот маленькие квадратики внутри доски это в двоичном коде э закодирован идентификатор этого фрагмента видео естественно разные видео фрагменты имеют разные идентификаторы нужно Естественно для автотестов нужно понимать какой у нас сейчас фрагмент а далее Мы размечаем каждый кадр А значит э-э ну разметка такая вот эта полоса сверху чёрненькая это двоичные разряды соответственно черные условно нолики белые условно единички соответственно каждый кадр таким образом имеет свой значит числовой идентификатор просто грубо говоря интеджер Но вот вбитому представлении вот каждый кадр маркируется таким образом значит Затем когда мы получили видео из сети видео там могло претерпеть какие-то проблемы значит и у нас сейчас интересует проблема если выпали какие-то кадры значит Есть ли каких-то кадров не хватает это такое может быть вполне то мы и в референсе убираем вот эти вот кадры то есть кадры которых нет мы вычищаем из референса или по-другому можно сказать что мы пересобираем наш референс таким образом чтобы в референсе остались только те кадры которые мы получили в видео из системы значит зачем это делается Это потому что зима будет сравнивать кадр кадру мы должны соответственно это синхронизацию обеспечить значит и выпущенные кадры мы грубо говоря логируем куда -то Файлик потом для инженера который будет изучать Какие кадры выпали а и хочу показать вам несколько примеров наших замеров например вот замер номер один значит эта картинка хорошего качества значит это видео было 2 мегабита почти Это достаточно хорошее видео хороший битрейт значит и вимаф дает достаточно высокую оценку Да значит вимаф дает оценку от нуля до 100 здесь 95 Ну то есть 95 из 100 возможных соответственно достаточно хорошо psnr 50 это тоже хорошая отличная качество вот Пойдёмте Дальше не знаю насколько видно на мониторах э-э Но артефактов немного картинка не сильно хуже Хотя сжатие сжали э-э почти в четыре раза значит но в выдаёт всё равно близко к станции значение 87 - это не идеально но неплохо Вот сценар тоже пострадал но чуть-чуть третий пример вот здесь уже наверное Должны быть заметны артефакты 150 мегабит 150 килобит уже Маловато для видео значит Поэтому есть артефакты вимаф уже упал 63 100 возможных psnr тоже 43 тоже так уже снижается и последний фрагмент как говорится 10 шакалов из 10 Ну и вот соответственно вимаф это подтверждает 23 стало возможных и 38 э-э децибел psnr А значит подведем промежуточный ток что мы в итоге Можем отловить по результатам Вот таких вот измерений первое мы э-э соответственно отлавливаем артефакты внутри видео которые могли появиться за счёт пропадания пакетов в сети ещё каких-то там сетевых проблем перестановок и прочих а второе мы можем отловить если разрешение картинки ниже ожидаемого то есть исходная картинка была большая а потом мы ее где-то на сервере сжали И вот она стала маленькая тоже наши вот эти оценочки они это покажут следующее видео претерпела геометрические искажения то есть Оно обрезано как-то сдвинуто ещё что-то то есть допустим тоже при перекодировании на сервере какие-то были значит проблема Вот соответственно тоже мы увидим А это мы увидим кстати благодаря шахматной доске вот той самой Вот и последнее видео слишком сильно сжато кодом тоже это мы видели вот эти вот квадраты а вот но при достаточно низком битрейте Вот и принципе последнее что я хотел показать Дело в том что помимо вот когда я показывал стенд я говорил что подходит инженер нажимает в teamcity кнопочку там машинерия поднимается и все значит но кроме подхода с инженером У нас есть автоматизация и мы сделали мониторинг нашего продакшена окружения таким образом что каждые 15 минут вот этот стенд он сам автоматически поднимается измеряет качество видео на продакшене и репортят вот этот график Вот и мы соответственно можем наблюдать что у нас э могут быть какие-то просадки по качеству или наоборот всё ровно хорошо э и за экспериментами можем тоже следить то есть поставили эксперимент смотрим на график Ага поползло там в ту или иную сторону делаем вывод э Про эксперимент удачный неудачно Вот Мы двигаемся к завершению значит несколько мыслей вот в качестве итога первое для того чтобы сделать нашего пользователя счастливым и обеспечить достаточное количество видео нужно выдерживать баланс между размером картинки между степенью сжатия и между сетевыми условиями в которых находится наш пользователь Вот то есть мы можем сделать сколько угодно хорошее видео Но если оно будет очень тяжёлым мы не сможем протолкнуть его в сеть пользователь будет не рад И наоборот мы можем очень сильно сжать видео можем легко протолкнуть его в сторону пользователя но оно будет плохого качества пользователь также будет не рад поэтому этот вопрос Это всегда такой очень тонкий баланс с большим количеством еврейстик а следующее качество видео можно измерить я еще вот так не постеснялся добавить слово объективно и даже вынесло в заголовок доклада А дело в том что те метрики которые мы пользуемся psnr вимаф они основаны на математике результат их работы воспроизводим то есть если мы одну и ту же картинку прогоним через вимафтом примерно через несколько раз то мы получим один и тот же результат и это значит что Метрика ну так скажем более или менее объективно Ну и оценка опять же выдаётся в цифре и можно в цифрах сравнивать вот мы сделали какую-то фичу соответственно вот была такая цифра у нас качество стала другая и собственно Вот про это Хмм мой значит третий э прямоугольничек то есть для чего мы можем использовать такое измерение Значит мы можем оценивать Хмм Как влияют наши доработки которые мы делаем вот этот вот тонкий тюнинг того самого э транспорт кэшан-контрола например мы можем его тонко настраивать и э это в лаборатории или уже на продакшене можем оценивать как наши доработки Как наш тюнинг влияет на качество видео Ну и Последний пункт мы вот построили считаем Это важным мы не систему мониторинга качество видео на продакшене то есть это именно вот мы в цифре получаем качество видео помимо конечно же мы измеряем CPU мы измеряем память Там миллион у нас различных метрик Но кроме вот таких вот чистосерверных параметров мы вот ещё умеем измерять качество видео э на продакшене А на этом У меня всё пожалуйста голосуйте за доклад и ваши вопросы Алексей Спасибо теперь Мы все знаем как оценивать качество видео поэтому Оцените качество доклада Алексея вот qr-коды значит вопросы можно задавать э-э для тех кто будет смотреть и смотрит нас в онлайне э в чатик те кто стесняется тоже в чатик лучше не стесняться поэтому ваши руки пожалуйста покороче надо успеть многим дать Так давайте вы первый а уже здесь всё извиняюсь Давайте Добрый день спасибо за доклад такой вы упомянули что вы затащили подобные алгоритмы в систему мониторинга для этого алгоритма нам требуется референсный кадр и уже прошедший весь pipeline выходной кадр откуда берется этот референсный кадр с точки зрения мониторинга то есть Он же известен вам заранее на ваших тестах потому что вы имеете доступ к камере полный кадр референсные который идет от клиента он уже де-факто как бы при попадании в сеть приходит он сжатом мониторинг выполняется на стороне фронта смотрите там Дело в том что используется тестовый клиент равно бот некий бот то есть звонит автоматика звонит ботами один бот звонит другому и у Бота звонящего просто Файлик есть на жестком диске он всё время один и тот же мы подготовили референ заранее это Файлик Вот соответственно вместо камеры он показывает этот Файлик Это инженерные клиенты именно это не настоящий клиент как бы настоящий клиент Спасибо так Ну тогда точно туда Простите пожалуйста у меня такой вопрос Вы упоминали доклад про звук он уже был или будет был осенью 22 года на хайловоде который в Москве был Спасибо Здравствуйте спасибо большое за доклад мне вопрос наверное про другую большую проблему а как вы справляетесь с отставанием видео как вы вообще фиксируете Ну какие могут быть причины этого отставание от чего от звука Ну я что-то говорю а пользователь видит меня там через 5 секунд только например ну мы справляемся с этим следующим образом мы стараемся во-первых не накапливать нигде большие объемы этого видео то есть грубо говоря дропаем то есть тут у нас есть какой-то буфер там 200 миллисекунд мы как бы вот это касается звука тоже со звуком и чуть хитрее поступаем не дропаем но там ускоряем Но короче говоря смысл В чем поскольку вот у нас данные поступают поступают поступают значит если они не поступают значит будет какой-то Фриз или мы там начинаем вот эти вот процедуры восстановления там попыток и так далее Вот но мы не копим много за счёт этого мы выдержи ваем там 200-300-400 миллисекунд Вот эту вот задержку вот ну если застряла видео допустим в сети Сеть кончилась допустим Ну значит до какой-то степени будем пытаться восстанавливать потом аватарку покажем если нет видео примерно так пожалуйста Добрый день спасибо за доклад наверно повторюсь немножко вот бывает ситуация когда по крайней мере в зауме у кого-то подлагивает видео а потом резко начинает ускоренно воспроизводиться у вас получается В таком случае будет проблема со сравнением с референсным видео того что у вас получается да конечно если такое произойдет система покажет да качество снизилась Ну ладно спасибо тут на самом есть еще вопрос в чатике вот к этой теме близко я его сразу задам Андрей Арутюнян спрашивает о том что пробовали вы в qmt от МГУ от системы система оценки видео качество использовать Почему веймах а не в маф некф Обновили по причине легкого взламывания этой метрики Ну взламывание смотрите Да разламывание есть такая история что те кто разрабатывает допустим кодеки Я слышал эту историю что те кто допустим кодеки разрабатывают они научились подпихивать такое видео которое дает ложно высокую оценку например но у нас просто нет такой задачи мы никому не пытаемся эту цифру продать что вот смотрите у нас большая цифра поэтому Заплатите там нам деньги Например вот мы сравниваем пока что по крайней мере сами для себя сравниваем с другими продуктами и мы вот я уже тоже об этом я говорил что у нас паттер видео Говорящая голова мы не пытаемся подвернуть какое-то хитрое видео чтобы обмануть систему вот поэтому нам это То есть в принципе замечания валидно естественно лучше взять то что так сказать лучше где пофикшено всё но просто для нас является Это критичным сейчас вот а Метрика которая упоминалась не пробовали вполне возможно присмотримся тоже попробуем Спасибо так ещё вот здесь а уже здесь Да хорошо Да я тут Лёша привет Прикольно спасибо у меня такой вопрос Ты говорил что ну важны каждый из параметров потери качества в отдельности но важна их комбинация и Ну потому что ты упоминал кажется что ну типа лучше если они все три по чуть-чуть упадут чем если там останутся высоко один упадёт сильно но это вот какие-то эмпирические соображения А есть ли у нас какой-то Ну не знаю интегральный показатель когда все вот эти вот параметры как-то там не знаю весовая комбинация или что-то еще там переводим в какой-то единое число и можем Ну какое-то счастье пользователя как мы его понимаем вот этим Одним числом измерять есть Вот такое что-то у нас Я думаю что именно вот как оценить комбинацию такого магического числа нет отчасти потому что на самом деле если немножко копнуть Вот в специфику видеозвонков И в юай то на UI видно что например один пользователь который Я кстати в спикер который сейчас говорит Он на полный экран показывается А вот маленькие Да а пользователи которые значит не говорят они в так называем колбаса Ну или более корректное называть галерея Вот они в галерее находятся там с правой или Там сверху Вот и они маленькие и в этом есть тоже такая ну хитрость что тот кто большой его бы надо показывать получше Ну потому что вот он большой а этих маленьких Ну маленькое у них разрешение Ну и ладно всё равно они вот это я собственно и показывала на первых где был маленький такой прямоугольник вот поэтому То есть это еще нужно соотносится с ожиданиями пользователя то есть Active спикера пользователь хочет видеть крупно и хорошо маленького он готов там особо на него не обращает внимания Вот и там мы можем играть и вот именно с теми пользователями мы снижаем там разрешение Потому что им их всё равно их мелко показывает вот а есть ещё страшная вещь есть такая фича как пинпользователя то есть например Я выступаю я для всех крупно а какой-то использовали хочет другого пользователя смотреть крупные они меня и он может на него нажать на кнопочку и именно тот другой пользователь откроется для него э на полный экран и получится вообще сумасшествие То есть все смотрят крупно меня он один смотрит крупно кого-то другого и сервер серверу как бы не разорваться то есть нету однозначности что меня крупно надо показывать о всех остальных мелко а это значит что меня крупно всех остальных мелкая но это тоже крупно для вот того пользователя поэтому у нас в этом плане очень логика хитрая последний супер быстрый вот уже с микрофоном быстрый эффект про отправку из дачных данных чтобы совывать а были планы перейти на eml и на основе мыли на клиенте дорисовывать данные Ну типа кадры и увеличить частоту кадров А значит не совсем есть такая штука может быть там есть там или внутри это надо еще нам поизучать значит в принципе вот для звука есть такая фича называется plc когда у нас не удалось восстановить пакет сетевой века нету ничего нет просто есть дырка вот эту дырку можно как бы зарисовать вот если представить в звуке синусоидов Вот её можно зарисовать либо алгоритмами математическими либо имеем можно закрыть эту дырку вот для звука Это уже реально используется значит э для видео Мы хотим это использовать пока не внедрили то есть да декодер при определённых доработках декодер видео может как бы замалёвывать зарисовывать вот эти артефакты Ну с какой-то степенью качество Конечно если много пропадёт много зарисовывать надо будет плохо но мелких каких-то пределах может делать да планируем супер Спасибо за ваши вопросы Те кто не успел задать вопросы зададут их в кулуарах дискуссионной зоне Алексею на них обязательно ответит теперь Алексей должен выбрать Два лучших вопроса которые были заданы подарочком Значит у меня первый мне понравился вопрос в общем-то жизненный про задержку видео и на самом деле да да коллега не затронул чуть-чуть одну тему больную это называется липсинк на этот на эту тему Кстати это синхронизация аудио видео это есть куча отдельных докладов на эту тему вот мы пока над этим работаем И вот так как была затронута острая тема это вот поэтому вопрос ещё один а ещё один как раз последний про mml зарисовывание фрагмента отлично поздравим наших замечательных зрителей внимательных и Алексею скажем Ещё раз спасибо и тоже подарим ему подарок от организаторов Спасибо всё до встречи на следующем докладе Всё Всем спасибо"
}