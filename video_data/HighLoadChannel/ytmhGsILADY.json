{
  "video_id": "ytmhGsILADY",
  "channel": "HighLoadChannel",
  "title": "Подсматриваем за Linux-инфраструктурой и выявляем атаки / Антон Жаболенко, Лиана Остапчук",
  "views": 1125,
  "duration": 2368,
  "published": "2024-04-17T01:10:20-07:00",
  "text": "Да всем еще раз Доброе утро Меня зовут Антон жубаненко я руководитель информационной безопасности в Wildberries и здесь моя коллега Лиана Лиана отвечает за внедрение мониторинга информационной безопасности в нашем Security Operation центре команда которая отвечает за расследование инцидента собственно говоря и сегодня мы с вами поговорим на такую тему как выявление Атак Linux инфраструктуре и поговорим вообще о том что нужно для того чтобы эти атаки получилось выявлять О расследовать и начнем сразу с кстати пока не начали сразу прикладного примера А вообще тут есть если тут безопасники Понятно значит наверное будет интересно хорошо начнем сразу с прикладного примера предположим Что произошло страшное и криптобиржа N трагически со всеми биткоинами была взломана с точки зрения твоего опыта работы в соке что же в таком случае нужно делать Я пошла искать план реагирования на инцидент ИП да То есть хорошо чтобы был план реагирования на инцидент и Б Но к сожалению во многих компаниях в особенности тех компаний которые изначально не сталкивались с какими-то крупными инцидентами утечками план реагирования на инциденты и Б выглядит примерно так у кого так было у некоторых было Окей хорошо предположим что ты работаешь вот этой самой Крипто бирже и планы реагирования на инциденты и Б Нет что же тогда делать Я бы начала с формирования списка вопросов на которые в дальнейшем пошла искать ответы начиная с того как злоумышленники проникли в инфраструктуру до каких узлов сети смогли Достучаться повышали они привилегии сюда то каким образом не оставили они бы которые и так далее на самом деле расследование инцидента сводится к поэтапному ответу на ряд вопросов которые нам помогут понять что же вообще делал злоумышленник инфраструктуре и как он действовал но легко можно заметить что все эти вопросы сводятся к одному более общего более общему вопросу на самом деле А если логи понятно то что в во всех наверное компаниях какие-то логи есть но часто этих логов на самом деле недостаточно для того чтобы непосредственно расследовать и как-то на них реагировать какие-то логи есть но это не те логи которые которые на самом деле нужны и мы Надеюсь вас Убедили в том что логи наверное нужны Да теперь давайте поговорим о том все-таки а с помощью чего эти логи эти логи нужно собирать И для этого можно применить так называемые абстрактно мониторинг бленд своей точки зрения каким основным критерием мониторингб должен удовлетворять верхнего уровня Вам он должен уметь собирать телеметрию по запросу по таймеру и по наступление определенных событий да И на самом деле есть еще один очень важный верхнеуровневые критерии про который часто очень любят забывать безопасники мониторинг на самом деле не должен мешать работе провода и в целом вот этот вот вопрос про то что мониторинг не должен мешать работе прода он становится часто кривоугольным таким камнем при внедрении мониторинга информационной безопасности потому что безопасники ставят какой-то мониторинг он начинает серверах съедать половину производительности и коман эксплуатации этим обычно не остается слишком сильно довольна Окей А когда мы говорим про внедрение какого-то мониторинга который позволит собирать телеметрию и логики необходимые для расследования возникает часто такой вопрос а Можно ли взять какой-нибудь существующей айтишный мониторинг который у многих уже стоит и использовать его для сбора необходимых логов и телеметрии например Часто у коллег из эксплуатации возникает такой вопрос Подходит ли например забитый для того чтобы нужную информацию собирать как ты видишь ответ на этот вопрос на самом деле это очень хороший вопрос к нам не раз приходились с ним и я скажу что нет забикс не подходит под данную задачу потому что в конечном счете это все сведётся к тому что мы будем писать такой мониторинг с нуля да то есть Он позволяет выполнять произвольный код и у коллег из эксплуатации часто возникает вопрос почему бы Он позволяет писать произвольный код почему бы с помощью этой функции не написать там сбор всех нужныхлогов и телеметрии на самом деле так можно сделать но мы напишем свой мониторингб на самом деле и придётся проделать огромную работу чтобы с помощью зомбик начать собирать всё что нужно а Окей если забикс и аналоги не очень подходит А что же вообще тогда потенциально можно использовать можно воспользоваться стандартными сборщиками логов к примеру число qng или посмотреть в сторону классов решений edr xdr и так далее а так сейчас я кликаю слишком много напридумывали этих всех названий о чем вообще вот эти страшненькие многобуквенные аббревиатуры друг от друга отличаются И в чем вообще суть по большей части они предоставляют примерно схожую функциональность появление новых разных красивых аббревиатур это результат работы хорошей работы маркетологов разных компаний за много денег Ну то есть на самом деле Да вот эти все решения они довольно-таки схожие и часто являются трудом работы маркетологов которые пытаются продать банку какого-нибудь очередное очередное модное решение которое решит все его все его проблемы мы сегодня в во всё это многообразие прекрасных аббревиатур погружаться не будем а поговорим более про прикладную такую составляющую вопросы О'кей а что же тогда вообще Использовать можно для сбора логов При построении нашего сока мы проводили сравнение существующих систем мониторинга eBay в том числе эластик Агент вазах некоторых других проприетарных решений водах у нас достаточно долго эксплуатировался впроте на позже мы поняли что Не совсем подходит под наши задачи нашу инфраструктуру В итоге решили посмотреть в сторону такого инструмента как усколереи сегодня хотим рассказать вам о нем поделиться опытом эксплуатации данного инструмента нас в инфраструктуре а вообще кто-нибудь сталкивался Понятно кто-то сталкивался ластик агентом не многие не многие тоже некоторые про это решение слышали окей да И что же собственно говоря разрешение такое ускорить это агент который мы ставим на хэштез которых планируем дальнейшем собирать интересующие нас телеметрию с помощью данного Агента у нас появляется очень удобная абстракция над операционной системой в виде базы данных Где практически каждый компонент операционной системы описывается в виде таблички в результате мы имеем возможность писать подобные запросы в этого Агента и получать информацию о той системе которая нас интересует в том числе мы можем читать конфигурационные файлы определенные видеть какие пользователи есть системе Какие пакеты Какие процессы вообще запущены и так далее Также агенты позволяет такие запросы запускать по расписанию и логировать все результаты выполненных запросов в системе сбора логов да И на самом деле когда мы с вами говорили про такие верхнеуровневые критерии для системы мониторинга eba мы упомянули то что такая система она должна очевидно собирать логики и телеметрию и на самом деле у сквере применении климакс инфраструктуре с этим все достаточно хорошо осквере умеет собирать порядка 154 видов различной телеметрии и логов в контексте линуксовых хостов что это вообще за телеметриелоги ускорили позволяет получать кучу разной информации от того кто и когда логинился на хвост Какие контейнеры запущены Какие порты открытые Какие ключи лежат во второй кисть и много-много всего другого на самом деле по нашему опыту а той телеметрии и техлогов которые умеет собирать ускорение Вполне себе достаточно для написания большей части правил корреляции которые нужны вам для на самом деле выявления инцидентов и покрытия там борщей части какой-нибудь матрице этр А ну и в принципе для расследования инцидентов тоже обычно Этого достаточно а окей а мы поговорили Что умеет собирать осквере но ты вот сказала то что у squery представляет информацию об операционной системы в виде таблицы позволяет получать эту информацию с помощью таких Аля и сквер подобных запросов А как вообще это выглядит Давайте попробуем узнать какие пользователи на Хосте обладают расширенными привилегиями для этого обратимся в табличку судоэрос и выполним запрос Селект из этой табличке и мы видим что в данном случае я могу выполнять все команды под суда без пароля Красота и будет будет этого файлика в котором прописано это правило знает ли об этом администратор Да мы обозначили что squery может выполнять запросы по расписанию по запросы отхок Мы также выдвинули требования что мониторинг должен уметь собирать информацию по наступлению определенных событий вот Можем ли мы это сделать с помощью squery Да информацию о происхождении различных событий мы тоже можем собирать с помощью для этого есть две подсистемы первая подсистема работает с помощью механизма работает за счёт собственно говоря запуска epf программ в ядре эти bpf программы подписываются на информацию о запуске различных системных вызовов и превращают и обрабатывают и превращают её в такие более верхнеуровневые события которые могут нам говорить о том запускались останавливались процессы открывались закрывались соки и так далее вся эта история доступна с версией ядра 4:18 Ну давайте тут тоже опять же не будем долго говорить про теорию а сразу возьмём собственно говоря небольшой небольшой эксперимент и посмотрим как это всё работает а возьмём какой-нибудь среднестатистический продавец железный сервер на котором есть какая-то Боевая нагрузка такая усреднённая и поставим туда сквере с запущенным bpf модулем для сбора информации процессах и соки посмотрим что происходит Как вы думаете что что вы видите на этом графике Да тут действительно показывается сколько потребила CPU Los squery но тут можно заметить некоторые интересные особенность потому что на самом деле на этом графике осквере занимается тем что непрерывно запускается И падает запускается И падает вот эти вот на графике такие как сосульки это на самом деле тот момент когда у сквере достиг некто некоторого Пика производительности потом по Некоторые причине упал соответственно потребление упало потом перезапускается начинает опять нарастать потребление CPU и он снова падает И на самом деле такой здесь предварительный вывод то что подсистемы epflare она к сожалению для родовой нагрузки Судя по всему не пригодны мы об этом чуть позже ещё поговорим но к счастью подсистемы epf она не единственная которая позволяет получать информацию о тех событиях которые происходят в системе есть ещё и вторая подсистема Также можно воспользоваться под системой ядра аудит аудит доступен версия 26 и выше и с помощью аудитов Мы также можем подписываться на интересующие нас события к примеру запуске процессов поднятия сокетов события Барбара и так далее и предлагаю дальше продолжить наши эксперименты и переключить способ сбора событий с ebpf на Аудит И мы увидим следующее что во-первых Агент в течение нескольких суток практически ни разу не упал и второй Вывод что Агент потребляет в разы меньше тех ресурсов которые мы необходим были при работе с evp В итоге можно сделать вывод что в целом аудит работает стабильно приемлемо употребляет ресурсов тоже все относительно да то есть если подытожить в целом вот этот небольшой блок про сбор событий тут выводы собственно говоря два первый то что еби ппф действительно на самом деле на прудовых нагрузок нагрузках нестабилен и вот выводы которые мы здесь получаем они немножко контура интуитивны потому что evpf он должен быть более производительным чем парсинг логов из аудита который делается просто путем парсинг и строк но к сожалению ускорить это работает не так а реализация модулей evp она не оптимальна и можно даже в слайке разработчиков найти информацию от человека который пил подсистему написал где он в итоге пишет то что Да они используете её на высокой нагруженных системах оно что-то пока плоховато плоховато работает Хотя очень хотелось вот там например а под система аудита а она работает относительно стабильная она в принципе пригодна для продада с ней плюс-минус там можно работать не без своих как бы интересных моментов э но в целом приемлемо а о'кей и когда мы с вами поговорили в целом о том а какой каким функционалом обладает Торе и какие с помощью него можно собирать логия телеметрию события теперь хочется поговорить собственно говоря о таком вопросе как а в итоге достаточно ли Тихо и стабильно ведет себя осквере все-таки напротив вот в целом глянут часто к тебе приходит ночью администраторы стучатся в двери и спрашивают с тебя за то что осквере положил в какой-нибудь продали сервер Нет еще не приходили на Я думаю что это связано с тем что к этому вопросу Мы решили подготовиться основатели и начали с того что мы подключили мониторинг потребления ресурсов агентов на Хосте с помощью то есть мы контролируем потребление цепогенным памяти и контролируем статус Агента отключен например или нет то есть мы на самом деле воспользовались которые являются у нас компании мониторингом просто по умолчанию поэтому им воспользовались каким-то другим на самом деле и поставили присматривать за агенты смотреть что там вообще с ними Происходит что в итоге получилось насколько В итоге там стабильно функционирует В итоге все функции функционирует стабильно Агент живет себе хорошо тут на слайде придет скриншот потребления цбу Агентом на одних из родовых серверов Вот но бывает Но на самом деле вот этот график который Здесь изображен он показывает там работал ускорили за чуть больше месяца со включенной подсистемы именно аудита То есть можно видеть что потребление плюс-минус стабильное А да но как заметила ли она бывают но и что же это за мной как с ними собственно говоря бороться про но мы расскажем чуть позже как бороться сейчас расскажем так первый момент который мы включили для мониторинга потребления ресурсов агентом мы воспользовались встроенным механизмом Москвы Watch dogan и за это ему самый максимальный уровень ограничения потребления ресурсов Что включает себя не более пяти процентов не более 200 МБ памяти то есть по достижении определенных лимитов Watch Dog приостанавливает работу агент Его перезапускает Вот но на практике Выяснилось что 200 МБ не совсем достаточно для того чтобы Агент спокойно жил в проде ему увеличили этот лимит до 1 гигабайта и позволили ему работать не более 10 минут немного уточню то что Watch Dog он собственно говоря тоже ограничивает потребление ресурсов с помощью потребления ресурсов А насколько вообще ты очень долго доверяешь надо понимать что это часть кода скверий и что-то всегда может пойти не так поэтому мы обратились к функционалу функциональности ядра операционной системы все группы и задали такие лимиты как также по аналогии лимиты на CPU памяти и ограничили скорость записи чтения с диска вот эти вот параметры откуда они вообще берутся И что это такое Да эти значения мы высчитываем автоматически при раскатки Агента PlayBook Да мы их высчитываем динамически при раскатке Агента получается с помощью на самом деле если подытожить вот историю про то насколько сильно шумит осквере он в среднем шумит не очень сильно но все равно мы дополнительно обезопасились его сквере ограничились с помощью двух таких эшелонов обороны Первое это встроенный в скваере Watch Dog второе - это сигруппы где уже ядро гарантирует то что процесс у сквери не сможет потребить больше чем мы его ну как бы ограничили а окей Теперь давайте поговорим про те проблемы и особенности которые могут возникать при эксплуатации осквере в проде их на самом деле довольно-таки много мы поговорим сегодня безусловно не про все но про какие-то такие наиболее наверное те которые нам показались интересными и на которые мы потратили больше всего на времени и проблема первая она связана с особенностью архитектуры в целом подсистемы линук саудит проблема заключается в том что в подсистеме аудиты ядра в линуксаудите есть буфер ограниченного размера куда записывается собственно говоря события которые которые вы хотите видеть и на самом деле такой почти очевидный наверное факт что если события в системе происходит чаще чем вы из Аудит И их вычитываете что-то с ними делаете то будет происходить торт троттлинг То есть вы Если вы недостаточно часто вычитываете события из аудита то события просто будут теряться А как с этим бороться есть несколько основных способов во-первых можно увеличить собственно говоря размер этого буфера и у вас тогда аудит будет потреблять больше памяти но будет теряться меньше событий второе что вы можете сделать это собственно говоря еще поиграться с балансом между полнотой логов и производительностью осквере который вы готовы отдать собственно говоря ускорили на конечном Хосте и вы можете чуть-чуть увеличить лимиты которые вы которыми вы зарезали с помощью Watch dog's Group почему это может помочь потому что осквере начнет работать более производительно и будет более агрессивно скажем так вычитывать логи из аудита и они меньше будут И последнее Вы можете в целом чаще выполнять запросы к табличке evense которые тоже собирается информация на как раз из-за Аудит И тоже это приведёт к тому что это родственница будет реже это первая проблема но были ещё какая проблема была в следующей следующая Проблема была связана с тем что мы решили поставить агентство сервера и администраторы начал мне стучаться в личку почему очень сильно шумит с такими логами что он не может подключиться к нет линкоке то мы пришли выяснять в чём же дело оказалось что на впн-сервере использовалась всякие Bird для bgps-сессии он использовал как раз нет линк сокет Линк Роуд идем разбираться дальше у нас был Запрос который использовал табличку Roads которая также по аналогии обращалась К тому же сокету что в результате приводило к конфликту доступа к одному и тому же свой Кито Это табличка нам была необходима для того чтобы мы могли получить информацию о маршрутах которые заведены в на самом сервере как мы решили эту проблему мы отказались целиком от ее использования потому что в конечном счете это могло привести к тому что сеть просто бы могло сломаться могу сломаться и поэтому мы здесь обозначили эту проблему Потому что если вы с ней столкнетесь то имейте ввиду что она может как-то так зафиксить сеть если можно использовать наверное можно добавить то что в целом получается ускори может занять вот этот самый над Линк Рокет сокет и у вас в целом например Bird который тоже его использует может где-то не запуститься на ваших серверах где он нужен В итоге То есть все сломается как лиада и сказала да а это снова не последняя проблема со следующей проблемой мы столкнулись когда ребята из эксплуатации к нам пришли в чате поддержки сообщили о том что сквере неожиданно начал потреблять избыточное количество вроде бы про оперативную памяти подумали тут ускорение начал поедать слишком большое количество памяти которое память жёсткого диска уже и по другим мониторингам было ещё видно то что осквере слишком агрессивно и слишком часто пишет э пишет и читает с диска начали опять же разбираться в чём была проблема из-за чего такое могло произойти и А тут надо сказать то что осквере в качестве такого А локального бэкэнта для хранения для хранения информации используют легковесную базу данных roxby а и у база данных роксди би тоже по сути есть некоторые свой фиксированный буфер в который он а в который он вскоре может писать события А и мы изначально когда проектировали всю вот эту систему мониторинга посчитали то что мы не хотим ограничивать размер этого буфера Чтобы не терять события Ну потому что как бы в среднем оно там несколько месяцев жило при этом неограниченном буфере стабильно никаких проблем не было но тут произошла ситуация при которой осквере с локального Хоста не смог по какой-то причине а отправлять события в систему сборы корреляции логов и вот именно в этой ситуации логи начали накапливаться на локальных хостах начали съедать диск и появилась вот эта самая избыточное потребление операции чтения записи с диска есть несколько способов как это можно попробовать полечить и первый способ заключается в том чтобы все-таки вот этот буфер в котором скапливаются локальные события на вашем Хосте ограничить делайте это с помощью переменной баффер Лок Макс это все вот все переменные которые здесь перечислены это просто конфиги такие для точечной настройки они Если вы захотите вдруг когда-то при эксплуатировать они вам собственно говоря и пригодятся а во-вторых помимо того чтобы этот буфер ограничить Вы можете а-а с помощью специального параметра указать А какое количество времени события могут храниться на локальном Хосте перед тем как они будут с ротированы и э-э тоже это дело можно задать с помощью параметры events Max и Кроме того Вы можете в целом увеличить частоту отправки логов на вашу систему сбора логов и за один раз отправлять больше логов тут тоже нужно смотреть на конфигурацию вашей инфраструктуры вашей сети и найти некоторое такое промежуточное для вас компромиссное значение какая была следующая проблема следующая Проблема была связана с тем что При составлении не совсем правильного запроса мы можем заставить Агента потреблять слишком много ресурсов что не очень хорошо для агентов родовой инфраструктуре под сложными под сложными запросами вообще можно понимать такие запросы не только как слишком много джоинов Селект в селекте и так далее но если мы пытаемся с помощью Агента распарить какой-то очень-очень большое конфигурационный файл на что Агенту также потребуется очень много вычислительных мощностей для того чтобы Сложить это все в табличку и показать результат для того чтобы не столкнуться с такой проблемой нет Да вот Кстати забыла сказать такие запросы могут попасть в Blacklist в squery Blacklist в терминах осквере это список запросов которые Агент не смог выполнить он их банит на 24 часа и этот вопрос больше не будет выполняться в течение суток вот чтобы не столкнуться с такой проблемой нужно подумать над самим запросом возможно его можно упростить или разделить на несколько более простых Вот либо увеличить лимиты очень долго Возможно мы сильно слишком ограничили в ресурсах Агент и ему даже простые запросы сложно выполнить или то что мы не рекомендуем делать это отключить Watch Dog это мы нашли в дредах и там была такая рекомендация вообще отличный совет как избежать того чтобы ресурсоемкий запросы у вас переставали выполняться на Хосте отключите просто все лимиты и будет все хорошо Отличный совет от разработчиков а тут наверное еще можно добавить то что вот в чем опасность Вот таких вот запросов которые собственно слайде были в том что у вас вроде бы SQL подобный синтаксис вы делаете запрос и думаете что вы делаете запрос некоторой табличке а на самом деле когда вы делаете вот Select From и честно например как вот на слайде у вас сквере как вот Лиана сказала идёт и начинает парсить файлики какие-то на кости и всё это требует ресурсов цпу поэтому то есть синтаксический подобный но это не просто обращение к табличным данным эти таблички Они вообще формируются на лету что тоже необходимо для Агенту для его работы кликер немного сошел сошел с ума Да окей а следующая проблема с которой можно столкнуться она такая уже Небольшая но такая косметическая но тоже про нее стоит иметь ввиду то что так как осквере накапливает события на локальном Хосте и отправляет их на систему сбора логов с некоторой периодичностью если она отправляет в эту систему сбор логов слишком редко то вы можете получить такую ситуацию Когда у вас время доставки события всем сильно расходится тем временем когда это событие на самом деле Произошло Это во-первых не очень удобно потому что вам придётся в вашей логике которая как-то работает с такими событиями а-а операции именно на там внутренние параметр который указывает на то когда события всё-таки произошло и второе почему это может быть не очень хорошо потому что если у вас на эти логике завязана какая-то корреляционная логика которая призвана выявлять и обнаруживать инциденты Real Time Что называется ваша инфраструктуре то у вас может получиться событие получиться ситуация при которой события произошло например там в 10 :00 утра а Лог был доставлен в систему сбора логов 12:00 утра и за это время злоумышленник уже вас Вот наверное вы этого не хотите а что может опять же тут помочь чаще отправлять логи с локального Хоста в систему сбора сбора логов и последняя проблема с которой мы столкнулись да это больше не проблема рекомендация внимательно изучайте таблицы которые есть в скваре и те поля которые Может залогировать потому что в Например если вы обратитесь в табличку докер контейнерс Вы случайно заблокируете переменные окружения контейнеров у себя все ем Это не хранилище для секретов Да лучше использовать для этих целей а окей мы поговорили с вами о том что такое вообще osquery как с помощью него можно собирать различную телеметрию события о том говорили о том с какими проблемами вы столкнетесь при эксплуатации осквере в какое-то распределенной высокой нагруженной инфраструктуре Теперь давайте подумаем А как же осквере все-таки мог бы помочь за расследовать атаку если бы он стоял на хостах той самой криптобиржен про которую мы в начале сказали а давайте предположим такую выдуманную ситуацию то что злоумышленник проник в инфраструктуру криптобиржин с помощью комплиментации Саша ключа для какой-то сервисной учётной записи Ну такое бывает например разработчик Случайно запушивал его в репозитории такое К сожалению случается и после этого он попал на один из ховстов криптобиржи который торчал в интернет бирже конечно Хосты должны торчать в интернет а и а-а на этих хостах был запущено после того как злоумышленник попал на этот хвост он попытался оставить на нем богдор и использовал максимально прямолинейный такой прием Добавь злоумышленник добавил в крон-тап строку которая открывает реверс Shell до его инфраструктуры чтобы он потом со своих серверов удобненько дальше продолжал как-то горизонтальное перемещение по сети которая он хочет скомпрометировать здесь вот b64 просто закодировано открытие открытие реверсел с помощью netcato по-моему А что дальше произойдет в на этих хостах после того как злоумышленник такой добавил после этого скомпрометированный хост на котором как раз стоит грунта пойдет по задачам которые в него добавлены и запустит собственно говоря решил который прокинет тоннель Да какой-то инфраструктуры хакера в тот момент как это перевершил будет запущен osquare при правильной настройке он заблокирует информацию о запуске такого процесса и отправит её в схеме у вас может быть все съем Эта система сбора и корреляции логов собственно говоря в сиеме у Вас могут быть настроены координационные правила например по каким-то по каким-то текстовым паттерном либо по каким-то по каким-то еще сейчас не очень важно на основе которых у вас загорится Alert и ваша команда иб увидит то что в инфраструктуре запустилась какая-то странная штука которая открывает соединение вовне нашей инфраструктуры на какие-то странные айпишники альерд э который иллюстрирует такое событие может выглядеть примерно так то есть мы просто видим то что запустился какой-то странный процесс с детектить моего могли опять же потому что пошёл пошёл соединение на какую-то странную инфраструктуру после этого Если бы у нас было скваре мы могли такое событие легко заросливать мы видим то что у вот этого процесса есть провод с Print То есть это айдишник процесса который запустил вот этот вот странный процесс а после этого мы могли бы пойти с помощью осквере посмотреть А что это вообще за процесс увидели бы что это крон крон и пошли бы смотреть А что же там в крон вообще у нас добавлено для этого тоже есть специальный запрос на уровне осквере мы бы увидели то что у нас крон добавлен какая-то странная строчка которая там при декодировании действительно открывает реверселы это сто процентов какая-то атака это не какой-то Full Используйте срабатывание Это явно что-то странное в инфраструктуре этого быть не должно А после того как мы такое увидим мы можем дальше спокойно расследовать атаку посмотреть У кого и на каких хостах есть похожие кроны У кого есть активные коннекты на такие же нестандартные порты как вот были закодированы в этой там b64 строчки Какие команды ещё запускались компрометированном касте то есть мы сможем как раз ответить на те самые вопросы которые нам помогут за расследовать атаку а и а собственно говоря когда мы разобрались что такое Square и как он может быть полезен команде безопасности Хочется ещё ответить на такое краткий вопрос А может ли быть такой инструмент полезен уже команде непосредственно например эксплуатации Как ты считаешь может быть полезен командам эксплуатации как минимум поможет ответить на такие вопросы кто поставил этот пакет который Сломал мне все зависимости положил в рот или кто запустил этот странный процесс который тоже мне убил Ну и в целом ответить на вопросы какие у нас вообще есть сервера да то есть на самом деле по опыту осквере очень сильно помогает в том числе командам эксплуатации разработки расследовать непосредственно уже инфраструктурные инциденты Когда опять же кто-то что-то сломал никто не признается инфраструктура лежит и что с ней случилось непонятно так наверное на этом все готовы ответить на ваши вопросы Спасибо друзья Спасибо за доклад мне кажется для утра это очень было зубодробительное я антибиотиз жизни проснулась И у нас сердце вопрос У меня есть вопрос Сколько будет заключаться для доставки логов и какого удалось вам добиться предоставки всем последующих корреляции а собственно говоря вот этот лак он настраивается с помощью просто параметров Вы можете этим управлять там можно добиться какого-то минуты этого лага собственно говоря а загрузка на хвостовую может повышаться еще у вас будет если у вас большая инфраструктура тысячи хостов которые подключены к единой сети если вы часто будете события отправлять очевидно еще повысите нагрузку на сеть понял спасибо А еще был вопрос Какой задержки добились мы Я честно говоря просто не помню отправляется около 2000 событий это прям максимум и у нас следующий вопрос Здравствуйте спасибо за доклад Меня зовут сел Это вопрос Следующий Какие сценарии предусмотрены на случай если систему сбора логов вмешается злоумышленник и нарушит их целостность Какие сценарии а систему сбора логов иметь эту сие Ну да например если он за собой Хороший вопрос на самом деле Обычно сием вот ну как это у нас сделано администрируется непосредственно команды eba То есть туда нет доступа например эксплуатации опять же это какие-то сервера которые сильно захарджеры В общем которые настроены там максимально безопасны в соответствии там со всеми практиками А куда осуществляется доступ там с помощью каких-то не знаю аппаратных токенов и так далее То есть тут скорее а-а мероприятий направленных на то что Ну в крайнем случае у нас пока направленных на то что им будет скомпрометирован каких-то ещё не проработано скорее мы тут действуем пользу того чтобы вероятность этой компрометации понизить а система сбора логов за собой ведет как-то Да нет как вы можете на Хосты системы сбора логов тоже поставить осквере который будет тоже собирать там различную информацию тоже отправляйте их систему сборы логов Да но это не знаю насколько очень в этом есть смысл коллеги Мне кажется интересная тема дискуссии имеется что предложить а у нас пока следующий вопрос Привет хорошо слышно отлично супер два вопроса Первый вопрос разбирались ли вы Почему такая драматическая разница в производительности между и bpf и аудитом потому что интуитивно кажется что должно быть ровно наоборот второй вопрос сразу или позже давай позже вообще модулеев подписка на 26 системных вызовов то есть мы подписываемся буквально все сразу и на события процессах сокетах и файлах в аудите мы имеем возможность подписываться на определенные тип событий к примеру нам Интересно только процессы сокеты мы собираем только их а вот и отдельно если нам понадобится мы можем включить фильм модуль для того чтобы целостность файлов там контролировать То есть если подытожить то получать свою bpf вы как бы собираетесь все А потом парсите скорее большое Почему собираем а реализация модулей epf такова что он подписывается почему-то на очень большой глубже тут не разбирались но он подписывается на большое количество системных вызовов которые по идее избыточно и на такое как ну на такое большое количество системных вызовов подписываться не нужно чтобы просто например собирать информацию о процессах и вот это под систему условно говоря она реализована так что там нет возможности как-то гранулировать например Мы хотим собирать информацию только о процессах или только акитах ты там включаешь вот этот модуль и он начинает собирать информацию сразу всё о чём И когда ты подписываешься на информацию о запусках двадцати шести системных вызовов понятно что таких событий происходит очень много он начинает у себя внутри парсить э и всё это приводит к тому что он вот так вот Понятно спасибо И второй вопрос про пользу эксплуатации там есть еще обычно команды копать эти которые отвечает за выделение ресурсов И вообще где Что стоит Можем ли мы например смотреть не только какие пакеты стоят Ну например Какие плашки ОЗУ нас там вставлены и так далее То есть на уровне железа Да мы можем собирать системную информацию с хэстов там есть отдельная табличка система инфа и там в целом вся такая Информация доступна и у нас как бы есть это такой проект где мы это частью как разделимся со смежной командой Спасибо Ну и у нас наверное время только осталось один вопросик Короче вопрос обеспечиваете целостность раскатки собственно говоря о скваере на каждом Хосте Ну и чтобы администраторы не изменяли что-либо в настройках этого как первый вопрос больше продолжения к вопросу Всеволода И второй вопрос касается сиемы то есть инвентаризация активов которые проходят по сети и в принципе серверов Она проходит средствами или расположено больше на cm системах на первый вопрос отвечу у нас вообще агентство управляются центральным сервером управления и если мы пытаемся изменить конфигурацию Агента локальности он пойдет и обновиться с сервера обновлений и примет тот актуальный кончик который есть на этом сервере то есть не будет такой ситуации что админ захотел отключить сбор процессов и все мы ничего не видим и админ доволен и мы ничего не знаем вот агентство пойдет обновится и продолжит работать так как мы ему сказали то есть у нас осквере поставляется не с каким-то статичным конфигом А есть такая такое решение оно называется Флит это система централизованного управления конфигами осквере и у нас ускоряли забирает конфликт собственно говоря именно оттуда Поэтому если локальный конфликт через некоторое время всё равно заберет конфликт там еще можно Ну с точки зрения опять же там подход Да риска б некоторые есть о том что можно успеть некоторые вещи разрушителю сделать во флагов можно указать Агенту Как часто ходить за обновлением конфигурации там Раз в 5 секунд 10 раз в час то есть этим тоже управляемый и сами оцениваем вот этот временный промежуток дополнительно прокомментирую безусловно вот что такое это обычный какой-то системный Юнит который запущен там от Рута если руки его захочет погасить он погасит Но если речь идет про защиту от инсайдера тут есть ещё вторая составляющая в виде телепорта про которую мы вчера рассказывали Да тоже там на одном из докладов которые мониторит все действия людей которые подключились к конечной системе такое кроссочек получается очень классно для тема для дискуссии сейчас воспользуюсь правом ведущего У меня последний вопрос выберите лучше вопрос и мы пройдём конфигурационные файлы Это было очень вот сюда Книга лучше подарок и еще раз покажи Да всем спасибо что пришли оставайтесь с нами у нас будет еще очень много интересных докладов Спасибо"
}