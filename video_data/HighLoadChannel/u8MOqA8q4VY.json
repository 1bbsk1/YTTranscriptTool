{
  "video_id": "u8MOqA8q4VY",
  "channel": "HighLoadChannel",
  "title": "Теория программирования: пакетные принципы и метрики / Александр Макаров",
  "views": 2241,
  "duration": 1932,
  "published": "2022-03-21T14:01:30-07:00",
  "text": "и так о чем будем говорить пакетные принципы и метрики про что вообще так да немножечко самаре такой прям супер-супер кратенький а именно он проток как собственно дробить наш код когда у нас получается что-то вроде монолиты мы можем его дробить несколькими способами можем делать микро сервисы можем делать какие-то пакеты внутри и так далее и вот доклад будет о том как его дробить то не просто как дробить а как точно знает что мы раздробили правильно или неправильно поехали вообще чтобы применять ну вообще любые принципы и правила и так далее нужно их понять ну точнее можно их применять и просто так но чтобы правильно применять понять все-таки нужно начнем а чуть издалека и начнем с того что такое абстракция вообще абстракция это обобщение существенного и соответственно удаление всего не существенна для контекста которые мы абстрагируемся чем но в общем то да впихнуть невпихуемое потому что от военные научились вот такие всякие крутые штуковины запихивать очень могу всего люди есть проблемка проблемкой вот она проблем к это наш мозг и может мост наш эта штука такая достаточно важное в нем много много проблем и и большинство проблем которые человек вообще есть они как раз оттуда и есть вот и а как он вообще работает то есть есть у нас кратковременный долговременной памяти он на самом деле это не так просто но для наших целей чуть упростим есть два вида памяти и вот в кратковременной памяти собственность вход-выход и она представляет собой что-то вроде стека и ttr объекта который мы туда загоняем ну примерно 20 секунд маловато но окей и да еще одна гадость что вот в этой вам самом стеки человек может оперировать очень небольшим количеством этих самых объектов то есть на 89 год люди думали умные люди думали что это 7 плюс-минус 2 потом оказалось что dota 2001 циферка обновилась и это 4 плюс минус 1 ну то есть так как мы достаточно такие мощные товарищи которые свой мозг постоянно тренирует возьмем что мы можем запихнуть свой мозг 5 объектов ими как-то по оперировать но число конечно зависит от от объектов плюс есть всякие разные трюки например можно группировать эти объекты например вот такую последовать цифр запомнить ну не очень просто скажем так но если сделать вот так уже нормально почему нормально становится вот как раз если посчитать эти группы это как раз вот пять объектов вот и собственно вот это все она очень сильно связана с теми самыми принципами про которые мы будем говорить вообще архитектуры их изобретают для чего для того чтобы совладать с неподъемно сложными системами со сложными доменами там и так далее и из-за вот этих вот ограничений для нашего мозга неподъемности начинается прямо очень очень быстро к сожалению что мы делаем когда у нас слишком много объектов мы начинаем все это дело абстрагировать и слои вводим слои начинаем словить ну все в общем то получается классно то есть мы оставляем там 5 плюс минус сущности в слое в одном все вроде супер все классно мы начинаем все это видеть но есть проблемка то есть мы по горизонтали все осла или от вертикали у нас может набраться больше пяти слоев и опять возникает проблем это проблема еще покруче то есть мы не можем уже по вертикали впихнуть наш мозг как все эти слои между собой взаимодействует вот но и получается вот такая вот гадость называется глаза не неправильная очень сильно неправильное лазание и она на самом деле будет похуже чем наш любимый спагетти код почему потому что чтобы эту лазанью сделать правильный надо я сначала расфигачить спагетти а потом собрать обратно ну и до вывод отсюда какое что абстракция вообще это как бы вынужденная штука то есть нет цель сделать какие-то абстрактные штуки там паттерна на вернуть что-то еще такой абстракции то всегда не цель а инструмент и абстракции это зло ну не совсем зло то есть это инструмента и любой инструмент можно использовать как для хороших вещей так и для не очень но и абстракции то такое вот необходимое зло получается как вообще построить абстракции не сделав хуже ну что хуже сделать очень легко алгоритм простой мы берем книжку мартина читаемое не понимаем и начинаем применять получается просто крутая штука вот как раз то самое неправильное лазание с кучей слоев неправильными границами и вот этим всем есть два основополагающих вообще принципы как все это дело делать чтобы она была клёвым это к хижин и каплин но в русском языке это два очень похожие слова это связанность и связанность вот связанность это хорошо это когда похоже и общее по смысла мы группируем а связанность это плохое когда то что не должно быть похожим по смыслу начинает у нас слипаться вместе и вызывает очень очень плохие реакции то есть мы правим в одном месте ломаться начинает совсем в неожиданных местах так вот если каким проверочный правил но когда мы работаем с кодом как бы есть до роберт мартин в 2000 году придумал некую штуку solid которая на самом деле вообще не вот этих вот принципов какие жирный каплин вот ну и там н принципов есть и говорить о них общем не будем они хорошие но не про пакеты что вообще такой пакет но пакет это группа единиц кода классов или каких то вообще сущностей и пакета можно назвать модули библиотеки но с какой-то натяжкой наверное даже микро сервиса на какие вопросы вообще хотим ответить на 2 вопроса то есть как правильно формировать пакеты то есть что туда выделять и как правильно работать с зависимостями между этими самыми пакетами есть ли какие же накоплен для пакетов вот такие же правила ну на самом деле есть и это почти solid но не совсем solid не совсем есть у того же самого мартина дополнительные принципы дополнительные принципы это принципы дизайна пакетов их опять же 6 штук и делятся они на 2 группы то есть прокачка бежим это вот именно как дизайне пакеты что туда собирать и соответственно 5 очка блин это то как мы должны собственно использовать пакеты но это больше про зависимости разберем эти самые принципы первый это из группы к хижин это user лис и к ленте принципу звучит он так что green life news и заглянул of release но звучит как обычно у мартина на самом деле мутно у него в книжках принципе все так не сильно четко то есть он заставляет подумать и иногда к сожалению задумываешься совсем не до того что он имел в виду вот но мы и попробуем сделать так чтобы как бы это все было достаточно однозначно и принцип на самом то деле обозначает что собирать вместе нужно то что используется юзерам одновременно ну достаточно такая логичная штука выглядит это примерно так то есть вот мы допустим смотрим на такой вот кусочек кода и видим в импортом что что java и о батарей бла бла и так далее вот здесь есть два импорта и мы их используем вместе и вот если бы это было вот так то согласно этому принципу это было бы очень неправильно то есть мы тащим из двух пакетов то что используется вместе ok следующий принцип команд ложе принципу класса которые меняются вместе упаковываем вместе ну как бы да нормально и здесь важно понимать кем меняются то есть здесь в общем то разделяются несколько факторов которые несколько ударов вот этих вот пакетов то есть первые от юзеры которых потом использует будут есть моим тейнер и вот и у них вот такие вот весы получается что одни принципы они для юзера вторые принципа немножко для main тренеров и вот этот принцип он про mendiny рф больше чем про юзеров то есть если класса меняется моим тренером вместе то упаковываем их опять же в один пакет до пример такое то есть библиотека для интернационализации есть у нас штуковина который переводит сами вот эти вот строчки и есть цвету за который инструмент для внимания строк из кода как контейнеру мне конечно удобнее чтобы всё лежало в одном пакете чтобы я зависимости там не обновлял не делал два релиза чтобы все это было от вместо они по смыслу похоже и мне на самом деле удобнее так то есть и приятнее лучше и и в общем то меньше тело движений следующий принцип комнаты юз principal то есть классы которые мы используем вместе опять же упаковываем в месяц здесь кто опять же мы мы здесь имеется ввиду на на этот раз юзер то есть если класса не используется юзерам по отдельности тогда упакуем в один пакет если используются но наверное не упако вы здесь можно было бы привести вот этот вот опять же пример с интернационализацией и согласно этому принципу приходится делить по другому потому что юзер может использовать переводы строк но не использовать паузу для экстракт инга этих самых строк из кода и делать это вручную но запросто поэтому как бы два пакета вот но еще один пример это кэш то есть как моим тренеру мне офигенно удобно что я все там бакен такаши соберу в одно ну и почему бы и нет собственном я там будет драйвер потом еврей disk drive адаптер под memcache и так далее но юзеру в общем-то не нужно ставить там и редис ммкф если он использует то что-то одно звучит в общем то нормально обычно отлично звучит но реальность нас немножечко подводит подводит она в каком плане что есть у нас вот такой треугольничек по моему артемий лебедев девизе свое своей студии несколько другими словами обрисовывать этот треугольник в общем что можно получить только две вещи из быстро хорошо и дешево такой же треугольник из там на кап теорему и так далее и такой же треугольник есть на вот эти вот принципы треугольник как ни странно нарисовали в институте физики вот то есть ребята очень сильно загоняется по абстракции кода что достаточно странно для физиков вот но вот делают так здесь что мы видим что вот эти принципы опять же получить можно только 2 то есть если мы начинаем убиваться по реп то есть группируем для usa town ace ну получается немножечко плохо по всем остальным принципам то есть либо мы получаем ненужные релизы либо мы получаем что юзайте то не очень приятно потому что мы тянем для того чтобы что то сделать там слишком дофига пакетов либо мы как моим тренером немножечку под утопаем в изменении в куче кучи-кучи пакетов все вроде как но не очень радужно но есть такая общая рекомендация что на первых порах если вы там выкладывайте допустим пакет его пан сердца или внутри пакеты разбираете надо фокусироваться на цепи и реп то есть это группировать для релизеров ну то есть для пользователей чтобы в это то что используется вместе мы группируем вместе и соответственно no se si pe то есть это группировка для моей тренера чтобы то что мы меняя вместе опять же группировались вместе а вот сплит сплитить для camry usa но это такое то есть нам нельзя в общем то уходить ни в один из углов или грани этого треугольника надо соблюдать какой-то баланс но по крайней мере мы обозначили границ это уже очень даже неплохо вот а принципы капли нга они немножечко более четкие и вот про них мы поговорим наверное чуть более наверное подробно то есть первый принцип это принцип от циклических зависимостей то есть если мы возьмем и построим грамм в зависимости но я вообще разрабатываю фреймворк сейчас и мы взяли его и разбили там на 200 плюс пакетов почти 200 пакетов там числа варьируется от туда сюда бегает вот какие то мы убиваем какие-то добавляем и получается что что если мы возьмем и зависимости одного пакета все от рисуем получается некий граф и если у нас там цикл это это вызывает проблемы проблемы какого рода что если мы меняем что-то в одном пакете нам по кругу надо все это дело от релизе и у нас i can then sent играешь он не может пробежать пока мы не 3 лезем весь цикл и соответственно ну и те кто его использует все получают полностью сломанные пакеты вот вам во всем этом округе как вообще проверить на циклы ну как бы просто строен направленная цикличный графы смотрим на него можно наверное автоматикой скорее всего можно автоматики я ничего готова не видел написать сожалениями было немножко лень вот для печки he той же есть библиотека полиграф composer но если мы соответственно засунем туда все все это у нас получается слишком много пакетов игра выглядит очень чудовищ но если мы исключим не нужно это получается вот такие штуки что одно зависит от другого и так далее вот здесь циклов нет все нормальные стрелочки не образуют у нас кружок ну и замечательным чем меньше зависимость вообще тем проще то есть игра в получается у нас меньше и вероятность что что-то там зациклиться меньше но поэтому не делайте как ребята из мира java-script не увлекайтесь тем что в библиотеке выделяете штуку который дополняет пробелами строку слева да как вообще разорвать цикл вот у нас мы делали-делали и получилось что на графе у нас все-таки цикл есть то есть мы можем использовать во первых инверсия зависимости через интерфейс то есть мы берем интерфейс выделяемого между там вот этими двумя пакетами и выносим его в еще один пакет и получается что у нас в этом месте происходит как раз разрыв и все получается норм тасс цикла больше нет ну и по комнате из принципу можно выделить опять же общий пакет можно просто взять и сделать полный редизайн того что образовала цикл так тоже работает еще один принцип это принцип стабильных зависимостей то есть зависимости у нас бывают стабильные и нестабильные сейчас чуть расскажу что это такое и звучит он так что не получится строить вообще стабильной на нестабильным то есть она как бы вот заражается и становится нестабильным тоже посчитать стабильности или нестабильности но достаточно просто формулы вот такая то есть у нас нестабильность это яичко полной нестабильность и полная стабильность это нолик раньше вот эту штуку в оригинальных книжках того же мартин называли и frank uplink и offering uplink то есть это потом он это переименовал на финал tfn и то есть это количество классов вне пакеты которых этот самый пакет зависит но и второе это количество классов вне пакеты от которых зависит пакет то есть это такая вот штука по зависимостям но более гранулярный чем просто зависимости от пакетов и если мы все это посчитаем до то у нас получится некое число как вообще все это дело повысить то есть чтобы стабильность было больше но да здесь уже следующий как бы принцип принцип стабильных абстракций вообще здесь получается что что чем абстрактный пакет тем стабильней смысл в чем что стабильные пакеты они ну очень даже абстрактно почему потому что там менять ничего то есть мы абстракцию один раз сделали ее скорее всего переделывать ее не будем если мы и сделаем нормально если мы сделали нормально но к сожалению тут все очень плохо а гибкие пакеты они общем то конкретные но есть исключение можно вообще померить абстрактность ну на самом деле до можем вот такая получается формула то есть мы считаем количество абстрактной сущности в классе тот абстрактный класс и там интерфейса вот это все просто как бы посчитали взяли потом число конкретной сущности и посчитали собственно коэффициента абстрактности нолик получилось это значит все очень конкретно то есть все очень не гибко все очень как есть и единичках все очень очень абстрактное и здесь что получается что абстрактные пакеты они должны быть предельно стабильными то есть на них завязываться но в общем-то безболезненно то есть мы можем на них завязаться ничего от этого плохого не будет а потом почему потому что поведение у них скорее всего меняться не будет то есть контракт остается таким же а конкретные пакеты они должны быть нестабильны то есть их легко менять там может все как бы разваливаться но это ничего потому что от них не должно ничего такого прямо зависит но есть до исключением опять же если построить некую и графиком называется де метрика то есть по оси x мы откладываем абстрактность ту самую эту величину которую мы посчитали по оси y нестабильность у нас получается от левого верхнего края до правого некая линия и если мы вот в эти вот зоны вот давайте кружки которые там нарисованы зелененькие то наши классы и рыженькие это тоже наш класс вот рыженький это не очень хорошо потому что он уже пошел к нестабильности ну не очень не очень супер и получается что что 00 это очень очень нехорошо плохая зона то есть у нас здесь получается максимально не стабильные штуки и соответственно максимально абстрактные и это как-то очень странно то есть абстракция они должны всегда стабильно и соответственно второй угол это у нас получается что максимально абстрактные и точнее максимальный конкретной и максимально соответственно стабильно это тоже не очень как бы хорошо но есть исключение опять же иногда вот в левом нижнем углу у нас оказываются вещи и обычно они библиотеки то есть это библиотеки которая пишется как бы один раз и меняется но достаточно редко то есть это стандартной библиотеки языков там и так далее на них все равно как бы более менее можно завязываться вот это самое расстояние де которая да вот это вот самой линии de метрики считается как абстрактность плюс нестабильности минус единичка это получается у нас расстояние от главной линии ну соответственно все это дело руками считать и рисовать не очень весело наверное это неприятно и есть всякие разные инструменты вот инструменты у нас получаются такие the jedi pen на джаве это собственно инструмент который я думаю над был написан как раз по мотивам книги этого самого мартина и на печке есть порт и то есть это печь пилипенко письме tricks все они более-менее сейчас поддерживаются но и строят вот как раз вот такие вот прекрасные графики если вот этих вот красных штука и не рисуют а надо бы чтобы сразу читалось это дело это уже я подрисовал вот ну и что еще все это дело как бы она классно то есть мы при разработке можем один раз все это дело посмотреть все метрики от рисовать эти графики что-то поправить но классным в этом то что это можно автоматизировать то есть если мы это можем автоматически все эти метрики собрать значит мы их можем автоматически сунуть опять же в pipeline и в этом самом пай плане мы можем как раз детектив не соответствие ну или полное хотя бы не соответствует каким-то из принципов вот например тот же принцип цикличности зависимостей в комп озере в mavi не и так далее мы можем отдать эти довольно просто то есть мы начинаем все эти пакеты перебирать стаскивать у них манифесты или конфиги и соответственно строить граф но граф из есть настроить памяти и если он замкнулся мы просто материмся говорим ребят вы там делаете что-то не то не надо и соответственно в pull request и мер шарик вести не знаю кто чем пользуется у вас проходит чай и дика матерится на самом деле да вот засунуть всякие штуки все это очень круто это сильно правильное решение для архитекторов для тех кто вообще отвечает за pipeline поставки чем туда больше всякого разного запихнёте и чем она будет злее тем в конце концов волос меньше будет до продакшена всякой дряни долетать вообще да как и solid ну здесь получилось что что вот эти вот красненькие принципы которые принципе на тему каплин гоа недостаточно конкретные получили здесь и можно и числа какие посчитать и так далее а принципы каге жена не но такие такие получились немножко расплывчатой да и вообще они не совсем догматичны и но они тем не менее могут быть чрезвычайно полезны и чтобы просто начать об этом думать вот и да мой кейс то есть мы пилили фреймворк и пили мог стать и до сих пор достаточно уже долго но я думаю мы его все-таки доделаем и релиз ним и когда мы начали у нас был монолит и мы этот монолит начали дробите поняли что у нас что-то идёт наверное не так то есть у нас получился как раз взрыв взрывное такое дробление я думаю что то же самое ну я видел что то же самое на самом деле получается и с микро сервисами то есть мы начинаем наш монолит дробить и либо мы делаем огромную тучу этих микро сервисов и они действительно вас микро либо мы соответственно начинаем ну дробить так чтобы сервисов слишком много не вышло и получается у нас к некие макрос сервисы их так называю ну что на самом деле они не фига не микро и философии не соответствуют ну и вот эти вот принципа они все-таки помогают нам немножко меньше бояться то есть мы сверяли когда все это дробили с тем что здесь было в докладе и понимали что блин но их много но это ничего нам пришлось конечно допилить некое количество толстому что с таким количеством пакетов работать уже стало сложно то есть это штуковины которые перемен cavalli между друг другом чтобы можно было код в некоторых местах сразу там править и проверять еще и даже не сделав релиз это вещи которые опять же делали комменты или что такое сразу то в сотку репозиторий авто мной вот такие вот вещи в принципе тоже самое что у нас получается расходы на те же микро сервиса то есть когда в них люди суются они думают часы на микро сервиса напилил будет у меня все как в гугле но забываю что надо с собой еще привести большую команду drops of которые как раз будут делать все эти инструменты и обслуживать инфраструктуру которая получается но немножко не сильно дешевый также здесь но к счастью это не так ужасно вот но и эти принципы они вообще позволяют не скатываться в wordpad или монолит то есть этот две крайности монолит от у нас ну не очень хорошо потому что тот же фреймворк если пользователи его к себе тянут они хотят чтобы вот в том же микро сервисе было минимальное количество всяких там библиотек и так далее подгружена чтобы онa маленький хорошенький если это компилируемый язык то чтобы бинарник был маленький быстрый если это интерпретируемый чтобы поменьше всего в память грузилась и поменьше времени тратилось на инициализацию вот ну а другая крайность это лев под кто вообще знает провод под историю он не все окей что было но несколько лет назад в мире java script получилась такая нехорошая тенденция что вот я упоминал что ребята начали делать пакеты для всего чего угодно и были классные пакеты которые ну не знаю повторяют там допустим букву а или что там передашь аргументом м м 1 то есть вместо того чтобы написать это в одну или там две строчки но маленький cyclic они делали отдельный метод вот и была такая библиотека efb от которая дополняла строчку заданным количеством пробелов исключительно слева причем вот наверное right path это от отдельный должен быть пакет ночь тонул отпад как бы делает уже одну свою задачу дополнить слева зачем как бы справа дополнять вот но и в один прекрасный момент автор этого дела обижается на сообщества и выпиливает пакет с npm и и оказывается что что этот пакет был сильно сильно важным от него зависело буквально все то есть мажорные всякие фреймворке библиотеки и кстати сам npm да сам вот репозитории пакетов тоже как бы зависел от него и короче упало все то есть они пакет конечно восстановили соответственно сделали так чтобы автор не могли выпиливать свои пакеты которые завязала слишком много людей но как бы мораль такова что не надо так страшно дробить прям совсем страшно чтобы было настолько всё хрупко еще одна кстати конечная штука в той же инфраструктуре and emma что но средний пакет у него может быть там гигабайт зависимости очень легко и в этом гигабайте зависимости очень тяжело вообще весь код про audi ровать то есть мы даже не знаем что нам прилетела и как это суп суп суп суп суп зависимость может быть с уязвимостью или чем еще похуже вот но и на этом наверное все то есть время вопросов спасибо да вопросы можно задавать и по этим вещам и папич кишки и по фреймворка почему года наверное да да фреймворк называется y и и это типичный фреймворк используется много где но это надо кликать sage привет федор васильев и компоненте я правильно понял что ты вот эту де метрику заюзал уже в ноде метрику да то есть мы когда проектировали собственно сам фреймворк ее били его по кино пакеты у нас был был инструмент который как раз строил все вот эти вот штуки про которые рассказал вот например это одна из катушек и получи уже да это циклична и вот эти вот вещи и иди метрику мы соответственно тоже строили для всего если у нас что-то попадала вот эти вот красной зоны но мы по крайней мере over till i see смотрели что ж у нас не так а и вопрос практичные это выложили где-то чтоб посмотреть как именно сейчас мы когда вот первый раз поэтому прошлись мы насколько я помню вы пили эту штуку потому что библиотека которая строила нам эти самые вещи на плохо начала работы с современными версиями печь пищи и на время мы это забросили скоро наверное будем еще раз подтягивайте все еще раз вы лидировать но это просто интересно я посмотрел применим не только к я просто посмотреть как вы сделали так что выложите да и цикла и но цикла я понял сложнее обсчитывать но тоже было бы интересно но цикла на самом деле обсчитывать чуть наверное попроще даже так до науки то есть там вот готовой библиотеки есть и они нормально работают по крайней мере для тоже его твоя идея засунуть и pipeline присяги мне тоже понравилось это прямо классно спасибо спасибо а маленький вопросик от меня паком если вопросов нет вот-вот воды график и вот или красные зоны они же наверно в разных языках немножечко разные могут быть для себя определили это вот эти красной зоны нет они во всех языках будут одинаковые то есть но как бы почти во всех языках то есть где языка где разделяются контракты и самореализация да там мы соответственно вот эти вот этот график можно вполне себе строить где контракта и реализация не разделяется там наверное все немножечко повеселей но там все равно есть какие-то там не знаю мнимые контракта и так далее то что то придется нам накостылять чтобы вот этого дела отрисовать спасибо так я думаю что мы просто мы закончим на вопросу больше нет отлично благодарим тебя за доклад посетите большое"
}