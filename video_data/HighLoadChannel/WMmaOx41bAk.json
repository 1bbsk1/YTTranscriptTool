{
  "video_id": "WMmaOx41bAk",
  "channel": "HighLoadChannel",
  "title": "SPQR: горизонтальное масштабирование PostgreSQL / Денис Волков, Кирилл Решке (Yandex Cloud)",
  "views": 418,
  "duration": 2944,
  "published": "2023-10-06T07:20:03-07:00",
  "text": "что это такое кто это такой но мы вот в Облаке сделали такую штуку чтобы начать масштабировать постгальскую но перед этим небольшой дисклеймер Да и мы об этом собственно хотим рассказать передать небольшой дисклеймер что в этом докладе будет три лжи то что мы сделали не то чтобы не до конца работает оно работает но не то чтобы оно выкачено куда-то но не выключена То есть она уже прошло вот эту стадию когда Это вроде бы прототип но это уже точно не прототип но еще не пришло кстати хоть сколько-нибудь где-то работающего проекта вот так вот скажем так кто такие мы мы себя скромно называем Open Source rdbms девелопмент Тим в Яндекс облаке ложь номер раз это далеко не все люди которые тут есть да чем мы занимаемся Мы контрибьютим в погребе мы к интервьютим в LG разных миллионы запросов в секунду это данных Это совершенно разные кластера совершенно разные ресурсами И в основном это highwalability кластера то есть кластера в которых несколько хостов Итак зачем мы хотим научиться масштабировать постскрискуэль Ну просто типа ну потому что хотим мы этого очень давно хотим это наше давняя мечта чтобы в нашем сервисе была такая кнопка и ты нажимаешь её и у тебя как бы кластер он как бы разъезжается на несколько кластеров это такая как бы наши давняя мечта Итак что мы хотим от шортирования Примерно вот так выглядит типичный постгрискольф кластер там есть мастер там есть реплики на реплики читающие запросы приходят на мастер пишущий Читающий куда-то как-то уходит в вал в хранилище Как там бэкапа в общем как-то так а вот так мы видим типичное приложение наших пользователей что есть несколько бэкентов и они каким-то образом подключаются к нашему кластеру так вот мы думали вот было бы круто короче сделать какую-то штуку чтобы она вклинивалась между ними и каким-то образом сейчас переключится слайд каким-то образом Решала куда надо перенаправить запросы при этом совершенно понятно что в нашей ситуации У шардов могут быть разные ресурсы Вот и так а теперь что мы попробовали для того чтобы сделать так Ну во-первых да что он попробовали что мы хотели сейчас переключится слайди Ну вот на этом слайде Ладно пофиг что мы пробовали Ну во-первых давайте вот обговорим Что именно Мы хотим получить в итоге Какую именно Какой именно сервис какой именно приложение что он сейчас значит что как мы видим вот наше решение наше решение заключается в том что есть какое-то количество кластеров разгресс они как-то там настроены есть клиент который хочет выполнить на них запрос есть наша нечто которое мы называем Вот на этом слайде роутер который может взять запрос и понять на каком шарде нужно выполнить этот запрос для того чтобы он выполнился успешно при этом подразумевается что данные которые хранятся во всех этих шортах Ну они как-то шортированы по какому-либо признаку по каким-то правилам и эти правила они контролируются как-то на роутере это в общих словах То есть есть клиент он отправляет нам запрос вот на слайде здесь написан Select здесь есть very Close там Y равно 3 мы допустим можем посмотреть на это запрос и понять что ну по какой-то причине мы поселили все значит данные у которых Y равно 3 на первый шар Давайте отправим этот запрос на первый шаг вот если у Вас если там как буквент примерно такая загрузка то мы вот можем его как-то шантировать что мы пробовали для того чтобы написать решение значит первый подход был очень простой сейчас слайд переключится Ну первый подход заключался в том что ну в позже уже написано очень много решений различных например есть инфраструктура экстеншна из инфраструктуры внешних таблиц они работают Почему просто не использовать внешние таблицы то есть что мы можем сделать от ВДВ это форунды то есть в воскресе есть способ объявить таблицу внешней и также есть способы вы видите как бы нечто Что называется сервер который занимается тем что доставляет данные из этой таблицы которая внешне Ну мы ровно это сделали мы написали свой фонд рэпер который работает очень просто он берёт запрос соответствии с какими-то правилами понимает что он должен был Должен быть выполнен на там допустим первом или втором шарле отправляет туда этот запрос получает данные отправляет их клиенту Все очень просто всё должно работать какие здесь проблемы первая проблема заключается вот ровно в этом запасе который написано слайде значит если такая достаточно умная база данных каком-то смысле вот если у вас insert происходит какие-то данных которых есть какие-то волатильные функции например на Вот именно функции то после не сделает один вызов к ВДВ партиру он сделает два вызова первый Вызов будет Вот insert как на слайде второе Вызов будет апдейт при этом здесь есть вот неприятная колонка стит это идентификатор table и проблема в том что это невозможно заработать сидит Это просто когда ты байтов на диске это не то мы можем взять и сказать что вот у нас есть табличка у нее есть колонка Давайте все ключи меньше 10 живут на Первом что тебя все ключи больше 10 живут на втором шаге для стидов такое сделать невозможно ну эту проблему Конечно можно решить например переписав там очень много ухода в возрасте но мы решили так не делать мы шли попробовать другое решение оно в целом немного подсмотрено вот у ситуса сделана примерно также мы можем просто взять и попробовать выполнить просто мимо спланировать и самим выполнять для этого нужно взять хук способ переопределить как бы хук для планировщиков и просто выполнять все самим То есть можно взять запрос распарсить его вставить до свои как бы ноты потом их выполнять это в целом тоже работало это показывала какие-то в целом неплохие результаты то есть был посос который снова просто партии запрос отправляется значит результаты на шарт и там получается результат выполнения судах и возвращает данный обратную клиенту вот здесь написано что мы смогли выжать из этого 5000 ТПС на тесте Что такое 5000 PS это 5000 транзакций в секунду ну мы целились цифру 2 миллиона секунд что нам помешало вот вырасти еще больше вот нам буквально в пять раз нужно увеличиться Чтобы достичь цифры 2 миллиона тпсов помешало то что пост эта база данных То есть как бы вот мы пишем extension да он выполняет внутри базы данных но он не выполняется отдельно как бы мы не контролируем очень многие вещи например пост перед тем как выполнить запрос он проверяет что этот запрос он обращается к таблице которая Действительно существует там в этой таблице есть какие-то запросе У вас есть какие-то колонки эти колонки реально существуют они относятся к этой таблице у них там везде правильные типа данных это все очень большое количество проверок которые мы не хотим делать потому что Ну это конечно круто что вот какая-то штука которая выполняется просто вот будет Вот это всё делать но это будет сделано второй раз уже на широте поэтому это вообще не нужен соответственно нужно от всего от этого избавиться то есть большое количество обращений к значит к каталогу подвесовому это как бы место которое наступит здесь возникает большой Лог антенн мы не можем значит из-за этого вот из-за всего выжимать какие-то большие числа из нашего решения Мы хотим больших числа Ну получается что еще проблема была что но написано писать на себе больно типа долго Поэтому мы решили написать там быстро просто можно буквы точнее перемены называть одной буквой вообще все отлично значит мы написали нечто Что называется стоит роутер значит он не стоит сразу скажу он имеет какое-то отношение к возрасту как он работает он слушает значит какое-то порт и общается по по протоколу passgress а то есть мы принимаем к роутеру к нему можно подключиться просто поисковили отправить какие-то сообщения по протоколу прогрессу он вам ответят типа в целом если вы не знаете что вы общаетесь с роутером вы будете думать что вообще эти базы данных Но на самом деле что будет происходить так этому будем брать ваш запрос просто парсить его вот на запросе на слайде мы взяли insert нам даже пофиг какой таблицу обращается это очень важно мы просто взяли и посмотрели то что вот есть ID ее значение 14 Ну по каким-то заранее сконфигурированным сконфигурированным правилом мы поняли что ключ 14 лет поэтому мы туда его и отправим этот вопрос выполним в нем результаты клиента вот insert 01 это просто ровно то сообщение которое вышло шаверму его прикинули обратно отлично типа есть какая-то программа на Go которая умеет вот это делать сейчас переключится слайд ладно значит пока слайс переключается короче есть в целом два способа раскидать свои данные по шардам Если вы хотите пошутили свою инсталляцию как бы оба они очень простые Вы можете либо взять сказать то что вот у меня есть данные Давайте часть из них лежит на Первом что тебе просто подряд вот типа там у меня есть таблица в ней есть какие-то ключи это числа целые Давайте все числа меньше 10 на Первом шаге все числа больше 10 но меньше 20 на втором шаге и так далее ну типа мы называем это шодирование по диапазону ключей точнее все называют это по диапазону ключей есть второй способ сделать то же самое Это шокировать Не сами ключи а просто хэши от них мы используем во всех своих тестах во всех своих значит инфляциях первый способ второй способ наверное тоже интересный можно использовать но мы так не делаем в целом ничего сложного в этом нет хорошо получается что вот Ну что мы получили написав роутер ногу мы получили что у нас есть какая-то программа которая принимает значит клиентские коннекты обрабатывает их как-то и отправляет на шарды получается у нас есть вот какая-то одна точка отказа это очень плохо типа наши там распределенной системы одной точки отказа быть не должно из этого следует простой вывод мы должны вот сделать много роутеров у нас особо Выбора нет мы должны там гарантировать какую-то отказоустойчивость хорошо два роутера когда вот вот мы пришли от одного роутера к двум у нас получилось следующая проблема Если бы у нас были какие-то фиксированные правила шортирования которые никогда в своей жизни меняются то он типа все было бы просто взяли роутер сказал фигурировали в один раз в самом начале и типа жили бы спокойно но к сожалению возникает необходимость значит привозить какие-то данные между шардами это такая практическая необходимость реально существует поэтому сразу решили тоже с этим вопросом а что мы сделали для того чтобы значит это сделать у нас есть сервис-скриминаторы зачем он нужен значит это данные на роутерах они не одинаковые могут быть то есть значит правило по которому роутер решает на какой шарт отправите Ну какой-то конкретный запрос они меняются во времени потому что мы хотим перевозить это мы хотим гарантировать следующее значит следующий вариант если к нам приходит клиент и просто типа пытается выполнить запрос том то вне зависимости от того на какой роутер он пришел он получился один и тот же результат там неважно перевозим сейчас какие-то ключи не перевозим сейчас какие-то ключи может быть роутер упал Ну тогда всё просто приятность может выполнить запрос вообще идеальный случай значит хорошо Ну понятно что также что с точки зрения клиента вот то что роутеров много это вообще не проблема типа там выходили там в один and Point нужно ходить в 2 Ну позже в подписи через запятую дописывать еще один хвост в конечностинг Типа все продолжает работать Проблема в том что мы должны Как бы на роутерах какую-то логику реализовывать То есть если сейчас у нас есть какой-то ключ который мы привозим между нашими то наверное к нему не надо обращаться на запись и вот всем вот этим вот занимается координатор он сообщает ротором Ну какие вообще можно запросы обрабатывать Сейчас Какие вопросы обрабатывать нельзя и своими данные то есть какие есть ключи какие есть правила шарнирования там где они все живут в чем то что называется Коди би Ну db это Database Q это буква которая мне нравится и y уже была занята поэтому кудиби бодибил нельзя Можно кудибил получается отлично так вот примерно для этого нужен координатор то есть когда-то занимается одну на самом деле нужно для того чтобы выполнять Ровно одну задачу хорошо это Перевести ключ между шардами Ну вот еще здесь написано что он занимается менеджментом ключей шодирования и Recovery Ну то есть если у вас выключился роутер то потом он поднимается у него могут быть старыми то данные нельзя разрешать сразу ему выполнять запрос он должен Подождать там актуальных метаданных и всё такое то есть Recovery тоже делает с помощью аккумулятора Отлично Теперь Чуть более значит детально про то что такое перевести ключ Ну вот есть значит нагрузка какая-нибудь Ну у вас есть какой-нибудь шагирование Например ключи от 1 до 10 и вы как-то часто допустим начинаете обращаться к ключу номер один ключ номер два прям настолько часто что Sharp на котором живут эти данные Ну на нем уже заканчивается все ресурсы которые на нем есть там память что для этого ну что в этом случае логично сделать логично взять ключ один и перевести его на другой шар чтобы размазать нагрузку более равномерно Ну ровно это мы сделаем с помощью каллятора Мы возьмем Значит все роутеры заблокируем на них какой-то ну там возьмем какой-то диапазон ключей распилим его на маленькие кусочки и начнем перетаскивать на другие шорты то есть вот не так как на этом слайде когда мы перетаскиваем половину данных а вот как на этом слайде чтобы как можно меньше думаем для Ну пока мы перевозим ключ с одного что-то на другой нельзя к нему обращаться не начни на запись поэтому мы не будем перевозить половину данных данным маленькими кусочками что для этого Сделано для этого у нас есть специально обученный разработчик который умеет тоже писать экшена и он написал extension который называется PG comm stats сейчас переключится слайд Ну в общем смысл этого extention заключается в том что мы можем агрегировать вот да есть значит extension который может ну который решает очень простую задачу он может сгруппировать запросы по каким-либо правилам так чтобы оценить вот значит Каким можно использовать для того чтобы понять какие диапазоны ключей больше всего загружены там по памяти по диску и соответственно с этим принять решение о том куда их перевозить отлично так пока переключается слайд не знаю даже что сказать Ну вот такой экстеншн Ладно неважно В общем Какая идея у всего этого ну нам типа не нужен какой-то продукт который бы решал очень большое количество очень сложных задач Нам нужен продукт который у которого есть там одна оригинальная идея оригинальный заключается в том что давайте просто будем выполнять 1/2 запрос и какое-то количество костей вокруг для того чтобы жить Ну не была настолько сложно то есть там какое-то количество встреч чтобы можно было этих как-то пользоваться Поэтому вот в Обычно Обычно мы запрещаем запросы которые обращаются сразу несколько шардам то есть на роутер прямо код написан который там случае если вы хотите данный из двух шагов то есть вас запрещаем это клиент получится ошибку протокол позволяет но некоторые вещи запрещать неудобно например типа создать таблицу через роутер Было бы очень удобно неудобно там братья на каждый шаг заходить прогонять какой-нибудь прогонять какой-нибудь миграцию чтобы создалась табличка для тестов гораздо удобнее делать так чтобы ну вот можно было какие-то простые запросы понять через роутер даже если не будет там какие-то очень плохие никакие снятные там не двухфазные транзакции вот допустим клей телом мы разрешаем и делаем его с помощью best of То есть это такая транзакция Просто берем и отправляем вашу Просто если выполнить то он выполняется если он упадет где-то на каком-то шаге то но это будет очень грустно но это не контролируем значит это не для Production или какого это просто если хочется что-то потестить то вот это удобно использовать также то что мы разрешаем это мы разрешаем Селект Star То есть если вы хотите поселить все Ключи из какой-то таблицы то Ну вы получите не сидят на результат но Мы это сделаем потому что это тоже удобно так вот здесь вот видно что creat able отправилась на все ширды вот здесь видно что себя Стар работает то есть у нас есть допустим табличка артику с которой есть просто две записи первая запись живет на первом что тебе вторая запись живет на втором шаге здесь видно что запрос выполнялся Хотя Казалось бы он не роботится взяли его отправили и поджог или результаты там у нас есть специальное место где написано специальный код который говорит что типа если здесь пришёл до второго и здесь пришёл этот роут то вот ну попробуем их как-то совместить если они разные то всё плохо если они одинаковые там попробуем что-то ответить клиенту это всё это не кастетный листинг допустим его можно использовать только для блага какого-то для настоящих типа вот если бы прямо хотим хороший трудовые запросы как ты выполняется но мы хотим наверное то нужно делать то мы будем использовать другой подход так Это я уже говорил короче сейчас как мы все-таки хотим выполнять судовые запросы Ну на самом деле то есть сейчас мы допустим это как-то не поддерживаем Но вот в будущем в будущем будет такая штука роутер он хорошо делает одну вещь он хорошо выполняет запрос если он может выполняться на одно шаги Иначе мы хотим просто делать на некоторые некоторые нечто Что называется Волжский Что умеет собрать какой-то консистентное представление данных как-то атамарно выполнить в них какую-то операцию или как-то данные с разных шардов для этого мы смотрим в сторону ситуса на самом деле то есть Было бы отлично если бы могли использовать ситус для этой задачи но также есть вариант делать Не ситус а для кого-то на самом деле потому что в нем уже есть планировщик орка который очень модуль на него можно использовать можно для этой задачи Вот использовать ситус или Green Club мы пока еще не знаю чем мы хотим из этого использовать но это не наши сна кейс на самом деле не волнует очень хорошо так и дальше Денис расскажет про бенчмарки и про всякие другие интересные вещи не работает можешь мой поговорить что все работает все спасибо большое Так я вернулся на сцену собственно ребята из пост вы видите какую-то табличку тут какие-то чистилки ребята из позже померили наш роутер сравнение с другими решениями другие решения и сам постгрыз и в целом и можно не считать В целом вывод такой что это как-то работает и вроде даже хорошо работает А верхает в сравнении с ванильным возрастом Не такой уж большой но нам нужны были пруфы самим хотя бы что это точно хоть сколько-нибудь работает я погонял бенчмарки с бенчем провел несколько тестов и нам нужно было проверить что да При добавлении новых шардов говорил это не увеличивается это так давление новых шортов не добавляет времени выполнения запроса второе нам хотелось померить все-таки какой оверхед на добавление на использование роутера и в моих тестах У меня получилось примерно от 8 процентов до 20 процентов не знаю насколько можно доверять этим результатам просто типа это факт теперь для тех кто не понял как этим пользоваться Это нормально Короче было много слов сказано но непонятно как этим пользоваться вот сейчас для вас будет демо Надеюсь все прояснится Ладно подождем суть в чем немного забудем пресс-пауэр вот Представьте есть такое приложение которое как будто бы как бы агрегирует новости называется агрегатор новостей News Demo оно состоит из двух штук Это буквально РСР лент и сервер который вот эти на партии статике отдает внутри этого приложения на самом деле вот лежит такая простая табличка артикул который там есть и описание и внутри этого приложения используется когда запроса Select Star из таблицы и вставка какой-то статьи в таблицу при этом заметьте мы вставляем не просто так мы вставляем Хеш от урла вот этот хешек он как бы строку Маппет в какую-то чиселку чтобы это это очень странное предположение что у статьи будет один и тот же URL Но вот это так работает Просто URL преобразуется в какую-то чистилку Итак чтобы запустить это приложение нужно буквально сделать Make там два бинаря запускаешь 2 бинаря указываешь как подключаться к базе В общем ничего сложного и как начать шортировать такое приложение первым этапом это первым тобой является собрать из исходников запустится покупая настроить шортирование настроить эти вот правила шортирования которых говорили раньше и запустить приложение Итак спбёр эта штука выложена на гитаре всегда было выложено на гитхабе и будет выложен хабе и всю разработку мы ведем ведем там можно Кстати если чего зайти поставить звездочку нам будет приятно мы собрали Мы зашли короче поставили звездочку собрали роутер запустили роутер вот запустить роутер следующий этап у роутера есть конфликт в котором указано какие-то общие дефолтные настройки типа уровня логирования или показывать ли вот эти сообщения или еще что-нибудь там указано правило как подключаться к роутеру там указаны глобальные правила как подключаться у имя пользователя название базы И там список шардов это весь этот текстовый конфиг роутера также у роутера есть административная консоль Да представьте спукуар уже запущен к нему можно подключиться по двум портам один порт это штука которая вот эти вот запросы обрабатывает другой порт который ты подключаешься чтобы вот эти правила шортирования сконфигурировать то есть буквально что происходит берем подключаем все консоли мы делаем шоу sharks Да видно что есть вот такие шарды прям как в конфиге и добавляем shardin.ru название по такой-то колонке ID все видим что шардин рулл добавился теперь добавляем же то есть с какого по какой айтишники на какой шар отправлять его тут буквально написано что айтишники с одного по X отправляя на shard 1 айтишники с X по 2x отправляй на Sharp 2 тут Это буквально написано можно кстати не читать Теперь мы можем действительно посмотреть Что добавилось такое правило шортирования добавился такой же и можно Подключиться к роутеру Да роутер начинает эти правила использовать но суть в том что там дальше может было бы написано что мы делаем запросник который Ну допустим Select в ID равно 1 и мы точно знаем что этот запрос заведомо должен попадать на первый шарт и о чудо это происходит или за про запросит типа Select в очень много а вот так вот Окей был нормально начинаем скорее Table вот мы видим тут что Create был отправить на оба шарда потом мы пытаемся делать селекции видим что они действительно попадают на один шард на первый шаг на второй шарт В общем Суть в том что наше приложение Ну вот так вот начинаем шортировать то есть ничего даже в самом коде приложения менять не пришлось Окей в принципе да это тоже чем я говорил в принципе я уже сказал да Раньше у нас открытый процесс разработки У нас есть репозиторий Можно нам помогать И мы бы были бы очень рады если б нам кто-нибудь помог и попытался запустить эту штуку то есть буквально спланировать репозиторий и сделать мой экран у нас есть Telegram чатик в котором можно задавать вопросы Мы были бы очень рады если бы кто-то когда-нибудь нам когда-нибудь кто-нибудь попробовал и нашел кинь баги пришла прислал нам фичери квесты это было бы очень полезно Также можно запустить этот демо-приложение оно живет в соседнем репозитории всё на этом все спасибо про лучший вопрос еще давай так мы ждем вопросы и за лучший вопрос будет какой-то подарок но я его не вижу Если честно вопросы погнали первый даю свой Всем привет Спасибо за доклад Скажите как вы боретесь с коллизиями например Когда шардирование происходит по округу то есть там с первого по 10 в одном и так далее Это понятно но сами данные могут прийти могут быть по-другому настроены В итоге данные перетекает из-за того что там другой И если они перетекает ещё не совсем удачно то сами данные могут остаться на двух сортах и в итоге когда мы пойдём отпрашивать через роутер вашей схеме по всем шарам то мы получим одни и те же данные и как вы группированы когда мы будем на роутере спрашивать там всех Стар допустим он просто не сможет получить эти данные которые ещё не до конца приехали потому что мы заблокировали ключи блокируете Там есть ну такой достаточно просто говорит который блокирует какие-то ключи вот там есть тебе все вот это дело когда поддерживает такие варианты что вне зависимости от того В какой момент ты выполняешь Вопрос на каком роутере ты всегда получаешь данные как будто Роутер 1 А если роутер один то понятно Каким образом ты гарантируешь А вот extensional который вы говорили который перетекает из одного шанда в другой он берет сколько не совсем немного данных чтобы шарт грубо говоря там секунду только был заблокированный Просто какой-то маленькое количество да Ну время не могу сказать но смысл в том чтобы переезды Были очень маленькие следующее когда берётся через как рассчитывается вот эти вот сейчас могу сказать что никак не рассчитывается просто данные приезжает подряд Наверное это может записать да Спасибо большое вопрос из чатика Как вы обеспечиваете консистентное состояние метаданных в нескольких роутерах полученных от координатора Могут ли два последовательных запроса в разные роутеры уйти по ошибке на разные шарды Ну нет то есть значит как мы гарантируем кастетность Ну вот у нас есть код который ты гарантирует я даже не знаю как это рассказать это долго Ну мы занимаемся тем что вот допустим у нас есть какая-то система из двух роутеров у них есть какие-то данные значит если мы ничего не меняем все хорошо если мы хотим перевести какой-то ключ с одного шарда на другой то мы занимаемся следующему блокируем этот ключ на Первом что ли блокируем потом перевозим данный физически после этого меняем метаданные так чтобы вот они указывали на другой шарт после этого разблокировая значит оба роутера разблокируем эти диапазон ключей и всем этим занимается Ну если это ответ на вопрос я не знаю если не ответил Напишите в чате поругайтесь Следующий вопрос я хотел спросить вопрос Чем отличается вот подход выглядит так как будто бы процитирование Но делает примерно те же задачи или вы хотите просто контролировать именно то на каких шардах то Что располагается для более точного контроля Так мы контролируем на каких шардах Что располагается Green Plan для аналитики У нас oltp вот разница с перформа сидел Ну окей нужен для лоб нагрузки там соответственно тоже может задать куда она распределяется распределяется на разные соответственно Если попробовать использовать гримплант волчки нагрузки там получится очень плохие числа если Ну то есть Спасибо Спасибо что с транзакциями если на них планы вообще и второй если это Вроде это еще в конце Какой первый вопрос что с транзакциями что с транзакциями если их ещё нету Какие планы на них не ну транзакции то есть значит в роутере написан прям код который занимается тем что он поддерживает состояние сессии То есть если ты сказал Беги то мы запомнили у себя в мозгах что у тебя сейчас если ты ну отправили следственный беги на тот шарт на котором ты будешь выполнять свой запрос потом ты присылаешь свой там первый Селект мы его отправляем у тебя транзакции открыто ты выполняешь seart мы отправляем всё что там тоже открыто транзакции если ты отключаешься то мы тебя лбачим Если ты сам решил запомнить то мы прислали только МИД в этот шаг то привязан Можно я попробовал по-другому ответить А те запросы которые выполняются на одном шахте консистенты те запросы которые наполняются на всех не консистентны всё там даже если вам транзак да попросили э-э это мы делаем мульти шар запросы просто для того что бы я не знаю как просто принять нашу наилучшие усилия вот так вот типа условно вот cree Table если бы вот не было вот этого мультишар запроса как cretable пришлось бы заходить на все шарды и всё равно создавать таблички как-то не консистент мы можем написать транзакции в роутелем просто это не делаем хорошо Ну транзакцион работает Это садовый запрос Ну скорее вопрос в том и планировать замену либо нет получается нет И второй вопрос - Это уже где-то есть используется У нас есть доктора но у них пока Спасибо Отлично вот с этой стороны еще есть вопросы параллельно смотри qdb тоже должна масштабироваться не должна масштабироваться там метаданных буквально на там реально очень мало да то есть на мегабайты это не нужно мегабайта это даже много для кутипи хорошо У кого микрофон у меня А вот пожалуйста я правильно понимаю что координатор это Battle nake всего этого решения что с его надежностью и так далее Потому что но он типа да это одна тачка но нет никакой проблемы там сделать тоже какой-нибудь такая штука которая администраторы грубо говоря запускает чтобы перевести ключи в доме там не очень нужна какая-то устойчивость То есть тебе нужно чтобы запросы просто работали вот роутеры просто работают для заранее скопированных правил Если ты хочешь их понять ты используешь координатор Ну если упал пока ты меня отправила типа подними и второй вопрос говорили насчет транзакций Что будет если блокируется набор если у нас открылась транзакция а затем у нас начал перетекать с одного шадана Другой у нас откатывается вся транзакция короче если ты начал выполнять транзакцию и при этом привозят ключи да да Ну если ты начал выполнять транзакцию то на роутере на котором ты выполняешь закцию Мы возьмем блок на тот диапазон ключей которые он сейчас использует координатор который захочет привести ключи попробовать взять локоны скажем роутере и не сможете снять блокнотом роутере который сейчас общается с этим диапазоном ключе то есть будет ждать пока транзакции закончится спасибо Вот 18-28 под конец уже прилетел прилетел вопрос какой-нибудь Значение Вот такой сбд для каких задач она предназначена в которых все другие не подходят в которых все другие не подходят другие сободэ видимо Ну вот часть про которых все другие не подходят это очень сложно но в целом Если у вас есть какая-нибудь сервис который может допустим хорошо шодироваться типа по юзерам или по каким-нибудь там баке там неважно типа то вы можете использовать практически то же самое что у нас используется других сервисах где шортирования просто обобщенное решение можно маску в Twitter предложить пожалуйста ребят Спасибо за доклад зовут Дмитрий есть такой кейс существует база данных и авторы база данных которые любят хранить таблицы которые нужно шортировать и таблицы которые не нужно шардировать одно и той же схеме и любит там например посадить джабу которая будет раз 15 минут ходить в локализацию собирать свежую локализацию дизайнеров заливать базу потому что удобный способ интегрировались Зачем еще завозить Расскажите поддерживается ли Будет ли работать Я слышал Утверждение что ЛТП там всякие запрещены запросы в несколько шардов запрещены если это не Селект звездочка Вот это не бьется с этим кейсом и если планы я понял вопрос я попробую на него ответить или не попробую Я короче думал об этом и чисто мои мысли Мы конечно это пока еще не обсуждались ребятами но очевидно это еще зависит от того что это за таблицы вот эти таблицы которые не шортируются Они часто изменяются или не часто изменяются если не часто изменяется то у меня есть решение Ну может еще зависит от того Большая таблица спрашиваешь хотим ли мы делать трудовые запросы в будущем смысле у тебя есть табличка которая хорошо делается Но рядом сервисе еще таблицы которые ты бы не хотел шортировать и для которых ты бы хотел стать они должны жить таблицы которые не только не хочу шортировать я хочу их иметь одинаковыми сделать Да у нас есть такие случаи мы но это короче вот я не знаю насколько рабочие Кстати да вот если ты не хочешь шортировать Возможно все-таки ты можешь её шортировать если ты шортировать но вот если вынести все эти таблицы какой-то отдельный кластер и подключаться Shadow fdv короче к этим к этому кластеру Вот будет ли от работы я не знаю но я хочу писать запросы с джонами на эти да и Каждый кластер должен выдавать результате там с айдишником моего там условно кастомира или там мои там конференции и её локализованным именем из документика который залили дизайнеры Короче давай так у тебя есть ответ на этот вопрос У меня есть предположительный ответ на этот вопрос я короче понять не имею Будет ли это работать обязательно следующий раз когда придем что-то рассказывать вспомним и расскажем об этом типа мы по-любому короче это решим Спасибо Надеюсь кейс был полезен вот эта фишка парного доклада У меня есть друзья там на вечеринках все время жена задает вопросы а муж на них отвечает и короче всем остальным участвовать в дискуссии нельзя Будьте добры вот три раза мы вам не давали задать сейчас Добрый вечер подскажите пожалуйста основная задача горизонтально масштабирование есть какое-то количество максимального шортов Жалко что я вот изначально в тысячи шардов но к сожалению у меня не хватило квоты чтобы создать тысячу шортов я запускал тесты Ну вот я говорил что я проверял Действительно ли что при добавлении шортов не увеличивается Здравствуйте я смог создать запустить роутер с двумя четырьмя восьмью 1632 64 и на 90 у меня закончилась квота я не смог протестить это Но вообще мы целимся в это и как будто бы действительно сможет 1000 шардов держать роутер то есть один Ну два роутера как будто бы вот ну вот на 80 точно типа 890 держит Следующий вопрос Нужно ли будет увеличивать количество роутеров зависимости от того Какое количество шардов Ну то есть какая-то зависимость будет Или настолько два месяца вот всё Ну типа если один роутер не вывозит давай рядом второй поставим в целом логика была такая Окей спасибо спасибо до Андрей выставлю Здравствуйте продолжим тему мигрирующих шардов смысле мигрирующих данных шардами пошел запрос запрос отработан роутером в запросе в данной конкретный момент указываются те данные которые поехали шарда Шарм Как выглядит процедура отработки этого запроса со стороны клиента ожидания ты ждёшь Локи Да понятно Значит данные уехали это как бы Спасибо первым на первый вопрос Это так было значит Вопрос номер два данные Поехали Да ну ехали на другой шарт перед этим данные брали с первого шарда ошибка да да ошибка ошибка откатывается То есть пока вот в данном варианте это все в продакшене чрезвычайно К сожалению но неизвестно сколько часто Вот именно этот Иисус призывается Так что просто если данные меняются постоянно если данный перевозят постоянно данный перевозится если данный переводятся постоянно Значит мы что-то делаем не так К сожалению это вопрос объёмами то есть если там где запрещается то у нас идея перевода заключается вопрос Вообще специалист по перевозу данных У нас вот во втором ряду сидит Да жалко что он не вышел не выходит в этот раз на сцену но я думаю можно к нему подойти потом поспрашивать как это могло выработать у меня ощущение что это Объединенная экзаменационная комиссия сейчас накинулась ребята вдвоём считают диплом Да будь добры отсюда потом здесь по традиции два вопроса Первый вопрос вы показывали такое SQL интерфейс кроутеру А вы правила шарнирования и также в специальной базе данных которые на стадии называлась кудиби то есть типа ты создаешь вот как на слайде было написано это для простоты типа когда у нас один роутер мы можем просто у него в памяти менять правила Но на самом деле правила создаются через координатор гранатору сначала записывает какую-то база данных потом рассказывает всем роутером какие у них теперь правила А это база данных она отдельно ее нужно отдельно поднимать чтобы все это работало это база данных она в ней там полтора мегабайта короче хранится даже если очень много правил То есть это не должно быть проблемы и второй вопрос У вас же на год есть библиотека которая умеет делать вызов в эсор и возвращать Там просто структуры То есть это очень удобно не надо делать после этого ну определяете в какую шарту Да он возвращает просто дерево вот прямо как структура данных вот в возрасте описаны все вот эти вот я к файлы вот прямо вот этими с лишними структурами только ну аналогами в год вот такая штука возвращается Спасибо но ты начинал Ты завершай есть такая часть скажите еще Созрела Вопрос такой что если мы представим совсем высоко нагруженный проект и там миллиарды запросов секунды к одной таблице которую нам нужно перевести и у нас меняется ключ мы начинаем перекликать данные из одного в другое и вы сказали что у нас становится Лог на на вот этот объём данных если этот запрос требует Ну перебора всех шортов то получится на все э-э данные шорты и соответственно пока нагрузка не спадёт она может вообще не спасти то и мы не наполним там новый шар и она просто данные не будет критикать или будет наоборот очень очень много ожидания от базы данных от роутера что соответственно тоже может привести к печальным последствиям на нагрузках вопрос в том что будет если данный долго приезжает правильно вопрос в том что есть я могу представить как вот эта схема работает на ненагруженных проектах То есть у нас база данных сидит ничего не делают у него появилось время и данные поплыли при перетекать А если Ну там сильный сильный лоуд на на роутер то тогда у вас не будет времени на перетекание данных и соответственно вся эта схема ломается Короче я не понял просто я тоже не понял сейчас давайте в куларах и отлично Да я понял вопрос я отвечу суть такая что у тебя очередь блокировок общая у клиентской нагрузки и у сущности которая перевозит отлично Все друзья у нас с вами 7 минут еще до до второго ужина Давайте ответим еще в интернет Здесь был вот такой вот такой вопрос вот здесь смысле речь идет про Green Plan или сайтус это что мы хотим выполнять Что будет если утро потеряет связь координатором если не смог отправить команду на блокировку Ну клят они перестанет работать роутер если потеряет связь с координатором старые правила и типа он мог не отпустит допустим то есть а теперь анекдот Кому мы подарим приз за лучшие вопросы да можно задать Я думаю можно еще вопрос задать Да конечно Вот вы говорили про то что у вас кросс-шардовых нет запросов а мульти шардовые возможно но например сделать из селекта то есть оно на каждый шард раскидывается и там локально это делается Такое возможно но мы не хотим поддерживать традиционность всего этого дела поэтому делаем так интеллектом Ну я запишу в голове у себя я запомнил ты еще вопрос Это были русские хакеры они отобрали у волонтёра микрофона и задали вопрос Когда уже нормально А сколько у вас призов Да мы хотели подарить его тому джентльмену и сейчас мы его только найдем он был тут Кирилл Денис вам памятные призы от хайлу за выступления друзья Ну что ж это было прекрасно и завершение первого дня"
}