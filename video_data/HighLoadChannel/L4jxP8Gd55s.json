{
  "video_id": "L4jxP8Gd55s",
  "channel": "HighLoadChannel",
  "title": "Мультиплеер на Go+Lua / Sergey Lerg (Spiral Code Studio)",
  "views": 1181,
  "duration": 3242,
  "published": "2018-08-16T04:50:36-07:00",
  "text": "всем привет надеюсь вы хорошо покушали поэтому у вас будет немножко вырыли глазные слайде ки и нужно такой нас на голодный желудок вас тяжело смотреть меня зовут сергей lirc это у меня собачка слева это значит можно подписаться на меня в твиттере или в инстаграме но вы 100 грамм не подписывайтесь лучше в твиттере там я публикую ссылку на слайды к этому докладу и буду там еще всякие полезные ссылочки так что обязательно запомните сергей ярко-ярко легко запомнить это как серга только l 1 очень важная информация да и сегодня 7 ноября на и барда мультиплеерного и lugo так теперь нам нужно познакомиться вот у нас похоже все кто хотел зашли и ты хочешь нам нет не захотел давайте познакомимся я разрабатываю игры на lua все и а кто же вы то есть поднимите кто из вас не занимается game by вам здорово теперь оставьте руки меня подними панелью оставьте руки те кто хочет заниматься другим делом вы молодцы от всегда нужно заниматься game jam потому что без геймдева жизнь очень скучно все эти серверы баз данных репликации кому-то надо по шпили тебя что-нибудь кто-нибудь играл starcraft на по модему вот это это здорово это мне нравится то есть целевая аудитория то есть нас геймеры собрались большинстве до базы данных геймера и базы данных созданы друг от друга теперь кто пишет на год замечательно кто пишет на lua замечательно чем я там еще было а кто разбирается в сетевых технологиях и мультиплеере меньше всего вас людей в общем у меня немножко несколько частей составить доклад и они все между собой переплетаются и мне бы хотелось бы понять на чем больше уделить внимание вот будет провала будет прагой и будет про сетевой взаимодействие и в сети у нас будет в первую очередь поэтому кому больше интересно сетевое взаимодействие то есть там протокольчик и и все это такое как там работают в дипе теперь все такое но довольно много мы хорошо значит расскажу про этом в чем lua язык это прекрасный если вы его не знаете вы его обязательно посмотреть м он учится за 1 день если у вас уже есть какой-то там навык в лего скрипте что он в питоне не знаю все быстро очень изучите его учиться не задень но там немножко нужно не голову не повернуть но после того если вы узнаете то зго довольно быстро подружитесь как по крайней мере я подружился и потому что в них есть схожая идеология то что было ничего лишнего нет и в go ничего лишнего нет мне вот этим она и больше всего понравился еще много людей нога переходит с и php из питона с печки понятно потому что там надо больше производительность но спит он тоже больше производительность но с печки еще немножко ну там много причин по которым переходят на не будем об этом не будем о грустном и напиток из питона почему потому что многим кажется что go очень похож о синтаксису на питон в том плане то что так же вроде как все и лаконично как будто это динамический языка на самом деле он компилируемый язык и работает гораздо быстрее питона ну и как можно было не изучить горе если у него такая няшка в git видео mascotte если бы вовсе плюс плюс был какой-нибудь котенок то он бы тоже был бы менее страшным и больше бы людей его знали кто знает си плюс плюс поднимите руки но по-моему а наверно да здорово так поговорим про мультиплеер почему мультиплеер ну потому что это тяжело и круто есть у нас два мультиплеера это пошаговый и real-time пошаговый это нет real-time это значит когда вам нужно одну каждая миллисекунда у вас на счету вам нужно молниеносной реакции там у вас какой нибудь пользователь нажал на курок выигрывал в игре там отправилась это все на сервер там это все обработалось и нужно быстро быстро быстро это все сделать не столько важно пропускная способность там килобайт в секунду мегабайт в секунду а вот задержка между откликом и взаимодействие то есть так называемый кинга в играх и гель-лак его называют пошаговые мультиплеер это как отличить его если вы играете в игру в лесу на 2g интернете и вас это не бесит что это либо пошаговая игра либо у вас железные нервы реале способы реализации пошагово очень скучные это простое чем у вас есть какая то база данных у вас есть как может быть риск запросы и вам задержка не нужно вы подправлю отправили пакетики поездом в харьков он вам пришел обратно тем же самым поездом или по этому почтовому голубям вот и выйду друг друга обмениваясь информацией и передаете друг другу шаги как раньше играли в шахматы по почте было такое затея в общем real-time джин он строится уже сложнее в том что нужно минимизировать издержки задержек и используется теперь дпс том плане что youtube и он побыстрее будет в кости за девка плане задержек мы посмотрим почему в общем и игровой процесс чаще всего строится в оперативной памяти и сервера если бы пошаговые можно складывать все базу данных я туда потом выковыривать когда у нас приходит запрос то в мультиплеере real-time но нам нужно 10 сейчас все данные и держать и где-то в базе данных не имеет смысла но здесь мы не говорим про какие-нибудь там lpg когда у вас есть какие-то аккаунты какие-то там шмотки в инвентаре которые у вас сохраняются при потери соединения все такого это уже такая смесь рилтайм туристы и это относится уже к база данных и обычно штукам то есть там это в принципе все то же самое работает creatine мультиплеер это мало имеет значения вот это знаменитая картинка уровне асиф по распределению трафика то есть вас есть там физический уровень транспортные и уровень приложения с картинка страшная но не бойтесь нельзя так просто взять и рассказать про мультиплеер не задену не задев какие-то не за низменные низкие низкого уровней вещи вот поэтому она больше понадобится только три вещи три блока отсюда всего этот тисе пи и дпм и ешьте тебе все то есть все остальное нас принцип почти не интересует нам нужно только иметь в виду из этой картинки то что это происходит здесь происходит наложение всех графиков то есть у нас есть ethernet сверху в него инкапсулируется там айпи протокол сверху ти себе сверху у нас еще наши данные то есть все эти наложения не играют роль если мы используем тисе пи который соответственно работает по с hdp этого у нас каждый тисе пи заголовок он у нас несколько некоторое количество байт занимает по 20 до 60 зависеть от его конфигурация это немного но если мы посмотрим а если мы посмотрим на схему взаимодействия клиента сервером то увидим что они передают между собой не отдельные какие-то закончены блоки тисе пи пакеты а они туда сюда всякие там подтверждения делают соединение установка соединения всякие сенную сины seiko ок а вот это вот все и то есть если вы хотите отправить одно одно число с клиента на сервер или обратно то это будет не один и пакетик это будет много 10 пакетиков и это нужно учитывать при разработке мультиплеера отсюда у нас появляется и задержки эти себе и типе свою очередь гораздо меньше занимает места на верните и всего лишь 8 байт и дальше уже идут данные но естественно у него идут и свои недостатки в том плане то что как он передается по физическому уровню то есть у нас есть вы хотите отправить одно число отправляйте и у вас получается 1 и 2 пакет ни больше ни меньше но у вас не устанавливается соединение соответственно если принимающая сторона не готовы принимать этот пакет и он потеряется если не знаю произошел обрыв или какой-нибудь там сетью реструктуризировать и пакетики потерялись посетим то не принимающая сторона не отравляющие не будут об этом ничего знать поэтому и дипе программировать тяжелее в том плане то что нужно учитывать все эти недостатки и теперь каким-то образом их нивелировать либо у вас за счет просто геймплея вам неважно эти потери то есть вас вы отправляете там не знаю 100 пакетов в секунду вас там хоть один из них дошел какой-нибудь то это уже нормально либо вы используете какие-то дополнительные меры общения то есть и дипе пакетик установки соединения потом раз в секунду вы посылаете youtube пакетики с пингом чтобы знать что вот я еще живой не убивайте меня не отключайте от сервера и какую-нибудь метрику может быть отправляете чтобы все это было более-менее надежно работала в общем преимущества и соответственно недостатки и различать и дипе когда вы выбираете зачем строить свой мультиплеер то есть и себе у нас устанавливает соединение вам не нужно самим что ты на этом поводу изобретаете у детей у нас работает без соединения тисе пи может отправлять потоковые данные это значит что вы когда устанавливаете себе соединения вы открываете socket знаете наверное такое слово this is a key to tell этом кто-нибудь пользовался заходили на сервер и куда нибудь вот дополняет это вот очень близко к которым ты себе соки там что что-нибудь напечатал на одной стороне но на другой отобразилось и с другой стороны так же само по себе у нас дает гарантию доставки то есть там если пакетик оправился то он точно будет доставлен либо вернется ошибка о том что он не был доставлен у насти себе обрабатывает все разбиения пакетов на составные части и потом их перри сборку на стороне принимающий чтобы все-все байтики которые вы отправляли они были четко как нужно как вы задумывали если вы ее много отправляете то они могут прийти с разной скоростью и у вас может сначала например прийти действия то что вы стрельнули язык и из оружия а потом только действия то что вы достали оружие и по соответственно на сервере поменяется логика и на геймплей будет сломанном то есть будет произведен стран синхронизация так называемая вот ту себе за этого мы за всех этих проверок больше задержка у и т.п. она меньше но уйти есть еще одна проблема фрагментации как раз таки потому что он этим не занимается то что точнее не не тот недостаток а такой нюанс то что у нас есть у дети пакетики он у вас может быть большим когда мы отправляем его по протоколу и ppi у нас все они развиваются на несколько частей на в соответствии с intel то есть если мы отправляем большое пакетик тон у нас развивается на несколько и ожидаемая наша и то есть на принимающей стороне пока все эти составные части кусочки не придут то ваше приложение не получит этот риддике пакетик соответственно получается еще задержка поэтому для максимальной скорости для максимального максимально быстрого мультиплеера нужно использовать юге пин с простой структурой данных передаваемый чтобы они укладывались в большинство стандартных мтюм тириону примерно там 1500 байт может там 700 байт у кого на разных сетях мы разному это настраиваться на примерно такие значения как но обычно этого хватает то есть там координаты x y там 8 10 байт координат действия игрока прыжок влево вправо в принципе это все укладывается если мы говорим о таких играх если у вас там передаются не знаю целые куски карт или там какая-нибудь сложная анимация движения то это занимает очень много места на трафике соответственно будет тяжело серверу от этого общая проблема с портами каждому приложению нужен порт и если у вас игра вы говорите вот за бензин себя на парте 3000 люди пишем и 10 или типичном вот а потом какой ни другое приложение тот же самый порт используют стал у вас появляется конфликт и соответственно нужно всегда проверять какие порты вы из какие порты не заняты какие порты можно использовать и договариваться с сервером передачи данных поэтому очень часто пользуются связкой у детей с дцп пою тебе отправляются данные уже непосредственно игровые по тисе пи идут данные о например состояние соединения данные о настройке изначально то есть как раз таки прописать все эти порты или выбрать сервер например если вы играете на нескольких если доступно несколько серверов то соответственно вы выбираете тот который бы к вам ближе и по тисе пи можно это сделать договориться об этом поэтому связкой удивитесь и она довольно часто используется но некоторые заморачиваются за и диппер рила и был так называемые то есть это все общее общее название от когда вы делаете собственную реализацию надежно выйти без проверка ошибок с проверкой соединение вот чем я говорил keep-alive пакет и пинги например про очередность вы можете отправлять клиента номер пакета который отправляется и на сервере проверять если это номер получился внезапно не тот с пропуском то вы соответственно тот который уже был придет после этого если он придет то он уже будет невалидным и его отбросить сервер уже уже какая-то форма но к нам пришли браузеры и веб и программировать и сию тебе стало то чтобы стало сложнее программировать а стало сложнее его использовать так как злые системные администраторы я системные администраторы здесь где-нибудь один ты злой 2 нет по бороде видно что добрый в общем злые системные администраторы они блокируют весь трафик который не по 70 порту или 433 и говорят никаких вам игрушек на рабочем месте казалось бы чего плохого и сложно сложно играть поэтому люди стали играть в браузере а в браузер и очень не любят тисе пи и диппер в том плане то что конечно у вас есть http и архетип э.с. но блин это совсем не то же самое что это сырые тисе пи соки так которые можно что угодно flight чем связано да они плохие то что у нас появились firewall и которые блокируют порты у нас появились роутер и которые и на ты где нельзя просто так открыть на своем машине порт и сказать сервер олло вот ли мне да ты ли мне данные вот на мой порт потому что роутер все это дело просто не сможет правильно переадресовать если не используются механизмы так называемый у диппера ума панчи холл когда роутер и клиент между собой договариваются о том что вот ладно и я вот я вот хочу у себя открытию ди би порт такой-то а роутер будет любезной пожалуйста вот эти вот данные которые на этот пор будут приходить вот камни пересылать тогда это будет работать но да это работает не всегда опять же прокси и фильтры то что например можно даже если вы используете и 80 порт для своего tcp сервера фильтр смотрит то что это не ешьте типе трафике просто тоже его может заблокировать не пустить дальше и у нас всеобщее тенденция к безопасности то есть у нас все соединения в 2017 году уже должны быть по https с шифрованием для игр это конечно не так страшно но уже тоже нужно к этому двигаться шифрование накладывает свой той же отпечаток и если кастить фифа пакет у нас выглядит вот просто как небольшой кусок текста то есть байтом сто-двести дополнительно их который вам нужно каждый раз перед ссылать то хостить ps у нас будет еще хуже потому что нужно еще пересылать различные ключи и договариваться то есть это пока соединение у нас установится у нас уже все игроки разбегутся если мы делаем мультиплеер быстрее и соответственно ничего хорошего не произойдет вот и еще html5 то что у нас идет общем браузер и становится мощнее то есть они уже в как в принципе игровые клиенты годятся уже несколько лет и можно мне делать довольно тяжелые игры у которой работают просто в браузере и люди будут играть и играют html5 сейчас сильно растет игра в этом плане методы работы мультиплеера по ищите это если мы говорим например про пошаговый парту им бересту нас есть полинга и long polling кто знает разницу сразу из зала немного человек значит то что сейчас вам расскажу будет полезно полынь когда когда вы как дятел атакуете сервер и говорите ну готовы уже готового готово и можно уже ходить на можно я скажу пожалуйста и несколько запросов и на каждый такой запрос сервер отвечает типа нет нет нет-нет и потом когда наконец наступает ваша очередь на твердом и ваш соперник передвинулась шахматную фигуру теперь это ваш ход и теперь вы можете свою фигуру подвинуть и вы отсылаете уже данные со своей фигуры соответственно можете представить какая то нагрузка на сервер если у вас клиент и присылает тысячу запросов в секунду чтобы просто попасть поскорее отправить свой и очень ему не терпится и либо у вас просто не клиент дебила у вас их много например 1000 тех же обычных пользователей каждый секунду долбящей ся к вам на сервер это тоже мало хорошего все эти трафик то есть вот этот бесполезный трафик все эти установки соединения не съедают кучу места у вас получается вот от такого пакета вот такая вот маленькая польза а все остальное это флуду или доз как любят говорят когда открывают какую-нибудь сервер с популярной игрой он в первый же день падает от наплыва игроков потом разработчики говорят то что мы были атакованы злобными русскими хакерами и не смогли справиться вот long polling делает немножко хитрее ситуацию вас клиент отправляет запрос на сервер но сервер не торопиться с ответом он говорит такая подумаю то есть и как только соперник сделает свой ход тогда сервер уже будет знать что ход сделаны можно клиенту уже ходить делать свой ход поэтому соединение устанавливается 1 сервер ждет ждет ждет то есть власти себе socket открыт соединение открыто и как только у вас появляется а какие то данные которые клиент хочет вы эти данные отравляйте от сервера у вас получается много открытых соединений на сервере и если вы используете например печки который один instance на одно подключение то если у вас там 10 тысяч игроков которые все время представлю сколько представьте сколько ресурсов это будет жрать на сервере поэтому используют сервера которые один instance обрабатывает много подключений и между собой данные туда-сюда перекидывает после того как сервер отправит данные в лондоне кто клиент опять устанавливает long polling соединения и ждет уже свежую порцию данных от сервера либо просто обновляет свои данные и там уже ничего не требует от сервера если это можно по-разному сделать реализацию вот поэтому long polling хорош но все равно там полу валяется вот эти вот между между запросами все равно этот бесполезный трафику перри создавание подключения вот я также можно данные присылать сделать rest поднимите руку кто знает чем рост отличается просто http вот ну довольно много поэтому можете сразу можно сразу всем сказать то что рис это полная фигня для game by вы не используете его а просто пользуйте просто одним постом плюс джейсон и то есть когда вы делаете rest вы учитываете там всякие другие ощутите пихай дыры вроде точнее и голы вроде but be late апдейт опять в смысле вот и у вас например может быть на пути создания игрока патч это может быть и вы передаете изменение положения игрока делает вы может говорить вышел из игры но никакая граф в такие рамки не вписывается и чаще всего разработчики пересылают либо свои какие-то бинарные данные с постом либо jason jason очень удобен в плане реализации работы как с клиентом так и сервером то есть для веб-разработок это прям там сама это java скрипта и пришел и быстро перекочевал и в другие все языке то есть и нагое налога с ним есть библиотеки с которыми можно работать комфортно еще удобно с джейсоном делать дебаг то есть вы открываете в shark либо какую-то другую программу для мониторинга трафика видите как ваш там знаю соседа качают фильмы непристойного содержания и одно небожитель и код своего сервера для интересующихся трубы с мультиплеером и вообще как работать нога с просто простым и ешьте типе у меня есть статья на хабре про это там тоже есть lua то что так что те кто работает слова тоже мог будут полезно это почитать а я на этом не буду оставлять уделять этому внимание потому что это довольно много времени занимает у нас не такого много поэтому все кто хотел сфотографировать а там уже сфотографировали теперь придем к веб сокетом поднимите руки кто знает как websocket и работают опять же где-то половинка может быть меньше половинки так что все равно я вам расскажу никуда вы от этого не денетесь websocket это ешьте типе который делает который изменяет свое содержимое на сне свой режим работы на socket то есть вас идет куча бесполезного трафика одна установка соединения и степи то есть эти заголовки потом вы к этим данным добавляете специальные слова не пожалуйста апгрейт и connection и сервер понимает что вы от него хотите как раз таки установки соединение по протоколу websocket а если сервер это поддерживает и клиент сервером договариваются то сервер отправляет подтверждение кодах 101 и у вас ищи теперь переходит в режим почти роте сеппи сотен то есть ротике песок ецира высоких так когда мы можем отправлять любые данные в обоих направлениях то есть там на сервер произошло событие по выпсуке ту отправились серверный клиент на тренде производства события отправили на сервер не нужно ничего ждать не нужно делать переподключение у вас 1 socket на одного клиента и это работает гораздо быстрее чем почти но не так быстро как по обычному ти себе потому что для websocket of есть еще свои свой формат хедера но он не такой большой то есть в минимуме он занимает два байта если вам нужно какие-то совсем небольшие данные передать то у вас будет два данных и дыра плюс еще два байта контроля то есть чтобы разделить разделить фрейма websocket а внутри соединения тисе пи и overhead получается не намного больше чем степи столько там но и соответственно это и не так быстро как люди dino браузер и египет не поддерживают поэтому поэтому люди довольствуются пакетами казалось бы websocket и только полезные внутри браузеров потому что они там и для них это и было сделано но для не браузеров для обычных клиентов это тоже полезно потому что вам не нужно переписывать логику работы с сетью если у вас например много клиентов и у вас есть клиенты под html5 клиенты под настольной операционной системы или под мобилки то у вас код работы с сетью будет примерно одинаковым потому что все высокие они кроссплатформенные то это их очень довольно большое преимущество то есть вы в мае нам в малом формате вот у вас получается хедер небольшой два байта потом либо если это большой формат когда у вас день величина данных отправляем их больше чем 128 то вы добавляете еще размер байта для для указания размера и соответственно потом уже отправляйте данные сколько вам нужно для из-за кого есть библиотека как стандартная x на это websocket так сторонняя сгорела но сторонние лучше потому что она более больше поддерживает режимов работы и даже если вы зайдёте на сайт стандартной библиотеки там прямым текстом написано не лучше ребята используйте гориллу о них у них лучше получилось поэтому используйте горилла для lua тоже есть игротека выпсуке тов используется она поверх стандартного socket t socket я думаю много с ней работали то есть вас если у вас вы работали слова движками и там есть четыре квест или там network долот какая-нибудь функциях делать сетевые запросы то это все устроится поверх лу востоке того которая может устанавливать когти себе соединения так youtybe соединения и соответственно в псаки ты она тоже может делать здесь две ссылки первое это стандартная библиотека для нестандартных смысле общепринятая реализация websocket для лова а дальше это было teka которая уже еще раз завернуто для движка дефолт игрового кто-нибудь слышал про игровой движок дефолт немного я вам его немножко покажу в общем как во архитектура сервера мультиплеерного время посмотрю нормально сервер у нас принимает соединение принимает весь input от всех клиентов игроков он их соответственно смог ловят 4 смотришь чтобы никто ничего не запрещенного не использовал и соответственно потом рассылает все эти изменения по всем другим игрокам и у себя там еще в оперативной памяти обновляет свое собственное состояние дефолт игровой движок который поддерживает большинство платформ то есть мобилки десктопы и что немаловажно html5 он как 2d так и 3d теперь у кого есть интернет можете и у кого есть android mac os или linux или windows но вот можете скачать програмку игрушку и ее запустить теперь перейдем к google вот это синтаксис строчка из моего скрипта которые на сервере работает и это одна из самых важных потому что это описание массива игроков то есть весь игровой мир вся игровая логика в.г. она вертится вокруг массивы игроков слайс ну у нас много разработчиков которые не знакомы с go поэтому для них то есть в go это называется слайсы вообще можно думать что это массива нет по аналогии с другими языками в гонит общепринятых классов в lua тоже нет общепринятых классов там есть только от эйбл и вот здесь вот одна из разительных схожести из ну а то что похожие структуры используются для реализации объектно-ориентированного подобного программирования то есть в нога у нас тракт на lua темпл и так же у нас есть строка какие-то поля которые мы можем заполнить и в лот то же самое таблицы могут быть разные поля как вы уже могли заметить это то есть описание как бы класса игрока на сервере у него есть ссылка на соединение websocket насколько через которые производится общение с игроком у нас есть его и дичь ник у нас есть его игровые параметры то есть положение на карте у нас есть угол поворота скорости и движения чтобы у вас было небольшое представление о том как выглядит я сейчас вам покажу то есть я сделал вот такую штуковину и это кораблик он летает один никого не трогает но если я зайду в своего айпаде к то у нас получается 2 теперь я уже играю на а и пойдите и они у нас летают вместе и в догонялки соответственно все это работает через наш не хорошо работающий вайфай и задержка ну не такая уже чтобы и плохая то есть вроде видно можно также подключить и телефончик вот у меня загрузился телефончик нас ему совсем плохо то есть он видите как лагает это из-за того что как раз таки в это и не очень хорошо работает но это же игра это же всех вижу на экране цель игры чтобы убегать от красненького а если вы красненький то вам нужно кого-нибудь догнать чтобы он соответственно было догоняла игра в догонялки мультиплеерная я не видел чтобы кто-то такое делал верно по объективным причинам потому что это дико скучно на в качестве тест качестве примера реализации мультиплеера это очень хорошо подходит потому что здесь не так много событий и действий но на самом деле все нужные компоненты для полноценного сервера здесь есть покажу и дальше то есть вот у нас x y это вот нас по карте они передвигаются энгл поворот куда она смотрит торин это кнопки нажатия лево или право отправляются на сервер чтобы знать куда игрок двигается если бы мы просто отправляли положение на экране у каждого кораблика без управления без затравки событий нажатий то есть лево право вперед назад the server бы не знал в какую сторону нужно двигать игрока у себя там в голове а если это не ввести эти данные у себя в голове на сервере то будут большие проблемы с синхронизацией то не потому что вы можете только лишь не так часто отправлять данные то есть в идеале вы хотите отправлять данные на сервер 60 раз в секунду чтобы было 60 фпс и сервер должен их 60 раз в секунду у себя принимать их и пересылать мгновенно за одну миллисекунду всем остальным участникам чтобы у вас было всё синхронизировано но такого естественно не получается поэтому отправляются данные на сервер там раз в секунду там есть несколько раз в секунду в данном случае я отправляю каждый раз когда была нажата какая-нибудь из кнопочек вот эти и стык в стык time отвечают за то что какой кораблик в текущий момент является body like кто вводит кто красненький из записывается последнее время того когда он это делал чтобы когда происходит смена когда они пересекаются чтобы они друг на друга и не перестраивались чтобы запинался кто был до этого и давалось три секунды иммунитета в рай channel это удивительная тип данных в год который называется каналы у них аналогов есть у кто знает в других языках аналоги каналов и сга в скале ну вот замечательно если вы программируете на скалах есть кто-то на скала программирует 12 ну вам вдвоем это подачи наверное помогло чтобы понять что такое канала угла у нас конечно больше программистов много чем на скалы не знаю радоваться там или нет но я порадуюсь главное как и все год запускается с функцией мои и первым делом я один проверяю флаги при запуске в клиз командной строки и вторым делом я использую стандартную библиотеку и happy чтобы назначить функции которые будут не обрабатывать соединение то есть у нас если слэш это значит народ когда мы без каких-либо параметров долгим ся на сервер а статус у меня еще маленькая страничка который выводит количество игроков онлайн и апдейт world это функция которая как раз таки в голове на сервере обновляет игровое состоянии глобальная она оперирует над массивом игроков и изменяет у них все значения 1 60 раз в секунду ключевое слово go это очень короткая запись того чтобы выполнять эту функцию асинхронно то есть ли бы go не было то эта функция была блокировала поток выполнения программы она бы зависла а так мы делаем новый зеленый поток так называемый или гору тина как она в go называется у нас это все там крутится и затем мы запускаем наш ищите pi server то есть у нас есть на сервере наш игровой world игровой мир где мы обновляем игроков и у каждого игрока есть тоже свой маленький локальный мир который обновляется посредством игрового движка и он работает с разным количеством кадров в секунду то есть кого то хороший телефончик там 60 кадров кого-то не очень там 20-30 и соответственно все эти значения передвижения она будет отличаться и нужно очень хорошо постараться чтобы добиться синхронизации между всеми клиентами а игроками и сервером поэтому нужно в первую очередь контролировать фпс не замачиваться на фпс как будто он всегда 60 кадров в секунду а делать чтобы он был зависел чтобы все вычисления в игре они зависели от к текущего значения fps еще такой нюанс есть с лотами если вы передаете флот и как они есть в бинарном виде то на разных машинах они представляют собой разные немножко это будут они немножко по-разному появляется очень незначительная sen de синхронизация поэтому лучше использовать все таки интеджер и и с фиксированной запятой какие нибудь типа данных у нас есть indian с а тоже когда интеджер и могут передаваться по разному формату если у вас она не из одного байта состоит из четырех то есть либо главный спереди байта либо менее главных перегибать little endian и гендин детстве когда каждый игрок получает обновление состояния мира о других игроках то они тоже приходят с какой-то периодичностью не 60 раз в секунду поэтому как только мы получили состоянии о каком-то кораблики который там где-то летит то мы не ждем сервера чтобы получить но его новое положение а мы у себя на клиенте и вот так же само двигаем как и себя чтобы он тоже двигался и когда у нас происходит следующее приходит обновление от сервера о кораблики там его уже на корректное место ставим у себя на клиенте если этого не делать то у вас кораблики будут просто прыгать по экрану а если делает они будут плавно двигаться и будет совершаться незначительная корректировка которая на глаз не будет видно вот так просто в go можно сделать в эту страничку то есть вот у нас статус который я вываживает в html количество игроков от количества игроков это просто л.н. функция которая возвращает количество элементов в сансе player то есть если мы сейчас зайдем на этот сервер и если у нас есть вай-фай у нас нет вайфая к сожалению но если зайдете на статус там появится сколько отобразилось четыре игрока хорошо так пошли немножко не успеваем рассказать чуть побольше тут у нас кода на гитхабе то есть гид cup слышали рга можете найти коды для огонь и для для лова с которым будет на котором все работает чтобы посмотреть самим сейчас я быстренько по коду пробегу чтобы вам показать как она все на самом деле работа то есть вот вот все сервер он занимает весь сервер 300 строчек кода но мне кажется для игрового сервера это достойный показатель в так как ты стащила часть занимает статическая просто страничка то есть вот у меня два вызывается функция апдейт сейчас я вам эту функцию отдает покажу там на задних рядах видно что написано функция обладает у нас ногам мы вот эту строчку мы делаем то что выполняем то что дальше идет каждый один раз 60 раз в секунду на примерно 16 миллисекунд дальше мы каждый этот период времени проходимся по массиву игроков выбираем все всех и каждого игрока и для него обновляем значения угол поворота его направление и скорость ограничиваем скорость если он двигается слишком быстро и все эти данные мы обновляем этот код у меня реализует переход когда с вылетаешь с одного края экрана прилетает же другой то есть всего мира у меня есть размер и я его задал 1280 на 720 в этих же значениях у меня оперирует под на lua там производится тоже те же самые вычисления но соответственно nalu вот затем у нас происходит проверка коллизии проверка коллизии на клиенте 1 занимается физический движок и на самом деле он там не занимается потому что сейчас клиент ждет от нас сервера подтверждения пересечениях 2 корабликов самого это не делает но это можно было делать тоже в общем как происходит проверка на коллизии мы берем 2 игроков то есть у нас двойной вложенный массивчик мы берём их векторы которые указывают на положение на карте и берем вычисляем расстояние между этими двумя точками если у нас расстояние меньше радиуса кораблика то есть у нас каждый кораблик на самом деле это кружочек летающий несмотря на то что он какой-то сложной формой но всегда всем этим разработчики делаются вас никогда практически нет такого чтобы на сервере весь ваш аватар так скажем был в точности повторяла форму вашу какая у вас видно на клиенте это чаще всего большие упрощения бывает от совсем мало чтобы вам успеть показать ну вот например покажи налога чуть-чуть код и пей мы перейдём к вопросам хорошо ребят там был предыдущий слайд его сергей откроет ссылками на git хоп codes если штор 3taps сергей lirc код на lua все свои всего из четырех lua файликов и пиалу а у меня обрабатывает соединение с сервером то есть адрес сервера по выпсуке там и с библиотекой клайн ты сын которой с дефолтом div нет для дефолты написано я устанавливаю соединение выпсуке там и соответственно когда придут вот здесь я делаю соединение connect когда с их connex осуществляется вызываются калмыки и действие совершаются нужны сереж все а то народ уже начал разбегаться не мы не даем людям шанс задать вопросы задавайте быстро да отвечай коротко и сухо хорошо давайте вопросы и такой вопрос браузерная часть она вот как сделан на web assembly или как быть браузерная часть дефолт умеет экспортировать напрямую в html 5 то есть там все то же самое там через web assembly компилируется движок и там все работает но из-за того что для браузеров соединение должно быть защищенным конкретно данную игра у меня сейчас не работает из-за этого мне надо делать сервер что было поддерживал tls тогда она будет работать следующий вопрос пожалуйста на мобильных устройствах лагает как с этим бороться мобильных устройствах лагает из-за скорее всего плохой сети так же самое как и надо стопок здесь разницы большой нет на мобильных устройствах там не html5 используется там используется нативный опэн джи эль с точки зрения графики там всего она быстро раз пользуется вот чтобы не лагало это надо описать умные алгоритмы синхронизации которые могут показывать клиенту что играю выглядит плавно когда на самом деле там вам приходят раз в секунду или две обновления от серверов это надо очень хорошо постараться чтобы так написать код но люди делают это работает websocket на 3g интернете нормально поддерживается ну вот у меня телефончик на 3g интернете я играл тоже нормально было то есть если но зависит от оператора но сайты у меня не открывались в хроме а игра работала то есть там нормально вот здесь весь 3g вы или поэтому микрофон кнопка внизу так вот и продолжение вопроса соответственно то что в первую очередь думаешь просить какие то не знаю пару хлопчиков либо там по времени богами чтобы отсечь проблемы сетью чтобы было видно сети и сети если не считал куда дальше копать то есть какие-то такие моменты можно противника в коде то есть на момент дебага момента есть вот и не пока про разрабатывать чтобы отсеять как моменты сетью и смотрите ну как бы ему что что завязал носов какие проблемы ну тогда разрабатывается локальный веб-сервер и у вас локальной сети уже соответственно все как нужно работает в этом случае понять что это самый простой вариант как бы а если все таки хочет ставить точки зрения различных терминалов и которые где то все таки как бы вынесенная пример что вот этот есть нормальный рабочий вариант сети обычно так и белым делают все таки локальную сеть а чтобы эмулировать какие-то задержки от сети и от туда их искусственно внедряют внутри локальной сети такое тоже фоткаются проблемы не знаю стыка сети в мобильном аппарате еще чего-то какие-то вот такие тоже сложности если вы говорите про firewall и какие-то блокировщики шейперы именно на самом аппарате мобильным то есть то что посерединке будут проблемы это понятно это отдельно а вот именно что в какой-то пример из легендарная карта нет если не знаю сложности на самом мобильном аппарате этой я не знаю так и чтобы были сложности обычно все как работает единственно то что если у вас клиент перегруженный и процессор не справляется то соответственно игра будет лагать и все а так все довольно будут на спасибо за доклад а как обновить сервер без потери соединения с клиентом ну вот websocket а я не без потери соединения с клиентом или вы просто именно будешь же все равно при подключении клиента нет выпсуке этой темы и хороши то что перед включение там нет то есть websocket и это как тисе пи socket только соединение устанавливается похитив когда есть и пью соединение произошло то у нас перестает лица еще тебе трафик начинает литься уже ваш игровой трафик который вы нужны он в обе стороны работает но классическая схема с мастером и маркером как как web серверах обычных тут то же самое да можно рассказать почему то есть почему гол понятно почему ну а потому что быстро потому что удобно и есть игровые движки которые с ним работает с я вас показал код аналу а там совершенно элементарная код и все быстро работает то есть держал скрипте то что можно сделать нет на java скрипте немножко не так java script и раздаст на сложнее встраивать в игровые движки потому что у него гораздо больше вверх от ул с кем и славится тем что наибольшая производительность если ради вот этой библиотеке которые отдел сколотив дефолт да за нее до движка до движок использует хуан и и слепота java script есть такой же движок тогда можно на любом websocket и они кроссплатформенные работают нас из на разных фреймворков"
}