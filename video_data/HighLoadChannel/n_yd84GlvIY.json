{
  "video_id": "n_yd84GlvIY",
  "channel": "HighLoadChannel",
  "title": "Мастер-класс \"Практикум по теме высокодоступного кластера Kubernetes\" / Марсель Ибраев (Слёрм)",
  "views": 1644,
  "duration": 3762,
  "published": "2021-10-04T02:47:02-07:00",
  "text": "добрый вечер я очень рад что несмотря на то что все держу второй день и вечер собственно завершении конференции вы все равно нашли в себе силы и время прийти я предлагаю это мероприятие провести немного во этого потому что я понимаю что все уже устали и формат этого мероприятие этого доклада он будет в таком life coding наверное виде да но при этом если кто-то присутствовал там на прошлом моем докладе сегодняшнем я обещал что будет 20 доступов на кластер эти 20 доступов есть они лежат вот здесь на стуле соответственно кто вечером в конце холода хочет поработать руками пожалуйста нужен только доступ по ssh подходите берите вот они здесь стоят на стуле те кто снова томи те кто хочет посмотрите как много силы сидит хорошо более того эти доступ этих эти кастера которые мы с вами сейчас будем говорить они останутся с вами весь вечер и всю ночь если у вас еще силы останутся то вы можете еще ночью их ковырять и вам никто слова не скажет единственно но все взрослые люди до майнеры не надо там запускать пожалуйста кто сказал и возвращается в так соответственно так кто хочет поработать вместе со мной то без проблем сейчас мы вместе все это будем делать единственно организатора мне сказали что мы все-таки ограничена в тайминги поэтому я сильно не буду там как-то останавливаться дожидаться всех я как-то будут двигаться своем темп но постараюсь сделать это более меня размеренно вот естественно все объясняя показывая и рассказывая те кто получил доступ и собственно если что доступа на стуле еще есть если вдруг там присоединяется можете брать что нужно сделать нужно открыть компьютер зайти свой ssh клиент и сейчас мы через него будем подключаться к своим к своим кастерам перед этим я рекомендую найти мою репу на гитхабе пользователь ибраев м и репо hell 2021 вот я пока вот эта оставлю открытом собственно кто будет со мной вместе делать то пожалуйста найдите потому что там у нас все там вот как мы видим все инструкции к применению папочки практики и так далее и так далее после того как у нас так вот пройдет мероприятие пройдет все это останется в общем доступе если кто-то там захочет повторить то что мы будем делать сегодня на своей кастерах уже после мероприятия то без проблем если возникнут какие то вопросы можете писать мне в telegram тоже с радостью пообщаюсь вот еще немножко подержу а ну да у нас же не зум у нас у нас то тут весь комп показывается то есть я не могу сейчас вернуть и параллельно что-то делать на не страшно давайте еще буквально секунд десять чтобы точно все кто хочет они смогли подцепиться пока расскажу немножко что мы будем делать опять же те кто присутствовал на моем сегодняшнем докладе знают что я рассказывал про некие инструменты которые позволяют делать работу нашего приложения нашего продакшна приложения более устойчивый и вот про эти самые инструменты тут никакой никакого секрета нет вот они прям названию по папочкам сейчас туда будем заходить и делать вот про эти инструменты я и буду рассказывать и показывать и прямо с по манифестом будем проходиться запускать их смотреть что происходит все я думаю коллеги справились если что спрашивайте я еще раз покажу те же кто просто смотрит возьмите кофе чай там откиньтесь и кайфуйте так я тоже перешел в ssh клиент и что собственном теперь нужно делать нам нужно вот прям я буду вместе с вами идти по инструкции чтобы не дай бог куда то не туда не свернуть и чтобы у нас все было хорошо на листочках есть два поля логин пароль логин представляет из себя там с и шесть цифр 000 что-то там вот ваш номер вагина вы периодически будет видеть такую формулировку в ремешки вот это как раз вот эти шесть цифра к не у каждого все но понятно уникальны вот и его надо будет эти циферки надо будет подставлять placeholder почему до сих пор не переменная но хочется же чтоб все пострадали не только мы прыгаем на джим хост сперва то есть вот таким образом я прыгнул под своим пользователям да кто обучение в слёрма проходила сейчас будет ловить лютые flash бэки это нормально так неотступность сюда из тут не надо собственно вот первый шаг который нам нужно делать коллеги кто делает параллельно со мной это подключиться на xbox и zbox лером а ее и то есть также в ридми жки еще раз повторюсь все что мы будем делать все ремешка нас будет описано соответственно подключаемся туда логинимся пишем свой пароль и вот мы залогинены на xbox это джон хост сейчас джим hasta я прыгну уже на свой кластер на мастерноду и вот здесь соответственно я подставляю уже своего пользователя у меня пользователь 99 ввожу пароль и вот вроде как я подключен и вот здесь уже давайте станем рутом разговору о том надо ли работать под ртом или не надо давайте оставим за рамках этой лекции иначе мы не уложимся стайлинг и если вы справились то есть вот мы стали рутом на ноги master 1 можно проверить что действительно все работает выполняем какую такую команду видим что вот у нас есть куча кодов значит хорошо значит вы справились вы восхитительны ну и следующим шагом чтобы мне выполнить практику я перейду куда-нибудь к того косово и туда спланирую свою репку потому что там меня тоже всякие заготовки манифеста чтобы не копировать туда-сюда их прям сюда вот так сделаем и перейду внутрь вот опционально можете поставить пакет который называется к 8 шоу это пакет собранной специалистам компании south bridge если кто знает сергей бондарев и делал это пакет который позволяет добавить авто комплит по сути вы можете сделать это и руками до вашей россии все необходимые прописать он просто еще делать такую штуку что у вас автокомплект работает и по соответственно через купить elle потому и через букву в cookies тоже если вы привыкли то пожалуйста без проблем так у меня этот пакет уже стоит поэтому я перехожу сразу далее после того как мы зашли на свой кластер cabernet из стали рутом спланировали репозиторий теперь можно уже переходить к рассмотрению инструментов первый инструмент которым рассмотрим это инструмент который называется под destruction budget вкратце напомню и расскажу для тех кто на предыдущие наши лекции не присутствовал собственно этот инструмент который работает с вершин api то есть он ограничивает количество недоступных инстансов приложения в случае если мы делаем куб ситель drain например у нас работает две реплики приложения и одна из реплик работает на ноде с которой админы ноды в под и выгоняют и соответственно в какой-то момент только одна реплика останется работает буквально несколько секунд на это будет так и мы можем сказать что это там неприемлемы да например или можем сказать что одна окей пусть будет чтобы это было более понятно давайте посмотрим на сам манифест под dessar общем budget . яму и на самом деле он очень минималистичный что мы видим манифест но во первых до ткань под destruction budget его имя а дальше спецификации у нас может быть два значения либо миновали было либо макс и на берегу и как раз таки здесь мы задаем либо минимальное количество доступных реплик либо максимальное количество недоступных реплик а какого именно приложения того приложение который мы выбираем через селектор из матчей блс все достаточно просто и логично еще раз повторюсь что под destruction budget никакой магии не делает он работает именно с вершин api искуситель дуэйном поддерживает нужное количество реплик вашего приложения в квест ирку бернес реплика сайт контроллер вот когда вы сказали там что типа 3 реплики нам надо вот он будет их держать следит и меня за drain am вот эта вот штука но и чтобы наверняка с этим разобраться вот здесь в папочки в каждой папочки практике будет ремешка ее тоже можно будет посматривать я тоже ее сейчас открою чтобы опять же никуда не свернуть случайно по из холдеры кто проходил у нас обучение слезы навернулись на глазах в энгельсе учитывая что у каждого свой номер вагина у каждого свой кластер и соответственно у каждого свой балансировщик снаружи нам нужно будет здесь прописать свой номер чтобы трафик шел именно к вам у меня 40 а 99-го соответственно что-то другое выиграть и мы все это дело прописываем сохраняем сам игр с мячом себя такого не представляет это просто хост куда мы подключаемся connect уходят куда-то там в сервисной mangens на 80 порт самые внимательные наверняка заметили что синтаксис игра со имеет старый формат там типа до версии 1 19-20 да это действительно так немножко старовата я версия куба здесь 118 на это плюс минус то версии на самом деле которое у нас сейчас на проектов вроде 118 119 на 120 тем более там типа 21 не не уехали нет без до сохраняем выходим что у нас здесь в папочке engine x у нас depoimento как не сложно догадаться с индексом ingress который тогда будет вести но и сервис соответственно тоже я могу deployment быстренько показать опять же тут ничего такого нет две реплики индекса максим от сыновей либо 113 так далее так далее то есть ничего такого просто engine s2 реплика запускаем ok сверяемся с нашей ремешка видим что нам нужно теперь все это дело запустить давайте запустим нашу кластеры посмотрим что получится получилось хорошо проверяем ну да вот они две реплики engine.exe сейчас мы немножко подождем он запустится вроде нас пробу пройдут и все будет хорошо ok опять же если вы были на докладе вы в курсе про кейс который я рассказывал я рассказывал про кейс когда у нас разработчик катит релиз приложения соответственно две реплики приложения вот идет ролик апдейт одна реплика погасла 2 реплика с новой версии приложения еще не поднялось и вот буквально несколько секунд у нас работает только одна реплика ну так работает ролик апдейт если у нас две реплики и именно в этот момент админа на вот этом здесь на сервер где вот эта единственная реплика осталась работать начали какие-то работы и reboot 0 и сервак сдвинь или все снова reboot нули и мы получили downtime небольшой но downtime вот сейчас я это продемонстрирую естественного бара торном путем то есть я сейчас наш department который запущен 2 репликах вот я его возьму и соске люда единицы представим что идет rolling апдейт вот у нас один под старый погас погас сейчас новый там в контейнер крутится сейчас он пуститься но вот пока у нас одна реплика рабочие есть мы даже можем посмотреть где это реплика находится мы увидим что аналог где-то на ноги 2 находится сымитируем ситуацию но чтобы прям было прям хорошо прям показательно мы сделаем так мы где-нибудь либо в соседней консоли соседям терминале либо этому xiv скрине кому как удобно запустим вот такой башенном который будет и каждую секунду подключаться к нашему приложению и выдавать 200 ok если соответственно 200 кот либо если иначе то будет выдавать файл ну окей либо файл дать им на тему можно секундочку если напомните где это было с этим зажигаем так дальше appearance on а вот тогда так норм так возвращаемся и гибель вот мы этот башенном сейчас запустим я наверное отдельную консоль открывать не буду я где не скрине часто сделаем просто-напросто давайте как сделать у меня чтобы она отличалась сделаю вот так наверное вот единственно кто или если кто-то за мной успевает учтите такой момент что здесь еще один power любимый всеми поэтому его правим ничего такого в этом ваш изменит просто бесконечный цикл мы курим наше приложение если 200 соответственно водоем окей если иначе то выдаем файл и спим одну секунду пробуем и видим вот они и что-то сетью а смысле как я в доллар превратил а вот эти не знаю это автоматизм какой то надо следующий раз проверить как ты была так но смотрите файла быть не должно чего-то сеть как бы вот они koko k и это то что нам нужно ну вот вроде разродилась понеслось вот и пусть она сейчас скрине там будет его вот там и параллельно сделаем то что сделали админы а именно выведем ноду на обслуживание можно без этих всех флагов без грейс-период делить около дата игнор daeman сеть единственно нужно ставить и без force она тоже прекрасно уедет давайте я скопирую как она есть и вспоминаем на какой ноги у нас был запущен под соответственно если мы сделаем куб стиль get по минус white мы увидим на какой ноги у нас под запущен запущена на ноги 2 но я делаю купить стиль drain но до 2 и доллар даймондс так до допускаем я админ я пришел обновлять ядро хочу прямо сейчас вот у нас там еще ингрос контроллер был наш под evict- и отлично он куда-то уехал но я напомню да что значит эвакуировать под это значит что у нас вот они файлы проскочили как бы столько секунд у нас несколько секунд у нас пользоваться видели там условную 503 но он запустился под в итоге на другой рабочей ноги все стало хорошо окей эвакуировать под значит удалить его на одной ноте запустить его на другой то есть никакой опять же маги нет забыл кое-что показать забыл показать конфигурацию нашего кастера 3 мастер две ноты соответственно нас 2 но да есть если что он приехал соответственно ноду один было на ноги 2 вот но учитывая что была только одна реплика он здесь сдох и здесь поднялся бывает теперь двигаемся дальше но кеес я думаю понятен да эта ситуация возникла бага дело только один раз нам на моей памятью но в принципе такое может быть и от этого надо застраховаться поэтому делаем пока что он кордон моды 2 возвращаем ее в строй и теперь подумаем над тем как такую ситуацию нам обойти как это избежать собственно мы не зря говорили про и тебе сейчас вернусь в наш каталог вот он наш манифест мы на него уже смотрели пока мы занимались кластерам тут ничего не поменялось и что этот манифест нам дает у нас приложение которое мы запустили имеет вейбо а п.п. индекс соответственно создав этот объект под destruction budget мы этот и деби привяжем к нашему приложению и у него в настройка будет написано вот максимально доступное количество реплика этого приложения 1 то есть меньше вообще нельзя если ты там тренер последнюю доступную реплику остановись проверим остановит ли у нас применяем смотрим на коды но скейлится брата не будем как бы вот у нас представим гипотетические до сих пор происходит rolling апдейт проверим что у нас здесь qqq все верно но и попробуем еще раз попробуем еще раз выгнать наш под давайте посмотрим где он есть есть он естественно теперь на ноги один мы сдвинем его оттуда я делаю дрейф и мне поди сарафан гаджет говорит а то то то есть мне нельзя его зрение потому что где то было а вот делает запас destruction budget то есть мы уперлись в бюджет и он будет так висеть до тех пор пока необходимое количество бюджета необходимое количество реплик не появится если мы сделаем вот куб ситигид pdb то увидим что вот миновали был один и all it dies rovshen то есть максимально что мы можем еще потерять 0 то есть больше мы потерять не можем хорошо давайте застрелим обратно представим что у нас теперь снова две реплики смотрим pdb видим что тут пока один сейчас я вернусь drain теперь по идее он вот спокойно уехал то есть у нас здесь сейчас он разродиться он там видимо поднимаются еще да вот только он поднялся собственно нас поднялась 2 реплика и теперь вала destruction у нас один то есть потери одной реплики мы теперь можем допустить и в случае чего у нас drain пройдет конкретно в ситуации и эвакуации подав и rolling апдейта админа просто повесить немножко вот это сообщение потом дальше evacuation пройдет просто потому что rolling апдейт тоже пройдет это первый кейс с этим я думаю мы разобрались тут собственно ничего ничего такого нет да он кордоне обратно потому что нам она еще пригодится не хотелось бы чтоб на такой глупости кто-то попался на таком кейсе вот но я за собой тоже почищу потому что мне этот индекс ip-адрес раб чем budget в следующем кейси не нужен я его удалю отлично с этим я думаю разобрались давайте нам вопроса ставим на самый конец пока пойдем дальше потому что потому что у нас еще лимит ренджи и превратит вас и перехожу в следующий каталог лимит rangers and ресурс квот из внутри тоже у нас есть ряд манифестов есть вот лабораторное наше приложение над которым мы будем извиваться и соответственно лимит range и ресурс кого-то который мы тоже будем применять также есть ли движка я ее тоже сейчас открою и мы вместе по ней будем делать 25 меня не занесло никкуна отлично напомню кейс кейс связан больше с таким человеческим фактором то есть у нас мы можем забыть про ставить там лимиты request или можем поставить их неправильно или можем случайно за скелет наше приложение в какое-то большое количество реплик что негативно скажется на нашем кластере и вот есть инструменты которые позволяют такие негативные последствия как-то предотвратить эти инструменты называются лимит раньше ресурс квота давайте про каждой поподробнее поговорим про назначение так далее я уже рассказывал вот как раз таки на своем докладе но здесь теперь давайте поподробнее из чего он состоит внутри в левит ренджа спецификации вообще лимит раньше у нас может работать с контейнерами с кодами и из явись и и вот здесь спецификации мы говорим что вот кстати да есть такая некоторая особенность у лимит ренджи и ресурс квот особенность так скажем в оформлении опеки вот здесь у нас есть лимит но как бы нет request и это на самом деле нормально это the limits наверное она типа по логике относится именно как лимит range типа levi's вот но факт что можно немножко под запутаться и это еще не все есть макс есть мин есть дефолт есть дефолт request тоже немножко напрягает мозг на сейчас мы с этим разберемся как я сказал в рамках лимит ренджем мы можем задать там значение для контейнеров для подав и для певицы и что конкретно данном манифеста мы делаем мы говорим что теперь у нас контейнеры максимум могут запросить один циpкa и один гигабайт озу то есть лимит минимум request может быть 500 миль и циpкa и 64 мегабайта за минимум тоже рекомендую ставить потому что была ситуация разработчик говорит у меня на старом оси она запускается типы еще там не надо я поставлю один милиции по всему взлетит не взлетает хотя бы 50 не обеднеем и самое что мне нравится дефолт то есть если я на докладе уже говорил дает в этом плане немножко такой вредный я ставлю маленькие значение потому что но если она взлетит с дефолтным значений это круто молодец если не взлетит но разбирайся как бы на посмотреть какие request a limit и поставить так вот дефолтный у нас лимиты 100 милицы по сто двадцать восемь гигабайт озу и дефон и request это же пусть будет коск вас гарантии что прям вообще классно было и таким образом если у нас контейнеры которые появляются в нашем кластер губернатор превышают эти значения то они просто не создадутся в рамках конкретного нам space и есть также у нас под в пади плюс-минус те же самые настройки мы можем делать то есть в рамках контейнеры а в ходе может быть несколько контейнеров либо на уровне потом мы можем это задать но на уровне пода есть прекрасная настройка очень на мой взгляд тоже хорошая это макс лимит request risha это соотношение пропорции между request a mi и лимитами потому что опять же извините пожалуйста что сторону разработчика все время кидаю но это вот моя боль то что я встречаю своей работе как бы прилетает deployment у которого were квестах сто миль и цикл в лимитах 5 циpкa ну типа поставили мало а там бог с ним пусть растет сколько хочет вот как бы нехорошо это по-хорошему надо понимать действительно сколько она будет потреблять в идеале конечно вот здесь должны быть единицы потому что у нас кубинец есть класс класса и проще говоря если кому интересно подробнее в кулуарах можем пообщаться я расскажу про это проще говоря для кубер на это со приложения у которого лимиты и request равны вот это приложение для кабинета самое важное важнее чем то у которого нет ни лимитов не request of хотя с классической инфраструктура это вроде не вяжется потому что мы хотим вроде бы на классической инфраструктуре запускаем бизнес критиков приложения и никаких лимитов ему не ставим по сколько выживет столько и нормально она очень важно здесь ситуация обратная и мы здесь можем написать единицы и тогда все коды которые поедут к нам они обязаны иметь равный request a limit и но мы живем в реальном мире и это не всегда возможно к сожалению то есть веке гэп некое некое пространство для нагрузки мы все-таки должны я считаю иногда давать поэтому двойка это нормально то есть у нас лимиты могут быть в два раза больше чем request и в данном случае ну и девисе минимально один гигабайт максимально 100 гигабайт как я сказал на докладе теперь если вместо буковки г сюда нечаянно залетит буковка п а если вы посмотрите на клавиатуру они рядом и вместо одного гигабайта к нам в какой файл помойку подключиться 1 терабайт исходя то вот или mid-range нас от этого спасет это что касается лимит ренджа и наконец ресурс квота здесь еще раз возвращаемся к прекрасном описание с цепью спецификации есть хард но нет софт вот реально нету и типа ну ну окей с этим живем ресурс к вот у нас позволяет не только задавать какие-то значения по ресурсам в рамках in space а общее то есть сколько всего мы в рамках нам space а можем запросить например циpкa или сколько всего можем запросить озу но и что немаловажно количество этих самых ресурсов то есть например у нас в нем спейси может быть только 10 кодов или только 10 сервисов вот бисера нам вообще запрещено в этом нам создавать not part ii запрещено создавать реплики шим-контроллер с если кто-то работал с версии там куба 1615 возможно помнят такой от такую абстракцию устаревшая абстракция тут окружений не надо ею пользоваться тоже запрещаем создавать коды сервисы вот по 10 штук чтобы наш квестор в помойку не превратился и на мой взгляд тоже хорошее решение для того чтобы более-менее кластер держать таком привет приемлемом актуальном состоянии потому что становится непонятно оно вообще надо не надо все что там запущена так создадим нам space у которой мы все это будем делать прям так и сделаем создадим en est est и сейчас все вот эти наши вещи мы в этом нам спейси применим я покажу как потом можно посмотреть будет параллельно пока она применяется давайте сразу глянем диск рай понёс тест describe теперь о нем space а мы можем видеть следующее смотрите у нас тут появилась ресурс квота и вот она колонка юзжд сколько мы уже за использовали ресурсов и сколько у нас граница и вот они лимиты наша вот то есть все что мы поменяли теперь здесь отражается давайте попробуем нам чего-нибудь запустить вот например вот этот deployment сразу говорил у нас приложение которое мы запускаем прям очень оригинальная engine.exe две реплики но нам просто для лабораторки нормально посмотрим что она запустилась видим что запустилась все хорошо и вот теперь если мы ещё раз посмотрим describes а то смотрите вот теперь в use the нас начинает копиться вот 200 милицы полом и заюзали 200 гигабайт озу и request of лимитах то есть все вот здесь вот в контейнерах назначение появились то есть потихоньку нас точнее она была и путают с этим потихоньку у нас теперь начал вестись учет проверим что это действительно работает давайте я знаете что сделаем я сделаю как редиска я возьму и вот здесь с хитрю я скажу что да как бы request и мне сказали что надо ну контролировать request a надо мне сказали обязательно ставить его поставил 100 миль и циpкa но я не уверен что он с такими будет работать поэтому вот вам один цикл чтоб наверняка в лимитах запасе тест configured на этом этапе никто на нас не поругался хорошо посмотрим на коды и видим что под и у нас имеют возраст 80 на секунду на подождите вот вот только что за павел то есть у них возраст должен быть типа где-то там пять секунд 10 секунд но но ничего такого хорошо проверим действительно ли это те коды которые я хочу видеть если я сделаю там какой-нибудь под сейчас посмотрим посмотрим да нет у него were квестах сто миль и циpкa и в лимитов 100 милицы посмотрите наше изменение они не заехали они применились но ничего по факту не запустилась в чем дело дело в том что нам нужно опуститься на абстракцию ниже от депонента а именно посмотреть что происходит у нас в реплика сетах для начала давайте посмотрим геттер с днем спейси тест разумеется смотрите у нас когда мы выкатываем какой-то новый релиз нашего deform это у нас под капотом создается рипли кассет с нашим новым имиджем там или на какими-то новыми параметрами вот он здесь тоже создался дизайн у него одна реплика а все остальное по нулю и мы видим что да вот же она вот 66 секунд вот недавно мы создавали но сто бед один диск раб посмотрим что там rss джилекс шо ты не это самое то а вот так вот и да мы видим что смотрите реплика сет контроллер нам ругается что вообще-то у нас макс лимит рейши 2 а мы запросили 10100 милицы по 11 10 раз видя не очень очевидный момент но докопаться до этого можно и я вот вам показал собственно как если что это можно дебате ошибку получать видеть давайте допустим пусть работает еще один кейс который я рассказываю на докладе это был про космический скиллинг когда у разработчика логана в интернет он это было на месте правда он хотел застрелит приложения до единицы томске а соответственно один единичка на в терминаль нее появилась нажав 11111 и раз они появились как бы 111 миллионов реплик чтобы этого избежать чтобы избежать этого космического скиллинга мы вот как раз таки вот эти прекрасные инструменты внедрили теперь если вдруг ошибаюсь и сделаю купить сельский department replicas 30 спейси тест тут он не скажет скиллинг но если мы посмотрим на сами пода то увидим что вообще-то нет вообще то их далеко не 30 и вот если мы посчитаем то мы насчитаем их 10 и это ровно то количество которое написано здесь 10 кодов увидеть мы это тоже можем реплика с этим в and bass test самым свежим который у нас дизайн собственно 23 коран 10-10 если мы посмотрим то убедился в том что нас тоже рубль там есть можем глянуть тест вот они used 10 лимита 10 то есть мы тоже это видим таким образом влияние человеческого фактора на наш кластер кубинец она немножко снижается и мы особенно если какой-то аврал какая-то в реальной ситуации нет времени прогонять pipeline а я пеку через какой там сидите записывает через n себе резинку psy теле быстро-быстро что-то делаем но вот на всякий случай это нам может помочь в принципе с этим мы тоже вроде как разобрались до разобрались мы даже успеваем думал дольше а кто повторяет вы успеваете нормально отцы так нам space это тоже удалим последний кейс про который я рассказывал он был про priority class a тоже немножко напомню это еще один инструмент губернатор который позволяет нам если особенно у вас несколько окружений в кабинете вы с помощью этого инструмента можете контролировать то что происходит у вас квесты а именно вы можете назначать приоритет production имеет высокий приоритет development под имеют низкий приоритет и тогда в случае аварии у вас первыми на свободной рабочей ноты поедут production коды ситуация про который я рассказывал на докладе было следующим там в общем тоже было два окружения кластер с половине а из-за того что была сетевая авария часть not отвалилась оставшиеся под и соответственно начали переезжать давай пенза раза залез целиком продакшене не полез вот чтобы этого избежать маст хав для тех кто юзает тоже несколько окружения в комбинации это неплохо я считаю это ну экономит ресурсы как минимум просто вот priority class и их надо юзать так тем временем у меня не space удалился это хорошо перехожу в папочку привороте квест здесь у нас ряд манифестов как можно догадаться у нас есть приложение development и приложения продакшен и есть еще вот некие такие файлы сейчас мы с этим разберемся вообще в любом квестеры более-менее свежей версии если вы выполните команду куб стив гет писи то вы увидите вот такую ситуацию на самом деле в квесте руку бернес по дефолту уже есть два priority class a они называются систем кластер критиков и system not критиков и у них вот такие огромной вылью и это типа нормально для преврати класса 2 миллиарда 2 миллиарда 1000 как сказать ну да эти priority class и они привязаны и работают с компонентами квесты кубрина таз и сетевыми компонентами соответственно систем кластер critical относится к компонентам кластера например copy серверу a system not критика у нас относится к компонентам сети то есть они все эти у нас более критично чем потеря opi сервера потому что если у нас потеряется сеть то у нас есть риск что это за affected наши клиентские приложения как это смотреть если вдруг кто-нибудь интересовался если вы незнакомы с priority классами до этого не работали но при этом у вас зале ковырялись то вот вам спейси куб систем у какого-нибудь давайте api сервера посмотрим это мастер один например discreet только если сделать descried мастера api сервера игры пнуть по слову при чтобы всю портянку не смотреться смотрите есть некие поля priority 2 миллиарда и priority class name system кластер критиков ну как не сложно догадаться это вот у равна ней и то же самое там к с остальными компонентами то есть по молчанию нас принципе у кубинец а вот эти priority class его этих компонентов есть но не совсем доберемся покажем а пока давайте посмотрим как они могут работать на наших приложениях я сейчас открою быстренько depo менты пробегусь в общем вот есть условный development он опять же gx2 репликах но версия 113 там и смотреть у него вот такие request a limit и типа 200 миль и циpкa 100 мегабайт озу ну так скажем не очень большие ну типа этот ген поэтому и из такого что здесь появилось это с в поле speck появилось новое поле priority class name и вот такое и медива priority это ссылка соответственно какой-то priority class который в кластере должен существовать мы его создадим обязательно если забудем и есть еще приложение production здесь ровно то же самое с небольшими отличиями что priority class name здесь другой он продакшен priority называется и версия 114 новая версия и соответственно request a limit у нас тоже чуть чуть больше ну типа production да нам надо чуть больше понятно что притянуто за уши ну чушь подливать и давайте быстренько глянем на файлике с priority классами они тоже вот прям максимально до безобразия минималистичны название и вылью единственного ли у вас по-хорошему ну должен быть сильно меньше чем вылью у компонентов более того насколько я помню он больше этого вылью сделать не даст он поругается можно проверить вот и здесь у нас соответственно мы говорим что для подав девелопмента у нас 900 миллионов целью нашего преврати кваса то есть они имеют 900 миллионов у попугаев и неважно чего просто 900 миллионов ни в приоритет а у продакшна тихо не пиве продакшна 1 миллиард больше ну это логично я напомню все под у кого при перевороте квас выше у кого вот это были выше они более приоритетны для scheduler а иона будет первыми соответственно в случае аварии увозить и более того если на рабочих нотах не хватает места и вот он production перевозит это место не хватает он девелопмент оттуда будет скидывать лишь бы наш production залез мы это прям сейчас проверим действительно ли это так можете и вру так да сам сказал чуть не забыть и сам чуть не забыл давайте мы все это дело сейчас применим единственно нам нужны будут для чистоты эксперимента разные нам спейси собственная вот так вот прям скопирую чтобы не тратить время тут мы применяем в кластере наши priority class и и создаем нам space и продакшена development ну если я сделаю куб ситигид писи то теперь у нас вот он продакшна priority появился со значением 1 миллиард ядова приводится со значением 900 миллионов хорошо едем далее ну и диплом наше приложение deployment production запускаем в продакшене deployment development запускаем давай запускаем и прежде чем продолжим надо немножко познакомиться с нашим кластером потому что в этом вся соль давайте мы сделаем какую-нибудь ноду нод как он давайте 01 и 02 тоже посмотрим а именно нас интересует ресурсы ресурсы в нашем кластер они такие даст достаточно не резиновые у нас всего ого кейт resources всего доступно ресурсов для кого стирку вернется вот на этой ноте один цикл и тут почитайте сколько 450 мегабайт от 11 процентов типа 4 гиганта где-то грубо говоря 4 гб озу узкое место в нашем случае как вы понимаете цитатам всего лишь один цикл а мы в request of грозовым какие-то конкретные значения сдержит describe ноды мы можем посмотреть какие коды на этой моде у нас запущены и видим что у нас scheduler решил запустить два кода с допинг приложением на этой ноте и один пост-продакшном но видимо так полезно и теперь уже 90 процентов всех ресурсов подсыпал у нас там занято то есть зарегистрировано так скажем о хорошо давайте посмотрим моду 2 как там там с конфигурации ровно то же самое 1.4 газу единственно scheduler когда думал как это все распределить он соответственно сюда отправила на запуск только один индекс прот и здесь у нас 500 миль и цыпа зарегистрировано но если вас помним у нас на одной реплики нашего продакшна соответственно 400 миль и цыпа мы ставили were квестах а здесь 500 кто-то еще захапал request of если мы посмотрим вот сюда то увидим а у нас оказаться в финал есть ну что логично работает финал сетевой плагин и у него were квестах тоже есть сто миль и циpкa но типа норм с сетевой плагин ему по-хорошему до явно нужны какие-то ресурсы и хорошо что они там есть эти request и то есть в итоге у нас всего на ноде 2 до помада на ноги 2 500 миль и ципао тоже рано еще 500 остается она первая ноги вообще все 900 милицы повод ажурно это вместе с нашими проданными и белыми приложениями и фена вам хорошо предположим что что-то пошло не так и мы это сделаем опять же лабораторных условиях чисто технически можно конечно выключить в mq подождать 5 минут 40 секунд по дефолту и у нас под и сами начнут пережать но мы давайте не будем столько ждать мы просто сделаем drain и со второй ноды мы возьмем и все коды перевезем а я напомню на второй ноде у нас работает продакшен с соответственно 400 миль и циpкa у него were квестах она первой ноде у нас осталось только сто миль и цыпа то есть там а не полезет соответственно придется что-то делать я вот здесь вот такой подправлю за 3499 поехали со второй надо у нас поехали приложение и мы помним что на ноги один сейчас по идее не хватит места то есть туда всем вот этим скопом они туда не заедут но посмотрим как разрулит это scheduler и повлияет ли на это priority class и глянем на наши коды в продакшене как он назывался a production видим что в пензе где висит так это уже нас должно насторожить то есть он что-то пока не запускается ok давайте глянем девелопмент а что вообще там происходит и девелопмент пока в пензе где висит хорошо ждем а по а про тем временем в ранге а давай этим бременем до сих пор спиннинги ну вот столько времени если он до сих пор спиннинги это уже что-то нехорошо его можем проверить что именно там не хорошо если сделаем вот так и соответственно там на спиннинге висит вот этот человек но и здесь мы увидим что до scheduler у нас говорят что некуда его разместить то есть не как при этом еще раз обращу ваше внимание что productions у нас-то доехал и действительно смотрите у нас на ноги куда мы переселяли продакшен вовсю сидел и работал development и priority class и сделали так что development оттуда выселился лишь для того чтобы продакшен все-таки туда доехал и запустился и все стало у нас хорошо окей с этим кейсом мы разобрались и все таки выяснили что да все в этом плане у нас работает вот с этим примером давайте мы сейчас сам кордоне все это я даже вот так вот прям сделаю есть еще одна штука которую я хочу показать это прекрасный пример как можно выстрелить себе в ногу этим priority эти priority class они так скажем есть вектор нюансы если мне не изменяет память поправьте пожалуйста в 2019 кажется году у графа на был такой крупнейший факап 20 19 не помню давненько это было когда у них лег под лед частично пород и потом они писали по смартом в этом паспортами они чистосердечно признается что дело было в приорате классах а именно детали опять же не помню но факт что priority class это вот снаружи кажется очень такая простая и понятная штука но во-первых у priority class есть дефолт и некоторые во вторых приорате классы они влияют на три вещи влияют на skay link если мы стелим приложение то тогда тоже будет коды с более низким преврати кого сам погоняться влияет на диплом если мы диплом и он не влезает и тогда тоже более низкий будет удаляться и соответственно эвакуацию и влияют они действительно на всех сейчас мы в этом убедимся перейдем вот сюда и снова запустим наше приложение можно было в принципе заповедь но перед этим мы подправим кое-что мы в дипломе нити для продакшена укажем не 400 a800 вот так вот грегори квестах помним что у нас на нотах один цикл и мы 800 из них зарегистрируем под на шпрот соответственно две реплики одновременно на один на одну ноту не поеду поедут на разное математика 1 класс или какой там 5 соответственно 200 миль и цыпа на нотах останется но у нас еще есть девелопмент и удиви append а если мы вспомним там 200 то есть 800 плюс 200 ровно 1 циpкa сейчас у нас должен заняться и по идее оба окружения должны стартовать и все хорошо но вы помните когда да когда мы смотрели диск рэп мы обратили внимание на то что у нас финал есть который вообще сто миль и циpкa за request я в самом начале говорил что есть два сторож класса которые там отвечают за компоненты кластер за сетевые компоненты вот они есть работу ты все хорошо проверим да так разработчики решили чем-то узнает нет нет это дефолт я заново а стоп ошибочку дешевые сусов так еще раз а точно-точно . сказывается вечером применяем production & development у нас по идее должен был применить где он там нет второй строчкой шел не применился вот так вот мы проверяем на спейси продакшен у нас все завелось спейси development у нас все заводится так новом раз кордоне ли оскар доннелли оскорбления в пензе gear петь деньги в пене деньги давать когда нам ой входим же все-таки чем она на что ты хочешь стартует все-таки просто видимо да просто немножко подвис бывает все видим что у нас и документы production залез все хорошо хорошо ли смотрите вот сюда мы с вами сейчас успешно потеряли сеть на обоих ногах да вот я только что говорил да что вроде бы в кубер на это все приоритеты для основных компонентов есть это же как же так а как почему тогда сети то так получилось давайте ка посмотрим на плоды этого финала и что там такое я на по не говорю я про это собственно говорю у нас кваситься развернуть через куб спрей самой обычной ничего такого просто в качестве сетевого плагина выбор в финал ну нравится мне финал легкий и простой есть стикер в телеге надо было ставить калика я его тоже видел даже иногда вспоминаю но на таких вот простых кластеров я как-то привыкла искрой поддеваем и чтобы нам легче читалось давайте мы гребнем это по слову при и ничего не увидим у нас в template dedeman сета кодов нет вообще никакой строчки про приоры про priority class name как мы это делали в де память это и смотрите усвоенного в кубе в куб спрей я не знаю как на самых новейших версиях но здесь если вы раскладываете квестор войну они не ставятся никакой преврати класс и вот здесь можно выстрелить так много и соответственно отхватить такую проблему при этом если у вас калика там есть priority class самый высокий not критику самым большим числом и такое такая фишка уже там не пройдет поэтому да еще раз надо было ставить каликой вот я даже закончил да на этом у меня все еще раз повторюсь по поводу там доступов и так далее можете еще поиграться те кто будет на смотреть записи да давайте вот так вот выведу чтобы клонировали если что все это будет в общем доступе в общем можно будет это повторить вот на этом у меня все до насчет вопросов так как время мы немножко задержали вот у нас есть время буквально на 2 вопроса остальные вопросы вы можете задать в дискуссионной зоне которая будет доступна в за нашей сцены я не знаю даже работает она ли еще вот но давайте пару вопросов и закончим только давайте не очень долго потому что нас уже выгоняют вопрос довольно простой как мониторить эти вещи чтобы не стрелять себе в ногу периодически простой и на него очень долго отличить если кратко то я про это уже говорю немножко в своем в рамках своего основного доклада это вопрос не конкретно мониторинга там ресурс квот или там лимит ренджи это вопрос вообще в целом мониторинга и ведение ресурс менеджмента вк обернется то есть нам по хорошему не за конкретным манифест ими значениями надо смотреть а в целом за ситуации в кластере и тогда не сильно важно какие у нас там значения стоят там был один кейс который был озвучен по поводу hop anno докладе что типа ну вот у нас hop он может скелете мы тем самым его ограничиваем как же так вот именно для этого и надо представьте если нас hop за скелет наше приложение до такой степени что там положит кластер по ресурсам вот именно для этого и нужна поэтому ну кратко отвечая на этот вопрос грамотный мониторинг ресурса нажимаем золото ресурс то есть просто все что-ли видится но мониторится в процентном соотношении по использованным убрали да да есть там прекрасные экспортеры который кучу metrics отправляют все это можно смотреть поэтому да можно заморочиться написать баши зма куб ситель describes выдергивать циферки я вот собственно тоже вариант спасибо за доклад у меня такой вопрос но кроме соответственно того чтобы поставить калика все же priority class и для вот таких системах плагинов как лучше организовать то есть но заранее учитывать что там допустим все но до упаду ты рассчитывал с этим рассчитывали ресурс нехорошими кажется способом все же какой вот тоже немножко про это отвечал я здесь наверное отчасти исхожу из практик которые приняты на хостингах то там есть такие уровня отказоустойчивости тир и в принципе ориентация на такие сало метрики и так далее это очень хорошо коррелирует с бизнес требованиями мы по сути идем бизнес и спрашивать и вам надо вы там сколько хотите полежать если чо в год и исходя из этого соответственно прикидываем цену читать и того чего они хотят у нас были ребята которые на битриксе хотели четыре девятки я им заряди вот такой инфой вот такой цели как сказать давайте вообще без вас за 4 как бы поэтому до вопрос вопрос усилий и вопрос требований но в целом повторюсь эту фразу который я говорил просто дублицирование основных компонентов это не очень хороший вариант потому что это паху хостингом параметрам псв это тир 2 по моему да он как бы считается низким вот здесь наверное это тоже актуально нам по хорошим нужно иметь какой-то некий буфер и по графикам условно используемых ресурсов и так далее ну типа 70 процентов у нас типичная нагрузка идет и и это наверное хорошо то есть выше типа 8090 при тепловой нагрузки если у нас занят кластер это уже не очень хорошо что наверное заканчиваем на этом вот я предлагаю выбрать книгу уже в дискуссионные зоне а потому что всего лишь два вопроса была я думаю это не очень много так коллеги всем большое спасибо за то что присутствовали сегодня"
}