{
  "video_id": "c5YmzfagtmM",
  "channel": "HighLoadChannel",
  "title": "Postgres Pre Commitfest Party",
  "views": 132,
  "duration": 3210,
  "published": "2025-01-17T02:24:03-08:00",
  "text": "Здравствуйте Мне очень приятно видеть что у нас очень довольно наполненный зал у нас это впервые происходит этот эксперимент это замечательное событие и собственно почему я так очень рад этому Потому что когда мы организовывали нашу компанию мы как раз рассчитывали на то что у нас появится много разных компаний которые будут заниматься пом которые у на появится отрасли судостроения и мы будем заниматься таким красивым Хорошим орным делом значит вот сейчас у нас происходит вот такой этап Мы собрались Здесь пять компаний пять компаний впервые мы все друг с другом конкурирует так устроено порево сообщество маленькая версия международного сообщества вот меня Многие спрашивают каким образом люди как бы кричат за Open Source но при этом зарабатывают деньги Как устроено вообще посо сообщество вот оно очень уникальное Дело в том что в в это сообщество оно развилось из опен сорса родились компании та называемые прогрессо вые компании которые оказывают уже ну платные коммерческие услуги большим энтерпрайз например да но при этом нет ни одного ключевого игрока То есть все компании более-менее одинаковые вот все компании были организованы выходцами из сообщества они являются членами сообщества то есть они участвуют во всех мероприятиях они организовывают эти мероприятия сотрудники этих компаний участвуют в разработке сообщества при этом компании конкурируют в первую очередь как раз с ванилопу он очень хороший они конкурируют друг с другом но при этом каждая компания она является прокси между сообществом и энтерпрайз потому что сообщество развивается по своим законам а энтерпрайз он требует какие-то фичи какие-то фичи прямо сейчас Поэтому вот такие компании как наша Мы например удовлетворяем эти запросы А дальше начинаем нам приходится делать свой форк практически все компании делают свой фор вот довольно трудно обойтись расширением Но дальше возникает каждой компании выгодно поделиться кодом с сообществом Потому что когда вы делитесь кодом с сообществом сообщество берёт ответственность на себя за поддержание этого кода таким образом ванильный постгрес начинает расти А компании приходится опять конкурировать с этим ванильным постом изобретать какие-то новые фичи Да обратно делиться Нила опять раст ве что ты сделал какую-то фичу ты делишься не просто с кем-то А ты делишься Сразу со всеми даже со своими конкурентами То есть если мы сейчас например здесь вот продвигаем четырёх битные транзакции это та вещь которая очень важна в России потому что у нас постгрес используется в очень больших системах мы её отдаём всем в том числе и всем нашим конкурентам и Я знаю что все наши конкуренты они этот патч используют там так так или иначе вот Конечно мы на r& потратили Очень много сил Да но тем не менее это тот как раз оверхед который компания должна нести чтобы прогрессо вое сообщество чтобы Open Source развивался то есть очень легко Казалось бы сделать какую-то фичу зажать себе сказать что это у меня преимущество Да и сказать зарабатывать деньги но тогда сообщество не будет развиваться вы не будете настоящим членом сообщества поэтому наше прогресо сообщество она является вот чисто опенсорс при этом в нём хорошо уживаются вот эти коммерческие компании которые зарабатывают деньги и они драт сообщество потому что все мер контрибьютор они работают в этих компаниях если раньше скажем я и Федя мы с фед были последними мажорными контрибутор компанию получилось Что теперь их вообще Нет То есть сейчас сообщество взяло на себя функции это App значит тестирование Там и так далее обсуждение А все разработки по-настоящему ведутся Конечно вот этими поми компаниями которые удовлетворяют значит клиентов своих и делятся наработками со всеми Вот так работает уникальна наша очень хорошо сбалансировано Осо посое сообщество е раз напомню что Вла нельзя здесь сит же из даты нельзя взять и заархивировать проект наха нельзя и в этом очень большое такое это самое ещё Я радуюсь тому что О это в первую очередь что какая основная така фича Это не то что вы там хо можете модифицировать смотреть там использовать так далее ша к то чтобы все коларова есть работали совместно Да мы здесь соревнуемся друг с другом но у нас есть сообщество в котором мы можем коллабов и так далее да и поэтому Давайте ещ а ещё с нами Фёдор сигаев человек который метил множество патчей полезных а он будет помогать с техниче водной наверное ничего не надо не я про Давайте короче сразу к по по теме так две вещи скажу так Ну то что у нас Экспериментальный формат Вы уже поняли э у нас много спикеров будет А зачем это нужно вам э это такой способ подтвердить что вы можете разобраться в очень сложных вещах вряд ли что-то сложнее вот такого вот разработки СУБД или операционных систем или компиляторов можно найти Ну наверно можно но зачем вот Кроме того для вас Это для тех кто к нам пришёл постс ваш потому что вы его разрабатываете и первый шаг в сообщество - это ревью чужого кода это не написания своего это посмотреть на какого-то другого человека который тоже в сообществе на этом вся вводная часть закончена Давайте больше слушать людей и главное когда всё закончится вы ещ можете с теми спикерами которые вам понравились прожить обсуждение здесь либо в шатре У нас у ша где можно д шатра в короче в 2 часа Давайте передадим микрофон Михаилу который расскажет про свой патч Привет классном при Сегодня я вам хочу рассказать про свой патч который должен исправить колонку Weight Event в представлении PG Stat Activity для когда на нашей базе очень много количества подключений А что значит много Ну наверное не десятки не сотни а тысячи а то и десятки тысяч и вот если мы возьмём такую базу и начнём на неё гнать очень простую нагрузку Ну например очень короткие селекты ну их можно сгенерить смо и на своей любимой машине и запустим вот конкретно данный запрос который Что делает он выбирает из представления по AC данные и фильтрует их только по клиентским соединением и группирует по колонке как раз таки Event мы смотрим только на активный подключения Мы фильтруем всякие там которые есть те подключения которые сеча запрос и что же мы увидим мы увидим такую картинку что выберется строчка первая где состояние ожидания - это а состояние нашего бэнда активный А это вообще-то ошибка Cent говорит нам о том что мы сейчас никакого запроса не выполняем Мы ждём какое-то новое сообщение от клиента мы не можем быть активными в этот момен столкнулись и начали разбираться А разбираться начали в смыс чтения алгоритма алгоритм здесь выглядит довольно-таки просто здесь есть некоторый луп который объединяет две внутренних структуры данных первая структура данных называется backend status Ray из неё выбирается информация о состоянии бэнда активный он неактивный какой запрос сейчас выполняется как с какого IP адреса с какие там старты новых транзакций и тому подоб И самое главное что он выбирает оттуда копированием данных но при этом копирует создавая блокировку на чтение а сразу просто берёт и копирует но при этом проверяет что в рамках одной строчки он закопилити самого стреса а дальше берёт итерируемый гэп времени между тем что мы зачитали из backend статус арея и реально колонкой wa Event то есть для одного и того же БК энда мы читаем данные в колонках которые относятся к совершенно разным момен времени и Чем ниже строка тем хуже как раз это тем больше это время и тем хуже у нас получается выборка ошибка появляется всё чаще и чаще И что же мы сделали ну мы попробовали минимизировать расхождение во времени очень простым способом вместо того чтобы разделить эти два момента времени копировать для каждого бэнда разная информации Давайте всё это объединим в один к и открыли дискуссию первые отзывы были просто прекрасны да ребята Это баг Мы тоже с ним встречались всё хорошо Пока не пришёл Роберт Хас и сказал ребята Это не Баг и самое лучшее действие - это ничего не делать Мы немножко расстроились но всё-таки продолжили работать над этим исправлением и в течение года мы это исправление вылезали у себя проверили покрыли тап тестами и год назад мы выпустили данный фикс у себя в форке гп стандарт и pgp Enterprise за этот год я могу вам сказать что было несколько раз когда действительности Нам очень помогало это исправление то есть мы сравнивали вот вот на постгрес всё хорошо А когда смотрели Нил прям вот всё снова слёзы печаль грусть вот а и что же теперь А теперь мы вот здесь как раз все собрались чтобы обсудить этот патч и я хотел бы услышать ваше мнение потому что что почему пришёл Роберт Хас и сказал что это не баг Да потому что он боится что Вот не надо ставить никакие блокировки гарантии перфекционизма мы не сможем сделать а мы хотим с другой стороны всё-таки ехать А именно минимизировать вот этот Дельту во времени на чтения или же например пришёл другой комител Да зачем вы держите эту информацию в разных структурах держите в одной В общем вот вариантов много и я думаю что у кого-то из вас ещ делись другие идеи и Вас всех приглашаю в 2 часа продолжить обсуждение в нашем шатре Спасибо наверное я должен пригласить следующего докладчика Никола можно прокомментируй немножко А у меня дедлайн можешь не отвечать хорошо не надо вот отлично значит я что хочу сказать Вот ситуация сейчас в мире складывается такая что средний инстанс в России в разы больше как по объёму данных так и по мощности машины в результате часто сообществу приходится доказывать что это проблема потому что если вы делаете запросы раз в п секунд небольшие и у вас число коннекто там 10 и машинка 16 ядрах данных там 10 ГИГ то на самом деле в поро в эту проблему которую Миша рассказал практически невозможно значит сообщество сейчас в среднем работает с машинками там 16 ядер нормально 64 ядра большая машина значит наши клиенты 64 - это это стартовый уровень значит Поэтому ребята вообще нам нужно кооперироваться и рассказывать что у греса есть проблемы на больших машинах это одна из них Спасибо Михаил сейчас выступит Николай кстати человек который придумал в весть Наш новый формат Давайте его поприветствуем Здравствуйте я Николай Я работаю в компании pog Professional и я могу сказать Мише жилину что 2 года - это фигня вот эта вот история с новыми опциями для таблиц у меня длится 9 лет а 9 лет назад мне дали тестовую зада Как сказать студенческую задачку со словами Ну недели за две ты её сделаешь за 2 недели велели приделать опции к операторам класса даже не надо думать что это такое просто вот есть оператор класса и к нему можно и нужно приделы опции Я заглянул в эту тему и понял что вообще-то опции в постгрес уже есть есть уже опции таблиц и надо просто каким-то образом использовать один и тот же код Вот да я выяснил что этот код сильно прибит гвоздями в постгрес действительно есть опции значит опции таблиц Вот первая строчка чит с красненьким наверное создавали такое Когда вы таблички какие-то дополнительные привате что там типа заполнять её сильно не заполнять её не сильно там автовакуум запускать не запускать и так далее такая же история есть в индексах и такая же история есть теперь уже значит эту работу в результате сделал не я значит В операторах класса тоже значит вот можно присвоить эти самые опции проблема заключается в том что этот код очень-очень древний он возник ещ в тот момент когда пос как это сказать не был модульным когда был монолитным и изрядное количество опций например определены как э соответственно значит статический массив то есть да вот оно определено оно прибита гвоздями мы не можем как динамически это менять а в тот момент когда захотелось выносить э индексы в отдельные расширения придумали ещё один механизм соответственно помимо статического объявления опций есть ещё значит динамическое объявление опций есть специальная API которая заполняет специальный массив в котором рассказано как эти опции устроены после того как добавили опции оператора класса значит завели ещё один API абсолютно Как сказать симметричный В общем повторяющий тоже самой но только вот работающий локально В общем короче говоря Значит на грозде Костыль на косты на косты на косты и если честно очень-очень сильно хотелось сделать какое-то универсальное API которое работает с опциями в принципе не не привязывая к тому Является ли это э таблиц Является ли это оператором класса или может быть где-то ещё тоже нужны опции сделать абстрактный механизм по работе с опциями И после этого уже прикрутить его и к релей и и коп классу и к чему ещё захоче Да вот дублирующий как это сказать ээ API вот захотелось всё очень сильно разрушить и переделать значит что в результате было сделано было заведено две концепции значит одно из которых называется это самое Option некая структура в которой рассказывают про одну конкретную опцию про одну конкретную опцию и соответственно полностью она описывает то как эта опция должна парси и Валиди и соответственно завен Option набор этих самых всех возможных опций которые могут быть присвоены таблицы или об классу или чего-либо ещё значит и э бы структура Option бы в принципе описывала бы всё что можно и нужно знать про эти опции вот здесь на слайде приведены скриншот структуры которые бы сделано и Да после этого мы можем это вкрутить в Access метод или вкрутить в то место в которое надо как вот такие вот новые универсальные опции Единственная проблема которая нас отделяет от этого Счастливого будущего заключается в том что патч очень большой его непонятно как резать на куски То есть ты начинаешь трогать одно место и тебе приходится править все И в этих опциях похоже никто толком ничего не понимает поэтому я всех кому интересно э тему Приглашаю к нам присоединиться в шатре и соответственно значит уделить внимание как моему патчу так и патчу всех коллег Спасибо небольшой комментарий поскольку времени у нас сейчас мало я совсем небольшой во-первых Коля затронул одну вещь Что по возможности резать патчи на какие-то нужно места которые можно осмотреть и в реальности это достаточно тяжело если у вас фича какая-нибудь крупная типа чех битных сидов или Джейсон как было значит вот мы с Олегом я вернусь к теме опций Мы с Олегом разработали три индекса в постгрес и половину сильно и половину индекса сильно переписали операторы классов Я думаю что там или три десятка Мы в результате нарисовали опций сильно не хватает я ко разг я говорил А давай попробуем Ну что там вечно нужно какие-то особые конструкции выдумывать сказала никакого Джейсона в каталоге Вот теперь Коля мучается пытается сделать гибкую вещь без Джейсона надо помочь поприветствуем Илью ВМ всем приня Зора кони состоит в том что я написал новое расширение которое называется PG Stat adviser В общем если сказать это одним предложением что он делает он даёт подсказки которые можно дать для того чтобы что-то сделать со статистика таблицы В общем Какая история вообще написания этого расширения В общем 4 года назад как-то Константин книжник пытался написать патч который может улучшить estimated rows в Jo командах как раз с помощью расширенной статистики И там был создан Go параметр который вкл выкл который может делать следующее может тоже что-то вот подсказывать что вот надо создать ста в такой-то таблице по таким-то колонкам и вот у меня потом возникла такая идея что А почему бы не создать какой-то вот отдельно расширение которое может как раз именно вот эту расширенную статистику давать по различным критериям В общем я это расширение написал И пока что на сегодняшний день он может делать две вещи Значит первое Значит первое значит я создал Go параметр которое Ну имеет дабл значение которое делает следующее А значит он вычисляет все все талы которые добавились удалились и Арей которые ещ не были обработаны команды и общее количество всех талов которые есть в таблице и вот если вот этот коэффициент будет меньше чем вот вот это вот отношение то то при вызове какой-то какого-то запроса но на текущий момент пока что это по командам S при вызове ап подожди если мы этот коэффициент преодолеваем то по команде он нам подскажет что надо сделать а потому что всё-таки уже слишком накопилось слишком много талов которые ещё команды анала не прошлись значит это первый го параметр второй Вот как раз связано с расширенной статистикой это то что если ВД общему количеству будет превышать вот этот вот параметр то тоже по команде он Будет рекомендовать что сдела расширенную статистику по вот таким-то столбцам ну критерий может быть слишком примитивные слишком тривиальные но будущая патча будет состоить в том что рить чтот типа расширенной статистики может применяться только при определённых фильтрах В общем если будет интересно подробности также буду ожидать в шатре В общем у меня всё Илья Спасибо большое а вопрос есть сразу на засыпку на 1С пробовали на 1С пробовали Ну у меня просто я видел рекордный для меня размер запроса порядка 10 или 20 Мб оно там Но не засыпет Но если Значит мы go параметры по различному настраивали Да оно засыпало прям конкретно и вот и как раз вот от этого засыпания мы Я как раз понял что в уре надо всё-таки более подробно какой-то критерий написать вы скажем для статистики которая смотрит на функциональной зависимости там же он смотрит что есть только оператор end и поэтому как-то сузить вот этот фильтр чтобы он всё-таки не так сильно засыпал Спасибо большое на самом деле что я хочу сказать на самом деле вещь На мой взгляд очень полезная потому что всё-таки развитие компьютеров сегодня они ну тренд лежит туда меньше как можно меньше человек участвовал вот это вот шаг как говори мы лежим в том направлении легче будет те что в комьюнити ответили Ну мне пока пока ответил только Андрей лепихов как раз из ваший компании но Он предложил ещё две фичи Но вот одну из них он предлагал Слушайте если расширена статистика устарела то что вот делать Ну вот я как раз придумал анала а второе там как он что-то предлагал ещё с кастами что-то поправить обратить внимание тсдит Интере то коммьюнити тоже на это может не посмотреть поэтому не ленитесь это прежде всего км инженерам если у виде полезную фишку не поленитесь написать что блин я воспользовался мне она зашла и так далее спасибо спасибо спасибо поприветствуем Павла Всем добрый день Я Павел команда сбертех команда панголин расскажу о планах по компонентам это не только ядро но и сейчас я док но и различные компоненты то есть принесём в комьюнити разные флаки сборки То есть это там баунсер не выговариваемые слово zxn принесём фла юниты это pgq принесём изменения в сборке понга и в качестве старта Выра pdb такая компонента которая ускоряет восстановление Ой простите впер умотал Да которая помогает мигрировать базы данных и патч самые вкусные вещи вот которые на скриншоте они уже исправлены Но на самом деле там большой патч и местами он уходит да что такое Я не нажимаю уходит в корни макросов поса кажется презентация сама листается на удерживать она сейчас дальше поедет Ну в целом У меня всё наверное то есть Приходите поговорить о каких-то компонентах которые вас волнуют если что-то можем помочь донести или совместно прорешный са там листается сама листается Добрый день Меня зовут Иван кушнаренко Я из танс я вам расскажу про автономные транзакции Ну суть моего доклада в том чтобы вы узнали о них Нашли себе их применение и отписали в хакер как они вам нужны и как бы вы Их использовали потому что Тема если 7 лет назад Они сообщество было то сейчас уже сообщество думает нужны Не нужны и прочее так соответственно автономная транзакция - это транзакция которая будет зафиксирована даже если основная транзакция откатилась так тут это есть а соответственно зачем они нужны ну в данный момент они нужны для конвертации кода из Oracle например там есть автономные транзакции потом для логирования денга и прох автономная транзакция создаётся за счёт того что функция имеется прама autonom transac соответственно при выполнении этой функции создастся автономная сессия и которая ну соно транзакция будет выполнятся автономно здесь есть пример что создаётся основная транзакция Где вставляется ноль вызывается функция вставляет единица на на транзакции мы получаем в таблице есть единичка сохранилась соответственно автономные транзакции используются многих база данных в том числе отечественные имплементировать его её так и не pob так ну автономные транзакции в данный момент реализуются с помощью расширений PG background также Python 3 используется минус их в том что ну как правило в некоторых не создаётся по сессий соответственно на каждый вызов команды сода но сессия это затратно или например логин пароль в открытом виде хранятся в SQL коде Ну недостатки общем есть Так первые запросы по автономка появились в 2008 году В haers до 2011 года постепенно появлялись первые реализации появились в четырнадцатом году потом в шестнадцатом году и соответствено в 2023 году мы предложили кое-какие доработки а соответственно Ну патч наш реализован на основе патча пин Раута Ну взяли идеи там кое-что ребелион автономная гму амус добавили соответственно автономная сессия реализована с помощью бэкграунд воркеров общение между основной сессией и автономной сессии по протоколу постгрес идёт а общение синхронное и Ну один из главных преимуществ то что есть пул автономных сессий в паче реализация а соответственно общение Как происходит создаются некоторые статичные структуры типа dat потом две очереди создаются по которым происходит общение между основной сессией и автономной сессии Ну и далее выполняется код ну здесь краткий пример выполнение кода соответственно основная сессия отсылает сообщение запрос автономно е выполняет отсылается сообщение Z Complete И ждёт следующей команды от основной сессии соответственно Ну дальнейшие планы имплементировать там некоторые стейтмент не поддерживаются соответственно до имплементировать их добавить поддержку П пайтона А в данный момент пул для одного бэнда создаётся мы его хотим для всех кэндо соединений которые с постгрес сом клиентов может быть и синхронный сделать ну и соответственно в идеале в мёрзнуть Мастер но так как сообщество сейчас думает нужно Не нужно то может быть доведём как расширение так всё спасибо спасибо Иван можно а я а на на самом деле вы же воркера сделали да Через Граунд воркера Граунд воркер Смотрите тут вот сразу даже не заглядывая в коммьюнити я могу на задавать вопросов на которые требуются ответы значит вообще говоря автономные транзакции вопрос ж они виде резуль родительской транзакции или нет в вашей сме Конечно вы не сможете увидеть это может быть и правильно я не знаю демонстрирую вопросы от коммьюнити Следующий вопрос как она се поведёт если воркеры исчерпали вот воркеры все заняты а воркеры в постгрес их лимитированное количество може их много сде если они все все заняты то родительская будет ждать пока освободится я не требую ответа сейчас Это просто повод подумать и на них к нам так или иначе ответить следующее вот у нас скажите у кого больше трёх баз в инстанс есть больше Дети больше 100 вот у нас рекорд 100.000 бас в одном инстанс вопрос как она себя поведёт вот эта вот штука ну страшные люди я не виноват это не мы придумали Да значит вот таких вопросов на самом деле достаточно много и на поскольку Вы Совершенно правильно заметили что в стандарти скули этого нифига нету то на них нужно отвечать ещё один вопрос Давайте про вопросы в шатре поговорим У нас просто прямо вообще по времени короче и Ну хорошо у нас шатёр останется в секрете Да Пойдёмте в шатёр Сейчас поприветствуем Максима алло-алло так А как тут переключать ещё раз добрый день Меня зовут Орлов Максим я разработчик компании пост профессиональный Сегодня я вам расскажу про одну из таких вот основных даже можно сказать Таких вот важнейших частей которые у нас есть это вот четырёх битные транзакции Я вот уже так много повторяю это слово Что я начинаю сбиваться Мне проще восьми байт уже говорить Ну ладно давайте окун немного Что такое транзакции тут придётся конечно от Адама и Евы начинать я сейчас не буду тратить ваше время на это просто что нужно знать и почему это важно Вот это самое важное что я хочу донести до вас счётчик в посе транзакций он тридцати двух битный это просто ну просто число которое постоянно бежит вперёд а и кажется какие проблемы а проблема в том что на современном оборудовании такой счётчик Может у вас переполниться в день И это не какой-то исключительный случай это совершенно нормальные А такие Фло от наших заказчиков Аа То есть если э ваша нагрузка Ну какой-то у вас сайти или что-то такое что-то простенькое вы кладёте какие-то простые туда запрос свои вы никогда не наткнётесь на проблемы с ээ транзакциями Вы не исчерпаемые ну короче рассчитаны на то чтобы вы это не увидели конкретно это будет warr и вакуум Но если у вас высокая нагрузка А мы всё-таки на лоде Как я вижу Да значит вы должны понимать что при Вот вот которой здесь написана нагрузка получится что у вас вся работа постгрес будет критически я ещё хочу сказать ещё раз слово акцентировать критически будет завязано на работу вакуума А что нам даёт в этом случае переход на четырёх битные транзакции Дело в том что тогда эта проблема становится чисто теоретической то есть они при текущей нагрузке конечно могут переполниться Но это произойдёт там через 10.000 лет или там я не знаю через сколько через 000 лет Мам извини валы раньше закончатся там тоже счётчик шех битный и он не плюс плюс да да ну не будем сейчас углубляться Да в ревью и прочее Я не буду сейчас вас мучить именно там реализацией там какими-то Почему мы так сделали не так сделали форматы страниц Какие выбирали это всё было в сообществе у нас уже обсужден не один раз и от сообщества нет людей вот реально нет людей которые скажут что этот патч не нужен потому что развитие вет в эту сторону и количество транзакций оно будет только увеличиваться странно будет если оно уменьшится Да но проблема состоит в том что это очень большой патч на пол мегабайта и ну хотелось тут с каламбури да давайте слона есть по частям поэтому вопрос в том как разбить это на части в данный момент вот я вам показываю вот актуальный скрин несколько недель назад Вот вы можете удивиться что здесь тбек на самом деле здесь есть такое небольшое исключение потому что обычно это означает что типа ну не получилось нам это не нужно на самом деле Там договорились что мы вернёмся к этой теме переотправить от Да перевести оффсеты мультик сидов на 64 Бита опять-таки сейчас это неважно что это такое главное что здесь А это патч небольшой а возможно вы не сталкивались с проблемами с офсета Но если вы сталкивались то обязательно следите заходите говорите да нам это нужно Без этого жить невозможно Ну и прочее прочее Так что работа ведётся а вты мы переведём Я надеюсь в следующем в следующем нашем сезоне на 64 Бита это будет хороший для нас успех Потому что я в постс раунда на самом деле если кого-то не рисует транзакции Мультитран Зак и асетов Мультитран Зак и Мы надеемся избавиться от одного из раундов Спасибо то что нагрузки в России на поре заметно выше когда Мы начинали эту работу У нашего клиента в был раз в 2 недели значит потихоньку это уменьшилось до недели до 3 дней и сейчас вот есть клиент у которого он пришёл нам звонил со словами что у меня раз в день вра сейчас у него всё хорошо но Беда в том что когда мы вот пришли приблизительно год назад с очередным своим патчем Давайте комети ответ был Ну слушайте раз в 2 месяца вакуум можно и потерпеть Ну блин какой раз в 2 месяца когда у нас раз в день спасибо поприветствуем Антона Спасибо Здравствуйте меня зовут Антон Мельников я из компании по Professional хотел рассказать про патч который был в общем создан по просьбе первую очередь наших инженеров который должен позволять ограничивать память и всех эндо вместе то есть Например можно задать там допустим для каждого бэнда потреблять не больше 200 МБ памяти а для всех вместе 2гб Вот для чего это делается Ну во-первых чтобы дать возможность на сервере спокойно запускать другие процессы чтобы сервер дышал вот не уходил в SW и конечно за такой Ной ту Вот то тоже обрываются все остальные сессии и сервер уходит в Rec в данном случае ну полностью этого не избежать но можно сильно Уменьшить это вероятность этого события вот что сейчас есть хорошего по этому патчу значит в сообществе опубликовано пач от Реда томпсона который умеет как раз ограничивать общий обм и две независимые проверки там в ревю от Тоса вонд и наши измерения показали что вот текущий патч от Реда Томсона Он практически не влияет на скорость выполнения запроса мы провели довольно точное измерение с погрешностью где-то 0,2 0,3 про вот для разных для разных ограничений так как это случайные величины мы для каждой величины ограничений снимали целую серию измерений и строили распределение этой случайной величины Вот и видно что вот для ограничений а на сервере было 12 ГБ памяти и мы сравнивали ограничения вот просто без патча с нулевым ограничением 16 то есть выше предела оперативной и чуть ниже во Ну и такое клиническое ограничение 200 МБ и видно что все вот нормальные ограничения они в общем не влияют на скорость Они все укладываются в погрешность Вот и только вот это вот ограничение 200 МБ которая на самом деле это всего это 1% от всей памяти сервера Ну чуть-чуть медленнее но тоже там в пределах дисперсии то есть практически не влияет там на 0,4 про среднее ушло Вот и самое главное хорошее ещё есть третье - это то что в нашей компании разработан патч который умеет уже ограничивать память отдельных кэндо но все вместе не умеют Вот и поэтому вот а это из хорошего а из плохого М это то что текущий пач вот от Реда томпсона он к сожалению а устроен Так что ошибку то что памяти не хватает вызовет не не тот Кэн который съел больше всех а вызовет его Тот кто последний пришёл даже не виноватый маленький Вот вот это в сообществе сразу вызвало нарекание и в общем это придётся переделывать Ну и тут вот ещё есть там ряд серьёзных замечаний я сейчас не буду наверное все озвучивать их можно у нас там будет поподробнее в шатре посмотреть Приходите вот расскажем есть вот и что собственно предполагается делать По этому патчу соответственно первое надо объединить то что сделал вот в сообществе ре Томсон с нашим патчем который разработан в по про кстати вот Максим Орлов его автор вот он тут вот объединить это ВС и сделать в общем очень серьёзную переработку и доработку патча там есть отличное ревью в сообществе от это Томаса вонд и по существу много вопросов и вот и по коду больше двух десятков замечаний В общем Кто хочет его можно рекомендовать Как в общем образец такого ревью идеального Вот кто хочет посмотреть как в общем это выглядит хорошее ревью можете заходить вот в этот ТД в сообществе и вот брать вон для подражания вот ну и соответственно когда мы там будем уже публиковать это наши наработки и вы можете присоединяться что-то писать и ждём ревью от вас вот по этому адресу в сообществе заходите и туда и к нам шатёр По всем вопросам спасибо спасибо А у меня такой глупый вопрос Я очень быстро Значит кто сталкивался Ским см какой процесс убивали какой процесс убивается sshd нет вам совсем уж не повезло обычно убивается не тот который сожрал больше памяти а тот кто больше Потрогал А в современных условиях больше Потрогал чекпоинт поэтому его ом Киллер пришивает после этого постгрес разводит руками говорит идите я в одно место я не буду работать в таких условиях Поэтому собственно говоря очень важно по принти от прихода ум Киллера Спасибо поприветствуем Алёну насколько я знаю этот патч который про который Она рассказывает уже был в Мастере или или ещё не был сейчас а Да этот патч был в Мастере на совсем недолгое время буквально где-то неделю или меньше Вот Но мы активно продолжаем над ним работу и сейчас я вам Судя по названию замена окв на any Expression что это такое то есть у нас с самого начала пришла проблема от клиента у него сформировалось очень много bitmap снов с выражениями Потому что его реворк банально Не мог обработать in Expression то есть и выражение То есть у него 50.000 bitmap снов сформировалось Для выполнения этого запроса потребовалось а 1л гигабайта памяти и соответственно выполнение время выполнения выросло до 50 миллисекунд ой секунд Извините а у нас была идея Давайте попробуем Вене всё это упаковать посмотреть что будет наверное должно сработать а получилось что время выполнения сократилось до 300 миллисекунд а м Саши Ну я тут написала очень мало потому что если честно я уже не особо даже за детектива и всё прекрасно то есть у нас вместо бит снов использовался индекс СН и соответственно одно большое выражение массивом Да это Корнер кейс и он но часто встречается Если у вас есть фреймворки которые формируют автогенератора Давайте несколько вспомним о них я думаю это полезно будет для каждого во-первых Ной в данном случае я называю ИК Может вам знакомы се из плана или это N loop В общем это какая-то операция которая выполняется там для соединения или для сканирования экм или выражением клауза я называю вот то что выделено красным внизу а то есть где у вас представленный массив И количество количество строк или кардинальный Сто К сожалению немножко сдвинулось это ро равно де в данном случае на данном примере если не совсем Всё понятно и всё очевидно то если что я об этом да спасибо Фёдор Если что я об этом рассказывала на ПГ Конфи в прошлом году ссылочка проведена Можете свободно посмотреть об этом и дальше обсудим что вообще даёт этот патч помимо того что у нас бас Корнер кейс выполнился за 300 миллисекунд во-первых у нас за счёт более короткого списка выражений То есть у нас всё упаковывается в одно практическое Выражение у нас меньше идёт времени на формирование планов оптимизатор К сожалению любит много раз сканировать р выражения и в данном случае тут проведён список где он это помногу раз делает То есть он удаляет дубликаты ор выражений при создании индексов оценка селективности и тому подобное а скажем так бы был слайд для любопытных И также у нас идёт ускорение выполнения сенкана То есть если раньше нам приходилось каждый тупо сравнивать с каждым выражением То есть это тул равен единице равен двум то здесь мы просто формируем ш таблицу и про смотрим входит Ну известный тупо нет неизвестный то добавляем о НМ знания если если он вообще не состоит списке Но мы его уже обрабатывали то значит он не соответствует условию И также у нас идёт влияние на выбор наиболее оптимального плана Что это значит у нас есть преимущество у индекс канов все тупы уже отсортированы То есть если мы с пачем у нас происходит с пачем что у нас Не м не нужно А извините тут СРТ нота должна быть у нас не нужна дополнительная а операция сортировки чтобы отти наме применить операцию то есть при группировать эти плы в запросе и иногда влияет на улучшение оценки кардинально Если у вас есть ко мне вопросы по этому патчу предложени или вам Созрела какая-то идея что мы не рассмотрели можете найти меня информация чтобы найти меня кстати я неза что являюсь не только я но и Андрей лехов и также вы можете написать в ТД ссылку ТД Я тоже приложила можете там тоже спокойно Найти меня Спасибо Спасибо значит вот этот пач Я хочу сказать он возвращает нас к проблеме омов который герет не задумываюсь как умеют и порождают такие случаи в моём личном опыте первый раз я с этим столкнулся в версии поса 63 он тогда просто на больше чем де орах про р падал Значит теперь он молодец выдерживает 50.000 оров но при этом сжирает всю доступную память то есть улучшение есть но надо Дальше улучшать спасибо спасибо а поприветствуем Юрия Добрый день я Юрий Соколов работаю в постгрес Pro у меня маленький патч Я надеюсь уложиться за минуту расказ пришёл Клиент говорит Вот мы сделали вашим пробкам бэкапы у бэкапа есть время пытаемся на это время восстановиться получаем Recovery все валы проиграли время не нашли Почему проп для того чтобы узнать на какой момент он делает п он добавляет Recovery с помощью функции SQL вот в базе нет активности клиент тестирует где-то или на тестовом окружении или вот в базу залиты данные они не дополняются а восстановление на точку во времени в постгрес сейчас анализируют только записи комита и аборта а врем в xlock rest Point оно есть но при восстановлении на точку времени не используется так было не всегда примерно 10 лет назад в 2014 году это место Фактори и случайно потеряли реакцию на Point собственно пач два Патча в этом было предложено во-первых восстановить реакцию на та и е Добавить запись самой остановка вот в принципе всё спасибо что-то добавишь надо просто доделать это да просто баг который надо починить остался мой маленький патчи У меня всё просто я люблю проверять индексы на коррупции коррупции физическое разрушение данных па довольно давно лежит самое главное что если вы вдруг хоб разных индексах в Б дереве в гисе в джине или хотите написать для хэша Приходите разобраться это не очень сложно и Довольно интересно А ещё меня можно будет найти в шатре по Professional в 1400 мы там собираемся чтобы продолжить наш Весёлый формат у нас было сейчас 10 спикеров Всем большое спасибо что вы приехали рассказали и самое главное потенциальных ревью сколько-то ещ в трансляции сколько-то придёт в шатёр Давайте делать лить пост постс наш А можно я чуть-чуть прокомментируй твоё выступление Давай совсем чуть-чуть значит вот как раз возвращаюсь то что мы с Олегом написали три индекса ну половину сильно переписали У нас есть модуль л на которых у нас с Олегом нету сил дотащить до коммьюнити возьмитесь кто-нибудь потому что вообще оказывается Ну B3 плюс-минус Понятно Как должен выглядеть вот с стом уже сложнее А с джином или СП СТМ совсем плохо значит и поэтому мы параллельно писали модуль который позволяет исследовать внутренности этого индекса а только для супер узе потому что можно начудила это место пожалуйста Отлично спасибо за комментарий Я тоже L"
}