{
  "video_id": "0rz8IAvUjW8",
  "channel": "HighLoadChannel",
  "title": "ObjectManager, или Как работать с большим количеством объектов на карте / Марина Степанова (Яндекс)",
  "views": 111,
  "duration": 1774,
  "published": "2017-04-22T13:31:17-07:00",
  "text": "меня зовут марина степанова я руководитель группы разработки api яндекс карт и яндекс и сегодня я буду рассказывать про тон как показать на карте большое количество объектов какие проблемы вас ждут на клиенте такие клиентов какие проблемы вас ждут на сервере и как хорошо организовать передачу данных между сервером и клиентом сначала я расскажу почему сложно отобразить большое количество меток на клиенте какие там подводные камни с чем люди сталкиваются вообще пишу актуальность проблемы затем я расскажу про средства которые предлагают картографические api уже сейчас и чем вообще пользуются люди затем я расскажу как загружать метки по требованию ну как собственно организовать взаимодействие сервера и клиента и в конце я расскажу некоторые рекомендации по организации серверной части как там хранить данные как делать серверную кластеризацию и так далее итак почему сложно показать много меток на карте эта тема действительно очень остро здесь показана выдача собственно сколько как часто нас в нашем клубе разработчиков api спрашивают что с этим делать проблема встает как перед нашими сервисами собственно перед яндекс картами там индекс недвижимости и многими другими так и перед обычными людьми которые как бы решают там не столь большие проблемы например сайт банка motor.ru у него стоит задача показать все банкоматы в москве банкоматов москве очень много карта получается очень сильно нагружена и для них вся эта тема очень актуальна для того чтобы понять какие проблемы у вас появятся при решении подобных задач давайте рассмотрим сначала решения задачи в лоб у вас есть некоторый сервер и у вас есть какой то клиент этот клиент например мобильный телефон iphone у пользователя вам нужно сгенерировать некоторую html-страницу передать ее на клиент чтобы ловек в результате увидел метки на карте вы генерируете некоторую страничку которую условно называется пойду html передаете сервера на клиента если вы хотите просто нарисовать карту то весь код страничке париж тмл выглядит вот так но причем с док type a mi там со всеми своими делами теперь давайте добавим в этот код метки нам нужно что-то на карте еще показать то что сейчас показано на слайде это и я сгенерировала для презентации это я открыла один из наших сайтов ну и сайтов которые используют api и скупала что как эту проблему решили они разработчик далее и страницу вот эту пейдж html разместили описании вот всех всех вот этих 50 тысяч точек которые они хотят показать на клиенте то есть файл там понятно превратился очень очень длинную колбасу которая передается сервера на клиента очевидные недостатки этого решения во первых файл начинает весить несколько мегабайт то есть вы понимаете что мобильное устройство уже подгрузить его не заодно и не за 2 секунды мы передаем на клиент слишком много от них то есть если человек видит кусочек москвы а метки у вас например разбросано по всему земному шару то вы явно загружайте слишком много данных чтобы человек просто что-то посмотрел в мобильнике ну и плюс зачастую мы рисуем на клиенте те данные которые человек не видит то есть тратим время на рендеринг того чего на том что может вообще никогда не понадобятся что предлагал использовать или многие годы для решения этой задачи при чем тут я должна говорится что я сейчас рассказываю не только про решения яндекса это вообще типичный подход для решения этой задачи в различных карт графических api решение номер один она такое самое ядро работает во всех браузерах очень быстро у нас на этом решении например показываются яндекс пробки это технология активных областей суть ее заключается следующем вас существует картографическая попытка и для нее вы еще поверх загружаете набор изображений эти изображения представляет из себя прозрачные картинки поверх которых нарисованы иконки меток или каких-то других объектов ну там я отдельно от этого вы погружаете геометрическое описание меток на карте в результате когда человек вводит курсором по карте то мы просто просчитываем над каким объектам находится сейчас курсор и эмулируем как бы эмулируем все так как будто человек взаимодействует с реальным дома объектом а не спроста нарисованный png картинкой в частности сайт банка motor.ru которая приводила ранее работает на технологии активных областей то есть все вот эти зеленые штучки банкоматы сбербанка который вы видите на карте это подготовленные заранее тренды на сервер этой лики какие плюсы и минусы у данного подхода плюс и быстрый рендеринг на клиенте действительно показать просто картинку в браузере довольно быстро и хорошо передаются данные только для видимой области карты это тоже плюс очевидные минусы очень сложная серверная часть если вы хотите понять насколько она сложно попробуйте на досуге написать скрипт который генерирует вот эти вот прозрачные тайники с нужными вам картинками но еще один минус это картинка на клиенте абсолютно статично то есть элементарный кейс перетащить одну метку с одного места на другое вы решить уже в принципе не можете потому что на любое изменение картинки вам нужно отправить запрос на сервер который от там ответят измененными данными на клиентов решение номер два это использования клиентского класс there'sa таро опять же он есть во многих опиф каких-то встроенных как-то в каких-то нет суть его в следующем на клиент передается набор точек не класть и рисуется в результате показываются кластер и какие плюсы и минусы у этого решения но плюсы понятно очень просто использовать то есть там в api яндекс карта но он из коробки работает в других api это же не сложно плюс гибкая настройка на клиенте вы можете делать абсолютно все что угодно с вашим клиентским с клиентской картинкой и при этом не ходить на сервер там за обновлением данных минусы клиент тратят время на кластеризацию то есть собственно вот код который пластеризуется метки выполняется в мобильнике пользователя что они очень хорошо ну и не решена проблема оптимальной подгрузки данных это как бы всегда остается за рамками то есть вы как-то сами должны подгрузить метки которые откл интересуются исламе должны последить чтобы эти метки загрузились оптимальным образом еще одна проблема которая хочу осветить тут заключается следующем я специально осмотрела все картографические api и в принципе у них у всех вот эта проблема существует если вы хотите 50000 меток сгруппировать в один кластер вам любом случае нужно создать 50000 каких-то программных инстанций разных api это разные программные сущности но так или иначе это вот везде одинаково получается что для того чтобы нарисовать на карте один круглешок цифры 50000 вы должны потратить время клиента на инициализацию 50 тысяч объектов операция не удалась как я довольно дорогая и это может существенно снизить производительность вашего клиента и но собственно вот они лишние программы инициализации что мы хотим в идеале видеть мы хотим не делать никаких лишних инициализации на клиенте желательно загружать данные асинхронно то есть показать сначала человеку быстро карту и потом подгрузить потихоньку данные мы хотим передавать только те данные которые человек видит и мы хотим рисовать на клиенте только данные которые человек видит что мы сделали для клиентской оптимизации начнем как бы от клиента на сервер для начала мы подумали почему бы не хранить просто данные сырые то есть зачем нам сразу создавать какую-то программу инстанцию для метки которые может быть не показано на карте или вообще хлопнется в кластер поэтому мы храним только данные для метки до того момента как эта метка непосредственно пригодится на карте получается что программной сущности создаются только в момент когда метку нужно нарисовать на карте это решает проблему которой я говорил ранее если у вас 50000 меток за группируются в кластер не будет никаких лишних программных инициализации тем не менее когда вы сгруппировали метки часть из них все равно придется отрисовать поэтому следующий этап работы над скоростью был ускорение собственно этих меток мы внимательно посмотрели на наши метки и посмотрели на компоненты из которых они состоят наши метки довольно сложны потому что есть много кейсов которых метки самостоятельно рисуются по одной и у каждой каждый метки есть своя какая-то сложная логика своей инфраструктуры которой она живет на самом деле большинство компонентов которые существуют у метки непосредственно к отрисовки вот этой , на карте отношение не имеет то есть менеджер был у на а там есть менеджер всплывающей подсказке есть редактор гиа объекта но собственно за отрисовку отвечает один компонент который называется у нас оверлей такой-то день ускорения была очень простая мы объединили все метки которые показать хотим показать на карте в коллекцию в рамках этой коллекции мы рисуем на карте только оверлеи а всю инфраструктуру для всех там 50 тысяч меток условно мы вынесли собственно в эту коллекцию получился модуль который мы назвали обжиг менеджер он хранит данные джейсон и не создает программные сущности без надобности и вынесли все инфраструктуру в общую коллекцию так чтобы для каждой метки создавалась только по минимуму то что необходимо чтоб метку нарисовать тут потрясающее воображение график на сколько у нас получилось ускорить отрисовку меток тут я показываю за сколько времени рисуются метки этом с кластеризации там 1000 меня так 10000 меток и 50000 меток ускорение там больше чем в два раза в некоторых кейсах там ускорение до 10 раз некоторых похуже но суть в том что нам у нас получилось значительно продвинуться в опросе большой отрисовки большого количества объектов теперь давайте поговорим про загрузку данных сервера на клиентов классе когда вообще программисты начинают думать об этой проблеме то есть что вообще говоря человек видит маленькую часть карты а у меня данные по всему миру я хочу загрузить только данные для видимой части карты 99 процентов решений которые мы видим там например в клубе заключается следующем человек анализирует клиент анализирует какая область карты сейчас видно отправляет запрос на сервер там сервера дай мне данные для этой видимой области карта понятно что разрешение мониторов и всех разный размер экрана разное другой человек может увидеть другую кубик картографическую область соответственно пошлет другой запрос на сервер какие минусы этого подхода ну во первых на малейший сдвиг карта вам нужно генерировать новый запрос заданными потому что что-то скрылась что-то открылось нужно это обработать многократная загрузка одних и тех же данных как правило решения с которыми мы сталкиваемся заключается следующем что люди просто каждый раз грузии данные заново для новой открывшийся области на плюс запроса со всех клиентов поступают принципиально разные очень сложно организовать кэширование данных на сервере вы не можете понять как на чем вам построить собственно ваш кэш как вам это сделать поэтому правильный подход в данной задаче грузить данные по то его в прошлом докладе уже говорилось об отходе когда на карте отображаются tylo собственно моего тоже используем у нас есть некоторая видимая область карты мы вычисляем какие tylo попадают в эту видимую область карты и отправляем запрос заданными собственно для вот этих вот тайлов почему они хорошо данные загружаются по сути поди быть по одним и тем же границам потому что количество tylo всегда конечно тайл то вы всегда находятся в одних и тех же местах карты и вы можете уже организовать нормально каширование ответа на сервере плюс легче запомнить какие tylo подгружена какие нет ну и плюс небольшой сдвиг карты может не вызвать подгрузку данных если например у вас в новую картографической область не попали новые tylo собственно существуют два модуля непосредственного пикард который осуществляет логику на клиенте они отслеживают какие тайлы попали видео видимая область какие не попали отслеживают какие данные загружены какие нет что делать при смене коэффициента масштабирования и отправляют по той лавы и запросы на сервер заданными почему два модуля один модуль заточен под клиентскую кластеризацию 2 под сервер на то есть первый модуль загружая данные и пастеризуют их на клиенте а второе умеет показывать результаты того что вы там на генерировали носи берем также за них существуют разные режимы запросов заданными то есть несмотря на то что удобно работать по той лова понятно что если мы будем с клиента отправлять на сервер запросы за каждым толиком отдельно мы можем сильно забить канал поэтому запросы отправляются сразу для большой прямоугольной области карты но тем ни менее запроса формируется все равно по той лавой области что позволяет нам организовать каширование на сервере и если там разбить эту область на сервере на отдельные той реки оперировать всем так как будто у вас просто отдельно это теперь я нам несколько рекомендаций как организовать серверную часть 1 вариант который подойдет для показа большого количества точек при условии что запросу вас поступает по той лава это генерация обычных статических файлов количество файлов всегда конечно количество коэффициентов масштабирования тоже конечно и вы заранее их знайте поэтому вы можете написать скрипт который из вашей базы достает метки объединяет их по тылам и для каждого зума на генерировать вот такие вот файлы содержащие вызов джейсон тыкал бека сформированному там по определенному шаблону эта часть не требует по сути никакого сервера который будет обслуживать ваши запросы взаимодействие идет с файловой системой но файлом могут занять очень много дисковое пространство понятно что если вы генерируете картинки для коэффициентов масштабирования там с нуля до двадцати трех то у вас избыточность будет там в 23 раза больше информации чем нужно нужен скрипт который эти файлы генерирует от некоторые серверной части вам не обойтись и плюс это очень примитивное решение нам подойдет для таких небольших дома проектов либо для каких то таких инфо проектов в которых в один раз сформировали данные никогда не собираетесь их обновлять так подход правильный в данной ситуации это использование пространственных балданов то есть вы должны взять какую-то базу данных москаль там под греческой наложить на нее пространственные индексы и тогда работа с метками уже выйдет на новый серьезный уровень давайте теперь поговорим про серверную кластеризацию точек собственная говорила что один из клиентских модулей как раз заточен под то что вы уже на сервере группируйте метки какие-то кластера и передайте результат на клиента почему вообще нужно делать кластеризацию на сервере если вы делаете кластеризацию меток на клиенте то каждый клиент который открывает ваше приложение заново выполняет кластеризацию вы по сути тратите кучу времени и сил многих многих клиентов хотя могли бы подготовить данные заранее ну а собственно лишние программные операции и идеальная картинка что должно быть когда вы класс there'sa эти данные на сервер серверная кластеризация версия 1 заключается следующем когда вам поступает запрос заданными вы идете в базу достаете данные для некоторые области затем некоторый алгоритм пастеризуют эти метки в кастера и от возвращает на клиент взаимодействия с базой вас довольно примитивное просто выбрать данные по некоторые области вот и дальше вам нужно написать какой то скрипт который объединит метки в группы плюсы и минусы данного решения плюс следующем у вас очень гибкое место для вы можете написать любой алгоритм кластеризация какое вам заблагорассудится минусы заключаются следующем вы можете столкнуться с тем что у вас получилась очень низкая производительность вашего сервера и вам нужно очень хорошо заморочится с кэшированием данных чтобы сервера twitch'а отвечал на клиент достаточно быстро ну и плюс как бы чем красивый алгоритм как так тем он дольше работает как правило об этом не нужно забывать поэтому значительно облегчает тут жизнь grid кластеризация мы сейчас используем на клиенте почему бы не использовать ее на сервере суть заключается следующем на карту накладывается некоторая сетка все метки которые попадают в один квадрат сетки объединяются в кластер там на самом деле эту грядку стилизацию можно немножко модифицировать чтобы картинка была покрасивее на это сейчас не очень важна картинка вашей серверной кластеризации превращается вот в такую вы можете теперь пастеризовать объекты внутри базы данных одновременно при выборке объектов как это делается ну там пример скрипта такой очень примитивный который выбирает данные потом группирует их вот как раз осуществляет grid кластеризацию плюсы и минусы данного подхода заключается следующем вам не нужно ни писать никакой дополнительные логике не какое-то никого javascript а который делает отдельно кластеризацию и это довольно быстро работает минусы в том что горит кластеризация не всем нравятся чисто визуально ну как бы по картинке которая получается ну и плюс поскольку ваша база данных постоянно рассчитывает там вот меня в запросе было умножения и деления вы не можете эффективно использовать индексы в базе данных это минус поэтому следующий прием который позволяет еще улучшить собственно кластеризацию в базе данных это использование так называемых ватт киев что это такое кладки это некоторые коды с помощью которых вы кодируете положение объекта на карте причем они формируются таким образом что старшие разряды квад кода указывают на номер tylo там на крупных масштаб на крупных масштабах до точнее на мелких в общем ну их целый квад код указывает адрес объекта на самом подробно масштабе карты на самом деле алгоритмов которые могут формировать этих вот кода довольно много нот один из них например выглядит так и получается что для каждого объекта мы получаем некоторые битовый код который кодирует его положение поэтому если нам нужно выбрать объекты в некоторые квадратные области на некоторым зуме нам достаточно сгенерить правильную бытовую маску и по этой битовой маски мы можем очень быстро оценить нужные нам объекты получается что схема немножко модифицируется у нас есть база данных которые хранятся объекты и в этой базе на считанные квад кода дальше мы осуществляем кластеризацию объектов сразу при выборке объектов из базы помощью этих клад кодов кстати говоря квад кода позволяет превратить вообще любую базу special базу то есть если у нее нет пространственных индексов их можно как бы эмулировать с помощью вот этих подходов но тут опять же пример запроса как это делается и суть в следующем что когда вы выбираете объекта во первых выборка объектов происходит просто битовые операции там сравнением хватку до метки и нужно вокал от кода ну и плюс тепло кластеризация дальше происходит ровно по тому же алгоритму это очень быстро работает плюс и минус плюс очень быстро минусы grid кластеризации а не всем подходит я уже об этом говорил а ну и вам нужно заморочиться заранее на генерировать эти клад кода этот он требует некоторого времени и сил теперь немножко буквально поговорим про каширование и versio не рование данных с кэшированием все просто поскольку данные отправляются с клиента на сервер по той лова то собственный кэш вы должны организовать по той лавой ну то есть в хэши храните там тайл и номер tylo номер зума и все вы можете записывать данные файловую систему почему бы нет можете использовать какие-то системы типа memcache или рейда с для хранения вот этих данных которые поступают от сервера если запрос поступает небольшой таял его образ области опять же не составит труда разбить его на маленькие той лики достать и тито или киска ш сгруппировать и вернуть на клиент опасный момент в таком ну при такой работе это момент когда вы на сервере решаете обновить данные предположим что у вас есть клиент который полчаса назад открыл страницу на нее подгрузились некоторые метки дальше человек двигает карту у него открывается новая картографическая область для которой еще не загружены данные напомню что с того момента как человек загрузил данные до текущего момента прошло полчаса и ваш сервер ваш серверная часть обновилась у вас новая версия данных получается что у вас уже загружены метки старой версии есть риск что для новой области загрузится метки новой версии в принципе для некоторых сервисов это не крите что но вы должны просто об этом подумать знать об этой проблеме и сразу заложить ее в архитектуру во первых вы можете передавать на клиент версия данных с которой он работает соответственно на сервере вы должны хранить куш и несколько последних версий ваших данных чтобы клиенты которые начали работу до вашего обновления все-таки получали какой-то валидный ответ чтобы картинка средств данных на всей карте был одинаковый система каширования также можно завязать на версию то есть вы там в тот же редис кладете например данные и формируете ключ по номеру той лупы коэффициента масштабирования и по версии plus если вам критично чтобы клиент всегда видел самую свежую версию данных вы можете как-то продумать авто обновление версии на клиенте опять же у нас так работают пробки у нас клиент там раз в четыре минуты пингует сервер не обновилась не обновился рис рез данных и если данная обновились то удаляет все с клиента и загружают новую порцию поэтому всегда картинка собственно одинаковое но на самом деле это в принципе все что хотела сказать тут полезные ссылки первое это просто руководство разработчика в котором написано примерно то что я говорю на подробнее с примерами и если есть вопросы пишите в клуб у который мы в общем то отвечаем на вопросы по api мы там тоже сможем на все ответить у меня такой вопрос когда наконец таки сделаете ваке стрелочки буквально недавно лично я в песочницу добавила пример стрелка на карте нет просто я не помню мы используем по моему 2 7 или два шестую версию там еще их не было и нам приходилось делать от через костыли то есть это кастомный объекта все равно ни один объект стрелка то есть мы ее рисуем отдельными линиями да я поняла он это отдельный вопрос на самом деле больной инфографика вопи то есть я понимаю что это востребованная штука как бы часто спрашивают но пока у нас нет ресурсов на ее воспроизведение то есть мы стараемся там писать какие-то примеры если кому-то очень нужно реализуете а когда это будет прям вопия щас не могу сказать не знаю здравствуйте вопрос сколько вообще всего клиентов у карт яндекс ну-у каком смысле клиент приложение зарегистрированных то ваши там ну вот как уважать и когда вы запрошу то он там сотни тысяч сайтов сотни тысяч интересно спасибо подскажите пожалуйста знаете нет у индекс недвижимости проект какая кластеризация используется из тех что вы перечислили какой подход не крепко я пытаюсь вспомнить причем буквально недавно мы с ребятами на эту тему общались но у них какая-то своя это критично гадость гадость да не да скажи здрасьте спасибо за доклад а можно вот узнать сейчас недавно обновил яндекс карты на телефоне там начали автобусы ездить прямо по карте я сначала думал что то нет а вот хотелось бы узнать там непрерывный поток данных идет для передачи или как что будет если 1000 евро я думаю что все будет хорошо ничего не рухнет когда он непрерывный поток идет данных то есть он же в реальном времени движется у меня на карту тут я хочу пояснить наверняка идет речь про мобильное приложение про мяг да у нас разные команды делают мяч и два скрипта пи поэтому я про автобусы слышу от вас такой маг мобильные яндекс карты ну это наш внутренний сокращения сна то есть от них вам про да я кстати не скажу спасибо за доклад такой вопрос не подскажите когда появится уже в яндекс картах вопием дискард информация обо транспорте московском может разговора джуд и по два года что вот сейчас сейчас а вот сейчас никак на каком транспорте вы имеете это общественный транспорт до травы автобус троллейбусов но насколько я знаю сейчас вот свежей версии api уже есть маршрутизатор который умеет строить по общественным транспортом я имею ввиду куча стояние автобусов на карте в москве так вроде как такой информацией честно говоря не знаю то есть нет никаких прогнозов добрый день спасибо за доклад мне такой вопрос немного не по api я вообще по картам вы не пробовали не работаете в сторону векторной картографии вот google последнюю версию именно там с вектором делает ну дай конечно вектор от очень перспективное направление я надеюсь что в каком-то обозримом будущем у начнем делать векторная карта но сейчас реальность такая что как в реализацию вектора можно сделать не во всех браузерах которые мы хотим поддерживать с поэтому мозг я ну я то опять же фантазирую я предвижу какой-то плавный переход то есть мы наверно начнем какие-то эксперименты по вектору и будем медленно вместе с браузерами но типа на него google на это пошел он сделал это на своем сайте но вопи выдает все еще той лавы и карты вообще без вектора на на своем сделал на векторе а вы то бишь еще даже не начал как бы я так скажу есть некоторые прототипы но когда это выйдет наружу я сказать не могу скажите пожалуйста вы сказали прокладки это как бы эмуляция спешил индексов да а вы тестировали насколько ты быстрее то медленнее или но можете что-то сказать вот и синиц пришел индексов а вот только ваш подход использую если есть только кладки это работает очень быстро ну то есть я щас конкретных цифр не продуктов нужна конкретная база там данные на графике грубо говоря нет араб отель летает не но данные одни и те же да собственно выроют то есть вы используете свою собственную разработку виде от этих квадов амирова превращаемся в новые и как бы внедрили да и собственно из пришел яндексе делали вы замеры насколько это там быстрее медленнее или что-то и я боюсь вам чувствовать если вам интересно то я могу ну то есть напишите на почту я вам вышлю вот реально исследования красиво детей еще один вопрос по поводу критику и стилизацией как я понимаю сейчас у нас квадратики и они не всем нравятся не думали в сторону гексагон of хотя бы если мы используем гексагон и собственно пропадает все ну пропадает вся прелесть вот этой гриб кластеризации потому что кластеризация занимает значительное время на клиенте на самом деле есть несколько подходов там торые позволяют сделать grid кластеризацию красивый и у нас есть в планах замена вот этого движка кластеризации но опять же там на ближайший год может быть мы сделаем ещё можно это вот про карту когда говорят обычно приходит в мысли что поиск ближайших объектов этого когда к вам относится вообще копии индекс ее муж просто не то что говорю на спа поиск ближайших объектов чтобы меня не знаю вот так важно это . там много точек на карте вопит от ближайшей у нас есть модель который позволяет удобно там находить ближайшую точку находить точки в окружности там и так далее все есть документация спасибо"
}