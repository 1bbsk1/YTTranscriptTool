{
  "video_id": "F-6e6sfLvSc",
  "channel": "HighLoadChannel",
  "title": "Enterprise deploy: почему это больно / Филипп Дельгядо (lekton io)",
  "views": 1726,
  "duration": 2719,
  "published": "2025-01-17T02:26:02-08:00",
  "text": "Привет Нам только что на тех толке рассказывали про тонкости выкладки больших систем в энтерпрайз собственно про это я и буду рассказывать Меня зовут Филипп дагда я последние довольно много лет занимаюсь в основном финтех ВСС продуктами разнообразными платёжными системами чуть-чуть е комом и так далее и так далее и так далее конференции статьи сейчас мы строим в компании ктон карточный процессинг нового поколения а и с этим возникает много интересных проблем про которые я буду рассказывать Мы делаем коробочное решение для больших финтех для банков и платёжных систем поэтому то что мы разрабатываем это довольно большой продукт много команд много сервисов разные базы данных брокеры и так далее и так далее и он ставится у клиента поэтому на самом деле мы не контролируем процесс его обновления за него отвечает вообще говоря клиент поэтому я не могу сказать что мы там можем сделать 10 выкладок на продакшн в сутки потому что банки всегда хотят чтобы их корневые системы обновлялись 10 раз в сутки им это не очень удобно и Поэтому приходится с этим как-то жить то есть приходится уметь обновлять аккуратно без простоя без потери данных с минимальным возможным риском и про то как это делать Я сегодня буду рассказывать Мы поговорим Какие бывают стратегии мы поговорим Как работать с обновлением баз данных Как работать с разными типами взаимодействия между сервисами Ну и некоторая сумма в самом конце Какие как вообще с этим жить дальше когда-то Когда в мире были сплошные монолиты самым простым способом обновить какую-нибудь систему был ST and Run взяли систему остановили сделали п поменяли нужные версии протестировали и потом опять её запустили отправили не живых пользователей К сожалению это не всегда допустимо если вас нельзя взять остановить вашу систему там на несколько часов или дней или недель Вам приходится использовать более сложные процессы все идущие вокруг идеи BL у кого кста вообще используется активно В продакшене как-то немного Итак как выглядит идея У нас есть какой-то Старый сервис зелёный система ко есть какой-то сервис какая-то база данных на Первом шаге мы берём поднимаем новую систему ещё ни к чему не подключенную дальше переводим нашу базу данных в совместимый режим так чтобы с нем могли работать и старые и новые системы обычно эта логика живёт как раз в новом сервисе про это е поговорим отде запрос на новую систему при какие-то проблемы нам не страшно откатиться опять вернуть запросы на нашу зелёную систему она работает в совместимой режиме и вроде бы мы даже ничего не потеряем ну и потом через какое-то время мы избавляемся от всяких старых артефактов в базе данных переводим её в новый совсем режим Ну и дальше можно удалить старую версию и себе спокойненько счастливо жить всё это буде прекрасно пока у вас там один экземпляр системы одна база данных и так далее в реальном мире у нас уже немножко не так у нас много разных экземпляров Ну обычно Тоже работаешь ка небольшим количеством баз данных и это позволяет нам использовать некоторые другие паттерны деплоя можно сделать канарейку можно сделать ролинг update Rolling update - это когда мы все экземпляры конкретного сервиса меняем по очереди первый второй третий четвёртый пятый обновляем и смотрим Что происходит канарейка примерно то же самое только мы ещё управляем потоком информации идущей на эти наши сервисы например Сначала мы на новые сервисы отправляем 1% входящих запросов потом 10 потом 50 ну и потом в конце концов 100 но во всех этих сценариях есть одна проблема у нас одновременно в системе существуют экземпляры из очень разных версий и с этим надо как-то жить про то как с этим жить мы поговорим попозже но Один из таких классических вариантов - это включить фитон фиче флаги когда мы новую функциональность на новых сервисах включаем не сразу мы сначала их выкладываем когда они работают так же точно как и старые а потом например берём разрешаем использовать какую-то новую фичу которую мы сделали тем самым мы можем уже на новой системе потихонечку всё включать по во всех этих подходах есть одна Общая часть нам нужно уметь обновлять структуру схему наших баз данных про это сейчас и поговорим вообще кажется что всё просто написали скрипты или вообще ваш ом автоматически сгенерить скрипты миграции запустили их с помою ка и так далее и вроде бы всё прошло вообще думать не надо всё за вас делают стандартные фреймворки но нет так чтобы новы умел работать Рой данных чтобы новой Бао данных при этом Многие операции обновления создание индекса и так далее очень долгие минуты часы иногда бывают дни и откат не всегда возможен даже если вы создали колонку а потом её Удалите физически она скорее всего не удалится только там после какого-нибудь вакуума через какое-то время если вообще вы можете себе позволить делать вакуум на продакшн базе поэтому не всё ли так легко реально безопасных операций с которыми можно работать в базе данных совсем немного можно добавить таблицу всегда совсем безопасная операция можно добавить Новую колонку но при этом эта операция не то чтобы совсем безопасная на самом деле При этом в любой базе данных реляционной всегда будет эксклюзивная блокировка на несколько миллисекунд Но если у Вас например какой-нибудь долгий отчёт строится вы при этом обнов добавляете колонку и при этом у вас ещё какая-нибудь активная OTP э операции происходит они будут ждать пока у вас не закончится отчёт После него сделается обновление колонки А дальше можно будет работать поэтому если у вас много Долгих операций на базе добавление колонки не всегда безопасные вещ можно добавить индекс что тоже не всегда совсем безопасно в том же постгрес есть специальные команды Как делать индекс без блокировки основной таблицы параллельные индексы так называемые нужно их использовать и знать как они работают у них свои ограничения поэтому даже такая операция Не идеально безопасна Ну и расширение типа то есть вроде бы даже наши безопасные операции довольно хрупкие и ситуация и наша база данных при этом Ну может повести себя не очень хорошо например когда нам нужно сделать очень простую штуку поменять тип колонки Ну была строчка стала например хотим в Интера стринга перейти или наоборот Ну что мы делаем им создаём Новую колонку с нужным нам типом То есть была колонка а ринговая стала колонка б например числовая дальше надо разрешить запись Новую колонку в этом случае мы начинаем писать уже и в старое и новые данные наши Серви читаем ВС е старые потому что там актуальные Данные есть да мы процесс копирования данных нам надо все данные из колонки а потихонечку перенести в колонку Б про этот этап мы будем говорить отдельно Он не тривиальный он может занимать довольно много времени Ну дальше Потом мы начинаем использовать Новую колонку когда все данные там уже поместились при этом как бы мы пишем всё ещё и в старую чтобы можно было всегда откатиться Ну и в какой-то момент мы перестаём писать в старом формате Ну и потом может быть когда-нибудь вообще удалим старую колонку потому что она нам не нужна всё это довольно долго происходит и всем вот этим процессом надо управлять поэтому поневоле нам приходится в своей системе создавать набор инструментов из которых основной менеджер миграции который понимает Какие миграции Какие шаги уже можно выполнять мы добавили колонку можно уже потом сделать на ней индекс мы не можем сделать индекс если колонки ещё нету учитывают всякие взаимосвязи между ними учитывает взаимосвязи с тем Какие вык сервисы уже готовы например к этому Ну и умеет при каких-то сбоях продолжать миграции если например Мы в середине а процесса упали он поднимается и понимает что ага мы вот колонку добавили индекс ещё по ней не сделали надо сделать этот индекс Кроме этого нам нужно где-то хранить описание миграций традиционно раньше считал что миграции можно описать сэлем но сейчас очень активно развивается хранение данных в полях Там Jon Jon B и так далее которых нормально можно работать только внутри того же самого бизнес-сервис который эти данные создаёт поэтому у нас только Ико для миграции уже недостаточно приходится часто делать кусочки миграции которые описываются кодом причём код связанный тесно с бизнес логикой конкретного сервиса и часто это нужно делать именно на том самом сервисе который работает с этими данными Ну и надо уметь поддерживать миграции данных ну опять-таки кажется что взяли сделали один апдейт там с колонки А в колонку б Беда в том что во время этого апдейта у вас опять-таки будет блокировка на все эти данные А сам апдейт там каких-нибудь 10 млн записей может занимать довольно долго секунды и даже минуты а если 100 мл то даже и часы поэтому и выбрать какую-то пачку данных не очень большую там лучше всего если у вас есть какой-нибудь монотонный индекс И вам удобно по нему выбирать лучше всего Когда у вас есть поле где указано какую схему данных данная строка поддерживает и вы можете выбирать только старые строчки не выбирать уже обновлённые а перевести все эти данные в новый формат и записать эти данные опять-таки в базу данных Ну и дальше сдвинуть счётчик С какого места мы вообще всё продвинули чтобы в случае падения начать опять с какого-то места Ну вот последние три операции лучше делать в одной транзакции это гораздо безопаснее вас вы взяли там получили 000 записей Обновили сдвинули счётчик вяли следующую если упали Вы точно знаете где была проблема а и все эти операции на желательно повторить не просто подряд а с каким-то а паузой чтобы не сделать слишком большую нагрузку на вашу систему потому что у вас при этом идёт нормальный продакшн Если вы возьмёте начнёте там активно менять на Боевой таблице все данные апдейты может быть вас просто не хватит производить в моём опыте как-то мы делали миграцию которая шла 3 месяца это была одна из основных баз данных довольно крупной системе и пришлось понемножку буквально там по однодверные Таблицы с разной структурой данных чтобы потом в конце взять и целиком перейти на новую Так что это бывает довольно длительные операции Ну ещё надо уметь управлять зависимостями вре миграции то есть хранить Какие вообще были миграции запущены чтобы там сервис при запуске понимал что Ага я сервис там пятой версии Я предполагаю что такие-то миграции на базе уже прошли они ещё не прошли давай-ка я лучше Упаду и скажу что нет я не готов работать с этой базой данных в не нет нужных мне данных ну и выставляют какие-то фиче флаги всё Я закончил миграцию по созданию индекса теперь можно пользоваться методом кото ильз индекс для отдачи данных до этого этим методом пользоваться не стоит потому что он будет работать медленно собственно наверное про базы данных всё что хотелось сказать только хочу напомнить что бизнес конфигурация - это тоже база данных и нужно уметь не только ваши операционные данные уметь обновлять между версиями Ну и бизнес конфигурацию это иногда сложнее потому что там совместимостью всё гораздо грустнее но это тоже очень важная часть про взаимодействие сейчас у нас уже обычно один монолиты одна база данных а у нас обычно много сервисов и они все так или иначе друг другом связаны и тут возникает некая проблема Если у вас какие-то два-три сервиса обмениваются данными они друг с другом сильно взаимозависимы вы не можете из них обновить один не учитывая возможности что второй не поймёт новых формат там ответов сообщений и так далее Все они становятся док от друга сильно зависимыми И конечно в теории там микросервис - это то что можно а что автономно не зависит каких других микросс можно автономно обновлять в реальности так не очень бывает у вас всегда есть какая-то зависимость при любом варианте связей собственно Что значит зависимость значит новая версия должна уметь работать как старая Ну с точность до каких-нибудь фиче флагов старая версия должна уметь понимать запросы приходящие от новой Ну может быть потеряв при этом какие-то новые незнакомые поля А и кажется что это легко решить если у нас все изменения будут совместимы а возникает вопрос Что такое совместимость по-хорошему совместимость - это про требует очень точного понимания Как устроены все участники взаимодействия Потому что от того Можно ли добавить новую пустую там не значащееся условий чтобы предполагать что разный сервисы друг с другом совместимы при конкретном изменении А лучше по совместимости смотреть в разных срезах Ну во-первых есть совместимость по синтаксису Когда у нас Синтаксис - это про наш формат данных про то как он описывается и здесь совместимость довольно легко её упра видно то есть это у нас какой-то код какой-то мето описания IP мы часто явно видим протокол вызова при этом совместимость зависит от протокола то есть там в джейсоне мы можем себе позволить гораздо больше гибкости там jpc зависит от стека там какой-нибудь дкн на Джаве позволяет гораздо больше издевательств на при парсинге входя запросов чем там стандартный энкодер в Go зависит от соглашений мы можем договориться что мы всегда можем добавлять произвольное количество полей если поле вам не знакомо вы его игнорируете ну нормальное поведение и этот подход к совместимости про него чаще всего Говорят он проще всего контролируем можно вообще автоматически контролировать совместимость синтаксиса но его не всегда хватает потому что кроме синтаксиса У нас есть ещё семантика семантика - это про смысл про то что раньше Вы считали что поле сумма в описании платежа значит сумму до расчёта комиссии а потом стали читать её после расчёта комиссии и никакая автоматическая проверка синтаксиса вам не поможет не покажет что смысл изменился что теперь у вас другая семантика этого же запроса А поэтому совместимость зависит от конкретного использования вообще говоря Если повезёт документи ется но проверяется только тестами никакого другого способа проверить семантику нету но кроме семантики У нас есть ещё и прагматика про то как реально используется ваш метод например вы всегда думали что данный запрос нужен только для того чтобы показать дито банке там последние 100 платежей и вы сделали хитрую оптимизацию которая мена этот сценарий делает гораздо более эффективным и у вашего клиента всё упало потому что он этот метод использовал для отчётности на 100.000 строчек и теперь ему стало очень грустно потому что раньше именно этот кестер стал работать медленнее и прагматика - это то что вообще вы как создатель как разработчик сервиса не контролируете Она всегда где-то снаружи иногда тут тесты помогают но иногда большей части вы не можете покрыть тестами то как вас использует какая-нибудь другая компания или даже другой департамент вашей компании поэтому изменения описывают делить не на совместимые и несовместимые как обычно делается А на по другие группы во-первых они бывают скорее всего безопасные Ну добавили новую там entry Point новую ручку изменили текст ошибки ускорили обработку Да тут тоже могут быть проблемы я встречал ситуацию когда ускорил выполнение метода в 10 раз мы получали проблемы потому что начинали возникать гонки которые раньше не успевали подействовать на нашу систему потому что очень медленно работала там некоторая агностический отчёт А теперь он обрабатывал быстро и Мы начинали идти там в соседнюю систему за данными которые раньше успевали до неё дойти а теперь не успевают хотя мы всего лишь ускорили наш запрос при этом у нас из-за нарушения прагматики всё упало Но обычно такие изменения скорее всего безопасны бывают возможно опасные мы добавили новое Поле мы удалили какое-то неиспользуемое поле добавили параметр нам тут ВС зависит от тех соглашений которые поддерживает вызываемая сторона вторая сторона готова она пропустить поле готова она потерять данные готова она к лёгкому нарушению семантики когда мы сначала создали на там новой версии AP какой-нибудь сущность а потом при её получении соста они получили поле которое мы только что ввели Стандартный вариант нарушения там при какой-нибудь канарейки Когда у нас некоторые данные почему-то в Гете не получаются потому что они были заведены только на крете Ну есть точно опасные когда мы поменяли семантику Это точно опасные изменения когда мы добавили какой-нибудь сайт Эффект у нас был метод который раньше всего лишь отправлял нотификации пользователю А теперь он с него ещё и деньги списывает за то что мы эсэмэску отправили вроде бы снаружи ничего не поменялось синтаксис не поменялся семантика не поменялась даже прагматика не изменилась добавился просто сайт Эффект Опаньки стало всё гораздо грустнее потому что пользователь говорит А куда мои деньги деваются Почему во с меня те со счёт что-то списывают Ну или если удалили рипо потому что вы никогда не знаете что кто-то перестал использовать вашу ручку может быть её дёргали раз в год для формирования какого-то странного сложного ежегодного отчёта и больше никогда вы её удалили о том что возникла проблема узнаете через 8 месяцев причём Скорее всего в критический момент 31 декабря в 1200 ночи А как с этим всем бороться есть у вас синхронное взаимодействие То есть просто два каких-то синхронных вообще синхронных взаимодействий не бывает вы все знаете да что на самом деле TP - это асинхронный протокол Вот И вообще синхрон - это не про взаимодействие А про поведение клиента в процессе взаимодействия если при вызове Мы ждём ответа в том же самом потоке то это у нас синхронное взаимодействие но традиционно все путают понятие синхронность во взаимодействия в обработке и обычно всякие взаимодействия типа http grpc называют синхронными так и будем так вот если у вас синхронные взаимодействия то есть несколько простых Практик которые упрощают плой упрощают процесс работы с совместимостью делают изменения желательно достаточно безопасными ну во-первых Особенно для энтерпрайза лучше версионирование целиком а каждый отдельный метод Ну потому что у вас обычно в Enterprise IP десятки и сотни методов Если вы поменяли только один вставлять пользователя клиенты переключаться целиком на новую версию Ну довольно дорого и очень неудобно Лучше пусть у каждого метода будет явно его собственная версия все изменения которые вот хоть как-то вас напрягают стоит окружать фиче флагами там вызов нового метода на каком-то сервисе изменение семантики вообще при любых сомнениях просто сделайте ФИФА который новое поведение контролирует чего можно будет всегда откатиться его отключить и работать как будто ничего не поменялось и используем в рамках одного и того же рипо только скорее всего безопасное изменения Если вы хотите создать какое-то возможно опасное изменение лучше Создайте просто новый рипо с новой версии предложите всем на него потихонечку перейти так будет спокойнее Ну и надо делать какую-то монетизацию запросов чтобы у вас конкретный сервис точно знал какие версии методов Он поддерживает и чтобы получал только понятные для него запросы это умеют делать какие-то современные сервис I Ну и некоторые балансировщик у вас у AP он достаточно гораздо более сложный чем обычно кажется это не только там работающие методы неработающие методы это бывают методы со например драфт когда мы метод создали он даже работает но мы не уверены что он будет работать так что его семантика никуда не поменяется И вообще луше пока просто сказать нам хотите ли вы его использовать или нет Бывает точно unable когда вы точно знаете синтаксис этого метода поменяется Ну в течение ближайших не знаю месяца а не 5 лет как вы обычно гарантируете например ваш IP Ну и понятно бы Можно придумывать много других разных статусов в зависимости от того кто у вас потребитель IP ваша компания соседние компания какие у вас обязательства перед этим какие у вас проблемы с I например для внутреннего AP и для публичного совершенно разные жизненные циклы и разный набор статусов про это ВС надо уметь работать ну и чтобы с этим всем пользоваться Нам нужен е один инструмент истмен управлени флагами где у нас каждый сервис должен уметь получать флаги когда Они поменялись нужно как-то контролировать зависимость между ними что только если у нас поставлен ф можно использовать там новый индекс на таком-то запросе то можно тогда выставить фи флаг вызывать метод ту ручку которая использует этот индекс то есть между флагами почти всегда довольно сложная сеть зависимостей иногда имеет смысл использовать Корее флаги потому что коноре на уровне а сети не очень удобен Ну у вас там 10% э событий вы отправляете на Новый сервис тогда у вас получается что там какие-то события ходят то по старым сервисам то по новым это сложно контролировать иногда Проще сказать что вот этот фиче фаг мы включаем только для пользователей у которых проставлен э Family Friends and Family и например тест и только они увидят новый функциональность только они с ней могут работать в этом случае фича флаги для деплоя очень близки к а тестированию тут не требуется только метрик но зато здесь нужно всё то же самое с точки зрения их управления Ну и надо не забывать удалять нету неактуальные флаги Я знаю компанию в которой в какой-то момент сделали фича Фриз на несколько спринтов пока не вычистить несколько тысяч уже ненужных флагов Ну просто потому что они начали сильно мешать работе в любом месте было там десяток фов которые сильно мешали понять Вообще что происходит поэтому чист флаги лучше сразу не дожидаться когда придётся всё остановить асинхронные взаимодействия на само деле правильнее сказать их назвать их взаимодействием с состоянием когда мы отправили какое-то событие оно где-то хранится какое-то время в памяти на диске неважно И потом его оттуда забирают Ну все так или иначе кавка ребит включёнными либо кластером либо гарантией сохранности почти все прочие MQ системы они все про это про взаимодействи состоянием Оно обычно реализуется на клиенте как асинхронное Но кстати не обязательно многие используют кролик при этом как синхрон шину Беда в том что у нас здесь нету мгновенного изменения процесса передачи как например у нас было там не знаю для http у нас какие-то события живут в нашей системе хранятся и мы в общем должны с этим что-то делать вообще можно было бы использовать те же паттерны что для изменения структуры баз данных ну потому что будем честно синхронное взаимодействие типа кафку - это интеграция систем через общую базу данных Беда в том что обычно у нас нет инструмента работы с событиями которые хранятся в той же кафке или ребис мы не можем на них запустить какой-нибудь сложный апдейт поэтому приходится мучиться при этом обычно ещё следующая проблема Когда у нас там общение через брокер нам известны не все участники взаимодействий кто-то нечаянно взял и подписался на наше события и мы не знаем кто какой-то новый продюсер стал решил тоже формировать данные события и мы не всегда знаем кто может быть нам поможет документация может быть нам помогут логи но точного понимания точно гарантии нету Тем более что обычно а почему-то имен для документирование довольно слабое у вас нет документации которая точно показывает всех получателей ваших событий нельзя изменить версию события в пути потому что она живёт в какой-то неконтролируемой вами базе данных неконтролируемом хранилище Ну и вам обычно Если вы используете оди нужны какие-то дополнительные фишки там порядок партиционирование которые не хочется терять и вот свя обновлении системы с асинхронными взаимодействием хороших решений нет потому что все решения которые бывают либо частичные либо очень сложные тем не менее какие-то из этих паттернов попытаюсь описать ну самое простое создавать новый топик для каждой версии То есть у нас новая версия событий Мы создали для не новый топик мы при этом теряем гарантии порядка мы при этом скорее всего Теряем партиционирование мы усложняем администрирование довольно сложно и много всякого лишнего происходит когда переключаем на новую версию то есть ему надо Вычитать все старые события из старого токи начать потом читать с нового или как-то ещё При откате там тоже довольно сложная логика Но вообще эта схема работает Если вы используете не хотите ничего больше от вашего брокера ти просто где-то временно Похра события пока их никто не получит вам не нужно ни гарантия порядка ни позиционер ничего другое другой вариант который популярен для кавка продуктов когда мы сначала обновляем всех консьюмер новой версии тогда мы выкладываем нового продюсера который умеет отправлять события уже в новом формате он начинает их отправлять в новом формате консьюмер уже новенькие этого читать проблемы две первая формально если у вас такой вариант деплоя в вашей системе то не говорите что у вас микросервисная архитектура у вас сервисы перестали быть автономны по пю они жёстко по нему завязаны это по всем определениям которые я знаю это уже не про микросервисы А второе что у вас большие проблемы с откатом на самом деле кого-то из консьюмер Потому что если у вас консьюмер Хотите откатить назад вам нужно чтобы продюсер начал тоже отправлять старые старые версии его возможно тоже при этом придётся откатить что довольно сложно частичным решением этой проблемы является включение в продюсере отправку событий нового формата только через какой-то фиче фаг оно несколько упрощает жизнь но всё равно при этом откат консьюмер вызывает проблему потому что у вас в очереди могут уже сидеть события нового формата и старый консьюмер скорее всего не сможет их корректно прочитать есть сложная схема когда мы Чтобы решить все эти проблемы в первую очередь проблемы с автономностью в нашем лоде события отправляем сразу несколько версий одного и того же события в разных форматах а консьюмер сам понимает умеет какие из этих форматов он понимает и берёт тот который понял то есть мы там отправляем сразу там не знаю четвёртую пятую версию консьюмер старенький говорит Ага я знаю только четвёртый формат я его прочитаю но возьмёт пятую Ну через какое-то время когда мы уверен что всё хорошо мы продюсер говорим всё можно там четвёртую не отправлять все уже на пятую перешли Это довольно сложно в реализации Я слышал только о подобных реализациях я вживую их не видел а но при этом она действительно делают сервисы достаточно автономными за счёт сильного усложнения работы с поводом и увеличение объёма анимо информации Ну либо можно сделать сервис МШ на вашем брокере который будет получать любые события при необходимости их преобразовывать и отправлять на те сервисы которые готовы нужную версию прочитать Ну по сути дела Мы пытаемся сделать Прай серс баз во всей его классике перетащить часть бизнес логики на уровень транспорта Ну вот всё То от чего мы когда-то пытались уйти используя не SOS USB А микросервисы мы опять получаем во всей своей красе но я знаю точно что некоторые компании именно такую систему используют она при этом достаточно эффективна да у вас начинает плодиться Трансформеры начинается усложняться бизнес логика но при этом она тоже нормально работает Ну есть самый правильный способ упрощения своей жизни с передачей событий состояниями не использовать их на самом деле обычно нам нужно брокер в нашей системе только для того чтобы сгладить какие-то пики чтобы сделать очерёдность обработки Но тогда Уберите этот брокер внутрь вашего сервиса не оставляйте его между сервисами Пусть там будет какое-нибудь простое там мати типичное событие дальше его получим на консьюмер нужный версии нужной ручки положим в базу данных свою и там уже разберёмся в своём брокере Как именно его обрабатывать я вот буквально месяц назад рассказывал на KF на P Days про виды взаимодействия в распределённой среде там как раз про этот паттерн довольно много говорил это во многом удобнее чем использовать кафку или rit в качестве транспорта потому что будем честны они для этого никогда не предполагали Итого для того чтобы нормально запускать процесс надёжного деплоя без остано без потери данных нам нужны главный инструмент документация нам нужно как-то описывать политики совместимости в нашей системе что мы считаем совместимостью в что мы считаем совместимостью в семантике нам нужно как-то рассказать разработчикам какие у нас есть сценарий обновления Ну вообще любой код с поддержкой версионность он сложный если у вас при этом ещё какие-то свои инструменты вокруг они становятся ещё более сложные Поэтому лучше чтобы разработчики не слишком много думали не слишком много делали ошибок прит назвать сложные паттерны нужна документация где стандартные сценарии какие-нибудь сниппеты с примерами использования кода вообще всё то что нужно чтобы взять и начать использовать и делать нормальную вот такую распределён ную систему безопасность и нечаянно нарушить совместимость Ну и нужно описывать все взаимодействия в первую очередь конечно попса вные взаимодействия особенно надо правильно описывать э неформальные взаимодействия которых нет на каких-нибудь красивых архитектурных картинках Ну почти во всех больших системах есть красивые архитектурные картинки где показано Какие сервисы С какими взаимодействуют очень часто из-за требований быстренько сделать какую-нибудь фичу приходится проко выливать дырочки которые на этой картинке нету и поскольку они формально Никаким там архитектурным комитетом не согласованы их не то чтобы любят описывать и про них рассказывать поэтому они очень быстро теряются вот надо Находить себе смелость хоть где-нибудь их всё-таки описывать Да мы сделали гадость мы сделали в там покоряли дырку или там отправляем события и делаем тем кем положено но по крайне мере мы хотя бы это учитываем нам нужны тесты нам нужно тестировать сам процесс миграции то есть Нам нужно брать и смотреть что вот когда мы запустили наш этот огромный сценарий миграции который может занимать там часы и дни у нас при этом всё работает Это не очень просто потому что это такой n2n тест плюс ют тест При этом надо их запускать при этом во время выполнения плюс туда ещё какой-нибудь хау тестинг накладывается что мы в середине например что решили всё это уронить но такое делать надо нужно проверять всякие частичные работоспособности у нас новая система один сервис Мы в неё внутри откатились у нас старая системы Мы один вне сервис подняли на новую версию а всё ли у нас при этом будет нормально работать ну и надо откат обновления тоже тестировать мы делали делали выкладывали выкладывали серве средин решили откатить А всё ли у нас будет нормально не потеряем какую-нибудь важную информации А ну и нужны инструменты то есть собственно менеджер миграций управление фиче флагами и наверное у кого процесса выкладки Какие миграции мы запускаем Какие флаги После чего мы включаем А где мы хотим подождать полчасика и проверить потом пологам что всё нормально А где мы проверяем какие-нибудь а тесты в процессе там не стало ли что-нибудь хуже Я знаю что многие делают все эти системы поверх арга поверх дженкинса даже поверх антиб но честно говоря все эти инструменты не очень удобны Это довольно много приходится делать сво собственно машинерии Ну нам по многим причинам при вообще писать собственный инструментарий потому мы не готовы предлагать клиенту поставить себя дженкин поддерживать развивать при этом какую-то машинери поверх него Ну бо большая часть крупных компаний тоже делает свой собственный инструментарий простенький инструментарий иногда может выглядеть просто как несколько десяток строчек на шели это будет тоже инструмент который для небольших компаний вполне работает продуктов Ну и в самом конце у нас не бывает идеальных решений нельзя сказать что вот у нас стандартный па помою которого можем делать безопасную выкладку всегда будут проб всегда будут какие-то неудобства многие сервисы вообще проще погасить обновить и через час запустить А никто этого не заметит потому что это например там не знаю генератор месячных отчётов Ну и нормально Пусть он тебе полежит денёчек или другой вот некоторые так делать нельзя приходится мучиться Вот сегодня был хороший доклад У Жени кузовлёва про Гира сплен системы он очень много там рассказывал про то что стандартные подходы никогда не работают надо всегда исходить из бизнес логики вашей системы из бизнес логики вашего продукта Здесь тоже самое выкладка всегда сложный процесс и как любой сложный процесс её Можно иногда пытаться разделить на какие-то кусочки есть свона по частям Сегодня мы делаем выкладку качественную только для одного нашего сервиса дальше завтра для ещё двух послезавтра решаем что лучше вообще дальше не идти потому что и так достаточно вот ну и Все ошибаются Как бы вы не планировали вашу безопасную выкладку рано или поздно кто-нибудь что-нибудь сделать несовместимым и всегда надо Быть готовым к тому как вы будете восстанавливать данные как вы будете на это какие у ва для этого есть инструментарии но это совершенно отдельная тема Вопросы Спасибо огромное Я даже в тайминг уложился Да вообще спасибо ну прям Правда спасибо Итак во-первых переходите пожалуйста по QR коду пишите своё мнение о докладе плюсы минусы фидбек всё передадим А пока уже с огромным интересом прочитает пока вы это делаете филь будет рад ответить на вопросы Из зала Пожалуйста поднимайте руку Если вы хотите задать вопрос здесь и сейчас Если вы смотрите нас онлайн Пожалуйста пишите ваши вопросы в чат а я буду их зачитывать так Ну что ели у нас какие-нибудь руки сейчас 2 секундочку я посмотрю что у нас в чате на самом деле это вечная такая магия ведущего так прошу вижу а угу передайте микрофон пожалуйста Спасибо большое за доклад очень нравится ваши доклады и на фесте был и сейчас и вопрос собственно по поводу шестьдесят пятого или шестьдесят шестого слайда Когда речь шла про версионирование лода при брокере сообщений и а не дальше ещё А да вот здесь и здесь как раз речь шла о том что мы отправляем лоуд старой версии и новой и не в одном лоде мы сообща мы отправляем одно и то же событие в двух форматах А ну да одно и то же событие в двух форматах и вот собственно Здесь вопрос А какая сложность Ну собственно вот мы просто расширяем P Да и передаём несколько форматов либо если мы поле там расширяем да то мы просто новую версию полия передаём и хотелось понять В чём сложность этого подхода В чём сложность подходов в том что многие стандартные инструменты работы с как раз подобными со синхронными событиями тут не работают вы не можете взять стандартный не знаю там кавка streams с авра схемами прикрутить к этой схеме сказать что всё будет нормально потому что у вас разные схемы одного и того же события внутри одного лода вам нужно делать какую-то свою собственную библиотечку обвязку на более низком уровне который умеет по сути дела из почти что бинарного формата потому что вы не можете сказать что это д Джейсона который мы реализуем и как-то берём нет вам нужно вырезать тот Джейсон который вы готовы понять в нужной версии и дальше его стерилизовать А ну в этом собственно мой вопрос то есть мы используем в любом случае события чтобы передать какие-то данные Ну чаще всего и соответственно если у нас появляются новые данные Ну то что бы мы мы хотели чтобы было в новой версии Мы же можем просто взять старую версию и добавить туда несколько полей которые будут вот те самые данные в новом формате передавать и соответственно если у вас э Вот это надо возвращаться более на гораздо раньше когда мы говорили про совместимость и про возможные безопасные изменения вы говорите О том что если у нас возможно безопасные изменения и как бы все про них знают то проблем не будет на самом деле есть очень много сценариев Когда вы можете добавить новое Поле но вы не имеете права его потом не вернуть А это на самом деле уже некоторая семантика и даже немножко прагматика про то как используется ваши IP и ваши вроде бы безопасно из просто добавили колонку уже не на много других тонкостей но я в первую очере говорю не про возможно безопасные изменения А когда у вас изменения возможно опасны или точно опасные когда А таких изменений всегда много вы семантику поменяли Если вы поменяли семантику поля вы не можете просто обойтись одной версии события А если у вас да а если у вас какой-то активный живой домен если вообще ваш продукт живой то в НМ меняется домен если у вас домен меняется у вас регулярно приходится использовать безопасные обновления Да если у вас продукт умер то там скорее всего ВС дейст очень просто ну иногда добавит новое неважное поле Ну нормально но в моей практике такого по никогда не встречается Итак Следующий вопрос У меня ещё один есть Давайте в курах у нас дискуссионная зона очень хотелось бы ещё несколько рук вижу хотелось бы чтобы Все успели задать Итак Спасибо за доклад Не могли бы вы подробнее прокомментировать вариант с использова приходилось ли использовать такой способ Какие неочевидные подводные камни как понимаю для асинхронной сообщения имеется в виду а говорю Вот я как раз его не использовал потому что А это достаточно сложно и бизнес логика начинает просачиваться в транспортный уровень хотя на каких-нибудь кавка транзакциях это делать очень удобно То есть у вас будет транзакционный сервис который берёт событии его преобразует отправляет дальше всё это в одной транзакции замечательно но многие привычные сценарии Когда у вас там вы не знаете какие версии развёрнуты и кто на Что подписан у вас пропадают там автоматическое распределение партиции по начинает страдать Вы должны понимать какие версии приход На какие партиции На какие коню там много подводных камней которые сильно зависит от конкретно сценариев использования брокеров которые приняты у вас в вашем продукте поэтому можно поговорить отдельно там в чатике или ещё где-нибудь но проблем там довольно много Собственно как всегда как только взаимодействует через брокер вас много странных нетривиальных пробле буд говорили про миграции со старой версии на новую не использовались метод когда данные мигрируют не в момент записи допустим А в момент чтения то есть Get метод смотрит есть новая версия если нету мигрирует ну понятно что методы меняют базу это не очевидное поведение Но с другой стороны первый раз поменяли а потом ну вот там страшно с нарушением семантики и то что иногда бывают ГТ методы например массовые и вот в них уже массово менять данные довольно больно мы так делали скорее что есть очередь изменений и методы всегда оче добавляю события в савер потому что надо побыстрее для этой записи поменять пото что она явно актуальна такие вещи делали то есть не то что прямо меняет но метод ставит быстренько задачу научиться поменять тако такое делали конечно да Спасибо отлично так есть у нас ещё руки в зале или зачитать текст из читай минутку Как измеряется опасность Какая опасность считается достаточно безопасной ну опять-таки зависит от того какой у вас продукт иногда неправильно понять приходящие события чревато отзывом лицензии концом всего вашего бизнеса а иногда просто пользователь не увидит фотографию котика это сильно зависит от конкретного вашего продукта от конкретных ваших требований поэтому они бывают разные поэтому универсальных решений нет Если что у статья про каждому а каждому проекту своя методология где он довольно аккуратно разбирает Какие бывают проекты с точки зрения безопасности Следующий вопрос как версионирование какой версии кургае да для энтерпрайза обычно не очень удобен Поэтому в просто не использовать Вот не надо использовать там где он для целей где он не предназначен Угу отлично прошу Следующий вопрос Спасибо за доклад оче Интересно изп что можно сказать чаше мы используем мы используем да да Прошу прощения Да Микрофон был выключен интерфейсные соглашения Джейсон проба для Джейсона есть Джейсон схема для профа там есть схема рест и так далее вот по опыту Что лучше применять вот в части совместимости вот безопасного подхода Ну для профа Нако Я помню есть довольно подробные вобще говоря читается совместимым изменением а для Джейсона это определяется очень сильно библиотекой то есть в каком-нибудь Джексоне Я просто могу всегда написать произвольный обработчик незнакомых полей и в него запихнуть вообще всё что хочется или даже транслятор типа к мне прилетело такое-то там странное поле в джейсоне А я при этом при лизации его положу в совершенно другую структуру и иногда я такие Трансформеры на Джексоне использую чтобы не потому что они обеспечивается совместимость IP при этом у меня одна и та же ручка остаётся Хотя совершенно разные вещи умеют воспринимать а с grpc гораздо почти не работал поэтому там не смогу сказать насколько Такое возможно но по-моему там всё гораздо жёстче и там собственно кроме добавление в самый конец новой колонки вообще ничего сдела нового поля ничего сделать не можете Ну с этим надо жить то есть только такие изменения считаются а возможно безопасными Ну и по семантике буквально короткий вопрос Вот ты сказал что можно поменять семантику поля Мне кажется это вообще плохая практика Например если у тебя была сумма с НДС а вдруг она стала суммой без НДС плохая практика которые при этом регулярно происходит ваш телефон пользователя который всегда был телефоном пользователя стал просто телефоном отправки нотификации а телефон пользователя тического коммуникации стал совершенно другим полем и вот такое при развитии доменной системы доменной области происходит постоянно у вас семантика уточняется иногда сужается иногда расширяется лучше делать новую ручку спасибо Вот там кстати по поводу семантики прагматики и так далее там недаром было две картинки на картинке две книжки иногда очень прикольно прита изх отрасле оче люблю прива программирование поняти семиотики Всем советую читайте хорошие книжки они помогают развиваться так е вопрос когда говорили про управление схемы тоже говорили в основном про Реон базу данных там всё понятно был опыт управления схемой про про который сегодня было два доклада там сно при этом у меня было довольно много использования KV баз данных где мы просто храним какой-то Джейсон и хорошо если Джейсон Там они Какой ещё более сложное там работает всё тоже самое только там сложнее с транзакциями там приходится делать только де потент изменения как-то хранить последний счётчик изменившихся но основная логика примерно та же но просто иногда понимать что вот вы даже пачку обновив можете все середине до конца её не обновить Ну примерно то же самое по логике то есть разницы особой нету а вот с K value более того когда вы работаете там не знаю с Jon полем без схемы у вас ровно то же самое получается ну как бы ну какая-то схема есть для этого полезно в любой записи хранить схему Ну код той схемы с помощью которых она создана То есть например вы при изменении версии просто пишете в ещё одно поле Какая схема использовать четвёртый пятые там двадцатое и так далее тогда вы сразу видите при чтении А какой она версии и как с ней работать Следующий вопрос из чата а так я буду засчитывать и параллельно показывать консьюмер Обновили продюсеры Обновили убедились Что работает вдруг а продюсера пришлось откатить данные опять в старом формате как разруливает старую версию и при необходимости переключать назад на неё Ну разумеется консьюмер должны уметь читать и старой и новые версии потому что в любой момент у вас всё равно когда вы подняли Даже новый продюсер у вас всё ещё в очереди сохранятся события в старом формате и у вас должен поддерживать совместимость на один формат назад всегда и продюсеры коню в общем все должны уметь работать как будто они живут в старом окружении в старой версии супер спасибо Ну что предлагаю выбрать какой вопрос больше всего понравился Я понимаю что все были хорошие это очень сложно так а Поднимите руки кто вопросы задавал чтобы я проти так ещё не разу не делал Дели Я это сегодня стырил У Я вообще сегодня много стырил уже очень сложно ребят Вот кто ни разу не выступал когда ты стоишь на сцене и пытаться вспомнить блин какой-то вопрос был классный кто Вот первый вопрос вот оттуда там он был да то есть мы ещё долго будем его обсуждать Сегодня я знаю поэтому можно Точно Спасибо огромное за ваш сложный вопрос мы обязательно продолжим его обсуждать В смысле вы я в этом участвовать не хочу спасибо Вот а в подарок от оди матрёшка совершенно потрясающая новая классная практически Челлендж бери все матрёшки А почему спикера матрёшку не даёт вопросы надо задавать дорогие спикеры Работайте задавайте но спикер мы просто даём а замечательный подарок от онтика там много всего вкусного Филип Спасибо тебе огромное это было потрясающе пока"
}