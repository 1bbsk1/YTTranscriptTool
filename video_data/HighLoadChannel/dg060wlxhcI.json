{
  "video_id": "dg060wlxhcI",
  "channel": "HighLoadChannel",
  "title": "Amazing threesome, rrr... React. Redux. Real world / Ростислав Галкин (Babo)",
  "views": 1553,
  "duration": 1833,
  "published": "2017-04-22T14:47:54-07:00",
  "text": "всем привет меня зовут ростислав и давайте зажигать эту классную тему react я работу в компании баба мы занимаемся разработкой платформы гражданской журналистики которая позволяет вам получать контент от пользователей пользователям получается за этот контент деньги и собственно без обид но косички начну с того чем мы занимаемся и как как как выглядит наша система что себя представляет наш проект первую очередь это мобильное приложение мобильные приложения только сними визируется под каждый телеканал таки только на так life news рад что да и по москве 360 собственно сама и известно этих приложений и to live score это мы и фронт-энд у нас представлен и главный главный сервис который мы разрабатываем fontaine диета редактор который позволяет телеканалам работать с материалами собственно какие в нем есть функции в первую очередь это постановка задачи то есть яд люди я телеканалов которые создает задание кто отправляются на мобильные телефоны пользователи получают push-уведомления и едут на место событий снимают материала помимо этого естественно есть люди которые занимаются обработка материала то есть они должны принимать и отклонять материалы и в общем то так же там есть архив всех котировок которые когда-либо приходили телеканалам наконец после того как телеканал покупает материал он может его потом взять и продать другому телеканал что тоже является частью баба вот ну и наконец виджет который встраивается на сайт телеканала и позволяет присылать материалы прямо на сайте или канала вот это то что я сейчас но год назад ничего этого не было год назад ничего не было как не было в этом проверьте меня и предо мной стояла задача собрать команду и реализовать весь функционал собственно случилось выброс т.к. выбор был довольно простой исходя из предыдущего опыта в пак react и бы лотка новая фишка новые ногти новая технология тори dax собственно новой с с мы взяли тоже решили попробовать сейчас модуля и собственно реакции редакции пойдет речь в моем выступлении меньшей степени react потому что при нем обычной такси говорят и в общем то здесь как бы ничего нового не скажешь просто пару кейсов которые которыми мы столкнулись разработана вашу систему в этом начнем с реактор собственно как только мы начали разрабатывать интерфейс с первой задаче с которым мы столкнулись отображать большое количество элементов и собственно было очевидно что до в реакции virtual дом да он берет на себя задачу вычисления изменения реального дома да все это круто но когда вы там будете придавать него тысячи и десятки тысяч элементов как нашем случае у вас возникнут проблемы с тем что все это дело будет тормозить и когда вы решаете такую задачу естественно нужно сократить число элемента в доме и собственно сразу мы написали свою сетку которая просто рассчитывает текущие размер экрана истра и показывает virtual доме только те элементы которые мне можно отобразить собственно таким образом мы решили эту проблему самого начала следующий момент это пресловутый универсальный рендеринг котором все так любят говорить и передаю стала задача виджет мы хотели чтобы он выглядел максимально нативно нативно чтобы как только открываете сайт телеканала он с минимальными задержками отображался на этом сайте собственно сразу через айфрейм и мы хотели чтобы он максимально быстро то есть чтобы не было тихо лагов пока подгрузить скрипты и пока инициализируется и здесь мы решили попробовать универсальный рендеринг и первое с чем естественно сталкивается разработчики которые внедряют универсальная рендеринг это то что это то что эта штука синхронная то есть это блокирующая операция и еда есть это метод оптимизации мы их использовали но в конечном счете вы все равно придется то что вашу штуку под нагрузками будет падать учитывая что в эта штука устраивалась на сайте или каналов на сайте телефонов которые в общем то так нагружена бывает пике когда что не происходит и не катастрофы там и народной плавает естественно эта штука начинала падать как мы не оптимизировали поэтому единственно лекарстве на сегодняшний день к которой есть это кэш поэтому если вы хотите сделать универсальные рендер их сразу закладывайте на кэш либо если то есть если это позволяют задача там сделать кашель и на уровне джинсы либо делать конечно уровне программы то есть если приходит и данные сразу к жиру эти результаты выполнения товар эндера вот но в принципе у этой штуки есть светлое будущее то рядом стрим для те которых появилась там буквально в этом году и мои тоже попробовали с о том что вы загоняете этот рендер в ряду был стрим естественно в этом случае у вас чуть-чуть ситуация меняется вот с не главную проблему то что значит вообще не поддерживается из последняя версия react она несовместима и совместим она потому что автор этой библиотеке пишет реализацию для реакции в общем то есть надежда что в будущем в реакции в официального реакция релизах будут стримы для того чтобы аренда retreat на сервере вот теперь перейдем к редакцию всегда у нас была такая история что мы начали писать приложение в июне то есть 11 месяцев назад так появился 12 месяцев назад собственно главная проблема в том что на понравилось но не очень было понятно как на ней писать собственно те шишек которые мы набили за этот год и чему в итоге пришли к кому стыку при написании ридак со пойдет речь в основной части выступления сегодняшний день когда горит при ридак сразу называют крутые примочки экосистему то есть для стусла gear time трейлинг и когда мы начинали писать ничего этого не было то есть мы видели рядом с еще голом и нас привлекало в нем простота то что нет никаких иван димитров 1 star во многом это все было там унаследованное навеянный эльма суть том что просто создаете dance top вы можете подписаться на обновление товара вы можете передать изменения вы можете получить текущее состояние стоит в этом история все классно и вдобавок ко всему мы хотели писать с драйвом поэтому нас очень порадовало что операции изменения стоит и можно было чем просто тестировать по сути по сути все изменения встреча ним происходит в одной функции в смысле их может несколько конечно но суть та же the reviews are который передается предыдущее состояние стоит придется экшен и на выходе должен получится новый стоит и это очень просто тестировать дальше приходите того что же на это дело интегрировать react а мы в общем то есть тоже все более непонятно уберетесь из top передаете в контекст дальше внутри всего скобы приложению через контекст можете доставать нужны данные стоит подписывать компоненты на изменение отстаете и здесь главную проблему на самом деле того как это интегрируется с раком потому что у вас нет никакой изоляция вы передачу из контекст соответственно у вас нет никакой мотивации выстраивать правильную форму стэйта для того чтобы потом впоследствии можно было сделать и визировать и вы в любой части проекта вы можете доставать stor из контекста но перейдем к тому моменту когда вы начинаете писать мы начали писать где в общем-то 1 1 нюанс который важен при работе при работе с редактором то что у вас все данные должны изменяться нему табель на и предлагается что в review саре вы передаете какой то стоит и на выход должен получиться другой объект то есть должны быть не мутабельные изменения и самый простой способ но это делать обжиг to say only бы спред в общем то есть открытия официальную плантацию и достаток прилагается делать плавно проблема с этим подходом в том что в большом проекте у вас нередко появляется глубина это ложность 3 соответственно взять такие матрешки и это очень раздражает это отражает а ты пишешь к ты смотришь чужой код и поэтому сразу этого и от этой идеи отказались и взяли и методы джесс но те кто работать реактор приказано перед библиотеку имеют абу джесс хорош он решает в него у него хорошая пью небольшой api и на самом деле в этом главная проблема с одной стороны конечно все равно дубна удобно работать сложными объектами но на самом деле из всего этого количества ментов которые есть ими тут же суд реально на практике за год мы использовали ну максимум 4 то есть set in a way to enlarge we смотришь на для бачей и в общем то на этом все а ракету вытащите 55 килобайт модифицированного кода то есть на секундочку там плане джек вопрос для того чтобы использовать из этого несколько методов добавку всему эта штука построена на флешмоб деревьях и это необычный объект который вы передаете с ним нельзя наработка с обычным объектом то есть чтобы доставать потом данные стоит вам нужно использовать ветра и метод get и соответственно когда вы там доставить в коннекте из state который написан который завёрнут в и мы тут же с вам нужно везде дергать get это тоже раздражает поэтому где-то середине года мы перешли на землю семью это был отличной альтернативой методы джесс под капотом обжиг фриз то есть никаких хэш map of так далее объект от объекта замораживается и после этого в него добавляются просто методы хопперы который вам помогают работа состоит в том что сложным стоит им set in апдейт engine то есть все что надо там есть и весит делать 5 класс блайт и на выходе вы работаете с обычным объектом с обычными массивными другая проблема которая есть при работе с реактором то что вас часто бывает такое что то какие то данные нужно их как-то изменить для того чтобы выражать rift и компонентах вот почему-то у всех у нас приходили новые люди и у всех большое желание это дело сделать на этапе полнения action то есть условно вас но там взять пример который нас был один из приходят кучу и там точек пользователи которых данный момент активно нужно пастеризовать все эти точки в кластеры соответственно очень хочется взять и пастеризовать и запихнуть стоит и потом просто стоит убрать вот но в большом приложение вы сталкиваетесь с проблемой в том что одни и те же данные могут использоваться разными компонентами и соответственно каждый раз да вы утверждаете данные других компонентах вы выполняете гипноза перерасчета и естественно в таком случае хранить все данные встретит ну не рационально и нужно это делать при то есть эти расчеты нужно выполнять при считывании state of собственно таким образом вы дополняете добавляйте свою структуру свой проект и селектора но нюанс такой что connect выполняется каждый раз когда что-то меняется встретить то есть меняются даже эти данные который не относится конкретным расчетам соответственно у вас теперь расчета буду приходить когда что обвиняется что то что вы даже к вашим расчету не имеет никакого отношения поэтому сразу сразу нужно закладывать иммунизацию но и в собственность отличный библиотека для этого делали select вы доставите нужные данные стоит и передаете в функцию расчеты на выходе получаете функцию же которые сми мая зации по сути и тесно на выполняться только в тех случаях когда меня столько те входные данные которые нужны для расчетов другой момент это экшен а вот здесь наставников и 0 и потому что экшены в редакции это просто объекта объекты которых за за год существования редакции появился такой стандарт предполагает что вас там тип экшена хранится в поле type какие-то данные в природе мета-данные там в поле мета ошибки в поле ошибки самое главное что это обычный объект обычно в который можно там загнать же сон и при нами стояла задача сделать синхронизацию экранов поскольку операторы телеканалов работы одними и теми же данными у нас спа и нужно чтобы они в каждый момент времени были актуальные данные перед глазами чтобы они не делали лишь не перезагрузок страниц и и мы решили очень дешево очень дешево потому что мы просто взяли и стали прислать текст и потоки там то есть мы писали обычный кот обычный кот не задумывайся вообще о синхронизации просто некоторые action- и помечали мета мета тегом sing в этом случае тех шины брали брались и отправлялись по соки там и край походили на другой клиент они доставались и джисона и предавались top соответственно таким образом подхватывали все нужные изменения но когда говорят про экшены про работу с экшенами в редакции то здесь первую очередь всплывают вопрос что делать с асинхронность you то есть как быть если вам нужно сделать запрос соответственно вам нужно сделать это экшен дополнение запросы после и так далее собственно начального было предложат sang sang middle в классная штука пока вы не поработайте с ней много вот как бы она предполагает что вы возвращаясь не просто объект когда ставите action эти функцию в которую можно в которую вы получаете dispatch собственно можете низко раз вызвать из польши таким образом создаете несколько экшенов проблемы начинаются в большом проекте опять же когда вам приходит такой человек добрый и говорит что давайте крутить мы добавим такой функционал и соответственно вам нужно при вызове two экшна добавить дополнительную лайку и возникает вопрос что с этим делать и вы естественно пихать этот танк потому что операцию пока нет и первое что вызывает боль только это дело тестировать потому что бы ты делал протестировать вам нужно создать стал бы вам нужно создать моки не только после этого сможете нормально это делал протестировать но соответственно эту штуку будет расти и писать эти без тестов это тоже застрелиться вот это ждет на середине года появилась хорошая альтернатива такое приятное слово из 87 года саги sagitta серия серия плюс sagitta такой термин обозначает серию долгих транзакций вот и собственно сам что долго шло в сторону того что нужно использовать генераторы при работе с такими с вами сайт эффектами и было вес на кучу в реализации в течение года кучи велосипедов в конечном счете победила ридак сага которые тоже мы начали выделять свой проект она позволяет вынести вынести вот все работы с action и на периферии вы сидите за экшн у вас происходит снова потоки и при появлении зеленого экшна вы добавляющих будь то like it i like an там изолируются и выносится подальше от все оставляют все остальные лайки в этом может нормально протестировать поскольку в ней сразу сделал на кучу хопперы в которые помогают это сделать и тестирует это вообще без боли то есть нам не нужны не стал бы не мог ничего но здесь я подхожу главной проблеме глав главной проблеме рядах са которая была в нем заложен самого начала и которая очень долго времени решалась что делать при росте приложение с изоляцией то есть залог успешного успешно масштабирование это консультации вам нужно развивать все на модуля и здесь изначальных хорошего ответа не было потому что но кажется вас работа состоит вам находится в регистре за отображение отвечает компонента то есть кажется что можно взять перетащить компоненты потом взять притащить user и все будет работать хорошо не будет потому что вас всех шины выполняются последовательно них нет ни к изоляции и какова скупо и соответственно возникает проблема как это дело решительность так что можно переносить reviews are и и связывать их с компонентами собственно самом начале когда люди начнут этим сталкивается не спрашивали но авторы библиотеки dino bravo как-то можно решить его начал он отвечал что он используется локальный стоит окей взять взяли редакции давайте будем использовать локальный стоит окей но это подходит нам для можете небольших каких-то компонент но в нашем случае нужно было наши любимые дизайнеры предложили сделать такую панельку боковую в которой происходил внутренняя двигаться то есть это большие блоки довольно которые находятся на три страницы это не маленькие маленькие то компоненты соответственно нужно нужно было что с этим делать потому что используется для написания таких компонент но это тоже совсем как-то но ни к селу мы пошли по простому пути ну раз делать состоит значит давайте сделаем ридак state то есть сделаем аналогичную логика проста будет просто она будет работать с чего к системе ридак со и мы самого начала решили проблему просто написал библиотечка такую ридак state су и том что вы изолируете регистр в изолируйте компоненту и дальше в этот радиус разбавляется определенное место в стойке в общем стоите и таким образом вы решаете проблему с тем как перетаскать а ну компоненту из одного места в другой параллельно с этим параллельно с этим появилась там еще кучу других решений которые предполагали принципе аналогичный подход но сохраняли возможность перетаскивать радиус r отдельно компоненты отдельно они просто подписывали reviews are ее компоненты хищниками таким образом происходило связь между кусками стоит и компонентами но тоже этой утра привели саги когда появились саги возник вопрос как этом случае чего сагами делаю загиб хороший тоже нужно изолировать вот и здесь конечном счете сообществе и мы пришли к тому что надо в свой проект как ты переделывать в общем-то во время во время народ понял простую мысль что в общем-то раз среда кс был на вены львам то давайте будь то есть мы взяли из-за редакция смысле цели мы там только часть давайте возьмем все остальное ну чё мелочиться и эльм изначально предполагает что у вас но отличия и в общем-то различили мы ее рядах са в том что там фактически в терминологии элевэйтэ язык и так что библиотека вдобавок ко всему вот но в фильме есть модель в редакции есть тэйт в фильме есть апдейт в редокс есть радиус r весь команду в редакции пыль из саги чине года новыми view в редакции понятно компоненты react а вот и при этом структура фильма полагает что вы все эти куски компоненты команду апдейт и вы можете использовать модуль на и берете берете просто все это дело изолируйте в в одном месте потом просто можете такие кирпичики перетаскивать один за другим соответственно в этот момент появился редуксин и токсин который снял окончательно вопрос то есть он предполагает что у вас уже не просто review сразу своим апдейт раб deuter в котором изолирует состоит работа состоит ему там вы можете подключать дополнительные компоненты там вы можете изолировать саги и аналогично историю происходит с компоненты там вы привязываете компоненте кусок стоит когда называется модель иди спать иди спать у вас перемещается вниз по дереву каждый раз находясь в нужном контексте нужном сколько нужно компонента и в общем-то таким образом мы решили свою последнюю проблему и вот после после того как появилась ридак сейм у нас окончательно общение стало сомнение что писать на редакции круто и по итогам этого года к чему пришли из земли семью ты был на для работы со стритом ресивер для того чтобы доставать данные рядах шаги для работы с и синхронностью & daxter в качестве основы архитектуры вот но подводя итог на самом деле с алексом в течение этого года было все абсолютно не гладко как вы понимаете но тем ни менее сообществе находила решение находила решение и в конечном счете мы остались довольны тем что взяли ридак потому что самое главное почему хотели то чтобы писать тесты если тесто нормально и писать код быстро остальные проблемы в процессе решили его на сегодняшний день мы успешно используем у себя при dax на этом все спасибо за внимание раз-два-три спасибо ещё раз за доклад у нас есть естественно время на вопросы так что у кого-нибудь есть вопросы после доклада у меня просто напросто последние ваши мысли редакции для того чтобы писать теста вы пишете так столько наряди серы или на компоненты тоже уметь писать точно понятно компоненты там правила довольно просты и теста потому что через ридак сам используйте паттерн умных глупых компонент и вы tester team основном глупые компоненты а это просто значит вы придаете в компоненты пропсы дальше ожидаете что ваш компонента адресуются определенным образом а умные ныне там и нет нет умные умные в том смысле что умными компонентами являются называется компонент которые привязываются к стоит это есть это берется в коннектор поэтому там логики никакой там просто достается данная дальше всю эту пропустим передается не стали писать писательство для компонент тоже выдалась очень круто это одна из причин потому что вам понравилось средах спасибо что спросили да кстати я забыл об этом что вы тестируете очень просто вы передайте пропсы дальше ожидаете что вас команда примет какой-то определенный вид и таким образом это очень просто тестируется локального то стоит а вот еще и page вот туда микрофон говорите в микрофон вот так вот прямо не слышно да спасибо за доклад у мне несколько коротких вопросов вас мобильное приложение вы используете react не тиф нет думаем про это но пока нет пока там все нативно да да так останки то вместо promise of нет танк это вообще отдельная история то есть это структуры dance предполагать что у вас есть такие middleware это по сути функции которые выполняются при там появление экшена с не обрабатывать экшена известно самка эта штука которая получает экшн если эта функция то дальше на просто передает туда dispatch значит внутри уже здесь вы можете использовать promise и для того чтобы выполнять асинхронные запросы поэтому это его вещь вообще никак не связано оно связано больше с реактор получается среда среда ксо ладно в общем понятно по вашим ощущениям порог вхождения дело в том что сложность все архитектуры она на таком уровне не для всех что называется вот насколько быстро вы можете взять нового разработчика ввести его в курс дела и начать разработку с ним за последний год мы набирали только medley junior of разработчиков вот и собственно во время собеседования там очень многие конечно говорили что я не предам сложен вот но тем не менее люди у нас изначально какого набирались которые были без собственной редакции и порядка порядка наверное неделя может быть максимум 2 уходило на то чтобы они начали писать нормальный ход на релаксе спасибо спасибо за доклад то у меня только вопроса ридак целом он подойдет для всех типов проектов от простого до сложного или только от от среднего до сложного конечно придет и для большого смысле для маленького проекта на самом деле по моему по моим ощущениям для маленького проекта по недостаточно редакция когда у вас нет необходимости использовать компоненты можно брать спокойно редакцию для большого редакции и соответственно дак сами тоже можно брать спокойно в маленький проект ничего плохого с ней случится page передай вот там микрофон пожалуйста привет ты говорил что вы не используете локальный стоит в компонентах и вот вопрос вас с этим были связаны какие-то проблемы по скоростью работы приложения нет абсолютно ну то есть там уже получается что любое изменение даже опыт мало-мальское приложение оно затрагивает весь поток опытов доит и в этом на самом деле суть придется то что у вас есть 1 стоит кто отвечает за все приложения и если вы сохраните ложность тег state of и если вы каждый если вы сидите с мутациями то на самом верхнем уровне можете отловить изменение во всех внутренних объектах соответственно в этом случае вы прям обязательно самый верх я сам верху последний настоящей операции и перешла именно как бы компоненты где вот как раз да да да что посему вопрос по поводу тестирования сага как понимаю вас вся логика лежит в сагах до вопрос как вы тестируя саги в частности как вы блокируете те функции библиотеки которые отвечают допустим за общение серверами и так далее вот как раз фишка фишка сак то что там есть такие методы обертки для вот этих вызовов собственно если вернуться уже не вернёмся но в том что во время тестов вы по сути просто сравнивайте результаты выполнения этих функций в коде и в тестах если вы там и там берете библиотеки вам не нужно их макать они не будут исполняться просто выращиваете их в колпак называем функция дальше сравниваете что вот здесь-то был вызван кол с таким-то аргументом то в каждый аргумент утка раз ваши функции и сторонние библиотеки по поводу ну вот что в компоненте нужно хранить состоянии отображения вы храните это встреть и или история вот допустим dropdown да у него есть состоянии открыть закрыт и какие-то более сложные элементы данного красота я говорил в таразе ринге было где платим изоляции что в общем-то для маленьких компонентов полагалось что можно взять из быть локальным этого не хотели сделать мы эти данные хранили в стоите с помощью нашего решения потом когда мы перешли на редакции собственно там это решалось аналогична той всех они со встречи и его вокального стоять в кармане опрос по поводу асинхронную асинхронной загрузки данных вот скажем так какие на каком уровне вызывается собственно снос события что нужного загрузить данные то есть это глупые компоненты либо если протока реализовано садись и ларри пратт перед нами разбирался про танк там это вызывается момент когда вы вызвать экшн вызвать экшен и там вызывается запросы сливать про саги то там вас про вызываете action дальше тешин отрабатывать происходит изменения в сторе после этого включается саги это понятно я имела ввиду вот ну допустим отображается компонент и он должен отобразить отвозить этой даны которые должны погрузиться как компонент вел mount спасибо"
}