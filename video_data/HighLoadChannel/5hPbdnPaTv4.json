{
  "video_id": "5hPbdnPaTv4",
  "channel": "HighLoadChannel",
  "title": "Оптимизация UI потока / Дмитрий Куркин (Mail.Ru)",
  "views": 335,
  "duration": 1609,
  "published": "2017-05-16T13:00:03-07:00",
  "text": "здравствуйте меня зовут дмитрий куркин я расскажу вам о том как можно подходить к оптимизации ей потока ну думаю для любого 1 . приложений вполне известна проблема когда интерфейс подтормаживает либо вообще даже подвисает мне встречались люди которые считали что на ios как-то все так очень круто сделано что приложение в принципе не могут тормозить вот но на самом деле совершенно не так и и из разработчики в таких же условиях как и все остальные поэтому соответственно вполне актуальная ситуация когда значит мы делали-делали приложение вроде все у нас хорошо отдаем на тестирование показываем начальству и у них все плохо все тормозит какие-то разные проблемы соответственно в этот момент уже хочется понимать что же там произошло еще лучше такого не допускать но еще хорошо когда мы вот момент понимаем как бы где это все происходит однако в принципе проблема может возникать из-за кого-то внешнего воздействия то например посетить что-то пришло и тогда мы видим торможение только в тот момент когда сами начали что-то делать там скролить или пытаться писать клавиатуры соответственно эти проблемы начинаются привязываться к разным совершенно невинным местам вот и понять что здесь происходит опять же очень сложно ну и наконец мы все отладили всех все проверили раздавали друзьям у всех все хорошо раздали в створ и треть пользователей нам жалуются что у них значит все плохо что же начать с ними делать нужно как-то систематически решать проблему тормозов тормозов ей а это в первую очередь значит какие-то большие задержки на главном потоке из-за чего соответственно мы не можем получить наш любимый 60 fps для того чтобы этого избежать нужно как-то ловить вот эти большие процедуры которые занимают наш главный поток слишком надолго нам в этом помогает watchdog в общем виде watch dog это некий процесс или потока которые следит за каким-то другим вам важным процессом или потоком текущий момент не встречались в общем то такие два основных подхода к работки вы же дога значит первый случай это мы запускаем какой-то поток и он заставляет главный поток выполнить какую-то небольшую операцию причем соответственно главный поток должен успеть выполнить там за какое то указанные нами время если он не успевает мы значит на нашем потоке обозначаем что есть какая-то проблема другой вариант это отслеживать итерацию замереть итерацию ран лупа средства мы можем перехватывать события глупо старт-стоп когда начинается итераций когда заканчивается смотри сколько она заняла в итоге и значит это время там отображать либо значит другим потоком фиксировать превышение там как вот временного лимита это же обозначать проблему но если мы как бы научились ловить эти длинные процедуры значит как дальше собирать эти результаты и начать что с ними делать ну первый сам обративший вариант в общем то он вот и в открытых вариантах используется это логировать в этом случае мы можем игнорировать какие-то не критичные для нас моменты и обращать внимание тогда когда хотим соответственно приложение может работать без остановки даже если там ему совсем плохо но при этом мы можем мы видим что проблемы есть но при этом не можем понять о том как бы из-за чего оно происходит другой вариант это в случае когда мы фиксируем проблему кидать исключения и тогда мы получаем шлок соответственно мы видим что в каком-то абстрактном 20 потоке она завалилась и при этом можно смотреть в 0 поток смотреть что же там происходит в данном случае какое-то обращение к адресной книге однако при этом приложении крошиться у пользователя все пропадает и если он встречает в эту проблемку это задержку как-то само оно не пройдет он так и будет и мучиться значит не будет все время здесь в худшем случае падать соответственно без какого-то work раунда тут ему не пройти далее как работать с этими результатами мы у себя используем вот вариант со сбором по крыше логу поэтому дальнейшая работа это работа со стеком главного потока большинстве случаев довольно часто мы по главному потоку уже можем видеть в чем проблема соответственно в данном случае обращение key chain которая вызывает какой-то видим взаимодействие с с внешними процессами в данном случае видимо видно обращение по экспрессии и встал главный поток на semaphore моих примерах по по этим проблемам мы указывали на ретироваться на лимит в одну секунду то есть это задержка главного потока более чем на секунду соответственно в этом случае процедуру мы просто вносим другой поток и все становится хорошо другой вариант может быть что в главном потоке вы своего кода совсем не видите значит в этом случае не стоит отчаиваться и останавливаться говорит что тут кто-то другой виноват стоит смотреть на другие потоки возможно что там упал низкая процедура которая из-за которой встает главной данном случае а в player он обязательно очень хочет дела целоваться на главном потоке чтобы вас не сделали все равно туда уходит и если при этом пытаться что-то делать со звуком на других потоках иметь как-то видеосессии вот то это значит вызывает у него задержка он начинает ждать пока мы там закончим соответственно главный поток встает и снова мы фиксируем проблему но бывает момента когда не так все очевидно мы видим где все происходит но что прямо править куда вам зация неясно соответственно надо профилировать если мы посмотрим как профилировать на и оси вот довольно быстро найдем масса статей где значит восхваляются наши прекрасные инструменты которые дал нам apple значит time профайлер предлагается почти во всех вариантах что по-крайней я видел запускаем time профайлер по кнопочке цифрой 1 запускаем запись сколько-то там гоняем приложение по цифре 2 пусть собираем какие-то результаты по цифре 3 весь какой-то график значит по загрузке процессора цифра 4 значит нам показывает какие функции сколько заняли по времени причем там значит кто больше занял сверху все отсортировано иначе пункт 5 позволяет нам как-то еще и все эти вещи настраивать вот принципе как бы говорится применяйте вот этот обряд и все будет хорошо однако хочется обратить внимание на два момента первое вот значит пример никого замера здесь видно что в общем-то приложение хоть эта минута приложение практически в общем-то процессор не занимает большинство как бы пустых пустых мест соответственно что здесь происходит при этом само приложение практически не отвечает она время висит немножечко отзывается в основном висит что же как бы здесь происходит нам тайну это открывает такая небольшая галка почему-то тоже об этих всяких настройка дополнительных нигде не рассказывается в этом случае мы начинаем фиксировать не только те процессы которые в этот момент что ты что-то делают но и те кто стоят на какой-то блокировки соответственно вместо пустых дыр нас появляются вот эти серые шарики вот и как бы потыкав по ним мы можем увидеть с чем собственно был занят этот процесс чего он ждет почему он в этот момент ничего не делает в данном случае мы видим что какой-то метод встал на semaphore вот и открою тайну там ждет когда из сети что-то придет второй момент который хотелось обратить внимание это то что если в списке замеров по времени вы не видите что править то есть там как бы никто время то особо не занимает то это не значит что стоит на этом остановиться потому что если у вас какая-то синхронная процедура тотем профайлер просто не имеет возможности ее полностью замерить средства если взять вот пример процедуру до абстрактный когда вы с какого то поток стартуете там операцию значит она там где-то на другом вашем потоке понимают что здесь нужно можно в несколько потоков что-то на делать запускает там несколько потоков значит получает какой-то результат и этот результат то там кидает на исходный поток соответственно time профайлер может замерить вам любой из этих облачков но никак не все процедуру целиком поэтому я бы рекомендовал очень разворачивать все значит в режим а когда у нас все показано по потокам и соответственно смотреть что там происходит по каждому потоку где как бы что у вас как происходит возможно вы видите какие-то блокировки или личных хит-парад лишние операций далее хотел бы показать что мы нашли таким образом себя на проекте seti вам под ios первую очередь запустив себя watchdog мы поняли что города там и себе занесли зря вот она нас вызывает много проблем большое количество изменений в разных таблицах когда много приходится общение происходит активность все это вызывает достаточно большие задержки соответственно мы увидели это прямо наглядно значит для того чтобы в главном потоке на что-то отобразить и по-меньше объектом насчет нужно их как-то в контекст засечек вот и это может как вот здесь на этом стыке вызвать запрос вы скупает соответственно это возможно чтение файла другой вариант если у нас неполный меньше объект соответственно его надо также за печать если у нас ещё много других контекстов они там что же тут могут дело соответственно видимо города эти требуется какая-то синхронизация и соответственно это тоже вызывает ощутимую задержку на главном потоке другой вот пример это пример дернуть охраной союзе falls and falls нам обещается потока безопасной соответственно тоже мы можем ее дергать разных потоков если мы на главным чаем гордость хранить вот это все может снова встать на блокировки вот как бы уже такая прямо наша бага значит масштабируется картинка к сожалению делает это на главном потоке вот если картинка достаточно большая все это тоже начнет фризит наш ей вот пример уже не совсем даже нашей части библиотека статистике flare пытается значит что-то сделать по сети и на и при этом обращается к key chain у соответственно причина видимо имеет какое-то обращение к другим своим процессом поскольку штука системная и она тоже встает на экспрессе вызове и на semaphore ну соответственно в общем то как и во многих во многих налоги их не обошлось и без проблем соответственно далее бы сказал какие подводные камни у нас возникли при работе с домом самое большое что вызывает проблему при работе с другом и это фон то что приложение какой-то момент при сворачивании засыпает в первую очередь приложение сворачивается или разворачивается то в этот момент она как бы с одной стороны его с другой стороны нам нужно как можно быстрее свернуться и тут уже нам не так важно чтобы поток отзывался потому что он должно уйти там уже что то делать дальше сама фоне и в этот момент и и сама система тоже много что делает пытаются там не скриншоте и кит еще добавить на операции делать соответственно здесь мы довольно часто можно столкнуться с тем что таймаут на свое не пройдем и аналогичная ситуация на активации тоже как бы происходит разные выгрузка различных моментов из памяти что-то подымает что-то загружает какие-то вещи пытают фиксировать что должен активируется соответственно что там пытаются своей проверить как системные так и какие-то внешние библиотеки и последний момент это если приложение у вас фоне делает может быть обрабатывает там погром фичи или значит какой-то какие-то модификации локально используя могут давать небольшой промежуток процессорного времени если в этот момент значит замер стартануть то следующий закончить мы уже можем где-то там через час например соответственно вроде бы для нас эта проблема хотя в общем то проблем на самом деле нет для пользователя второй момент с которым мы столкнулись это то что системные модули также могут вызывать довольно ощутимые задержки на главном потоке первое с чем мы столкнулись это клавиатура и и подъем особенно первый раз это довольно тяжелая болезненная процедура здесь вот несколько примеров значит здесь она пытается что-то грузить какие-то своей настройки видимо тоже обращение куда-то вовне здесь опять же задействованы экспрессии и все это начать и мое время встает другой момент что значит она грудь какие-то свои еще дополнительные библиотеки погружает там массу шрифтов соответственно это также может попасть в наш лимит здесь для того чтобы видимо включить или что-то сделался возможности диктовки с кнопочкой она проверяет возможность можно ли его использовать лезет в сеть и опять же тут видно обращение куда-то во мне соответственно тоже это попадает лимит ну и конец а чтение файла в строку вот причем таких моментов там не один второй модуль который так вызвал нас большие проблемы это камера камера при старте инициализирует множества слоев вот и соответственно нашем случае это тоже вызывало не проходила нашли нет в секунду здесь мы видим опять же обращение к настройкам довольно часто и вообще вещь и снова куда-то обращения вовне и все это снова встает возьму форе другой момент это запрос значит за переводами видимо он обращается с каких-то локализованы текста выводить также он шариться по файловой системе видно и также это может уже вызвать задержку кнопки для того которым показывает в камере он также загружает как видно на главном потоке ну и соответственно для того чтобы звук при съемке видно что он также анализирует тут что-то насчет звука вот грузит этот файлик и видимо тоже куда-то обращается вовне ну и такое третья проблема которое нас возникло это то что если мы используем какие-то внешние библиотеки который нам очень нужны они в общем то тоже могут решить тем что что-то делать такой нехороший на главном потоке они зачастую что-то значит запускать код запрос какие-то результаты их прямо тут же в главном обрабатывают и там куда то еще сохраняют лазить и в настройки в печи и прочим моменты вот здесь например садись на facebook sdk получив там что-то по сети видимо access token пытается его сохранить в аккаунт и соответственно это видим вызывает кого синхронизацию возможно во мне другой пример значит библиотека от флаер очень довольно много она на на старте или где-то около того пытается прочесть настройках юзер дефолт соответственно тоже всех рано из обязательно не нужны самые актуальные чтобы там ничего не дай бог не пропало его соответственно это тоже вызывает ощутимой задержки ну и другой пример значит биотек статистиков лари тоже значит на инициализации своей визит куда то значит по директориям соответственно в обращении файл системе в данном случае тоже задержка поскольку в нашем методе значит если возникает проблема неважно наш она или нет для того чтобы пользователь мог дальше пользоваться приложением нам нужно какое-то решение чтобы он прошел дальше не была крыша поэтому необходимо для этих ситуаций какие-то рук раваны но в случае как ухода фон и активации важно как можно раньше остановиться мы применяем просто остановку и после активации особенно после нужно фиксировать когда закончится инициализация психически вещей типа статистики в конце значит запустить снова замер и причем вот такой у нас был примера мы используем для сбора к шейху keope соответственно он на старте если крошить довольно много накопилось кого-то он может это там делать синхронно сначала одну port отправляет они потом другую соответственно довольно сложно это окончание запуска довольно не так просто зафиксировать нужно как бы дождаться когда все они закончат для процедур которые не такие большие реки длинные мы применяем пропуск небольшого промежутка там пример секунду для тех модулей которые где есть модификация значит перед их запуском и notification в завершении соответственно мы по этим модификациям делаем стоп и сразу планируем старт чтобы возобновить замеры ну а соответственно в случае если таких модификаций нет то процедуру съездим перехватываем и вставляем начал остановку и сразу планируем запуск для того чтобы получить максимум результата для того чтобы собирать эти данные там вот широкому кругу пользователей мы используем разные значения лимитов ответственно для внутренних пункт для внутренних тестировщиков можно чтобы приложение падла чаще и вот они а значит нам быстрее доложишь что это что как а вот для них мы используем одну секунду это а что нам даёт такой наиболее наибольший объем результатов для внешних тестировщиков мы этот тайм аут увеличиваем до 3 секунд а вот тем не менее на каких-то старых устройствах это позволяет фиксировать значит проблемы которые ушли уже куда-то наружу то что не удалось поймать нам но помогли поймать лишние тестировщики ну а для appstore а соответственно мы уже побаиваемся что значит начнутся какие-то краше не дай бог поэтому в этом случае ваш долг мы уже выключаем и завершить хотелось бы на позитивной ноте не на на четверг раундах значит применяя watchdog мы довольно оперативно понимаем о том что занесена какая-то проблема особенно при разработке сразу видим крыши вот это довольно удобно при чем настолько удобно что хочется применять уже это не только на главном потоке но и соответственно для других каких-то наших ключевых потоков там для работы с базой данных приобретите сетевые вещи соответственно планируем наверное и туда тоже его развернуть ну и ссылочка на нашу реализацию вот на диск об одном из наших разработчиков можете скачать посмотреть на этом у меня все вопросы артём авито вы упоминали что у вас были проблемы с клавиатурой из камерой и вы как-то это пытались решить или вы понимаете там что это дамы пытались решить мы значит первая идея была что мы видели там какие-то методы инициализации что причем какие-то даже шире трин солнца пытаются стартовать то есть это явно синглтона там пытается запустить поэтому в первую очередь мы попробовали фоновых потоках как-то заранее все это прогреть попытались дергать эти методы соответственно для того чтобы все это в итоге для того чтобы первый первый запуск и первое открытие было но уже как будто как второе но тем ни менее последние то странной крыши и в общем-то выдать это на продакшн и в итоге не рискнули поэтому решили просто обойти это и клавиатур касается камеры да ну а в случае камеры было видно что можно просто делать свою камеру к возможно что она будет удобнее и даже лучше кроме того там были вокруг камера другие проблемы которые хотелось какие-то другие функциональность которых я хотел занести но стандартный камер этого не позволяло мне вопрос на тему того как как вы делаете лоббирование как вы собираете пробу с процессов от славного если это не йаран лук вот как значит у нас история была такая и про робко бы ее вот про другой подход мы когда все это делали начали с того что чтобы система начнет бороться с тормозами мы сначала начали мерить ран лук вот и накрутили все вокруг него значит замеры и соответственно результат мы снимаем просто тем что кидаем исключением для исключения и соответственно дальше мы используем хаки об он снимает по по исключению все стыки со всех потоков и мы от него получаем уже прошло к соответственно дальше там на вебе его читаем посмотрим что там как я имею самым сам механизм вот если не разлук то у вас есть какой-то свой там потоку тот watch dog это отдельный поток который там for цикл какой-то крутится и вот в этом в теле for a снимается проба спартак а вот как как такую функцию я не знаю ядра что как как вы это делали примерно мы делаем так соответственно мы довольно главный поток беспомощным операцию чтобы он там буквально больше поменял вот ну это грубо и дальше засыпаем на определенный тайм-аут который мы хотим поиск по завершению тайм-аутом проверяем она там поменялось если поменялось значит а все хорошо если она как-то момента не успела поменять то значит это исключение и как бы этот подход нам на данный момент уже нравится больше потому что он кажется легче запускается на других поток говорю спасибо привет хотел задать вопрос потом забыл сейчас долго вспоминал что же я хотел спросить смотри вот начиная с того момента когда вы этот хочет устроили нас во первых ну два вопроса первый все ли проблемы действительно удалось локализовать понять в чем была причина провисание исправить их или что-то и совсем не объяснимое есть какие-то вещи кота но в любом случае есть ложные срабатывания то есть например когда он же стреляет после проблемы и мы видим только как бы пустой ран лук главном потоке видим что как бы ждет следующую процедуру и там вообще как бы не кого то есть он явно уже не чем реально не занят вот такие конечно ситуацию нас продолжаются но и как бы те проблемы которых я указал все наши workaround и вот они у нас работает не всегда вот тем более просто листе у нас тоже активно развивается и вот и на текущий момент еще различные ситуации когда мы получаем ложные срабатывания по своим вещам мы убираем то что нашли большинство вещей убрали но честно говоря вот currado то у нас к сожалению еще еще висит на надеемся когда-нибудь мы ее дожмем пока у нас есть и надо нам может стрелять окей спасибо тогда все есть планы какие то на счет миграции скоро дата сказать нам нравится прям по всем параметрам вроде тоже самое но без сдачи всех множеств объектов и вот это всего схемы прочих вещей видимо на этом все"
}