{
  "video_id": "Mb7Ov07dG3A",
  "channel": "HighLoadChannel",
  "title": "Linux Kernel Extension for Databases / Александр Крижановский (Tempesta Technologies)",
  "views": 1778,
  "duration": 3161,
  "published": "2017-04-22T14:48:11-07:00",
  "text": "добрый день всем добрый вечер уже давайте представим себе меня зовут крыжановский александр я работаю в двух местах в одном мы занимаемся разработкой высокопроизводительных приложений на заказ консалтингом в основном это система обработки всего трафика и базы данных в другом проекте секрет технолоджис это фок от на tissot мы занимаемся разработкой and south africa что delivery контроля то есть вот такие гибриды из средств безопасности в буксире готова fat bass тогда который помогает вам доставлять контент быстро и надежно сегодня я хочу собственный сказать по часть этого факта при том что это в целом это в основном акселератор веб-контента у него достаточно много общего с базами данных собственно по него в конце а сначала я вообще начну свою презентацию с моего очень давнего неудачного опыта построения собственной базы данных легкой и тогда это много лет назад меня стояла задача построить очень быстро и стоишь для инсов мессенджеры истории с мессенджера стоит а вот собственно должен был держать сообщения пользователей по ключу из трех компонентов это отправитель получатель но и временная метка сообщениям соответственно требовалась большая производительность начинали с того что она вообще консистентной с неважно мы хотели это всю жизнь делать на файловым столь же а потом пришли к тому что в общем как-то нехорошо терять теряя сообщение пользователи мы захотели какую-то консистенсии ну и поскольку все это мы начинают файлы вас тут же подумали что два-три месяца достаточно для того чтобы такое сделать на файлах заложили ссылок очень мало и в результате точно бы все быстро делать вот сегодня буду рассказывать по внутренней базы данных по внутренности операционной системы о том как собственно что происходит на стыке когда я говорю по базу данных я имею ввиду в основном вот вывод управления памятью и обработка транзакций совершенно не по скверне по индексам не по блокировке тогда то есть только вот вывод полене по мячу и транзакции и больше я буду сегодня ну те места которые я буду упоминать по баз данных я буду ссылаться на и на тебе просто какую-то которых наиболее мне знакомо вот если мы посмотрим на от индукционный движок движок санкционной базы мы увидим вот примерно такую же картинку то есть у нас есть buffer pool в нем живут страничке яндекса страничке данных все эти страничка не выводятся через тын секционный wog когда они изменились походит это все через планировщик ввода-вывода и в ту и в другую сторону понять куда когда читаешь что-то диска он делает ледоход вообще это походит через во всем этом даже на диске теперь давайте посмотрим на то как устроена подсистема ввода-вывода и виртуальной памяти в includes левом в принципе в операционной системе и мы увидим очень очень похожую картинку то есть у нас есть пачкаешь там хранятся какие то страничке сбрасываются они через фау систему через верх из файла с теми вместе с фаустом обычно поставляется инфекционный лук и все это же проходит через планировщику вода выводы там тоже разные умные вещи происходит вот собственно традиционно баз данных строились на стену вызове о директ и вот это достаточно стала выжимка из письма linux в общем не приветствуется это озабочен операционной системы у нас достаточно долго есть недопонимание между рабочим колесом схемы базы данных что должно быть вот соответственно в то время раньше я решу что мы не будем как бы попытаться выкинуть операционно систему как а большинство разработчиков баз данных а бы максимально использовать ее интерфейс поскольку времени у нас мало у нас есть замечательные системный вызов и мэп который нам поможет собственно у него есть все необходимые нам фич который мы видим сейчас на левой картинке vaper он вытесняет страничка когда страничка вытесняется она пишется на диска она пишется там она до файла система она это обеспечивает далее мы он как-то баунти сбрасывает страничке у нас по участку ассистент ность вот вывод управляется операционную систему у нее есть разные под винты пони . вот выводы тоже нам это хорошо и у нас как бы есть такая приятная фича о том что нас принципе даже получаем индексы бесплатном давайте посмотрим на последнем фичу собственно мы поэта просто непрерывная область памяти достаточно большая соответственно вся память нас есть виртуальной адреса есть физически и вся память у нас все обращения в памяти которые происходят они у нас должны ходить через трансакцию vita но адреса физически и да это у нас используется таблица по что apple собственно она занимается этим рисунком вот у нас есть сверху ключ 48 бит на это адрес из него и способ 36 бит и здесь вот мы походим откусываем по 9 бит за вас от этого ключа и походим по дереву нас по участник такой радикс 3 то есть если вот фатер картинку пересмотреть то будет примерно то что показано слева то есть вот у нас 1 9 без ключа определяют индекс в этом массиве да потом мы переходим здесь указать на следующие так далее структуру называться дикс 3 и в целом если мы строим какой-нибудь бинарное дерево до в оперативной памяти ну как в обычном бинарное дерево там скажем какойнибудь стиль мы куда которые используют к оснащенное дерево у нас на каждом поиски элемент вот если мы спускаемся из дерева и хотим вот пакет 2 зелёненького элемента и синего то мы должны в общем случае сделать разрисовывать адрес и соответственно пойти все наши большое дерево сделать четыре обращения к памяти получается что на то чтобы пойти и каждый элемент нашего прикладного дерево мы должны сделать пойти еще дерево таблицы страниц вот если мы как бы на это посмотрит вот вообще к бы идею того что у нас индекс есть days коробки мы можем выделять непрерывную область памяти в каком-то фиксированную моды судам epam и потом гладь крючьев фиксированном диапазоне quote их стих на шину данных и вот у нас будет визовым через таблиц страниц вот если мы на этом более внимательно посмотрит на самом деле не что иное как просто обычные хищный массив то есть большой session и массив это на самом деле дереву вот ну как бы мало на что с этим можно сделать но здесь интересно то что виртуальная память она совсем нам ведешь вот первое что хочу сказать этот третий буллит о том что если у нас виртуальной памяти вот если мы так будем использовать эту она память капуста индекс из коробки то если мы будем использовать не будем использовать ключ из простой плохой локальность это сильно распределенные ключи-то у нас все очень будет долго потому что мы будем из-под очень много памяти до то есть один элемент маханием а использовал целую страницу там где он лежит и вот собственно каждый элемент этого дерева это страница дерево очень дорогое вот у нас это дерево на кэшируется втб мтлб маленький и к сожалению мы на концах свечах должны вообще не вы ли делать полностью каждого уровня потому что виртуально адреса у нас могут быть одинаковые и соответственно у нас вылетает все эти все адреса вот но хорошо то что юзу списке она space контекст switch он оставляет каши не тонким потому что работа и двое use space работает в одном пасха на в одном вода адрес таблица стране с одной таблице они сработают собственно вот на тот момент когда начались было с маком я понял суть вещи о том что во первых если мы используем большие большие данные то нам нужно максимально держать просто снова cal ность то есть нельзя просто взаимо пить большой области как попало использовать нужно максимально локальной ключи использовать ну собственно большие map и они достаточно долги потому что если вы маппить и большую область вы тратите много на таблицы страниц то есть вся эта область она должна как-то адресоваться вот на самом деле я далеко не первый кто вообще попытался как бы переиспользовать механизмы механизм операционной системы с помощью map и и вот мы видим что еще у получать 35 лет назад люди давно задавались этим же вопросом а то что как нехорошо получается что вроде как у нас все механизмы есть на операционной steam они не отворяют требованиям разработчиков баз данных сформулировал майклсон ветер эти требования они достаточно интересные интересно что фактически все кроме последнего до сих пор актуальны то есть вот за в это десятилетие процессы стали достаточно легкими у нас появились три да у нас мог все изменилось появился map то есть вот в этой статье она еще до появления мы по вот астаны они в принципе более менее актуальна то есть первое что когда мы делаем эмп вытесняем мы не знаем когда какая страница вы тесниться в каком порядке так далее далее у нас вся в обычно фауст and которым мы имеем дело они не структуре она не просто хранят последовательность байт у нас совершенно нет транзакций настоящих да то есть с одной стороны мы говорим то что у нас есть инфекционного к другой стороны транзакции смысл баз данных у нас нет и есть проблема с непрерывностью локации блоков на диске ну вот эта проблема тоже вот то есть вот последние три проблемы они более-менее сейчас решены до первой 3a никак не были решены так и не решились давайте с конца это все посмотрим собственно пиво это локальности данных нам помогают extend и файлах систем то есть у современных фарш тем они отсылают на диске пососу достаточно большими кусками и как бы решают проблем того что у нас фрагментация файла на диске боков файл базы данных на себя очень низкая соответственно нам есть долго помогает системный вызов of white если мы создаем большой файл см идем большую запись факту мы можем при резервировании последовательную область на диске и писать туда данные соответственно все будет как бытха уж пососал локальность вот поскольку нас fava система они не только отсылают данный акцентом на них еще адресуют соответственно ну-ка большинство файла всем они тоже имеет индексируют свои блоки через деревья там через b3 через хитрой и чем больше блок данных а не индексирует чем ниже это дерево соответственно не индексирует большие extend это деревья получается достаточно низким и если мы овацию pow pow вообще большими флаг это у нас как бы еще меньше индекс соответственно по сути у нас дерево которое есть у файлы системы для адресации блоков она очень низкое это проблем нивелируется тоже теперь вот самое интересное это то что подход к самому интересом и тому как обрабатываются транзакции здесь схематически пытался но рисовать как выглядит анзак шин processing в и на тебе давайте посмотрим что здесь у нас есть две грязные странички которых изменяются две записи красным цветом и самое важно для нас что тебе использует политику так называемую still in a force это значит что вот эти странички они могут быть любой момент fashion с диском то есть едок момента коми то это значит значит что они вот воруются это steel ct но фолз говорит о том что когда у вас проходит commit не обязательно что вас будет зафиксирован все ваши данные на диске соответственно мы используем andare ноги для того чтобы катить a dog откатить сплошная духами то данные дак контакт с которой еще не закончилось и ряду для того чтобы восстановить так ну давайте дальше здесь еще интересно что есть antec это собственно ну как бы основан на чем работает multivision ность и он хранит ставим версия записи то есть в целом базы данных вот ее от инфекционного этот уровень ввода-вывода он должен знать о реку достать мы не можем реализовать достаточно гибкий такой стратегии фишинга без знания семантики данных которым мы храним без знания рекордов собственно но это вот как как как с и мы в принципе уже сейчас поговорим о том что мы не можем гарантировать когда какая страница будет записан не можем говорить записях и давайте посмотрим вот например что у нас будет какие-то две транзакции тебя вот которые совершенно разные страницы модифицирует но вот на одной страничке они модифицируют казны и записи до нас linux vmm не знает то реку до соответственно вот когда у нас пиво транзакции к месяца мы можем сказать что у нас была изменена 3 стране страничка да вот это но мы ее должны сложить допустим мы ее фаршем вот эти три страницы которые были изменены первой транзакции но когда мы пашем эту страницу мы не знаем успел или другая транзакция сделать изменения в трети страницы или нет и соответственно вместе с первой транзакции можем сложить изменение 2 то загса можем не спешить и сам похоже что мы это вообще не знаю мы даже не можем узнать и мы как бы в принципе уже сказал но на самом деле то же опять же люди все равно задаются вопросом о том что могут ли современная файлы системы предоставлять нам ну как бы окей мы понимаем что баз данных современной она реализует более сложные механизмы чем файла система но может быть мы можем отключить какие-то кусочки от традиционно движка баз данных заменить их механизм имеем файлы система давайте сейчас немножко мы бежим по тому как фарси вообще устроены и потом пытаемся ответить на этот вопрос первое что хочу сказать файл схемах этот популярные во всем который наверное большинство используют это так называемая урока ширины и fous тему то есть обычная фас тема к ней приписывается лог когда мы делаем запись мы сначала пишем в транзакционный лак и потом уже пишем на диск соответственно нас получается двойная запись обязательна и единственное что мы можем сделать это во первых бог-сын сексуально он пишется последовательно поэтому нам хорошо да второе то что он ну как бы он маленький он последовательно 2 то что поскольку мы уже списали wog мы можем изменение отложить их записи замочить их и большим куском все вместе опустить вот проблема двойной записи нравилось не всем и люди делали попытку вообще уйти от двойной записи они говорили ok давайте мы откажемся вообще от супер файл схемы вообще ее всю по своим как один большой транзакционный лог нас изменились данные мы их допишем в конец нашего поставите налога который все растет и растет дальше и вот изменяется кусок файла моего дописываем в конец теперь у нас ой not который ссылается на вот изначальный наш бог он должен тоже быть изменен соответствием это же вы должны по копиру туда в конец индукционного и поскольку у нас анода теперь плавают по диску мы должны еще где-то держать картой нодов которые тоже как-то апдейтить с этими указать имена я найду в конце и получать достаточно такая сложная структура со сложенным менеджментом и в общем показывающие плохую очень их производительность вот вот например не офиса до сих пор в ядре linux есть ее можно взять и запустить попробовать продолжением эта идея сталью ну как бы что что-то между вторыми это копия white файл с тем этот современный zfs и г3ф с собственно не спорит такой же подход поскольку обе fous тем они позволяют нам шутить то они используют следующие свойства как допустим вот у нас есть желтенькое дерево до изначально потом мы должны добавить элемент 19 мы берем копируем вот этот бог дописан к нему 19 и теперь мы должны ссылаться на этот блок is good а вот мы тоже к пилам и приписываем ссылку вот эти оставляем и в этот момент у нас остается вот а вот этих элементах а то у нас когда-то освободятся соответствует за счет этого мы можем делать снапшоты и здесь у нас похожая идея наук структуре на всем то есть новые змеи мы просто дописываем дальше и здесь получается следующее свойство если у нас есть скажем файл базы данных до которой примерно одного размера да сохранят например у вас есть там сто тысяч пользователей которые вы там или 100 тысяч клиентов которым вы иногда изменяете там записи и так далее но примерно у вас файл базы данных будет одинаковой до медленно расти но будет высокий апдейт соответственно к файл с тем оно будет все время лоцировать нового места на диске все время будет крутить диск и в принципе фрагментации здесь тоже будут проблемы потому что если вот эти четыре бога они были последние на диске то после того как мы запишем вот эти блоки свинку им да у нас будет только на диске богатство к ностью здесь есть другой стороны если мы все время дописываем новые новые данные то так которая всем имеет место быть да напиши только один раз данная она не пишет их два раза на диск поэтому наверное b3 fs лучше для о olap нагрузок когда вы периодически выгружайте большие объемы данных на диск и как выгружать их последовательности если же у вас идет большого где-то у тебя нагрузка то лучшая классическая система обычно последнее о чем хотел упомянуть это free bsd снова система в принципе она как бы говорит о том что мы можем вообще не спорт никакие логе а можем аккуратно делать апдейты если мы например хотим добавить новый бог файл то мы сначала целом бог где-то моего отсылали положили и только потом мы должны прописать ссылку на него вай нот если у нас где то по середине отвалится но мы потеряем первый блок но консенсус у нас будет х останется другой стороны если мы сначала изменим енот который ссылается на новый бог да бог еще не выделит а у нас свалится контент ность файла собственно так оно работает но понятное дело что file system опять же не знает никаких данных она может сохранять только истинность своей структуры она немножко и сохраняя системность данных в принципе вот систему пам на предыдущем здесь не показано файлы силы gfs gt4 не ну как бы xfs вообще позволяют только метода туда делать экзост а4 можно настроить чтобы оно дано это же vogue а то есть это четыре она позволяет вам более консистентные данные хранить вот и собственно подобрались к вопросу о том что можно ли нам все-таки это механизмы баз данных выкинуть из под вместо них file system вот и в 3d а из пехотную написал замечательный блог о том что он попытался выкинуть добывает буфер и заменить его изоляционного файлы системы и бог этот насколько помню он вообще в двух частях то есть начало первая часть о том что все замечательно все хорошо получилось 2 о том что ничего не получилось проблема в том что мы не можем писать большие данные consistent то есть давайте рассмотрим что мы пишем сейчас с вами делаем большой гайд ну 11 системный вызов вызываем который должен нам записать 3 блока до 1 пишем 2 пишем хорошо потом мы отваливаем ся нам всем она не откатит изменение 1 вот традиционный лог-файл всем это очень большой файле маленький другой стороны мы можем вызвать light на много-много гигабайт до например ком быть большой там и машин были выдаст попытаться сохранить и нет у нас мест для того чтобы все эти данные где-то сохранить мы можем целовать большую большой файл и перезаписывать там данные нам тоже не где все это сохранить соответствовать тем она максимум что может даже вот максимальным вариантик z4 которая должна обеспечивать консистентной данных мы какой-то часть из этого из данных переданных в этот гайд вы мы consistent запишем какой-то нет что-то у нас откатиться что-то не откатиться то есть вообще говорят паффа нацию кастинг в данный файл системах вот собственно опять же вот после заключения о том что повысим не структуре он ничего не знают о данных константности не дают давайте еще посмотрим как у нас вытесняются данные хочется из памяти на диск собственно linux работы с двумя списками ок активный не активно если страничка только что вот приходит нам новая страничка какая то мы почитали и почитали и в памяти папа изменяли и пока мы из дням она находится в актив листе как только она устаревает она вытесняется в и на тифлис пасту по по таймауту если она сколько то здесь побудет в инактив листе отсюда она пишется на диск и птицам она отсюда может забиваться локатором проблема здесь в чем что это 2 линейной структуры данных с последним доступом у нас памяти может быть очень много да вот современную собирают может быть там 128 там 512 гигабайт оперативки делим это все на 4 килобайта получаем уйму страничек который будет лежать линейном списке соответственно если у нас доступ к нашим данным к памяти он все время меняется мы меняем то одни страничке то другие пачка у нас в эти списки она добавляется и нефти в список он тоже у нас может ухнуть до покинуть своим правилам в какой то момент мы можем брать страничку снова к ней обращаться на снова сюда переоденется и вот это множество все время страничке могут циркулировать между вот этими списками когда оценщика все-таки фарш и цена диска она может снова быть поднята подняться с диска до при обращении ну и так далее в общем когда кенгурин ксу не хватает памяти когда им приходится сканировать в ответе списка все становится очень медленно кстати говоря к свадьбе это однопоточный демон плюс еще он должен научить вот эти списки когда он по ним бегает для того чтобы сохранить кастинг на структуру данных относительно изменение которые делают другие процесс вот по вставке излечению страничек ну и вообщем все очень плохо вот есть у нас несколько системных вызовов которые нам помогают синхронизировать принудительно данные из ну как бы из-за отказа открытого файла до скажем i've seen к и либо из-за map а вот но проблема в том что вот если мы внимательно посмотрим на все вот эти вызовы да у нас вот есть здесь адрес есть длина asset опять же байт мы можем только кайт непрерывный финиш сброс мы не можем сказать пожалуйста пусть нам первую 3 коту страничке дамы так мы не можем если мы сбрасываем и делом один большой light то мы не можем его записать там она и мы опять же не контролируем когда едва linux скидывая скинет определён страничка может быть до этого синко может быть посвящен к то есть любовь вот когда моей маме мама вообще не знаем ничего о том состоянии файла на диске какие данные сих резины какие несколько vision это плохо вот соответственно мы немножко можем повлиять на процесс и которые протекают в вытеснение из памяти внутри linux мы можем давать два из и вот например от вас о том что они определенно не нужно а если мы помещаем в мафию страницу как не нужно то с большой вероятностью и двое и раньше выкинет но опять же когда она его выкинет выкинет и вообще нам тоже гарантий никаких не дается вот это некоторая сумма том что как бы только что сказали первое о том что но мы вытесняем когда мы вытесняем мы мы не знаем можно только немножко влиять есть полный полностью конизация файла и это кстати причина почему ты сексуальный лог баз данных хранится в отдельном файлики в небольшом потому что мы можем полностью сделать в sing на этот файл полностью 8 реализовывать то что нас нет другого выбора как синхронизировать какие-то какую-то область например почему ты был спасен хранится заочные заученные списке сканируем это все плохо очень вот давайте пойдемте вообще по тому что сейчас ну как бы паре siri счетчика то и делаться в области файловых систем прежде всего это языком они добавляли от инфекционных но опять же эта сексуальность для небольшой записи помыта 4 32 килобайта the man издавали у них есть какая-то поддержка транзакции но опять же большие данные нельзя на них данные нельзя сохранить континентом с gallante до b3 fs нам дает на самом деле трофей слепота за акции мы можем сказать что начать транзакцию начать операции с файловой системой по моему это не только red white в определенных волнует а всякие там перемещение файлов удаления и так далее потом закончить транзакцию здесь есть проблема и в принципе это как бы не рекомендованы интерфейсы к использованию в том что если мы начинаем транзакцию потом нас процесс подыхает то больше никто не сможет обратиться к этим к этим файлам которые он захочет соответственно мы как бы это за акцию не откатиться до есть вот windows таксофона в этих в какой-то версии windows она даже сейчас есть на объявлен как deprecated тоже насколько помню по тем же самым причинам что и в 3 fs и есть еще вот the research is к до сочувствие же файла система которая позволяет вам на уровне which of our system новые самом высоком абстрактном делать инфекционные системные вызовы над файлами в семантике транзакции тоже начинаем транзакцию камедь mathcad и умно и так далее вот далее у нас есть еще операционная система тоже девятого года который вообще говорит о том что почему нам вообще не сделать все операции в операционной система в операционке 7 от инфекционными то есть убить любую последний системных вызовов мы можем посадить по транзакцию любую откатить и для этих целей там по часа абсолютно все все структуры данных они и когда вы менять например у нас есть структуру тоска факт если вы изменяете процесс например там изменил какие-то данные по фаун дескриптором по еще чему-то вы какую-то структуру помечаете ту как old копии новую как новую копию и вот работаете с этими копин потом их удаляете и в целом вы можете это от как откатить вот интересный как но для нас более интересный пример это оказался м sing проект и собственно он делать достаточно маленькие вещи о на пост дает индекс он интерфейс к мапу он позволяет вам за маппить область памяти с флагом с новым флагом они добавляют мапо томик делают м sensing патчит который позволяет синхронизировать тоже только измененные данные причем непоследовательности только те которые были недавно змеиные добавляют ряду aging но и почет гос страниц то есть достаточно большие змеи но которые позволяют нам атаман работа сама плен и областью последний пункт который у нас был вот который адресовал майклсон backing это о том что нас файл с тем они я не структурированы и на самом деле у нас есть файл и структуре система которые структурированы которые дают вам рек и торрент от интерфейса и вот в мэси такой есть palm это был выеби морских мин фильмах соответствует морских в системах у нас есть фау систему который вам дают разные вы можете их открыть вот со специфичными здесь не показано тоже там сиз о по специально специфичные системные вызовы то есть не такие как окон ride lite в линуксе а вы использовать специально системные вызовы для открытия файла непосредственных доступа для доступа по индексу и так далее на самом деле это получается вас когда вы закрываете фа у вас это все сбрасывается бизань обязательно и получается у вас это на самом деле вот оно как бы выглядит как базу данных напарника базы данных она по сути внутри этого и есть база данных у вас есть индекс у вас есть транзакцию у вас вот есть интерфейс вот этого добавления записей походы по записям так далее по сути это вставим а баз данных которые зеленого и для вмс вот и вообще говоря это не дохлое это как бы не восьмидесятые годы это современная вполне вещи и вот сейчас можно скачать документацию поэтому это вот документация современной операционной системы вот собственно подобрать уже к нашему к решению соусом и тоже делаем базу данных ну нам базу данных понадобилось поскольку мы идем в боксе регату то акселерат и должен хранить контент страниц есть например apache ты of exigo который реализует никто и подобию баз данных тоже у него он не в каждом отдельном файле хранит табличка специально овации ваном спейси docs только то это может сбивать эффективно и адресовать соответственно также используем базу данных то есть основной для чего мы используем тебя to die by the file cache cache cache ответов север там же еще у нас хранятся павел фильтра заблокированных клиентов там же будут храниться связь ипользуйте и так далее вот соответственно сама тебе сработает внутри софт и курит полностью ядерные решения и сейчас мы начали работать над тем чтобы как бы открыть эти интерфейсы делают что-то более общие что можно было бы использовать в новых приложениях для базы данных нам самим сейчас понадобились новые интерфейсы для доступа к базам данных data что можно было удобно управлять своим ковшом и соответственно нам как бы стало не хватать после ядерные баз данных которые тяжело получить доступ из use space а собственно все это сейчас находится только вы сработки сейчас в отдельный ветки на гитхабе ты лежит и давайте посмотрим вообще что делалось делается но это как бы как это все хозяйство используется у нас есть use space утилитка маленько который вам позволяет делать какие-то кризисы в базу данных открывать таблички и так далее то есть достаточно просто основной все что делается это вот на уровне едва базе данных у нас honey фильтра хранит правило ситуации здесь хранится в кэш будет храниться логированием изначально мы как бы тут интерфейс который сейчас есть в мастере это вот такой вот интерфейс то есть это вся эта область то есть как база данных лежит у нас внутри ядра и мы используем над wing интерфейс для того чтобы передать за запрос через socket от и дпкв едва-едва здесь крутит вы чекаете запрос и потом отдает результаты виза space проблема в том что сам по себе над wing map он может любой ядерной буфер смотреть вам в usa space в принципе мы как бы с помощью копии можем передать все данные за два use space проблема заключается в том что в базе данных у нас много всего лежит если вы дадите запрос например дайте мне там все все ответы сервера там за какой быть периода литому каком быть индексу мы не можем просто взять и как бы странице базы данных завопить в use space потому что у нас в этих страницах будут как бы и записи которые соответствует запасу записи который не соответствует во первых во вторых эти записи могут меняться вот прям сейчас в онлайне и соответственно мы поступаем так что вот мы здесь в сторонке овации вам новые странички туда собираем результаты выполнения запроса потом уже эти странички мы маком без капельницу space вот а нам захотелось все-таки быть совсем без копирование чтобы у нас и use space процессы и сама tempesta они работали с одним буфером внутри е21 uxa как с одной общей базы данных то есть у нас получается многопоточная база данных с одинаковыми данными вот и собственно сейчас немножко по то как мы строимся пapehь мы используем только большие странице когда creaciones те могуществом и откусываем от нее область памяти большой непрерывно также как делать #ff с потом в нее мы мопи им все наши данные то есть поскольку tempesta это полностью ядерно решение она работает с авто китай сами т.е. до обработки и клиентских запросов это тоже и пребывания спать мы там не можем на диск на них можем поэтому есть жесткое требование это о том что вся база на должно быть in memory она должна быть президетна я должна бы консистенсии стен тный но вся должна помещаться в память что пришедший запрос мог сразу отработать сбрасываемся мы только в моторных нитях выпиливается сейчас новая система которая должна дать интерфейс к tempesta тебе собственно через веб-интерфейс у нас будет свой вот это map похоже на м sing используем мы сейчас стратегию но steve fox либо но фокус но steel напомню что это значит что странице мы не можем сбрасывать на диск до тех пор пока нитками the falls in a force значит о том что если у нас фон стратегия то тогда когда походит коммент мы обязаны всё синкай на дисках если но falls to commit пошел носенко может не быть давайте посмотрим что происходит ну во первых это вот как это все организовывается сейчас есть сегмент страниц вот эти больших которые уоттс мы от него отрезаем небольшой область вначале этот инфекционный сегмент здесь у нас живут и интерфейсы mapa виртуальный файл с тем и тонкой и прикладной уровень он ходит через эти интерфейсы получается что вся база данных она напиться вузах space через через мап на уровне use space виден как яндекс так и данные и выводится отдельный менеджмент потоки которые занимаются синхронизации вот смотрите если у нас приходит как отказа который изменяет вот несколько вот этих две странички и изменяют 3 записи мы изменили хит леджер данные моих них вашим то есть вообще в принципе это все сливается в систему vmm linux но как бы здесь в этот специально рио на область она не сбрасывается бага un de теперь теперь когда мы подписали вот эти данные и звезду space и нам приходит к мид мы все эти данные копируем в тэн секционный сегмент убиваемых последовательны и последовательны последовательно записью уже вата в отложенном потоки потом мы это все сбросим сейчас мы пока еще не фаршем теперь когда мы комет пошел мы уже в вашем все данные так если в другом сценарий если мы пишем идем какую-то транзакцию из ядра linux то всем данный которым мы здесь изменяем мы не можем их сквозь внутри софта кем мы должны попросить отдельный поток который нам их сбросит вытеснение из кэша собственного как бы поскольку мы должны реализовать кэш в в пляж ката в котором записи должны успевать мы мы еще прикручиваем и вытеснение с каша вытеснение скажу а также работает через наш вспомогательный поток и также через сброс через индукционный вок то есть вот когда у нас есть запись есть запись в зайчики мы узнаем что она уже закончена мы ее можем сбросить на диску далее еще не сказав о том что как а как устроена теперь сзади видео в том что современные современной машины имеют не имели метрах хиту недавно построены на моем архитектуре и это значит что доступ к зачаткам памяти занимает разное время соответственно одна из функций вспомогательного потока теперь тебе она заключается мечут за его счет у меня ни крика и цену 1 1 с функцией скажите можно что сделать одна из функций поток потока менеджера тогда бы заключается в том чтобы быть и копировать реплицировать данные между анодами вообще все попова получилось так нет на своими есть собственно в теплице деби у нас есть несколько режимов работы если у вас очень большой контент который вы копите в каше то вам весь смысл чтобы каждый каждый процесса ходил в удаленную но до пуска медленно но на мы храним данный только один глаз косвенные если вам нужна очень высокая производительность но другой страны ес вам нужно очень высоко производительность но данных немного то мы можем скопировать данные на разную процесс набега g в их локальную память и соответственно каждый процесс будет работать достаточно быстро из их локальные областью вот еще вот это собственно режим когда у нас есть когда у нас памяти мало контента многом и его разбиваем на разные участки когда приходит запрос он считается на один тот или иной процесс ный пакет и репликация тут когда у нас по полностью весь контент копируется мы используем достать специфичный индекс это cache cache из структуры данных так называем которые знают о к шее мы стараемся каждую к ошейнику напихали как можно больше данных и весь магазин работает с кэш линейками собственно то как работает наше дерево общее что такое что из себя представляет баст это небольшая хэш табличка всего лишь 16 элементов когда приходит никто ключик мы из него высчитываем высчитываем хэш берем последние получается четыре бита и четыре бита нам определяют мест в этом хэш-таблицы сейчас хэш-таблицы пусто поэтому вот прямо прямо здесь будет храниться наш крючек . массиве далее теперь у нас приходит мы набили еды есть у нас если у нас приходит еще еще не значение то мы уже маленькие значение можно напихать bucket не вы не больше одной страницы работаем дальше с ним как со списком обычные хэш-таблицы потом когда заканчивается у нас место в этом пакете у нас происходит взрыв bucket а это значит что мы выращиваем второй уровень хэш-таблицы соответственно если у нас происходит коллизия мы берем по первому элементу индекс в первом узле по второму элементу мы определяем два других то есть это примерно работы какать x3 только у него не канатная высота и мы должны перебросить все значения в новые баки там вот теперь по транзакциям собственно когда у нас происходит изменение она пишется у нас традиционный уклад то внутри узлов дерева все это пишется индукционный вок сами века ты тоже пишет заказа ционный лак и когда добавится полностью рек а то яндекс вместе с данными последовательно ложится на диск вот собственно все здесь исходный код проекта включаю tempesta дебита бог куда всех приглашенных если какие-то вопросы буду рад увидеть по e-mail еще мы активно ищем таланты хорошо разработчиков кто подключиться к нам и составить нам компанию разработки проекта наша вот всем спасибо вас есть и мыть но"
}