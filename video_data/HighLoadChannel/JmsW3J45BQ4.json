{
  "video_id": "JmsW3J45BQ4",
  "channel": "HighLoadChannel",
  "title": "OpenStack от enterprise к сервис провайдеру / Сергей Пимков (Селектел)",
  "views": 1030,
  "duration": 1495,
  "published": "2017-04-06T12:10:46-07:00",
  "text": "следующий доклад у нас про нижний уровень не прострочила сервис если мы поговорили про всякие разные configuration management и так далее доклад будет от ребят которые действительно умеет это делать уже много лет делают компании select all который делает хостинг и в том числе облачный хостинг будет рассказывать про openstack и опыт работы с ним ну и также не про свои продукты которые они сделали на окон стеки сергей пинков из компании select all поприветствуем всем привет мне хотелось бы поделиться нашим опытом адаптации ванильного конспект под нужды сервис-провайдер этот опыт мы получили разрабатываем нашу услугу виртуальные приватные облака долгое время мы разрабатывали поддерживали облачный сервис и на снова на основе зовут платформ и нашего собственного успеха услуга отличалось от других моделью абада употреблению но может быть не от всех но за все это время у нас накопилось большое количество опыта отзывов предложения критики в результате чего мы решили разработать новый облачный сервис на основе лучше поддерживаемых и более современных решений проблемы с поддержка были как у нашего собственно толстый к часть которого была написана на хаскеле и соответственно с точки зрения производительности в нем все было великолепно а вот с точки зрения сопровождения не очень проблемы были также из сторон не компонентов в частности гипервизор zen из-за политики компании citrix за эти несколько лет изрядно потерял своей привлекательности поэтому мы обратили свой взгляд на квн который к этому моменту обладал уже очень приличным функционалом и при этом быстро разрабатывался в качестве платформы мы решили использовать openstack конспект самое главное проблема пустой как кроется в нем самом он немного похож на индусский 3 учебу в которой постоянно что-то строится ломается строится снова и перестраиваться целиком при этом если мы хотим построить действительно современные и хорошие облака в данный момент у вас так одеться практически никуда все остальные решения не заведомо либо менее функциональны либо же закрыт и соответственно таким образом мы основе же не используем аванс т.к. они недостающий функционал решили в случае необходимости западе сами в ходе реализации облака перед нами стало несколько глобальных вопросов о которых я сейчас расскажу ну в таком около хронологическом порядке самый первый вопрос какой возник это где собственно то просто брать и как вадимович hero очередь мы рассмотрели несколько windows ких решений которые вы снова делились на два основных типа первый тип это скажем так обфусцированы и решение видов ключи и получи и никогда не поймешь что внутри происходит примером такого дистрибутива является продуктов компании постам клауд другие решения представляют собой конструктор сделай сам например это правда платформа от red hat там есть модули документация поддержка но при этом версия было несколько протухшей здесь хочу сказать что если мы разрабатывали приватное облака под собственные нужды в принципе дальше можно было бы даже и не ходить венгерские решение на тот даже на тот момент обычно прославить windows key и решения даже на тот момент в принципе было посижу вполне под силу поддерживать паре клюв сырных программистов а сейчас они еще более эволюционировали и вероятно сейчас можно даже не держать в штате человека который хорошо разбирался в константин пока между до первого падения и еще один путь добра соответственно учитывая специфику наших задач мы решили не искать легких путей и воспользовались исходным кодом прямо с гитхаба для того чтобы не гепатита все руками мы написали набор по 5 модулей которую поседение успешно работает он достаточно узкоспециализированным и расширяется точно там где нам надо сейчас такой ситуации мы бы возможно воспользовать очень хорошими моделями от компании мир on this но на тот момент они были еще не вполне готовы для продажи на ну и плюс содержали себе фатальный недостаток будет его ричардс лагерь 2 второй вопрос который сразу же мы обратно который мы сразу же обратили внимание это проблема пользовательского интерфейса в ком в пасти входит компонент по названием horizon а это их панель управления она написана на django достаточно но я бы сказал что написано людьми но для роботов или может быть для инопланетян потому что они пытались запихнуть в эту панель весь функционал японский к совершенно без оглядки на удобство использования иногда некоторые штуки найти где-то в недрах бесконечных меню достаточно сложно соответственно на мой взгляд хорезм пригоден для поставки только в составе готовых решений под ключ всяких приватных облаков который будет един уже настроены и потом там будет работе толки которые будут совсем не просить каша годами нам же требовалось что-то лучше соответственно учитывая то что у вас такие есть открытый api мы написали собственную панель управления на java скрипте панель ее прототип был достаточно быстро и в данный момент она уже проходит свой первый редизайн я игрушку для улучшения удобство ее использования панель соответственно как я уже сказал будет обросла дик было реализовано целиком с помощью api здесь я хочу отметить что в принципе это а бедный вот именно растопит наилучший способ общения ступин стеком там почти всегда все хорошо хотя странности на самом деле хватает иногда приходилось их документа существенно документация часто оставалась неполна соответственно здесь есть такой небольшой маленький лайфхак соответственно чаще достаточно часто проще не смотреть документация запустить консоль один крючком дебаг и он покажет все запросы потом выполнял в удобном ли восприятие формате вокруг команда и так следующих лади пожалуйста следующая проблема она концептуально собственно как это вообще продавать что с этим делать на тот момент в стек уже содержал себе компонент авторизация кистон то есть поддерживал такую модель в которой пользователь мог создавать несколько проектов и несколько пользователей и давайте пользователям доступ к этим проектом в принципе можно было бы взять вот это так как она есть то есть каждый наш клиент получал бы свое распоряжение один проект и в нем со 2-го виртуальная машина такая модель полностью соответствовал модели на 2 блока и также десятков или даже сотен других услуг осознанных по такому же принципу то есть плоское пространство в котором есть виртуалке диски и прочие объекты при этом тот фидбэк который мы собрали в ходе эксплуатации нашего старого облака показывала что в идеале пользователь хотели бы видеть лучшую степень изоляции и разграничение прав доступа а на подходе был уже релиз гризли с блюпринта микки стон api v3 которая реализовала такую сущность как домен в принципе картинка в лесовоз такая каждый наш клиент получил в свое распоряжение этот самый домен в котором он может может самостоятельно создавать несколько проектов и несколько пользователей и каждый такой домен изолирован от всех остальных проекта свою очередь тоже изолировать таким образом говоря по-простому каждый клиент может создавать много облаков и много пользователей соответственно осталось разобраться с ресурсами ранее используемая нами модель оплаты по потреблению как показала практика оказалось неудобно оказалось удобно только дали достаточно узкой аудитории в которой которая действительно получала от этого немалый профит имея возможность сэкономить на в каких-то фресках потребления но к сожалению такая концепция носила смятение fm и другой части наших клиентов которые даже не могли хотя бы примерно прикинуть сколько будет стоить их виртуалка соответственно здесь мы остановились на более простой модели это продажа я der памяти диска и тому подобное но поскольку раз уж мы продаем облака мы не можем просто взять и ограничить юзера какими-то фиксированным конфигурациями или флэйва риме в терминологию пластик мы должны продавать ресурсы соответственно здесь мы воспользовались systemic вот в принципе вкратце администратор проекта имеет возможность за лимитировать проект сверху по каждому из типов ресурсов сожалению здесь мы получаем проблему если мы отдаем этот функционал пользователю то что же делать нам как же нам за лимитировать его самого заявление на тот момент доменных квот то есть кот кот и их не было еще даже видео блюпринта где-то и отсюда назрела необходимость реализации нашего собственного компонента который занимался бы этими вопросами и так этот компонент было благополучно запилен он по сути занимается тем что привязывает у вас так к реальной жизни в виде уже существующую систему авторизации и соответственно биллинговой системы каждый каждому для каждого клиента создается доме в котором он может там создавать удалять проекты пользователей проще и назначать квоты на ресурс чуть позже этому компоненту пришлось отдать еще ряд функционала например выделение плавающих адресов плоти на пи и белых под сетей это стало необходимым потому что алгоритм выделение флоте настойки таков что клиент имея квоту в один адрес может со скоростью выполнения запроса перебрать весь пул доступных адресов то есть каждый раз он будет выделяться новый-новый-новый соответственно простор для рассылки спама например просто шикарный вот соответственно такие запросы мы проектируем через наш собственный компонент ну и не даем клиентам недобросовестно скажем так можно этим заниматься тем чем они хотели бы заниматься здесь могли бы быть и более простые решения например за лимитировать api сам по себе но это понесло бы уже проблемы и для тех пользователей которых мы уважаем и любим который не занимаюсь такой ерунды и так соответственно следующая проблема вопрос с которым мы столкнулись это вопрос подготовки образов виртуальных машин которым часто сначала никто даже не думает мы долгое время исповедовали принцип в котором операцию систему установится на машину с нуля каждый раз этот принцип великолепно обеспечивает уникальность тех объектов которые должны быть внутри виртуальной машины уникальные всякие ключи еды портится и тому подобное но к сожалению требуют ждать минимум минут 10 пока пиратам система будет установлена пока мы оставили эту концепцию мир двигался вперед и на тот момент мы уже понимали что ожидать 10 минут каждый раз при старте виртуалке это слишком много это полностью ломает те возможности используя облака и создания виртуальных машин on demand соответственно нам требуется мастер образ как же его получить если кстати замечу чуть попозже замечу нам требуется мастер образ получить его можно сняв как мастеркопию вас уже установлены машины но машины сперва надо установить на тот момент поддержки установки виртуалок ce iso образов в пластике не было он приносит чуть позже из первом появился для машин с локальными дисками и только потом авто маме в системе center который управляет соответственно дисками это появилась только сейчас буквально в релизе джуна с помощью системам беде и во двор и это там пришлось немножечко про патчи чтобы это работало как надо соответственно navi была использована простая идея здесь взять маленькую и сошку формата business card размера 20 или 30 мегабайт далее раскатать и на диск виртуальной машины и загрузиться с этого диска ядро интернете загрузится в память инсталлятор начал свою работу и весело за трет сам себя установив его рацион всем он этот диск идея пока достаточно странно но рабочим как казалось соответственно далее мы забили ли инфраструктуру которая автоматически загружала свежую и сошки устанавливаем виртуальной машины снималась не заливала их диски в glance хранилище образов и навешиваю нужны нам свойства инфраструктура была написана также целиком на а пиво конспект здесь я хочу отметить что мы сперва пытались использовать python клиента в посте к они оказались не столь и качественно как нам того бы хотелось во-первых они все разные во вторых они часто не совсем функционале относительно api в итоге мы переписали все на request то есть я и до сих пор могу рекомендовать как бы с этими клиентами особо не заигрывать как нам кажется соответственно хорошо мы получили образ но он является грязным то есть в нем присутствует не уникальный вид партиций соответственно в нем есть ход ключей встреч которая также получается не уникальна все группа таких машин нам это надо чем-то все очистить то есть подготовить диск эксплуатацию уже продакшне скажем так для этого нужно что то что действие выполнено и это что-то это агент который выполняется внутри виртуальную машину соответственно весь этот функционал выполнять наш собственный агент который мы реализовали нашел его к можно было бы спорить использовать клауд и нет мы пока что не нужно такой инструмент который сперва кажется привлекательным потом в нем оказывается безо всяких недоработок он примерно тоже оперу что я об старт в общем лучше не надо для виртуальной машины этот на старте и таким должен выполнить как минимум следующее действие настроить сеть этот пункт выпадает если используется dhcp но если дождь и пинеток кто-то должен прописать статические конфиге клиент это у меня далее нам необходимо установить пароль и желательно делать это secure на кроме того нужно перегенерировать код ключи и видит партиции и расширить диск очередь портится на размер всего диска здесь еще замечу что ключи что пароль внутри между нашими мы передаем в сугубо в виде хэш автоваз никого план текста не используется но соответственно все вышеперечисленные нас агента естественно делает будьте добры садик переключите пожалуйста ну собственно помимо вышеперечисленных вот этих вот глобальных вопросов нам потребовалось решить еще большим достаточно большое количество мелких задач для чего потребовалось как разработанные нами всякие скриптик и инструментики так и те которое присутствовало сообщества примером такого скрипте к который был изначально и сообществом потом очень сильно допилили эта штука которая реализует файла gear виртуальных роутеров то есть когда у нас один шлюз падает кто-то должен перенести роутер на другой шлюз сейчас с этим стал становится потихонечку легче потому что вы простите появился дистрибьютер роутер но раньше этого делать вот таким скептиком в принципе значительная часть функционала которая нам нужна была готова т.к. он потихонечку появилась например это поддержка нескольких брендов для хранилища дисков цензура и реализации ограничения по и общем которые нужно нам в общем-то жизненно необходимо другой функционала он так и не появился поэтому нам пришлось сделать его самим это например почти на поддержку систему квот для глаз охраняющего образов я для него существует blue print и носом но как бы реализации пока папа стыков ходе всего этого выяснились как достоинства так и недостатки но самое главное достоинство это то что учитывая его расширяемости модульность в общем-то у нас не было ни одной такой задачи которые нам не удалось бы решить а недостатки это и низкое качество кода в одних местах и высокая его сложность других местах это целая куча абстракция час которой надо продержаться каждый раз при отладке ну и это заберу протестирована процесса приемки патчи из-за которого скажем так значительная часть наших функционала так и не пока не попала в обстрел у вас просто нет возможности выделить человека который дня у него сидела и ругался с рабочими понс т.к. будьте добры схватив еще в целом хочу сказать что задача в итоге получилось сложнее чем мы думали провозились немного дольше вот и это никак не получилось без команды очень мощных ребят соответственно здесь я хочу сказать что в итоге мы получили совершенно чудесный продукт в котором собой страницу пластика с другой стороны нету цвет и и возни соответственно и нет своего и не надо покупать свою желез и не надо заводить и специалиста который будет сидеть и изучать окон стек здесь соответственно например для разработки присутствуют такие удобные вещи как вы можете сделать отдельный проект облака пупа produce например сделать еще один маленький поддержку и сказать что джуниору россию можно ходить только где в call of product ему нельзя а если придет еще один джуниору пейте тогда можно развернуть точно такую же пола это будет сделано но за несколько минут потому что есть у вас эти готовые образы сделать клон облака очень легко ну и соответственно всякие вопросы вроде развертывания 20 дополнительных машин так напакостить на пару часов это тесто тоже все решается потому что тарификация почасовая и здесь в общем то нет никаких проблем собственно здесь много другого интересного но поскольку у нас конференция все-таки техническая перец и долго не буду этом всем спасибо за внимание соответственно вопрос когда спасибо за доклад скажу просто каково сейчас версию принц так используется у нас сейчас стоит джона как вы планируете обновляться у нас предусмотрена модель rollin кандидату то есть примерно через два-три месяца после выхода релиза то есть мы ждем пока появится пару следующих версий которых будут там обычно по 200 фиксов принимается сразу после релиза поэтому немножечко ждем какой у вас систему если тёплую после выкопки новой версии ли вы это руками делать но частично как бы это делается на уровне папито так частично бывает свои руками потому что одноразового действия их часто не просто нет смысла автоматизировать вашим не одноразовые с какими проблемами в работе с т.к. в продакшен они столкнулись например здесь в первую очередь следует отметить проблемы реализации сетевой по системы то есть их это в общем то можно сказать даже общеизвестно их система плавающих айпи адресов ванильно реализация с помощью виртуальных роутеров она не очень хорошо держит нагрузку на самом деле то есть там и lott nasty растет и скажем так шлюз весьма уязвим банальному туда сам соответственно мне очень нравится вот этот момент то есть мы его в данный момент обошли тем что в качестве решения для продакшна предоставляем самый обычный вилла с прописано не раз сложи 29 потеть угол и еще такой вопрос если у вас поддержку горящую приключений ура тайных машину другую гипервизор если основной падает куда на другой хвост другой хост да естественно то есть еще у нас вот этот ход у вас недоступен виртуаль виртуальная машина будет в холодными прижал руках вас там перезапустить этого реализовали киеве это вы рисовали гипервизор киваем он в общем то очень хорошо имели умеет живую миграцию на самом деле лучше чем зайн который котором у нас так и не удалось побороть некоторые проблемы живой вибрации скорее это связано железом но тем не менее здесь все роботы прекрасно здравствуйте они немного в продолжение предыдущих вопросов да если не секрет из вас инсталляция окон стека какая но смысле по конфигурациям сколько машин она занимает и сколько человек вас обслуживает и но количество хвостов и не скажу вот но для управления у нас сейчас используется три контроллера то есть но соответственно троекратное резервирования сядем падает еще два работают два падает то хотя бы один будет держаться так соответственно все api записываются запущены на вот этих 3-х стах там же база данных реплицируется ну и собственно дальше видимо нужны более детальный вопрос а что вас интересует у нас сейчас получается над проектом работает ну прямо сейчас в данный момент очень наскучат четверо разработчиков я и есть им администратор не очень крупная командам и очень производительны все всем вопросов нет я вопрос массива сергей"
}