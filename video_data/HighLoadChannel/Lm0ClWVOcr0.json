{
  "video_id": "Lm0ClWVOcr0",
  "channel": "HighLoadChannel",
  "title": "Испытание поединком: PostgreSQL vs MySQL / А.Чистяков (ВИШ), Д.Подольский (GitInSky.com)",
  "views": 37144,
  "duration": 2069,
  "published": "2017-05-14T22:53:05-07:00",
  "text": "идея очень простая мы написали на языке Go программку Кто мы такие мы два лысых человека толстых которые занимаются в жизни it и как вообще появилась идея доклада Однажды нам нужно было сделать новый проект и нужно было выбрать базу данных для него вот и Мой коллега сказал что - это база данных а этого Я терпеть не мог сказал что нет не хочу я брать mysql он сказал А почему mysql же быстрый А когда я слышу слово быстрый Я понимаю что как бы линейку придумали уже давно И можно взять и померить быстро он или нет Мы решили что мы помери и сделаем про это доклад и мы действительно помери вот прямо перед вами синтетический паттер социальная сеть ну есть три таблицы Да есть два стула есть три таблиц пользователи друзья и сообщени видите пря так и написано табли тут без не обошлось но вы знаете в паге примерно также создаётся я вот взял маску схему и в пакую превратил за 5 минут выкину ненужные слова тут тоже без не обошлось но ВГ абсолютно там если ненужные слова выкинуть не знаю что это такое Да и третья таблица тоже выглядит вот так но мы видим что у нас есть for и мы эем их у нас обм Обратите внимание на индекс уникальный по фондам и я им горжусь не знаю почему методика тестирования пушка Ну самописная да мы как бы в процессе подготовке к докладу мы как это знаете готовясь к экзамену по чему там по латыни студент медик вызвал дьявола случайно мы случайно написали систему рования социальная сеть могла бы нам позволить реализовать мы не придумали Почему не придумали придумали Ну а какой стандартной пушки такой нет гн почему мы написали свою потому что мы любим язык Go во-первых Ну точнее не то чтобы мы его любим мы на нём пишем и мы решили что нам надо графики рисовать красивые и нормально В общем репортить метрики с нтими и всем остальным ум это удалось мы умеем СМИ Рива мы используем современные методы сбора метрик Да и хватит об этом да на языке тест-план описывается на ял Ну я не знаю важно это или нет это чрезвычайно важно потому что можно будет в эту пушку любой тест-план затолкать чем мы будем заниматься в ближайший год видимо вас призываем в этом участвовать потому что нам кажется что получилось клёво мы может быть потом покажем е потроха как-нибудь может быть даже сегодня Да у нас я уже говорил что современная система сбора трики снимаются только с пушки опубликована натурально она в этом самом гитхабе А давай ты дальше будешь рассказывать а я буду запускаться Значит так конфигурация тестового стенда мы решили не мелочиться четыре машины 192 ГБ оперативной памяти каждая был такой план сделать две пары Маер с для мускула номы не справились по разм Прим сегодняшний день никаких дисков кроме SSD уже для базы данных не бывает Поэтому взяли две сдх в каждой машинке по-моему они там в мирро Но честно скажу это делал наш сисадмин Роман поэтому я не помню так для пушек для каждой пушки в связи с тем что мы собирались запускать их в параллель две машинки для по одной для каждой пушки эти Машинки пожиже Это 32 гига оперативы какой-то SSD который понятное дело в деятельности пушки никак не участвует Ну вот как-то так одну машину такую же как машину для пушки пушек мы взяли для сбора метрик и поставили на неё Прометей знаете да что такое Прометей на этой конференции было четыре доклада про Прометей оборудование предоставлено компании Север с которой у нас давние хорошие связи Вот покупайте наших слонов Итак эпизод 1 эпизод О мы запустили Что такое мы запустили это пустая база это дефолтный вот прямо как вот ставит у бунтов ский такой вот конфиг у базы данных у одной и у другой скорость поступления запросов в связи с ванною времени вот этот вот плавный ро количества запросов зависимости от количества запросов в секунду мы вам продемонстрировать не сможем поверьте он есть но продемонстрировать никак поэтому сразу вот сколько база запросов принимает столько мы и обрабатываем вот на самом деле вот одновременных клиентов сколько база выдержит тут написано Нет плохо наша пушка падает в связи с тем что падает При таком раскладе драйвер мускула в Ну пост собственно тоже падает они все примерно одинаково устроены если не лимитировать Connection Pool то драйвера падают и значит 128 на самом деле клиентов сейчас и на всех во всех остальных эпизодах 128 Давайте посмотрим вот сейчас я попробую Вот это же количество общее количество запросов сейв нуть Да это сейв это сейв отлично давайте я сейв от греха это это вот можно как-то показать во весь экран так вот да а Вот видите и такую же можно рядом открыть сейчас так чуть больше 20 сся квери персе и вот он начал проваливаться мы видим да по многим разным причинам А вот у поса кстати не тюнино ситуация получше да да чуть больше п видите А вы говорили победит не победит мы будем продолжать И вы говорите вот ну за спой у него вот в нет конфигурации вот эти вальки они сейчас регулярно начнут происходить Я так сильно подозреваю что это потому что у меня файлы дефолтные стоят Мега мегабайт Да и оно там не успевает просто чекпоинт есть м при поверить нам на слово Алекс расскажет что он именно сделал с кулом 192 значит он поставлен из какой-то и по-моему из прямо постгрес официальной репы внту 1404 Да пог 95т самом де я мраза лоде осенью Я докладывал про ртб и там у меня был mysql И mysql этот обеспечивал мне 100.000 апдейт в секунду вот причём это были довольно сложные апдейты с триггерами и с н ключами потому что мне надо было обеспечивать равномерную открутка баннеров их у меня там было что-то по-моему 10 Милн строк В этой таблице это было на хне 32 оперативы Сата 17 даже не Нет это не было важно потому что я же включил каширование записи отключил значит здесь мы просто не успели на это посмотреть честно вам скажу вот а там что-то в районе 200 гигов Ну вот видишь я не помню то есть это было больше чем оператива но индексы все лезли в орати вот всё что я помню про ту конфигурацию Да и упёрся я там надо сказать в процессор Гра показал мне что это процесс обновления индексов Ну вот съел все четыре ядра какие были в этом i7 Ну понятно да что если бы ядер было больше то я получил бы больше они плавно растут Скажи у нас есть там строки где-нибудь Метрика такая Сколько строк на тот момент когда мы приш очищали базу перед докладом в ней было 22 млн строк это мы туда напихали примерно за час размер строки до 4 КБ там ро случайной длины строка была Ну средний соответственно Да наверное потому что минимальный был 10% впер сюрприз сюрприз ой спри чуть-чуть больше 25к ну местами чуть больше чем 30 А местами чуть больше 2п ну 35 да Ну действительно смотрите я я могу ещё сказать ему чтобы у него автовакуум наступал почаще например чтобы он был помедленнее не это неправда не не будет Нет на самом деле конечно автовакуум который наступает почаще поможет вам на Большой базе на базе такого размера автовакуум ничего пока не сделает полезного К сожалению ма сль разгоняется там я смотрю Остановите его давайте что это что это такое вообще Ну давайте предлагайте Что сделать Я же здесь с ноутбуком Давайте придумаем Придумаем что Помогите Алексу у нас просто как-то так очевидно myq вырвался вперёд Ну это ничего сюрприз в этом нету у нас очень как бы это сказать очень вырожденный кейс Мы очень много инсерты практически не апдейт и селекти по индексам исключительно То есть если бы там был хоть один селек програм например полнотекстовый поиск какой-нибудь Выключен Выключен конечно мы бы наблюдали совсем другую картину совсем а запросы значит там есть инсерты в юзеров там есть инсерты в месседжи там есть инсерты в таблицу с френда и там есть селекты прямо сейчас вот на этой стадии там есть селекты из таблицы межей Ну соответственно сначала саск из таблицы НВ потом Селект из таблицы межей по там даже ордера и лимита сечас Слушайте я придумал что можно с пасом сделать можно его потова на тему кэша а шерт бафер ему надо задрать вот что во давайте я сейчас шерт бафер у меня же память до дури вот сейчас так и сделаю Не ну очевидно тут нет никаких блокировок потому что сначала они шли голова в голову А ну да ну в смысле вообще по теории бывает да Ну вот тут очевидно всё в порядке тут очевидно мы ограничены сервером а не клиентом А можешь показать что вставляет потому что в у вас вставляется большей частью френды что довольно странно Ну в смысле у вас 30.000 фредо в секунду при это вот мой друг Алекс нарисовал стратегию так она и происходит так он лысый я лысым не доверяю Сам ты лысый значит я могу показать наверное на самом деле ты можешь конечно сходить сам посмотреть на это Ну давай попробуем так вот идём сюда говорим что хотим новый Тап говорим что хотим здесь UB Мы хотим UB иди сюда UB ой уйди уйди от меня Ха Вот вот это всё мне не нравится дадада приватные репы нас не Интере сейчас ловят там была группа и в гитхабе не было так и что я должен теперь сделать для тебя дружище должен наверное сделать вот так похоже на прав так это АСР Ну то есть нет На самом деле - это ВМ случае и в 95 появилась соответствующая конструкция с другим немножко синтаксисом она там тоже используется вот ну Дело в том что у нас же есть этот самый уникальный индекс компа и соответственно нет никакого смысла делать даже и на этом месте нет никакого смысла и делать иде тоже вше а вот это вот Рандом в рамках максимального значения этого сикса тоже внутри Гоше чтобы не выбирать его из мускула держим держим Ну то есть не мы а Гоше это делает Ну я не знаю как тебе помочь теперь по-моему у вас там конфликт Это не я не это безусловно ял но может быть это не очень правиль нет всё там в порядке разго раз его ял Пашечка значит это ял вот такой Селект реальной жиз поз может быть фнв просто в массив бы запихал для юзера тогда бы оно работало повеселее побыстрее вообще без этого Попро быстрым довольно много на такой базе и на таком количестве строк нет способа сделать постгрес быстрее мускула есть способ сделать постгрес примерно так отстающим процентов на 10 иногда на п вот когда база станет терабайт вот тогда ситуация изменится Вот с таким количеством таких прох интов кстати интересно посмотреть на 96 где обещают как раз на простые инсерты и простые селекты чуть ли не 20% прироста через год 96 уже какой через год в сентябре релиз Ну хорошо давай мы сделаем всё то же самое на лот без меня без меня так а они на этом случай просто апдейты будут фигачит и там тоже мой SQL выйдет вперёд Алекс Ты в каком состоянии я смог сейчас я запускаю обратно дадада сидят в Одессе люди втроём ждут четвёртого играть в Домино а он всё не идёт наконец прибегает его внук и сказал дедушка сказал что если сможет то не придёт Нил А где здесь количество запросов в секунду вот в этом красивом ям ой-ой-ой в этом там кое-кто подг нал по до 60 Ну 50 к запросов в секунду Сейчас посмотрим сейчас посмотрим так вопрос Ты задал вопрос Нет там в этом ям сейчас Нет ограничения потому я уже говорил не знаю не знаю как прокомментировать эту картину до 30 практически Ну вот оно до 4 обратно задрало Алекс Ты выключил что нет я не выключал Зачем У меня там кэш с батарейкой не надо выключать с батарейкой там хорошая Сха нет тут немного нам даст К сожалению нет я задрал как у ме гиба ТС H PES у меня в принципе есть ещё сколько-то времени для того чтобы найти как это делается H PES вчера был целый митап в отличие от меня ты на нём был Давайте посмотрим как там мускул себя чувствует Да мускул то понятно всё проиграл уже так я надеюсь Ну сюда так мускул Ну да муку пло стабильно плохо Ну не то чтобы плохо нет я могу ещё кинуть в принципе А может Т начато более простых вещей вки прочее а вот скажите сколько у нас осталось минут Полчаса только 15 минут что ли и накатить свой конфиг мускула из ртб конфигурации и посмотреть что будет ну там же наверняка написаны страшные слова какие-нибудь типа отключить Син там это я на уровне файловой системы обычно делаю Куль глупый он так не умеет нам это не даст ничего на сам деле нам это ничего не даст У нас сейчас с мусло сделано следующее я же кстати не сказал что я с мусло сделал Я ему сделал замечательную настройку которая очень длинная которая это синхронный комит у них делает Я поставил в двойку дадада и на db я её всегда ставлю в двойку Я вот боюсь боюсь что эта конфигурация осталась на внешнем винте я ему докинути размер транзак логов оставил 28 МБ больше я с ним ничего не делал ему сразу стало лучше так а постгрес постгрес стремится вернуться в предыдущее состояние тем временем да да посмотрите Посмотрите коллеги как отвратительно это выглядит А вот эти ступеньки Я не знаю откуда берутся то есть Давайте попробуем что-нибудь Давайте сечас посмотрим вакуум так часто С чего бы а мы много вываливается сколько там каунт Он же не сейчас сейчас сейчас сейчас по каунт мускул будет вставать намертво конкретней что там у меня-то вообще 50 Ну логично это в принципе давайте давайте посмотрим что у нас там в этих сейчас попробуем посмотреть Ты знаешь может быть имело бы смысл как-то прокомментировать А давайте Кстати на посмотрим действительно Ну смотрите у нас нли нарисовано поскольку мы любим всякое такое как это у нас есть лазерная указка Да на красный палка можно тебе в глаз льну ей Ну собственно всё очень просто здесь пятипроцентный персель 95 и 9 значения выражены в микросекундах То есть 40.000 микросекунд - это 40 миллисекунд всего-то навсего Ну и что тут можно сказать это вот у нас кто был постгрес 99% запросов за 40 мсн укладывается А так надо запомнить эти числа а в масле зараза удивительно Удивительно как же так а в мас нет слушайте что-то реально рвёт вообще как-то он быстрый вот Наверняка Наверняка просто у просто хуже драй сенные вставки в юзеров секундные приэтом юзеров вставляется 100 в секунду причём они как-то так были были Да и потом начали нормально работать Ну да вот он как-то Да вот почему-то вот так вот сделал объяснить Это я вот не в состоянии даже с помощью графа и фа Я не понял почему он так себя странно ведёт решил что просто буду с этим мириться то есть он через какое-то время перестаёт себя так странно вести по непонятным причинам Ну видимо видимо там тоже есть какой-то этот самый оптимайз на таблице который её приводит в какое-то состояние в котором она дальше живёт Давай вернём погас обратно я не могу это видеть да Ну вот ещё одна загадка для меня лично Почему растёт производительность Ну вот почему что это скрыты резервы Я думаю что тут без мельдония не обошлось как может она думает что если она быстро закончит выключи блин а тут как-то всё это да тут не ну чутка чутка похуже надо скать честно вам скажу я этого теста до сих пор не видел я ожидал что постгрес будет где-то тут вот но видимо я его раньше гонял на машинах сильно слабее этой поэтому поэтому вот так что я могу сказать результаты стабильные всё Ровно количество коннекторов там заряжено везде и там и там причём в масле я даже не тюл ничего он оказывается из коробки можно лько коне держать много в пагс я поставил 800 на всякий случай сейчас Да мы попробуем сейчас действительно увеличить и посмотреть ну там уже на машине А кстати я сейчас могу вам какие-нибудь чище сказать самих машин я сразу вам скажу не означает ничего Мы совершенно сознательно не ставили не пер потому что недостаточно длинный доклад чтобы и это в него уместить знаете примерно одинаков что там 33 что там там 36 Но это же ни о чём это ничего не говорит нам Кроме того что процес используется Кроме того что используется ввод-вывод память Ну память сейчас скажу память есть надо смотреть же файловый кэш и надо сказать что постойте А почему 192 Т 32 сколько двас выдал Не 32 натурально 32 это На пушке нет на Лах 32 вот почему у меня не запустило ничего на Лах 32 Да накинули вообще за4 не в своп Нет там нет свопа нет нет нет подождите Я же перед тем как вот те 192 что были на экране Я выдрал из экрана конфигурации в сервер не постойте ну реально фри показывает 32 Давай давай убедись вот фри минус H Нет ну как мо ското Запусти 31 может быть постгрес остальную съел Не не натурально надо требовать возмещение ущерба мы потеряли лицо таким образом Пусть нам два серверок так отдаст за бесплатно а он и так отдал за бесплатно да да не существующая так сказа Не ну это очень странно Очень странно что тут их 32 коллеги я не могу это объяснить Давайте посмотрим как там дела Тем временем потому что вот это вот вот эта самая картинка вот эти самые 192 именно с этого сервера были выдра страниц конфигурации ну его заменили просто пока Мы спали тут очевидно же всё а конект не упал почему это крутая технология Ну вот вот это слушай наверное можно уже видимо два сумеет как-то выдёргивать поме живую да да пушка пушка работает в одно ядро примерно ну в два ядра То есть ни сколько не используется ресурсов ядер на Ош памяти 32 куда Дева разни мы знаем вообще коллеги задача оказалась значительно более чем мы себе месяце назад представляли Мы думали что мы за пару дней справимся мы написали первую версию пушки за день после чего не сумели к этой версии пушки написать стратегию поэтому мы написали Стратегию и стали писать пушку к стратегии мы писали пушку с перерывами на аврал и вы на проектах на которых мы задействованы в течение неде переписали её заново потому что оказалось что она работает плохо в Ну в том что мы очень многого хотели от стратегии Мы хотели чтобы она Сначала мы просто хотели чтобы она с разной вероятностью выбирала запросы из Пула и их херачить что мы хотим сценарии да то есть последовательности запросов и их с разной вероятностью 256 я поставил вот можно смотреть что происходит да конкурентность 256 и они там Молодец Так значит что На пушке которая видимо с 01 это му мускульная пушка с 0 - это вообще не пушка с 02 - это пушка и с 02 - это мускульная пушка Да а что Ну меня просят выяснить сколько там чего я же сказал там в дна работает сейчас вче наверное Давайте подождём пока всё это устаканится А я пока зайду на мускульную пушку Слушайте а как у вас упал девяносто девятый процентиль инсертов фнв на увеличение коннекто это вы вообще как считаете процентиль Это же не мы считаем а Прометей это Прометей считает НТИ А вы в Прометей Циферки складывает Откуда вы их берёте Ну это разница между стартом и концом запроса Откуда мы их можем брать ещё ну то есть она упирается в ожидание числа коннекто Ну ты смотри ты просто увеличил количество коннекто у тебя де девку я уверен что Алекс увеличил не число коннекто а число рутин Да вот этот параметр в Стратегии который показывает ти може о не влияет АНО заметно Ну это то место которое както ш магия мы не знаем ш свободно 85% процессора большая пушка занимает 25 гиб оперативной памя нет да 25 МБ оперативной памяти вот если хотите я схожу по происходит На постгрес пушке но скорее всего происходит так что что Пойдём посмотрим на муку которому дали 256 Конев Давайте посмотрим Ну постгрес возвращается упорно в состояние в котором ему нравится пребывать я усматривают да это правда и у нас подскочил де п Деп перти подскочили Ну логично это да это вот наш мускул перестал справляться с таким количеством коннекто И кстати заметьте Ден посл наконец-то Да на мус с маску элив обработки ошибок Я помню у меня такое было когда в масле карати немножечко И надиби он не может запуститься он говорит у вас что-то тут плохо в базе работать не могу не у нас есть Волшебный mysql на 500 ГБ и 400 млн строк и там в одной из Больших таблиц на 200 млн строк есть диапазон при обращении к которому всё падает вот мы его исключили из рассмотрения хит об У нас есть Вью которая мимо этого диапазон читает мимо причём бэкап бэкап вот этого инстанса сделать нельзя штатными средствами myq Потому что когда myq Dum или что-нибудь там доходит до этого места он говорит Ой привет Да и начинает заново Ну просто выключает сервер да Но даже в те времена когда п с штатными средствами этого маэля проходил Он восстанавливался неделю держать неделю белог чтобы запустить таким образом слей нам вот никак не удавалось там ещё весело было потому что мы сделали ну в какой-то момент мы повзрослели поумнели и сделали bas replication в масле оказалось что когда вы часто делите все записи из таблицы то у вас слев который работает в один поток и применяет как бы построчно или мы тратили мы тратили наверно трайт разворачивался в Del и приезжал на слей и начинал исполняться В итоге у нас слей отставал в течение ВС больше больше и больше при этом нечеловечески задал бывает диск а ночью он иногда догонял а потом перестал Ну да В общем как-то так то есть так 25000 всё-таки Вот 25.000 купс И ниче это пог это постгрес и вон простите меня пожалуйста девяностый персель растёт самого мускула спросить сколько у него клиентов давай пока я т смот Давай какой-нибудь заем вывод из всего этого безобразия так вывод из всего этого безобразия значит что мы видим стабильный 25 а что до тюнинга что после Это означает что мы не умеем тюнить постгрес так стабильные 30 что до тюнинга что после Это означает что Алекс не умеет тюнить так он же за Да 151 25 и 30 честно вам скажу это не разница то есть есть смысл под свок про есть смысл вот такой мой личный Вывод я для себя его сегодня сделал есть смысл брать пос Почему Потому что вот эти вот ну сколько это 1 Да это 1/6 К тому моменту как база по-настоящему Да так вот 1/6 вас ни от чего не спасёт но зато Когда вам потребуются например функциональные индексы вы не будете бегать туда-сюда и рвать волос здесь показаний поста мастера постгрес Должен был Должен бы демонстрировать меньшее отставание насчёт Сва от мастера пост Малу используют принципиально разные способы реплицировать вообще некорректно Ну хотя бы потому что в поровски слей вы Писать не можете в принципе а а мускульный можете И на самом деле я честно говоря как бы ска юзкейс для дамы Ну где-то лет года год два назад из из мануала наконец ушло что это не рекомендуемая штука Я задолбалась говорить что это не рекомендуется лет я не знаю сем назад Ну для этого есть раунд это конечно же неправильно и всё такое прочее но дело неё Дело в том что архитектурно То есть у постгрес физическо репликация у ма Сэла репликация при помощи дополнительного лого Это просто как она решена и они делаются в общем-то для разных как бы задач для одной и той же задачи снять дам с базы они делаются больше ни зачем с не нуже снять базы Вы можете использовать myl и не использовать My сервер вообще это если вы хотите снять дамс база с Большое спасибо двум большим людям Спасибо вам L"
}