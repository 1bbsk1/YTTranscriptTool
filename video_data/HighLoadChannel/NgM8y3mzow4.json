{
  "video_id": "NgM8y3mzow4",
  "channel": "HighLoadChannel",
  "title": "Эксперименты с Postgres в Docker и облаках / Николай Самохвалов (PostgreSQL.support)",
  "views": 2429,
  "duration": 3388,
  "published": "2019-05-15T02:51:25-07:00",
  "text": "мой доклад а tps эксперимент по английски но если его так нас то за него плохо голосуют приходится расшифровывать вот ну то есть по русски экскрементам базами данных ничего лучшего пока не придумал и конкретика этого мы крутим пост в докере иногда в облаках иногда и локально по-разному и с разными целями для оптимизации для проверки разных идей и для всяких других целей тоже кстати для бэкапов тоже можно было бы на верность проверка бэкапов тоже вопрос можно было бы использовать немножко пару слов про себя карьеру minor уже лет 15 больше даже и в основном узор очень много с базами данных дело имел хотя пришлось побывать и сетевой все разных социальных сетей и отвлечься немножко техники лет на почти 10 вот там социальной сети в указаны некоторые также rupes гости если кто-то в плоскость . орк если зайдете там увидите метод группу нашу который к численности обогнала сан-франциско я не устаю не устаю этим гордиться хотя последний минус активность немножко замедлилось но думаю мы все таки будем продолжать и youtube канал руб он здесь тоже призываю всех зайти там но если вы после сам интересуетесь там 300 почти 300 290 же с чем-то видео там собираем очень но все что на русском языке там все конференции хайло там есть очень быстро полосам интересуетесь постеру плоскость поищите на youtube вот но сейчас я в там проживаю и занимаюсь тем что там второй раз короче стартанул свою практику консалтинга попал гасу о здорово full house вы проходите туда может или ничего страшного если я всем пока так значит а вот два года назад или три где-то примерно я стартанул опять практику по прозвищу консультирую вниз на этом стартапы сейчас уже энтерпрайзе начались и у них все очень интересно нас сказать что под колеса очень популярен самое главное то есть я тоже не устают повторять после супер популярен на популярность растет среди стартапов это выбор номер один по умолчанию по сути для сигналов проект вот и вещи этого года только все началось это после сия это платформа которая призвана дополнить все облака то есть если вы видите менеджер пол вес плоскость в облаке которые за вас решают задачи про режиме нга backup of replica иногда и фолловеры автоматического то это только часть проблемы а кто будет заниматься оптимизацией подбором настроек анализом запросов в общем вот кто всем этим будет заниматься это в общем это тоже нужно автоматизировать потому что реальность такова что будущем вы будете управлять ни одной базой и там двумя да а там десятками и более особенно если мексика сервиса всех накроет что мы уже наблюдаем у некоторых людей до и после смен пожалуйста подписывать все твои если вы в твиттере бываете подпишитесь пожалуйста на меня зачем нужны эксперименты над базами данных not разберем простой пример как вообще мы сейчас проходим проблемам производительности как его в в обычной жизни мы это делаем вот есть мы до слева справа есть какой-то про то возможно у нее есть мониторинг возможно нет права у разные тоже наблюдаются ситуации ну как правило есть некоторый мониторинг и он нам счет присылает какой-то лед пришел и дальше мы там что-то еще ручками там посмотрели дальше возникает вопрос что чтобы понять что реально происходит но приходится лезть внутрь анализировать запросы то есть братья вот лупу и и с этой лупы по базе лазить и для анализа запросов у нас есть по сути всего там два основных подхода этапе g-100 statements с дополнениями тип в виде пересадки кэш там и и как остаться и общем и так далее проблемы с реализацией statements они понятны и да то есть это абстрагирован ее запрос нет параметров мы не знаем на самом деле то есть каждый раз когда я вижу что люди ну да и сам тоже использую перестает нас нашел тормознутый запрос что дальше мы не можем взять его в экспо и подставить понятно да то есть это очевидная проблема то есть мы должны какие-то параметры забрести а какие потому что параметров зависит план select звездочка фронте был в горах больше ? а ? зависит да заходите а знака зала ? зависит будет это секс канале индекс к например да ну понятно и даже равно ? если это это равно приводит краска ну почти все таблицы то пол из поймет и сделает всех сканы если это происходит вообще а чего не голосовали за доклад вот почему я в этом зале вообще то есть но я сам не знаю я сам виноват это без эксперимент голоса голоса пошли вниз я быстрый к переименовал по-русски написал голоса пошли вверх на был опознан поэтому в этом зале я казался ошибку совершаю прошла с то же самое было на английском написал и все таки они не православно окей ну мне это нравится на самом деле чтобы много людей хорошо знаете 30 нас понятно нам нужно примеры по примеров нет ситуация надеюсь будет исправлен есть патч отпускать про лет кого-то еще не помню точно которые будут примеры привозить разные там типа самый плохой пример основных хороший пример для этой группы запросов перед состав вот ну и планы то соответственно тоже ok второй подход мне очень нравится но и его тоже проблемы это анализ логов когда-то давно в древние времена у нас был перерыв уинн сейчас у нас пейджер написано напирали он все еще развивается это удивительно пока я готовила то так ватного версия вышла 10 он требует вот сколько раз слышу шоу есть что-то получше чем реджи беджера потому что его же постоянно надолго сильно тва ливается получил толщину короче его надо поддерживать он он не не как прежде сосед нас внутри и все работает и он естественно некоторые задержка у него есть к ментальный подход но он задержкой то есть он не real-time показывает опять же нет планов если вы не включили of the xp ног тоже включить на продакшен по полной а сэмплинг да там пока нет и не полноценная картина потому что мы не лакируем все потому что блокирует все в некоторых случаях ok но об этом мы будем говорить что что бывает когда логировать все и когда как это как это как с этим жить то есть у нас обычно запроса только которые медленнее там допустим 50 миллисекунд 100 миллисекунд только героем только их и видим соответственно всю картину потому что может быть какой то запрос который занимал там 40 миллисекунд но он был миллион раз вызван в минуту и очень все стало самым главным игроком в плане проблем проблем производительности в общем понятно да проблемы эти я думаю вся эта боль понимают сейчас да значит вот допустим мы нашли ну вот эти проверки делаем то есть мы нашли подобрали какие-то параметры и пошли проверять куда мы пошли в большинстве случаев когда от человека не набил уже шишак он пойдет к себе на ноутбук или там на workstation где база 100 мегабайт и в общем план совсем другой очевидно в других случаях тоже постоянно наблюдаю это наоборот очень умные люди они им достаточно продакшна все на продакшн даже мы мы сейчас индекс построим никто не заметит а если нужно отдать проверить и транзакцию откроем отдает проверим косплей на мой сайт а потом rollback все хорошо это это до смешного так как мы живем сейчас вот четыре способа всего у нас есть это тюнин конфигурации это добавить изменить набор индексов это поменять сам запрос или схему это самое сложное наверное и побольше ресурсов наверное на голосование простой но зависимости от того какой кошелёк у нас вот всего четыре способа если знаете 5 скажите пожалуйста мне очень было интересно тоже проанализировать во всех этих случаях мы можем делать более промышленно так сказать более более взрослое делает не гадалка от гаданиями а экспериментами разберем эти вещи после чуть подробнее а тюнинг приближаемся к тремстам майской уже выше 500 ручек ну который можно тюнить конечно не все они касаются производительности там некоторые из такие че служебные но очень много разобраться без опыта лет пять очень сложно или без предыдущего опыта других особо до индексы в общем благодаря плоскость про в частности индексов очень много тоже бывает и их нужно тоже у них есть еще опция есть топ класса и общем это все тоже не очевидна и требует глубоких знаний но главное у нас как правило нет про нормальных по полноценных проверок в реальной жизни или они очень узкие ограничены но выстрелим и одним explain a loser ну все хорошо поехали в обычное дело и в итоге она мы получаем в оптимальные или даже вообще не оптимальное решение далекие от оптимальных именно поэтому тебе это черной магии потому что нужно много знать и когда тебе уже опытным просто так хоп хоп хоп пропустил и вот интуиция сработала да но я верю что эту интуицию мы можем можем формализовать чтобы потому что и интуицию мы ее общем себя не разложишь да но это нужно постепенно делать будет в общем это такое вот видите некоторые да так пример из жизни простой пример вот читаем бог поставить его дефолта с extabit 100 это как-то маловато стоит от 100 пакетов для каждой колонке после сбудет staz the bucket of хранить поста статистике соответственно иногда данных очень многое стоит уже недостаточная точность хотя хотелось было 1000 например классно в статье об этом прочитали в блоге каком-то применили наблюдал ее у себя в голове такое и у довольно хороших интересных проектов крупных стартапов ну прям серьезных и в продакшн соответственно несколько запросов провели руками теперь потому что не удивлению есть писк берлин есть экспонировать проверил поехали в продакшн отличная идея production но вот теперь вот как как у меня это было там мы сделали хорошо а теперь вот в этом году меня такая много сижу дома все таки вот теперь у нас есть средства эксперименты у нас есть подход чтобы узнать нас так как на самом деле повлиял это все как повлиял изменения переход от ста до тысячи в целом проверим с помощью эксперимента фото это интерфейс по-прежнему такое не очень в общем слева это 100 прогон а справа это 1000 и прогон это ну это реальная нагрузка с помощью логов собранная в общем мы видим что у нас улучшение в целом есть на 8 процентов в среднем по больнице там две тысячи запросов гонялась всего девяносто семь групп получилось когда вот ну прежде состоят на девяносто семь групп и мы видим что стало лучше да вот здесь слева 100 справа 1000 стало лучше но дальше у нас вот в этом интерфейсе мы можем смотреть каждый кори группа сортированы по тот all-time в этом прогоне первая группа ok 2 группа китае терке и 4 смотрим hop 4 на 88 процентов хуже то есть была она была total duration 2 минут а в сумме эти запросы отрабатывали сейчас почти 4 вот у меня же есть это вот почти четыре минуты здесь что то есть при старте force российских stargate 102 минуты отрабатываем а так почти 4 руками проверяем так и есть дальше мы можем просто на самом деле если нас нет времени мы можем даже не думать почему так там был джон яндекс по тексту поиск допустим мы даже не думаем почему так мы можем просто сделать alter стоит altera тайбл оба можно еще alter index а кстати сделать и просто сделать колонки стс статистика обратно 100 конкретные колонке мы вернули старое значение опять 100 пакетов проверяем ручками фсб опять стала ну сработала за тепло или то есть мы про пачелли наше решение старая которое приводило в целом узкого улучшало но вот конкретное место ухудшало то есть вот ну имеет смысл да то есть вот взгляд в целом теперь отступим немножко в сторону от как вообще происходит управление изменениями в более развитых областях чем database administration огнестрельного сдано да потому что я думаю что мы живем в пещерном мы вообще в пещерах живем и в каменном веке до сих пор в базах данных потому что вокруг у нас уже все там себя сиди губернатор все эти в сеансе был там все автоматизация она по-прежнему ходим 1 запросы к спинам смотрим вот ну то есть посмотрим на другие области note of соседей например да у нас куча всего есть то есть уже настолько развита что без этого уже мы не мыслим себя то есть если у нас нет автоматических тестов если мы по-прежнему тестируем руками но это как бы 20 лет назад так и делали сейчас уже так делать нельзя и все уже понимают что обычно вручную ты обязательно что то пропустишь нужно писать тесты кто знает что это такое да органическая труба правильно то есть несколько это такой дом двигатель это окна мической а труба то есть в в разных там областях она применяется это на самом деле такая же идея у нас есть некоторый образец модель иногда она бывает полный рост иногда он бывает масштабе поменьше то есть моделирование нагрузки и дальше у нас есть дополнительные средства вот сейчас в об этом краз разговор чем чем отличается от эксперименты в других областях у них есть три главные характеристики первое они не production ну не можем мы продакшна проверить какую-нибудь вещь который нам там если это кокос mazda мы не можем некоторые вещи делаются там конечно но они сначала готовятся моделируется если вы смотрели там аполлон 13 помните у них там бады аварии и на земле люди экспериментировали чтобы предложить уже готовое решение они они экспериментировали на копиях данному длинному лежат как там что с чем стыкуется а потом уже им выдавали решение то есть мы должны лабораторию сделать или можно назвать это стайлинг и второе есть детальный анализ то есть иногда чтобы сделать детальный анализ мы должны использовать инструменты которые нам испортят производительность в случаях лаборатории обычно мы можем сделать так что это ну то есть во первых это только нас аффекте то нет юзеров да и второе мы можем смотреть разницу то есть мы можем сказать о кей 20 процентов медленнее станет но мы проверим несколько вариантов и в целом ухудшили да но мы зато нам важно относительное изменение они абсолютные значения производительности там теперь встал у нас не 10000 там а 8000 но зато мы видим что если мы вот эту ручку меняем у нас все улучшается а вот в ту сторону ухудшается то есть есть инструменты для детального анализа которые могут мы сами обзор и факты так называемые то есть они сами влияют на производительность мы не можем этого продакшене допустим сделать и третье мы хотим чтобы это было был конвейер то есть мы хотим чтобы то есть мы видим это в других областях запуск эксперимента люди стараются максимально удешевить чтобы это было быстро чтобы это было не как можно дешевле что можно было много-много прогонять сейчас когда мы говорим про ручной запуск мы можем сами склонировать базу rds то кстати позиционирует вот облачный облачный полк гости позиционирует что вы можете сделали клон за промыть или пожалуйста экспериментируйте на нем на самом деле я вот с этого тоже все начиналось я я обратил внимание как классно с облачными базами заправить этот клон нет ни о чем нет никого не спрашивая их железок за промолчите реально проверить все свои идеи получить реальные планы на большой базе и дальше все хорошо но руками все это делать опять же это все ручное это долго и просто дорого получается вот поэтому автоматизации здесь дополнительно обязательно нужно я хотел сделать демонстрацию но на потерял свой переходник поэтому приходите завтра в 4 на митап программки найдете место мы обязательно сделаем демонстрации то есть демонстрация будут есть опыт собственно инструмент который мы заметили пару месяцев назад и сейчас активно развиваем называется нэнси и командный интерфейс сейчас мы о нем поговорим то есть вы можете просто проводить эксперименты над своими базами ссылку я еще раз много многие слайда будут повторять завтра в 16:00 приходите будем смотреть как это работает это то же самое то же самое по сути интерфейс но графический тоже для работы формочка запуска эксперимента тут есть четыре вещи мы сейчас их обсудим в общем из чего состоят эксперимент немножко теории первое нужно принять среду где мы где мы запускаем как какая какое железо пиццу на система версии какой позе как какая версия позиции какая конфигурация второе нужно скормить какую-то базу этому делу да то есть нужно в идеале это клон продакшна причем клон не дамп restore не логический клон а вот как из бэкапов можно взять это то есть большинство инструментов бэкапов позволяют за праве женить с бэкапов то есть у нас там сохраняется bloat у нас физические данные также выглядят в идеальные идеальный объект выглядит именно так 3 нагрузка здесь есть разные варианты мы сейчас об этом поговорим ну грубо говоря это начинает одного запроса кончая тем что у нас есть инструкция гонять параллельно кучу запросов и четвертое это то что мы проверяем допустим идея покрутить дефолт вас есть x таргет это наше изменение но у нас он называется дельта вот или там создать индекс кстати но когда вы добавлять индекс можете по замедлить некоторые запросы то есть один запрос ускориться другие замедлятся опять же руками это вычислить очень сложно бывает в результате что мы получаем вот нэнси привозят вам некоторые самарин утром 1 пишет ну там сколько времени заняло сколько был прогоны так далее сколько было запросов наблюдаемых то есть можете уже быстро понять стало хуже или лучше второе приводится там уже нас там 15 артефактов этой конфиг мозга стал психологи блоге подготовки логе самого прогона что там еще всякие снимки перестав всех таблиц включая перестал statements отчет пейджер потому что пережил внутри и так далее а ну вот и подробный анализ это один из артефактов просто ключевая вещь и мы можем по нему сравнивать не не в целом сколько времени а вот конкретно по каждому запросу то что вы видели мы можем взять самый тормозной запрос в первом прогоне посмотреть каким он стал во втором прогоне как-то изменилась и свиделись его показатели когда мы говорим про здесь про группу запросов это имеется ввиду либо группа из причин сосед нас либо из пиджи birger у них есть отличия конечно но в целом я надеюсь вам логика понятна да если какие-то вопросы ну да вопрос лучше конце значит вопрос такой можно ли это сделать с того что у нас есть ответ можно блоки существуют у нас есть докер нас есть пиджи реплеи пи джи пи джи bench на самом деле здесь надо писать у нас есть перестать много чего включая дополнительно решением в виде 50 стоит мыться пересадки кэш авт explain что блокировать планы есть и джинджер для анализа логов а если мы хотим налогах основываться и у нас есть такая волшебная штука как спорт в инстансы в амазоне надеюсь когда-нибудь и яндекс их за перед такое вы можете там до 78 процентов скидку мить получая instance без гарантии то есть это такой вторичный market короче по сути простаивающие мощности они продают по задешево но при этом вас нет гарантии что он не исчезнет что и сейчас там ну там есть некоторые ну типо типо аукцион да кто меньше платят от толпы первым при прибьют и до в нашем случае мы можем себе позволить у нас прибьют потому что эксперимент но мы хотим мы их проводить многое хотим экономить и нэнси и силой делает это все за вас просто в этом ключик amazon или так далее укажите и там будет по дворцам по выбору зоны в амазоне в конкретном регионе чтобы цена была минимальная как раз защита на большое количество экспериментов экономия бюджета и кстати в сам или будет потом сейчас мне давно сделали там цена будет писать сколько у вас оценка скуму время умножить на стоимость секунду амазона посекундной тарификацией будет время ну парень принц скоковым долларов это обходилось конкретный эксперимент вот мы все собрали и вот с тех пор там заварили этот суп приготовим его в называется нас силой есть более подробные версия я тут не будут устанавливаться это с другой другого доклада на англоязычного там просто здесь у нас гораздо больше интересных блоков которые еще можно использовать чтобы эксперименты проводить более интересно в целом откуда все это взялось я ну вот плоскость и я я сказал что мы хотим автоматизировать то что еще не автоматизирована в плане администрирование баз данных и наблюдая за поведением там своим и других людей эксперта по базам данных а я вижу что есть три класса задач первое это capacity planning & tuning параметров то есть взгляд без того чтобы заныривать в само приложение да ну то есть как бы такой верхней уровневый взгляд дальше второй отказ условный робот стив условий робот джон это оптимизация запросов подбор индексов переписывание запросов и так далее то есть это самое наверное сложная и дальше возникла ввп возник вопрос откуда брать данные но какие-то данные у нас есть какие-то мы еще можем там взять десятка клиентов а дальше что даже amazon с огромным количеством камбербэтч или где то еще он не может за у своих клиентов ничего брать по договору то есть они не могут залезать внутрь когда в саппорт обращаетесь вы они внутренне лазят и либо это доступ нужно договариваться о чем то как правило они просто не лазят соответственно проблема у меня волновало то я посмотрел какое-то время я парился а потом быстро понял что во всех областях то самом деле так данных не хватает чтобы обучать модели для машину обучения мы можем просто наберите чтобы наделить нам нужно какую-то штуку иметь которое будет нам быстро в разные ситуации проигрывать вот так он на самом деле дивизии нэнси и родилась а уже потом она уже потом пришло понимание что нам это нужно и без всяких а я и машин нашем линков нам это нужно для того чтобы проверять то что у нас происходит с нашими системами ну то есть по аналогии себя сидит только для баз данных о сюжете это для за за но отвечает за эксперимента это такая идея в целом платформы которая я вижу на несколько лет вперед и вот рассказывай о том что что мы уже достигли за последние полгода значит этого пан source и то есть вот он есть докер dockers позже самые со всякими добавками но все это вы можете посмотреть зайти и все исходники увидеть можно есть несколько команд которые позволяют вам по сути прогоняя готовите прогонять эксперименты она может локально у вас на машине можно уборки запустить завтрак раз посмотрим и можно в амазонии гонять можно и в google клауд гонять но это будет локальный запускаешь не dimon не ремонт управления не удаленное управление вам нужно будет зайти и там уже работать в тима ксилитом скрине и для amazon и мы хорошенько постарались чтобы вот как я уже сказал спад и и бюджеты вам экономили ну точнее на на самом деле но мы это делаем up on source и так но внутри я объяснил чуть поболее подрисовывать специфики там есть настройки которые сразу ну по умолчанию полное логирования 50 statements есть она по умолчанию настройки такие что если вы будете выжимать из этого максимум конечно вам нужно лучше пересмотреть эти настройки и облегчить именно логе потому что иначе это будет чрезмерно но если вы берете нагрузку сорвал по своего со своего рода который работает не на максимум то на самом деле это хорошая штука потому что напротив они не может это включать а в этой штуке вы можете себе позволить включить все эти штуки вот то есть авто авто explain a трека тайминг и в общем такой очень подробный анализ и недавно счет flip flap буквально на этой неделе мы добавили флом графы ну перф это же тоже в час в общем интересные результаты так значит для чего можно использовать вот как я уже только что рассказала можете моделировать нагрузку и под лупой и рассматривать гораздо более пристально чем на проводе можно смотреть проверять как подействует какой конкретный индекс на на нам на сцену на на наоборот и как подействует какое-то изменение конфигурации на прот можно подготовиться к breakthrough апгрейду софт или железо то есть у нас есть идея допустим мы хотим побольше добавить за там побольше я der добавить как это как как изменится на сколько нам это поможет да стоит ли нам в это вкладываться или же это не не интересно для бизнеса это очень важный вопрос то есть допустим сделать два раза больше денег отдаст ли ты нам два раза лучшую производительность красным для этого можете посмотреть с помощью экспериментов любую гипотезу оптимизации вы можете тоже так проверить вы можете поставить себе задачу я хочу получить эту ручку найти самое оптимальное значение то ручки например там шайба фирс для моей нагрузки для моя базы 25 процентов это это оптимальное значение или нет вот поделитесь у кого 25 процентов на проводе неужели ни у кого нет я не верю это около того 125 процентов все что ли да я не верю 2 ну я что-то как-то вообще удивленного какие значения используются у кого что у кого что стоит напротив счет boffins сколько 3033 за гигабайт или чего-то сколько всего памяти при этом а 30 процентов почему не 50 можно я передам эту эмоцию черт ну то есть как бы да то есть вы . проверяли это 30 процентов а кто-то настроим да ну то есть ладно у кого есть запустим 8 8 гигабайт стоит тоже только один хорошо окей ну в общем мы на самом деле это такой вопрос интересный альбатроса сейчас наши инструменты показывает что это вопрос очень сильно зависит от нагрузки и базы вот так что это можно завтра будет подробнее посидеть так ну в общем прайма и моделей а я уже говорил какие сложности вот то есть эта штука работает но есть сложности и вот в 5 5 компаниях уже мы это пробовали продолжаем пробовать и вот они там от низких до нескольких терабайт и до 15000 дпс такие нагрузки . я бы не сказал что это прям супер высокие нагрузки какие сложности до но при этом это компания который это пара co2 из этих пяти компаний это мало тебе он компании то есть это отношение к этим вещам очень серьезные как раз там там это очень актуально что от ваших решений может много чего зависит в общем первая сложность это если мы хотим собрать нагрузку на основе логов но нужно включить полной логе мы идем делается logo менди вечный statement и у нас возникает вопрос а не стоит ли нам плохо от этого нужно вот если сладость качаете просто по этой ссылке есть такой подход очень простой подход ну просто берем за собрали допустим 50 statements за час до и посмотрели сколько там при условии того что у нас там не перестанем 500 не 500 от 85 тысяч групп запросов включена посмотрели сколько у нас занимают тела самих самих запросов да там нет параметров дождь просто длина каждого запроса в байтах ну в символах и просто умножили на количество вы количество вызовов в секунду да и сложили таким образом на свете оценка сколько байт секунду мы будем писать лог очень простая без учета параметров и там еще дополнительных вещей типа там duration : вот это вот соответственно мы можем понять будет будут ли это там десятки килобайт сотни или мегабайт в секунду и и сколько всего будет записи в лог после этого когда мы видим что не так уж и много мы можем принципе рассматривать включение но еще надо одну один момент у вспомнить один момент это какая вот система логирование то есть если у вас все слог журнала д а я вот сначала внимательно подумал прежде чем включать такую штуку почему вот простой пример - 96 поезда и просто взяли и перебей чем погоняли да то есть мы выжимаем максимально конечно теперь и syslog проигрывает это ubuntu syslog явно хуже слева это вообще логии выключили у нас там стоит одна тысяча теперь а syslog 37000 cdr-ы логин конвекторы примерно одинаково ну просто это файл пишем и все никаких там никаких оверхедов дополнительных серьезных нет вот что происходит если у нас не просто syslog а еще сжимал диез тут centos journal de убивает производительность вообще вот так вот та ну то есть то есть если у вас там еще journal de как современное linux linux вендоры любят делать не в коем случае нельзя включать полные логе вы просто ляжет сразу даже если у вас там видно что всего лишь нам меньше мегабайта в секунду в общем ни в коем случае включать просто так нельзя сначала нужно подумать чтобы переехать на другую все на другой способ вот ну тут об этом как раз и иногда то есть ну то есть вот это это резюме да иногда мы понимаем что мы не можем себе это позволить мы допустим каким-то причинам нас там логе собираются в какую-нибудь систему кабан или еще что-нибудь и мы не можем просто так отказаться от текущего подхода логирования это очень сложно организация там все такое в этом случае мы можем просто подумать о сэмплирование тут есть вариант если у вас есть пиджи баузер и и вы можете просто написать ему в конфиге функцию который будет кидаться рандомное число и дальше сет считала командировочный стоит нам будет 0 в зависимости от того там это число там дочь вы можете 10 процентов сэмплировать да есть почти тоже висит of hackers который еще не принят которые будут сэмплирования из коробки делать то есть было классно писать все логе иметь свои быстрые запросы там но только для одного процента сайте например будущем это будет сейчас пока нет но вы можете приложение такой запилить принципе ничего сложного в этом тоже нет самое кстати такой простой и прямой путь наверное приложение за карете вот если вам ничего этого не подходит вам нужно по-быстрому есть еще один такой подход вот этот товарищ из портленда сделал поддержку пиджи buncha в нэнси и теперь можно у нас мы можем как 9 базу с помощью прижигания очевидно на простом посеять стандартную базу до каким-то сид фактором и мы можем workload тоже с помощью поджигания гоняются соответственно там будет конкор носите в себе в общем ни один поток загрузить все свои ядра можем и я не знал этого раньше но оказывается режим день чем можно указывать несколько файлов и у каждого файла назначать свой вес а это нам уже дает возможность моделировать нагрузку который конечно же будет более далека от ситуации со сбором логов и перепоя но если мы не можем все такую ситуацию позволить мы можем хотя бы вот так сделать мы можем проанализировать с помощью вот этого тоже запрос из риса стыд нам посмотреть топ запросов по total time и взять и ну дальше она будет придумать как параметр заполнять и тут хорошо если у вас 11 плоскость вы можете zip фиан дистрибьюшен использовать для генерации более приближены к жизни вот ну некоторых станциях очень сложно и приходится просто либо пропускать такой запрос либо просто его как-то деградировать ему ему ну ситуацию то есть главное помнить что если мы по total time смотрим важность вклад каждого каждой группы запросов нашу в наш стресс то вот эти веса надо назначать вот здесь в писании через собачку до vesa назначать основываясь на вкладе не в total time of holes . выну в количество раз вызвав вызов вызовов вот пример из жизни еще один бит лап у них под газ 2 2 терабайта база сейчас что больше наверно уже и чем там очень интересная ситуация что в прошлом году пришли консультанты сделали подключили рэндом рэндом пачка 100 из всех пачку ost это поднимите руку то знает может тебя пропущу если все знают половина в общем это отвечает за стоимость обращения стоимость последовательно чтения диска или или случайного чтения с диска если вас ssd то почти они приближаются и практически там можно считать их равными до поэтому по умолчанию у нас последовательно считается единичка это наш kb счетная . а рэндом под шкаф четверочка как бы в 4 раза дороже нам после в нам рэндом читать в ssd это уже не так и поэтому некоторые составит 11 до по наитию на самом деле ну какие-то эксперименты руками вот пришли консультант в этом году опустили раны под шкаф до полутора до вот полтора приблизили как патч cost полегчало а дальше если возникла в этом году тебе посмотрел и некоторые запросы тормозят и вот ему и мущина пришло в голову всех пачку с четверку сделать и это счетом до меня была в общем нет несколько запросов стали лучше production опять такая же история и в общем на самом деле полегчало реально полегчало прикол в том что я дальше думаю сейчас я докажу с помощью экспериментов что это очень плохая вещь так не понятно что мы когда так делаем у нас вообще в explay не все двигается да то есть у нас все эти касты они грубо говоря четыре раза нетрудно сдвинутой то есть все что вы видите вот это стиме the cost он в четыре раза по сути уменьшенной да здесь потому что снег . стопы на чтобы наша точка отсчета я думаю щас я докажу что это было все очень плохо и подозрительность нам целом просела он просмотрел резко запрос оказался у него интуиция работало хорошо то есть нужно было не несет пучков конечно крутить а другие параметры включительно прикол в том что эксперимента показали что в целом про известность улучшилась на на 40 процентов дальше нужно смотреть какие группы именно улучшились и более глубокий анализ делать но вот таким простым таким простым способом заняло это ну полдня вот эти эксперименты погонять собрать для двух терабайт най база и получить результаты то есть мы можем просто гипотеза проверять вот такая бредовое на первый взгляд гипотеза она сработала уже на ситуацию ещё пример очень такое у я вот этот пример очень люблю читаем документацию там видим что лоджик а lights информация не составит us apart logical decoding окей мы думаем сейчас мы logical если делаем значит вал будет больше писаться но потом смотрим что вот здесь написано что то есть url валы l до l logic был он призвал троллем тоже увеличится ok увеличится particular и то есть особенно если много таблиц сконфигурированы и сидишь и думаешь а если меня 1 таблица нет не используя щас ложек вы могу его выставить должна заранее выставить restart сутки downtime и думаешь вот партитуры и ну в общем неточность непонятно в документации написано если нет ни одной таблицы с репликой донести full большего любую то линию или меньше вместо того чтобы гадать берем просто базу нашу и наши нет некоторые наши запросы и просим нэнси в амазоне я быстренько посмотреть через том числе некоторое время он там база подготовлена было через 15 минут есть ответ что никакой разницы нет то есть можем спокойно балвал носенко бы образованием немножко занимаемся то есть если у нас есть какое-то непонимание chop-chop воздухе происходит мы можем запустить эксперимент есть опция keep-alive сказать там держи мне инстанции амазоне на час и потом просто засечь пойти посмотреть все что внутри происходило такой образовательная вещь это вот для конкретных одного проекта шайба фирс вот для конкретно такой нагрузки показывает что выгодно сделать большие шартрез больше половины вот причем дальше были лучше не ходить потому что там он киллер будет нас ждать а вот где-нибудь вот здесь хорошо восстановиться но прикол в том что нагрузка просто а ну то есть там есть такие запросы которые формируют большой вклад в нагрузку если x оптимизировать и дальше смотрите что будет если мы будем больше теперь с то картина совсем начинает меняться то есть начинает начинает появляться проблема как раз того что шайба фирса на больших объемах он знает конкорд сизо хэш-таблицу внутри за локи работать и соответственно нам выгоднее остановится здесь сидеть то есть все зависит от того какая у вас нагрузка какая вас база можно это изучать чем мы сейчас и занимаемся на самом деле но это большая история можно завтра тоже проговорить это напоследок если вот вопрос у нас нынче гоняет пережив и джери play или пиджи bench изнутри то есть мы как бы чтобы видеть нагрузку нам нужны ресурсы тоже то есть мы отнимаем у нашего подвеса ресурсы на то чтобы обвинить конечно же это какой-то вверх отдает в предикат опрос какой недавно тайфун графы запилили как искал на этой неделе по сути и смотрим что вот в конкретно этой ситуации дофин граф завтра покажу приезжает просто как артефакты вы можете его после чего не надо вам уже отключить просто он приезжает вы можете его открыть посмотреть там зазумь это очень удобно и же bench вот в данной ситуации он всего шесть процентов вклады сделал до заметно можно принципе а думать о том чтобы вынести и в некоторых случаях это нужно сделать если у вас база 96 вам вам нужно зип вин пить же быть хоть это клиентская вещь он входит в сервер pencott что вы будете что в центр ся в центральном вообще все склеена и поэтому конечно то есть нужно где машины чтобы даже поста чтобы даже купить же бич другой версии получить вклад 76 процентов данность ну в нек-рых ситуация будет будет больше конечно некоторых меньше вот соответственно это я уже рассказал все как итоге эксперименты с базами данных это правильное направление она еще в таком зачаточном состоянии но это то что позволит нам от черной магии перед тег понятным вещам к принятию решением на основе данных то есть да это дрейвен де sirens и стейджинг следующий стейджинг вам нужно стараться медь такой же как продакшна желательно регулярно его клонировать а еще clock еще более классно иметь его по запросу то есть иметь много стрингов по запросу кому-то надо развернули свернули очень классная история есть у меня там где-то слайдах в кантом буду еще поступательных слайды есть вы классная история доклад от яндекс метрики как они там myspace пейджинг по запросу разворачивают за пару секунд с помощью за tfsi snapshot of над отдельная история то есть это тоже интересно и в конце концов от используйте то что уже есть вы можете получить очень хорошую лабораторию для того чтобы собирать данные спасибо вопросы здравствуй ну давайте ладно наверно просто завтра а я всегда спасибо 2 рубля много вопросов не знаю могу за всех задать если желаешь лет за мой можно много самый яркий на своем так сказать кластер и на своем облаке это все можно разворачивать особенно если это кластер с репликацией аппликация пока вообще не как мы то думали только то есть это пока все пока только с одной ноты имеем дело развернуть можно на любом линуксе даже на маке а можно я завтра покажу на майке буду то есть нам виртуальная машина будет да то есть можно назвать или где угодно в любом linux ну мы правда приняли только ubuntu и centos да если вы хотите вопрос ремонт вот это управление когда мы с одной контрольной машиной вот как для amazon и сделали что мы можем сказать о сделаем проводкам сейчас сто прогонов жертва фирс сделает разные да хотя кстати это неправильный подход тоже можно обсудить завтра в в этом случае только сама зонам работы пока есть то есть вот чтобы будет удаленное управление если иначе вы можете просто удаленный засечь вызов там нэнси развернуть прогнать все то есть это не вопрос репликация пока никак не проявляется вот тогда я сразу спрошу небольшой вопрос как клон рода как очень происходит хорошее отличные вопросы там есть несколько вариантов один вариант конечно же можно просто логически ну там подсунуть это не вопрос то есть арест дам но когда нас будет там терабайт 2 терабайта у нас придется ждать час и пока они пока не развернуться можно без backup взять и просто провести то есть там же но в докере вы не имеете права данные держать поджидает это держать внутри я не должен быть снаружи потому потому что там много рфс и все такое то есть нужно держать данные на нормальная файлы системе снаружи просто монтировать соответственно просто когда нация запускаете там есть опция кажется что побеждает и у меня уже есть уточню речь про то это реально надо делать клон продай если там вот эти терабайт и где-то крутятся чтобы протестить какие-то там особенности каких-то запросов да у нас в планах есть сделать частичные дампы но просто мы пока пошли по другому пути тут много планов там есть что да есть идея что он что можно было бы не все брать некоторые таблицы да и автоматически там с помощью анализировать workload понимать какие таблицы нас интересуют только их брать готовить заранее и дальше уже там просто копируем копируем и ну эталонную такую резаную поджидает одержим и клонируем но мы пошли по другому пути нас интересуют базовые вещи просто мы сами занимаемся более полноценными исследованиями когда у нас workload приближен production но это у нас все интересует ну и проще взять там все эти два терабайта изгонять их вот то есть это классная идея у нас вообще классно хотя и очень много вопрос что тут на чем стоит учиться то есть ощущение что пришел в какую-то зону где пока еще ничего нет и очень много чем можно сделать вот пока мне такое ощущение то есть вот вот я даже на самом деле вот сделать уже 33 дак вот эти доклада я тут уже сегодня утром и отметил что прошло докладывал от я прошла ну это был тот удобно прошлой конференции а вот уже dan dan dan то есть у нас я я уже начинаю как конференции идея рассказал а потом уже как как проджект менеджмент какой-то начинается а вот общий смысл всего этого тестирование на амазоне грубо говоря в докере в том чтобы за счет разворачиваться секунды а если мы говорим о тебе прямо полноценных базах то как бы объем длительно изменяются что измеряются в байтах ну правильно поймать терабайт тоном в amazon это гонять на бессмысленно и вот мы гоняем 2 терабайта в амазоне просто мы готовим и биас алем заранее а сколько от времени подготовка тестова контура занимает зависит от того сотку да вы качаете то есть это если через океан там гроба против из канала то есть и торджи кстати это это еще дорого а папа цен например насколько это обходится почему она один тестом не знаю там дети день проходит все профиль нагрузки то есть нету завтра покажу вот 2 терабайта база мы гоняем полчаса вой тест у нас меньше доллар обходится прикольно а еще за час там больше не возьму полотенце вашей системы и яма тонов скачка может быть разные разные по любому соответственно так возводят а классно мы там а если вы живёте в амазоне тут есть разные кейсы есть и мы иногда гоняем локально нам наоборот нее заказчика то есть нам удается экспериментальный там пары инстансов ну и то есть это виртуальные либо это железки настоящие ну прям на них локальной гоняю это такие же резко production все такая такие условия когда люди живут его в же цепи как git лап или в амазоне мы гоняем прям там в гугле мы догоняем а предлагаль на амазоне у нас есть ремонт вот это управление классно вообще есть еще одной ситуации когда мы исследовании мы занимаемся как сейчас продолжается следует жертв offers когда мы просто нас не очень интересует конкретный кейс мы можем некоторые взять кейс мы берем а и 3 инстансы которых локальные envy me диски они быстрые и общем какой-то такой сферический конь но он довольно такое интересное тоже получается мы смотрим как от разных размеров количество памяти количество объем базы или сколько там цепью и к к к к к к к к к и на количество нагрузки создавать какой там читающие читающую как это будет ну какой шайба фирс оптимальный в разных ситуациях его эти исследования публикуете это только в будущем то есть идея какая чтобы полноценно все это про исследовать он нужно 1000 лет то есть это просто кошмар идея такая что мы сейчас какие-то реперные точки обозначим вокруг них что-то преследуем руками а потом нашу людям запустим мы уже это делали для некоторых конкретных ситуаций работает очень хорошо то есть ну можно то есть если тебе и говорит если вы зададите индекс у вас ускориться в десять тысяч раз по моему опыту могу ошибаться там на порядок но не больше то масленок деби он будет знать лучше предсказывать что этот индекс поможет так а вот блин яндекс поможет меньшим зато у него размер меньше или там можно многое каких вещей собрать это дела в будущих лет нескольких а думаю то есть это если не больше apple тему затопив расскажите или , направлялся виктор и гафаров с авито вот он к специалистов с мы только начали то есть я пока не могу ничего сказать даже приходить наверно рид может быть что тогда уже мы сделаем спасибо пожалуйста здравствуй спасибо за доклад у меня на самом деле вот вопрос про оптимизацию вы говорили по поводу 4 вот четыре штуки которые можно делать я хотел почтить а вот их sing вообще ну не всем наверное в sing нужен если не боимся например данные потерять как на этом относитесь и еще до нуля такого среди своих клиентов у себя не встречала нам и мы все боимся данные пятно если статистику например мы собираем статистика на самом деле очень такая объемная штук то лучше unlock ты был сделать вообще и вот второй вопрос по поводу если мы допустим ты был space то есть все индексы и несем на ssd не пробовали вообще так делать во первых до тенденция которую я у нас получается что из того что многие люди и компании seat в облаках тепла списав уходит от косого просто отказ от пусть интенция мы часто выпиливаем в одном проекте cross tail space которых сотни в облаках вот тут до этого ты рассказ про во лжи был во лжи не поддерживает лесах собственно эта причина почему это мы выпиливаем вот сейчас тенденция в облаках ну я и в сша там там просто ну люди которые живут не в облаках они уже ушли из облаков каким-то своим причинам дам денег меньше например по умолчанию люди в облаках облаках у нас если мы смотрим допустим на google ниткой никакого смысла даже к слог выносить мы балвал вы носите на другой диск просто просто там сетевые эти диски гугловские они они совсем дольки другие звери чем они другие по натуре чем обычные диски и там нет проблемы что у вас вас там же индексы выносить ну наверное надо смотреть конкретику то есть либо списание у нас вот один проект гоняется он стоял с пейсами некой проблемы нет не помню какие то небольшие проблемы были но мы гоняем вот этот подход просто господством щеки проверить что будет если мы вынесем индекс это же всего же деле мы можем даже сказать дельта alt alter этот самый подождать придётся но это но мы готовим пойдем другими делами заниматься результаты получим попозже это все можно делать да я просто свою пояса означало сказал что то пускай свой пили вы а вот еще сложилось такое мнение но точнее у меня вот из-за вашего доклада что у вас прямо предвзятое отношение какой то есть к centos это так или нет я советовался использовать на продам меня краям большой предвзят отношения просто у меня как бы мы не дружим чему-то лично это очень лично с вот см округа с 2005 года просто учитывая что я выдаю летом 10 лет занимался кента не очень вещи вещам не очень техническими изменять все делали я помню я принял решение от ямы войти в в debian тогда еще ну в оп оп систему да и то что внутри люди готовили or пьянки это я просто помню как просто половину времени админа приходилось выделять постоянно на это и это была жесть я как облегчалась сразу с дебютом а сейчас и мне пришлось и за клиентов окунуться опять в это все и я опять эту боль почувствовать но иметь что лично я просто я не знаю просто ладно короче спасибо просто добрый день спасибо слышно часть замените пожалуйста до окончания доклады осталось 10 минут если какие-то вопросы остаются неразрешенными по истечении времени их можно будет задать дискуссионные зоне спасибо или завтра в 16:00 на этапе спасибо большое за доклад хотел спросить каким образом правильно собирать сэмплы запросов которые потом отправлять потому что откуда брать данные понятно справа да а как запросов до самый хороший классный способ это собрать полные логе и там дальше просто пиджи реплей есть готовятся бинарные бинарный режиме готовят сам по сути бинарный файлик в котором говорится что мне пожалуйста участвовала параллельно фигачить таки это запрос там есть проблема что в логах должно быть таймс темп обязательно миллисекундный и проблему что это миллисекунда а они микросекунды давно пора уже медь микросекунды надеюсь когда-нибудь скоро это появится погаси потому что с миллисекунду уже недостаточно вот и на основе логов это самый классный способ нового рассказывал про это посмотрите потом еще слайды там есть сложности вы не можете взять выключить полные логе если не можете выключать и сэмплирование вы можете просто приложение в сайте сказать сок сок лидирующей степан можно выставить прям сыщи что вначале вы с вероятностью здесь процентов оставляете себе его или там один процент в зависимости от вашей нагрузки это кстати отдельная тема как сделать так чтобы уже хватало до но еще не захлебнуться большая тема есть теории на эту тему в других в других областях знаний если вам надо быстро грязное решение но лучше чем ручное вот это уже рассказывал с анализируйте 50 стоит мы сортируйте по total time за довольно большой кусок там за неделю и смотрите вот это запрос у нас пять процентов total time вновь входит а он выполняется один процент всего лишь берем его значение рандомные исходя из знания своей базы делаем слез backsplash эндом поставляем лучше если у вас есть возможность пережить гонять 11 версии там есть рэнд backstage сет рэндом зип вин это распределение нерон ну короче не равномерная более приближена к жизни расстояние типа и тогда вы будете выдавать бур то есть у вас пользователи допустим смотрит какие-то страничке они такие ценники больше смотрят неравномерно вот этот это лучшее это использовать и так вы проходите и собираете у нас бывала там прав взяли 10 запросов они по total time восемь процентов все нагрузки а дальше главное весам можно настроить pidы бенч и и просто прижмите гоняет и мы гоняем исходя из знания знание сколько у нас tps продакшене мы такой же подбираем теперь с прежде чем можно сказать backstage д-р большое это сколько теперь задать то есть перемычки может не обязательно максимально нагрузка выжимать он может идти ровно то есть просто вoт вaм выжимает 2000 ps запрос идут в пропорции приближенных продакшн и случайно и случайные значения распределить ифа и дальше нэнси начинаешь сравнивать total time ручку покрутили total time запросов стал больше или меньше и по каждой группе запросов тоже сравнивать начинаем у нас всего десять групп здесь будет хоть так спасибо пожалуйста привет спасибо большое за доклад это задать серьезный вопрос мы нами то про не то что вот и даже не менее земными то перед ценам шутейно скажи пожалуйста что делать этой армии огромный гибель магов которых заменит нынешняя штука больше больше советуешь ставить эксперименты они будут ставить эксперименты будут большим количеством баз данных управлять и заниматься меньше ручного труда и все то сейчас мы как у нас с лопаты да я предлагаю на тракта присесть превратится взять лучше а не превратится ли это что-то в них некую ручку которой будет дергать разработчики и получать это тоже классно если эта связь возможна use by и как бы не не поразиться не бояться нечего потому что это всего лишь инструмент он просто позволяет более системой работать я я в этом уверен но этот философский вопрос это соски страх замены и роботами до"
}