{
  "video_id": "zr4ZDtfp0N0",
  "channel": "HighLoadChannel",
  "title": "Что мы знаем про хэши / Андрей Аксенов (Sphinx)",
  "views": 6697,
  "duration": 3346,
  "published": "2019-06-03T09:05:07-07:00",
  "text": "тем временем вы все успели прочитать что рассказывать я буду 1 том или даже второй тон кнута в катар там professio и ничего не более интересно очень в этом самом первом или втором томе курта не расскажу стандартный дисклеймер под названием как бы в силу глубочайшего лично снова своеобразия которая по совершенно непонятной причине а по непонятной причине которые по причине отсутствия карательной психиатрии в нашей свободной демократической россии никак не лечатся не могу сорваться и там начать матами ложить explicit lyrics там уберите диет мониторов прекратите запись мы в приличном месте в сколково я тут матами класть буду как тот физрук покрыл матами пол вот как то так на кой черт я это делаю не понятно но с одной стороны но с другой стороны понятная достаточно последовательных и своих убеждениях убеждения гласят что как бы надо знать фундамент остальное этом фундаменте а тебя постепенно приложится или например приложится неважные конкретные технологии важно то что ты понимал что этих технологий внутри учите компьютер савинцева no one читаете кому-то и конечно же это не окажет никакого влияния на вашу зарплату поможете херачить надо все равно на реактива ей и там чем-нибудь еще но все таки приятно хотя бы вот знать что ты когда-то это изучал учета понимаешь вот как то так про слово хэш значит немаловажная деталь что такое вообще хэш мне честно говоря первым в связи с тем что проживаю городе-герое москве сразу такая матёрой шар месяца на трассе м4 брат и вкусной hашем все дела вот люди которые там когда-нибудь ездили в штаты наверное кушали вкусный десерт хэш брауни хэш брауни кто бы мог подумать вот и конечно же инсталляция корабль в бутылке все это не только несчастье вот вместо вот этих вот интересных вариантов мы будем обсуждать более примитивные но это тоже три разные штуки то есть к чему вот эти вот рандомные картинки ты была были тоже три разные штуки если я сбегу со сцены он туда подбегая в принципе монитор буду видеть ну толку никакого в проклятый терминологии уйти науки им постоянно когда говорят про хэш путают и я тоже буду подать три совершенно разных вещи во первых от собственно сам контейнер ассоциативным sew которой функциональности ведет как ассоциативный массив плата этот кладешь ключи получаешь значение кладешь ключи получаешь значение на самом деле кладешь пару ключей значения потом покручу быстренько быстренько значение получаешь его называют хэш он хэш-функцию которая там внутри для реализации этого дела если она внутри реализованы хэш-таблицы именно они как-нибудь еще и это же называют huge он для краций это же невозможно каждый разговор мы вычислили значение хэш-функций елы-палы и мы короче вычислили хэш положили в хэш получился хэш вот так это работает я их тоже естественно буду падать потому что нет никакой человеческие возможности говорить здесь и ты хэш-таблица это хэш-функции но догадываетесь по контексту функциональные и технические 2 разных штуки надо понимать что контейнер который ведет себя как вот этот хэш то что привычно называется хэш он ассоциативный массив если угодно у которого индекс это произвольно взятый объект внутри может быть реализован без хеширования совсем там может быть внутри спаси господи вектор с линейным перебором и чего работать будет просто тормозить как по плану в принципе нам не привыкать вот а там может быть такое дерево внутри быть спрятана например или любая другая гибридная структура классика жанра то что там пишешь стб мэк не задумываясь ее на си плюс плюс и богомерзком и как бы выглядит как хэш но hашем не является внутри там значит определенное дерево красно-черный там сбалансировать что-то в этом роде нас интересует как бы нет нас интересует вот тот самый компьютерс касается о новом который по классическое хеширование значит простейший случай как сделать самый простой here я собирался как честные зайчики нарисовать все таки двадцать строк кода которые сделают какой простенький хэш но поленился и надо как-то каким-то бонуса там присылайте визитки я не знаю чем или сами напишете и мне присылаете я потом весь код и засру и это даст вам возможность интеллектуально вырасти так и эдак самый простой реализации hishe который в принципе можно придумать что удивительно она же и зачастую хорошо работающие делается поверх тупо массива в котором в отличие от обычного массивов которые ты складываешь элементы линейно по мере поступления 0 поступил то его в нулевую позицию 1 в 1 2 2 и так далее если не дай бог 0 стерли ту началась колбаса там на данный двигать самый простой hash это просто тупо массе в котором всего лишь несколько нестандартных доступ как бы war важный возможно там про тектонический сдвиг то есть если никогда не задумал только я не знаю кто пришел послушать про хеши как он не ловит зачем приперся видимо потому что думает что достаточно тихо буду рассказывать не буду им мешать код писать но если ты никогда не задумывался как эта машинка внутри в принципе устроено тут оно устроено вот так это просто тупо массив в котором при поиске и вставки элемента ты начинаешь этот самый поиск или вставку не с текущим он там начала хвоста и так далее а с какой то непонятно как вычислено позиций с какой позиции как это понять понятное дело что для каждого вылетающего ключа ты должен этот поиск начинается примерно одной и той же самой позиции понятное дело что для того чтобы это как бы работало хорошо эти позиции должны быть более менее равномерно раскиданы по массиву ну вот внезапно мы приходим от концепции контент хэша хэш-таблицы контейнеры концепция собственные хэш-функции хэш-функция некая штука которая это вычисляешь для каждого конкретного ключа и которая тебе для этого конкретного ключа говорит значит так для ключ для ключа номер 0 поиск будем начинается позицией номер 5 почему 5 а хрен его знает потому что остаток от деления на длину массива 8 в данном случае от нашей функции которые типичная все-таки не там ни одного нет ни от наглядности для семьи принтом 32 убить на 64 битные так далее то остаток от деления на 8 ап5 значит начинаем оттуда близки вставляем соответственно ключ к номер один остатка деление на 8 равен 2 ура ура значит первым делом пойдем именно туда вместо линейного перебора от начала до конца пойдем в какую-то воспроизводимым стабильно воспроизводимым по значению ключа образом позицию и начнем оттуда поиск все ура мы значит сделать мы виртуально в голове написали свой первый хэш вот тут вот как раз и очень хотелось но за ленился будем честны написать этом буквально те 10 строк один первые 10 на поиск 2 действия ставку которой вот натурально сделали бы там первый примитивный хэш но что ставим как упражнения для слушателя к несчастью не все так просто и возникая возникает определенное количество деталей реализации этот не все примерно так раза в три минимум не все а возможно больше каждый из этих деталей долбанных реализации влиять не то чтобы меняет все но влияет влияет на разное вот и надо каждый раз принимать какое-то неприятное решение что мы делаем по каждую из этих вопросов почему на слайд вынесены вот эти вот именно 8 про размер удаления спец ключ и и так далее и тому подобное потому что грубо говоря там может быть не все восемь но там 5-6 из них натурально определяют ваши конкретные требования к этому самому фишю определяют ну как его грубо говоря правильно писать чтобы получилось хорошо там быстро компактно по памяти и так далее и тому подобное вот казалось бы мы живем в 2018 году и наши космические корабли конечно и там баллистической ракеты кинжал бороздят все что возможно вот ей нас должны спасать библиотеки или например стандартной библиотеки нужен блок языков программирования в каждом из этих долбанных языков программирования есть стандартная библиотека и пылесос судя по звукам но к несчастью если мы значит вспомним что там каких-то 8 произвольных вопросов то вот эти вот бинарные выборы по каждому из 8 вопросов нам блин уже дают 256 вариантов вы можете представьте библиотеку нормальную человеческую абсолютно стандартную и идеальную в которой реализовано либо какая-то обобщенная штука которая отлично работает в 256 разных вариантах сборки или спаси господи и вообще в 2.10 6 разных вариантах runtime а за какая-то магическая машинка которая вот бантик с флажками так на вход передаем трах-тибидох ясуко джин хоттабыч я идеально работаю вот именно в такой конкретной конфигурации как бы чудеса бывают но не в этой части поэтому для всех этих случаев конечно в кавычках идеально годится там из cd нардеп или любой другой контейнер который вам ваш конкретный язык среда и так далее предоставляет но в кавычках идеально то есть амортизированная в среднем неплохо он годится вот но к несчастью если у него зарыться в детали и малость упороться и написать собственную реализацию иногда выясняется иногда подчеркиваю возможности не гарантия что синдром как бы сделано не тут а значит победил в кои веки и мы свои проценты либо разы либо перформанса либо требования к памяти либо и того и другого внезапно вот в этом конкретном месте нашли ну хорошо как же эти чудесные штуки происходят давайте хотя бы в 8 флажку галопом по европам занырнем у давайте конечно размер статика и динамика о чем это вообще о грубо говоря двух или трех разных вариантах реализации hishe вот это вот первый гигантский выбор первый и второй вариант на слайде это так называемый обстоят забыл я поставить честно говоря путаю названием поэтому если соврал не бить меня сильно посмотрите википедия это так называемый alpina dressing ешь когда все свои элементы хэша ключ и значение ты втыкаешь в одну большую таблицу и соответственно если тебе повезло то это одна большая таблица просто фиксированного размера пункт номер один этот размер никогда не меняется но вот ты знаешь что у тебя там в любой конкретный момент я не знаю там ровно 37 монстров по карте бегает но они как бы гандоны постоянно умирают нам рождаются и у них у всех разные имена и зачем-то их именно по именам надо как бы открытка чтобы там смешную шутку потом пошутить того гоблин вася то а лопату на вот не знать страны к чаю space какой важно то что ты знаешь что этих объектов всегда ограниченное количество можешь сделать абсолютно статическую table табличку балет номер они нумерованные ну блин умер в голове номер один это идеальный вариант вот если такое получается сделать то про трубах божественным к несчастью нашими городами плодов как программистов норовят пользоваться живые люди в тот конкретный в тот момент когда ты думаешь что как бы там 640 килобайт должно быть кому угодно достаточно или там не знаю 512 монстров на карту какая-нибудь вот просто уже прямо в эту секунду собирается этот лимит пробить в три раза а потом по факту в продакшене постепенно случается так что лимит пробивается в 10 раз поэтому внезапно более живенькие часто используемый на сами на практике вариант номер два когда у нас есть большая большая табличка с но тем ни менее динамически изменяющейся длиной то есть вот вот это самая табличка которую этому рисовал не понятно тут не на восемь элементов а там длина условно говоря для начала на 8 не хватило рис сойдемся в 16 не хватило риса 732 и так далее так далее так далее возможно виноградари садимся вниз первый подход большая табличка евниев т.к. второй подход опять же такой глобальный фундаментальный это когда у нас есть на этот раз действительно пожизненно статичная по на время контейнера не меняющая свой размер табличка с так называемыми салатами или ведрами бакетами или как угодно их еще назови а внутри каждого баки то у тебя дополнительная структура хранения данных что это за структура в принципе неважно может быть натурально тупой вектор тупой просто там статический массив то есть берем там все вылетающие нам данные шпак раскладываем их там примерно равномерно размешиваем на 1024 ведра и и там держим 1024 вектора каждый раз когда нам надо поискать что-то по ключу мы себе пространство поиска в среднем в 1024 раза сократили ура ура и сделали это достаточно простым методом заведя там массив на 1024 вектор на кой черт еще это надо необходимое пояснение вот такой вот фокус когда у тебя статично это будет таблицы слотов багетов и внутри дополнительная структура она может экономить память в тот момент когда ты почему-то совершенно не может зафиксировать указатель на объект и в терминах siplus плюсика и вынужден хэшировать сами объекты и она получше работает в случае в случаях когда особо много стирания из этой самой таблице потому что alpen андреасян с одной-единственной большой таблицей тише и вот плохо достаточно живут с этими самыми стирания мисс де летами тут значит две картинки сверху alpina dressing снизу соответственно клаус хешан или и лечением варианты alpin a3 вот у нас есть большой массив типичной степени двойки хотя как не удивительно не всегда в котором мы втыкаем ся в те или иные позиции и внизу соответственно вот 4 баки то а внутри этих четырех пакетов мы набрасываем элементы вот тут набросанные элементы этому элементы с номерами там 1 2 5 6 7 12 13 они вот так вот разлеглись по верхнему пишу и нижнему пишу здесь я специально на этом слайде что значит забросить мысль о так называемых коллизиях сразу прям в не окрепшие детскими в том числе свой набросал 2 элементов верху красненький 12 у которых одна это одно и то же значение хеш-функции один как это вот работает работает вот так представьте себе что у нас есть два элемента е1 и е2 у них одно значение хеш-функций как это работает в обоих случаях в первом случае мы втыкаем ся сначала в слот номер 1 кидаем элемент я один туда второй элемент пытаемся кинуть туда опыт не попали сдвигаемся в бок например на единичку кидаем туда в верхнем случае султана трещин в нижнем случае соответственно вот подрачивая вектор накидываем туда да самое скучное кончается самое время уходить а вот что интересно если бы у нас было более лучшая нормальная функция хеширования и получше развала тела бы элементы по значениям хэш-функции картинка верху не изменилось бы что смешно внизу изменилось бы вот у нас получше с хэш-функция мы более равномерно разбросали элементы по этим самым салатом и баки там кроме того она не видно на слайде потому что как бы поиска и вставка никак не обезображенный но в первом случае у нас средняя длина поиска могла бы быть достаточно плохая ищем элемент есть семь мы начнем перебор то с позиции номер пять проверим пятую шестую седьмую и только после этого начинать найдем элемент есть семь у которого было плохое не хорошие значения хэш-функции 5 а вот в этом случае хотя визуально ничего не изменилось мы сразу начнем поиск элементы есть м с позиции 7 потому что у нас придуманные хэш элемента е7 как раз 7 равен вот наверное в этот момент надо сделать комментарии если значит забудете все остальное то из доплата запомните хотя бы это что как бог и шеи есть два принципиально разных внутренних устройств один из гигантский таблицей которая постоянно растет и изредка уменьшается второе вот с каким-то количеством слотов и там грубо говоря в вектором или списком или чем угодно еще определнном каждому конкретному салату обратите внимание если там внутри вот этот список это не значит что нам реальный список прим прим список список это может быть какая-нибудь забавная структура с плотненьким контейнером которой лежит в памяти статического размера винтовыми индексами внезапно такие фокусы иной раз дают грубо говоря там не знаю полтора-два раза перформанса формально с точки зрения компьютер silence это список и это список только в одном случае моего реализуем прямо и честно честно список список как по книжечки в другом случае мы его натягиваем на структуру данных безо локаций и в список все затаскивает индексами они указателями внезапно вот этот вот кейс может сработать там сильно более бодро хотя бы поста просто за счет того что избавились от локаций выглядит как непонятно что до выглядит как два массива на самом деле это тоже список массив массив как бы лежит хомяк на нем хомяки херохеро ты внутри список про размер как быть с размером с размером мантра просто хотя как бы что интересно как раз си плюс плюс на и с целью не поддерживает что с размером подобных таблица ты хочешь как бы строго по меньшей мере по реализации руками уж точно с размером ты что таблицы этом таблицы всего в первом случае лапина трясин что таблицы флотов ты строго хочешь делать степень двойки по одной простой причине ничего не меняется за последние 50 лет операция отделения умножения как была дороже чем операция блин там умножение и сложение так до сих пор то осталось вот я не помню с какого конкретно процесса раз рисовала срисовал раз трактовки но с какого достаточно свеженькую там условного skylake а если не кофе лейка в крайнем случае там с предыдущего поколения вот обратите внимание для того чтобы сделать виртуальное отделение на степень двойки то есть просто нижние биты взять нам надо условно говоря пол такта ну на самом деле один просто процессов параллельно с этим сможет еще что-то еще считать чтобы честно и полноценное деление сделать нам нам в одном случае если на 32 бит на число делим на 26 тактов если дай бог 64-битные хеши и 64-битные деления то вообще как бы отдыхала кастетом сто тактов может уйти на просто вот это вот операцию деления обратите внимание что за операции деления черными дальше ваще говорит на странице вот у нас есть хэш-функция там как это 32 битная почетная для каждого ключа для каждого ключа на каждую долбаную на каждое люблю на любое обращение к хожу на каждую долбанную вставку на каждый долбанный поиск мы считаем хэш-функцию это живет какое-то время далее после этого у нас ограниченное длины табличка либо табличка элементов либо табличка салатов если вы не дай бог деление выполняем в этот момент об 30 тактов как бы просрали работает этот как был хуже несколько чем если мы просрали один так несемся дальше по деталям реализации удаление спец ключ и значит бывает в жизни так что вот самую хэш-таблицу надо к несчастью моему глубочайшему не только лишь вставлять данные искать их там а еще и бывает стирать вот как бы это плохо во первых и еще бывает значит раскладывал 100 ой что иногда у тебя среди ключей есть какие-нибудь спец значения которые можно цинично использовать но там я не знаю фишеру ешь да не понятно чертам честно говоря dunhill фишеру ешь имена фишеру ешь именно и у тебя есть отличное спида значение пустая строка в этот момент у тебя внезапно есть особое значение ключа которой ты можешь использовать в своей хэш-таблицы которую как бы делаешь руками муж зайдем сегодня все собрались за чем у тебя есть отличная спец значение ключа который можно использовать для того чтобы понять что это не элемент который пока пустой который мы даже не инициализировали и соответственно никаких дополнительных флажков свои хэш-таблиц не делать а иногда нет иногда у тебя те значения которые ты фишер и те ключи которые ты фишер уишань и как покрывают весь диапазон там хе-хе-хе широт все возможные int и там от 0 до там два в тридцать второй степени минус единиц в этот момент приходится как-то выкручиваться соответственно в чем прикол в чем суть слайда в том что у тебя элемент hishe в общем случае при абсолютно общих требованиях это к несчастью подчеркиваю к несчастью несколько больше чем просто пара ключ-значение это еще вдобавок ну там типично как минимум флажок пустой это элемент или не пустой и флажок и стерли элемент или он первоначально девственно пустой и зачастую еще неплохо бы сохранить значение хэш-функции потому что потом когда-нибудь пригодится вот соответственно если есть особое значение ключей и значений можно сэкономить на этих долбанных флажках is empty из дели that но реально помогает про удаление тут как опять-таки без картинок непонятно но попытаемся и почему это плохо получается что значит вот при этом сама поиски нет перемотай все-таки на картинг вот мы ищем там элемент допустим тот самый элемент номер 7 и перемотаем ся даже вот на эту картинку для абсолютной ясности не синхронности ищем элемент номер семь начинаем поиск экспозиций номер пять пошли позицию номер 5 там элемент 5 не совпал 6 не совпал 7 не совпал и чего мы весь массив до конца про шагаем херб мы находим до элемента 8 он пустой он никогда не был про не цели zero ван стерт тоже не был в этот момент мы получим такие так о ништяк всё наша цепочка элементов с хишам номер пять кончилось навсегда дальше мы ничего не ищем мы перебрали не весь массив на 16 элементов мел перебрали топ 3 элемента либо нашли либо не нашли наш элемент на этом поиск кончается а если бы он раз патроны а если бы какая-то нам с тем же самым хишам номер пять вставила еще элементы 8 и 9 после чего 8 стерла и мы 8 помечаем как пустой в этот момент поиск у нас кончается элемент номер девять пропадает навсегда моего не находим никогда вот по этой нехитрой причине приходится вводить дополнительные тот цвет окрас ячейки и в таких случаях элемент номер восемь когда его стерли красить другим цветом возводить ему другой флажок или там писать другое значение ключа писать ему другое значение значение в этот самый элемент и опять же обратите внимание что вот а в нижнем случае когда у нас не вот одна это гигантская alpina трясин таблица тренинг таблица такой проблемы как бы не возникают потому что у нас ну стерли у нас элемент номер восемь ну и хер с ним мы его просто удалим из вектора и как бы если умные вдобавок то удалим не со сдвигом всех данных а там обменяем с хвостовым элементом уменьшив конец вектора и никаких вот этих вот пустых элементов стертых элементов у нас как бы нет все эти проблемы возникают только в первом случае где был на пункте номер три пары удаления ловушка опять таки это все применима только к первому кейсу апина dressing с этими долбаными стирания my можно загрязнить вот этими могильными камнями которые помещают удаленными элементами внезапно замазать всю таблицу против смешную ситуацию когда у вас ноль затишье равных элементов но любая операция скифам тормозит дичайше просто потому что как бы не очень хорошо написано там таблицы на миллион элементов сплошные могильные камни и мы как бы на каждый чих сканью весь миллион элементов но как более лучшая реализация она как бы следит за этим и в момент когда там слишком много таких могильных камней флажков что этот элемент был стёрт берет и перестраивают хэш-таблицу за но мы-то понимаем как вы напишем свою первую хеш-таблица и даже третью я бывает и пятую с такими богами писал это потому что мы же знаю это не баги это требование меняются по моему только у одного человека в зале требование меняются либо у остальных 6 вечера по этой причине отбой ну ладно вот решение до смотреть не только на лад фактор но и на количество стертых элементов и значит операции по поддержке хеш-таблицы в актуальном состоянии проводить как бы почаще и дав случая с чонин реализациями такой проблемы нет спиц включить и наконец-то первый хоть какой-то трюк представим себе смешная ситуация ключи просто int и просто их сильно многом и там 64-битные int и фишеру им например в качестве наших ключей исключение никаких нет то есть значение там моль -1 или там 24 6 3 минус единицы мы как некой некий магический маркер использовать не можем внезапно трюк но мы его можем назначить в основной таблицы выбираем произвольные реально значения какие захара какие нам захочется такие и выбираем для того чтобы он помечать стертые либо пустые элементы а соответственно если не дай бог какая-нибудь нам все-таки вставит элемент с таким ключом ну в обоих а ключевых методов в обоих ключевых методов про вставку и поиск элемента пишем к нам пару тройку строк для обработки вот этих двух или одного магических значений если стирание нет то вообще 1 вот невероятно но этот грязный хак работает настолько хорошо иногда подчеркиваю иногда что я вот ожидал что перформанс потеряю намерен хотя бы там не знаю 0 1 процента на синтетическом тесте они намерил падение перформанса совсем никакого мелочи приятного назначили спец ключ и там хорошо сэкономили на размере таблички тут не видом коду простили вот написали конечно убогих проверок но перформанс то остался по-прежнему отличный следующий элемент примере принятие решения как понимаю что скорее всего уже вообще не зайдет я принципе без приходят в сознание сам рассказывают без особого понимая что и несу потом в кулуарах вспомню и расскажу исправлю ошибки но тем ни менее слайда 5 может точно ключи и соответственно значение о чем это вообще как их хранить опять-таки точка принятия решения в реализации своего клевого единственного там верного хэша который идеально решает нашу текущую странную задачу можно ключ и значение хранить в памяти рядом можно хранить отдельный большой массив ключей там на миллион ключей здесь отдельно большой толстый массив на миллион значений здесь как лучше правильный ответ а хрен его знает товарищ прапорщик надо мерить обычно обычно если она достаточно мелкая и условно говоря и ключи и значения влазят в 1 чашки от него кеш line то в этом случае сто пудов лучше хранить рядом просто потому что обратившись ключевым зачастую почти с первого удара найдете нужное вам значение и немедленно получается без дополнительных обращений совершенно другой регион памяти без дополнительных шпицев и так далее это значение соответственно немедленно покиньте об перформанс уверенно растет иногда нет представим себе ситуацию наоборот когда у нас средняя длина поиска какого-то элемента в этой самой в цепочке этом неважно в чин хи ширево по надрез длинная ключи маленькие типа по четыре байта значение гигантские по килобайт у получается что мы если храним их рядом и длина поиска нетривиально то мы скачем и скачи мы скачем по памяти с шагами не меньше килобайта кеш затрачиваем так что этот козёл возможно даже не выживет перформанс будет чудовищный в этом случае сильно лучше ключи сразу сложить от назначение сложить отдельно и за значением в память ходить толстым большим размером в килобайт и вымывать кэш процессора только один раз когда мы перебор ключей уже закончили и вот собственно хотим прочитать значение но повторюсь это вот такой вот дискуссионный вопрос называется в котором на самом деле никакой дискуссии нет делаете benchmark на своих конкретных данных и на своем конкретном паттерне доступа иначе никак предсказать скорее всего не удастся что интересно даже если вы думаете что вы это прекрасно понимаете скорее всего benchmark вас может удивить меня удивлял неоднократно и еще одна пара значит небольших таких комментариев оля трюки в бок если у вас сильно большой плюс что возможно возможно хорошо сработает трюк в табличке первого уровня хоронить не весь ключ как честные а маленький кусок из этого ключа и 2 значит не менее прикольный трюк даже если объекты какой-то сложный объект со сложной внутренней структурой зачастую от того что мы в тупую прочитаем из него первые 32 байта памяти и используем вот это вот в качестве нашего ключа и соответственно в хэш-таблицу сохраним ценить что просто первые 32 байта там при помощи немцы пиллай случае фишечки получены или чего-нибудь соответствующего ишо полученные там в джаве расти и так далее вот тем не менее будет достаточно хорошо ищешь одна точка принятия решения и еще одна точка принятия решения на самом деле две одна небольшая вторая большая первое это хранитель это значения хэш-функции которой мы насчитали или нет вот опять такой дискуссионный вопрос в моей практике типично зависит наверное более всего отключают хэш-функции если у тебя маленькие простенький ключ для которого а там ключи это третье число натурально целое для к и хэш-функция простая условная либо crc32 либо еще проще так называемый там ул отгул кортеж ой хэш который вычисляется в две инструкции процессор той нехрена его хоронить только лишние памяти так далее если эта строчка или там особенно строчка с нетривиальной длиной то в этом случае просто хотя бы для операции изменения размера alpina трясин сша лучше это значение сохранить дополнительной памяти потратим немного а дополнительных операций на перерасчет хэш-функции для достаточно длинных в среднем ключей вот на этом сэкономив и это на самом деле было небольшое знаю небольшая точка принятия решения а вот большая это дополнительное требование какие еще бывают дополнительные требования этой нашей структуре данных и зачем я вообще писать руками есть же стандарт мэк ну вот как бы наверное минимум половина кейсов а то 75 процентов кейсов когда осмысленно это сделать это когда у нас хочется не просто лишь тупорылые хэш-таблицу написать как бы этом beko ce фак ю как бы я вот прошел первый курс средней школы и поэтому могу а когда натуральные появляются какие дополнительные требования к контейнеру хочется от него еще что-нибудь на примерах хоронили не терять порядок вставки в этот хэш и сделать для этого какой-нибудь список в элементах сша который завязывает их порядке вставки или обратном порядке вставки или еще нибудь например коммуне вторичную выборку по ключу делать так далее вот понятное дело что лучше всего с этим вообще не морочится но с пониманием что ради этого всего мы делаем вот пробежались по нашему 8 by тиком повторюсь на кой черт мы это делаем вот у нас 8 педиков в кавычках 8 точек принятия решений они в зависимости от конкретной решаемой задачи разные имеющейся контейнер вам как бы не всегда добавить счастье и тут внезапно тупорылая задачка на которой оказалась бы стандартный контейнер счастью должен дать частотный словарь тупой как палка ой как дрова ой как дрова это папа карло отрезал ли напильник берем текстовые файлы с английским языком буковки от a до z можете заранее регистр в принципе у провести даже до эту и строим частотный словарь этого самого как бы файла вот внезапно вскрываются бездны когда люди которые этого не делала никогда делают это первый раз более того внезапно продолжают скрываться бездны когда люди когда это когда-то делали делают второй и третий раз без до номер один и без на номер 2 без на номер один то что написанное тобой профессиональным программистом на си плюс плюс у которого минимум три года опыта возможные две ходки программа примерно в 80 процентах случаев в средне потолочь на окажется медленнее чем скрипт на php это не преувеличение а возможно как бы наоборот не до стрел это натурально опыт статистика был занят на эксперимент в жизни натурально большое количество содомитов скажем так вот решение этого дела над минимально большого фаре там в условно там мега байтик 23 или там 20 размером оказалось медленнее чем эталонный скрипт на php которому вообще не было никаких требований кроме как обеспечить эталонные результат но вот так вот то есть вот вот так вот мы пишем на си плюс плюс лучше бы на на php писали этот вот внезапно разрыв мозга номер один внезапно разрыв мозга номер 2 вариант номер два который ты напишешь возможно будет нас как бы вот тут статистики у меня нет не буду врать но по ощущениям минимум в 50 процентах случаев вариант номер два которой на ты напишешь как бы так поглядев на скорость это логово решения на php все еще кажется мет видеть его талон на и решения на php после этого доживают до разрыва мозга 3 далеко не все как бы только там самые упорные его то и и или страждущие просветления но разрыв мозга номер три заключается в том что написать вариант который простите обгонит и эталонное решение на php эталонные в кавычках решения с твоим std an ordered мэп вполне себе возможно раз и обогнать его возможно раза в два вот я понятно как бы старые замшелые поэтому пишу носить очки и siplus плюсики вот но чисто теоретически играться в этом в это дело и смотреть как устроено внутри структура данных можно вообще на любом языке даже php умеренно быстро ну тоже на достаточно большом количестве языков там он горазд java и так далее он достаточно быстро от огромного runtime и так далее то что вы сделаете на них руками не должно быть достаточно плохо внезапно кроме начальных 8 значит больших в кавычках поворотных точек в этой долбанной теме про хэши их еще больше вот небольшое количество еще дополнительных поворотных точек которые мы обсуждать не будем но они приводят к ряду ключевых мета мифов и там небольшого количества смешанных фокусов которые обсудить все таки хочется бежим ключевой миф номер один в конте написанное не только вк ну те написано вставать и любой нормальный пока ранен там написано что если вы делаете хеш в него там механизм механизм вот этот коэффициент загрузки то есть сколько у нас элементов написано в эту там большую таблицу размером 1024 или 1 миллион форточки тут 76 элементов ну 0 5 ну максимум 07 но если 08 то как бы фу фу фу ты лабу не сдашь студент тайну 08 у кнута написано 07 ты чего вообще ты на кого батон крошишь в реалиях делаешь бенчмарков скрывается бездна что иногда иногда подчеркиваю от и натурально хорошо работает не оказывает никакого чудовищного влияния на производительность коэффициент загрузки 099 но честно говоря 099 of production ни разу не раскатывал стал все таки вот ну а 0 90 95 работать может хорошо это 1 2 надо понимать что вот этот вот фактор загрузки сколько элементов мы по факту написали в наш большой значит степени в большую степень в таблицу это не так важно не важно сколько у тя там элементов важно сколько ты на каждую долгую операцию делаешь вот как это сказать сделаешь попыток перебора при поиске или вставки элемента если у тебя хэш-функция для всех элементов дает одно и то же значение то даже если тут небольшое количество элементов вонзишь в одну и ту же позицию у тебя получится просто тупо линейный массив только начинающейся возможно не с нулевой позиции и даже если у тебя будет маленький лот фактор маленький коэффициент загрузки кэша то скоро все равно будет плохая это коллизии удаление точно также мешают этому самой этой самой глубине поиска и вот как бы учетом сиськи не не это не показатель там волосы не показатель показатель вот тут и так вот фактор не показатель глубина поиска показатель вот главное это не просрать глубину поиска какой у вас при этом luat фактор не так важно миф номер один не смотрите на него когда пишете свой хэш руками вот миф номер два что хэш-функция должна что-нибудь вот на самом деле хэш-функция никому ничего не должна кроме как быть счастливой и опять же типично типично она должна ну опять может у меня какой то сильно перекошенный взгляд на мир вот во всех применений во всех применений где мне скажем так приходился руками переписывать она должна быть ровно одно быть крайне легковесной очень быстро запускаться и очень быстро считать и тут внезапно лучше худший выбор который в принципе можно сделать это выбор по benchmark у какого-нибудь sm фишера делаю подходим как к снаряду как зайчики там берег берем интернет в руки смотрим что там нам современная наука про хэш-функции пишет идем куда-то выбираем самую быструю функцию одна проблема и и benchmark ли на одном гигантском свалки данных размером 3 гигабайта и там вот на бич марки хеши вам 3 гигабайта за раз она показала идеальный вариант потому что мощно размотан она а вы x инструкции и этом по 256 бать за цикл молотит а мы хэш и роем строчечки от трех до семи байт длиной а у этой супер быстрой функции которая молотит по 256 байт за раз минимальный объем обработки 256 байт работать эта функция в вашем конкретном случае будет чудовищно плохо а когда нибудь плохая в кавычках функция типа crc32 которая в случае с с м фишером тесты не все проходят работать будет ну с точки зрения перформанса идеально вот по тем не менее как бы штука под названием и сэм фишер на мифе номер 22 она все равно приятная вскрывает интересные красивые эффекты ну вот там любимая мною это мне любимая многими функция сердца 32 вот есть ожидаемые красивые эффекты что там коллизии там неожиданная коллизия когда две строчки хэшируется в одно и то же есть неожиданные красивые эффекты когда вот ты думаешь что блин ты туда 100 миллионов элементов запилил уже должна быть коллизия произойти вот и и наоборот не происходит сути это в этом сайт треккинга в том что не всегда функции про которой вам интернет и пишут что они чудовищно плоти и тесты не проходят действительно плохие они зачастую работают на самом деле все равно хорошо тут такое опять таки вопрос вслух но мы риторические что вы думаете за шао но в этом за функцию ш если мы crc32 наша заменим или какую-то другую модную криптографическую функцию на себя лучше поведет нет если мы оставляем от неё 32 бита простите а в случае с хэш-таблицы мы и 32 бит это не оставляем и в конечном итоге оставляем там я не знаю 10 бит для хэш-таблицы размером в тысячу элементов 20 бит для хэш таблица размеров в миллион элементов любая криптографическая функция просто за счет того что вы сильно balabit оставляйте себя лучше не поведет вообще с коллизиями будет та же самая беда с уникальностью возможно будет даже с уникальностью на определенных коротких строчках будет еще даже хуже чем у crc32 спаси господи ну вот миф номер два я наверное уже как бы это в каком-то смысле проговорил не раз что вот идеальная хэш-функция должна проходить все тесты и всенародно любимые штуки под названием с сэм фишер от нет это не так но есть ловушка что она в конкретных случаях опять таки может работать не забывайте смотреть на ваши данные нарветесь на какую интересную коллизию будет неприятно шанс нарваться на невелик миф номер три что хочется медленно опять таки для не позволило мне сделать вовремя benchmark нет кыштым не сказать чтобы медленном количество операций в секунду которой можно выпилить измеряется миллионами иногда наверно десятки миллионов этого скажет у конкретного ядра бояться этого наверное не надо фокусы галопом во все оставшиеся пять минут и сколько там слайдов 6 слоев она тотчас полётного времени в принципе еще если обстоятельно подходить к снаряду у вас есть 5 минут фокусы галопом есть про алгоритмы есть про реализацию они по большому счету как раз вот с теми вопросами с номер девять по номер 16 перекликается вопрос а бывает ли идеальные прямо хэш-функции который прям вот всегда уникальные там никогда не пересекающиеся значения выдает и как следствие помогают там мгновенно находить нужный элемент в нашей супер таблички добывают только их надо строить оффлайн медленно печальные относительно тяжело гуглить ключевые слова г перца мпх если у вас есть какое там заранее построенный словарь языка или там словарь покину в партере и так далее вот эти штуки хорошо работает следующий интересный вопрос или не очень интересный lp на трассе на крыше большие табличке мы вот тут там немного всех предыдущих обсуждениях как бы не явно подразумевали что если вы попали в занятый слот мы пошли за элементом попали в занятый слот ключ не совпал так далее мы сдвигаемся в бок на единичку а что если сдвигаться в бог не на единичку диссертации на этом защищена невероятное количество собственных весь дальнейший слайд про линейной двойной квадратичной кукушкина и матери probing он про это интересный фокус из этого всего это вот как раз значит хеширование имени кукушки в детали и подробное объяснение нет никакой возможности лезть но значит оказывается несмотря на то что коллизии удаления и прочими мразоты эффекты знаете в этих ваших ушах можно сделать такую ловкую схему что поиск в кеше будет работать за константное время как в массиве блин он будет значит ходить и проверять максимум два элемента понятное дело не бесплатно и сайт эффектом является то что зато вставка работает ни хрена не константное время а в один прекрасный момент может внезапно даже решить хэш-функций изменить и полностью таблицы перестроить но зато поиск вот такой вот прям приятно и true real time ago а вот фокусы галопом про реализацию самое интересное наверно но как обычно цинично в конце доклада во-первых и в деталь каждого лезть наверное на пол доклада само по себе можно по-разному украл укладывать данные в памяти можно укладывать данные ключи отдельно значение отдельно можно укладывать их попарно можно делать одинаковое количество ключей значений можно умудриться сделать 1 на количество ключей значений пример мы знаем что у нас в таблице будет храниться там максимум 67 тысяч объектов вот-вот знаем откуда ты все тут 67 тысяч объектов отвратительное число когда у тебя объекты размером 10 килобайт если до степени двойки вниз округлять нельзя не влезет а верх округлять лоб ну как бы да сильно памяти тратим ну вот в этот момент трюк с красные буквы м работает хорошо отдельно хранить ключи отдельно хранить значение хорошо работает трюк менять указатели на индексы вот неизменно поражаюсь натуральный потом просто в тупую меняешь указатели на индексы и вместо того чтобы локациями все долбить сваливаешь все в один пул внезапно получаешь свои законы этом я не знаю 10-20 иногда 50 процентов производительности следующий флажок все уже наверное забыли кроме тех кто фотографировал слайды но флажки про не использую элемент стерты элемента так далее можно сложить это самое значит значение хэша который мы на всякий случай храним хранить их значение хэша типа там 30 бетани 32 все равно у нас и до миллиарда элементов хэш никогда не дорастёт хрен с ним и сэкономим тем самым немножко памяти два важных приятных трюк на закуску что называется фокус под названием муфту фронт представьте себе реализация когда у нас там не знаю 1024 we drove хэши и в каждом ведре внутри вектор простой тупой трюк на каждая либо на каждое обращение либо на каждую вставку мы берем элемент которому обратились и двигаем самым в самое начало этого вектора просто в тупую с вопим вот зачастую дает как бы терминальное ускорение за счет того что часто используемые элементы мгновенно всплывают вверх если почему то зачем то надо делать именно чейни нш ну вспоминаем про 256 вариантов всегда по разному надо то работает терминальные хорошо и еще один значит опять таки тоже интересный трюк су называется не стесняйтесь эксперименты экспериментировать берешь какой-нибудь тут некую стандартную хэш-функцию типа crc32 и совершенно случайно по причине опечатки константу там меняешь натуральная единичку на двойку случайно перебил и внезапно на бенчмарках видишь ускорение на свои драгоценные процентики бывает изредка но бывает если вы хотите значительно упороться можно даже полным перебором пытаться это дела атаковать и под свои данные во время кончилось совсем продолжаем под об это подобрать ее ослабить свои законные процентики производительности еще фокуса галопом про реализацию клёво работает если можно хэш-функции написать так что хеши лишь не по одному байту ключа за раз как дурак но там ключа какой переменной длины типа строки и так далее а по четыре байта за раз в интернета google им какую-то реализацию crc32 которая там раскатывается на работает по блин работает по четыре байта за раз не один опять-таки ловим своей процентики производительности мы же не просто так наверно полезли сдуру зачем-то блин свой собственный хэш писать вместо того чтобы стандартно использовать на с с е хорошо ложится и опять же crc32 каким-то рефреном проходит хотя это и плохо иногда иногда срабатывает фокус под названием мы не проверяем ключ вообще проверяем только значение хеширования значения хэш-функции извините вот из-за коллизии когда у нас тот самый crc32 от слова ольсен хауэр совпадает с блин собачки едой так делать вообще говорят нельзя но иногда в отдельных случаях ну все-таки если очень хочется то можно и вот лишний раз упоминаю про фокус под названием спецназначения ключей таблиц собственно уже почти конец слава тебе господи реализация в языках alpen и чонин alpen и чонин с одной стороны вот фактор с другой стороны и как мы скачем по этим самым таблицам в случае up in a dress in линейно сдвигаемся квадрате чески или как со стороны 3 оказывается что у нас вон в каждом это я как бы где-то спер в ходе подготовки доклада 8 табличкам понравилось оказывается что в каждом конкретном языке все значит делают по-разному совершенно оказывается что человечество до сих пор перри изобретает какие-то там новые методы сделать хэш немножечко там чё-то вот сделали один давайте как-нибудь нестандартно оптимизм чего-нибудь в этом в контейнерах который у вас в салатах лежат давайте поиграемся слот фактором здесь сделаем такой здесь делаем такой сделаем наш собственный benchmark на нем всех победим на чужой бенчмарки соответственно всем проиграем ну вот так чего там слайде важно наверное на мой взгляд на мой взгляд в этом слайде важно то что какой бы язык не выбрали там одна конкретная прибитые гвоздями реализация которая в зависимости от ваших конкретных требований работает повод тем важным 8 поворотным точкам недостаточно хорошо и в какой-то критической точки программы может соответственно производительность терять ну натурально в разы или память терять натурально в разы собственно примерно вот они выводы и есть выводы простые хэш в отличие от какой-нибудь более странный ой более простенькой структур ки странный структурно странный структур ты тоже есть и эта проблема как ни удивительно не универсально решенная для которой есть там идеальное решение которое подходит всем слишком много вариантов слишком много поворотных точек слишком много тонкостей реализации из-за этого мгновенно происходит вот такой вот комбинаторный взрыв вариантов то что вам дает ваш конкретный язык это гвоздями приколочено грубо говоря 1 реализация максиму я не знаю 3 соответственно если если упороться и переписать эту реализацию руками обращая внимание на ток какие у вас конкретно данные какой к ним паттерн доступа какие ключи какие значения какие требования так далее внезапно можно найти себя в интересной значит ситуации когда вы переписали там грубо говоря 100 200 строк кода и схватили очень прилично и улучшение производительности на десятки процентов местами в разы обратите внимание что переписывание руками подобные штуки хорошо сработать не обязана тут вот самая шутку про которая на самом деле не шутка статистика про скрипт на php который там 80 процентов программ на си плюс плюс сорвет однако руками она сработать можно может и выигрыш будет существенный раз и на самом деле несмотря на миллион вот этих вот тонкостей которые я по нему что не зашли совсем о которой я хотя бы попытался опозорить с другой стороны не смотря на все эти тонкости любая конкретная реализация из этих там групп говорят 200 56 и в кавычках вариантов достаточно простая натурально первую версию можно изобразить там я не знаю в 20-30 строк бояться этого не стоит теперь мы значит вроде знаем как написать наш первый хэш и наш первый частотный словарик если зачем-то захочется вроде все котика нет только корабль в бутылке вопросы есть звучит как угроза вот я нашла спасибо за доклад такой вопрос если какие-то особенности в реализации потока безопасной хэш-таблицы ли там по сути имеют оксана весело все ясу скажем так ну любая lock free структура таблиц это как бы если analog фрита это отдыхала cost если она не лоб free окруженном ютэк сам-то как бы это то же самое что и однопоточный только каждый вызов окруженную так сам я бы лично я бы застава пытаться писать лопаре структуру как бы я в принципе уже как бы кукушка иногда еду но хотелось бы чтобы остатки и они как бы со мной остались я не чувствую в себе сил туда ходить вот это выше моего уровня понимания или уровня желания вот такая вот единственное тонкость реализации очень сложно слишком много краевых случаев и слишком много потенциальных raid arrays of memory рейсов и так далее которые чуть менее чем невозможно обработать спасибо скажете вот на слайде где реализации в равенстве реках там у голод фактор 6 половина я во первых как признаешься деталь не капало просто срисовал вот вторых в каком смысле вот этот шесть с половиной я не очень понимаю то есть если у них как будто 8 этим пакет что наверное для того чтобы честно считать надо было шесть с половиной на 8 разделить предполагаю измену но не может же быть что у нас там в шесть с половиной раз больше элементов выше чем у нас элемента в принципе есть вот но как бы просто цинично срисовал спасибо за доклад андрей 6 половине кстати уже больше чем 075 немного 08 получается вопрос такое ты можешь сформулировать список ясных и понятных и всегда используем их метрик когда надо писать свой хэши когда вообще не подходит вот нового языка для любой библиотек список метрик он вот такой как бы метрика по большому счету 1 и к несчастью не очень хорошо формализуем а и вот если ты жопой чувствуешь что в этом мире месте как подозрительно медленно и вот есть такое смутное ощущение что там 10000 операций в секунду это не достаточно хорошо при том что мы как-то прикидываем что блин у процессора там гигагерца my измеряются чистоты и там хэш look up of в секунду если там не 10 миллионов можно делать то 50 вот если есть такое ощущение в какой-то вот точечки то и ты видишь что вот оно упирается туда вот начинаешь копать внезапно выкидываешь стандартный контейнер и начинаешь пилить формализуем а я метр как понятное дело в профайлер смотришь и если есть хоть под который там в хэш упирается спаси господи вектор или куда-нить еще начинаешь заниматься странным онанизмом под названием выкидываем стандартный контейнер и делаем реализацию руками вот ну натурально должно быть какое-то ощущение что с перформансом счет у нас тут вот в этом месте нет то нет смысла переписывать блины хэш который хранит пять элементов итоговый конфиг один раз на запуске программы сложили и соответственно 10 красные ему за все время жизни программы два года аптайма обратились не надо переписывать этот хэш счастье от этого не будет воткните да любой стандартный контейнер части будет тут но вот в нагруженном месте она либо вылезет на ход вспотели бава вылезет у тебя как бы в основном чувствующим органе вот как то так к сожалению у нас не осталось больше времени на вопросов вы можете пожалуйста вылить выделить один какой-то который вам понравился возможно больше всего или заинтересовал черт я не записывал затрудняюсь честном что crc32 предлагают случайно к несчастью еще не дошел до той стадии просветления чтобы в башке crc32 считать наверное давайте при миру им вопрос про многопоточное женой что люди это хорошо что люди в принципе думают о том что программа бывает многопоточной хотя в принципе уже пора спасибо дальше"
}