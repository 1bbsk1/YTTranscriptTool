{
  "video_id": "ooBAQIe0KlQ",
  "channel": "HighLoadChannel",
  "title": "Отъявленные баги и как их избежать на примере ClickHouse / Алексей Миловидов (Яндекс)",
  "views": 10518,
  "duration": 2914,
  "published": "2020-02-26T12:04:03-08:00",
  "text": "как меня зовут чем я занимаюсь я об этом рассказывать не буду вместо этого я лучше расскажу какие бывают проблемы значит ясные вы написали какой-то код сразу готовьтесь к проблемам во-первых у вас в коде обязательно будут баги ну ладно вы написали идеальный код вывоз компилировали но баки в компиляторе и код будет работать не верно ну ладно в компиляторы бак исправили все скомпилировалось запускается работает неверно потому что в операционной системе тоже есть баги ясный вы person система не от богов баки будут железе это неизбежно если вы написали идеальный код он идеально работает на идеальном железе все равно будут проблемой например в конфигурации вы все сделали правильно а вот эти какие-то другие люди допустили ошибку в конфигурационном файле что-то не так и все не работает проблем мог бы тебе заберите ясны пользователи постоянно неправильно использовать ваш код по проблема не в пользователях проблему вашем коде вы написали что-то что трудно использовать ну давайте посмотрим на первом попавшемся примеры таком классическом примеры некоторые из вас может быть с таким знакомый пример взят из жизни из практики но к счастью не моей и очень давно и вообще в другой компании все это происходило не в яндексе не беспокойтесь предположим что вы пишете мапри длилась кластер ты по ходу по вот вызов захотели написать свой ходу какая будет архитектура он будет состоять из некоторое количество серого с данными дата ноды которые просто хранят данные и один или несколько серверов мастер сервер и которые знают на каких серверах какие данные должны быть расположены дата ноты подсоединяется к мастеру мастером говорит скачается такие данные у вас должны быть такие данные эти данные удалите в общем все прекрасно работает что же может пойти не так однажды просто выложили новый файл с конфигурации на все дата ноды и по ошибке эта дата ноды подсоединились не к своему мастеру а к мастеру от какого-то другого кластер и вообще от с тинга ну и чего произошло мастер решил посмотрел на данные о которых ему сообщили дата надо и решил что все эти данные какие-то неправильные надо их удалить отправил команду дата надо пошли удалять все эти данные несколько петабайтов данных удалилась и когда это произошло половина данных исчезла наконец-то кто-то это заметил вот вы кстати правильно делаете правильно делаете что смеетесь потому что некоторые мои знакомые не смеются и как вы можете заметить л часто сцене остаюсь это же чё-то не смешно как-то и вот это такой простейший пример всегда нужно иметь ввиду и так самые эпические баги когда программа непреднамеренно удаляет данные как этого избежать очень просто не удалять данные но напрасно их переносить в отдельную директорию в сторону или удалять задержкой сначала перенесли что они не будут видны пользователям аяз ты пользуется расскажет ой вы в течение несколько дней сможете предложить их обратно ну и конечно если вы видите какие-то данные но они вообще неизвестные неожиданные какие-то странные имена у них тогда просто допустим отказываетесь запускаться в этом случае администратор заметят то что серу и запускается и пишут какое-то интересное сообщение и будет разбираться ну и изоляция от с тинга и продакшна хотя бы там на уровне айпи tables тут можно сказать что если ваша программа делает какие-то деструктивные действия первый пример это удаление файлов но скажем отправка email а это тоже деструктивное действия потому что она съест чью-то внимание поставьте найти деструктивные действия порог типа сотни писем можно отправить боялся тысячу пусть там флажок будет какой то предохранитель который надо сначала выставить перед тем как произойдёт что-то ужасное но это было самое простое про баги конфигурации но конечно большинство баков будут в коде следующий пример тоже взят из практики и теперь к несчастью из моей личной практики а это не про код это тоже про конфигурация значит одной хорошей компании как-то очень странно работал кластер crack house эта компания из амстердама но это к делу отношениями это не индекс кластер работал на почему-то реплики не синхронизировались они постоянно писали сообщения типа этот кусок данных неизвестный я его отложу в сторону а этот кусок данных потерян навсегда ну и конечно первое действие которые делали это просто перезапуска ли сервер но при перезапуске серверу общения запускался на говорит что-то странное очень много неожиданных данных я не буду запускаться надо выставить флаг форсы restore data после того как разобраться ну люди конечно ни в чем разобраться не смогли а просто вы строили этот флаг и половину данных куда-то исчезала графики там получали с дырами но и они обратились камня камня много хороших людей обращается и тут я подумал что здесь что-то происходит интересная надо расследовать разглядывал и всего лишь через несколько часов когда наступило утро и законом стали 5 птички я понял ну сначала я ничего не понял как я в этом разбирался значит из чего состоит кластер коли хаусом там есть и ролик или хауса я серу из гипера серу и кликал сохранять данные звуки пим определяют на каких сферах какие данные должны лежать по сути тоже самое о чем и раньше говорили звуки пер это тоже кластер он тоже реплицируется как правило это три машины у некоторых там пять машин реплицируется по очень хорошему алгоритму распределенным консенсусом со строгой консистентной все должно прекрасно работать и в конфигурации клика указывается сразу все машины звуки пера сразу все три он подсоединяется к любому и с ним взаимодействует и этот сервер уже реплицирует все запросы и так что же произошло оказалось что у них 3 раза гипера но это не кластер звуки про от 3 отдельных маленьких кластера один клик house подсоединяется к одному серу записывают туда данные все нормально реплики хотел сказать эти данные о этих данных нигде нет перезапускаем сервер он подчиняется к другому закипела и видят что те данные с которыми он работал до этого они лишь не надо их куда-то отложить он их не удаляет прикрылся вообще трудно с удалением данных вот мы ничего не удаляем просто перекладываем в отдельную директорию ну я беру в этой директории все данные переименовываю их и дело запрос отточить в результате все данные восстановленные люди довольно и говорят спасибо как будто уже даже забыли как иногда это во всем плохо работало никаких patterned графики без дыр так на следующий пример чего нам все про конфигурация говорит следующий пример конечно про кот кот мы пишем на си плюс плюс это значит что у нас уже проблемы этот баг реальной настоящий из production оправдать 2015 года более свежая пусть там немножко отлежаться потом я буду о них рассказывать и так очень редко пользователи часто ответа на запрос и получает сообщение об ошибке чек сумму не совпадает данные побились страшно или например какой то кэш стал не консистентными там есть бак то есть смотреть код который мы написали сам сообщает нам о том что там есть бак иди исправляй вот ну и чего я по этому поводу думал значит ошибка что checksum они совпадают и данные побились бывает обычно тогда когда данное действительно побились на файловой системе по совершенно разным причинам бывает что сервер counter запускают и часть файла там мусор но об этом потом поговорим но здесь это не так я проверил читаю файл вручную он прекрасно читается checks у нас совпадает если ошибка появилась то она продолжает стабильно воспроизводиться на как при повторе того самого запроса но я со серую перезапустить то ошибка исчезает на время а потом появляется снова и снова стабильно воспроизводится 0 думаю может оперативка неправильно оперативки блюдца биты тасс типичная ситуация но если посмотреть до минска или варлок черный лак то там нету mcf машин человек exceptions который обычно пишут когда с оперативкой что-то не так бы других проявлений ошибки нет потому что если бы на серве была битая оперативка то у нас бы не только моя любимая программа работала бы неправильно но и вся страны это же случайным образом глючили было ничего не понятно нам говорят что в коде мы пишем на си плюс плюс может у нас проезд по памяти да у нас есть тесты по до дыр санитар вот рационе тайлером еще memories ним тайлером отзыв and behaviors они также и они ничего не показывать все чисто допустим что некоторые тестовые кельце не покрыты я собираю сервер с адреса нет азерам запускаю на продакшн и он ничего не ловит тоже все чисто единственное что помогает ясно сбросит кашу некий каждый засечек то на некоторое время ошибка лечится ну и я стал чего делать если непонятно в чем бак можно просто пристально смотреть в код надежда что-нибудь там найти посмотреть изменение которые были в последнем релизе и вот я значит смотрю в код а там бак я его из правил учета не помогло я смотрю в другое место в коде там бак был тоже исправили все нормально я читаю код еще одного разработчика и установил там еще три бага я иду исправляю наш код становится лучше на ошибка никуда не исчезает и это просто другие баги я пытаюсь как-то найти закономерность на каких серверах проявляется в какое время с коррелированы ли эти ошибки то есть относятся ли они к похожим запросом по характеру нагрузки ничего не помогает потом вдруг все-таки понял что проблема проявляется только на одном из кластеров она других никогда нет воспроизводится она не так уж и часто но видно что на одном кластере всегда проявляется после перезапуска через некоторое время на другом все чисто ну естественно на этом кластер и стали использовать новую возможность который мы добавили совсем недавно это каша словарь in a качество war ii использует вручную написанный локатор памяти под названием ориона вызов released то есть смотрите мы не только пешком на си плюс плюс у нас уже проблемам и еще и какие так остальные локаторы песен то есть два 100 обрекаем себя на такие штуки чего такое арена вызов released это кусок памяти в котором память выделяется подряд некоторыми размерами размеры разбиваются по степеням 2 то есть например кусочки памяти 8 байт кусочки памяти 16 32 и так далее а ясно появится сводили то они формируют односвязный список свободных блоков при лист посмотрим на код вот тут код и здесь используется функция содержащая в самом начале подчёркивание бит скан реверс есть такое правило что мест и функция содержат начали одно подчёркивание прочитайте документацию по ней один раз если два подчеркивая прочитайте документация два раза так вот есть функция бит скан реверс и она очень подозрительно выделено здесь красным прочитаем документацию она находит номер старшего выставленного в и денежку бита в 32-битном целом числе местный ни один бит не выставлен то есть это число равно нулю то результат неопределенно о кажется мы нашли проблему что такое app dev and behaviour все плюс плюс эта ситуация которая с точки зрения компилятора считается невозможной и компилятор может использовать эту невозможность как предположение для оптимизации кода правда в данном случае компилятор ничего плохого не делает он часто гирю в конструкцию оси обзор на место дизассемблируем машины код автом видно bsr там какой-то регистр еще какой-то регистр но инструкция bsr имеет не определенное поведение не на уровне си плюс плюс а на уровне процессора если у нас регистр источник равен нулю то регистр на значение не меняется там был на входе какой-то мусор и на выходе тоже останется от мусор так мы на самом деле результат зависит от того куда компилятор поставят эта инструкция бывает что функция с эта инструкция online so bad что нет если нет то здесь будет примерно такой код я его читать не буду хотя он очень простой а дальше я посмотрел например и всего всего такого кода в моем бинарники с помощью о каждом это очень просто fox dan dan арык кликал сервера там глеб инструкции bsr и по функциям функциях связанных с кашу или с ареной и я вижу что иногда регистр источник и регистра назначения одинаковые значит если был там 0 то результат тоже будет 0 все нормально но иногда регистры разная и там будет произвольный мусор то есть мы вроде нашли еще один очередной баг и так как это проявляется этот мусор мы используем в качестве индекса в массиве массе you free листов вместо массива мы обращаемся куда-то далеко по какому-то далекому адресу но нам повезло и все почти адреса рядышком заполнены данными из каша мы портим cash cash содержит смещением в файлах файлы мы будем читать по неправильному смещению из неправильного смещения возьмем человек сумму но там не checksum а что-то другое и этот чек суммы не совпадёт со следующими данными все мы получаем ошибку чек сам должен патчить короп today the к счастью никакие данные не испорчены портился только кач в оперативке нам сразу сообщали об ошибке потому что данные мачек суммирую ошибку исправили вот кстати commit очень старый все данные в порядке и был это 27 декабря 2015 года из правил и пошел отмечать так ну здесь вроде все просто это когда у вас неверный код его хотя бы можно исправить но бывают баги в залезем на самом деле баги в железе это не баке это физические законы по физическим законам железе железо глючат неизбежно но бывает и не только физический закон она и другие неизбежности например вы создали raid1 он состоит из там двух жестких дисков что это значит это значит что ваш сервер один сервер представляет собой распределенную систему чтобы записать данные на рейд массив он должен записать данные на один жесткий диск и на другой жесткий диск и он пытается это сделать но что произойдет если он запишет данный на один жесткий диск на другой данные не записались и исчезла питание у вас данные на red один массив будут не консистентными когда вы будете читать вы будете читать то одни какие-то байт это другие какие-то байты и вы не сможете определить какие из них верны конечно есть способы борьбы это размещение logo скажем за tfsi эта проблема решена но об этом не будем это оставим на потом но в принципе убиты на жестких дисках и на ssd могут портиться просто так скажем современной ssd особенно с многоуровневой ячейками они рассчитывают на то что эти ячейки постоянно будут портиться и единственное что не помогает это когда коррекции ошибок но иногда ячейки портятся так сильно и так много что даже когда коррекция ошибки ошибок не помогает и получается не замеченные ошибки которые не исправлены и то же самое с оперативкой оперативка конечно в серверах с кодами коррекция ошибок если проявляются ошибки это обычно будет видно по сообщениям влоги ядра linux в дамаске но ясно ошибок много вы там увидите что то типа того что исправлен она там сколько это миллионов ошибок с памятью и наверняка что-то будет отключить потому что отдельные биты не замечено бывают ошибки на уровне циpкa можно в кашах циpкa и конечно при передаче данных по сети тут следует задать вопрос а как же checksum эти цепи а как же checksum и озорно там фреймов но об этом потом как обычно проявляются эти ошибки железо приходит нам пищу и он идет хаб с вопросом почему испорчена данные звуки перед влади звуки пера звуки тур и мы пишем небольшое количество метаданных формате plain текст то есть обычный текстовый как бы файл и вот здесь что то не так кто видит дарят реплика написано греб либо очень странно ну я говорю то что очень редко бывает так что из-за багов коде меняется один бит конечно и такой код должен можно написать мы можем написать такой код скажем берем было у фильтр там мы должны изменить битва определенным адресам адреса вычисляем неверно меняем неправильный бит он приходится на какие-то данные все у нас теперь не реплика сколько взял реп либо и на этой reply да все данные неправильно но нет обычном все-таки изменения одного бита это симптом проблем с железом и это типичная проблема не осознаете про такой пример называется бит сквотинг кто знает всего один человек в зале ну тогда я коротко расскажу значит люди поставили эксперимент есть домены в интернете на которых ходят очень много трафика пользоваться туда вручную не ходят но трафика все равно попадает много например fb сидел дот ком но сидят фейсбука они создали зарегистрируют такой же домен но с одним измененным битым например ф.а. сидел на dot com этот домен нигде не опубликован но на него приходит трафик и в трафике иногда http заголовках написано холст fb сидел по запрос пошел на другой хост потому что у пользователя на устройствах неправильная оперативка и оперативка с коррекция особе кто-то помогает не всегда иногда она даже мешает и приводит к уязвимости впрочем об этом я не буду рассказывать читайте про и сиси plaid а вы вот такой всегда чак суммируются данные сами при записи на файловую систему чек суммируется в обязательном порядке при передаче по сети тоже чик суммируете не рассчитывается на то что там есть какие-то ксу мы пойдем дальше и так этот пример произошел совсем недавно продакшен кластер метрики пользователь иногда в ответ на запрос получает исключение checksum манерно поврежденные данные я иду за видел это исключение 2015 году и этот баг мы исправили давно и он больше не проявлялся а теперь февраль 2019 внезапно точно такой же бак и в сообщении об ошибке выводятся очень подробно какой очаг сумма ожидалось какой очаг сумма на самом деле в этих данных размер блока у котором мы проиграем чак сумму и какой контекст исключение то есть мы получили исключение когда мы получали пакет по сети от какого то сервера ну наверно опять проезд по памяти или рэй скользишь all или еще чего-нибудь давайте разбираться стало проявляться 6 февраля 2015 в это время я находился где-то рассказывал доклад и разбираюсь мои коллеги смотрели может релиза какие-то выкладывали ошибка воспроизводится только среди более чем 1000 серверов не оскара сутки тонн одном сервере вас произведется то на другом статистику собрать непонятно как ну и значит разбирались разбирались а потом проблему раз и исчезла сама и мы принял забыли мы про неё забыли а потом 15 мая проблема внезапно возникла снова и теперь к счастью продолжились на и разбираться и 1 стр а дело это просто смотрю подряд все доступные логи и графики полу смотрю так целый день ничего не понятно на графиках никаких закономерностей единственное что остается это любые вообще искать зависимости по процессору мало ли может быть и ядро linux неправильно работать с процессором я не знаю там неправильно какие-то регистры сохраняет загружает посмотрел что-то похожее на 7 из 9 хирургов один процессор который редко но вроде не то проверил ядра linux на разных серверах разные никак не связано ошибки обычно не повторяются но на одном кластере другая ошибка когда битые данные на диске тоже выкидываем гипотезу смотрю в карлаг ничего нету сообщений машинка как совсем тоже нету графики сети в том числе и трансмита тоже ничего интересного поцелуи о ничего не понятно смотрю на сетевые адаптеры которые стоят на серверах все одинаковые на которых проявляется на которых не проявляется вообще ничего не понятно что делать продолжать искать закономерности смотрю на аптайм сыру ров аптайм большое они не падают кстати секс фунтов нет вот когда я вижу что моя любимая программа упала стекол там я всегда радуюсь путевая радость потому что она хотя бы упала гораздо хуже когда ошибка есть и что-нибудь портит а в это никто не замечает ошибки сгруппированы по дням и то есть какие-то пару дней проявляются больше а потом балла проявляются а потом снова проявляются я стал смотреть календарь вспышек на солнце но я его посмотрел и не нашел никакой связи а потом я подумал что наверняка вот часть нашу как она была ночью земля она как-то экранирует эти вспышки на солнце наверное хотя я не особо силён в астрофизике я связали есть астрофизик пусть меня поправят вот так что я так и польза тоже исключаем так но у некоторых ошибок совпадают пакеты и чак сумма которую мы ожидали то есть проявляется на одних и тех же пакетных данных и большинство чтобы к всего два варианта пакетов тут меня очень повезло потому что сообщение об ошибке мы добавили именно саму чак сумму казалось бы кому она нужна сообщение об ошибке но оказывается нужно можно какую-то статистику по ним составить и размер сжатого блока который мальчик суммирую маленький а если мы смотрим от каких серов мы читаем данные по тоже никаких закономерности няться потом я взял какие-то размеры пакетов и посмотрел как они выглядят в hexe потому что мало ли что вдруг я сейчас увижу что все они например равны 0 и x ф.я. я не знаю почему но это наведет на мы слоя запишу этот факт а потом этот факт мне пригодится но пока не прокатился я ничего не понял и чего остается после этого делать поступка не исправлена снова искать закономерности значит ошибка почему-то проявляется только на одного из кластеров причем там тройная репликации появляется только на третьих репликах которые расположены в dc владимир мы так любим называется дата центры по именам городов вот и что интересно февраля было то же самое то есть та же дата центры владимир и точно это была другая версия cliff house а то есть еще одно против гипотеза что мы написали неправильный код мы его уже 300 переписали с февраля по май так что наверняка это все таки не код и все ошибки при чтении пакетов посети ошибка зависит от структуры запроса но иногда на некоторые запросы отличаются константы короче еще одна какая трепаться ну снова ищем закономерности на всех запросах здесь ошибкой появляется есть global джоем но не на всех на одном из них нету тоже отклоняем а потом маленький размер сжатого блока 75 байт и вот самое интересное то что если вывести серверу на которых есть ошибка по именам то эти имена группируются в диапазон и 39 40 41 там 44 потом пропуск потом писать 78 еще пропуска еще диапазона ну я уже совсем какой-то бред стал искать закономерности так можно найти в чем угодно я не хочу отлаживать код с помощью нумерологии но есть ещё одна зацепка то что проблемная сервера стоят каких-то кусках дата-центра у нас дата-центр владимир и там есть так называемые очереди то есть разные его части вторая очередь 34 и вот четко группируется в одних очередях нормальных других проблем и ну и теперь остается отлаживать методом тыка на то что значит вы формируете какой-то гипотезам а вот что будет если попробовать сделать так и собирайте какие-то данные вот я посмотрел в таблицу коверлок нашел запрос такой же ошибкой но где самый маленький размер пакета там был пакет размером 107 я взял запрос который есть скопировал его и выполнил вручную с помощью программы crack house vocal и при этом выполнил с помощью с рейс зачем я это сделал я захотел получить по сети точно такие же пакеты которые получаются при выполнении этого запроса изучите их можно для этого использовать де сепеда dota сепеда мне удобно потому что то мы попробуем выделить среди кучи продакшном трафика то что мне нужно конкретные запросы можно с помощью estrace с помощью estrace можно трассировать сам crack house сервер но этот сервер работает в продакшен и если я так сделаю я получу тоже куча непонятной информации поэтому я запустил отдельную программу которую выпадает ровно один запрос и у него у этой программы уже получил спектры костра из того что передавалась по сети итак запрос выполняется без ошибок то есть не воспроизводится я собой воспроизводилась это все проблема была бы решена и какие то пакеты но я взял и эти пакеты скопировал в текстовый файл и вручную стал разбирать протокол вижу что человек сумма совпадает стой которое ожидалось то есть это именно тот пакет на котором иногда в другое время в других запросах происходит ошибки но пока ошибок нет все нормально дальше я написал простую программу которая берет этот пакет и проверяет что будет какая быть аксума если изменить один бит каждом бойцам запускаю эту программу и раз одна из шаг сумма точно про которую есть жалоба итак снова гипотеза наверно проблема в железе потому что при ошибке в со всех бед флипы это мала вероятность сценарий но неужели после этого можно то закрыть крышку ноутбука сказать это аппаратная проблема мы разработчики мы таким не занимаемся не надо хотя бы помочь немного людям найти где а конкретно это вы пиратишки в жестком диске в процессор и в сетевой карте в оперативке который на сетевой карте светового оборудования и тут было отладка ваза не методом тыка по методам сейчас посмотрим каким методом итак проблема возникала в определенной даты затронуты сера сгруппированы совпадать с тем что было февраля и только в определённых и чердак дата центра и тебя отлаживали уже не методом тыка методом когда вот так игра с человека и три сестры и он скажет обязательно и вот сетевые инженера которые которых мы в компании называем но коми ну их все так называют это не обидно не бойтесь они сообщили что именно в эти даты заменяли коммутаторы на какие-то другие они их заменили снова на те которые были и проблемы исчезло все можно закрывать но сразу куча вопросов возникает почему не помада не помогает память коррекция ошибок на сетевых коммутаторах потому что если есть много битв рипов то они могут друг за руку компенсировать это будет не обнаружена ошибка почему не помогайте себе чек суммой кто-нибудь знает ответ на этот вопрос первое они слабы и если мы в данных изменили ровно один бит точность и печь axle всегда обнаружит изменения ясно и мы изменили два бита была на изменения может не обнаружить они компенсируют друг друга но у нас ведь в нашем пакете изменился только один бит в чем же тогда особенность особенность в том что есть и себе сегмент там изменилось два бита бы от него посчитают checksum она совпала но в этом типе сегменте наша один пакет приложения и мы уже от него считаем свою чак сумма пилот в этом пакете изменился ровно один бит теперь следующий вопрос почему не помогают чек суммой ethernet фреймов они более сильные не такие слабые как теперь кто-нибудь знает ответ почему его абсолютно верно и заводчик сумочек суммирую данные чтобы они не побились при передаче через один вот я могу ошибаться терминологией потому что я не сетевой инженер через один там хоп или большим так через один сегмент но сетевое оборудование она пересылает эти пакеты и при пересылке она может также изменить какие-то данные в них и поэтому чак soul просто пересчитываются мы проверили что на проводе короче не изменилось пакеты все нормально но ясно они повелись на самом сетевой коммутатор и он просто пересчитает checksum она будет другая и пришлет пакет дальше так что ничего не спасают чек суммируются сами не надейтесь что кто-то сделает это за вас итак у нас осталось 3 8 бит на очаг сумма это конечно overkill но на всякий случай и мы корректно сообщаем пользоваться об ошибке то есть данные передаются по сети повреждаются но мы их никуда не записываем то есть наши данные все в порядке можно об этом не беспокоиться и что интересно мы так любим чак сумма что мы считаем сразу три варианта checksum во-первых до сжатых блоков когда описан на диск файл или передам по сети все это чик суммируется когда данное реплицируется мы считаем еще общую чак сумму сжатых данных и общем чак сумму не сжатых данных потому что знаете ли бывают баги в алгоритмах сжатия это тоже известный случай я могу сказать что не бойтесь что так checksum и они не тормозят ну зависит от того какие именно и как считать если их считать от сжатых данных tadano будет меньше они не будут тормозить то есть нюансы но обязательно считаете checksum а вот ну а теперь так ада ещё мы сделали следующее вот как объяснить пользователю когда он получает такое сообщаем об ошибке что это проблема аппаратная вот так вот можно объяснить но сейчас я расскажу подробнее когда мы получаем несовпадение чак сумму на всякий случай прямо перед тем как нибудь исключением я беру и пытаюсь память каждый бит если выяснили что чек сумма сойдется я со изменить один бит то мы знаем что проблема скорее всего аппаратная и теперь вопрос а если мы можем обнаружить эту ошибку и если изменить один бит она исправиться то почему бы ее не исправлять мы можем сами исправлять ошибки до что его абсолютно верно потому что в ясным мы будем все время исправить эти ошибки то пользователь про них не будет знать он не будет знать что в этом оборудовании проблема а на самом деле когда мы выяснили что в коммутаторах проблемы то люди из других отделов стали сообщать а у нас там один бит неправильно записался в мангу а у нас там в по сгрыз какая-то фигня попало и лучше конечно пораньше сообщить что есть проблема ну и самое главное вот такой вот сообщение об ошибке пока пользователь его прочитает все это время он не будет писать телеграмма не он сначала предстоит от сообщая это займёт какое-то время и когда мы выпустили новый релиз с такой диагностика я подумал интересно когда ко мне обратиться первую пользователю которого заработать ну и уже пример через неделю один пользователь пишет что вот такое сообщение в том проблема но он его не ты читал я его говорю наверное скорее всего это проблема с железом местные посмотрите там если на одной ферме проявляется то скорее всего 99 процентов потому что знаете я всегда оставляю 1 процента на случай если я все-таки не про она как-то написал код бывает ну и говорят да заменили создать и проблема исчезла все спасибо так а теперь самая интересная еще одна непонятная штука которая заставила поволноваться детства нас данные яндекс метрики я в один столбец который записывается просто джейсон пользовательские параметры из кода счетчика и вот я стал делать запрос какой-то и cliff house сервер упал сиквел там ну я сразу по ст актрису пойму в чем проблема там недавно был к нет от наших контрибьютором внешних с другой стороны короче я его исправился cold а сейчас так как фолд исчез я запускаю тот же самый запросам что она работает и так проблема следующий я делаю select флик house чтобы получить это джейсон и и что-то медленно работает я получаю конкретный джейсон смотрю оон 10 мегабайт я вывожу его он выводится такой на экран действий копать большой я смотрю внимательно и там написано значит фигурная скобка открывается джейн с errors : cannot find property of a bug that define ну знаете java script код все такое потом двоеточие кавычка xml звездочка а потом дальше она короче пар тошнило какой то какой то мегабайт бинарного ваша кода такое если у вас еще шанс от и включить мы пока пробуете включить у меня пять минут я попробую рассказать дальше и вот она вытащила кучу такого кода я сначала думаю что это такое вариантов много проезд по памяти рейс candychan и зачем мы вообще разработчики пишем этот код на си плюс плюс ясно нас постоянно проезды по памяти рейс candychan если у нас куча таких бинарных данных это еще и очень очень короче говоря плохо там чего угодно может быть все знают помнят про hard блит что в общем-то когда дается дамп памяти это нехорошо так вот я стала смотреть туда внимательнее и понял что не все так просто но в этом году я стал на него внимательно смотреть на эти буковки и понял что что то не так во первых это казалось бы бинарные данные но это валидный utf-8 я смотрю на этот валит найдет на f8 и там кучу каких-то урлов непонятных и какие-то названия шрифтов а ещё там много русских кириллических маленьких буквы я просто квадрат идут такие вот я я и так далее теперь очень рискованно но я все-таки задам вопрос кто знает что особенного в маленькой кириллической букве я это не про яндекс если что чего абсолютно верно в кодировке windows-1251 маленькая кириллическая буква я этот здесь 55 символ а у нас на сервах linux и кодировку windows 10 1 никто не использовать и так можно сделать вот это дамп браузера java script код счетчика метрики собирают java script ошибки то написано java script ошибка такая а потом пор тошнило дампы браузера я сразу обрадовался потому что думаю сейчас я оттуда на эту пароли приватные ключи но никаких паролей приватных ключей я там не нашел но зато сразу отклонил гипотезу потому что сначала я думал что в моей программе в каком сервере бак потом я думал то что наверно программа который туда записывает она тоже написано на си плюс плюс там тоже бака она свой это дампа памяти складывает в crack house но оказывается это просто приехала от пользователям но отсюда тоже нужно сделать вывод яндекс метрика она обслуживает больше миллиарды разных польских устройств и браузера там десктопах из сотовые телефоны и везде отстойно оперативка отстойное железо-то перекрывается это все обязательно будет приезжать мусор и если проанализировать данные в таблицы в которой 30 триллионов строк там можно найти все что угодно и поэтому правильно это просто фильтровать этот мусор перед записью в базу не надо писать в базу мусор я это не нравится на этом у меня все спасибо можно сэлфи вот с тобой с этой штукой подала заявку можно просто ты не представляешь что это значит для меня сейчас о супер спасибо огромное но как ты понимаешь вопросов не будет уж я просто боюсь за людей вот сейчас вполне а еще есть немножко времени и сил и слабость камикадзе один вот пожалуйста задайте такой осторожно я прошу добрый день меня зовут илья спасибо большое за доклад у меня немного отстранённый вопрос про клик house если у вас планы отказываться от звуки пера для репликации делать свою если нет то почему и 2 короткий где можно взять такую футболку про футболку до 2 по футболкам не снимай пожалуйста не надо да вот первый вопрос будем ли мы избавляться от звуки пера у нас есть план предоставить некоторую альтернативу вместо звуки пера и 1 альтернативой которую мы рассматриваем это эти сиди сейчас уже идет работа по этой задачи выделен отдельный интерфейс и один человек как раз пробует подключить дети сидели то есть сделать реализацию этого интерфейса поверх эти сети вот а второй вопрос вы как тот человек который не побоялись задать вопрос получается футболку прямо сейчас по опа опа ну вот мне интересно что быть с вашим сервисом когда вы наденете эту футболку кстати о сущности палате сюда и заглянуть стоит за от который не показывается очень круто сейчас увидели да в боте в готе все будет можно вопрос да еще один честно говоря ушло от начала до конца несколько дней но очень серьёзно да и самое интересно что и на иногда я восстановиться сложно потому что все больше и больше гипотез и каждый раз думаю что вот совсем уже в какие-то добрые идем как представьте вы там дети полюса и собирается грибы и и кажется что уже хотя я никогда таким не занимаюсь и в петербург нее же правильно себя пожалуйста последний алексей отлить отличный доклад спасибо все очень получилось гармонично вопрос такой когда вы вот это все дело описывали представляешь себе один сервер и вот на нем ты можешь и трафик посмотреть и логе да и все один incense но там с маленьким нюансам то что там оказался у нас тысячи инстансов да какой touring как вы это все делали то есть чему это все собирали чем и все смотрели тут несколько таких пунктов 1 я хочу отметить то что разработчики должны иметь доступ в продакшен пусть не особо а просто чтобы посмотреть как все работает иначе все будет плохо и доступ у нас есть второе по поводу инструментов есть у нас в компании два конкурирующих на самом деле уже не конкурирующих инструмента чтобы понять команды на кластере погребать лог пожалуйста вывести аптайм тоже пожалуйста вывести информацию о том какая версия ядра и мы выводим сразу по 1000 сервером точно всякая тысячи серверов можно спросить на одно и то же да и она параллельно пойдет один инструмент по протоколу ssh у другого другой протокол еще более надежной спасибо и жду что еще один вопрос тогда нам светит вопрос к тебе алексей кому мы подарим утешительный приз так утешительный приз будет давать человеку который спросил как долго вы отложили эти баки а вот вы это мужчин до который микрофон не дошел но он на уровне ультразвука задал вопрос мозг в мозг так сказать пир toupper connection алексей спасибо тебе большое за то что все нам положил вот зато у тебя все работает и не тормозит правда спасибо за доклад и прекрасной традиционно вот и тебе тоже утешительный приз и памятные грамоты о том что ты лучший в мире докладчик хайло да вот но мы всем такие даем но просто вот тебе тоже на ты звезда вот здесь звезда хочет глаз покажи ребятам вот отличный супер"
}