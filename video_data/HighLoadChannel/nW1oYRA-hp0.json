{
  "video_id": "nW1oYRA-hp0",
  "channel": "HighLoadChannel",
  "title": "Database First! О распространённых ошибках использования РСУБД / Николай Самохвалов (Postila)",
  "views": 11522,
  "duration": 3388,
  "published": "2018-01-16T13:38:42-08:00",
  "text": "меня зовут николай самохвалов и сегодня мы будем говорить про так сейчас проверим мы будем говорить про ошибки использования реляционных субд e ice queen я глубоко убежден что сердце любой найти системы эта база данных и системы управления базами данных и я также наблюдаю что на узкий album отходят и кстати будет доклад кости 8 пола про то как это происходит он его сам обозвался доклад что просто смерть новый сквер насколько помню завтра утром будет доклад и грубо говоря все но искали cbd которые популярны и они движутся в сторону реализации square если на самом деле старый язык конечно он плохой но во многих смыслах на тем не менее популярный и никуда не денется и я считаю что если вы используете раз обода реляционной субд это не использовать ее возможности которые она представляет особенно базовые это большая глупость глупость которая приводит к неэффективным системам к плохим данным к ошибкам и так далее пару слов о себе я почти 20 лет назад поступил на физтех и через несколько лет нужно было убирать специализацию и вот как раз та самая убежденность что свобода это сердца эти системы уже было тогда у меня и я поэтому выбрал специализацию в исправности институт системного программирования база данных и совершенно не пожалел более того за эти прошедшие почти там 20 лет мы больше 15 я только убедился в том что действительно правильная мысль дальше сделал несколько стартапов в качестве со-основателя сетевое he а вот они представлены этот старый мой круг который уже совсем не тот мир тесен и пастила сейчас развивается далее я участвовал в создании xml типа в подписи уже более 10 лет назад занимался консалтингом иногда сейчас продолжаю заниматься и я в свое время с вами золотухин он основал сообщество московская этом российская по полису еще в 2007 году на самом деле 10 лет назад мы собирали встречи потом немножко утихла и мы несколько лет назад стартанули заново это сообщество и сейчас я очень горд что совсем недавно буквально месяц назад мы обошли группу в сан-франциско и пей-эрия и по размерам и теперь больше них проигрываем только нью-йорку нами на площадке нет обком и вот сегодня всех приглашаю в 7 часов на 4 этаже лаунж-бар у нас будет тоже к неформальная встреча именно сообщества в позу у нас там больше тысячи 300 человек и я посещаю группу в сан-франциско периодически очень горжусь что нам у нас в россию намного активнее группа сейчас хотя до встречи offline последний не всегда частый далее я призываю подписываться на мой twitter если вы интересуетесь под весом особенно после смены ну и ещё я вот уже десять с лишним лет помогаю с удовольствием помогаю составлять программы участвуют программном комитете ride highload и теперь ищу передай раша немножко про вас вопрос кто использует реляционные субд и практически все отлично у кого это преимущественный майской да где то 3 и позже вова преимущественно современно также окей я сегодня буду плохое про мальчика и говорить подготовьтесь и готов спорить отвечать на вопросы и на сцене и и снаружи без проблем есть причины на самом деле о чем мы будем сегодня говорить о том что люди используют cbd я это наблюдаю постоянно включая и новичков и опытных людей они часто не используют то что дает рсмд прежде всего это контроль данных то есть ограничения целостности типы данных и манипуляция данными то есть поиск и изменения данных вот собственно два этих вопроса как контроль качества данных и манипуляции мы сегодня будем весь доклад разбирать соответственно из всего этого вытекают архитектурные ошибки плохие данные баги и так далее люди городят велосипеды причем часто многоэтажные как на картинке начнем с первого части это вот контроль данных и не использование ограничения целостности это даже не ошибка это группа ошибок начнем с естественно с про америке про америке все уже давно понимают что нужен он не нужен особо экзотических случаев случаях когда у нас есть таблица мы не хотим вообще на не индексы например какой то лог там и так далее ну заполните на нужно что он всегда нужен потому что отсутствие про америке это нарушение реляционной модели приводит к дубликатом к аномалиям и так далее и если у вас таблицы выросла без права на лике вам потом нужно его добавлять это получается дорог и долго и нужно зачищать дубликаты любопытный момент если вы используете курить р-н например active record ruby on rails то наверняка у вас ключи 6 таблиц суррогатные то есть это идиш ник интеджер или интер 8 8 байт и и этот айдишник вы считаете что вот у меня есть первичный ключ харрисон модели нарушая все хорошо но как правило это это приводит к тому что люди расслабляются и не делают настоящие первичный ключ ну можно сказать неприлично настоящая натуральный ключ есть такое понятие на черенки что это такое это ключ который должен соответствовать ваши вашему реальному миру то есть в реальном мире у вас какой то признак например в табличке пользователи это может быть email если у вас только авторизация по авто дефекация поимел он должен быть уникальным соответственно это ваш натуральный ключ не аиде раз-два-три-четыре потому что по номеру люди котируются в каких-то нет имел то есть у вас настоящий ключ это имело если в июне уникальные ключ не навесили то есть не обеспечили уникальность по этому ключу то у вас возникнут проблемы дубликаты и пользователи темноту будет проблема понятное дело опять же будет долго и дорого вычищать дубликаты навешивать если таблицы очень большая на самом деле это банальные вещи с которыми сталкиваются люди при начале роста проекта и вот я хочу просто подчеркнуть что если у вас есть рогатые ключи нужно обращать внимание возможно у вас там недостаток еще какого-нибудь уникального ключа есть нужно подумать что у меня за натуральные ключи сделать этот уникальный индекс уникальный ключ далее вот эти первые два они уехали вверх без анимации следующее это внешние ключи довольно старая шутка весь такой в твиттере аккаунт трамп бей которого спрашивает какая ваша политика pap-for инки policy for my creation полисе и он отвечает что нам не нужны форум кен давайте использовать только мире kinky вот но на самом деле и бытует миф что форум диета тормоза это лишняя вещь а потом получается так что у нас есть какие-то записи которые какие-то пользователи созданы они давно уже удалены записи остаются это называется orphans это все осевшие записи сироты и опять же приходится вычищать а если этого не делать у нас возникают аномалии у нас могут быть 404 если там джо и например да да вопрос да вопросы кстати можно задавать перебивать меня я не против 404 легко может быть если у нас там идет join a этого записи пользователей нет вот он 4 4 еще хуже наблюдал много раз что может быть 500 ошибка потому что скрипт при западного что предполагает логик приложения предполагает что автор всегда есть у записи а его нет 100 вообще человек видит в общем это плохо лучше дать sbd возможно сделать свою работу и фу рынке все-таки использовать тогда не придется ничего потом вычищать из 100 миллионов записей следующий четвертый пункт это not налы ну тут все понятно и это мы если мы их не используем и мы можем легко получить пустые данные но напоминаю что нам это значение главный это отсутствие данных данные еще неизвестные возможно будут позже это главное значение конечно вы можете его там варьировать у себя в зависимости от ситуации но задумался нами в таком контексте и если у нас предполагается что допустим имя обязательно в табличке пользователей нам нужно сделать not нал это имя и никто не пройдет всегда будет всегда будет это значение и чистить не придется и наконец мой любимый человек constraint это такие кастомные пользовательские проверки вы можете например навесить что остаток от деления деление на два у числа должен быть 0 соответственно только четные значения будут приниматься нечетные отвергаться и что значение должно быть больше 0 я например что если воздам деньги например хранятся в общем вы можете навешивать причем вы можете эти чеки вешать не только на одну колонку а сразу на несколько какое выражение собрать единственное что от плоскости точно нельзя использовать другие таблицы в этих проверках там нельзя взять и папа select устроить если вы не используете чек constraint стал опять же вас будет мусор опять придется чистить и недавно мой один знакомый консультант он сказал что вообще его половина его работы этот чистка ему на это его работа этот трубочист он приходит очередной проект и видит этот мусор начинает все это очищать кучу скриптов это если таблица огромные это реально большая боль немножко вернемся даже опустимся на уровень ниже на самом деле есть такое понятие как тип данных и в пастбища в том же достаточно жесткая типизация данных то есть вы должны подумать что вас заданные если вам нужна гибкость вы используете джейсон или массивы чист числовые или текстовые но как правило если вы знаете свою структуру будет использовать разные данные и вот разберем несколько примеров допустим вас текстовое поле и вы вообще использует текст или varchar без ограничения на длину и допустим это делаете в том же имени у пользователя к чему это может привести вас газ принципе позволяет засунуть туда войной мир практически он-то гигабайт может принять ну допустим кто-то туда засунул килобайт какого-то текста а предложение по каким-то причинам тоже это все пропустила соответственно вас при выводе может это в пта горстка может если она не обрезала ничего там рассчитывал что что имем небольшой я тоже много раз видел опять-таки болезни роста люди не сделали ограничение на длину имени или сделали вы очень большим и получили проблему верстки или же после они решили что все таки нужно ужесточить и больше допустим 32 символов не давать там 6 с 4к нас будет проблема нужно будет всю таблицу обновлять потому что люблю свой пост должен проверить каждое значение он должен проверить какой там какая длина текста соответственно если таблица миллиард строку нас будет это очень тяжелая миграция и почему опять таки чистка нужно будет обрезать данные и так далее то есть да тут любопытный момент увеличив всегда проще это практически бесплатно то есть вы можете попозже решить дать больше это по полюсам то есть alt alter просто делается и мы давали 100 символов можем дать 200 них не вопрос вот обратно дорого уменьшение дорого увеличения дешево с числами в частности первичных ключах немножко другая ситуация по умолчанию и вы скорее всего будете использовать интеджер 4 байт ней но если это таблица большая я много раз этим тоже сталкивался то это бомба заметно то есть она будет большая в будущем годика через два там появятся два миллиарда строк и какой-то момент представимся работать пользуюсь не принимает больше такие строчки все ложится и причем ложится на долго потому что перейти на and 8 это перестроить всю таблицу долго и дорого и немножко про вот и мелко то я рассказывал что там он должен быть уникальный ключ очень часто вижу какие-нибудь рубис ты или печники они используют там просто varchar забывают в приложении или с в скверах во всех использовать lower и получается что можно завести два допустим или даже больше емейлов просто первая буква большая потом 1 боку маленько человек не может залогиниться у меня два аккаунта и так далее тесто нужно либо везде и всегда как тянуть за всех запросах lower или опер не важно выбрать что-то одно и либо использовать специальный тип данных seo текст то есть контекстный сенситив текст теперь посмотрим что происходит если приложение занимается проверкой ограничение целостности как очень любят люди которые спорят о м но они вовремя просто объявляют что у них там такие такие ограничения до базы данных это не так ведь не всегда доходят всегда превращается в детей правильной и у нас получается такая картинка то есть у нас приложение не важно чем написано занимается проверкой типов данных размеров но каналов уникальности связок ссылочная целостность то что внешние ключи в базе данных и дальше у нас пользователь с этим работать против все хорошо на самом деле не всегда все хорошо потому что я уголок убежден что в плоскость реализовано уже намного лучше чем вы чем вашей rm даже если ночь популярна и я все 0 наблюдаю что часто там просачиваются данные например не уникальные оказываются но еще хуже если вы по мере развития своего проекта решаете вдруг сделать мобильное приложение возвести немножко другой пи ай там что-то какое-то еще софт или же дать админку вашему модератору какую-нибудь стандартную или там просто он просматривал базу как-то работал с данными в общем появляются пользователь которые пользователи или приложения который в обход этого слоя проверки работают с данными соответственно все эти проверки они не работают их не нужно заново реализовывать на том же языке или на другом и начинается общем проблема то есть видно да что это архитектурная проблема что проверки должны быть как можно ближе к данным на самом деле чтобы никто не мог через них пробраться так делать не стоит как надо делать нужно делать в самом пол гости все его базовые возможности которые развивались более 20 лет использовать и там уже столько настолько это обкатана все и настолько все хорошо работает что просто грех это не использовать то есть мы сделаем используем четкую типизацию используемого все возможные виды в лечении целостности я здесь привел только пять есть еще 6 для если у вас есть геометрия или интервальные типа есть эксклюзив constrain за рамками этого доклада допустим вы тут мне скажите как же джейсон он такой гибкий в плоскости можно его использовать очень удобно зачем не все constraint и но на самом деле когда я работал на типом xml был в быту термин 70 вообще то есть слабо структурированы или полу структурированные данные и xml преимущество что можно задать схему различными способами дети дигоксина схемы и общем и другие еще были и это было неплохо потому что вроде гибкость и есть и все-таки где-то мы можем строго сказать что нам вот такие кусочки все-таки очень нужны the brick лают или тип-топ описать так вот с помощью чек constraint а моего любимого можно использовать такой же подход и джейсон после ся вот здесь мы видим что мы объявляем ну да это у нас айдишник кстати big serial на всякий случай этот calls and 8 интерьера 8 байт ней объявляем ч constraint и говорим что ключик color в верхнем уровне славик в наших нашего джейсона должен быть обязательно присутствовать для этого оператора ? есть после этого мы спокойно вставляем вот видите вторую строчку до что colored шеи по тренингам прошел но когда мы color не указали у нас та же ошибка выдалась и все хорошо никто не проходит то есть враг не пройдет и таким образом мы из общение структурированного практически джейсона данных структура там только самим синтаксис самого джейсона определяется мы получаем возможность использовать какие-то хоть какие-то дополнительные ограничения чуть-чуть очищать наши данные и получаем практически тоже полу структурированные данные и теперь обещанные анонсированные несколько слов про масику я размышлял откуда вообще вот такое разграничение что в enterprise мире люди вовсю используют десятилетия уже используют ограничения целостности типизацию они вообще используют возможности sbd вовсю там храним ки пишут не стесняются того ругалась с к дебюту все прекрасно в мире интернет разработок мобильного веба у нас сложилась ситуация что бытует мнение что все-таки лучше там сам все сделаю в базу только буду как сохранять и оттуда простыми запросе коми в общем читать какая такая продвинутая система работы компании убер нами так любит работать я размышлял на самом деле об этом кого-то фоновом режиме потом я думал что у меня доклад будет все-таки не пропуская какой-то пошире но у меня пошире не получилось он получился только по полной попал сбис ну кстати после сейчас по умолчанию реляционной субд и для всех стартапов то что я наблюдаю в долине и вообще в мире это может изменить только проблема с облаками далее я просто перебирала constraint и и гуглил чек constraint и масел и и наткнулся на то что в stack overflow вот проблема она вот такая stack overflow просто стена плача что я объявляю человек константу он у меня не работает и выяснилось для меня неожиданно на многих наверно ожиданно что человека но это это я пропущу что человек инструмент можно объявить мы видим сверху значение должно быть больше 0 а потом спокойно -2 вставить она даже не чихнет даже не вор не гони носится вообще ничего это современный масику а вот современная документация массе кула и включая и 57 и 80 и и общем не понятно что дальше то есть они портятся вот смех пошел ура не используйте mais que al блин ну потому что он он он просто порочат саму идею реляционной субд и вообще собой как можно это делать вообще то уберите их тогда вообще зачем nokia есть мария де бифа рк до год назад и два дня назад они в ирак выпустили релиз в котором есть чек инструменты они как бы работают но мы видим что вы не можете потом после определения таблица добавлять новые constraint и вы можете их только дропать вы не можете изменять их можете только дропать кому и такие нужны правильно то есть это опять мы вот опять сделали опять как-то все вот так вот люди не доверяют с о б д именно из-за этой штуки из-за такого отношения к данному то есть мы я за скобками оставил все то что история последних лет что только давно не сделали более серьезное отношение к типам данных скрытые об обрезании там отброс отброс лишних знаков вашей там ваших деньгах практически и так далее ладно все проехали про майский как нужно делать как нужно исправлять эту группу ошибок во первых во первых отлично тайминг я на самом деле с конце будут чек-лист давать и презентацию скачаете потом может в последний слайд просто распечатать на нем довольно долго работал во первых нужно знать какие типы бывают обязательно в вашей судьбе нужно их понимать лучше например вот я не рассказывал таймс темп лучше использовать сразу ставим зоны потому что тон переходить опять будет дорого опять будет неприятно мигрировать по размеру timestream ставим зоной at these до пункт 0 и он тоже восемь байт также как обычные станция там стемп то есть там зоны он просто знает что клиенту нужно сейчас сдвинуться и выдать значение в другой той зоне это круто то есть он вы знаете что он сохранялся в часе и может быстро для москвы посчитать или другого другой сессии в другом месте посчитать все круто и плюс еще есть рейндже допустим недавно было обсуждение фейсбуке как реализовать расписание когда там филиал открываются в такой-то день там time zone а у клиента другая как все это сделать опять же можно использовать специальные интервальные типы они были быть числовые интервалы либо вот время время начала работы условно конец работы причем можно включить можно исключить интервал там открытой закрытой как из математики и можно добавить вот тот самый шестой тип constraint of сказать что у меня до интервал не должны пересекаться например база в сама будет следить чтобы ни за что не интервалы не пересекались по всем строчкам проверка это очень удобно и там 5-ки операции есть удобные даже индексы есть специально чтобы очень быстро искать какие сейчас филиалы у нас прям сейчас открыты мы находимся в владивостоке какие но сейчас филиалов компании работают пожалуйста эти типы нужно использовать нас тема типов она огромная вот эти 2 pdf это для презентации они там на 100 слайдов каждая одна немножко устаревшая другая вот этого года рекомендую посмотреть знакомиться как референс можно их использовать привычное ключа обязательно обязательно если у нас он суррогатный то есть это просто число какое-то неприметное обязательно думаем какой же у нас натуральный ключ изучаем что такое нормализация как вообще проектировать что коллекционная модель ким книжки читаем это полезно это избавляет вас от ошибок и багов и потом мучительных миграцией перестроений использовав внешние ключи нет полных не использовать когда мне говорят что вот мы там внешние ключи сначала стали использовать а потом пытались что-то там удалите но там что-то очень долго потому что нужно каскадно все удалять оказалось но извините о чего хотели удалить быстренько и всех сил это место туда листа сначала все зависимые строчки они живут на самом деле вас к богам приведут если вы их не удалите и это может быть немножко времени занять но блин это будет более чисто приложение используем на канал используем чеки потому что это основная гарантия что ваше вашей согласованности частоты данных переходим ко второй группе немножко будет сейчас зубодробительной а в плане кода в общем речь пойдет про две вещи про чтения и про модификацию данных про поиск и пропадает одели ты вот пример начинающего печки программиста который делал рассылку там какому-то большому количеству пользователей и сохранял он просто шел поедешь ником юзера иди подряд и сохраняла базу как бы текущее значение этого курсорчик а где каюсь ради мы обработали и что он здесь делал он вот так да я вот сейчас ножка есть нехорошо форматировал ну да здесь замечание что если какое-то одно письмо не отправилась то ничего страшного тем более там обычно же как делают на локальный постфикс он достаточно надежно работает если что-то мучает на код а дальше уже внешне отправляет и вот он потом меня спрашивает как вы еще что то не то да я вот написал такой скрипт к там типа прибавляю 100 но запуская в несколько потоков у меня почему-то меньше увеличивается не над не не на то значение которое я ожидал вот здесь в три потока мы запустили должны были три раза по 100 прибавить а почему то она только один из прибавилось посту но очевидно возвращаемся к этому коду с началом в одной транзакции за select или потом долго что-то слали а постфикс он все-таки там на по 100 миллисекунд каждый письмо может обрабатывать в сумме это будет типа 10 секунд до потом инкрементируем спички и вставляем в базу я могу фантастика а ты не знаешь что можно подарить и написать просто у людей голова часто работает в сторону что давайте мы все таки вот все делать вот в печку вруби в питоне но вообще-то база тоже может это делать более того как бы правильно был это делать мы вначале сразу и читаем и обновляем сложно 100 получаем сдвиг границы берем предыдущих 100 пользователей и и мы обрабатываем если у нас там что-то упало можем еще куда-то сообщить что у нас там что-то не работает но в случае потери там этой пачке не страшно главное что у нас здесь оплата абсолютно никаких проблем с конкурентностью мы можем это 100 потоков запуск ну там 10 потоку спокойно делать и все окей здесь вот я использую если кто не знает реселлинг звездочка это можно в апдейтах дели так можно использовать для того чтобы получить эффект от роуз выбрать их сами и под то есть этот такой встроенный select которые просто одним запросом вы делаете и манипуляцию тоже получаете сыну что вы там меняли вот случае тот будет новый значению случае это будет удаленные значения вот собственный это был новичок дальше переходим удалить демонстрирую что естественно тут прибавка будет на 100 на 300 и никаких проблем не будет дальше ru bist du bist который путник стэнфорда сити хорошего растущего очень быстро стартапа с опытом там человек более десяти лет но у нас только руби конечно он там легко пишет что он пишет такой код здесь вот очень коротко но он ему нужно что сделать вот та самая проблема которая мы в первой части много раза трубочист ская проблема выяснилось что у нас там где-то дубликаты их нужно почистить почистить хитрым образом мы хотим удалить дубликаты оставив только самые саде вот если у нас есть несколько бликов мы хотим только последнее значение поиди самому то есть самое большое и доставить но ему кредит от взять из самого первого то есть как бы такая это вот часто бывает ситуация когда нас comte тел и какой-нибудь там вот этот пин the hockey это все такое сосет данные ваш этому схему звездочка снежинка и у нас почему он системы тоже часто написано не не такими большими любителями субд и опять же причине целостности они очень часто нарушают и не было ограничений а вот это натуральный ключ был потерян ключ был суррогатный возникли дубликаты я чуть попозже даже пример приведу и в общем вот он делает такой ход он грубо им получает ну все вот эти вот за купированы значения сейчас поподробнее расскажу а потом он их получает айдишники 1 ст уделит да вот он получает лишь ники тянет их на клиент выруби потом он этот артист уделит и передает их вот пол это то есть у нас будет делить идеи перечисленный через запятую вставляете что будет если таких орешников у него будет миллион там в общем то есть то есть вот это вот проблема что мой доклад называется databases да я считаю что нужно если мы работаем с данными надо сначала попробуйте как вот мы с точки зрения базы об это сделали с келим если мы с данными работаем лишь только потом если там что-то не так уйти уже в приложении здесь проще было человеку так причем у него очень противно . то есть это просто руку набил как на 3 подробнее это выглядит мы получаем вот группировка по какой-то колонки получаем макса и диетой dinos будет типа иди то есть мы это оставим айди далее мы с помощью агрегация в плоскости очень удобная рэй есть такая штука еще джейсона текст так он просто получает вам либо джейсон либо массив в данном случае бы числовой массив здесь здесь кстати вот у него ошибка на самом деле с картой dice в данной ситуации у тебя опыт всей диз диз следовало назвать ladies и он получает также дату 1 историческое исторически в каждой группе тверской этот потому что потом он ее потому-то дату засовывает в те записи которые собираются оставить и дальше он удаляет лишние записи предварительно вот в предыдущей строчке вычесть вычти из этого массива тот массив который типа иди круто почему бы не использовать сети и одним запросом вы съели то же самое не делать будет тем более он знает это все непонятно привычка и это плохая привычка как бы это было в нашем случае давайте возьмем пример вот табличка московской погоды и мы вот у нас будет флага тный ключ big сериал здесь лишнее конечно потому что у нас не будет столько записи до миллиарда год месяц in2 сделал чтобы экономить место и они но канал да кстати не забыли первичный ключ на канал и есть кредиты the time spent time зоной кстати я использую клок там ст м потому что если вы знаете но это будет только есть функция на она дает вам время начало вашей транзакции если бы использовал все строчки получили бы одну этот один тоже time stop я использую как-то им стенд который дает прям текущее время так что все строчки они там на какие-то миллисекунды будут сдвиги и последняя самая интересная колонка это типа хорошая погода была вообще в этом месяце не очень вот и days 2 что вместо экономит там с немцами зоной чем мы здесь забыли мы забыли натуральный ключ опять у нас есть суррогатные ключи айди но нам мы потеряли знание что у нас в реальной жизни не бывает как бы нам не нужна запись для одного и того же месяце года повторно мы здесь забыли town дуальный ключ типичная ситуация многих многих проектов вот многие рим там с помощью джимми всерьез лагерю от 2000 до текущий год и 12 месяцев выкидываю будущее месяце он меньше до 2000 16 меньше или равно 6 и дальше у нас как бы мод мы заполнили что у нас погода была хорошая какая же на могла быть еще с 2000 года а потом мы вместо того чтобы облететь или там absurd устроить мы сделали просто insert или новые записи и говорили вот счет в мае план погода плохая и заслужу the falls и сделали почему два раза и для июня еще один раз потому что погода сам неплохая вот мы мая ураган еще несколько раз мы все это заслужили то есть у нас будет три дубликата для мая внутри строчки дубль дублирующих для мая 9 июня и вот они здесь видны вот они три для мая 5 месяце 2 для июня и начале шоу true а потом два раза фолз вот хоть и запомните для мая был таймс темп 387 887 да вот пригодится то есть мы по нашей задаче мы захотим взять последнюю запись но для нее устроить запись таймс темпа вот как раз взять самую первую исторически то есть должен быть фолз будет и вот с этим 387 887 как мы делаем а ну да вот я пытаюсь исправить ошибку сделать наш настоящий ключ погоду и месяцу естественно он не дает говорит что там мая 17 у нас несколько записи есть так что нам нужно вычистить дубликаты это та самая работать трубочиста консультанта по базам данных делаем 4 этажной сети сети это популярная штука она и даже в москве есть это стандартная вещь следует его знать мы здесь в одним запросом который стал ансамбль состоит из четырех этажей сначала получаем данные с которыми будем работать уже сгруппированы опять-таки со всякими там массивы me a dish ников потом мы по чем строчки которые мы сохраним чтобы у них вот эти там стемп и были правильно и удаляем лишнее строчки и в конце мы выведем там сколько у нас результат сколько у нас было аффекта throws вот этот запрос и я сейчас могу коротенько разберу значит как также как и в том руби коде мы вначале получаем в общем сделаем select с группировкой погоду месяцу от грубой 12 значит грубая по 1 2 колонки с select предложения то есть погоду месяцу мы берем максимальная лишь некоторым мы оставим айтишник дальше мы там агрегируются des landes дальше мы под получаем здесь cry этот исторический 1 и мы его возьмем потом и засунем в следующем этаже мы правда этим наши записи кстати здесь любопытный апдейт еще очень много всего и это точно такой современный сквер на самом деле он не такой уж и сложный надо его изучать это поддерживает все современные свобода здесь обед с хромом то есть мы говорим что мы оба этим нашу погоду используя данные из вот этого первого этажа как индейцы ставим значение кредиты там где эти шнеки совпадают it offers к этот там гадюшнике совпадают и в конце литерных звездочка означает что мы вернем все что мы все новые данные вернем также мы тут же на лету вычитаем из всех ой дес я не могу ladies использовать потому что они рядом стоят на том же уровне базах еще не видят такой алиас поэтому я за нам по тараверы иди и вычитаю сразу последняя идиш ник опять же я не могу использовать типа иди потому что база не видят опять же тот же уровень но в общем я могу повторить просто это выражение либо я мог бы еще один этаж сделать тому же использовать элиаса но тогда у меня высота экрана не хватило гримм'ов есть подписи начинаются все 93 то есть в вашем пользуюсь вывоз польская всего есть это есть там вычет он просто возьмет из массива всех хотишь ников выкинет этот айдишник который мы оставляем получше массив орешников которым хотим удалить то есть здесь карта одессы и собственно вот здесь мы их удаляем мы удаляем и здесь используем функцию on est которая тоже очень полезная она из массива превращает массив просто грубо говоря la внутреннюю таблицу то есть строчки records эта и вы используете обычный сквер где мы удаляем девичнике в select an с то есть получим магазинчике в этом в этой под таблицы и опять же возвращаем лицом звездочка чтобы для анализа потом в конце вот они лицом звездочка в конце у нас мы получаем мы делаем select каунт из двух этих массивов данных множество данных и 1 говорим это наши запатчены и и оставшиеся выжившие идиш ники строчки а второй это удаленные строчки и вот результат как и следовало ждать июнь-июль два месяца остались а их дубликаты два лишних мая и один лишь не июнь удалились 3 штуки и вот результат еще час select смотрим у нас есть один только мои один только июне посмотрите у мая погода f falls то есть оно не fine совсем ураган был и как раз таймс темп 387 887 то есть этого timestream первой записи который еще был астру то есть мы добились то что хотели нет некоторые полезные вещи если вы все все это вот продвигаете очень рекомендую сквер изучать и продвигать он хороший язык для работы с большим количеством данных он для этого нет ни одного другого языка которые настолько же хорош для работы с большим количеством данных замечание полезные если у нас фиксится наших удалениях апдейтах большое количество строк допустим там миллионы десятки миллионов и тем более если у вас эта значимая часть таблицы там 10 процентов 50 или даже вообще вся то вам нужно обязательно подумать на то чтобы то работу раздробить к сожалению я не стал тратить время это за рамками как я обычно делаю я пишу deep and i do патентный запрос который можно вызывать сколько угодно раз он просто когда кончится пачки он просто ничего не будет делать он будет говорит что эффект от 0 и все или пустую зал сет и вы просто потом в цикле должны этот вопрос вызывать который пачками там по 1000 штук или по 10 тысяч штук можно посмотреть в зависимость от вашей системы как вам удобнее потестировать стоит несколько потоков это делать или один поток отправилась в один поток оказывается также эффективно и как правило то порядка там тысячи строк мы берем и и либо удаляем либо обновляем то есть вот работа трубочиста того самого и просто запускаете важно что здесь дтп звезд конечно но нам нужна внешняя помощь после сам себя не может вызвать даже если вас храним к на переписки или на чем угодно она внутри транзакции сидит и автономно транзакции в плоскости нормальных пока нет поэтому вы не можете запускать независимой транзакции а вам важна именно пачку обрабатывать в отдельные транзакции потому что тогда мы блокируем ненадолго маленькое количество и вакуум то есть если мы грубые должны половину таблицы обновить и делаем это одной транзакции это будет долго с блокировкой все будут ждать отчётом какие там новые значения а когда-то работа закончится нас blocking то есть раздувание таблицы написать процентов таблицы вырастет of the vacuum он не сможет обработать эти записи и пометить их что они казанова готовы для использования физически поэтому если вы сделаете это маленькими кусочками и вас of the vacuum настроен агрессивно это тоже уже такая тебе рекомендация то он успеет их пометить таблица не раздаются физически писать эти циклы можно чем угодно я обычно баши все дела и современного сколь есть очень два хороших источника один здесь присутствует на конференции вчера делал мастер класс просто великолепный максим багу которые кстати на пи джедай будет делать тоже доклад он здесь есть вот это хаотичном как приручить слона танцевать рок-н-ролл свежий доклад но я очень рекомендую ситы четырнадцатом году передай тоже ознакомиться доклад это просто прекрасна как работать с массивами вот эти вот он ест свертки развертки и так далее и рекурсивные сети очень круто сейчас максимум до я просите забыл напомнить что есть надо понимать что там optimizations and есть здесь написано то есть у вас планируем он не знает какие индексы соседнем это же и нужно просто понимать и все но есть еще возможность использовать максимум сейчас фанатов больше later олджон и общем его то можете почитать в семнадцатый год либо приехать в питер следующем месяце и посмотреть на конференцию джедай и есть мак маркус винт это вообще передали великолепный ресурс очень всем рекомендую в яндекс люк маркус обычно обозревает сразу пять су gd включаемая sql oracle и сравнивает их с точки зрения производительности обязательно смотрите от ресурсы там современной съели все про индексы про производительность модном стиле это тоже его ресурс как раз про новые фишки включая сети и оконные функции и так далее здесь следующий пример 23 у нас есть какие-то да это сайнсез или аналитики и они там что-то пишут на или на питоне машин лёнинг все дела и вот они очень часто с очень много данных закачивают а потом я видел там варвар же есть возможность грубое джойана делать прямо там в памяти класс то есть они качают кучу данных а потом это немножко надо и и они уже как бы за джонни ли чет там считают почему была сама собой не заставить делать свою работу и делать эти грубые джон и получать маленьких зал сет здесь демонстрация лагерем с помощью живет всерьез 10 минут строк в америке и в германию их в первом случае получаем только аккаунт но по сути он тоже секстан сделает а во втором мы получаемся строчки здесь я водку то нет потому что я бог слышав пискнул написал он out put файлик делает в первом случае у нас был 3 секунды во втором 22 демонстрация того что сетевая сложность очень важно то есть если мы то есть база может отработал очень быстро с огромным количеством данных уже готовых выдать дальше мы сталкиваемся сетью и если мы гоним гоним огромное количество данных и поток приложение там что-то делаем то это опять таки плохо архитектура то есть нужно подумать как сузить нашу кардинально сеть количество строк сразу же машин лирник есть прямо в полисе такая библиотека безумная кто называется madlib я использую очень рекомендую посмотреть она очень сейчас активно развивается кроме того она работает не только с пользой стану из грим план green planet от компании pivotal когда-то в это был for cad подвеса и он недавно стал open source у нас были мит апы на эту тему его в тинькофф банке используют и по сути это кластерная такая чтобы д который она сразу на многих машинах вы можете делать машин link прямо в суп э.д. и это pelle алгоритмы причислены да тут кстати уже устаревшие они там сейчас недавно еще с графами начали пиджак гугловские реализовали то есть там принципе интересно кнн у них есть теперь в общем интересные вещи очень и вы можете просто сказать сейчас пример покажу то есть это при примерке на пир питон функции на пиль питоне а в плоскости функция они встраиваются в сквер все же время спасибо да то есть охранники и функции плоскость это одно и то же отличие от храним акад функции это то что он храним кем нельзя встроить и легко в москве на функции можно то есть они это вы можете там из этого selected выдайте все что угодно и очень легко начать это использовать то есть вы просто ставите в библиотеку свой подвиг и дальше говорить и вот мне там линейную регрессию потренироваться на таких-то данных и дальше используете для prediction у меня тоже не было времени там свой пример сделать вот я повторил из этого доклада доклад кстати хороший здесь ссылка тоже будет и очень хороший документ который объясняет внутренний алгоритм и там с форума 0 если вы фанат да это sound machine learning вам и должен быть интересно и вы прямо в базе а базе же легко данный искать они вот прямо в общем-то работать с данными ближе ближе к данным это вообще сказка никакого сетевой сложности тут же можно в памяти все сделать потом сохранить я сравнительно сам или поздно начнем в память сохранит и уже вам скажу токио потом уже там будет синхронизация грязных буферов с диском то есть это быстро и в общем то вот 1 фунт одним селектором вы тренируетесь другим select am вы начинаете уже предсказывать по новым значениям в общем клык вашу классификацию устраивать с помощью различных видов регрессии или там рынка форекс или чего угодно саппорт фактор machines там и так далее то есть это общем рекомендую могли посмотреть это очень интересный проект и они релиза делаю довольно часто сейчас он упал source а починку beating и общем хорошая вещь талии в общем так как такой кейс очень часто есть опять же я считаю что спад слабыми возможности в москве ли развились сфинкс solar лице на ластик search они что решают задачу по и полнотекстовый поиск а значит мать тексту поиск это подкласс задач поиска задачи поиска это то что должна делать система управления базами данных они хранения баз данных правильно и окей допустим и даже решили его использовать наблюдал такую ситуацию рубис ты любят пол и газ но так боятся там полна текст использовать им нравится ластик у него там уже все настройки словарей в общем давайте его использовать проходит пару месяцев и менеджер говорит мне нужно админка и в дайте мне админку чтобы я могла использовать смотреть данные и если что быстренько подправить анекдот не не можем потому что будет вот такая ситуация и вы испортите нам данные они впадут в ластик нельзя будет потом искать давайте мы админку будем писать месяц как минимум займет мы напишем админку она будет тоже там все синхронизировать бредятина вот потому что мы можем использовать у нас у нас после съесть мы можем написать свои храним ки которые будут пулять напел питоне антраст от соответственно даже почти можем что-то пулять либо про более правильный путь это использовать фронды the rapper если для нашего источника данных есть такой он поддерживает запись или же сейчас самый правильный путь он уже в пользу снискать есть в десятке который выйдет осенью уже есть бы это первое кстати призываю пробовать есть logical диковинка вы можете свою ли логическую репликацию со своей логикой сделать что из таких the tablets все новые данные кидать нам власть если хочется вообще в этой системы даже вот в таком подходе когда у нас напрямую используется кидает свой ластик у нее есть тоже свои проблемы но это за рамками и так подходим к концу о чем нужно думать и помнить такой подход это без first когда мы для работы с данными рассматриваем средства соблюдать первую очередь он правильный но если доводить все до фанатизма я это пробовал то можем например увлечься и сделать как я например сделал проекте который прямо из база дергает google translate и 5 и переводит текст и мы прям селектор письма bdc и там переводим мы сохраняем или там просто select с триггером в каждом вообще то есть можно так сделать какая будет проблема очевидно что если у нас ничего боезапас одни надо то можем на словах такие функции гонять они у нас могут работать непредсказуемо то есть 200 миллисекунд даже секунду могут работать если внешний pr он далеко и подтормаживает и если мы эта транзакция записывающего мы должны это делать только на мастере соответственно мы потребляем время мастер процесса на пол под гасса и у нас это просто никак не школе руется очевидно то есть мы не можем запускать много потоков просто все будет убита так делать не стоит все-таки здесь работа с внешними ресурсами стоит отдавать каким-то другим вещам то есть нужно написать на но джесс наруби на чем угодно или даже использовать опа на месте например nalu написать плагин для engine.exe далее у нас вот я упоминал уже сети это пример затем френдс это забор оптимизация когда у нас планер он не знает что строки которые пришли из предыдущего за этажа у них там индексы можно было бы использовать он это не едет не видит поэтому здесь мы просто либо это понимаем и используем либо используем later and shown отсылая к максимум руку либо это используем даже намеренно иногда чтобы немножко обмануть планер какой такой своего рода условные hand и получаются иногда нужна внешняя сила как я говорил если нас работа с пачками нам нужно все-таки что кто-нибудь нас вызывал в цикле да и если вы пишете продвинут эскель вы определяете в юшки matter лайс вьюшки вы пишете храним кино чисто москве на переписки или на одном из там 15 языков поза в которой плоскость поддерживает вам нужно озаботиться подсветка кода versio нирования тестирования вот миграция очень важный вопрос миграции призываю посмотреть наши мит апы у нас проходили при миграции разные включая включаем это поэтому планете в яндексе раз разные способы и средства для того чтобы versio не ровать и код не терять и обеспечивать все полную synchronous продакшном далее вам нужно включить режим stand настроек если вы используете храним ки трек для того чтобы почесать statements очень полезная вещь для анализа производительности попадал информация о внутренностях функции ну и либо жить обычным при тренингам и туризма this либо есть профайлер дебаггер но они в готовке немножко сложны и вот обещанный такой слайд который самаре всего всех этих трех частей про типы про целостности про манипуляции с ресурсами призывалась чему скачать распечатать или как то еще использовать здесь вот я постарался собрать все что о чем разговаривал вот собственно у меня все готов отвечать на вопросы спасибо используйте силу под газ а добрый день а вот это никита меня зовут вопрос по первичным ключом погромче немножко по первичным ключом вопрос вот мнение что и microsoft использует своих продуктах такое решение что качестве первичного ключа используют еды вот как вы относитесь к но есть если мне напишите в twitter фейсбук или куда-то я вам скину ссылку на статью и свежая статья которая анализирует размер индексов производительность там все расписано гуидо вам дадут overhead по-любому по сравнению сын тоже 4 интер же 8 будет чуть выше чем это интер 4 ногу и да и в них ситуациях это нормально то есть на вы идете на замере намеренно наверх от например я int 8 очень часто использую в таблицах и просто вам это дает дает удобства то есть небольшой вверх от в современной системе ну ладно то есть обратитесь ко мне вам ссылку пришлю там очень хорошо списана все подписывайтесь на мой twitter у него 300 тысяч подписчиков и там постоянного информация про и скальпа звезд и также немножко вокруг здравствуйте . прости меня зовут виктор спасибо за доклад я хотел бы уточнить по поводу того как правильно использовать например импорт вот если сложная данная импортировать вы тоже рекомендовали бы обойти допустим да язык какой-либо до слое языка например и производить там из csv например сложного который агрегирует там на одной стороне этом 10 таблиц в моей базе стоит ли мне игнорировать язык как бороться томс валидации во-первых я очень вот отмени дали у меня есть такой серия прикольных видео в ютюбе называется you suck at photoshop и там будут рекомендуют очень смешно то есть смешной полезно там если кто-то photoshop до сих пор использует это полезно и есть такой товарищ microsoft из кстати джордж польский может быть знаете да джонсов твои доткомов автор trail мусор скафандр trello co-founder stack overflow он сделал отличный доклад это минут на 40 you suck at xl и он рассказывает как там в excel можно там что то делать я не тот конференции тоже планировал сделать у закат puzzles на самом деле я планировал что показать как мы можем взять какие-то такие грязные данные в csv и практически очень быстро импортировать в пол с грязным варианте и потом быстро ими там жонглировать оперировать есть form by the rapper для сисви вы можете подключить сисви как таблицу очень удобно можете гол спешит подключить как таблицу очень удобно дальше вы делаете create и было select звездочка фронта данная и получается другую таблицу с которой уже можно модифицировать дальше вы как очищаете вот этими у трубочист кими приемчиками и получаете чистую таблицу и сквер самый удобный инструмент для того чтобы такие задачи решать по любому то есть просто он читаем и он понятные он для этого он эволюционировал десятки лет для именно для этого фонда это rappers очень хорошая штука у нас есть даже twitter можно подцепить как форм литературно это извращение можно прицепить свой же в другой плоскость например и он тоже будет redlight и там будет возможность он умный довольно и в десятке будет еще умнее но на деле история не буду время хотим и можем потом съем осудить еще вопросы как времени 11 новый день а вы смотрите вы рассказываете то что то вы first вот тоже даже агрегацию жизни смотрите вы говорите это to be first вы говорите то что обрабатывается свет на уровне базы данных но вот мое мнение очистка или просто не понимаю даже слова есть таблица какое слово дальше я говорю то что вот вы прилагать с вы обрабатывать на уровне баз данных да ну вот и что мне кажется воздано труднее масштабировать поэтому получается под нагрузками они ну как бы будут расти много патч до но это смотрите я рассказывал про внешние ресурсы когда мы обращаемся к унты определенное количество время работать с волос обычно лежит локально его прочитать это ничего не стоит к тому же эти штуки обычно делаются в один поток это не дается юзерам каким-то дает какие-то такие крон тоски to make это да это в принципе один процесс под газ и тут нечего масштабировать даже пожалуйста спасибо за то что прослушали все это"
}