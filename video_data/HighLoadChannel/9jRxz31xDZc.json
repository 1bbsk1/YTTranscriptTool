{
  "video_id": "9jRxz31xDZc",
  "channel": "HighLoadChannel",
  "title": "Новые возможности полнотекстового поиска в PostgreSQL / Олег Бартунов (Postgres Professional)",
  "views": 13235,
  "duration": 3343,
  "published": "2017-04-22T14:48:18-07:00",
  "text": "видите вот эту картинку я ее использую в этом году не зря эту картинку это вот тибетская танка которая обозначает эволюцию значит грубая шаги для медитации для просветления и так получилось мне она нравится я ее купил катманду в непале так она мне нравится потому что видеть его здесь слон слон мартышкой монах монах это вы слон это ваш ум а мартышка этого шага говорится ну то что у вас отвлекает и здесь видите можно в этом году уже 20 лет по адресу вот эта вся моя жизнь но большая большая большая часть моей жизни и она мне вот нравится потому что ведь как процесс развивался то есть сначала вы следуете мартышкой и ваш ум следует за те мартышкой под потихонечку вы начинаете овладевать и в конце концов вы когда вот просвещайтесь ходите состояние просветления уже владеете своим умом и мартышка и так далее то есть это эволюция человека эволюция проекта подлец тоже можно сказать то что вначале мы put вес у нас падал потом он начнет стал хорошей там у нас есть какие то проблемы который потихонечку снимается вот чем чем больше белого тем больше просветленного этот доклад посвящен новому солнечный полые совпало тесном поиски почему я в этом году об этом говорю потому что полотенце поиск на самом деле мы начали развивать там но много-много лет назад и много лет моего назад бросили развивать и вот сейчас как в этом году в версии 96 получила такие существенные улучшения и еще больше расскажу вот и это вот план я обойду все знаешь такую полнотекстовый поиск вот мир о чем многие люди не понимают что полотенце поиск это они воспринимают его предаваться совершенно примитивно найти документ который содержит вот поисковые слова да ну реально же запрос может быть очень сложным поэтому мы употребляем слово матч то есть то что мы четыре он может содержать там анделор и там более сложные вопрос вот типичный поиск этот действительно найти документ который содержит все слова и результаты этого запроса должны опциональное быть отсортированы каком-то порядке вот некоторые люди любят чтобы это было отсортированном виде там по порядку по релевантности то есть насколько документ мочиться матч от это этот запрос некоторые любят этот результат и сортировать по времени например показать свежие документы то есть это все up to you вот тут уже провокации у меня тут патруль или на авито тащи так далее то есть зачем нужен вообще полотенцу поезд базе данных если есть сфинкс вот они прямо стоят и молятся сфинкс финн solar elastic search что вы еще знаете но там много разных дата действительно вопрос резонные потому что все эти внешние поисковые машины они не отягощены проблемами реляционных баз данных они не думают о сохранности данных о транзакциях так далее это чистая такая рабочая лошадка поисковой машины и действительно для многих задач этой внешней поисково машины достаточно многие из вас на века пользуются этой это этим поисково машинами однако полотер свой поиск базы данных во всех практически базах данных он есть ездил по вот таким причинам например что внешний поисковик он никогда не проиндексируют все ваши документы почему потому что внешне по и скидки активируют документами вот над реализованными а база данных как вы понимаете все вы понимаете что документа может быть результат какого-нибудь selecta join и в этом смысле даже если когда вы имейте несколько несколько близ количество вариантов да там которые вы можете произвести документов может быть достаточно большое и вы никогда не сможете отдать все эти варианты внешнего поисковиком то есть в этом случае когда вам требуется это фогг мир с то есть когда вам нужно совершенно определенно что вот из документ надо его отдать проиндексировать и искать тогда до внешней поисковика работает но когда вам нужно писать какие-то сложные запросы да и заранее внимание предсказуемые вы никогда не сможете научить внешней поисковики это их исполнять вот есть такое понятие даже hidden вы знаете такой то есть даже google который там индексирует миллиарда миллиард документов они признают этот факт что большинство документов скрыто от от поисковиков они лежат внутри вас за нах которые вы защищаете охраняете не дай бог дать им доступ ко всяким карауле рам то есть этот факт надо учитывать дальше а внешне поисковики не имеет доступа к атрибутам но вы же зря ими работать с базы данных у вас не просто там документ у вас есть куча атрибутов время кто создал там еще не знаем метаданных полно 200 200 table 200 200 колоночка может быть и вы хотите я не просто же искать документа вы хотите еще добавлять какие-то фильтры каким-то атрибутом order buy группировать и так далее как научить внешней поисковик делать все это я не знаю для этого вам нужно все эти атрибуты просто грубо ряска отдать поисковику и научить пускают поисковик делать агрегата и фильтровать то motorbike грубо и так далее ну вы получите вторую купе базы грубая а иногда бывает это очень важно потому что вот я знаю некоторые системы в которых результаты поиска они зависят от того кто искал скажем генеральный директор он получает болью полную картину скажем какую не тогда минус он получает никто то что ему дают то есть грубо реал зависимости от ролей вы должны иметь со внешней поисковик это сделать не может потому что он этого не знает если вы все-таки решились и ваши систему безопасности еще и скормили поисковику но это вам же ваша проблема то есть внешне происходить становится он начинает понимать все ваши внутренности кухне как у вас обеспечены там пуль политики доступа это неправильно такие базы данных она не только про безопасность данных да а еще про доступ к данным она для этого создана так дальше понятно что внешний поисковик просто так даром не дается его надо администрировать все знают как сфинкс падает как его надо поднимать и к нему надо что-то данные скармливать он там индексирует у вас получается лак лак по времени да там во вид а это 15 минут они специально сделали чтобы страницу сумел проиндексировать на это шучу конечно да она просто действительно иногда вам нужно вам нужно быть отдавать результаты как только они доступны базе то есть мгновенный поиск ни один внешний поисковик на это не пойдет базы данных для этого заточены как только вы положили они автоматически проиндексированы и и уже вы можете их найти сертификация вот это чисто наши может быть российская вещь но иногда вам вы делаете приложение которое требуется пройти сертификацию например для работы с персональными данными скажем после как вы знаете он сертифицирован для работы с персональными данными вы можете использовать своих проектах а скажем взять например сфинкс sphinx например может быть не сертифицирован готовы заплатить пару миллионов чтобы сертифицирует сфинкс но вперед ну и так далее то есть это дополнительно к это но тоже существуют дополнительные проблемы дополнительной оверхеды вот ну и самый последний конечно очевидно это никакой конституции нет многократно бывало так что вы ищете чего-то в яндексе например да нажимаете кнопку а там документ не найден но это вот действительно так что жизнь богатая внешней поисковик ничего не знает о том что там произошло сейчас в данный момент в базе это одни из самом деле причин почему попала тексты поезд базе должен быть их больше но это вот такие которые чуть-чуть если подумать они сразу приходят именно поэтому мы свое время когда делали rambler мы делали мы начали с которым сига имам работать над этим проектом полотенцем поиск базе данных это было что-то там 99 или 2000 год и тогда реляционные базы они были такие смешные они практически не поддерживали не не атомарные типы данных там были такие простые типа данных и благодаря тому что в ползли си существует с нуля самого начала в полисе было зашито я расширяемости нам свете удалось просто тоска говорится взять и реализовать не переписывались панели цивилизовать вот этот весь полна тел свой поиск ну требования которые у нас были это вот чтобы вы понимали это полная интеграция с движком база данных здесь написано что это означает что все это было действительно опасно традиционно и так далее плюс полотенце поиск вы никогда не можете запрограммировать вперед прям как всем нужно чтобы он все-таки мог configure the football достаточно гибкие ну и кого я то что он может быть как-то масштабироваться чтобы он достаточно быстро работал для 100 документов для миллиона документов и так далее тем не менее когда мы начинали нам люди говорили что вот есть же ведь такие операторы вот подвезти есть лайка и лайк там хильда звездочка и так далее то есть разные такие оператор они есть и первые поисковые системы я помню наполнитесь и писались именно так с помощью вот этих операторов но проблема была такая что но не было никакой лингвистической поддержки то есть понятие как штука и слова не было да там что-то стоп-слово не было как там взять разные формы одного слова танков склеить до непонятно было и они были еще очень медленные то есть все эти операторы они их на надо было сканировать всю таблицу фильтровать и при этом результаты они их нельзя было ранжировать все документы были одинаково от были имели дела куриленко с не было понятия релевантности вот кстати в 93 вот видите появился саппорт откель звездочка наши расширения если вы поставите триграммы то тогда вот такая штучка или звездочка будет поддерживаться индексами вот например увидите вот такой запрос можно написать это будет хороший купола текстов запрос но понятно что так так вот писать это у мучаешься никому не понятно поэтому нужно нужен был настоящий нормально движок вот история вся 2000 года то есть вообще говоря патрисом использовались изначально просто как сторож у нас было бы lisk перловые скрипты которые сами использовали свои словари и сами и дробили текст на дотсом из просто хранили в полисе весь поезд тоже проходил в перле потом мы сделали вот без новый индекс это rambler нас поддержал сделали тысяч тысяч 2 2006 году мы сделали вот этот наш знаменитый индексы джин джин который является все думать что это напиток но это на самом деле джинны сказки вот арабских сказок джим это мой среди придумали это название потому что обнаружили насколько к морю мощный этот индекс то есть он может использоваться для очень разных типов данных и он очень быстро и такой универсальный и поэтому назвали вот джином но американцы до сих пор думает что это напиток полноте всех поиск в ядро вошел 2006 году ради этого ноу грабаря нас впервые всех по привезли в торонто всех разработчиков пуговицы и там мы сделали вот этот доклад 2100 году что вот получился поезд в поле не как расширение уже ведре дальше начинается интересна история 2012 году мне захотелось переплюнуть внешние поисковые движке типа сфинкса после ей появилась и мы реализовали ее в виде некого патче называли его там вот фтс миллисекундный поиск и даже мы протестировали на реальных данных который авито дала и на реальных запросов и показали что мой там сфинкс просто рвем просто рядом не лежал вот но за это время но сообщества приняла только из четырех пачек приняла 2 патча вот и поэтому все это развитие иначе так и заголовка он существовал виде какого-то такого не принятого почти мы потеряли некий интерес потому что чтобы его пробить сообщества нужно было очень много провести работы вот и тогда мы пошли другим путем мы сделали в 2016 году в этом году вот саша коротков знаешь как нашей компании он сделал замечательную вещь он вот эту расширяемость пузырь со продлил от от типов данных запросов индексов продлил dax из методов то есть теперь после se любой из вас может написать свой access method для себя и не надо никого спрашивать там писать письма и так далее вы пишете свои расширения и вот когда мы привели появилась у нас это возможность мы реализовали новый вид новый год поисковик вот реинкарнацию от этого миллисекунда поиска виднее индекса к access метода который называется руму rum ром вот переводится ну потому что у нас и все кто знает историю у нас есть еще индекс водка то есть у нас месяца джим водка между ними мм изделия ром вот что вот и room at переводится как really useful метод или rush in usa метод но просто так решили придумали и сегодня будем как раз рассказывать про частности про этот про этот способ начну полнотекстовый поиск в принципе вот один кадр говорить о том что выполняется поиск это просто тип данных для документа вот у нас имеется документ мы просто переводим некоторый другой формат более оптимизирована для поиска этот тип данных и запрос это текстовый тип данных для вот языка запросов всякий and not our скобочки там и так далее тут два типа данных и оператор две собачки то есть вот это и есть получил свой поиск дальше это все уже на нашлепки дальше у нас имеется es que el интерфейс той с помощью сколько month вы можете уже конфигурировать как какой вид токина в какими словарями преобразовать что и как там e-mail обработать таким-то словарем там что стерическое число другим словарем там английское слово так всяк это все можно сделать просто ничего не надо делать с ручками пишите сколь команды вот ну и словари дальше у нас есть пачка всяких функций операторов но это уже такие там чтобы тут и с вектор чтобы текстовую штучку преобразовать втс вектор там тут и и сквере чтобы удобном там запрос на естественном языке преобразовался во внутренний язык полноте сок поиска то есть это уже не снизу не самое существенное ну чтобы быстро работала вот есть дешевый индекс джин яндекс и вот сейчас появился room яндекс вот как выглядит в принципе полотенцем запрос то есть тут и с вектор указывается конфигурация для английского языка вот сам документ две собаки тут я сквере тоже сам конфигурация и вот некий некие язык запросов что кит или ред и и что-то кушает и так они не отнимают ночью вот есть ссылка на документацию вот по ней можно более-менее все понять то есть весь мало текста и пояс на самом деле помещается вот здесь то есть в чем выигрыш происходит тут всех этих манипуляций в том что документ как только попадает базу мы обрабатываем только один раз а используем при поиске много раз то есть мы не занимаемся пар синим документа один раз от parcel и привели их на удобную форму она лежит вот там мы вытаскиваем на и соответственно позиции слов запоминаем позиции слов для того чтобы использовать для релевантности и прочих всяких там упражнениям на самом деле много чего можно делать вот игнорируем собственно и так далее очень проводим какую то обработку чтобы в следующий раз уже эти не заниматься запросам происходит тоже самое практически немного сложнее но происходит то же самое то есть опять же мы нормализуем сало по ним раза чем сетей выражение приводим всякие такие в нём как бы собственного выкидываем указываем всякие vesa которые можно указывать дело то что не все слова соединить с лого имеет одинаковую важность например слова которые встретились заголовке документа они более важное чем слова которые встретились в теле документа и вы можете у нас это их пометить просто есть специальные функции дополнительные которые говорят что когда вы лепите документ из нескольких атрибутов вы можете скажем атрибуты присвоить свой вес и том позже при поиске используйте его для реализации то есть чтобы более важные уходили вверх и для фильтрации говорить например пояс только по тайтлом поезд только там по ключевым словам и так далее то есть это достаточно гибкая вещь вот то есть на этом я кончаю что купол отец свой поиск то есть на самом деле это просто коллекция это он уже работает по молчанию уже можно использовать но на самом деле это просто коллекция эти кирпичики из которых можно делать свой поисковый движок вот так это не у меня это так но кроме полотенцу поиск если вы будете кроме обычного поиска если вы будете думать немного шире вы поймете что на самом деле так как парсер то есть программка которая делит документы документ на части да эта штука которую пользовательское то есть дефолтная до наивному мужчину взять свою то вы можете на самом деле индексировать все что угодно например я знаю поиск химический химических формул берете и говорите найти все документы которых встречается бензольное кольцо пожалуйста существует специальная аннотация химическая в которых она там своими обозначениями записывается и мощных паркер которых понимать нотацию делит правильно работает химики пользуются я потом геномы мы искали мутации например то же самое потому что все вся инфраструктура есть вам уже просто свои дерзкие функции под свои типа данных вот но в целом конечно до пола тесту поиск он заточен под текстовые документы под то что мы обычно наивно понимаем но упал на тесто поисков за эти годы накопились всякие проблемы и люди это понимают и нам писали и поэтому сейчас я кратко проблемы свечу то что сам поиск быстрый а вот ранжирование медленно и действительно вот если мы взяли 150 тысяч документов из википедии про индексировали и вот такой запрос сделаем топ-3 то мы увидим что он исполняется 476 миллисекунд много это или мало это другой вопрос а вот если посмотреть на explain мы увидим что поиск сам длился только шесть миллисекунд то есть сам поиск 60 миллисекунд все остальное время вот эти все найденные тупые надо было почитать из таблицы проверить видимость там да и посчитать ран посчитать ранг отсортировать и выдать топ-3 вот видите вместо 6 милисекунд мы тратим он 47 миллисекунда все это добро действительно нехорошо еще одна проблема это что у нас нет forza у поиска то есть если вы пишете а и b это все равно чтобы и а вот пример например вот если взять архив мыли кристоф элвиса и искать там good то мы найдем 34 тысячи постов хотя реально этот человек написал только 92 это потому что там good он искал со там line например scales где там а где то потом то есть нельзя было сказать что найти только действительно не документы которых тот год вот только там good и одним именно в том в этом порядке то есть не было поддержки фраз и люди занимались тем что делали патентный поиск и фильтровали с помощью регулярных выражений и это как бы работала на этапом опять же был замедляло процесс и самое главное что для сложных запросов это уже было очень тяжело написать регулярно выражении такие третья проблема это то что люди причем это чаще всего люди хотят ранжировать документы не пора не по рангу не про элегантности они хотят получать документы по свежести подати это типичная вот вас есть блог да вы что-то ищете вы хотите получить документ отсортированы по свежести это нормально так вот чтобы позлить это сделать вам нужно было сделать яндекс can по пола тексту индекс can подати сделать bitmap потом почитать хип потом отсортировать и потом выдать то есть очень много всяких операций и вот мы видим что здесь там на вот такой запрос скажем например что делал там lien около 2000 но года у millennium 2000 года и 1 января вот он исполнялся на миллионе всяких там этих пусть постов постов в нашем архиве мы не клестов он исполнялся там пол секунды и вот мы видим что bitmap индекс кран bitmap хитскан сорт там и так далее ну как бы много сложностей а хотелось бы люди говорили хотелось бы чтобы это было за один int проход за 1 дек скан вот мы видим трескать вопрос что что делал там ли вы знаете только the main о the main это человек который которому если вы откроете интернете к споров и там благодарности вот в частности ему там есть там войну the main автор стандарт али джи пи джи пи г автор библиотеки лик jipped вот является одним из лидеров подрисовывать сообщество разработчиков и тот человек которого можно увидеть и увидеть в онлайне или и и ночью и днем вообще непонятно мы раньше думаешь это вообще несколько человек то есть там line на из миллиона чем-то там постингов от всех подвести став нас да он написал порядка 250 тысяч писем то есть у человек он необычайно умны и талантливы и так далее это действительно про него википедия статья есть даже там это человек который обладает очень большим авторитетом среди всех разрыв не только потряси мод и я специально взяла его для того чтобы потому что этот сложный запрос потому что он написал две 70 тысяч писем из миллиона чем-то и видно что видите он чем-то занимался провел фиг сил до нового года после нового года прям сразу то есть как бы принял на грудь и дальше пошел на самом деле я этот вопрос повторил по всем гадам и действительно все во все новые года он что-то делал реально так так извините что то такое у меня так сейчас я быстро скажу что я делаю доклад наш уж такой то так подождите сейчас я они я сейчас делаю доклад как раз прямо сейчас все спасибо так так и вот дальше чтобы понять дальше что происходит нужно все-таки немного напомнить напомнить что такое обратный yandex вот видите что в каждой книжки в конце книги вы имеете вот такой список список слов индекс называется это слово и и страница которых она встретилась вот это и называется обратно индекс очень просто например видите если вы хотите найти какое-нибудь найти страницу которая содержит какое-нибудь слово вы просто берёте слово и сразу видите вот странички то есть вот это называется ключ в обратном яндексе а список вот этот массив страниц на без дорог встречалась называется постинг лист вот возле серовно так джим и сделал очень просто но тем не менее вот при такой простой структуре он позволяет делать сложный запрос например если вы ищете страницы до которых содержат 2 два слова вы просто берете два вот таких массива и делаете джо и грубая и смотрите те страничке которые присутствуют том списке в этом и вы сразу находите мгновенно но все что надо то есть это джин обратный яндекс и как бы он работал но для того чтобы все быстрее работала нам пришлось его улучшить как я говорил 2012 году мы сделали какие-то пачек нему но их не часть из них приняли часть их приняли и поэтому сейчас мы сделали room который отличается уже оджино тем что мы добавили дополнительную информацию вот в этот пусть n 33 вот грубая вот к этим циферкам мы добавили еще некую возможность хранить хоть дополнительно формацию для того чтобы их потом использовать прямо в яндексе например если мы туда добавили координаты вот позиции слов то мы можем прямо в яндексе например высчитывать релевантность нам не нужно ходить в табличку до смотреть позиции и так далее прямо в яндексе и прямо из индекса выдавать документы в нужном порядке если мы там например будем хранить таймс темпы вот я говорю tines темпы the time степа металлинвест мтз до проблем нет разницы нет то мы можем из индекса возвращать результаты отсортированы уже по времени вот вся идея вот а поэтому мы сделали вот такую увидите мы добавили просто-напросто добавим некоторую дополнительную информацию все то же самое осталось просто получилось дополнить формация вот эта штука оказывается дает такие возможности что просто я называю видите вот 96 pandora box на чашку pandora box до открыли вот в 96 из-за того что наши ребята наш sh коротков сделал вот эту возможность создания акциз методов это как бал открыл ящик то теперь любой может писать вот эти все индексы access методы ну и мы написали room вот как один из первых примеров вот например что мы делаем мы ввели расстояние между t сквере то есть между запросом и документам и мы используем позицию для того чтобы вычислять рамки и сортировать теперь мы вот тот самый запрос по википедии который исполнялся почти пол секунды до он теперь исполняется 54 миллисекунды ну так сказать существенное ускорение я знаю что многие из вас борются за 10 процентов 20 процентов 3 спартанская сих пор сразу просто за счет того что появился новый access method то есть первую задачу с ранжированием и как бы порешали вот например запрос найти top 10 постингов с которая содержит слова там line опять же видите он написал 10 лет 2 222 тысячи постингов и вот если использовать джин индекс то мы получаем 1300 1 3 секунды для джин индекса вот он а если мы используем room то мы получаем 200 16 миллисекунд и видим explain очень простой до индекс can индекс can и лимит а там было смотреть сколько всего bitmap индекс bitmap хитскан сорта трав чем короче много всего теперь трубу мы получили гораздо красивее планы и лучше производительность мы используем на самом деле в руме мы ввели новую функцию ранжирования в полисе существует два две функции ранжирования вы можете ранжировать с помощью функции t s ранг s ранг it s ранг сиди вот чтобы их понимать чем они отличается я вам сейчас очень быстро объяснил t s ранг используйте некую статистическую информацию для ранжирования то есть документы присваивать saves она хорошая функция она нормально работают с ссорами например очень хорошо работает ссорами но она не поддерживают всякие логические выражения достаточно примитивно t s ранг сидит она очень хорошее в том смысле что вы можете писать сложно двери ваши может быть довольно сложная и при этом ты с ранг сиди из и учитывать расстояние между словами то есть если вы ищете там line to the main будет лучше ранжироваться чем там бла-бла-бла line то есть это хороший функций test run' в сиде но она как выяснилось не очень хорошо работает с or запросами но она не заточена для эндов заточена в основном и вот когда мы это узнали да мы решили сделать из них как бы лучшие черты собрать назвать ее т эскорт и оно является как бы лучше их обоих но это такой запрос показывает что они на самом деле действительно разные то есть если использовать разные функции они будут немного по-разному ранжироваться вот вот здесь как раз мы использовали это все доказано с помощью знаете такую штуку что это такое это значит грубое американское министерство стандартов nist у них имеются специальные коллекции документов и коллекции запросов которые люди специально своим глазам отсортировали под разные запросы то есть для каждого запроса вы имеете список документов в специальном порядке сделаны человеком и вот все разработчики поисковых машин занимается тем что они свои алгоритмы вот эти ранжиру ищу функции сравнивают с человеческим ну что человек ожидает вот мы проделали такую работу и показали что вот наш тест скоро он вполне себе нормальный лучше чем цифрам сидит раз ранкор но это сложно просто поверьте показать дальше фразовый поиск мы переходим фразу поиск на самом деле 8 лет назад он уже был вопрос про него забыли он там лежал на полке сейчас стряхнули пыль почему потому что появился кураж потому что фразовый поиск если вы просто берете начинает использовать он на самом деле замедляет про поиск потому что вам нужно найти что-то а потом отфильтровать по фразам то есть какой-то вертеп вам нужны доступ координатам слов it over het а сейчас когда мы имеем room индекс вы уже можно прямо в яндексе уже отфильтровать фразы потому что там уже есть позиции слов и вот вот фраза with a и b и бывают разные результаты вот есть такой оператор fall out boy такой красивый оператор он гарантирует порядок операндов и здесь можно указать расстояние между слова pero no me ну грубо говоря вот математическое определение этого этого выражения вот а по жизни это просто вот так что он возвращает либо фолз либо труб и массив позиции правого аргумента вот здесь вот приводится запрос пример что вот например если нет позиции втс векторе то это будет falls а если вы увидите говорим суть чтобы слово а на 1 позиции на 2 то вполне себе работает смотрела слова видите по умолчанию мы говорим что расстояние между ними яичко то есть можно писать яичко либо просто вот такое ноль это специальный случай которые используются для внутренней службы вам он не понадобится делалось что что слова могут возвращать несколько форм и вот расстояние между формами с одного слова это 0 вот в частности видите а себе ласки словарь для английского языка для слова bookings возвращая два слова booking и мбук и расстояние между ними это ноль это на самом деле его норм одном это такой специальный случай это для юзера обычные доступной вот надо следить за порядком операторов то есть начинаем is not и кончаем или потому что если вы хотите четко знаете какой порядок вам нужен надо использовать скобочки тогда все будет хорошо фразовый поиск для того чтобы не писать вот эти все стрелочки и так далее у нас есть функция для ленивых фрей стул skt сквере то есть ведь и например во из этого из этой фразы мы получаем вот такую валютную полнотекстовой то что внутри используется запрос видите вот здесь например пост gostrey extend означает что extend находится на расстоянии 3 от подвеса почему потому что вот эти рыбы они они автоматически учитываются что это суп ствола то есть они запрос не попали но и координации конечно по учитываются то есть вот эта функция фрейд тут с клэри она делать за вас эту работу вы можете сами это написать но она вот делает для ли это работа для вас можно делать опять также комбинировать запросы вот ведь с помощью конкатенации то есть часть запроса может быть с фразами от часть запроса может быть без фраз это уже up to you up ну как хотите можно делать очень хитрое выражение базовый поезд на самом деле не такой уже и простой как кажется казалось бы взять просто наш документ и найти а потом отфильтровать который удовлетворяет вот фразам на самом деле мы делаем преобразовываем запрос дерево запросов дел то что не все операторы нуждаются в координатах получение координат of это всегда некий overheat поэтому мы переписываем запрос в такую форму чтобы сначала шли выполнялись операторы которые не требуют координат если эти операторы вернут там волос то тогда уже дальше вниз просто не идти и не надо будет координата делать вот для всего этого делается вот такая машинерия видите вот этот запрос переписывается вот такой запрос вот так а это дерево переписывается вот в это дерево то есть у нас имеется обычное дерево где не требуется координаты и вот такое развесь это дерево квест требуется координаты что если взять гуль волосу мы туда внести провалимся но и такой оптимизации и для этого существует у нас всякие правило как запрос переписывается кто же до для палаты я просто привожу чтобы вы просто как бы знали но вот видите вот здесь такая хитрая примерно not be то есть зао следует любое но только не б слова вот мы его переписана как вот так видео а and not a b это очень хитрая вещь потому что вот это выражение вы не сможете поддержать index to not чего-то как-то очень трудно это никакой селективности нет поэтому переписывал и делаем сложнее зато это уже вы можете индексировать трансформации вот пример например опять же берем 1 1 миллион постингов is willing листа по адресу и смотрим сколько раз вот сколько он написал письмо вот там ловить и 220 22000 если мы теперь возьмем секрет чего loves к нам просто сделаем фрейд все поиск то мы получим 2 и 6 секунды а если мы использовать будем просто анды и потом риггс бы то мы получим 2 2 секунды то есть мы видим что существует достаточно серьезно overheat на фразовый поиск и еще раз поймите фразу поиск он может быть медленнее чем обычные потому что он требует дополнительные работы вот здесь он достаточно существенно 1 4 секунды если мы добавим теперь джин индекс то мы видим целом становится быстрее но оверхед становится еще больше то есть одна одна секунда и 048 секунды то есть это существенно дальше когда мы добавили room индекс с ромом мы получили практически никого верхи да это связи с тем чтобы уже просто используем позиции которые заполнены в руме то есть румынах действительно сделал фразой поиск юзабельным нормальным отличным так и вот это все уже есть версии 96 то есть фразовый поиск есть арум он отдельно который доступен на гитхабе можно качать в нашем дистрибутиве вот пузыри с правом будет просто так доступно уже дальше а теперь как посмотрим как мы решаем задачу сортировки результатов под во времени мы берем храним tines темпы как дополнительную формацию в этом room яндексе и тогда мы делаем вот такой wiki синтаксис мы говорим мы делаем 2 2 а логичный индекс пола текст дату и говорим что кому прицепить вот просто такой синтаксис и тогда мы получаем 85 миллисекунд если сравнить 45 то есть видите опять же какой простой индекс план индекс can limit то есть если посмотрим индекс кондишен мы видим что здесь вот такой не на бесконечном внутри яндекс к на мы мы делаем полотенцем поиск по тому или и ну и сортируем и его по времени все еще просто а еще дополнительные примеры всякие вот например вот этот пример если мы используем там олейна мир да опять же около 2 2000 года нового года то мы не получим никакого speedup а вот такой запрос и вот такой запрос они будут практически одинаковые то есть room не даст никакого выигрыша почему потому что он лайн это очень частая вещь то есть вам для такого puzzle is он же умный он берет уже не будет использовать яндекс попала текстом поиску он будет использовать яндекс по бы три яндекс по времени а там лэйна использовать как фильтр и в том в том случае это будет как фильтра использовать потому что потом line это частая вещь частое сочетание поэтому выигрыш особого не будет а если возьмете например сервер краж и сравните два запроса то там выигрыш будет десять раз вот на немного просто понимать room дал еще возможность такую штуку делать обратный полнотекстовый поиск знаете что такое брат ипать то есть когда вы ищете запросы которые удовлетворяют документы обычно ищут документ который растворяет запросу а теперь нужно найти у вас имеется список запросов и к вам приходит документ и вы находите какие же запросы удовлетворяют это такое называется обратной полотенце я поиск это другими словами называется собрать подписка то есть у вас имеется пользователи которые подписались под не знаю под билла клинтона и как только вам приходит документ который есть билл клинтон да то есть помощью этого поиска вы можете сразу найти каким каком пользователю его отправить это обратный поиск называются вот пример здесь например вот запросы select сделочку кэрис вот сверхновые звёзды и здесь так теги и когда вам приходит вот такой документ черные дыры там трали-вали так далее мы находим что вот такие запросы подходят под этот под этот документ и тегу них color то есть мы как бы прокате говорили про классифицировали документ но это такой простейший пример на самом деле делать может ей угодно вот я так думаю что многие из вас даже об этом не думали обратном пути поиски ну вот здесь мы например использовал room индекс знаете для чего как мы в дополнительной информации храним вот эти веточки каире 3 вот уж нарисовал красивые картинки такие дерево вот мы храним их в виде дополнительно формации и это позволяет нам в яндексе эффективно уже фильтровать вот запросы и вот пример например самый первый пост нашим или кресте я решил посмотреть какие запросы удовлетворяют вот по колесу отойди ровно 1 оказывается вот puzzle is free везде действительно 1 1 постинг был в main кресте на самом деле был про после сна привезли вот можно посмотреть например вот такие запросы как найти мог такие боли такие постинге спамовые то есть самом деле у нас мы на кресте есть спама выпусники который удовлетворяет практически там большому количеству запросов вот например вот эти постинге это тайтлы удовлетворяет определите 4470 два запроса то есть вот по низко тысяч но если посмотрите внимательно на них оказывается что все нормально это просто большие ветер или снос длинные естественно такой же там естественно встречается все что можно по этому не такие монстры и дальние но этого так как бы забавные примеры использования этого обратного поиска вот а теперь сравним урум с джином вот мы взяли 6 миллионов документов реальных и реальные полотенцами запросы и на 20 на 20 4 ядерном сервере погоняли в течение 2 часа запросы джим и room когда говорю реально и самое на самом деле когда там недавно в 2013 году ловить-то скинул свои вот эти самые объявления несчастные вот эти 6 миллионов реальные запросы к лицу и вот мы сравнивали вот джин был за один час выполнил 258 тысяч запросов арум почти 2 миллиона то есть мы с помощью рома можем действительно реально всем раз у нас быстрее дальше там здесь некое сравнение по поводу того что насколько room быстро до вставку дел то что джин он действительно медленную вставку run тоже медленно вставку вот дальше тут в этой цифры если в них врубаться то можно понять что действительно room медленнее но не сверхъестественно просто потому что арум в два раза больше информации хранит он не просто там хранит он хранится постиг 3 там еще две заполнить информацию поэтому он действительно больше и должен больше требовать но сверхестественно увеличение нет вот пока мы разрабатывали room мы даже оптимизировали команду crate индекс делал то что сам room в 1 реализация оказалось что он генерит там очень большой трафик после потому что если мы вставляем середину страницы то существующая реализация вот этого обобщенного вала записывает вот это все не вот этот кусочек маленький записывайте всё устроим половину страницы фактически поэтому от просто не оптимизация поэтому генерит слишком большой трафик но когда мы сказали что а зачем мы собственно гелем трафика до мы вставляем в дерево потому что если что-то грак грохнется нам все равно чем заново создавать яндекс поэтому давайте мы не будем писать воу воу а просто когда сделаем индекс тогда возьмём пройдемся по дереву и запрещено вал и это позволило нам просто-напросто всё решить то есть вместо 186 гигабайтов вала мэйпл чили нормальные там гигабайт вот и этому некую проблему решили но все равно родовая травма урумма есть то есть на вставку он не быстрый это просто природа этого индекса это чтобы вы понимали когда выставляя когда вы документ добавляете скажем в котором есть тысяча слов вам придется сделать тысячу вставок в дерево это просто природа индекса но зато потом он быстрый вот таким образом и джинны рулон не очень хороши для большей readonly collect с коллекцией но если вы обычно поисковой машины так и делаются но принципе он конечно как как и нормально access method он живет и со вставкой просто и мало он просто медленнее и медленнее чем до 3 существенно и чем gist это вот такая родовая травма то есть мы сделали этот room его можно уже скачать старшего гитхаба с нашего зеркало откомпилировать уже можно пользоваться значит ваши понятно фидбэки нам очень важны реально когда мы в гетто пускали тестирование нам люди находили ошибки давали замечания мы исправляли очень благодарны им за это его то что мы хотим добавить доделать здесь написано вот всегда есть что-то сделать вот спасибо за внимание вот так как время у нас есть есть несколько слайдов других на самом деле еще 4 проблема те кто пользуется полотенцем поиском они обычно говорят что как-то сложно все словари надо инсталлировать в пол и риск какую-то директорию класть да какие то там телодвижения делать перекодировку то мы и так далее все как непонятно плюс еще каждый слова в словаре они жрут кучу памяти то есть словарь загружается в память своего бэг-энда если у вас например имеется чтобы кондратова словарь и каждый словари занимает по 20 20 мегабайт памяти видите вот русский хан спел словари из либо офис он занимает 20 мегабайт то вы можете его кушать существенное количество памяти это как бы не очень хорошо вот плюс к этому требуется атака но это достаточно долго делать запрос то есть например ведь вот я сделал все понимают что сделается 10 раз запускается вот такой запрос слова ивнинг проходит пропускается по английскому ханскому словарю вот прямо ту-ту-ту-ту-ту требуется почти 060 большие секунды на эти 10 запросов несчастных почему вопрос потому что вот сначала первый запрос надо загрузить словарь это 30 диска почитать обработать и загрузить памяти и поэтому требуется такое время а для русского языка требует сашу почти четыре секунды если вы хотите точно такой же потому что русский словарь больше и более сложные чем английский это реальная проблема то есть первый запрос он как бы сервер икает плюс к этому еще требует стопами вот сейчас вот например мы сделали вот скажем здесь сидит артур закиров значит сделали шаре ты спел то есть это тот же самый тимплей для из белорусских словарей а я вот не говорил на самом деле мы поддерживаем словаре все словари is khan & hans пеновский словари и спел русских словарей если брови со как морфология сделали теперь жареными вы можете указать ширины и тогда вот тот самый русский запрос да вот для русского слова туши он выполнялся почти четыре секунды а теперь выполняется 0 1,7 секунды то есть действительно и при этом он загружал загружен жареную память то есть это эти 20 мегабайт шарится между всеми брендами не каждый по 20 мегабайт она всех вот то есть мы получаем для высоконагруженных сайтов вот этот share the spell очень даже удобен и хорошие слова реках extinction вот у нас имеется еще такой extension в нем там сейчас имеется 5 словарей то есть вы просто качаете говорите great extent рашен он спел dictionary и attacks on шансом положит словаре куда надо там все сделает и вы дальше можете только заниматься конфигурацией то есть это уже стало просто ей кстати вот за примеры запросов и видно что например слова именин первый запрос 57 или секунд а русский видите 380 миллисекунд первый раз потом этот доля миллисекунды но первый раз это вот это синдром прерол запроса и здесь можно увидеть пример и например ведь и русское слово туши имеет четыре формы знаете да там push тушат уж тушить тушь это на самом деле является разными форме вот этой то есть почему важны словарь и потому что вы можете по любому из них найти документ вот а вот здесь пример например норвежского словаря нарвешься словарь и вообще очень страшный они же это язык в котором слова образуются новые прикрепления но конкатенации и надо уметь дробить их на части вот видите например футбол clubber это футбольный клуб на самом деле он может быть как футболка club как вот как балыка club это наш мы понимаем все это как это делается так называемые языки они очень сложные немецкий язык тоже не являются таким примером да и последнее что мы сделали вот на что же сотрудник 100 скилл вич он сделал целую пачку функций для того чтобы работать с вектором кто не знает сможет им это не нужно но я вам скажу например примеры какие то есть видите например вы можете каким-то определенным словам присвоить разные важности то есть у вас уже имеется т с вектор а вы хотите каким-то словам сказать что а вот эти слова важны и вот с помощью вот этого запроса с помощью функций все twain от можно сказать что слово подвес и 20 и 21 имеет вот важность а ну пойми пометить вы дадите они пометили и 20 бывает полезно иногда бывает полезно вырезать какие-то лексемы ест с векторы нашли кити матерные слова взяли вырезали витер построили я кстати свое время написал такой антимаг constrain то есть помощью вот этих функций с помощью вообще получился поиска можно написать constraint котором вы можете писать что-то мат матерные выражения грубой написать который будет учитывать с помощью словарей все формы вот это будет расценен работает тест делить там вот он не источник бывает полезно этом они остаться от массива здесь теперь на и сейчас имеется ones that at с вектора элит с верхотуры и вообще превратить с вектор v ray мы такие функции они у за комичны прямо версии 96 они есть а вот еще видите фильтр тоже кстати интересно отфильтровать только столько например вот здесь альт и отфильтровать только лексемы у которых есть важность и а бац-бац получили все остальное на что учитывайте вот и последний слайд это то что действительно нам нужно лучше конфигу он он и так очень гибкий потому что есть скули интерфейс конфигурации но люди нам недавно вы напомнили о проблеме что к как индексировать с документу на нескольких языках и так а реальная проблема и вот оказывается что просто так если мы скажем что использовать словари вот немецкий английский да то это просто так не будет работать потому что так устроен сейчас пола текст что если немецкий словарь и опознает слова распознает то дальше процесс не дает наша вся логика зашито в нем словаре и сейчас мы поняли как нужно сделать мы вытаскиваем логику в конфигурацию то есть появляется такая вещь что мы говорим что сначала вот эти все токены и надо обработать с помощью an extent а то есть все эти теги авто диакритические знаки выкинуть баню да а потом дэн обработать немецкий царем и английским словарем а потом уже простой куни слова отпустить то есть мы вытаскиваем логику из словаря на пользовательский уровень это будет действительно очень гибкость дополнительной гибкости люди могут уже делать вообще очень сложные поисковую конфигурации вот и теперь там вот я помню виде понял что это действительно все так минут в чем время у нас есть я хочу сказать так я хочу сказать что мы не прощаемся что у нас будет в сан-паулу будет мастер-класс где мы прямо будем вам рассказывать больше потрохов полотенца поиска и уже будем показать примеры вот так что у кого еще остались силы и терпения то в сан-паулу прямо буквально через какое-то количество минут на нужно бежать найти еще его будет самый спасибо олег"
}