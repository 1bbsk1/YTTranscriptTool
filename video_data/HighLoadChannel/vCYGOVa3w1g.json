{
  "video_id": "vCYGOVa3w1g",
  "channel": "HighLoadChannel",
  "title": "Логическая репликация и Avito / К.Евтеев,  М.Тюрин, С.Бурладян (Avito)",
  "views": 1258,
  "duration": 6619,
  "published": "2018-08-16T04:07:41-07:00",
  "text": "ну давайте начнем с начала то есть меня зовут михаил я до недавнего времени это все активно разрабатывал сейчас и этим интересно не занимаюсь вот кость возглавляет разработку всем привет да по связан с полюсом говорит из и сергей сергей самый главный босс газ администратор два вида вот значит а до я я один из первых разработчиков этой системы и во многом заложены идеи реализуются и сейчас до сих пор вообще маленькое обобщение патологическая приказы чем все это надо ну как частный случай и нормализации данных до такого если широкого глаза идти на понятно что иногда то что мы нормально положили сохранили где-то в хранилище потом хочется как ты перераспределить исходя из различных условий будь то по требованиям физического хранения то есть какого-то железо сиди сетевой топологии либо для того чтобы облегчаете задачу обработки данных мы делаем где нормализацию данные которую сжали вот на месте когда я оказывался грубого месте возможно при этом претерпевают какие трансформации вот это все это все как раз позволяет нам сделать эти средства те framework и те наработки которые стоит комьюнити и позволит данные перегоняется 1 подписано другой полюс при этом можно делать вот например такие частные случаи как управлять доступом так или иначе в разных местах к данным вопросом масштабирование сразу здесь могут быть решены потому что данные лежат в разных местах и можно организовывать как параллельный парень доступ к вот наше дело интеграцию потому что данные мы начинаем гонять между узлами можно усвоить объединять и разъединять в других как бы приемниках начну решать другие задачи которые соответственно мы вернемся и на примере данных лови так как там у нас передаются данные на то мы покажем значит а также из-за того что мы имеем дело с логической репликацией мы можем в на стороне одной из на одной из сторон наши нашей наших узлов которые принимают данный можно вставить свой код который будет независим от физической физической модели хранения что-то делать по пути перемещения данных вот это все что касается а если это кажется зачем нам нужно вообще вот для этого мы их и и для этого нам нужно так мы видим вот значит мы еще такой момент что это все опять же возвращаясь к истории да то есть так как таковая сколько сейчас декларируются на что подписи на уток сейчас появляется вот но как же как же было до этого да то есть оказывается что другие наработки и какие другие механизмы позволяли реализовывать и собственно пример обидно то что вот она работает это как раз пример того что это все можно было реализовать уже и до того то есть это мы посвятим тоже отдельные деньги потому что откажемся расказывать как это все реализовано те все эти механизмы покажут те пределы технологии которые сейчас существуют и возможности все будет определяться из того как это было как это было сделано не туда так ну костюмы продажей вот я сначала хотел еще чуть-чуть сказать о нике анонса у нас в анонсе доклада есть ссылки на виртуальную машину на который у нас будет вскоре реализовано практикой там же скрипке ссылки на скрипты в которых в каток из которых соответственно будет сергей вам демонстрировать практику так что пока я сейчас буду говорить можно все это копировать себе на телефоны на компьютеры чтобы практика была более полезный продуктивный теперь непосредственно к нашему докладу значит валит мы используем логическую репликацию практически самого старта проекта и уже очень много компонентов реализовано в том числе с помощью логической репликации частности в правом углу вы видите пару ссылок на два последних доклада про построения потоков данных с помощью логической репликации непосредственно одесскую аппликацию мы используем для реализации доставки справочников когда мы в одном месте меняем справочнике далее доставляем все эти изменения по всем нашим сервером распределяем нагрузки как в классическом виде так и достаточно специфичные об этом я буду говорить позднее показывать также у нас используется частично репликации когда необходимо доставить в сервис данные например определенной категории или определенные группы пользователей для сервиса доставляем данные в поисковую подсистемы в данном случае речь идет о доставке данных во внешней индекс в до нашем случае это сфинкса реализовали модель persistent на очереди персистенции очередь это наш некий такой паттерн когда мы берем и собираем со всех таблиц которые необходимы для различных аналитических расчетов изменения наконец транзакция и далее гоним с помощью логической репликации на один узел и впоследствии биой команда по необходимости может светлый лучик узла бесшовно вычитывать эти изменения и в том числе там хранится такое некое окно и благодаря этому окно можно в любой момент взять и перечитать данные что-то пересчитать также с помощью логической репликации мы реализуем и межсервисные взаимодействия теперь давайте взглянем немножко в историю как вообще какие вот основные моменты повлияли на текущую архитектуру логической репликации изначально девяносто девятом году то есть первый шаг это который был это наш соотечественник в один михеев за к метилом и сессию в пол игры с версии 653 энди сиссе и это мальте вершинного конкор настя control это инструмент который с помощью которого под колеса реализует работу многопользовательской среде то есть грубо говоря каждый backend видит некий snapshot и свою версию данных и за счет этого это большой как профитов производительность и с другой стороны у каждого клиента грубо говоря получается своя свой snapshot который имеет данные все согласованные более поздние мы об этом подробнее поговорим далее он же вадим михей в 2000 году понял что с помощью того что если мы вытащим идентификаторы транзакции вот эти вот снапшоты наверх мы сможем реализовать логическую репликацию в 2000 году уже появилось первое решение это реп skype один михеева далее в 2001 году в полисе появляется в right ahead лоб изначально университетской реализации под газ не было никакого right ahead бога и в 2001 году пришли к тому что вот это вот реализовывать как сказать сохранность данных при ответе коммита клиенту без right ahead logo достаточно затратно то есть придется ивсем кать кучу и вот непосредственно тысячи первом году появляется right ahead бог а для нас он в том числе интересен за счет того что все вот изменения для streaming репликации дарья для логической репликации как раз вот хранятся во вред ahead логин 2004 году я навек переосмысливает решение вадим и михеева или появляется за решение слоя репликации 2005 году возле закормить или point in time recovery по факту вы уже могли написать некую команду и сказать восстановиться к некой точке во времени но некоторые люди заметили что это можно использовать и для реализации стенда и вот михаил как раз может нам рассказать как он в то время реализовал жестом buy то время отпуска сам работали вот стенд бай который появился позднее он как раз внутри пояса положил тот цикл который люди квали restore команд то есть и весело ты на почему все это интересно потому что текущая ли зация диска индикации которых десятки появилась на оно произрастает вот как раз из до этого существовавших связью между мастером и репликой физическими и вот эти механизмы в red hat logo поинтами recovery снг и понимание как бы но позволяет он мере понять как часов работала диска репликации и забрать их от это некая очередь с изменениями которое идет вот а стендбай постоянно в цикле потребляют эти изменения и мы имеем реплику актуальную таким каким то никому же смысле актуальную мастеру так вот да существование стрельба я там еще версия 80 уже был уже уже такого небо из коробки но люди поняли что если команда не завершать для подвеса restore команда постоянно внутри в цикле доставлять вовы и за филата под любые постоянно применять эти валы и некое вроде получается по чувак пожалуйста нба и почему это еще интересна потому что вот с этого момента как раз началось том что моё знакомство с sky с разработками skype в то время skype активно как раз становился и они много сделали для после скамейке их фреймворк sky тулс включал себя скрипт который можно было встроить в restore команды по декабрь и команду и столь команду и получать из запускающего с сервера в режим восстановления получается его собственно тогда как раз я начал заниматься скай скай скай tool from work on а там том числе оказалось вот еще и другие инструменты частности автоматически прекрасно которым еще много времени уделим вот да как раз в 2007 году произошло следующая команда skype переосмыслила решение уже я навек к вадиму михеева и реализовала более простое решение за счет того что framework был написана искра или он был понятно читаемые а демоны написаны на вся обвязка на питоне и в принципе тоже всем читаемое если вам например интересен другой язык в эту обвязку могли написать на том языке который вам вот принципе более удобен и понятен 2008 году появляется стенда из коробки в подгрести именно поэтому до сих пор очень много в продакшене версии остается живы старых 83 за счет того что уже реализовано высокая доступность функционала той версии хватает для своей задачи 9 по сгрыз десятом году который появился в нем появилась впервые возможность переключать чтения на стендбай таким образом вы смогли масштабировать нагрузку почтения со стенда с другой стороны появляется streaming репликации это тоже очень интересный такой момент если до этого вам необходимо было реализовывать некую обвязку скриптов в которой вы реализовывали сначала доставку в архив потом из архива нужно было идти вала доставлять нас тэн байта сейчас вы просто подключали стэн байк мастеру и который подключался протокола ли pq и соответственно уже потребляется изменений овалов и и санбой работает тринадцатом году появляется следующая фича возможность подхватить the nba им новый timeline то есть представьте себе аварию когда у вас есть мастер дали он падает и вы переключаетесь на новый сцен боялась допустим есть еще несколько сцен боёв и до 13 года вам приходилось бы пересоздавать другие стендбай а в данном случае они научились подхватывать это томат timeline и соответственно все работало по факту только вот финансам году промышленно можно можно было применить в сложных инсталляциях которые существуют реальные практики streaming репликацию 2014 году реализовано одна очень важная фишка одна из фишек это slade и репликации что это такое до этого в случае если у вас на стенда и возникал какой-то аварии которая препятствовала проигрывание вала или были у вас какие то сетевые аварии у вас могло произойти следующее валы на мастере за ротируется и стенда я уже не сможет догнать мастер без дополнительных манипуляций то есть если у вас есть архив тогда вы могли бы данные из архивы поднять если архива нет то придется пересоздавать стендбай соответственно 2004 14 года появилась возможность создавать слот рипли кации который препятствовал ротация этих валов но с другой стороны это вас обязывает к тому чтобы следить за тем что ваш тендай работает иначе в случае аварии на стенда и ваш мастер может уйти по переполнению диска за счет того что там накопится вал оффы займут везде столько же предыдущие замечательный много времени уделял и вторая интересная вещь это logic олди coding то есть в пастбище 94 появилась инфраструктура которая позволила получать изменения которое вы производите с помощью секу elia и стримить их наверх клиентам для реализации задач аудита или задач логической репликации что собственно говоря как extension отсеком квадранты сделал он реализовал повело jackal примерно в те же годы и в 2017 году мы уже видим логическую репликацию из коробки в пост грехи 10 позднее мы а не будем говорить более подробно теперь давайте просмотрим как работы что такое вестись и значит puzzles предоставляет три уровня изоляции транзакций это рид комитет когда транзакция видит все изменения которого нет раза когда команда видеть все изменения которые закончились сначала команды реббе творит когда вы видите snapshot на протяжении всей транзакции и сериала и fable когда транзакции выстраиваться в некую цепочку одна за другой вот вот тут вот на этом слайде нам важно разобрать как работает рид комитет когда у нас есть один backend он вот он сверху изображен на timeline им он производит некую запись в это время подключается другой backend и пробует прочитать эти изменений соответствовал этих изменений не видит и после того как первый backend делает commit соответственно уже после второй backend даже в той же транзакций в которой он уже не видел эти изменений может их прочитать второй ключевой момент на котором основывается лаги архитектура триггерных решения логической репликации это реализация snapshot of нам тоже нас сейчас более детально разобрать и вот тут вот есть снизу той мой некий на слайде и вертикальная черная линия обозначает как раз вот snapshot это некая точка во времени и как раз вот в этой точке во времени она характеризуется следующими параметрами это x мин x мин это минимальный идентификатор транзакции которая все еще продолжает выполняться в данном случае это 1302 второе это xmax это идентификатор транзакции 1 который еще не назначена и тут важно понимать что все идентификаторы транзакции назначаются последовательно одна за другой таким образом мы можем знать какая транзакция будет еще следующий назначены в данном случае это 1306 ее еще не существует у данным именам будет будущем предполагается и массив транзакции которые все еще находятся в процессе в момент snapshot в данном случае это 1302 и 1305 и вот после того как все это вадим михеев за к метил он сделал следующее решение он реализовал логическая репликацию 2000 году то есть представьте себе 17 лет назад уже это все работало так это работало он держал некую таблицу в которой он складывал изменение триггерами для потом доставки на подписчиков логической репликации но помимо этого он еще туда собирала идентификаторы транзакции а с другой стороны он написал хищную обвязку которая доставалось снапшоты таким образом его скрипты peerless что делал он получал snapshot данных и записывал его то есть этот текущий sing и далее он брал предыдущий snapshot данных и доставала из очереди все изменения которые были меньше точнее больше xmax а предыдущего snapshot а и либо равны или те которые находились прошлый раз прогрессе таким образом запускается скрипт он транслировать изменение на приемник и уже работала получается логическая репликация дальше коммерческая компания наняла одного из ведущих разработчиков под бросая на века в 2004 году и по факту это такой вот классный пример когда коммерческая фирма может привнести большой вклад в open source комьюнити и я навек переосмыслил решения водимыми хе ён скалы если у нас есть два snapshot а то мы можем выбирать изменения которые не были видны в предыдущем snap shield и стали видны в текущем snapshot то есть неким окном назвал он свое решение как некий дифирамб помощь в сторону нашего соотечественника слонь этой документации так и написано что слон это русский elephant и решение заключалось следующем соответственно было слоник это связка наискось языке для управления репликации словно это хищный демон который доставлял изменение на подписчиков и таким образом sony схеме и лежали текущий статус репликации и конфигурация хранились некие процедуры которые могли вызываться из сильных демонов из утилита конфигурации а также работали триггеры которые все вот эти изменения клали в очередь таким образом мы имеем следующее идеи 1 это вадим михеева это фотография из сан-франциско 2000 года владимир соответственно снизу изображен далее я лучше всех разработчиков покажут нам низы ниже их имена подписанный в один мягкий у рта за сказал что мы можем достать видимость вот эту инвестиций наверх соответственно это делфи катары транзакции снапшоты а далее я навек он находится верхнем ряду 2 слева сказал что если мы имеем два snapshot а мы можем выбирать ивенты которые находятся между ними а с другой стороны за счет того что на всех таблицах которые участвуют наши логической репликации есть первичный ключ то все изменения вот этих вот таблиц идут под блокировкой на первичном ключей за счет того у нас за счет этого у нас получается такой вот порядок в котором иной порядок вокруг объекта защищенного блокировкой первичного ключа да и вот в этом порядке с одной стороны мы потребляем изменения а с другой стороны в этом же порядке мы их и проигрываем и того что мы имеем мы имеем после специфичное решение на основе им вестись и который основывается на том что дин фиксаторы транзакции назначаются последовательно транзакции могут быть могут выполняться достаточно длинное время и все это время их результаты не видны для других транзакций и при этом snapshot представляет собой некую точку во времени в момент который он разделяет все идентификаторы транзакции на те которые уже видны и те которые еще закончится в будущем продолжает выполняться таким образом мы подошли к решению от skype логической репликации лом 10 на базе очередей пиджаки о них расскажет вам михаил еще такой вот важный момент хочу упомянуть вот вот эта история которую мы подводили на миг раз и показывает что одесская репликация во многом основана на решениях которые были изначально для восстановления для оптической для для физического потока вот а то что мы сейчас мы будем говорить это решение той же задачи но никакой погоди курьянова угла то есть мы будем говорить про то что мы не берем бинарный лог а берем какие-то секреты инструменты и на их основе будем строить нашу 1 раз наш пророк репликации вот я красный щит эта история правильно сессий в чему она приходит во первых ну вот еще раз упомяну важный момент snapshot это мы имеем мы все данные базе можем описать snapshot она чтобы что-то да они причисления данных это некоторая формула который позволяет все за комичные транзакции либо они видны либо они не видны в этот момент времени то есть они были за комично уже и те данные которые этим загсов прерывали уже видны на момент старшего рыба не видны это просто важно рассказа как работает логически репликация которая давит уже сколько там семь лет эксплуатируется так вот на 4 еще раз к игроку иван days да то есть это вот ребята из skype они из эстонии вот эта картинка это вот эстонский слоник пустой не самый известный слоник этого lanista такой низкой фишечкой очень много таких названий там слоники landis ты все такое какое-то магическое так вот значит ребята посмотрели на склоне он это и 1000 session и решение которые отчасти в по сгрыз компилируются части как отдельный диман а вот а пока ребята в скайпе они на питоне все разрабатывали и они видят что на самом-то деле фоне помимо то есть эффективная штука для слоя нужно только чтобы писать что-то в таблице с очередью и забирать оттуда то есть можно рисовать секрет можно нарисовать secure процедуры и дальше на любом языке для них это был питон можно вокруг этого начать работать но но основная функция офигенная которая позволяет понять относительно какой-то для записи в таблице очереди как бы описать вот этот это событие было видно или или не было видно итак 1 функция вот видим видимости с начнете вот эта функция доступна прямо под здесь и вот если вы посмотрите документацию здесь январь ему ссылку на bada и ссылку будет есть то есть есть были есть ссылка на раздел в подписи как работать с этой видимостью профессиональное нужно для того чтобы даже если вы посмотрите кометы эти функции тоже если дополнена это у нас там прям описано будет что мы это заметили там в тех все когда когда сказать это развивал чтобы как раз сторонние репутационные решение могли работать что сша джордж для репликации нужно сказать что ребята вот на каждом следующем цикле дайте нам то что она менялась базе ему тогда это применим на источники и помимо всего прочего помимо сложности с вот этой видимостью на сессии то есть нельзя просто так взять и там не знаю когда по времени начать потреблять там либо каком-то sequins у это все начинают всякие разные гонки там и но наложения да если мы пользуемся видимостью то мы избегаем таких проблем предстоящей момент это еще эффективно здесь у вас есть какое-то таблица очередь изменение как-то с нее еще более менее эффективно изменения вытаскивать наружу и тут тоже вот это механика с транзакциями нам сейчас поможет собственно вот о чем говорит функция видимости с нам шоке она где том что любой какой-то дефицита за акции мы можем это сказать он уже законченном нет или нет как мы говорим то есть если этот если это если транзакция меньше самой самой массы в текущем счете значит мы уже уже видим вот и и при этом это этот клип и при этом этапе катар должен быть не больше нашего окна сам что-то иначе это иначе это как бы из будущего до индикатор и при этом он не должен понять решение профессии и так стараться понять почему мента на собственно еще и мы не знаем она будет закончен или от рабочей на собственно вот функция дальше такая задача как раз возникает следующий момент что если это транзакция не было видно прошлом совершайте а видно в этом сайте и на данный который это та версия отмеченных раз учились у нас этом в эти промежутки времени вот вот это вот этот запрос а вот там ссылка дана сверху его который реализует это вопрос позволяет нам как раз потреблять изменение из из из базы источника дальше смотрите по логической схеме вот это что касается как бы физического смысла но мы добавляем сюда добавляем сюда скан который может быть выполнен по b3 индексу если у вас изменения лежат изменения помеченные транзакция который правило мы положим bo3 that between позволит нам по yandex yandex к нам забирать нужную нам часть из из очереди на потребление еще такого момента важно откуда берутся эти snapshot и вот для того чтобы их учитывать мы всю базу должны постоянно расчесывает относительная на этой линии который кости рисовал вот это вот вертикальная мы должны постоянно иметь эти отметки чтобы относительно этих отметок говорить что случилось не случилось отметки мы делаем последовательно вот конфетки есть wi-fi котором сильно растет и можно сказать что вот такой вот такой отметки такой уже все потребили и дальше продолжаем процесс и это рациона доход вот эти отметки в нашем примере в этом в этого слоника есть демон тикер который тикает собственно вот этой картинке это принципиальная схема работы вот уже мы переходим пасынок репликации что мы здесь видим мы видим слой сказать некоторые основной слой это вот тикер и очередь что что у нас происходит в очередь пишутся события если рисуем прям касим в лоб и аппликацию то все из это обед или ты на интересующие нас таблицах средстве напишут это похоже некий аудит вук они пишутся в очередь вот и рядом существует таблицы еще стиками где просто раз в секунду например демон вызывает секрет функцию вот опять же вот это услышат что-то не сам что два написано это прямо функция такая snapshot кастинг ссылка есть для на каком слоне так нет вот ну там в документации из нее и ссылки точнее консультации skype идиоты это собственно да еще 2005 году ребят приезжали рассказывали на все это москве тоже были не было собственно вот это как бы те базу инструмента на которых строятся то есть очередь есть снапшоты который мы российских прочерчиваем все время жизни баландой створки worker это савская beer который раз в цикле там по определенным правилам говорит что дайте мне вот изменение которые были от того snapshot а ps насчет и так и так в цикле это потребляет и вытаскивает на дуб ударил dance не применяет это все сразу же организован концу мир что за уже применяет изменение делает из них валидный сиквеле для того чтобы то чтобы случилось на мастере переводить это на своих еще есть важный момент цивилизации в этом мы как раз коснемся том числе в демонстрации демонстрации коснемся этому вопросу ну и дальше расскажем по ходу дела здесь на что еще внимание брошь вашу еще раз то есть это секрет то есть мы можем вот эта вся штука построена на сиквеле то есть в возрасте есть такие функции вызывая которые можно можно брать изменения которые случились между сотами это все основано которые строятся и и лишь так или иначе решение начиная там еще скрипта r script at михеева законом салоне тоже самое делает внутри и вот такую это кино выпячивает уже на теперь и на скрипт прикладной на питоне кости ты сейчас дальше вот этого еще хотел дополнить что на приемнике в том числе делается cнова что есть для того чтобы в случае аварии сети не произошло повторного проигрывания и таким образом skype нам предоставил вот это вот решение которое являлось с одной стороны транзакционному связи с тем что все события которые происходят в базе данных кладутся в очередь в той же транзакции с другой стороны она была эффективна за счет того что все изменения проигрываются бочками то есть те катку то есть говоря вот этими которые предыдущем снапшоты новым snapshot то есть целый batch изменений третий момент что она обладала отказывай устойчивостью связи с тем что она реализована на пост россии на всех механизмов подвес и которые предоставляет к восстановлению соответственно и open source то есть оно простое есть комьюнити можно дорабатывать и что собственного ему в том числе тоже девочка кости моменты не договорили это все штука еще нужно для того чтобы репликация шла вообще параллельным неким потоком который бы минимальный эффект kill минимальный эффект тел основную основной трафик на базу и запись и чтение вот вот это потому что похож на решение она вообще не блокирует никак пишу читающую нагрузку включаем антенны с процедуры которые очередь должны эту обслуживать то есть на самом деле туда резон некотором роде такой же как с бинарный потоком механизм ротации ненужного ненужных событий в очереди взялся штука сделаны не блокирующими жиме то есть ваша ваша основная нагрузка не должна замечать по корме ринологическом свой рис научился блокировка неких не возникает чтобы чтобы как-то fixed а если на накладные расходы не существует ну это вот поворот на прити конечно потому что мы больше пишем да ну некоторые циклу расходы так задача не не блокировать одной стороны значит реализована как раз таки да все верно теперь перейдем давайте перейдем к реализации к архитектуре streaming репликации как у нас работает по сгрыз соответственно после следует процессная модель и когда у вас подключается вас applications переходим к пиджаку который в коробке час и под конфоркой для вас backend и соответственно этот backend поднимает данные из кучи в шарить буфера далее происходит производит некие манипуляции в частности модификацию данных и сначала на их записывает вал в right ahead лак ну и после тому же асинхронный через шарик буфера может быть они достигаются до диска и соответственно вот эти вот валы хранятся сначала каши операционной системы далее они могут уже выпадать из каши операционной системы попадать уже непосредственно на диск после этого можете там реализовать некую команду архивирования которые переложат их в архив и случай если у вас вам нужен стендбай появляется следующая структура появляется непосредственно сам стендбай и вы настраиваете streaming репликацию у вас появляется репликейт слот который указывает на определенную позицию валя и далее он берет этот вал отправляет через вал sindoor вал ресиверу вал ресивер получает этот вал кладет в каталог по gx слог далее уже стартап процесс на стенда и поднимает этот вал и через ряд буфера эти изменения до кучи доносят и непосредственно если вам необходимо например читающую нагрузку разнести в то же время можно же эти изменения со стенда я читать теперь разберем как работает логической репликации случае с логической репликации у нас появляется еще один узел и the logic of dick order соответственно что он делает он берет вау декодируют его подсматривает впг каталог и все эти изменения отправляет через вал сендера logic у лари прикинь шнурки руна подписчики там он соответственно пишет эти изменения вау и также по заносит их в таблицу с данными которые вы реплицировать и тут следует отметить то что как случае landis ты так и в случае логической репликации в подгрести вам необходимо заботиться о том чтобы не какой стороне потребитель не написал вам эти таблицы потому что записи они не защищены и отдельно стоит поговорить еще про механизм инициализации логической репликации в тот момент когда вы говорите там корейцев скрип шины добавить таблицу происходит следующее один процесс держит реплики ищем слоты берется наб чего-то другой процесс в этот момент производит копирование данных на получателя теперь давайте разберем какие архитектурные решения были реализованы во это с помощью логической репликации еще давно где-то 2 тысячи десятом году мы поняли что все наши таблицы разложены по нормальным формам не очень-то подходит для частотные читающий нагрузки и далее прыгну то есть мы пошли стандартными путями покерными когда нужно взять эти данные иди нормализовать сложить все в одну таблицу и таким образом у нас появилась матери зова на и представлении основанный на триггерах справа уйти 2 ссылки не слева очень интересными доба реализация матери зова на представление работающего в реал тайме далее мы понимаем что уже вот этот сервер наш несмотря на то что там данные де нормализованное он не готов для того чтобы и писать многое читающий нагрузки держать нам соответственно как разнести эту нагрузку и вот тогда вот 2010 году михаил тюрин на и роман павлушка нарисовали следующую моделью на вот слайд на слайде вот видно доска когда мы у нас появляется соответственно еще две базы когда мы берем вот это вот матери зова на и представления и переносим его с одной стороны на базу яндексе рак который является источником для внешнего индекса и там сразу берем и раскладываем на несколько шагов для того чтобы вычитывать индексы вычитывать во много потоков из параллельно создавать сразу индекс то есть это позволил там делать индекс за несколько минут а с другой стороны делаем базу редкие репка это почему так и назвали значит там взяли и размера шарик буферов сделали сильно большим размером нежели чем сама матери зова на представление получается еще тогда в 2010 году мы сделать некую in memory базу данных которая позволяла вычитывать тысячи транзакций в секунду по первичному ключу тем самым непосредственно из репки до сих пор в авито реализовано показ объявлений которые вы находите в поиске то есть начало в яндекс идет запрос потом там выдается вдругорядь 200 объявлений вот все что вы видите на поисковой стране выдачи это вот с репки отдается и что мы можем сказать про репку с течением времени после того как мы вышли на пик запросов далее уже количество чтения из этой базы она характеризуется количеством записи потому что по факту вся ваша база прикрыта ковшом каши и могут быть достаточно большие и до базы будут долетать только те запросы которые вы пишите то есть вы меня эти данные каши инвалиде руются и вот эти запросы доходит до базы таким образом мы можем увидеть что ну примерно порядке не меняет что там 2014 года где-то около 4000 транзакций в секунду в шестнадцатом 6000 потом 5000 и все это крутится там на 8 или на 5 ядрах помимо всего прочего матери зова на представление мы рисовали еще один паттерн мы сделали такой вот некий хакк и обошли ограничение связано с тем что когда у вас есть логическая репликация при изменении структуре на источнике вам необходимо эти все изменения поддерживать и на приемника схему именно данных до схему данных то есть вот зеленым подсвечена у нас была грубая много колонок мы взяли их иди нормализовали в кастор в одну колонку и таким образом случае если вы меняете структуру своей таблице на базе никаких изменений делать не нужно нужно просто выкрутить новое приложение которую новую версию приложения которое начнется работать новые версии схемы следующий момент когда вот вы нажимаете например сохранить свое объявление запускается много асинхронных механизмов но в том числе есть некий такой синхронный механизм когда через всю эту связку пробиваете до самого диска коми там вот это вот сохранения и после того как вы провели это сохранение через три секунды с помощью логической репликации можно доставить данные во внешней индекс то есть это из одной очереди приложите в яндексе из яндексе делаем еще одну логическую репликацию пиджаки которая непосредственно несет данные изменения во внешний индекс с другой стороны езда вот то что я уже рассказывал за счет того что мы разложили по партийцы вот эти вот данные репки на яндексе ри мы можем производить индексацию во много потоков и пересоздавать индекс буквально за несколько минут для всех активных объявлений авито и еще один шаблон был реализован далее мы пришли к тому что в принципе то сама вот это генерализованное мотивированное представление на источнике иметь то и можно не иметь можно в дефиле триггере собирать все вот эти вот изменений просто отправлять их в очередь нос связи с этим вам придется сначала реализовать некий механизм индексации об этом можно почитать но в принципе это возможно сделать когда вы сначала там делать инициализацию где-то на получатели потом начинаете эти изменения инкремента получать там но этот механизм может быть достаточно затратным или сложным или источник ваш может быть достаточно сильно нагружены связи с тем что в принципе происходит авария необходимо иметь сразу два логических подписчика для того чтоб в случае аварии сразу переключиться на 2 и когда вы переключаетесь на 2 . 1 у вас выпал нужно новый пересоздать и более поздние я сейчас расскажу в том числе об этом механизме а сергей вам будет показывать это на практике это нужно еще добавлены к той картинке которая изначально давно реализовано чем-то смысл вот когда это все делали будут такая была таблица с объявлениями на мастер базе мне не пишет приложение которое такие личный кабинет а другая нагрузка которая должна учитывать индексировать и показывать на сайте она как бы идет она мешает работе работе пользователей и хотелось как можно быстрее доставить в яндекс а доставка в индекса это всех сканы получалось классическими сна нам на массе нагрузка это энди сканы и запись и работа с объявлением индексация это такой большой большая вычитка всей кучей это как бы не живет вместе хорошо и была такая идея что раз взять вот эту вот взять некой matheson представления и убрать его вообще в память на другую машину вот это и это как раз вот это этой логической аппликация то есть и по дороге этот механизм с матери зоны представлениям это такой промежуточный к паникой транспорт что ли который гонит gone данные из гавани данные из места предназначенного для изменения вместо предназначена для быка для выкладки которые все уже лежит в памяти до красного диски приказ возьмем за то место где на чтобы писать другое место на читать так идем дальше соответственно появился еще один патин когда вы можете выставлять некие параметры конфигурации гук в пастбище для транзакций далее собирать их в момент отправки в логическую репликацию таким образом вы можете некие vento собирать на источники и отправляйте их на концу меры этих событий в принципе на источники данных таких и нету у вас получается уже некая производный от данных и на основании то вы можете выстраивать конвейер но это так еще один как потир теперь поговорим о а бавария помимо всего прочего в принципе случаются аварии к ним надо быть готовым нужно иметь action plan и когда у вас случаются аварии в распределенные системы обработки данных у вас некий узлы могут относительно друг друга оказываться или в прошлом или в будущем естественно вас все это в каких-то асинхронных очередях и все dosing эти данные вы не потеряете но при этом нужно в текущий момент запустить ваши базы данных после аварии в согласованном состоянии и как раз вот мы имеем много наработок сейчас я в общем про них расскажу сергей будет уже показывать на практике их представьте себе что у вас есть мастер база данных нее есть с тобой и с мастер базы данных вы делаете логическую репликацию на никого получателя в случае если у вас взрывается ваш масс мастер база данных у вас может так получиться что логический концу мир оказывается в неком будущем относительно вашего нового стенда я логическая реплика потребляла изменение быстрее чем бинарный чем бинарное например ну это как бы они по-разному вообще но в нашем случае это мир такой случай то есть вот то что как раз горел алексей мог бы какие-то причины не связанные с с вашим с вашим логическим кольцом использования данных которые тормозят бинарный лак я таки можно получилось вот например у нас вот провайдер которая физическая реплика она подослала на логическая была впереди и вот получили проблему да и для этого мы реализовали такой вот паттерн undo в том числе своих доработки мы за к метели и в анонсе нашего доклада можно уже сейчас вот смотри что мы сделали undo это некий такой вот трек всех событий которые приходят на приемник логические репликации за действия обратные желаемому действию после того как мы за про монтировали стендбай мы смотрим в какой временной позиции он в какой позиции подписчик и далее мы прокручиваем все изменения которые вышли в будущее на подписчики в обратную сторону после этого у нас базы оказывается в согласованном состоянии мы запускаем логическую репликацию второй тип аварии 2 типа аварию вас может упасть подписчик когда у вас есть грубо говоря мастер база с ней идет логическая репликация на сабскрайберов сабскрайберов есть бинарной санбой бывает так что сав скрайбер уже падает и тогда у вас может так оказаться что ваш стендбай сабскрайберов окажется в неком прошлом относительно исходного источника данных в данном случае нужно сделать следующее мы про матируем подписчика но далее смотрим его позицию во времени позицию во времени источники данных и на источники данных мы должны переподключить логическую репликацию на позицию соответствующую подписчику при этом иногда возможно требуется держать некий такой вот слот или какой-то лог на то чтобы эти данные которые идут из очереди логической репликации за это время ни zara тира вались ну и после этого мы запускаем логическую репликацию все согласовано все хорошо и 3 кейс 3 кейс когда у вас я уже до этого говорил система достаточно сильно перегружена или процесс инициализации логической репликации достаточно сложен возможность пересоздания с источника данных приемника логической репликации может быть либо очень длительным по времени или очень трудоемкий поэтому мы реализовали следующий паттерн когда у нас соответственно падает одна из логических реплик мы в бою соответственно имеем сразу вторую нее пошла нагрузка но при этом нам нужно пересоздать снова для резерва еще одну реплику и в данном случае мы создаём некий такой фейковый концу мир сначала логической репликации который ничего не потребляет ждем пока изменения для этого концу мира появится на подписчики того как они там появились мы можем инициировать создание нового новой копии по факту 2 концу мира после этого смотрим в какой позиции от концу мир находится двигаем вот эту позицию на источники данных и запускаем логическую репликацию этого мы имеем снова 2 рабочих логических копия мы создали копию данных не не никак не затрагивая источник в этом как бы вся изюминка этой штуки так теперь у нас мы подошли к практической части к самые интересные наша часть сейчас все вот эти вот кисы которые мы реализовали lavita сергей вам продемонстрирует еще раз на напомнить что это все у нас есть на гитхабе еще знает понимание данный гитхабе в сеть а вот то что я мой виртуальный сейчас у нас пути хакк активно идет кости расскажи про да у нас сейчас вот идет пиджак в частности вот а вот виртуальная машина который сейчас будет проходить практика мы валит реализовали соревнование похоже но носить ф это типа cityphone около по сгрыз и там вам предстоит решать продуктовые задачи и задачи по администрированию данных на время некое и данное соревнование мы уже провели в сентябре и соответственно получили много море положительных эмоций обратной связи и в целом всем очень понравилось и позитивно зашло поэтому в том числе после того как вы нас послушать сегодня приходите к нам на 5 же как хакк около сингапура будет очень интересно сейчас сергей начнет демонстрацию да сейчас мне нужно некоторое время чтобы настроиться минут пять так но вообще мы как бы в регламенте по времени может быть какие то есть уже вопросы нам еще сейчас где-то тут минут тридцать-сорок неточно еще поработаем может что-то уже задать может быть будет понятней чтобы сергей вообще делать дальше нужно будет да я вот сейчас как раз мы этот момент затронем то есть то что создавалась под гресь и но тоже про это но немножко по-другому скажем так то что то что сделано подгрести она изначально исходила из некогда других условий это дает на реализацию наложил анализа цию свои какие-то свои варианты мы сейчас покажем сейчас покажет как то что мы сделали на логической аппликации как мы делали до этого на триггер репликация как это можно будет реализовать в десятке что там это уйдет и буду на комментарии что прямо один к одному переносится что переносится с доработками потому что не все так однозначно еще в лоб переносится вот это мы сейчас посмотрим но в общем это будет как бы готовый уже action plan когда вы запустите у себя логическую репликацию на десятом по сгрызть и вот все вот эти вот авария вы будете готовы к тому чтобы восстанавливать и согласовывать во времени ваши узлы распределённой системе вот сергей как раз отвечает за скрипты восстановления и рассказать чтобы записать восстановление gras необходимо понимать это все какая позиция на сколько позиция в слоте отмечено какая позиция на реплики как они друг к другу относятся кто перед кого убежал кто не добежал потому что все же эти вещи асинхронные и караться всегда что у логической аппликация все как-то интуитивно понятное и легко он ищет подписываем паша репликации но когда он сунул выходит из крови чтобы продолжить взаимодействие операционные необходимо сделать служу восстановление либо на источнике либо на приемнике сироп готов а вот еще вопрос я пастырь можно говорить потеря данных откуда вообще может быть а просто потерю до асинхронные взаимодействия что-то у кого-то может не доехать нет но таких они по потере данных связанных с применением наших инструментов либо штатных инструментов не возникает бывают как бы потери б дизайн здесь у вас асинхронное взаимодействие та часть например данные которые применены и были на источнике может в случае аварии может просто еще не доехать до приемника но и такой дизайн то есть вопрос о том как у вас а секунда сколько оно у вас может лагать вот в этом потери такие пути общего плана не конечно могут быть но вот те штатные средства эти инструменты когда применяем и мы считаем что они без багов скажем так ну тут конечно сергей за как бы собаку съел бы бывают конечно баги то есть но баги касаемые репликации бинарного logo они-то приоритета я никого фиксится очень быстро то есть после с которой вы скачиваете можно считать что он без багов в частности сейчас на семинар налога но и ягодицы он их всех вещей нет нет я сейчас закроем я просто покажу сейчас так ну вроде говоря тоже все нормально консоль будет видно проверим так я буду сидеть ну план показа такой мы сделаем репликацию логического точнее нет мы взяли виртуалку от позже как а то есть там сейчас нет еще никаких кластеров нужных нам для демонстрации я создам кластером мастер стендбай и репку создадим две таблички в них вставим некоторые данные создадим логическую репликацию потом мать я покажу как сделать вторую копию репликации с 1 то есть не с мастера с другой копия вот о чем все говорили потом мы симулируем аварию на мастер за промоушен стенд бай и посмотрим как работает undo и все это будет показана и для landis ты и для логической репликации 10 полиса но вот команда которая буду вводить они вот здесь нас вузы на гитхабе можно туда зайти как бы смотреть я буду говорить что я делаю сейчас нет рада сейчас мы зашли на виртуалку под гриссом виртуалку позже какой-то мне нужно и инициализировать сначала я щас быстренько я сделаю там еще есть такая проблема что у нас по ошибке выкатилась не та версия skype с наших на нее поэтому я тогда еще почти что себя включает patch патч там просто вот последний вот такой каннибал видно нет там просто пропустили одну команду в параметрах наша версия по почину загнулся лижет ноги хобби щас мы в том числе подготовили колоду первый момент это мои за об инсульте всю нашу все наши наработки для скай толстой sky тулс наш почин и а с другой стороны в том числе там же выложена кастомный концу мир который позволяет делать вызов с одной базы данных на другой базе данной через очередь таджики готова так мы начнем с 96 по сгрыз да здесь шрифта маленький начну с 96 по сгрыз я там создам сейчас все эти кластера и создал нужны нам таблички сергей рассказывай пожалуйста какие кластер а ты создаешь для чего я создаю у нас вот кластером с названием monster а да забыл упомянуть мы используем debian то есть здесь будет использоваться скрипты операционной системы debian для управления кластером ip-адрес я создам кластер майн это стандартное название для класть под газ а дэвин потом создам кластер с названием стендбай там будет бинарной репликации у нас и глостера репка один репка 2 потому что вылечишь так на тебя становился так я удалил старый с кластер от позже хака создаю новые майна стендбай репка один рябко два такси у нас создалась нужно открыть доступ в 96 для репликации в десятке уже по умолчанию открыт доступ открыли так теперь мы настроим параметры логическая репликация для логической ну да для репликации бинарный баловал и всякие параметры для бинарный это maxval sender.air и плиточный слот то есть по умолчанию в 96 репликация не включится так настраиваем у глостера репы перезапускаем основной кластер с нужным нам уровнем баллов для бинарной репликации логической ну пока бинарная это богатая часть 1 мы landis ту демонстрируем а вторым этапом так вот у нас здесь запущена так создаем бинарный стендбай очистим каталог создадим слот для бинарной аппликация сделаем резервную копию мастера в каталог с вами и запустим стены бани буковку запустили с параметрами несессер большое этот параметр означает что сам по живой звук от создастся нужны конфликты для подключения к мастера то есть нам в принципе здесь ничего не нужно настраивать и вот видно что бинарный наш стенд бай запустился так создаем таблички база данных создать на мастер у нас база называться будет src на логическое реплики dst от destination создадим таблички на мастере и на логические реплики на логической реплики мы сделаем их unlocked просто для примерно у нас кстати вот в бою тоже аналоги то ли это позволяет как бы не писать на диск вообще ничего за как раз в то что таблица analogue то есть своего время нам дали и следующее преимущество раньше диски были не настолько мощные и связи с тем что у вас изменения на источнике происходит во много брендов и пишет много потоков а проигрываете вы их в один поток за счет того что вы делаете analogue таблицы получается в один поток успевает справляться со всей этой записью но в данном случае вы имеете следующий недостаток случае если ваш сервер выключится к питанию таблицы превратится в тыкву по факту и на этот случай мы просто имели всегда 2 логических реплики таким образом если одна из них вылетал у нас было резервная но если вам нужно было снять некую копию с неё то через предам замечательно все это д'ампеццо да как создать второе мы попозже посмотрим так ставил я данные а теперь приступаем к созданию логической репликации с помощью landis ты как уже коллеги рассказали он лонди состоит из двух демонов первый демон тикер который создал вставляет табличку типов в снапшоты текущие которые он видит момента вызова и 2 демон это сам landis ты которые этими snap сотами нарезает таблетку табличка очереди и непосредственно читает и вставляет данные в destination в подписчикам так сейчас я создам конфиг для кикера и конфиг для лонди 100 дальше по киккера и ул он диск или стандартной команда install с помощью которых он устанавливает свою схему в нужные ему глаза вот мы поставили текирова мастер и поставим сам лонди sti в мастер и нас на реплику вот провайдер ставит схему в инсте на мастера subscribers ставит схему лонди стена реплику так по умолчанию уладить есть еще такой оптимизация что он отслеживает как давно и изменялись данные когда были событие последний если слабые и давно не было то он просто увеличивает время между вопросами то есть по молчанию там 60 секунд полна стоит мы сейчас попробуем уменьшить поставим что максимум он ждал 5 секунд так ну и запускаем тему антикера можно посмотреть его лоб вот видно что он уже запустился и начал там писать свои текке в базу теперь запускаем демон лонди sti вот он запустился тоже произвел свой первый вопрос он пишет сколько он прочитал события сколько пропустил так как раз обои в очереди можно в одной очереди можно к одной очереди можно подключить несколько таблиц на мастер она подписчики эти таблицы могут не совпадать таблицами со списком таблиц на мастере поэтому некоторые события он вести могут выпускать но это как бы осмысленное действие так теперь добавляем а таблички в очередь вот мы добавили на провайдер и на логическую подписчика с помощью команды сабскрайберов тибблз можно отслеживать процесс их копирования на подписчикам вот первая таблица скопировалась пошла вторая кого здесь рисуя система а мне кажется это очень интересная штука вот домашнее задание может быть что же такое разобраться как и относили зация вам дасти вот все все таблицы нас ушли на реплику проверим что репликация работает ставим дополнительная строчечку на мастер так и теперь мы еще включаем наш ended up undo подсистему то вот у нас отделаться командой сабскрайберов down down это команда она просто создает наши вот служебные триггера на таблицах логической реплики и начинает писать все события специальную табличку он дал ок сергей покажи еще раз наглядно что там все это реплицируется давай сейчас показываем вот видно что мы ставили строчку ccc и вот она попала на логическую реплику так давайте еще раз ставим вот еще а ставилась двойной ccc все работает так теперь я создам вторую реплику с 1 то есть не с мастера с 1 для этого нам нужно создать 2 подписчика в одной и той же очереди то есть one does the можно на одну очередь продюсеров отличать несколько подписчиков и мы это используем чтобы как вот поддерживает как раз для копия через статус так вот мужику одному telit она показывает текущие настройки очередей то есть у нас есть очередь с названием ванде 100 репка и у нее один подписчиков он диск 1 а секунды это когда последний раз они опрашивались созданием 2 подписчика athlon 202 он вот используется для второй реплики здесь такой важный момент то есть начинать копировать реплику нужно только после того как вот вторая очередь содержат больше событий чем первое это можно отследить вот по этому времени последние вопросы то есть это время должно быть больше чем у первые реплики мы видим что 1 реплики одна секунда последовать вычиталась а во второй 30 секунд назад то есть соответственно можно запускать по жидам даже место на создали подписчика но не запустили да вот ты сейчас у нас капитаны и они никуда не теряются вот мы сделали позже дам восстановили базовую во втором пластики власти репка два теперь мы для теста ставим данные watch ну смысле не очередь а просто измените то данные на мастере вот мы вставили ddd так теперь нам нужно настроить то что мы сейчас скопировали потому что вот здесь он даст используют обычные таблицы в подписи для отслеживания прогресса репликации логической и для этого он пишет имя и последний проигранный бать в табличку так как мы сделали пажа там пожар история то сейчас имя соответственно у нас восстановленной копии соответствовать первые реплики нам надо ее сейчас исправить вот видно что сейчас скопирована нами реплики содержится имя ланцеты 1 мы его сейчас поправим no one city 2 вот ланди 102 так цикламена создать конфликт для второго лан доска готова так теперь посмотрим как отличается вообще текке вот мы добавили такие команды это тоже в нашем патче провайдер карен тег и сабскрайберов antique они пишут последние проиграны вот логических событий на мастере и на подписчики вот видно что на мастере 59 станет вать с капитанами копии 68 то есть у копию которому скопировались 1 реплики она соответствует состоянию базе на 68 бать то есть когда тащится от 8 батик не уже применен соответственно чтобы включить теперь логической репликация для второй нашей копи нам нужно вот этот тег на мастере сдвинуть на такую же позицию как и скопированные реплики для этого нестандартная команда londa sti rewind она может сбегать как вперед тик-так и назад так rewind вы вызвали смотрим какой супер тег вот видно что на мастере он сдвинулся вперед на тоже позиция что и но тоже позицию что соответствует логически нами скопированные реплики set 8 теперь можно включать репликации так сейчас он посмотрим что данных там еще нет и соответственно ddd которым мы вставляли так как еще не включена включаем второй процесс landis те которые будут писать во второй реплику не ставил 2 вот видно что после события и что во второй ланске уже проигрывает их на 2 реплики теперь посмотрим содержимое вот видно что строчка ddd которая была оставлена когда у нас не работал еще репликация то есть другого раката мы делали пожар или когда настраивали текке она успешно проигралась на скопированный нами реплики теперь все реплики идентична все где всякую точку master пасс покажу что они на ноги реплики появилась давайте попробуем если это ничего сломает импровизация пошел допустим xxx так мастер ставили вот на второй реплики она появилась а теперь посмотрим на первый мод на первое тоже она появилась все работает так теперь мы сделаем авария на мастере все запущено таких кастера майн реплика один длина логическая реплика 2 и наш бинарный стендбай сейчас музыки или мастер и переключимся на из-за промоутер стендбай так для начала да мне нужно показать же что логической репликации ушла вперед бинарного с тумбой для этого я сейчас просто отключу бинарность любая от мастера заключу ему доступ и вставлю данные в мастер так закрываем доступ сейчас бинарный стендбай не сможет потреблять изменения логической логически реплики смогут до доступ закрыли перечитали теперь закинем не вставить мастер чтобы показать сейчас я там по позе ставлю так вот сейчас я реплика выключена неординарная посмотрим как сейчас выглядят данные вот это у нас мастер вот это бинарность онлайн но идентичны и там и там шесть строк вот теперь вставляем новый три категории 10 20 30 на мастер и посмотрим как теперь выглядит наш сорвана на мастере вот они на логической реплики 1 вот они и бинарный стендбай а бинарность стендбай у нас отключена он их не употребил и в этот момент происходит авария на мастере так убили мастер за про монтировали с тобой теперь у нас как бы логической аппликация впереди нового мастера так сейчас я переключу londa стена новый мастер и мы посмотрим что у нас получилось останавливать тикер запущу ticker на новом месте и посмотрим журнал вот он работает на новом мастер останавливаем 1 реплику запустили реплику на новом мастер matter посмотрим что у нас реплика в будущем новый мастер нету данных на реплики есть теперь посмотрим журнал landis ты здесь видно что вон дасти обнаружил это эту проблему и остановил репликации вот он ругается таким сообщение то есть он ожидает что destination не будет 139 бать а видит там 156 то есть для радости логическая репка реплика в будущем и чтобы защитить данные он прекратил репликации и сейчас пишет такой ошибку так мы еще ухудшим ситуацию и ставим те же самые данные которые нас на мастере пропали на новый мастер посмотрим как теперь выглядит два наших сервера wot на новом астери видно данные и и в primary key 36 37 38 на реплики есть те же самые данные но primary key у них другой шанс вообще все разъехалась но как мы помним репликации сейчас не работает то есть в принципе еще можно все это восстановить ничего поверх не перезаписывается и вот сейчас мы вызываем нашу onda onda отслеживается в табличке лон 10 фонда и вот там можно увидеть туда пишутся событием которое нужно будет выполнить чтобы вернуть реплику предыдущему состоянию вот для inserto так мы выставляем insert для них для insert пишется команда delete она у нас только следует а для де лет соответственно нужно указать при моряки стран строчки который удаляется вот видно что вот эти вот события в unc блоге соответствуют тем строчкам которые нам нужно sti от удалить вот 156 то в будущем на мастере 139 бать соответственно со 139 по 156 батч нам нужно все эти события удалить вот они как раз 148 148 бате были вставлены для undo нужно остановить landis ты все остановили и выполняем undo вот он пишет что последний технологической репликация был 156 на мастере 139 и выполняет унты до 139 тег а вот в конце он написал сколько строк он удалил видно что удалилась три строки не фарша удалилась в данном случае удалился в общем это какие-то изменения откатились назад до откатилась три строки вот видно что в антологии они пропали то есть последний батю нас декаде последний 120 вот у нас на мастере вот нас на destination очищены эти теперь видно что тики и на мастере на логические репликации одинаковые 139 теперь включаем репликацию так запустили лонди смотрим его журнал вот видно что ошибок уже нету событие проигрывается но и для проверки ставим еще новые события 100 200 300 тебе посмотрим как выглядят данные на мастере на логической реплики вот видно что логической реплику у нас тебе соответствует мастера то есть со старыми primary key строчки удалились ставились новые с мастера и дополнительно ставились те строчки которому только что вставили описывать а я уже при создал не хотел сказать что почему почему они не пропали с мастера то есть они были просто в очереди по жаке поэтому мы могли снова просто проиграть потому что londa sti остановил репликации и защитил temsa у нас от потери этих данных но так работает репликация в лондон и он до ножа на наш фонда теперь на то же самое все проделаем для 10 после со до 10 полиса на основе логической репликации штатные postgres и в качестве унты я взял просто вот эти наши храним ки и чуть-чуть поправил их на переделал батина л с н так как логической аппликация в десятом после себя на период таким понятием как об unlock sequence number позиция вашей важный момент что получается логический декодера парсит вала и оперируют этим вот его сыном таким образом он соответственно берет начало изменений транзакции началось если они туда попадают том что интересующие нас таблицу она где-то хранить в неком буфере и при к мите соответственно с этим его ценам он их отправляет на приемник логической репликации на приемнике мы как раз вот все эти изменения нами руются и применяются в том порядке в каком они появились непосредственно валя да то есть снт грубо говоря позиция вот в этом бесконечном потоке валов последнего коммита до которого все применилась так теперь мне нужно всё тоже самое сделать на десятом для этого я сейчас удалю все кластера которая до этого создавал чтобы они нам не мешали так еще закинул он 10 штук тоже не мешал ой помните так вот этот стикер и 2 субстрата все почистили создаем 10 кластер аналогичные мастер стендбай а репка один репка 2 так настраиваем параметры здесь чуть поменьше здесь нужно только основное включить это уровень журналирования logic of для логической репликации нам нужен так редки и запускаем мастер чтобы его у level поменять все нас запустилась 10 10 10 создаем бинарный стендбай отчислили катал их создали слот сделали бэкап запустили смотрим журнал вот видно что он подключился к мастерам создаем пазы создаем таблички так аналоги на реплики вставляем данные готовым так логической репликация 10 под грехи она работает на свою так называемых публике шины subscription то есть на мастере нам его создать публике шин указать в нем какие таблицы мы будем реплицировать она логической репликации мы создаем subscription и указываем куда нам подключаться и какой по готично использовать вот но сейчас это все пройдем создали публикацию на мастере создали подписчикам монологической реплики все в общем лаги скрип лягаться настроена теперь убедимся что данная нас и prezzi руется вот две строчки на мастере вставляем третью а это на реплики да две строчки на реплики ставили 3 мастер и вот видим что 3 появилась на реплики репликация работает так теперь мне нужно создать undo этот код и можно посмотреть вот я наверно не показал на на гитхабе на гитхабе я на гитхабе это выложил вот этот файлик свой можно посмотреть вот там я щас просто его family желаем перечислили что сейчас ну там я скопировал 2 храним кеес нашивал он даст и как бы описывать их не буду построчный 1 пишет события в андролог табличку а другая потом их проигрывает для выполнения он да таким образом он 1 реализуется для триггера которые на приемнике будет undo делать правильно да вот я сейчас вставил эту схему в первую реплику логическую от у нас по идее он должен заработал так медленно и она потом в конце расскажу так это сейчас мы будем создавать вторую реплику хотя можно сейчас рассказать процесс репликации логическая в после себя в десятом отслеживается на реплики с помощью таких понятий как ориджинал и о тсн они к сожалению не транзакционные то есть это такой массив в обще памяти и то есть если для londastyle позиции отслеживалась просто в табличке которая штатным образом там пилось ребята была редка транзакции по же дампом то для логической репликации десятки так сделать не получится потому что эта табличка в которой пишется процесс репликации на логической реплики она будет меняться в процессе уже дампа и то есть мы не полон не получим тот lsn который будет соответствовать нашим данным сначала казалось мне что все все пропало ничего не получится сделать вот костя предложил что можно же просто остановить репликацию в момент позже дампа для того что создать вторую копию мы сделали такой алгоритм и останавливаем репликацию делаем дам запоминаем позицию логической репликации и даже не так мы останавливаем репликацию запоминаем позицию логическая репликации запускаем там и после этого уже можно запустить снова логической репликация потому что дам выполняется в рипли ты говорит снапшоты то есть там применяется оппозиции его мы уже посмотрели началом дампа сейчас я это все проделали для второй реплики нам нужно создать соответственно для londa steam и создавали подписчиков очередь а для десятки мы создадим логический слот 2 зовем его репка 2 сейчас я создаю 2 логический слот на мастере вот видно что у нас здесь есть два три слота крепко 2 которого создали репка один который сейчас работает для реплики логически и на шпинатный стендбай ну там кстати видно вот их позиция текущая фасонов сейчас они одинаковые биологической реплики так отключаем репликация логическая для первой реплики отключения для теста я просто ставлю данные в мастер чтобы показать что они потом не потеряется запоминаем текущей лассе наши первые реплики я буду использовать эту колонку ремонт лосин она статуса логической аппликации можно посмотреть в таблице пожаре при crash in origin статус на самом деле это не таблица она на охранники основана так вот этот мой запоминаем и запускаем по жидам он допустим полетов у нас все выполняется уже параллельно можно запускать репликацию потому что мы позиции и уже узнали так репликация пошла вот видно что на 1 реплики наша ddd проигралась который я оставлял когда репликация была выключена она 2 реплики и нет вот последнее ccc посмотрим позицию слотов вот видно что логическая репликация сдвинулось 1 а вторая реплика наша она осталась там где было 77 я но и здесь еще такой особенность позже там ни там пит логического репликации и состоянии то есть когда вы сделали копию с слот у вас получается не подключен к мастеру и здесь возникает вторая проблема то что она даже не там 5 какие таблицы вы реплицировали и чтобы вам восстановить эти таблицы вам нужно тело подключить саб скрайбера subscription когда вы только подключаете с скрип сам у вас тут же начинает проигрываться события из слота а таблицы еще не созданы эти все это событие теряются это как бы был второй провал когда решил что опять ничего не получится но потом у сквозь обсудили и поняли что можем же окажется позже дампа есть такой ключ который позволяет ему не дам 5 вообще subscription и мы просто сейчас продам по использование с этим ключом но суп скрип сон подписчика мы сейчас создадим заново вручную и не будем его пока подключать вот мы подписчика создали для подключения потом в будущем избегание мне понадобится еще вот этот параметр void его можно посмотреть в табличке на реплики позже subscription box используют такое наименование для отслеживания репликации то есть он берет это таит из позже subscription дописывать к нему вперед позже почивать они и используется в качестве имени подписчика так посмотрим что вот после восстановления позже дан по у нас все состояние потеряно вот пустая таблица состоянии теперь нам нужно сдвинуть нашу новую реплику на ту позицию который бы соответствовал ее данные для этого мы вот запомнили там перед началом позже дампа позицию валин мы оставляем сюда а в качестве имени будет использоваться вот это вот служебное имя которое генерит под grease позже подчёркивание и вот это таит из таблицы позже собс klipsch и все сдвинулись теперь посмотрим состояние вот видно что состояние появилась наша логически репликации видно ее имя подписчика и видно что вот позиция лосин соответствует тем данным которому делали в пажи дампир которые соответственно составляли в в этой хронике позже рыб летишь на ли жена двое нас теперь посмотрим сами данные непосредственно вот последняя строчка ccc на 2 реплики включаем логическую репликацию это делается через altera subscription enable включили вот видно что ddd который мы вставляли в момент когда все было выключено и когда мы копировали реплику она появилась на 2 репки стена что все работает но для проверки еще можно посмотреть слоты вот видно что слоты сдвинулись на второй слот вперед и что вы титана и соответствует вот друг другу 1 2 реплики посмотрим статус на 2 реплики и на 1 вот видно что они идентичности с ремонтом и сын такой-то приму твой сын такой-то всем небо 8 так теперь мы сделаем симулируем авариям своя хожу в будущее логической реплики но сейчас такие есть кластера мая на 1 2 и на стенд бай май мы сейчас и тот же объем остан бой за промывать он опять же я также отключил доступ просто стенда баюна мастер чтобы симулировать его задержку отключаем 102 и готова смотрим текут состояние наших данных четыре строки на мастере четыре строки на стенд wine вставляем данные 10 20 30 на мастер теперь смотрим что получилось на мастере вот они на логической реплики вот они у нас тонкая соответственно их нет с тобой у нас от стал теперь у нас происходит авария ты все такая хитрость десяткой 10 репликации логической что слоты на стендовая не реплицируется то есть после про molto нам нужно заново создать все слоты и здесь такая ситуация возникает что вы за про могут ли сердца но получается пускать на его трафик еще нельзя иначе вас будет дырка то есть данные которые при изменится на новом мастере еще до того как вы создадите слоты они себя потеряются для логической репликации поэтому мы перед как бы после после promod сделаем вид что мы не пока не пускаем трафика делаем сначала слот потом только пускаем трафик так мастер закидывание вэл он достиг состояния отслеживается просто в табличке то есть ставлю что там видно такие кибаки про игрались в десятки а логической аппликации она работает на основе lsn и чтобы вот понять да какой позиция мне над отматывать логической реплику мне нужно перед про молот важно посмотреть позицию на стендбай то есть до какого и лосин стендбай проиграл данный вот мы сейчас это сделано с помощью функции last вал реплеев с м вот такая она здесь цифры и мы и будем использовать для undo до этого состояния все теперь мы готовы делать про mode и теперь перед запуском трафика мое тело им логически слот для нашей реплики готова а физически слотом можно нас тобой сделать бинарном а вот логически он не дает просто с ошибкой говорить нельзя включить и decoding валов на stampa я так посмотрим какие у нас состоянии с данными вот новый мастер три строчки вот наша логическая реплика шесть строк она у нас в будущем у казался вот так выглядит наша табличка undo на мастере но и намасте на реплики здесь видно что вот эти вот строчки 456 соответствует такому тсн нам нужно откатить все строчки которые больше того его сына который был нас там два и так сейчас я включу репликацию покажу что она пока не работает ставим на мастер те же данные потерял и команду на разлуку здесь здесь видно что логическое приказа сейчас включена на мастер данные ставлю но они не проигрываются потому что мы ставили те же самые данные которые были там до аварии и на логической реплики у нас сейчас возникает дубли кейт кей вылью ну смысле unica violation посмотрим как выглядят наши данные сейчас вот на логической реплики эти данные из primary key 456 она нового мастере эти же данные с 36 37 38 он для исправления этой ситуации мы сейчас эти четыре пять шесть с помощью нашего undo откате для этого нужно сначала выключите репликацию так вот эти данные мы сейчас удалим атос вот видно что сейчас он на 8550 так я верху где-то записывала вот а эта позиция нашего стенда я который был a dog про молота вот на саунду выполнилась видно что она удалила третьи строчки и установила текущее состояние с 8550 на 7-е b8 сейчас мое видео заканчивается время вы сейчас сказать что показать что она откатилась мы поверим всем работы поэтому соня рождена включаем результата за работой вставляем еще дополнительно новый данные 100 200 300 смотрим что получилось вот видно что данные теперь идентична на новом мастере нас 36 37 38 100 200 300 кинологической реплики то же самое то есть проблемные строчки с маленькими primary key они были откачивая нашей функции он до вывода сравнение так демонстрация закончил сегодня ну вот с реализацией во время реализации он да и копирование мы столкнулись с такими проблемами но они все преодолимо кроме наверное при кришна реджину в лонди ст и мы используем успешен переменные для отслеживания какой бать в данной транзакции проигрывается на логической реплики десятки используются специальные функции которые выставляют lsn и origin источника во время проигрывания транзакции на логической реплики но вот его сын можно получить есть такая функция в десятке в триггере а origin для которого проигрываться события к сожалению нашел такой функции здесь получается такая проблема что во-первых идет origin он как я уже говорил хранится в памяти в shared memory и он общее вообще для всего класса для всех баз на этом сервере и здесь получается сложность как отслеживает для какого мастера проигрывается событий если у вас несколько мастеров в одну базу пишут логической репликации следующая проблема в londa steam позиции отслеживается просто в табличке чтобы остановить репликацию достаточно просто взять эксклюзивную блокировку на этой таблице а для десятки чтобы остановить репликации вам нужно сделать alter то есть также subscription а чтобы а также со вскрыв шим выполнить его нужно закомитить здесь получается сложность что вам нужно сначала все эти операции привести в одной транзакции а допустим он тоже выполняет другой origin advance то же самое да можно сказать еще сложность что это вот костя помогли миша рассказывал что власти можно сделать ряды за счет того что очередь это просто таблицы там записано все эти события и когда нам нужно сдвинь повторить их заново простых берём от туда вычитаем заново повторяем а для десятки экологической репликации нужно сдвигать слот для этого сдвинуть слота нет такой операции вообще в поле с то есть не предусмотрен такой ну про то что при кашин origin он не транзакционными я уже говорил это делает сложным пожаром то есть сложности сложно создать вторую реплику то есть приходится сначала отключать репликации потом только делать уже там ул он все такой проблемы нет потому что он просто в табличке а табличка топиться со всеми данными ну вот про то что subscription не дам пицца да я твердо сказал ну и третья проблема да то что слот на стендбай плотно стендбай не существует после promod его нужно заново пересоздавать а так в принципе в основном вот у нас получилось сделать на десятки то же самое что и скальп тулс того если резюмируя все наши исследования можно сказать что все подходы которые мы реализовали у себя авито авито в том числе можно сделать и в десятом под грязь и тут сводная табличка и и сейчас мы не будем озвучивать ключевой момент в чем что в десятом подгрести настраивать репликацию стало очень просто но мы вас призываем к тому чтобы вы вас не смущало это простота то есть за ней кроется достаточно сложные вещи по согласованию после аварии и вот эти все результаты нашего исследования которые мы пусть оправили сергей из вас с вами вас ознакомил с ними мы выложили их на git х помните об этом нужно их развивать в том числе хочется может быть в будущем вот этот механизм восстановления после аварии будет реализован конан this коробки так же просто как сейчас создается рипли козы там крейг публики и шин кризисов скреплены все заработало хотелось бы чтоб также была там раунда и все синхронизировалась и соответственно давайте общаться заходите на наш гид хоп жить и в twitter и ребята могут в то что пояснять рассказывать там еще остался у них один момент один еще есть особенности текущей реализации которых десятки выкатилась вот ну а сейчас мы уже не успеваем ответить сам вадим у кого на вопросы можно продолжить в зоне пока хакк и на стенде авито дима сейчас будем все существа него пиджак это около написано сингапуре и грыз если такой вопрос вообще перед меня куча заданное на самые рисующая до того как десятку завезли логическую операцию до появлялся такой инструмент на поле как поголовье к да вот у него самая такая его ахиллесова пята было то что ему для работы нужно все валы хранить реплицировать да и в случае сбоя мы могли получить то же самое при заполнении диска да и кирпич вопрос вот lsm то что верит он позволяет частично выполнять репликацию увалов вот эти ход то есть ему в базе же много изменений происходит у меня допустим реплицируется одна вещь для этого не нужна рисовал я же сразу и помимо вопроса ваша вся вот все эти вопросы возникают из двойственной природы логической про кации текущей реализации десятки за то что очень хранится вала то вы по по бинарному логу вы должны обеспечивая чтобы он не радировал всем чтобы также можно было до реплицировать и вы среди полезных ваших изменений также сканируете это что вообще существует вообще в кости и то есть суда я здесь вы должны помнить что ваша очередь логической лежит бинар налоги и все особенность отсюда возникают они все присутствуют это что с ней потом еще успеем рассказе объяснить но в общем вам на на того чтобы весьма хранилась и там это все лежит и ответить на ваш вопрос спасибо то есть это прочитать его удержать чтобы можно было похоже кого их откручивать друзья все на сегодня вопрос пока нет"
}