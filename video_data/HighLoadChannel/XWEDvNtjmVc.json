{
  "video_id": "XWEDvNtjmVc",
  "channel": "HighLoadChannel",
  "title": "Как научить MongoDB делать горячие физические бэкапы / Юрий Фролов (Yandex Cloud)",
  "views": 422,
  "duration": 1630,
  "published": "2025-01-17T02:35:09-08:00",
  "text": "Всем привет Меня зовут Юра Сегодня я хочу рассказать вам как делать горячие физические бэкапы в монге вообще я работаю в Облаке в основном я работаю с реляционными базами данных но так получилось что сегодня я буду рассказывать вам про то как работает Манга Итак как я уже говорил Я работаю в Облаке в команде управляемых баз данных моя именно команда пишет код во всякие осные штуки в одиссее в Connection для поса в LG пну утилиту для всего вообще что есть ику это штука для шардирование пос греса сегодня про неё был доклад Итак к теме сначала поговорим о том какие вообще бывают бэкапы Первый вид бэкапов - это логические бэкапы там лежат какое-то описание базы данных в каком виде с помощью них Можно например переехать из одной базы данных в другую но они медленно создаются из них база медленно восстанавливается Поэтому если у вас высокие нагрузки Вам нужен следующий вид бэкапов физические бэкапы в них лежат просто данные из-под базы Вот вы их взяли с диска и положили в бэкап из них быстро восстанавливается база и создавать их тоже быстрее Итак как же дело с этим обстоит в монге кто вообще пользуется монгой Поднимите руки Вот но не очень конечно много поинта в том чтобы рассказывать про Мон в таком случае но я всё равно расскажу это документо ориентированная база льная самая популярна из льных у неё есть две версии это Source avil Community и Enterprise версия платная когда-то в обеих этих версиях были физические выгля Это примерно так она вам возвращает файлы вы их копируете и радуетесь жизни но в какой-то момент решили убрать этот функционал из коммьюнити версии и оставили только в энтерпрайз почему Ну понятно энтерпрайз сам себя не продаст Но поскольку ко версия Можно попробовать написать в неё свои бэкапы Если вы хотите из просто так э если в базу идёт пишущая нагрузка из-за этого у вас будут под ногами удаляться файлы создаваться новые в них будет что-то перезаписывать и бэкап получится битый это подходит только если вы можете остановить пишущую нагрузку Если вы не можете нужно придумать что-то похитрее чтобы понять что именно можно похитрее Давайте посмотрим как мо G db пишет данные на диск И может это даст нам подсказки Итак правильный ответ как M db пишет данные на диск это никак не пишет db пишет данные в свои Stage ны А вот они уже могут писать данные на диск главным Stage ном в мое дефолтным является verer Давайте поговорим про него Tiger - это такая база данных осная когда-то он разрабатывался отдельно от db но Был куплен db и с версие 3.2 года это дефолтный в манге в Гере таблицы хранятся внутри в деревьях Он поддерживает Как строчное так и колоночной при записи на диск это всё всё равно реализуется в два бай один для ключа другой для значения Ну и ключ храни в табли явно в колоно талих только чех битное целое число и ключ не хранится явно у них есть ещё один подтип со всем с узким применением с фиксированной длиной значения очень быстро достаются биты Но поскольку этих бит может быть в значении всего до восьми используются они очень редко только для бит масок каких-нибудь например Итак как Tiger пишет данные на диск схема выглядит примерно так вот у нас есть Как видим пользователь пользователь работает с кэшем в оперативной памяти откуда данные попадают на диск через компонент называемый менеджером блоков и параллельно на диск пишется вал рассмотрим все эти компоненты по одному Потому что много умных слов наговорил начнём с кэша кэш используется для того чтобы с горячими данными было быстрее рабо понятя быстрее дить по сути копии страниц б дерева с диска Но к ним прикручен декс для поиска по ключу и главная штука которая хранит Все изменения которые пользователь совершает со страницей и если к становится слишком большим или вызывается чекпоинт данные сбрасываются на диск причём в таблице в которых запись не шла они просто выкидываю из оперативки только грязные страни в которых бы только они пишутся на диск Итак следующий компонент важный это у нас вал вал используется для восстановления базы при каких-то падениях это журнал всех операций которые совершаются в базе и вы можете использовать его чтобы привести базу в нужное состояние в Гере эти записи пишутся файлы чтобы эти файлы быстрее создавались может использоваться такая штука Как локация у вас создаётся временный файл на диске в него пишется заголовок он помечается готовым к записи вала и для того чтобы начать в него писать вал достаточно просто переименовать файл таким образом вы экономите время на запись заголовка также при чекпоинт вал который вам больше не нужен может быть автоматически удалён Если вы хотите Итак последний компонент на схеме - это блок менеджер про него рассказ будет долгим сначала поговорим о том как он вообще используется блог менеджер используется для того чтобы выгружать страницы из кэша на диск И наоборот чтобы загружать страницы с диска в кэш в первом случае блог менеджер получает на вход структур VT page это та самая репрезентация страница бо дерева в памяти он её пишет на диск возвращает в а Тайгер адресную Куку где лежит там Осе место занимаемое страницы и чек сумма для проверки корректности и в обратную сторону это работает адресная Кука подаётся блок менеджеру Он загружает страницу с диска и возвращает её в вегеру страницы хранятся на диске в структурах называемых блоками где помимо тело страницы лежит заголовок страницы заголовок блока там тоже размер осет чек сумма вот эта вся фигня Э блоки относящиеся к таблице лежат на диске файле имя таблицы точка вт очень удобно лежат они там как-то произвольно кроме самого первого блока фай в этом блоке лежит там версия ра тоже кма используется ром для того чтобы валидировать что файл Вообще корректная таблица и размещаться эти блоки могут блок менеджером либо по принципу bestfit когда выбирается наименьшая по размеру подходящая пустая Ну подходящая дырка в файле ли когда выбирается вообще самая первая сначала подходящая Итак теперь поговорим о том что такое чекпоинты я их упоминал уже чекпоинт - это некоторая точка во времени на которую можно восстановить базу такой снимок её состояния в каждой таблице обычно в Гере будет содержаться Не меньше двух чекпоинтов в любой момент и для блока менеджеров это просто некоторое множество блоков лежащих на диске какже блок смотрит куда можно блоки для этого используются такие структуры которые называются списками промежутков этих списков хранится в блок менеджере 3 в каждом чекпоинт их состояние записывается на диск хранятся они в структурах данных называемых скип листами такая интересная проба биличенка многоуровневая Нижний уровень у неё представляет собой просто все элементы списка в виде связанного списка рованные и при вставке на какой-то уровень Каждый элемент может быть записан на следующий уровень с какой-то вероятностью это даёт логарифмическое время на вставку и на поиск элемента какие именно используются списки первый список - это список алок мы выписываем страницу на диск под неё выделяется место и это место записывается в список арованы страниц хранятся они смещению относительно начала файла следующий список - это discard это страницы которые освобождаются в рамках какого-либо чекпоинта например мы перезаписывает на диск в неё была запись и тогда её старая версия помечается как освобождаемая также отсортированы по смещению относительно начала файла и последний но не по значению список - это AV это пустые промежутки в которые можно аллоцировать новые блоки хранятся они для ускорения выбора нового промежутка хранятся они отсортированные по размеру задачи блок менеджера является следить чтобы каждый блок который принадлежит хоть какому-то чекпоинту в него не было перезаписи но при этом блоке в которые больше никому чекпоинту не принадлежат были свободны для перезаписи в них можно было разместить новые страницы как это происходит давайте рассмотрим на примере В базе рабо база работает в ней происходит чек Мы аллоцировать ещё один чекпоинт в нём допустим какая-то страница была перезаписаться промежуток под её новую версию лоцируется затем мы лоцируется промежуток и теперь поскольку у нас больше двух чекпоинтов мы можем удалить самый старый из них при этом логично должно происходить освобождение промежутка J для локации новых блоков это происходит за счёт того что каждый чекпоинт при удалении ржится со следующим и если промежуток был лоцирование блоков не всегда может приводить к тому что мы можем уменьшить место под базой мы вот подали данные но блоки есть в конце файла и место под базой не уменьшить просто так для того чтобы уменьшить место под базой используется специальная операция называемая уплотнение или comp его Главная задача - это переместить как можно больше блоков из Конца файла в начало файла чтобы в конце файла образовалось пустое место файл можно было просто потратить для этого для того чтобы страницы боле активно двигались именно в начало файла используется принцип для размещения блоков сча делается чекпоинт чтобы все грязные страницы из памяти были выброшены на диск затем Tiger обходит дерево проверяет Какие страницы выгодно перезаписать то есть какие страницы при перезаписи позволят освободить место в файле они помещаются грязными даже если запись в них не происходила затем происходят ещё два чекпоинта чтобы новые версии этих страниц были пере записаны в начало файла и старые чекпоинты можно было удалить соответственно блоки также освободились файл можно было потратить вместо под базой уменьшить Как же это ВС дело выглядит на диске рассмотрим на примере строчных таблиц Ну поскольку это у нас Дерево у него есть внутренние страница и листья во внутренних страницах хранятся ключи и ссылки на детей в листя ключи и значения причём как ключи так и значения могут быть вынесены при большом размере в отдельный фа и нанит на место где ключ и значение лежит колоночные таблицы отличаются от строчных тем что как я уже говорил в них явно не хранится ключ ключ хранится только самый первый на странице и хранится он в заголовке страницы как же делать бэкапы в Гере это наверное очень сложно Ну сначала рассмотрим немного Что такое курсор курсор - это просто штука в которая используется для любо рабо данными чтение из таблицы запись в таблице получение статистики получения вала и так далее в том числе Что самое главное в Гере уже предусмотрен курсор для создания физических бэкапов выглядит это так бэкап най курсор он возвращает вам список файлов которые вы должны скопировать для создания физического бэкапа и пока курсор открыт никакие файлы которые существовали в момент его открытия не могут быть удалены чтобы Вы могли их безопас и список файлов которые он вам вернёт будет достаточно для того чтобы восстановить базу на момент открытия курсора Как работает пй курсор Давайте посмотрим по порядку Сначала он берёт блокировку на изменение схемы чтобы вы не могли создавать таблицы или удалять таблицы и также на создание чекпоинтов содержимое фай в данный момент в базе никак не может быть изменено затем метаданные р Тайгера в метаданных лежат типа информация о том какие таблицы есть в р тагере Какого типа в них колонки где лежат Их бы деревья на диске для каждого чекпоинта Вот это всё копируется в отдельный файл затем происходит ротация файлов вала то есть файлы которые он писался Он больше не пишется пишется куда-то ещё теперь в новые файлы и весь этот список файлы вала файл Tager Backup с метаданными файлы таблиц всё это возвращается пользователю и он он может начать их копировать затем Лог на схему и чекпоинты отпускается Но это ещё не всё потому что нужно же гарантировать что файлы в списке не будут изменены при копировании Поэтому пока курсор открыт во-первых запрещается удаление вала даже если пользователь его включил во-вторых не удаляются чекпоинты которые существовали в базе на момент открытия бэкапа А значит блоки под ними тоже не могут быть и Кроме того локации овала также не используется потому что ну временный файл мы получается что удаляем Это нарушает гарантии но были у бэкап Наго курсора и минусы он восстанавливает базу только на момент своего открытия что нам нужно сделать чтобы восстановить базу на более позднее время очевидно нужно использовать вал но как гарантировать что во-первых вы скопируйте то что нужно и во-вторых что Вал у вас под ногами не будут менять ещё один курсор открыть нельзя р такого не позволяет сделать но можно использовать то что называется дублирующий курсор это курсор который при открытии принимает в себя уже открытый курсор в случае пго курсора этот дублирующий курсор вернёт вам файлы вала лежащие в базе на момент уже открытия уже дублирующего курсора и вы также сможете их скопировать он также делает как и обычный пй курсор принудительную ци чтобы в эти валы больше никто вам не писал Вы можете скопировать дальше эти файлы и использовать их для восстановления базы на нужную вам точку во времени как же можно это всё использовать для того чтобы делать бинарные бэкапы mong db чтобы заб капить любой кластер mong db вам потребуется две Вот таких стадии агрегации Первая это п курсор тот самый эп курсор который был когда-то вын из коммьюнити версии и второй - это расширенный п курсор который будет возвращать вам файлы вала которые вы сможете использовать для восстановления базы если это звучит знакомо это просто потому что в п курсоре внутри используется п курсор из Тайгера А у расширенного п курсора используется дубликат п курсора из йера по сути эти методы просто прокиды вызов до уровня Гера какже исполь эти стадии агрегации для создания бинарных бэкапов в случае одношаговая бэкап най курсор на вашем Мастере или на реплике копируете возвращённые оттуда файлы закрываете курсор и вот у вас есть физический бэкап в случае с шардирование скопировать с них файлы получить бинарные бэкапы для шардов затем с отстающих шардов нужно взять вал чтобы можно было накатить всю базу в одно консистентной расширенные курсоры потом закрыть основные курсоры и вот у вас есть физический бэкап шардирование отвечает за хранение своих данных Mon db хранит данные в ком in Memory стод или в тагере в основном то что в тагере уже есть функционал для создания бинарных бэкапов даже если в Мон db его нет с которой вы пользуетесь Это значит что При желании написать физические бэкапы в M db проще чем может показаться на первый взгляд наконец типа не бойтесь попробовать написать что-то сами на этом всё спасибо за внимание ри Спасибо большое Я бегу уже на сцену А прежде чем мы начнём секцию вопросов и ответов я хотел бы напомнить что нужно обязательно оценивать доклады пожалуйста потратьте немножко времени поставьте оценку это важна конференция спикеру нам и всем дальше вопросы Можно писать в чат зала я их зачитаю да Ну конечно если у нас останется времени но скорее всего у нас останется Если вы в онлайне то у вас там на портале есть кнопка задать вопрос эти вопросы тоже попадут в часть в чат зала и я их тоже зачитаю А теперь ваши вопросы руки Вот пожалуйста какой пятый пятый ряд нет Вот чуть подальше Спасибо У вас тоже будет возможность А ну раз-раз спасибо за доклад у меня ну во обще У меня два вопроса наверное задам один а вот Tager умеет в compaction Ну вот было слайде а при каких условиях он это делает Просто от скуки или его Надо попросить Это явно делается вызов функция компак насколько я помню и в мо db тоже есть такой вызов для сжатия места под базой вот Окей спасибо спасибо а пока у нас прозвучал только один вопрос я напомню ещё одно очень важную часть мы будем дарить подарки кастомную матрёшку и книгу за самый лучший вопрос пожалуйста Фиксируй Что тебе больше всего понравилось чтобы потом было проще выбрать у нас а Да всё отлично здравствуйте Андрей теньков А замеряли насколько быстрее физический КП логического и какие-то цифры есть Сколько занимает там не знаю терабайтный п терабайтный ба точно по времени я не измерял но Ну в целом у нас была проблема с тем что какая-то база внутренний клиент он не убирался в сутки при восстановлении своего логического бэкапа и при создании логического бэкапа типа мы добавили бинарные бэкапы и они стали убираться то есть вот это был кейс который решали таким образом Спасибо есть в правой части зала первый первый ряд с другой стороны будет микрофон всё нормально спасибо спасибо за доклад У меня вопрос с подковыркой вот у Яндекса же есть очень развитая инфраструктура хранения данных которая совсем нестандартная но на которой в Яндексе построено всё вот не пробовали ли вы заменить Tiger на свою вот эту систему вот Ну тем более что вам бы наверняка было её легче и бэкапить и сопровождать Если нет то почему А в смысле заменить что-то ещё ну то есть eng для Мон писать Ну это мудрёно но у нас написаны свои Ну мы написали код который позволяет бинарного об этом будет следующий доклад если хотите можете послушать как мы с этим работали но менять eng мо Мы не пробовали пока там достаточно сложный интерфейс или почему Ну там много методов надо реализовывать очень много коса есть ответ да думаю что этот вопрос Лучше задать команде ydb они любят э заменять сторе баз данных типа гресса на ушный storage они сделали это для для постгрес может быть когда-нибудь иду донги но это скорее просто как идея для них я не слышал об этих работах пока что на самом деле это очень интересный вопрос потому что обычно спрашивают наоборот обычно спрашивают ребята вот у вас своё Почему не используете что-то общедоступное А здесь первый раз я услышал реверс вопрос к человеку второй ряд да Я думаю тоже правая часть зала спасибо спасибо за доклад Я может быть не не совсем понял ээ В чём принципиально необходимо сделать как бы ещё одну вот как бы точку для того чтобы получать Лок когда Допустим мы не можем сделать вот эту точку там у нас образ файлов есть а дальше просто допустим Като притворится реплика и вытягивать Ну можем Да но для этого нужно другой код писать а Tiger уже позволяет просто это делать своими средствами то есть Да если хотите можете отключить удаление вала например автоматическое собирать его сами потом накатывать просто как будто кажется что вот ну лишняя точка - Это лишние блокировки файлов то что мы их не можем освобождать не Ну вам всё равно нужно при копировании этих файлов всё равно нужно чтобы они не удалялись то есть кажется что тут особо Ну тут кажется поменьше можно Ну да Ну да то есть есть минусы У такого подхода Да ну то есть такой вариант просто как-то не рассматривался Да возможности вытягивать Ну я думаю что все варианты сложно рассмотреть а был опыт не просто с постгрес сом вот оно так работает что КП он тоже физически как бы снимок файлов делает А дальше подтягивает сегменты Ну я думаю что это очень хорошее предложение когда мы пройдём в кулуары После сессии можно будет дополнительно обсудить хорошо у ня Спасибо большое где-то здесь видел руку передумали Да есть ли у нас ещё вопросы к нашему спикеру есть ещё один вопрос комментарий Да нет комментарий Да тут хорошо э здорово Мы у нас дискуссия сейчас на самом деле самое ценное во всех выступлениях - это интересная дискуссия после доклада поэтому комментарий приветствуется Ну я раз раз я Ну ответить на вопрос потому что я тоже из Яндекс облако и в целом мы используем оба подхода во-первых А во-вторых в постгрес там физическая репликация и поэтому там ну мы что пим валы что реплицируемый А ну во-вторых мы её тоже используем Но об этом в следующем докладе тайзер Да у нас такой своб две части из произведения искусства будет второй доклад тоже про горячий бкп и монге но сейчас а у нас ещё я вижу вопрос левая часть зала Спасибо Юрий за доклад очень интересный Георгий Сбер а были какие-то сравнение с Enterprise решением performance сравнивали Ну и никаких каких я бы знал кажется там главный минус энтерпрайз решения - это лицензия которая стоит много денег как бы Поэтому вот а вы всё у меня не было заинтересовался насколько кастомное решение вдруг сравнить опережает или отстаёт хоо спасибо ну Enterprise внутри насколько По крайней мере я понимаю ну то есть до выпиливания бэкап курсора он тоже вызывал внутри себя курсор ва Тайгера Так что это примерно то же самое что делается в Прай монге О'кей ещё вопросы нет тогда настало время выбрать вопрос который тебе больше всего понравился и подарить кастомную матрёшку и книгу Ну вот наверное вопрос вот провал был лучший Ага вот сюда Да правильно дадада нет погоди да А всё правильно Да прошу прощения Даня подумал О'кей А и спасибо тебе Юрий большое за доклад я тебя поздравляю Приходи к нам ещё Мы также от конференции дарим тебе подарок там тоже матрёшка и ещё кое-что вот если захочешь расскажешь Если у вас есть ещё какие-то"
}