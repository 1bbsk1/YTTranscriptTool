{
  "video_id": "GZmVFVL5dhk",
  "channel": "HighLoadChannel",
  "title": "Реализация восстановления после аварий / Сергей Бурладян (Avito)",
  "views": 294,
  "duration": 1889,
  "published": "2017-04-09T09:45:00-07:00",
  "text": "всем привет меня зовут сергей был ладена я работал авито администраторам баз данных да ну я работаю такими вот системами это нас наша центральная база 2 терабайта 4 сервер один мастер 3 стендовая еще у нас есть логическая репликация на основе londa sti это и скай тулс внешней индекс сфинкса различные выгрузки во внешней системы это такая как вот там-то выхода пустим еще у нас есть собственные наработки в области удаленного вызова процедуры x трупа c так называемые шадрина и хранилище на 16 bass ну и вот та що таке а цифра что наш пикап занимает шесть часов а его восстановление около 12 мне хотелось бы чтобы случае различных аварий этих систем наш простой сайта занимал не более десяти минут ну вот если попытаться представить вот связи различные этих систем это не вот как-то так выглядит и вот как все это не потерять при авариях какие могут быть аварии ну вот я рассматриваю в основном это аварии потери сервера и плюс для мастер еще такая авария может быть как взрыв данных ну давайте начнем допустим какой-то администратор по ошибке сделал апдейт без веры у нас такой случай был несколько раз и как от них защититься мы защищаемся с помощью того что у нас есть стендбай который применяет вал с задержкой в 12 часов мы соответственно когда произошла такая авария мы просто взяли эти данные со стоны боли и закрутили обратно на мастер вторая авария когда может зайти с мастером это потери сервера мы используем синхронную репликацию и соответственно после потери серверы мы должны сделать про могут какого-то какого-то с добавим а так как у нас репликация асинхронная то необходимо выполнить все различные процедуры для восстановления вот связанных всех вот этих систем так как вот мастер москва центральный является источником данных соответственно если он переключается оси репликация синхронно мы теряем часть транзакций и получается часть системы в недостижимым будущем для нового мастера руками это все сложно сделать поэтому вот нужно сразу делать скрипту как это выглядит авария то есть вы во внешних системах появляется объявление которых уже нет на мастере сфинкс выдает при поиске не существующие объявления sequence и прыгнули назад логические реплики в частности из-за этого тоже они перестали работать londa sti но не все так плохо да это все можно восстановить если вот мы посидели подумали да и как бы спланировали процедуру восстановления вот в частности выгрузка 2-х мы можем просто выгрузить заново и непосредственно так как он автор стоит 10 минут то эти на месячных отчетах изменения этих потерянных айтемов просто не видно как восстановить экстракция except нам повезло тоже у нас exo процесс пользуется для гиа кодинга для вызова процедур намасте синхронных и для расчета кармы пользователя соответственно если мы что-то зодиака деле то есть из адреса превратили его в координаты на карте а потом этот адрес пропал то ничего страшного что он останется зодиака дина просто мой второй раз не будем такой же треске кодить соответственно не надо устанавливать локальный вызов процедуры асинхронный он так он локально он расположен на одном сервере базы на одной базе даже и поэтому когда базу мы переключили она консистентной соответственно тоже ниче не надо восстанавливать карма карма пользователя мы решили так что если пользуется сделал что-то плохое а потом произошла авария и мы потеряли эти плохие этим это карму пользователя можно тоже в принципе не устанавливать так он же сделала это плохие вещи sky у него останутся так synths сайта sings у нас есть два сфинкса один для сайта другой для быка часа вот sings который сайта он реализован таким образом что полностью перестраивать каждые десять минут рисуй индекс соответственно мы потеряли ты зашла авария восстановились и через десять минут и яндекс полностью перестроен соответствует мастером от либо кофе сама решили что это то мне тоже не критично мы можем взрыв решить часть объявление которые изменились после восстановления и плюс 1 месяц мы полностью перестраиваем весь backoffice сенковский и соответственно сети аварийно этими будет почищенный как восстанавливать секунды чтобы они не прыгали на зато мы просто выбрали важные для нас секунд это такие как этим айди там user айди платежный первичный ключ и мы просто их после аварии прокручиваем вперед на вот решили что стоит 100000 нам будет достаточно логическую репликация мы восстанавливаем с помощью нашей системы это патч для londastyle который делает онду для этой логической реплики ну вот этот патч android такие вот три команды непосредственно сама команда и плюс две команды добавления удаления онду для логической реплики и плюс реплей ул он даст ему добавили флаг чтобы он передавал тикай dice мастера в сессионном переменную под gresso это нужно вот непосредственно самой реализации онду так как она реализована просто это триггер и на всех таблицах суп скрайбера триггер пишет в табличку истории непосредственно какая операция произошла на целевой таблиц и вот этот переданный тикайте с мастером он запоминает в этой записи соответственно когда произошла авария логическая реплика оказалась в будущем ее нужно чтобы восстановить все изменения которые из недостижимого будущего почистить и это делается просто с помощью выполнения обратных запросов то есть для inserto мы делаем билеты для орды это обновляемого предыдущими значениями но и для delete и insert ну непосредственно руками все это мы не делаем мы делаем с помощью скрипта какая здесь особенность нашего скрипта у нас тристан дубае асинхронных соответственно прежде чем переключаться нужно выяснить какой из них наиболее близких мастер далее мы выбираем этот стенд бай дожидаемся пока он проигрывает оставшиеся вала из архива и выбираем его для будущего мастера дальше мы используем поиск из 92 особенности этой версии в том что чтобы стендовое переключились на новый промоушены мастер их приходится останавливать вот приделать по моему 94 этого можно не делать ну соответственно делаем promod достигается секунд вперед выполняем нашу процедуру on doom запускаем добавить дальше вот уже интересные моменты нужно дождаться когда она когда стендовая подключиться к нового мастера мы это делаем с помощью ожидания появления timeline нового мастера на соответствующей страны вами и вот оказывается в подгрести нет такой функции из кельна невозможно понять timeline instant больниц но мы решаем это вот таким способом оказывается можно подключиться по реплика цену протоколу поздравить его с н дубами и там как раз утром после первой команды sn2 и сообщить свой вот выделен красным поймаем ну вот такой у нас скрипта восстановили мастера ну пойдем дальше как мы устанавливается непосредственно вот когда внешней системой какие-то разваливается вот например стендбай так как у нас тристан да и как я уже говорил ему просто берем переключаемся на оставшиеся стендбай если один из них падает в крайнем случае даже если мы потеряем средством добавим и можем переключить трафик на мастера но здесь будет теряться теряться часть трафика да но в принципе мы сайт будет работать здесь еще была такая хитрость как бы сначала у нас я все время создало новые стены бани из бака по потом у нас появились сервера и ты создашь ну а я все так же продолжал устанавливает из бекапа стенда бани и потом оказалось что если вот брать из backup а это восстановление занимает 12 часов а если просто сделать позже боюсь backup какого-либо работающего стан добавим кто это занимает гораздо меньше войны вот если у вас несколько стены бани можно пополнить вас тоже проверить так если ломается сфинкс сайта свинг сайта у нас написан таким образом что он полностью перестраивать весь индекс стинг сайта это активное объявление сайта то есть вот все активные объявления там 30 миллионов по-моему сейчас или 35 на сайте они индексируются вот вот этой системы индексации идет с отдельные реплики логической она подготовлена специально для индексации и сделано таким образом что там все разложено в памяти и происходит индексация очень быстро и поэтому можем делать индексацию просто вот каждые десять минут полностью снова соответственно реплику нас логических по парень соответственно если мы теряем реплику приключения просто на ее резерв а если что-то случилось со сфинксом то через десять минут он полностью просто индексируется все будет хорошим как можно восстановить экспорт 2 а вот допустим что там экспортировано 2-х произошла авария не потеряли часть последних данных extra 2 а у нас идет через тоже отдельно логическую реплику и там на этой реплики хранится последние четыре дня и мы можем просто руками заново вызвать скрипты экспорта и выгрузить все эти данные плюс там есть и чего-то архив полгода либо в крайнем случае мы можем только у нас несколько скандалов а мы можем просто взять один из них поставить на паузу и заново выглядеть в обществе данные с мастеровых xr pc xt у нас реализовано полетов по жаке это skype его то благодаря этому мы можем делать вот такие хитрые штуки по джеку это по сути просто таблица в базе и в ней за хранятся события вот оно как то приблизительно так выглядит как на рисунке там есть время события и transaq эти транзакции и когда мы восстановили клиента x рпц мы можем просто взять стянуться назад в этой очереди и проиграть заново те события которых нету в получателем и т.п. это у нас есть хранилище из нескольких баз 16 баз и они расположены 8 машинах и вот он и она это хранилище нас резервируется следующим образом что просто бинарная репликация после сонастроены с одной с одной машины на другую то есть 1 машина резервируется sn2 и мы 2 на 2 или 2 на 3 соответственно 8 на первым ну и плюс проигрывание баллов там также происходит задержка 4 дня то есть по сути у нас есть за четыре дня до к по любой из этих нот сейчас я подробно расскажу про реплику что это такое реплику нас построена на основе логическая реплика на основе возможности по сгрыз а это есть юхана мастеру и эфире триггер на нужных таблицах по этим триггером по этим триггером срабатывает специальная функция которая пишет в отдельную табличку ее можно считать как быть реализована и представление и дальше это табличка просто средствами лонди 100 реплицируется на репку на логическую репку вот непосредственно это как-то так вот выглядит я не буду на этом подробно останавливаться сам сервер логической реплики зачем это вообще нужно это отдельный сервер характерен тем что там все находится в памяти то есть шарик буфер такого размера что вся вот эта табличка плюсы и индексы полностью у него влезают это позволяет на таких вот логических репликах обслуживать большую нагрузку в частности например 1 репка служит нас 7000 транзакция секунду и тысячи событий в очередь мастера в нее льется так как это логическая реплика реализованы средствами лондон и соответственно поджог и то там вот это вот есть удобная штука отслеживания такие транзакции уже проиграли на этой логической реплики и вот на основе этой штуки можно делать вот такие вещи как онду ну какие да я уже говорил что реплика у нас две штуки мы можем устанавливается просто переключаясь если одна оливка потерялась подключается на 2 это возможно из-за того что по джекил позволяет подписать на одну очередь несколько потребителей ну вот репка упала и дальше нам нужно восстановить ее копию если это делать просто средстве на илон даст это это занимает вот у нас сейчас репка сайта это 4 часа для сфинкса это восемь часов так как там вызывается триггеры которые нарезают данные для удобной индексации хенкса и это все очень долго ну вот оказалось что есть другой способ создать упавшую репку это просто можно сделать продам с работающей но если просто сделать по годам и запустить на его londa считает они все не заработает потому что вон дасти отслеживает и на мастере и на логические реплики текущую позицию проигранной транзакции поэтому там нужно делать еще дополнительные шаги нужно поправить после восстановления дампа на мастере тикайте чтобы он соответствовал тому тиканье который установлены репки но ты если вот так вот через позже дамп копировать это все это занимает не более 15 минут ну сам алгоритм а вот как-то так выглядит можно будет потом на слайдах посмотреть backup рука предназначен для защиты от аварии но непосредственно самим бэкапом тоже могут происходить аварию и вот например в подписи в команде в примере команда команды архивирования wolof там не указано что например на нужно делать осинка давал записывается в архив но это вот важная вещь и позволяет защититься от допустим аварийного перезагрузки архива ну плюс у нас был как очень резервироваться тем что он копируется во внешнее облако но в планах мы хотим сделать два активных сервера архива чтобы архив ком он писал она убивала но еще вот можно сказать что вот сначала мы экспериментировали с позже ретивых слог для того чтобы получать непосредственно самих серверах архива валы но отказалась что в 92 он его практически невозможно использовать потому что он не делает их sing не отслеживает такие вал он уже получил с мастер какие можно чистить при тип памяти ну вот сейчас в повести это доделывают возможно будущем мы будем использовать не архив комната пожаре сивак слуг все таки мы не используем стриминга себя то есть вот то что прошли рассказывала это все основано только на вал архиве это в частности вот и было сделано из-за того что сложно обеспечить при стриминге еще и архив так как если например выберем орхиса стендбай backup завершился а мастер еще не успела заархивировать эти волны нужные для восстановления bacopa и мы получаем битый backup это можно обойти вот если у нас допустим стенда боится с которого берем backup отстает на 12 часов как вот у нас либо 95 в подписи сделали такую вот настройку архив not always а вот при такой настройке в принципе такой проблемы не будет можно будет брать и спокойно боках со стенда боя и и получать валы непосредственно тоже состава и в архив ну недостаточно делать просто backup его еще нужно проверять в святом калеб на нас за бы катилась вот мы это делаем на тестовом сервере и для этого написали специальный скрипт проверки bacopa он основан на том что проверяет после вас на лимитированный запуска сообщений об ошибках блоге сервера и плюсы для каждого с базы восстановлена кластеры вызывается специальная проверяющая функция тех backup который выполняет дополнительной проверки в частности например такая проверка что дата последней транзакции должна отличаться от даты последнего объявления не будет вам тем на минуту то есть если этих дырок таких нет мы считаем чтобы как восстановлен корректно но потом можно будет посмотреть на слайдах какие непосредственно команды какие ошибки мы анализируем логе проверки backup раньше мы еще проверяли бы копы с помощью выполнения вакуума нашей базы и вычитание таблиц но потом решили от этого отказаться потому что мы считаем по восстановленным пока поищу отчеты соответственно если отчеты по считались корректно нет никаких дырок странных значения табака по сделано корректно ну вот я рассказывал про асинхронно репликация но иногда все-таки хочет сделать синхронную благодаря тому что у нас как базе то это состоит из нескольких множество сервисов вот один из таких сервисов это платежный сервис и из за того что он выделен мы можем сделать синхронную репликацию для него так он работает на отдельной базе там не такая большая нагрузка и вот стандартная ла-тэн сети позволяет нам включить там синхронную репликацию ну что можно сказать в конце все-таки несмотря на то что рубля к цель дефекация синхронные можно в таком режиме работать и восстанавливаться если посмотреть на свои связанные системы то можно придумать и как их можно устанавливать ну и плюс важно тестировать резервной копии еще такое замечание вот у нас скрипта восстановление в конце его необходимо изменить dns и так как у нас мастер этой лице его это закатана в dns и вот мы сейчас думаем о том чтобы использовать какие-то системы типа закипит или 10 для того чтобы автоматически переключать tns такие вот пусану спасибо за внимание здравствуйте дмитрий ростов рабочие решения хотелось бы узнать очень интересно как часто возникают такие ситуации а какие именно когда приходится применять данные технологии я понял ну вот например авария с мастера у нас была как раз вчера до но у нас есть некоторые проблемы с оборудованием то есть вот мастер у нас падает где-то 1 5 в год да где то так сергей да добрый день вот такой вопрос почему вы на сайтах часто обозначали что в новых версиях ос gresso нам какие-то проблемы которые у вас там решаются определенными своими наработками или там тузами они уже решены вот почему вы до сих пор на 92 ну нас пугало ошибка вот вход гасители 394 сделали изменение проб тэйт режиму так ты весишь режима блокировки внешних ключей это потребовало от авторов плоскости изменить такую систему как мульти транзакции и и rss когда они разделили вот это вот ну то есть сейчас они более бой больше уровней блокировок в современном пожгли со и это вызвало большие проблемы с мульти транзакциями их нужно будет теперь вакуум делает для них и вот эта вот вся инфраструктура она работала нестабильно там стена вызов возникают ошибки вот в 93 94 по-моему до сих пор еще до конца не исправили нас вот это пугало и мы пока они не обратились но в планах мои думаю что вот на 95 мы наверно проведем вам трейлер а вот у вас несколько банда получается нужный а что если между ними за дело несколько зубов и вам надо синхронизировать еще и между ними получается то есть ну например вам надо понимать пули если этот платеж в платежной базе есть информация о нем в базе которой как вы решаете таки мульти меня за нас как бы есть центральный мастер он является источником данных для всех вот этих вот бас которого вокруг него в нём в нем данные об этом платежи потерялись хотел бы иметь это как он секционный просто из пойман тому и зальем мастера скажите оставьте скажите а правильно ли я понимаю что у вас нет автоматического пуловер нет автоматического нету и у вас дежурят мечами да есть дежурный администратор devops а когда происходит авария он выполняет этот скрипт переключение если я вам понимать что это дворец мастера если эта авария с логическими редкими то они или состава и мы просто меняется , нэнси и вы не планируете в будущем как-то автоматизировать это но полностью мы не планируем автоматизировать то есть и все равно он будет какой-то части человека сергей спасибо за доклад такой вопрос вы говорите сфинкс вас раз десять минут полностью периоды ксир я все данные это вот те два терабайта он раз здесь минут перелопачивает нет нет у нас есть два сфинкса у нас есть sings для сайта в котором только активно объявления это 30 миллионов есть стинг бэк-офиса вот где 2 терабайта и вот раз здесь внук полностью перестраивается только сфинкс сайта это снг это с логической реплики вот та реплика которые полностью в памяти там специально для индексации разложены по таблицам чтобы быстро максимально этого учитывалось и просто six канал вычитывает все за 10 минут полностью перестроить индексы и еще такой вопрос ну инфраструктуру сложно понятно много серверов как то это все мониторе с автоматически и средства которые используете но мы используем мунин используем коллег д по моему и соответственно но то что коллег да и то в graph они там рисуется плюс есть к бот для оли рт а то есть там множество систем здравствуйте а почему не используйте файл avi решения теперь кпрф для того чтобы избежать ника со сменой т.с. например при крахе мастера когда можете просто было бы сменить на но стендбай на мастер избежать какой-то долей проблем можно ли автоматически смениться там двойно мастер ну да или те вещи которые вы говорите у вас вызывают трудности например это смена там имен в dns этаж можно даже вообще пасторе от этой проблемы избавиться но вот для этого мы сейчас рассматриваем вот это разные решение на основе за keepers мы хотим как бы у нас нами этого сделать спасибо за доклад вопрос такой у вас вся инфраструктура находится в одном да центре да а как вы защищаетесь от ошибок связаны с инфраструктурой дата центра связана с ним и так далее и планируете ли что-то в будущем хотим непосредственно сами данные мы защищаем тем что вот эти бэкапы они копируются в другое место в какой-то не в этом дата-центре а вообще от ошибок тотан центра ну нам повезло с дата-центром там у него нет таких проблем никаких работает работает ну пока нету планов на распределения по разным дата-центров все вопросы закончены большое спасибо скажите пожалуйста а сколько вам необходимо людей что поддерживает работоспособность то есть сколько сами людей работает там респиратор который дежурит спасибо но у нас сейчас траками в главное не соврать бы по 62 и около этого тоже 6 администраторов спасибо"
}