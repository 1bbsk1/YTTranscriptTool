{
  "video_id": "Axoo80DnqvA",
  "channel": "HighLoadChannel",
  "title": "Автоматизация управления ClickHouse-кластерами в Kubernetes / Владислав Клименко, Валерий Панов",
  "views": 1180,
  "duration": 2848,
  "published": "2019-12-05T12:50:39-08:00",
  "text": "доброе утро меня зовут владислав клименко это валерий банов и мы бы хотели вам рассказать об автоматизации управления пентхаус кластерами будут обернитесь и на мой коллега начнет aed надо продолжить итак первый вопрос для кого этот доклад то есть мы видим целевую аудиторию себя как админа devops и и говорить будем на языке админом и так ну всем доброе утро давайте начнем первый вопрос что для разминки кто уже сейчас использует каберне this поднимите пожалуйста руки достаточно много но еще не все то есть надо соответственно как бы расширять данную аудиторию то есть и так тогда вводное слово небольшое что такое каберне dice то есть ожидание в индустрии таковы что uber notice окажет на индустрию влияния сопоставимое с появлением linux то есть ожидается что рано или поздно практически весь сервис сервер сайт будет работать на кубер найти все вот так оберните с это платформа с открытым исходным кодом то есть все что мы сегодня будем обсуждать она все с открытым исходным кодом которая позволяет строить система на основе контейнеров то есть это система регистрации контейнер вот и описывать система декларативно слову декларативно мы вернемся еще не раз сегодня это как раз таки очень удобный способ описания когда мы хотим описать конечное состояние системы вот и уже сама система разбирается какие шаги надо предпринять для того чтобы прийти к этому конечному состоянию соответственно кубер найти с как платформа она позволяет эффективно управлять ресурсами за счет большего уплотнения процессов и очень хорошо автоматизировать развертывания то есть получается что у нас как бы uber нить из это операционная среда дальше пойдемте дальше клип house кто уже использует клик house или знаком еще меньше рук соответственно надо как бы та же целевая аудитория нужно давайте обсуждать что такое клик house вот клик house это тоже открытый open source то есть получается столбцов а система управления базами данных для аналитической обработки то есть это классическая лап система столбцов вот которая сейчас набирает популярность и так следующий вопрос это мы пытаемся запустить клетка визг обернитесь и зачем это надо то есть зачем кому почему это может вообще понадобится современные тенденции таковы что у некоторых компаний да и таких компаний все больше и больше уже подавляющее большинство компонентов и так находится в обернитесь и то есть поверните сдает максимальной унификации управления то есть в своей практике мы уже неоднократно сталкиваемся с тем что крупные вендоры у которых достаточно большой штат админов диап сова они хотят позиционировать как бы своих сотрудников как специалистов по кубер не tissue а конкретное приложение которое вы убираетесь и запускаются уже админы не должны детально знать как же она там работает вот то есть они хотят видеть специалистов по кубер нить из и тут максимально унификация как раз таки это то что требуется также каберне this если кхал с кубер найтись и позволяет очень быстро развертывать хранилища данных то есть если у нас какая-то динамическая среда нам постоянно надо клик холста поднимать и опускать тусклости ра разного размера создавать то как раз таки динамическое быстрое построение хранилищ данных и но очень хорошо получается именно кубер найтись и и кубер найти с нам соответственно предоставляет максимальную переносимость то есть принципе получается что все эти факторы вместе приводит к тому что запускать клип house кубер найтись и переносить его туда это очень она оказывает большую пользу и так пойдемте дальше то есть клик house обернитесь и это вообще насколько просто сложно то есть это и не сложно но и не просто почему потому что у нас получается сложение а может быть даже умножение сложности то есть у нас есть повернитесь и мы пытаемся в нем как бы запустить cliff house они каждый продукт сам по себе требует некоторой сноровке управления а вместе получаются некоторые как бы дополнительные эффекты от и рутина такого что хочется это все дело автоматизировать то есть на практике когда особенно ты часто работает с различными кастерами их поднимаю создаешь опускаю накид постоянно какая-то динамика процесса то хочется это все автоматизировать хочется одну такую большую красную кнопку на которую можно нажать двумя руками и сказать что сделаем я пожалуйста клик хаос там 5 sharp две реплики вот их как-нибудь тому разместим не в кубер найтись и то есть предоставлено готовый результат вот мы в компании аль кинете все чаще сталкивались таким вот с такой необходимостью и в итоге решили как так делу подойти фундаментально вот был разработан alte нити клип house оператор для кубер не tissot то есть что это такое вот это наших продукт который соответственно полностью окон source он доступен на гитхабе его задача это управлять их кластерами карлик house в кубер найтись и то есть и так пойдемте дальше оператор следующий вопрос залу а кто знает что такое оператор в среде кубер нить из кто вообще слышал такой термин еще меньше рук ну давайте пояснять давайте рассказывать что такое оператор и так само по себе тенденция автоматизации в обернитесь и она как бы подходит с разных сторон не одним нам это очень сильно надо и поэтому был введен от относительно недавно новый термин это оператор в кубер найтись и то есть что это вообще такое эта программа которая управляет другими программами операторов классически принято описывать системы на декларативным языке то есть мы оператору говорим что сделай нам пожалуйста там допустим кластер плек хаоса или еще что-нибудь то есть на текущий момент уже операторов существует достаточно большое количество ночью не такой большой как хотелось бы но все крупные вендоры стараются более-менее под свои продукты делать оператора многие из них уже доступны на оператор хобби и так и получается и оператор он содержит кодифицированные знание то есть знания в предметной области это в общем то все то что квалифицировано сисадмин нарабатывает с опытом с болью с шишками вот оператор большую часть этого позволяет автоматизировать то есть оператор это робот помощник сисадмина он очень хорошо автоматизирует рутину но как всякий робот если у вас какой-то совершенно нетипичный случай который вот требует вмешательства специалиста только сожалению оператор вам не поможет вам все равно может потребоваться квалифицированный сисадмин но подавляющее большинство рутина оператор на себя возьмёт с большим удовольствием и существенно облегчить жизнь и так пойдемте дальше клик house оператор что это такое если оператор целом эта программа по управлению другими программами то клик house оператор эта программа которая управляет кластерам клик house вы кубер найтись и то есть клик house оператор содержит набор кодифицированный шаблонов от кодифицированы best practices то есть это как раз таки именно знание о том как правильно запускать crack house в кубер найти все то есть соответственно упрекал как администрировать кластер клип house квалифицированной админ знает вот оператор содержит шаблоны то есть он знает как допустим сделать тому кластер 5 реплик на 25 шар дам на двери плети как это совместить звуки первом как произвести зонирование то есть и все эти мы стараемся так чтобы все эти шишки которые сисадмин как хауса набивает в процессе эксплуатации они потихонечку появлялись в операторе и облегчали жизнь значит неподготовленных пользователей и так пойдемте зачем же это все надо то есть в принципе наличия такого рода программного продукта она позволяет эксплуатировать кластер клип house не сильно вдаваясь в подробности как же ши мина клип house кусты рисуется в uber найтись и то есть совсем ничего не знать конечно же не получится но при этом обладая таким некоторым достаточно базовым набором знаний уже вполне можно эксплуатировать любое количество кластеров лет house не сильно как бы понимаю как же же но там в деталях внутри работает и очень хорошо автоматизируется типовые задачи если вам надо это постоянно как бы делать то есть и мы приходим к вопросу кому все это надо то есть вначале в первом очень хорошо поможет тем кто только находится в начале пути и разбирается с тем как же ши мина cliff house можно запускать кубер найтись и то есть у нас есть набор баз practices кодифицировать знание большой набор экзампла то есть если вы только начинаете разбираться вы смотрите как вы это делаете как это делает оператор можете сравнить результаты подправить и то есть также это очень хорошо позволю помогает тем у кого типовая инсталляция то есть если у вас просто опираю клик house кластер в uber на эти себе вот и вы не делаете с ним ничего такого необычного то он периодически там растет надо добавлять новые шарды там что-то реплики выходят из строя вот оператор за всем этим может следить вот и очень хорошо он помогает тем у кого большое количество типовых задач автоматизация получается достаточно неплохо итак давайте теперь глянем что же именно из себя представляет оператору будем переходить уже от общих как бы слов к более детальному рассмотрению как же оператор работает и так у нас получается сисадмин вот этот маленький человечек вот он оперирует соответственно я малых мы спецификации и он видит клип house кластер как один ресурс как один ресурс ямал соответственно взаимодействует только лишь с этим ресурсом описывая какого рода кластер он хочет сисадмин получить вот потом этот соответственно ямал с описанием ресурсов передаются с оператору и оператор делает некую магию вот она как раз таки это оператор желтого цвета посередине он делает магию с оберните цепи и на выходе у него получается класс торф кубер найтись и которой состоит из многих компонентов они между собой уже связаны настроена то есть в принципе мы на выходе получаем полностью функциональны и работоспособный класс вот к правой картинке вот что именно у него получается на выходе мы еще вернемся и рассмотрим в подробностях что же именно получается то есть теперь мы будем говорить в терминах кубер не tissot то есть из каких компонент оператор собирают собственно говоря класс торт оберните со ну естественно из базовых строительных блоков кубер не tissot то есть это стоит full set f вода persistent волюма persistent валим клеем и конфиг map и то есть чего-то чем у нас живет кубер найдешь вот для соответственно для тех кто уже немножко имеет опыт может быть с поверните сам с операторами мы при построении оператора пришли к выводу что мы хотим использовать для каждой реплики плит house отдельный стоит full site то есть это решение не типичная в большинстве случаев используются как раз таки 1 либо реплика сайт либо deployment на весь класс труб если мы допустим говорим там про другие продукты вот но такой подход у нас позволяет более гибко настраивать соответственно сам кластер и в итоге мы можем получить кластер не состоящий из различных версий клип хауса или как бы по-другому кастомизированные также отдельной сущности у нас в кубер найти схему создается зуки пир если требуется репликация то есть но внуки пера мы еще вернемся чуть дальше и так то есть вот в итоге на выходе работы оператора получается вот такая вот значит набор сущности каберне tissot которые представлены на слайде и они между собой соответствующим образом как бы сконфигурирован ну пойдемте дальше теперь будем потихонечку начинать запускать пластырь пентхаус обернитесь и то есть что нам надо чтобы начать использовать в общем то надо немного вот для начала естественно требуется кластер поверните с то есть нам нужен какой-то instance каберне tissot можно начать с мини-клуба вполне себе работает вот и основным инструментом является кубка тылы в принципе вторым хорошим набором является набор example co конклав который предоставляется с кликал с оператором то есть там достаточно богатый набор примеров вот можно но в любой вкус выбрать и начать то есть дальше можно пойти двумя путями если вы хотите детальней шим образом во всем разобраться то можно качать исходники гитхаба смотреть там документацию достаточно подробно и множество примеров исходники все доступны все понятно как работает если хочется просто попробовать то даже качать ничего не надо можно прямо посмотреть как старт гайд и начать значит применять как бы запускать оператор прямо с гитхаба работает вполне себе нормально итак давайте пойдем дальше и создадим первый мастер клип house of обернитесь и вот спецификация ямал соответственно для тех кто уже видел кубер notice как работает тут особо нового ничего нет мы описываем новый тип ресурса клик house installation вот и собственно описываем конфигурацию кластера с именем дема в общем то эти 3 строчки они создадут как бы зачаточный кластер который будет состоять из одной ноты пока что но уже будет полностью работоспособным вот тут есть нюанс в данном примере еще никак не описан старридж но мы к этому вопросу еще вернемся то есть сто раз он конфигурируется несколько дальше вот если заглянуть теперь в душу каберне tissue что у него на выходе получилось соответственно вот мы можем увидеть что когда мы создали namespace применили данную спецификацию буквально из 5 строчек то у нас на выходе получился кластер который вот состоит из соответственно так дайте мне попробовать прицеле целых этой вот штукой да вот внизу у нас как раз таки хорошо видно что у нас получились вот подать повод сервиса и прочие компоненты соответственно кубер не tissot так ну пойдемте дальше давайте усложнять но мы хотим более сложную конфигурацию мы хотим сортирование например начнем с двух шар дав меняем нашу спецификацию 2 шарда опять кубка отеля плай вот смотрим что получилось на выходе мы видим два повода 3 сервиса соответственно 2 states это вот мы persistent валим овощи нету но мы к этому ещё дойдём то есть для того чтобы вот то же самое с configure те же два инстанция клик хауса руками уже надо было бы приложить какие-то усилия уже надо соответственно разложить конфигурацию указать клад спецификацию кластера вот все это на себя берет фоне оператор соответственно мы только лишь специфицирует декларативно что мы хотим кластер о двух шар doch но дальше соответственно следующий вопрос это мы как-то хотим наверно передавать конфигурацию в клик house тоже можно сделать любые поля которые понимают клип конфигурация клип хаоса и и можно специфицировать соответственно в секции configuration и здесь мы просто указываем что у нас будет пользователь с таким-то паролем кем-то профилем с таким-то доступом по сети то есть конфигурационные опции crack house они вполне как бы транслируется оператором в конфигурацию при клауса раскладываются по всем потом все как надо то есть сама конфигураций она распространяется ударным средством для кубер найти сайта конфиг мафами но практика показывает что этот процесс не мгновенный но зато он очень такой прозрачный и кубер найти свой классический так хорошо давайте сейчас немножечко отвлечемся от схем и посмотрим на вернее текстовых вот таких слайдов посмотрим на картинке как же у нас на самом деле происходит отношении от между сущностями которые вовлечены в эксплуатацию кластера как house обернитесь то есть внизу нас естественно качестве платформы кубер мэтерс и все прочие компоненты могут соответственно исполняться в кубер найтись и то есть у нас клик house целиком содержится в кубер найтись и так же прямо в кабинете сепаратор живет в виде отдельной сущности и посередине вот этот молодой человек в зеленом костюме с лопатой это звуки пир то есть звуки пир соответственно это компонент то есть это внешняя система в которой используется клик хаусом для организации репликации то есть жуки пар это как раз таки сервер достижения консенсуса ну кстати вопрос о многие эксплуатируют звуки перу себя ну есть руки до но немного соответственно как бы для тех кто его еще не знают что это такое это отдельный софт который позволяет распределенным системам приходить какому-то консенсусу случае клик хауса это как правильно реплицироваться то есть какие блоки данных куда что идет вот и соответственно случае если мы хотим ещё более сложно кластер мы хотим с репликацией то нам понадобится звуки и так звуки перф можно использовать любой имеющийся если он у вас имеется то есть для тех людей у которых он уже инсталлирован возможно они не захотят еще отдельные инстанции за кипера поэтому достаточно использовать просто какой-то любой имеющийся у вас если никакого нету то можно все сделать более менее прозрачно в значит с оператором распространяются скрипты по установке звуки perros persistent волю маме сложного от простого конфигурации до достаточно сложно вот то есть ставится это все буквально запуском 1 shell script а то есть пойдемте дальше то есть читаем что за кибер мы поставили вот добавляем в нашу спецификацию кластера грипплики шин то есть у нас уже получится на выходе 4 ноды то есть два шарда по две реплики четыре ноты и добавления тоже происходит очень таким вот прямолинейным способом мы описываем звуки первых который будет эксплуатироваться то есть это надо просто прописать хост 1 или список то есть если у нас закипел сложно установлены и мы говорим оператору что сделай нам пожалуйста две реплики то есть и на выходе мы уже имеем четыре значит инстанция клип хаоса которые сконфигурированный в кластер вот пойдем еще дальше пойдемте усложнять теперь мы дошли как раз таки dapper сестринство раджа но тут мы переключаемся к опять к сущностям которыми оперируют каберне this для спецификации persistent 100 раджа используется стандартный шаблон поверните said a persistent валим клеем то есть документация всего этого это из кубер не tissot то есть как данный сисадмин que ver найти со сконфигурировал какой там persistent storage как это все настроено и соответственно persistent валим клеем он абсолютно классический для кубер найти саму тут ничего не изобретали но пойдемте дальше еще больше усложнить кластер теперь она у нас будет соответственно собран из различных версий клип хауса вот вводим следующую сущность это под тимплей ты то есть мы можем соответственно под и запускаемой в клик хаусе специфицировать полностью именно тут у нас помогает вот архитектура про которую я говорил что каждая реплика crack house она живет сам states эти это нам позволяет полностью кастомизировать собственно кластер вот в итоге мы приходим к тому что мы можем говорить что у нас вот эту пожалуйста instance клик хауса такой-то версии этот такой-то версии описывается через под тимплей здесь мы как раз таки видим что мы можем четко указать и манш какой мы хотим использовать маленькая такая заметка на полях что не надо писать и мяч летит если вы хотите на самом деле получить самый свежий потому что как бы для применения ямал спецификации она должна изменяться чтобы быть применены от кластерам кубер нити сам вот и поэтому надо просто всегда явно специфицировать так в итоге на выходе вот мы уже получаем достаточно сложный кластер уже собраны из разных версий клик хаоса там уже есть репликация шарди рования настройки пользователей persistent storage но в принципе по прежнему это все еще достаточно человеческий смотрится то есть можно еще дальше усложнять как бы кластер но в данном случае мы наверно как еще больше усложнять пример мы не будем вот но просто можно сказать что дополнительно можно конфигурировать еще множество дополнительных вещей то есть это любые настройки самого клип хауса оператор также предоставляет вот за не рованный deployment то есть что это такое то если вот у вас кластера кубер найти со на железе и четко хотите что на вот этих вот железных сервера значит кубер нити запуск клик how запуская на этих не запускай вот не больше одного инстанция cliff house она каждый год зонирование это именно про это это про распределение инстансов по каберне tissue то есть полностью поддерживает safety rules on the finite rules сервис template сервисы это точки как раз таки соприкосновения служб службы которые исполняются внутри поверните с внешним миром то есть все это шаблоне зиру и цао к документации представлена также имеется возможность вот создать дефолтную конфигурацию для клик хаоса то есть мы именно в терминах того той конфигурации которую понимает сам клик half подготавливаемые отдаем оператору и о нужности инстанцирует новые инстанции клик хауса с некоторой желаемой изначально конфигурацией то есть в принципе как нам кажется конфигурирование достаточно человеческая юзер френдли от дружелюбно декларативная и управление кластером целиком она получается проще чем если это делает руками так пойдемте дальше то есть в принципе но оператор он на себя представляет не только deployment и кореша но также включен мониторинг то есть ли клаус оператор он предоставляет and point для интеграции с про миссию сам то есть прометеем и теперь еще проще упрощается мониторинг то есть если у вас получается имеется кластер клик house кубер найтись это для того чтобы настроить весь мониторинг прометею надо просто сказать что ходи вот по такому-то адресу там тебе будет оператор выдавать все метрики со всего кластера то есть уже не надо самостоятельно разбираться где же у нас там запущен инстанция клип хауса как их собирать то есть оператор это все берет на себя и также готовы уже дашборд для графа на предоставляется поэтому от интеграция с прометеем игра фаны она весьма получается простой и прямолинейной что указал прометею быть and point по которому оператор отдает метрики настроил дашборд в графа не и в общем то можно уже смотреть на крыше но работает вот это состояние на текущий день по поводу значит планов на будущее что мы хотим еще сделать первое как бы и важно это наследование шаблонов потому что хочется предоставлять какие-то библиотеки шаблонов также очень востребована внезапно оказалась хранения истории изменений как отдельного ресурса то есть в принципе опять-таки все манифеста это просто текстовый файл их можно хранить в любой системе контроля версий но к моему удивлению некоторые пользователи не хотят видеть это именно как отдельной историю хранения изменений а также ведутся работы над автоматизацией канареечного тестирования то есть это для тех клиентов у которых динамически изменяются версия клип хауса вот и чтобы можно было поставить допустим на один под где-то в углу кластера новую версию посмотреть как она работает потом и распространить там на все реплики или надеть на одну реплику или на 1 шард и потом выкатывать на весь класс там то есть сейчас это делается в таком полу ручном режиме потому что сам оператор предоставляет возможность собрать в гетерогенной кластера зла из различных версий но это все хочется автоматизировать вот пир немножечко такой вот вопрос который тут пользователи делятся на 2 типа первое говорят что мы звуки первом хорошо знакома он у нас есть как бы и мы рады и вы как мы понимаем зачем это надо 2 говорят что надо ещё какое-то сущность тащить мы про них ничего знать не хотим поэтому сделайте нам просто чтобы crack house работал вот значит мы думаем потихонечку проводить интеграцию с оператором или как-то там на общем планы есть еще что-то сделать звуки пиром усложнять half чайки и в виде отдельных повернитесь job выполнить вот такие вот задачу то есть это вот backup вот ришар линк или проведенных реплики так ну пойдемте дальше то есть итак что же мы получаем на выходе как нам представляется существенно упрощается конфигурирование развертывания также весьма упрощается сопровождении потому что у нас уже как бы вся спецификация кластера она находится в одном ресурсе увеличивается part обильность то есть уже все становится более менее унифицирована вот встроенный мониторинг существенно помогает и шаблоны кодифицированы приводит к тому что в общем-то существенно меньше способов совершить какие-то ошибки все это предоставляется оператором но есть ещё один вопрос который мы не затронули это вот вот все вот эти вот split абстракции и что же в итоге получается с производительностью то есть имеет ли вообще смысл и много ли материалов производительности если мы базу данных пытаемся разместить обернитесь и про производительность там как раз расскажет валерий панов он эксплуатирует plaster практически и немножко в этом хорошо разбирается передаю слово валирию спасибо еще раз добро утро меня зовут валерий панов я тимлид админов компании венка пару слов о том в каких декорациях мы работаем с прекрасным и с оператором вообще у нас специализированный поисковик для бизнеса мы продаем доступ к 5 у нас есть поиск по большому объему данных частично мы их сами на корабль или частично купили ну вот у нас есть поиск по данным ютюба vimeo вконтактика фейсбука twitter реддита большого количества форума в том числе огромных китайских и так далее нас что-то около 120 и физических серверов и мы сейчас переносим инфраструктуру в каберне this для увеличения density и для того чтобы сделать человеческие соседи еще пасть исторически у нас есть сетевая файловая система музеев с мы когда ее deeply или тогда цеха глостер находились еще в начальной стадии у нас они не завелись а музеев с проявила себя достаточно хорошо если кто не знал это фьюзед есть штука то есть она состоит из произвольного количества серверов которые кантри beauty от часть disk space а в сетевую файловую систему и просто это модуль для сюзи которые через hyperspace делает доступным это сетевой файлов и на любой так ну естественно это все работает под индексом и она хороша тем что вам не нужно выделять отдельные блочное устройство под нее вы можете просто сказать вот с этой машины 500 мегабайт contribute пожалуйста и все а минус у нее такие что это фузи что она медленная и в принципе если вам нужно сделать что-то типа облачного хранения допустим к лечить большое количество картинок то вот это прямо и из кейс но если вам нужен именно интерфейс блочное устройство с большим количеством в рандомных сиков запись и чтение в разные сегменты файла то музеев с вообще ни о чем это все при реквизиты потому что я буду говорить дальше и у нас уже есть клип house небольшой порядка гигабайта темпом и занимает перформанс данные за два года он работает мы им довольны но когда зашла речь и о кубрике зации инфраструктуры я подумал о том что клика вас это будет первый кандидат на выселение потому что он напрямую не аффекте production он небольшой и легко забэкапить откатиться и когда я узнал что вот мой друг ладислав разрабатывает оператор я очень заинтересовался и решил его попробовать собственно мы довольно долго уже работаем с оператором пережили апгрейт кубер не tissot едва-едва релиза собственно самого оператора я вот сформировал сформулировал тут несколько чисто практических рекомендаций и советов для тех кто хочет попробовать ну во-первых собственно сам император хостится вот здесь он состоит по сути из двух частей это оператор как бы это докер и матч ямал файл для кубера собственно эта часть этом внутренности самого оператора и отдельно это еще один яму файл в котором вы описываете кластер который вы хотите чтобы оператор вам сделал но что-то типа как если бы вы от минус задание писали нужно две реплики нужно столько то место мы вот такой собственно этот кастом яму файл для начала сложно сами написать самому и вот владислав поэтому написал огромное количество примеров вот здесь посылки их можно посмотреть там есть примеры практически на любой вкус и я думаю что они здорово помогут тем кто хочет вообще попробовать из мелочей практических которые оказались очень важные здорово попортили жениться в начале ну во-первых нельзя забывать что нужно сам оператор в отдельный кубинский namespace ставить если вы это не сделаете это он поставите системный или в дефолтные это будет неудобно собственно и сам кластер живет тоже в отдельном на им спейси это важно если у вас несколько кластеров но делать несколько namespace of у нас например купер он доморощенный на баре металле и поэтому у нас сервис ты полон балансир не заработал ну-ка убери он не поддерживается кто не знает это надо иметь в виду если у вас баре metal cover и очень удобно и функциональности в операторе самого начала была практически по тому как на каких физических но дах кубер будет разворачивать ваш приказ рулится вот атрибутами просто так на коленке собственно основная та часть информации которая я хотел бы поделиться сообществом это про перформанс смотрите кликов эта база данных поэтому перформанс тесно связан с вопросами старриджа а в кубе ресторан это больная тема насколько я слышал большинство решают вопрос интенсивного айова убери просто при калачева не им кодов как вы ведь какой-нибудь тачки и там организует локальное хранилище вот я всеми силами хотел этого избежать потому что тогда зачем каберне this если у нас все равно workload остается привязанным конкретной железяки и еще есть большие опасения по крайней мере в российском комьюнити начата вверх и до дойки рэй кубера соответственно ну типа мы раньше работали на абонементы для нас все было эффективно теперь все у нас виртуализированные в контейнерах конечно же там будет overhead на виртуализацию очень большой вот собственно хотелось бы это все померить как мы мерили ну во первых есть такая утилита tsb с тем через benchmarks youth от ребят который time scale пишут ребята и закинете прикрутили туда драйвер для клика асаи таким образом стало возможно мерить перформанс крик хаоса и на генерал тестовый тестовую базу вот она получилась такая не очень большая но как бы что то есть мы будем проводить 4 теста это запись time series собственно вот этой тестовой база мы будем делать выборку последнего значения по всему рейндже эффективно это будет fulham мы будем делать к агрегацию почасовую из всего datasette а с уборкой примерно 2 процента записей и мы будем делать просто выборку по критерию тоже который вернет нам идет про 1 процента всех данных и еще мы будем тестировать собственно наш production приказ который установлен на hardware и мы будем тестировать кубер нить из в двух его ипостасях первое это вот как раз local storage под приколоченные к железяки на мертва с заманчивым локальным старриджа а второе это собственно подсыпка в котором старик проводиться вот собственно этой файлов и музей вс ну сразу ожидалось что музеев с будет провальным провальный идеи потому что она не предназначена для того чтобы посетить файлы баз данных и ещё хотелось бы скажите тестирование будет нечестно и потому что с production откликался который на баре металле я не могу снять production нагрузка он работает и чтобы это скомпенсировать моды которые работают в вернитесь и который с ним соревнуются нищий в два раза мощнее там больше я деру два раза а если будет совсем нечестно но зато реально вот поехали запись у нас осуществляется что в кубер local store что в баре металл со скоростью примерно миллион time series в секунду в секунду до музеев и с примерно 125 тысяч то есть мы получили просадку восемь раз что в общем-то и ожидалось но смотрите 125000 time через секунду это все равно очень высокий рейд в ряд ли кому-нибудь нужно будет это вообще в нормальной работе продакшена а если нужно больше то я думаю можно легко расширить ему зевс собственно теперь считаем в один поток ну как выведем это самый легкий тест понятно поэтому что барри металл что coopers local store джим справились нормально а вот full скан уже дает существенную разницу результатах и мы видим что купер просел капистрано ну а музеев с как обычного cider меняем ситуацию берем три потока мы видим что по-прежнему кубер local 100 вич в порядке а вот как только дело доходит до full скана то здесь уже кубер получает существенное преимущество но я думаю просто потому что там больше ядер и нет продакшен нагрузки смотрите музеев с уже не так сильно отстает увеличим параллелизм еще и видим что на пускай они multi flash вообще практически не проигрывает это потому что музеев с у нас физически около 80 шпинделей конечно они все медленные они там проходят через юзер space идут по сети проходят еще один лидер space но тем ни менее это работает это было большим сюрпризом для меня потому что я думал что никаким параллелизмом не получится добиться от музеев с приличной производительности но вот успех и в итоге я думаю мы будем использовать продакшене именно криком с кластером но мы зевс и еще что хотелось сказать но мы видим что везде у нас повернитесь не дает сколько-нибудь заметного вверх и да все вот нам разницу в этих столбиках они примерно плюс минус соответствует погрешность измерений я отгонял эти тесты много раз и раз через раз получалось что кубер нить изберет баре металлу видимо от того как звезды любви что я хотел сказать в итоге для чего и зачем нужна может понадобиться крика вас оператор ну во-первых он точно будет бесполезен для тех кого нет развитой инфраструктуры то есть если вас небольшой проект и 3 сервера hetzner это вам наверное купер вообще не нужен оператор тем более далее оператор находится сейчас в фазе активной разработки и первых релизов поэтому во первых там с одной стороны может все меняться а с другой стороны если вам чего-то там не хватает то с большой вероятностью вы можете завести фичи request и вам это сделает то есть все есть позитивное в ожидании вот в таком виде как сейчас он есть он вообще идеален для экспериментов и задачи пруфов концепт то есть вот мне хотелось померить будет ли жить или не будет прекрасно мне несколько раз приходилось перекраивать кластер там это делается прям как магия то есть вы поправили одну строчку яму в файле загрузили его в кубе рг-6 редки закрутились через 20 секунд у вас новый кластер причем все под и перенастроены кликала сконфигурирован к нему пацы плен и собственно старриджа от предыдущей версии данные не потеряны и даже из за того что там всюду используется стоит вал сеток убираете стэк по очереди кладет и поднимает и поэтому даже сервис из ропши на не происходит то есть продакшне это было бы наверное вообще бомба про вверх от мы уже поговорили и последнее несмотря на то что владислав со всех сил пытается вам сделать максимально крутой сервис чтобы вам ничего не нужно было знать про крика вас все-таки что-то знать про кликал с нужно вот пример у нас в схеме была колонка которая называлась яндекс и когда мы запретили клик house 3 класс перестал запускаться потому что стал считать индекс ключевым словом и решилась это только редактированием файлов которым ддл этой базы лежала и добавлением кавычек вокруг слова индекс после все заработало для этого пришлось залезть в кишки кликал внимательно почитать логе из там что-то еще поговорить на этом у меня все и теперь выслав проведет вам мастер-класс по управлению крик алсу с помощью его оператора передает слова ему обратно спасибо у нас правда немножко время уже заканчивается мы даже немножко пересидели так в общем-то смысл какой мы бы хотели бы показать вам небольшую дымку вот о том как вообще происходит эволюция пласты road от начала инсталляции оператора и как раз таки проходя через его базовые степень развития чтобы в итоге получить кластерная 4 шарда и две реплики вот у нас еще есть время лежа mi5 ну как раз там две с половиной минуты тогда мы пойдем быстро будет 2 консоли показаны с большим шрифтом это там где у нас как раз таки вводятся команда с меньшим шрифтом это дашборд в котором губерн эти с будет результат и показывать так ну пойдемте то есть вот эта консоль и мы начинаем с инсталляция оператора то есть вот поехал инсталляции оператора мы его ставим прямо как раз таки с гитхаба ничего себе недавно вадим вот он ставит их наши кишки оператор а вот на выходе у нас получится функционирующий оператор смотрим в консоль каберне тесс появился под давайте я попробую вот сюда вот у вас нет аж уши ну получается о нет нет нет секундочку куда-то делась пришелся на так извиняюсь ну запусти заново чудо-машина чьи-то видео сломать ладно а вот опять запустилась то есть ставится оператор наш я хотел попасть вот а вот вот вот вот то есть ставится оператор отлично теперь он запуск вот заглядываем в кубер найти с видим собственно коды оператора появляются у нас в сервис и оператора сейчас мы будем на девственно ставить первую но дух клик хауса кубка тель у нас появилась первая ну да как хауса вот-вот уже у нас получается два года он появляются persistent storage же появляются сервиса то есть в кластер начинает самостоятельное шевеление так сейчас будем усложнять ситуацию то есть добавляем дальше ставим за keeper то есть это как раз таки мы ставим звуки пир внутрь кубер не this a script и готовые все вот у нас создалось на им space для за киперов вот он стартует сам за гипер сейчас вот он перейдет состоянии вот тут вот вот тут вот running как только running станет рейде то жуки пир заведется вот завелся стоит full set a для за кипера тоже готовы сейчас соответственно продолжаем дальше добавляем репликацию то есть у нас будет теперь потихонечку расти количество кодов вот то есть у нас растет кластер наш заглядываем в руки пир как у него тут дело происходит вот теперь вводим зонирования то есть следующим пунктом и как раз таки поделим plaster на зоны куда клип house может ходить куда клип house не может ходить но вот мы нанесли лэйблы зонирования произведено и сейчас мы будем как раз таки делать самый большой у нас будет четыре шарда по две реплики зонированием то есть в итоге мы на выходе ожидаем 8 кодов 8 инстанциям crack house а которые будут собраны но сейчас мы просто наблюдаем как оператор перри создает вот у нас интерес представляет вот тут вот видите как раз таки потихонечку появляются коды которые становятся статус среди вот и когда их станет 8 plaster будет полностью создан они вот так неспешно появляются с мониторингом то есть в принципе оператор вот примерно так и функционирует что вы смотрите как уже шел перекраивает close to и тут мы видим внизу как у нас сервисы появляются от соответственно сервис это для доступа к самому crack house of the persistent storage добавляются волю мы уже у нас сколько там мы уже да это он уже создает реплику с индексом 2 всего будет у нас последняя с индексом 3 верни shorts индексом 3 на две реплики так ну это у нас дома и так что мы получили на выходе то есть в принципе практика показывает что база данных целом и клик house частности в uber нить из можно использовать все достаточно хорошо то есть производительностью все нормально от и мы как бы рекомендую вам присмотреться к этому решению то есть сам в проект это open source любые значит и щипал request и и обсуждения приветствуются всячески и напоследок пятиминутка реклама crack house а то есть послезавтра будет метод проклят house приглашаем всех желающих вот по этой ссылке спасибо за внимание вынесла спасибо огромное варенье выходить на сцену и где официально благодарности спасибо полярно спасибо большое несчастье вас есть по мере слова спасибо пожалуй пожалуй пять минут если нас есть первый вопрос можем подарить да я вижу у вас важную задачу вы убираете лучший вопрос здравствуйте спасибо за доклад мне непонятно зачем нужен оператор если можно все это решить в принципе фильму есть готовы уже template их немного единственное ну может быть что непонятно как девочка родирование там вот это вот все ну для тех кто не знает но если этого не знаешь мне кажется участок даря вообще не лезть хороший вопрос про хил то есть до вопрос задается зачем это все надо если есть hell но тем как раз таки он позволяет только лишь стартовую собрать хвоста первым стартом а потом начинается мониторинг в чём я говорил maintenance то есть допустим если вы хотите вас кластер на 3 шарды вы хотите добавить четвертую вот оператор это все делает автоматизировано то есть он полностью создаст нужную конфигурацию кластера раздаст ее всем клип хаусом он соответственно добавит ее в конфигурирование он сбросит dns кэше он передаст значит сделает все dd или statement проиграет на всех репликах и вы получите полностью готовый как бы x пользованию кластер который практически не надо ничего там руками делать вот уже на уровне клик хауса будет пири-пири лета на ну как бы данные на новую реплику механизмом реплицирования соответствие блэк хаус а то есть схема вам этого не предоставят но при этом никто не запрещает пользоваться хеллман то есть тут уже каждый определяет для себя степень автоматизации который он хочет получить то есть можно конечно же и руками пользоваться то есть и краткий ответ на вопрос почему именно это решение они схему больше автоматизации да че разными словами простыми словами фильм это как контракт на установку deployment оператор от как контракт на обслуживание и сопровождение вот 2-го прозвище будет просто время директора добрый день и спасибо большое интересный заклад расскажите по написанию самого оператора есть какая-то про iwork либо или там голые и просто поверни таз и вот на чем и написано но классические операторы считаются сейчас правильно написать на гол в принципе ничего не запрещает его написать на чем угодно потому что оператор это просто программа который поместится как оберните со то есть его хоть нашел скрипт и пиши но мы его сделали конкретно в нагул касательно фреймворка сейчас природе существует значит пора фреймворков которые пытаются помочь написанием операторов вот то есть это операторов фреймворк и кубе builder соответственно вот они два мы сейчас как бы у нас написан оператор без фреймворка у нас такая вот получается нативная вещь вот потому что фреймворке они с одной стороны упрощают за другой стороны не до задает жесткое русло что очень сложно выйти если ты хочешь что то такое что фреймворк тебе не предоставляет вот поэтому ответ на ваш вопрос в целом будет фреймворке есть да они есть мы ими не пользовались наш оператор написано гол еще розги academy спасибо за доклад у меня вопрос вопрос если поддержка кубика troll weight ну ожидать что во время скриптов автоматизировать развертывании кластера ну пока что еще нет еще давайте тогда в городских лесов лимитер ресурсов лишь до ресурсы то есть получается лимита ресурсов он описывается стандартными средствами оберните со там это все описывается в шаблонах то есть можно специфицировать а потом диски вот вот то что кубер позволяют специфицировать это можно и еще один вопрос у меня вот с интеграции с гитлером там если лидер за кипера находится на каком веке к оси на него прилетел сложный запрос то жадный crack house соберет все и за гипер тормознет иногда реплики могут уходить в в редон ли режим как-то с этим эту проблему решаться будет или она можно на вещи на вопрос какой как это не делает это клонирование есть не располагает языке но просто вы криминала слышать это зонирование вот это как-то немножко противоречит концепции купер небеса о том что много но ты как бы хочу все использовать замуж за кипр не такое уж требовали у него можно реально куда угодно засунуть вообще выглядит как фичи request на то чтобы за кипер ни силился вместе с клик клик клоссовски методами как без процесс например собственно горя это примерно в ней уже завязан сзади сказать что при выходе из и поговорить дальше дополнительные вопросы и сейчас я прошу вас выбрать лучшего просто хорошего просто сама ну пожалуй все таки последний молодой человек который бурную дискуссию разворачиваем prism есть беда микрофон и скажи как тебя звать где-то работаешь здравствуйте меня зовут андрей я двух компаний называется hidden из хабаровска занимаемся эти проектами просто собираюсь скоро развертку treehouse нас есть такая необходимость и изучал вопрос перед вашей конференции можно сказать они не пришел и вот собственно интересно производительность и он явно подготовились вот вам плесну большое спасибо большое за интерес"
}