{
  "video_id": "-mbCehYz2Jo",
  "channel": "HighLoadChannel",
  "title": "Внедряем скоростное мутационное тестирование  / Станислав Вожов (WebPros)",
  "views": 106,
  "duration": 1891,
  "published": "2023-10-06T07:19:54-07:00",
  "text": "Почему эта штука ну-ка пока порассказывать про этот слайд по каким кликер Я работаю в компании вопрос в команде solos И мы разрабатываем приложение для хостинг компании мы упрощаем процесс их работы с виртуальными серверами позволяем им их продавать либо использовать в внутренних целях приложение Наше написано на PHP GS и Go мы его Тестируем и на момент внедрения мутационных тестов У нас не было ни одного тестировщика Да были тимлид менеджер все как полагается но тестировщиков у нас не было Мне кажется тесты кажется тему тестирования Проклятые 2 доклад протестирование и проблемы с кликером вот это вот сегодня второй доклад был протестирование там было примерно такая же проблема Да не протестировали в общем все так отлично часть нашего приложения это более 280 тысяч строк кода количество тестов более 6000 и код кавер 90 процентов Казалось бы все здорово Да у нас нет тестировщиков но покрытие тестами достаточно хорошее мы можем в принципе не переживать за то как мы проверяем наш код Однако мы все все-таки разработчики мыслим немножко другими категориями у нас нет тех навыков какие есть у тестировщиков и соответственно перед нами возникает вопрос а Насколько качественно мы пишем свои авто тесты как хорошо мы проверяем все возможные сценарии для этого есть различные качественные характеристики первая из которых это пас и бранч каверы Давайте представим что у вас есть какая-то функция ее можно представить в виде вот такого графа каждая конструкция внутри вашей функции на этом графике это вершина этого графа это как раз бранч это может быть вход функцию выход из нее какие-то условные операторы а ПАЗ - это все пути выполнения от начала до конца То есть сейчас на слайде у нас представлено 6 врачей и два пути соответственно можно в PHP юниты которые как раз мы используем для запуска наших тестов передавать этот ключ поставишь и он будет проверять все пути выполнения функции Казалось бы это именно то что нам нужно все ответит подскажет ответит на наш вопрос качественно ли мы проверяем наш код Однако после того как мы попробовали запустить Наши тесты с этим ключом мы наткнулись на то что время требуется просто колоссальным То есть у нас в тесты запускается где-то за 3-4 минуты Но если добавить ключ по скайридж то это уже 24 часа и больше мы даже не могли дождаться окончания этих прогонов так использовать невозможно мы писали вопрос на стекле Flow и авторы нам ответили что да Так и должно быть а на слайде там где подтверждено авторами Это ссылка на стек и флоу Когда вы получите доступ к презентации Вы можете перейти по ней и посмотреть что же ответили авторы были варианты как бы можно запустить пасхаверы отдельно от пул реквеста по команде либо же ночью запустить тесты спа-скавердж Но для нас это не подходит потому что мы всё-таки хотим проверять каждый наш полури квест до того как он попадёт к нашим клиентам соответственно мы стали думать что же нам может подойти ещё и ответы на этот вопрос было а мутационное тестирование А в чём оно заключается Давайте представим что ваш код - это вино а ваш ваши тесты это дегустатор дегустатор пробует вино говорит оно хорошее либо говорит что нет что-то как-то с вашим вином не так так вот если мы хотим каким-то образом проверить этого дегустатора Как хорошо дегустирует наше вино мы можем каким-то образом испортить вино добавить соль либо что-то еще и предложить это вино дегустатору если он попробует его и скажет что ну с этим вином все в порядке можете пить а мы знаем что мы его испортили то кажется нам с таким дегустатором не по пути так вот принцип мутационного тестирования именно такой мутационное тестирование вносит некоторые изменения в наш код в данном случае у нас есть некоторые метод в котором есть оператор больше он меняется на оператора больше либо равно и запускается тест который проверяет эту строчку кода и если тест по каким-то причинам не выполнился то считается что мы поймали этого мутанта то есть мы изменили код это мутант мы отловили этого мутанта и значит Тест Хороший Но если после изменения кода тест продолжает выполняться как и прежде значит это тест не покрывает все сценарии работы этого метода небезызвестный канал PHP разработку вы могли уже с ним сталкиваться сегодня и даже с автором этого канала Перед тем как мы начали готовиться к этому докладу мы опубликовали такой опрос в котором попытались узнать много ли вообще разработчиков используют мутационное тестирование не просто использует о нем даже слышали Не все а уж используется в своих рабочих проектах буквально единицы но в своем докладе я не буду погружаться в особенности мутационного тестирования я больше расскажу о том как мы его у себя внедряли а Познакомимся с мутационным тестированием можно по приведенным на слайде ссылкам первая из них это страница на гитхабе библиотеки infection позволяет как раз заниматься мутационным тестированием на PHP альтернатив её на самом деле нет была до какого-то времени еще одна библиотека но они сами сказали что ребят мы все используете infection дальше идут две ссылки на доклады первая из них это доклад максарафалка это автор инфекшена И он очень хорошо рассказывает своим докладе О мутационном тестировании как работает infection а вторая - Это ссылка на доклад ребята Они пробовали внедрить у себя infection но силу различных внутренних причин у них это не получилось они изобрели своё мутационное тестирование у себя но они позаимствовали мутационное тестирование из мутационные операторы Прежде чем продолжить хотелось бы ответить на вопрос а кому в принципе может быть полезным мутационное тестирование допустим у вас вообще нет тестов зачем она вам но если вы все-таки хотите писать автотесты то Смело можете перед этим внедрять к себе infection поскольку он поможет сразу писать тесты на хорошем уровне вы будете тестировать какой-то участок года infection будет говорить что все здесь Ты все протестировал можешь идти дальше если у вас много сложной логики расчётов либо ваше приложение каким-то образом связано с деньгами Используйте infection потому что он поможет вам отыскать все подводные камни какие-то Особые случаи которые вы не протестировали а это в таких местах очень важно и если у вас много тестов высокий код coverge вам наверняка будет интересно какие-то простые базовые сценарии мы как раз относимся к последней категории нам это интересно а мы были не первые кто попытался внедрить infection А в нашей компании было несколько примеров один из них завершился удачно ребята внедрили infection достаточно быстро быстро запустили его на всем проекте посмотрели на результаты добавили какие-то тесты какие-то тесты исправили мы были и неудачи на Большом проекте infection запустить не удалось просто не дождались его результатов потому что ему нужно сгенерировать слишком много изменений в коде а в другом проекте было очень мало тестов и ребята подумали что ну у нас нет тестов Зачем нам infection а теперь о том как же infection внедряли мы мы настроили infection на странице infection очень хорошая инструкция о том как можно настроить его Как запускать мы все это сделали и попробовали запустить его на всем нашем проекте не получилось потому что опять же нужно сгенерировать слишком много мутантов много изменений в коде но к счастью позволяет запускать прогоны на определенных файлах на слайде представлены команды infection первые две требуют рядом установлено Гита они идентичны и запускаются они на всех измененных файлах либо добавленных последняя просто принимает список файлов вашего проекта мы ее как раз использовали мы сами отфильтровывали файлы которые по которым мы хотим запускать infection и передавали его в эту утилиту Мы все настроили Все работает теперь нам нужно каким-то образом останавливать наши сборки если в них недостаточно тестов то же самое как Скотт кавер мы выставляем какой-то порог минимальный и если в отдельном паукесте этот порог становится меньше мы останавливаем сборку говорим программист ну-ка иди пиши тесты Здесь нам нужно то же самое к счастью у инфекшна есть свои характеристики которые позволяют нам это делать первое из них - это эшн Скоро интегейтор он показывает сколько всего было обнаружено мутантов относительно общего числа всех мутантов то есть допустим мы а поправили какой-то файл в нем сгенерировалось 100 мутантов Мы в наших тестах отловили 90 MSI будет равен 90% кстати здесь стоит отметить что если вы в большом десятитысячном файле грубо говоря поменяли одну строчку infection будет смотреть на весь файл и будет выдавать в своих результатах мутации по всему файлу То есть если на вашу строчку измененную кода попадает только 5 мутаций то вы влоги увидите 100 мутаций которые попадают на весь файл это его особенность я к ней еще вернусь убежал поскольку мы внедряем infection уже на этапе когда наше приложение достаточно большое у нас большое количество тестов Мы решили немножко схитрить и воспользоваться более мягкой характеристикой это каверы коды на сайт она не учитывает места которые не покрыты тестом то есть представьте себе ситуацию вы править бак мы говорит на тебе 100 мутантов иди исправляй Ты смотришь А на них просто нет тестов А ты маленький бак исправил ты не пойдешь исправлять все эти тесты чтобы повысить Нет мы здесь решили что мы сначала попробуем инфекшн И уже потом будем подобным заниматься поэтому мы выбрали сначала говорят какой-то мысль мы не смотрим на места которые не покрытым тестом Да они у нас есть Ну ладно переживём после нескольких прогонов Мы решили что мы выставим этот MSI на значение 55 процентов то есть минимум 55 процентов В камеру такой MSI у нас должен быть чуть позднее мы поставили его на 65 Все infection мы добавили сборки падают Однако Как нам вообще отслеживать В каком направлении мы движемся мы решили что будем присылать статистику которая генерирует infection в наше сообщение slack с которым у нас интеграция успешных сборках Вот так это выглядит мы выводим MSI других характеристики А ещё мы выводим Лог тот самый про который я говорил который генерируется на всём изменённом файле даже если вы изменили в нём одну строчку с таким логом работать честно говоря неудобно То есть тебе нужно найти в нем Где же мутанты которые относятся к своему Power квесту что решили сделать Мы в нашем приложении для Сянь добавили фильтрацию мутантов И теперь мы в нашем приложении сами просматриваем попал мутант на изменённую строчку кода или нет Если он попал мы формируем сообщение в полвеквест сообщение - это блокирующее то есть разработчик не может а Хмм замёрзшить свой путь квест пока не исправить эту проблему а здесь это Наследие представлено очень хорошие примеры мутантом мы здесь изменили вызов методы перенесли один метод из модели в сервис и infection просто взял и удалил вызов этого метода то есть в наших тестах Мы даже не проверяли что этот метод вызывается Мы что-то проверяли и нам было неважно вызывается он или нет infection это обнаружил и сказал иди пиши тесты а после того как мы начали фильтровать мутантов Мы решили что А почему бы нам самим не считать статистику Ведь мы можем определить сколько всего мутантов было сгенерировано и они относятся к конкретному реквесту А давайте мы будем на основе формулы которые есть на странице инфекшена сами считать эти статистики И ориентироваться уже на них а не на тот э-э MSI который генерирует infection на основе всех сгенерированных мутантов которые даже не относятся к квесту мы это сделали и теперь мы выставили MSI она сейчас интересен MSI А в значении 85% эмоционально нам интересен потому что мы написали код и не протестировали его то есть мы какие-то части тестировали Ну у нас остались непокрытые тестами места и они новые Нет мы должны их сразу покрывать тестами откладывать это на потом мы не будем какое-то время пожив с инфексом мы сформулировали некоторые минусы этой библиотеки они незначительные но все-таки о них хотелось бы рассказать первое конечно же невозможно запустить infection на всем проект если это уже проект средних размеров прокручивание даже и думать нечего Однако эффект может запускаться на нескольких файлах что очень удобно в рамках конкретных квестов некоторые мутанты у инфекшена бесполезные В некоторых случаях Сейчас объясню почему А у нас используется фреймвор кларевель и в нем есть своя магия Вы можете методы контроллеров или писать как с модификатором видимости Public Так esprotected infection это не нравится он говорит Смотри я поменял область видимости с паблик на протектор и твой код продолжает работать это как вообще пишешь мы посмотрели на это и решили что такие мутации нам не нужны к счастью infection позволяет исключать некоторые файлы некоторые методы из генерации мутантов что мы и сделали Ну кстати говоря благодаря этим мутациям мы обнаружили что ещё и в моделях так тот же самый принцип и мы строже теперь Подходим к тому чтобы писать protect этот метод и внутри модели они опять же доступны из всего проекта Хотя протектор а некоторые мутанты эквивалентны То есть если у вас есть какой-то логическое выражение условное условное выражение то на такое место может быть генерировано 10-15 мутантов Ты смотришь свой и у тебя просто однотипные мутанты в списке сообщений и ты понимаешь ну ты не протестировал это условие Да все эти мутанты несколько отличаются друг от друга но они про одно и тоже иногда на такое смотреть они удобно с этим К сожалению ничего уже нельзя поделать А но тем не менее есть и другая сторона ты можешь быть уверен что ты процитировал все сценарии работы этого условно выражения а infection всё равно говорит что Слушай у тебя тут есть несколько мест которые ты не проверил можно Взглянуть на эти сообщения и понять что а мне не нужно Не нужно вот это вот условие которое я здесь добавил со мной такое было я это прочувствовал на себе и взглянув на мутаторов которые сгенерировал infection я поменял свое условное выражение упростил его таким образом effection помог мне не просто с тестами но ещё и с кодом по результатам внедрения можно сказать что с инфекшеном работать очень удобно он у нас запускается на каждом пудри квесте который связан с бэкэндом мы самостоятельно считаем статистику на основе отфильтрованных мутантов они используют ту которую генерирует inction мы а публикуем в наших квестах сообщения о мутантах которые не Были обнаружены и программисту не нужно не предлагать каких-то усилий Искать эти мутанты он просто видит этот список и начинает понимать и исправлять писать тесты и об их переписывать время которое требуется для запуска мутационных тестов совсем не критичные для наших квестов плюс 3 минуты не страшно наши впечатления от использования инфекций они сплошь положительные самые неожиданный можно сказать опыт использования это то что на код review мы уже практически не смотрим на тесты мы полагаемся на infection он с этим отлично справляется ему уже больше концентрируемся на бизнес логике во время коды и тесты смотрим Может быть так в качестве исключения инфекция заставляет нас Писать много тестов Мы покрываем весь Новый год тестами места где сложные логика они протестированы сейчас лучше также из интересного во время рефакторинга infaction помогает находить не протестированные места которые у нас оказывается есть Несмотря на то что код камеры 90 процентов у меня был пример когда я провел один баг А я переименовал метод infection обнаружил все места где этот метод вызывается и говорит смотри где-то В половине из них ты даже не тестируешь вызов этого метода иди протестируй пока я тестировал я нашёл ещё несколько багов это кстати еще о том что infection в том числе помогает улучшить качество вашего кода а теперь давайте представим что мы руководители команды разработки и перед нами стоит вопрос А надо ли вам писать автотесты многие скажут что Ну у меня есть Клиенты Они протестируют у кого-то большие команды тестировщиков Мы же отвечаем на этот вопрос У себя в команде таким образом что мы будем писать автотест и Если честно нет ответа на вот этот вопрос сколько же инфекции дал нам в деньгах Но я могу сказать Так что infection гарантирует нам что наши усилия наши вложения наше время А время деньги в написании тестов оно эффективно я могу сказать что оно эффективно на сто процентов мы это можно как минимум подтвердить тем что с тех пор как мы внедрили infersion практически не один Пури квест который связан с пациентом не обходится без сообщений от infection infection нам понравился и мы сформулировали для себя некоторые планы как бы мы хотели продолжить с ним работать и первое что нам пришло в гору в голову мы бы хотели использовать свои кастомные мутаторы У нас есть какие-то свои внутренние вещи которые специфичны для нас и мы бы хотели чтобы в том числе менял и их например у нас есть Динамо в зависимости от которых в разных местах нашего года разные логика разное поведение и было бы неплохо если бы infection заменял значение динамов на другие и Проверял что мы покрываем наших тестах эти случаи К сожалению в инфекции нет такой возможности поэтому мы сами ее разработали открыли пол request в infection сейчас он находится на стадии обсуждения с Максом рафалка что же еще нужно сделать внутри библиотеки чтобы этот пул request завершить кстати говоря Если вы были на предыдущем докладе про модули А там как раз проблема в инфекции в этом там используется ПХП Доки и они помечают классы которые отвечают за изменение кода они помечены как внутренние ну без использования вот этих вот всех наворотов кий PP Вот и как раз вот эту часть нужно переписать чтобы Хмм она чтобы раскрыть этим мутационные операторы в наружу чтобы их можно было использовать теперь немножко не по теме нашей конференции Но об этом хочется сказать infection нам понравился мутационные тесты это круто И мы хотели бы их использовать еще и на фронте у себя для этого есть страйкер очень ждем когда же наконец-то сможем попробовать его подавляет итоги можно сказать что мы абсолютно довольны тем что внедрили infection мы считаем что Это правильное решение опять же из-за того что infection постоянно генерирует нам сообщения о том что какие-то места не протестированы и мы пишем эти тесты таким образом Если сравнивать до и после сейчас мы пишем тесты больше покрываем больше сценариев внедрить инфексом не сложно это не какие-то особые технологии все это хорошо описано на документации infection даже если у вас нет тестов Ничего страшного Если у вас есть желание писать автотесты и внедрять infection даже перед тем как вы начали писать тесты когда вы будете писать тесты он будет вам реально помогать А когда уже у вас есть тесты проверяйте ваши тесты может выполняться быстро Несмотря на то что на самом деле он проводит колоссальную работу чтобы проанализировать код Но если делать это как раз в рамках публика квестов либо какие-то отдельные модули своего проекта проверять на покрытие тестами он может выполняться быстро и быстро давать результат а что касается того что effection эффективен и возвращаясь к тому вопросу Хорошо ли мы пишем тесты инфекция помогает нам с ответом на этот вопрос Без него мы бы писали тесты хуже infection контролирует нас и заставляет писать и тесты лучше порой и делать наш код тоже лучше за что infection Большое спасибо за то что пришли и послушали мой доклад Буду рад ответить на ваши вопросы так не знаю в курсе ли ты у нас правила такие что ты выбираешь автора самой самого интересного вопроса или этот автор получает приз так и я вам тоже собственно напоминаю поднимайтесь свои руки и к вам придут с микрофоном Спасибо за доклад Скажите пожалуйста почему infection не смог разобраться с вашим проектом в начале старта Когда вы его натравили на весь ваш проект и если какие-либо решения например параллели тело там или еще что-то Спасибо он справился Но это было очень долго Да спасибо за вопрос Это не внедрить для каждой сборки То есть если время я не помню точно Сколько времени выполняется на весь проект Но это требует как минимум несколько часов а дожидаться несколько часов на каждый прогон сборки на ПХП Ну такое поэтому мы и решили что мы будем смотреть именно на те файлы которые были изменены и запускать infection именно на них Но если хочется именно оценить свой проект на то какой MSI Как хорошо его тестируйте можно запустить и единоразово на всем большом проекте он в принципе справится Спасибо Спасибо за доклад можно такой вопрос А почему выбрали MSI 85 процентов Да хороший вопрос часто так бывает что когда вы правите бак какой-то вы меняете одну строчку кода и она покрывается тремя тестами четырьмя генерируется маленькое количество мутантов и получается так что 85 это допустим 5 мутантов было сгенерировано нет больше допустим 9 из 10 мутантов мы убиваем хотя бы так иначе получится что часто придется во время сбора отключать интуиционное тестирование у нас есть такая возможность чтобы как раз вот такие вот маленькие квесты проходили чтобы таким заниматься Как раз 85 процентов В принципе помогает Ну у нас часто бывают ситуации Что как раз с той стаей прям смотришь и не нравишься так вопрос вот там еще есть Здравствуйте Меня Владимир зовут компания вы упоминали что проблема с большими проектами где большое количество строк входа внедрение именно мутационного тестирования в этих проектах А у меня вот по этому поводу вопрос возможно просто у вас архитектурный Монолит А если выбрать архитектуру Там проекта как микросервисы и именно каждый свой микросервис мутировать упростить Возможно ли что это упростит как бы сборку проектов тестирования проектов вот таким вот образом если для каждого микросервиса своя отдельная сборка Да у нас Монолит поэтому большой получается и инфекцию сложности с разным запустить Но если действительно проект разбить на микро сервисы можно в каждой из них добавить фешене Это поможет на всем проекте запускать Да спасибо не Слав Здравствуйте спасибо за доклад А что такое большой проект это Сколько строк кода примерно Это первый вопрос я потом второй поближе микрофон пожалуйста я услышал ну для меня Мой проект на котором я работаю мы считаем что он средних размеров А вот проект на миллион строк кода кажется уже достаточно крупным Да это жесть если он написано начали нулевых и живет до сих пор то ничего удивительного смотри проект предположим на 50 тысяч строк покрытие тестами процентов 70 Я хочу попробовать infection мне вообще стоит или мне лучше улучшить покрытие тестами сначала как бы ты подошел короче к этому Вот у тебя проект покрытие 70 процентов тестами там где уже есть тесты в каком-то количестве Пусть лучше будет infection он поможет то что раз вы пишете тесты infection будет помогать писать их лучше не важно сколько их дам вы выставите очень маленькие Мыса Если вы например запускаете на весь проект если он небольшой но вы выставите мы сами маленьким постепенно он будет расти хорошо Еще один вопрос я тебе не дам оттуда уйти смотри предположим я использую некий сторонний пакет и обновил его То есть у меня строчки кода вообще не изменилось ни одной как мне перезапустить мутационное тестирование потому что в теории логика могла измениться немного Ну то есть ты же запускаешь на только на измененный Код да получается его Я правильно понял Ну у нас в принципе смотрится У нас есть проект в одном репозитории и там где если что-то поменялось внутри бэнда запускается интуиционное тестирование А ну ладно тогда мне все спасибо я тебе напоминаю тебе надо помнить вопрос чтобы выбрать автора самого лучшего вопроса Есть ещё вопросы что ж твои шансы запомнить все вопросы резко выросли тебе нужно выбрать автора лучшего вопроса чтобы он получил подарок от нас Я бы отдал победу вопрос про микросервис вопрос про микросервисы поднимите руку Дайте пожалуйста подарок тому человеку а я вручу тебе небольшой презент от нас за твой контент Спасибо тебе большое подавайся еще выступаю будем рады тебя видеть это был Станислав по жов давайте поаплодируем ему и мы расходимся небольшой перерыв и скоро будем продолжать и будет финальный доклад сегодняшнего дня всем спасибо"
}