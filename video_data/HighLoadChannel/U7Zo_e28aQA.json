{
  "video_id": "U7Zo_e28aQA",
  "channel": "HighLoadChannel",
  "title": "Лучшие практики CI/CD с Kubernetes и GitLab / Дмитрий Столяров (Флант)",
  "views": 61415,
  "duration": 3305,
  "published": "2018-08-16T04:52:57-07:00",
  "text": "добрый день меня зовут дмитрий столяров я технический директор и соучредитель компании флант и сегодня я буду рассказывать про все эссе диску bernette асаги плата доклад будет в двух таких принципиальных частях 1 часть будет очень обзорная которая пытается показать картинку в целом а вторая будет такая более техническая с углублением которое пытается рассказать о нашем опыте этих проблемах с которыми мы столкнулись это мой не первый доклад прося и сиди с докером и губернатор аж 4 и это совершенно не потому что мне больше ни о чем сказать потому что тема очень большая и еще не все это умеют ещё не так много экспертов в этом и там есть много проблем и которых стоит рассказать я всячески постарался сделать так чтобы этот доклад был абсолютно автономен но мне было очень сложно рассказывать о каких-то деталях в губернатор не не понимая знает ли аудитория те примитивы которые есть кубер на это снова я всячески старался этого избежать она избежать каких-то проблем с с у хождением слишком сильные дебри значит и так про наш опыт про опыт компании флант мы не просто 4 доклад делаем по теме соседи мы еще и что-то делаем реальное значит реальная на данный момент выглядит следующим образом у нас 180 одно приложение в этом году будет в пройдено cabernet из-под приложениями я понимаю немаленькие сервисе key зачастую у нас даже некая совместной архитектуры а такие более так скажем классический архитектура где есть бэкенд frontend какая-то база моим кэш и вот вот эту связку я подразумеваю приложение давайте продукт или если это микро сервисной архитектура то это такой настоящий сервер значит и это не просто 180 одно приложения а стоит 80 одно приложение в двадцати одном проекте ipad проекте мы подразумеваем разных клиентов вот только что коллеги из альфа банка рассказывали про devops в банке и там у них одна огромная организация а у нас наоборот нас много много много маленьких организациях как маленьких небольших небольших проектов какие-то стартапы небольшие но у нас их много то есть нас опыт совершенно другой в рамках подготовки к этому докладу так получилось что мы решили посчитать что же у нас есть и на удивление победил на джесс вы понимаете больше чем 20 юридических лиц никак друг с другом не связанных не знающих друг о друге а победил на джесс мы не знаем почему я был уверен что печки на первом месте почему-то оказался ей хоть она даже с победил so pretty single package менеджерами npm но понимаете почему самая интересная битва пузырь со смысле елин закончилась абсолютно ничьей и видно что манга на втором месте но вот понятно что это выборка какая-то очень с другой стороны то россия то есть у нас клиенты по всей стране более-менее из малого бизнеса по мимо ресторан победил редис мы не знаем почему мы не знаем плохо это или хорошо по очередям rabbit по поиску elastic search почти 2 за сфинкс ну я думаю тоже все понимаете почему хотя мне лично свинг старается большим гораздо стабильнее проще и вообще но он понятно что вас так себя в сша это еще куча других задач окей зачем я все это рассказываю я все это рассказываю о том что вы примерно понимали наш контекст вы примерно понимали что мы занимаемся небольшими проектами там где 1 2 3 5 7 разработчиков две команды разработчиков там пять команд разработчиков это вот наш диапазон до они не 1000 в разработке как вольфа банки например да то есть мы помогаем небольшим компаниям на данный момент 180 приложений больше 30 команд разработчиков 25 клиентов вот опыт на котором мы базируемся и это речь идет исключительно про губернатор я рассказываю о том что у нас реально в губернаторе что такое seo сиди все знают что такое сиде или никто не знает что такое сесть идея основной смысл в том что эта цепочка которая позволяет доставить код с из гетто на прот значит есть три понятия континент играешь на continues delivery continues deployment я них в одном из прошлых докладов кажется говорил но главное что я понял что в целом это абсолютно не важно важно другое важно чтобы эта штука работала и ну достигала тех результатов которые мы от нее ожидаем что мы от нее ожидаем мы ожидаем сокращение времени релиза и определенные гарантии что релиз будет и пройдет успешно deploy будет и пройдет успешно и вот именно это мы ожидаем а не каких-то слов ещё один важный момент который я бы на который я хотел бы обратить внимание это мы в эту цепочку добавляем a pirate я не знаю там корректно это некорректно но мы считаем что это очень важно потому что мы считаем что доставка кода заканчивается не тот момент когда он выехал на продакшен в тот момент когда он выброшен с продакшена вот это очень большая важность в этом потому что если вы рассматриваете сей среди которых заканчивается тем что скотт улетел в прод у вас будут проблемы ну из нашего опыта для того чтобы рассказать что же можно сделать вся из sedef cabernet если точнее так в процессе подготовке этого доклада у нас получилась такая достаточно слитная система факторов которые влияют на сложность на сложности оси девку это не только в комбинации на сложностей сидел сложность всего процесса значит фактор первый чем мы хотим отвод от от от delivery мы хотим доставлять в одно окружение или мы хотим доставлять в несколько окружений у нас есть одно окружении у нас есть только про где у нас даже просто рейтинг например несколько окружений понятно что у нас есть там просто edjing еще что-то динамическое окружение хотим ли мы иметь возможность создав branch у детей получить этот branch развернутый сразу из этого бранча или хотим ли мы иметь возможность по кнопке для девелопера быстро разворачивать инсталляцию системы ну и четвертый уровень сложности delivery это если у нас несколько площадок какие-то дела распределенных а нам надо ли верить одновременно во все и как-то как-то координировать это значит если посмотреть на себя сети со стороны тестирования что мы хотим от тестов мы хотим просто гонять анализатор кода но это просто поставили на runner бинарник бинарник удали исходник на них кроватей код хороший легкий к плохой ну это один бинарник или несколько но это достаточно просто если мы хотим гонять unit тесты тесты которые уже требуют язык программирования уже требуют все зависимости но еще они требуют runtime зависимостей это сложнее если мы хотим гонять функциональные интеграционное если микро сервис это не называется компонентные тест понятно что там это еще сложнее нам нужно запустить к нашему приложению memcache москве рейде сну все runtime зависимости если мы хотим если у нас микро сервисной архитектурой мы хотим делать интеграционный тест and one тест или perfomance test микро сервисной архитектуры то это какой-то найтмэр и ну я бы не сказал что у нас там абсолютно и секс история с этим есть по kei значит дальше если мы говорим про разделение прав все и сиди вообще весь тренд идет на то что как бы разделение прав не было но оно было как-то сведена какому-то разумному минимуму там продуктовые команды devops интеграции 2 вот это все да но разделение прав все вам все хотят и все равно все хотят как то что то с этим сделать и мы видим вот такую шкалу сложности простое разделение прав и то эти люди могут только писать код эти люди могут еще и катать разные права на разные окружения этим можно встретить и можно production этим можно туда мульти встречи провал если тимлид тимлид разрешает выход на stretch а quay разрешает выката стыда в продакшен но только того же сам то есть это в одном плане и коллегиальное решение но соответственно когда у вас консилиум собирается да будет прод ok четвертый фактор который влияет на сложность вот вся и сиди в целом это архитектура вашего приложения если у вас html к йоге плавить поверьте мне очень просто если у вас стоит вас приложения пички но тут же с у которого нет ни базы не ничего нет которая ходит только во внешнее пей его деплоить просто я вот тут приложение может быть слово стоит вас приложение не совсем корректно стрелец стоит вас продукт стоит сервис потому что под положением не подразумеваю все-таки связку там с базой из вас обычное приложение все таки не одно ему что-то надо и вот я подразумеваю всю связку здесь вот вся связка стоит вы совсем ничего не хранит там достаточно просто если state full понятно что у вас уже появляются миграции у вас появляется какая-то история там с bootstrap am данных ну если вас многокомпонентные приложение условно у вас есть front and backing какие-то концу меры для индексации есть не знаю что еще кроны в целом тоже отдельный компонент ну это как бы еще один еще одно усложнишь к ну и найтмер это микро сервисной архитектура и конечно я имею в виду прежде всего не тепло одного сервиса микро сервисной архитектуре а диплом все и микро сервисные архитектуры да потому что вот если смотрим один сервис одно приложение там нормально а вот целиком окей значит что мы из этого получили мы получили вот такой график который совершенно не видно в четырех осях и я так на нем немножко по прикидывал что можно сделать и какими инструментами и вот если мы используем просто гид там хуки условно до или какой-то совсем простой фамусова похвастайся и то нас минимум возможностей если мы добавляем докер у нас открывается пачка возможности и почему докер необходим для этих возможностей я рассказывал в отдельном докладе но основной принцип в том что достаточно сложно победить там конфликты конфликта двух версий приложения зачастую вы все и хотите тестировать несколько версий вашего приложения или несколько разных приложений тут докер очень сильно помогает и для многих других аспектов если вы добавляете туда губернатор то эта штука вырастает вот так вот тут речь идет смотрите не о том что нельзя на чистом вообще можно сделать все не имея ничего вопрос во времени в усилиях и в количестве велосипедов которые на для этого сделать а я здесь говорю о том что этот функционал из коробки есть он штатный бери да пользуйся вот нужно только посмотреть в нужен только взять значит если мы добавляем связку с git la bam то в целом мы покрываем с нашей точки зрения все потребности теоретически мы на это на практике не пользовались ни разу есть где club enterprise который покрывает вот эту историю с правами но мне где club не платит я никак ним не отношусь мы вот этот кусок мульти встреча провал закрываем какими-то своими костылями наше ли если кратко наше ли и на руки у нас есть на хабре кажется несколько статей об этом но в целом вот эта вещь не нужна маленьким команда мне нужно небольшим командам весь вас одна две команды вам быть встреча право луи и вот это все не нужно окей значит есть еще пачка дополнительных требований которые кассир всегда возникают во первых быстро и быстро эта штука очень измеримая речь идет не о времени там delivery at от от идеи до до продакшна речь идет от времени комментов гида до его выхода на продакшн от вот я про вот это delivery мы быстро очень измерили очень просто измерили в ожидании программист выяснилось а там 0 вот быстро для разработчиков это 0 в тот момент когда набрано команды git push и нажать enter с точки зрения разработчиков код должен оказаться на продакшене это наиболее эффективная ну как бы модель пожелания значит со стороны разработчиков понятно что это не очень реалистично но мы видели как аппетит растет во время еды компания раньше делал это руками за час мы пришли помогли теперь они делают это за минуту и через два месяца они очень недовольна минута как как можно выкатывать что-то целую минуту реально конечной ожидании конечная цель этанол максимально приблизиться к нулю надежно что такое надежно есть два момента во первых для того чтобы вся эта штука заработала разработчики должны быть не уверены вот не знаю вы уверены в консервном на же на вы знаете что он споткнётся в банку и вы сможете им открыть банку у вас нет сомнений в том что в какой то момент он может раствориться ну есть некоторую верность вот соседи это инструмент и в инструменте инструмент должен быть на тон должен давать гарантии если это не так никто не будет кататься много раз в день потому что это страшно а если вы не будете кататься много раз день соответственно вас если вы небольшая компания у вас все сроки уезжают и много проблем других которые не касаются этой темы как выяснилось подсознательно разработчикам гораздо важнее доступность соседи нежели доступность prada почему это совершенно серьезно так почему потому что до рот не работает до компания не получает деньги на разработчик это головой понимает ну все понимаю но он не чувствует это физической болью а вот в тот момент когда он пытается выкатить свой код в review ветку вот он хочет посмотреть как это работает она не работает он является непосредственным пользователям и он испытывает ну понимаете что он испытываете удовольствие и конечно конечно растет негатив и мы пришли к тому что надо стараться определять такие же требования к доступности сидит как доступности продакшном и или близки дешево но я не знаю как это комментировать нынче все должно быть дешево потому что чем дешевле системы в управлении понятно что все эти ну как бы сей сиди можно построить с нуля меня в команду большую из кучи талантливых людей на дженкинс и там куча кода но я верну by еще на чем-нибудь но хочется сделать штуку которая но хочется взять готовое как можно дешевле и как можно меньше денег тратить на и управления и на администрирование этим и второй момент вряд ли кто-то готов тратить в 10 раз больше денег на деф инфраструктуру чем на пруд соответственно с одной стороны хочется обеспечить богатые возможности для разработки для процесса разработки с другой стороны сделать это не не колоссальными ресурсами окей есть еще пачка особых требований fanta связанных с тем как мы ведем бизнес и как мы работаем если вкратце то но мы там нас просто такой взгляд на жизнь что мы используем только opensource с одной стороны с другой стороны это возможность ставить там продукт в любую компанию без ограничений разно масштабность у нас есть клиенты малинки нас есть клиенты средние там на несколько команд у нас нет клиентов с тысячами разработчикам и не знаю вообще что это такое то есть мы можем только догадываться до там жили докладом смотреть но нам нужно чтобы продукт был одинаково хорошо применим в компании с одним разработчиком в компании с тридцатью разработчиками и там с пятью десятью и чтобы и там и там это было одинаково эффективно интероперабельности многие компании имеют какую-то привязку мы в амазоне мы в таком-то дата-центре мутант у нас такой привязки нет у нас клиенты везде у нас есть enterprise соды своим варии у нас есть amazon google клауд вижу и celik целое все что только можно соответственно нужны инструменты которые мы можем использовать где угодно и для нас это реально важна простота эксплуатации понятно будущее будущее это очень важно что я подразумеваю под будущем есть продукт который сейчас хорошо работают но за ними не нам не видно будущего нам кажется что у них нет будущего есть продукты которые сейчас может быть иметь какие-то баги какие-то проблемы но уже работают но видно что там через два года они станут отраслевым стандартам и конечно мы заинтересованы в продуктов в использовании инструментов у которых есть будущее про инструменты но и знак из названия доклада было понятно что мы пользуемся губернатором и докладом из того что мы пользуемся губернатором было понявшим пользуемся докером это очевидный кусок и я ничего не буду говорить про гид lab pro докер про cabernet а потому что а есть об этом отдельный мои доклады б уже большинство и так знает гид лап я думаю что пользуется я не знаю сколько я не буду делать суждение много людей знают гид лапы пользуется я расскажу про два последних это фильм и доп а нет простите я расскажу про кубер нету значит действительно самый важный момент про губернатор с которым надо сказать что это черный то есть да он как-то внутри устроен там много кода на гоа об этом можно почитать в других источниках самый важный момент для нас сейчас что некоторые черный ящик в которой мы отдаем декларативное ямал описания а получаем облака контейнеров ну вот как бы не смотря на то что облако контейнеров звучит как как облака контейнеров но отдали декларативное описание получили ожидаемый результат и описание именно де квартир мы не говорим и губернатор заведенном там два контейнера или у дали нам два или поменяй этому контейнеру и матче мы говорим должно быть так то есть описание декларативная второй важный момент про губернаторства что он мы в квадранте не оперируем уровнем контейнеров мы не говорим там контейнер такой мы оперируем гораздо более высокоуровневыми понятиями у него есть коллекция примитива коллекция строительных блоков из которых мы можем городить архитектурой и очень подробно об этом в докладе ссылку дам в конце если хотите значит vitlab докер cabernet стандарт для нас сейчас мы не думаем ни о чем другом у нас даже нет никаких сомнений мы просто счастливы фильмы доп значит helm это пакет менеджер для губернатор который поддерживается microsoft как ни удивительно значит состоит из двух кусков есть консольный клиент есть сервер который запускается внутри cabernet со ну и смысл его работы ровно такой же как у любого другого патч менеджера это задать стандарт для пакетов и уметь их ставить есть наша утилита дат они я рассказывал на прошлом хайло де и сейчас мы в нее сделали еще кусок с дипломом но можете посмотреть можете пользоваться можете не пользоваться она ничего экстраординарного не делать на маленькой обертка в одном случайно дайконом другом случае надо фильмом которая делает нашу жизнь чуть лучше и так возвращаясь к возвращаясь к соседи pipeline если мы его изобразим вот таким вот образом то есть у нас есть гид по середине есть я и есть справа перед значит и если мы будем помнить что вот эта часть это то за что отвечает где club клаб отвечает за классическую часть continuous integration за pipeline а запрещено отвечает губернатор дальше происходит такая штука у нас есть git репо в котором лежит файлики платья яма в git лобби все декларативно тоже на ямах и он отвечает именно за pipeline какие-то мтс 3g какие что делать есть в китовом репе докер файл в этом докер файле описано как наш проект собирать в доке рыныч ну разумеется у нас где лежат все исходники там игра цветы то ли я об этом не говорю да я говорю о том что кроме исходников лежит в дитя значит докер файл на стадии build превращается вымыть на стадии же build отправляется в докер реджис 3 и мы используем с большим удовольствием битловский докере jest ли он классный интегрируется из купер нету самые решает все вопросы и если вам необходимо тестировать соответственно вы в тестах используйте этот же докеры матч плюс в те лежит фильмов sketch art который на стадии тепло и утилитка термин стал отправляется в кудир на это комбинация там качает имидже истоки реджис 3 и нет визы и вуаля значит вот таким образом выглядит основной процесс вся и сиди с губернатором все декларативное есть информация о том как собрать и мы есть информация о том как устроена сей есть информация о том как устроена архитектура приложения я понимаю что те люди которые не очень знакомы с купер нации не понимают как там круто все в этих йамликуху cabernet но я не могу сегодня вам этой крутостью поделиться значит дальше есть нюанс в том что мы на самом деле вместо докер файла используем доп файл вместо докер билда build вместо термин стал добкин deploy но это не важно потому что это реально тонкой обертка и смысла это не меняет значит весь сегодняшний день весь завтрашний день мы будем на стенде подробно подробно рассказывать с большим удовольствием отвечать на все ваши вопросы все исходники приходите если есть вопросы значит и на этом обзорная часть заканчивается а начинается пачка истории они с разные глубины погружения истории именно как какие проблемы есть там вся их сиди губернатор и в общем пачка истории история первое что должно быть в докер образе казалось бы очевидный момент но мы видим постоянно что люди задают вопросы не всегда понимают какие вопросы люди задают например а почему бы нам не использовать готовый образ спички к нему монтировать наши исходники этот вопрос который мы слышим часто или вот это наверное основной вопрос или а стоит ли нам в докер-образ ставить все наши зависимости ответ в докер образе должно быть все вообще все чтобы можно было его запустить абсолютно автономно а именно если у вас проектный печь питу там должен быть печки должен быть ну все системные компоненты там должен быть папич менеджер которым вы пользуетесь африке шилову package manager но все понимают что это там должны быть все пакеты которые таких менеджер поставил все зависимости вашего приложения там должны быть все липки которые нужны этим пакетом там должны быть обязательно исходники там должен быть должны быть собраны и ассеты с скомпилированный cs и скомпилированный джесс все что только можно и готовая конфиги если вы не пользуетесь губернатор сам вряд ли у вас получится сделать но если вы не пользуетесь какой-то готовый системой артист рации для докер если у вас по легко получится сделать готовый конфиг но если у вас сервис discovery есть и в этом завязано dns то скорее всего вы сможете сделать готовые конфиги для всего который даже не надо про метро давать или минимально их параметризовать какие вопросы еще бывают а я хочу переменное окружение передавать отладочный режим или не отладочный то есть типа для prada или не для провода вот умно доджерс я хочу погиба жить для этого для этого разработчика настоящий ни один из разных компаний нас просили что сделать давайте мы в докер будем передавать перемену окружении в зависимости от переменной уже не будете ставить разные dependence и нам нужна разная dependency для для prado и разные дать для дыма что здесь не так это полное убийство самой основы докера самого паттерна ему то был инфраструктуры потому что если вы вымыть после запуска что то ставите кто гарантирует что он вообще поставится кто гарантирует чтобы поставится два раза одинаково кто но как-то гарантирую что она оставить сегодня поставится через три недели там очень много таких вопросов поэтому докеры матч должен быть всегда собран целиком если вам нужно ввести отладку собирайте 2 докер имиджа продавай и отладочный но как бы собирайте их сразу все и просто 2 и матче если можно до 15 собирайте 15 еще один момент о котором я уже говорил в докладе по протоке полтора года назад вот есть такой кейс есть готовый лет в нем у вас есть branch мастер в котором пусть есть докер файл пусть есть зависимости все пусть есть исходники вы из него собираете докер-образ классно ставите так ну например по имени бранча классно и отдаете куэй на проверку ну или сами проверяете или неважно проверяйте выкатили куда-то проверяете о все хорошо и тут вы вдруг берёте и делаете мерч в какой-то соседней branch например в продакшн и оттуда собираете докер-образ вот сейчас на картинке очень хорошо видно что докер образа по два разных они 1 и они ни разу не равны и в один могли поставить с одни пакеты в другой другие в один вот между этими действиями из пакетов в но тут же с а вот ту фигню налили которая там не знаю помните или нет ну да ну если бы ее удалили у нас буду крем еще не собрался а если чуть подправили так что он собрался и вроде работает но какие-то там по-другому не надо так делать значит если вы вместо мир до поставите пик и потом переса берете и мы тоже не надо потому что учил на мыло а разумеется нужно отдавать на проверку не не вот это а вот это да то есть конечный и матч самая главная мысль отдавать на проверку только конечно не мочь и этот же имидж бинар на тащить дальше на продакшен мы для себя сформировали некоторые соглашение что в ките есть бронетяги соответственно избран чем мы собираем временные образы из тегов мы собираем релизные образа и временные образы мы используем для нужд review the для нужд м а а резные образы мы используем в цепочке которая доходит до prada если стоит задача продукт оунер быстро показать какой-то фичу то это вот временный образ если стоит задача посмотреть работает ли моя фича сейчас просто посмотреть это временный образ если стоит задача посмотреть интегрированы изменения но мы померили в мастер три штуки это временный образ а если мы вроде посмотрели вроде работает 1 до релизе то мы ставим так собирается и матче мы его гоним по ну уже там по тестам почему третий момент третья история история не связаны я не знаю их восемь прошлый прогоны у меня занимали 1:20 регламент 30 минут прошло тридцать но мы успеем значит порядок выката эмиграции тут я должен немножко все таки рассказать про cabernet с и про примитивы которой есть купер сейчас у меня на картинке нарисована облачко которая символизирует такой примитив губернатор как deployment deployment это коллекция контейнеров включающая логику обновления этих контейнеров и включающая логику масштабирования то есть deployment а мы указываем версию имиджа и сколько штук а он уже сам разруливать мы циферку меняем он добавляет контейнер циферка уменьшаем он уменьшает контейнер меняем версию имиджа он в стратегии rule out эти контейнеры по одному обновляет нас не обновляет мы просто удаляя стали добавлять новые второй момент тут нарисован зеленый квадратик с гороховым стручком мы так показываем под на самом деле в cabernet оси невозможно создать контейнер так то можно создавать только под и под это несколько контейнер это может быть один контейнер на может быть несколько контейнеров тесно связанных друг с другом которые имеют общий локалхост всегда ходу лица на один хост ну они составляют монолит из нескольких контейнеров давайте так так вот соответственно у нас есть deployment в котором трипода и у нас есть база данных ну то есть есть baking есть база это значок стоит full set а что такое стоит fused неважно другой вид другой примитив купюрница по сути там тоже есть подсказать ремарка у нас зачастую в прозе базы не в кудир нас вроде но вот вне про да там station китайские все остальное уже все целиком в губернаторы мы радуемся прод ну во первых от проекта к проекту зависит во вторых от инфраструктур потому что если это вам озоне то с удовольствием а если это в на желез кто там есть сложности с правыми базами в cabernet и но это не важно важно что есть база значит у диплома то есть некоторая версия версия имиджа которая сейчас вы кочина и допустим у нас созрел созрела новая версия еще раз понимаете докер-образ там бэкенд собранный новый есть мы нажимаем диплом что при этом происходит во первых скорее всего наш тепло и через там фильм чарты через вот это все обновит версию дипломанта и deployment окажется в таком транзитивной состоянии то есть я типа еще версии 07 14 но мне уже надо версию 08 15 и скорее всего фильм создаст job это еще один примитив губернатор означает типа akon контейнеров выполнить один раз то есть такой job я даже не знаю зачем это объяснять по моему это интуитивно понятно и нам у нас создаст a job который будет выполнять миграции но штука иммиграции в зависимости там от вашего фреймворка понимаете там рейтинг baby my great или там зависимости от от того какой у вас движок миграции но при этом у вас все равно какое-то консольная утилита который вы говорите с мигрируем не базу есть невероятное количество нюансов связанных именно с миграцией база что можно делать что нельзя делать это за пределами этого доклада совсем но данность в том что у вас есть некоторые команды который вы иммигрируете базу так вот что при этом происходит в кубе rnessa происходит несколько вещей параллельно во-первых губернатора читает обновлять deployment он и так отслеживал я просто не показывал знает версию каждого пода соответственно в виде тара под старой версии остановлю его он восстанавливает и удаляет и начинает запускать под новой версии а это под лезет базу пытается трахнуть видит нет миграции что делает падает кстати хорошо если он падает на не мигрировали базе потому что не падает на эмигрировали масло может запуститься и просто вас куски там какого то при частом и пео или что-то может не работать те куски который лазят в таблицу которая должна была появиться колонка но мы считаем что у вас ваш фреймворк падает когда база не смогли равана и все хорошо и купер нет ах ты гад упал удалю тебя создам заново он опять упал их убирают сидит или старте под до бесконечности с увеличивающимся тайм-аутом ну как бы для того чтобы не создавать просто вот эти мире стартами лишнюю нагрузку параллельно с этим job создает под в котором будут выполняться с миграцией и мы считаем что этот код запускается и ваша утилита с миграциями работает работает работает работает она ходит в ту же самую базу там какие-то альтеры делает опустим это и будем считать что это под выходит успешно повернется понимает под вышел успешно значит у нас успешно и будет больше не будет пересоздавать коды для этого jobo потому что если он выполнил успешно он бы также продолжал до тех пор пока не добил бы ну что-нибудь вы не добил на или пока бы ему кто-то не помог ok база теперь от мигрировала соответственно следующая попытка станет успешной классно один обновили после этого кубер нации пойдет дальше остановит следующий убьет новый когда запустился остановит ну тем же процесс могу обновить следующий все выкатились проблема проблема в том что во первых я уже говорил хорошо если у вас бэкенд падает когда база мигрировала если не падает а вторая проблема в том что вот эти вот увеличивающиеся тайм-аут и они приводят к тому что допустим вас миграция работы две минуты за две минуты кубер нации выйдет на тайм-аут в пять минут и соответственно вместо того чтобы вас выкать занял две минуты плюс 15 секунд добавлен обновления бы kind of он займет две минуты плюс 5 минут этого тайм-аута левого и только после этого 15 секунд на обновление остальных кодов соответственно для того чтобы так не делать нужно сделать следующее понятно что миграции и бэкенд использует базу и там есть явная зависимость соответственно если миграция пытается столкнуть или если база пытается если бэкенд пытается стартануть с базы нету или база в комп не там состоянии они упадут окей но есть еще и косвенная зависимость и эту косвенную зависимость нужно явно отслеживать нужна помощь и бэкенд раньше миграции ну не надо обновлять на данный момент в губернаторы нет никаких встроенных средств для определения порядка запуска вот этих вот штук там сейчас есть такая вещь как и нет контейнеры и до того как под стартует можно указать несколько контейнеров которые если вы как выполняется успешно то продолжай если выполнить не успешно то стой не надо мы в этих а нет контейнеров час до докатились до того что мы вайли натка там например проверяем открытой спарта базы и пока порту база не откроется мы такие валики счастливчиком в один и база то есть и база ты есть и база то есть от база пошли дальше для ожидания миграции можно такой же вайл писать который вашим вашим фреймворком для миграции будет проверять о миграции уже прошли миграции уже прошли когда прошли только тогда продолжать немножко костыли немножко это страшно но это работает и ну это минимум этаж и шоу 1 шился одна строчка нашей а на каждую такую зависимость то есть это что то чему же можно пользоваться понятно что там пройдёт год и будет какой-то встроенный механизм вот этих вот dependence of но сейчас его нет но есть решение второй кейс представим себе что у нас база таких купер на эта сеть и представим себе что мы создали в купер нэнси отдельный namespace там есть namespace и я думаю всем понятно такое namespace отдельно этом окружении пустое и мы пытаемся в это пустое окружении вывалить наш фильм как это выглядит есть три примитива и губернатор начинает одновременно запускать трипода на на разных серверов как schedule этот отдельная тема понятно что с первого захода скорее все эти два упаду дружба за еще не стартанула ну потом база стартанет со второго захода стартануть миграции с третьего захода наконец-то стартанет бы кента который потом доске лица но как бы это в худшем случае лучшем случае мы тем же самым механизмом делаем зависимости то есть в целом у нас в китовом репин чарте указано что вот так ставить база вот так ставить миграцию вот так ставить бэкенд вот так ставить frontend вот так ставить сфинкс вот так ставить еще что-то и там стоят и щеки например в вроде вместо базы в губернатор домен пробрасываем туда в продавай инсталляцию базы ну например соответственно резюме этой истории ну как то явно пропишите зависимости потому что иначе все это не будет работать bootstrap базы о чем идет речь значит если у вас появился такой классный функционал и вы можете взять и ваше приложение поставить пустой namespace она полностью разворачивается со всеми зависимостями вас тут же возникает желание я хочу вот развелось мне приложения хочу там потыкать в интерфейс зайти в админку зайти еще что-то а база вас пустая соответственно вам надо как-то ее наполнить по сути есть два способа наполнить базу это или там какой-то заранее готовились ыды сюда или текстуры в разных в разных фреймворк это может называться по-разному значит с дампом очень просто стартанула база после базы отдельным job в губернатор загружаем туда дам после загрузки дам пока не иммиграции который получается что косвенно зависит от дампа после этого запускаем бэкенд который получается что косвенно зависит от миграций ну то есть вот такая вот оркестров очка sd пандан сами уже чуть сложнее но терпимо в случае с седыми стартанули базу сидом обычно нужно миграций то есть а не рассчитывать на то что уже в базе создана структура вся я под миграциями подразумевая что вас миграции правильная с нуля которое на пустой базе и ее полностью приведут к нужной структуре но если это не так там между между миграциями и база еще лоб дам со структурой но неважно запускаем сиды это тоже job который зависит от миграций целом мы можем параллельно запускать бэкенд он от седов не зависит ну я надеюсь потому что если вас booking не запускается от того что юзера в базе нет это ну что то что то наверное хороший они могут стартовать пароль или вот примерно так это выглядит мы перебрали для себя все варианты как же можно быстро падь базу ну и если интересно мы можем подискутировать об этом на стенде но я сейчас кратко мы пришли к тому что есть два классных варианта если хотите сфотать я могу слайд поддержать ну презентации все будут выложены в общем это квад будет выложен очень скоро значит есть два варианта которая с нашей точки зрения наиболее оптимально смотрите если просто брать и загружать сиды в базу это может занять например минуту не бояться сколько там скрипт который быстро брать базу работает вместо того чтобы это делать мы делаем следующее мы берем branch мастер и каждую ночь выполняем загрузку седов и делаем дам а еще круче делать не дам а взять и докеры мышь с установленным москве гелем и прям в эту базу загрузить все что надо и вот так вот докеры матч с данными там с да под иглами зато файлами mais quel а прям коммент docker и мы готовы с данными чтоб даже дампа не надо было заливать ну или там способ этим шланга смысл смысл меняетесь у нас есть докер ный димыч в котором база готова и загруженными данными но такая для дева и классно в том что если мы используем этот и матч вместо обычного у нас бог 10 секунд и база развернулась и второй вариант который тоже классного просто сильно сложнее в реализации если у вас есть к это скрипт или если вы в состоянии писать скрипт который ваша правовую базу cabernet почистит of us и рует удалит телефоны там какие-то персональные данные может быть уменьшит в размере в идеале и вот выглядит этот дом пусть это скрипт работает четыре часа пофиг вы запускаете его в полночь каждый день он вам генерить докер не матч который быстро пальца за 30 секунд и вас прямо по настоящему ну данные близкие к продано которых вы уже большинство кейсов можете посмотреть собственном из пришли к примерно двум вариантам которая наиболее используемый понятно сейчас такого скриптонит можно также там dumps про догони то есть можно ночью делать копию prada есть вас база небольшая окей как это выглядит в git лобби бит лобби это выглядит вот так и мышь сбился бабах где plaza все приложение в целом если мы диплом в пустое окружении то она создаст базу по умолчанию например с ночными с ночными видами плюс все приложения если у нас уже что-то стоит в этом namespace есть мы облетим весь мы не стали мысли мы облетим то она только обновить код то есть базу она не не перед рот плюс есть кнопочки для ручного для ручного перевыполнения ok следующий момент вы как без простое казалось бы бернетт с deployment и rule out что там как вообще откуда там простой как всегда везде есть нюансы значит опять есть deployment с двумя кодами а и есть ну тут за счетчик ingresso нарисован для тех кто знает что такое игр с это не знает по сути ты просто входной балансер в встроенный в губернатор там есть разные варианты реализации но входной балансир и у нас есть два пада и на них идут запросы допустим мы решили обновиться вы видели уже как это происходит стратегия рл out соответственно купер нация начинается топать один под и что происходит момент стоп а разумеется нас там был запрос что происходит с этим запросам ну хорошо если это как бы все правильно настроено а если нет то по сути у нас обрывается текущий запрос вот там один или может быть несколько но не оборвутся от момента ну то есть есть некоторым она когда мы потеряем этот вопрос что делать но очень просто кубрина из коробка имеет там стать сигналы чтобы сделать нормальный грэс-1 он большинство софта умеет делать нормальный грейсон down in жены к сумме делать нормально грызть showdown можно прописать тайм-аут fpm но тут же с во все можно сделать нормальный саша дал но это нужно обязательно сделать если вы это не сделаете вы будете терять запрос почему об этом вряд ли узнаете вы деплоить есь после этого жмете в 5 мы все работает деплоить и жмете в 5 но все работает а в это время у вас к не синхронизация сковать внешняя фишка которая сопит ошибками и что-нибудь там понятно что входящий бластер скорее всего запрос повторить другой под и понятно что на самом деле скорее всего ничего не будет в этом кейсе но если это post запрос который не и дым патентные да то он не будет повторять если это в любом случает увеличение лотность и какое-то и следующий момент остановили запускаем новый губернатор считает что он запустил под тогда когда он его запустил вот он запустился и все он не проверяет открыл этот порт стартанул лет если у вас спички fpm он стартует за 2 секунды а если у вас много г.с. а если у вас java которая стартует полторы минуты то туда будут вне запущенное приложение закрытым потом лететь запрос но опять там входной балансер как-то разрулить но в квадрате есть весь функционал для этого строя там есть райден из проба их нужно прописать и тогда у вас купюрница будет знать контейнер запущен или контейнер рейде и для комбинации это две разных вещи соответственно обязательно прописывать райден из проб третий момент мы все это сделали первых 2 и выяснили что все равно ничего не работает значит почему по разным причинам но для того чтобы проверить что вас выход без простой нужно тестировать это соответственно берете apache benchmark g метр все что угодно и хоть на главную страницу вашего там сайта или один метод и долбите с большой интенсивностью делайте тепло и смотрите 4 request a отвалилась почему ну и как бы разбираетесь потому что она скорее всего просто что-то там сделано не так где то есть нюанс что надо поправить и приходите к тому что все работает последний момент если у вас всего два кода означает что при тепло и на 2 нагрузка вырастет ровно два раза готов ли он к этому если у него достаточно там трейдов ресурсов на той тачки на которой находится и так далее так далее так далее если у вас подав 20-то ну как бы его перезапускать их по одному тона остальные загрузка увеличится там все на пять процентов если они скорее все это переживут но если вас подав 50 и вы их деплоить и по одному вы умрете ждать потому что у все равно как бы надо чтобы каждый соответственно нужно правильно обернется настроить баланс там скорости и ну запаса производительности так чтобы вы могли стекло это не в два часа ночи когда там луна не слишком полная а в любой момент времени в час пик от омар ность вы к то есть гид лап в git лобби есть разделся и сиди там есть in words и там сказано что у нас в продакшен данный момент вы кочина вот такая эта версия это наш губернатор в котором все наше приложение развернутые как надо и они сейчас какой-то версии той же что на продакшн у нас есть в том же гид лобби в pipeline а уже собранный и матч на ноль восемь пятнадцать мы нажимаем для него диплом работает там до апрелем отправляется все это в кубе рн и таз и что при этом происходит с кронами все просто достаточно поменять это описание и следующее по расписанию следует следующие под будут создаваться новым имиджем а дипломом ты все переходят вот в это транзитивной состоянии обновляюсь и допустим эти два обновились а этот застрял с ошибкой но не может там по каким-то причинам ошибка в коде застряла окей летит ошибка и в git лобби в pipeline ах написано ничего не выкатилась но простите vitlab уверен вот функционал ситигид лобо уверен что у нас вот в этом окружении в продакшн 07 14 не раз не так там не да вы катившийся точнее такой одной ногой по пытавшаяся выкатиться версия 08 15 понятно что там понятие от омар ность она совершенно не корректно для подписания этого процесса потому что не может быть ничего там arnova но но атомарная кавычках соответственно что нужно делать в этой ситуации очень просто когда прошла ошибка есть встроенная возможность сделать rollback патрубок нужно не забыть сделать и этот rollback скорее всего не нужно делать всегда нужно делать только на проводе потому что на дэви вы скорее все хотите посмотреть что же у вас там не выкатилась и разобраться динамическое окружение есть кубер на в котором настроен ingress контроллер тот самый входящий балансир туда у нас отправлен домен звездочка review экзампла комп люди держитесь 7 7 часть из 8 сейчас добьем значит есть гид в детей есть branch который называется фича x когда мы этот branch git push нули и с учетом того что у нас есть фильм чарт который нам позволяет с нуля bootstrap нуть все мы с большой радостью берем и делаем так что при пуше branch и у нас бах автоматом разворачивается в кудрин столице из этого бранча и туда за руль и вается домен названием space of купер на это си название домена соответствует названию бранча и наступает счастья создали еще один branch еще один namespace еще один branch еще один namespace удалили branch удалился namespace это вот прямо из коробки встроенный функционал где club если у вас есть чарты для фильма которая вот позволяют все это sbus тропа а пару нюансов как мапать понятно что есть один проект есть нормальное название branch этом ума по им один-в-один не у интерфейс так назвали домен так назвали нам спастись у вас branch и вот такие ну вы видели такие братьев детей я видел много я кстати не уверен насчет решетки но по-моему нормально окей значит в git лобби слава богу есть встроенный механизм называется slug семантический уровень он превращает can системно уникально вот в какой-то такой не очень же человеко читаемая хотя и не знаю левая часть была человеко читаемое или нет если у вас несколько проектов разумеется для маппинга вы используете название проекта плюс название бранча ну вот как-то так нюансы понятно что если вы будете раскатывать во все review жки полностью настроенное приложение там которое есть 16 гигов памяти 500 трейдов и так далее ничего не выйдет у вас очень быстро закончится деньги на инфраструктуру и ну и тебе сервера еще что то сделайте маленькие маленькие маленькие потому что ну вот эти дома branch и динамические окружения они они же разработчику посмотреть any single single user мод там вдвоем они там зайдут обязательно целиком в губернатор включая базу потому что вы тогда можете легко эту базу взять и удалить или создать новую ну то есть как бы папа является гибкость я не говоришь на попраде базу в интернет сейчас в 2017 году в ноябре 2017 го ставить но я говорю что сейчас надо для всего не про доставить базу в кубинец ваш текст с и права как это ограничит разработчиков фича очень классная сразу ход весь кластер cabernet занят review branch и не надо ставить лимиты там ними 510 ну в зависимости от вашего кейса на проект разработчик пытается выпуск него ошибка слишком много он весит вася чего тяжко 4 штуки разгоном тонкой твой извини . удалили выкатили то есть какие-то для этого придется там немножко костре наш или написать мне ничего страшного соответственно динамическими окружениями тепло и выглядит вот так есть кнопочка стоп а последний момент тесты если нам нужно проанализировать ход то мы просто на стадии тест выполняем binary это просто ну жанру сказали выполним вот эту команду если речь идет про юнит-тесты the workflow выглядит следующим образом из докер файла собрали докеры мач и это докер и матч простым докера нам гоняем unit-тест это что такое это тест который не использует внешних зависимостей соответственно там реек тест не знаю 1 peg в в rubber speck просто собрали и матч готовый в нем запустили тест если речь идет про функционально интеграционное тестирование выглядит следующим образом докер файл собрали положили в реджис 3 плюс у нас есть фильм чарт и на стадии тестом и хилимон столам создаем динамическое окружение в которой выкатывается вся наша инфраструктура нам со всеми всеми всеми всеми зависимостями плюс job в котором выполняется тест я не знаю там selenium гоняется или может быть не один 20 job of которое в параллель гоняют много разных тестов и когда это все успешно проходит мы делаем фильм делить ну вот мы вытаскиваем какие-то данные то многие какой то скрипт агрегации удаляемых namespace конец очень быстро значит итог вот эту часть функционала эта связка позволяет с легкостью покрыть мы сейчас в компании флант каждый день ну не каждый день каждую неделю по два проекта вот где-то вот в этой зоне делаем а в остальном у нас тоже есть опыт но прямо активно каждодневно в этой части приходите к нам на стенд мы расскажем покажем за бесплатно с большим удовольствием поделимся всем все знаем рассказываем расскажем о том о чем не знаем значит чем вообще мы занимаемся мы не просто внедряем вот такие штуки а мы занимаемся комплексным обслуживанием инфраструктуры включая и поддержку 24 на 7 и и мы даем гарантии не на время реакции она время ответа вашего проекта и ну неприлично называть цен на презентацию на средний чек по маленьким проектом 100000 большое спасибо за внимание подписывайтесь на youtube канал на котором есть три прошлых доклада на блог на хабре и плюс аните пожалуйста наши два проекта завтра будет презентация утилита который называется блок-хаус это сборщик логов для кубер наценок ли хаусе у нас на стенде и отдельно напишем в телеграм и slug"
}