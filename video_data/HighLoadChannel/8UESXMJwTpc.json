{
  "video_id": "8UESXMJwTpc",
  "channel": "HighLoadChannel",
  "title": "Golang: специфические вопросы производительности / Даниил Подольский, Кирилл Даншин",
  "views": 19673,
  "duration": 2027,
  "published": "2019-05-15T04:06:45-07:00",
  "text": "так коллеги добрый день меня зовут данил по-дружески читать я сегодня буду про специфический вопрос производительности боулинг немного докладчики ну вот я 26 лет стажа 20 из них сисадмином в эксплуатации ну и руководителем группы эксплуатации из оставшихся 6 4 программирую нога она включая 2018 год кирилл даньшина вот лично он тут присутствовать не может потому что спросите у него сами но вот можете посмотреть на его изображение это создатель grain work это моим тейнер один из фаз 1000 т.п. это черный гамак о чем я маг о чем я скажу позже в самом конце и если он продолжит не выезжать из своего минска еще пару лет как он делает это последние пять то мы начнем вызывать минским отшельником значит обратите внимание кирилл попросил обратить ваше внимание вот на эту надпись вот это его контакта презентация понятное дело будет доступно все вопросы по поводу последней части доклада надо будет адресовать ему потому что это он черный маг аней аят как раз наоборот с ним в этом смысле в конфликте но будем надеяться что рака доклад при этом родился у нас хороший так о чем доклад 4 года четыре года я программирую на go за это время я увидел довольно много странного и кое-что из этого было интересным я это все на бумажку выписывал и когда-нибудь хотел такой доклад прочесть конечно тасс идея которая у меня родилась для этого доклада занимает в этом докладе процентов 10 теперь но тем ни менее откровений не будет ну потому что от куда уж откровения в таком простом языке как бы но и того что пишут в газетах например того что штатный джейсон марш allure медленной вот этого я тоже говорить не буду а список не полон отражает исключительно жизненный опыт авторов но тем ни менее это интересно начнём мы с языковых конструкций что у нас есть некий эталон производительности до некая функция которая инкрементировать некоторую переменную больше не делает ничего вот это минимальный так сказать то есть быстрее быть нельзя полторы на на секунды на операцию вот языковая конструкция de fer все про него знают да и очень мы его любим использовать довольно часто мы об так довольно часто мы его используем вот так типа зефир жида можно можно и так нельзя посмотрите каждый диффер съедает 40 наносекунд я было подумал что может быть это из-за онлайна что типа enlight а вот в минимальная функция у меня онлайне цао de fer функционер онлайн лица не может поэтому я скомпилировать дельную функцию из головы новый онлайн ничего не изменилось все те же 40 наносекунду занимает de fer но тридцать восемь с половиной вот что это означает это означает что там где ваша функция занимает меньше 100 наносекунд хорошо бы обойтись без di ferro это важно но там где ваша функция занимает больше микросекунды уже наплевать можно и de fer использовать так пора ли вот для начала сразу после диффе разберем с популярными мифами передача параметра по ссылке а ничего не стоит ничего не изменилось то есть кое-что изменилось но это флуктуации вот эти вот три на на секунды над эфире я видела здесь очень большой разброс так анонимные функции иногда новички спрашивают а вроде анонимная функция это дорого ничего не изменилось анонимная функция недорогая интерфейсы ну вот смотрите есть три варианта использовать то есть вернее так вот у меня есть такой интерфейс у меня есть вот такая структура которой его реализует есть три варианта использовать этот самый in crime это метод инкремент напрямую от struct от соответствующие в этой интерфейса конкретного и с онлайн конверсии runtime конверсии интерфейса ну вот собственно вот вот она runtime конверсия интерфейса вот оно прямое использование что мы видим к интерфейс как таковой не стоит ничего а вот runtime конверсия интерфейса да да стоит не то чтобы дорого то есть так вот специально от этого отказываться не надо но надо помнить что везде где вы можете обойтись без runtime конверсии интерфейса надо без нее обойтись есть черная магия на этом месте который еще чуть-чуть быстрее черные маги связанная солнцев чем прямая вот этой конструкция конверсии интерфейса но я его мы и не советую использовать для ускорения потому что она очень уродливая так ну что собственно первая часть деревьев разыменования указателя бесплатно анонимные функции бесплатный интерфейс как таковые бесплатно runtime конверсии интерфейса не бесплатно очень частый вопрос вот прям каждый каждый новый человек в группе в телеграме спрашивает а что будет если я заменю switch нам f не станет ли быстрее ну да надо разобраться свечи бывает разное они бывают разного размера я тестировал на трех размерах у меня есть маленький switch на 10 кейсов у меня есть средний свечи на 100 кейсов меня есть большой switch на 1000 кейсов как ни странно свечи на тысячу кейсов встречаются в реальном продакшин коде конечно никто руками их не пишет это of the genre он эй кот обычно это type switch вот ну и я тестировал на двух типах на in the хана стрингах потому что мне показалось что это наиболее показательные варианты значит что мы видим значит маленький switch самый быстрый вариант который мы видим это собственно switch вслед за ним сразу слайс где по соответствующему энтому индексу лежит функция которую надо позвать ну сукна функцию значит мы не рулит не на винтах не на строков вот хотя нас вечно стрингах существенно медленнее чем свечной in the кстати это важно а если у вас есть возможности сделать switch не нас не на стрингах она энтов то сделайте его это может помочь для среднего свеча посмотрите на янтарь все еще рулит собственно switch но слайс его обогнал немножко map все еще от в отстое но посмотрите на стрелковом ключа у нас map сделался быстрее чем switch ну ожидаемо да и наконец на свече на тысячу кейсов мы видим безоговорочную победу мипо в номинации свечи по ст рингом и безоговорочную же победу ну вот нельзя сказать что нет ни безоговорочную то есть теоретически победил слайс но практически конечно я вам советую здесь использовать все тот же switch вот потому мы не катит все еще медленный это несмотря на то что умер для in the вых ключей есть специальная миха специальная функция хеширования которое собственно ничего не делает в качестве хэша для in the выступает сам этот винт так мы пролит только на больших количествах не на целочисленном условие я уверен что на любом из условий кроме целочисленного он будет вестись от h как нас трендовым ну и слайс слайс если вам очень хочется ускорить свою программу на 2 наносекунды то вы можете использовать можете использовать слайс между рутинное взаимодействие значит с тем сложная и тестов я провел много покажу вам только наиболее показательной из них значит какие мы знаем средства между рутинного взаимодействия мы знаем о томики ограниченного ограниченной применимости средства можно заменить указатель можно int использовать вот мы знаем you такси и используемых широко помнил все со времен явы мы знаем каналы которые фактически уникальны для нашего языка и мы знаем буфере зова ные каналы я тестировал на опять же трех вариантах на самом деле тестировал ясно существенно большем количестве вариантов но показательными я выбрал вот эти три для себя на 100 га рутинных которые конкурируют за один ресурс на 1000 и на 10 тысячах и профиль нагрузки тоже тоже бывает разному ну бывает бывает когда все грудь и на хотят писать в одну переменную но это вообще-то редкость обычно все-таки какие-то пишут какие-то читают давайте посмотрим что у нас там значит это код который используется для того чтобы канал мог обеспечить одновременно но техника налога рутина которая обслуживает канал диспетчер могла обеспечивать одновременно и чтение из переменной запись в нее ну собственно если к нам приезжает сообщение по каналу через который мы пишем мы собственно делаем вот эту если канал закрылась за к закрылся мы грунте ну завершаем и если в любой момент если кто-то готов читать мы готовы вписать в канал которые используются другими грузинами для чтения ну давайте посмотрим это на 1 га рутине ну понятно что канальный а вот канальный тест на 2 грудь и на фф1 обрабатывает канал другая в этот канал пишет а вот эти три варианта были протестированы на 1 грудь и некоторая вот директ просто пишет в переменную мьютекс берет лог пишет в переменную отпускает лоб и atomic пишет в переменную через atomic ну понятно что atomic не бесплатный но в утки существенно дешевле мьютекс а на 1 га рутине ох не знаю видно ли из задних рядов скорее всего нет поэтому мне придется как-то прочесть этот экран вслух значит что мы видим на малом количестве грудь in значит у нас наиболее эффективный способ синхронизации это все тот же а томик неудивительно дерек то тут нет понятное дело потому что нам все-таки нужна синхронизация которая дерек не обеспечивает поэтому а вот о томик наиболее быстрый но мы помним да что у него есть недостатки следующий мьютекс я честно говоря ожидал что канал будет примерно таким же быстрым как мьютекс ну потому что а чё бы ему быть медленнее но нет смотрите канал на порядок дороже чем мьютекс причем смотрите у нас есть канал у нас есть буфере зова ный канал они примерно в одну цену а есть канал который у которого буфер никогда не переполняется и посмотрите канал да что ж такое-то значит канал буфер у которого никогда не переполняется на порядок дешевле чем канал у которого буфер переполняется неважно вот этот вот вот эти два канала это буфере зова ные каналы но ни один из них не буфере зова ный а другой буфере зова най но они в одну цену и только есть ли буфер в нашем канале не переполняется наш канал оказывается стоит столько же примерно столько же дороже но по порядку величины равно сколько мьютекс вот да это то чего я ожидал вот от всего от этого значит этот эта картина с распределением того как что сколько стоит повторяется на любом профили нагрузки и на мозг верит и на масле right почему это так я вам сказать не могу я не успел изучить этот вопрос но даже если у нас есть мозг верит у нас в общем в общем и целом уравниваются вот так нет подождите не глупости говорю хотел сказать вам совсем не об этом значит смотрите вот у нас есть мозг le райд это у нас а томик вот мост мириться полный канал стоит столько же сколько и неполной и мозг лирой так по канала буфере званый канал в котором буфер не переполняется стоит столько же сколько и остальные каналы почему так я сказать не могу следующая тема эта тема передачи параметров вот поднимите пожалуйста руки тех кто думает что параметры надо передавать по ссылке потому что так быстрее поднимись положил столу руки те кто думает что параметры надо передавать по значению потому что так быстрее ну давайте проверим значит каким образом я это проверял я наделал вот таких типов вложенных типов я их надела от 1 до 10 ну понятно да что в десятом и полей и int64 у меня так нет подождите у меня же да вот и полей n64 у меня там 10 и вложенных типов предыдущий вложенности тоже 10 вот такие я написал функции которые создают мне тип вот от этой самой вложенности и померил значит я использовал три варианта типа я использовала маленький с влажностью 2 это смол я использовал медиум с вложенность you try это и я использовал lace сложностью 5 я хотел было использовать lace сложностью 10 но не смог дождаться конца теста поэтому использовала вот такие но на том тесте который я оставил на ночь который действительно закончился картина точно такая вот в этих функциях передача по значению минимум вдвое быстрее чем передач по ссылке вот так связано это с тем что передача по значению не напрягает escape анализ и соответственно наши переменные которые мы выделяем оказываются на стыке они в хиппи и это существенно дешевле для runtime а для горбач коллектора хотя я не уверен что горбач коллектор успел подключиться тут это тесты которые шли несколько секунд горбач коллектор наверно все еще спал на этом месте вот помните это и наконец что-то я очень быстро читаю свой доклад много останется времени на вопросы значит наконец раздел про черную магию вот те кто видят код на экране поднимите пожалуйста руки тем кто уверен что знает что выведет эта программа вот тогда хорошо ну как минимум одну руку я вижу теперь пожалуйста те кто думает что программа выдерет выделят 1 выведет один опустите пожалуйста руки так хорошо а те кому все ясно с этой программой не нужны никакие дополнительные вопросы опустите пожалуйста руки значит то что вы ведет эта программа зависит от того на какой архитектуре она исполняется на little endian например amd64 эта программа выводит 22 в 32 она бега indian которых я не помню уже давно ни одного эта программа выводит единицу ну потому что дано летала индиана это единица оказывается в середине числа она бега indian эта единица оказывается в конце числа важно важно что на свете существуют все еще процессора у которых indian с переключается например power pc то есть если вы когда-нибудь напишите кошечкой код который на каком-нибудь аяксе на каком-нибудь ай-би-эм of scam много- процессор нам сервере станет исполняться скорее всего прежде чем делать какие-то умозаключения насчет того что делает такого сделают такого рода ansa и фокуса вот скорее всего вам придется выяснить прежде прежде всего что за india's сейчас сконфигурирован на вашем компьютере он это происходит во время старта так что зачем я это показываю вам этот эту картинку для того чтобы объяснить почему я считаю весь он сейф черной магии с моей точки зрения пользоваться этим не надо а с точки зрения кирилла надо и мы сейчас объясним почему значит есть некая функция которая делает то же самое что и гоп энкодер поднимите пожалуйста руки те кто помнит кто такой год вот это да вот это да значит такого гоп это глубина ремар шаллер вот вот эта функция делает тоже самое но на аннсофи фактически она берет кусок памяти изображает нам из него массив байт что мы видим а это даже не порядок это два порядка на вот поэтому человек по имени кирилл даньшин когда пишет высокопроизводительный а он очень много пишет всего высокопроизводительного вот он не стесняется залезть в кишки свои своей программе и устроить ей once и так я действительно слишком быстро прочел свой доклад я уложился в 30 минут это плохо но тем не менее давайте вопросы 111 да меня аллергией делались и тесты при увеличении количества ядер и количество сокетов а я да понимаю этот вопрос очень хорошо нет мне не удалось наложить лапу ни на один компьютер с количеством сокетов больше одного я думаю что тут бы а то микки у меня сильно огорчили но у них не получилось извините понятно да и из тех кто у нас еще умеет разные энди нас это микс ими и в парке ну да вот да и инсеев это хорошо если пользоваться этим аккуратно потому что иначе но не знаю если например мы хотим работать с масляной памятью то у нас единственный путь и танцев если нам нужен em up а это в пользу какого тезис аргумент пользоваться их если нам нужна скорость у нас нет вариантов как кроме как broken so if pointer заниматься type кастингом и заниматься черной магии значит вот мне бы хотелось на этом месте чтобы имела яблок хотела бы что в моей жизни никогда не было ситуации когда мне нужна скорость мне кажется что просто докинуть я der немножко проще на порядок на порядок что ну вот как бы пример сериализации да окей два порядка 100 раз больше машин нормально вот вконтактик бьется за то чтобы у них там в два раза не возросло количество машин а тут как бы два платка да ничего возразить к сожалению то есть я вот хотел вот я я хотел сделать так чтобы черная магия выглядела чем-то очень плохим да мне как тимлид у читать код который в котором есть on сейфа очень неприятно но нет ничего не попишешь два порядка спасибо за доклад не видно у меня вот такой вопрос почему бенчмарках производительность на свойствах деградировала но вот между в общем бенчмарками заметил что при большем количестве элементов слайсер производительность падает в такого не должно быть почему разве она падает давайте пасовать и посмотрим может быть я ошибся да значит да вот это вот значит что мы видим слайс в 3 на на секунду укладывается на медиуме в 3 на на секунду укладывается до малач знаете я думаю что он перестал ся помещаться у меня в кэш вместе со всем остальным я думаю что там сброс кэша произошел в смысле вообще или может внушить нет свободы со свапом я следил не было там никакого свапа а вот но видите во первых там на этом компьютере что-то еще происходило а вот может быть это вызвало инвалида цию к шоу вот аян валидация каша да это вот так будет выглядеть так отпрыгнет так я просто подобный теста проводил и вот короче не деградирует ничего абсолютно там будет 2 3 на на секунды также как во всех ну так должно быть да за чего бы по-другому спасибо извиняюсь что ясно я здесь прямо до я снова перехватил микрофон да я забыл спросить еще на каких артизи турах постилась x86 x64 и все на самом деле этому есть объяснение я был готов к этому вопросу дело в том что нет никаких больше архитектур для того чтобы наложить свою лапу на какой-нибудь более экзотический процессор надо поступить работать в какую-нибудь более экзотическую контору чем обычно интернет стартап и что мы там гоняем кошечку до vr guard башней реализации vr guarda vpn который в ближайшее время включить link сейчас работает через горную модуль ну смотрите мне интересно то что происходит на мобилках да вот вот именно этот тест было бы очень интересно провести на мобилки но я не умею разрабатывать для мобилки я просто не справился бы сам аид и даже двух точек состыковать для доклада было очень трудно вы видели презентацию я доделывал тут прямо вот потому что нас трудно было состыковать спасибо большое за доклад а такой вопрос а вы тестировали reflection и насчет рефлекс она просто была бы очень смотрите это же вот она и есть вот это тоже один из видов рефлексии соответствует вот эта вот этому определяется с помощью reflect вариант не я скорее про то когда мы например на поля какого-нибудь структур ки смотрим через reflect и потому что это очень сильно вещь просто с виду они работают довольно медленно вот по моим каким-то тестам но при этом казалось бы они должны летать вообще потому что ну казалось бы голод во время кампала должен был знать вообще какие там поля и как-нибудь их статический я так понимаю что reflection и комбайнер никак не помогает рефлексии вот у меня тоже такое впечатление создалось из-за так это очень печально знаете да я это я могу я просто в голову не пришло это тестить потому что я одну видимо потому что я знал что рефлексия медленная и был уверен что вы тоже об этом знаете эфир мало кто знает а про рефлексию все здравствуйте спасибо за доклад хотел бы попросить вас переключить на слайде кс по ссылочке и по значению там такой показательный был очень не нет там по моему да да да вот вот было бы классно здесь увидеть использование памяти я еще бы то есть не было ли оно там в два раза больше к примеру ну когда мы передавали по посылочке по значению ну смотрите после доклада можно толкнуть этот тест на моем ноуте с соответствующим параметрам меня они меня это честно не интересовало но можно посмотреть да по той под колеса вот интересно поведется потом еще garbage collector ну то есть ну то есть полностью dos провести знаете я гонял этот тест ночами горбач коллектор явно ночью что-то делал не может так долго и еще было бы интересно очень посмотреть ну там как я понимаю там структуре с винтами в принципе использовались и с другими структурами которые там аналогичны было бы интересно посмотреть еще на тест который генерит амбой terra и или бабы необъятная объять нельзя но и там вот я выложил этот самый код вот жду по ур и квестов я понял просто не будет ли он сильно медленнее так как как я понимаю байкеры imap и выделяются уже не в мире о них я забыл не с таким не встать и да значит направьте откуда собственно взялся этот доклад и вот этот пункт докладе я описал нечто что разбирала бинарный протокол который прилетал мне от си плюс плюс снова модуля оси плюс ники они очень любят просто взять указателя на свою структуру сказать что это байкеры размером сайтов и вот это выпихнуть в сеть не никакие другие программисты по-моему так не делают источники так делают и мне надо было на кошечки это принять разобрать и сформировать структура принятие разобрать там были строки там были байты там были айпи адреса в виде четырех байт ну все что хотите на вот и понятное дело читаю в связи с тем что они еще про гм упак используют я это просто в памяти положить не мог то я его с помощью бояре рид читал но после этого я должен был сформировать эти структуры в памяти и вот там я выяснил вот тогда оказалось что по ссылке медленнее чем по значению довольно спасибо так еще вопросы спасибо за доклад я пока я сам ещё на голом много не пишу это как академические иногда там теста писал и вот я как-то организовывал т.с. вычисление фибоначчи через вложением адрес там где-то я вычитал там такой способ и соответственно и написал на яве и тестер через думаешь и потом писал на голые хотел так скажем к близится к джаве соответственно я пока писал на голову погас оптимизировал первоначальный вариант был простой там все по значению вычислялось и возвращалась и потом используя разные там комбинации ну думает что дева выделяется там же когда просто гоняет спишется что-то сколько аллокации в итоге я сделал передачу моментов через ссылку и ведь там нет никаких аллокации небу и самый быстрый способ в итоге соответственно получается что по ссылке то получается иногда выгоднее передавать чем если нет аллокаций да и если не это локации туда единственное почему по значению выгоднее это потому что аллокация происходит не в хеппи авс таки больше никаких причин этому нет так еще вопросы хорошо коллеги спасибо"
}