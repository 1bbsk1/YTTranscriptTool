{
  "video_id": "0sLlhmB1IkI",
  "channel": "HighLoadChannel",
  "title": "«Mattermost» на стероидах: как мы запустили и развиваем мессенджер / Евгений Кульгин, Юрий Власов",
  "views": 1148,
  "duration": 1878,
  "published": "2024-10-29T03:08:36-07:00",
  "text": "я приглашаю на эту сцену Женю кульна и Юру Власова ребята расскажут нам про Мар мост на стероидах Всем привет поделимся своим опытом как мы развивали как Мы работали собственно немножко я руководитель компании компании коллега Евгений немножко о самой компании компания сдек - это уже не просто логистическая компания а больше всё-таки it потому что мы продаём именно уже по наше и прочее каждая четвёртая посылка доставляется компании сдек по России вот у нас 950 релизов большая количество активных пользователей и 14 дней у нас уходит на разработку немножко о структуре нашего доклада мы поговорим Почему мы выбрали мотер мост Какие изменения какие мы словили проблемы с ним вот Какие плагины сделали и куда мы планируем двигаться дальше а цитата наша которые мы используем прислушиваемся смотрим и уже решаем сами внедрять или нет о чём мы не будем говорить мы не будем рассказывать как устанавливать пересказывать всякие инструкции и стоковые решения которых Вы можете по чить собственно зачем нам Понадобился Когда у нас было куча других мессенджеров нашей компании у нас был WhatsApp им пользовались часть команд часть групп вот у нас там была информация кто когда приходит в офис следующий у нас был Telegram туда у нас приходили алерты там флудилка была резервный чат на случай сбоев у на также бы сла платной версии самым главным минусом не было контроля над приложением это всего 10.000 сообщений в истории хранилось и не было возможности загонять туда сотрудников как-то целенаправленно собственно был Skype Мы его использовали для видеозвонков на тот момент всё устраивало и у нас там общался весь наш почти бизнес мы для своей команды решили сделать мормо буквально это было для небольшой группы людей больше для технических специалистов потом мы всё это сделали всем понравилось презентовали и вся компания стала заходить туда вот чтобы он стал более стабильно работать мы его переименовали в Дек ток а перенесли все чаты в одно место и в принципе сейчас продолжается интеграция у нас весь бизнес уходит в него Поговорим немного про установки какие у нас были то есть когда мы это только запускали это вот первая версия наша Это был собственно один сервер в куда мы всё запихали там же лежала база данных база данных для авторизации она у нас была через gitlab сделана чтобы спом подружить минусы всё в одном месте собственно если сервер падал падало всё вот очень быстро кончалось место потому что все скидывали картинки какие-то и просто улетала это на глазах плюс индекс Bel который там есть тоже очень много места убирал наша следующая интеграция Мы решили посмотреть как же всё-таки решить наши боли сделали два сервера В бесплатной версии невозможно сделать что они оба являются мастерами поэтому мы сделали ма сй через Пилат разделили и собственно две базы с постгрес сом минусы Собственно как я и сказал что нельзя сделать Мастер Мастер и возникла проблема с драйвером для S3 хранилища по умолчанию там отсутствовал полноценный драйвер для работы и нам пришлось и3 хранилища под монтировать просто как папку Чтобы два сервера могли между собой синхронизироваться плюсы Появилась возможность быстренько тестирование делать если падал один сервер мы прямо проверяли ни одно сообщение не теряется то есть небольшой лак происходит но именно потери никакой нету И нет необходимости править на каждом сервере конфиг А теперь поговорим о том как бы Какие стероиды мы стали подмешивать чтобы вырастить из стандартной системы вот нашего такого монстра первоначально так люди заходить их стали заходить из разных других мессенджеров и мы стали получать обратную связь что не хватает либо того функционала либо другого и из этого мы сделали такой небольшой топ как бы нужны функции которые необходимо нам было бы самостоятельно внедрить самым наверное популярным это стала информация о доставки и о прочтении сообщений в платной версии данный функционал он реализован но он реализован очень неудобно для того чтобы сделать запрос нужно сделать массу действий протыкать именно руками вот мы посмотрели поняли что это не совсем удобно и реализовали как бы свою функцию на основе всеми привычных галочек это серые галочки о том что сообщение просто доставлено и галочки окрашиваются в синий цвет о том что сообщение прочитано как бы сделано это на основе плагина который интегрируется на любой версии мотор моста но есть такой скажем один минус о том что нельзя уже сказать что я не увидел этого сообщения То есть система автоматически отметит того что оно было доставлено и прочитано дальше позднее расскажет Почему возникла необходимость мы реализовали функцию закрытости каналов то есть о том чтобы не все люди могли писать в каналы в платной версии реализовано опять же но оно реализовано не совсем удобно то есть опять надо сделать много действий зайти в какую-то консоль выбрать какой-то параметр в нашей же интерпретации это выглядит Вот вы можете видеть на слайде это просто три точки которые появляются в шапке канала и вы можете уже выбирать Как именно вы хотите ограничить пользователей то есть либо все могут писать либо м либо все могут писать в канал либо все могут только читать сообщения При этом писать может только администратор канала либо можно разрешить общаться именно в треда под сообщения дальше это м бот Тая скорее всего это бот таких как бы рассылок в личные сообщения Он является как бы интеграцией между самим мотер мостом и какими-то другими сервисами 1S с внутренним порталом и массой других то есть вот вы можете видеть о том что в данном случае Тая Например Она оповещает что скоро будет день рождения у пользователя причём оповещает она именно всю команду Где работает пользователь за исключением самого пользователя также Тая оповещает Например если у нас есть программа Приведи друга Если вы кого-то рекомендуете вы автоматически подписываетесь на все изменения и можете наблюдать На каком этапе ваш коллега например проходит трудоустройство в компанию также Тая напомнит об отпуске когда пользователь делает когда пользователь как бы самостоятельно выбирает в календаре в дни которые он пойдёт в отпуск Ему больше не нужно об этом помнить Тая сама ему напомнят за 2 недели и также сделает напоминание руководителю о том что ему необходимо подготовить замену для данного сотрудника пока он будет в отпуске и необходимо будет обратиться там в отдел кадров для подписания каких-то документов также не все то есть есть каналы для общих сообщений То есть например туда подписано 10 000 сотрудников но есть сотрудники которые просто МТТ такие каналы и соответственно они могут пропускать какие-то важные сообщения вот в этом случае та она сделает рассылку таких важных сообщений по по личным сообщениям пользователей и при этом о это можно сделать как бы частично не сразу всем пользователям отправлять а скажем по тысяче сообщений в час а дальше это не совсем наш функционал который мы разработали но мы его смогли использовать это разработка мотор моста То есть у них есть встроенные скрытые сообщения они реализованы как пуш-уведомления от мобильных как пуш как пуш сообщения на мобильных телефонах вот если например вы такое сообщение получаете обновляется страницу оно пропадает данный функционал мы использовали для получения двухфакторной авторизации то есть пользователи набирают команду получают ко код и соответственно после обновления этот код Никто не знает таким способом мы смогли м сделать ряд функций во-первых Мы ушли от единой учётки которую пользователи между собой там разработчики передавали и соответственно теперь у нас это делает бот Он у него есть своя встроена учётная запись которая получает данные из базы из базы и отправляет их скрытым текстом это очень просто пользоваться потому что достаточно вести только одну команду увеличилась скорость не нужно получать никаких согласований То есть если пользователь вводит команду в логах уже будет кто сделал какой запрос соответственно это всё уже просто отслеживается и соответственно произошла экономия на SMS оповещения Ой не туда есть ещё много ботов например бот кто дежурный если в канале задать данный вопрос то тут же высвечивается сообщение к кому можно обратиться напрямую Этот человек всегда непосредственно находится с ноутбуком и он всегда готов Прийти на помощь бот проблем Например если случается какой-то инцидент в компании и заводится Задача в жире бот смотрит что появилась как бы новая задача он автоматически формирует канал в мотор мосте подключает туда необходимых людей формирует созвон и когда человек подключается он уже видит с кем ему предстоит работать И краткую информацию по проблеме То есть ему необходимо просто за Димо просто зайти то есть у него уже всё есть перед глазами так и последний бот - это сборы на день рождение То есть когда нужно скинуться всем вместе но чтобы сам сотрудник об этом не знал что ему скидываются такой тоже У нас есть далее одним из самых запросов пользователя это было видеоконференции то есть масте на самом деле у него нет такой функции у них есть аудио звонки но видеоконференций нет в matmos написано несколько плагинов для интеграции существующих сервисов таких как G Zoom Google Meet но у всех них есть какие-либо ограничения которые нам не подходили поэтому наш выбор Пал на бесплатные решение такое как Life Kit почему оно было выбрано потому что оно также написано на языке Go оно Легко устанавливается работает фактически из коробки и у него большой Итернет коммьюнити где очень быстро приходят на самом деле на помощь первую инсталляцию мы сделали в Докера действительно там было далее далее Далее готово мы запустили отправили в плавание но получилось что буквально на созвоне в 15 человек вдруг докер стал падать логов К сожалению мы не нашли то есть информация в контейнере она отсутствовала разработчики лай кита помимо того что они сделали такое решение как сам видеосервис видеосервер они ещё сделали для него нагрузочный Удели для для проведения нагрузочного тестирования вот на первой картинке Вы можете видеть сервер параметры сервера и параметры нагрузочного тестирования которые запускали сами разработчики Мы же взяли сервер в два раза слабее и соответственно запустили в два раза меньше нагрузку и вот что мы получили если у самих разработчиков у них ноль ошибок вышло В нашем же случае получилось что у нас 179 человек просто не смогли подключиться к видеоконференции мы стали смотреть почему это происходит и обнаружили что когда люди подключаются они имеют процессор находится под большой нагрузкой почти в 100% всегда стали разбираться почему это происходит и обнаружили что в одной из версий разработчики просто один параметр из бинарного кода они выбросили мы запустили сервер с данным параметром и вот вы видите на графике что мы получили причём этот график - это уже нагрузка на нашем сервере который в два раза слаб но нагрузка производится тем параметрам которые использовали сами разработчики то есть нагрузка не превышает 60% И следующий параметр - это так как видеозвонки работают у нас Остаётся только добавить видеозапись сами разработчики они уже также его сделали это сервис рес в принципе он устанавливается также То есть если вы пойдёте пройдёте по QR коду там будет ссылочка Это буквально там четыре строчки о том что нужно сделать это далее Далее готово и действительно у нас всё работает вот немного про наши факапы как у нас какие были проблемы самая большая проблема которая на это была очень большая утечка памяти причём память просто утека просто так и ночью когда Никто особо не пользуется днём ещё больше она просто текла Мы создали Запрос к официальным разработчикам мор моста тоже можно пройти по ссылочки посмотреть собственно какие были выявлены причины утечки основное это было S3 то что у нас не было драйвера полноценного и индекс Bel очень большой ну и плюс ещё был ряд самописный плагинов они тоже делали утечку по мы всё поправили разобрались всё-таки нашли драйвер поставили его для работы С3 у нас всё нормализовалось и утечки не стало факапы по самому киту тоже мы с ним столкнулись собственно Kit не поддерживает kdb То есть те кто пользуется KB прид рано вер к редис вот была очень большая проблема когда у нас в редисе была ссылка на нулевой элемент массива тоже был сбой Ну собственно если использовать версию редиса 1.4 то там всё хорошо работает и всё есть в один прекрасный момент мы обратились что у нас перестали делаться индексация встроенного индекса Bel рекомендовано в принципе всего 2 млн у нас порядка 20 это выглядело таким образом что идёт индексация доходит до 80% И падает честно говоря потратили очень много времени наверное недели три мы искали разные проблемы где это могло быть собственно была проблема Это в PG баунс в посло При таком большом объёме он собственно падал и закрывал конект безопасность Э мы решили добавить э у нас была http протокол когда Мы перешли на https э собственно у нас перестало всё работать нашли вот такую строчечку и проблема тоже была решена а самым большим фака пом - это если знаете у мотор моста есть основной канал куда добавляются все сотрудники из него выйти невозможно то есть по умолчанию всё есть и в один из прекрасных дней Когда у нас там уже достаточно пользователей было один из сотрудников написал с тегом свой вопросик и всем в почту полетели что задали вопрос в почту упало порядка 10я писем при этом люди решили помочь человеку и ответили на него и прилетело ещё столько же в общем пока мы разбирали что сло ложи написали плагин который делает канал только для чтения чтобы туда никто лишний Больше такого не писал А собственно что будет дальше дальше Э понятно что аппетит приходит во время еды и соответственно мы не собираемся останавливаться на том что мы уже достигли и продолжаем работать Дальше например из Бота Тай Мы хотим сделать фактически полноценного такого скажем секретаря который бы делал все действия за сотрудника То есть если сейчас он просто оповещает о том что необходимо уйти в отпуск то в данном случае например будет То есть можно будет за задать вопрос в свободной форме абсолютно то есть такой небольшой как бы искусственный интеллект можно будет написать там хочу справку 2НДФЛ То есть тебе это всё придёт и плюс мы ещё хотим сделать интеграцию с ЦП чтобы например тоже самое подписание заявления оно автоматически отправлялось в отдел кадров уже с подписью сотрудника дальше мы все привыкли пользоваться календарём и действительно то есть мы постоянно планируем свою жизнь это стало незаменимым таким инструментов но мормо он имеет интеграцию только с Office 365 и в зависимость точнее Если обратить как бы внимание на то что сейчас происходит в мире нам постоянно закрывают доступы то к одному продукту то к другому и не хотелось бы чтобы в какой-то момент нам закрыли доступ ещё и к нашим календарям поэтому на данный момент мы пытаемся написать интеграцию с локаль р на основе далее как Юрий уже рассказывал у нас были проблемы с индексом Bel поэтому мы протестировали есть возможность мармо протестировать весь функционал платной версии мы протестировали эластик действительно всё работы для наших потребностей это подходит И сейчас мы находимся на бета тестировании плагина именно для использования при индексации сервиса вот у мотор моста В бесплатной версии доступен только один сервер отправки пуш уведомлений и соответственно весь мир им пользуется находится он где-то по-моему в Северной Америке если мне память не изменяет И это не всегда удобно то есть они не несут ответственности за стабильность его работы на сайте мотор моста есть довольно-таки подробная инструкция о том как поднять свой сервис и как его использовать вот на данный момент мы уже даже сделали первоначальные работы в данном направлении у нас поднят свой сервис мы тестировали его действительно сообщения отправляются теперь нам необходимо просто пересобрать мобильного клиента и но мы хотим сразу туда внедрить ещё и ряд новых доработок поэтому это тоже в таком как бы процессе усовершенствования находится во время работы с мотер мостом нам также пришлось оптимизировать свою работу Так как постоянно выполнение каких-то определённых действий оно становится неудобным и мы понимаем что мы можем переложить на машину то что мы делаем руками например мы использовали скрипт по чистке файлового хранилища когда люди стали м вложений стало в сообщениях очень много вот необходимо было старые удалять а также мы писали скрипт по проверке доступности новой версии если сейчас уже стабильно выходит там одна мажорная версия в месяц то раньше это был рандомное время и постоянно заходить на сайт было неудобно у нас был скрипт который самостоятельно делал это раз в сутки и отправлял уведомление Нам же обратно в канал о том что есть новая версия Пожалуйста можете обновиться мы написали скрипт по очистке от старых каналов логика там довольно-таки простая если в канал не пишутся сообщения больше заданного количества дней где администратор сам это выставляет то скрипт просто архивируемых пор Это скрипт по обновлению матер моста это то есть на сайте есть Да действительно простая инструкция это последовательность действий но она довольно-таки длинная мы это взяли просто записали и всё в Единый скрипт и если раньше у нас но скрипт мы сделали как бы на основе наших инсталляций Поэтому если раньше у нас обновление занимало скажем 30 минут Сейчас обновление сервиса у нас занимает буквально 3 минуты причём это делает сам сервер без участие человека человеку достаточно просто запустить данное обновление далее как мы заявляли Мы готовы предоставить модули на над которыми Мы работали Единственное что мы не успели сделать какую-то страницу презентации где это можно будет скачать прямо вот прямо сейчас а по QR коду Вы можете попасть в Telegram канал Где в ближайшее время Мы выложим уже готовый а готовые модули Единственное что без без самих исходников То есть Вам достаточно их будет загрузить Как это сделано там в прило в магазине самого мотер моста То есть вы просто загрузите если это действительно будет пользоваться успехом мы увидим что Да Есть востребованность Есть вероятность что мы полностью сделаем какой-то не знаю ветку Гита откроем чтобы Вы самостоятельно могли там пушить и вносить изменения что хотелось бы подвести в заключение это то что В бесплатной версии можно сделать отказоустойчивость хотя заявлено что это можно сделать только якобы В платной версии не бойтесь экспериментировать как в нашем случае мы экспериментировали с с различными видами инсталляции то есть мы проходили понимали что нам это не подходит пробовали другой вариант делитесь наработками своими Ну по нашим Да как бы варианту что мы модули готовы предоставить и не гонитесь ну здесь Наверно не за трендами не Старайтесь гнаться За всеми обновлениями которые предлагает тот же самый мотер мост Сейчас кратенько объясню Почему начиная с седьмой версии они под капотом выпустили у себя какой-то функционал который основан на ихней внутренней разработке искусственного интеллекта и как только люди обновились на утро У них на форуме посыпались гневные сообщения что у вас произошло у нас там процы в сотку почти все скану это долго думали и вот получается Сколько у них полтора года они выливали это всё обратно и вот только в девятой версии месяц назад Они полностью избавились даже от кодовой Базы и вторая такая интересная была особенность это СТ помимо того что он сам как бы обновляется он ещё использует различные сервисы в нашем случае это использование базы данных на основе постгрес в инструкции у них указано что они не используют девятый постс но можно использовать любую версию старшей девятой но нигде не указано например что при использовании матер моста если вы меняете дефолт ную локаль с английского например на русский язык у вас половина индексов который создаёт сама термо она не будет использована то есть у вас все запросы пойдут в обход индекса в саму базу что создаёт обратно свою Ну как бы увеличенную нагрузку поэтому не гонитесь чтобы всё подряд быстро-быстро обновить то есть лучше иногда подождать и иметь более стабильную какую-то версию для работы чем иметь всё обнов Спасибо за внимание Спасибо Ребята так друзья у нас есть время на вопросы-ответы если есть вопросы-ответы онлайн Пишите в наш чатик пожалуйста я зачитаю из зала поднимайте руку будем по очереди давай вот отсюда начнём потом вот Может с той стороны Здравствуйте меня зовут Михаил А скажите а сколько у вас в команде вот окучивают всю эту историю что ещё раз сколько людей работает вот над этим продуктом поддерживает его и так далее да на самом деле команда не более 10 человек у нас и в основном там один разработчик и больше именно десо которые всё это поддерживают Спасибо Давайте вот там я видел руки где-то были Нет вон там есть Ну тогда вот там если там рук нету а потом по центру вопрос аппетит приходит во время реды во время еды и микрофон чуть-чуть ближе да хорошо аппетит приходит во время еды и соответственно будущем захочется ещё больше функций каких-то иметь например отложенные сообщения какие-то списки шено в которые приходят вы в итоге планируете продукт развивать как Fork или всё-таки вливать функционал в Open Source версию мы наверное больше планируем что это не будет форком а это именно будут плагины чтобы можно было добавлять к текущему Ну то есть Прямо с форкнуть и потом поддерживать вот Весь вот этот Монолит очень тяжело на самом деле если Вы посмотрите кодовую базу она Ну достаточно сложная и не особо прямо сказал чтобы хорошо написаны можно ещё вопрос а в итоге Ладно всё Галя у нас от Да в общем это всё будет написано именно плагинами которые подключаются Давай да спасибо за доклад Меня зовут Никита вопрос первый короткий вы сейчас используете пушер публичный Да на и какой у вас процент недоставки мы так именно не считали Но объективно наверно процентов 30 точно теряется угу понятно Ну да соответственно выход свой пушер делать а второй вопрос Вы в докладе не осветили А как вы победили проблему с таймаута бан мы его убрали да спасибо если что-то сбоит просто убери это Да ещё вопросы друзья мои вот с той стороны сначала Давайте Добрый день спасибо за доклад Мы тоже разрабатываем Армос правда для себя Вот хотелось узнать какие у вас камни преткновения в создании плагина для эджа И как долго вы его разрабатываете здесь наверное будет задать вопрос Лучше разработчиком то есть мы мы вот прямо сейчас не готовы на это вопрос не на самом деле смотрите там есть на гите похожий плагин практически он уже написанный Да но он работает очень как бы плохо но по крайней мере логику оттуда можно какую-то взять Ну мы как бы также сделали реализовали У нас ДСА и как бы подружились Ну примерно за неделю всё работает Ну да Ну это не особо критичный был функционал пока что для нас то есть мы вот решали именно максимально критичный то есть вот люди жалу что там галочки надо потому что непонятно прочитал не прочитал сотрудник потом когда мы это сделали сотрудники начали жаловаться что галочки не надо потому что контролит что прочитал и не ответил Ну то есть в основном пока вот в такую сторону развивались Спасибо большое зат вое амы также сделали Отлично просто вот там вот микрофон потом сда Подскажите с точки зрения организационной как есть ли вопросы службы информационной безопасности к решени к такому Есть ли какие-то вопросы связанны что это может быть как бы рядом стоящий с объектом ки как-то и вообще приходили к вам ваша внутренняя служба с вопроса мы сейчас рассматриваем вариант его вынести в мы сейчас короче развиваемся в сторону гибридного облака и планируем этор мост полностью убрать из периметра самой компании то есть пока что это находится внутри Но именно вот сейчас у нас работа для вытаскивания в другой периметр дополнение как вот вы будете что-то делать тогда с псом если вытаскивать будете или у вас его нету не плани у нас он есть но проем нчи закроем его Спасибо вот кажется здесь был по центру вопросик Да здравствуйте Спасибо большое вы так много говорите про мормо Почему не кетча типа не очень у нас был чат Мы кстати потом убрали этот сладик на самом деле мы его поднимали пользовались очень сильно нестабильно он Ура работал в то время поэтому было решение именно уйти на мост Окей спасибо и второй очень маленький вопрос вот если вы фактор у нас двухфакторка сделана на основе клока через ССО поэтому там всё хорошо работает Окей спасибо Мне кажется вообще все компании Сейчас делятся на две части первая часть который сначала взяли кетча и мне понравилось они взяли потом матер мост и вторая часть они сначала взяли Мар мост и мне понравилось они перешли на Кет Chat вариантов как бы нету ещё вопрос Давайте один вопрос вот здесь и будем выбирать лучшие вопросы Спасибо за доклад Э да мы из тех кто были на Роке чати перешли на тр мост и по своему опыту конечно могу сказать что Небо и земля Да хотя на нём проработали 3 года или четыре а вопрос организационный вы в самом начале сказали что у вас много чатов WhatsApp Telegram и так далее А как переводили всех сотрудников Удалось ли всех перевести в мотер мост может быть лайфхаки есть какие-то на этот счёт Ну наверное тут больше такое было волевое решение нашего руководителя что он сказал Ну всё мы всё закрываем и теперь все общени только вот здесь то есть это было так то есть компания по фа по факту диктовала правила Ну значит мы здесь тоже из тех что сделали также может быть было что-то другое спасибо Я позволю себе задать вопрос на плах ведущего А у вас своя собственная автономная система есть автономная система чего автономная система набор IP адресов которые принадлежат непосредственно компании да а это получается значит вы поднадзорные должны выгружать все сообщения в соответствии с требованием регулятора когда когда плагин появится для этого мы подумаем на этом мы там написали что предлагаете идею мы вот ребята у вас ещё свой подарок Да нет а мый в один Ага а Выбирайте лучший вопрос А подарок комплексный от Газпром нефти и от ребят А кому это подожди подожди подожди а это вам подарочки за то что вы к нам пришли у нас тут это вот а вам нужно выбрать лучший вопрос Мы подарим за него тоже подарок такой выбор такой выбор давайте давайте давай должна играть тревожная музыка Я не готов принять такой ответственный шаг Ну у меня Мне больше нравится вопрос про иб это вот там вот бы ну вот Давайте значит тогда туда и уходят Спасибо большое ребята Аплодисменты нашим докладчика Спасибо ребята Приходите к нам ещё"
}