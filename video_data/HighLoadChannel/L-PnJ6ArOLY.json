{
  "video_id": "L-PnJ6ArOLY",
  "channel": "HighLoadChannel",
  "title": "NoSQL Best Practices for PostgreSQL / Дмитрий Долгов (Mindojo)",
  "views": 2155,
  "duration": 3193,
  "published": "2018-08-16T04:09:33-07:00",
  "text": "да ну давайте начнем всем привет и сегодня мы поговорим о достаточно интересные вещи это но и свой подход к обычными в обычных реляционных базах данных с точки зрения под газ а ну то есть по большому счету мы будем говорить про джейсон дэй и различные в альтернативы почему я буду об этом говорить во-первых с одной стороны мы все сиди команде в zalando имеем очень интересный опыт использования документов в подписи и должен сказать что мы использовать используем достаточно активно и с другой стороны я в каком-то смысле имею отношение к разработке но из кирпич в подписи поэтому если вы использует же снг есть небольшая вероятность что вы используете функциональность реализована мной так да и еще один момент за этой презентации есть идея я пытался собрать как можно больше интересных технических деталей каких-то таких внутренних инсайтов чтобы сделать ее интересно и даже своего рода хардкорные так что вот даже это знаменитый персонаж был бы горд за эту презентацию и так что мы сегодня о чем мы сегодня поговорим во первых мы поговорим о внутренней сэнди как именно он реализован почему он реализован а именно так и почему это хорошо помимо этого мы поговорим о том как и на как обходить проблемы с написанием сложно запросов поверх документов наверх джейсон бер о сбросе и большой раздел посвященный бенчмарком бенчмарки буду разделим на 2 категории первая часть это будет бенчмарки общего такого характера цель которых на самом деле точно просто показать что текущая реализация снг в подписи она достаточно хороша с точки зрения производительности по сравнению с другими альтернативами когда я говорю в этом докладе альтернатива я имею виду на самом деле всего две вещи это бинарный джейсон москве или и bison в mongo db почему бинарных штаны с моей сфере ну во-первых да это тоже достаточно хорошая цельная реализация бинарного джейсона и ну и просто интересно сравниться с таким ближайшем он соперником по сбросу ну омон где by не знаю как у вас но когда я думаю о документы ориентированном подходим манга дебита первая вещь которая приходит мне в голову пример может быть не самый хороший но тем не менее достаточно реприза репрезентативный да ну и вторая категория бенчмарков будет том как джейсон где работает случаях различных горных кейсов какие-то интересные особые детали случае которые будут интересны с точки зрения производительности и если вы например используйте должен быть документы в подрасе и без всяких видимых на то причин вы видите как вот эти градацию производительности возможно вам будет интересно посмотреть на слайды из этой серии да кстати чисто из интереса кто в этой аудитории используют уже продакшене джейсон это хорошо из года в год на самом деле количество растет на еще не так а а может быть бинарный бинарных джейсон москве ли а а манга baby ok хорошо да но сначала немножко контекста для этой презентации чтобы не было каких то так нет недопонимание вот примерно как на этом слайде собственно о чем я буду говорить до изначально когда мои товарищи из под гаспра предложили эту идею провести различные бенчмарки идей на самом деле очень проста и она вертелась вокруг именно да только без шнурков то есть идея была проста чтобы честна с точки зрения по стрессового комменте показать что это очень хорошая фичу что она реализована с точки зрения производительности на уровне альтернатив и в принципе да в принципе все но затем я связался с этой компанией под названием zalando и видел что многие из моих коллег на самом деле сталкиваются на dos трудностями с работой с джойстиком метров пожгли то есть например надо возникать какие-то трудные запросы которые просто сходу трудно создать написать либо например какие-то такие архитектурные вещи как именно хранить то есть выбирать либо там джейсон белибов таблица либо просто в плен джейсон и просто исходя из этого опыта который мы наработали в мои соседи команде я расширил этот доклад назвала теперь best practices и соответственно сейчас мы по всем этом будем говорить более общем контексте да ну и раз серьёзная часть этого доклада будет толщина бич марком сначала немножко окружение в котором эти бочки проходили то есть здесь на самом деле никакого спорта высоких достижений все что я делала то я тестировал в амазоне я брал и ситу инстанции для каждой базы данных естественно для борт лодки не ротару естественно все они были в одной записи в одной placement группе для того чтобы держать проблем с напарником естественно там были образы с этим виртуализацию для того чтобы производить было страшно хорошие ну и конечно когда кто-то занимается бенчмарками и делятся своими результатами все считают себя умнее чем этот персонаж никто не хочет помочь поэтому я старался быть как можно более аккуратным старался избежать разных глупых проблем не говорю что я всех избежала тем не менее я старался и поэтому как минимум по 4 раунда бэк марков практически для всех из кейсов я проделал на самом деле для большинства из них гораздо больше потому что я проделал бенчмарки для разных версий и между версиями там на самом деле не так уж и часто праздник на различные отличия были да ну и говоря про версии вообще говоря да я использовал на тот момент текущую стабильной версии под брусу 96 и в том числе проводил тесты ради интереса на девелопмент ветки на мастер ветки ip-адреса и то же самое для моей цели то есть текущий стабильная и плюс просто из любопытства надавила конверсии на тот момент манга тебе последний версия была 3-4 4 и да а для тестирования использовал это достаточно популярный инструмент йаху класс rnb марк собственных до инструмент предназначенный для бенчмаркинга ну и сколь баз данных и всех к нему причастных но к сожалению мне пришлось на самом деле сделал свой форк этого инструмента потому что об этом я расскажу чуть дальше для того чтобы внедрить свой тип документов и сейчас этот форт поддерживают тому же отверстие 013 ну и соответственно да все тесты проводились на миллионе записи миллиона перес одними ну там за редким исключением да конфигурация другая болезненная на самом деле тема опять же никакого спорта в итоге снижений все что я старался то есть я старался в этом докладе придерживаться одного правила конфигурация который менял они относились либо ка ин сон су как таковому к его ресурсам либо к природе нагрузки который я применяю к этому ин сон су то есть я говорю например а памяти или например настройках чек-поинтов для heavy апдейт нагрузки то есть для полосы это был шербур force эффекте в кэш сайт и максвелл says ну и для для москве ли на тебе buffer pool сайт и блог files да в отличие от других бенчмарков я старался продюсер бенчмарки с максимальным уровнем концерна оба про о наших данных поэтому манга тебе я тоже использовала в режиме джон old который является наиболее скажем безопасным в рамках одного в рамках одной ноты в рамках одного из осы манга также чисто из любопытства я на самом деле проводил бенчмарки для этой опции для вас tiger называемый транзак сенсинг который по большому счету делает то что ну в целом по умолчанию в manga диабетом на самом деле немножко хитрый такой фазе check point если мы используем эту опцию мы железно говорим что наши данные более sing ну ты и то есть например если вы запустите манга деби под стрессом и вы прямо увидите этот syscall фдт sing что замечательно они не соврали но в этой на самом деле презентации there'sa ты не поместил но отличие там есть но незначительные она естественно я настроил чекпоинты и конфигурировал election для monbebe да пару слов про типа документов дело в том что как я уже сказал в я кукла сером бенчмарки тип документов на самом деле очень простой то есть там разные work лорды но документы которые в этих формулах используются они это просто плоский документ без внутренней структуры ключ-значение ключ-значение ничего интересного соответственно из коробки мы можем в таком случае сделать условно говоря маленький документ и условно говоря большой документ почему я говорю условно потому что встречается например люди был один товарищ hackers прислал сообщение о том что он работает с документами там по 500 по 500 ключей в документах и он там их вытаскивает по одному то есть для него наверное вот-этот large документа ты не такой уж и большой но и в своем форки я добавил то что я назвал сложным документам у которого есть какая-то внутренняя структура да и важно перед тем как мы начнем поговорить одном моменте когда мы говорим о производительности баз данных на самом деле суть огромное количество разных факторов которые так или иначе влияют и на пропускной способности на летом сильно всё что угодно поэтому в целях этой презентации я ограничиться только тремя из них которые непосредственно относятся к документам это представление на диске то как именно мы храним наш документ это представление в памяти потому что дискового представления сожаления всегда хватает иногда необходимо развернуть нашу структуру в память естественно индексы поскольку документы нам необходимо индексировать искать по ним так и начнём как раз индексов в это в случае с индексами здесь на самом деле уже есть интересная на деталька если мы говорим об отдыхе и о том что именно мы можем три документа индексировать мы можем индексировать один путь мы можем редактировать несколько путей а также мы можем датировать все пути внутри документа то есть весь документ это такой уровень повышенный уровень гибкости ушло на что называется потому что вся цель джейсон безначально было отдать вам больше гибкости ну а это соответствующий уровень вы можете просто проиндексировать целые документы даже не заморачиваться что вы дальше с ним делать и в принципе это будет более менее производительна в manga тебе к сожалению мы не сможем индексировать целый документ только его отдельные пути либо несколько путей и в мае сколько сожалению индексации сейчас напрямую не поддерживается бинарного джейсона поэтому вам необходимо создавать виртуальные колонки которые будут вытаскивать информацию из документа и затем эти колонки вы можете индексировать как обычно что в принципе ковалентно опять же индексирование одного пути либо нескольких путей да ну и говоря об адресе еще одна интересная то ли я почти уверен что вы они в курсе в кодексе вы можете сказать какую стратегию вы хотите применять для редактирования и из коробки у вас будет джейсон пав которая поддерживает наибольшее количество значит кооперации функций но при этом оно занимает больше пространства памяти чуть медленнее работают в отличие от второй стратегии джейсон випов abs которая поддержит всего две операции но при этом гораздо более шустрые но на самом деле на этом список стратегии не заканчивается дело в том что например есть расширение же и сквере который добавляет еще пару интересных поэтому в принципе этот список расширяем да ну и приступим к бенчмарком сначала самый простой вариант это обычный рид нагрузка на чтение то есть мы берем из нашего база данных по индексу выдергиваем один документ в целом для москве лимон к диме мы индексируем только айтишник внутри документа для розыгрыша мы индексируем без документов и вот такой нас сюда получается не спешите фотографирует не нужно очень много здесь объяснять сначала так здесь несколько интересных моментов которые до которые прямо вот требует объяснения во-первых мы здесь явные видим вот этот вот пик в 20 клиентов то есть до этого пика у нас происходит с определенный рост а после этого возраста морские львы ходят на свой рот такую планку на плато а манга тебе ведет себя немножко начали об этом тоже поговорим с чем это связано дело в том что в данном инстансе в данном tippins с фан форум dodge как я искала не так много сепию и с этих инстансов на которых я проводил benchmark я собирал метрики вот пример 4 consumption для подброса на 20 клиентах то есть мы видим что в принципе все ресурсы степени у нас полностью поглощены и до 20 клиентов в принципе у нас есть еще небольшой запас часть цепью ресурсов она еще остается после 20 у нас уже нету ничего и в принципе с этим как раз связан этот пик 20 клиентов но естественно если мы будем масштабировать к сожаление по моему эти графики тоже не может их доклад но тем не менее я пародировал dosage in часто если мы берем более мощный тип инстансов мы видим что во первых этот пик смещается вправо и там про свой другие интересные вещи да я забыл сказать важную вещь на самом деле то есть естественно этом графике как вы видите по заголовку это пропускная способность то есть операция в секунду и по оси x здесь у нас указано количество клиентов которые одновременно делают запросы в нашу базу данных по большому счету это уровень конкурентности для данного конкретного bunch марка но и по оси y соответственно операции в секунду да значит пропик 20 клиентов мы уже поговорили другой интересный момент это разрыв между манга деби моэск видим как раз вот в этой пиковые звонят с чем это связано самом деле изначально это было еще хуже потому что как выяснился большое спасибо алексей aka поэтому который мне который поделился с со мной этой информацией в принципе еще неплохо помог с майским сетапом дело в том что поскольку мы используем виртуальной колонки в москве ли маску или необходимо явно сказать что это колонка с торт и тогда он будет достаточно эффективность ней работать иначе вы потеряете очень много производительности но в данном случае помимо этого здесь включается еще один фактор опять же коллеги со стороны майский заявляют что performance кима в москве ли она на самом деле делает много больше чем пиджи стад таблицы в подписи и стад kollection и в manga деби соответственно эти mobil объясняется этот гандикап вот этот разрыв между манкой и москве лем но я не стал эту перформа схема учит потому что это на самом деле то что обычно делают в бенчмарках мать для майский ребята из oracal но мне кажется это не очень естественный вариант никто так продакшене делать поэтому мы сделали именно так другой интересный момент который необходимо оценить это вот от деградация которую мы явно видим для мам к тебе на самом деле она была совершенно неочевидно этими метриками которые я собирался инстансов изначально ничего не говорила почему это деградация происходит поэтому я расчехлил перф и начал просто трассировать базу них и увидел интересную вещь только для метрики к отличались очень серьезно при запуске для 20 клиентов и для ста и чтобы вы думали да конечно себе мигрейшн и syscall называемый след ел прок то есть по большому счету те и венда которые относятся к реализации спин lack of manga тебе здесь мы явно видим что у нас количество себе мегрэ шансов то есть мы кидаем с цепью на себе она увеличивается нас четыре раза и соответственно в принципе у нас возникает проблема с луками из за этого происходит градация а самом деле ребята из мозга тебе над этим работают и изначально изначально проблема была еще хуже то есть на по манга тебе 3.2 производились падала до 10 там 1000 на 3.4 чуть лучше но тем не менее деградация заметно но и самый важный момент который необходимо изменить это конечно поведение данном случае под газ а почему так на самом деле нехорошо себя немедленный ведет объяснить отдам пока не забыл лет инси очень тоже важная вещь потому что естественно просто способность иногда может обманывать но здесь мы тоже явно видим что под grass москве в плане 99 пирсинг или латинский ведут себя достаточно хорошо auman к тебе к сожалению мы наблюдаем деградацию связаны со спины лаками да ну так вот что же не так с этим ведь марком почему после себя так странно ведет дело в том что этот матч мог не совсем честный изначально как я уже вам сказал мы индексировали весь документ в подрасе а в остальных документах мы индексировали только идиш ник документе поэтому давайте сравним условия сделаем тот же самый тест но будем индексировать только один в документе в погаси и вуаля мы видим в принципе ожидаемый результат а манга тебе ip-адрес они идут практически вровень год до пика затем деградация начиная сильно давить мангу тебе ну а под раз более менее линейно продолжается довести еще один момент который здесь необходимо надавить это разрыв который получается между подбросом а майские ли дело в том что все эти бенчмарки которые проводил они проводились со включенными prepared statements ну хорошо это или нет это вопрос спорный и скорее всего я также предоставлю потом в будущем тесты для ситуация когда у нас препарат стоит нас выключены но в принципе достаточно известный факт как мы выяснили в мае скверен prepared statements и они каширу чуть меньше информации чем в конкурсе соответственно чуть менее эффективны и в принципе этом и объясняется этот разрыв да ну и на самом деле основная цель этой презентации показать что по большому счету джейсон бинарный deeson они в принципе уже достаточно хороши и производительность она будет практически на таком же уровне как у решение специально предназначенных для документы ориентированных для документа ориентирована хранения данных и в данном случае это явно видно то есть у нас возрасте манга тебе очень хорошо идут почему потому что как я покажу в дальнейших слайдах структура которая используем документов она практически эквивалентно и соответственно мы используем одну и ту же структуру данных один и тот же индекс если мы поставим эти две база данных в одинаковые условия дадим им окатить на кого окружением и соответственно будем получать близкие данные и давайте посмотрим на внутренности да дело в том что когда мы думаем о том как именно нам необходимо представлять документ на диске нам необходимо найти баланс между двумя двумя различными вопросами двумя различными такими подходами во-первых мы хотим наш иметь наш документ как можно меньше по размеру чтобы естественно меньше писать меньше читать и так далее но с другой стороны мы хотим иметь возможность этот документ достаточно предстательной читать хорошо с ним работать и для того чтобы ответить найти этот баланс нам необходимо ответить на вопрос а как много дополнительной информации мы можем добавить в обычный plain джейсон для того чтобы потом с ним удобно работать и фишка в том что по большому счету ответов на этот вопрос не так уж и много все что мы можем сделать это добавить для каждого элемента нашего документа тип данных который отвечает одна ваку менту там строка целочисленные что угодно и размер этого поле этого ключа внутри документа все и давайте посмотрим на примерах вот она диаграмм к на которой представлено как в грубом варианте как реализован же синди в подрасе во-первых мы видим документ союз поскольку это джастин by the camp один тип данных у всех композитных типов данных есть размер документа затем мы видим древовидную структуру каждый но до который содержит хедер и variable assist контент федор данном случае называется gentry ну аварий был cs go над соответственно содержит всю нашу информацию на данной схеме нас больше всего интересует вот эти 2 ноты давайте посмотрим о них поподробнее что мы здесь видим во первых мы здесь видим тип контейнера в данном случае это либо объект либо там массив либо скаляр на самом деле скаляр этот массив с одним элементом внутри но тем не менее затем количество элементов мы при этого контейнера и затем затаиться непосредственно сам заголовок сам хэдер который содержит три элемента первый это флаг что мы дальше храним длину или смещение затем как я уже говорил в или type собственно там строка целочисленное что угодно и затем непосредственного значения длина или смещения в данной схеме наиболее странная и непонятная вещь это именно зачем нам хранить вообще длину или смещение зачем нам выбирать дело в том что изначально изначально реализация джейсон дэй всегда было только смещение это было сделано для того чтобы дело в том что просто при такой схеме при таком подходе мы можем получить наибольшую производительность планет доступа к отдельным элементам документа но к сожалению выяснилось что при таком подходе мы получаем документы кампарс ability у которых очень плохая то есть мы когда я сжимаем и очень плохой результат отжимания получаем соответственно для того чтобы улучшить ситуацию нам необходимо хранить длину и соответственно в текущей реализации джунгли в подгрести мы имеем такой трудов баланс когда каждый это элемент содержит смещение все остальные длину этот это элемент это на самом деле в переменной a j bss straight которая она к сожалению не где не представлено в виде конфигурации это исключительно переменная внутри нее но в принципе если вы интереса можете попробовать собрать свой под газ и поиграться с этой переменной вы можете получить чуть большую скорость производил на доступа к элементам за счет потреблений одесского пространств ну и давайте посмотрим следующую схему это представление того как реализован bison манга тебе опять же мы видим размер документа докумен says опять же тогда видна структура а каждой ну да который содержит заголовок и собственного лейбла съезд контент и давайте посмотрим поближе на хэдер данном случае что он содержит во-первых да опять же не так много опций валютой затем уже первое интересное отличие прямо в заголовке у нас хранится ключ имя ключа и дальше опять же катя уже говорим так много опций размер значения которые отвечают этом ключе тоже первое отличие на самом деле связана с тем как мы храним ключи в этом случае в случае джейсон bionase все ключи все значения хранятся вот в этом блоке которое зовется контент he здесь и мы не явно подразумеваем порядок в этом блоке они явно накладываем просто какой-то определенный порядок в бессони этот порядок он напрямую зашита заголовок данное здесь схемка которая представлена бинарный на который представлен бинарный джейсон москве или опять же древовидная структура в данном случае у нас нет явного какого-то выделенного заголовка у нас есть только тип и само значение которое содержит всю информацию и давайте посмотрим поподробнее да вот большой большой компонент во первых сначала у нас количество элементов в данном контейнере затем размер и как вы наверное заметили то мне туда come inside поэтому для корневого элемента размер всего документа будет вот именно здесь и дальше другое интересное отличие у нас здесь появляется опять же относительно того как мы работаем с ключами появляется интересный термин который называется pointer и это конечно не пантеры в памяти это просто смещение относительно начало документа где мы можем найти can данный конкретный ключ или значение ну и дальше соответственно сам блок соответствующие включаем и значением исходя из того что я прочитал в исходниках москве ли сделано это было для того чтобы опять же в целях производительности для того чтобы можно было работать с ключами и значениями условно говоря таком линию мы варианте когда мы можем иметь доступ конкретному ключу или значению дамы я уже показал вам несколько отличий связанных с тем как мы храним ключи здесь есть еще одно интересное отличие несмотря на то что в принципе решение похоже они но есть маленькие отличия для джейсон дэй бинарного москве ли все ключи и значения будут сгруппированы между собой то есть когда мы например имеем документ ключ 11 два значения один ключ и два значения 2 они у нас будут сгруппированы ключ один ключ 2 значение 1 значение 2 этаже это будет группировка эта группировка будет появляться только на каждом уровне вложенности соответственно каждый отдельный уровень уровень будет содержать эту группировку в manga бессони это немножко по-другому там ключ и значение следуют в естественном порядке то есть ключ один значение 1 к лишь два значения 2 и так далее зачем это было сделано опять же просто исходя из необходимости сделать все максимально быстро то есть представьте когда мы работаем с документом мы естественно чаще всего работаем и нас ключами этого документа мы что-то обновляем по этим ключам мы читаем информацию по этим путям и так далее соответственно если мы все эти ключ открой первом месте мы во-первых поимеем к ним более быстрый доступ нам не надо бегать по всему документу во-вторых мы можем там кэшировать как-то оптимизировать к ним доступ и так далее она на самом деле песен в москве лета сделать и проще потому что эти типы данных они абсолютно внутренне они никуда наружи не предоставляются в то время как bison это своего рода такой интерфейс на тип который используя в том числе дай коммуникации поэтому в этом случае на самом деле изменять порядок сложнее да ну чтобы сделать это по чуть более интересным я покажу все эти отличия на прямо на бинарном уровне на примере такого простого документа собственно что я делал в подгрести это войск вели в manga тебе создавал таблицу слышь коллекцию которая содержалась его одно поле типа джейсон дэй и это pon это таблица содержалось его одну запись которая была как раз представляла себя этот документ вот этот да ну и соответственно представлен запрос который вы можете вытащить файлик которому относится данная таблица и что мы видим мы видим интересные вещи здесь к сожалению кликером конечно вам не покажу но тем не менее вот мы видим часть заголовка которая есть документе и дальше вот вы явно витте и би 2 ключа сгруппированной месте затем у нас есть выравнивание ранены там отключи который а 08 как раз длина или значение и два значения сгруппированных вместе ведь мы явно видим троечку и x y z для того чтобы проделать тоже самое для манга тебе мы можем воспользоваться просто библиотека из пайпе обогатит называется очень говорящим названием bison и просто сдам пить этот документ и видим это же самое сначала мы видим documents вот первый открывающий бит затем первый ключ который и соответствующему тип данных десяточка в данном случае это целочисленное и затем сразу же соответствующую этому большое значение тройка затем опять же выравнивание затем следующий ключ и соответствующее ему значение то есть принципе как я сказал они не группируются и для майского ли к сожалению не пришлось найти необходимый документ прямо руками в базе данных но тем не менее это сделал и вот пример здесь на самом деле очень-очень длинный заголовок и по большому счету его трудно раз порхать потому что как я уже сказал там есть и пантера которые ничему не отвечают но тем не менее и мы явно видим в конце этого документа что вот у нас опять же до 2 ключа сгруппированных вместе и двоим соответствующих значения ага другая интересная на самом деле маленькая но тем не менее телесный деталь дело в том что джейсон б эта штука который называется variables искал там должна быть выровнена по четыре байта и это приводит к интересным последствиям предположим мы имеем два документа вот 1 2 у которых всего лишь на самом деле поменяны порядком два значения то есть с точки зрения просто обычно джейсона родиться в размере никакой но если мы пытаемся сохранить два документа в подкасте мы увидим что второй документ занимать на два байта больше почему это происходит на данном слайде приведен соответственно придется бинарное бинарное представлении документов и мы явно видим что на втором документе у нас сначала есть два байта выравнивания и сразу после этого ключей обе есть тоже два байта выравнивания как я уже сказал отличие всего 2 beta в данном случае мы явно видим четыре а дело в том что выравнивание по 4 бит думать ну это мы поговорили о внутренних структур и о том как мы это все храним на диске это все хорошо но как я уже сказал тип документов которые используются в yahoo 40 очень простой это не очень реалистично все документы с которыми мы работаем имеет внутреннюю структуру поэтому давайте посмотрим на тот же самый benchmark когда мы вытаскиваем один документ с база данных на то документ имеет какую-то внутреннюю структуру его соответственно сложнее вытаскивать сложнее парсить и так далее и на самом деле не удивительно мы в принципе видим те же самые результаты только разные немножко цифры то есть опять же пика 20 клиентов опять же а потом он к тебе тут один в один но ум он к тебе со временем наступает проблема со спины лаками ну и опять же проблема не проблемы особенность маску или связанные с информацию схема и припер statement привод потому что он чуть чуть медленнее до другой интересный момент до этого я показывал достаточно простые бенчмарки которым когда мы выдергиваем 1 документ ну естественно возникает вопрос а как это все будет себя вести когда у нас документы меняются по размеру и следующий benchmark это как раз и будет показывать что я сделал я взял тот же самый вид workload но при этом зафиксировал количество клиентов которые мы используем на 40 о клиентах и вместо этого менял количество размер документа который мы запрашиваем вот она интерес точно бисмарк получился здесь тоже все самые та же самая легенды заключение того что по оси x у нас размер документов килобайтах и мы видим интересно деталь до примерно двух килобайт of у нас идет примерно линейной деградация принципе просто за счет того что наш документ становится большего труднее читать потом бам что-то происходит и у нас происходит резкое деградации после которой опять же линейное падение с чем это связанно это связано как вы могли догадаться с топпингом дело в том что как и любой тип данных на самом деле как вы будете большой тип данных по трассе он подвержен the single исчез на наши документы они имеют свойство расти со временем и что происходит сначала естественно мы будем сжимать наш документ это пума поведение по умолчанию можно конечно отключить но тем не менее по умолчанию мы будем ужимать и если после сжатия наш документ все еще достаточно большой мы применяем к нему tasting то есть мы расщепляем наш документ на большое количество маленьких кусочков и сохраняем его в отдельную таблицу как вы можете себе представить это тоже выход то есть для того чтобы например нам записать документам необходимо его расщепить половить по разным таблицам для того чтобы его прочитать нам необходимо его опять же собрать и выдать клиенту как целый и все это так все это происходит когда у нас документы занимают больше чем два кило бы это пространство и мы значит закончились секции относящуюся к дискам представления но как я сказал disco vol представления не всегда была достаточно сложная логика она была предназначена для того чтобы иметь возможность читать за документов в более-менее производительном виде но дело в том что например предположим когда мы хотим обновить документ как мы это можем сделать структуру уже достаточно сложная поэтому обновлять его прям вон диска презентация достаточно трудно поэтому что обычно делают обычно условно говоря си реализуют данную дисковую структуру в память в каком-нибудь простую структуру в памяти для под раз это будет девильо для манга тебе это будет класс документ и для мастер это будет класс джейсон дам и затем мы с этой простой структурка как-то очень удобно работаем и проводим какие-то изменения затем си реализуем одессе реализуем это обратно в близкое представление сохраняем уже на диск и на самом деле во всех трех с решениях которые сейчас сравнивая на так и работает ну и раз мы поговорили до о обновлении документов мы поговорим немножко другие сейчас видах нагрузки то есть естественно мы не только читаем с нашей базы данных нам необходимо еще иметь добавим не добавлять документы и их обновлять самый простой benchmark это просто на ставку что здесь происходит мы берем целый документ записываем из данных естественно для всех трех база данных мы беспокоимся об этом документе чтобы он был сохранён и так далее и смотрим что происходит во первых изначально это ужасная картинка на самом деле не смотрите на ее но дело в том что изначально я пытался либо еще марки без соответствующей конфигурации чек-поинтов и это приводит таким чудовищным картинкам наши результаты очень сильно осциллируют потому что просто все очень сильно завязана стратегию чек-поинтов и она нестабильна соответственно вот например метрики взяты с манга деби мы здесь явно видим что у нас степенью практически не поглощается и мы в данном случае серьезно связано с ее производительностью и вот например красивый график связанный с тем он показывает очередь в manga тебе на запись как именно она меняет со временем и мы видим явно что есть очень серьезные пике возникают время от времени эти пики они просто уничтожают производительность соответственно нам необходимо настроить чекпоинты для данного конкретного клода чтобы они происходили не так часто и воля тот же самый benchmarks настроенными чекпоинтами мы явно видим что в данном случае на самом деле под газ ведет себя очень хорошо манга divine москве они примерно на одном и том же уровне происходит но здесь есть деталь на самом деле дело в том что для москве ли в данном быть марки есть два сетапа правильный и неправильный правильный предназначен для того чтобы он правильный он тот который он советуем и дело в том что он хорошо работает на выборку и на обновление правильно это означает что данном случае там есть правильная как раз прямо реке и все хорошо но к сожалению такая постановка вопроса приду к тому что производить на вставку вообще чудовищной то есть вот здесь она порядка четырех тысяч операций в секунду в этом правильном варианте она была порядка двух тысяч операций в секунду поэтому надо нам бенчмарки я представил неправильно ситуация когда нас нету прайма реке здесь у нас вставка немножко получше себя ведет но тем не менее не так хорошо и это связано самом деле с тем что это как более-менее достаточно известная проблема москве ли с нагрузки на связано вставку и по большому счету все это большое количество вереница разных форков мы успели она как раз таки предназначены решить эту проблему но в ванильном моя спели она у нас фигурирует да и перед тем как мы поговорим о моделях нам необходимо поговорить об одной штуке а дело в том что когда мы говорим про документы в реляционных базах данных нам необходимо понимать если не смотря на то что мы думаем об этом документе как документе он задержка круто внутреннюю структуру маленькие ключи не маленькие ключи и так далее для база данных это все равно один большой тип данных сожаление поэтому иногда как там мы производим какие-то операции какие-то функции применяем к этому документу случайно или не случайно по шепель не по ошибке база данных может продвигаться по всему документу несмотря на то что вы ожидаете от нее например работа только с одним ключом такое иногда происходит пару примеров самый яркий пример это да это обновление одного поля из большого документа и на текущий момент и в моем стиле в подписи у вас будет достаточно серьезно верха связанный с тем что ну во-первых да вы будет читать целые документы вы будете писать на за целы документ он там обвал целый попадет и так далее несмотря на то что вы обновили всего одно маленькое поле а другой пример т.д. то sting & peri индексирование слов документа но мы они сейчас чуть подробнее поговорим сначала до сначала индекс апдейт какой интересный случай может возникнуть помимо обновления документа от целиком предположим что мы создали яндекс по документу и затем мы хотим обновлять какое-то поле в этом документе который с индексом сын не связано что произойдет естественно база данных захочет перрин ducks давать весь документ к сожалению это естественно приводит к выходу ну может быть не такому большому но тем не менее на этом почему ты сейчас привел пример зеленым у нас здесь соответственно показан показана ситуация на самом деле тоже интересный сетап немножко отклонять в сторону он тоже относится к тому как использовать или не использовать документы в резных баз данных и скажем 2 так 2 диски из а когда вы храните оддиш них внутри документа на когда вы храните орешник в отдельной колонке то есть есть разные за и против этого случае например ребята из oracle они используют только первый подход когда у вас видишь них всегда в отдельной колонке и например они я не помню точно название на они сейчас делают интересную штуку которая позволяет работать с реляционная база данных по обычному протоколу как будто бы вы работаете с джейсоном но под капотом это всего дела создается обычный реляционной базы данных и да там просто документ и в отдельно кому-то хранить сегодняшний так вот означать к этому бенчмарком мы здесь явно видим что зеленая линия которая относится к ситуация когда у нас айдишник по отдельной колонке она чуть более производительно да просто потому что мы не перестанем индекс в данном случае для условно говоря маленькие документов это тавер хоть не очень большой но вы должны иметь ввиду что чем больше ваш документ тем более плачевное может стать этой ситуации ага ну и собственно то чем я говорил вначале обновление большого документа а точнее одного поля у большого документа сначала до сначала ну не такой большой сначала да то что мы называем simple соответственно настроенными чекпоинтами в данном случае я использовал из я х-класса рыбачок workload под названием выплатой который подразумевал под собой 50 процентов апдейта и 50 процентов выборки то есть условно говоря симуляции реальной нагрузки какой-то и что мы видим картинка на самом деле очень интересно и как мы видим после самой сколь и они в принципе тут себя достаточно хорошо и в принципе после они на самом деле после настройки чек-поинтов они получили очень хороший boost к сожалению для манга тебе это не так дело в том что для всех этих трех баз данных их в этом случае сравнить вообще сложно потому что все они используют более менее разные тактики для чек-поинтов то есть несмотря на то что и там и там у нас будет спред или там фазе чек будет называйте как хотите тем менее тактики немножко по-разному происходит например маленький пример когда здесь происходит с для под курса чекпоинт идет идет идет и концу батч марка всё синхронизировано при одних и тех же настройках с москве но при этом в москве le chic пантин еще продолжается какое то время после бенчмарка там еще данная какие-то до записываются и это естественно влияет на результат которым и это нам пришлось немножко избегать немножко различными настройками учитывать факт но тем не менее для манга деби все еще сложнее дело в том что по умолчанию почему то там стоит лимит на размер файла транс уайтхед лог файла в два гигабайта то есть хоть я показал предыдущем для подвеса и москве летом осмелился 5 гигабайт для мага тебе только два и я даже на самом деле не нашел ни в документации не в к мите который внес изменение почему именно два единственная моя догадка просто в том что данные из песни очень характерен для манга тебе то есть правильно было бы сделать кучу маленьких реплик например но тем не менее это надо иметь ввиду ну опять же другой интересный момент здесь в том что все таки несмотря на все это манга тебе не должна быть так медленно то есть мы ожидали что она будет чуть медленнее может быть там в два раза но не на столько поэтому вполне возможно мы еще можем подключить какие-то настройки которые сделают эту ситуацию лучше для мага тебе да но как я уже сказал оверхед обновляем одно поле с большого документа смотрим что происходит делаем то же самое для большого документы видим да к сожалению да это немножко стара сайт но тем не менее мы видим что в данном случае несмотря на осцилляций у у манга деби производились гораздо лучше и это на самом деле benchmark еще без сконфигурированных поинтов с конфигурирование он там будет гораздо больше то есть порядка 3 тысяч операций в секунду гораздо более лучшая производительность на большие тут метах просто потому что манга дебиана в курсе о сложной структуры документа с которыми она работает и умеет обрабатывать более умным путем ага ну и другой пример другой пример того что может пойти не так это документ слайс до этого быть марки которая показывал были достаточно простые мы выделяли целые документы с базы данных что произойдет если мы захотим город нецида документа только какую-то его часть очевидно включится машинерии которая залезает внутрь нашего документа и следующем меж марки она до сначала они почему сначала объяснение что происходит о чем я говорю то есть вот предположим у нас есть два запроса когда мы выбираем 2 ключа в этом случае все в принципе будет хорошо когда вы выбираете ключ один ключ 2 и они находятся условно говоря цепочки внутри одного документа однако к сожалению во второй ситуации этот запрос в подгрести вызовет привели к тому что у вас этот документ и это будет до тостер два раза соответственно вы его будете разжимать и собирать энергично кусочков два раза и это на самом деле это своего рода проблема но она характерна не только для джейсон by она характерна для всех композитных типов данных то есть ли в том числе для ариев и для чего угодно и соответственно вы можете при себе представить что если у вас будет 500 ключей которые вы захотите выбрать таким образом вас будет очень-очень большой orchid и давайте посмотрим на башмаки в данном случае мы выбираем только одно поле мы уже видим что ну на предыдущих бенчмарках вы можете вспомнить что там под verso манга тебя не были примерно один в один здесь у нас уже появился небольшой разрыв связаны с именно с тем что мы начинаем залезать внутрь в принципе это более-менее ожидаемо одна только заметка здесь на самом деле если мы будем масштабировать эту ситуацию то есть incense который на котором все это происходило он был достаточно таким маломощным если мы будем увеличивать количество вершил сепию на нем мы видим что этот разрыв остается все меньше и меньше то есть на самом деле в этой ситуации по чуть-чуть лучше все-таки реализует использовании доступных ему ресурсов однако следующий вариант сделаем чуть более нашу ситуацию чуть хуже выберем уже не одно поле с большого документа а 10 процентов из еще более большого документа то есть будем готовить гораздо сильнее и что мы видим ситуации на самом деле крайне плачевное то есть признательность очень серьезно упала и упадка сами ума и сквере я на самом деле не проверял мой square в плане реализации но я полагаю что там та же самая проблема просто исходя из данного бенчмарка и да как мы можем эту проблему избежать самый просто способ это применять 100 рассчитаю данной колонки в данном случае мы получить мы избежим для топпинга мы просто скажем что эта команда не будет сжиматься соответственно вся эта проблема идет но при этом вы естественно это все будет за счет того что вы будете потреблять больше количество детского пространство вы не будете сжимать ваш документ другой пример он другое решение она еще более простое просто замените ваш запрос и тут на самом деле самое время поговорить о сложных запросах дело в том что просто заменить запрос не всегда не всегда легко и вот почему до исходя просто из моего опыта в zalando мы в принципе увидели что поскольку в позы сейчас нету нормальной поддержки хорошего джейсен pov некоторые виды запросов могут быть сложными например запрос который содержит какой-то массивчик внутри по пути или например когда вы тренируетесь по компонентом вашего документа это может быть проблематично на самом деле для этого уже есть решение это опять же расширение джей скорей которые представляет нечто похожее на джейсон пав и вот этот грядущий большая грядущее вещи под названием из колледжа сон о которой олег бурханов говорил в предыдущих докладах я очень надеюсь что возглас 11 она будет за конечно она реализует полноценный сон по но пока на текущий момент нам необходимо жить с тем что у нас есть и да как же нам избежать эту проблему в данном случае конкретно для выборки мы можем на самом деле использовать очень простой подход мы можем с пульсацией джейсон дэй папиллит рекорд что она делает она по большому счету разворачивать наш документ русскую структуру и тем самым мы избегаем большое количество проблем но на самом деле это очень большая тема дело в том что в подписи при работе с же снг документами это очень популярный полезный подход а когда мы берем ну все-таки мы в конце концов работаем в лицо на базе данных мы можем развернуть наш документ в нормальный рацион и структуру и работать с нико хотим предположим у нас есть вот такая вот например штукатурка это просто коллекция каких то документов и каждый документ внутри еще содержится до какую другую коллекцию и предположим что мы захотели выбрать все айтемы у которых вылью равно 3 play как мы это можем сделать мы можем использовать этот подход раскрывание и собирание документов назад вот в данном случае представлен этот пример как мы это можем сделать мы можем использовать функцию джейсон бер элемент для того чтобы развернуть документы дело с ним дальше все что захотим другой пример это и 3 рование по элементам или документа опять же похожая ситуация но в данном случае мы хотим выбрать те а этому у которых статус равен true как мы это можем сделать опять функция джейсон дэй each который развернет наш документ и дальше мы с ней делаем что хотим естественно в некоторых случаях это будет слишком многословно то есть например представьте вы хотите обновить документ вам необходимо его развернуть что-то с ним внутри сделать и потом сыграть его обратно в этом случае женщин паз был бы конечно гораздо приятнее но тем не менее на самом деле об этой штуке не надо думать как о каком таком грязном хаки это на самом деле очень полезная вещь дело в том что по большому счету это такая . где документы документы ориентирован так он встречается с склеим и соответственно это вот именно то . где вы можете использовать всю мощь и сквере для того чтобы работать с вашими документами это на самом деле очень круто ага и на самом деле на этой ситуации на этом слайде мы закончили большую секцию которая относилась к альтернативам вне по сбросу то есть мы буквально взяли у до star trek star wars и давай их сравнивать но прелесть в том что есть альтернатива джефф ноты в том числе внутри самого пояса и как я уже сказала на просто опыте из нашей команды это вопрос часто возникает предположим вот у нас пришел там web хук пилот из гитхаба как мы его можем хранить ну то есть самый очевидный способ это там просто например plane jason мы предполагаем что мы не будем работать с этим документом мы не будем след залезать внутрь него просто будем там в доски например в приложении все это с одной стороны хорошо другой стороны это вранье потому что с внутренностью документа мы все равно будем работать окей тогда джейсон by но возможно например есть смысл просто развернуть его в таблицу этот пилот чисто с точки зрения производительности есть ли в этом смысл или нет такие вопросы они часто очень возникают поэтому следующие бенчмарки как раз этому и посвящен и да вот первый матч марк это у нас просто обычная реляционная таблицы соответствующие документы и сам собственный документ в данном случае это пока у нас benchmark связанной с инсектами и что мы видим мы видим что insert обычных записей в таблицу он чуть чуть быстрее чем insert документов но не на самом деле не серьезно то есть отличие там меньше по моему тысяч операций в секунду с принципе если путь использовать документы вместо таблице вы особо много не потеряете но оговорить заранее это на самом деле вещь которая очень часто портят разработчиков когда есть возможность там пихать любое шахтам в документы не надо то конечно делать вам надо понимать что вы должны работать с документами вы должны хранить жизни только документы которые 10 на являются документами то есть вещь которая сама по себе имеет он скажем так происхождение виде документа например event да куб пилот который содержит в себе всю информацию о себе он такой достаточно замкнуты с ним хорошо работать если же вам нужно что-то джонни что-то там доставать изнутри солью с данными вокруг лучше этого конечно не делать помойку не надо это превращать да и другой бич марк тот же самым benchmark но в данном случае мы делаем выборку обычная строка из-за таблица против документа и здесь мы вообще видим что они идут в один в один что означает что по большому счету если вы разворачиваете документ в обычную лицо на таблицу на чтение вы вообще ничего не получите поэтому в принципе особо смысла в этом нет данной другой момент плен джейсон против же снг почему это интересная опция для исследования то есть да дело в том что есть в принципе предположения что плен джейсон поскольку мы не поддерживаем а внутренне структур он может быть иногда чуть быстрее просто за счет того что мы не лезим внутрь документов не вытаскиваем какие-то ключи может быть это имеет смысл давайте посмотрим да вот здесь у нас больше марк связан с сенсорными мы видим что в принципе джейсон ли джейсон опять чуть чуть более производительный потому что нам не нужно опять же повторюсь поддерживать его внутреннюю структуру но опять же разница крайне мало вот прям как в том ими очень мало и в принципе ну на самом деле не может быть не так уж и много смысла это делать и аналогичный benchmark для теста для редфорд лада в принципе та же самая ситуация apple андерсон чуть чуть более производительный опять же повторюсь 3 раза за счет того что просто мы ничего с ними делаем а просто берем строку и отдаем клиенту но опять же разница ну очень скромная поэтому в принципе исключительно с точки зрения производительности скорее всего так делать не стоит да и на самом деле мы уже подходим к завершению пару выводов самый на самом деле большой основной вывод заключается в том что джейсон дэй бинарной джейсона москве ли они уже достаточно хороши для того чтобы их активно использовать то есть например если вы говорите что если например вы хотите думаете о том чтобы иммигрировать с манго там элис аррен тебе на под газ или майский в принципе это уже достаточно хорошо будет для вас вы при миграции не увидитесь серьезной деградации например какой то неожиданно для вас скорее всего производились будет примерно том же уровне и следующий вывод да все отличия бенчмарка которые только что показал они по большому счету объяснялись именно конфигурации самой база данных то есть то о чем в принципе мы уже более-менее поднаторели то о чем мы в принципе более менее уже знаем все реализация документов само по себе в современных баз данных она очень похожи поэтому в принципе они будут обработаны достаточно производителя но естественно все эти бенчмарки которая показала недостаточно искусственные и поэтому для того чтобы вы могли быть абсолютно в себе уверен в своей системе вы должны естественно конечно тестировать все на своей системе на своем на своих work ладах да ну и на этом у меня все я очень надеюсь что вас есть какие то вопросы неужели нет вопросов добрый вечер спасибо за доклад у меня такой вопрос можно ли имеет ли смысл использовать документы джейсон в ограничениях например во внешних ключах доставляется каких-то данных столицу мне хотелось бы быть уверенным что такое такой-то поле этого jason de документа содержит данные из другой да конечно обычно вы можете создать обычный constraint которая будет это проверять он не хочет область он не дается создаваться вы по крайне мере на 9 и 6 на десятки по-моему очень странно потому что я проверял вот этими вот руками может быть его развернуть той также надо или как то так вот в таблице будет вообще синтаксис неверный я так не умею интересно но можем поговорить после этого но я могу вас уверить что constraint точно есть и он будет работа вообще-то хорошая идея или не очень да мы в принципе это используем спасибо замечательная видимо либо очень хорошо объяснил либо очень плохо поэтому вопросов нету но в любом случае если вы слишком стеснительны и можете найти меня я буду здесь сегодня завтра мы можем поговорить либо даже в шахматы играть например если хотите спасибо за доклад мне вопрос такой я не знаю может быть ну бирский от отключить сжатия для колонки от ты говорил что можно как бы чтобы она не не the stellae там немало как это делается есть ну в принципе вот она там прямо на докладе дословно set сторож type сейчас найдем до секс 2 external просто и сколь команда alter the apple alter каллум и секс старушек страну спасибо большое у меня быстрый вопрос дополнение к прошлому вот при отключении сжатия вы делали быть марки смотрели на сколько на самом деле даже не пока еще нет вопрос по поводу эффективность перестройки индексов при обновлении больших документов какой-то тоже bench перестройка целого индекса после обновления одного маленького поля наоборот мы обновляем большой документ и после этого там чтобы а обновляем большую через документы да на самом деле я не знаю что здесь тысяч потому что здесь принципе она будет эквивалентно любой другой ситуации когда вы просто обновляйте большую часть например там таблицы и до индекс вас обновляется а что вы ожидаете но мне интересно сравнить скажи манго нет я такого не сравнятся жилет в принципе интересный вопрос на самом деле на самом деле очень много интересных различных вариантов и это не первый раз когда я делаю то доклад все что-то предлагает у меня на самом деле очень большой серьезной физичка окончании меня всего две руки один маски они все успеваю поэтому если у кого-то из желании можете присоединиться все исходники все скрипты на гитхабе это все вэнсы был поэтому можете легко развернуть на его у себя и по тестировать спасибо спасибо за доклад тоже такой вопрос новичкова я может быть вот есть смысл если смысл для ускорения поиска там несколько полей существо на вытаскивать отдельными таблицами на если по ним там вы идете или принципе без потери скорости можно по джейсону искать не совсем поняла еще раз то есть большой джейсон да есть у него несколько там значащих полей до по которым мы делаем там в запроса и тесте нормализовать вытащите как-то отдельно отдельно колонками положите это он про сложить паззл и вы получите признательность на только в там в крайних случаях когда опять же когда вы там прибегайте по всему документа но это такой крайний случай то есть тут надо смотреть вообще если в этом смысл если вы это столкнулись тогда да вы можете вынести до этого наверное нет смысла всего да но я полагаю все спасибо"
}