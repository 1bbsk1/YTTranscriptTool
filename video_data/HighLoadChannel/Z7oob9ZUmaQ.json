{
  "video_id": "Z7oob9ZUmaQ",
  "channel": "HighLoadChannel",
  "title": "Отказоустойчивое Такси, или Как мы строим надежный сервис / Максим Педченко (Яндекс.Go)",
  "views": 12022,
  "duration": 2797,
  "published": "2021-10-04T02:47:02-07:00",
  "text": "ok поехали всем привет я максим и расскажу сегодня про отказоустойчивые такси и как мы строим надежный сервис более простое название моего доклада просто как делать надежные сервисы кто я вообще такой я работаю в компании 2017 года приходил ещё в компанию яндекс такси сейчас индекс голову называется руковожу группой бэк-энд разработке и занимаюсь продуктовой разработкой а продуктовой разработка это разработка фич и это правда сложно про яндекс голову у нас микро сервисная архитектура сейчас кажется уже сотни или тысячи микро сервисов есть монолит и код пишем на си плюс плюс и на питоне 3 в основном на си плюс плюс а сегодня буду рассказывать про то почему отказоустойчивость для нас это приоритет а что обычно в таких архитектурах как наши приводит к отказам и о чем обязательно нужно подумать перед разработкой чтобы большинства проблем избежать и так почему отказоустойчивость вообще приоритет для нас а как вы думаете сколько в россии совершается поездок в день просто выкрикиваете 100 тысяч десять миллионов но близко-близко в 2019 году было такое исследование ссылочка здесь есть сколько людей несколько поездок еще совершается в день и вот на 2019 год число такое 2 из 7 миллиардов поездок это 5000 секунду представляйте 5000 в секунду кто-то хочет уехать куда-то на дачу к родственникам а что будет что будет если такси перестанет работать с понятно не все эти поездки наши но все же мы водители будем терять деньги тут самое важное наверное что просто люди лишатся заработка пользователю уйдет конкуренту пользователи есть потребность он хочет просто уехать он кого-то найдет может быть такая ситуация что уходить будет некуда что тогда ну в самом лучшем случае там идет дождь вы хотите уехать в метро ну как метро подъехать и может испачкайте ботинки в худшем случае у вас отпуск вы просто опоздаете на самолет и это прям совсем неприятно и наша цель здесь всегда подать машину мы хотим пользователя не подвести наоборот вернее подвести всегда что обычно приводит к отказам типичная архитектура сервиса по заказу такси выглядит так есть мобильное приложение есть какой-то backend давайте для простоты это будет монолит у него есть там несколько and point а вот юзер идет в авторизацию затем он считает цены затем с этими ценами он заказывает такси ну заказ пишите куда-то в базу дальше какая-то обработка это уже не важно а что здесь может пойти не так ну может быть какие-то внешние факторы да может быть там снег пошел дождь пошел просто много людей хочет уехать и мы не готовы к этому а может быть естественный рост из года в год люди пересаживаются на такси продают свои машины не надо искать парковки ну просто удобней а может быть мы сами виноваты сможет быть мы просто пишем новые фичи так ну вот и о чем-то не думаем и вот я сегодня именно с этой стороны хочу разобрать вот о чем мы могли не подумать в разработке что привело этом стриги рила какой-то крупный focal то есть именно с продуктовой разработки разобрать на чем важно подумать о давайте побудем сейчас в роли продуктовых разработчиков и представим то что нам в эту архитектуру нужно интегрировать вот новую фичу вот кэшбэк то есть у нас вот есть экранчик расчета цен нам нужно положить в него вот информацию сколько кэшбэка может быть начислена за какой-то конкретный тариф и у нас даже есть micro сервис кэшбэка нам просто в него нужно сходить сходить получить информацию и в принципе все окей мы выбираем интеграцию через backend то есть мы из расчета цен делаем сетевой запрос в кэшбэк а есть отдельная интеграция когда мы прямо из мобильного приложения ходим в этот микро сервис я попозже в середине презентации расскажу почему так делать не стоит ну и у нас вот очень просто все получается мы сетевой запрос так добавляем в этот кэшбэк ну и в принципе все и интеграция вот супер прямолинейная то есть у нас один сетевой поход в кэшбэк затем мы парсим и taipei как то возвращаем его в мобильное приложение мобильное приложение это и 5 поддерживает и ну как это часто дальше бывает мы такие 1 раз и в продакшен все же просто а если мы вот здесь остановимся и больше ни о чем не подумаем то нас обязательно ждет вот такая картина то есть наш сервис упадет почему упадет ну там не будет цен нельзя будет заказать такси и там что угодно почему это произошло потому что мы о чем-то не подумали вообще вся отказоустойчивость она про то чтобы о чем-то подумать задать себе нужные вопросы найти на них ответ какие вопросы то есть как мы будем вот эту фичу включать на бэг-энде вообще думали а вот в приложении как мы будем включать а правильно или мест вообще для интеграции мы выбираем ну и что если вообще все что у нас есть пойдет не так очень важные вопросы давайте по порядку а как мы будем включать фичу на викенде то есть почему важно об этом думать что будет если мы не подумаем то есть наивный ответ мы никак ее не включаем она вот сразу включена тогда у нас мы вообще здесь в этой картине это страшно мы ничего не защищены допустим вот какие то сетевые проблемы начнутся то есть мы ходим из расчета цен в микро сервис кэшбэка с тайм-аута метан 500 миллисекунд на 3 литра я и выкатываемся выкатываемся на прот все хорошо ну а потом микро сервис кэшбэка этому чуть чуть хуже уже становится он начинает отвечать за 600 миллисекунд мы начинаем горе троить ну и сервис уже как бы совсем перестает отвечать что будет дальше а дальше вот что будет типичный ну backend он работает примерно так насти есть какой-то входящий поток и запросы есть какие-то worker и которые эти запросы могут обработать то есть в обычном случае запрос попадает на какой-то worker worker висит потом начинается ретро и и ну то есть все все нормально когда ретро iv нет все отпускается когда начинается ретро и они начинают забиваться забиваться и просто типа все worker висят ждут пока кэшбэк ответит кэшбэк никогда не ответит и поэтому новые запросы они ну вот они приходят встают в очередь и никогда больше не смогут выполнится вы скажете ну есть же у нас сейчас async раньше на нас есть асинхронный backend и в принципе да если у нас будет асинхронным backhand-ом куница симка его в питоне тогда мы просто не загрузим 3d потому что мы будем тоски коллекционировать в памяти но так ли это важно то что мы не загрузим труды из и вновь прибывшие тоски они будут ждать вот настолько долго неприлично долго что для юзера в принципе никакой разницы нет в итоге у нас в этом случае если мы ничего такого не умеем делать у нас просто забивается канал забивается просто моментально и наш расчет цен выходит из строя для пользователя это значит то что он не может заказать такси и поэтому ok давайте все-таки здесь какой-то того добавим потому что ну как бы все таки отключать это полезно мы добавляем итогом такой в коде просто оборачиваем вовчик если у нас к и так он включен тогда мы делаем вызов если выключен не делаем слушайте а читать мы когда такой конфиг будем ну и наивный ответ что мы читаем его перед выкатки то есть мы выкатываем backend он подхватывает какие-то конфиге там типа стоит true все хорошо и тогда наши действия сводится к тому что мы первые меняем конфиг и второе перри выкатываем все это наше дело слушайте опере выходка вообще сколько будет идти ну вот у нас сервис прямо сейчас не работает он уже все там все забилось ну и мы такие посмотрели пять минут пять минут это еще хорошо если там какое-то такое крупненький монолит а сколько людей не уедет тогда помните там цифра до вначале вот и понятно что давайте-ка мы лучше здесь как-то runtime сделаем чтобы мы быстро смогли все это отключить и это первый паттерн паттерн который мы применяем называется backend конфиге нам нужно добиться такой ситуации чтобы мы могли вот такие параметры без перри выкатки в runtime за секунды менять и тогда все будет о'кей наши действия в этом случае сводится к тому что мы меняем просто конфиг и как только вот мы видим проблемы все поход отключается все хорошо backend скорее всего поднимется чтобы такой ситуации добиться нам достаточно просто поставить какой-то компонент это может быть поход в базу это может быть какой-то микро сервис если вы хотите распространить это на все но самое важное что нужно наладить какой-то sing здесь периодически ну и получать просто свеженькие конфиги и тогда опять же если у нас вот любая проблема возникает какие-то тайминги мы видим высокие еще что то мы от этого защищены мы просто сразу же отключаем поход и наш монолит наш расчет цен спасен и только после этого мы можем считать то что мы реально подумали как мы будем включать фичу нубы кэнди смотрите подход по наитию здесь не работает просто не подумать об этом может среди рить там что угодно и даже если есть какие-то конфиге файлики это тоже может быть не опция следующий вопрос который мы себе задаём сушите а как мы будем включать фичу в приложении и мы же подумали что мы на бэг-энде можем ее включаете в приложении там на мне и делать ничего не надо а а если бак а если бак мобильном приложении мы допустили и вот может ли быть такой баг который мы допускаем в мобильном приложении и вот нам ничего не помогает и даже в конфиге бэг-энде конечно же может быть баги вообще везде есть и вот например посмотрим на интеграцию которой случилось здесь вот у нас а очевидно есть какое-то поле поле кэшбэка которым расширилась наша фишка вот и мобильное приложение чтобы поддержать это поле то есть разработчики мобильных приложений они затеяли какой-то рефакторинг рефакторинг как это часто бывает при разработке то есть какой-то тех долг задача вроде просто я просто решили пофиксить и вот как как выглядела фишка то есть у нас есть просто новое поле кэшбэк в нем есть какая-то строчка строчка типа 150 кэшбэка все вроде бы ok но вообще-то кэшбэк бывает еще и дробный и вот об этом мы не подумали с мы проверили кэшбэк 0 мы проверили кэшбэк там супер огромное число но дробные числа мы не проверили и так случилось то что мобильное приложение внутри рефакторинг и ожидал то что мантисса и целая часть они будут отделяться запятой ну а пока сформировал точкой ну а поскольку эта функция парсинга цены кэшбэк цена и цена за тариф это тоже цена эта функция парсит вообще все и что у нас дальше происходит а дальше у нас случается ошибка парсинга то есть у нас мобильное приложение что отбрасывает все ответы которые есть и в принципе вообще ничего не работает для юзера это опять выглядит как ну он не может сказать такси дальше что происходит use же на верность и уехать на хочет он начинает вот так пин туда-сюда дергать если таких юзеров много то мы опять можем сложить кэшбэк и опять пойти по первому сценарию в общем что-то не очень хорошо получается и вот отключение на викенде ну вот отключим мы кэшбэк на бэг-энде ok но у нас же цена цена которая продолжит быть дробной то есть нам дробные цены нужно отключать получается нет но это уже не подходит . и давайте мы все таки делаем hotfix hotfix первое что приходит в голову слушайте а hotfix вообще когда в сторе будет и вот hotfix мобильного приложения вообще не тоже самое что hotfix а бэг-энда hotfix мобильного приложения это нужно пройти review review в apple store это могут быть дни там ребята еще на каникулы могут уйти тут уже совсем весело получается и очевидно то что мы не можем позволить себе здесь складываться на несколько дней поэтому давайте все таки тоже здесь какое-то табу предусмотрим чтобы все было окей опять завернем вы вчера вы вчера который будет проверять и на и болты ленина и болт и как-то эти углы будем собирать ну и вот как как как мы будем их собирать и наивный ответ опять же давайте как-то на старте приложения это будем делать то есть у нас на старте приложение будет and find какой-то или мы можем в существующей завернуть получить тогу ну а во время пользования приложения мы их не будем ни как обновлять ну потому что это как-то уже сложно начинается ну и тогда в принципе мы можем это отключить да то есть юзер он увидим что что у нас начинаются какие-то ошибки по какой-то метрики отключаем потом юзер перезапускает приложение и вроде бы все окей а пользователь ущерб перезапустит у нас то есть он же перезапустит наверное он знает что и наш об не работает перезапустит уже от другого такси зачем опять страдать вот и получается то что нам здесь нужен все таки какой то обновляем итогов давайте сделаем чтобы вот как в первом случае мы могли это быстренько сделать и а это второй паттерн который называется клиентские конфиге так же как и на бэг-энде нам важно на мобильном приложении добиться такой ситуации что мы можем быстро без перри выкатки очень там легко и на кнопку параметры фичи менять ну и отключать он шучу скорее всего та же как и в первом случае мы можем поставить здесь какой-то вот небольшой компонент конфигов скорее всего это будет какой-то штате пей-пей мы можем его полить если юзеров мало это будет норм может быть какой-то один секунд 1 секунды полинка же теперь сделать или даже websocket какой-то открыть в принципе есть еще второй вариант когда мы просто вот эти конфиге кладем в ответ и а фишки например прямо в расчет цен мы можем вот отдельным полем их положить это тоже будет окей вот и вот сделали мы такие конфиги и как мы будем дальше отключать вот у нас прямо сейчас есть проблема и вроде бы подумали что давайте вот просто вот хотя бы вот на всех отключим починим мы эту несчастную страну которая или там несколько стран который с дробными кэшбэка me и тут менеджер такой слышит наши разговоры прибегают слушайте у нас тут реклама в россии сейчас вся москва будет пестреть кэшбэком и давайте-ка мы все-таки чтобы вот миллионные штрафы рекламным площадкам не платить мы как все-таки россии не будем отключать но мы такие думаем о и понятно что нам недостаточно этого нам нужно что то еще и поэтому давайте мы еще предусмотрим здесь подключение по странам нам нужно научить вот эту штуку так чтобы она умела пользователя как-то из него выделять какие-то параметры то есть может быть пайпе может быть по локации и там разные есть методы выделять страну выделять какие-то еще параметры бизнеса ну и отключать по странам и тогда в принципе мы можем быстренько отключить по стране мобильное приложение то есть разработчики они вот сделают быстренько hotfix наверное быстро зальют его и в принципе все окей и потом вот когда они зальют менеджер такой прибегает говорит слушайте ребята hotfix готов давайте включать и вот здесь самое важное вот опять не попасться на эту уловку и не включить потому что если мы опять включаем опять случайно мы валимся где это вы сами понимаете да родовых данных там значительно больше чем тестовых мы просто не защищены не можем все обработать здесь нужно подумать еще раз и последнее чему мы хотим здесь научиться это научиться включать все это дело на процент то есть мы берём какую-то страну берем какой то регион не знаю еще что то пробуем включить на процент смотрим агатом один процент вот посмотрели вроде бы работает поехали дальше 10 процентов вроде бы ok а потом 20 процентов нет уже все плохо откат его брат и только тогда мы можем считать то что мы реально подумали как включать ее в приложении здесь также не работает подход прос ну не думать цена ошибки слишком велика вам не нужен неработающий сервис следующий вопрос а правильное ли место для интеграции мы вообще выбрали и правильно как быстрее ну конечно какой еще ответ может быть и правильно как быстрее это просто взять взять все монолитный backend расчет цен и положить сетевой запрос туда а что будет если у нас случится баг в интеграции бака в интеграции то есть вот здесь вот ну смотрите расчет цен это какой-то критический компонента вот мы уже два паттерна обсудили что делать чтобы он не ломался и если он ломается то выходит из строя вообще все а тут мы просто что-то кладем в него и не думаем что тут может произойти давайте посмотрим на пешку которая идет от микро сервисы кэшбэка вот она выглядит так у него есть в илью вылью в котором лежит кэшбэк и делитель что это такое это довольно распространенный кстати способ передачи дробных значений в опишите бессонов то есть мы берем какой то какой то кэшбэк ну да был умножаем его на какое-то там нужно 10000 если нам нужно 4 знака после запятой а потом вызывающей стороне делим это и поскольку у нас вот это вот величина то есть 4 знака после запятой два знака после запятой она может быть разная разная в зависимости от страны и там мы вот эту переменную величину также в протокол кладем но обращайте цен у нас такая как бы простая конструкция выходит мы просто как бы люди элем на делитель в принципе получаем кэшбэк си реализуемого в строку какие-то округления проводим и возвращаем мобильному приложению и вот так быть не должно но так случилось то что вот странно где у нас вообще нет кэшбэка вы все-таки сходили туда получили то что у нас ну кэшбэка нет но и делитель тоже 0 а что дальше дальше деление на ноль и вот что будет если деление на ноль случится ну тут зависит от языка конечно в каких-то прикольных языках будет просто exception division by zero где-то может быть убийство процесса по сигналу sexy по я сейчас вот сейчас многие скажут вот просто в питоне берешь оборачивались в тройке и вообще забиваешь на эту проблему ну и выйти правы но смотрите вы просто моделируйте ситуацию под себя то есть может быть ну какие еще баги может быть какие-то утечки памяти просто что-то кладете в лист забываете оттуда удалять и ну там будет какие-то а.м. поэтому да это точно проблема и какая цена у этой ошибки будет ну вот смотрите а мобильное приложение обычно как стучится в b к чешской это балансиры и у нас есть кое-то кластеры нот и в нормальном случае то есть мы но там делать которых half чек и поживы многом мы этот запрос распространяем и вот запрос пойдет на 1 убьет его потом на второй убьет его мы и так по всем придется мобиль напряжение быстро ли троит и убьет все убьет все что у нас есть если там будет о а м в принципе такая же ситуация будет окей а сколько restart займет вообще неважно сколько restart займет потому что мы рестарта нём ся и опять умрем и поэтому сушить и как-то вот расчет цен критичная штука давайте все таки как то может быть чоризо посмотрим на интеграцию и ok давайте делать через приложение тогда у нас интеграция вот немножко такая получается то есть мы уже не из расчета цен вот этот вот запрос в кэшбэк делаем а вот прямо из мобильного приложения и вот самый главный вопрос который здесь стоит а вот запрос добавить мобильное приложение это вот бесплатно то есть вот действительно ли нам это ничего не стоит и вот на самом деле нет если у нас много соседних запросов рядом то есть мобильное приложение она ходит в расчет цен она ходит в какие-то машинки на карте она ходит еще куда ты куда-то вот в кэшбэк начинает ходить у нас начинается конкуренция за сеть нигде не написано но мобильные клиенты а в http 11 допускает только четыре активных соединений а мы-то но вы знаете даже тебе один и так каждый запрос это открывается соединения новое и там все дела и вот вашти теперь 11 который кстати до сих пор довольно распространен вы можете сделать четыре параллельных запроса из там какой интерес приложения дефолта и получается то что если вот наш кэшбэк начинает тормозить мы тормозим какие-то соседние запросы ну четыре вот параллельных запроса расчет цен он может уже медленне выполняться и ну если мы тормозим расчет цен критичная штука это уже может влиять на метрики нашего бизнеса а это бизнесу не понравится и vod-ok http 2 и даже в http 2 у нас остается проблема headline блогинга на уровне тисе пи я здесь не буду подробно становится что это такое просто погуглите потом и даже если нас вообще не парит конкуренция за сеть то у нас все равно остается вот это вот и ппс богам в приложении когда мы что-то какую-то штуку допускаем которые мы не покрыли какими-то конфигами и нас опять ждет эпопея с перри выходками нас нас нас такой путь разработки не устраивает см и все-таки хотим как-то подумать как это делать через backend и про это 3 паттерн 3 паттерн выделение ядра нам нужно добиться такая ситуация что фича которую мы разрабатываем она вот никак на наше ядро не влияет вообще никак его не трогает ну и соответственно как следствие и как его не ломает что такое ядро что-то новое ядро это то что нужно для решения вот вашей базовой задачу без чего сервис вообще не работает мы с вами сейчас говорим про расчет цен понятно что там внутри могут дать киты баннерные крутилки какой-то маркетинг вот кэшбэке какие-то появляются вот это все не нужно для того чтобы просто уехать чтобы просто уехать нам нужно просто посчитать цену с этими ценами сделать заказ вот это ядро все остальное это не ядро и вот поскольку мы говорим про кэшбэк нам как бы кэшбэк нее дроном наверно нужно как-то его обойти что нам нужно сделать нам нужно вот разорвать связь разорвать связь между расчетам цен и кэшбэком ну и как следствие мы никак не будем трогать ядро ядро она работает и а на 2 месте назад работу кажется что все будет о'кей как это сделать мы можем сделать это введением 3 компонента который называется gateway и завернуть трафик так то что gateway ну мобильное приложение ходит где твой она даже не вот там никаких правок нибудь мы можем через всякий прокси просто роутинг так настроить а на выходе где твой дед рей будет ходить в расчет цен сначала или даже параллельно потом ходить в кэшбэк как-то компоновать ответ и все окей и на любые проблемы вот тайминги какие-то возникают какие там вот 0 и всякие деление на ноль мы просто отключаем кэшбэк и продолжаем работать без кэшбэка но цены считаем и поэтому наш сервис работает а где деленному на тут а почему gateway тогда не упадет логичный вопрос логичный вопрос кстати да есть 2 ответа даже если день твой упадет скорее всего вы сможете заработать трафик обратно в монолит и самое главное что вот он не упал же цены могут как-то считаться то есть они сейчас стабильны можно взорвать трафик это возможно будет даже быстро и второй ответ людей твои вообще-то не подделка вы скорее всего будете использовать его везде или это будет даже к это open source технология там уже сто раз эти проблемы решены поэтому просто можно даже забить и последний вопрос тогда остается а как выделить ядро ну и ответ такой просто не пишете код в ядро договоритесь с менеджером так чтобы вот слушай давай вот мы просто новые фичи будем вот вот этим вот новым подходом делать через gateway как-то это вот сначала чуть чуть дольше будет там может быть на недельку но это супер нас потом от всяких fa cup of защитит и ну если мы уже разумный он наверняка поймет и вот только теперь да мы можем сказать то что да мы подумали подумали как мы будем интегрировать то есть понятно что просто так делать как быстрее это вообще не всегда окей паттерн особенно если у вас там огромная нагрузка и супер критичная там вам критично всегда не падать и последний вопрос который мы себе задаём вот подумали ли мы а что если вообще все пойдет не так но опять же смотрите мы же не можем все подумать и поэтому нам нужно взять вот остановиться на чем-то и сказать у те и вот мы подумали вот про такие проблемы у три штуки мы взяли вот если дальше вот что-то идет не так у нас должно быть по это решение а что может пойти не так но интеграции у нас супер прямолинейная наверное вообще ничего не пойдет не так а суть а вот у нас там майские новые ввели предпраздничный день части на даче поедут и реклама реклама вся москва будет в кэшбэк ах что если все юзеры захотят резко воспользоваться нашей фичей резко уехать куда-то что будет к нам придет просто кратное число людей кратное число людей которому мы можем быть не готовы это будет какая то повышенная нагрузка и приведет она к нехватке ресурсов ну что делать когда у нас не хватает ресурсов очевидно масштабироваться но масштабирование процесс небыстрый особенно если у нас монолит там может быть десятки машин мы можем не успеть и сколько у нас будет downtime посчитали мы так бегло мы получается что вот мы там одну машину вводим из строя накатываем потом еще и вот так делаем там 50 раз и получается что вот дед все-таки пять минут мы полежим а сколько не уедет пользователей опять как-то много короче нас это не устраивает не устраивает потому что эта ситуация она может произойти когда угодно то есть она может в новый год произойти там вообще никого онлайн не будет нам нужна какая-то замена на время здесь и про этот четвертый паттерн называется fall back ядра нам нужно чтобы отказ нашего критического компонента скорее всего только критического вообще не приводил к отказу сервис у нас там может быть много критических компонентов нам нужно какое-то замена на время то есть вот у нас есть расчет цен нам нужен какой-то расчет цен который мы назовем fall back что такое fall back fall back это деградация расчета цен а мы можем не группировать тарифы это может быть какой-то сетевой запрос запрос в базу может быть сложный конечно же мы можем не считать кэшбэке вообще еще много чего не считать и мы можем считать цену от там 199 рублей это может сократить на десятки походов в различные базы и микро сервисы и вообще сделают жизнь намного проще ну а уехать все равно будет можно про то как можно деградировать есть доклад от ильи сидорова классный из нашей компании грейс пул degradation называется там презентация будет можно посмотреть итак флп hydra то есть у нас появляется какой-то такой блок расчет цен fall back и это вот отдельной http and point то есть мы просто берем и дублируем наш расчет цен наверно прям заново код можем написать в нем просто чтобы было понадежней там не использовать жареный год и поставим его прям отдельно от нашего монолита потому что если мы в нем его положим понятно да там монолит выходит по ресурсам от fall back там особо смысла никакого нет и как будем ходить вот из приложения не из приложения и вот из приложения ходить не надо во первых флп эти бывают многоуровневые а во-вторых приложение вообще ничего не должно знать проект то есть она там одинаковая пешка будет в response и просто она вот как ходит так и ходит пускай и в какой-то там а трафик мы сами завернем как завернем давайте использовать действий из предыдущего паттерна и в нем мы просто положим новый расчет цен и будем говорить там если все хорошо мы ходим вот сейчас в нормальный расчет цен если все плохо то давайте мы все таки вот в fall back сходим и даже если у нас там все супер там корректно написано нет зависимости по данным никакие мы еще можем кэшбэк даже вот fall back прикрутить как переключать как переключать вообще это отдельная эта тема для отдельного доклада там очень много всяких нюансов но если коротко то это статистика то есть мы считаем статистику и если процент там не ответов превышает какой-то порог то мы переключаем трафик из одного места в другое а тут важно отметить то что в любой системе всегда есть фон каких-то ошибок там чтобы не случилось может быть какие-то клиенты плохие могут быть какие-то тайм-аут и и поэтому считать нужно вот брать какое-то скользящее окно то есть мы берем считаем там ага за минуту инкрементируем типа пришло там 1000 событий из них пришло там 800 200 aw 200 500 и там смотрим какой процент если процент большой переключаем ну можно взять там 50 процентов 30 процентов тут уже зависит от потребностей насколько вот эта штука критично для бизнеса и последний вопрос который остается слушайте вот сделали мы fall back он вообще выдержит вот почему вы думаю что он выдержит и он выдержит потому что он скорее всего делает там какие-то 10 процентов от работы мы там сократили вот вырезали все запросы все походы в базу и поэтому вот все все что выбирает обычно до циpкa делать десять процентов от работы значит мы можем просто накинуть ему столько ресурсов и даже микро сервис чтобы он какую-то 10 кратную нагрузку держал это окей но скажите вывод будут же уго у вас тогда ресурсы ресурсы которые не утилизируется они просто ждут своего часа до так и будет страховка за страховку надо платить возможно вы когда случится какой-то реально там крупный факап в эти деньги еще сто раз окупите так что все окей и вот теперь да теперь мы можем сказать что все мы реально постелили соломки где нам нужно и уверен это что мы там какой-то новый год в принципе без боли можем пережить итоги итак я показал вам вот на примере на примере простой прямолинейной фичи вот кэшбэк просто взять добавить информацию о том сколько кэшбэка будет начислено за какой-то тариф в приложении вот что это стоит и вот она вот она продуктовая разработка это не просто взять и написать код это подумать как там еще кучу всего не сломать там нюансов полно вот то что мы сейчас обсудили это реально там где-то 30 процентов как включать фичу как выключать место для интеграции а я предлагаю вам вот эти вот вопрос и вот эти вот вопросы прямо на вооружение взять тоже думать и ответами на эти вопросы могут быть паттерны backend конфиге мы обсудили это вот когда вы фичу можете включать и выключать в рандами без перри выходки бэг-энда клиентские конфиге то же самое в мобильном приложении выделения ядра это когда вот у нас что то работает критичная мы работает не трогай делаем рядышком и fall back ядра когда вот если все-таки нужна какая-то соломка вот она у нас есть и заключение хочу сказать что ну вот мы сейчас рассмотрели вот прямолинейную фичу которая занимается вот чтение а есть еще запись есть еще какие то там задачи где мы должны например куда-то записать как b и там начинается все намного веселее там уже гоночки там уже и дым полезность и вот эта вот было только верхушка айсберга верхушка того о чем нам нужно думать дальше будет только веселее я желаю вам своих архитектурах все так проектировать чтобы вы пережили не один год и не один факов удачи друзья максим спасибо огромное у меня есть еще один слайд я знаю то что кто-то мог залипнуть поэтому я сделал свою презентацию отказоустойчивый к таким вещам и вот вам fall back презентации давайте закидаем максима вопросами у нас есть на это действенно смотрите там мужчина прыгает прямо хорошо максим спасибо за доклад у меня есть в тему истории жизни в ту ночь когда приложение яндекс такси превратилась приложение яндекс google моем телефоне я изрядно пьяный вышел из бака и хотел поехать домой и когда открыл приложение все что я увидел это только карта города что что что когда я открыл приложение к только вот в этот момент так решила превратиться в яндекс гол я увидел только карту города без интерфейса вызова в такси и без ничего вот и в связи с этим вопрос зачем нужно было так такое рисковано изменение вообще поменять каир функционал вызова такси на такси и тыкает и да и все остальное сушки это прикольный вопрос но к сожалению я не знаю ответа на него вы можете наверно спросить нашу службу pr и я здесь больше вот про техническую часть понял как готовится неудобные вопросы откидывать вот отлично отлично следующий андрей кузнецов на классники максим спасибо большое за отличный доклад у меня такой вопрос больше по окончании презентации по поводу fall back ядра очевидно что вот этот большой сложный сервис который считает цены он оптимизирует каким-то образом денежки вот и дает возможность побольше заработать когда мы падаем на fall back там более простая штука которая точно будет денежки терять вы как нибудь читали вот этот эффект падение на fall back сколько вы теряете как вы оптимизировали сложность впк для того чтобы поменьше терять случае падения на него да спасибо за вопрос я сейчас подумаю но во первых тут смотрите надо моделировать ситуацию под себя я честно ну вот pricing да это какая-то отдельная команда и я не могу сказать что там какой-то какая-то оптимизация есть денег я просто не знаю этого и если мы вообще нет не даем делать заказ то понятно что мы вот просто эти деньги теряем если мы даем делать заказ там и хотя бы что-то зарабатываем эффект я не считал и не знаю может быть кто-то считал сложно сказать спасибо добрый день спасибо за доклад а почему в этой схеме не тупо тестирования она у вас вообще есть смешно группа тестирование конечно же есть но это же не отменяет того что разработчик тоже должен думать о чем-то мы же разработчики мы должны все это наперед думать и поэтому чем больше разработчик подумает тем меньше работы будет у тестирование и она сможет сфокусироваться на реально каких-то там более заковыристых вещах если мы можем освободить давайте освободим это же круто здравствуйте максим меня зовут сергей озон спасибо за доклад у меня такой вопрос скажите а в случае когда вы переключаетесь на fall back вы предусматриваете какую-то обратную связь для пользователей потому что буквально вот две недели назад видимо случилась ситуация которую вы говорили когда в приложение яндекс такси было не конкретно сына написано от вот и на самом деле в коммюнике началось прям бурление потому что люди подумали что это новая фича ну клиенты начали сразу говорить что вот яндекс все сломал все очень плохо таксиста конечно обрадовались потому что наконец-то мы посчитаемся с этими там дизайне щи бродами как они говорят вот вы как-то вообще предусматривать возможность оповещать клиентов что это вот временные проблемы и вы их планируете решать слушайте вы абсолютно правы нужно обязательно коммуницировать пользователям о том что сейчас проблемы и я думаю то что мы будем работать над этим ну то есть я согласен абсолютно типа это обязательно надо делать вот я не вижу вон здесь мы групп вот смотри добрый день спасибо за доклад меня зовут дмитрий вы предлагаете использовать год битвой вместо монолита уже на вот этой простой схеме через год вы идут три обращения к монолиту callback у и к сервису кэша если эту схему немного утяжелить то получится что ветвей превращается в тот же самый монолит с бизнес-логика и со всеми фичами там плюшками как потом бороться с этим есть разница когда мы делаем вот это все то есть вся вся разработка у нас идет через наш монолит то там скорее всего вот какие то разработчики они вот-вот на коленке делают какие-то сетевые походы и возможно они не обернут все в нужные там iv чеки в нужные проверки gate вы и теперь праге твой а мы заранее дизайном эту штуку так чтобы она большинство проверок сделала то есть там и вот какая то статистика может быть там и отключение при любых проблемах там и тайминги то есть вот это вот автоматизация каких-то and проверок это вот вот этот выигрыш-выигрыш который нам нужно далее здесь отбросит лего когда 5 микрофонов она с распределенные вычисления вот под фонарем прям как вы максим привет александр самокат спасибо за доклад очень клёво интересно мне прям три коротких вопросов 1 мы тоже используем печатал глинкой на клиенте и на бренде а но это приводит к тому что сложность тестирования она возрастает на тоже просто комбинаторная задача данного проверит все варианты приключения вы как с этим боретесь что вы с этим делаете или как вообще от тестируйте комбинаторную сложность да вообще честно говоря по моему по моему мы боремся с этим тем что просто тестируем все старые флаги выпиливаем типа того просто мы как-то контролируем это тем что мы удаляем старые неиспользуемой фичи и второй вопрос вы пошли в сторону того что вы пилите какие-то фабрики на критичная операции на но и как 21 веке всей сторону того чтобы масштабировать свои сервисы в момент нагрузки добротном губернии tissot все это вся эта история позволяет поднимать сервисы тот момент когда тратит приходит расскажи пожалуйста почему вы пошли в сторону fall back of any в эту сторону ну смотри мы в принципе готова масштабироваться и мы так и делаем но начиная с определенного момента у тебя просто вот это вот время которые ты будешь в downtime пока там масштабируемся ты можешь быть down тайме и вот начиная с определенного момента это время критично и поэтому там да даже минута может быть проблемой поэтому начиная с определенного уровня роста бизнеса мы готовы тратить ресурсы на то чтобы постелить соломку даже здесь спасибо за доклад повелся инструменты вопрос такой сколько вы можете жить на fall back если ну регламентирована время сбоку сколько быть поднимать сервис искусства с целым downtime смотрите здесь есть 2 ответа первый на фалда как можно жить бесконечно по нему потому что они просто позволяют уехать и второе фабрики надо чинить как можно быстрее и да мы это делаем если у нас включается вот эта штука то есть любая там на новый год вот на новый год все просыпаются начинают чинить эту что это ненормально это надо быстро исправлять но в целом можно жить на этом долго но то есть к вам бизнес не придет скажет скажет давайте быстрым как бы ну есть 5 минут чтобы все было смотрите про тут не бизнес тут мы сами получаем мониторинге мы же ответственные разработчики хотим все быстро починить спасибо так давайте первые ряды не обижать третья битва за вопрос спасибо очень интересный доклад максим вопрос такой а как по синхронизируйте ядра да да да я понимаю вот это кстати классный вопрос то есть реально нужно тестировать и если fall back включается редко он действительно может немножко отойти есть ну вот расчет цен может быть как стабильная штука но все равно вот там пару раз в год в нем что-то вносится и надо тестировать недавно прям совсем буквально мы сделали такую штуку как хаос инжиниринг и хотим уже так делаем включаем на какой-то процент пока сотрудников тестируем на самих себя так спасибо большое за доклад легче найдено компании atlas доклад прекрасной отличные демонстрации последовательного применения здравого смысла она тоже здравый смысл диктует что в общем если как бы количество микро сервисов которые реализуют новые фичи будет расти ту рано или поздно вред от них превысит пользу слишком много коммуникации вопрос такой вот фичи остаются реализованные таким образом навсегда или не иногда вы их иммигрируете снова в монолит да вы правы действительно микро сервисов если их очень много это вредно вообще лично думаю то что в целом в монолите нет особых проблем если его правильно готовить они там позже начинаются прямо если вы стартап начинать точно нужно с монолитом вопрос про то переносим ли мы фичи обратно из микро сервисов монолит вообще так не делаем ну по крайней мере я в своей практике такого не встречал но возможно если там какой-то крупный сервис ну из микро сервисов giga сервис вырастет наверное что то придется думать я в целом не хотел бы портить микро сервисную на архитектуру финальный вопрос из зала и потом пойдем у меня вопрос тоже пропал бег похоже с предыдущей вопросам то их немножко нюанс если вам никто не говорит вернуться с fall back at a как вы принимаете решение что уже пора фабрика перейти восстановлена лид и чтобы при переходе вы его снова не положите брата не придется вернуться fall back то есть как вы рассчитываете этот момент я правильно понял вопрос что если fall back долго не отключается что делать можно микрофон как вы решаете тот момент уже пора переключит столбика что при переключении мы снова не положите основной сервис вот как мужчина в этот момент да да да я понял это статистика вот я говорил там есть как скользящее окно типа вот мы берем две минуты в нем накапливаем события и если ну вот там 1 2 минуты потом опять две минуты потом следующие 2 минуты и вот когда ты будут две минуты в которых там процент 5 соток меньше чем наш порог и мы можем начать плавно наливать трафик или резко работает ну в распределенных системах всегда что-то будет параллельно работать это да"
}