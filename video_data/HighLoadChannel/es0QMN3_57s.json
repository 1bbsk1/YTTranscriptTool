{
  "video_id": "es0QMN3_57s",
  "channel": "HighLoadChannel",
  "title": "Всё, везде и сразу: трейсинг в условиях хайлоада и 10к бэкендов / Александр Кирсанов (VK)",
  "views": 911,
  "duration": 3243,
  "published": "2024-04-17T01:09:18-07:00",
  "text": "это наш монолит огромный сложный PHP родной у Монолита есть порождение велосипеды все знают что у нас ВК много велосипедов мы пишем свои базы данных мы пишем свой сетевой протокол у нас даже компилятор свой можно считать что это все такое один большой огромный велосипед для того чтобы ВК работал кто-то посмеивается над этим кто-то уважительно кивает головой но все об этом знают и все всегда спрашивают почему почему они всегда пишут свои велосипеды Почему им не живется как нормальным людям почему они не могут взять нормальную обычную технологию Также как все использовать ее радоваться нет вечно сидят кидали там что-то мы с вами посмотрим в котором мы разлучим Монолит с велосипедами вместо них Мы возьмем стандартную вещь мы попробуем использовать ее мы будем перемещаться по вселенным мы будем брать разные идеи навыки мы будем бороться с трудностями и увидим суждено ли им все-таки в конце оказаться вместе а теперь Play у нас куча бумажек это данные ори квестах наших пользователей очень много всего на какие серваки Они заходили что там с памятью Что там со всякими метриками где Какие запросы ходили сейчас хаос Мы хотим как-то это дело привести в порядок Чтобы не искать вручную Если что-то идет не так при каких-то неполадках быстро находить нужно нам информацию хотим этот сложить куда-то сложить что нам будет давать весь путь запросов нужных условиях и так далее есть стандартное решение Для этого называется трейсинг вот те самые как это в принципе работает Давайте посмотрим как это крутится на обычных бэкендах мы пишем какой-то код для того чтобы по нему рисовались картинки мы его размечаем с панами что спанд начался спам закончился который в итоге горизонтальные полоски становятся этим спадом мы можем добавлять различные атрибуты можем писать атрибуты какие-нибудь можем какие-то логи писать туда чаще всего это playing текст потому что там никакой структуры нет внутри В итоге каждый спад превращается в такой огромный по сути джейсончик там есть куча сервисной информации того что мы не писали что система сама собирает то что мы туда записали и так далее один спанджи сонник второй сонник все что мы создали получается такие огромные вещи работают посылают друг другу запросы микросервисные архитектура там все дела каждый из них пишет свои собственные такие трейсики и потом это все сливается Джаггер и в этот джаггере мы уже можем смотреть Что происходило как происходило когда и прочее отлично индустрия уже все придумала нам не нужны наши велосипеды мы будем использовать стандартные вещи от велосипедов откажемся и пойдем относить наш ворах данных в Джаггер впрочем что это я текстом пойдем относить весь на сворах данных в Джаггер Давайте детально разберемся все-таки что мы туда принесли что мы от него хотим и какие у нас требования Джаггер в целом он рассчитан примерно средние нагрузки около 100 спанов на рейс потому что зачем больше и оперирует и форматом такой стандартный фактор для описания различных процессов и состояний что мы хотим относительно него во-первых У нас очень много квестов очень много в принципе запросов к нам полтора миллиона запросов в секунду нашу фишку каждый запрос когда мы обрабатываем мы делаем очень много сабрик квестов в разные наших движки базы данных и так далее и хотим мы иметь информации при этом больше чем опыт телеметрия Что значит больше чем опыт телеметрии это вот те самые джейсончики которые были такие желтые Они и так содержат много всего Но мы хотим еще больше к примеру Мы хотим знать все про память где она выделялась где освобождалась мы хотим знать все про всякие разные запросы наши движки про то как переключаясь корутины насколько параллелен Мы хотим знать про сетевое ожидание сколько мы стоим насколько мы эффективны и так далее каждый из этих пунктов он несет какую-то определенную когнитивную нагрузку к примеру Мы хотим замерить сколько мы съели памяти Казалось бы чего проще вот мы начинаем память заканчиваем память разница между ними это сколько мы съели что еще может быть проще А вот нет Если у нас человек делает так уже нельзя вот как в гой например Сделано в город Там есть гарутины Green Trade что управление переключается с одного потока на другой Точнее с одного витрина другой или в not GS точно так же там один поток на самом деле какая-то функция выполняется потом ушла в диск или ушла в сеть начал выполняться другая третья у нас допустим runtime Точно также и поэтому уже нельзя точнее если мы замерим память в начале память в конце вычтем уже получится не то потому что между началом и концом какие-то еще другие работы испаны а мы хотим именно понимать замерять нужную нам память или к примеру те же самые запросы движки наш Монолит Делает очень много запросов Мы опять-таки хотим померить иметь какую-то по ним информацию Если мы возьмем просто функцию которая делает запрос какой-то обобщенную точку входа для всех и попробуем создать в начале завершить в конце у нас получится очень много коротких планов выглядит примерно вот так совершенно не нужная информация Гигантское количество экранов по вертикали а чего мы хотим на самом деле на самом деле мы хотим по каждому скажем так пользовательскому логическому спауну иметь всю информацию всю агрегацию потому сколько мы ходили в нем кэш сколько мы ходили там в движок друзей движок стены и так далее сколько мы байт скачали сколько мы байт отправили вместо того чтобы иметь каждый спал отдельно В общем с такими требованиями мы приходим говорим мы хотим Вот это Джаггер нам отвечает Какая нафиг память какая блин асинхронность что еще за агрегаты У меня есть стандартный формат симметрии Я ничего другого не принимаю вот идите ваши данные перерабатываете приносите мне уже готовые в моем формате вот тогда мы с вами поговорим Окей у нас был опыт расширить то есть условно говоря от наследоваться добавить все что нам нужно проплавить добавить все что нам нужно про запросы А поскольку мы хотим видеть разные скажем так группировку это должны быть папы мапы с разными срезами про всякие картины сеть и прочее куда влезть его пантиметре но поскольку у них формат специфицирован попробуем влезть куда-нибудь в атрибуты писать текст что-то там хранить нужном виде в памяти потом подлазить в атрибуты это как-то превращать что еще есть устроены примерно следующим образом что ты вначале запроса подбрасываешь монетку и в какой-то вероятностью этот запрос трейсишь Тебе же не надо тратить все подряд одна тысячная Значит каждый тысячный запрос три месяца Все остальные просто выкидываются я считаю что так делать нельзя Это вообще неправильно нельзя такого допускать потому что на старте запроса Мы еще про него ничего не знаем мы только к концу запроса можем узнать что-то интересное к примеру о сообщении отправлялось 5 секунд это интересно хотим сохранить или о скриптах ел там 400 метров памяти это интересно хотим сохранить и так далее То есть мы на самом деле хотим трейсить абсолютно каждый запрос полностью сначала и полностью до конца и только если он войдет какое-то состояние интересное тогда сохранить но чтобы его сохранить нам надо иметь весь его путь уже на тот момент в памяти поэтому третьем абсолютно все абсолютно каждый если расширить Если трестить каждый запрос и трейсить этот джаггерскому формату мы получим примерно такой оверхед примерно 4 процента оверхеда по времени по времени CPU и примерно на каждые 100 выделенных мегабайт памяти 5 мегабайт дополнительно к этому на сервисную такую бесконечных таблиц и так далее делают так Что же делать а может быть нам начать предпринимать какие-нибудь странные действия ведь Давайте подумаем Почему Почему есть Джаггер Почему есть опыт телеметрии Почему они есть в таком виде потому что в нашей Вселенной эволюция сложилась таким образом что что это привело именно к таким обстоятельствам именно к такому Джаггер именно к такому телеметрия возможно каких-то вселенных пытаясь вход где-нибудь совсем рядом эволюция сложилась по-другому и там другие технологии там что-то произошло иначе Возможно есть какой-то к примеру Альфа мир где живут лучшие инженеры где они придумали что-то совершенно другое Возможно они смогут нам открыть какие-то порталы или трамплины чтобы мы побегали по разным вселенным без оглядки на то что у нас есть здесь и сейчас Попробуем перенять все лучшие идеи и навыки из других вселенных у нас получится примерно следующее вот смотрите леметрии формат span который мы пытались расширять мы же хотим сохранить много мы попытались расширять давайте сделаем вообще не так мы его не будем расширять моего сузим оставим Там просто одно поле просто число по найди и все ничего больше вместо этого сделаем Open Clock мы будем в лог писать информацию о том что происходит когда мы исполняем код мы пишем что-то влог примеру мы создаем спам значит генерируем ему айтишник один и пишем влог создан спам с айтишником один таким-то названием когда-то потом к примеру представим его в ходе атрибут опишем блок на самом деле что этому присвоен такой атрибут с каким-то значением завершаем спам Окей к примеру из какого-нибудь бинарного мира где более пол имеет только два значения мы можем перенять идею бинарных данных мы можем складывать данные в бинарном виде и у каждого события которое происходит например создания спана есть какой-то обход какой-то просто один байт мы пишем Этот один байт и какие-то данные в бинарном виде точно также добавляем атрибут это другой обход другие данные и в итоге у нас получится такой длинный бинок который на самом деле содержит процесс того как наша система развивалась события данные события данные никакого состояния мы не храним и вот если у нас есть вторая сторона которая умеет читать этот белок и умеет его как бы перепроигрывать у себя перепроигрывать развитие нашей системы и эмулировать его тогда вот это читающая сторона уже может вычислять вычислять все аишники вычислять память и так далее потому что состояние на самом деле нам не нужно хранить вообще не нужно хранить наша цель его получить в конце его можно вычислить если мы будем писать любое событие все что происходит с системой тогда все вычисляется белок начало спанов конец планов значит для любого момента времени мы можем вычислять активный исполнены мы можем вычислять родителей испанов и прочее к примеру мы будем писать Туда иногда состояние памяти значит по крайней мере в однопоточном режиме мы можем на любой момент времени сказать какой испан Сколько памяти от ел мы будем Туда писать примеру переключение в сеть и обратно Значит мы можем вычислить сколько и как он какой спам провел в сети суммировать это время мы будем Туда писать переключение корутин А значит у нас есть уже все метрики с учетом с учетом асинхронности потому что и память и запросы и прочим мы можем уже трекать с учетом того что рутины меняется между собой любые внешние запросы любые локации любой файловое взаимодействие Все что нас интересует мы пишем в белок и потом это дело можем перепроиграть все что угодно не привязываясь к тому что мы хотим получить в итоге на картинках и эта информация значительно богаче чем в целом стандартные подходы можно упаковывать и можно придумать какие-то способы чтобы это было по компактнее эту этот навык можем получить из мира где еще не закрыли и там до сих пор существует люди способные упаковать всю квартиру в одну тележку в течение жизни процесса спаны постоянно создаются закрываются потому что мы обрабатываем примерно одни и те же запросы значит они создаются с одними именами мы добавляем атрибуты с одними теми же именами чтобы не копировать строки эти постоянно мы можем ввести словарик один раз при встрече новой строки зарегистрировать их получать просто индекс и потом просто обмениваться числовыми индексами даже не копируя строки к примеру с тем же самым временем стампами какие-нибудь что Обычно такие длинные числа если нам нужна точность микросекундная это реально длинные числа но мы можем один раз примеру в начале запроса фиксировать длинный танк а потом просто оперировать смещение и вот эти смещение уже укладываются намного меньшее количество байт и в итоге мы переходим примерно к следующему следующему взаимодействия что у нас нет никакого состояния что у нас есть просто спас айтишником ему можно туда только писать мы можем добавлять атрибуты но мы не можем никакой атрибут получить можем спам закончить но мы даже не знаем закончен ли он это все мы знаем только на принимающей стороне А наших которые это все дело пишут Нам ничего вычислять и ничего хранить вообще не нужно так Фух вроде как все раскидали совсем справились где-то рядышком из очень немножко параллельной вселенной нам все-таки напоминают Что окей что-то вы там придумываете А как вы вообще будете это приземлять как вы вообще будете это то что вы там пытаетесь придумать дружить с вашими текущими технологиями дружить с вашим текущим языком дружить с вашими ран-таймами и прочее Давайте вспомним о чем написано ВКонтакте Ой что-то мы это переместились во вселенную где ВКонтакте на Джаве написано немножко не туда это уже правильный мир это наш ВКонтакте написано КПП это тот самый наш язык который превращает весь наш огромный пока пышный Монолит автоген ускоряя тем самым в разы десятки раз и поскольку это язык наш компилятор наш мы можем модифицировать его под себя мы можем делать там то что мы сами захотим к примеру в обычном PHP как и в другом любом другом языке мы бы писали мы бы создавали спаны завершали бы их вручную А поскольку у нас язык свой компилятор свой мы можем просто сделать раз аннотацию написала функции компилятор сам тебе вставил начала сам придумал имя сам во всех точках завершения этой функции вставил конец более того как мы нигде не можем сделать ни в каком языке а здесь поскольку у нас свой язык наш компилятор мы можем сделать так что мы написали функцию Мы хотим ее трейсить компилятор видят что из этой функции вызываются другие строят Граф и прямо из неё различает все подвызовы и таким образом мы с финальном трейсе будем видеть не просто саму функцию и все под вызовы из нее тоже исследовать на по каждому под вызову все метрики необходимые нам более того компилятор может вполне понимать что эта функция достаточно большая или к примеру брать все функции брать там топ 5 процентов самых больших по объему и автоматически навешивает над ними трейсинг и разработчикам Бендером в большинстве случаев просто вообще ничего не нужно делать потому что компилятор и стат за них сам на момент компиляции все расставил это так офигительно иметь свой компилятор мы можем делать там все что захотим вообще все вот к примеру у нас как и у всех многоязычные сайты многоязычные ресурсы когда мы пишем многоязычные приложения понятное дело мы не используем строчки по-русски строчки по-английски мы вместо этого У нас есть какие-то отдельные переводы по ключам мы на них только ссылаемся к примеру это может быть функция там Ланг по ключу который на текущем языке пользователя подставит нужное значение русский английский испанский все дела ведь лонги встречаются по всему коду и к примеру что если мы хотим замерить сколько мы тратим вообще время на функцию Long она исполняется очень много раз как и в случае запросами мы не можем взять и вставить спам потому что их будет десятки тысяч на запрос Зато от свой компилятор мы можем сделать вот так можем написать и вместо того чтобы представлять спаны горизонтальными он их будет агрегировать вертикальными срезами и мы на пересечении горизонтали и вертикалей будем получать все необходимые метрики сколько мы в каждом пользовательском Испании вызвали лонгов вызвали кто исполняли регулярок и так далее и более того это там хитрее плюсовые конструкции превращаются для того чтобы продакшн не ответить когда это дело не используется Потому что когда у тебя десятки тысяч вызовов на один скрипт тебе надо это делать очень аккуратно А мы это дело понятное дело скрываем от разработчика поскольку у нас свой компилятор в общем рад был вам представить наших героев Trace Trace это не состояние это процесс потому что состояние оно вычислимо на любой момент времени по факту если взять Джаггер и то что он делает у нас есть все то же самое только только мы его можем за playbaчить на любой момент времени мы в любой момент времени знаем состояние системы Можем по факту сделать ползунок и смотреть как система развивалась как рождались умирались пары рождались умирали карутины как выделялась память и так далее Мы научились все а сейчас научимся это делать везде У нас очень много бэндов у нас примерно 10 тысяч серверов которые работают на КПП У нас очень много движков которые мы делаем запросы И что если мы хотим к примеру научить наши движки тоже писать какие-то трейсы как это дело совмещать как это в принципе дело совмещать с учетом того что мы придумали как это все сделать единым целым смотрите что мы будем делать у нас приходит запрос в КПП в веркер он начинает писать Trace Din Lock на момент записи он придумывает какой-то айдишник крейса тоже его пишут белок Понятное дело и когда веркер допустим делает запрос по РПЦ какой-нибудь движок сообщений для этого запроса он придумывает уникальный какое-то число 4 байтовое он посылает фишку сообщений айтишник трейса и уникальное число движок сообщений тоже начинает писать трейс winlock свой имея уникальное число потом делается еще один запрос другой движок другой уникальное число и в принципе любые запросы предположении что приемник тоже умеет писать трейсы и тоже понимает этот формат и придерживается его приемники тоже пишут свои части трейсов А сам Trace выходят это такая распределенная штука доступная внешнему наблюдателю и получается что еще раз надо понять Надо формировать терминологию трейс это какая-то распределенная штука по всем бэкендам сразу каждый процесс пишет свой участочек трейса каждый участок трейса состоит из Панов Давайте придумаем терминологию для этого дела испан с атрибутами где мы уже видели спам с атрибутами где мы каждый день видим спонсотрибутами правильно HTML а если мы пишем с планы куда с паны вкладываются это же Логично в дневнике ядер на самом деле я забыл вам сказать вначале я 15 лет писал в контент 15 лет и не в другой Вселенной вот в этой Вселенной просто 2006 года каждый день каждый день с утра до вечера занимался 5 лет подряд каждое утро абсолютно каждое я Вставал я заходил на Лайф интернет смотрел статистику использования браузеров я ждал Я ждал когда же наконец интернет Explorer 6 станет достаточно популярным для того чтобы перестать писать костыли в верстки для других браузеров для E3 Firefox 1 и так далее В общем я занимался очень много лет поэтому фронтетические знания нам помогают мне лично помогают придумывать терминологию получается что спаны с атрибутами это участок дивы это сами участки А трейс это по факту Бодя по факту полное состояние системы То есть каждый процесс пишет дивник состоящий из Панов в данном случае нарисовано что это начинает писать КПП веркер Но на самом деле ничего нам не мешает взять и рутом трейса считать примеру мобилку он тоже пишет свой дивник посылает запрос на сервер он становится просто обычным потребителем который пишет обычный денег это все обобщается И вот тогда вот эту распределенную вещь независимо от каждых узлов мы можем сохранять в базу мы поняли как это распространить вообще на все осталось только понять Как это хранить у нас бен-логе бинарные данные как вообще их можно хранить как вообще по ним можно искать и что-нибудь находить интересующие Давайте вспомним зачем мы вообще вот это все придумывали у нас изначально была цель иметь память иметь РПЦ запросы иметь там сколько рутин запущено агрегаты какие-то и так далее поэтому бинлогу это все можно вычислить то есть мы можем вычислить это все мы можем добавить туда то что писал пользователь и уже бинок плюс вычисленные данные заранее проиндексированные вот уже их сохранить в базу и уже по ним искать ровно потому что мы вычислили нет какого-то волшебного поиска по любым бинарным данным чтобы там сказать Я хочу найти который бы был вложен в какой-нибудь там такой паттерн нет ровно то что мы посчитали ровно поэтому мы можем искать никакого волшебства волшебства не бывает сколько ты не бейся от чего-то тебе придется отказываться Я считаю на самом деле что это хорошо что детерминированность и отсутствие волшебства Это очень хорошо потому что Как сказано пацанских цитатах жизнь волка если предпочитаю видеть только хорошее это не значит что я наивный это стратегия и так мы можем уже заглянуть структуру нашей базы которая предельно проста на самом деле одна табличка что самое главное мы туда сгоняем бензок для того чтобы прочитать восстановить все И заранее проиндексированные данные кивали отдельно числа отдельно строки отдельно там другие типы данных поэтому можем искать это мы можем выводить как-то раз мы решили сделать рейтинг совсем все пользовательские заголовки из интернета старые школьные алгоритмы числа строки но не случился коллапс потому что на самом деле сюда нам нужно сохранять только то что нам Интересно нам не нужно сюда сохранять миллиарды трейсов нам не нужно видеть миллиарды одинаковых трейсов мы туда хотим сохранять только то что Что представляет какой-то интерес разнообразие репрезентативность И на самом деле исключительно потому что у нас монолит у нас достаточно всей информации на одной ноте для того чтобы вытащить её и понять нуждается связь сохранения или нет трейсинг в памяти каждый запрос абсолютно каждый благодаря малолитности сохраняем только то что нужно Мы научились все научились это делать везде Давайте посмотрим как теперь все вместе сразу все наши чеки Мы научились складывать в Пилот их отправлять в базу Я же франкендер я написал для этого дело ua выглядит она примерно так туда выводится все Троицы нас интересующие там есть поиск выводится такое самари по каждому то куда надо смотреть глазами самое интересное то когда что-то идет не так надо смотреть именно туда куда же выводится все что записал пользователь все что мы заранее проиндексировали даже выводится все что мы автоматически посчитали все про память все про запросы все про корутины и про всякие разные технические метрики то изначально вообще зачем мы все это придумали там есть поиск который на самом деле очень клевый потому что мы можем искать по всему мы заранее предрасчитываем индексируем все что можно поэтому делаю ищем по любым пользовательским атрибутом по любым автопосчетам атрибутом с учетом различных операторов и так далее значительно богаче Чем это можно делать Просто стандартный интерфейс Джаггера потому что у нас есть намного больше И посчитали мы заранее намного больше более того даже удалось модифицировать то что вы видите сейчас это действительно это похоже на Джаггер И на самом деле это он но это не Джаггер удалось оттуда выдернуть просто ее Айку и перенаправить ее в наш бэкент наш бэкенд по протоколу который ждет Джаггер отвечает теми данными которые нам нужно поэтому то что рисуется здесь это не хранится джаггере это хранится у нас в нашей базе а значит мы можем выводить туда восстанавливаясь все что нам нужно все агрегаты все запросы все про память стандартный интерфейс и там тоже есть над этим интерфейсом надстройки Потому что если подумать то картина Которую мы должны видеть картина как развивалась система это же не статичная штука примеру Мы можем поставить галочку смотреть как рождались умирали каротины к примеру мы можем выводить туда отдельно длинные запросы в виде спанов самое интересное Наверное это вот какие-нибудь такие вещи вот взять к примеру память память это аддитивная Метрика какой-то Спан сколько съел памяти столько сколько Все его дети + он сам сколько он сделал запросов сколько Все его дети плюс он сам поэтому по умолчанию физионные метрики конечно складываются но мы можем их допустим поставить галочку что не суммировать детей и они не будут складываться будем видеть просто по факту по каждого спана его непосредственная работа плюс неразмеченные области или в качестве длины тоже можно брать разные метрики к примеру взять необычный urion от начала до конца а сетевое ожидание вычисленное построить распределение по нему и мы будем просто видеть сколько процесс простаивал Сколько в каждом месте он ждал сеть и ничего больше не делал или если к примеру взять в качестве длины одна секунда это один сделанный РПЦ запрос и не суммировать внутренние показатели потому получим распределение по запросам или если взять в качестве метрики одна секунда это один килобайт выделенной тогда получим распределение по памяти мы можем трейситься вертеть как угодно смотреть в каких угодно разрезах потому что полнота нашей картины значительно богаче качественные богаче чем просто результат Потому что это не состояние это состояние это процесс если в начале когда мы предъявляли наши требования и пытаюсь все это запихнуть Джаггер у нас было получалось что 30 каждый запрос это выходило 4 процента оверхеда и много памяти то сейчас нашим реальном продакшене у нас выходит 0,15 процентов верха на каждый мы тратим каждый абсолютно каждый запрос и практически не расходуется память потому что этот белок в течение особенно после первоначальных оптимизаций очень очень компактной мы тратим каждый запрос и сохраняем только интересное нам Я же кстати не только дизайнер я еще точнее не только дизайнер Зацените какой короче нарисовал это вкладки браузера сколько здесь смысла во-первых это а во-вторых самое главное DT всем закончившим любой математический факультет в принципе даже школы должно быть знакомо вот отсюда из интеграла функции по времени и в нашем случае это полная аналогия потому что Trace это не состояние как я уже говорил 10 раз Trace это процесс бинлок эта функция состояния системы от времени и интегрируя бенлок мы получаем Trace общепринятом понимании которым уже выводится в интерфейс И когда я говорил что спаны складываются в дивники я не врал они действительно вкладываются в дневники Однако На этой картинке не хватает одной маленькой вертикальной палочки давайте я дорисуем это практика которую придерживаются хорошие инженеры во всех мирах инженеры которые знают все три правила владения любой технологией Сначала ты не умеешь пользоваться потом умеешь пользоваться а потом умеешь не пользоваться и вот покуда в нашей Вселенной можно Как пользоваться так и не пользоваться Я лично сюда никуда не собираюсь Спасибо друзья а теперь давайте зададим вопросы и за лучший вопрос выдадим книжку Поднимите руки и получите микрофон первый во втором ряду погнали если попрошу вас вставать и называться по имени Здрасьте Алексей собственно У меня даже какой-то менеджерский вопрос затраты А это наверное много труда часов труда людей много захотели росировать профиль вылилось конкретные примеры какая-то показалось что получилось хорошо я бы ответил на этот вопрос я бы ответил на него абсолютно честно вот эти полгода я занимался той технологией про которую рассказывал сейчас последние три дня Я готовился к конференции потому что только три дня назад я все доделал и все запустил интуиция и весь мой 20-летний опыт в контейнерской И не только подсказывают что то что мы запустили это ровно то как надо было сделать И это ровно то из чего можно будет получать Профит Вот как раз его Мы сейчас собираемся получать как раз сейчас наше боковое начнут это дело смотреть будет время там найти в долг начнут оптимизировать и так далее Потому что отсюда сто процентов можно будет извлечь нереально ту информацию которую ты даже не ожидаешь к примеру такой посмотришь будешь анализировать что-то и ты будешь видеть вещи которые ты раньше даже не думал что есть потому что то как ты думаешь исполняется код и то как он на самом деле исполняется никогда не совпадают и вот ты будешь смотреть такой Опа а что это тут мы сеть ждем Может это можно раз пролезть или Такой типа об А тут мы ждем какой-то процесс столько же сколько мы его там исполняем и так далее мы будем видеть очень много чего и получать просит в будущем после запуска этой технологии после произошедшего запуска сто процентов это будет так поэтому затрат много было это правда чтобы это все придумать сделать запустить просто будет значительно больше вопрос от Дениса из интернетиков или просто не вслух планируете ли вы хотя бы частями выкладываться в Open Source КПП Итак Open Source ну по факту все что мы сделали это и так лежит только понятное дело это привязано к нашему языку к нашему runtime то что я сейчас рассказал технология и в принципе идея вообще никак не зависит языка вообще никак Ну насколько глубоко удастся там лезть фронтаем Поэтому если грубо говоря кто-нибудь это сделает в некопахп и Это станет каким-то еще одним стандартом который значительно превосходит концептуально те возможности которые я сейчас ничего плохого в этом нет Спасибо Доброе утро Максим технологии Я немножко далек от мира Поэтому меня такой вопрос возник А почему мы думаем что вообще кажется вот история с агрегатами в принципе уже была изобретена и работает у нас нет рейтинга когда мы знаем куда кому запрос пошел сколько ходил просто агрегированный профиль обычно трейсинг и правда понимаются в виде что вот у меня две с половиной тысячи микросервисов Я просто даже не знаю что там внутри давай-ка я просто посмотрю как там блин проходит запрос Через какие 150 микросервисов у нас понятное дело не так у нас Монолит огромный и смысл конкретно нашего трейсинга больше профилировании это абсолютно правда вот Да за счет того что технология распределенная за счет того что есть дивники за счет того что это все можно там агрегировать и на самом деле посылать клиента это все-таки трейсинг Но именно за счет того что Монолит мы можем там агрегировать именно в плане профилирования очень много всего опять-таки когда мы говорим про стандартные инструменты я мог рассказать про стандартные инструменты примерно любые не только Джаггер как они пытаются стыковаться к нам потому что в итоге это все-таки распределенная штука Спасибо уже нет вопроса нет вопроса отлично руки в небо вот сюда в центр можно микрофончик просто и друзья сейчас 5 минут и мы закончим сессию вопрос в ответ да Как ближе микрофон в этой системе как я понимаю спорт данных процессов и при интерпретации можно получить мы не знаем что еще у вас был уже такой момент когда из-за того что данных много вы уже увидели какие-то паттерны поведения которые обнаружились из-за того что у вас на самом деле примерно любой трэйс который ты смотришь с реального продакшена он тебя очень сильно удивляет понятное дело именно потому что мы сохраняем интересные какие-то кейсы они все чем-то интересны если сохранять все подряд то 99 с лишним процентов трейсов Ну как бы запрос работает быстро все с ним хорошо нас-то интересует как раз когда запрос работает долго и посмотреть что он там делал чтобы оптимизировать больше вот хвост который по 95 и больше Поэтому поскольку мы сохраняем часто именно такие вещи Мы в рейтинге видим типа блин капец тут сделать 200 тысяч регулярок что там вообще считалось здесь там сто тысяч запросов типа что это вообще хотя то есть среднем профиль не соответствует действительности В крайних случаях именно те которые Нас интересуют мы видим очень много чего интересного и как раз и срезая эти крайние случаи очень сильно будет срезаться и случае не экстремальные а обычные Спасибо наше время стремительно выходит молодой человек вторым поднял руку скажи ты говоришь что у вас очень много этого трейсинга интегрированы ваш кпхп и зависит от вашего компилятора чтобы вертикальную агрегацию делаете насколько знаю У вас уже есть команда на Go ВКонтакте и как выживаете с ним или Неужели Монолит никогда не ходят в го что со стыком гошные сервисы это не бизнес логика это по факту тоже условно говоря движки что-то используется для стриминга что-то используется там для баз данных Это куда ходит Монолит но это не часть бизнес-логика Монолита вся бизнес логика это действительно один большой Монолит и это то наше преимущество которое мы постоянно пользуемся как нельзя избавиться от одного камня точно также нельзя избавиться и от другого будет только хуже вас не очень интересует Почему я потому что в год часть нет бизнес логики но мы туда ходим и когда и вот эта технология сейчас поскольку Это технология общая ровно там тоже скоро команда научит точно такой же трейсинг по таким же самым правилам и мы будем видеть распределенную уже штуку агрегированные уже на Но большую часть решения про то насколько это интересно все равно останется в монолите потому что мы очень сильно пользуемся единой точкой принятия решения на данный На данном этапе эволюции Спасибо Спасибо Добрый день Кирилл зовут такой вопрос Вы 100 тысяч 500 раз повторили что сохраняете только то что вам нужно несколько вопросов возникает во-первых Как вы заранее определяете что вам нужно и не Оказывается ли потом также то что Вы сохранили на самом деле не то что было нужно и второй собственно связанные технический вопрос как эта информация о том что нужно собственно Где находиться как она попадает на которые потом пишут ее собственно говоря Вот и сопутствующие сохранять что-то выделяющееся например как вы сначала не сохраняете обычные на самом деле это абсолютно правильные вопросы и действительно в том чтобы отделить нужное от ненужного есть очень много вопросов в том числе нерешенных но на самом деле Давай сначала прежде чем на него ответить рассмотрим просто Джаггер обычный куда мы как с обычными бэндами допустим вы сохраняли бы туда все и вот там бы копилась куча всего одинакового и потом бы такие типа блин он что-то тормозит Давай настраивать какие-то ретеншн полисе какие-то там что-то еще потом пытаться над этим короче на джаггером навешивать разные велосипеды чтобы оттуда извлекать то что нам нужно Да мы пытаемся это делать превентивно мы это пытаемся делать на той информации что практически весь путь запроса у нас лежит Монолита он не распределенный не микросервисный Следовательно во время пути во время того как запрос обрабатывается Несмотря на то что мы пишем Блок Мы запоминаем какой-то маленький маленький стоит того на основании чего мы можем потом принять решение интересно это или нет На данный момент времени нас интересует когда запросы получались долгие когда они съели много памяти Когда было слишком много взаимодействий когда там какие-то редкие кейсы встречаются которые просто рандомно не попадут Это вся логика вынесена в Монолит то есть она включается там примерно в середине или в конце плюс того что это вынесено Монолит то что ее можно поскольку это бизнес логика это не какая-то внешняя система и тем более не Рандом Значит мы ее можем менять мы можем подстраивать как угодно что сейчас грубо говоря ближайший там несколько месяцев нас интересует разбор этих хвостов Вот Потом когда мы с ними более-менее разберемся нас будут уже интересовать немножко другие паттерны и Мы подумаем над тем как именно их отслеживать именно потому что Монолит мы можем это делать внутри одной точки друзья я тут поиграю немножко в дисциплинатора через минуту мы должны сделать перерыв с вами поэтому все вопросы которые не успели задать сейчас будет финальный вопрос потом раздача слонов единорогов Напишите пожалуйста в чатик коллеги проконтролирует что он нам все это ответит да пожалуйста Очень интересно Меня зовут Сергей Вы можете проследить работу то есть в рамках того чтобы базовая условно говоря там цпу и прочие всякие штуки мы Понятное дело тоже Можем отслеживать обычным системными вызовами иногда периодически скидывать в тот же бинок на основании этого вычислять что-нибудь интересное вот другого хардвера мы сейчас не скидываем потому что Итак слишком много всего из чего можно извлекать какое-то понимание концептуально если будет понимание Ну допустим на нашем разработчиковском уровне Какую информацию можно извлекать из какого-то Hardware скажем так из каких-то характеристик и можно ли как-то репетировать и так чтобы это замерять было можно с маленьким лете когда их тоже будем просто скидывать куда-то на проигрывающей стороне как-то разбираться технология настолько общая что нам не нужно это дело копить в памяти это самое главное теперь надо выбрать два вопроса за которые мы подарим во-первых вашу единорожку это тебе привет и книжку как рабочие отношения управляют помогают управлять трудным начальником Может я себя Нет нельзя забрать не пались у тебя хороший начальник скажи вслух у меня хорошая хорошая на самом деле самый грамотный вопрос Это про то как принять решение про то что такое Интересно что такое не интересно Еще не до исследований поэтому махните рукой пожалуйста и теперь книжку"
}