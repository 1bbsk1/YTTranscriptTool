{
  "video_id": "Z7gie1Kqmvc",
  "channel": "HighLoadChannel",
  "title": "Внутренняя платежная система Яндекса: что под капотом? / Антон Куранда (Яндекс Финтех)",
  "views": 1755,
  "duration": 3050,
  "published": "2024-10-29T02:48:12-07:00",
  "text": "захотелось рассказать о том что мы делаем с вашими деньгами Возможно это будет интересно не только с технической но и с потребительской точки зрения сразу скажу что буду рассказывать про то какую бизнес задачу мы решали Какие подходы и практики мы использовали теории низкоуровневых вещей говорить не буду для этого есть более специализированные доклады про себя подробнее меня зовут Антон куранда я уже больше 15 лет делаю так чтобы платёжные системы работали предыдущее место работы - это РБК Money Там мы очень весело писали платёжку на ланге и так случилось что потом за опенсорс вообще всё что мы сделали оно до сих пор лежит на гитхабе можно посмотреть по вдохновляться до этого мы в делали так чтобы работали и платёжные терминалы кстати вот поднимите руку Кто пользуется платёжными терминалами сейчас на регулярной основе есть кто-нибудь кто-нибудь нету 10 лет назад здесь был бы лес рук и почему есть ещё одна область которая растёт так же как конференция High ecce прёт он пёр и до пандемии и после Пика пандемии Он продолжил расти наш рынок не насыщен и это нормально люди привыкли к скорости к удобству это абсолютно нормально для человека Сидя на диване хотеть заказать себе банан из лавки чтобы его привезли за 15 минут что это значит для нас Я оцениваю как повышенную вероятность того что ваш бизнес ваш заказчик придёт к вам и попросит вас написать программу проду который так или иначе связан с электронной коммерцией а это значит что Возможно придётся потрогать и платежи потому что это Краеугольный Камень электронной коммерции даже если у вас есть сейчас что-то за что вы принимаете деньги Ну вероятность высока того что придётся написать какую-то штучку которая резервирует ваш платёжный шлюз потому что падают все а терять деньги бизнесу самое больное что можно представить Давайте подумаем можно сделать и как это сделали Мы синхронизирует области я буду в основном оперировать терминами индустрии платёжных карт Ну банально потому что у нас их проникновение самое высокое больше 90% Казалось бы что такого стянуть деньги Пошёл в банк сказал дай деньги получил деньги отгрузил товары всё плаж хитрая штука у него гораздо больше состояни получил деньги к примеру если оперировать нашими терминами мы можем запустить процесс авторизации то есть получение и холдирование денег на вашем счёте в вашем банке там есть два выхода она может быть неуспешно это всё понятно Если она успешная платёж авторизован и у него тоже есть несколько выходов мы можем отправить авторизацию отмену и пжт сформировать лирин сообщение плаж будет ну условно Полин Я у прощаю И всё это нужно делать таким образом чтобы переход между состояниями был консистентные авторизованный платёж не может вдруг стать поф илем Представьте ситуацию для вас Мы списали с вас деньги а такси в том анекдоте виро лаши сказали что Ой какие деньги Ну это самое больное для нас потому что мы очень щепетильно относимся к вашим деньгам и любые проблемы с ними для нас первый приоритет первая головная боль как мы делаем так чтобы минимизировать все эти проблемы кстати платёж и его состояние - это не только до того как мы начнём авторизацию может вообще запуститься аутентификационные и вводим на сайте банка но мы работаем в странах где люди не работают с платёжными картами например в Африке там может быть путь из нескольких действий ввести OTP поднять OTP ввести его в какую-то специальную форму сво кодовое слово ввести и так далее и всё это нужно вместе упаковать в Единый какой-то понятный процесс собственно в Яндексе мы этим и занимаемся наши функциональные требования состоят в том чтобы для всех известных вам сервисов это такси Маркет лавка еда заправки всё что угодно проводить платежи то есть в онлайне мы принимаем распоряжение от сервисов о том чтобы пойти и с вашего платежного средства и предоставить этим сервисам в онлайне информацию о результате этого процесса причём делать это нужно в огромном огромном количестве платёжных провайдеров стран мира и так далее мы не просто какие-то карточки принимаем Да мы работаем от Перу и код диара до практически всего что есть в России есть пжи через нас и задача сложная заключается в том чтобы упаковать это всё в единую опиш которая для сервиса выглядит просто как создай платёж и сделай мне его успешным мне дальше Неважно Что у тебя там за тобой находится А за нами находится там пол Африки и это нужно всё правильно сделать чтобы правильно работало сценарии там достаточно сложные и вот как мы их обрабатываем Ну про нефункциональные требования у нас нагрузка состоит из объёма денег который через себя мы проводим Мы за последние годы я по открытым источникам Погугли проводим суммы платежей в целом сравнима с ВВП с процентами ВВП нашей страны и с учётом того что средний размер платежа у нас достаточно маленький Ну буквально поездка на такси там условно 300 руб то количество платежей в секунду оно составляет прям вот цифры с тремя нулями и в связи с тем что мы подключены к большому количеству банков У нас очень много вариантов проведения платежа причём платёж у нас это ну есть некая сущность которую мы условно отдаём сервису но под капотом она может содержать несколько платежей ну к примеру мы умеем делать Так что мы взяли вашу карточку пошли в банк а поняли что он нам отказал по какой-то понятной нам причине отлично а нет денег и мы в этом же нашем платеже Можем сходить в несколько других банков каскадом и попытаться списать там деньги сейчас нспк Подрезал нам немножко крылышки в этом плане но ладно при этом регулятор требует от нас хранить все эти данные годами и Челлендж состоит в том что это действительно больше сотни терабайт в год Ну типа это много это во-первых стоит как бы денег во-вторых непонятно как дальше масштабироваться да если нет плана вот что будет если будет там 200-300 теб А если петабайт и есть ещё один Челлендж вам хочется чтобы мы очень быстро проводили платежи Ну вот пример есть Яндекс заправки супе удобная фича можно прямо в приложении карт подъехать на заправку откроется шторка и там можно заправиться не выходя из машины если это происходит медленно То есть вы стоите нажимаете смотрите на эту крутилку а сзади Значит тебе сигналит Нетерпеливый следующий Посетитель Давай Уезжай отсюда что-то вообще в кассу не пошёл это не приятно то есть людям важно чтобы платежи проходили быстро и Челлендж у нас был тоже в том чтобы прям сильно в разы в десятки раз ускориться В девяносто девятом Тиле это до 30 раз Доходит и при этом Ну проливать Надёжность э нельзя ну то есть понимаете да При таком объёме трафика при таком псе буквально минуты простое это миллионы и ещё самое противное то что ну как противное оно с одной стороны сложное такое нервное с другой стороны приятное мы сервис который стоит на критическом пути практически у любого сервиса Яндекса Ну то есть Маркет становится просто Мета поисковиком по товарам и не приносит бизнес ценности Да ну собственно Если вы не можете купить свой товар вы уйдёте к конкурентам в лавке вам не назначаться курьер и не повезёт Значит вам на этом быстренько велосипеде банан Потому что плаж не пройдёт потому что бизнес-процесс у них построен на том чтобы прошла успешная авторизация соответственно у меня задача сделать мой сервис таким чтобы он был как минимум не менее надёжный чем самый из надёжных сервисов Яндекса и исходя из того что у меня все их платежи у меня ну как бы rps э составляет rps всех платежей всех сервисов с одной стороны как бы немножко страшно с другой стороны вот он настоящий Хало то к чему Я всегда стремился интересные задачки как мы собственно решаем эти задачки где-то 2 с по года назад мы решили немножко вложиться и переписать нашу текущую платёжную систему мы это сделали выбрав Гош почему гошко типа ну платёжки же хорошо писать там не знаю на яве котлине Ну во-первых мне нужен был низкий порог входа было какой-то пол разработчиков там питани сы разные ребята и ну Гошка действительно легко достаточно вкатиться и Знаете по скорости работы на Ну по скорости работы и и количеству ресурсов которые потребляет она прям реально окупается у меня было несколько багов когда мы накосячили с ретра ями И хорошенько привалило я не скажу чтобы у меня там вот рутин каут как-то на подах сильно увеличился или там цпу в полку то реально быстро работает купается Ну собственно самый большой секрет э нашей системы заключается в том что у нас должна быть надёжная база на которой мы всё строим Ну как бы что тут такого есть микросервисы они stateless и фактически Надёжность и скорость работы вашего продукта она зависит от хорошей базы данных но её тоже нужно немножко правильно готовить как мы это делаем все сущности наших бизнес-процессов они описаны в виде конечных автоматов банальность теории конечных автоматов фсм там описан Граф переходов и переход между состояниями осуществляется просто отправкой в мы все допис в конец И у нас именно Именно бизнес сообщений Event Log которые нельзя поменять Ну то есть буквально у нас в интерфейсе базы данных нет метода Del так далее У нас есть и EV чем Это хорошо если взять Вот наш первичный ключ в основном это fsid неки виде произвольного позволяет нам использовать idb без Джой без кросс шардов запросов и фактически держать весь стейт в одном шардена огромную скорость достаточную для нас из базы данных ну мы типа достаточно нагруженный проект но я знаю что мы даже там не в первом каком-то проценте топа того что может idb то есть масштабироваться там ещё есть куда в таком сочетании подходов один шарт одна МКА и Event которые мы можем сразу поднять и обработать позволяют нам восстанавливать причинно-следственную связь иметь аудируемое главное что мы не храним стейт именно конечного автомата ней арену суно ту когда мы начинаем обрабатывать какой-то бизнес-процесс мы поднимаем из хранилища контекст проигрываем все ивенты и понимаем в каком состоянии начинает оказывается конечный автомат и дальше в этом нужном состоянии выполняются некие бизнес экшены которые реализуют бизнес логику Почему е в фи для меня важны были следующие мне не хотелось думать и голову над шардирование она даёт автоматическое шардирование из коробки я отвечаю за ваши деньги и мне важно чтобы с ними было всё в порядке поэтому мне нужны гарантии надёжности Надёжность в idb мне даёт из коробки следующую минус дата-центр Минус стойка в регионе собственно я умею переживать отключение одного дата-центра что мы делаем на учениях следующая фишка - это автос литова или автор по нагрузке или по количеству данных в рде Ну автор нам не грозит мы только растём А вот авто Сплит очень хорошо решает проблемы того что я просто не задумываюсь о том А куда доедут данные Хватит ли места Ну как не задумываясь в контексте техническом в контексте финансовом заходишь как бы вот ко консоль Яндекс клауда смотришь Сколько денег думаешь ёлки-палки и следующая гарантия которая мне нужна которую я получаю из коробки это строгая консистентность то есть уровень изоляции се realizable не спрашивайте меня как как ребята это делают я не то чтобы не знаю но не буду отнимать хлеб вот моего замечательного коллега Оле коллеги Олега можете поспрашивать его ну и собственно Мы хотим делать какие-то Полин Мы хотим шеду какие-то автодей Вия и нам пришлось ээ использовать планировщик событий Вот и Весь секрет основные компоненты на которых работают платежи и как их использует Яндекс Ну теперь давайте к более грязным более техническим подробностями А общая схема компонентов Ну представим что вы заказали Комфорт Плюс Комфорт Плюс Плюс это будет а наши экземпляры живут в трёх дата-центра то есть есть микросервисы бизнес логики они распределены географически по нашим ДЦ в России это внутреннее Яндекс облако также должны переживать один дата-центр но мы хотим платёж сверху приходит такси и хохочет списать с вас деньги за поездку но оно не может потому что ВС е понимаем откуда списывать Деги поэтому любым просом предвар плаж является так называемая привязка вашего пго метода на нашей роне есть UI который позволяет м ввести данные Ну предположим вашей плай карты этот UI умет сохранить эти данные платёж каты в зашифрованном виде в PCI dss так называемое хранилище Ну P dss - это стандарт который определяет практики того как безопасно хранить сента то есть данные вашей карточки это PD и время на cvv соответственно Когда вы привязывает карту мы её сохраняем шифру токени и этот токен подкладываем под ваш Яндекс ID в хранилище платёжных методов и это то что вы видите в шторке в такси то есть это лежит на нашей стороне это и в такси и абсолютно в любом сервисе чем для нас хорошо один раз Вы привязали карту условно в такси она проросла во все сервисы Яндекса для вас это удобно Для нас тоже вам не нужно несколько раз это делать Окей У нас есть привязанная платёжная карта я опускаю слой там балансировки маршрутизации здесь больше логическая схема компонентов хотим запускать платёж дальше это проваливается в микросервисы ядра как раз наши Гош которые умеют крутить бизнес логику естественно Мы хотим запер систим мы это делаем через а отдельный сервис про который Расскажу позже Лим данные и дальше начинается сбор контекста платежа Ну то есть на входе у нас от такси есть сумма ваш айдини дишни токен вашего платёжного метода этого недостаточно чтобы провести платёж потому что у нас есть миллиард банков которые он может приземлиться есть движок который на основе аналитики предыдущих платежей на основе правил определяет во-первых наиболее выгодный для нас и наиболее быстрый для вас банк и старается приземлить платёж туда Ну то есть мы как бы ретроспективно оцениваем доступность всех наших банков и результатом движка правил является упорядоченный список маршрута того куда можно приземлить платёж также мы естественно отвечаем за ваши деньги не хотим сделать так Ну по крайней мере в массовом виде чтобы если угнали ваш Яндекс аккаунт платёжные карты оказались доступны злоумышленнику там секретными методами определяется вероятность этого события и в терминальной стадии антифрод может вообще запретить платёж но скорее он делает мягкий запрет он поднимает требования аутентификации Да мы можем Вам СМСку отправить там ещё-то дополнительно авторизоваться Вот и есть ещё целая куча сервисов там их Почти полтора десятка которые нужно отор риро собрать контекст Ну и собственно только после этого мы можем проводить платёж Окей мы знаем значит что афро разрешил мы знаем куда прием подключается концепция наших платежных адаптеров Это примерно те же микросервисы только у них задача перевести наш внутренний контракт там буквально из пяти ручек там Cap в понятный какому-то внешнему банку протокол это закрывает требования быстро расширяться то есть адаптеры у нас пишутся какими-то может быть даже сторонними командами к примеру вот у меня есть Моё ядро есть команда я которая хочет в Африке что-то подключить они вполне могут прийти ко мне законтрили зовать ашку пройти тесты и всё начать принять платежи но мы ещё не знаем карточных данных внутри вот этой всей системы мы не оперируем чувствительными данными Мы работаем с токенами соответственно этот токен нужно превратить в реальную карту это делается через проктор в pss зоне на вход ему подаётся шаблон запроса где шаблони зру ется как бы карточка дата там какие-то ещё опциональные Поля это улетает в прокси он идёт в хранилище именно ваших карточек получает расшифрованный Пан ходит с ним банк и по реверс прокси отправляет результат запроса К нам Э накладная процедура она добавляет летен там достаточно легко на бажи поэтому мы стараемся минимизировать количество запросов именно через pss Проси и там где нет карточных данных адаптеры ходит напрямую минуя pss зону Ну например какой-нибудь Статус можно его дёргать невоз сколько угодно Верхне уровневая схема примерно такая теперь предлагаю погрузиться немножко в компоненты которые это делают ещ из важного Да вот эти все микросервис они на самом деле с точки зрения Бинар они одинаковые я не стал заморачиваться с тем что вот у меня есть там микросервис есть микросервисы ядра Там адаптеров и так далее это всё один и тот же Гош код это всё один и тот же Бинар который оттопыривается все ручки наружу Ну условно одновременно Ну то есть мы как IP gway можем принимать от сервисов запросы создай платёж Дай мне статус там Отмени плаж и так далее мы можем принимать входящий поток на RC и можем исходящие в банке разделяется это группами деплоя Ну то есть банально балансировки не льют в микросервисы которые представляются фик rpc и наоборот А например вот те сервисы которые в группе общения с банками к ним вообще никто не льёт никакого трафика они просто ходят и авторит запросы Итак практики для прония есть я как бы вот всю инфраструктур часть оис не буду описывать очевидно что у наха есть очевидно что мы хотим какие-то поиски платежей делать админки Ну именно онлайн платежей Ну там более-менее всё понятно Итак сверху к нам приходит сервис и говорит Хочу дене представляется и фактически первое что он делает он внутри кода создаёт экземпляр йт машины первым ивентов в неё ста в payment Start есть уже контекст того что СОБРа для того чтобы плаж прося сущность это экземпляр скажем так процессинга событий и контекста Ну то есть это тот же микросервис у него на самом деле задача следующая запер данные в idb и задули тас на будущее или задуть таку в наш шедулер в режиме очереди да то есть ну Del 0 - это как бы вот сразу фо обработка и отправка данных дальше на обработку бизнес логикой у него есть ещё задачи контролировать то что события будут обрабатываться именно в том порядке в котором они были добавлены в базу данных ну потому что у дура нашего нету гарантии exactly Once Сейчас объясню почему вообще интерфейс дулерайн мы можем добавлять тас с определённым идентификатором и идентификатором очереди в очередь там есть квар как бы какую-то МАПО можно подложить под эту таку экземпляр процессинга Может с комфортным нам с комфортной нам периодичностью полить эти таски Ну там 30 50300 миллисекунд Вот и при полинг тасо Он спрашивает буквально Дай мне значит задачи время исполнения которых уже наступило Ну то есть мы буквально можем дуть задачи там на день ВД и так далее вот отдаст паче задач которая у которых Эй уже наступил и если экземпляр значит сервиса забирает там эту пачку задач то шедулер помечает на определённый короткий отрезок времени Ну конфигурируется сделать процессинг он может пометить эту задачу Как успешно выполненной тогда она больше не появится для обработки в для других сервисов он может например сходить куда-то с запросом выполнить эту задачу получить пяти соточку и тут мы хотим травиться для этого он пометить задачу как failed и шедулер за шедуле С экспоненциальной задержкой её ещё раз и будет пытаться ещё ещё ещё с задержкой отправлять задачу в очередь пока она не выполнится ну естественно по пути поднимая как бы все алерты зажигая гирлянды дежурному Ну и например задача может выполняться и сервис может понять что ну типа она выполняется Долго но это нормально мы её можем за решеду ить то есть поставить нам на какое-то будущее время Ну под капотом это наверное марда от Task как понимаете здесь есть concurrency issues то есть э Представьте Да что один экземпляр процессинга взял свою пачку задач затупил задачи освободились для следующего взял в работу задачи следующий сервис Таким образом у нас на два пода может приехать обработка одного платежа в один момент времени Мы это знаем мы умеем с этим жить и единственное требование у нас то что ручки которые обрабатывают таски они должны быть идемпотентный идемпотентность обеспечена разными способами самый там лёгкий простой - это синхронизироваться внешнюю систему ну то есть представьте вот есть два пода в разных дата-центра на обоих в один Ну там в в какой-то момент времени запустился Стар мы идём в банк Вот и большинство банков поддерживают например Get stus и реализация адаптеров такова что знает он что был платёж не знает он всегда первым делом дёргает статус и таким образом синхронизирует своё состояние с внешней стороной Ну и собственно после каждого значимого действия Мы также ДГА статус Ну окей с очередью примерно разобрались значит что делает экземпляр процессинга когда приходит задача вот К нам приехал payment Start Del но процессинг его запол запол понял что нужно сразу же запускать платёж Он поднял контекст из базы данных А понял что этот это событие эта задача ещё не обработана и он отправляет этот контекст на обработку в экземпляры сервисов которые крутят именно бизнес логику Ну фактически это п запрос на ручку rpc в этот КТП запрос влетает значит МКА с контекстом в виде Джейсона и этот экземпляр разворачивает её в экземпляр конечного автомата прокручиваю события мы понимаем в каком состоянии мы находимся и например то есть это сейчас всё в памяти происходит да то есть мы не Обращаемся ко внешним акторам и например мы понимаем что мы находимся вот в таком-то состоянии Мы хотим создавать платёж но мы не уверены например что нас не придут не убьют Там и так далее и синхронно в ответ на запрос rpc мы можем создать ещё ивенты которые лягут в шедулер Ну как правило это ивенты какого-то трая после этого Помните я говорил что мы должны проводить платежи быстро мы просто создаём го рутину и начинаем просто в памяти с огромной скоростью пытаться провести платёж то есть платёж может занимать некие сеанс взаимодействия с внешней стороной в виде дёрганья каких-то ручек их может быть несколько там нужно подсох состояние в зависимости от реализации конкретных адаптеров Мы выбираем или сохранять чекпоинты то есть условно мы сходили получили какой-то шник подстили его событием в базу данных Здесь тоже важная тема события бывают у нас бизнесов и технические бизнесов события Ну это фактически то что и опять же его заперли здесь Спросите логично А что делать с не знаю если когда олер придёт или ваш пот начнут эвакуировать да ты же крутишь платёж памяти что с моими деньгами будет что мы делаем на самом деле ивен стартов всегда два То есть первый с но фактически быстро пролет через очередь шедуле на ну эмпирически выяснили на плюс 1 минуту в будущее если нас убили приедет второй ивент payment Start синхронизируется там с внешней стороной поймёт например что платёж уже авторизован и тогда просто кинет Event autorisation Success или проведёт платёж заново Здесь мы разменивает центили в тенси в году доступности Ну то есть нам важно чтобы там дено девятый перцентиль платежей пролетал меньше чем за сотни миллисекунд Ну и получается что цикл замкнулся то есть вся наша система выглядит следующим образом прилетает некий инициирующий ивент который в принципе триггерит создани стоит машины есть шедулер который с процессинговая отправляет их на обработку в инстансы бизнес логики инстансы бизнес логики в ответ могут Отправлять свои события которые могут Дули ещё какие-то задачи и только в тот момент когда в Лере закончились задачи стоит машина перестаёт выполнять свой бизнес-процесс и считается успешно завершённый ускорение через шедулер гонять таски долго Ну как долго это десятки сотни миллисекунд поэтому мы стараемся делать те веи которые можно сделать условно синхронно в памяти то есть большинство вещей Мы прокручиваем в памяти мы сами себе в машину в ивент лупе кидаем события которые например там не знаю что-то обогащает ретрай канты считают и так далее защищаемся от падений тем что отливаем в базу чекпоинты и можем не с самого начала проиграть события А на какой-то момент на тот который мы остановились есть ещё проблема с доступностью и производительностью вот смотрите у нас вот в процессе проведения платежей есть нефункциональные вещи например Мы что-то хотим отлить в ж брокер Ну то есть там д надо отливать Там и так далее Мы хотим делать это не Time Но если там что-то задержится для нас нормально если оно будет дожать для этого мы выделяем буквально один простой конечный автоматик у него там три стейта есть там р Success Fail Вот и его задача как бы трая отливать в КБР сообщения и вот Представьте наш шедулер У нас есть наша огромная очередь там не знаю payment Q падает к брокер блин он никогда не падал почти 2 года работал хорошо И тут он падает а что происходит у нас в системе начинают копиться ивенты трая эти ивенты трая через процессинг долетают до шедуле дуля там ну немножко экспоненциально ну что такое там экспоненты там о 125 секунд и так далее и Они просто начинают вытеснять своими трая ивенты пеймент старта получается что отвалилась какая-то важная но не онлайном разделяем очереди И для этого у нас есть свойства нашей очереди там есть конфигурируется максимальное количество задач которое она может отдать в работу Ну и собственно отдельная очередь ну очередь там ну это практически строка мы их можем создавать там бесконечное количество наверно ну сколько нам нужно соответственно это отдельная очередь может забиваться да как бы там могут травиться какие-то события но выделение именно её в отличную от пла очереди часть позволяет нам падают какие-то внешние системы ещё есть полезное свойство у такого разделения это скажем так часто эксклюзивно и небольшие платёжные провайдеры говорят что вот смотрите Мы готовы принимать от вас 10 платежей в секунду а если вы будете нас слать 11 платежей в секунду мы вам всё отключим Ну почему отключим потому что мы от этого падаем мы вообще не можем проводить платежи соответственно этой схеме можно можно так сказать шейпинг делать этих запросов то есть выделить значит Event payment старты которые прилетают с определённым провайдер ID в отдельную очередь там провайдер 1 зарезать там количество тасо которые отдаются одновременно и таким образом сделать там условно из большой нашей трубы которая к нам вливается более маленькую которая выливается бассейн нам будет Вот накопление задач в шедулер опять же обмениваем н на доступность но здесь нам доступность важнее ээ Давайте немножко отвлечся секунда отдыха в нашей системе Все платежи проходят в минимальных денежных единицах в копейках центах Там и так далее возможно кто-то догадался уже Почему чтобы не нам в чатике поддержки задавали такие вопросы а мы спрашивали копейки - это удобно договариваемся по правила округления Вот и и всё работает Ну окей про вот я вам говорю про эти стоит машины там и так далее чем удобно Почему мы их используем во-первых на самом деле у нас нет На входе конечного автомата платежа и мы не используем ТСМ мне хотелось дать сервисам возможность создание некого контейнера платежей в который можно например запу одновременно Это для какого бизнес-процесса нужно лояльность вы выбираете на Маркете оплатить часть моей покупками баллами Яндекс плюс соответственно для того чтобы Маркета не болела голова о том что ему нужно один платёж там второй тегами как-то связывать я говорю Вот тебе контейнер Ты создаёшь интент то есть намерение оплатить и ты можешь доки туда необходимое тебе количество платежей с точки зрения базы данных этова то есть fsm ID у нас всегда intent ивенты могут создавать дочерние стоит машины то есть мы используем иерархию стоит машин для двух вещей нужна про Вторую чуть позже расскажу как это вообще работает Чем полезно Ну вот смотрите мы а проводим здесь платёж Мы создали какой-то интент в нём создали мку платежа и хотим запустить сессию взаимодействия с внешним актором то есть зарегистрировать платёж там авторизовать и отлить ивент успеха например сессия поднимает под собой условно адаптер который идёт в банк банк может сказать О'кей я принял твой запрос но Подожди там спроси меня через секунду соответственно сессия сама в себя кидает ивент трая это через Ду прокручивается и в какой-то момент мы получаем ответ что ну О'кей всё хорошо соответственно у нас интент форкнуть машина платежа форк машину сессии и та результатом своего действия Может отправить в родительскую машину событие о том что с ней произошло если она отправляет suc то родительская машина дит условно из состояние в состояние А это нам позволяет расширять нашу бизнес логику и позволяет в том числе немножко экономить данные экономить наши деньги Ну вот смотрите вот та же стейт машина сессии она как бы временная нам Ну что там есть полезного Да она отливает контекст родительскую об ашках там результатах тампон кодов и так далее но у неё есть е список технических каких-то действий ивент трая там rety Count 1 2 3 она нам не нужна и Блин у меня там больше 100 тбт сейчас уже в базе ещё год не закончился сильно больше 100 и мы хотим чистить это всё соответственно Если вы выделяет В отдельной стоит машинке Вы можете сделать отдельный фоновый процесс который просто берёт прокручивает стоит машину общую интен выкидывает из неё ивенты создания сессии и апдейт базу таким образом можно делать компактизация вашего платежа там сессии всё бегает работает тут раз пришёл регулятор и сказал а теперь вы должны бить чеки а чеки это это же Ну это совсем оно вроде и связано с платежом вроде и не связано я к чему этот пример он очень хорошо показывает то что к вам будет приходить бизнес и требовать дополнить вот ваш бизнес-процесс новыми какими-то штуками не знаю А после платежа там курьер появится А ещё курьер пиццу на откусил значит заказ в состоянии надкусанное вот если вы попытаетесь это сделать в плоском автомате у вас получится й Explosion да то есть комбинаторный взрыв потому что там поменять какой-то там переход вам просто фить нужно всё соответственно использовать иерархию это прям советую закладывать Если вы какую-то подобную систему захотите использовать у себя прямо на старте она позволит вам расширяться и позволит в том числе делать вот эти все полезные вещи Ну и собственно чем можно быть полезным в этой схеме и более быстрым для ших клиентов да для ваших сервисов У нас есть Event он типа Анди из него можно вычислить состояние Отдайте этот ивен в каком-то Ну в какой-то Вью обрезанной как бы наружу Не всматриваюсь здесь я расскажу что написано здесь фактически есть то что происходит с платежом сейчас в Яндексе и то как его видит в такси есть дополняющий список событий есть говорим был создан интент был создан платёж и используя вот эту схему Если вы договоритесь с сервисом что янам вот как бы этих ивентов ну условно Вы можете расширять на своей стороне не возбранный значения вы сможете реализовывать новые вещи Ну то есть э Если вы будете какие-то агрегаты отдавать то будет тяжело решить задачу например которую мы решали Мы в Африке к нам пришли и сказали вот смотрите были платежи всё было хорошо у вас 3DS есть а теперь вот вам нужно USD запросы как бы понимать как что внешняя сторона отправила трекать там что человек ввл и так далее Соответственно что мы делаем мы в наш просто добавляем новый ивент который говорит что сейчас происходит US Inter и пере адресу пользователя там на поплин например на приложение sup или попроси его вот такой вот Лог наружу сервисом вы предоставляете свойство аудируемое Да в вашей системе Я недавно жил там одну проблем человек говорит что мне деньги не вернули вот иду в банк дёргаю статус он мне говорит Смотри вот было поклен на 50 как бы 50 А я не понимаю а что это значит там там было пять фандо по 10 или 150 а может там было 10 рефан дов как бы по 10 и пять из них зафер его разберёт что там происходило у меня сразу сервис бы увидел Event refund created failed refund created sueded то есть причина следственная связь понятна и никто же не запрещает сверху вам как бы посчитать там агрегаты сказать Ну вот у тебя было значит во всём этом значит портянки событий столько-то денег покре столько-то возвращено хочешь это Используй хочешь Что ну и собственно я Если бы писал сейчас там Своё Такси использовал бы этот подход именно там же А почему нет Чем отличается состояние платежа от состояния заказа такси та же стоит машинка как бы ну просто с другим графом можно в биллинге начислять какие-то вещи Ну что такое биллинг Ты пошёл как бы хочешь начислить баллы и лояльности проверил лимиты там подгрузило посчитал балансы понял что ошибся с балансом идёшь отменять как бы в кошельке лояльности баллы там тоже есть стоит машинка она простая типа по фанде баллы как бы Success не Success парася и так далее это можно использовать как большой фреймворк в принципе мы своим опытом вот сейчас доказываем да что этот подход Он работает на больших нагрузках Ну реально у нас серьёзные нагрузки Я хотел сказать что он не падает но я суверен поэтому не буду говорить потому что сейчас мне начнёт звонить железная ёт корона после этих слов но логично смотрите если м использовать вот буквально несколько компонентов да м нормальное хранилище шедулер э описание в виде стоит машин это выделяется в некую инфраструктур команду вашей компании Вы можете сказать Вот ядро вот мы его написали и его можно не трогая развивать дополняя какими-то новыми бизнес фичами вы можете сократить количество велосипедов используемых в вашей компание Да вы можете там взять на себя сказать Вот Мы команда инфраструктур и буквально давать как сервис это мне кажется достаточно полезная вещь на этом всё спасибо большое за внимание Спасибо А ещё спасибо за то что рано утром говорил медленнее это очень ценно друзья Задайте вопросы у нас не очень много на них времени смотрите вот Раз два можно микрофончик дать прямо сразу Вот и сейчас барош не справляется с противо с противопо током друзья помните что девушки и юноши в красной одежде - это волонтёры их надо беречь Да пожалуйста Да привет Спасибо за доклад Меня зовут Олег ВК команды биллинга У меня два вопроса технических и два бизнесов можно так вот давай два а ещё два в бизнес зоне потому что там третий вопрос до платный это не хорошо два технических на тему хранения транзакций такой вопрос сколько вы храните транзакций по времени хранитель вых 5 лет как надо по законодательству и если у вас разделение на какое-то горячее холодное хранилище Или вы просто тупо храните всё как бы в одинаковой доступности Это первый вопрос второй вопрос тему формирования отчётности тарификации и вот проблем которые часто возникают биллинге с так сказать протекающими минутами то есть Ели у вас такая проблема что транзакции могут то есть запрос на списание может идти довольно долго и он может произойти на границе меся месяца когда например 31 октября пришёл запрос на то чтобы списать деньги а списали деньги Вы только например 1 ноября вот Ели у вас такие проблемы Как вы их решаете Вот и можно сразу тогда ещё Нет конечно нет Ладно по очереди да потом тогда спрашиваю Спасибо Спасибо большое просто по времени мы летим изза из-за того что в снегу стояли автобусы поэтому Извини да хранить обязаны 5 лет иначе как бы придёт полиция спросит что с деньгами мы не сможем ответить сначала хранили в Горячем хранилище на SSD это супер дорого сейчас сделали тиринг тиринг что делает ты можешь мы сейчас поставили 3 месяца по-моему Вот есть фоновая Джаба которая просто из SSD перекидывает на idb HDD хранилище считаем нам этого хватит надолго Проблема была огромная потому что говорю сотни Киба - это очень много денег в idb вот проблема с события и посчитать агрегаты если мы выходим за границы месяца и если месяц закрыт то м ну туда условно перетекают балансы Вот и если Ну был какой-то или долг или пере Ну перерасчёт то баланс будет там в плюсе или в минусе спасибо Вот после доклада спикер всегда уходит в дискуссионную зону здесь она у нас сразу справа от выхода поэтому сейчас Вы можете последовать За Андреем и задать ему оставшиеся вопросы там и вот микрофон уже дали последний Добрый день меня зовут Сергей Нечаев биллинг ндекс облако Спасибо за интересный доклад вопрос Следующий Если со временем набор конечных состояний в конечном автомате меняется как сделано так что когда-то платежи которые начались по старым правилам обраться по старым начиная с какого-то момента новые обрабатываются по новым версионирование Ну то есть мы доигрывает по предыдущей версии и все следующие новые по Ну то есть набор состояние версионирование Я так понял что у тебя есть ещё третий подарок и ты его как раз можешь э во-первых получить себе а во-вторых свой подарок подаришь в дискуссионной зоне видимо вот э в ВК уйдут оба так обычно бывает А это тебе супер спасибо за участие Спасибо большое спасибо за стресс-тест"
}