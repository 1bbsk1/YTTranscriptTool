{
  "video_id": "6MJtIZd1E60",
  "channel": "HighLoadChannel",
  "title": "Tarantool Cartridge: кластер из коробки / Игорь Золотарев",
  "views": 1362,
  "duration": 1997,
  "published": "2022-03-21T13:13:02-07:00",
  "text": "на всем wed зовут игорь я сегодня буду вам рассказывать про трандл кортеж и давайте я один из разработчиков картриджа до этого год я разрабатывал витрины данных на картридже для мегафона также я maintaining торренту metrics и юридически ведут тренинги по картриджу и давайте подумаем канны задача когда мы строим наши кастеры у нас на самом деле три задачи мы хотим что наш кластер был масштабируемым чтобы мы могли масштабировать наши данные много их page радировать также что вы могли масштабировать какой-то код который с этими данными работает еще мы хотим всегда что у нас система нашего надежная чтобы она не отказывала в нужные моменты и мы хотим чтобы она была поддерживаемые у нас были кит инструменты для деплоя для тестирования для администрирования нашего приложения и обычно мы хотим чтобы это все еще была в одном как бы продукте что могли встраивать это наши соседи pipeline например чтобы у нас всегда была возможность создавать приложения по одному и тому же типу одно это уже вида переносить там какие-то практики по созданию приложений с одного приложения на другое и давайте посмотрим в целом на наше приложение на наш кластер любой кластер начинается с его клиентов то есть у нас есть какие-то клиенты с этими данными например банки телекомы какие-то финансовые компании эти клиенты они складывают данные в наш кластер или берут оттуда данные и первое что наши клиенты встречают на всем пути это роутер роутер это такой instance нашего приложения который распределяет запрос по всему кластеру он понимает куда ему нужно сходить записать данные откуда эти данные нужно прочитать и конечно же у нас сюда есть стороны которые наши данные хранят и это уже можно считать кластером то есть у нас есть разные типы инстансов и каждый из них в кластере выполняет определенную роль роутер и road запросы с тораджи хранят данные и мы можем добавить новые intense наш кластер это же назначить ему какую-то роль то есть новая инстанцию нас сюда тоже выполняют определенную роль в кластере то же самое когда она становится больше клиентов появляется потребность в масштабировании входных запросов и мы добавляем роутер тоже новые инстанции нашего приложения у которых будет роль роутер и конечно же мы хотим заботиться надежности поэтому у нас должен быть в кластере какой-то элемент который это надежно обеспечивает например какой то failover который будет заботиться о том чтобы наши инстанции всегда были доступны на запись и назовем какой-нибудь instance пускай он будет координаторам нашего файла вера и это тоже instance нашего приложения элемент нашего приложения у которого будет rolex laver координатор и пускай он данные текущих текущем состоянии кластер будет записывать какое-то надежное распределенное хранилище которое будет вне нашего кластеров чтобы могли не заботится о том что нас внешняя хранящая вместе с нашим по что она сохранив его вера вместе с кластером у нас упадёт и также мы можем добавлять наш кластер какие-то дополнительные элементы например нас появилась потребность в репликации данных откуда ты еще например и 40-го и мы можем включить наш кластер какой-то instance который будет эти данные и 40-х доставать отправлять их на роутер и и роутер и будет складывать эти данные по сторонам и мы сделали в таранд или мы сделали такой продукт который собственно занимается кластерами он называется картридж что такое картридж это фреймворк для создания распределенных классных приложений он нас позволяет автоматизировано пролез кластером точно сам заботится об основных вещах в кластере он автоматически сортирует данные также мы все там у нее есть какой-то набор ролей которую можно назначать на деятельности нашего приложения также мы можем функциональность этих ролей расширять и в карты же есть failover и множество инструментов например тестирования для администрирования для диплом и мониторинга да и давайте теперь поговорим что вообще лежит в основе картриджа в основе карт уже лежат множество инстансов инсов трандла для тех кто не в курсе что такое тарантул это платформа для янамари вычислений это одновременно и базы данных в янамари она сохраняет данные на диск всегда то есть мы можем не забудется том что наши данные пропадут куда ты запирательный памяти потому что не всегда сохранился на диск но при этом тарантулу еще и сервер приложений то есть мы можем написать какую-то логику на языке в эта логика будет крутиться рядом с нашими данными и обращаться к ним и тарантул поддерживает репликацию в тренд или сейчас есть асинхронной репликации и мы будем называть набор инстансов которые соединены между собой репликации и рипли кассетам европе к сети есть два типа инстансов первое это мастер в мастер можно писать данные остальные это реплики в принципе тарантул поддерживает мастер мастер то есть можете назначить несколько инстансов они будут мастерами некоторые будут репликами и тарантул поддерживает шарди рование ананас реализовано с помощью модуля лишат дополнительного и есть два типа инстинктов лишь rd1 это роль роутер my short роутер будет определять на какие стороны нужно отправить наши запросы и есть и шерсти тораджи сторону нас хранят данные данные нас хранятся по кусочкам собаки там могу называть бакетами и лишь works торджи суп найти данные хранят и заботиться о том что эти данные будут куда-то пережать если мы добавляем новые стороны в кластер то лишь арт сам определит мы когда сконфигурирован сам определить что нужно часть bucket of перевести куда-то на новые стороны его наши данные как то ли балансирует и собственный из этих кусочков у нас собирается картриджный кластер у нас есть отдельные инстанции тарантула эти инстанции у нас объединяются асинхронной репликации в рипли кассеты дальше если usb является необходимость мы можем эти данные по сортировать как это добавить роутера добавить назначить что ребекка сета будет сторожами и из этого у нас собирается наш картридж и давайте теперь поговорим про руль и до этого я уже говорил что каждый инстинкт в кластере выполняет какую-то свою определенную роль и собственно так и называются у нас логические кита модели в тарантас картриджи они называются ролями что такое роль роль это у нас ло модель гранту использую это языка поэтому нас все роли в картридже пишется на лугу роль это какая-то бизнес-логика если можете написать например какое-то свое хранилище и вы должны представить специальное api у карточных ралли есть своя фишка по ним и поговорим мы слышим слайде и также роль всегда назначается на реплика сет на набор реплик и она будет включена для каждого инстанса из рипли кассета и роли можно написать так чтоб их можно было конфигурировать без изменения кода у каждой роли есть своя конфигурация вы можете написать описать api так чтобы вы могли конфигурировать роли не меняя от и собственно у каждой роли своя структура у нее есть функция и нет в которой производится собственно действие понять и лизации наши роли например из этого выпишем ходит а сторож то в нет в нете мы напишем создание трантон их списав в создании индексов чем какие-то действия которые нужны на старте роли еще есть две функции для конфигурации в ledel конфиг apple конфиг ну собственно выжили конфликтом проверяешь там из конфигурация которая приходит она нормальная что с ней все в порядке apple и конфликт эта конфигурация применяет то есть в этом месте вы можете описать то что мы делаем когда к нам приходит какая-то конфигурация нашей роли ну и функция стоп соответственно завершает работу роли и ролей есть механизм зависимости то есть мы можем указать что наша роль зависит какой то другой роли это важно к этому мы придем чуть позже у нас есть встроенный роли в сам картридж их три штуки это лишь арт роутер или шар сторож они используются для управления вешшер дом в как в кластере для сортирования я уж говорил ли short роутера у нас направляют запросы к стражам без шор стража хранят данные и заботиться о том чтобы эти данные акта переносились на новые инстанции тарантула которые мы добавляем в кластер также нас есть север координатор он управляет фоловерам в кластере и так же у нас есть внешние роли например самый полезный них это тарантул metrics который собирает метрики приложений также у нас есть крут роли грудь сторож и крут роутер это на самом деле такая настройка на 2 шард сторожем и иви шартра утром которая упрощает взаимодействие с шарнирными спицами strand или также другие роли и давайте теперь посмотрим на зависимость между ролями когда мы пишем какую-то свою роль мы должны указать ее зависимости если они есть допустим мы написали свое какое-то кастомное хранилище данных стали роль в роли мы создаем space и и мы можем оказать ей в зависимости крут сторож в свою очередь нас крут сторож зависит и шар старриджа и когда подойдет делокализации нашего бластера кортеж гарантирует что у нас сначала бы запущен лишь артур эш потом будет запущен крут сторож и последний запустится наша кастомные сторож это есть в каждой этих ролей мы используем функции из зависимых ролей у мы гарантируем что эти функции уже нецензированная они уже работают во время старта нашей кастомной роли и так как у нас все инстанции тарантул 70 и картриджа это трамплины и приложение вход хана я . нашего карте же тоже будет love файлом которым запуском че тарантула и в нем обязательно жить и провести конфигурацию нашего мастера этого иван общие для всех инстансов картриджа на каждом нужно выполнить вызов картошка с г и в него нужно обязательно прокинуть исак ролей которые должны быть доступны в карты в кластере если мы эти роли не прокидываем то в кластере они не появились также мы туда можем это дополнительно опции засунуть который мы хотим чтобы вызывались вместе с нашим карты шкафы г.и. давайте посмотрим все таки как мы можем масштабироваться с помощью ролей пускай у нас будет какой-то маленький кластер из двух инстансов один будет роутером 2 будет сторону и через какое-то время у нас появляется необходимость эти данные резервировать ну допустим этом запустили тарантул поиграли с ним а потом мы решили отправить его ну в провод или на тест и мы хотим чтобы у нас данное реплицировали чтоб у нас не просто один из нас был чтобы чтобы 2 на всякий случай если вдруг первый упадёт и у нас появляется необходимость добавить новые реплики в кластер для резервирования рассказал может быть мы хотим часть запросов отправлять на мастера часть запрос управлять на реплики и мы добавляем наш кластер новый инстанции и назначаем ему роль сторож он добавится в существующей рипли кассетным указываем что он добавляется существующей рубрика set in него начинается роль сторож и дальше у нас проходит время нам память мы уже занимаем какую-то и нам не хватает памяти которую мы предоставили первом инстинкте тарантул в первом стороже вас появляется необходимость добавить памяти например нас там уже 80 процентов мы видим что она скоро закончится на добавить новые сторону или мы там по графикам как-то смотрим видим что с память все время растет мы хотим как-то page радировать и мы можем опять же добавить два новых инстансов картридж объединить их в рипли кассет и назначит у них роль сторож и кортеж сам поймет что у нас появились новые стороны что нужно значит данные со старых сторожей распределить ещё и на новые он сам перевезут данные перевезет нужные bucket она может не стороны и проходит время у нас кластер же работает и в какой-то момент понимаем что нам не хватает роутеров у нас появилось больше клиентов например или мы видим что у нас наши роутер и не справляются с нагрузкой что у них танцы полу в сотку уходят что не тяжело процессе запросы мы можем добавить новые роутер и тоже никаких проблем просто добавляем новые инстанциям начально них роль роутера и наш кластер дальше растет растет растет и в какой-то момент она появляется необходимость добавить новый бизнес-логику там появилось новое задачу нашего кластера и мы всегда можем это новый логику написать с помощью кода написать какую-то свою роль и добавить ее в наш кластер и ролевым принципе можем назначить на уже существующем птенцы таранд вам на счету личность нас и кортежа вот здесь мы например написали какую-то роль для мониторинга и мы запустили только на роутерах потому что мы так хотим в принципе могли бы запустить новый инстанции назначить на них эту роль отдельно от всех остальных но картридж не ограничивается нам количество ролей которые запущены на каждом инстанция в принципе можем все роли назначить на один instance если это необходимо и до этого я уже знал что в карту же есть конфигурация она в принципе не обязательно но в ней есть парочка важных моментов без которых мы жить не можем в пластами конфигурация она хранится у нас на каждом узле в ней содержится настройки топологии то есть список всех инстансов всех реплика сетов и настройки шарди рования и на стул конфигурация может быть ран тайме но мы хотим всегда чтобы она одинаковая на каждом из инстансов таранова чтобы нас ничего не сломалось чтобы везде конфигурация была одинаковая и поэтому мы его распределяем следующим образом когда если вдруг поменялось на каком-то из инстансов эта конфигурация разряжается по всем остальным но затем наше инстанции проверяет что нас конфигурацию пришла валидная что нас ничего не сломается после его запуска должно нечего соваться у нас проверяется это все и если вдруг какой-то из инстансов сказал что нет эта конфигурация мне не подходит и не могу принять какой-то причине то конфигурации по всему кластеру откатиться и не будет применена допустим и там ошиблись в какой-то строчки в конфигурации у нас один из вас говорит нет конфигурации плохо дело не принимаем на откатывается затем мы поменяли эту него ли дну строчку в конфигурации мы снова применяем она разряжается все инстанции говорят нам все хорошо конфигурация валидная я могу я применить и эта конфигурация теперь уже сохраняется на каждом из инстансов и она применяется на них с помощью функций роли кто называется play конфиг и даже если там умеет что-то пошло не так вдруг она не применилась по каким-то причинам apple и конфликт в эту ошибку мы можем ее насильно перри применить этих поломанных сторонах инстансах карточном это позволяет да и мы поговорили уже про масштабирование но не затронули еще тему надежности да у нас есть верификация но в дефекации не всегда достаточно нам необходимо что нас не только данные реплицировали значит ну чтобы у нас кластер сюда был доступен на запись и для этого в картаже есть файл over flower у нас это отдельная роль который начинается на один или несколько не нас кортежа и она следит за всеми остальными in some смотрит они упали кто-то вдруг кто-то сломался высшего строя или перестал отвечать каким-то причинам и failover это заметят он видит что какой-то из инстансов умер и он отправит на другой энтин запросу скажет все теперь и ты новый мастер теперь запросы на запись будут идти в тебя и эти данные на еще сохраняет как я уже говорил во внешнем распределенного кунта независимо хранилища и теперь если вдруг наш предыдущий мастер который сейчас умер если вдруг он вернется восстанет из мёртвых то мастером он же не станет потому что мы сохранили в какой-то внешней конфигурации что мастер теперь другой instance и также в картридже у нас есть множество различных инструментов у нас есть инструмент для администрирования у нас есть замечательный клип утилита карты школе она позволяет создавать шаблонное приложение то есть одной команды может создать код шаблончик можете его сразу же уже запустить поиграться с ним или уже сразу начать писать код на основе этого шаблона у нас есть фреймворк latest взять тестирование таранто во и для него написаны хелперы которые позволяют нам написать специальные тесты которые будут тестировать кастер целом то есть мы можем описать как то кластер в тестах и можем запускать иммиграционный тесты с каким-то маленьким тестом кластером сразу же в тестах нас есть набор инструментов для мониторинга это как я уже говорил в роль metrics которые собирают метрики с наших приложений в метрике мы потом можем отправить в наш специально написанные графа носки дашборд и мы всегда можем посмотреть на где обвивает мастера нашего и посмотреть все ли с ним хорошо посмотреть сколько она там поймите уже занято посмотреть а нет ли каких-то проблем пробивают напишут что потому что случилось на посмотреть что-то исправить или он даже может предложить некоторых случаях пути при исправления нашей проблемы там будет кнопочка исправить все что все было хорошо и тепло и мы делаем с помощью антипу картридж и давайте теперь все это резюмируем мы начали ставили какие-то задачи которые старят стоят перед нашим кастерам давайте перед резюмируем для в масштабируемости в картридже у нас есть роли роли назначаются на инстинкты тарантулы который нас участвует в кластере с помощью ролей можем масштабироваться есть мы всю нашу логику выносим в роль эту роль мы можем назначать на новые инстанции которые добавляем наш кластер эти роли позволяет нам сортироваться они управляют и шар дом то есть когда мы добавляем новый instances наш пластилин очищаем на них роль не шар сторож они сами башар дерутся и запросы буду идти уже на новые инстанции и для надежности нашего пластика у нас есть дефекации оперов которые идет сюда вместо странного и есть flower который заботится о том что чтобы наши всегда были доступны на запись и для поддерживать у нас есть куча инструментов которые мы можем передать нашим администраторам или написать с помощью них диплом мониторить из нашей инстанции с помощью наших инструментов и завершающим наверное информации будет о том как себя кортеж ведет вроде небольшая статистика нас на картридже написано наверное уже больше ста витрин некоторые из них просто так уж и они там стягивай данные и 40-го например или из других каких-то баз данных есть также нас мастер хранилища в которых хранится информация которая ниоткуда не стягивается просто реальные продавай серьезные данные которые нам ни в коем случае нельзя потерять и кластер у нас бывает совершенно разного размера бывают очень маленькие от атомарные практически кластеры из парочки инстансов и также есть огромные plaster и на 500 инстансов и они хранятся себе от нескольких мегабайт до нескольких тиром например я вот работал над кластером в котором было два терабайта данных и практика нас такая что мы всегда помещаем мастера реплики в разные соды чтобы быть независимо от того что нас в пункт соде может быть электричество выключили он сгорел мы сюда их размещая в разных сводах чтобы мы не зависели от всходов и каждый у нас есть много заказчиков которые используют картуши своих кастерах для по страниц своих мастеров и у каждого из них у нас написан специально и соседи pipeline кто-то использует дженкинс сказал использует что другое нас всегда есть какой-то pipeline по которому каждое новое карточное приложение которое создается все стадии она проходит этого pipeline то есть это и тестирование и создание приложения какой-то мониторинг выкатка его на тестовые зоны на родовые зоны настройка логирования настройка мониторинга и в целом в картридже очень много частей которые перри используются например нас есть хорошая практика что есть несколько ролей написанная какую-то конкретную задачу мы как-то очищаем выносим на общее пользование эти некоторые из этих ролей у нас остается только в рамках одного заказчика только они из их используют но не шарят их между своими проектами некоторые мы вынесли open source например роль metrics у нас частично уже вынесено в open source и все механизмы которые там час лежат у нас были изначально где-то сделаны в закрытых контурах и я говорю про диплом но про диплом лучше расскажет мой коллега рома про скин он выступает завтра в 1350 в соседнем зале а в зале пуффендуй переходите к нему если вы хотите послушать справа то как мы делаем диплом и на этом у меня все вы можете задавать вопросы к нам в чате можете писать мне в личку у нас есть также тренд и начнет может сюда тоже приходить задавать свои вопросы и приносите свои шью ко мне в репозитории а вот вы носите парик теста и на этом не все спасибо за внимание давайте передём к вопросам игорю здоров спасибо большое уже есть вопросы я прежде хочу тебя поблагодарить за то что так нам пришел рассказал все это для меня лично важна эта история как у как это все сделать когда незнаком продукт и кажется у нас есть даже для докладчика подарков я уже выяснил на прошлом докладе что это термос и отлично по сезону да спасибо тебе огромное остина до муж пока поставить потому что тебе предстоит непростая интеллектуальная задача выбрать лучший вопрос и первый вопрос у нас уже есть ребята если вы в онлайне нажмите кнопочку рядом с трансляцией вас там встретят и расскажу что делать чтобы появиться в фильм zdravstvuite панюков лекси изверг вопрос картированию рассказывали про сортирования если какие не будут все варианты сортирования данных по кластером исходя из собственных данных которые мы там раскладываем еще раз вопрос есть ли возможность сортирования данных по собственным шарфом исходя из самих данных раскладывать их по типам да ну да конечно данные карты решали руется паба китай де оба китай где вы сами задаете то есть вы можете выбрать это какой-то ключ родирование он может быть составной и вы можете построить на нем хэш и распределить данные по сути мы с клинской частью грубо говоря управляем тем куда он разложился до навыки и вопрос о собственной репликации настроек пожар дома космос на по всем остальным бизнесам вы говорите что каждый элемент бластера хранит у себя данный если какая-нибудь там master master sport для этих данных откуда на все страницы где там источник правда у конфигурированию еще раз ваш вопрос есть смотрите у вас есть некоторое количество инстансов да вы говорите что конфигурация дублируется по всем инстанциям правильному не надо кто является источником провода по этой конфигурации любой из нас может являться источником конфигурации то есть мы можем например зайти на какой-то instance его убивает там будет формочек где можно вести новую конфигурацию он распределиться сын свинство на котором вы находитесь то есть это может быть любой элемент кластер а он сам будет распространять эту конфигурацию по всем остальные соответственно конфигурация распространен и транзакционных сразу везде да и спаси большой привет спасибо за доклад а вот хотелось бы подробнее узнать про метрики а ты говоришь что метрики включает 2 которая собирает метрики а как собирается какое-то приватное состояние компонентов то есть ну если это как динамическая который добавляешь как она залезет в приватную часть какую-то которую приватную часть чего вот ты учился модуль метрик даже как она соберет какой то станем не знаю сколько байт посети отправлено как она об этом узнает ну это роли она включается вместе с нашим работающим приложением и она имеет доступ ко всему в общем у нас все роли всегда имеют доступ ко всем спайсом это же однопоточный тарантул то есть мы сюда можем любому устройству подключиться к эти метрики с него собрать или какие-то системные за метрики тоже собрать ее вынести их и отправить куда guides если я верно понял то получается что вот это вот роль метрика она может грубая в глобальную любую переменную то есть переменные публичные что ли получается так то есть она любой можете читать тут вопрос такой следующее что если как бы вот ну код который предоставляет метрику рефакторинг эта как об этом узнает модуль метрик то есть я потому что вот модуль метрик он лезет по какому-то пути там компонент один компонент 2 компания 3 вот здесь все еще лежит если ты просто 3 фактор ишей компонент 2 перемен уж как об этом узнают метрики ну метрики например они наверное не так сильно зависит три факта мира код потому что они не собирают что конкретно они в общем целую картины представляют там сложно что-то паре factory так чтобы метрики перестали отдаваться правильно ты же граждане не отдаются они собираются типа вот этот модуль он собирает их невеста ты просто переменную переименовал внутри классно как об этом метрика то узнает дмитрий ну я говорю что метрика нас не зависит от таких названий переменных они просто проходятся по всему и сыграют это то есть на что-то поменяется то мы об этом знаем потому что это же будет новый какой-то компонент с которым вам отдавать метрики надеюсь я правильно поняла починили мне микрофон ребята поднимаете руки заранее пожалуйста с тем чтобы мы ориентировались кому принести микрофон если сейчас кто-то из вас хочет задать вопрос дайте об этом знать а есть вот и гордись вот-вот своих супер онлайн давайте активнее если вы решитесь то вы без очереди зададите вопрос спасибо за доклад меня наверное вообще вопрос про тарантул раскат вообще отработает транзакционный а модель в случае shotgun да да то есть когда мы пишем какую-то одну моду и у нас на всех репликах эти данные будут заблокированы пока транзакция не раз катится или мы на чтение будем получать что старую версию пока вот но транзакция для всех реплика нашего plaster они дают то есть 1 вопрос будет ли во время переезда bucket of какие-то ошибки чтения правильно ну во-первых до при переезде а во-вторых просто когда мы пишем мастер если правильно понимаю да то есть весь мастер куда мы записываем обновляем данные и потом это но это обновление раскатывается по репликам то есть вопросы когда мы конфигурацию меня никогда просто что-то пишем обновляем на proz родирование у нас конечности дайте баки то будет доступна то есть пока он полностью не приедет он будет доступен с того места где он был раньше то есть у нас невозможна такая ситуация когда мы запрашиваем а его уже нет поэтому мест второй раз вопрос можно еще раз погромче нога у то есть мы обновляем какие-то данные это происходит в мастер мастер инстанции и потом это обновление данных раскатывается с мастера по всем репликам если я правильно понимаю вот пока вот этой раскатки не произошло ну то есть там не знаю наносекунды миллисекунды то есть треплет мы можем читать старые данные или мы вообще не читаю треплет но у нас а синхронная репликация и у нас есть какой-то лак то есть каком-то промежутке времени нас эти данные на реплики еще не пришли поэтому называется может возможно грязное чтение судя по этой глупой вопрос спасибо"
}