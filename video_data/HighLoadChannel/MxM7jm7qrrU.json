{
  "video_id": "MxM7jm7qrrU",
  "channel": "HighLoadChannel",
  "title": "Миграции между схемами и обновления в MySQL: механизмы, блокировки, нагрузки / Николай Ихалайнен",
  "views": 657,
  "duration": 3013,
  "published": "2021-10-04T02:42:06-07:00",
  "text": "чтоб базу интересной не только чинить ну и в ломать alter the bow это такой замечательный способ который позволяет базу ломать очень незаметно для программиста или системного администратора надо выяснить зачем все-таки это событие происходит какие есть альтернативы все-таки если мы говорим о реляционной базе данных mais quel есть слухи что если бы это все было переделано под новую скале режим то нам бы повезло также mais quel нам обещает что ну зачем вам учиться с миграциями вы знаете у вас есть онлайн диди ель а если он онлайн значит ваша база данных будет онлайн в процессе всего неделя которые вы напишете виде деле это alter the ebook rainbow и прочее несмотря на это существуют какие-то сторонние утилиты которые делают похожие вещи и тоже называется онлайн и базы данных часто бывает ни одна часто у нас бывает какие-то ещё дополнительные костры и вот как онлайн детей происходит в этот при репликации кострах почему у нас вообще возникает идея что нам надо поменять что-то в базе данных можно придумать такую замечательную структуру которую мы будем использовать все сотни лет последующие если посмотреть на базу данных mdb это крупнейшая база фильмовой а вот они как выкладывали десяток лет назад свою базу данных в cs в формате так вот и сейчас можно в том же самом формате получить эту базу и вы можете ее загрузить и там будут самые последние фильмы которые вышли за все эти годы все таки если мы просто имеем табличку табличка эта структура а кроме этой структуры нам надо понимать какие запросы будут работать быстрее какие медленнее нам надо для быстро запросов сделать специальные индексы для того чтобы все таблички не смотрелась кроме того каждый раз когда мы базу придумываем мы точно не знаем какие типы у нас будут в базе данных например еще пару десятков лет назад никто не сомневался что пол для указания хватит только бульон по сейчас это уже не так очевидна для крупных компаний также приложение не стоят на месте им нужно сохранять новые данные даже в старых объектах раньше мы считали что нам хватит 5 колонок а сейчас у нас может быть другое мнение по этому поводу или мы можем решить что название недостаточно хорошо отражает внутреннюю сущность достаточно крупная проблема которая была решена с появлением у это f8 много- байт него много байт ных кодировок это русский язык китайский язык арабский языки если у нас старая база данных то нам придется перейти на правильное utf-8 и это тоже вызовет истертый был мы не только добавляем в базу данных если наши базы данных большая то она будет требовать много памяти много дисковой пропускной способности и работать не сильно быстро если мы удалим все не нужно из базы данных то она будет быстрее мы можем удалить пустое место перестроить всю табличку с помощью alter the ball название таблицы force или как раньше было модно alter темпл название таблицы engine равно она тебе естественно не нужный индекс он тоже занимает место надо его удалить также с колонками более распространенное частая вещь это может происходить 1 месяц когда у нас есть большая таблица разделенная на партиции и мы одну партицию просто удаляем каждый месяц наши данные они находятся в физически в каком-то месте мы можем использовать синтаксис той был space для того чтобы указать а где находятся наши данных наша таблица в каком месте на диске в какой директорий и отделить эту директорию от всех остальных можно сжать базу данных чтобы она меньше места и его на диске можно и и зашифровать главное чтобы ключи потом остались наша база данных содержит отдельные строчки строчки с одной стороны мы как разработчики не смотрим на то как ой какая колонка идет за какой колонкой но внутри базы данных это может приводить к тому что мы записали что сначала идёт колонка а потом идёт колонка b если мы решили поменять их местами может понадобиться перестроить все строчки во всей таблички для сотен тысяч десятков тысяч строчек это легкая операция для миллионов и миллиардов это уже очень непросто и для каждой строчки надо сделать изменения у нас есть жесткие типы в реляционных базы данных если когда-то проектировщик решил что хватит смол int для типа то через десяток лет может обнаружиться что 65000 значений это не то чтобы сильно большое число еще такая же проблема возникает of the ian carey ментальными колонками потому что многие компании начинают маленькими потом растут и выясняется что 4 миллиарда это тоже не самое большое число это даже меньше чем людей на планете наши классы которые описывают данные они содержат поля если мы представляем этот класс в реляционной таблички он может лечь на несколько реляционных таблиц за счет нормализации это же нормализация нас заставят для проверки консистенции сделать внешние ключи и тогда когда мы меняем поле которое завязано сразу же на несколько табличек является внешним ключом мы будем менять не одну табличку сразу несколько или даже много когда встает вопрос о том что нам надо будет периодически может быть развод может быть разместиться как у нас релиза идут менять очень много строчек можно задуматься может быть мы вообще перестанем это делать тем более новость quelle мир предлагает нам такую хорошую мечту о том что вообще нам не надо делить на реляционные таблицы на наших класс вот давайте мы весь класс вместе с под объектами которые массивами расположена внутри этого класса расположен прямо в документе чем это хорошо хотим вам показать этот объект класса на какой-то веб-страницы или форме мы запросим только один документ и у нас уже будет готовая страничка нам не надо делать много запросов мы делаем один запрос получается быстрее чем у нас было бы с любой реляционной базы данных меньше таблица меньше головной боли что мы что-то не понимаем в базе новый разработчик когда придет он сразу поймет что вот у нас три коллекции в них работы в чем сложность несмотря на то что у нас есть документы то нам нужно искать специфические документы по конкретным полям значит мы должны достать это поле положить его в виртуальную колонку и по этой виртуальной колодки сделать яндекс то есть яндекс и выглядит точно так же как эволюционной модели более того если мы поменяли наш формат документа да мне нравится какие-то полях мы не можем перестать искать по старым полям до тех пор пока мы не поменяем формат всех документов внутри системы начали мы с того что не хотели менять все строчки в какой-то таблицы а теперь выясняется что у нас коллекция она стала более жирная потому что она содержит более сложные объекты и нам надо менять каждый документ внутри этой коллекции но хотя бы это можно сделать как-нибудь потом а пока это потом не наступил у нас в коде будет сразу же или условия или сразу функции которые обрабатывают разные значения для того чтобы поддерживать и старую и новую версию в моей сколь было все очень плохо с документами до момента появления моей сколь 8 мая сколь 8 можно делать индексы не только на поле в конкретном документе мой сколь считает документ чей сон отдельной строкой в своей лекционные таблички а на одну строку мы могли сделать только одну строчку индекса что если у нас есть массив с например почтовыми индексами где мы ожидаем человека и нам надо искать человека по конкретному индексу получается что в нашем специальном индексе будет на одну строчку на 1 документ сразу несколько записей в индексе яндекс будет не тысячи строчек для таблица с тысячи документов а он будет 10 100 million то есть он будет значительно больше это распухание было причиной почему таких индексов не было но сейчас мы искали есть индекса пути войдет индексы multi-way лет яндексе работает так же как и другие индексы основаны на очень рейтинг аламс если посмотреть например то мы меняем таблицу к саммерс и в таблице каста мир съесть джейсон документ и джейсон документе есть массив который называется zip code и там находится наши почтовые индексы если мы при селекции будем использовать немножко другое выражение не то который мы указали изначально при создании этого индекса то мы скрыли он достаточно глупы и он не понимает что пав который мы указали для джейсон элемента он одинаковый вот мои сколь и не поймет и поэтому не будет использовать индексы будет внезапно делать фото и busco ну хотя бы для правильно сделанного выражения у нас все будет работать следующая проблема которая возникает с документами то что приложение особенно приложение на си плюс плюс или на java на всех языках где программисты любят точность аккуратность в типах данных она может падать из-за того что мы вместо целого числа передаем строку потому что для программиста на таком серьезном языке программирования очевидно что если нам вместо данных передают какую-то фигню то надо выдать ошибку как можно раньше чтобы этого не происходило не надо эту фигню вставлять в базу данных чтобы не вставлять в документы ориентированную базу данных нам нужна схема если мы используем джейсон есть валидация джейсон документов в мой сколь который позволяет задать ну хотя бы какие-то границы внутри нашего джеймсон документ чтобы было не скучно тем программистом который не очень хорошо разбирается в морской или по каким-то причинам и не очень хорошо могут писать sql появился протокол моей сколь x этот протокол расширяет возможности самого mais quel и и позволяется ним работать не только как соску или база данных но и писать запросы в джейсон подобном синтаксисе получили connect получили как коллекцию или создали ее новую и после этого в эту коллекцию вставляем очень похожи на мозгу вот если вам нравится такой стиль вы можете с ним работать что же мы получаем если у нас нет реляционной структуры и используются документа индексы они всегда будет функциональные всегда это и generate от каллум с или virtual colors в морей деби и уже на основе этих колонок на основе какого-то выражения мы делаем индекс если мы делаем опечатку в название поля то яндекс создаться но к сожалению он не будет сработать как мы ожидаем если мы не вы лидируем полях если мы не внимательно следим за тем что мы вставляем то у нас будут документы которые не удовлетворяют условиям нашего поиска но при этом все еще будет в базе если мы неправильно выбираем как нам составить документ то база данных будет содержать много одинаковых вещей берем форму там есть какие-то посты есть комментарии к ним если мы располагаем и посты и комментарии в самом объекте в самом документе пастой с у нас есть все комментарии пользователя то вроде как у нас все данные для отображения есть и нам не требуются никакие дополнительные коллекции когда мы начинаем плюсом к этой коллекции делать там коллекцию пользователей может выясниться что пользователь два года назад написал сообщение потом он поменял свой ник и существующие читатели новые читатели они совершенно не понимают а кто это потому что такого пользователь с таким именем больше не найти либо нам надо лезть сразу в несколько коллекций и не менять во всех местах при любом изменении следующая проблема то что один раз записав какой-то формат документа в худшем случае мы должны поддерживать все промежуточные формы этого документа вплоть до настоящего времени в лучшем случае мы делаем правильную проверку любых полей у нас есть готовность к тому что поле может иметь несколько имен в документах то есть это достаточно серьезная лапша из кода вторая проблема связана с тем что у нас есть старая имена полей в том что яндекс и мы должны делать либо из выражений которые будут включать и старое поле и новое поле или яндекс должны жить вместе или старые индексы должны быть и новые индексы и мы никогда их не удаляем и закончится все это тем что индексы будут у нас занимать гораздо больше места чем сами данные и может быть совершенно редко использоваться и не используется вообще и новые индексы нам так же как и с реляционными таблицами надо добавлять то есть какое счастье нам дает скинулись подход то что мы можем легко добавить новые поля а для остальных задач у нас все-таки остается проблема вернемся к реляционным схемам как нам с мигрировать стой версии которая сейчас стоит разработчика на ту версию наоборот 100 версии которая сейчас production а мы хотим новую версию так которая стоит у разработчиков что надо сделать надо найти разницу из этой разницы мы должны составить запрос актер treble для новых таблиц соответственно мы должны составить запрос и корейцы был но я хочу сконцентрироваться именно на запросах alter ты был потому что они наиболее сильно влияют на жизнь нашей базы данных мы собираемся делать много работы если мы собираемся делать много работы значит эта работа будет мешать существующей нагрузки значит в худшем случае нам надо выключать нагрузку то есть полностью выключать наше приложение на все время миграции а это может быть иногда часы иногда дни то есть достаточно серьезная проблема в худшем случае все таки если не удается получить такое окно мы хотя бы должны найти то время когда у нас нагрузка будет минимальную приложение не ожидает чаще всего что в базе данных будет находиться и старой схемой новой схемах поэтому как только мы начнем менять базу данных приложение будет работать не правильно поэтому чаще всего его отключают ждут пока все изменения будут сделаны или часть приложения отключает которые относятся к этой таблице и потом уже обновляет приложение наша crate apple она содержит список полей и несмотря на то что иску или не гарантирует и даже не обещает то что у нас будут поля в том же самом порядке сохраняться в базе практически во всех базах данных не исключаем майской структура в crate ибо он напоминает то что физически расположена в строчках на диске значит нам может понадобиться остановить работу всей базы для костров или остановить работу только для конкретной таблицы или если нам все-таки везет мы сначала делаем что-то с таблицей что-то быстро а потом долго-долго делаем с отдельными строками и опять же если нам везет то у нас получается выполнять параллельные запросы вместе с нашей миграции что же позволяет остановить доступ к таблице когда мы делаем alter ты был в войска иль есть system log off метаданных me to do the logs me to do the logs работает на уровне транзакций и будет очень неприятно если транзакция пытается вставить какую-то строчку и прямо в процессе этой вставки поменяется структура если мы ещё раз вспомним что структура в которую мы описали она близка к тому что мы увидим на диске c + + приложение они очень не любят когда они работают с отдельными кусками памяти а потом внезапно у этих кусков памяти меняется размер если такое происходит всего лишь + приложение начинает писать в неправильное место в памяти и получается либо каша из данных либо само приложение спешит завершить свою работу чтобы не сделать еще хуже чтобы этого не происходило есть блокировки блокировки на таблице это как раз блокировки метаданных для этой таблицы и как они работают если у нас есть транзакции мы не должны ей помешать значит если транзакция сделала select или какой-либо другой запрос для конкретной таблицы эта транзакция получает шире флаг то есть такие вещи могут работать параллельно параллельно с другими транзакциями но не с alter the и бог не с запросами который меняет структуру запросы на изменение структуры должны получить эксклюзивную блокировку вспомним нам нужно получить список изменений между старой структура базы данных и новый нужны open source утилиты которые будут это делать есть очень старая утилита написанное на перле которая доступна через по на удивление на она даже работает с новыми версиями сколь вы указываете хост удаленный указывайте пользователя и указывайте какие базы и после этого у вас получается в виде результата список картеров которым вам надо выполнить вместе с комментариев что это вообще происходит здесь утилита с таким же названием из mais quel utilities кто использовал майскую летели this хотя бы раз вот замечательно это уже устаревшая технология несмотря на то что там были полезные программы орков решил что надо мигрировать с отдельных python скриптов на плагины для мая сколь сел к сожалению май сколь div и из майскую utilities не работает с майской 8 но и в майскую решил нет такого плагина который позволял бы видеть разницу между базами данных есть графический редактор sql тоже от орков которая позволяет редактировать иска или смотреть схему увидеть результаты запросов и мигрировать между базами данных к сожалению на текущий момент самая сколь 8 он тоже нет не работает и выдает большой большую ошибку поэтому school мы приходим к тому что либо нам надо использовать самописный способ изменения или бы нам надо использовать сравнение между темпами баз данных дам в мае сколь можно сделать без данных и он будет очень маленький и очень быстро делается без всяких блокировок берем в любой редактор который позволяет видеть разницу видим хотя бы какие поля поменялись какие индекса надо добавить получив все эти изменения мы должны решить что делать все сразу как то изменение эти применить или по одной таблички это делать и раз мы решили делать индекс что мы сначала сделал индекс 1 потом сделан индекс 2 как лучше что значит все сразу значит мы удалим все данные вместе со структурой создадим новую структуру а потом загрузим данные выглядит безумно но если у вас десятки тысяч таблица очень маленьких и надо произвести изменения сразу в большом количестве таблицы это работает достаточно быстро еще проблема невозможно взять и поменять тип в френки в моей скайлер которая относится к сразу к большому количеству дочерних таблиц даже если вы выключаете проверки на внешние ключи поискали все равно не даст поменять тип он вас заставят либо удалить фон тиз со всех этих таблиц либо вы должны все удалите все загрузить mais quel позволяет объединить андертейл который вы делаете несколько запросов для одной таблицы в один запрос надо колонку и сразу индекс к ней мой скальп будет делать меньше работы он будет сразу же менять структуру и добавляйте этот индекс когда мы ищем оптимум производительности нам может показаться что индекс хороший а другой индекс плохой но пока мы не попробуем мы не узнаем что происходит если менять добавить сразу много индексов оптимизатор может запутаться какой выбирать и выбирать неправильный или даже при наличии правильного индекса работать медленнее потому что то что не используется но все равно занимает место и в памяти и на диске как все происходит от 10 ball либо мы копируем все табличку либо мы что-то делаем внутри таблички либо мы делаем мгновенная стертый болт идеал это конечно же мгновенно alter ты был зачем нам чего-то ждать если мы сразу можем применить все наши изменения копирование сопряжено с полной блокировкой это самый старый вариант alter ты был который существует в морской и пока он выполняется этот алгоритм копирование то мы не можем не select и this таблички не записывать ничего чтобы не быть голословным нам надо понять из чего вообще состоит выполнение остер ты был для любого запроса в морской с помощью пифом эскимо мы можем получить стадии из которых состоит сам процесс вообще стадии видны в табличке wins the scoring но там видна только одна стадия для того запроса alter который исполняется прямо сейчас чтобы понять что он делал вообще мы должны включить instrumentation для стояв и включить сохранение для истории что мы здесь видим у нас стартовал запрос потом мы проверили имеем ли мы доступ вообще к таблице потом мы таблицу должны открыть потом мы создаем какую-то таблицу потом мы получаем блокировку на наш первоначальную таблицу копируем все данные в во временную таблицу переименовываем временную таблицу чтобы она имела нормальное имя и вот все мы завершили свою работу что же происходит когда мы смотрим на файлах в той же самой директории что и директория с таблицей создается файл и этот файл растет вплоть до старого или почти стала го размера потом этот файл исчезает и остается только новый файл часто ли у вас есть столько места чтобы влезло самая самая большая таблица которой у вас есть на диске потому что если нет это очень опасная ситуация вы можете попасть в нее если вы считаете место по процентам например мы считаем что правильно когда свободно не меньше чем 20 процентов место или мы считаем что правильно когда свободно не меньше чем 100 гигабайт место это хорошо но если у вас табличка самая большая занимает 50 процентов место или сильно больше гигабайт чем вас есть свободное место вы никогда не сможете сделать определенные виды alter table а что произойдет если не можете сделать на одном сервере а на другом сервере выполнится получится расхождение в репликации если это происходит на серверах связанных репликацией более приятный способ сделать alter ты был это делать его на месте это значительно дольше выглядит если это объяснять как происходит но чуть попозже мы выясним насколько ли дольше это делать то есть что мы делаем мы также должны получить полную блокировку над таблицей но мы не должны ее держать вечно мы можем записывать все что происходит с таблицей в процессе нашего альтера в отдельный файл у этого файла будет какой-то максимальный размер чтобы не забыть весь ваш диск по умолчанию по-моему это 128 мегабайт увеличивайте если вам надо больше после этого мы считаемся эти данные сортируем вставляем сортированы в новую табличку вот и интересный момент в процессе after they был именно inplace происходит сброс всех модифицированных страничек на диск если бы не этот процесс на сайт рты был бы работал мгновенно на стадии когда размера старого файла и нового равны я сократил немножко вывод запросов perform эскимо как видно он делает альперт его подготавливается после этого читает и из про мерике сохраняет все что смади фиксированный таблицы на диск и применяет вот этот лог изменений которым делал на удивление в файлах размер после такого артемова может стать больше чем он был до этого когда у нас размер файла не меняется временного но база все еще что то делает она вот как раз может сбрасывать на диск и делов выборку из вен встречи скоринг ли вы можете увидеть что происходит если мы делаем индекс то временный файл не нужен и все изменения действительно на месте происходит это разница рибелс paypal или не рибелс то его мгновенный решим изменений он не требует никаких изменений и body файла на диске поэтому он гораздо быстрее работает мы мгновенно можем добавить колонку изменить формат и много-много для мария тебе я пожалуй пропущу то же самое все как и в мае стоит только в яндекс instant режиме у нас гораздо больше действий есть дополнительные реши много копия в копию значит как раз рибелс тайбл но а так это тот же самый режим instant если мы делаем in place offer ты был для таблички с несколькими индексами то для каждого из индекса у нас будет отдельная стадия сортировки данных из ставки вот абсолютно также работает как в мае сколь алгоритмом копия что быстрее instant in place или копия ну конечно же самый быстро это is that a in place показывает лучшую скорость работы потому что в режиме in place несмотря на то что сам алгоритм более сложный в самом хорошем случае мы модифицируем данные только в pdf файлы а новые pdf-файл не делаем получается быстрее ну так как этот более сложный алгоритм вы можете получить и краж самого mais quel и если вы делаете делайте это под большой нагрузкой что происходит с кластерами запустим бекона x-tribe кластер три узла запускаем севинч пытаемся выполнить alt и бал для того чтобы перестроить табличку на втором узле выполняя мастер ты была на первом узле на нулевом возле у нас происходит сам севинч сердеч заблокирован с помощью метода the log off после окончания стирки его более того сердеч получает ошибку онлайн недель в виде не блокирующим просто не работает вот хотя без галера вполне себе работал это режим to the orders солей шин в нем кластер должен применить alter ты был ко всем узлам одновременно если это не требуется то мы можем выполнить сейчас для 57 как бы все то же самое происходит как из 56 вот сидит на я разницы что любой если ты был в любом из этих режимов to the orders солей шин или применяем и изменения сначала на одном узле потом на втором вот для to the orders солей шин у нас происходит полная остановка то есть не только модифицированная таблица вызовет остановку запросов над ней как было с 80 но и любой вообще запрос если мы выполняем запрос узел с узлом но вот этот узел на котором мы исполняем он выполняет какие-то запросы эти запросы подвис на неважно это будет 8 версии или 7 для галера кластера все точно так же как для пикси 57 нет такого что вы выполняете alter ты был и у вас запроса над другими таблицами продолжает работать так же как и для 5 для пикси 57 будут блокировка на комете но при этом режим с отдельной с выполнением узел с узлом он работает нормально в на гибель кластер все неприятно сначала работает как будто был онлайн недели существует а потом как только мы должны альтера исполнить на остальных узлах весь кластер зависает вот это наверное самый большой недостаток для онлайн детей у него есть сложности который не дают его используете всегда под полной нагрузкой поэтому будьте бдительны и делайте ваши тесты вот в качестве альтернативы можно использовать пить его он воинский матч он тоже вызывает метода полок но зато сам процесс копирования данных происходит с помощью искали запросов и эти искали запросы уже не влияет на работу ваших кластеров поэтому он будет работать с карьерой или с энди big остров еще одна альтернатива не используете триггера а используйте бинарный лак для получения изменений это утилита гост от hip-hop гост сделан гитхаба мэтта большая компания то что подходит для большой компании может не подходить вам потому что не рисованная многие фичи итоге онлайн детей это вещь очень хорошая старайтесь использовать его по возможности если вам надо сделать altera у 2 недели не работает пробуйте использовать 5 онлайн ски матч или гост потому что они позволяют снижать нагрузку на сервер они позволяют не с константой скорости максимально выполняться а как то когда то выполнить ильдар тайбл если есть вопросы то можно их задать как минимум в кулуарах если время нет у нас миллион вопросов я думаю отлично вот во первых большое тебе спасибо за этот доклад у нас есть для тебя конечно памятная доска который можно здесь в этом доме жил и работу и всякие теплый приятный штук ей значок спасибо ребята поднимаете руки и задавайте ваши вопросы у нас есть 3 онлайн тоже на нажимаете кнопочки пишите в чат кричит увидим космическая просто рассказал неужели у вас нет облаков есть есть вопрос и alt и бутоны и скорее привет спасибо за доклад я наверное немножко не понял но вот когда у нас есть ортер болл это блокировки и как тогда в халате справляться с такими вещами когда у нас запросы будут отваливаться вообще получается что в текущем виде под самой самой большой нагрузкой мы не можем сделать a terrible самых используемых таблиц в некоторых случаях мы вот как например в случае мари деби кластера галерного мы не можем сделать альтист elbow даже каких-то простых таблиц потому что это вызовет блокировку вообще всего кластера при любом отверстия вот есть еще одна рука на втором ряду ребята поднимайте руки пожалуйста заранее причем так чтобы я их увидел вот это вас очень круто я вижу еще одну руку вот тот что ближе человек тебе да мне такой вопрос мы тут рассмотрели несколько вариантов допустим нам нужно индекс создать какое какой мест среди этих вариантов занимает простой просто создание индекса с кантором для быстрее всего создается индекс в с помощью alter the ball in place без нагрузки на сервер или с минимальная нагрузка на сервер таковы спасибо за доклад смотрите я не майский ольчик мне просто портить смотрите я business in the лично сам занимаюсь мы сейчас запираем данные из системы где там представьте 40 разных мальчика вольных баз и я столкнулся с тем что я хотел просто переименовать база вот я обнаружил что alter database да то есть по переименованию база в математику или это очень так это сложная запутанная и невозможная операция вот уже в других базах это просто мысли съели например да вот скажите когда-то случиться или может быть есть какие-то такие пока раунды простые как дело в том что в моей скво или базы данных это директория на диске и в этой директории находится таблица пока это существовало в таком виде особенно еще с дополнительными файлами метаданных и фарм файлами в этой директории это было сложно в моей сколь 8 появилась нормальный словарь данных внутри базы теперь каждая таблица какая она какие колонки это записано в виде и сколь таблица вот и поэтому сейчас это сделать гораздо проще чем это было когда-то потому что сейчас происходит копирование файлов вернее перемещение их из одной директории в другую для каждой из таблиц которые содержатся в директории с база данных скажите то есть я могу делать alter database да то есть взять попытаться это сделать да и это скорее за сработает вы точно можете делать автор дтп с для того чтобы менять значение кодировки по умолчанию имя базы переменной имя базы данных я не помню точно вот по моему тоже можно ли не дремлет взять мои вскоре 8 и попробовать втором чеки вы поднять сработает у нас есть еще вопрос и поднимайте руки ребята кто хочет здравствуй спасибо случае кластера когда мы выполняем del на мастере реплицируется синхронно dd на вторичные ноды если у нас ось синхронная репликация сначала выполнились на мастере делали параллельный запрос выполнялись два часа после завершения запроса alter ты была на мастере у нас отставание реплики от мастера будет два часа и он будет бешено нагонять это временно то есть это сложно если мы делали с помощью пяти гавайским очень чьей-либо гост то это происходит без задержки слова без такой огромной если у нас галера кластера перка навский или мария тебе у нас как только мы делаем азер ты был в режиме тот лордов и солей шин блокируются все узлы и начинает выполняться этот самый acer tempo если у нас есть и no debe костер он же группы applications у нас сначала выполняется alter ты был на текущем праймари в режиме мульти праймеры это просто не работает dream master master если у нас только один праймари то мы выполнили на нем и тот же запрос продолжает висеть на а праймари в этом режиме мы уже ничего не можем делать с нашей базы данных и альтера начинается исполняться на вторичных серверах и вот эти вот вторичные сервера если что то не так произойдет с ними-то или если в это время у нас исчезнет праймари то у нас база будет очень много часов без праймера он не сможет выбрать нового если мы получается но если возможность сделать вот этот ддл мягко то есть сделать его на мастере и потом поочередно переключая там надо чтобы они на из них была доступна чтения поочередно который на них в зависимости от того какие запросы потому что у нас может быть до дрель совместимы ли несовместимый по запросам если мы удаляем какую-то колонка или переименовываем у нас получается несовместимый режим если у нас создается новый индекс то мы можем вот например в асинхронной репликации мы можем создать индекс на всех наших репликах без использования бинарного logo потом без использовать бинарного logo создать на мастере такой же яндекс и это все будет работать в режиме галера это мы переключаемся в режим роллинс кий мобитц ii сначала исполняем на тех узлах которые не модифицирует нашу базу данных или вообще убираем нагрузку с узла выполняем запрос потом мы меняем роль того сервера который сейчас самое основное получающие изменения и уже нас оставшимся сервере до выполняем наш я понятность нас есть задать вопрос и ваш последний шанс поднять руку чтобы еще один вопрос уточнения по поводу галеры блокировки я так понял что блокировка происходит но происходит она для конкретной схема где один alter какой-то таблицы делается или весь класс то то есть все схемы блокируются если у нас режим тотальной изоляции по умолчанию если у нас как он xrd кластер 8 то у нас блокируется только то табличка которая заблокируется все запросы которые связаны с модифицированной табличкой если у нас 5-7 или мария-де-белен то весь кластер перестанет отвечать на запросы по модификации а именно будет висеть на кометах никакой камень не сможет завершится пока alter ты был не закончится на всех узлах ну то есть это даже не в пределах схемы а в пределах все-таки всех зело внутри всего instant со всех база данных которым вас может быть не все понял спасибо супер и пожалуй последнего просто зала ребята у кого то еще остались вопросы вы сможете задать в кулуарах здравствуйте я наверное частично повторюсь в предыдущем вопрос мне интересно как проходит блокировка таблиц при проецировании при altar of на протестированный таблицы он блокируется все партиции ли они как-то частично становятся доступны постепенно поездка если мы хотим поменять колонку какую-то например поменять тип колонки то будут заблокированы все партиции то есть будет заблокирована табличек целиком если мы делаем к операции над конкретной таблицы и например мы можем сделать дефрагментацию отдельные партиции то будет заблокирована только эта портится так похоже ответ получен ты знаешь я раньше когда на конференциях а делами тоже вопросы возникали и я такой думаю я буду спрашивать ну кому это все интересно я потом догадался просто веду себя эгоистично я хочу информацию дали только мне и никто другой больше не узнал потом в кулуарах тем не менее а какой-то вопрос понравился больше всего один не очень сильно понравился вопрос про партиции потому что вот этот момент я у себя в докладе несмотря на то что было слишком много слайдов я не указал и это очень важный момент вот последний вопрос последнего просто круто поаплодируем победителю нашу маленькую розыгрыша спасибо вам большое спасибо николай еще раз что такое было какая только мы можем продолжить в онлайн кулуарах те кто онлайн подключиться через ум вы будете друг друга видеть и слышать и все-таки узнать то что вам по-настоящему интересно спасибо"
}