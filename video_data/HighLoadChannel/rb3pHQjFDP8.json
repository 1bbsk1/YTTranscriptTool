{
  "video_id": "rb3pHQjFDP8",
  "channel": "HighLoadChannel",
  "title": "Автоматное программирование. Как построить чат-бота и не погрязнуть в ветвлениях / Евгений Гаврилов",
  "views": 231,
  "duration": 2941,
  "published": "2023-10-06T07:18:53-07:00",
  "text": "а Всем привет Да я Евгений Гаврилов и Superjob занимает должность так занимая должность Тим Лида и так уж получилось что на мои плечи упала задача по написанию фреймворка для общения через мессенджер И я расскажу историю о том как его реализовал с какими подобными с камнями столкнулся И в чем вообще там сложность всё началось Достаточно давно на самом деле не очень но примерно прям перед к видом было очень много работодателей все Они искали работу было все хорошо и у нас были крупные работодатели у которых по 50-60 тысяч вакансий и обрабатывать такой объем был достаточно проблематично и одному из наших продуктов пришла идея Почему бы не опрашивать этих кандидатов через мессенджеры и уже подгонять работодателям горячие кадры всё строилось очень просто задаем вопрос отправляем информацию по вакансии получаем ответы благодарим и все для того чтобы проверить гипотезу ну самое простое это использовать уже готовые какие-то решения мы нашли готовый сервис Он прям идеально подходил под нашу задачу все было достаточно просто но очень много ручной работы мы выгружали суперджоба точнее менеджер погружалось вот чтобы суперджоба база загружал её в сервис сервис как-то общался мы выгружали обратно Обратно загружали супер Джоб работала все хорошо Надо было двигаться дальше но тут было очень много недостатков никакой кастомизации сценариев не было у них был один единственный сценарий на тот момент сейчас они возможно уже развились Но тогда они были на заре от восстановления много ручной работы загрузить выгрузить перегрузить не очень удобно для массовых каких-то действий естественно у них не было никакого начали сразу искать альтернативы Ну как обычно это либо готовые другие решения либо собственные разработка а-а готовые сервисы на самом деле оказались очень крутые у них были и Новый год редакторы и очень богатые Пиа и у них у некоторых даже были свои собственные языки для написания э-э сколько угодно интеграции С чем угодно Хоть с битриксом хоть э-э с какими-то другими своими решениями всё это было из коробки но там несколько проблем э ну во-первых э интегрироваться с ними всё равно придётся а-а помимо этого они стоили каких-то денег посчитали и поняли что дешевле на самом деле на этапе даже в год сделать своё Ну и критичное для меня это вендерлоген э-э все наверное уже ощутили как за последние полгода срочно бросаем slack переезжаем в какой-нибудь э другой мессенджер или ещё что-нибудь бросаем куча сервисов ушло и как-то завязывает свою бизнес-логику на каких-то внешних таких сервисах Когда можно написать свою Ну немножечко неправильно Поэтому решили делать своё мы можем делать всё что хотим мы можем делать как хотим но для этого нужны компетенции А если их нет это может выйти дорого и долго Но на самом деле и так может выйти дорого и долго тут уже от хотела начали думать как это все взаимодействие будет происходить ну здесь на самом деле Все элементарно мы посылаем получаем какое-то сообщение допустим отцапа выполняем какую-то логику отправляем Следующее сообщение всё очень просто и кажется что мы сейчас напишем быстренько один and Point э-э и там лифчиками накидаем сразу поняли что это действительно очень быстро там через недельку мы уже будем тестировать это всё на клиентах это дёшево бизнес счастлив всё хорошо а-а Ну минусы когда-нибудь потом какие-нибудь будут у нас сейчас пока не очень волнует вот Ну поехали первая итерация Отправляем сообщение получаем ответ кидаем в зависимости от ответа режима в папку к работодателю благодарим его все вроде бы очень Элементарно и нам Кроме того что нам нужно отправить первое сообщение хук обрабатывает Все очень просто мы проверяем на Да я специально упростил очень сильно код там понятно что всякие лавокейс и так далее Все это мелочи добавляем в папочку и Отправляем сообщение но продукты не любят останавливаться им нужно больше больше всяких фич они решили обрабатывать еще и сообщение нет соответственно там отправляется уже другое сообщение ну добавили никаких проблем продукты вошли в Кураж А что если соискатель нам не ответил Там на второе на третье сообщение Может быть ему стоит Напомнить ну Давайте попробуем нам Понадобился уже флаг начался диалог или уже продолжается потом решили обрабатывать ответы нет По какой причине соискатели чего-то не устраивает добавилось еще несколько шагов ветки ветках ветвление количество ветвлений увеличивается и все усложняется но мы с этим справляемся мы умеем писать ответвление Мы же это самое простое Что можно написать а потом была там пятой трасса потом шестая итерация и Седьмая итерация и так вот так прошло полгода продакты все время подкидывали новые сценарии пытались как-то изменить один на другой И в итоге к 21 итерации примерно получилось такое огромное сценарий это реальность сценарий Я его специально развернул э-э Ну немножко упростил но в целом это один из сценариев который сейчас у нас работает и вот вроде бы я справился вроде бы я все написал вроде бы хорошо и солнышко светит и Тут приходит продак просто и говорит Женя нас там релиз Через час я поговорил с клиентом он там придумала офигенную фичу Давай просто быстро запилим я тебе сейчас скину сценарий кидать мне вот это я ему Блин ну здесь неделя может быть пока теста пока не не Подожди Мы в одной лодке команда думай внимательно нам нужны релиз кот нам не нужен вообще схема есть всё хорошо тесты это конечно хорошо но не будь эгоистом Мы же команда Нам нужен развивать бизнес А это время было ковидное потому что горело все с вашим что-то переделывали Ну и почему это может привести просто к нокауту сотрудник скорее всего после такого уволится Ну я немножко здесь конечно слукавил на самом деле Я остановился где-то на втором шаге и благодаря все-таки хорошим продуктом я начал писать свой фреймворк но ситуация такая возможна И на самом деле я работал с кодом который построен был именно на таких условиях к счастью я не эмэльсах disasion 3 а для них это норма И тут сразу всплывают минусы Я не вижу целостную картину поведения Я не понимаю Где что берется Я не понимаю к чему это вообще все может привести при попытке что-то изменить у меня все ломается меняю одно условие ломается совсем другом потому что всё это как-то вот так вот всё переплетено естественно огромное количество может быть ошибок и никаких релизах через час речи быть не может ну и естественно это всё очень сложно тестировать куча этих линий куча вариантов тестирования огромное количество тестов э-э любого уровня хоть юнитов хоть э-э поведенческих Всё достаточно проблематично и получается что разработка не очень дешёвая вроде бы начинали вроде бы все было хорошо но надо было вовремя остановиться вы здесь конечно можете сказать что я просто взял на говнокодил напихал много условий и так вообще это не пишут надо правильно эти композировать правильно разбить по компонентам сервиса все такое И все будет круто замечательно оно так представим что я просто взял все разбил по компонентам распихал по огромное количество классов написал там куча абстракций Ну я все равно я не понимаю целостные картины Ну хорошо у меня вместо этого слова будет какой-то метод в котором всё равно будут эти условия все как-то всё это опять переплетается все переменные флаги что Откуда тащится всё равно разбита по всей системе Я просто взял из размазал сложность тонким слоем по всем сервисам В итоге все равно приду к тому что мне нужно это все переписать К сожалению декомпозиция данном случае тоже не спасет она конечно в какой-то степени упростит понимание операции но не даст целостной картины поведение Вы наверное не расталкивались Когда вам приходит задача на нее смотрите и вы не понимаете задача написана одно в ходе совсем другое а потому что так разработчик написал и я нашел автоматное программирование или как его еще называют программирование с явным выделением состояний оно основано на расширенной модели конечных автоматах я не буду рассказывать математику всю вот эту теорию потому что это всё скучно неинтересно и в контексте PHP - это не очень применимо важно оттуда получать концепции и автоматное программирование это именно про это Как натянуть ооп на автоматы Давайте разберемся что же такое сценарий по которому общается пользователь У нас есть простые объекты о простые сущности например какую-нибудь крут мы что-то посылаем что-то получаем и это всегда одинаково то есть на каждое входное воздействие У нас одно и то же выходное воздействие Все хорошо Все здорово почти весь API строится именно так а есть сущности со сложным поведением когда на одно и то же входное воздействие мы можем получить совершенно разные выходные воздействия и еще страшнее когда мы на разные выходные воздействия получаем одно и тоже входное на каждое входные выходные Выходные воздействия получаем одно и то же выходной воздействие например мы получаем одно и то же сообщение Привет или там ответ да а реагировать мы можем на него совершенно по-разному Мы можем там забанить пользователя если был вопрос А у вас стоит забанить и больше не писать или же кинуть в папку работодателю если он попросит это а сценарий как-то ближе все-таки к сущностям сложного поведения и тут самое главное это состояние и главный вопрос который нужно задавать в каком состоянии может находиться система и уже начинать плясать именно от этого Ведь мы не можем одновременно ехать в автобусе и бежать на улице мы на меня состояние Я еду в автобусе я могу делать действия которые я могу сделать именно там состояние соответственно несет себе информацию и о прошлом системы я настоящим системы убирает сразу кучу вопросов нам не нужно за этим следить оно определяет то как мы будем реагировать на какие-то входные воздействия данные и так далее И самое главное оно задается явно на самом деле вот в том первом варианте где куча разных условий состояния тоже есть мы от него никуда не денемся но оно задается не явным это набор просто разных флагов каких-то данных все это разрозненно И вот это главная проблема нет целостной картины нам же все это нужно собрать Ну так как автомат на программирование основано на конечных автоматах посмотрим как выглядит автомат в данном случае у нас есть какой-то входное воздействие У нас есть функция переходов которая меняется состояние которое зависит от входного воздействия У нас есть функция выходов это то что делает фреймвор Ну какая-нибудь там полезная нагрузка там Отправить сообщение или там что-то сделать с данными а-а и само состояние которое также означает влияет и вот как-то мы вот в этом автомате вертимся и всё вроде бы хорошо Вот теперь после такого маленькой части теории надо все это реализовать Для начала я выделил базовые требования Ну вчитываться не нужно сейчас пойдем по ним подробнее Первое это декларативное описание Это не совсем требование автоматного программирования это мое требование чтобы все было удобно хочется как-то уйти от концепции объяснять как это сделать Я хочу объяснять что нужно сделать Я хочу просто Отправить сообщение Я хочу просто получить сообщение я не хочу задумываться о том как этим заниматься а для этого нужно какой-то декларативное описание всего ну для начала выделим состоянии самым базовом сценарии у нас состояние Starting состояние уайтанса и состояние всё очень просто и для примера я буду показывать в массивах PHP но можно хранить хоть хоть Джейсон хоть в ямле Как Вам угодно у нас хранится в базе частичных джейсоне ключи это название состояний собственно значение Это какие-то данные пока остановимся только на actions это те действия которые мы можем выполнить в этом состоянии например возьмем блок какой-нибудь ожидание ответа что мы можем сделать во-первых мы можем получить сообщение во-вторых мы можем не получить сообщение и все что мы можем сделать что в этот момент мы что можем сделать мы можем перейти из одного состояния в другое для этого я добавил еще и ключик Next внутрь и там указывается следующее состояние в которое система может перейти на самом деле она может и не переходить это тоже бывает и мы попадаем какое-то состояние какой-то экшена Ну допустим там холостую зачем-то Нам нужен это не обязательно сам управляющий объект э-э то что будет взаимодействовать с э-э с массивами своими сценарием на первом этапе действительно просто мы просто получаем это действие у нас уже есть какой-то узел в котором мы находимся а-а мы получаем следующий узел айтишник и пытаемся просто его установить всё очень просто и мы уже на этом этапе можем как-то передвигаться по нашему графу запускается вообще Элементарно мы просто инициализируем сценарий Запустить вот это действие вторую проблему которую надо было решить это простота расширения И модификации тут надо еще выполнять какую-то полезную нагрузку а не просто двигаться по этому графу и чтобы как-то все легко было расширяемо я добавил за компьютера Ну и конфигурацию для них А что такое экзекьютор по сути это просто какой-то класс Возможно даже функция просто То есть тут реализация может быть много Все наверное пользовались и контейнерами и всякими другими штуками где всё это вот так вот просто напихивается само как-то работает а-а но э-э выглядит всё очень просто мы получаем какой-то пейловод получаем конфигурацию что-то делаем обозначение какое-то результат а-а но чтобы это всё хорошо работало нужно следовать определённым правилам а во-первых экзекьюри должны быть независимые А когда начинают зависеть друг от друга Ну вот эти вот сайты они никому не нужны и мы опять катимся в то что мы ничего не понимаем что происходит нам нужна простота во-вторых они должны быть атомарные он либо вы либо выполняется либо не выполняется третьего просто не дано Ну соответственно если у нас обычный какой-нибудь Монолит транзакции еще такое сложнее распределенные транзакции но чтобы как-то вот этого избегать всякое Вот это распределенности усложнения должны быть простые но здесь как бы субъективный такой момент важно то что как вы понимаете эту простоту Ну например чтобы по названию и потому методу можно было сразу понять что он делает конечно например даже простая отправка сообщения Может там вызывать 15 сервисов взаимодействие между даже микросервисами и всё такое но он всё равно простой просто отправляемся сообщения и ничего больше мы не делаем а-а Ну знаете как посоли до единой ответственности и всё такое вот таким образом а-а осталась добавить получение какой-то дополнительной нагрузки каких-то вводных данных и передавать их в этот экзекутор выполнять и получать какой-то результат Уже лучше уже Теперь мы можем и выполнять какую-то полезную нагрузку у нас еще не решена проблема осветлениями без них на самом деле очень чашка с одной стороны они как бы есть у нас есть разные экшены они могут вести на разные состояния Но это те ветвления которые мы вызываем самостоятельно а-а хочется как-то чего-то другого допустим экшен получение сообщений мы получаем сообщение и в зависимости от этого Мы двигаемся либо в одну сторону либо в другую сторону Ну я просто взял расширил ключик к перехода и сделал Там обычный маппинг это упрощённая версия там может быть на самом деле всё сложнее у нас есть реализация где там э-э подсовываются разные возможные стратегии но по факту сам базовом варианте этого за глаза хватает в большинстве сценария и Для этого нам надо просто в метод который пытается определить следующий узел передавать результат замачит как надо и все будет хорошо вроде бы хорошо но иногда бывает так что нам необходимы какие-то автоматические переходы Ну например Когда вы там может быть видели там автоматы для проигрывания музыки когда кидают монетку и начинается всякое там автоматика поднимается головка вытаскивается зажимом диск ставится другой сказать это всё происходит автоматически вроде по пользователь сделал одно действие кинул монетку и нажал кнопку ладно два Ну всё-таки и такие действия нужны например мы получили какой-то ответ мы что-то делаем и попадаем например Отправляем сообщение новое и нам нужно ожидать новое сообщение Мы конечно можем в этом узле его ожидать зависит от того как Вы будете реализовывать но все-таки такая ситуация есть для этого просто выработал ряд правил У нас есть только одно действие узла тип узла у нас автоматик в этом случае система сама работает и сама движется по графа чтобы это все работало я сделал новый метод который в принципе запускаю тот старый Run Action Но это все происходит в цикле теперь у нас появилась новая возможность мы можем разделять условия и выделять их в отдельные узлы так будет понятнее и на схемах Когда будем смотреть на них и в целом не всегда хорошо это смешивать в Один узел мы получили ответ Наш узел только это сделал передал это всё дальше дальше мы разветвились и куда-то ушли И теперь мы уже можем строить достаточно хорошие большие сценарии Ну надо решить проблему тестировать по факту она уже решена нужно просто как всегда принять ряд правил экзекьютера так как они независимы и ни с чем не пересекаются мы спокойно Тестируем отдельно это условно как обычный метод тестах там или если что-то сложнее ну поведенческие тесты Если понадобится функциональная Тестируем основные кейсы сценария отдельно мы можем даже вообще без компьютеров тестировать либо их спокойно мокнуть например Будем считать что сообщение получено нам не обязательно это отправлять но нам важно чтобы мы прошлись по всем веткам сценарии которые нам нужны в данном случае и убедились что мы где-то там не замкнули его случайно в бесконечный цикл и всё работает правильно как нам хочется и самое хорошее фича вышла прямо из коробки мы можем тестировать только ожидаемые действия нам не нужно тестировать все возможные варианты что если мы находимся в блоке каком-нибудь там ожидание сообщения что мы пытаемся Отправить сообщение сломается ли система или нет это уже ограничение из коробки автоматного программирования мы ограничиваем действие если Мы попытаемся выполнить действия reset message in alanswa всё сработает всё хорошо потому что они есть Мы попытаемся в какой-нибудь действие ничего не произойдёт Ну у нас конечно там есть и логирование потому что очень часто может получить Так что на самом деле действие вызывается ошибочно но К сценарию это отношения не имеет и все будет все равно работать с базовыми требованиями разобрались и в целом так система жила какое-то время Ну естественно систему и фреймворк надо было улучшать поэтому вы делали еще ряд требований для того чтобы все как-то расширить все работало еще лучше хранилище данных сразу буквально через месяц после пару итераций одного сценариев У нас появился кейс Когда нам надо было считать внутри сценария например Мы хотим провести опрос и или там ой так еще раз нажать а всё я ушел так Допустим мы хотим провести опрос нам надо как-то тренироваться или еще по какой-то причине хранить какие-то внутренние данные для этого я взял концепцию машины тьюринга если вы не знаете это такой автомат где есть управляющий объект есть бесконечная Лента память автомат может туда что-то записать что-то читать все И вот эта Лента я ее выделил в хранилище сценарий может что-то записываться к этой ленте есть доступ только сценария конкретного экземпляра этого сценария ну и соответственно все все это взаимодействует здесь есть такая разница есть состояние управляющего объекта оно влияет на то Какие действия Мы будем выполнять в каком состоянии мы находимся а хранилище отвечает за может повлиять на результат этих действий Допустим мы заранее перед сценарием загнали туда имя соискателя или работодателя там какие-то данные какие нам нужны и вот они никак не влияют на сценарий но они Вполне себе влияют на то какие сообщения мы можем отправить далее надо было решить проблему с акционированием на самом деле больная тема потому что мы можем запустить сценарий на 10 тысячах соискателей часть из них там сразу ответила часть Позже Мы потом решили запустить там улучшенную версию по другой части соискателей если мы изменим сценарий то возможно мы сломаем просто предыдущий сценарий так как он всё ещё идёт и сценарии могут длиться там неделю месяц Тут уж за что отвечают но всё очень просто я просто беру и сохраняю каждый раз новую версию при изменении и если мне надо когда я запускаю сценарии то я запускаю с определённой версией а-а Ну и всё изменил версию хоть вот переделал всю схему всё работает хорошо и новый пользователи получат будут общаться по новому сценарию далее тоже больная тема когда что-то падает когда что-то падает в простой сущности Все очень просто упало повторили все хорошо здесь же мы должны находиться в каком-то состоянии не факт что это состояние какой-то оконченное что-то произошло Ну например Хотя бы даже просто внезапно почему-то там сгорел там не знаю Ну или допустили какую-то ошибку и как-то там забуксовали и что-то сломалось и мы просто упали потому что там другие разработчики во время там написания метода там получения резюме или ещё чего-то допустили ошибку решается все просто нам дополнительно нужно сохранять входные параметры состояние хранилища мы и так уже сохраняем и получается в любой момент времени даже если мы просто все отключим мы просто для восстанавливаю это все одним методом и сценарий продолжает выполняться А из-за того что у нас за компьютера получается товарные то мне не страшно их выполнить повторно с аналитикой аналитиком нужно много аналитики они любят ее надо как-то собирать им важно знать где пользователи застревают как они идут в зависимости от каких сообщений как они отвечают и много-много информации для того чтобы все очень удобно собирать я добавил хуки жизненного цикла там на попадании в узел на выход из узла выполнения за компьютера до после и всё остальное их там 6 штук значит 6 штук Я уже не помню и там например можно сохранять какую-то информацию отправлять там аналитиком эти данные они уже у нас строят всякие карты Воронки анализировать Какие сценарии лучше подходят и проблема достаточно легко решилась и осталось самое главное проблема сценарий все еще может расти А когда он растет он всё равно становится ещё более сложным и у него получается огромное количество узлов и с этим надо что-то делать во-первых как я уже сказал получаем появляется слишком много узлов во-вторых частью слов они просто дублируются Ну например Каждый раз когда мы получаем сообщение и мы ожидаем что он ответит да или нет Ну допустим без вариантов и он нам отвечает какой-то белиберду мы можем его переспросить а мы не понимаем вас скажите нам да или нет нет и на каждое сообщение писать Вот так вот 3 4 5 блоков и пихать их в сценарий Но это как-то проблематично потом как это все поддерживает А если я решил изменить эту логику поэтому я воспользовался логичной концепцией на самом деле иерархические автоматы по сути это автомат встроенный в другой автомат если говорить в концепции сценариев общения то это один сценарий страны в другой сценарий на примере вот сценарий уточнения ответа Мы попадаем в узел погружаемся во внутренний сценарии гоняемся там и при завершении выходим наружу и как всегда очень много правил потому что их очень легко нарушать когда особенно не знаешь но если им следовать то все достаточно просто и понятно внутренние узлы не могут делать переходы наружу они могут только завершить перейти в завершающее состояние А дальше автоматика сама подхватит И завершит это этот сценарий и перейдет на уровень повыше внешние узлы соответственно тоже не могут уходить ни в какие внутренние узлы Ну только если мы находимся в этом же узле который является под автоматом Да мы попадаем в него и мы погружаемся Ну никак из других узлов мы туда не попадём И самое главное хранилище не должны пересекаться э-э на самом деле все очень просто у нас они хранятся в виде стайка мы погружаемся записывается новый элемент мы всплываем хранилище очищается и они не пересекаются каждый сценарий каждый автомат имеет только собственное хранилище по структуре Я просто добавил новое состояние внутрь одного узла Ну у нас это опять же пример у нас немножечко по-другому Я могу указать ссылку я могу указать айтишник сценария в базе и добавить конфигурацию и таким образом можно заранее подготовить базовый сценарий и начинать их встраивать друг друга и получается такая Огромная машина огромный автомат который внутри содержит другие автоматы и всё это как-то работает общается и что происходит Хорошо и как-то схема стала проще вместо начальных там 40 с чем-то узлов было мы получили там около 20 узлов ещё можно упростить но в целом она достаточно легко понималось поэтому не стали этим заморачиваться Но это на конкретном сценарии максимальная вложенность кажется у нас на одном сценарии три уровня У нас есть автомат которого автомат которым автомат вот прошло примерно два года за это время у нас есть появилась четыре основных сценария которые используем каждый день продукты прямо сейчас активизировались они сделали прямо уже скоро совсем ещё три сценария у было куча сценариев которые запускали один раз допустим подстраивались под конкретного клиента Потому что клиент Просто захотел как-то изменений допустим вместо простого добавления в резюме он решил там провести какой-то дополнительный вопрос а мы это ещё не заложили в основной сценарий или он решил скидывать э-э ссылку на адрес на карту где будет собеседование выборы времени собеседования и разные другие штуки ну и плюс мессенджеры развиваются у них появляется очень много всяких других штук всё это можно протестировать у самого первого сценария у нас получилось 21 операция Ну наверное итерации 12 из них было за первые два месяца мы просто чуть ли не реал тайме меняли сценарий на лету пробовали запускали мы попали вообще в самый запах точнее в апрель месяц в тот самый локдаун и к нам обращались из Минздрава Прошу прощения региона если мы вас врачей перемонили и мы опрашивали огромное количество врачей и очень быстро все это корректировали И вообще временно ничего не было И тут как раз таки фреймворк очень сильно выручил и минимальное время запуска у нас было 1 час мы больше наверное обсуждали в целом что хотим получить от сценария чем его разработка сейчас разработка сценария Ну я полноценный налог-редактора так и не доделал но есть визуальный просмотр и я просто накидываю массив смотрю Если всё то в принципе можно просто сохранять его в интерфейсе и спускать рассылку по нему никаких проблем Возможно у вас сразу появились вопросы а почему уж я не использовал какие-то готовые инструменты их сотни тысяч действительно ну такой есть внутренний скажем так ответ потому что мне было интересно в этом разобраться написать что-то свое но по факту на самом деле не очень большой выигрыш именно для нас был bpms все очень круто если вы там почитаете об этом там можно строить огромные системы всё работает из коробки Замечательно а но там нужно как и в любой другой системе куча делать обёрток подходящих именно для нас а базовый синтаксис достаточно сложные нужны ограничения чтобы менеджеры как-то этим могли пользоваться и понимали что там происходит поэтому отказались от bpms Ну и Хотя реализации есть под любые языки не только подписчики симфония плохо хорош но он больше подходит для каких-то маленьких объектов Ну например заказ мы меняем там статусы заказов там или статусы сообщения поста все базовые такие классические сценарии когда мы хотим развернуть какой-то огромный сценарий А еще вложить один там сценарий в другой сценарий Здесь начинается проблемы и чем городить вот вокруг симфония вокруг куча своей логики пытаться это всё за костылить а-а было решено писать своё темпал Но это интересная штука но она про императивное программирование Ну и когда появился sdk для PHP у нас уже версия наша работала первая фреймворка и смысл отказываться Нет но я пытаюсь сейчас свободное время как-то интегрировать Темпора во внутрь своего фреймворка использовать в качестве движка потому что там уже из коробки поддерживается очень много интересного там и таймер есть и Activity Flow и так далее ну если вы знали знаете tempro знаете что он очень крутой плюс у него проблема нужно поднимать вот эту всю инфраструктуру выделять в отдельный сервис А у нас на тот момент был Монолит и достаточно проще было написать какой-то а-а отдельный модуль или всё это должно работать Ну в целом их сотни разных и Возможно даже тысячи готовых решений любые языки но работают они все примерно одинаково У нас есть состояние у нас есть переходы У нас есть какие-то действия мы ограничиваем это всё и как-то передвигаемся Вот и все что я хотел вам сегодня рассказать Спасибо за внимание там есть ссылочка Tiny url.com PHP Rush дефис ап там есть ссылки на книжку по автоматному программированию там разные другие полезные ссылки по докладу Ну и слайды презентации ссылку на презентацию Всем спасибо Спасибо огромное напоминаю по QR коду можно зайти и оценить доклад вижу уже первые руки Пожалуйста микрофон Добрый день спасибо за доклад У меня вопрос У вас есть какие-нибудь архитектурный комитеты мне не очень понятно Почему в какой-то момент вас не остановили и не сказали не надо ничего самописное используя ppm Кому надо там что-нибудь такое а есть но на тот момент ресурсов было не так много и сам фреймов на самом деле написал достаточно быстро с этим проблем нет Ну и как обычно бывает нам нужно прямо сейчас нет времени недели изучать все возможные варианты когда за неделю уже есть готовы Точнее за неделю написано базовая версия потом просто там моменте как-то что-то расширялось Но скажем так есть огромная глобальная задача возможно в целом в принципе bpm затащить но как вы наверное уже понимаете это не очень простая задача чтобы переписать не только вот написать боты на bpm а в целом выстраивать какие-то системные процессы включая на основном сайте там скажем так в админке это проблематично дорого и как только так сразу так Спасибо огромное Следующий вопрос Здравствуйте спасибо за доклад было очень интересно такой вопрос про тестирование вы сказали что все легко тестируется потому что у нас все атамарно да То есть вы атамарно Извините тестируйте а как вы гарантируете что собрав все эти звенья цепи Ну как бы сценарий полноценный он работает корректно хороший кстати вопрос я времени не хватает на то чтобы все это запихнуть доклад там есть на самом деле много разных решений Первое - это просто самая банальное мы заранее договариваемся о том какие Ну вот допустим на этапе nvp А что вот у нас всегда выходит допустим условно там строка или определённый объект определённый структура и там благодаря конфигам как это всё второй вариант Более сложный э-э и частично у нас уже работает и с этим проблем нет э при необходимости его надо будет улучшать но пока хватает это mapping данных э-э и благодаря тому что у нас всё это описано и мы знаем что допустим в определённом узле мы ожидаем какую-нибудь объект с ключом месседж то мы уже заранее можем проверить даже на этапе сборки этих блоков что вот вот из этого узла мы не передаём message а он обязательный обычный типизация никаких таких серьёзных проблем с этим нет но для этого нужен мапе какой-то маппер между вот этими штуками все равно получается как-то отдельные звенья получается собираем какой-то сценарий его кусочком Тестируем на каком-то моменте времени смотрим Ага тут у нас данных хватает ок и типа Идем дальше или как Или по финалу что результат получили вот ну типа пациентки прошлись до конца результат получили Ну вроде бы что-то да А что там было Вот совокупности а нет каждый узел он просто он не в курсе вообще о том какие есть да Он может что-то получить что-то выплюнуть а-а мы проверяем то что он должен э-э что экзекьютор получает то что ему нужно Ну точнее мы проверяем на наборе данных что если вот мы ожидаем что пришло сообщение Ладно ожидаем что если пришло сообщение то мы его корректно работали если оно не пришло Ну допустим там какой-то там ожидаем Ну это тоже корректно отработало А дальше мы в каждом следующем блоке тоже такие правила проверяем и соответственно если мы ожидаем что он вернёт нам да что же такое ожидаем что он вернёт какой-то результат тоже сообщение мы уже заранее это можем проверить обычно типизация обычная PHP а далее Мы в сценарии просто статикой и проверяем как это всё Матрица если мы знаем что вот этот узел нам может вернуть сообщение Может вернуть пустую строку вместо сообщения может вернуть не сообщение А intent например какой-нибудь или айтишник кнопки которые нажали в мессенджере А следующий узел с ними не умеет работать ну мы не дадим Такой сценарий сохранить Ну типа либо как-то замает а либо обработают эти варианты тоже допустим через ответвление и сказать что вот эти варианты мы просто игнорируем если допустим Нажал кнопку А нам это не нужно мы просто кину ничего не делаем Мы возвращаемся обратно эта статика как контролируется но анализатором каким-то или на этапе тестирования там становится понятно что допустим нашли то что тут вот оказывается этот узел кнопку мир Ну не обрабатывает и это контролируется статикой Но это такой прототип сейчас потому что сейчас пишется вторая версия уже лично мной Просто не не для компании а дома и там я пытаюсь написать как раз таки нормально анализатор статический который как раз таки не будет зависеть именно от какой-то реализации и Ну как и в тех же bpm-системах и так далее В принципе это везде у нас есть все данные для того чтобы это всё правильно проверить э-э статикой супер Спасибо огромное вижу еще руку пожалуйста вот вот рука и еще одну руку Добрый день Спасибо большое за доклад А подскажите пожалуйста как у вас на инфраструктуре это разворачивается вот там куберы используется Лента функции и какой как происходит процесс вот тепло и вот новой схемы масштабирования вот эта вся вот эта вся сиди система у нас это также как и обычный процесс любого другого кода в компании у нас на текущий момент есть основной Монолит э поэтому всё в нём а-а сценарии они хранятся в базе А по факту я могу просто у меня есть даже интерфейс Где я могу добавлять их а-а я его конечно ограничил от менеджеров они могут просматривать менять параметры но создавать не могут как только появится ресурсы это добавится и в этом конечно выигрывают готовые сервисы а-а но всё-таки никак Вот то есть я просто конфигурирую сценарий если все блоки всех за компьютера мне которые мне нужны они уже реализованы то ничего это платить не надо я просто реализую сохраняю А потом когда запускается рассылки я выбираю запустить номер там 55 Или пометки такой-то все еще работает так Следующий вопрос Добрый день да спасибо за доклад Вопрос такой вот опять же про тестирование по проверку сценарий так как это как вы сказали данная система сделан не ради там заказов который имеет там три четыре состояния для большего процесса который стоит из там ну 50 состоянии то вопрос опять же протестирование вы говорили именно про анализацию на кода что группа одно состояние возвращает объект правильно типизированный в другое состояние А здесь больше интересен момент как проверяется то что одно состояние там протестировано второе состояние протестирование третье состояние а сама цепочка из 50 состояний в месте Все работает корректно Потому что во-первых одно состояние может зацикливаться то есть весь такие варианты в вы сами такая же проблема есть да здесь опять же повторюсь что не все нужно тестировать потому что что-то уже подсказывается и если у нас именно какие-то косяки с маппингом одних данных другие то уже будет ограничение на уровне фреймворка но основные кейсы то есть мы должны все равно убедиться что мы должны пройти по определённому узлам и достигнуть какого-то результата здесь Да Тестируем вот коллега Антон заплатили рассказывал про тестирование у нас поведенческая через бехат вот там это Тестируем основные просто кейсы Так ну что еще Вот тогда дополнение Вот вы тогда сказали что все состояния атомарны правильно Да вот например состояние списать с баланса Да списать там с банка при повторном запуске оно же может списать заново транзакции у вас состояние когда в каком плане оно оно не состояние а состояние мы просто находимся в каком состоянии мы можем выполнять какие-то действия логика выполняется в экзаменаторе предложения продолжить дискуссию в дискуссионной зоне после доклада Давайте последний доклад вот здесь была Прошу прощения последний вопрос вот здесь была рука пожалуйста так и пока у нас а хелпер помогает нести микрофон а уже уже принес Ну ладно спасибо большое Очень интересный доклад пару вопросов у вас кнопочный все-таки бот или Он поддерживает естественную речь Если естественную речь Как вы хендрите вот эти случаи когда человек пишет какие-то кейс который вообще не в развилке были Ну как всегда все просто в принципе у нас не ассистент у нас именно бот нам в любом случае надо мапить на какие-то определенные значения Но их мы заранее прогоняем через eml у нас используется Google dialogflow мы пытаемся выигрывать intent И если мы понимаем что intendo или нет не важно как он написал поезд Да латиницей да там конечно то мы мопим его надо если все-таки он написал какую-то белиберду Ну мы идем по выделению что мы не поняли его А так можно голосом можно как угодно то есть сценарию отношений имеет это имеет отношение там выше мы получаем сообщение То есть разделили по сути эту логику отделили да возможно если понадобится можно ее встроить внутрь пока просто не понадобилось понял второй вопрос последний Насколько сложно переменить этого чада Бота вообще в другом доме не знаю вот если я хочу не харите людей А вообще что-то другое вот билинг у сотового оператора или у банка там какие-то транзакции Насколько сложно это ну взять применить его применять можно где угодно у нас через него не только хантинг идёт у нас через него идёт общение с клиентами Там выставление на звонок менеджером э-э когда менеджер прозвонит что-то там делает с клиентом потом это всё обратно там попадает клиент Может опять нам что-то написать всё ограничивается фантазией Ну и тем что это всё-таки какой-то относительно всё равно небольшой сценарий То есть это не ассистент где можно что угодно написать они становитесь там вы вот конкретно ваши команды узким горлышком вот у вас 7 департаментов приходят там говорят хотите чат-ботов и вот без ваших знаний языка этого фреймворка это невозможно а там чтобы написать своего достаточно Все очень просто ну точнее написать свой сценарий для этого я вот и все разделял экзекьюторы отдельно сценарий отдельно Сам фреймворк он не требует каких-то есть еще команда которую им пользоваться предложение продолжить дискуссию Мне очень нравится как дискуссия прям так начинаются разворачиваются это на самом деле очень классно К сожалению мы ограничены по времени Ну что Евгений Теперь у меня к тебе самый главный вопрос я понимаю что будет очень сложно выбрать Но какой вопрос заполнить запомнился Больше всего мне понравились последние два вопроса вот человек а всё супер Отлично пожалуйста подарите подарок Спасибо огромное за ваше активное такое участие а унтика как организаторы холод дарит подарок где-нибудь себе Спасибо огромное за подготовку это было действительно очень интересно спасибо большое сюда и я хотел бы сделать логичное продолжение в тему резюме завтра в 10 утра будет мое выступление касающееся review резюме и у вас есть возможность в этом поучаствовать в чате холода есть объявления С почтой на которую можно прислать резюме бесконтактных данных без мобильного почты даже без компании и послушать честный фидбэк от Chart директора сети этим ли Да как это выглядит со стороны иногда это может быть удивительно скоро Скоро нас ждет следующий Тик Ток от Россельхозбанка в 15:40 А это будет листок с романовым бодриевым До скорой встречи"
}