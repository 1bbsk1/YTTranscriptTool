{
  "video_id": "NmdnaLnCpRA",
  "channel": "HighLoadChannel",
  "title": "NeuroHD: охота на шакалов, или Деплой и ускорение сеток в инфраструктуре VK / Арсений Нериновский",
  "views": 79,
  "duration": 2080,
  "published": "2024-10-29T03:07:33-07:00",
  "text": "мы продолжаем тему машинного обучения искусственного интеллекта больших данных и сейчас Арсений расскажет нам о том как они применяют этого в ВК поприветствуем СБО большое Меня зовут Арсений новский я R инженер разработчик CV нити единого видео компании ВКонтакте Сегодня я вам расскажу про технологию не HD и вот сейчас можно запустить первый ролик это вот сказка морозка и можно запустить второй ролик Если присмотреться то можно было заметить что между роликами было явно разница были удалены разного рода артефакты и был увеличен FPS и вот рассказ об этой технологии которая называется N rhd я сейчас проведу Да вот что такое не мы рассказали и по поводу названия доклада это уже у нас профессиональная терминология шакалы про шакалы мы говорим очень много шакалы в видео это вот собственно сами артефакты и мы стараемся сделать так чтобы их было меньше Да ну и вот чуть-чуть поподробнее о том каких шакалов Какие шакалы мы убираем слева у нас оригинал справа у нас после применения N HD Вот и вот можно заметить что к примеру у нас облако над горой фиолетовое и вся картинка немного расплывчатая УЦ на носу какие-то квадраты и щека тоже квадратами покрыта вот ну и справа мы вот эти артефакты убрали УЦ гораздо более мягкое лицо и гора выглядит поприличнее вот сейчас есть такой тоже профессиональный приём называется быстро щёлкать картинками и если на них смотреть можно заметить изменения Вот и вот эти изменения - это как бы результат применения нашей технологии чтобы понять Как бы есть ли какой-то Импакт можно посмотреть на цифры у нас 41 год обработанных видео и 20.000 лет просмотров то есть технология пользуется спросом люди е используют люди радуются когда я подавал На вот эту конференцию доклад у меня вот человек который его ревью сказал что он прям фанат технологии у меня было очень счастливая неделя из-за этого вот ну и технология ресурсо ёмкая 460 ГПУ в кластере и всё Это мы пускаем на не HD и поэтому вот эта презентация так интерес ше много-то о ЧМ Я буду рассказывать это именно том как мы ускоряли это как мы это вытащили в прот как мы ускорили сети при помощи Что такое и как обошли некоторые подводные камни Я не расскажу о том как я обучал сети потому что же какой-то отдельный доклад и оде Я тоже говорить не буду Ну немного контекста как это выглядит программно как это ВС реализована логика у на есть большой Серви назва Он написан на яве и трансформ поддерживает очередь некоторых тасо эти таски Туда закидываю прочими сервисами и трансформ он их просит в частности он их просит при помощи плюсовой проги называется Tools и Tools получает задание То есть у неё есть некие на вход видео или ряд видео некий Граф преобразования ина и для транскодирование FPS и дальше обратно зашиваем это Файлик Ну и получаем соответственно некий output вот так вот у нас выглядит mir HD и как бы что произошло к чему пришли от чего шли изначально всё было на порче на плюсах и за од секунду обрабатывали заче секунды ускорили получили двукратное улучшение всё это сделали при помощью просто интеграции одной библиотеки Что такое РТ это интересная технология от NVIDIA Она позволяет вам без изменения какой-либо сетки получить performance Boost это делается при помощи разного рода фьюзинга слов подкатных оптимизаций оптимальны лов для исполнения Вот и е па работы с ней выглядит вот так сначала запускаем шаг компиляции то есть загружаем сеть в оптимайз запускаем оптимайз и получаем сетку или в т формате дальше на иренс мы загружаем полученный и запускаем сетку в ран тайме дожи вот вотт падает ничего не происходит И всё идёт не по плану ошибки Да и доклад он в частности посвящён этому вот наш план и вот эти пункты они посвящены каким-то подводным камням и нетривиальным каким-то вещам которые повстречались во время работы с этой технологией Сначала я расскажу про компиляцию Райф это сеточка по повышению фпса дальше про компиляцию Бесика и под конец у нас будет плотная секция где будет такой сбор неочевидных вещей которые Надеюсь людям поможет Вот ну прежде всего задача чтобы лучше обрисовать обрисовать две сетки бейсик по повышению качества работает на пачке из 10 кадров на вход 10 на выход 10 работает он где-то за 1,3 секунды а Райф у нас отрабатывают на двух кадрах на вход два кадра на выход Один кадр мы предсказываем кадр между ними и отрабатывает она где-то за 30 миллисекунд особенность задачи заключается в том что это задача масштаба Да у нас есть некий кусок кода который выполняется Ну можно сказать на каждый кадр и вот к примеру в пти минутах видео Мы у нас есть 27.000 кадров И если мы ускоряем процессинг одного кадра только на 50 миллисекунд мы получаем в конце выигрыш 22 минуты и чем длиннее видео тем больше будет этот выигрыш поэтому здесь как бы каждая миллисекунда на счету Ну первая секция Райф немножко расскажу про устройство сети и вот сама задача - это интерполяция кадров У нас есть наверху изначальные кадры да девушка едет на коне и Наша задача предсказать кадры которые находятся в пунктирные рамочках то есть предсказать кадры посередине рай работает при помощи использования такой вещи как оптический поэтому о м тоже стоит рассказать оптический поток - это достаточно простая концепция по сути это тензор описывающий изменения между изображениями То есть у нас есть первое изображение второе в оптическом потоке у нас хранится то куда переместился каждый пиксель Ну по оси X и Y Ну то есть это двухканальный тензор размерностью само изображение так вып слева у нас две наложенные картинки где у нас произошло какое-то Движение И вот видно что у девушки рука пошла на юго-запад Да и стрелочки тоже идут вот на юго-запад col Map он повторяет это движение то есть вот с такими тензора Приходится работать Как устроена сетка Рафи это по-своему некий был прорыв в области изначально все решали эту задачку основываясь на оптический поток то есть сначала предсказывал оптический поток Как видно слева и дальше был последующий шаг когда предсказывал средний оптический поток то есть между исходными кадрами и кадром которые мы хотим вписать и дальше этот оптический поток использовался для последующего предсказание кадра Рафи решила избавиться от этого шага и они как раз по сути стали первой сеткой которая действительно хорошо работает для интерполяции кадров То есть то что было до этого если его запускать на на чтом то что не входит в их датасет это работало не очень хорошо а вот райфа её можно запустить на любом видео Ну как и мы делаем и она с радостью всё это красиво интерполировать тут не пугайтесь но достаточно тоже простое описание того что происходит у нас есть кадры которые приходят Ээ это i0 и I1 сетка предсказывает маску комбинатор и вот промежуточные оптические потоки о котором мы говорили раньше результаты У нас есть наши наш самый результат который мы получаем при помощи комбинации заварных кадров при помощи оптического потока то есть мы берём картинку и при помощи промежуточного оптического потока просто перемещаем пиксели в то место которое мы предсказали в оптическом то и получаем промежуточные изображения и дальше мы эти изображения Соединяем и получаем финальный результат вот ну и вот сама сетка Райф она тоже чтобы понимать что мы улучшаем это пирамида а пирамида свёрточная пирамида э с использованием вот такого хитрого варпинг и вот предыдущий шаг он как раз-таки используется Перед каждым перед каждой резидуально связью вот компиляция Райф что мы делали то есть первое что хотелось попробовать бачин но очевидно что вот с классификации когда люди работают часто увеличивая бач мы получаем бам в латен здесь такого не было Вот можно на это заметить также у есть возможность поддержки мено понятно почему Потому что когда вы оптимизируется к примеру классификатор Вы хотели бы туда подавать разного размера картинки и Соответственно в этом параметре мы передаём минимальное значение максимальное и некоторое оптимальное и возникающий вопрос очевидно Это насколько Вот это оптимальное значение будет влиять на наш финальный перформанс да то есть если мы укажем оптимальное значение в районе 360п Ну вот размер видео и потом будем вать видео насколько это будет афек перформа ну заметили что особой разницы нет то есть выигрыш 2 миллисекунды не оправдывает какую-то повышенную инженерную сложность Что дало выигрыш это fp16 вот на высотой получили ускорение сетки в два раза причём это практически за бесплатно то есть ничто не пришлось переобуть просто взяли сеть и конверт нули на Т4 значения схожие Хотя тоже выш Рат обратить внимание что на Т4 сети сами по себе медленно исполняются потому что карточка менее мощная подводный камни Вот почему я рассказывал про архитектуру и про варпинг потому что как раз-таки слой варпинг он не поддерживается в РТ и вот что делать как бы Когда такое происходит Ну очевидно есть несколько решений можно заплети слой самому но понятное дело программирование наку дело такое че превращать проект который по оценкам замт 2-3 недели в какие-то несколько месяцев потому что корректная имплементация какого-то сложного слоя на куде задача не из простых поэтому Лично я что для себе нашл и чем хотел поделиться есть у китайцев библиотека которая называется идея её это деплоя то есть большинство сеток подавляющее большинство сеток которые у них там есть они поддерживают и поэтому Если у вас есть сеть которую вы хотите конверт нуть в И вам нужны слои очень стоит посмотреть вот этот репозиторий Скорее всего вы найдёте то что Вы ищете Ну и вывод можно сказать что не оригинально воруйте отовсюду словами вот следующее бейсик компиляция сети по суре устройство сети Сеть изначально разрабатывалась как некая дисоциация всех идей по сверхразвитие фичи из картинок другой блок вычисляет вот оптический поток о котором мы говорили раньше дальше блок прон фют эти фичи и он уже их разжимает можно так сказать тут основная идея заключается в том что фичи в экстракции в алинг они считаются покадрово то есть они как и вычисляются так исмп каждый кадр по фиче но слой пропана здесь такая самая интересная сть он ки заниматся мнт какую-то информацию которая которая у нас есть в видео ряде в сами фичи чтобы слой мог гораздо более качественно предсказать кадр Как устроен слой пропана вот можно можно посмотреть на картинку У нас есть два два жа Back propagation и Forward propagation в каждом В каждом же у нас есть некое скрытое состояние которое мы передам от этих блоков бло у нас приходит два кадра следующий и текущий и скрытое состояние Ну вот в случае сами слои тоже устроены более-менее Просто у нас Мы вычисляем сначала оптический поток потом мы при помощи этого оптического потока ворм фичи которые м при из скрытого Сония потому МКА которые связаны вот с текущим кадром Вот и потом мы используем сетку по сути пирамиду для расширения этих фичей и дальше передаём на следующий блок тут сразу Можно перейти к подводным камням Бесик сетка интересная ну и к ней тоже ба не помогает тут вот на этом графике показан размер по иксу и мы видим что каждый бач у нас накидывает порядка 2 гигов при этом выигрыш тоже в районе 2 миллисекунд на увеличение Ба и основной подводный камень что вот то что я всё рассказал это чтобы показать что топология явно нестандартная это не типичный Т это даже не нка и не трансформер это вот какая-то вот такая Махина потому что описано мной это ещ упрощенный вариант а у нас вариант Basic vsr п+ в два раза больше этих рекуррентных связей и тензор т такое просто не тянет и решение мы разбиваем сеть на множество компонент Благо у нас она даже логически поделена на них Вот и вот затраты каждый из компонент Мы видим что мы явно Батл нечем в прог тратим на неё доминирующее количество секунд и чуть больше чем все остальные на асмп и Да каждый компонент переводится на нзр т и вот тут можно увидеть выигрыш в latc то есть здесь у нас всё на P выполняется за 1 ид секунды то перевод на T prop sle слоя накидывает нам 600 миллисекунд считайте практически за бесплатно без какого-либо переобучения но всё имеет некую цену мы по сути Меняем наш основно в том что мы меняем как бы скорость на количество гигабайт которое мы потребляем по оси Y у нас гигабайты по оси X у нас скорость и вот фиолетовый крестик - это у нас всё нарт да и мы видим что каждый наш шаг тоже по сути накидывает около гига гига в памяти на тче У нас тоже схожая картина уменьшается порядка двух раз И вот как бы наши финальные выигрыши то что раньше исполнялось за секунду исполняется за 510 миллисекунд ал и вообще в три раза быстрее Ну конечно нужно упомянуть о основном минусе такого подхода - это Инженерная сложность кода становится больше у меня его стало больше в 300 раз потому что то что раньше делась Ну если бы запустился делалось бы двумя строчками сейчас по сути вся сетка написана на плюсах Вот и код задубровский код код который занимается конверсией в нзр и код в плюсах Поэтому если вы решили такую чем-то таким за нужно осознавать сго этот вы будете закладывать время на такого рода разработку и вывод У нас есть трейдов приятный код и хорошее разрешение вот у кого-то могли появиться вопросы потому что любая оптимизация чего-то стоит в нашем случае стоимость минимальная ошибки достаточно малы вот 99,8 пикселей в райе у них ошибка где-то меньше 0 у Бесика картина схожая качественно Я долго смотрел видосы тестеры тоже смотрели ничего такого не нашли и интересный момент который хочется отметить что вот Усика ошибки бывают трёх родов либо вот ноль ошибок нет либо у нас какое-то волшебное значение либо у него как бы он полностью перепутал цвет Но несмотря на то что он иногда меняет пиксель это никак не влияет на качество то есть Лично я не смог этого заметить и никто другой тоже вот inference особенность инфраструктуры Да тут на этом слайде наверное Может кто-то удивился но нужно немного объяснить мы запускаем нашу сетку на инфраструктуре видео одноклассников и видео в Одноклассниках писалось давно оно было написано е когда слово кубернетес не все знали и на тот момент ребята поняли что нужно что-то для оркестрация Вот и поэтому Э мы сейчас Работаем на этой инфрейн Э что докер мы не можем использовать поэтому это добавляет некий Челлендж запуск модели Что может случиться модель конвертируется но не работает причина здесь скорее всего две либо у вас есть несовместимость вашей модели ран тайма Либо вы нашли бак Вт вторая маловероятно но оно может случиться Лично я на такое налетал несовместимость модели это вещь гораздо более вероятная Вот и я разработал такой чек-лист чтобы как бы понимать что всё должно быть хорошо то есть прежде всего тестируется модель в в окружении понимаем что с ней ВС правильно понимаем что версии для модели и для прода они у нас мача потому что требует о в о совместимости библиотеки для компилятора и для инса также требует совместимости железки да на той железке на какой мы компилируемые что железо нас совпадает это написано и эту вещь за этой вещью стоит следить иногда из этого может быть что-то какой-нибудь неприятный краш вывод ну нужно быть внимательным в этом случае теперь у нас четыре подводных камня четыре кейса которых стоит упомянуть первый - это то что у T есть Фронда к компи у есть Плюсовая вер У нас есть плюсовые новский банги к и есть новская прога полиграфи очевидно что у любого появится вопрос Что именно использовать но лично мой опыт лично моя интуиция такова что - это какая-то их первая итерация какой-то программы для помощи поэтому она Роме каких-то супер специфичных кесов м вяли поможет какие-то сложные модели можно подумать о использовани питонов байдин или чистых плюсов Если вы в плюсах всё делаете но сейчас кажется самым оптимальным решением является полиграфи Это фреймворк от N у них есть поддержка огромного функционала в том числе для работы с усом для чистки графа и для последующего даже какого-то дебага второй подводный камень - это документация них никакой единой точки входа доки огромные И порой там есть не самые Ясной формулировки к примеру переменная Max workspace size в доке вроде бы описано вроде бы прочитаешь и вроде бы понимаешь что она делает кажется что она задаёт то сколько нзр будет занимать памяти при ран тайме но нет это память при компиляции на stf есть разъяснение того что это такое поэтому какие-то неочевидные места док логично гуглить спрашиваю gpt и в в таком условии конечно же разработка решений лучше всего вести итеративности его наращивать понимая что у вас нет каких-то неочевидных мест хороший точки входа глаф и ещ есть одна отдельная Дока на ED Linux там хорошо описано как всё это можно дебажить третий подводный камень - это баги баги случаются и учитывая что это нзр такая штука капризно и так много движущихся частей можно долго ходить вокруг и пытаться что-то чинить но в конечном итоге это может быть действительно баг Вот мой кейс в F16 сетка bic падала и это ня излечилась только новая версия T то есть тут как бы совет в том чтобы пробовать разные версии нзра пробовать также разные методы конверсии потому что иногда изменение метода конверсии Фронда вот этого компилятор о котором я говорил в начале Может вам как-то сыграть и репортить баги на гитхабе ЕС Это точно баг ребята Их чинят и процессы у них в этом в эту сторону запущены и четвёртый подводный камень - Это то что нзр он очень похож на чёрный ящик у вас нет какой-то возможности заглянуть под капот кода открытого нигде нет для выбора вот оптимизации о которых и говорил для выбора ядер для фьюзинга слоёв он использует так называемые тактики и тактики они опираются на результаты Бенч есть запускает сетка и выбирает оптимальную тактику в зависимо от этого Сами понимаете что в таких условиях если вы запустите что-то параллельно с вашей сеткой бенчмарки изменятся и в разные какие-то запуски у вас появятся совершенно разные сетки и в этом есть как бы явная проблема а но Инзер это покрывает тем что есть функционал для реализации детерминированных ээ так называемых компиляции То есть когда вы при первой компиляции логи ете Какие вы тактики используете а при последующих компиляция вы уже будете переиспользовать то что вы записали это встроено очень удобно в полиграфе Вот и поэтому если у вас к примеру может оказаться случай что при разных компиляция у вас либо проседает качество либо сетка просто крашится тогда стоит вот подумать о применении этого функционала благо это пря супер сложно простая у Tor RT есть flb то есть можно посмотреть какие оптимизации были применены но если сетка начинает становиться сложной то парзи FL Boss - это отдельная задача потому что всё выводится в каком-то промежуточном формате и то есть тут каких-то явных решений чтобы понять что вот у меня была сетка я её скомпилированный решений нету Ну и выводы из этих подводных камней то что работая с тензоров движимых частей чем больше у вас детерминизма в вашем пайплайн тем вам будет проще Используйте последнюю версию потому что чем версия старше иногда даже и перформанс растёт просто от обновления версии и нужно нано смириться с тем что информации мало ито до это с проектами типа Или какими-то другими фреймворка иногда можно залезть во внутрь посмотреть что там происходит Почему у вас в какой-то момент сетка начинает работать дольше тут такой возможности нет но с этим нужно видимо смириться и жить дальше Вот ну финальные выводы то есть путём таких улучшений которые ником образом затрагивают сатку в два раза и как бы если абстрагироваться и подумать что мы вот сетку не трогали совсем но она в два раза стала быстрее работать это мне кажется очень крутой результат вот что как бы показывает что типично сетки мы запускаем явно не оптимально Потому что есть такой запас по производительности благодаря вот этой технологии и Да и то что мы никоим образом сетку не кнту ничего автоматически Вот спасибо вам за внимание голосуйте за мой доклад Спасибо большое Арсений переходим к секции вопросов и ответов с кого начнём поднимайте руки Вот пожалуйста в правой части зала вопросов первый - это про генерацию движков для ТТ как бы у нас есть достаточно большой пул видеокарт То есть можно заранее сделать под все известные видеокарты движки либо генерить прямо на видеокартах на стендах Как вы делаете У нас в проде в основном три типа видеокарт он более-менее однообразный и сначала генерируют дальше запускаю потому что л видеокарт очень большой на каждой как бы одно и тоже компилировать не хочется спасибо а используете ли Тритон для Ирен сеток у нас всё встроено вот в это в Tools видео Tools поэтому ритон интегрировать как-то не получилось но тритоне слышал много чего хорошего Да просто там под капотом есть и и вся история с оптимизацией и с квантования и со всем остальным очень и тоже для и дадада но тут просто проблема что вот к примеру в бейсике там сам ничего ну как бы бы не мог скомпилировать Ну с рафе понятно Там просто нужно было бы скорее всего слои подтянуть Но вот такую большую сеть Как бейсик так или иначе нужно разбирать на куски и отдельно компилировать тут мне кажется как-то Тритон Э я не очень знаком с этой технологией но Я подозреваю что внутри неё не получится реализовать так чтобы это было оптимально там так или иначе нужно передавать большие фичи подозреваю ритон заточен Именно под работу с картинками или с какими-то тензора малых размерностей Ну с трансформером хорошо работает так но это наверное для кулуарно дискуссии спасибо спасибо спасибо А ещё вопросы Ну как раз кулуар ную дискуссию тогда мы сможем А вот Прошу прощения Секунду сейчас микрофон принесут Как вы себе объясняете чтобы чува не не улучшалось оно плохо масштабированных я я на эту тему думал а в случае с Райф кажется там сетка не особо глубокая То есть у вас батч даёт какой-то супер выигрыш Когда у вас там есть огромный ренет и вы подаётся большой батч и вы тогда действительно повышаете производительность в случае с бесикович мы его улу увеличиваем там в н раз и тут тоже наверное ещё как бы вкладывается сама вот сложность этой сетки Бесика потому что у нас есть разные проходы мы интерактивно идём по одним кадрам и по другим вот поэтому мне кажется случае Рафи это именно то что сеть ну не особо глубокая а в случае с беком это вот э именно сложность секунду ЕС сеть не особо глубокая Она же в изначальном варианте с маленьким бам натт использовать мало регистров и так далее ей бачева наоборот должно то есть в рост Бача должен вам сохранять н и растить пропускную способность разве нет Потому что если сеть маленькая то у вас ещё есть свободные ресурсы на карте Ну там ещё мы на райе подаём достаточно большие картинки туда прилетают картинки 72 возможно она как бы выла все свои ресурсы за счёт размера картинки Ну потому что у нас как бы есть батч и есть размер самой картинки если подавать большие картинки тогда мы как бы будем выдать тот запас мощности который у нас есть Спасибо за вопрос ещё я сейчас проверю Есть ли вопросы из онлайна Вопросов нет тогда Арсений у нас Два подарка и два вопроса Выбирай Кому какой есть от парт конференции Газпромнефть давай начнём с него Давайте первому док первому вопрошать Газпромнефть второму нашего фирменного хомяка супер Ну и тебя Мы тоже пока не отпускаем вручаем тебе подарок Спасибо большое огромное спасибо за доклад за такую интересную тему экспериментируйте Приходите делитесь результатами было очень кому хочется углубиться в тематику прошу пройти в дискуссионную зону Спасибо Спасибо"
}