{
  "video_id": "6Jw6OvqSRpg",
  "channel": "HighLoadChannel",
  "title": "Трансляция HighLoad++ Весна 2021, 17.05, зал 1",
  "views": 1244,
  "duration": 33711,
  "published": "2021-10-04T02:47:02-07:00",
  "text": "антон ой на смысле первая профессиональная конференция разработчиков высоконагруженных и сложных систем проектов highload плюс плюс объявляется открытой я бесконечно рад вас всех видеть я бесконечно рад видеть вас вживую я не знаю как я ни пытался мы попытались сделать порядка 20 онлайн of и сделали хорошее и многие очень необычные я не смог его полюбить ну я не смог я пытался честно все-таки мы пандемию показала что мы все люди вот такой нежданчик что мы все люди что нам нужно общение что даже для того чтобы впитать в себя информацию чистой информацию на все равно нужна какая-то эмоция что потом прийти и и например применить мало что-то узнать на конференции ты должен еще потом по этим ножками убедить начальство том что нужно сделать по-другому сотрудников коллег вообще что-то открыть скачать новые не знаю репозитории запустить то есть нужна энергия и драйв и мы собираемся в оффлайне вот здесь вот в такой красивой обстановке такой драйвовый обстановке именно для того чтобы эту энергию получить вот почему мы идем вперед потому что мы профессионалы этот этот гимн аж мы придумали в 2014 году я вчера специально посмотрел 2014 году и он очень простой он про то чтобы профессионализм состоит из двух вещей это любви энергии и знаний и опыта вот именно такие нашей конференции добро пожаловать так а теперь небольшая экскурсия о том как пользоваться конференцию всем привет если что меня зовут олег бунин организаторы конференции очень много одни одни из организаторов конференции ребят нас 150 человек над конвой сейчас в залах 150 волонтеров помощников халк тимов кто угодно 150 самая большая маленькая армия да вот и первым делом пожалуйста надевайте маски обязательно когда вы ходите в фойе когда общайтесь с людьми соблюдайте социальную дистанцию в общем мы вас бережем мы очень много сил приложили чтобы дезинфицировать все-все рисунку ли ровать но вы тоже пожалуйста следите за этим смотрите по маскам тов по маскам есть одна важная вещь кто переболел ребят нам с вами ничего не угрожает но мы все равно будем носить маски но у на жены на лбу не написано что мы переболели и человек который перед нами он может волноваться он может беспокоиться того что читаю без маски ходим и так далее поэтому и просто гению маску из из-за того чтоб бы из уважения для того чтобы создать и для него в тоже безопасное пространство чтобы он не парился по этому поводу так хорошо и если вдруг у вас нет маски у нас на территории множество масок на всех выходах на стойке регистрации у любого организатора спрашивайте вам дадут даже из красивой маски на каждого дальше кто вакцине rose парня девушками нам с вами точно ничего не угрожает бы мы тоже будем носить маски из уважения для того чтобы для всех а не только для нас было безопасно чтобы никто не беспокоился и не волновался еще пара вопросов мы никому это не покажем трансляцию не пойдет здесь есть к вида диссиденты но то есть том плане что он это просто же гриб ну то есть немножечко медийной раздутый есть такие мы с тобой ведь все равно наденем маску да просто чтобы никто не беспокоился мы понимаем что они все ошибаются реально но мы ну понятно что грипп сезонность слушай это все ясно мы умнее ну маску мы наденем хороша так а есть те кто уверен что маски не работают потому что ну вообще но не работает понятно мы понимаем что все что это истерика на то есть как бы они все все все беспокоятся нужны вирус не понимает что вирус маленький он пройдет через поры маски элементарно но мы сами тоже оденем маску у нас их много меняйте их каждый час если они там не знаете что-то выходите на улицу подышать но пожалуйста всегда и везде всегда и везде из уважения к другим людям спасибо а теперь когда мы так долго говорили про маски давайте быстренько поговорим обо всем остальном пожалуйста прямо сейчас выключите звук своих телефонов чтобы не мешать спикеру и не мешает сидящим рядом возле вас звука телефонах их тут три страницы а лиса его раз ел программа комитет highload очень большая структура очень большая структура то есть мы проработали импланту более 200 то кладов под 300 что лес во все программа программно комитетов несколько работать на high line 1 несколько цифр то есть есть программный комитет по архитектуре по машин warning у и так далее ну неважно да то есть мы готовили ивану год год то есть сначала мы он был полностью готов в ноябре мы его перенесли обновили ну в общем короче эта программа выстрадана лучшая программа за все время которого минимум за год до минимум за год идем дальше расписание у всех у вас есть чудо книжечка на шее в ней много полезной информации это но самое важное это расписание этим очень удобно пользоваться не надо вертеть мы специально обучили наш типографии переворачивать листочки они научились встретил пару раз ну один раз перепечатывали один раз мы разбирали кольца перри собирали вообще обратите внимание пожалуйста у нас есть три расписания и расписания в залах зала всего 8 в них записываются доклады это будет следующий зал следующий слайд есть расписание выставки у нас огромная выставка это тоже по-моему самое большое количество партнеров которые у нас есть за последние годы есть отдельное расписание дема выставки где партнеры будут разыгрывать призы где вечером будет хабар награждение компаний попробует награждать за лучшие блоги обещают концерт обещаю сюрприз и вечерняя программа и и вы можете посмотреть в брошюре выдается в зоне раздатки вот в конце брошюры также есть оглавление вообще брошюры такая толстенькая книжечка в которой написано много чего о докладах и в том числе как выглядит спикер чтобы подойти к нему и задать ему вопрос какой нибудь мы сделали оглавление он кофе имени и по секциям доклады собственно мы находимся в зале 1 и по кругу пошли зал и все доклады записываются бухгалтерии у нас получается справа от входа в выставку около 5 до так же вы можете увидеть кофе-брейк кофе-брейк у нас постоянный уже работает можно пить означает что в любое время можно прийти там будет кофе и немножечко перекусить а сейчас вот наша гордость это гибридные конференции скажешь на мы попытались сделать так чтобы перемешать online so fly нам то есть у нас здесь будут перед каждыми докладами будут онлайн вставки для нас для оффлайновых ребят а оффлайновые ребята могут прийти к нам сюда взял почти ножками а то есть они могут задать вопрос мы его увидим мы потом после каждого доклада выходим цифровые кулуары да то есть это специально оборудованное место куда тоже можно подключиться можно подключиться из онлайна и увидеть как мы стоим вокруг докладчика задаем ему какие-то вопрос мы это попробовали это выглядит очень прикольно попробуйте сами как-нибудь накройте из наших конференций в онлайне зайти то есть ты стоишь в кулуарах ты видишь кулуары вот там камера специальная которая видит фокусироваться на том как только сейчас говорит носит выглядит очень прикольно ты начинаю задавать вопрос тебя в кулуарах слышат тебя слышат видят и отвечают а те кто нас смотрит онлайн это я в камеру обращаясь обратите внимание у каждого зала снизу есть две кнопки задать вопрос спикеру в эфире это значит вы попадете на экран сюда прежде чем пройдете фейс-контроль наших помощников и 2 подключиться в дискуссионную зону то есть после того как спикер закончит отвечать на вопросы на сцене он пойдет в цифровые кулуары старая дискуссионная зона и там зум конференции оффлайн онлайн сможете пообщаться наук онлайн ребята не стесняйтесь а теперь наша будущая теперь так будет всегда да то есть мы это сейчас внедрили через какое-то время ты внедряться остальные организаторы вот так теперь будет научитесь использовать возможности онлайна более полноценно нас смотрит две с половиной тысячи человек на доложи рекорде три с половиной тысячи в онлайне а здесь 1900 и 2000 онлайн дальше обеды у вас пиджак в кармашке сзади должно было быть два талончика если вдруг нет обратитесь на стойку регистрации кормим из 12 15 до 16 талончики можно менять кормим на втором этаже просто подойти к лифту мы на четвертом спуститься на два этажа вниз прямо под нами спускаете slide открывается и вы в центре импровизированную не знаю какой столовой да если что на территории крокус экспо если вы хотите вдруг множество кафешек о том что втором этаже талончики с обедами можно менять время можно менять приходите на регистрацию меняйте на любой другой или в чате конференции устраивается торги обратите внимание наш хэштег наш чат где можно общаться наш канал наш канал пожалуйста на него подпишитесь мы туда будем писать если вдруг что-то отменится если что-то перенесется или какие-нибудь другие организационные новости и чат и возле плееров но это больше для онлайн участников партнеры я говорила их много большое спасибо нашим партнерам и сейчас некоторых из них мы хотим пригласить на сцену чтобы они рассказали чего нас ждет вы же видели этот мини город который построен только очень-очень быстро поднимайтесь пожалуйста спасибо на самом деле на самом деле реально большое спасибо потому что мы выжили как команда как компания как конференции вообще благодаря им то что был период когда нам но никто все остановилось деятельность нам сообщает о том что ребята а теперь вы закрыты и теперь у вас нет и вы ничего больше не делаете ничего не умеете и насколько ничего это быть никому не нужны и продавать вам ничего нельзя и только благодаря партнерам вот этим вот это это представители только там не за четверть у тех кто нас поддержал за этот год поэтому им реально бесконечно благодарны каком-то смысле жизнью спасибо всем привет у настроение ребят татьяна сверху а компания select all безумно рада наконец-то видит живых людей очень соскучились пожалуйста приходите на наш стенд давайте общаться давайте обсуждать все что было ненавидеть онлайн-площадки и обязательно участвовать в нашем у кого есть и будут классные призы и ждем всем привет я наверное присоединюсь тоже к уже сказанному наконец-то очень круто видеть всех в оффлайне потому что от от онлайна действительно очень сильно устаешь я желаю всем и каждому сегодня для себя и сегодня и завтра на самом деле знать что-то новое обязательно послушать спикеров и поиграть наверное большинство игрушек которые делают команды компании партнеров но и конечно же приходите на наш стенд тоже там тоже есть игрушки в общем-то очень даже интересно но глобально наверное хочешь сказать что за эти два дня мне кажется 1 не побоюсь он оффлайн конференции за последние полтора года найдите что-то свое и унесите его домой и дальше рассказывая друзьям коллегам и обязательно посещая такие мероприятия в будущем у меня все спасибо спасибо еще раз доброе утро всем черно-белый тандем дует языкам бей меня зовут настя шивайя черт директор компании компании моя нам привез на речь будет очень короткой и в основном наверно опять связаны со словами благодарности во-первых большое спасибо кончика за то что дали нам возможность побыть генеральным партнером такой крутой всеми любимой конференции себя это вам спасибо за доверие в первый раз генерального партнера придумали и тут и тут вы большое вам спасибо это была ответственность челленж и очень было любопытно и сложные что все получится а безусловно большое спасибо всем нам за терпение всем вам за то что мы дождались все-таки оффлайн невского формата за то что награждались живой конференции живых выступлений выступления ну я буду не я если благодарю нашу dream team и компаний за подготовку конференции за ваше выступление ребят горжусь вами помашу вам там на стенде и конечно же одному из выступающих тебе особенно начнете все наступающим сегодня легкой аудитории нам да друзья всем реально очень рад всех видеть в живую наконец-то и огромное спасибо программу комитету за то что отобрал больше сотни крутейших докладов ни один не стендами едиными и конференция это не только общение это еще и самый крутейший доклады самая крутейшая спикера поэтому ходить и слушайте впитываете новые знания и уходите более лучшими самими собой ура всем привет всем привет меня зовут максим я представлюсь этим угол и у меня сразу вопросик такая кто сегодня на конференцию оффлайна смог добраться нашим сервисом поднимите руки есть люди ну не очень много да спасибо вам спасибо за offline спасибо организаторам вообще что интересно сети мобилу ассоциируется у многих просто с такси у нас намного намного больше работы мы всевозможные интеграции делаем по mac мобильной доступности и по по настоящей такой городской мобильности поэтому классно что все здесь спасибо всем приходите к нам на стенд приходите пообщаться голосом поиграть рассказать про себя послушать про нас всем спасибо да всем огромное спасибо меня зовут стас образовательная платформа skillbox мы здесь для того чтобы помочь вам развить ваш личный бренд чтобы помочь собрать команду мечты и если у вас есть ваши проекты в которые требуются молодые специалисты и так нам приходите на наш стенд спасибо организаторам спасибо вам всем а еще сегодня вечером skillbox наливая это всем всем привет меня зовут алексей я представляю integrity solutions мы разрабатываем курсы на высоком загруженные сервис продукты на базе некоторые платформы о которой мы поговорим лучше на стенде с вами мы очень ждём и мне будет приятно наверное большинством из вас пообщаться поговорить узнать кто вы и узнаете что вас там ждет тоже при при хождении к нам вот то что я уверен сегодня будет очень интересное для вас конференция то что отличного настроя успехов и вынести здесь как можно больше и контента который позволит вам стать лучше спасибо всем привет я повел я представляю mail.ru и представляет не только тарантул который меня на спине но еще и mail.ru клауд solutions стандартно у нас есть стенд у нас есть мелочь вы знаете что делать давайте просто послушаем классные доклады мы уже достаточно затянули и кстати первый доклад наши он будет здесь не уходите доброе утро всем верны штерна лице digital наш стенд находится перед этим выходом из этого зала перед входом в этот зал мы занимаемся ускорением изменений в командах в людях и культуре организации если вы встречаетесь своей трудовой деятельности с токсичностью с сопротивлением ригидностью со всякими такими вещами ну что жизнь то все равно продолжает идти вперед добро пожаловать к нам и нон-стоп два дня решаем поднимаем эти темы и решаем ваши кейсы всем инсайтов всем обмен энергии и новых знаний десант культуры на нашем в нашем технологической технологическом мире большое спасибо еще раз благодарю вас и спасибо спасибо большое ну что поехали мы рассказали о том как пользоваться конференцией и последнее что нам остается сделать это ещё раз выполнить традицию представить нашего бессменного ведущего лишь у образца алексей drastic пришло время когда у нас масочки под цвет обуви и спасибо с этого момента только шутки про инженеров поэтому вспомним двухлетней давности шутку про стажера из mail.ru который выйдет на эту сцену сейчас владимир перепелица также muons андерсон давай скорее мы отжали у тебя десять минут ребятам онлайне привет зададим вопросы потом готовьте вопросы по докладу воду переверни она у тебя вниз главы волнуешься нет конечно мы ждали тебя выдохнул успехов можешь затянуть потому что затянули начало всем остальным затянуть быть нельзя успехов и там он спасибо лишь рад всех видеть ужасно рад видеть всех живую как уже многие сказали чертовски достали эти онлайн и я сегодня начну с простой такой темы хорошая разминочка для утро понедельника для начала конференции как выбирать очередь я записан как владимир перепелица я больше известен как man сандерсон потому что так и везде подписан немного расскажу о себе может быть кто то не знает я почти 9 лет работы в mail.ru до этого я работал в рамблере и архитектор облако mail.ru mail.ru cloud solutions архитекторы product тарантула нашей платформы базы данных сервер приложений в общем много всего я очень люблю очереди я использую очереди с 2008 года я проникся этим паттерном я люблю реализовывать очереди конечно же на tarantul и это очень интересный инструмент для этого я люблю рассказывать про очереди несколько лет назад я подумал что надо бы рассказать про очереди я довольно много про них знаю вот я сам умею готовить я умею их выбирать надо рассказать о том как их выбирать первоначально я подумал что я возьму много разных очередей я их проверю и проверю их на разный перс предложу варианты сравнительные таблички много грузило вынос мозга потом потом я передумал во-первых потому что как обычно доклады готовятся в последний момент во вторых потому что гораздо важнее знать не перф перф может проверить каждый то есть вы просто берете свою собственную там инсталляцию берете выбираете одну штуку другую штуку третью штуку и как бы проверяете удовлетворяет она вам попер foo или нет в большинстве случаев вот поднимите пожалуйста руки те у кого скажем так нагрузка по запросам по сообщениям по ещё чему-нибудь превышает 10 тысяч запросов в секунду вы можете оглянуться и посмотреть это довольно малый процент из большого зала холода то есть в целом большинству этого достаточно большинству достаточно того что даст им любой брокер гораздо более важная вещь это то зачем вообще нужны очереди как они устроены и как они работают я расскажу несколько сценариев я буду говорить про то как они устроены про то какие вообще есть решение и мы сможем то есть вы можете всегда подойти ко мне и поговорить еще про очереди значит очереди нужны для распределения задачу на пример простейшей сценарий у нас есть 3 сервера один помощнее один послабее и один вообще не работает у нас есть входящие какая то нагрузка если мы возьмем классическую балансировку которая равномерно распределяет нагрузки на эти сервера мы получим следующую картину тот кто послабее он будет перегружен тот кто посильнее он будет не до гр ужин и какая-то часть запросов будет еще и фэй лица если мы вместо классической балансировки поставим очередь мы будем входящий запрос и складывать в очередь и те сервера которые работают будут забирать это в качестве задач на обработку тот кто мощнее будет забирать больше задач потому что он мощнее он успевает их обрабатывать тот кто послабее будет брать меньше но это обеспечивает самое честное самое качественное распределение задач значит далее очереди часто используется для планирования исполнения например у нас классическая синусоида или еще какой-нибудь график волнообразно когда у нас в один момент нагрузка большая в другой поменьше для того чтобы обслуживать такую нагрузку нам нужно иметь железо для обслуживания пика нагрузки то есть остальное время когда у нас ночью там ли не в аудиторный час нагрузка снижается мы не до используем ресурсы то есть мы могли бы снизить количество ресурсов которые мы предоставляем откладывая те задачи которые превышают наш оптимум то есть мы можем поставить меньше железо когда мы не успеваем обрабатывать задачей мы складываем их в очередь и они разгребаю ца позже когда ресурсы появляются то есть целом очереди это про например честность выделение ресурсов очередным можно реплицировать какие-либо данные при помощи очередей обеспечивается отказоустойчивость надежность передачи гарантия того что сообщение будет доставлено также очереди используется в качестве инструмента для коммуникации микро сервисов это породило несколько архитектура есть событийная архитектура есть потоковой архитектура она же streaming и это все как бы показывает нам что очередей очень много и они применяются довольно часто если посмотреть где очереди применяются то их можно найти на железном уровне то есть наше оборудование использует у себя внутри принципы очередей очереди есть в операционной системе то есть это всякие и пол как и у всех буфера сигналы если подниматься выше очереди есть в приложениях в приложениях у нас есть общение между разными thread'ами между разными процессами между разными процессами на разных составах то есть мы переходим уже к сетевым взаимодействием то есть в целом распределенные системы очень часто используют очереди в целом даже когда у вас есть построенная система она может использовать в очереди или не использовать на очереди часто используют для того чтобы состыковать разные бизнесы например два банка два разных банка они между собой общаются при помощи очередей то есть они передают одни транзакции в другой банк при помощи очереди фактически можно сказать что очереди применяются везде вот вы можете взять любой слой своей системы ткнуть туда и найти там очередь в том или ином виде очереди это своего рода клей между различными уровнями системы значит что такое очередь это средство для коммуникации коммуникация в очередях происходит при помощи сообщений то есть мы берем сообщение мы кладем это сообщение в очередь и кто-то другой его может оттуда достать это простейшие определение очереди на низком уровне на уровне структур но в распределенных системах мы идем дальше есть разные подходы то есть есть подход когда мы в очередь кладем задачу один раз и один раз ее оттуда забираем это подход пут и тейк то есть вот по названию методов которые это делают есть продюсеры которые кладут задачу в эту очередь есть консьюмер и которые приходят берут задачу могут обработать и тогда она выбрасывается то есть она считается обработанная либо они могут не успешно ее обработать и вернуть обратно есть подход который называется publish субскрайб или попса это подход когда продюсер доставляет сообщение один раз и на эту задачу может быть подписано разное количество концу меров бывает много сценариев бывает так что задача доставляется если концу миров нет она уничтожается бывает так что они там лежат и консьюмер и могут многократно эту задачу обрабатывать но так или иначе в отличие от первого подхода это один ко многим продюсер публикует задачу и у нас может быть много кантемиров которые эту задачу могут взять и обработать есть еще подход в очередях он изредка встречается request a response вот тот самый классический request response как мы делаем серверах только в этом случае это делается при помощи сообщений мы отправляем сообщения request он где-то процессе ца концу мир отправляет сообщение обратно которая является респон сам очереди бывает очень много протоколов то есть за все время существования данной темы есть протоколы mtp advanced message queuing протокол mqtt применяющийся в оборудовании 100 мб над зеренков то есть с этими словами можно столкнуться вот просто начав искать про очереди я немного скажу что это такое и в каком случае что применяется какие у нас есть варианты если мы хотим взять и попробовать очередь вот хорошо я вас убедил вы до этого не пробовали очереди что довольно странно решили попробовать вы можете попробовать облачные решения на сегодняшний день очень много различных облаков и вы можете взять амазона всплески исмаил ручной sq с яндекса воскрес в общем иск весов очень много иск весит a simple пью протокол простая реализация которая позволяет пользоваться облаком как очередью то есть точнее очередью в облаке помимо облачных решений существуют специализированные брокеры то есть те продукты которые вот как есть базы данных для хранения данных и есть брокеры для очередей то есть они были изначально придуман и чтобы быть очереди наверное самый популярный продукт здесь это ребятенка также я хочу отметить кафку есть много разных других продуктов которые можно для этих задач использовать в конце концов если вам не нравится что-то готовое или вы хотите какой-то кастом вы можете взять базу данных и с ее помощью приготовить очередь на этом пути есть много подводных камней поэтому тут нужно подходить с умом понимать что вы делаете но тем не менее если посмотреть в устройство очереди то можно увидеть что там очень много подходов которые похожи на базу данных ну и есть еще класс очередей которые очень часто называют сокетами на стероидах первым был за рамки а позже появился над который вырос в общем-то в полноценный брокер но изначально это были сокеты на стероидах они ничего не хранят они просто дают некоторый интерфейс взаимодействия то есть с точки зрения там одного узла он может поближе сообщение с точки зрения другого узла он может скрываться на сообщение но это просто небольшая настройка над сокетами значит давайте пройдемся по кандидатам которые стоят на сегодняшний день рассматривать если вы хотите воспользоваться очередные apache кафка популярный продукт на сегодняшний день вот они конкурируют с ребятам очень часто то есть можно вот если вы слышите про очереди вы услышать либо про кафку либо про rabbit кафка это распределенный лог-сообщение то есть основное назначение этой очереди для стриминга второе место это ребятенка это традиционный брокер очередей с поддержкой протокола mtp и он очень часто используется на третьем месте облаках облаков много если вес или облачные мкпп если вы уже размещены в облаке вам будет проще всего подключить именно облачную очередь еще я хочу упомянуть над довольно молодой про проект который скажем так вырос из сокетов на стероидах сначала без всякой persistent настей рассчитаны на масштабирование это хороший инструмент для соединения микро сервисов между собой когда вы побили свой монолит которую я надеюсь вы не вы его не писали вы сразу его заранее разбили вы можете воспользоваться натсом для коммуникации между узлами ну и конечно же я не могу не упомянуть тарантул я очень люблю делать очереди на таран туле тарантул дает возможность создавать абсолютно любые продукты поверх данных в частности очереди то есть все очереди которые я использовал за последние несколько лет были на tarantul и потому что это удобно да это требует некоторого вложения времени то есть мне нужно было реализовать зато я получал ровно ту очередь которая мне была нужна и так пройдемся по конкурентам между собой apache кафка реплицирует некоторый log то есть а на пирсе стид сообщения на диск мы организуем messaging по принципу publish субскрайб эти сообщения записываются в один лак кафка рассчитана на то что этот лук может быть повторно проигран и этот лог не может быть изменен то есть в отличие от классических брокеров лог кафки неизменен то есть если вы записали сообщение в каком-то порядке они не могут поменяться отсюда у нас появляется строгая упорядоченность кафка дизайне лась на ограниченное количество консилеров то есть на одном логе то есть на 1 партиций может быть строго 1 концу мир из одной консьюмер группы в противовес очередям сообщения могут перри проигрываться то есть если вы там вашей системе что-то испортили то есть какая-то часть сообщений было обработано некорректно вы можете перемотать этот logo проиграть его заново после обработки сообщений не удаляются кафка прекрасно интегрируется со всей к системой apache и очень часто используется для анализа данных для процессинга для передачи для репликации то есть и собственно мне кажется именно кафка породила по термин стриминга в кафки сложно делать традиционное для обычных брокеров очередей истории типа роутинга у нее довольно сложная архитектура то есть ее просто так на одном узле долго поднимать ей нужен пер но при этом оно хорошо горизонтально масштабируется она дизайне лась именно для этого rabbit создавался как брокер очередей с протоколом mtp с подходами мкп то есть позже к нему были прикручены альтернативные механизмы такие как include отеле столб это такие более древние протоколы или более привязанные к железу в ней есть очень много всего то есть в ней есть приоритеты в ней можно создавать athlon ii отложенные сообщения то есть фоновые то есть можно взять задачу отложить ее обратно чего нельзя сделать в кафки в ней нет к ограничение на количество потребителей то есть к одной очереди вы можете подключить любое количество потребителей и они будут быстрее разгребать эти сообщения в кафки не так rabbit умеет хранить данные в памяти и на диске может реплицировать данные может даже и спа называть коварную очередь использовать кворум для сохранения сообщений ребят довольно простой в освоении то есть я думаю вы с легкостью его поднимите но у него есть нюансы он довольно сложный в настройки отказоустойчивых сценариев то есть если у вас есть необходимость настроить очень надежно гарантированное хранилище вы задал боитесь то есть нет вы справитесь с этим можно справиться но в целом rabbit сложный когда вам нужна надежная распределенная система сценарии это традиционный попса брокер то есть он часто используется в качестве слоя шины данных между разными микро сервисами если говорить про облака здесь провайдер облака берет на себя все задачи то есть оно полностью менеджер вам не нужно ничего поднимать ничего настраивать ничего мониторить это все делает за вас облака то есть вы просто туда кладете сообщения если вам нужно больше вы просто платите за это больше она очень хорошо подходит когда у вас малое количество сообщений потому что вам не нужно ставить лишние сервера вы платите за очень малое количество у и squares стандартизованной а api вы не привязывайтесь какому-то конкретному брокеру то есть сегодня вы можете работать на амазоне завтра вы можете работать в мое ружье нам облаке послезавтра в яндекса вам и потом обратно это хорошее связующее звено если вы пользуетесь с облачными сервисами такими как из 3 или лямда то есть там вам иногда бывает нужно куда-то кинуть сообщение там из одной системы в другую то есть и вот там используется и squares нас изначально родился как система для передачи сообщений его целью была высокая производительность и практически линейная масштабируемость он был заточен под любые сценарии и под саб и путей и request response но впоследствии на нем появился движок стриминговый jet stream в котором есть уже и потоковая обработка и надежное хранение и рафтов и кластер то есть в целом нас вырос в довольно таки хороший брокер сообщений в целом используется для распределенных систем в качестве шины между микро сервисами написан на коленке тепло это довольно просто в целом вполне можно рекомендовать ну и тарантул в нем есть готовый брокер который можно просто взять поставите использовать в tarantul и есть интеграция с различными стриминга выми очередями то есть тарантул можно например подключить кафки strand или есть модули для построения собственной хачериди если вам нужен кастом то есть если вы смотрите на сценарии они вам не подходят они вас не устраивают вы можете спокойно взять тарантул и написать свою собственную очередь с кастомным процессингом с кастомными приоритетами с любыми с любыми зависимостями в рамках одного брокера то есть одного узла исполнения у нас есть транзакционных например если мы возьмем кафку в кафки нельзя взять из одной очереди закинуть в другую то есть если у нас внешний консьюмер в tarantul и мы можем объединить это в одну транзакцию поскольку внутри вот там на глубоком уровне он хорошая транзакционные база данных с огромной репликацией когда его можно использовать когда вы готовы разобраться в том как работает ваша очередь когда вам нужен производительный брокер в целом мы тестировали пропускную способность различных брокеров и на таран туле нам удавалось развить самую большую скорость несмотря на то что лидером в данном вопросе является на сегодняшний день кафка тем не менее на таран туле можно больше но для этого нужно приложить некоторые усилия ну и в целом если мы хотим что-то большое и сложное значит мы рассмотрели основных скажем так конкурентов давайте посмотрим на очереди а какие вообще сочи людьми проблемы но взяли поставили работает почему нет здесь есть целый спектр проблем эти проблемы многослойные впервые слой проблем это алгоритмы даже когда все работает ничего не ломается в алгоритмы очереди может быть заложена очень много хорошего или плохого во первых очереди бывают тифа как я уже говорил строгая упорядоченность сообщений бывает ли for last in first out это стык по сути встречается крайне редко но тем не менее может быть нужно для каких-то задач чаще всего встречается очередь которую там так или иначе называют best of art она в основном фифа но иногда когда например у нас происходит отказ какого-нибудь концу мира который уже взял сообщение сообщение возвращается обратно и они перри упорядочиваются для большинства задач это подходит то есть это нормально и скажем так это позволяет сочи ридми работать намного проще то есть если вдруг у вас какой-то концу мир в обработке задачи залив или там она выполняется долго он не тормозит вам остальную очередь дальше в очередях бывает нужно приоритезация то есть например в той же кафки приоритизации нет потому что ее не может быть каждое сообщение дописывается в конец топика то есть вы не можете скажем так прислать сообщение которое не ляжет в конец топика или как-то их между собой перри упорядочивать вот они как пришли так они и будут лежать иногда бывает нужно в рамках большой системы организовать огромное количество маленьких очередей например по одной очереди на одного клиента дальше повтор отложенные задачи различные ретро и задержки то есть если это полноценный брокер у вас это все будет если это у вас брокер на заточена на streaming у вас будет проблема с тем чтобы заводь повтор то есть повтор можно реализовать но вы на самом деле задачу вы мити из очереди и положите ее заново для того чтобы организовывать повтор или постобработку используется так называемая diddley торчу в целом это инструмент который появился из-за того что в некоторых брокеров нельзя вернуть задачу обратно то есть нельзя ее положить это такой механизм который позволяет куда-нибудь откладывать задачи которые мы не обработали еще бывают созависимые задачи еще бывают проблемы с временем то есть тайм ту лив time to release footbag то есть если кто то взял задачу то через какое-то время мы можем посчитать что этот кто-то этот конец умер умер и мы возвращаем задачу обратно из всех этих алгоритмических вещей вылезают еще очередные проблемы то есть если у нас есть приоритезация то у нас возможно например голодание допустим есть два потока сообщений одни с высоким приоритетом другие с низким если поток сообщений с высоким приоритетом достаточно чтобы загрузить концу миром то задачи с низким приоритетом могут вообще никогда не добраться до консьюмер а то есть у нас будет голодание у нас может быть ограничено очередь по пропускной способности то есть в принципе система за дизайне на так что у нее есть узкое место которое никак не масштабируется конечно же алгоритм может влиять на перфоманс то есть если у нас там условно говоря линейная запись на диск это один перс если у нас рандомно доступ к диску это другой перф очередь должна учитывать или не учитывать возможности масштабирования то есть если это сингл узел возможность репликацией у него нет никакого горизонтального масштабирования если вы стукнете ся потолок у вас будут проблемы любая очередь ограничено просто потому что наш физический мир ограничен у нас нет бесконечных хранились бесконечной памяти бесконечного диска поэтому нужно всегда смотреть как очередь себя ведет как да она заканчивается еще алгоритм может учитывать такую вещь как сохранность сообщений но это скорее больше темы для old эджа даже когда все работает у очередей есть одна очевидная проблема то есть очереди изначально придумывались вот на уровне железо на уровне софта когда никаких потерь нет когда вот процесс работает и внутри этого процесса что-то происходит мы сообщение достали сообщение положили случае сети у нас есть он defined by heather то есть мы отправили пакет и мы не знаем этот пакет дошел и его там получили или этот пакет потерялся то есть это классическая проблема двух генералов то есть если кто то не знает оно состоит в том давайте так кто не знает проблемы двух генералов значит суть в том есть две части одной армии между ними есть вражеская территория генералы должны договориться им нужно одновременно атаковать или одновременно не атаковать если кто-то один нападет а другой не нападет эта армия проиграет что они могут делать они могут посылать сообщения друг другу то есть гонцов и это проблема не имеет алгоритмического решение сколько раз мы бы не пытались один генерал отправляет гонца ему нужно подтверждение с той стороны что этот гонец дошел но гонец подтверждением тоже может потеряться его могут перехватить то есть можно отправить десяток гонцов то есть можно увеличивать как бы этот поток но стопроцентной гарантии что вот они договорились не существует в целом можно сказать что в распределенных системах есть две сложные проблемы это строгий порядок сообщений и доставка строго один раз вот доставка строго один раз как раз является частным случаем вот этой проблемы двух генералов до недавнего времени вот несмотря на весь опыт я считал что exactly one или доставки строго один раз не существует просто потому что она невозможна в нашем физическом мире но я столкнулся с системой в которой и где клеманс был реализован есть одна система из нее поступают сообщения есть консьюмер который как-то коммуницирует с другой стороной и вот задача в том чтобы сообщение было обработано строго один раз что происходит если возникает неопределенность например мы сообщения отправили и непонятно оно дошло или не дошло или соединение порвалась это сообщение кладется в так называемую digit.ru вот для этих сообщений которые лежат в две дырки нужно принять решение для этого нужно уметь посмотреть вот в ту удаленную систему и решение оказалось очень простым человек человек который сидит смотрит в эту очередь который разгребает эти сообщения которые может скажем так посмотреть в одну систему в другую в логе позвонить на ту сторону то есть человек это своего рода божественная сущность вот если у нас есть эти два генерала вот для них вот мир он там плоские они между собой общаются есть кто-то кто находится над ними кто видит что происходит и может принять решение так вы двое договорились все вы нападаете в исходном решение системы такое не предусмотрено но в реальности когда нам это очень нужно мы можем прибегнуть к такому подходу пойдем дальше помимо сети у нас есть еще диск и сеть и диск влияют на производительность это пропускная способность сколько сообщений может проходить через очередь и это задержка в работе в зависимости от того что используется у нас может она быть предсказуемая или непредсказуемая ну и напоследок мы приходим к ситуации когда у нас что-то не работает то есть все те кейсы были для системы которая работает работает штатно в ней ничего не сломалось но на самом деле у нас бывают поломки поломки бывают временные бывают постоянные вообще если спросить кого-нибудь что ты сделаешь для того чтобы обеспечить сохранность исаак сохранность сообщения сохранность базы данных можно очень часто услышать поставлю rate но на самом деле это спасает только от одного самого нижнего случая когда у нас вылетает один диск но у нас может вылететь целый host лично на моей практике был сценарий когда машина с шестнадцатью дисками получила разряд посетим блок питания и не защитил сгорели все кроме двух дисков то есть под просто напрочь то есть даже если бы там был рейд rate бы не спас то есть машина может выгореть целиком целиком может выгореть даже дата-центр то есть вот всегда нужно планировать масштаб отказа что отказать может даже дата-центр отказы бывают временные например у нас пропала питания у нас порвалась сети и там переехали каким-то экскаватором это приводит например то есть если порвала сеть приводит к сплит брейна две разные части системы одновременно живые но они об этом не знают они не могут даже корица и отказ бывает постоянный это физическое уничтожение то есть это сгоревший диска это сгоревший сервер это сгоревший дата-центр в принципе считается что дата-центр ну не должен сгореть но иногда они горят значит отказы влияют на две основные метрики в нашей системе это доступность и надежность доступность это возможность сохранить систему сообщения то есть доступность важно для продюсера надежность это то что если мы сообщили кому-нибудь что мы сообщения сохранили но мы не должны его после этого потерять то есть мы гарантируем что мы сообщения обработали и мы его доставим давайте рассмотрим разные паттерн и вот как можно организовать надежность и доступность в распределенной среде если у нас есть брокер очередей самый простой подход самый простой самый наивный к сожалению чаще всего использующийся мы просто берем один брокер ставим ему говорим вот это у нас очередь у нас распределенная система у нас вот здесь продюсеры вот здесь консьюмер и все хорошо у этой системы есть куча проблем во первых у нее нет масштабируемости когда брокер закончится все ваша система перестанет принимать сообщения во вторых у этой системой довольно низкая доступности низкая надежность потому что если эта штука сломается вот совсем вы потеряете сообщение которое вы туда сложили даже если оно сломается временном там не знаю сервер в ребут ушел у вас низкая доступность вы не можете туда положить сообщение поэтому эту систему можно очень просто за апгрейдить то есть можно поставить несколько очередей и класть в любую из доступных у этой системы показатели намного лучше во-первых у нее высокая доступность если одна из очередей умерла у вас есть еще много других то есть вы можете варьировать эта система масштабируема то есть поскольку вы можете ставить столько очередей сколько вам нужно то есть это своего рода ручной sharding но у этой проблемы есть серьезный недостаток то сообщение которое вы положили в очередь принадлежит только этой одной очереди если эту машину уничтожить вместе с данными вы теряете данные поэтому гарантии этой системы все еще потенциально x меньше единицы то есть где мы сообщение можем не доставить проблемы можно решить несколькими способами например мы можем класть несколько очередей то есть просто дублировать в тупую в этом случае у нас получается высокая доступность высокая надежность но кто-то из очередей то это сообщение довезет у нас нормальная масштабируемость то есть мы можем ставить н очередей и класть в к из них то есть к можно выбрать зависимости от того сколько мы хотим н в зависимости от того сколько нам нужно здесь не очень удобно с доставкой сообщений потому что каждое сообщение будет доставляться в среднем к 1 и соответственно нужно делать либо и дым патентные сообщение либо что-нибудь как-то проверять что мы это сообщение уже применяли мы можем уйти в сторону и подумать о какие еще у нас системы страдают от подобных проблем вообще базы данных и мы можем воспользоваться подходами баз данных для того чтобы решить эту проблему можем воспользоваться репликацией мы берем лидер и лидера и говорим что мы будем работать с точки зрения продюсера с точки зрения концу мира только с лидером реплики находятся в стендбай они ждут если лидер пропадет они готовы принять на себя роль нового лидера и продолжит работу если мы вместо каждой из вот этой одиночных очередей поставим рипли кассеты мы придем к весьма неплохой системе то есть у нас будет хорошая масштабируемость ставим больше реплик ассетов получаем пропускную способность у нас весьма неплохие гарантии вот в такой системе execution одной задаче будет стремиться к единице то есть он никогда не упадет меньше единицы иногда случае обрывов соединений он может превысить единицу но в данной системе она будет около единицы ну и поскольку мы уже заговорили про базы данных мы можем взять к вор умные базы данных в принципе все то же самое только за выборы у нас отвечает не классическая репликация aqua ровная репликация кворум защищает нас от потери данных то есть если мы прислали сообщение кворум его подтвердил то в общем она у нас надежно сохранилась кворум гарантирует довольно высокую консистентной нос кворум ными подходами у нас будет пониженная пропускная способность потому что узлу нужно будет обязательно подтвердить это сообщение иногда допускается вот такая ошибка то есть кто-нибудь берет хлор умный брокер ставит одну штуковину и такой вот у меня кластерная система она клёвая надежная она будет работать нет когда эту систему 1 parte циане рует то допустим у вас 2-го label эти зоны 2 дата-центра вырасти ну liquor умный механизм на несколько дата-центров вы получите пониженную доступность то есть у вас в той части где не хватило узлов которые оказались в меньшинстве вы не сможете производить сообщение вы не сможете их класть поэтому случае портишь энинга ваша система проседает по доступности и скажем так вы испытываете проблемы также у этой системы есть проблема с масштабируемостью здесь нет ничего для линейной масштабируемости то есть у вас сообщение процессе один лидер реплики эти сообщения у себя держат подтверждают но здесь нет масштабируемости поэтому вспоминаем как мы делали с реплицировали my очередями то есть какой у нас был хороший подход и меняем здесь просто подход базы данных с обычной репликации на коварную репликацию получаем те же показатели это надежная очередь с хорошей масштабируемостью с высокой доступностью с высокими гарантиями если у нас более одного кворума нам нужно его грамотно распределить то есть нельзя просто как бы поставить абы как то есть мы должны рассмотреть ситуацию что если у нас есть древо label эти зоны то мы должны распределить узлы таким образом чтобы кворум одного кластера был в одной availability зла не кворум другого кластеров другое ла ла билете зоне при коммуникации с очередным есть два подхода вот в принципе там можно крутить эти протоколы там с одной стороны с другой но по сути все сводится к двум подходом задача привязывается к соединению или задача не привязывается к соединению то есть соединение не имеет состояние если задача трека ица в соединении мы имеем кучу профита то есть в случае если соединение порвалась мы можем тут же задачу вернуть обратно на обработку но у него есть и минусы мы не можем эту систему легко масштабировать потому что нам нужно чтобы клиенты консьюмер и непосредственно работали с самим узлом очереди в противовес системы без постоянного соединения довольно легко масштабировать то есть мы все прекрасно знаем как масштабировать хоть и т.п. мы можем воспользоваться классической хотите пышной балансировкой типичной балансировкой но у этой системы обязательно нужно делать автовозврата сообщения потому что если кто-то придет через соединение без состояния скажет я взял задачу задача зарезервировались за каким-то концу миром и все он упал и он больше не вернется и вообще его больше не существует вот эта задача залипнет навсегда если не сделать авто возврат в системах типа с авто возврат сделан автоматически потому что без этого никуда ну и на последок про что ещё нужно подумать то есть если мы вводим себе в эксплуатацию какую-то новую систему нужно понимать как ее правильно мониторить основной показатель который нужно мониторить на очереди это размер очереди поскольку я говорил любая очередь лимитировано даже если вы не выставили ей лимиты она все равно лимитировано и нормальное состояние очереди это пустое вы присылаете сообщение вы эти сообщения должны разгребать если очередь начала расти значит в вашей системе что-то пошло не так поэтому это первый показатель который нужно мониторить второй показатель это время она вам пригодится тогда когда ваша очередь начнет расти можно измерять полную обработку сообщения от момента когда вы положили до момента когда вы обработали и можно считать отдельно время консьюмер а то есть концу мир взял сообщение концу мир вернул сообщение что он его обработал в разных ситуациях в зависимости от внешних факторов или от внутренних факторов вот это время покажет вам где у вас проблема также поскольку и размер очереди и время это показатель моментальные то есть вы пришли посмотрели очередь пустая через некоторое время еще пришли посмотрели очередь пустая но при этом через эту очередь за единицу времени могло пройти 1000 сообщений или 10000 в этом случае вы как бы в какой-то момент обнаружите что ой у нас очередь начала расти а почему она начала расти не понятно поэтому нужно еще обязательно мониторить такие проблемные вещи как количество повторов потерь отказов и поток сообщений то есть в этом случае вы будете понимать что с вашей очередью происходит помимо критичных показателей ну и такой совет планируете сообщение вот там где вы кладете сообщения в очередь если вы можете его залакировать но за лагер уйти но будет немножко лишних логов но случае если у вас произойдет аварию если вы что-то потеряете лучше доставать игре падь сообщения из логов чем обнаружить себя в ситуации что сообщений нет ну и обязательно планируете отказ система упадет обязательно упадет от вас зависит как именно она упадет и как именно вы будете подниматься можно переставать принимать новые сообщения если все если все сообщения важны переставайте принимать новые если вдруг старые сообщения не важны можете начать уничтожать старые но принимать новые иногда бывают сценарии что в вашей очереди часть сообщений еще живая часть уже совсем старая то есть для них прошёл какой-то дедлайн можно обрабатывать те которые еще живы и и для них выполнять задачу а потом уже вернуться к тем которые все равно уже провалились для чего нужно планировать падение для того чтобы подняться после того как ваша система упадет если вы не знаете как ваша система падает и как поднимается вы можете свою систему не поднять есть изречение конфуция что велик тот кто поднимался после того как падал то есть поэтому очень важно знать как ваша система будет подниматься давайте подытожим какие у нас есть варианты и что нам брать вот вам нужно очередь если вы хотите толерантность сервиса точнее если у вас есть толерантность к потере сообщений то есть вы можете терять сообщение ничего страшного если одно-два на там миллион потеряется вам нужно организовать передачу сообщений между сервисами вам нужна высокая пропускная способность и масштабируемость возьмите нас это хорошая система она хорошо себя показывает можно взять еще какой-нибудь и носки у который похуже можно взять за рамки который вообще ничего не pure system но вот здесь мне больше всего нравятся над он простой он хороший он развивается плюс у него есть эволюционная . для persistent а если вы хотите быстро попробовать вот услышали прониклись решили попробовать очереди если вы находитесь в облаке если у вас там микро сервисы кубер нить из вот это все возьмите облачную же очередь возьмите спс от любого провайдера в котором вы поститесь возьмите с если даже вам хочется mtp и вы считаете что вот только ребят есть облачные решения для mtb например клауда mtp облачный ребят но и в целом можно попробовать простые брокеры то есть для того чтобы пощупать эти самые очереди rabbit над но обязательно смотрите на то как ваша система настроена тут все то что я рассказывал то есть если вы этот узел потеряете вы потеряете сообщение или нет смотрите за настройками если вам нужен streaming то есть у вас есть поток сообщений там вы его хотите обрабатывать перекладывать в биг дату если вам нужна высокая сохранность ваших сообщений и или например требуется строгий фифа это apache кафка кафка было за дизайне на под этот подход у нее есть различные подходы к организации обработки сообщений перри проигрыванию поэтому кафка здесь вне конкуренции также можно взять jet stream от нас или можно взять тарантул энтерпрайз там тоже есть механизмы для потоковой архитектуры если у вас сложные сценарии если вы хотите очередь в очередь сообщения класть а потом отложить а потом взять и вернуть или если вы хотите настроить сложный pipeline что у вас сообщение входят разделяются потом сливаются и вы хотите делать что-то сложное странная если попроще это ребятенка если по сложнее у вас есть тарантул кью или возможность при помощи тарантула построить любую произвольную конфигурацию очереди у меня все спасибо за внимание учитывая время да я понимаю мы в овертайме вопросы все там мистер андерса спасибо большое к честь стоять рядом с тобой спасибо что открыл эту конференцию ребята еще можно поблагодарить громко тебе сертификат что ты прошел прошел испытательный срок и обучение нейрохирурга да вот специально открывшийся вида да наша тебе благодарность друзья мы отправляем владимира в электронные кулуары соответственно книжку подарим там и быть электронный culoare можно пойти вместе с ним мы увидимся здесь ровно через шесть минут в 1120 будет продолжение главного зала хорошего всем дня облака pop потом попадали с тех токс с баду и ровно через десять минут выступления следующего спикера погнали ну привет я артем я бывший редактор хабре сейчас ведущий подкаста мы обречены рад познакомиться привет я саша я тебе в команде бабу занимаюсь processing данных наша задача взять всю всю всю статистику доставить ее но мест где у нас есть потребители ты говорил что-то про культуру кода в чем ваша особенность что такое используйте культура конор в моем случае я имел ввиду именно подход я приверженец теории что не бывает ни возможных решений не бывает ни не интересных решений во втором этом можно найти какую-то составляющую которая понравится либо конкретно тебе либо в целом команде и на этом драме можно делать безумные вещи выстраивать безумные системы которые будут потом удивлять весь мир если о них рассказывал и скучно не будет никогда важно это просто понимать если идти с этой тенденции с этой этим пониманием давить людей то использованием этого все можно построить прямо гигантскую интересную систему расскажут что-то конкретно что-то между под этим безумен под безумными не скучно вершина без проблем одна из систем которые мы делали это аномалии то также система поиска аномалий на графиках тем они не новая но мы ее решили для в универсальном видят для миллионов графиков это собственно и будет темой моего доклада я буду рассказывать именно о том как какие запросы мы боль не о самой системе а ее подходят мы ведь очень много веселились со всякими научными статьями с поиском информации у нас не было изначально там большого опыта построения подобных систем но мы взяли cliff house мы взяли и реализовали на чистым пихал со стамбульской не численно кирха у нас на этом используем реализовали модели предсказаний воткнули туда сотни миллионов графиков и она считается процессе ца с минимальным шагом в 10 минут и это все еще при этом не на самых больших страх окей проект расскажу подробнее там слушать кузов еще такую ты берешь в себе такую силу для такого подхода ну просто люди когда начинают чем дольше работать в индустрии тема не давайте возьмем приняты давайте будем делать так как надо не давайте не будем лезть за пределы того что за что обычно не лают на тип откуда взять себе drive чтобы делать реально не скучные безумные постоянно придумать изобретать но здесь есть такая знаешь фраза он даиш то есть когда ты находишься на самом краю индустрии это не какое-то физическое положение что вот я проработал 20 лет теперь я могу ступить первые ряды и начать драйве нет это не так происходит так как тогда когда ты начинаешь падать на индастри лавал структур киты делаешь работу ты ее сделал поставил галочку для зимы что я умею это делать или рассказал об этом какой-то доклад до что нового изобретена что нового продвину как продвинулась инфраструктура в синтез индустрия в целом если ты просто сделал то же самое что делали другие ведь намного интереснее погрузиться во внутрь какой-то новой вещи взять что-то новое как-то по-другому повернуть под новым ракурсом сделать какие-то новые выводы используют те же самые инфраструктурные вещи о которых говорят там очень многие но повернуть и под таким углом под которым никто еще не поворачивал увидит что это работает может быть немножечко где-то подкаст и не без этого но результате добиться того что никто никогда не делал и благодаря тебе благодаря тому что ты привнес и рассказал о чем ты сподвигло у кого-то двинул двинуться дальше расширить горизонты своего восприятия мира но сейчас узнаешь как думают что особенно чем больше работал чем больше изучают вещей таки да все уже изобретено и все что изобретена довольно тривиально и придумано не лучшим способом да и особый улучшать никуда давайте просто этим пользоваться и не собственно можно так сказать но если взорвать возьмём ситуацию десятилетней давности начала десятых годов тогда тоже так все говорили но тогда не было кли хауса не было кафки не было куча языков которые сейчас используются повсеместно да тогда уже тоже было все изобретено но это не так мы двигаемся мы развиваемся и когда-то в древние века люди считали компьютеры что необходимо я не помню точную фразу что по-моему 2 мегабайта оперативной памяти будет достаточно всех и люди в это верили в rose ваша вера если вы не будете подвергать свою веру сомнением не будете критически мыслить а действительно ли все изобретено а действительно ли нельзя эту конкретную тузу улучшить или как-то повернуть неизвестным углом таким образом чтобы она начала приносить пользу еще где-то без этого да можно действительно сказать что все изобретено сложить лапки просто начать это использовать а можно попытаться но что сейчас думаешь про индустрию вот сейчас ты ее видишь что тебе мне кажется где надо изобретать где как слабые места чтобы ты стал понять вот даже в тех подходах который вы построили той системе который вы построили где те решения где тебе приходится идти на компромиссы такой блин здесь не круто надо здесь сделать круче вот этого не хватает этого не хватает да я понял вопрос на самом деле это абсолютно нетривиальный вопрос можно выстраивать что-то новое во всех сферах и очень многие это делают тот же самый house продолжает развиваться и они решают основную нашу боль а если уже не решили честно не могу точно сказать это звуки к примеру за кибер им боль у всех наших последний бой к нам приходил оон киллер за звуки первым так вот потому что он немножечко разросся в памяти всего лишь 16 гигабайтами каждую систему невозможно сделать совершенно нету совершать это только цели к нему к ней можно стремиться да мы сделали мы процессе миллиона графиков но мы это не делаем бесплатно мы это делаем за счет конкретно известных там ресурсов которые мы на это тратим есть узкие места которые для нас являются проблемы тоже за мысом языке про для нас эта проблема невозможно постоянно горизонтально масштабироваться соответственно рано или поздно придется дальше разве хоть эту штуку чтобы оно было быстрее и эффективнее поэтому нет абсолютно во всех сферах есть куда расти только для того чтобы это сделать необходимо обладать знанием и опытом в этой сфере конкретно в нашем случае да мы очень не хотим избавиться в руки перо у нас практически к любой сфере при так или иначе последова на привязан и он доставляет большую часть проблем вы уже пытались пока нет но вот хотя бы к этот об этом думаешь как ты думаешь какую сторону здесь улиц как избавляться я думаю именно менять собственное решение решение которые были сделаны у нас таким образом чтобы и покрыть задачу и меньше учитывать за кипы поскольку он нужен нам о последованном нас нет задачи сделать его идеальным то есть нас нет задачи на него тратить ресурсы у нас есть задача именно нашу проблему решить а ее можно решить в том числе к примеру уменьшив нагрузку на за кипр предыдущую идею которое мы реализовывали она это не учитывал будущее будет когда вы строили вот система которая рассказывала у вас были какие-то камни преткновения из-за чего то вы спорили чтобы у сложное всего проблем не да наверное вот лично для меня это было проблема ранжирование аномалий то есть вот я говорю конкретно про она любит а также систему которую мы сделали для чего нужно объяснить проблему комбинаторного взрыва у нас есть примеру там график с параметрами нас есть страна оператор пользователь там и еще с десяток разных параметров каждый из них если примеру 10 параметров каждой из них по 100 то мы получаем 10 в 20 комбинацией параметров и каждый из них может потенциально обладать цифры это безумные объемы и с этим как бы ну никто работать не будет но как при условии то чтобы примеру определяете 99,9 процентов всех значений а то есть три девятки это вас немножечко нем много мало но 10 в семнадцатой аномалий и вот как как найти среди них она малюта естественно мне сложно полтора процента вверх и вы визуально даже ну да скок ну ладно но это будет самая большая аномалия за счет того что цифра само по себе больше нежели так дела у вас какой-нибудь стране количество пользователь упала в половину там это катастрофа поэтому она ну ладно муки будем жить дальше и вот именно эту проблему я пытался решить это было две недели когда я просто сидел с гигантским объёмом данных и просто вписал запрос разными вариантами разными случае вытаскивал какие-то дополнительные параметры метрики из данных для того чтобы хоть как-то вытащить ну и вкратце примерно как что было за решением я получил коэффициент немножечко в попугаях но коэффициент который говорил о разглядит графика в предсказании графика реальных значений использую его из используя нормализацию на общий вес графика отношения его числа к общей сумме всех графиков внутри там какого-то reporto и еще нескольких других коэффициентов я получил более менее функцию которая не позволит выдать цифру по которой могу сортировать эта цифра мне уже сделала что график с большим разлет am график у вас с большей аномалий визуально именно визуальный будет выше чем график с меньшим визуальным размер успехов вам в работе над этим до строить систему изобретаете всему большим надеюсь вы избавите suzuki пера и сделать это отличное других научить и тоже будем посмотреть отлично спасибо ребятам за этот разговор у нас будут такие включения с вами все дни все несли все вот эти два дня как как когда мы празднуем на к наконец-то highload живьём я вам тоже буду напоминать о том кто наши партнеры и сейчас поподробнее поговорим про i can pay когда уже не выйдет на сцену обращу ваше внимание на нашего золотого партнера это рсхб in тех россельхозбанк инженеры и разработчики собрались для того чтобы внедрять банковские продукты и агротехнологии и об этом можете поговорить с ними на их стенде а на эту сцену я приглашаю как энергично взбегает евгений и кузовлев под ваши бурные человек который уже десять лет 0 разрабатывает сложные системы и сейчас уже поборол волнения и готовится рассказывать про серебряную пулю геоданных готовьте вопросы сразу после выступления знаешь к настоящему не совсем поборол волнения все-таки перерыв в полтора года она вот несет в себе такое его знаешь полтора года не была живой аудиторией волнение присутствует серьезно тебе говорю у нас у всех был одноклассник который за время рассказать стихотворение откручивал пуговицу от пиджака но у тебя нет пуговицы ты то чтобы уж подкручивать clicker мне надеюсь у вас есть запасной водички дайте отлично ну погнали да привет начнём с простого кто мы такие почему я здесь о чем мы сегодня будем говорить и вообще какой я имею моральное право вам чего-то рассказывать и компы это международный финте холдинг который отвечает за то чтобы максимально безболезнено принимать деньги у населения мы процессе им достаточно большое количество транзакций в день краеугольным камнем ganas является надежность и один из показателей который позволил нам нашу надежность поднять это количество площадок которых на которых крутится нашей системы в итоге практически каждой нашей системы которые мы эксплуатируем является гиа распределенной еще хочешь сказать что мы вот такой хорошем смысле настоящий фильм тех что я в это вкладываю я вкладываю следующее понятие что практически каждую за крайне редким исключением систему которой которую мы эксплуатируем и который мы зарабатываем деньги мы написали сами это приводит к тому что у нас больше 50 процентов компании айтишников и об этом обо всем вот гиа распределенных системах том что потенциально giau распределенные системы могут повышать надежность мы поговорим зачастую как начинается история построения гиа распределенных систем вам приходит руководство ваш бизнес и говорит а давайте мы сейчас нашу систему поставим в 2 дата центра если у нас даже один из дата-центров откажет то у нас есть 2 но бизнес не понимает он не должен понимать какая сложность стоит за этим понимаете это вы и об этом собственно мы и поговорим вообще давайте разберем ответ на вопрос а зачем строить где у распределенные системы конечно ну самое первое это обеспечение надежности но это не единственная причина по которой вы можете построить и захотеть построить гиа распределенную систему кроме этого очевидно это может помочь приблизить ваши системы конечному пользователю для разного рода систем это может быть критически важно например если вы строите систему которая показывает рекламу на сайтах контекстную то для этой системы критически важна скорость ответа и в этом случае чем ближе вашей системы находится к конечному пользователю тем быстрее вы покажете нужную рекламу тем быстрее она загрузится поэтому очень важный показатель для определенного рода систем ну и не надо забывать что когда у вас есть несколько дата-центров то вы можете масштабировать нагрузку между этими дата-центр не между установками ваших систем и тем самым обрабатывать большие количества пользователей большее количество запросов и зарабатывать больше денег о чем конкретно мы сегодня будем говорить чтобы конкретизировать скажем так наш спич по очень абстрактная обширной теме по гео распределенным системам настоящего мы с вами будем говорить о правилах как не выстрелить себе в ногу о базовых правилах построения giau распределенных систем конкретно про две вещи мы сегодня будем разговаривать мы чуть-чуть поговорим в первой части нашего разговора про архитектуру дел распределенных систем и о том как данные связывать в разных установка как передавать и кроме этого во второй части мы с вами немножко поговорим про сеть про новые границы которые может открыть вам в сетевой составляющей построение гиа распределенных систем потому с чем вы можете столкнуться в рамках этого увлекательного процесса ну и кроме этого что вам готовят различные регуляторные органы очень кратенько если вы будете строить гиа распределенные системы в россии это носит свою изюминку у нас стране итак начнем архитектура да когда мы строим гиу распределенные системы первым вопросом которую мы задаёмся заключается следующем а как нам синхронизировать данные между да по центрами есть совершенно замечательная такая называется на теорема не совсем эта теорема принятого этично мере назвать теорема cup теорема кто про нее слышал практически весь зал это отлично это с теорема она формулирует три основных принципа надежность согласованности доступность из которых по факту гласит классическая интерпретация эта теорема очень утрированно что из трех можно выбрать только два по-настоящему это не совсем так там есть дополнительные отдельные рассуждению умных мужей о том что при определенных условиях мы можем выбрать все три но эти условия очень ограничены мы же рассмотрим очень примитивно этот вопрос и поговорим о вопросе синхронизации данных вопросе синхронизации данных у нас по-настоящему есть наверное три подхода первый подход это мы синхронизируем данные асинхронно то есть мы принимаем запрос в одном на одной площадке на другую площадку данными передаем после того как этот запрос обработали альтернатива этому id асинхронная обработка запросов когда мы данным принимаем на любой из площадок сохраняем по всему skype всех наших установок после этого возвращаем данный клиент в ответ на ваш запрос естественно этот две противоположные границы и обычно истина находится где-то посередине есть третий подход это гибридный подход когда часть данных на 8 хроне часть данных всем хроне записываем но для того чтобы разобраться какой подход хорош и какой по-хорошему надо бы использовать давайте начнем по порядку вот предположим мы хотим синхронизировать наши данные абсолютно синхронно обеспечивать полную консистентной наших данных для того чтобы понять хорошо это или плохо давайте посмотрим вот на такую картинку это картинка времени доступа стива влага от пользователя который находится примерно в москве примерно потому что сетевая топология она бывает иногда своеобразные вещи творит да вот конкретно наших точек присутствия в европе это несколько дата-центров которые расположены в различных европейских городах здесь мы видим что самая близкая . это там условно . присутствия хельсинки до нее из москвы сетевой лаг составляет примерно 40 миллисекунд если же мы строим систему которая будет синхронно сохранять данные то автоматически любой запрос у нас увеличится от 40 миллисекунд куда приходит запрос к ближайшей точки до 40 плюс какая-то дельта которая накладывается на то чтобы передать запрос между всеми дата-центре обычно это там ну вот в нашем случае если мы синхронно данные гоняем это примерно от 45 до 90 миллисекунд в зависимости от текущей задачи возникает сразу вопрос ну окей мы готовы этим пожертвовать а как это делать зачастую у вас у всех ваших системах есть какие-то классические реляционные базы данных вы хотите построить распределенную систему идете не знаю открываете google что делает разработчик сначала открывает google да и как построить распределенную систему если вы напишете в синхронной то вы можете найти вот такую прекрасную вещь которая называется галера кластере слышали про галер класс у кого есть галера кластер одна рука поднята две руки поднята прекрасно блага лера кластера в зале вот такое можно прочитать это соответственно копия информация с сайта который посвящен галера кластеру и если это прочитать то выглядит что это просто серебряная пуля ну вот просто берём ставим и все круто у нас все сразу из коробки консистентная надежность так подумали наш с вами коллеги из одной транснациональной корпорации у них было при площадке лондон далласа сингапур для понимания сетевая задержка между лондоном и сингапуром составляет примерно 130 миллисекунд между лондоном и далласом примерно 95 миллисекунд ребята у них было распределенная система они получили в итоге commit time на одну транзакцию полсекунды если что-то случалось приключение клиентами ним за 10 секунд они попробовали так работать 2 2 месяца и у них ничего не получилось они откатились обратно к режиму когда у них один дата-центр активной и два других находятся в режиме горячего такого полу горячего резерва получается что ребята все-таки не серебряную пулю дали из галера кластера нет она решение рабочая его можно использовать надо понимать какую она за собой несет логику и как эта логика ложится на ваше приложение ok предположим у нас три дата-центра которые в разных локациях принципиально разных получается что мы не можем использовать синхронную репликацию давайте посмотрим в сторону асинхронной репликации асинхронной репликации это классическая в mais quel если делать это классический асинхронный multimaster как и multimaster а мастер мастер прошу прощения когда каждый дата центр является словом для другого дата центра и они синхронно воспринимаем данный то же самое попыталась сделать еще другая уже эти компании наш с вами коллеги тоже у которых был 20 в москве и питере изначально питерский сот был резервный московский основной они сделали асинхронный multimaster поставили туда синхронную репликацию завершили внедрили они этот проект пятницу вечером до понедельника они отмечали успешное завершение проекта а где-то в понедельник кладет все эти подняли по тревоге почему а потому что у финансистов в двух финансовых проводках оказались разные данные если кто то не знает то финансисты готовы за это убить натуральном смысле слова потому что у них не может быть такого что в двух проводках может быть разные данные для них это подобно смерть в итоге за неделю все разобрали откатили и снова работают на одном активном судьи и одном неактивным получается странная история синхронная плохо асинхронная плохо чушь делать и вот чтобы понять что делать и как вообще жить и надо ли строить вообще гиа распределенные системы давайте рассмотрим пример из реальной жизни у нас стояла задача построить giau распределенный биллинг что такое беринг в нашем случае вот идет транзакция клиента например вы совершаете покупку в магазине то есть деньги от вас уходят в сторону магазина в этом смысле посередине мы стоим как эквайринг и мы условно живем на маленький маленький маленьким процентом ноль ноль ноль один процент обычную от этой транзакции но мы должны посчитать этот процент потому что он от каждой транзакции разные вот задача биллинга родов у нас много 5 соответственно надо обеспечить реализацию этого биллинга с простыми условиями взаимоисключающими должна быть максимальная скорость ответа и должен быть синхронный контроль баланс и условия вроде бы они взаимоисключающие тут можно сесть в уголок плакать но мы не стали плакать мы пошли немножко в глубь и посмотрели а какие же у нас есть типа транзакции биллинге от типов транзакцию словно есть 2 1 тип транзакции эта транзакция по инн это когда вы деньги платите в этом случае вы передаете деньги и они идут как бы клиенту клиенту юридическому лицу к нашему клиенту второй тип транзакции эта транзакция payout это например типичная транзакция когда вам на карту несколько раз месяц или 1 1 месяц падать зарплата то есть со счетов юридических лиц мы передаем деньги на счета физических лиц к примеру и посмотрев на эти два типа транзакции посмотрев на условия мы получили достаточно интересное наблюдение что не надо выполнять условия которые были изначально для всех типов транзакций а максимальную скорость ответа надо по-настоящему обеспечить только для пэйна для по его то как раз нужно синхронный контроль баланса сейчас объясню почему вот вы когда покупаете в магазине представьте себе что вы приложили карточкой к терминалу и на терминале слова обработка висит 5 минут вы нервничаете кассир тихо нажимает на кнопку рядом уже стоит охранник который готов достать что они там дубинкой тесак до такой такой нервозность потому что если у вас вот каждая транзакция будет проходить так то примерно через день задумаетесь о смене банка ну потому что ну не надо потому что вы привыкли приложили карточку и сразу же прошла транзакции поэтому здесь важна скорость но когда вы платите счет клиента он увеличивается всегда потому что у деньги от вас переходит клиенту там не нужно в принципе баланс контролировать настолько а вот по инн как раз и по я у транзакция когда со счета юридического лица идут в обратную сторону деньги там не принципиально скорость ведь когда вы например получаете зарплату вы даже не знаете в какой конкретный момент времени вы ее получите вы знаете что вы например получите 15 числа ого сколько в12 в 11 в час дня до мне принципиального знаете что вы ее получите в этот день но в этом случае вам надо контролировать нам надо контролировать баланс чтобы не дать уйти в минус счёту с которого происходит списание денежных средств получается интересная история что для одного тип транзакции есть одно требование для другого тип транзакции есть другой требует и родилось вот такая вот интересная структура на примере трех дата-центров мы разделили баланс на 3 часть то есть у каждого юридического лица его баланс поделен на три д на три части и каждая часть принадлежит своему да по центру и только конкретный дата-центр может ее изменять суммарный баланс каждого клиента состоит из трех балансов сумма балансов по всем дата-центром что это дает это дает следующее что когда нам надо изменить баланс на какой бы дата-центр к нам не пришел запрос мы в этом дата-центре локальный баланс и меняем если у нас локальный баланс увеличивается проблем нет вообще если у нас локальный баланс уменьшается то в рамках конкретного дата-центра мы просто контролируем уровень этого локального баланса для того чтобы он не ушел отрицательные значения если в локальном дата-центре не хватает денежных средств идет широковещательные сообщения с фразой амука займи мне пожалуйста происходит внутренний перевод с одного дата-центром другой и если денежных средств на всех дата-центрах отпадает для проведения транзакций мы эту транзакцию проводим к чему я это рассказывал и это рассказывал к тому что мы пришли в итоге к следующей архитектуре point транзакции происходит в асинхронном режиме то есть транзакция всегда придёт на один дата-центр а потом данные когда-нибудь по принципу увенчал консистенции доедут до других дата центров по я вот транзакции в большинстве своем приходит в асинхронном режиме если хватает локальных балансов а если локального баланса не хватает она происходит синхронном режиме с задержкой времени проведения транзакций потому что для по java транзакции это допустимо какой вывод из этого можно сделать из этого можно сделать вывод что архитектуру синхронизации данных между удаленными площадками стоит строить исходя из той модели из той архитектуры системы и тех бизнес требований которые у вас есть если же у вас архитектура системы не позволяет реализовать это то надо подумать об изменении архитектуру системы это первая часть марлезонского балета про синхронизацию данных но дальше поднимаемся выше является ли синхронизация данных единственной проблем следующей проблемой которая являет которые есть у нас а синхронизация это не единственная проблема это проблема роутинга очень просто когда у вас стоит ли системы когда вы работаете с одним запрос у вас нет проблемы роутинга к вам приходит запрос любой из доступных дата-центров любая с доступных площадок отправляет ответ и забывает про пользователь у вас нет проблемы роутинга но вот у кого-нибудь есть stateless системы а стоит full практически весь зал стоит фу то есть по факту у вас всегда у вас всегда стоит full system и в зависимости от того куда придет запрос пользователя у вас по-разному меняется поведение системы какие варианты роутинга есть для пользователя если вы строите распределенные системы базовые варианты которые вам предоставляет любая технологическая платформа или вы сами их можете построить они примерно следующее это либо распределение на основании параметров в цод нагрузка количество серверов в лс либо распределение на основании клиентских параметров айпи адрес браузер устройство что-нибудь еще либо распределение на основе какой-нибудь математической функции например каждого первого каждого второго отправляем налево каждого первого отправляем на право хорошо ли это но все эти варианты зачастую они не работают не работают тогда когда у вас во время взаимодействия с клиентом более чем один запрос если у вас более чем один запросто у вас регулярно может возникать вот такая ситуация у вас 2 до центра первый запрос пришел на один дата-центр 2 на другой там нет данных мэтт валились с ошибкой пользователя недоволен пользователю шел по факту получается что нас есть дополнительные условия роутинга дополнительные условия роутинга заключается в том что роутинг надо осуществлять когда-то с привязкой пользовательской сессии а когда-то без привязки пользовательской сессии как это сделать если у нас стандартные инструменты принципе есть но стандартные инструменты вот те которые реализуются в рамках стандартных механизмом механизмов они ведут к определенным ограничениям эти ограничения они достаточно просты и первое ограничение что если мы например рауте на основании внутренних параметров запросе клиента то этот параметр должен присутствовать в каждом запросе не знаю у вас должен быть идентификатор совершаемой операции в каждом запросе от клиента не каждая была такой может сделать если же мы роутинг осуществляем на основании каких-то параметров клиента например ай пи адрес это может привести к тому что вас routing пойдет с перекосом у вас появилось много пользователей за одной локации с одним а те печника мыле из одной подсети они все пойдут в один дата-центр кроме этого если выручите на основании пи адреса то если вы вводите или выводите какую-то площадку в строй в этот момент у вас карта перестраиваются и соответственно люди они будут перекинута на другую площадку вас не сохранится сессия вы получите ошибки есть еще один вариант которым пользуется например большинство банков если вы вы заходите в онлайн банк например того же сбербанка то вас с адреса онлайн . там сбербанк точка ру redirected на адрес достаточно хитрый ноды там 01 . сбербанк . что-нибудь такое и такой вот во многих вариантах то есть происходит redirect при первом обращении на адрес конкретной площадке но с этим есть та же проблема это работает для браузерных клиентов если у вас есть клиенты которые обращаются к вам попей то не всегда можно такого клиента redirect 0 потому что зачастую и нет на и сообщение по этой содержит post запрос a post запрос redirect для другого для другой машины к другой системы практически не представляется возможным то же самое те же самые проблематика с куками cookies вы можете выставить только клиенту чушь делать то чушь делать так по-настоящему выбирать в зависимости от того какие у вас ситуации если у вас только клиенты вот мы браузерные как например в онлайн-банкинга вы можете redirect совершенно спокойно конкретную площадку что сделали мой у нас и браузерной интеграции и опять интеграции у нас первичный пост get запрос и у нас не осталось иного выбора кроме как реализовать схему в которой в каждом запросе от пользователя есть одинаково идентификатор вернее для нас это пара уникальных идентификаторов это идентификатор проекта идентификатор клиента идентификатор платежа на основании этой пары мы определяем куда отправить запрос это все хорошо и она может работать в конкретном случае опять же какой здесь вывод что серебряной пули нет и мы это всё строим всегда исходя из того какие ваши системы но роутинг он может также применяться для того чтобы обеспечить приближение ваших процессинговых решений ваших систем конкретному пользователю и когда вы решаете вопрос приближение ваших решений конкретному пользователю минимизации время ответа скорее всего вы столкнетесь вот с таким словом это слово и не каст кто не слышал про не каст кто-то слышал отлично не к стати свой протокол который позволяет отдавать сетевые маршруты для одних и тех же систем для одних и тех же адресов dns который потом транслирует свои пи адреса по разным то есть у вас есть несколько площадок и они могут отдавать разные маршруты и в зависимости от того какой маршрут является для клиента самым маленьким клиент попадают на ту площадку где соответственно наиболее быстрое время для него но и не каст реализовано основании протокола bgp а если мы используем by g питу автоматически мы приходим вот к кому понятие собственной автономная сеть кто знает что такое автономная сеть автономная сеть друзья мои не все просто знают это собственный набор айпи адресов хотели бы вы владеть своими ip-адресами лонгборды вы их не арендуете у кого-то а вы их покупаете они ваши но если вы примете решение о том что вам нужны собственные пи адреса вы будете похоже вот на такого котика почему самое первое айпи адреса закончились нет есть айпи вы 6 адреса но проблема заключается в том что еще не все работают по ipv6 если вы не хотите отрезать львиную долю клиентов то вы не можете взять api вы 6 адреса а если вам нужно и пиво 4 адреса то вы подаете заявку на получение статуса лир около интернет регистратор это как раз и означает то что вы становитесь владельцем автономной системы и вам говорят о кей вас поставили в очередь чего плакать и страдать нет есть биржи где это можно купить есть другой путь интернет-адреса закончились в европе но они не закончились например в африке в африке свой собственный своя собственная организация которая ведает распределением адресов можно подать туда и вам сразу выдадут заявку в африку noike адрес который будет привязана к африке здесь есть проблемы вы должны тогда вести бизнес в африке потому что если вы бизнес в африке не видете то айпи адрес скором времени у вас отберут и дадут по голове потому что так в последнее время стали делать очень многие тем которым не хватает айпи адресов в европе окей каким-то образом купили айпи адреса дальше начинается куча других совершенно разных проблем с которым вы раньше не сталкивались первое сетевиков нет но вы можете сказать что любых специалистов нет на рынке да но сетевики это отдельная категория людей которых и так очень мало и их действительно совсем почти нет найти качественную сетевика это прямо проблема вы сразу сталкиваетесь что вам нужен резерв провайдер раньше вы об этом не задумывались вы работали либо в облаке либо вы работали в собственном оборудовании много арендовали машиноместа там стойку и сеть у провайдера дата центра и дата-центр сам заботился о том что в случае там какой-то аварии переключить вас на другой dc теперь это не работает внезапно магическим образом почему потому что вы сами управляете собственными api адресами вы сами управляете куда вы отдаете анонсы в какого провайдера и вам резко для вас резко открывается новая картина когда вам нужно несколько новых провайдеров и естественно для вас от открывается совершенно новый дивный мир это сетевые катаклизмы которые регулярно происходит вот последняя фраза провайдер накосячил flow speck эта фраза которая случилась примерно полгода назад есть такой крупный достаточно провайдер сейчас он называется уже люман случилось достаточно простое и это все магистральный провайдер который обслуживает примерно 30 процентов всего интернета там какой-то инженер проводил регулярные работы и случайно совершенно ошибся в протоколе в свой успех произошло что примерно 70 процентов всего мирового интернета пошло через одну маленькую стоечку где-то в минесоте стоечка не выдержала потери пакетов составляли примерно девяносто девять , 999 много если у вас собственная автономная система если у вас один провайдер для вас это может стать критичным ну потому что весь ваш трафик он пойдет через такую стоечку случае аварии авария тогда длилась семь часов и крупняк спасался только тем что он переключался на других каких-то резервных провайдеров ну и последний нюанс который присутствует только в россии если у вас европейские your wits и если у вас бизнес европе это вас не касается это вы познакомитесь с аркаим team что такое ркн в россии это организация про которую мы все много шутим в наши telegram канальчик ах про которую который мы не любим которое пыталось забанить телеграмму потом сдала назад так вот если вдруг вы получите в россии автономную сеть то к вам придет ркн и 1 стол скажет передайте информацию о том что у вас есть автономная сеть вы передадите потомкам придет снова и скажет так а теперь давайте еще полную конфигурацию оборудования полные конфиге вашего оборудования желательно распечатки желательно заверенной подписью что генерального директора и вот обновляйте их каждый раз когда вы их обновили но это еще не все скажите пожалуйста а кто нибудь слышал такую аббревиатуру нсд одна рука две-три это суверенный интернет господа он уже работает и nest и это национальная система доменных имен и если вы являетесь раньше это требование распространялась только на телекоммуникационных операторов а теперь она распространяется в том числе на владельцев автономных сетей если у вас есть собственную автономная сеть это значит что разков согласно требованию роскомнадзора вы обязаны в первую очередь использовать корневые на минные сервера которые поддерживаются роскомнадзором график работы этих серверов можно посмотреть специальном кабинете который работает в первый понедельник месяца высокосный год судя потому что никто не знает как они работают но они уже есть это дополнительный привет нам от государства которой которая хочет контролировать все соответственно это вот те проблемы которые мы с которыми вы можете столкнуться в том случае если вы хотите полностью управлять своим роутинга мы полностью хотите приближать клиента к себе и хотите организовывать информационные системы которые расположены в географически разнесенных дата-центров какие выводы из этого всего мы можем сделать первое про то что я уже говорил что типа организации данных и синхронизация этих данных между дата центрами зависит исключительно от внутренней логике эта архитектура ваших систем где-то может быть если у вас дата-центра близки вам подойдет синхронно и синхронная передача данных но в большинстве случаев нужно думать как жить со синхронно и асинхронно и приводит к тому что у вас венчал консистенции что вы не можете по факту изменять одни и те же данные в одних и в разных дата-центрах и вам надо как то с этим бороться роутинга пользователей дополнительными хищениями еще как-то не ищите готовых серебряных пуль их нет любое про что вы прочтете в интернете что и вам что покажется что это классно оно не будет работать если вы четко не понимаете как вы хотите сделать вам сначала надо понять как вы хотите и как она будет работать в соответствии с вашими бизнес требованиями и потом под это можно попробовать на эти решения но как показывает практика решения не подойдет на сто процентов если вы хотите строить гиа распределенные системы то вы столкнетесь с проблемой роутинга пользователей эту проблему вам придется решать она нестандартное и если вы хотите приближать своей системы конечному пользователю вы столкнетесь с понятием автономной системы это абсолютно иной уровень проблем который вы можете получить каску с которым они до этого не сталкивались есть естественно облака облачные хостинге типа амазона тип mail.ru клал solutions типа яндекс облака которой часть проблемы могут попробовать решить за вас но эта попытка решение проблем опять же надо четко отдавать себе отчет а как это работает есть современные вещи такие как amazon лямбда это исполнении какого-то кода на корневых на роутерах которые максимально приближены к пользователю за счет того что амазона есть достаточно большая собственная сеть этих edge и роутеров но можно ли их использовать да это приведет к тому что вы максимально близко подберете к пользователю нам понимать что лямда исчисления они не подходят для степу приложений в большинстве своем стоит full приложение должны иметь общение с базой данных а база данных не может быть расположены на edge роутере потому что этих от шутеров сотни они регулярно перезагружаются они не хранят состоянии но обо всем об этом наверное в маленький доклад уместить нельзя наверно на этом все мы с удовольствием продолжим дискуссию в кулуарах а сейчас вопросы спасибо большое девчонки но побежали у нас спасибо что оставил больше времени на вопросы мы можем сейчас поговорить плотнее и ребят и зон из онлайна если у вас есть вопросы пожалуйста нажмите соответствующий кнопочки мы в виде выведем вас в эфир с удовольствием первый вопрос пожалуйста представляетесь и вперед она еще константин россельхозбанк почему при роутинга вы не рассматриваете g1s геодезист можно рассматривать дело dns но опять же а что будет если у вас от к происходит отказ и у вас делал dns должен распределяться на другой дата-центр получается вы теряете сессию точно также как потеряю с установкой ничуть не хуже анимирую гораздо меньше это решение если вы готовы терять эту сессию если отказ уже есть я ее уже потерял если вы ее уже потерял если вы если вы при этом пользователя если у вас нету скажем так процедуры перемещения сессий с одного дата-центр на другой дата-центр d1s может быть таким же решением как routing пайпе адрес это сравнимо и решение на мой взгляд ну и автоном хотел бы своего собственного опыта добавить не знаешь все сталкивались ли нет крупные провайдеры очень и не любит анонсировать маленькие автономки поэтому маленькой автономка это путь в никуда что есть маленькая автономка вашим вашем понятии ну скажем так я сталкивался что 128 мудрецов уже могут не анонсировал такие автономки практически не продаются ну то есть обычная меня ном к когда мы говорим про автономку про несколько локаций мы не можешь анонсировать на локацию меньше чем слэш 24 до получать что стандартно условную мы берем автономки там слышь 22 хотя бы просто бывает люди горю виде слова автономка покупают минимальное возможно и получаете хочу собственную автономку класс спасибо вот здесь двое а там тоже да нам тут фонари светят очень хорошо девушки с микро в девушке молодцы микрофоном так вот у нас есть уже вопрос да матче галёрка добрый день спасибо за доклад николая колос в сбер мегамаркет бывшую books.ru у меня вопрос насчет для распределенных транзакций солим салат судя потому что вы рассказали я понял что вы разделили баланс клиента на количество дата-центров то есть там три дата-центра 3 баланса меня вопрос такой а что делать клиенту если он хочет узнать вот свой баланс в реальном времени с учетом тех транзакций которые проходят и силы насылают спасибо скажите мне пожалуйста хоть одну распределенную финансовую систему которая готова дать исла хотя бы четыре девятки на то что она покажет гарантированно правильный баланс клиенту с учетом проходящих транзакций я не знаю таких систем то есть условно что делаем мы если мы говорим про отображения баланса не про проведения транзакций то есть показать клиенту баланс мы показываем сумму балансов с того дата-центра куда пришел запрос она может поменяться через буквально доли секунды потому что данные там не знаю доезжают то есть транзакция прошла клиент еще видит старый баланс но через долю секунды он уже обновиться обычно я не встречал кейсов когда для клиента отображения баланса в моменте настолько важно что вот транзакция прошла и через сотые доли секунды он хочет увидеть обновление баланса ему нормально если этот баланс обновится через секунду в парадигме венчал consistency когда все работает если у нас не произошел отказ дата-центра если у нас нет нарушения сетевой связанности то изменения баланса по факту происходит почти мгновенно я ответил на ваш вопрос спасибо вот пожалуйста здравствуйте спасибо большое за доклад был очень познавательно легче найденов компании atlas скажите пожалуйста каким образом вы проводите тестирование проводить или и учение в случае падения одного из узлов в распределенной системы как это происходит учение мы проводим в бою потому что как показывает практика у нас наверное не проходит месяца чтобы кто-то из операторов не отказал или не приехал экскаватор наказание который перегрызть сразу оба ввода кабеля в один дата-центр который должны лежать по разным сторонам на по совершенной случайности лежат в одной и той же трубе она происходит как бы само собой нескольким случаям некотором роде но по-настоящему у нас кроме этого есть внутренние регламенты которые говорят о том что если у нас ничего не произошло и мы что-то начали скучать там и минимум раз в месяц должны эмулировать вывод выход из строя одного из дата-центр соответственно мы теми или иными путями либо гайсин на канал одному каналу связи либо мы гасим гипервизор и внутри дата центра ну то есть прямо по питанию берем и дергаем и смотрим что происходит ясно спасибо еще один маленький вопрос извините пожалуйста если ты не коммерческий там тайна а скажите пожалуйста какой силой вы обещаете по доступности вашим клиентам мы публично говорим про то что у нас с и четыре девятки это публичная открытая информация если мы говорим про договор но силуэт вопрос с каждого конкретного контракт на публичный силой которые мы говорим и которые мы раскрываем мы рассказываем про каждый случай который у нас происходит сбой а это четыре девятки на данный момент вот например у нас с начала года 99 , 99 пусть 6 спасибо вот оттуда вопрос можно фонарь рукой за закрыть и видно будет тогда пожалуйста спасибо за доклад меня три маленьких вопроса первый что вы делаете сессии мир привязанными к дата центру при проблемах на оном то есть дата центр пропал сессии привязаны по клиенту и проекту ну по вашей паре по скажем вашим хожу что делается с этим у нас есть внутренняя система это первичная система первичный слой обработки которая понимает что у нас дата-центр вышел из строя соответственно у нас есть базовая карта распределения которое говорят что вот сейчас вот проект а идет направо проект бы идет налево но в том случае если налево или направо у нас это путь который не работает у нас происходит при распределении трафика в соответствии с резервными картами понял второй вопрос вы как тори балансируете баланс и поровну между тремя до центрами дабы нивелировать такой момент например опять же был дата-центр на котором были какие то там ну как какая-то часть баланса он пропал и вдруг стало надо сделать много паутов и денег на 2 из 3 не хватает занять бы еще у третьего дом в дауне что делаете вот на чтобы от этого избежать и может быть перри балансируете как-то смотрите да у нас есть процедуры перебалансировки которые мы ни разу не запускали я честно признаюсь а у нас мы у нас есть dlp которая описывает соответственно тот случай про который вы рассказываете но реальной жизни показывает так что дата центра если выходит из строя то на незначительное время то есть это максимум часы и за эти часы баланс не успевает полностью уйти в ноль на тех дата-центрах где соответственно происходит списание ну и плюс обычно обычно наши клиенты стандартно вообще в принципе для большинства клиентов стандартной стандартная карта трафика это много оплат и мало выпал поэтому обычно не происходят ситуации когда нам надо резко взять и выплатить столько сколько нет на балансе это единичные ситуации которые обычно происходит опять же в то время когда у нас дата центр работает все это центр работает при этом врп такой ситуации есть честно сказать мы ее ни разу и не проверяли понял спасибо спасибо супер сейчас будет еще один вопрос из онлайна пока подумай если из этих ребят а вот там еще вопрос когда мы это участку or все кто здесь живьём вы можете пойти потом пообщаться если онлайн вопрос готов то давайте выведем его суда а вот смотри куда а вот на экране привет но тебя не слышно ага о да и мы считаем нашу надежность вот тот кто который я озвучила я специально оговорился что это с начала года число считаем мы внутри с 1 января до этого года то что внутри мы считаем это что мы даем совершенно спокойно как бы посмотреть нашим клиентам это надежность за последнюю неделю за последний месяц с начала года и за последний календарный год это был василий абакумов с нами из с просторов мирового интернета вася вася жизнь кому подарим книжку за лучший вопрос вот с галерки вот там вот был вопрос в отличие красная только с которым у нас было достаточно длительной дискуссии великолепно спасибо большое спасибо за доклад ребята спасибо за вопросы тебе памятные призы за участие в хайло de 12 хай-лоу де весны это прекрасно сейчас спикер уходит в цифровую зону общения мы с вами увидимся в 1240 сначала будете это те кто к с андреем аксенова мы завита и потом следующий следующий спикер продолжаю желать вам хорошего времени общения михайлове 2021 весна но на were привет я артем и снова сгрызть и да я редактор обрушение рукой я бывший доктор хабра сейчас ведущий подкаста мы обречены раз познакомиться чем занимаешься сейчас в общем регулярно чем работаешь глобально я как бы маленький предводители мама группы разработки просто выберу поиска овечки которые мы растим за грехи мои тяжкие мы все еще гоняем замшелые самописный движок сфинкс который я когда-то тоже видимость грехи будь она неладна писал и мы поближе поддерживаем и развиваем всякому дописывать ты жива сделал давно и не для vita ты просто как вы правому он вообще как-то считаю что он выдержал те требовали которым сейчас у него есть то есть они тоже тоже меняется и там сейчас 80 миллионов объявления завтра будет 160 миллионов но при этом у нас как бы боевой поиск это 80 миллионов объявлений это то что оперативно доступно каждую секунду в каждом первом пользователю масаки и внутренние системы которые тоже нас миксов кроется в которых и побольше да миллиардами измеряется например у админке с архивом всех объявлений может что-то интересное в принципе тоже не сильно я знаю светлом прошлом были инстанции в которых и еще больше там сотни тысяч серверов и этом за слишком большом количестве детьми по большому счету узкий лист достаточно некомфортно оперируете и был тогда и до сих пор может когда ничего с этим наконец сделаем вот но как бы я к тому что масштаб там порядка 100 миллионов документов много 10 миллиардов документ когда мы привычно но сейчас таких боевых условиях есть моменты на которые ты смотришь такой блин ну почему я тогда там не знаю 8 лет назад сделал по-другому 20 а что вы дружно все 13 ментальные возраста вообще 11 но отмечать удаваться а во вторых на эти моменты они есть понимаете постоянно все ним последние 20 лет в любой конкретно взятый момент времени хочется взяли все переписать на хрен вот 0 нет надо держать себя в руках нельзя все ломать надо на чем-то сидеть а некоторые моменты наверно там наоборот удивляешься блин-компот какой-то замши а ты меня не работает до сих пор и честно творения желание люто бешено полностью переписать а в основном скорее ну наверно больше половины года который делается это все таки что то что будет меняться можешь например рассказать в какие-то вещи которым ты был меньше всего готов который было сложнее всего это движок поиск по тону передали сейчас у вас мы там включает общем мель модули я не думал что 20 лет назад об этом думал что такое 20 лет назад каких бы даже не догадался о том что есть такая штука как имели которая по большому счету над статистиками сам астероидов и там линейная модель сотни входов они там с тремя входами пайк не как ни странно в этой части все достаточно легко как раз интегрировать есть интеграция той же самой модели ранжирование это достаточно штука оказалась простая потому что привело бы к нему к подобному сразу готов навестим один прекрасный момент уже там вырос там концепция под названием от моста сигнал оранжевая форма выраженными так далее выросла некая считалка этих самых сигналов форма выражения и все что оставалось делать это просто чтобы обеспечить возможность подцепить у д и функцию и в этому да я функцию передавать достаточно большой бинарный блок со всеми сигнал беранже нами которые мы хотим туда передавать достаточно тривиальных занятия вот поэтому это был сделан еще десять лет назад опять таки дев действует назад по моему мой первый раз какие такие бои менее мои обычные модели явку пожевали делалось это в тот момент не для vita делалось для одного тогдашнего клиент которые строил там маленький региональный поисковик по одной среднего размера европейской стране вот там был соответствует уже сфинкс там выберем от модели и нам первый рассмотреть самые мобиль кручу ли у тебя вопросы ниже определенному моменту в open source все после определенных увлекательных событий переживаний сэм с одной стороны с другой стороны я внезапно понял что прямо сию секунду никакого прока с этого конкурса не будет ни для какой заинтересованной стороны но смысле для проекта роток не вижу для себя так и уж тем более вот и пока в таком закрытом режиме может быть к лене купить source вернемся может расскажут что такое случилось почему так шо он там этот длинный увлекательный или наоборот длинная не очень интересная история вкратце и как бы это давай совсем большими масками следующим образом очень не просто зарабатывать сопин снова движка который ты абсолютно за бесплатно делаешь раздаешь и и пытаешься зарабатывать хрен пойми чего нельзя все отдавать за бесплатный надо чего-то и продавать вот с продавать у нас как бы всегда были некоторые сложности и поэтому на самом деле текущую версию который разрабатываемые тем боль послушать я ее прикрыл еще в годы когда попытки зарабатывать со танцор снова движка не кончились уже там не знаю группу а рядом четырнадцатом году если при помощи уже был понятно что надо что-то менять в кавычках в бизнес модель бизнес в гигантских кавычках потому что особого бизнеса в этом утра диски счастью не было а и уже тогда где стать решила что маг будет делать где-то разрез версия за деньги вот версия без денег и поэтому некие большие фундаментальной перья сделки которые были за тельны и что тогда дома в четвертом годе надо их прикрыть и не потом где-то провести линию разрез соответственно после всех этих перипетий названием кассовый разрыв довольно долго получается жили до 1 нормального кассового разрыва с одной стороны но здравый стоят там 95 процентов так называемых стартапов как бы в это дело заезжают на дистанции в 1 1 2 3 года футболист несколько дольше в свое время но ну чё за твои оказался достаточно фатальной очередной разрыв читы деньги кончились совсем самое главное что приток денег кончилось тоже совсем там был еще массу неприятных моментов нужно как как сказать как в любом разводе скажем так но это уже наверно тема для отдельного рассказа и обычно там а кулоном рассказанным с угрем вещами за четырьмя литрами пиво и постепенно переходим от и оон когда он был в open source его легче было ним работать был какой-то вклад от сообщества значимой интересный вопрос легче или нет я бы сказал что хомячки как-то сильно комфортнее на пару понятно немножко сцену всегда удобней работать когда ты nissan там какая . понемножку тут копеечку так капельку а вот снова нихера когда сзади к тебе прилепим гигантская компания со всеми ресурсами и возможности ресурс так или иначе использовать могут будет понятно дело сильно поле комфортно режим жизнь вот понятное дело что тут как бы палка о двух концах и естественно если у тебя твой проекта люто бешено взлетает и сам начнет генерировать сильно больше денег чем у при большой компании на него в принципе когда не забуду за бюджете вы то наверное пора некий спин-офф open учинять а тут песчаную большой компании случае со сфинксом это случается сфинкс может служить достаточно мало зарабатывал всю жизнь как бы это соответственно его независимая жизнь была не сказать чтобы как бы усеяна розовыми лепестками и корпоративными с черной икрой с соответственно выдающиеся в золотых чашечках бриллиантовыми ложечками поэтому в рамках большой компанией ну честно говоря одну жить легче много чем по меньшей мере вот на это этом стартовые фазе под названием и еще пока там свои 100 миллионов долларов с share via не делаем вот чисто теоретически чисто теоретически наверно можно построить разработку следующим образом что у тебя есть достаточно большое количество компания интересант of каждая делает рожна из которых делают достаточно новое хорошее интересное и которая можно скажем так в общем то ну хорошо уложить а его проект замерз теоретически это возможно какие то вот прям супер комьюнити проекты такие есть тот же пост бриз например по большому счету вот такое супер танцы проект на котором трудиться далеко не одна компания и каждая из которых по 2 лего это вот вообще дерево , а сфинкс до такого масштаба черт его знает то ли не дорос то ли в принципе невозможно чтобы до такого масштаба дорос потому что насколько я смотрел и изредка смотрю на более другие проекты которые тоже про поезд в основном и понятное дело люсин и все что поведает нам о библиотечка люсин и тот сервер который в этом сезоне модны строить поехали set а они всегда у меня конечно может неверное впечатление пошли к недостаточно хорошо там умею распарсить 250 мегабайт джавс кого года 220 мегабайт из которого это в основном то мне нужны реальные комментарии и там тривиальный фабрик но у меня такое ощущение что поменьше мерил в ядре скажем так движка библиотек и так далее где-то процентов 90 кода делается был бы в этом крайне ограниченным кругом лиц который возможно формально ходит по разным компании но их там допустим 5 до если думают об opensource что это очень мало люди на самом деле то есть он такой открытый но контролю реально большой 1 раз контрибьютором пара человек странных именно так большое количество контрибьютором при этом одновременно с этим может возникать в какой не части там типа а вот ведром и лезть опасаемся но зато мы прикрутили вот этот плагин вот этот плагин вот этот план вот такая вот штука она конечно цветёт и пахнет сильно сказать все сели на шепча чем попытки привлечь к разработке ядра при каких условиях ты повернул его выполз сложный вопрос вот на данный момент я натурально не вижу никакого там объективного плюс от open source а кроме никого имиджа и даже уже не уверен насколько как бы это важно и не важно для конкретных пользователей для того чтобы этот имидж был вот если бы сейчас тут и мог вернуться в прошлое с текущими своими знаниями о том во что превратится в этот проект и что-то одно сделать по-другому что это была не ну это ответ на этот вопрос мне к несчастью готов еще до того как я придумал сфинкс и он звучит примерно как а в момент ваучерной приватизации я бы украл ящик водки украл ящик водки много ваучер на которой там складывается в исламе газпром потом конвертируется в биткоины и в принципе на данный момент был он маску меня где-то уже в подметки вот если стаки признанием ну ладно успеха теперь хорошо готовится докладов надеюсь получится круто хорошо выступить ай да надеюсь делу спасибо denis привет я артем я бывший директор хабра сейчас ведущий подкаста мы обречены рад познакомиться добрее чем занимаешься я являюсь сотрудником россельхозбанка в данный момент я работаю в инвест блоки занимаюсь дива псам и вопроса мы зададим их сезон лайна но сначала доклад и может быть 40 минут а может быть 50 посмотрим как получится доклад называется необычный случай оптимизации производительности например и клик хауса меня зовут алексей наверное все уже знают я делаю crack house pro crack house я рассказывать не буду кроме того что повторю что crack house не тормозил не тормозит и будет не тормозить еще больше и лучше а что вообще такое оптимизацию производительности чтобы клика вас не тормозил мы постоянно все оптимизируем это похоже на некоторую игру в которую я ни разу не играл я его даже не разу не видел как кто-то играет но судя по картинке похожа короче такой автомат где и сбер вылезают какие-то каратэ надо бить их молотком одного карата ударил волевые лист другой тоже ударил и мне кажется что оптимизация производительности выглядят примерно так профилирует наш код видим какие-то выступающие части ударяем по ним решаем вылезают какие другие части продолжаем оптимизировать дальше и дальше давайте рассмотрим какие нибудь интересные примеры просто попробуем задать вопрос и посмотреть как на него ответить значит в клик хаусе есть разные движки таблиц почти всегда рекомендуется использовать движок таблиц north 3 это такой самый продвинутый больше всего поддерживает но есть еще движок таблиц memory они отличаются тем что мертв 3 хранит данные на диске memory таблица хранят данные в оперативке а еще мы знаем что памяти быстрее чем диски но обычно конечно можно поставить сервер например 10 нём и ssd и 1 канальную память и тогда этот ssd будут быстрее чем память но правда они не будут работать быстрее потому что все будет ограничиваться памятью но обычно память быстрее чем диски значит ли это что memory- таблицы быстрее чем мертв 3 попробуем проверить тут небольшой скринкаст я выполняю запрос из таблицы тест . hi-c таблица типа мертв 357 миллисекунд теперь я сделал следующее создам таблица с душком memory и вставлю туда данные выставляю memory limit чтобы данные хватило оперативки на вставку данные вставляются довольно быстро миллион строк в секунду даже больше данные вставились всего лишь за 7 секунд теперь я проверяю с какой скоростью выполняется запрос из таблицы хит подчеркивать memory 50 миллисекунд 54 а из таблицы хит 57 ну что на несколько миллисекунд memory таблицы все-таки быстрее а вроде вы должны быть больше ну здесь стоит отметить довольно очевидную причину то что мертв 3 таблицы они хранят данные на диске на самом деле файловой системе когда данные читаются они попадают в печках который реализует ядро операционной системы и читаются уже с плеч каша то есть из оперативки получается что и memory таблицы в оперативки и мертв 3 тоже в оперативке то есть никакой разницы нет но почему тогда memory таблицы все-таки работали быстрее давайте рассмотрим ну во первых есть и очевидные случае это то что мер 4 таблицы поддерживают первичный ключ поддерживают индексы позволяют читать маленькие диапазон и конечно от будет быстрее a memory таблица только full скана но это неинтересно мы будем рассматривать почел full скана в мертв 3 таблицы не так уж и сильно медленнее и в том запросе у нас был именно full scale все данные с агрегировать посмотрим дальше тоже я тут видео сделал правда почему-то весь мой экран за хватился и так выполняю запрос из таблиц этот тест хит 171 миллисекунды hits подчеркивали 215 миллисекунд то есть memory таблица почему-то бы наоборот медленнее чем мер 4 как такое может быть я выполняю запрос снова с помощью утилиты коли house benchmark и так memory таблица 213 миллисекунд мертв 3 таблица 150 с чем-то миллисекунд запрос на какую-то агрегацию там был ёрл там было поисковая фраза и парадоксально но когда данные целиком в оперативке работает медленнее как такое может быть ну что давайте разбираться есть еще некоторые случаи почему мер 4 таблицы могут работать быстрее чем memory во первых из-за сортировки данных мер 4 таблице данные сортируют по первичному ключу и некоторые алгоритмы могут полагаться на сортировку причем они могут полагаться на сортировку как явно так и не явно например если у нас данный уже отсортированный мы снова делаем сортировку то повторная сортировка не будет использоваться будет только некий мерч или там грубое по первичному ключу тоже будет использовать сортированных данных но сортированный может использоваться неявно например у нас таблица отсортировано по айпи адресу мы делаем запрос грубой по региону и у нас одинаковые api адреса идут подряд и систему про это знает но еще у нас одинаковые регионы тоже идут подряд но система про это не знает но у нас есть прикольная оптимизация если мы видим что какое-то значение повторяется мы прикуп грубой просто не ищем его второй раз в хэш-таблице то есть сортированных данных локальность данных тоже используется но это еще такой пример но ясны данные в одинаковом порядке в австрии в memory таблицы может ли мертв 3 быть быстрее сейчас посмотрим во первых нужно я напомню как в как хауса хранятся и обрабатываются данные клик хаус стал целая база данных данная хранятся по столбцам и данные обрабатываются в памяти тоже по столбцам что это значит вот классический пример сравнение представления данных в оперативке массив структур или структуру массивов в этом пример у нас точка в трехмерном пространстве три координаты слева мы их положили в структуру и сделали массив этих структур а справа мы сделали структуру где три массива разные варианты лучше для разных случаев ясно нам нужно всегда доставать все 3 координаты и как это обычно бывает там я не знаю в каких нибудь в трехмерной графике это лучший вариант слева но если вдруг нам надо взять только одну координату понять пройтись там я не знаю про сформировать x лучший вариант справа на самом деле все чуть-чуть сложнее данные хранятся в оперативке обрабатываются не целыми столбцами а кусочками столбцов например если у нас есть таблица и там миллиард строк мы же не будем весь такой массив миллиард значения одного столбца делать это очень длинно и когда нам надо выполнить операцию плюс мы будем идти по этому миллиарда значений нет мы разобьем данные на такие некоторые блоки и личинки или кусочки я вот не могу придумать еще синонимы слова кусок хотя нам для разработки cry хауса очень нужно больше синоним слова кусок кусок чанг какой спецборт что еще бывает блок кто еще знает силах мы столовый кусок что отрезок да винчи у нас тоже есть гранула есть короче читаем эти данные и получается кусок для такие мотивчики для каждого столбца например по несколько десятков тысяч строк и вот эти вот уже кусочки столбцов обрабатываем так делаем все наши операции я даже один раз наткнулся на научную статью научно это значит сверстана в техи в которой эта технология называлась марс allbiz processing меня даже пришлось пойти и воспользоваться переводчиком чтобы узнать что такое марса оказывается это английское слово которое значит маленькие кусочки еды вот а я прочитал эту статью и обиделся потому что эти авторы они должны были бы с твоей статья написать клик house bass processing они изобрели термин отдельный и вот такой способ он лучше потому что он более кэш локальный сейчас объяснять не буду сейчас покажу дальше давайте разберемся как читаются данные из таблицы вот все что происходит ясно у нас таблица типа north 3 там и во-первых читаем файл и из файловой системы файлы содержат сжатые данные данные сжимаются тоже по блокам но другим блокам не тем блоком которую мы будем обрабатывать а специальным блоком для сжатия это другой блок например взяли 64 килобайта зале записали файл взяли 103 64 килобайта данных зале записали файл когда читаем надо их рожать когда мы их нажимаем мы еще и обязательном в обязательном порядке вычисляем checksum и и сверяем checksum и это очень важно потому что данные на диске на ssd могут начать потухать там биты могут слипаться и все такое если вас это интересует у меня в позапрошлом году был доклад под названием отъявленные баки рекомендую посмотреть итак проверили checksum и дальше ru зажимаем сжатые блоке у нас получились не киеси реализованные данные эти стерилизованные данные надо превратить в те самые кусочки столбцов в оперативке это здесь названа шагом диси реализация и когда в оперативке кусочки столбцов есть мы уже их обрабатываем вроде бы все просто теперь тоже самое для memory таблицы ничего делать не надо в оперативке готовые кусочки столбцов вот они лежат просто бери и обрабатывай то есть все шаги которые здесь были они не нужны memory таблица должна быть более эффективно теоретически но сейчас посмотрим дальше что же на самом деле происходит при чтении данных из мер 3 таблицы шаг 1 читаем сжатые данные из файловой системы читать данные из файла и системы из файлов можно по-разному можно читать с помощью синхронно у воды вывода или с помощью асинхронного если используется синхронный вот вывод можно использовать обычные системные вызовы рид или перед а можно сделать вам map file а тогда он будет фактически читаться в афгане 5 фунтов это не системный вызов но тоже пейдж фонд использует ядро операционной системы если у нас асинхронный ввод-вывод мы можем использовать linux а и а системные вызовы айро сабмит и aged events и другие или новый интерфейс you ринг который доступен только в самых свежих и ядах linux так что если вы хотите максимально всех поразить написав свой код вы можете использовать интерфейс your young но нам это не так полезно потому что у нас в основном последовательное чтение операции ввода-вывода немного так что асинхронный ввод-вывод особо не поможет можно использовать синхронной если использовать синхронный вот вывод можно использовать . или не использовать . не используются если вы поставили флаг a direct а если вы читаете например с помощью эмма по то у вас прям поищешь напиться в адресное пространство процесса если используется мы потом избегаем лишнего копирования данных из прыжка ш юзер space тем не менее можно отметить что мы читаемость файлов сжатые данные если у нас коэффициент сжатия например в 10 раз то этих сжатых данных в 10 раз меньше чем тех данных которые нужно обработать то есть то что мы читаем эти данные вычисляем checksum и личное копирование это все не так важно в 10 раз меньше чем всего остального ну давайте смотреть дальше раз сжимаем сжатые блоки по умолчанию cliff house использовать алгоритм rc4 данные сжаты всегда можно использовать более сильное сжатие zeos т.д. можно наоборот сжатия вообще выключить это у нас названа кодекс затем на но ну вот что интересно проводим эксперимент берем выключаем сжатия и внезапно все работает медленно поэтому возникает ещё вопрос какими блоками лучше сжимать данные влияет на это на скорость и как кстати если интересует про сжатия данных рекомендую посмотреть доклад три года назад как у скорость разжатия rc4 но это если вас интересует такой хардкор смотрим дальше диси реализация кусочков столбцов на самом деле в кликом сидиси реализации нету почти нету это значит что когда данные ража ты допустим хранятся в базе просто числа и и из 32 они файле просто подряд и уложены в родном формате и чтобы перенести их столбец просто надо скопировать какой-то кусочка этих данных столбец просто переложить данные переложить данные и все спрашивается а можно ли как-нибудь обойтись без этого копирования без перекладывания данных ну на самом деле иногда можно иногда нет здесь отличие в том что как раз кусочки данных в оперативки и кусочки данных для сжатия данных которые при разжатия образуются они имеют разный размер и они должны иметь разный размер если в таблице у нас какой-то столбец очень маленький например число идентификатор региона там москва единица санкт-петербург два и так далее допустимый uint 32 4 байта и у нас даже если взять один миллион таких чисел это будет 4 мегабайта а другой стал 12 ну например содержимое html-страницы 100 килобайт если возьмем миллион сколько получится 100 гигабайт то вообще один блок в оперативку не поместится поэтому если мы читаем толстый сталкиваться нас должны быть маленький кусочек в оперативке если мы читаем маленький stalgast лучше большой так что приходится иногда перекладывать данные итак случае memory таблиц у нас в оперативке готовые кусочки данных в случае мертв 3 кусочки столбцов формируется при чтении то есть мертв 3 делает больше работы но может ли быть такое что делать больше работы на самом деле быстрее ну конечно может быть если мы на каком-то шаге делаем больше работы а потом нас каждом шаге делаем меньше работы ничего сложного я как какие-то такие странные вещи говорю все на самом деле очевидно и так случае мертв 3 кусочки столбцов формируются динамически при чтении и поэтому их размер можно выбирать адаптивно так как будет лучше для кэш локальности наверное уже нечего и поят из моего доклада но сейчас я объясню и так какой большой столбец типа вот этого текста html или какие сообщения статьи на сайте довольно крупная в этом случае вот как я говорил лучше формировать маленькие блоки например по 10 строк а когда у нас memory таблица там и размеры всех столбцов в этих танках одинаковые но при орви за тысячу строк один столбец а то другой тоже тысячу строк и мы будем обрабатывать мелкий столбец будет лучше для кэша локальности будем обрабатывать большой столбец у нас временное данные будут вымывать процессор на кэш и соответственно будет использоваться больше оперативки и все будет работать медленнее и тут возникает вопрос куча вопросов с какой скоростью работать оперативка нельзя на этот вопрос просто так ответить скажем вот какой это человек сидит с ноутбуком а какая на вашем ноутбуке скорость оперативки с какой скоростью работает оперативка на вашем ноутбуке что-то никто не знает а как вы можете на ноутбуке я не знаю сёрфить в браузер и что-то и не знать с какой скоростью работать оперативка ваше железо вы должны знать с какой скоростью работает ваше железо вот я например всегда знаю как быстро работает оперативка как быстро работает кэш как быстро работает как 1 2 и 3 уровня и если использовать его из одного процессора ядра из сразу многих процессах я тёр какая пропускная способность какая latency все это можно взять такой набор чисел стоит сложить перемножить и свериться с ответом ну теперь давайте посмотрим следующий вопрос про сжатия данных вот я провел эксперимент создал мер 4 таблицу с данными которые сжимаются по умолчанию с помощью алгоритма ль за 4 я начал их профилировать выполняю запрос смотрю в профайлер в прав а игры в топе функция эльза 4d compressive разжатия данных я думаю сейчас я удалю этот пусть у меня данные будут не сжатая этой функции не будет все будет работать быстрее то есть надо просто убрать сжатия данных и вот один я сейчас расскажу историю которую я уже один раз рассказывал но с удовольствием расскажу еще раз несколько лет назад один человек обратился ко мне в чате и говорит что у меня вопрос упирается выражать о данных давайте я можно ли вкх уся как-то отключить сжатия данных я говорю нет нельзя crack house сделан правильно данные впитался всегда сжимаются но если вы хотите вы можете отправить полу request человек спрашивает а какие строчки кода менять я говорю ну вот в этом файле памяти и ушел на следующий день человек отправил pull request я посмотрел сделал code review по меру сил все нормально работает и спрашиваю его скажите пожалуйста а насколько ускорились вопросы а человек говорит и за эти не могу сказать насколько ускорили запроса я попробовал готов и теперь данные не помещаются на ssd стало слишком много данных а вообще если данные не сжимать то обычно ничего хорошего не выходит то есть вариант 1 не сжимаем данные они не помещаются на диск вариант 2 не сжатые данные помещаются на диск но по их чтение читают гораздо больше используется пропускной способности диска и теперь чтение с диска тормозит хотя раньше не тормозило или например убрали сжатия данных и меньше данных помещаются в печь кэш в оперативке потому что как раз в печь каши были те данные которые файлах то есть сжатые и чем лучше данные сжимаются тем больше данных помещаются в печь кэш ну давайте представим что у нас куча оперативки на сервер и я не знаю один терабайт оперативки 2 терабайта оперативки а скажите а у кого из вас на сервер и еще больше оперативки кричите да сколько у вас оперативки на сервер 6 tarra white ну и вот вы туда все свои эти данные положили и давайте наверное их лучше не сжимать потому что сжатия расходует циpкa имеет ли это смысл не сжимать данные когда 6 терабайт оперативки давайте проверим возникает вопрос вот самый вот есть алгоритм на сжатие который более сильные сильнее сжимает данные но при этом я не работают есть более легкие вот эльза 4 это более такой легкий алгоритмом zeos т.д. несколько более тяжелый зато лучше сжимает данные а я собрать еще более еще более мягкие алгоритм можно свести все к тому который вообще ничего не сжимает его можно использовать в качестве bass line это миром копи ничего не сжимать не разжевать просто скопировать данные вместо их сжатия коэффициент ржать сжатия единица и вопрос что работает быстрее просто скопировать данные переложить их из одного места в другое или взять сжатой данной и разжать их и ответ вроде бы очевиден если я правильно все цифры помню на я навскидку так говорю на своей машине мем копи работает где-то 12 гигабайт в секунду а рожать эльза 4 если мерить по разным данным получается где-то от 2 до 4 гигабайт раз сжатых данных в секунду то есть просто скопировать данные быстрее чем рожать их вроде все так но есть какой-то подвох может быть кто-нибудь уже знает в чем подвох как я вас обманываю ну я не слышу орите так в оперативке что нас загрузить вы против у нас уже все данные в оперативку в оперативке я не слышу орите сжатых данных меньше и тапочек почти правильно ответ но не совсем все-таки сжатых данных меньше но когда мы их разума и мы же трать тратим на это время и развиваются они медленнее в чем подвох и ответ на самом деле очевидный я хочу чтобы кто-нибудь сказал чего не развивать максимума стыдно как от козла локальность я не надо говорить в общем не надо позориться сейчас я все объясню рассмотрим такой сценарий чтобы все понять и так данные хранятся в оперативке данные обрабатываются по блокам каждый блок небольшой и сам помещается в кажется пул но естественно все эти блоки в оперативке не помещается в кажется пу их там терабайт и и данные обрабатываются в несколько потоков то есть данные читаются из оперативки в несколько потоков и каждый блок потом уже обрабатывается внутри каша процессор нова из оперативки читаются только исходные данные и у нас получается да допустим возьмем машину desktop на raise не 16 озер и если в каждом из этих 16 ядер делать нам копи и выполнить просто арифметику домножим 16 на 12 гигабайт в секунду якобы получается 192 гигабайта в секунду но на самом деле не получается если в каждом потоки разжимать свой маленький блоки блочек такой эльза 4 из лера сжатые данные в каждом потоки поместиться в кэш соответствие его процессорного ядра тоже домножаем 16 лидер на от 2 до 4 гигабайт в секунду получается от 32 до сорока восьми гигабайт нажатых данных в секунду оперативка на вот этой конкретной машине работает со скоростью 30 гигабайт в секунду то есть смотрите в каждом потоки делаем мем копи чтобы сделать нам копию мы должны по крамер и прочитать эти исходные данные прочитать их из оперативки и быстрее чем 30 гигабайт в секунду мы это делать просто не можем а когда разума эмаль за 4 мы читаем меньше данных мы читаем их с меньшей даже скоростью из памяти потому что они сжаты их просто меньше но в результате генерируем такой же объем 1 сжатых данных но разжатой данные уже в процессор нам кэш и они уже там быстрее обрабатываются и оперативки пропускной способности оперативки используются совсем мало то есть в случае мем копи упираемся скорость памяти в случае за 4 не упираемся и скорость получается примерно такая же писать в память не а мы в память не пишем вообще мы нажимаем данные как бы в память но они попадают в процессор на кэш каждого процесса нова ядра то есть вообще не пишем в память только читаем из этого можно сделать такой вывод что память можно рассматривать как диск и неужели разжатия эльза 4 будет быстрее чем нам копи ну это зависит зависит от железа вот например 200 этой сервер один из самых мощных по нашим дач парком на эпики 2 processor ных два сокета в каждом 6 4 ядерный процессор всего сто двадцать восемь ядер память может быть долл 8-канальный максимальная брук слоя способность аж в 190 гигабайт в секунду и что будет быстрее просто перекладывать данные или разжимать их ну и вот домножаем 128 на 2 например гигабайта в секунду скорость разжатия пор сжатым данным получается 256 гигабайт в секунду что тоже больше чем русская способность памяти и на этом серве тоже разжать ее будет быстрее на самом деле не все так однозначно я провел еще несколько серверов там серверы на intel и там поменьше было процессор федор оперативка такая же быстрая и там получилось что не быстрее то есть все это зависит еще можно сказать что здесь рожать я все-таки упирается в процессор например данная сжаты в 10 раз у нас 190 гигабайт в секунду раз сжатых данных и 19 гигабайт в секунду сжатых данных из оперативки читаются только сжатые данные то есть это медленнее чем то что дает оперативка сжатие можно все-таки ускорить ну что давайте посмотрим какие мы сделали оптимизации в криком все просто полагаясь на этот вот опыт для memory таблиц для лучшей каш локальности уменьшили размер блока чтобы при обработке данных не использовать оперативку обрабатывать чисто в каше я добавил сжатие для memory таблиц и вы знаете она выглядит хорошо на бенчмарках это прекрасно в продакшене memory таблице не обязательно нужны используйте мертв 3 ну а то что выглядит на пять марках хорошо это всегда радует оптимизация для мертв 3 таблиц вот кодекс сжатия но он то есть ничего не нажимать и не разжимать спрашивается а зачем тогда вообще данная копировать зачем это лишнее копирование я убрал это лишнее копирование ненавижу лишние копирования я вообще любой хороший разработчика он больше всего ненавидят единственное копирование если это разработчика на си плюс плюс аист на похлопотал 1 дальше у нас есть вычисляем checksum я люди спрашивали вот в профайлер и видного частей очаг сумму можно ли его убрать я говорю нет так правильно данные всегда нужно chicks умирать у нас надёжная система не пудри цена мозги ну потом подола дать проверим что будет если выключить чек суммирования ну выключил и запросы не ускорились не насколько и производительность вообще не изменилось там получается что чтобы учиться чак сумму над пройтись по как он кусочку данных этот кусочек данных будет читаться из оперативки загрузится в кэш а дальше следующее уже будет использовать кэш то есть мы просто раньше загоняем данные в кэш а самого часто чак сумма и она быстро и дальше сделал возможность чтение с помощью map чтобы еще одно лишнее копирование убрать но тоже не помогло потому что она поджатым данным и давайте посмотрим как все эти оптимизации все ускорили димка захожу в crack house клиент выполняем сначала из таблица мер 3 запрос 180 миллисекунд а теперь из таблицы hits почерками обрыв abs 226 миллисекунд то есть медленнее но как было теперь я попробую применить свою супер оптимизацию сжатия данных оперативки вот я написал engine равно memory компресс равно единице создал таблицу теперь надо вставить в нее данные оставляю данные id происходит медленнее потому что данные сжимаются но все равно скорость приличная и так очень люблю этот зеленый прогресс барр всегда когда на него смотрю данные вставились выполняем запрос из таблицы his подчеркивает caps 300 миллисекунд а ведь было 200 с чем-то от этого было 180 что-то не так действительно вот было 200 миллисекунд из таблицы мертв 3 а я все ускорил я все ускорил и она замедлилось в чем прикол я ведь это павел когда доклад готовил вчера почему она замедлилось я только что объяснял что все должна ускориться она замедлилось ладно я понял все таки почему она замедлилось и сейчас вам расскажу всё дело в размере блока который в memory таблицы создаем ямори таблицу со сжатыми данными и теперь выставим размер блока 8192 поменьше чем по умолчанию по умолчанию 6500 решать сейчас данные записывается в оперативку в виде таких сжатых и блоков каждый из которых 8192 строки каждого столбца и теперь делаю запрос выполняю из таблицы просто хит 107 688 миллисекунд а теперь из таблицы хит спать черные memory оптимизированный о 123 100 16 миллисекунд 198 миллисекунд круто вот на этом я остановлюсь то есть видите изменили размер блока было 300 миллисекунд стала 98 эрик секунд и в чем причина самая главная причина это кто скажет cash cash локальность совершенно верно вроде бы все просто выводы чтобы оптимизировать производительность надо знать что делает ваш код профилируют вашу систему знать возможности железо ну на самом деле достаточно просто знать что процессор имеет много ядер что у процессора есть кэш ну и не путать в этом сайте трупу всего спасибо оптимизируйте вашей программы алексей спасибо большое друзья давайте зададим вопрос и теперь уже в микрофон они без без вора поднимите ручки пожалуйста вот одна рука вижу вот смотрите к вам бегут две девушки выбирайся микрофон да пожалуйста представьтесь и задайте надо было девушка обнять сначала поэтому микрофон и работы да не достаточно крепкая прием прием здравствуй пасе большое за доклад вот вопрос на самом деле самого начала крутился в голове про размер этого блока должны сразу же было как-то понятно что есть какая-то зависимость между коэффициентом сжатия и производительностью вот вот если какие-то вот рекомендации по подбору размер этого блока потому что кажется как будто бы это еще зависит от природы данных всем спасибо да действительно вопрос как выбрать размер блока для сжатия данных и это зависит от того какой алгоритм сжатия используется если используется довольно легкий алгоритм сжатия типа семейства за 77 в том числе и ждать 4 он работает так есть какое-то движущиеся окно с данными в которой мог быть ссылки назад то есть алгоритм сжатия просто копируют повторение этих данных которые были недавно и размеру то движущуюся акрам валь д 4 максимальный 64 килобайта то есть получается эти бэк reference ссылки назад то максимум на 64 килобайта назад я сам выберу размер блока 64 килобайта получиться неплохо если 128 несколько лучше потому что вот во второй половинки можно будет ссылаться в первую но дальше уже увеличиваем и увеличиваем и никакой разницы нет но и сажать ее более сильное скажем библиотеки которые реализуют или e-mail у них размер в котором можно искать данные это многие мегабайт и иногда даже можно выставить чтобы были гигабайты и там уже лучше большие большие золотые блоки но они будут сжиматься и разжиматься так медленно что на кашу локальность вам уже будет наплевать так что смело выбирайте большие блоки если алгоритм сильный спасибо ответил вот человек в третьем ряду и ребята в онлайне вам снова привет если есть вопросы нажимайте супер кнопки пожалуйста и спасибо интересный доклад интересует тема такая вот вы все рассказывали но не упомянули тюнинг параметров операционной системы типа пачкаешь пичкаешь says и так далее вот эти вот параметры как-то крутили смотрели вообще ну performance мерили с измененными параметрами или на дефолтных каких-то значениях остановились есть такой классический случай когда есть пользователи клика уса и у них супер там кластер и он делает какую-то очень важную работу например баннерная крутилка ну вот из того вот эти люди там куча таких обменов серьезно хотя люди думают что сейчас мы прочитаем здесь конфигурационный файл и от каждого нас троечку поменяем на какую-то более оптимально части скатала 8 везде там чуть поменяем таня это меня отнят вроде а на ночь работает быстрее на тестовой среде она продакшн и внезапно все замедляется иногда люди об этом даже не знаю потом просто сбрасываемся в дефолт и она работает лучше так вот если нет возможности именно хорошая сравнительно сделать тестирование желательно продакшене просто ничего не меняете и вся вы хорошо да прошу прощения понял ответ может быть какой то оптимальный профиль от яндекса есть уже готовый для production серверов именно там sysctl профиль и так далее ну то есть или просто вы используете какие-то дефолты и на этом остановились вообще с этим идеальным профилем довольно сложно у каждого клиента чуть-чуть отличается нагрузка у одних например посмотришь запросы и все эти запросы упираются в выполнении рига ксп of noodles просто наскольно повергать хотя прыгать по у нас хорошо оптимизирована и но и остальных и запросах молока все равно все будет опираться в реках сп и а у других например очень длинные строки и надо уменьшить размер блока а у некоторых наоборот короткие и надо его увеличить хотя при чтении и смерть 3 он выбирается сам и вот этих особенности очень много то есть такой идеальный профиль я даже боюсь раздавать тем не менее у нас выложены тестовые данные яндекс метрики of us и раваны и у нас есть benchmark железо и результаты разного железа поэтому мяч марку по запросам тоже из яндекс метрики опубликованы на сайте и там можно сравнить самое разное железа там даже сравниваться там x86 и arm и и можно посмотреть что быстрее и должна приблизительно оценить стоимость спасибо спасибо и финальный на сегодня вопросы остальное в кулуарах пожалуйста просите спасибо за интерес на такие точки оптимизации вытащил нужно здесь мысль промелькнула что да можно ускорять чтение это здорово и полезно и нужно но это имеет эффект и на записи аренда надо писать очень быстро очень много и не терять данные соответственно вот планируется легко и там защиты более подробно и разворачивание темы как данной оптимизации повлияют на ворота на запись и не завалено мб ram таким образом на самом деле скорость записи имеет другой порядок по сравнению со скоростью чтения то есть мы видели запись это порядка 1 1 миллиона строк в секунду на одном сервере для достаточно широкой таблицы ну там может быть 10 миллионов для мелкой таблиц или там сто тысяч если она очень толстая чтение это могут миллиарда строк в секунду когда читаем мелкие столбцы все такое и для записи уже влияет не время на сжатие данных то есть ржать и если хотите можно и посильнее выбрать и разница в скорости не заметить для мертв 3 таблиц влияют и во-первых сортировка данных при записи которым вам так или иначе нужно для индексов а во-вторых влияет то что данные раскладываются файлы на файловой системе и ясно писать мелкими блоками то этих файлов будет много для этого кстати недавно сделали оптимизацию компактные компактный формат кусков он включен по умолчанию так что здесь тоже не партесь по умолчанию будет работать нормально если медленно просто записывать в большее число потоков но извините это я говорю как будто вы это уже не делаете но вы выглядеть как профессионал поэтому я уверен что алексей кому книжку подарим за лучший вопрос а я все вопросы уже забыл а давайте последнему человеку последнего человека над которым ты подшутил на хорошо это честно достаточно до алексей тебе памятные призы и сертификат нейрохирурга как обычно друзья мы встретимся здесь через 15 минут а алексею ходит по цифровые кулуары чтобы отвечать на вопросы и соответственно usa online оттуда можно подключиться и из оффлайна прийти ножками вместе с ним luxoft диоксид i know jack компании ведущая глобальная компания оказывающие услуги по формированию digital стратегии и разработке программного обеспечения с клиентской базой по всему миру в россии luxoft представлен в москве санкт-петербурге омске нижнем новгороде и дубне мы вносим большой вклад в развитие автомобильной индустрии наши эксперты по встраиваемым системам ведут разработку автономной системы помощи водителю которая объединяет в себе компьютерное зрение фокусирование на модели окружающей среды и другие направления идет работа над проектами тире ток к ап5 включающими unix дизайн и создание платформ и чем а и для производителей автомобилей премиум-класса активно развивается и направление держал инженеры который объединяет в себе проекты в таких отраслях как энергетика медиа здравоохранения ритейл и логистика телекоммуникацией и туризме мы постоянно расширяем нашу экспертизу в облачных вычислениях до vox машинном обучении искусственном интеллекте системах интеграции блокчейн специалисты нашего финансового направления выполняют крупные проекты для международных банков и хедж-фондов мы предоставляем клиентам эффективное решение для анализа и обработки моделирование и проектирование данных которые дают дополнительные преимущества для бизнеса заказчика люксов также активно вкладывается в развитии своих сотрудников this ой а мир нару а привет я артем я бывшие до краха бы сейчас вы подкаст мы обречены при этом знакомиться приятно познакомиться меня зовут ольга и я занимаюсь в компании компаний безопасности приложений безопасностью приложений это что-то особенное не как сказать что-то особенно я стоял где-то такому важному моменту который связывает собственно мир разработки и меры безопасности потому что зачастую как решаются себя себе люди делают безопасности это ребята которые не знаю периодически запускают какие-то сканеры и узи масти и дальше приходит предположим к ребятам инфраструктуры со словами ребята у вас здесь не знаю какое нибудь узел мои приложения но обычно эти со сканера связанные с безопасности vendors кого по если не знаю вы предположим на капельку им тапочки он может быть старой вес если у вас есть компании своей разработка то разработчики пишет уникальные уязвимости которые сканер уже не найдут обычно это есть предположение знает о дженесс с которыми пользуется большинство компаний для удара бдительно нужен при собственно вот я пытаюсь внедрять различные практики безопасные разработки поиска узи масти собственно в разработке который ведется в компании работает и в чем заключается процесс какие мы пользуемся различными во-первых с камерами которые именно сделаны для практичности курить это статический анализаторы к 1 безопасность мимический анализаторы код для безопасности различные сканер зависимостей которые проверяют какие вообще фреймворке какие библиотеки используются и все или там хорошо с безопасницу также пишите свои большие инструмент или слизь какая-то специфическая позже логика который не может осилить динамический анализатор из коробки то есть предположим тот же burgs youth networks юта прокачивали burgs enterprise они не всегда могут качественно проскочить на безопасность то есть например динамический сканер как работают они отправляют какие-то нелады с кавычками и дальше смотрит такой ответ пришел и не всегда таким сканером предположим по зубам какие-то специфические приложение какие-то специфичных запросы и предположим одних мы пишем код свою логику и также проводим ручное тестирование потому что 1 делает безопасность когда не знаю какой нибудь кавычки ты можешь зайти под админом другое дело то что есть должен какое-то бизнес логика и предположим она может немножко несерьезная реализована и уже предположен какого-то типа узи масти надо проверять рука ну и также проводим какие-то тренинги и пытаемся всячески просвещать разработчиков помогать правильно составлять с техническими заданиями и консультировать на каких моментах чем мы могли подумать как это сделал безопаснее на моменте именно дизайн ну вот именно когда ты проводишь кафедре view года так а вообще существуют что ты учивший бочков как писать код так чтобы было безопасно чтобы не было уязвимостей мы проводим тренинги с точки зрения любви кода мы спали используем подход грей бокс тестирования когда мы одновременно имеем исходный код приложения положим понято дебаг режиме и дальше предположим отправляем поднимаем приложение локально подключаемся к и брешке и дальше смотрим а как же себя пойдет тот или иной пилот который мы отправились клиента и как он пройдет в приложении вот примерно с точки зрения такова ревью на безопасно ну плюс поиск каких-то типичных небезопасных функций который практически во всех языках программирования есть различные магические методы и валы которые не плохая идея использовать мало разработчики периодически во всех компаниях что-то использовать бездумно хотя не знаю вы х мануале к их языку написано что ребят если вы это используете на десять раз по дому но не всегда там устроит 10 раз подумайте собственности такие функции мы тоже ищем глазами если предположим по каким-то причинам с этим не справилась как статический анализатор но чаще всего статические анализаторы справляются с таким review еще мне кажется или часто встречаю такое отношение к безопасности что это ну какие то просто формальности перестраховки паранойя нет ну я в принципе наверное могу конечно согласится штаты перестраховки паранойя но если у вас есть команда песен security который занимается именно безопасностью вашего приложения вашего кода то мне кажется разработчикам если они научатся дружить и правильно понимаете эту команду станет легче жить потому что куда наверное проще когда теперь принесли уязвимость которую нашли еще на стадии тестирования над столицей jar чем когда какой-то хакер вывести ты знаешь что-нибудь через приложение перебежит бизнес а посреди ночи сослали надо срочно что-то фиксить мне кажется ну без опеки шекспира помогать чуть спокойнее жить разработчик ну вот как на твой практики до них это доносить как мы это объяснять приходится на самом деле в большинстве твоем я сталкиваюсь с разработчиком которые сами хотят вникать и сами разобраться потому что очень быстро до людей доходят то что если самостоятельно в этом всем разобраться если самостоятельно вникнуть и приходить ко мне по любому вопросу и консультировать то скорее всего у них получится написать безопасный код и и когда он едет для меня что м а там уже будет минимальное количество проблем и им не придется это исправлять здесь же есть какие то еще не только какую потребность безопасности какие-то еще требования регуляторов например да конечно конечно требование от регуляторов есть мы например у компаний сионистском planning и мы собственно должны использовать вот все что связано с жизненным циклом безопасно работ это и нам статическими завтра динамически это можно подходить к этим требованием абсолютно по-разному и соблюдать их по-разному мы стараемся дамы эти кривые соблюдаем мы но мы стараемся делать больше чем требует регулятор потому что же больше очередь да потому что это надо не для того чтобы быть все действия компании да понятно это надо делать но в первую очередь это безопасность которую влияет и на нас и на наших клиентов и мы хотим предоставляете качественно безопасный продукт может быть расскажу как именно до скиллами будут что будут заниматься тем чем ты занимаешься наверное понимать собственно как пишется код как работают приложение понимать собственно как работе база данных как строится запросы как наверное работает уязвимостей общем и целом как как работает в моем случае приложение потому что надо во первых еще но не определенную фантазию и наверное при желании бесконечное желание узнать что то новое ну вообще звучит вроде как что это надо уметь чтобы уметь разрабатывать тоже и между может 10 особенности чтобы именоваться иметь нюх на безопасность и если я ними наверное сложно про это судить а потому что опять про себя и про друзей и коллег но я наверное мне сложно сказать если безопасники чем-то отличаются но возможно это просто специфически специфическое мышление с большим желанием что-то сломать но она но мать она опять же без с одним желанием что-то сломать мне кажется для их нельзя а поскольку надо еще понимать собственно как написан код потому что одно дело отправлять кавычки блага боксом когда ты видишь незнакомец этих и просто кидаешь кавычки другое дело разобраться и распутать общее а что же происходит на бы может быть даже небольшой короткий ликбез такой вкратце пару советов как писать так чтобы у тебя было меньше вопросы к разработчикам у меня было ну такие основные его наверное самый главный совет это хорошо знаете язык на котором ты пишешь если есть какое-то сомнение по поводу использования той или иной функции пойти и еще раз прочитать на сайте посвященному языку про это например для php в большинстве большинстве функции если они предположению безопасные тот же on сериала из большими красными больших большой такой текст выделены красным или были сказаны не использовать эту функцию если бы именно не понимаете что она делает не понимаете как сделать я безопасный наверное основное то самое главное просто хорошо знать язык и также читать материалы про то и же такие специфичные для этого языка и вообще насколько то чтобы хакерские скилл и прокачано безопасника так интересно грань что вы теряете и другие должны иметь и уметь что-то похоже но мне кажется что хорошо запасников должна быть очень хороший хакерских строить потому что в любом случае когда а ты работаешь внутри какой-то компании и занимаешься значит и если ты не понимаешь как ломать при вряд ли поймешь как защищать и туда так ну ладно спасибо тебе за рассказ пусть расскажет пишут безопасный код и чтобы проблем было поменьше и возможно когда это это больно отличная это было воли свиридова из и компы можно ей поаплодировать туда вдаль там где она сейчас кстати и кампинас генеральные партнеры можно тоже поаплодировать если вы не бы лично на их стенде подойдите пожалуйста ну как минимум обняться испанское за то что конфа продолжается это международный провайдер платежных решений но и все кто платить через интернет много раз от логотип конечно видели я сегодня увидел их логотипов с другому потому что знакома александр мы ждали тебя александр тобой вконтакте 15 лет коммерческой разработки хотя ты выглядишь на 18 вот так хорошо сохранился и конечно мы все ушли в видео где то год назад и все что про это можно знать хорошего или плохого следующем докладе успехов готовьте вопросы а мы приготовили подарки и саша приготовил подарки и прекрасно что у всех для всех очень все было дырки и так всем привет сразу начну наверное с 2 приятных объявлений нас ждет невероятное количество красивых красочных слайдов все стуле расставлены у нас через одного поэтому если есть возможность присаживайтесь ближе не стесняйтесь места есть желательно чтобы все смогли видеть второй момент что у нас есть призы есть призы от highload есть призы от вконтакте за лучшие вопросы по этому еще один повод присесть ближе чтобы задать лучшие вопросы и получить приз итак три-два-один мы начинаем и так уже меня представили меня зовут александр и действительно 15 лет коммерческой разработки 25 лет программирования 10 лет разработки media service of a сегодня мы поговорим про платформы видеоконференций ну чтобы еще наверно добавить у меня информации я отвечаю за техническую часть вконтакте и отвечаю за единую платформу звонков почему сегодня про видеоконференции ну наверное все знают началась пандемия и нам надо было где-то разрабатывать общаться и мы решили сделать свои звонки ну конечно нет если посмотреть на соответственно графики которые нам дает то пение bloomberg все говорят что с момента пандемии у нас возникло невероятно потребность в видеоконференциях которое вот на всех графиках отражается большим количеством инсталляций и соответственно мы тоже как бы хотим быть в тренде и вот это все вызвал большой интерес на самом деле в бросить в вопросы и большой hyip вокруг видеоконференции у меня многие коллеги спрашивают друзья знакомые китай сторонние стартапы постоянно как устроен зум как устроен clubhouse что мне взять для моего сервиса звонков как не ставить звонки в мой сервис вот на самом деле ровно поэтому мы решили еще пообщаться сегодня прозвонки если посмотреть наверно на все крупные сервисы они уже все обзавелись звонками появилась масса стартапов за последний год давайте посмотрим как вообще крупные сервисы работали с именно видеокоммуникации что запускалась началась пандемия в discord удачно покрутил свои настройки и увеличил количество участников в чате до 50 воцап тоже переделал немножко layout и смог выжить со своих звонков 8 вот как видно все крупные игроки стали торопиться и запускать свои сервисы clubhouse вышел без android google мид запустился бесплатным зуму снял ограничения на 40 минут потом правда вернул но как бы вот видно что каждый месяц буквально в течение года да сейчас у нас постоянно выходят новые новые апдейты звонков различных сервисов сервисов коммуникации все остального вот в марте появились видео звонки на десктопе воцап а еще в мае нас обещают telegram побаловать групповыми звонками у нас групповые звонки были давно и так же как и все будет будучи в тренде мы на пандемии запустили групповые звонки на 8 потом на 128 и в этом году планируем сделать на тысячу а про что мы сегодня с вами все будем разговаривать начну на самом деле с такого немножко отвлеченного рассказа мне один candy дат на собеседовании сказал что он посмотрел мой доклад про сети кстати кто видел мой доклад про сети отлично много много людей вот и он сказал что ему это очень помогло от собеседовать в большую крупную зарубежную компанию вот и пройти собеседование поразить интервью вера я внушительно здорово что не только рассказывать о том как мы что-то внедрили но и рассказывать еще теорию которая на самом деле позволяет вам внедрить что-то свое альтернативное поэтому сегодня будет много теории начнем вот так вот что здесь куча страшных слов которые на самом деле к концу моего докладываю все будете знать это к план доклада мы начнем как я сказал с теории потом рассмотрим на практике внедрение звонков вконтакте посмотрим как перейти на решение для 1000 и больше участников посмотрим мы конкуренты различные трюки немножко посмотрим на open source и на то как внедряется им или звонки но и общий подход к созданию таких сервисов дисклеймер все из цифры по конкурентам полученные на самом деле путем общих наблюдений и измерений мы никого не реверс инженер или ну в общем стандартный подход к разработке любых сервисов сначала надо понять что хотят пользователи если вы крупная компания можете провести маркетинговые исследования компания поменьше ли стартап проведите коридорные мы такое исследование провели и заметили что пользователи хотят много чего важно важного но самое главное это качество то есть все же все пользовали различных видеозвонков жалуются на качество ну и конечно все всегда все хотят бесплатно среди жалоб основная история была на плохое качество видео на нестабильность на зависание на греющиеся телефоны взлетающие компьютеры не комфортное общение как есть мы проанализировали конкурентов посмотрели у кого что есть на самом деле как он видели на предыдущих слайдах самые крупные растущие зуму и google нет у них на самом деле отличаются большим количеством участников может быть это и не нужно но потенциальная возможность что вашей встречи соберется тысяч людей это здорово вот почти все крупные сервисы поддерживают все возможные платформы звонками по ссылке сейчас никого не удивишь демонстрации есть почти у всех ну и запись там виртуальный маски и вся история такие-то комплементарной истории какой то супер серебряной пули конечно же в этом месте нет мы выстояли для себя требования неограниченное количество участников почему бы не потягаться работа на всех платформах и низкое потребление серных ресурсов почему ну мы на самом деле комплементарный сервис нам нужно балансировать мы не можем совсем там идти в решении которые вам дают он прием сервисы но с точки зрения стиля это высокое качество звонков стабильность очень просто сделать крутые звонки дал чтобы формализовать такую задачу нам нужно ножка разобраться в теории и так на самом деле любые звонки состоят из трех уровней первый уровень это наверно signaling это уровень бизнес логики в котором вы как-то сами подключаете ваших пользователей координируйте этих пользователей и дальше устанавливается некоторые сетевой уровень сетевой канал между ними через который же будут передаваться видео и аудио данные если говорить про signaling то у него задача аутентификации там установки соединений списке участников блокировки зал ожидания все остальное похож на волю ближе всего нам какой-нибудь массажер на выпсуке тем которая мне к все писали сохранением состояния всего остального сегодня мы будем мало про него говорить про сетевой уровень так как я видел что много людей видели доклад про сети быстренько пройдемся значит так мы говорим про real-time коммуникацию прозвонки то все конечно же будет пройдите про минимальной задержки вспомним чем у нас характеризуются сети вы отправляете какие-то данные в сеть они разбиваются на пакеты приходят на клиент с каким-то прорежем нам времени на эти пачка пакетов если вы сложите весь размер пакетов поделите на время получить некоторые бенглис это пропускная способность сети если у вас на пакет есть так много джамин подтверждающий что в этот пакет видели ну или pink например вы делаете эхо запрос датой строя теперь получаете ответ то вот это время ттт ну и наверное еще важно история по которым будем говорить это пакет лосс вы отправите пакет он потерялся wendy's будем мерить кило битых мегабитах в миллисекундах packet loss процентах какие у нас еще будут дополнительные истории round trip и на самом деле пинку это случайная величина можете пинговать хайло тут я сегодня утром это сделал вот pink вот так выглядит не знаю что там нас с вайфаем или еще с чем-то но pink вариативной и для оценки его вариации используется джиттер джек и у него есть разные механизмы измерения мы меряем его как мне минимальную максимальную задержку между пакетами есть некоторые там иры всей которые мере чуть по другому но нам было интереснее видеть это так очевидно что когда у вас пакет и приходят группируются пачками вам нужно как то с этим бороться чтобы с этим бороться у вас есть некоторые джиттер буфер который собирает определенную пачку пакетов и выдает и равномерно ну например у нас вот пролетел один пакет предположим в пакет обычно voip вкладывает в пакет например 20 миллисекунд аудио вот вас прилетела 20 миллисекунд а где вы их проигрываете у вас задержалась пачка пакетов вы проигрываете тишину потом пролетела еще пачка пакетов вы играете но вы начали уже там на вот это отставание в 40 миллисекунд стабильно отставать вот ваша задержка вот вы отстаете в принципе вот джиттер буфер примерно так идиотом компенсирует эту задержку следующая история про которую мы поговорим это как бороться с потерей пакетов здесь вас помогает farther correction или избыточное кодирование кто видел так вот просить история буду ускоряться все равно на вам придется тоже послушать вот вы добавляем дополнительные избыточные коды например можем просто показать пачку пакетов добавить к ссор если у вас пропал пакет нам пришел к ссорам можете его восстановить особенность у вас дополнительная верха и даже если пакет они пропали и можем чинить только фиксированный процент если вы заложили допустим там оверхеды 3 процента то есть у вас пропало 4 процента вы его не почините фиг очень удобно комбинировать знаком с негатив окно выжми там что происходит вы отправляете там три пакета 2 дошли один пропал посрать 4 5 пропал после этого у вас пропал пакет после там пришел 5 пакет в у вас два пропали один починили все com1 не знаете что делать починили на ком солью быстро ускорился вот соответственно вот в этом месте можно чинить негатив окно лучами там пакеты чтобы делиться срал чтобы бороться с раунтри пами надо использовать на самом деле сидена вряд ли вам что-то еще пазу поможет мы стали мм сервера в разные города но тут надо еще знать некоторые особенности работы операторов например если вы пытаетесь найти пир toupper соединения кто-то кому-то звонит из владивостока по вайбу на пир toupper соединение то в разных мобильных операторах может получиться что звонок про это через москву для того чтобы это починить для наших пользователей мы устанавливаем седины которые перем с разными операторами и мы можем например в этом случае запустите этот звонок через хабаровск или новосибирск метрики сети понятное дело что зачем вам рассказывал про сидел метрики сети будут у вас разные это зависит от дел распределенности ваших пользователей от того как у вас снова на сервера но вот покажу наши цифры для оценки больших цифр когда у нас большая аудитория мы обычно используем перцентиле мы оцениваем медиану то есть среднее значение у нас здесь все хорошо он 140 миллисекунд довольно короткий и например 99 перцентиль что он говорил с 9 перцентиль в 550 миллисекунд prt значит что у девяносто девяти процентов пользователей ртт звонках меньше 150 миллисекунд и мы для себя решили такое требование что наша задача работать хорошо ну или вообще обращать внимание на 9 процентов пользователей у нас все эти вот примерно такая то есть я сразу призыв цифры продвигаться процентили проговорю у нас 10 процентов укладываются 550 или секунд у них интернет есть хотя бы четыреста кило бит у них пакет лосс два и два процента или меньше и у них на самом деле джиттер см10 секундах посмотреть разницу между пакетами то может доходить прям до 1 4 секунды наверное стоит отметить вот мы говорили prophet инок что при таких сетях когда у вас маленький пакет лосс но большой ртт вам выгоднее чиниться веками что мы быстро узнали сейчас за сетевой уровень что сеть данные передаются в сети пакетами там есть бен дэвис ртт пакет лосс все значения меняются во времени в зависимости от того как распределены ваши пользователи распределён ваш сидит у вас может происходить такая ситуация что одно и то же самое развернуты решения звонков разных условиях будет работать лучше или хуже с точки зрения вас вам необходимо смотреть на цифры на перцентиле не смотрите на средне вот но и для компенсации джиттера есть джиттер буфер для компенсации лттб ndsm используем сидена для работы с пакет лоссами у нас есть алгоритм эффекты на перейдем дальше к следующему лиру мы уже здесь прошли signaling прошли сетевой уровень и теперь аудио и видео история и так теория с аудио по планам большой сложной но собрались оставили все будет просто 1 наверно часть которая срабатывает при начале звонка это хак insulation ну или aig акустика х consolation в чем его суть предположим алиса звонит бабу борису алиса звонит борису вот у алисы все хорошо с echo cancellation а мы вот у бориса плохо он у него не работает что происходит от алиса начинает слышать себя обратно то есть если вы слышите себя обратно проблема не у вас у вас есть звонке какой-то пользователь у которого не работает echo cancellation вам нужно срочно замьютить наверное на удаленке вы уже все с этим столкнулись и научились их находить следующая история которая в аудио pipelines всегда встроена неотъемлемой относится прошин в дело в том что микрофон и ваших ноутбуках стоят рядом с вентиляторами если туда от туда забрать оригинальный звук то вас вас будет просто не слышно поэтому есть ах подавления которое дарит давид разные шум и белый шум розовые все остальное вот следующая история этого из activity detection он говорит вообще оценивает говорите ли вы в этом интервале времени или нет если нет голос это очевидно можно экономить его можно не передавать на сервер вот и дальше у нас game control это история с тем чтобы у всех было примерно одинаковая громкость мы отправляем эти пакеты кодируем отправляем в сеть на другой стороне когда вам что-то говорят вам сразу все приходит по сети тут отрабатывает жить трубу фирмы про него уже поговорили и дальше вы можете что-то починить догнать time стретчинг вот дальше попадает на audio mixer вашей системы если у вас много говорящих он smack суеты всех ну и собственно вот про компенсацию задержки вспомним про то что был джиттер буфер который нам создавал задержку то есть если носки ты пакеты по дергались он немножко отставал у вас появлялось задержкам звонки вы могли друг друга перебивать что можно сделать с тем чтобы ускорить задержку починить эту задержку самое простое это ускорять тишину то есть если у вас хороший ватт вы можете ускорить тишину вот склеить просто слова и на самом деле все чем лучше ваш вайс детектором тем лучше вы склеиваете это слова но если вы ничего не можете склеить то вам надо ускорять голос он будет немножко гномика чтобы этого не было есть специальные алгоритмы можно посмотреть мы например сонник используем с точки зрения кода к аудио обычно используется опус он хорош тем что он на всем диапазоне частот показывает хорошие цифры у него низкие задержки прах есть такая еще интересная история пакет лосс консилмент внимательный человек заметил что один пакет на входе джиттер буфер 4 он пропал если у вас потерялся кусочек например длиной 20 миллисекунд его можно придумать вот на самом деле на исходя из вашей речи очень довольна проста коды корпус может 20 миллисекунд придумать так что будет довольно незаметно дальше это будет уже странные эффекты вот чем мы запомнили что пойти класс консилмент маскирует потери пакетов его не надо путать например с веком потому что фиг вам добавляет избыточное кодирование это по сети дорого это опасная история opel все это довольно халявно из 20 миллисекунд используйте тире проговорим право time стретчинг про гномиков и про ускорение представьте такую картину вот слева это вам приходят пакеты пакета приходят задержкой 20 миллисекунд от пользователю потом у вас случился какой-то стол мачта залипла и потом они пришли пачкой как вы их будете поигрывать сначала вы их проигрываете нормально по 20 миллисекунд потом у вас остановилась все у вас нет пакетов но через plc один пакет починили что-то придумали хорошо дальше у вас тишина вы здесь делали feydau аккуратно чтоб щелчка не было и стоит после этого у вас пришли пакету вы их начали проигрывать здесь у вас задержка проигрывания пакетов стал уже не 20 миллисекунд a80 если вы очень долго происходит играете с задержкой у вас все хорошо то возможно вам нужно ускориться и здесь вы включаете ускорение вот для всего этого придумано не который джокер буфер он на самом деле у каждого voip инженера есть свой кастомный дресс тический джиттер буфер который делает это хорошо и он всегда является балансом между light неси искажениями и того мы поговорили про echo cancellation про на из сопряжён право ты гей про of the game вот поговорили как у нас ускоряется что это некоторый баланс поняли что выгоднее всего догонять на тишине ну и опус умеет для нас и пил сейфе перейдем к теории видео а тут буду максимально быстрым у нас видео состоит из кадров кадры есть опорные то есть когда у вас кадры на сангли картинка и кадры есть который кодирует div вот опорный кадра вот div когда у вас кадир столько изменения для аудио звонков на наверное интересная история с тем что есть айфрейм и вы раздаете сигнал всем например пользователями если у вас групповой звонок и кто-то подключился в середине между вашими ой фреймами все что вы может увидеть только div у вас распадающейся картинка просто будет поэтому нужно подождать некоторые следующий кадр это будет серьезная задержка для этого того чтобы этого не делать есть фулл интро request фирм это некоторый запрос которым позволяет генерировать опорный кадр минус очевидно опорный кадра весит больше чем div и про кодеки много разных интересных кодеков все они отличаются тем что некоторый баланс между батареей сетью более современные больше вам потребляют ресурсов менее там более старые они более экономичные к вашим ресурсом но требует больше пропускную способность сети того поговорили про кодеки поговорили про запрос опорного кадра поговорили про то что такое фреймы и опорные кадры в целом правой партии наверное многие из вас сталкивались и без этого наверное никак не сделать звонки если вам нужны браузера это некоторый открытый стандарт который реализован во всех браузерах которые в себе реализует сетевой уровень и аудио-видео pipeline он не реализует никак вашу групповую топологию не как не накладывает на вас некие ограничения и того весь звонок состоит из того что ваши пальцы подключаются посигналь инга устанавливать транспортное соединение обмениваются кодеками начинают кодировать аудио-видео в этих кодеках отправляют адаптируются чинят меняющейся ваша динамичную сеть компенсирует задержки классной видеоконференция все очень здорово но все пояс или жаловаться говорят 80 процентов исповедовать хочу качественные что это давайте потом как это оценить самый простой способ это отправить сигнал забрать сигнал ну и на самом деле как померить качество до на самом деле просто опросить пользователей например стандартной метрикам усвойте это оценивают качество пользователей новые качества звонков оценками пояса ли они от одного до пяти ставят на сколько им понравился запрос это некоторое среднее для того чтобы каждый раз не проводить большие опросы после вашего очередного эксперимента есть различные алгоритмы которые повторяют действия человека наиболее классная история с низко это алгоритм нейросетевой специально обученный на большом do to say that deep links обученный на большом dts эти вот я буду сделать ссылки на писк потому что для если есть voip инженеры они понимают что это но на самом деле внутри мы пользуемся низкое она более клёвое про групповые звонки и типологии вот мы все рассказывали теорию про сети pro audio pro видео и теперь надо добавить групповой звонок какие есть варианты самый простой способ сделать мышь топологию отправить всех всем без серверную например там завод сам так делает в есть варианты нам теория говорит им сию я буду иногда называть миксом когда вы отправляете все свои все свое аудио-видео сервер клеит ваше аудио в одно клеит ваше видео тоже какое-то одно и отправляет всем другим пользователям очевидно вся нагрузка на сервере вы ничего не делаете здорово и некоторые технологии sf и буду говорить и и forwarding она ваше видео вам не нужно доставлять всем клиентам как в мышь дам всем вы отправите только на sera sera за вас и говорит transmitted тоже довольно простое решение очевидно что прям аж топология у вас очень быстро растет в исходящий трафик вы очень много декодируйте кодируете видео для каждого участника это плохо больше восьми участников очень трудно завести на этой топологии если говорить про микста основная проблема это объем циpкa который мы не можем использовать допустим в каких-то комплементарных или дешевых решениях вот и если говорить про sf и он такой компромиссный он с одной стороны позволяет вам экономить ресурсы на клиентах с другой стороны не сильно нагружает сервер на что ещё стоит обратить внимание это на количество участников теория нам говорит что в миксе вы ограничены только тем сколько вы сможете смягчить а например в форт топологии проблема в том что клиент миксер mixed аудио всех говорящих и довольно дорогая история и в партесь и например вам может в браузере позволит вам максимум 50 участников по мексике ошибки выбор топологии если вы это прочитали то вот меж завести на количество участников больше чем восемь крайне сложно топология без серверное это тоже очень трудная история как говорят что может дать свои видео потом другому вот так тоже не нужно это хорошо работает для торрентов для real-time коммуникации это не работает ну и попытка запустить вой поверх тисе пи тоже странная история сейчас уже меньше одного процента сетей не поддерживают и т.п. вой поверьте себе работает если у вас 0 пакет лосс у вас нет джиттера у вас константный битрейт будет работать если вдруг у вас есть остались вопросы можно посмотреть вот этот доклад это как раз тот доклад который помогает проходить собеседование отлично теперь он оставили попробуем для нас уже некачественный вопросы сделать классные звонке для нас попробуем ускорить и понять что с точки зрения разработки как формально выглядеть наша задача нам нужно минимальную задержку обеспечить что боретесь друга не перебивая нам нужно минимальное искажение минимальное потребление ресурсов на клиенте нас влияет эта переменная сеть на пользователи устройство браузер доступные ресурсы на клиенте количество участников звонки на что мы влияем у нас есть сетевые алгоритм у нас есть аудио-видео кодирование нашей кастомные джиттер буферы чтобы различные типологии то есть на самом формально функция выглядит так многокритериальной оптимизации задержки искажений употреби ни ресурсов на некоторым переменах иксах которые есть у вас это различные условия сети устройств и так далее ну это чем вы управляете это различные алгоритмы которые вы можете кодировать для себя мы ограничиваем x некоторым дело с девятым перцентиль им считаем что мы должны работать на 99 процентах хорошо ну что теперь можно делать сервис потому что мы формально определили задача разобрались с теорией в сервисе будут встречаться такие tricky что если зоны зеленое то вы можете просто брать это и применять если зона желто этого надо аккуратно смотреть на метрики расскажу почему и будут сложные трейдов и и перцентиле где нужно будет реально выбирать уже с точки зрения вашей аудитории и так топология для передачи аудио мы можем использовать простой forwarding отправлять всех участников всем другим но если вас много людей говорит то у вас будет высокий входной трафик предположим до четырех участников это четыреста кило бит ну вот вам придется их всех де кодировать и выполнил что декодирует больше плести не получится возьмем попробуем сделать микс возьмем соберем всех участников в один аудио поток но тут мы если мы просто это аудио поток отдадим обратно то получит такая картина что вы услышите себя возникнет эхо поэтому на самом деле поставкам из микса вали всю там тысячи участников конференции нам нужно вычесть вас персонально для этого простым вычитанием на самом деле для того чтобы вы не услышали эхо что еще мы вспомним джиттер буфер который у нас выравнивать пакеты по времени который догоняет если нам нужно задержку компенсирует может чинить через пенсий эффект и теперь сравним с if you и эм си ю то есть forwarding и mix когда вы просто for одеть пакета через сервер вообще на них не смотрите в их отправляете клиенту и все вот эти алгоритмы джиттер буфер оказываются у вас на там телефонах ваших клиентов если вы делаете микс то вы собираете джиттер буфер у себя на сервере собираете один поток отправляйте клиентам 2 джиттер буфер один на клиенте который компенсирует проблемой сети другой у вас на сервере с одной стороны 2 джиттер буфера должны внести большую задержку с другой стороны вы починили на одном плече если вы сервер починили плечу от клиента на этом же тир буфере отправили клиента клиент починю другому то есть оставили не очень страшно вот мы у себя использую микс мы всех пакуем в один поток у нас есть кастомный джиттер буфера твой инженером вот правда у каждого свой все извращаются как могут на де конинк всего этого аудио и видео мы потратили не очень много ресурсов меньше десяти процентов от циpкa задержка у нас в целом не возникает в микс вы просто складываете пакет это вообще дешево вот ну и джиттер буфер задержка джокер буфер сервера будет зависеть от там клиентов обычно она у нас там 60 миллисекунд медианы теперь всякие audio track если вам нужно вообще улучшить звонки то внутри бы партесь и есть некоторые audio network adapter у которого есть очень сложный конфликт спарта баффи я просто ссылочку оставлю где можно его посмотреть и подтюнить он позволяет настраивать разные вещи она позволяет настроить адаптацию аудио битрейта позволяет настроить эффект позволяет не отправлять пакеты если участник молчит вот с чего низкого битрейта можно в моно перейти если у вас уже там не знаю все десять кило бит давайте можно отправлять вот если это все аккуратно по тюнить то что написано можно очень дешево прям на ровном месте выиграть снизить у себя packet loss round trip отправлять меньше данных в сети вот это очень дешевая история которая нужна вам в любых звонках двинемся дальше посмотрим на то как мы делали аудио pipeline классические pipeline мы рассмотрели в теории здесь мы заменили две истории одного из аудио detection in as the profession и решили отойти в классических алгоритмов в партесь и которые есть в партесь и в аудио детектор сделан на голосовых моделях довольно старая история и шумоподавления тоже у нас эвристическое но мы знаем что чем меньше у нас мы передаем трафика то есть если у нас хороший ватт который хорошо определяет когда я говорю когда тишина и у нас хороший но из опрошен что я чего-то где-то создают шум вот шум любимцы вырезает вот там и меньше времени тратим на микс меньше передаем данных это все очень здорово поэтому стоит вложиться в свой нойса брошенный wait wait мы сделали на градиент на мбуз тенге отыграли у в партесь и порядка тридцати процентов по передаче данных то есть мы зафиксировали ложный reject голоса на одном проценте то есть решили на потому что один процент голоса мы там можем предъявить в тестах вот и при этом в процессе пропустил там 80 процентов шумов 83 вы пропустили 55 целом не так просто отличить голос от шума ну правда тесто сложные были шумоподавления наверняка у каждого есть сосед а вот с первой картинке вот которыми что дрель отпилит и вот это все он мешает не только вам но и обычно еще людям которые есть в вашем звонке дейстительно давайте попробуем подавить шум но на самом деле шумоподавления очень трудной задачи у нее высокие требования нам нужен real-time желательно на клиенте и задержки очень минимальные мы при этом хотим чтобы наш шумоподавления работала на уровне state of занят решений например reference есть креспо и очень классное решение можете посмотреть который вам позволяет подавить шум ну и при этом мы хотели чтобы это все работало на мобильных телефонов нам нужно было минимальная модель размер модели и минимальное потребление циклу мы взяли некоторые исходный сигнал мы его сильно зашумели для тестов собрали конечно большой dtc тут это все посмотрели как работать в процессе то есть от исходного сигнала наше качество пользовали говорил оценивали крайне плохо 1 из 7 в партесь и там чуть-чуть улучшал эту ситуацию ну и мы взяли dlna не рассеять обучили все классно вы получили хорошие цифры наверное сильно не вдаваясь в историю модели у нас получилось порядка 5 мегабайт мы ее скачиваем on demand мы и подружились опусом и в этом месяце обязательно напишем на хабре статью про то как это детально сделать какие даты с это использовали чтобы все могли это повторить наш эффект от внедрения своих кастомных ваты и но из опрошено мы сэкономили для пользы 30 процентов аудио трафика мы теперь 60 процентов случаев стали меньше заниматься искажениями гномиков когда вам нужно очень быстро говорить чтобы люди быстро отвечали наши запросы потому что вас вот на самом деле потому что ваш ватт не за детектив паузы в словах и на самом деле следующая история это то что мы увеличили на самом деле качество разговора с точки зрения метрика пользователя где тут можно подорваться можно подорваться что когда мы запускали наш клиентский шумодав мы увидели такую странную историю что у нас выросло из починка на сервере искажений то есть починка lightness искажениями то есть на самом деле мы посмотрели чуть глубже увидели что нас вырос джиттер с клиентом то есть на самом деле когда вы немножко нагружаете сепию на клиенте у вас очень быстро на него появляются вариация задержки появляется джиттер это история связана с тем что у вас или кода генерирует гетеро или сетевой стек если у вас цепью загружен поэтому самое важное это бык пряжу по себе you то есть когда вы запускаете различные шумодава на клиенте всегда смотрите за какое время в процессе ли тот или иной фрейм чтобы быстро отключить это шумоподавления если реально например на телефоне садится батарея он вам в реально резко режет ресурсы и мы ужинали не справляемся вот что мы получили у нас аудио pipeline меньше десяти процентов на пользователям мы растим качеству уменьшаем трафик все здорово вот мы померили наши задержки наш сервер там в медиа не за 60 миллисекунд перекидывает видео и аудио перекидывать на клиентов в перцентиле за полсекунды вот у нас довольно дешевый всего 20 миллисекунд константы но это все как бы очень здорово но надо понять в общем и такие классные сток всего намутили что относительно конкурентов ну для того чтобы измерить нас с конкурентами нам пришлось сделать вот такую сложную схему мы просто взяли соединили подключились к телефонам через джек отправить до аудиосигнал забрали оттуда и сигнал из динамика ну и соответственно в один телефон что-то говорим другого забираем сравниваем эти аудио сигнал и меряем между ними лейтон си ее мозг для десктопа существуют такие вот утилиты которые вам позволяют соединить ваши аудио-видео через драйвер вам не нужно вот ничего хардвар наделать сравнили нас с конкурентами оказалось что у нас получилось минимальная задержка очень хороший moss 9 что мы дискорда здесь проиграли вот и еще дополнительно добавили метрику количество в ряд изменений задержки то есть это сколько раз нам приходилось что-то склеивать одиннадцатом и что-то искажали мы просто допустим склеивали тишину очевидно что наш джиттер буфер стремится к минимальному лейтон си но при этом мы иногда часто прыгает теперь вспомним теорию нашего топологии нам говорили что если мы что-то миксе много кэнди то это будет долго лучше просто прокидывать пакеты и там клиент разберется с другой стороны мы помним что если прокидывать пакет этого клиента все придется миксовать и он больше кисти не сделает теперь если мы возьмем в партесь internals посмотрим как работает google нет то окажется что он миксер если мы почитаем статьи про гугла разум они скажут что они все for added идут вот странная история мы все это померили нашими интересами получилось что google мид несмотря на что миксер аудио на сервер оказался самом минимальном полотенце ozum который вроде как по всем статьям у нас forwarding прокидывает просто пакеты он оказался самым медленным другая история что зум вроде как forwarding по пакетам но по документациям но при этом у него максимальное количество участников 50 как они это делают но они делают такой трюк они считают что все сразу 50 говорить не будут и отправляют например только тех кто говорит или от кого идет какой-то шум из минусов очевидно у вас битрейт на клиенте растет три четыре пять человек говорит у вас вырастает битрейт вам нужно всех декодировать но из плюсов вот у вас есть такой track что вы можете ничего не миксовать выводы на самом деле микс который в теории может быть медленным на самом деле может казаться быстрее не все у вас решается топологии ну а мы на самом деле внутри рынка по качеству и при этом максимально экономим ресурсы пользователя про видео давите наверно стоит сказать что микс никто не использует это когда вы пытаетесь собрать одно большое видео всех участников это супер дорого поэтому обычно все про используют прокиды вание видео то есть вы отправляете видео она доставляет со всем участникам минус мы уже говорили если кто-то подключился с середины у кого то пропал опорник мы потеряли кадра пропал опорной надо ждать следующего ну или соответственно попросить опорным того кто шлет представьте конференции на 1000 участников у кого то пропал пакет он говорит пришли опорник вы все тысячи отправили ну и следующая история кто-то подключился супер плохим интернетом вам нужно все качества понизить ok для этого и для решения есть например такие технологии как символ каст который говорит давайте-ка мы на клиенте patrons ходим ваши большое качество еще поменьше еще поменьше конечно решают многие проблемы но не все но при этом требует ног клиентских ресурсов есть более крутая технология с висим которая в кодеке говорит давайте-ка мы внутри кодека сделаем качество поменьше сделаем качество побольше что-то поменьше еще супер большое но тоже вам потребляет много ресурсов меньше чем символ каст но и связь и не поддерживается браузерах мы пошли по своему решению мы помним что для наших пользователей очень важно качество с другой стороны мы помним что любое дополнительное наброс ресурсов на ваш телефон несчастные генерирует вам лишний джиттер задержки все остальное поэтому мы решили а под транс ходим мы сервером мы помним что транс кодировать сервером конечно супер дорого но можно сделать такие замечательные интересные наблюдения когда вы выбраны как главный спикер вы большой понятно вы отправляете большое качество если вы где-то поменьше внизу там уже на вас никто не смотрит вы просто слушатель то вы можете править качество меньше ну или кто-то вас смотрит сетки возможно все вообще на вас не смотрят вы просто сидите формально с видео можно попросить вообще клиента нет нет родни отдавать видео высоком качественном говорим клиенту отдавай не больше чем сколько тебя смотрят то есть если ты где так все-таки болтаешься с низким качеством и тебе понижаю можно посмотреть через в партии sentir нулся с на вас никто не смотрит мы вообще в ноль уберем и resolution и битрейт это нам очень сильно сэкономили клиентские ресурсы и серверные ресурсы но и это еще не все рассмотрим ситуацию когда все смотрят на меня в каком-то некотором разрешении кто-то подключился и у него совсем плохое качество сети надо под транс кодировать только в этом случае мы запустим transcode а давайте мы на сервере понизим мои качества и тут мы тоже на самом деле увидим что это нужно крайне редко у нас 40 процентов пользователей вообще не нуждаются транскодирование доставляются просто как есть ему по сути чистый софью но зато мы этим решаем вот некоторые проблемы теперь сравним нас с решениями стандартные софью понятно мало кто использует потому что много входного трафика на клиент собрать все видеопотоки в большом качестве плохо всему кости когда мы транс кодируем все видеопотоки мы всю работу перекладываем на клиента связь эту работу немножко минимизирует но это же дорого мы на самом деле максимально бережем наших клиентов но при этом перекладываем работу на сервер про кодеки помним что кодеки бывают разные кодеки бывают которые что-то работают хорошо на определенных битрейтах и при этом могут потреблять больше меньше ресурсов самое простое это на самом деле переключать разные котики зависимости от условий то есть если у нас например вниз высокая пропускная способность низкий заряд батареи слабый телефон мы можем использовать классические 264 ускоренный на пользователях если у нас плохая сеть мы можем включить saw тварный vp9 который вам по потребует больше батареи но сэкономит ваши сеть повысит качество еще мы научились переключать коды кинули ту и того что говорить про видеосервер мы транс кодируем на бэг-энде транс кодируем только по запросу проксимально стараемся этого избегать если посмотреть на наше время транскодирование очень некая порядка 40 миллисекунд мы вносим latency для транс кожаного стрима если его потребовалось транс кодируется требуется его крайне редко ну и ресурсы на пользователя порядка 04 циpкa на пользователя вот она так делятся между аудио и видео здорово х5 напридумывали кучу всего сложного посмотрим где мы против конкурентов как померить нашу задержку против пользователей и против других конкурентов на наших пользователях самый простой это просто показать таймер в камеру посмотреть через какое время вы пришли фотографировать замерить задержки мы конечно же выровняли сеть до серверов конкурентов и увидели что мы по видео на самом деле быстрее всех вот довольно странно ну то есть или также или быстрее скажу почему есть такой момент синхронизация аудио и видео если как ни странно есть много разных исследований тоже референсных по людям если мой голос будет сейчас отставать немножко от моего видео а он реально отстаёт потому что я говорю в микрофон это лук через динамики вам всем нормально но если мой голос будет вперед видео то я на самом деле начну то вам будет не очень хорошо это будет странно если я говорю раньше чем вы меня видите вот по этим исследованием видно что если вы на 60 миллисекунд раньше воспроизводить и аудио то это не очень мешает зато отставать аудио можно больше можно на стол 120 миллисекунд вставать воспользуюсь этим трюком мы посмотрели сколько у нас он занимает processing аудио нам бы кэнди сколько занимает processing видео все аккуратненько разложили по перцентиль им вычли 1 из другого получилось что в общем-то backend не так и укладывается в этот диапазон поймешь на клиенте может происходить черти-что но мы отказались от лифтинга то есть мы на самом деле отправляем аудио-видео клиент не синко это это время мы рассчитываем на то что она сама где-то будет в этих диапазонах в общем если вы пояс нашими звонками и вам не нравится липсинка у вас вдруг что-то кого-то опережать или тормозит пожалуйтесь мы можем включить но пока нам кажется что так работает здорово теперь самое интересное как по какую архитектуру нужно выбрать как нужно построить чтобы вам можно было выдерживать там бесконечное количество участников у нас три наверное основных группы серверов это сервис signaling где вы подключаетесь просто паук сокета передаете какие-то сервисные данные сервис conferencing где реализован в партесь ее прием медиа вот и сервисы трансформа где-то облачные которые запускают сказал может что-то под транс кодировать делается на лету и всю эту историю кто сейчас где какой звонок processing сделается через гипер как происходит скалирование звонкам предположим алиса звонит бабу если нам ничего не нужно закодировать тому просто алиса может висеть на одном сервере баб не другом они могут перекинуть видео напрямую все есть нам нужно например что тасс миксовать у нас много участников нам нужно под нарезать видео мы в облаке запускаем различные процессы например нам нужно под transcode баба нам нужно смягчить бобы с алисой нам нужно и patrons коде cialis там ее сзади носит не дай бог еще что-нибудь вот соответственно и там и размазываем по любому количеству процессов таким образом у нас нет какого-то ботаника во всей этой истории мы сканируем ся на любое количество серверов звонке про отказоустойчивость но в такой архитектуре наверно добавлю что мы еще закрываем наши сигналы балансирами . вот внутри себя в случае потери сервера вов у нас закипела регистрирует на что перекинуть но и случайно сами к что то выпадает у нас нет такой истории что весь звонок грохнулся потому что он висит на одном сервере у вас одни люди на одном сервере transporting на другом кто-то моргнет где-то отвалился вот но при этом какие то серьезных проблем не будет вот все posing on через закипели ладно про уменьшение latency если вы работаете с медиа внутри дата-центров ну во-первых везде включитесь и пенал delay погуглить с не знаете что это вторая история у нас на самом деле сервера на java и иногда у вас бывает большой gc например может быть время которое latency генерирует вам garbage collector там доходить максимум доходил до 50 миллисекунд мы заменили дживан наши надо это как раз garbage collector ориентированный на минимальные задержки вот и мы уложились в то что наш conferencing который на джаве реализует в вертись и у него максимально задержкам 10 миллисекунд и у трансформа вообще 3 этом оберточка нет нате вам вот jitsi например самый популярный многие наверное знают он у нас тоже на джаве этот трюк ему тоже поможет что еще нужно про тысячу знать конечно 1000 если вы в порто c пойдете скажите у меня 1000 участников звонки на забирай работать не будет вот потому что нужно много декаде raw там каких-то state of всех участников поэтому мы ассоциируем количество стримов ровно под то количество которое вы видите сейчас на экране и делаем замену видео то есть у вас стрим идет перманентной это того участника ну например хотите здесь заменить опять олесуна баба вот в этот момент вы просто говорить о кей я хочу заменить олесуна бабу ставить аватарку баба нужна скроллите меняете вот в этот момент вы просите сервис подменить стрима ли сына бога вот у вас пока висит аватарка вам серы отвечает таймс темпом с которого у вас пойдет в этом же с тремя боб и вы дальше получив этот темп ждете пока он придет возможно вы получите его позже тогда у вас сразу можно включать бабы либо вы получите раньше дождетесь этой задержки вот таким образом у вас получается всего в партесь и максимум там 50 участников но при этом сервер за вас полностью реализует всю логику по переключению этих зрителей и вы можете лимитировать любым количеством участников на сервере сколько ваш сервер выдержит и того же если вы хотите сделать большое количество участников конференции вам нужно научиться горизонтально эскалировать звонок по всем серверам научиться обходить ограничение вы портите paper cone экшеном использовать например мы называем это решение с латами ну использовать какие-то серверные топологии ну и помнить что вам нужно нейросетевой шумоподавлению ватт и прочие истории помним все что у нас есть много эвристических алгоритмов типа джиттер буфера адаптации растягивания аудио и всего остального и стоим нашу формальную постановку задачи у нас было многокритериальная оптимизация на каких-то параметрах и вот того что мы можем поменять что интересно мы на самом деле можем взять и завести некоторые там пример градиентным бустинга построить модель оценивающую качество звонка до того как вы его начали интересный момент да то есть по пользовательским данным того какой у него сигнал например мы здесь видим здесь сверху вниз обозначены самые значимые параметры в модели предсказания качество звонка еще до того как он случился мы смотрим на качество на смотрим на сигнал наверно из важного насколько вы как у вас работала сеть в приложении до того как вы позвонили быстрого стартовали приложение интересные моменты здесь присутствует например среднее количество ошибок на вот этом айпи адрес и за неделю то есть по вашему айпишник у уже можно сразу сказать будет у вас все хорошо звонки или плохо и подтюнить тот или иной алгоритм а для тестирования всей этой штуки мы заводим кучу кучу разных браузеров на virtual как подключаемся некоторым тестом дал чтобы любой разработчик мог подключиться в большой звонок и протестировать различные свои клиенты а ios android веб на производительность наверно стоит отметить что есть масса готовых решений я даже прошелся по ним посмотрел какие в них характеристики и цифры скажу что наверное скалирование горизонтальная дрянь и вам вряд ли обеспечит но если вам нужны звонки на 50 там 100 участников то в целом вы можете взять какой-то open source проект который вам больше подходит по стыку на плюсах на джаве и решить свою задачу общее решение такое что если вы не делаете глобальной сервисной миллионы пользователей у вам не надо больше ста участников можно взять какой-то open source добавить к нему шумодав из готовых например крис вот или использует какие-то готовые облачные решения которые за вас еще и проведут всю работу с селеном с операторами и того что у нас получилось у нас аудитории месячного этих звонков порядка 20 миллионов мы делаем 6 миллионов звонков день всем и это разрабатывали удаленно но пандемии по функциональности у нас сейчас 128 участников наших детей уже позволяет 1000 + вот мы думаем не плохо сними со всеми по конкурировать еще замечу что в течение всего доклады на мы говорили что зумом какой-то по задержкам странные вот чем вообще на все им пользуются тоже интересный вопрос по немножку поанализировать мы заметили что зума очень хорошо работать например на каналах с потерей пакетов 50 то есть пакет лосс 50 через пакет у вас пропадают при этом зум не сильно вырастет вам задержку сможет работать например мы там или google вид на 10 20 процентов начинаем уже страдать в целом очевидно что зум используют топологию которая вам гарантирует минимальный лейтон все но разменивает ее разменивает на качество звука на шумоподавления на работу в плохих сетях вот мы наверное в данном случае решение ближе google метан вот что еще на хочется сказать про а настоящее будущее звонков и про то как извинялся voip вот буквально за последний год нейросетевые алгоритмы появились везде все веристический алгоритмы такие как аудио detection но и сопряжён все поменялось на нейросетевые сейчас уже есть и нейросетевые audio codecs видео кодеки даже качество звонков мы оцениваем нейросетями почти везде у нас м.л. общий подход к решению таких задач ну понятно определите требование сделайте опросы изучите теорию формулируйте задача это на стали очень полезно когда вы решаете не что-то в вакууме когда у вас есть реально формальная постановка определите где вы находитесь относительно конкурентов это очень важно и уже развивайтесь развивайте сервис опираясь на метрики что можно заметить что чем больше вам нужно участников звонки чем больше вам нужно качеством звонки чем ниже задержки тем более сложное ваше решение но самый плохой вариант если вы пойдете вот так вас может получиться такой вариант что вы находитесь на уровне как avanti open source и но при этом и ваше решение супер сложно поэтому всегда сравнивайте с конкурентами смотрите где вы сейчас находитесь и развивайте что у нас сегодня получилась мы с вами поговорили про то как выглядит сеть какими характеристиками она описывается как починить проблемы сети как выглядит аудио-видео pipeline и как можно померить качества в этих звонках немножко поговорили про видео и про какие-то три про разные трюки которые вам могут позволить улучшить качество и также говорим что м л в среднем звонках на от 20 до 100 процентов может улучшить различные алгоритмы классически эвристические что вам с этим всем делать ну можно встроить сервис ваши звонки можно пройти собеседование в курить в команду и развивать чей-то сервис можно например начать свой стартап дали если вы не хотите пользоваться вейпом на самом деле за протяжении за последний год вот мы пробежали то что как изменилась индустрия мы видим что когда появляется какая-то нужда и какие-то там какой-то высоко растущий интерес вокруг каких-то сервисов вокруг него сразу же появляется многое моль решение то есть по сути вся классика вайпа заменилась млм и это произошло буквально вот там за последние годы вот поэтому возможно в вашем сервисе который вы делаете вам тоже нужно подумать и посмотреть может быть нейросети градиентный busting или что-то может сделать ваш сервис лучше да всем спасибо я принес доклад был довольно сложный если у вас остались какие то вопросы вы их не успеете задать или еще что-то можно мне написать на почту или в личку и в течение недели я вам обязательно отвечу сделать это вот ну и соответственно в вопросы из зала как и обещал за лучший вопрос прозвонки у нас будет в подарке с различными мир чем а также подарим прекрасного хомяка сенью и настоящий он игрушка ты как всегда трехчасовой доклад уместил в 50 минут просто красавица отдельные отдельные аплодисменты тебе за это спасибо большое а у нас изменения в программе все вопросы тебе смогут задать только в цифровых кулуарах но зато ты будешь видеть людей не сквозь свет во флориде и сеню там тоже дадут меня там ждет отлично тогда в цифровые кулуары ребята у кого были вопросы прямо за за сашей топ-топ-топ и общаетесь пожалуйста памятные призы от хай-лоу да спасибо большое за доклад а мы продолжим здесь через 15 минут так и и но нару о да а а а вот он ты мы это добрый день добрый день меня зовут александр сергиенко я ведущий разработчик направлении потоковой обработки и больших данных компании neoflex наши компании имеет более чем 15 летнюю историю и обладает обширной экспертизой области финте х банковском секторе сфере кредитных бюро не секрет что этот сегмент а идти является одним из самых технологичных и трепетных с точки зрения объемов данных скорости их обработки time to market масштабируемости отказоустойчивости вместе эти требование дают разработчикам широкие возможности для технического творчества и применения новых концепций подходов и технологий в этом тип толк я бы хотел осветить тему монетизации кредитных историй и выделить наиболее яркие с технической точки зрения моменты с которой мы сталкивались в проект компании flex связанные с построением аналитической платформы крупнейшего российского кредитного бюро позволяет раскрыть тематику обработки и колоссального объёма данных на фоне высоких требований отзывчивости стабильности и горизонтальной масштабируемости системы законодательства российской федерации обязывает финансовые организации передавать сведения о кредитных историях заемщиков в так называемые кредитные бюро каждый приобретенный кредит будь то покупка нового автомобиля или ипотека каждый платеж или просрочка даже сам факт запроса отчета по кредитной истории выполнены через интерфейс на веб-сайте все это становится частью истории не входят в обширной и непрерывно расширяющийся массив данных кредитного бюро случай рассматриваемой аналитической платформы речь идет о сотнях миллионах хранимых кредитных историй и связанной с ним информации каждый день candida на игру обрабатывает десятки миллионов запросов отчетов по кредитным историям сотни гигабайт новых изменений от кредитных организаций и формирует миллионы уведомлений о полученных обновлениях для банков клиентов в основе бизнеса кредитного бюро лежат три типа продуктов обслуживание запросов отчетов по кредитным историям анализ изменений в историях не формирования уведомлений различных типов это так называемые триггеры а также оценка заемщика с точки зрения его надежности и платежеспособности так называемые ско ринге триггер это некоторые события который является реакцией на то или иное изменение в кредитной истории чем меньше временной отрезок между изменением и производным событиям тем выше вероятность успешной монетизации этих данных рассмотрим реальный пример михаил открыл счета в двух банках каждый из которых занимается по 3 сельским кредитованием оба банка хранят кредитной истории своих клиентов в одном и том же кредитным беру но банк номер два назовем его west best offer дополнительно приобрёл продукт триггеры в отношении ряда своих клиентов в том числе и нашего героя михаила михаил приобретает в кредит новый смартфон и по случайности для расчета процентов и переплат обращается к менеджеру банка номер один клиентам которого самый является банк запрашивает кредитную историю михаила в бюро и после получения ответ и предлагает ему кредит под восемь процентов запрос кредитной истории от банка номер один также является ее частью аналитической платформы бюро обрабатывает запрос с точки зрения триггеров и генерируют уведомление для второго банка то есть банковой с best offer который ранее при обрывался то соответствуй услугу реагирую на полученную давление банк номер два присылает михаил с мсс выгодным контур предложением кредита под более низкий процент и клиент с радостью его принимает рассмотрены сценарий описывает лишь малую часть возможных вариантов монетизации данных по кредитным историям ходе анализа требований и предпроектного обследования анти ландшафта кредитного бюро мы поняли что тех логический 100 кв asdasd а в основе которого лежит симбиоз уже ставший классикой big data и потоковых подходов к работе с данными может решить существующие проблемы и дать бизнесу возможность реализовывать принципиально новые продукты при разработке аналитической платформы критически важными для нас являлись следующие требования первое это снижение той тумаркин для новых продуктов второе переход от пакетные к потоковой обработки и real-time продуктом с минимальными задержками обработки третье внедрение технологии машинного обучения и жизненный цикл разработки моделей так называемый м.л. abs для задач с хокинга и 4 надежность гибкой горизонтальная масштабируемость и высокая отказоустойчивость платформы на достижение поставленных целей мы применяли лучшей практики devops и облек сработаем среди истории моделей мой flow и тепло реализуем процессы соседи используем современные фреймворке и эти потоковый как стоит вас так и стоит full обработки данных live band клауд flow об отчеканен капочи spark of the streams а пируем дата лайк на базе hadoop используем apache cassandra до оперативного ханин данных и c в качестве хранилища файлов масштабирование отказоустойчивость обеспечиваются рядом подходов и технологий в основе которых лежит платформа артист рации контейнеров опыт shift центральной части топологий аналитической платформы находятся высоко нагруженные потоковые проложи некоторые также называется pipeline нами они разработаны с использую приборка апачи frank который располагается под зонтом продукта облачная регистрации разнородных потоковых сервисов которые двоится live band клауд future платформы полностью соблюдает концепции реактивной архитектуры поздно действие между отдельными сервисами и pipeline нами полностью асинхронно и реализовано с помощью пачиков к экзотическая платформа разделена на технологические под модули которые обладают слабой связностью независимо масштабируются и строго изолированы можно выделить следующие основные модули аналитически платформы первый это pipeline и поговорить на обработки данных которые обслуживают процессы захвата анализа и трансформации входных данных второй этап система master data management которые идентифицируют изменения или запрос и определяет к какому субъекта кредитной истории он относится третье это покойный триггеров и поклонись корнаков это основные самые нагруженные потоковые приложения платформы который обслуживает соответсвующий бизнес продукции в том числе оперирует модели машинного обучения в скоринга система выявления изменений и формирование гектаров данных для бизнес под line of и модель обучения это наш последний под модуль источники данных и магической платформы можно разделить на два сегмента первый сегмент это онлайн поток который включает запросу скоринга и отчеты по кредитную историю помашу these руется в платформу при помощи rstp и построенном на базе той книге клок этот поток обслуживается стоит ли с микро сервисами и выделенными pipeline амин основе лаймен клауд лу и а к string на данный момент они обрабатывают около трех с половиной 5 миллионов запросов в сутки ро сегмент источников это пакетные данные которые состоят из файлов с изменениями по кредитным историям пакетом запросов спаррингов отчетом по истории мо так же с сервисным файлами которые обслужим бизнес продукты платформы например списке клиентов для отслеживания в отношении триггеров этот сегмент обслуживается высоко нагруженными потоками приложениями на основе апачи фринк и в данный момент обработать около 80 миллионов изменений в сутки с неравномерным распылением нагрузки с пиками до 15000 событий в секунду каждой из сегментов и модуля аналитической платформы спроектирован с учетом гибкое горизонтальным штабе руи мастер пакетные данные 2 сегмента анализируются и разделяются на отдельные события с момента появления такого события платформы функционирует в рамках событий на ориентированные архитектуры каждое обновление или запрос проходит идентификацию в подсистеме master data management и обогащается средними о субъекте изменения эти обогащенные дискретные события в потоковом режиме передаются в подсистему выявления изменений и далее обрабатывайте специфически в зависимости от типа при обработке изменений кредитных историй рассчитываются дельты так называемые состояние было стола и соответствии с текущими настройками формируются новые события для дальнейшего анализа в pipeline их триггеров и формирования онлайн уведомлений для клиентов дура давайте вспомним наш кейс с михаилом его покупкой подсистем оперативной обработки событий также занимается расчётами викторов так называемых печей для моделей скоринга при поступлении запроса на scaling вектор извлекать из оперативного хранилища и подается на вход модели бигер из запроса сама же модель при этом за diplona как обычный под кластера опыт shift разработка модели машина обучения для скоро выполняется в отдельной области так называемой аналитической песочнице это 1-ый класс строкам shift и инсталляция cf или hadoop оснащенные инструментами до работы специалистов в области дата сайнс проект гипотез валидации моделей а также механизме вынос и модели в продакшен на базе репозиториев моделей молекул результат работы бизнес сегмента фанатической платформы то есть результаты запросов кредитных историй с колин гав а также события по триггером могут передаваться к ментам в режиме онлайн через и пео или с помощью сервер sun tent стиле пакет на с помощью файлов механизм получение результатов зависит от возможности и потребности кометы и никак не ограничиваться стороны платформы в ядре тех магического стыка платформы лежит фреймворк артист рацией гетерогенных потоковых порт lifeline band плавать flow фактически это зонтичный фреймворк объединяющие кабинете с операторы apache spark апачи фринк и а к который позволяет строить разнородные с точки зрения backhand pipeline в контексте единого метаописания и процесс в дипломатов среди его кушают эрика берна tissot взаимодействия между компонентами pipeline of асинхронная для этого используется пачиков к жизни цикла по чаплинка я почти spark делегируется соответствующим кубер на с оператором подавляющее большинство потоково приложений аналитической платформы работают с хранением состояния так называемый стать фил обработка 90 процентов стив в обработке выполняется с помощью патчей fling остальные десять с помощью apache и spark и в основном это касается работает да то лайк и hadoop потоки в стоит в обработке на по чаплинка зачастую шарнира ванны с высоким максимальным параллелизмом что позволяет быстро менять степень параллелизма операторов на барина грустных участках проекты и выполнять горизонтальное масштабирование системы с появлением нативной поддержки губернатор в релизе а против find any 13 перспективы мы планируем отказаться от текущего кубы гнать из операторов рынка от компании лифт и реализовать динамическое масштабирование blink драбов тоже настал момент делать выводы проект аналитической платформы для активного бюро позволит полностью перевести существовавшие ранее бизнес продукты на real-time обработку радикально повысило производительность отказоустойчивость масштабируемость за счет новые реактивные событий на ориентированный архитектуры ключевой бизнес продукт триггеры теперь выполняются в режиме онлайн и задержка между получением обновление и формированием события для клиентов 90 процентов случаев не превышает 10 секунд при пиковых нагрузках политическая платформа обрабатывает десятки миллионов изменения ежедневно обслуживая высокие пиковые нагрузки до 15000 событий в секунду и при этом имеет возможности для гибкого горизонтального масштабирования с ростом числа клиентов средств разработки проверки и вывода продакшен для модели машину обучения также позволяет повысить качество продуктов скоринга и снизить тайм ту марки для новых моделей и продуктов и многие фас дата и потоковой обработки в целом позволяют достичь минимальный задержек и значительно повысить монетизацию ваших бизнес данных олег привет я артем я бывший редактор хабра сейчас ведущий подкаста мы обречены раз познакомиться здравствуйте добрый день меня зовут сметанин олег я технически архитекторы и delivery лид практики разработки заказных приложений и сервисов компании accenture accent я слышал очень большая компания да действительно компания в санчи это глобальная компания официальным метрикам в ней больше 500 тысяч сотрудников 50 странных 200 крупнейших организациях города компания глобально эта глобальность видно когда ты находишься в диалоге или можешь обратиться там в базу какую-то носить базы база знаний и ты можешь посмотреть как примерно подобные проекты решались в японии там недавно или в испании как такие проекты делались такая хорошая к система который естественно приходится управлять это управление выглядит может выглядеть там примерно следующим образом сформировали новое направление плавать first то есть это стратегическое направление в котором сейчас компания развивается определили в этом направлении там 70 тысяч сотрудников всех обязали так стать не то что обязали способствовали тому что все начиная от аналитиков и заканчивая исполняющими директорами получили сертификаты официальные то есть прям это от рен даров сертификаты все по-честному со сдачи экзаменов все это в массовом масштабе это все это это работает действительно и соответственно таким образом и идем и delivery им эту историю дальше расскажет каким проектом занимаетесь да ну вот наши заказчики это топовые компании с таких индустрий как бэйн кем-то финансовой сферы retail ресурсы они приходят к нам и мир для того чтобы мы помогли ему развить новое направление бизнеса технологических обеспечить или модернизировать существующие бизнесе нет из тех проектов которые сделаны с микро сервисной архитектурой я вот нашим заказчикам и delivery club на этих приложения с микро сервисной архитектурой для современных регистраторов таких как к бернейс больших вот из таких приложений с которым вы могли наверное столкнуться можно отметить такое решение как кредитный конверт для банков решения позволяют с учетом рисковых моделей данных о клиенте данных а его доходе данных профиля клиентов банки размер разноплановых данных из внешних источников система анти фродо рассчитать одобрены предложил предложения по кредитам для десятков миллионов потенциальных заемщиков ну и за 40 секунд например автоматизированную принять решение о выдаче кредита при вращении заемщика по существующим каналам связи ну то есть мобильном банке там обратиться и соответственно получит за 40 секунд ответ другим каким-то проектом решением с которым вы могли столкнуться является логистическая логистический сервис который позволяет заказать на алиэкспрессе какие-то товары онлайн и забрать их в ближайшем магазине это система которая интегрирует и большое количество лидеров и комикса и предоставляет интерфейс и и опять для скажем минорных участников этого и камер с таких мелких скажем интегрировать систему управления складами системы управления транспортом система управления лагерными сетями поста матными сетями вот и уже сейчас это решение перевозит порядка двух миллионов ваших заказов привозит их магазин ну вот как жить как делать правильно чтобы вместо монолитного да не получить интеграционный от ну есть да ряд методик которые и мы рекомендуем вот скажем так тогда когда мы внутри системы это сервис и наши мы и там формируем некую микро сервисную поставку она включает себя имплементацию самого сервиса это всем понятно дальше клиента к нему на том нативном языке на котором будет потребитель с большой долей вероятности работать то есть он в простейшем случае просто берет нашего клиента который может работать по синхронным протоколом асинхронным протоколом и мы считаем что мы транспортом такой глупой микро сервиса умные и мы подставляем красивого и удобного понятного клиента так чтобы на этапе компиляции уже было понятно где этом потребитель и и им этот поставщик то пропустим расходимся это вот там одна из первых мир 2 мера значит но если это потребитель какой-то внешней по чистому и ту самую спецификацию поставляем типа об анапе а если например из новой истории для того чтобы он смог на любом другом языке который там считают нужным использовать своих систем так по практике мы интегрируем ся совершенно разными технологиями бывает там этой стороне и поэтому например на java то там поэтом и мы там допустим для них сразу там об анапе схему поставляем причем важно тут два момента несколько текущую схему поставить для сколько договориться о будущих изменений то есть вот это вот самая большая проблема сказать что те и вот к такому-то релизу у нас будет вот такая ситуация и пожалуйста под нее подстраивать значит это очень важный аспект который я во многих корпорациях ну скажем так как на базе базовой базового менеджмента api не вижу частая история это когда смешки интеграции вот у нас есть условный confluence и мы там документацию пишем там какой то плюс минус произвольной форме нет компьютер на читаем не компьютера или это new нельзя формальной спецификации щит считать естественно там много расхождений может быть таким подходом и когда и выясняется то всем на гораздо ну на поздних этапах таких как ft rido стан дай только там потом поняли что серьезно разошлись в понимании происходящего потому что человек читал не компьютер не машинах вот вот в эту же микро сервисную поставку входит там блоки связаны том числе своим то есть там перри используем компания каждый как бы микро фронт свой делают для своего домена то есть разные аспекты и в том числе как это легкая интеграция и съем эти компоненты которые прибиты гвоздями если по-простому говорить каким-то сервисом который легко использовать чуть-чуть под конфигурировал и все вот тебя весь элемент выбор из справочника мясника локаций точки доставки с картами со всеми штуками вот есть другие практики такие как вот контрактные тестирования и это еще гораздо более сложная история и сказать что тот же корпорации многие к этому не готовы то есть на уровне методологий мы этого не видим когда например консьюмер потребитель сервиса может выставить свою часть контракта сказать что вот пожалуйста провайдер я жду от тебя вот такие вот там поля какие-то значения в каких-то местах в таких-то структурах и ты не можешь выпустить обратно не совместим и сервис не учтя этого опять же управление версиями в общем набор техник вот виде микросфер из на поставки которые правильно артефакты для консьюмер а для потребителя выдает контрактные теста вот они все помогли мы в значительной степени все это интегрировать без шапки ну куда бы не завел нас прогресс я желаю вам успехов всем спасибо до свидания спасибо большое спасибо что пригласили великолепно можно не стесняясь поблагодарить под кастера который взял для нас эти все интервью а у вас телефон в руках да вы не можете хлопать с отлично маленькая продолжается highload весна если кто-то очень хотел розетку они в полу под железными люками ну так я просто одного человека бегущего с зарядка видел может быть он такой не один я предлагаю провести акцию не неимоверные щедрости и олега пригласить на сцену на 7 минут раньше его выступления потому что зал полный и потому что ему всегда есть что дополнить это олег болтунов человек который знает все о слонах и которые этих слонов простит холит и лелеет и не выдает из наших с вами зоопарков как настроение сейчас посмотрим слышно отличная вот велика ли крайне отличная так эти семь минут я хочу использовать для того чтобы сделать несколько объявлений вот сегодня вечером 10 вечера метро воробьёвы горы выход номер 2 мы побежим хайло лбу пробежку то есть тех кто хотят тут присоединяйтесь вы можете задать любые вопросы мне там про под брестом про жизнь там еще так далее то есть такая хорошая возможность обещая убежать не быстро все будет хорошо но вот следующая я хотел бы вы видите в слайды вот сортируйте страничку потому что слайда можно скачать и это будет вам гораздо удобнее потом изучить материал потому что их много реальных там очень много я буду показывать не все естественно пропускать быстро но для того чтобы вы поняли под gris поняли его потроха и поняли причину своих проблем вообще это интересно их будет почитать то есть я для вас старался этот доклад я готовил ну больше года потому что прошлый highload не случился за это время у нас голове произошли некоторые изменения и вот видите изменилось название то есть мы назвали уже не просто мы сквозь и джейсон и что-то такое она завалила про джейсон где на стероидах то есть это действительно ну как бы важно и переключение у нас в мозгах этот доклад мы готовили с никитой глуховым которого здесь нет правда я хочу представиться тех кто меня не знает я занимаюсь по адресам с 95 года работаю я профессиональный астроном работаю московском университете и являясь генеральный директор компании после то профессиональный а также мажорным контрибьютором адреса то есть вот этот слон он составлен из названий проектов которые я кантри beauty of puzzles наверняка многие из вас как бы знают вот эти названия кто-то делал индекса и так далее я очень рад тем что я приложил руку к этим проектом никита глухова несмотря то что он присоединился команде не очень давно но он уже очень много тоже сделал это тот человек который занимается с квали джейсоном тот человек который сделал джейсон пас но и и вот мы с ним сейчас продолжаем работать над производитель джейсон бер а давайте я расскажу как все начиналось на самом деле подлез является реляционной базы данных 1 которая в себя включила поддержку слабо структурированных данных вот посмотрите 2 тысячи третьего года уже в подгрести была доступна такой тип данных как restore он до сих пор живой находится кантри андре бах это уже был прообраз будущего деструктивного хранилище в совете 2003 год знаете когда появился jason jason появился 2008 так что 2003 уже могли делать гибкие схемы не надо было менять альт р т и было так далее и штора является как я говорил уже частью по адреса с 2006 года в двенадцатом году появился тип данных джейсон это просто текстовая строка с валидации это мне не очень понравилась и поэтому в четырнадцатом году мы сделали настоящий джейсон бит тот самый тип данных которым сейчас пользуется весь мир он уже является это бинарное хранилище поддерживают вложенные объекты массивы ну и естественно есть индексная поддержки чтобы с ними можно было хорошо работать в 19-м году мы оживили проект и добавили поддержку джейсон паса джейсон паса это язык запросов джейсоном той с помощью его вы можете очень гибко описать ту часть дерева джейсона или под деревья джейсон с которыми работать то есть это очень удобно и хороший хорошая вещь а дальше мы остановились потому что надо было делать уже поддержку иску или джейсон функций который является частью стандарта но тут возникли некоторые вопросы и на этом я остановлюсь более подробнее но пока что я хочу сказать показать вам этот слайд по материалам сайта db engine и такая пузомерки для баз данных я построил вот такую картинку вы видите что здесь единственная база данных которое растет это пузырь с то есть ее популярность посмотрите 14 года начала расти и растет до сих пор в то время как остальные это москвы oracle mssql они находятся более менее в константе или может быть чуть чуть про проседают так вот это связано с тем что в подвесе появился нормальная поддержка джейсона виде джейсон бер и очень много мускульных юзеров пользователи пришло к нам то есть наше сообщество обогатилась новыми и новыми запросами новыми потребностями так далее и это началось водитель с 18 декабря 14 года вот я обещал рассказать что надо что остановлюсь о том что сейчас есть адресе вот-вот в подписи есть два типа jason jason de вот видите 2012 год 2014 джейсон б это бояре джейсону и они вот находятся не то чтобы в противоречие друг другом но как бы вот мешаются мешается первую очередь тем что джейсон изначально занял ну как бы название джейсон и нам пришлось делать джейсон by и вроде как вы это джейсон by не является стандартным но люди привыкли и пользуются им вот мы его развиваем джейсон be at этом запросе вы можете увидеть чем отличается джейсона джейсон бер джейсон слева просто-напросто это текстовое хранилище то есть как вы подали джейсон так он не такой какой он есть а джейсон бер это бинарное в нем ключи сортированный дубликаты вычищены и пробелы всякие white space и тоже удалены это позволяет работать с джейсоном очень эффективно вот джейсон где имеет очень богатую поддержку функции там один список функций там это зашкаливает существуют всякие расширения и существует индексная поддержка так что совет такой сразу когда спрашивают чем пользоваться пользователь джейсон б очень редко нужен джейсон очень редко то что под gres так хорошо стал поддерживать джейсон и пользователь стали пользоваться джейсону в реляционных базах данных привело к тому что из quelle es que el тот самый es que el который говорил что никаких джейсону никаких массивов и так далее он сказал что это теперь джейсон является с частью стандарта 2016 года то есть вот 22 фичи из нового стандарта это про джейсон из 44 конце декабря 16 года уже является действительно стандартам и так далее сейчас готовится новое издание стандарта в котором будет уже специфицированы тип данных джейсон и мы к этому тоже готовимся ну вот и все кратко посмотреть стандарт включает описание модели данных sql джейсон в целом это тот же самый джейсон которому мы все привыкли второе это джейсон послан вич как я рассказал это описывает проекцию джейсона дерево джейсона вот то чем пользоваться дальше функциях и 9 функций 9 функций которые одни из них которые как бы construction functions то есть как сделать как иску или типы превратить в джейсон значения и каире как джейсон значение проводить вас квали типы но тут их достаточно много и мы решили пойти вот таким путем то есть мы взяли джейсон big как подмножество из квали джейсон модели данных при этом это подмножество удар от ее уникальные ключи опыт показал что этого подмножество для профи всех практических задач и задач хватает и мы реализовали джейсон пас как наиболее важную часть стандарта то есть этим вы уже можете пользоваться это камин закончена в 12 в 13-ю версию причем я хочу сказать что мы так постарались что 15 из 15 fitch поддерживается еще общепризнанно что джейсон поспал risi является самым крутым среди всех остальных баз данных дальше и сквозь сон функция функции мы работали над ними четыре года честно потратили время вы видите что 55 версией патча для искали джейсона и 48 версии патча джейсон тепла вот столько функция столько почти сделано у нами для того чтобы в комьюнити пробить вот нам на самом деле все это до сих пор ждет своего review и не закончена на это есть причина я расскажу потом индексы мы реализовали индексы то есть мы добавили в индексы поддержку джейсон паса то есть теперь уже можно делать использовать индексы для того чтобы искать по джейсон полосу специфицировать но самое интересное что все предыдущие фу индексы существующее уже лежащие на диске те которые вы делали ли джейсон б они теперь поддерживают тот же самый джейсон пас без изменений чего не надо делать вот список проектов вот за эти четыре года что мы сделали джейсон б вот вы видите иску или джейсон функции потом мы делали обобщенный и пиаре для джейсона это связанно с тем чтобы сделать джейсон бер стандартным иску или типа это тот стандарт который будет в следующем году или в этом году уже будет признан и мы сделали специальный доклад и который позволял с помощью специальной переменой объявить джейсон by как джейсон так что вы могли писать ваши приложения для одной базы данных для другой и так далее вот мы улучшали индексирование джинсы джейсона мы делали там селективные индексы расширяли синтаксис джейсон паса вплоть до поддержки там лям для функций и так далее вот пытались работать над simple тот наташин и так далее то есть действительно много всего сделано и это все можно увидеть даже скачать и попробовать протестировать я рассказала на предыдущих докладах на но сейчас для нас топ приоритет это сделать джейсон б как гражданин 1 сорт первого класса под алисе то есть чтобы у нее было действительно эффективное хранение быстрый быстрый выборки апдейт что очень важная и хорошая и pr вот почему мы решили немного не то чтобы как бы поспал немного придержать те остальные проекты а заняться именно этим этим связано с тем что популярность джейсона вот посмотрите по обзору 21 года в топ-3 фичи джейсон b и джейсоном находится на первом месте то есть действительно это люди реально пользуются вот я являюсь моим тренером канала телеграма позже sql кто не знает то подпишитесь потому что там виде 6170 пользователей и там несколько тысяч в онлайне непрерывно то можно решить любые любые проблемы так вот я сделал дамб и про гребень и оказалось что джейсон находится на третьем месте после selecta иску или то есть люди реально обсуждают джейсон web адресе и тут на меня как говорится нашло прозрение о том что при том что у нас недостаточно ресурсов сообществе работать над всем сразу вот всем этим большим количеством проектов не хватает разработчиков review верах коми киров и вот видите сковали джейсон четыре года мы потратили 55 версии сделали джейсон pebble 48 версий вот при этом еще кого ни спроси любой стартап он использует погрыз и вообще не думают о совместимости 40 лет эмали майкрософтовской серы кто здесь используют oracle или microsoft стартап ну может какой-то один отщепенец и найдется в целом нет такого нет это не только у нас в россии это и по за рубежом людям используют либо позволять либо манга ну так по большому счету и популярны jason de который является многим уже матерым договорятся ну то есть взрослым солидным банк типом данных у него там большая функциональность поддержка вот она говорит о том что надо заниматься именно этим типом данных джейсон b то есть грубо говоря если вы пишете приложение уже вряд ли вы будете писать приложение для того чтобы быть совместимым еще и 40 klom есть по адресу он хороший я вас уверяю он хороший на нем можно сделать все большие федеральной системы россии работают на подвесе и вполне себе нормально так что если вы думаете ваш проект будет ли работает об адресе сразу вспомнить яndex там маги то там они работают защите ваш проект сработает тем более что в джейсон бы есть что улучшать то есть и мы как раз задумали сатин а как же нам и что сделать чтобы джейсон бы стал действительно гражданином первого класса в адресе дело то что почему это вот проблема в чем состоит что вы взяли джейсон 2 работаете и вы замечаете непредсказуемую производительность вдруг и стала и всего он становится медленным вот пример классический пример простейшая табличка которая состоит из айди джейсона которые просто длинный массив ну просто 0 и 0 и и вы делаете вот запрос получаете шесть миллисекунд все хорошо просто вытаскиваете ключ едешь к потом вы делаете облить то есть просто говоря добавляете ключ бар у которого значения бас вы получаете message истинный ciklum получаете шестьдесят шесть миллисекунд то есть в 10 раз производить ваше просела это конечно очень нехорошо это связано с тем что как раз повысился предел джейсон стал чуть чуть больше чем 2 килобайта и вы зато остались узнаете скатол стата то есть это такое отдельное хранилище для очень для длинных записей то что больше 2 к2 килобайта компрессировал их все уходит в отдельные хранилища может вы об этом не догадывались но именно из за этого происходит вот такая такой просят следующий пример это вот популярная ошибка которая ко мне подходит начисто люди на конференции говорят ну мы делаем табличку которая стоит просто и джейсона а иди внутрь и нам ничего не нужно и так далее вот сравнили наш производительность двух схем когда у вас а и снаружи и когда один нутри джейсона вот красненькая красненькое вы видите время доступа к ключу камня к еде она постоянно а время доступа к иди которая лежит джейсоне она зависит от длины джейсона причем так линейно чем длиннее чем джейсон тем медленнее то есть это такая практический совет не поленитесь сделайте таблицу хотя бы айди вы носите и джейсона тогда будет вам жить легче чтобы дальше пройти нужно рассказать что такое тост толст это такое специальное хранение в подписях хранения больших данных то есть в самой таблице в хеппи как мы говорим хранятся значения не больше двух килобайт строка должна быть не больше двух килобайт но кто сейчас имеет такие строчки у нас у всех джейсон и достаточно развесистая таблица достаточно широкие поэтому все что больше чем 2 килобайта не даже после того как ios комп рисовали все уходит в отдельно хранения вот здесь написано здесь картинка такая да то есть ваша пример здесь а иди и джейсон так вот айди остается на месте а джейсон компрессе ца и нарезается на такие чанки 4chan как видите здесь и она уходит совсем взрыва их хранения то есть грубая невидимая для вас создается табличка для вот этих чанков которых лежат и девчонки и вся проблема как раз начинается здесь как только вы начинаете доставать какое-то значение из вот этого толсто вам приходится делать внутренней jojen тот самый join которую никто нас не любит то есть вам приходится читать дополнительные данные все эти чанки вам нужно потом это жениться и готова стать в память чтобы с ним что то сделать вот при этом там в этой таблице существует свой b3 индекс то есть вы не просто to which входите вы ее сначала по индексу прочитайте три четыре или пять блоков а потом уже идете в табличку собирать вот эти кусочки танков и 9 чанки то есть достаточно такая хорошо работающая но такое скрытая скрытая бомба вы никогда не знаете когда вы попали на это и вы начинаете начинается боль я дальше пропущу это немного теории 4 на самом деле видите чтобы таз произошел нужно сделать 4 шага это довольно сложная а покажу он сразу такой очень такой пример в котором табличка со 100 джейсона me & jason и разных размеров они от 130 байтов до 13 мегабайтах который компрессируются вот видите да 247 килобайт но такая обычная табличка которая запись выглядит так ключик очень длинный ключик и какие то еще ключик и какой-то длинный ключик кей 4 и такой стандартный путь когда вы делаете джейсон у вас разные разные размеры бывает вот и мы изменяем мирим время доступа ключу для каждой строчки тысячу раз повторяем вот делаем и такой специальный запрос тысячи раз повторяем чтобы померить надежно производительность и наблюдаем вот такую интересную картинку посмотрите казалось бы достать короткий ключик кей 1 да это же ничего а мы видим что все ключи вот время доступа ко всем ключам она одинаковая что для длинных что ищу для коротких это связано с тем что вам приходится 1 ну разжимать все эти доставайте девчонки разжимать и так далее вот этот плоский кусочек польский кусочек это как раз там где еще не наступило тост то есть там короткие джейсон и они лежат таблички и никакого толсто нет а вот дальше возникает наш кусочек вот этот кусочек вот этот кусочек это там помещается те джейсон и которые сжались до двух килобайт вот это видео строчка это как раз вот вот это предел 2 килобайта а вот здесь уже рост лейн это просто вот эти чанки надо читать читать читать вытаскивать ну и соответственно по количеству записей по количеству блоков которую надо прочитать вы видите что как только наступает толстый вот толстый наступает вот начинается беда вам приходится читать просто очень много это вот такой интересный интересная проблема но это тоже самое только здесь по оси x не размер джейсона такой стандартный а комплексирование размер джейсона здесь очень хорошо видно вот предел 2 килобайта то есть после двух килобайт начинается другой рост теперь это был все синтетический тест а если мы возьмем реальный тест есть такая база данных доступная свободное называется internet movie database ну грабаря база по всем фильмом мы взяли оттуда 4 ключа выглядит запись вот примерно так и здесь вот распределение ключей вот выглядит помечено звездочка видите вот айди это короткий ключ короткий ключ и он достаточно популярный вот роли роли это действительно большой там бывает чуть ли не за мегабайта список ролей это же популярное вот высота это рост роз актера и соответственно мы еще взяли внутренние ольги этой базы данных тоже это видите очень короткие значения но очень популярны вот четыре ключа мы взяли оттуда и проделали то же самое что делает для статических теста мы тоже видим здесь что действительно мы видим три участка вот онлайн это то что нет assets а вот этот кусочек это то что онлайн но сжатая и вот и этот кусочек то что-то снится и вот здесь за мы видим что действительно проблемы начинается с того как происходит тос то есть мы поняли из этого из этих простых упражнений мы поняли что декомпрессия это большая проблема то есть для того чтобы в тащить какое-то маленькое значение вам приходится брать эти чанки и разжимать причем вы не можете нажать только один чан кусочек такой вам нужно все чанки разжать потом оттуда вытащить значение это большая проблема отсюда мы поняли что он вам нужно частично декомпрессии то есть разжимать только тот кусочек который нам нужен вот и второе это то что мы читаем слишком много блоков слишком много вот этих чанков нам нужно брать и чанки кусочек только те танки которые нам нужны но который содержит то что нам нужно и дальше вот мы начинаем мы сделали проект то есть как мы улучшим вот этот тост хранилище и вот смотрите сколько здесь мы сделали экспериментов то есть мы где компрессируем только необходимую часть джейсона вот мы сортируем ключи по их длине это очень важно потому что у нас короткие значения лежат впереди а длинные лежат сзади и такой типичный паттерн использование джейсона у вас имеется метаданные всякие счетчики и так далее и что такое длинное было бы и обычно а привычно обретет вот эти коротенькие и доступ коротеньким нужен вот существующим джейсоне это все как бог на душу положит или не как вы назвали ключи существующим джейсоне запомните ключи отсортированы по названию ключей то есть вы у вас может быть так что впереди лежит большая плюха с коротким названием ключа и она будет портить все что там и так далее вот поэтому мы сделали так что джейсон без сам за вас внутри меняет хранения сначала лежат короткие ключи наиболее такие использованы и третье это частичные де тулуз то есть мы нажимаем мы только чанки нужны итератор такой 4 это онлайн тост делать то что когда я могу показывал картинку про тулз трудно было заметить но при кости у вас ту полу то есть ваша строка она сжимается до тупо pointer а то есть место самого значения там лежит такой pointer на куда-то на вот этих чанки так вот остальное храня и остальное место в ту плея которая лежит вашей таблице она не используется так вот мы решили что а давайте часть 1 чанка обратно положим сколько их хватит места в таблицу обратно вернём и есть большая вероятность после того как у нас все сортированы по зачем по длине значения для подавления ключа большая вероятность что вот этих как раз короткие ключи они окажутся ну и в онлайне и тогда доступ к ним не будет загар огибать вообще вот это толще хранилище это вот мы назвали онлайн тасс ну и самое последнее самое вкусное это сделать расшарить и вот эти чанки расширить чанки это означает что что вы не создаете новую версию этих чанков когда вы что-то обретите вот сейчас вы должны что сделать если вы зададите какой-то ключ у вас и перепишется все то есть вся строка и все вот эти чанки они из дуплицировать появится новая версия это не только вы тут размер увеличите таблица но у вас еще вот это все уйдет вал зачитывал в этот лог т.е. если у вас был джейсон там 10 мегабайт и вы меняете один бантик у вас станет хранения 20 мегабайт еще 10 мегабайт уйдет в лоб вал это очень дорого так вот мы сделали так чтобы изменился только тот кусочек тот чанг в котором действительно произошло изменение а все остальные остались на месте и да да будет блокироваться совсем мало и соответственно охранение не будет сильно изменяться это вот такой план который я вам сейчас покажу например на частично декомпрессии вот представим все ключи видите здесь пять ключей ключи лежат снаружи а потом лежат за значения так устроить же есть андрей и вот слева это мы фултон одесская декомпрессия то есть когда мы достаем например 5 ключ мы должны то есть производительность и одна и та же вы все равно читаете весь джейсон вот размера вот ведь длина видите вот длина это показывает ну большой то есть третий ключ большой справа частично декомпрессия видите мы читаем не все а мы читаем вот кусочки только а джейсона но если мы хотим 5 джейсон взять нам придется все равно весь прочитать потому что он находится там и мы видим что как изменилась слева то что было справа что что что стало видите красненький точки это ключ первый ключ он упал упал вниз вот по оси y время то есть мы видим что действительно произошло что то такое то есть его стала к ней доступ к нему стала быстрее все потому что мы теперь считаем не весь джейсон а как только вы добрались до или включая один все остальные ключи они пока читается также какая была потому что мешается вот этот длинный ключ он запер тоже сам мы на видим то же самое на им baby а и от роли зелененькая я самое большое и вот мы видим что упала синенькая айди их высота рост человека роз актера упали а вот а и красненькая внутренние иди и роли они остались вот там вверху потому что пока роли запер заперли чем этот mdpi чтобы это распереть нам пришлось сделать с отсортировали джейсон ключи по длине не по названию ключа по длине и то же самое сделали опять же значит посмотрели тот же самый пример и мы увидели видите как произошло изменение вот здесь вот здесь мы читаем уже не все вот как было вот видите а читаем только вот чуть-чуть потому что уже вот этот ключ он просто другой место попал вот это вот то что вам свободное время за чашкой чая почитаете это вот значение что привело видите у нас теперь отвалились все ключи вниз пошли кроме желтого желтая как раз длинный ключ ну вот и синенькие а вот красненькие зелененькие то коротенькие ключи они отвалились и стали чуть-чуть быстрее к ним доступ все потому что мы отсортировали ключ ключи для на мгб произошла примерно такая же картина то есть мы видели что теперь уже о м д б а иди вот видите здесь красненький тоже здесь были а теперь красненьких там нет красненькие тоже упали потому что красненькие стали впереди зелененьких но впереди ролей роли остались они большие они стали сзади вот если вы интересуетесь все здесь посмотреть то мы увидим что ускорение уже несколько порядка бывает ну зависимость и так далее дальше мы сделали вот этот тост де тост и это привело к тому что уже мы уже скорости вот доступ вернее access time он практически стал не зависеть от размера джейсона вы видите да что вот здесь была некоторая зависимость от размера джейсона а здесь уже вот видите не зависит фактически потому что мы берем только тот тот чанг который нам нужно не не все ну на mdp ади мы тоже видим вы плащ его не и плоская плоская становится опять же здесь если говорить о числах это действительно порядке ведь от одного до ста два порядка ускорение может быть онлайн тост но эта тема такая же он говорил да что мы вот ctos ctos panther добавили некоторые хранение называется inline чанг это на самом деле кусок от первого чанка откушу откусанные и вернул вернули его в табличку в надежде что вот эти все короткие ключи метаданные они попадут туда это тоже облегчает как боится жизнь и действительно мы видим что произошло еще лучше что мы видим мы видим что вот вот эта часть упала вниз упала вниз и мы видим что действительно от и 1 микросекунды до ста миль из микросекунд мы уже улучшились ну тоже те же два порядка но просто поведение стало уже другое боем baby то же самое произошло то есть вот красная желтая верхняя часть упала вниз но до сих пор существует такой гэп ответе ступенечка вот это этот ступенечка существует и мы ее как раз здесь убираем с помощью вот жареных чанков вот здесь написано что происходит на щит я уже вам говорил что происходит когда вы обретёте джейсон вот пример возьмите 10 тысяч джейсон of которых имеется 1000 ключей то есть ключ простой 1122 и так далее и мы можем посмотреть что таблички сама занимает 512 килобайт а хранилище тостов занимает 7 из 8 мегабайт вот такой select надо и иногда его приятно посмотреть то есть вы смотрите ведь табличка маленькая а вот это дополнительно хранилище она на самом деле еще очень большой 78 мегабайт то есть сам джейсон это 19 килобайт он компрессируются в 6 килобайт эти шесть килобайт занимает 4chan cotos чанки размером по 2 килобайта вот здесь эти вот эти за запрос и они помогают вам понять как устроено на самом деле хранения не так как вы видите посмотреть табличку а как на самом деле происходит дальше мы делаем облить давайте про облетим колоночку айди она вот находится отдельно она не она маленькая она никогда не попадет в толст просто запрещено для нее для таких и для интерьеров уходить тост вот вы продадите ли занял это 42 дней секунды и посмотрите какой вал всего полтора мегабайта то есть 150 байт на запись при этом если посмотреть на размер толсто он не изменился как был 7 из 8 гигабайт так и остался табличка увеличилась два раза но это понятно почему потому что ну версия пока вакуум не прошел табличка два раза увеличилась tales не изменился а теперь давайте про облетим джейсон вот мы сделаем облетим джейсон мы видим что в 300 раз медленнее стала то есть занял это 12 секунд что такое мы видим что размер вала стал 130 мегабайт 130 мегабайт вместо пел полутора мегабайт ну и соответственно хранения тост изменился увеличился два раза вы представляете дать чуть-чуть маленькой такой апдейте его вас все полетело в тартарары все провалилось вот и мы тогда вот как раз и придумали вот этот шарик джейс жареный торс когда вот эти блоки или чанки этого толсто они не все копируются а копируется только тот создается новая версия того чанга который нужен которой лежит грабаря вот эта часть атрибуты мы это сделали это опять же такая тонкость как это здесь устроен формат джейсона здесь очень тяжело и вам объяснить что это такое но если вы скачаете вы поймете как устроен на самом деле хранение его на диске бинарная вот и как все это выглядит то есть в этом примере мы показываем как на самом деле происходит шарин толсто есть ну давайте я вот сделаю вот пример хорошо апдейт вот первый обдурить мы делаем говорим делаем а равно барр то есть ключ у а добавляем насчет добавляем ключ облетим назначение бар этот ключ и вот вот он верху а и он находится он не то стенай вот эти все b и c это те где лежат эти ключи лежат где-то далеко видите там внизу тасс pointer вот мы видим что у нас приобрети а ничего не особенно не происходит от а приобрети и c вот есть ключ c у него есть ключ к структура ключ x происходит такие странные вещи у нас появляются новые версии чанков это приводит тому что у нас мы сохраняем и вот при первом дети ничего не сделали мы сохранили мы уменьшили трафик и это привело к тому что вот видите синенький синенькие они упали вниз они были вместе желтенькие желтенькие то длинные ключи осинки были такие промежуточные длины они отошли то есть стала сильно лучше и на imdb посмотрите что произошло вот этот гэп который был ступенька она ушла то есть ступенька ушла остались одни вот в гордом одиночестве роли ну то есть длинные ключи длинный ключ остался а все остальное она примерно примерно не зависит от размера джейсона здесь размер джейсона меняется от 0 там видите тогда мегабайта то есть это конечно очень хорошо очень здорово однако нас всех интересует апдейт вот посмотрите что случилось в мастере апдейт приводил к тому что ну просто любая любого ключа приводил к копированию появлению новых чанков новых версий и у нас поэтому вот эта кривая задирается вверх а справа справа мы видим что маленький ключ и они ведут себя совсем по другому то есть они просто находятся на постоянном уровне константа это потому что мы совсем не трогаем тост они лежат но в той области которую не надо трогать промежуточные ключи они упали синенькие они оторвались от длинных ключей желтых но все равно растут потому что они все равно лежат в то есть идет на если посмотреть на вал трафик то мы видим что в мастере вот какой в как вал растет а вот приобрети маленький ключей здесь волкон под постоянной он не зависит от размера не зависит от размера джейсона для синеньких для правильного для ключей промежуточной длины там действительно происходит тоже рост еще если суммировать все все тот например для синтетического тесто вот слева это мастер а дальше мы делаем по частично декомпрессия к сортируем ключ и частично дикости и дальше делаем онлайн толст и следующий шаре тост вот все вот эти пять оптимизации на одном графике мы видим эволюцию как все меняется и мы видим что насколько сильно у нас производительность версаль производительность здесь видно три порядка изменения при этом я хочу подчеркнуть здесь происходит полная совместимость с джейсоном то есть старый джейсон и новый они могут существу существовать потому что джейсон он внутренней расширяем вот его бинарный формат сделан так что он сам понимает какую версию джейсона читает то есть это вот мы такой эксперимент сделали очень интересно а вот для а им baby та же самая картинка вот эволюция как происходит до с длинными ключа и мы ничего не сделали ну потому что как они есть и есть длинные ключи то есть пока мы ничего не сделали и вряд ли че можем особое сделать но короткий ключей те самые метаданные за которую мы боролись они стали вести себя совсем по-другому это очень здорово и теперь вот тот самый пример когда мы начинали что айди вне джейсона 13 вильсона то есть мы увидели что до ситуация улучшилась то есть вот ольги жки принципе можно держать внутри джейсона то есть она немного хуже стало но не не низ не существую а длинный ключом там так и продолжает расти это вот количество блоков прочитанных боль можно видеть да как стала то есть если вы читаете айди которая находится вне джейсона или читаете о гектору находится внутри джейсона разница нет по количеству блоков вот маленькая просадка производительности видите вот желтенькая на чуть повыше чем красненькая она связана с тем что все таки достатке джейсона надо и вот этот overheat он есть поэтому конечно лучше всего держать айди снаружи но уже не так не так кардинально как как было дальше делать то что почему я люблю такие онлайн и оффлайн и в конференции потому что действительно мы получаем такие вопросы интересные до которые нас мотивируют на продолжают работать я за сегодня вот этого доклада переговорил не знаю с кучами людей получил кучу начни интересных замечаний идеи и вот прошло на прошлой конференции которая была в марте к нам подошел человек она была в онлайне то есть где то там в онлайне мне задали вопрос вот как сделать стрим адресе но это другой вопрос нужно ли не надо но представляете у вас имеется байты да и в их к нему добавляете блоки вот люди делали его там не знаю фильм записывали ли что-то еще они столкнулись с тем что когда вы что-то добавляете было вы тратите гигантское время до трафик на то чтобы все это происходило в полисе вот пример добавить 1 байт вот имеется 100 мегабайт ни байта и к нему добавляем 1 байт вот занимает совете больше секунды но это связано с тем что как вы уже теперь знаете есть такая штука как толсто которая она ищет соответственно вот это 100 мегабайт копирует вал и копируют в хранили их хранение александр зовут зовут александр сожалению запомнил его и мы серьезно задумались это такой челлендж появился как же сделать так действительно что можно было стримить web адрес и тогда мы придумали мы придумали пример что вот пример мы придумали сделать специальный такой формат данных data он называется подрасти то что передается значит функций и так далее как вот этот самый тасс pointer и еще какие-то inline данные то есть если вы когда вы хотите добавить что-то мы сохраняем его в inline данных в ту пле вот здесь нарисована видите вот это тасс pointer у него размер там 5 5 килобайт 5 5 килобайт этот размер вот этих трех чанков а это просто pointer и вот здесь мы добавили их маленькое хранение вот то что не хватает до двух килобайт просто для того чтобы например если вы хотите один бать записать вы прям записывайте не туда а вот в это место как бы ускоряется когда становится больше мы делаем новый chant вот когда мы увеличивается мы просто делаем новый чанка старое просто как бы сохраняем на месте и мы получаем такой интересный benefit до что место 14 чанков вот на таком простом примере да там сделали два аду мы работаем семью чан коми ну то есть уже в два раза но это просто такой примитивный пример реально конечно вот например на том же самом примере если мы повторим мы получаем видите какую скорость в две тысячи семьсот пятьдесят раз больше быстрее ускорение то есть просто стрим занимает меньше миллисекунды вот так добавили при этом генерится таблица размер таблицы оставался то же самое примерно 100 мегабайт и вала всего 143 байта сгенерил ась вместо 100 мегабайт ни каких то дополнительных ненужных и чтений блоков не нужно было то есть ну прям такой хороший хороший приятный мотивирующий пример который показывает как можно толстый изменить чуть однако у нас вот здесь как раз показано то что есть в по здесь и сейчас ведь и по оси x размер данных о старые стану размер данных и мы разные цвета это количество опенсорс то есть сколько вы добавляете к этому как к этому размеру 10 байт 100 до одного мегабайта вот мы видим как вы у нас слева сейчас пол зависит происходит то есть у нас время execution time пропорционально длине джейсона и тому кусочку которая и добавляется а то что мы сделали у нас лейте пропорционально сюда да за пропорциональность если вы не знаете я сам не знал вот за пропорциональности да он размер джейсона уже не вышел только зависит от размера того что вы добавляете по моему очень красивые такие картинки да видите как спокойно но это вот здесь вал тоже видно как вал работает стал вал хороший а теперь возникли другой челлендж это мы один раз сделали один раз добавили а теперь давайте сделаем так чтобы мы быть действительно сделаем stream то есть у нас строка строка имеет размер 0 и давайте добьём его до 1 мегабайта маленькими апдейтами например по 10 байт сколько надо сделать по 10 байт апдейтов чтобы дал один мегабайт но от если 100 килобайт вам нужно сделать d110 апдейта всего и мы решили посмотреть как это можно сделать делать то что использовали позже стас that statement для того чтобы вытаскивать время количество блоков и размер вала и действительно вот результаты стрима видеть и в старом возрасте как все происходило мы сразу уперлись просто производительности дело то что один мегабайт мы выбрали не случайно потому что ну просто место на ноутбуке стала вылетать потому что когда вы начинаете обвесить вот такие уже от 100 килобайт так далее то есть у вас начинают врастать таблица ну очень круто представляете вы 10 10 байт ними кусочками отдайте его сколько вам нужно там тысячи раз облететь пухнет таблица пухнет вал поэтому ограничить 1 мегабайта и вот справа как у нас происходит на щит стало уже со пензе был байта вот это показывает о том какие большие перспективы то есть ну как бы действительно вполне можно сделать такой тип данных апдейт обл стримить и но это вот здесь показан вал размер вала как растет здесь ведь размер овала зависит только от 1 от от размера добавляемого куска а здесь он зависит слева зависит от самой строки опять же ну это вот мы сделали полосу посчитали сколько мегабайт в секунду видите слева у вас вы начинаете вот маленькими вот внизу это вот вы мы stream 10 байт ними кусочками ну то есть действительно здесь у нас начинается там с мегабайта секунду и очень быстро мы килобайта секунду спас падаем то есть полоса сайт совсем маленькая если мы увеличиваем значит все становится очень много получше но опять же все спас падает вот а справа мы видим такая постоянная нормальная производительность то есть мы можем предсказать что если мы хотим занять полосу там 20 мегабайт в секунду то надо просто напросто ответить там килобайтами чан коми и не будет его деградации производительности не будет это вот такое интересные примеры ну вот здесь я хочу сказать что мы у нельзя было оставить манго в стороне да поэтому мы решили как-то посмотреть как все это выглядит и я отдаю отчет что это абсолютно ненаучное сравнение потому что хороший benchmark это отдельная большая работа которая включает себя там не знаю провели настройки правильно и железо там большой опыт мы просто сделали значит как бы вы видите да то есть мы ищем по а in baby базе данных мы ищем считаем количество записей в которых алешко содержит слова кабеля кабель и зайчики ночи кабирии был фильм такой вот мы копирующим и после связь memory манга 444 и два варианта 16 гигабайт in memory и 4 гигабайта это ну как бы половина памяти дел то что здесь мы два взяли случай а потому что после 100 работает в памяти с сжатыми блоками вот эти толстые чанки они лежат в уфе раху адреса сжатые а у манго ниро сжатые и поэтому манга она занимает кнут несколько раз больше в два раза больше памяти требует чем пузырь с и если например если например подвес под лесу не хватает памяти он деградирует естественно но не так сильно как деградирует манга то есть в манге если вы не под не попали в память выпроси дайте очень сильно ну это здесь видно вот видите слева мастер вот это мастер а это вот манга мы видим что mango выигрывает мастер раза в три и дальше мы добавляем наши оптимизации то что я рассказывал то есть вот декомпрессия ключи сортированные там дето осень и так далее и так далее и мы в конце концов доходим вот для такой штуки то есть мы уже вот здесь шарит толстых начинаем выигрывать мангу но я хочу сказать что все тесты которые мы делали мы делали с выключенной параллельность you вы знаете что у мудреца достаточно хорошая поддержкой параллельности мы ее специально выключили ну чтобы иметь нормальное представление доска на производительности а здесь просто включили параллельность и когда мы включили параллель из мы стали быстрее манги еще во много раз вот маленькая это манга 16 гигабайт а вот манга 4 гигабайта то есть база половина база только память включилась так вот она видите почти как говорится ну ну почти как поезд просто как только как только вы не хватает памяти но и как сказал это уже ненаучное сравнение начисто с полисом ненаучный benchmark буду рад если тут есть как после свой грязная а манго виде да то есть из есть манго или дату мы буду очень рад просто сделать benchmark на реальных данных на реальных запросов будет этот я думаю будет многим интересно ну вот я тут подошел к концу наш мы продемонстрировали шаг за шаг улучшение джейсон б причем с обратной совместимостью как и говорил джейсон был устроен так что он сам распознаёт новые форматы хранения и это привело к тому что действительно там десятикратное у ускорение для select of ну и очень очень дешевый апдейт произошел и это наталкивает на то что мы находимся на правильном пути кульки пи джейсону ну так то есть может действительно не только быстро читать делать точечное чтение но и апдейтом уже делать этот очень не хватает многим людям тут ко мне подходили действительно говорили что частичный апдейт это очень нужен хочу сказать что частично апдейтом он гонит там тоже там копируются все мы здесь сделаем 1000 апдейт если кто хочет поиграться посмотреть тот вот на гитхабе у нас все это лежит там отнял не скрываем ничего и как известно вот слайда этого доклада на ней доступны делает он деситин содержит гораздо больше информации просто такую аудиторию очень тяжело подробности технически рассказывать но хочу сказать что вот тот же самый подход мы можем применить к любым типом данных у которых есть возможность рандомного доступа к частям например массивы можно сделать то же самое для массивов доступ какому-то определенному элементу массива dat а тот же самый штор можно сделать тип pdf тип документ pdf в котором имеется в заголовке имеется просто ссылки на страницы и можно легко делать доступ к любой страница не скачивая весь документ то есть это вот меня на при раздражай когда там встречает суку на под документ я должен ждать когда весь документ выкачать а тут вы сразу даете ту страничку которое вам нужно вот мы показали что можно сделать opengl бинарный тип и там мы видим прямо тысячекратно улучшение производить тысячекратно и это конечно тоже вот у нас доступна в отдельной ветке это можно протестировать нам мы всегда готовы к сотрудничеству вот и внизу две ссылки которые говорят вода два других доклада более обширных в которых уже не просто вот то что я рассказал есть содержится описание всех других проектов кому-то может станет интересно это вот как бы расширение синтаксиса новые индексы там до обобщенный и 5 для джейсона мы кстати с этим обожжено piarim.biz он а мы сделали возможность например сделать джин индекс для джейсона знаете что джейн джон индекс существуют для джейсон бей а с помощью того и и пиа я можно сделать и для джейсона и так далее это все вот этих двух ссылках есть что нам нужно сделать дальше нам нужно сделать больше бенчмарков понят что бенчмарки должны быть либо общепризнанные такие как в айсе и сбивайся с бета общепризнано benchmark для не структуре новых баз данных или например какие-то типичные из кейси вот эти из кейса они конечно интересно какие у вас действительно ли так что джейсон как бы использую так как использует джейсон просто чтобы положить и взять или просто чтоб как как правда и какие ключи достаются что вы делаете с длинными блогами с длинными массивами да это очень важно мы знали что оптимизировать чтобы мы не оптимизировали сферического коня в вакууме а как-то сделали доброе хорошие да ну и конечно надо про бенчмарка пудришь с мангой это очень важно потому что я уже несколько раз здесь суд встречал людей которые сказали что они используют postgres но вот часть данных держит в manga потому что вот и нам как раз интересно и вообще stack overflow дело в этом году обзор и показано что 2 2 наиболее используемые вместе базы данных вообще среди разработчиков stack overflow это пузырь из манго то есть никаких других базах данных нет пол рис манга и часто действительно в подвесa люди держат использует традиционную структуру до реляционные данные а в манга и держит вот весь этот мусор джейсон но тем что после он мы улучшаем puzzles мы стремимся к тому чтобы часть вот этих манго и давно потихоньку все-таки пришла к по адресу и этим самым мы будем поддерживать рост популярности пузыриться и поэтому нам здесь конечно очень важно работать с реальными реальными пользователями очень интересно расширить вот этот подход жареных чанков толстых на того чтобы поддерживать строки массивы массивы джейсон of сейчас мы только что поддерживаем только рудого и объекты а надо чтобы еще может была власть ну и типа иерархии то есть потому что джейсон это может быть развесистой дерева и можно вытаскивать не все под дерево кусочка еще внутренние вот большая работа конечно поплава был толст у делать то что все что я сказал это очень под вопросом как интегрировать это все в ведро пуговица ну то есть отдать сообществу мало сделать ссылку на git хоп и сказать берите нет конечно сообщества надо бороться бороться за то чтобы она приняла как сделать вот этот новый api ой как сделать так чтобы тот был как сказать тост знал тип данных как лучший для как и для типа данных сжимать работой например если это просто интеджер нет ничего не надо делать с ним да там если это джейсон то тогда надо использовать вот то что мы наделали если это массив то дальше что то другое то есть мы хотим сделать благо был толстым чтоб можно было сказать там критий был там так далее мы же говорить сейчас сторож extended напье 40 external main plain так что можешь было говорить вместо этого можно было говорить название этой процедуры которая наиболее оптимальна для данных для данного типа это вот такой как бы расширяемость патриса ну вообще подумать над сторожем новым сторожем в котором вообще не толсто типа вот в нем лежали оптимизированы для дерева подобных структур в которых есть большие атрибуты этого то что у нас голове сейчас сидит и над чем мы сейчас думаем ну и соответственно я уже просил что нам нужны ваши тестовые данные запросы если можете анонимизирован дата и дать нам мы будем просто счастливы и рады своим по сотрудничать вот есть наши наши email и можете так далее но я хочу закончить вот такой картинкой действительно оу нет использовались вот я вам хочу сказать дествительно я 2595 26 27 готов работать спорить вам никак не понадобились другие базу данных вот туда doom спасибо большая олег мы вас отправляемся фанатами которые хотя задать вопросы в цифровые кулуары там же за лучший вопрос можно подарить книжку книжка и сувенир традиционные за выступление уже здесь следующий доклад здесь через 15 минут тоже пропал gris через десять минут видео включение очередного подкаста как это прекрасно быть среди живых людей да это очень приятно я хочу сказать спасибо команде файла который подарила вот такое качество мероприятия потому что действительно мы все соскучились по вот мы сейчас смотрели унылые онлайн действительно было как-то ну не то там еще в пол голоса разговаривают поэтому так уныло здесь можно agoda бегуны давайте в десять вечера побегаем на любые вопросы обещаю там все нормально и далее neoflex создает эти платформы для цифровой трансформации бизнеса помогая заказчикам получать устойчивые конкурентные преимущества мы фокусируемся на заказной разработке программного обеспечения используя передовые технологии и подходы наш отраслевой опыт и технологическая экспертиза усиленная готовыми программными компонентами акселератора my разработки позволяют решать бизнес-задачи любого уровня сложности сегодня многие проекты просто развития компании последних лет обусловлено тем что мы работаем на острие самых современных информационных технологий на любые технологии камали these руются и становятся общепринятыми чтобы обеспечить движение вперед необходимо постоянно находить что-то новое я уверен что neoflex такая компания которая иначе но метки развития сможет предложить рынку новые ровно идея вне зависимости от уровня сложности объема задачи и географии мы с заинтересованностью относимся к каждому клиенту мы ценим наших заказчиков и их доверие так как понимаем что именно их выбор дает нам возможность принимать участие в инновационных проектах влияющих на развитие отрасли а если мы беремся за какой-то проект мы обязательно доделываем его до конца из нужным результатам если мы работаем с каким-то клиентам то мы делаем так чтобы клиенты получил то что он хотел тогда когда он хотел из тем качествам до который нам не просто будет стыдно мы будем гордиться стремясь быть лучшими в своем деле мы постоянно осваиваем новые технологии и инструменты развиваем методологию своей деятельности и совершенствуем собственные акселераторы разработки для того чтобы обеспечить максимально качественный результат для заказчика сегодня мы старались делать то что мы не делали вчера если мы задумываем что-то на завтра то обязательно так как мы не делали или это как бы по-новому настроим команды или используем новые технологии или используем какие-то новые подходы но обязательно делаю следующий шаг мы делаем его как-то по-другому как-то интереснее как то лучше география наших проектов охватывает более 18 стран европы и азии и африки обладая глубокой технологической экспертизу и знанием бизнес-процессов мы реализуем проекты для крупнейших финансовых организаций в партнерстве с ведущими вендорами айти решений мы работаем в очень высокотехнологичной сфере области информационных технологий преимущественно для финансовых институтов и сегодня компетентность выходит на первый план банки и компании укрупняются там работают очень высоко профессиональные люди кого же они выбирают в качестве партнеров для своих идти проектов конечно же эти организации в которых с их точки зрения есть необходимая экспертиза которые могут дополнить знания внутренней команды заказчика главное в neoflex это люди их знания и скорость мысли в отношениях с клиентами доверия мы знаем что такое ответственность подкрепляем каждое слово действиям и результатом об этом говорят сотни успешных проектов для крупнейших российских и иностранных банков и компаний лидеров своих отрасли нам мы обречены приятно познакомиться взаимно чем ты занимаешься я архитектор в решении работы в московском офисе компании red hat последние годы 4 наверное я делаю всякие штуки вокруг devops а вокруг выбираете сами красивой архитектурой всего 5000 до я прочитал что ты учу вас компании популяризатора микро сервисов это это маркетинговый ход да смысле но это видение нашего маркетинга я для более скромно прошествии как раз они в принципе да ну и что микро сервис это действительно хороши как они все говорят последнее время потому я частенько начинаю слушать критику критика была есть и будет это неизбежно но в моем понимании это это неизбежно ну на ближайшие какой-то обозримый там перспективу горизонт событий все равно все там будем часто бывает что действительно замечательное технология но технология подразумевает присутствие какое-то культуры и каких навыков вокруг этих технологии часто не хватает ну а какие то проблемы именно валил бы тут понимаешь что то как бы кто я такой чтобы критиковать с одной стороны с другой стороны в неформального общения часто вижу часто понимаю то что допустим вот ситуация с abs с командой сопровождении каких-то там технологических платформ часто бывает то что с административной точки зрения руководства не готовы инвестировать в эту команду люди несколько оторваны от вот общего какого-то глобального цикла им через забор передают задачи и говорят справляйтесь как хотите с ними не ведутся какие-то диалоги о прекрасно получается на выходе то что у нас такая борьба за псевдо стабильность мы боремся за то чтобы просто продолжала горит лампочка на самом деле мы сидим своем отсеке славы понимаем что вообще происходит и что делать что делать есть такая идея то что давайте попробуем переделать психологию методологию работы нашего abs команда в сторону и сэргэ чуть-чуть про наверно терминологии зачем это вообще нужно сергей сергей это сайт ривай ability инжиниринг я очень плохо словно ты фразы дальше это будет сильная аббревиатура а зарыдает стране и по сути это такая специальная редакция на самом деле devops практик потому что делится devops абсолютно те же фундаментальные принципы концепции главная разница то что мы как параноики пытаемся выстроить более отказываю устойчивую структуру с одной стороны с другой стороны мы принимаем перспективу наших конечных потребителей и это безумное логично моем понимании то есть мы мы воспринимаем любую операцию проблему факсов новую проблему то есть с перспективы того же пользователя абсолютно все равно каком уровне у вас что-то сломалось нас просто не доступен сервис перспективу нашего бизнеса на самом деле приблизительно то же самое поэтому все проблемы приступ write софтовые проблемы что проект порождает сдвиг в сознании abs команда садиться за один стол вместе с продуктовыми и разговаривать с ним на равных к и фактически получается что у нас разработчики становятся функциональными заказчиками мышка перешить я не очень прямо зачем этот отличается просто культуры devops потому что df ielts они вместе работали справедливо да здесь мы можем устроить глобальный холивар на тему разночтений именно терминология предлагает виде не делать то есть ситуация такая то что по факту да действительно devops описывает все все все на самом деле что подразумевается его сырые по сути да но по факту у нас не происходит вот этого сдвига но все равно есть некая изоляция команды нету понимания кто за что отвечает если мы идем в сторону и среде и разделяем вот фундаментальный парадигму скажем так и сырья когда у нас все у нас ведь одна большая софтовой проблему тогда у нас не будет разночтение кто за что отвечает ну окей например я понял что у меня в команде если это проблема я такой говорю давайте строить и сырья как это давайте давайте нам нужен человек с определенным административным рычагом который в принципе сможет вернуть эту историю который сможет объяснить зачем это делать и что изменится это во первых во вторых наверное нужно следовать хорошую культурным практикам в в плане создания именно в пузыре комьюнити с рио каких-то команд хотя на самом деле практике также применимо в принципе создание любых команд большей части да это про культура про людей да я бы первым сказал то что провал это нормально ошибаться это это получило человеческие все мы люди и дело не в ошибке не в качестве ошибки в масштабах от ошибки а в том насколько мы поняли где мы ошиблись и что нужно делать чтобы это ошибка не повторялось следующий момент наверное яблок предостерег гоняться за звездами в найме моменте лень членов команды звезды я подразумеваю не просто одаренных и компетентных людей историю когда определенный набор софт скилов двигают человек в вот именно в какую-то такую звездность болезнь когда он порождает какую-то информацию борьбу за власть или как вариант и или на самом деле мы своими руками нанимая звезду или звезд загоняем себя в рамках нашего предприятия в частный случай winder но когда там один или несколько человек действительно понимает как работает та или иная систему ну вот про звезд я как при понимаю когда слышу говорят вот проблема звезд это очень сильно технические специалисты которые ни с кем не считаются с практиками справили объект просто очень так стараюсь деликатно эту тему как-то проговорить потому что это тоже холивар на тему то есть с одной стороны до звезды позволяет очень быстро начать но звезда с с перспективы стороннего наблюдателя будет для нас аномалии потому что у нас такой глобальную всплеск компетенция как любой аномалия надо срочно перспективе катастроф поэтому нужно отыскать какие-то такие середину все и но очевидно вот как как вывод из этого быть абсолютно готовы вкладываться в развитие своей команды гоняться не за идеалом гоняться за потенциалом смотреть на softkey вы причем отцовски выявлению не только в моменте то что парень хорошо умеет рассказывать какие смешные истории то что он действительно понимает как и что он делает в плане бизнеса чтобы он чувствовал бизнес на самом деле все звучит безумно прагматично но акцент живу в реальной жизни этого очень не хватает я думаю если об этом говорит и может быть что-то изменится вопросы доверия вот например частности то есть очевидно то что команда способна сделать гораздо больше чем каждый из нас в отдельности вдова без без выстраивания доверия внутри команды без пропагандировали я вот так такого рода культурных практик но мало что получается на самом деле мало того должно быть доверие со стороны руководства потому что без доверия люди теряют способность принятия самостоятельных каких-то решений и мы получаем вот команда меня не очень сообразительных роботов что тоже нехорошо самом деле мы вроде на нем людей мы долго беседовали мы выдворили с их навыками но с другой стороны постоянным объем их рукам и не даем принимает 705 на решение лайки должна в моем понимании это должна быть такая автоматикой специалист ты берешь на себя ответственность и делаешь эксперимент понимаешь получилось не получилось но объясняешь сопутствующие риски какие-то чем мы можем поплатится за это мы так или иначе у тебя есть свобода самостоятельно принимать решение но это требует очевидно или мне кажется здесь немного по-другому эту проблему чаще слышу о том что доверие как раз очень мало при найме а уже после найма бросают в воду учись плавать сам обычно впечатление складывается прямо на моменте найма на моменте первом собеседовании когда все жутко строгие и спрашивают не всегда адекватные вещи и человек выходит на работу и продолжает жить в такой же парадигме то есть он боится как высунуть голову бы боится проявить инициативу возложи на самых повторюсь да звучит банально убаюкай меня действительно ваш вот наверно еще бы хотел рассказать про момент то что это вот классика окон source комьюнити быть не согласны мы следовать курсу это на самом деле то же вытекает вот из смелости из доверия из-за такой умеренной борьбы системы здесь как-то противоречиво звучит вот здесь мысль заключается в том то что кей для того чтобы развиваться нам нужно экспериментировать для того чтобы для того чтобы экспериментировать на нужно какое-то направление для этих экспериментов потому что мы но очевидно не может быть комментировать во всех направлениях сразу быть несогласным это нормально и ничего ужасного нету но идея заключается в том то что раз мы приняли какое-то направление мы должны ему следовать до того момента когда мы поймем то что либо шаги в этом направлении либо направлении целиком ошибочно тогда мы фактически в реальном времени меняем вот эту вот нашу направленность экспериментов ну в общем другими словами да мы должны избегать аналитический паралич иначе мы будем вечно натыкаться на одни и те же грабли до бесконечности причем такие серьезные глобальные грабли которые нам не позволяют действительно развиваться не просто какие-то мелкие штучки что-то там поколотили нас не получилось а именно таких концептуальный большие вещи но и как твои успехи вот в внедрение от культуры а это неизбежно происходит потому что так или иначе как вот с чего мы начали то что есть запроса и со стороны бизнеса и стороны разработчиков страны безопасности откуда угодно есть запрос цена имплементацию вот каких-то практических вещей с культурой серия так или иначе это нужно делать просто если это делать более и неосмысленно если понимать то что рано или поздно мы туда придем the data наверное жизни наши станет немножко попроще но какие-то проблемы сейчас основные на твоём пути моем пусть они сами проблем мы лак в понимании наверное бизнеса и руководящего состава в в сознании проблематике то есть опять же вот это вот порочная практика то что пока пока у нас каптерке горит свет это буквально равно то что у нас все в порядке хотя на самом деле мы уже серьезно опоздали в нас уже есть большие каких комплексной проблемы то есть это чувство что сопротивление идет не от с персонала обычных разработчика фокусов и прочего а именно за руководство да но это не то что сопротивление это отсутствие такого осознанного понимания что происходит того что очевидно из-за своей роли людям тяжело вникнуть во все нюансы и пока не случится что-то из их вот показатели которые им близки очевидно ничего не случится и вот с чего я тоже начинал по поводу того то что в реальной жизни чудес не бывает для того чтобы случились изменения нужен человек с властью чтобы двигать эти изменения вот нужно найти holod а когда кто нас услышит у нас поймёт и вот он поднимет тогда знаю я желаю тебе успехов чтобы это спасибо большим лак непонимание исчезал и почти все получалось спасибо за рассказ спасибо да класс нет особо времени на представлении николай самохвалов который при ли перелетел через весь мир чтобы быть на этой сцене у тебя 40 минут плюс вопросы если не успеем то вопросы все будут в кулуарах продолжаем разговор о салониках успехов спасибо так что у нас со слайдами пока еще не вы ли да всем добрый вечер добрый вечер вот это правильная слайда меня попросили сделать классную тему спасибо что здесь пришли послушать тема очень интересна будет тема которая так иначе у всех проектов влезает в случае изменения схемы базы мы знаем что очень часто бывают проблемы с производительностью и не только и как раз как сделать так чтобы этих проблем было меньше мы сегодня будем обсуждать еще раз меня зовут николай самохвалов как уже было сказано времени на представление нет я скажу только что более тысячи за свою карьеру изменений схемы реляционных базах но прежде всего позвольте я сделал или заревел то есть я считаю что у меня есть некоторый опыт чтобы стоять на этой сцене и моя компания довольно молодая и после сияй мы как раз сейчас специализируемся опять же на том чтобы улучшать управление в том числе изменениями в частности и делать это автоматически о чем мы сегодня тоже будем говорить сразу скажу что конечно же бывает слышишь в закладе была реклама ну во первых от реклама открытого продукта то есть это полцарства вторых это реклама мы его продукты которые моя команда и я делаем так что я считаю что меня полностью извиняет из кто так считает иначе но напишите в комментах это еще раз я почитаю вот это главный самый главный слайд видите какое мне имя удалось легко запомнить битве хайло . 2021 вы там можете найти эти слайды они останутся открытыми и мы можем с вами асинхронно продолжать если у вас есть вопросы или вы если смотрите вот в ютюбе в записи я кстати призываю всех смотреть holod материалы в записи очень много выкладывается полезно полезного и она довольно медленно устаревает я всегда когда красный чу через океан и я смотрю какие нибудь материал из прошлых конференций так что пожалуйста идите вот по этой ссылке и комменты там открыты ну google аккаунт уже о чем чем мы сегодня стоит ожидать во первых конечно же вот доклад называется таким образом самые популярные ошибки которые делают люди так как я роман комитете холода я за это все эти годы там 2007 года хорошо выучил что если сделать такой доклад то это привлечет внимание и конечно же я собираюсь показать какие-то примеры но это не главное главное чтобы вы запомнили принципы какие то что все примеры слишком много ситуации которые бывают слишком много разных ситуациях что-то ломается и постепенно надо к ним готовиться по мере роста проекта вы делаете то лучше лучше но главное усвоить принципы как готовятся не только к но но он announce да то есть не только не как известно мне известно но еще и канон анонс то есть некоторые это очень сложно но есть некоторые методы они они сегодня поговорим как быть готовыми к совершенно неизвестным вещам чтобы не было downtime а при изменениях схемы а также чтобы еще в целом у нас или заделались бизнес обычно требует чаще и качественнее да ну и соответственно я хочу показать вам как этот путь как выстроить это именно в этой вашей организации кстати поднимите руки пожалуйста кто спас гасом работает до есть люди процентов наверно меньше десяти процентов не с поясом удивительная картина вот главная сцена холода и большинство работать с полюсом 10 лет назад это просто было сложно было себе представить здорово те кто не с посольством вам тоже будет я надеюсь интересно и и некоторые вещи они общие вот он здравый смысл но конечно же некоторых штучки было чисто по две совы и и мы увидим это а терминах д м л д д л я надеюсь все понимают у нас всякий случай да и там many places on line ключ и да это дефиниций like each team или to select a апдейт insert или ты еще можно tranque туда засунуть и наверное еще вы их то есть сети недель и to alter the alter дроп все вот эти штуки и что такое дтп с мая гришин дурацки дурацкое название оно пришло я подозреваю что из мира ruby on rails там так прижилась на самом деле слово такое перри использована перегруженная потому что миграция от обычного там из-за уроков по фгос мы иммигрировали ли еще что то когда мы меняем схема мы никуда не мигрируем да мы там колоночку добавили но почему-то назад так вот никто называют дтп с различают это бы с кимом игры шанс это поезда и там играешь нас отдельно но очень часто это эти темы переплетены как раз в 2019 году доклад назывался дорогой делить я там больше про изменения данных говорил сегодня про изменение схемы но еще раз тема переплетены и изменяя схему в иногда вынуждены и данное менять но в целом это эта тема называется data весьма игре шанс еще вот из википедии можно увидеть да там с change management с кем over шиллинг эскимо evolution в общем вот такие термины есть целом это планированием планируемые изменения в схемы базы из той же википедии мы в перу же первых рядах считая проски мамой грешен видим вот эту фразу что изменение это то тот момент когда система может упасть это большой риск все мы знаем такое понятие как кот фриз обидчив из когда менеджмент говорит что вот сегодня никаких изменений никаких релизов пожалуйста потому что у нас там не за маркетинговые кампании мы не хотим увеличивать риск проблем их можно понять также тут а так такая ремарка что вообще в целом это сложная тема менять схему онлайн без downtime а без проблем в реляционной субд e и это настолько сложная тема что даже иногда появляются продукты которые говорят давайте мы вообще не будем я схему а будем все хранить джейсон и вообще сиквел это плохо и вот он много тебе привык появляется да то есть тут сложная тема и она правда сложная и после в подгрести у нас реляционная традиционное управление схемой то есть вы можете открыть транзакцию поменять несколько вещей и закрытию вас будет атомарные изменения если у вас какая-то будет ошибка то у вас вся транзакция не будет применена это очень классно но тем ни менее огромное количество вещей в плоскости не готовы и вы должны откладываться разными алгоритмами чтобы так или иначе не подвергать систему downtime у и деградации ну то есть у нас риск возникает повышенный когда мы что-то меняем и это относится не только к эти системы в это понятно давайте подумаем какие у нас бывают вообще в целом разные типы изменений разный тип ошибок когда мы делаем изменения в схеме 1 самый простой он даже стыдно говорить но вы не представляете насколько он часто встречается это у нас на проди другая схема не ту которую ждали да то есть у нас вот у нас допустим мы используем какую-то систему versio нирования схемы и это нужно делать например там блэк улыбаясь flywire sketch поднимите руку кому это слова известны видно вот сейчас меньше половины да это плохо то есть ok у вас может быть есть там форекс рельс друга нравился у них свои миграции есть у джанкой свои миграции но так или иначе вам нужно держать схему в гите ну или какую систему контроля версий а еще наше время можно использовать и все изменения треков именно через гид да то есть это маст хэв наши дни и вот у нас там что-то лежит она пройдет немножко другое и это бывает такая ситуация кто-то руками построил яндекс или триггер навесил и у нас из-за этого наши миграция может просто упасть это очень частая проблема я просто ну как бы стыдно про это говорит вот оно есть и дальше у нас есть какое-то тяжелое изменение например какая какое-то изменение схемы подразумевает перезапись всей таблице знакомая ситуация жида и такая вещь она довольно сложная вещь то есть она там букет проблем дальше мы может быть допустим делаем релиз хотим что-то поменять но нам не дают это сделать потому что какая-то транзакция удерживает какой то какой то лог контур который конфликтует с нашим локоны вот мы заблокированы или же наоборот мы четвертый пункт блокер мы что-то делаем и мы заблокировали кого-то каких то пользователей а то и вообще всех там не знаю словно там можно все можно повесить лог на базу и заблокировать всех или 5 это мы все сделали хорошо все хорошо но со временем идёт деградация система потому что наши изменения допустим привело к увеличенному блату либо же мы убили какой-то индекс который нужен раз в месяц и вот первого числа он стал понадобился то есть у нас какие-то последствия уже после релиза вот в целом пять типов ошибок которые бывают если вы знаете 6 скажите потому что я долго довольно думал я не мог ни одну из известных мне проблему а я довольно много их видел сделать придумать еще чтобы она не попала в эти 5 то есть вот эти пять это похоже что все теперь давайте чтобы их почувствовать эти проблемы сделаем вот четыре оси это 4 осени 2 то есть мы такую еще звездочки будем рисовать 4 конечно и вот эти четыре характеристики проблемы да то есть вниз нас по оси y о силе смотрящий вниз это у нас слишком много работы которые нужно делать прям щас например мы должны обновить там гигабайт данных миллиард строчек в таком духе да а верх это много работы которые предстоит полюсу или там sbd ваши сделать потом потому что мы там что-то сделали заложили какую-то бомбу замедленного действия то есть вниз много работы сейчас вверх много работы потом ясно что они не взаимоисключающие еще раз это две разные оси и посей по осям x влево asics это значит что мы заблокирована либо вообще упали при изменении ось x право это значит что через блоки надо это знать что мы кого-то заблокировали идеально изменение выглядит вот так очевидно да то есть мы делаем изменения и их из этих четырех характеристик мы не встречаем изменение которое связано с разведением схемы выглядят вот так мы просто не можем сделать релиз потому что мы добавляем колонку она там уже есть либо мы другим индекс а его там уже нет например то есть мы разъехалась схема до харе кришна выглядит вот так то есть мы не только делаем работы много сейчас но мы ещё и сами можем быть заблокированы когда мы обновляем много строчек например мы можем мы не можем получить эти локи например или же мы блокируем другие другие изменения в базе потому что здесь на изменение конфликтуют если мы в одном запросе будем миллиард строчек обновлять мы захватим лог на все эти миллиард строчек и стать пользователи это точно заметит если мы допустим не можем получить лог то вот это выглядит вот так но еще и тут свет видите другое вправо да еще мы можем может быть мы не можем получить лук но еще и других начинаем блокировать я вам это покажу и в конце концов вот если мы просто кого-то блокируем она выглядит очевидно вот так а пост изменения выглядит проблема вот так то есть вот такие характеристики и что как как эти характеристики выглядят с точки зрения бизнеса да то есть вниз ну мы можем мы делаем много работы скорее всего мы загрузим ресурсы и может быть какая-то деградация но я она будет сразу и это хорошо я сделал более красным вверх потому что отложенная деградация это менее приятная вещь потому что вы не видите сразу вы не понимаете в чем причина дольше диагностировать и исправлять когда у нас случился по случилась проблема но это все самое хорошее если она если у нас если мы соломку постелили видит всяких таймаутов и мы покупали но кейма релиз отменили это очень неприятно бывает но зато пользователь ничего не заметили поэтому это наименее красное влево до ну и самое плохое когда мы начинаем блокировать и мы вас получается либо частично либо полный downtime частичные у нас какие-то функции отвалились на нашем сервисе полный вообще все легло и там весь сервис лег или все сервисы я не знаю если у вас там монолит начнем с очень простого примера там пример вот красным схема mismatch да если мы создаем таблицу и пытаемся ее выполнить на про диана уже есть вы увидите вот такую ошибку всем известную да то есть пользуюсь большим он риддик xii ст все хорошо и дальше начинаются разные вариации решение этой проблемы который я наблюдал жизни одна из команд посмотрев на это решило окей у нас флавий довольно старая версия у нас нет нет онду никаких шагов fly вы описывают только все время движения вперед и у нас возникла на каком-то из инвариантов такая проблема давайте просто что сделаем добавим if not exist да вот кто-то начинает смеяться и правильно делает но не смешно на самом деле потому что вот мне так и не удалось в той команде выкорчевать этот но он он так распространился и стал об общей практикой что в общем довольно сложно от этого избавиться это некоторая уже такая травма на всю жизнь короче то есть люди начинают писать это везде if not exist ifixit и все время предполагать что возможно это наше изменение уже было сделано чем это плохо это плохо тем так чем это плохо мы обсудим попозже давайте посмотрим на характеристику но она очевидно да то есть вот схема mismatch вот я буду показывать вот такие вот глобусы и мы видим что у нас только по одной из этих четырех одном из четырёх измерений у нас как раз вылезло вот я рассказал только что историю там файлы был может быть очень и чего него такое тоже бывает и люди такие у нас нет времени внедрять систему управление изменениями схемы поэтому мы пока там скриптами своими мы написали хорошие скрипты они сами все буду делать мы в ките все мы все держим в общем все это какой-то момент разъезжается и по хорошему как должно быть вот у нас есть система управления которой версии вот одна из этих да это мне просто описывается движение вперед а как я уже сказал движение назад если мы движение вперед и назад можем описать это классно потому что ну по многим причинам я кстати вот тоже в википедии это повторяет мысли которые очевидно если вы у вас есть гуандун вы можете в не production in вариантах откатывать изменение назад да то есть вы можете накатил откатил вы можете еще раз повторить его то есть тестеры становится немножко легче хотя есть более хорошие способы тестировать о них попозже скажу таким образом в идеале вы должны поместить в асеан тестирование ваших дуан ду шагов она совсем в идеале и как я всем рекомендую и некоторые уже сделали это надо дуан да еще раздул почему потому что повторные идут и стирают этот онду если вы неправильно написали онду например вообще его не написали то у вас 2 дух упадет понятно же мы сюда то есть вы создали таблицу у вас пустой онду в создать еще раз он у вас падает только если не у нас чертов if not if not exist существует он как раз у нас такая заплатка такой костыль который делает возможен игнорировать он душах вот именно поэтому его не надо использовать это плохая практика то есть это реальный антипа там изменение схемы он приводит к запрятала нею потенциальных проблем которые потом могут дойти до брода вот соответственно рекомендация не используете их not exist sci-fi quest направо и налево используются только с умом иногда он все-таки нужен нужно понимать когда он нужен и старайтесь описывать еду и онду и положите их всей и тестируете вот в такую цепочку duhn ду ду соответственно также что люди делают например врубил нравился нас есть там возможность переключиться на строка char . и сквер и после каждого измене только дельту вот эту и альпертом клеит недель не только дилер описаны держать в гите но и всю схему мы damping там рельсы с вами это делают но можно повторить для всего чего угодно и в детей всегда есть представление о том какая должна быть вся схема база это легкая операция сдам пицце мы и так вот таким образом нам позволяет контролировать и сверяться с продам да то есть мы можем направлять тоже дампе схему тоже лёгкая операция и дальше посмотреть даже может просто div файла вас уже может поможет показать расхождение там конечно будет версия передам положено но это можно сделать игнорировать это можно игнорировать вот и не игнорируйте ошибки не надо заплатки делать надо их просто решать как выглядит вот раз уж про тестирование поговорили то есть мы про seo и поговорили как общий ландшафт тестирование связанные с разработкой выглядит то есть мы забываем про всякий инфраструктурной задачи про бэкап этом аппликацию как ландшафт выглядит вот мы можем тестировать и схему и данные данные тоже можно тестировать мы можем делать статический анализ можем тестировать схему например там мы не хотим чтобы им поле в котором есть название мфц было типа данных текст и у него не было индекса по lower потому что мы хотим игнорировать кейс давайте мы их будем использовать и текст либо обязательно будет индекс функциональный индекс на lower от e-mail такие тесты можно писать их тоже держать держать sketch позволяет описывать тесты у него есть дуа нду диплом rebirth и еще у меня есть very fine dry файл можете на языке sql или перестань записывать тесты и каждый раз их вся и гонять по можете тестировать данные например вы решили что ради признательности вы выключили внешние ключи так иногда бывает не всегда конечно это хорошо что не всегда у вас нет внешних ключи вы можете данные всякими select a mi протестировать и убедиться что нет строчек которые ссылаются на данных ну да не на что ссылаться да то есть внешний ключ нельзя было бы и навесить можно динамически тестировать вот как раз та тема сегодняшней мы можем изменения самом деле тестировать либо dml тестировать и как раз чтобы это делать мой подход который я кросс всем предлагаю это делать это на полноразмерных базах и и расскажу сейчас как то есть мы делаем это не только на пустышки или на какой-то маленькой тестеры базе но мы это делаем прямо на копии продакшна который развернули быстро за счет тонкого клонирования ну и также можно тестировать разные запросы и там бенчмарки делать это уже другая тема и если мы говорим конкретно про тестирование именно изменений вот и как как делать их надёжно вот есть такая все знают пирамиду маслоу да вот эта пирамида маслоу для change management of в реляционной базе то есть на самом нижнем уровне вот эта система контроля версий который вас обязательно должна быть это ли кубой sketch fly ваэль васу встроено в ваш фреймворк следующий уровень то есть вы как бы все все трогаете через гид следующий уровень у вас есть тестирование duende желательно дуан туду всей третий уровень у вас есть процесса review если у вас нет процессора view это очень плохо то есть не это еще хуже чем в коде не не иметь процессу review потому что вот вы сейчас изменение это то что приводит к проблемам она повышают риск проблем соответственно если нет процесса review нет вторых глаз которые посмотрели на это изменение то у вас проблема еще больше риск возникает да то есть это в помощью нужно внедрить вплоть найти вторую пару глаз чтобы человек посмотрел но опыт показывает что если процесс review ручной то дальше все зависит от культуры опыта и усталости человека который делает review иногда конечно мы все этим грешим мы очень бегло посмотрели и нажали о пруф хотя на самом деле вроде нормально все было а потом downtime потому что мы там что-то просмотрели чтобы не было вот этого на зеленом уровне на оранжевом уровне у нас тот уровень на котором мы краж с работаем чтобы он был нам нужно каждое изменение прогнать сначала до деплоя на полноразмерной базе то есть вы прогнали автоматически потому что если вручную тут пробыл вскипать вот если она автоматически прогоняется всей это наша гарантия что изменение мы прогнали на копии prada собрали диагностику как она себя вела где-то там сохранили и после этого мы можем уже говорить что да это изменение можно править то есть вот оранжевый уровень это самый классный уровень но очень мало компании до него дошли например некоторые наши клиенты такие как git лап они дошли до этого то есть у них есть если создается мертв и квесты в нем есть миграция дтп с datawiz мы грешим то в этом случае автоматически все происходит проверка на тонком клоне всех изменений есть еще вишенка на торте это на самом деле оранжевый уровень не видно что он тоже не полностью защищает это очень хороший уровень и мало кто до него дошел но до него дойти нужно всем я считаю поэтому наш продукт окон source дтп слаб он open source но есть еще конечно же что-то дальше это что-то это например вы делаете изменения и тут неожиданно пришел of the vacuum и он не уступает вам дорогу как известно of the vacuum он он блокирует нас то есть если мы хотим alter сделать of the vacuum нас блокирует но обычный of the vacuum он уступал уступая дорогу автоматически потому что он видит там через секунду что он кого-то блокирует ионов то убивается сам но бывает такое of the vacuum который в режиме forst транзакций найди рапира он привержен да то есть он прилла почивает freeze делая да он предпочтет таблицу из того что у нас 4 байт на идиш ники он фризит тупые кортежи соответственно он нам дорогу не уступят в этом режиме и к сожалению иногда бывает такая ситуация что была изменения очень хорошо протестирована миллион раз но вот именно напротив в три часа ночи мы сталкиваемся с тем что of the vacuum не не уступает дорогу и вот такие проблемы они требуют большого опыта и уже дополнительных соло маг например вы делая большое изменение заранее делаете фриз сами контролируете когда of the vacuum будет таком в таком режиме запускаться именно конкретным таблицам и так далее это только одна из возможных проблем да вот эта вишенка этот ведь она un an ounce да и оранжевый уровень он позволяет приблизиться к мы уменьшить эту вишенку чтобы сейчас вот без оранжевый уровне у вас огромная вишенка и вы просто не знаете что там происходит да вот пример да то здесь я не рассказывал not do the best lap эта штука которая позволяет делать тонкие клоны для любых бас не важно где они и пол и газ аббас конечно только под газ пока что они могут быть под вашим управлением они могут в облаке по сути вы разворачиваете специализированную реплику для вашей базы и на одной машинки вы можете держать сразу там 20 клонов 30 клонов и каждый клон он полноразмерной и независимой то есть можно гонять все альтеры все там клеит индексы в своей базе и это может делать разработчик тестировщик можно развернуть такой клон чисто для тестирования полноразмерной то есть вас появляются полноразмерные среды разворачиваем и за 10 секунд то есть у вас десять трогать база аккаунт прозрач ивается за 10 секунд эта тема отдельного выступления и они были вот и на холоде и тоже зайдите на пост газ . и я и посмотрите как это работает может быть попробуйте себе поставить уже многие это ставят но в целом здесь мы говорим про изменения поэтому java демонстрирую изменения с помощью бота который поверх этих тонких клонов работает и я просто ну мне так удобнее он дал дополнительные штуки привозят здесь я вот просто создают таблицу не знаю видно не видно вообще да видно ok а вот сверху видно что создается таблица 10 миллионов строчек строчки от одного до десяти миллионов in and 4 до 4 гбайт mind плюс какой-то рандомный текст неважно какой и потом внешне ключ на идиш ник повесили вот джоном рассказывает о том но там делать некоторую диагностику о том как вообще изменения происходило то есть что чем вы там занимались видим что айони который был и а нос вот 14 секунд выполнялось это изменение отлично 14 секунд мы создали таблицу дальше мы допустим хотим обновить что-то и мы говорим мы хотим заменить там 0 1 5 9 на большой с аджита просто просто для прикола неважно мы хотим такое изменение сделать если мы делаем вот такое изменение вот если просто его так апдейт с это вот так вот написать то случится следующее в подписи будут все 10 миллионов строчек обновляться то есть даже если риплейс 3 случится если она обновит а когда у нас ожидает плоскости происходит как вы если вы еще не знаете вдруг то старый теплыми помещается устрою строчка физически помечается мертвой создается новая строчка и грубо говоря у вас таблицу увеличится физически в два раза вот хотя может быть этот реплей сообщение кусочку не задействовал это очень неприятная проблема и конечно же такое изменение вот оно здесь я специально поставил начали сет statement time all 15 секунд чтобы показать вот так мы можем упасть это тайм-аут нам нужен он должен быть на продакшен то есть он нас защищает от того чтобы мы не делали каких-то тяжелых действий но у нас случилась проблема как раз мы смогли за релизиться делаем такое измене она не выкладывается и как раз вот эта демонстрация то есть если мы тестируем на полноразмерной базе мы как раз увидим что проблема в том что на маленькой базе у нас может быть там за полсекунды все выбрал там за 100 миллисекунд все выполнялось и мы думаем хорошо все хорошо но нет на большой базе мы как раз увидим на большой базе мы увидим что именно проблема именно в этом и здесь это очень неприятно и вот это изменение потому что она всю таблицу обновляет это тяжелая операция прям щас мы можем упасть стоит мы тайм-аута если у нас есть либо мы можем быть заблокирован и потому что кто-то может что-то с этой таблице делает какие-то строчки сейчас обновляют не отпускает мы будем ждать это это этот лог а еще мы блокируем другие изменения с этой базы то есть это точно заметит пользователя вот так делать нельзя если же мы тайм-аут уберем да мы выполним это изменения но вот он здесь вот она видно что она была 44 секунды и вот эти 44 секунды мы будем блокировать записи в этой таблице на изменения такой пользователь точно могут заметить и общему тону сместился акцент здесь нарисовал череп потому что это реально очень плохой из плохая ситуация мы блокируем всех плюс плюс еще смотрите вверх по оси которая y вверх а мы у нас появилась проблема почему потому что если мы меняем всю таблицу апдейтом мы создаем вот 10 миллионов мертвых кортежей даже если придет of the vacuum их и всех пометят нас будут свободные пространства физическом loyalty это так называемый blot вот именно так он объеме он появляется массивная операция приводят к блату да то есть таблицы раздулась и нам потом нужно там репак запускать и так далее вот имена вот так делать нельзя и поэтому у нас по y вверх появилась измерение потому что мы приводит к тому что больше тяжелой работы в будущем какие будь сканы замедлится то есть мы ухудшили работу на будущее мы это можем не сразу заметить там через неделю чё ты как ты там деградация пошла ну конечно делегациям и блок сами себе одному на ровном месте устроили если посмотреть под микроскопом вот как раз этот бот он приводит этот план точно так же да и транслирует его здесь я не показал но он транслирует его в мы поняли что обязательно добавь epc включать когда вы explain анала и сгоняете чтобы видеть сколько данных не только в логическом уровне rose а еще сколько именно физически данных мы потрогали там хитрит этом за запись терся тритон до чтобы мы видели эти числа и чувствовали как операция работает финна физическом уровне и мы так же заметили что хорошо бы это еще в байты переводить то есть обычная страница по умолчанию плоскости 8 кибибайта есть мы умножаем просто эти числа на 8 кибибайт и приводим вот гигабайта мегабайты мебибайт 1 гигабайта до соответственно так мы видим что этот апдейт у нас было 459 гигабайт хитов конечно там многие страницы были фитиль из много раз это понятно но мы почти гигабайт там 700 мегабайт мебибайт мы читали с диска там скорее всего с диска тут или тут на этом уровне не видно потому что это возможность каша персоной system now видно что это очень тяжелая операция и это не то что вы хотите получить в релизе вот как раз здесь я демонстрирую о том что если мы возьмем строчку у нее физический адрес соц сетях где то скрытая колонка вы всегда можете ее за select этих любой таблички для любой строчки вот начале у нас и упал на что есть кортеж лежал по адресу 01 да тут у меня навесить миром а вот он лежал по 0 0 1 то есть он на 1 на 0 страница 1 упал а когда мы сделали апдейта причем мы ничего логически не поменяли видите сет и вообще ничего не изменилось но мы видим что адрес изменился потому что свет на тот тип он был помечен мертвым у нас новый живой тепла родился вот именно вот так у нас проблемы возникают даже если мы ничего не меняем вот это был со очень тривиальный example давайте подумаем что здесь можно делать конечно же прежде всего надо сократить количество работы в в одном шаге да то есть нужно разбить на бача такую такую ситуацию на кусочки и возможно вам потребуется вневременный индекс для того чтобы по этим патчем быстро находить следующий патч до то есть чтобы потом поедим и должны идти ли еще как-то у нас возможно если индекса еще нет мы должны его сделать и конечно очевидной оптимизация если у нас там от возвращаясь к риплейс у мы можем если у нас этих символов нет значение но не нужно эту строчку вообще трогать потому что апдейты приведет к новому мертвую кортежу зачем такое вот а дальше интересный момент вот мы разбиваем на даче и там с какой-то скоростью движемся во-первых моя рекомендация не думать про параллельную обработку вообще один поток хватит чтобы вы можете грубо вот на скидку на миллиард строчек в день можно сделать обрабатывать если возможно я машина вы должны на боярство очень уметь обрабатывать на фоне да и не сильно мешать пользователям конечно зависит от конкретной ситуации нагрузки ресурсов и так далее это довольно довольно много но если вы начинаете проанализировать вы себе как бы режется сук на котором сидите на самом деле то есть вы сами с собой будете там конкурировать и убивать производительность лучше в один поток все делать но очень важный момент какую какой размер бочче подобрать вот очень простое если у вас о типе то есть это у вас свой мобильный сайт либо веб-сайт то простое простой как метрика это секунду это уже медленно да то есть ваша будет зал учат определенное количество строчек и пользователи могут это заметить если это будет длиться несколько секунд очень большая вероятность что они будут недовольны а пользователи обычно вот 100 миллисекунд это еще более менее быстро хотя уже заметно 1 секунду я тоже медленно а там 10 секунд недопустимо пользователь просто будет считать что все ничего не работает тормозит и так далее вот поэтому надо бате так подбирать чтобы быть меньше секунды слишком дробить тоже плохо потому что есть традиционный оверхед если вы раздробите там по одной точке будет обрабатывать все 10 миллионов увидите как у вас общее время увеличивается есть транзакционные вверх это в целом это не хорошо то есть вы вы бы хотели побольше baci но то же время вот есть такая метрик вот одна секунда это вот золотое золотое число которое вот для для всяких обновлений как раз подходит вот ну и есть еще хорошая практика контролировать размер количество дать уполз ебло то с помощью дополнительного анализа и смотреть нам иногда немножко паузу сделать чтобы авто wacom отработал либо даже в вакуум самим прага вручную ну не вручную автоматизировано если у вас реально очень много стоящих обновляется вот ну третий пример вот мы хотим у допустим у нас есть айдишник я отказ табличку сделал 4 байт ней айдишник многие наверно с этой проблемы уже сталкивались вы хотите вставить 2 в степени 31 и видите вот такую ошибку хорошо если в эту ошибку увидите где-то в не production окружении потому что если вы увидели и production окружении это очень неприятная проблема не такая неприятная как транзак шнайдер up around конечно то есть касается только сегодня той таблице но если это таблица центральная вашей системе там в сервисе в этом это очень ну в общем очень меня были ситуации когда это приводило к down down time у этого сервиса до несколько часов слава богу это было громко 2008 был очень неприятно с этим дело иметь то есть вы хотите знаете об этой проблемы заранее хотите поменять на что на 8 байт ней int этот личный ключ как это можно сделать но вот так это можно сделать и вот для нашей 10 миллионные таблицы это заняло 4 спальни минуты это самый самый самый плохой пример то есть видите что он по всем осям плохое то есть очень много работы сейчас мы раздули таблицу много работы на потом мы скорее всего будем долго пытаться получить лог мы будем блокировать всех-всех это отвратительная вещь то есть вот так вы можете сделать только если вы разрешаете себе downtime maintenance window обновили дальше поехали вот но в целом это очень неприятно я сейчас у меня совершенно нет времени чтобы прямо окунаться носом не нужно час минимум чтобы в всякие детали различные решение этой проблемы я могу рассказать в кулуарах на самом деле я рассказывал на после вторники у нас есть в ютюбе у нас есть такие вот онлайн митап и группа сбис можете поискать учебе и там рассказывал об одном из путей решения этой проблемы под названием новая колонка да есть два пути новой колонкой новая таблица вот есть такие еще пути там есть можно перестать туда писать конечно да и или же многие вот такие а мы же можем негативное значение тоже используют потому что ведь у нас почему там 231 они они 32 потому что этот это sand and то есть у него есть негативное значение но там не всегда это возможно то есть либо у вас в коде что-то не так выйдет либо вёл там в общем это не очень такая идея хотя принципе она имеет право на жизнь но это все уход от проблемы да нормально решение проблем это либо новая колонка либо новая таблица но очень коротко новая колонка там вы создаете но эту колонку делаете триггер чтобы трека все новые строчки вы погружаете старые данные и делаете это так что дайте на но старые данные по сути увы синхронизировали да уже новый конкурс о старой и дальше возникает проблема которая очень интересно что до 11 по фгос а она нормально не решается то есть вам а ну то есть две вещи да вам нужно во-первых что первичный ключ на новые колонки объявить вам нужно уникальный индекс создать то есть если вы просто дропните привычное ключи сдадите привести к вич вы опять же получите блокировку пускал полной таблицы опять тоже самое все ну почти тоже самое но неприятно поэтому вы должны со заранее создать уникальный индекс на основе которую первичный ключ будет работать но это еще не все вам нужно но знал потому что просто уникальный микс он разрешает налы а первичный ключ ему нужно чтобы над на лбу и вот-вот нал самое интересное да нам нужно еще заботится внешних ключах но уже не будем этих мелочей касаться хотя они тоже могут есть куча времени значит индекс вы конечно же будете со словом конкорд ли закон конфетка очень важно и вот как раз если вы допустим используйте все автоматизированным средством тестировать если вы забудете конкорд ли это будет отловлено и на продакшен точно не пойдет потому что без него мы блокируем ся вот я тут уже пропущу немножко давайте потому что времени не хватает значит до 11 под газ а у нас не было никаких возможностей сделать нот на у без блок без к на все таблицы соответственно alter the ballad таком not now добавление она за она приводила к стану все таблицы это была тяжелая операция и это прям вообще них не обходится к сожалению в 1 ст об адресе так как сделали не блокирующий дефолт то есть вы можете добавлять новую колонку говорит что дефолтом что-нибудь и это не приводило к перезаписи всей таблице то есть от дефолта виртуальный все старые строчки получают это дефолт виртуально мы можем вот какой там нет меня осенило мы же можем при этом еще и нотном сказать и старые строчки а ниже уже заполнены и мы им им и они как бы они не заполнены они виртуально заполнены этим -1 дефолта и поэтому на канал он не будет приводить никакому скан он будет очень быстрый и таким образом мы можем вот сказать но от наладив от минус 1 до новые колонки которые 8 байт на и это будет очень быстро то есть это было прямо открытие которое с 11 подвеса и позднее она доступна этим надо пользоваться потом мы его так заполняем все старые строчки -1 превращается уже в настоящее значение в старое значение которой все меньше чем 2 в степень 31 -1 и или равно этому значению и дальше мы уже убери можем дефолтный -1 свое дело отслужил можем его дропнуть у нас как бы состоянии колонки готова к тому что первичный ключ навешивать это вот как раз такой трюк который очень помогает вот таким сложным операциям вот ньютон был к сожалению 3 говорит реально минимум полчаса что просто сказать алгоритм поймаете меня в кулуарах расскажу с удовольствием это очень интересно и там интересные разные проблемы возникают которые могут стрельнуть и я помню как раз как мы все для одной крупной компании американской мы решали все эти проблемы и в три часа ночи окрас force staff the vacuum не позволил зарелизить хотя все проблемы были париж он повешены то есть это краса новым on on on on on приехал вот напоследок членов blockers это очень интересная вещь то есть если вы у вас есть вы хотите просто alter ты был этот колумб просто добавить колонку and 8 любую вы знаете что это очень простая операция для подвеса но вот так получается что вы почему-то не можете добавить либо вы начинаете добавлять и видите что все ложится такие ситуации бывают почему если у вас открыто транзакция причем касательно на первом месте даже это вот старые слайды похоже не обновили я специально сделал первую сессию там был select то есть просто select из этой таблицы andro загса еще не завершилась как эта транзакция поработал с этой таблицей сделала select шерлок нокаут на какой-то строчку мы делаем alter и мы не можем alter сделать потому что мы ждем когда татар за акция закончится это ещё не самое плохое было балки если мы просто не могли получить лог то мы упали самая главная проблема что мы начинаем вообще запрещать все запросы к этой таблице пока мы ждем то есть возникает цепочка блокировок наш alter если есть долги транзакция к этой таблице незавершённые он по сути ждет когда когда будет окошко до чтобы влезть и если у вас весь долго транзакция вы можете реально положить таким вот не все до этого дохода то есть вам чтобы это почувствовать нужно чтоб проект выросла но вот тут при этот скрипт который позволяет увидеть дерево точнее лес деревьев блокировок потому что их может быть несколько деревьев вот это дерево там видно прям что вот у нас там этот запрос блокирует то есть у нас alter возникает все демки этой цепочке но в реальной жизни он там у него очень много детей которые которых он заблокировал да и это неприятно как это решить вот совсем там недавно чуть больше года назад депеш поднимал эту тему в своем блоге все мы все за кто в позу с теми знаю депеша хубертус hubert любашевский он так он описывал что можно делать ретро и но он описывал это с помощью там баша либо питона в общем какого-то внешнего средства и это классно но на самом деле бывает сложная операция когда транзакция состоит из нескольких шагов и делать ретро и вам же нужно в стразах отменить эти шаги приходится повторять кто-то в комментах а конкретно михаил великих его не знаю но он молодец а то есть он очень классный предложил рецепт мы можем с помощью прп джейс quelle ретро сделать такими локальными и не отменять все предыдущие шаги в транзакции вот здесь маленький кусочек кода постам можно ссылку java на слайде дал так что вы можете пройти по ссылке есть откроете эту ссылку дам битлы хайло 2021 соответственно вот этот это то что должно быть у всех у всех altar of это должно быть у вас поставляется лог тайм-аут например там 50 30 миллисекунд 50 леску нормально и после этого мы мы делаем допустим там 100 попыток получить сделать alter каждая попытка будет длиться всего 50 миллисекунд и мы будем так вот че хоть чуть-чуть да то есть мы на 50 секунд если у вас не получается лог мы блокируем всего лишь написать милисекунд милисекунд все 50 миллисекунд мы заблокировали дальше следующая попытка и мы не выходим из на загсом и внутренние вот бегин exception м тут этот блок он позволяет это делать и если там нам не хватит там тысячи попыток ну извините у нас упадёт миграция пользователи вообще ничего не почувствуют это очень классный рецепт вот вот он вот так выглядит по нашей классификации видите оранжевый . посиди не больше у него нет никаких негативных эффектов именно так и нужно делать все альтеры вот я буду заканчивать потому что у нас уже совсем нехорошо со временем да очень простые слова которые краски хотел бы донести моя философия в деби и области это тестировать все то есть даже самому себе иногда не верить а идти попробовать то есть если в чем-то сомневаешься возьми и попробуй я вижу что иногда люди там сомневаются идут какие-то в чат задавать вопросы попробуйте сначала сами и чтобы пробовать реалистично и что было пробовать удобно подумайте в сторону тонких клонов посмотреть и то чем мы занимаемся после сияй наград делаем это тестирование удобным то есть вы можете там терабайт ну 10 ромбовидную базу от клонировать за 10 секунд попробовать выбросить ее именно вот этот подход как раз то есть тестируете и сделаете среду тестирования удобные для себя вот ну да то есть тут вот я немножко еще про дтп слаб то есть мы без этого то есть мы сейчас в этом году к 1 плотно занимаемся темой чтобы эти тонкие клоны тестирования на них именно миграции было всей автоматическая как я уже сказала если нет автоматического значит кто-то когда-нибудь начнут забывать и либо нет времени и пропускать этот шаг все это обязательно будет сделано вот без тестирования он всегда вот эти вот эта вишенка огромные экспорт прогноз если взять это без лап у нас прямо вся и появляется вот клон тонкий на нем мы тестируем там есть интересные вопросы безопасности и как это делается так чтобы там персональные данные не язык использует чтобы никто их не видел мы все это решили то есть это за рамками доклада но это все решаемо но я уверен что в этом будущее тестирование миграции то есть именно на полноразмерных базах нужно их прогонять всегда вот ну это куда можно пойти чтобы этой темой поинтересоваться у нас есть лак telegram нраве на русском под при снятии к нашему телеграмму и если вам тема интересна та посмотреть еще вот на эту страничку у нас есть кастом едва из групп которые мы набираем сейчас чтобы именно по теме тестирования миграцией на тонких клонах если у вас есть плоскости вам проблемы это близко по присоединяйтесь заполните формочку мы с вами свяжемся и обсудим именно вашу ситуацию вот минутка рекламы вот все то есть мы можем общаться в кулуарах я могу на самом деле продолжать но у нас по музыку конец со временем да то есть как со временем ну смотри либо еще две минуты ты выступаешь либо берем да давайте лучше вопросы наверное давайте два вопроса друзья руки в небо смотри вот раз два остальные тогда в зоне цифровых кулуаров можно будет продолжить разговор здравствуйте пасибо большое действительно очень жизненный цикл от скажем так и вопрос про дуан ду и вот их not exist вот вы говорите что это прям какое-то такое очевидное зло но вот к примеру есть большая табличка нужно сделать alter вот как пока был пример alter и нужно сделать это не блокирующим способом ну например способом новая табличка до каким-то фановым и вот как то есть этот процесс может в любой момент упасть например чисто теоретический вход мент когда будет перри накат он пойдет заново все это делать так вот как в этом случае убедиться что мы не будем заново всю эту новую табличку переливать пересоздавать и он просто проверить что же все накачана и выполнится покажите давайте разделим у нас есть схема есть данные что вам мешает разделить это изменение на несколько шагов первые замене изменения будет только про схему оно должно быть быстро вы оборачиваете вот эти ретро и логика вы получаете это то есть я не понимаю зачем нам там иметь какой-то эффект диск и внутрь здесь да то есть а дальше уже данные данные там больше а ты что там что-то пойдет не так упадет ну и там можно insert selecta мы либо там копи какой там откуда-то и это уже будет другой шаг до то есть у вас первый шаг завершился зафиксировали так и зачем кончились тогда как в игрушки да то есть а дальше уже второй шаг делаем правильно то есть да ну вот второй шаг он же допустим вот на втором шаге который переливает данные например он падает и в отель и номера да ну смотрите там вы зависит конечно от данных но как правило мы там это одним шаг одним запросом делаем ensure select и все то есть он падает к бы отменился нас традиционная и синди система и она просто все от меня то есть вам там никаких эффективен мне нужно будет если вы я видел ситуации когда люди пытались шаг разбить на кусочки чтобы не допускать долгих транзакций но и такие к чему хорошему не приводила бы да у нас не было долгих транзакция но разъезжались данные то есть это не хорошо и второй вопрос вот по центру андрей ван young смотрите я может быть пропустил мы вас ничего не было сказано прадед локи у вас случаются такие в паз грехи такие вещи когда вы накат и выйти на например реки бальзам апдейт транзакции падают в продакшене я из мир и mssql то есть я честно говоря не очень работаю спускаться мы только планируем нашей компании вот и как бы с этим как как вы обходите подобные проблемы с дидлами у нас есть как раз крупный клиент по которой рассказывал там как раз тоже уехали с microsoft sql это нормально это что люди приходят в мир после существенно так и ну да блоки в любой cbd они есть лагает оных определения в плоскости есть настройка т.д. длог тайм-аут после который случается проверка помолчали одна секунда и если долг наступил происходит убивание одной из сторон да то есть и я понимаю но в этом случае понимаете да давайте договорю договор это говорить всегда когда наступает до двух еще простое правило независимо от свободы если суп это нормально реализована и плоскости маятника 100 спенсер в этом плане нормализована это ошибка клиента то есть он неправильно спроектировал это допустил такую ситуацию нужно забираться в каждом случае бывает очень сложно бывает бывает даже на самом деле что мы допускаем что у нас там немножко дотла как бывает в день там сколько-то и так спроектируем приложение что это неизбежно если это касается именно миграция но нужно садиться разбираться конкретную ситуацию тут нет универсального рецепта вы вы не пробовали понижать приоритет блока приобрети и пытаться со своей стороны увеличивается этот лак тайм-аут ну вы мы с келли мы можем например поймать ретро edit log со стороны апдейта и попытаться обработать эту ситуацию на эти чем переписывать клайд тут очень сложно говорить какие-то общие рецепты ну во первых там можно до доктор mode увеличить может привести к нехорошим последствиям что дальше можно делать как правило локи которые мы транзакции носика правило это так и есть все логе которые мы захватили они будут освобожден только в самом конце когда случится commit и rollback поэтому мы стараемся тяжелые локи обычно вкусом и на самый конец приносить этот общее правило да то есть не торопиться но если мы хотим миграцию сделать возможно имеет смысл сделать локти был самом начале потому что то поделать и потом уже за к мите да если мы делаем локти блузы рабы уже одни с этой таблице на один да мы можем локти был обернуть тоже в такую живут конструкцию даже нужно это сделать с 3 троими до чтобы если на слух не получается что мы других опять же не блокировать даже selecta блокируется при этом мы и вот free троих лог получили и все до конца транзакции таблицы наши вот наверное вот такая такой подход в вашем случае может быть имеет смысл я могу я вам предлагаю продолжить да мы обошли у нас мы это все сделали просто и вас хотел спросить как тогда сложно без деталей можно детально обсудить в цифровых кулуарах сейчас вместе пойти чтобы не ограничиваться спасибо спасибо большое за доклад молодец врезал себя с часа до 40 минут просто мужчина друзья в шесть часов у нас разговор с просто промсвязь банком и в 6:10 будем говорить про процессор эльбрус увидимся хорошего всем окончания дня на мы где не привет я артём я экс редактор хабра и ведущий подкаста мы обречены рад познакомиться даже приятно predator team ну рассказывай чем занимаешься да во всем по чуть-чуть вопрос в госбанке насколько это возможно но насколько я знаю если ты работаешь государства банки тебе немножко сложнее настраивать все и выбирают инструменты и соответствовать другим требованием надо безусловно да если говорить про какой-нибудь например стартап конечно у нас очень большая разница но если говорить про какие-нибудь мировые гиганты типа там например google а фейсбук и мне кажется у них тоже не так легко и быстро взлетают какие-то активности просто не про это давным-давно узнали и раньше как бы нас могут это все протестировать проверить у них там есть научные какие-то лаборатории исследовательские команды рэнди отделы там не знаю может даже департамент который занимается у нас же это по сути ложится рядовых drops of которые так скажем на чистом энтузиазме предлагают улучшить там текущие современные процессы там теми инструментами которые востребованы сейчас в мире в чем для тебя самая большая трудность и разницы по сравнению с тем что за делал раньше до того пришел в государственный банк я пришел банк чуть меньше двух лет назад полтора два года назад вот пришел как раз таки заниматься тем чтобы развиваться домов с направления да и как-то привносить какие-то современные стандарты как раз таки в нашу компанию вот и получилось так что там у нас уже была небольшая команда там порядка 10 человек и мы активно разрослись сейчас нас там порядка 50 мы очень сильно нарастили мощь как раз таки в автоматизации непосредственно потому что не буду скрывать раньше года там в 2017 наверное псб тогда это получается чем промсвязьбанк наши один где все эти учитывают в промсвязьбанке обновления были практически ручного характера да то есть инженер это ручками заходили на физический сервер а то подкладывали какие-то файлики ребута ли какие-то сервисы что с этим делать на вот а потом это все начала активно как раз таки развиваться как раз тогда стало 20 это вся культура модно интересно и прикольно да и все стали мне переключаться вот и как раз вот где-то там получается в 19 году туда пришел я а вот меня позвали как в эту всю историю начать усилять развивать вот как раз таки завод почти то погода мне кажется не сделать большой шаг к современному ему так скажем да вот сюда вот прошло вот когда vox называют а мы с точки зрения культуры с точки зрения технологического стыка и процессной составляющей то есть очень сильно выросли и если поначалу набирали людей чтобы тушить пожар и потому что систем было большое количество digital как бы очень растет сейчас да там добывай системы расширяются просто колоссально быстро количество разработчиков нас команды там росли просто с геометрической прогрессии какой-то и вот как раз в этот последний наверное полгода у нас уже получается активно двигаться в сторону и рэнди то есть никак как раз таки развитие там походу дела так скажем обходилась обходилась тем чем есть вот сейчас большое внимание уже выделяем как раз таки развитию и каким-то новым современным видением который мы хотим использовать поэтому потихоньку переходим на декоративные описание инфраструктуры там использования с подхода инфраструктуру как кот там для написания скриптов описаниями описания непосредственно там наших нашего окружения можешь прям вот чуть конкретнее это пример написать например что ты не можешь использовать и чтобы ты хотел использовать от чего тебе приходится отказываться в таких условиях допустим появился какая новая фича мы хотим и я тоже тоже естественно использовать мы начинаем это все там тестировать у нас соответственно есть разные тестовый полигон и тандыр стенды тестовое окружения вот на которых мы можем там что-то проверять вот случае если используется что-то вообще новое что то так скажем вероятностью каких-нибудь уязвимости до взять мир туже контейнеризации почему ее не секрет же да говорят что в контейнер и образы это вообще не про безопасность то есть это не очень северные штуки и ну понятно почему да то есть и вот мы как раз таких как госбанк глубоко анализируем эти вещи то есть мы не просто но будем работать с контейнерами да заходим docker hub скачали поехали нет мы покраски прорабатываем вы будете процессы как мы на проверяем там до грубо говоря агрегирует компаниям создаем свои какие-то образы из каких-то базовых штанов образовал да там и так далее то есть мы выстраиваем целый цельный комплексный процесс но вам же вы же не отказывайтесь вообще эта идея сама подхода контейнеризации просто как ты ее не конечно услышано вы используйте вот эти все докеры каберне this и то что сейчас пишут в резюме devops а то что надо знать мы к этому движемся то есть я не знаю там могу говорить не могу есть какие то такие вещи вот в продакшен у нас пока такого нет то есть мы к этому как бы активно идем готовимся нарабатываю тоже мышечную массу экспертизу очень часто со беседовал народ и люди настолько привыкли работает с вот виртуализации контейнеризации совсем и подверните с когда я docker и так далее что забыли про некие вот прикладные уровне на что есть там железо которую как-то работает там ну и так далее пристом монтировщик и аппаратные какие телефоны с которыми там нужно который очень топорно там деле типа связи пользовательский ну то есть там много очень нюансов и как раз таки когда мы выстрою выстраиваем вот наши процессы это очень круто для наших специалистов потому что это заставляет и в первую очередь покачивается более широко более глубоко как же наверное сложно нанимать людей при таких условиях и какова же уровня люди должны приходить сюда чтобы ты их брал совершенно тут сложный вопрос тут на самом деле наверное нам очень везет потому что у нас очень крутая команда очень классные ребята очень сильная то есть на самом деле так чуваки они как бы и так скажем за приклад секунд да то есть они знают как грубо говоря происходило там обновления 5 10 лет назад то есть на более вот таком низком опорном уровне и при этом они у них есть понимание как так скажем на современном уровне сейчас это происходят от и с помощью где распределенных кластеров каких-то вот этих всех штук одобряли ну тут очень сильно конечно мы стараемся уровень наших сотрудников подтягивает мы регулярно проводим какие обучения отправляем на внешнее обучение wine спикером спикеров к нам банк чтобы приходили люди рассказывали нам что случае происходит в мире да какие есть современные штуки что все там давно в облаках что губернатор докера и самое главное как к этому прийти потому что понятно дело что ну не сложно поднять там настроить кластер да не сложно чтобы все это работало вот когда у тебя нет выхода там никакого в интернет вообще ниоткуда вот это сложно вот это становится сложнее вот здесь уже включается как раз таки креатив и интерес что как все должно работать а как все проверки должны обеспечиваться как у нас там трафик должен сходить клиенты подключается как у нас там несколько прокси-серверов там и так далее то есть здесь уже встают интересные вопросы интересные кейсы что не так просто как бы работать как раз таки в сегменте который вообще не имеет доступа некуда то есть вот он сегмент мы банк который спросят гособоронзаказ мы обязаны так скажем придерживаться всех передовую и возможность критериев по защите и соответственно конечно у нас очень но к этому относимся ответственно и безопасностью нас очень ответственно и поэтому этот момент данными творится хорошо ну естественно есть различные фронтовые системы сервис эквайринга там все прочее которая конечно же в интернете там и так далее но к ним тоже повышенные требования безопасности которые мы обеспечили вот поэтому возвращаюсь к вопросу значит провод как мы людей ищем ну что как бы люди там эксперты по кубе рам и так далее это очень круто это очень востребована просто так получается что они не всегда с нами так скажем совместимы да то есть мы не совпадаем вот этим штукам потому что мы сейчас это все только нам нужно люди в дальнейших широкого формата до который как бы знает а было как должно быть в будущем куда мы стремимся то есть вот так получается что мы вот на пересечении как раз таки сейчас этих двух эпоху да когда мы уходим от каких-то вот вещей таких постулатах вот в 10 х 15 х годах его двигаемся в новый я тебе желаю успехов справляться с этим чтобы все было надежно и дальше но и чтобы вы шли чтобы все получалось сделать удобно и современно совмещаете спасибо большое спасибо пользуясь случаем а у нас есть пару вакансии если интересно и более глубоко изучать так скажем стандартные вещи того пожалуйста просим на сцене дмитрий завалишин спасибо и мы переходим от от кода переходим к архитектуре процессора а где здесь есть кто-то 85 года рождения вот вот столько лет дмитрий пишет код я уже не пишу лет 10 надо все остальное да все остальное в баскетбольной площадке прошу спасибо за вопросы в конце спасибо что пришли спасибо что досидели до этого момента если кто то из вас уже работал с эльбрусом то вы к сожалению от меня ничего нового не узнаете это будет такая обзорная обзорный рассказ но наверное может быть я парочку слов скажу про то что там мало кто рассказывает тем не менее общая идея бы хотел чтобы просто знали что это такое потому что про него ходит много разных слухов толков чтоб человеку или груз во первых он не является ничем клоном это абсолютно российская разработка на самом деле еще советская разработка он уходит корнями в далекое прошлое полностью спроектируем россии есть версия которая в россии изготавливается на наших заводах но конечно самые боевые мощные версии делаются в тайване нет см7 эльбрус и про это же есть много разговоров умеет исполнять код x86 но делает это не совсем аппаратно даже на самом деле совсем не аппаратно путем бинарен трансляции я про это отдельно расскажу современная версия эльбруса нация с 14 года уже выпускается да это довольно мощный процессор до 16 ядер 2 гигагерца и надо понимать что это 2 гигагерца не тех же самых что у интела потому что эльбрус умеет запускать на один такт до 50 инструкций правда это надо кое-что же суметь ему выкатит такой код чтобы реально заполнить все возможности но технически это возможно серийное производство 14 года и уже на сегодня поддержан довольно широко операционными системами в основном конечно линуксом ну вот я сам внезапно только вчера готовят этот рассказ узнал что оказывается даже есть версия unix ну и еще есть российские у совы которые сделаны для эльбруса в принципе на самом деле кстати вот под возраст который здесь вот до меня два раза выступал давно у нее перенесён и вообще-то довольно много кода на него перенесена краткая история что примерно понимать чит 1 эльбрус появился в восемьдесят седьмом году 15 миллионов операции 64 мегабайта для то время это была бешеная совершенно объем оперативной памяти и сам он тоже родился не на пустом месте к этому моменту момент уже была бэсм-6 которая была самая производительная советское время и в общем даже среди мировых она в некоторый момент занимала первые места девяностый год эльбрус 80 из нитей год вылез 2 до 8 процессоров в параллель с 25 миллионов операций эльбрус 3 ему не повезло он пришелся на деградацию советского союза и хотя он был сделан на общем собрали один экземпляр дальше он не пошел после этого там были смутные времена и разработчики которые проектировали придумали эльбруса не в на самом деле работать на компанию intel и там даже есть патенты наших вот людей которые до этого работали на эльбрус а потом помогали делать в частности с с е инструкции для компании для процессоров intel и вот только в четырнадцатом году выходит первый процессор эльбрус в виде микропроцессора уже он во многом наследует идеи вот этих первых трех эльбрусов хотя и довольно сильно не одних отличается но и в общем про это поговорим вообще и я сейчас буквально еще одно слово скажу про предыдущий слайд надо понимать что эльбрус и это действительно довольно специфичный вид процессоров они изрядно не похоже на то к чему вы привыкли есть базовые инструкции все те же самые вот там еще такого буде удивительного нему не увидите сложение и вычитание умножение jump и переходы все это в общем там есть но тем ни менее архитектурно процессоры очень сильно специфичные чтобы понимали насколько они специфичны и вот в процессорах эльбрус и один эльбрус 2 вообще эльбрус и отличаются от всех остальных процессоров так называемый тяговая архитектурой процессор те герои данные в памяти таким образом что он знает тип объекта в памяти когда обращается в памяти какому-то значению обычный процессор просто считывает бита вую строку и дальше трактует как float или int или pointer или что то еще эльбрус точно знает что там прилежит с той стороны так вот современный эльбрус отличает только pointer и и данные вообще а предыдущие эльбруса знали настолько много про объект на той стороне что например поддерживали такую вот вдумайтесь перечную операцию в эль бросят 2 можно было положить память такой указатель такой объект что при попытке считывания значение этого объекта то есть обращение памяти на считывания данных из нее прозрачно для для вызывающего обращающегося куда вызывалась функция адрес который находился в этом объекте она отрабатывала ее результат подставлялся как итог команды считывания из памяти с этим масштаб того что там была реализована в современном эльбрусе все попроще существенно много таких вещей в общем из него убрана но тем не менее это довольно интересный общем очень не банальный процессор пойдем дальше 21 год вот на сегодня он уже существует правда это все-таки еще пока я знаю тестовый экземпляр и они еще не пошли прямо в серию серии в серию он уже делаются на них платы это вот эльбрус 16 из 16 ядерные 2 гигагерца еще раз напомню до 50 команд на один такт поэтому это прям существенно другие 2 гигагерца технически он позволяет но в иране технически архитектурно позволяет дождь из четырех процессоров неправильно написан у меня ядер собирать в сампе систему по 16 ядер в каждом да и опять же я не знаю сколько реально возможно потому что мы понимаем что одно дело это в архитектурной возможность другое дело нагрузка на шину и реализации но вот известно что про предыдущей модели известно что 4 processor ные модули на них производились реально поэтому можем уверенно предположить что сок там пусть и 6 4 ядра вполне себе возможно вы сампе варианте запустить я здесь ним стал все что про него известно можете почитать это все всей этой информации есть в интернете про то что у него на борту по периферии там общем всё довольно серьезно на самом деле я больше сегодня буду про архитектура говорить это картинка про небезызвестный вам закон мура вы его знаете да значит каждые два года количество транзисторов на одном кристалле в среднем удваивается почему я про это говорю что это сильно влияет на ток вообще откуда взялся эльбрус с его идеей как надо делать процессор и вот на этом графике если вы посмотрите какие там именно процессоры дата до где-то 95 года происходит вообще абсолютные синекура для программистов процессоры реально количество транзисторов удваивается процессора становятся более быстрыми и те же программы без всякого приложения усилий со стороны программиста просто работают на процессорах быстрее заменили 8086 на 208 6 все полетело быстрее 300 еще быстрее 406 еще быстрее пентиум просто программа летают программисты ничего не делает процессор просто тупо ускоряются дальше начинаются тонкости ну начнем с того что во-первых и закончим тем что сейчас мы знаем что к сожалению уже невозможно просто тупо ускорять одно отдельное ядро и ускорение процессора делается за счет увеличения числа ядер что уже не позволяет программистам просто в тупую запускать те же программы их нужно распараллеливание но вот между сегодняшней ситуацией и совсем простой ситуации там типа pentium ii и 408 6 была еще одна фаза это появление процессоров со встроенным распараллеливание им исполнение кода что происходило значит обычный intel овский код это крупные сложные инструкции в которых закодирован довольно много а ты вот здесь примерно показано как устроено вот слева инструкция типа интеловской а справа и как это сделано в лисках процессорах которые такую инструкцию исполняет вентили инструкция сама может сходить память читать кучу значения сделать несколько вычислений сохранить данные в память да еще может много чего сделать процесс исполнения одной инструкции в рисковых процессорах так не принято в них принято инструкция иметь фиксированного размера и очень простые либо инструкции читает исповедь и либо она выполняет регистра вую операции поэтому одна инструкция интела на рисковых машинах разбивается на целую серию простых инструкций которые делают то же самое как ни странно могут делать быстрее значит что произошло вот в этом самом диас то пятом году у интела возникла проблема связанная с тем что программы завязаны на январский набор команд в intel и очень мало регистров поэтому оказалось что писать программы эффективно невозможно почему всего 8 регистров вы написали кусочек кода который использует эти регистры следующий кусочек кода используют их же даже если да эти два кусочка кода можно было бы исполнить параллельно за счет того что процесс или для этого достаточно мощности из за того что они упираются в одни и те же регистры это невозможно сделать что сделал intel значит внутри процессора intel и это сейчас так происходит сложная инструкции бьются на кучу простых и мало того этим простым инструкциям назначается в на самом деле внутри intel и больше регистров чем видно с точки зрения программиста их там него семенам 32 или больше и вот такие наборы инструкций им даже если они обращаются у два набора к одно и тоже и к одному и тому же регистру использовать его загрузили посчитали и записали в память да и следующий набор инструкции такой же загрузили в x посчитали записали в память они раз параллели ваются и им выдаются две отдельные копии виртуального регистра x же они могут быть запущены параллельно это позволяет опять же без того чтобы нагружать программиста сильно ускорять программы за счет того что процессор выявляет в коде скрытый неявный параллелизм и реализует его в виде реально параллельного запуска участков кода которая в общем можно исполнять параллельно как вы понимаете это очень не бесплатная затея то есть это очень сильно усложняет процессор процессор вынужден много анализировать много чего делать в нет внутреннего возникает в общем целая куча дополнительные войны связаны с тем что мы разбираем инструкции исполняем вот эти микро инструкции потом еще выясняем а где же они на самом деле закончились там возникает целая куча сложных эффектов которые действительно очень серьёзно усложняют аппаратуру процессора с другой стороны возникает в общем довольно приятная картина мы можем внутри одного ядра делать много что параллельным ну опять же опять же мы понимаем что несмотря на все это все равно не получилось облегчить жизнь настолько чтобы процессор полностью снимал с программиста необходимость раз проливать многоядерные процессоры все равно тем не менее вынуждают нас писать мал тетрадные программы искать какие-то способы про грузить вот все те аппаратные средства которые в современном процессоры есть все равно не смотря на все эти вот их и селения внутри процессора компиляторы довольно сложные сам код программы прикладной сложный и с этим приходится много возиться что сделал эльбрус на самом деле надо понимать что это было сделано в изрядной степени из ну некоторые невозможности реализовать вот эти вот сложные устройства внутри процессора было сделано предположение что не надо все это всю эту сложность запихнуть процессор можно сделать сильно проще можно сказать что все распараллеливание должен делать компилятор мы возьмем и сделаем процессор таким чтобы можно было через сложная большую инструкцию очень детально и подробно объяснить ему какие исполняющие устройство процессора должны что в данной инструкции сделать то есть процессор вообще не пытается за вас разбираться где там и восходе можно что параллельно из при что нельзя компилятор должен реально хорошо разобраться в программе им сильно проще сделать поскольку он в отличии от процессор который видит маленький кусок кода он видит много вплоть до всей программы он может очень детально разобраться что происходит и детально процессор объяснить вот эти вещи можно делать параллельно этим нельзя значит мало того в этом месте еще снижается существенно неопределенность потому что интеловском компилятор все равно надо довольно хорошо знать что там в процессоре происходит и подавать его код так что процессор было легче его распараллеливания возникает такая сложная командная игра компиляторы процессора в процессорах с очень длинным командным словом это собственный эльбрус ну и кстати intel itanium да это происходит полностью на стороне компилятора и процессор упрощается и за счет этого на самом деле можно существенное количество аппаратуры процессора которая ну вот выпуском подходе занималась этим разбором и раз параллели ним потратить собственное исполнение на на еще исполняющие устройства на кэш и еще некоторое количество ценностей из этого вытанцовывается значит что де-факто происходит у эльбруса в каждом ведре ingrosso есть шесть аллу логических устройств которые могут исполнять 6 довольно полноценных параллельных инструкций то есть это там инструкция типа вычислений типа доступа к памяти этот мусор со то что мы вообще обычно считаем инструкцией и в очень широкой команде эльбруса для каждого из этих алла прям явно сказано ты складываешь ты вы читаешь ты делишь ты записываешь память например в этой же команде можно положить одну суп инструкцию которая управляет переходами ну это условно jump но я даже скажу там чуть похитрее сделано и еще можно положить 4 литер альных значения то есть значение которые прямо пойдут в исполнении как бы как константы и еще очень интересная вещь которая там заложено это то что есть вот описано как предикаты это тоже очень веселая вещь значит у процессора ильдус есть отдельный регистр который называется регистр предикатов если совсем просто то один бит в этом регистре носовых там два бита это булево значение которое можно использовать для условного исполнения инструкций есть когда вот вы запускаете на исполнение эту огромную инструкцию то 6 суп инструкций для каждого аллу можно еще завязать на предикаты сказать что вот эта суп инструкция будет исполняться если такой the predicate единичка а это если нолик это приводит к очень простые вещи можно сильно экономить на jump ах потому что можно некоторые простые условные операции а иногда и довольно непростые условные операции закодировать в одной инструкции таким образом что у нас по первая половина iv исполняется если предлагать предикат единица автора если он 0 то есть мы сразу запихиваем в команду и тот и другой вариант кода для iv и для else но просто проверяем по определенному видику какую из них исполнять это позволяет как вы понимаете сэкономить довольно большое количество jump off a jump а для современного процессора это огромная головная боль тут на самом деле много усилий сделано для того чтобы их по возможности избежать мало того вот эти предикаты для них для самих существуют зубы инструкции которые позволяют перед исполнением команды их посчитать то есть мы можем на самом деле внутри одной инструкции взять посчитать несколько пулевых операций то есть у нас в регистре предикатов есть много разных там видиков сидит мы можем там парочку из них по или потом какой-то из них с другим по и связать потом получить ответ и по этому ответу условно использовать команду и можем оставить его регистре предикатов он останется это как бы такой большой флага вый регистр в котором можно сохранять большое количество булевых значений то есть еще и большое количество булевых rip отчислений которые относятся как правильно как правило control flow наська управление того как поют вполне не команды ну куда в программе исполнять полностью параллельно вместе с основным кодом программ и почему jump и очень неприятная вещь для современного процессора все современные процессоры являются так называемой плановым процессорами они исполняют значит каждая команда исполняется в процессоре много такт auto 5 7 до 19 по моему но за счет того что в каждом такте мы исполняем от первой инструкции вот первый шаг от 2 2 и 3 3 и так далее то есть они как бы вот вот видите такой вот ступенькой расположены самая первая инструкция мы делаем не только одно считываем инструкцию из памяти на втором такте мы для следующей инструкции считываем и из памяти а для предыдущие декодируем и так дальше движемся по цепочке таким образом процессор каждую инструкции исполняет там скажем 10 тактов но за счет того что они все наложены фактически в один такт исполняется 1 инструкция то который к этому моменту доехал до конца времени свое исполнение так все с вами на процессор устроены из-за вот этой проблемы команда jump очень неприятно для процессора потому что она вызов вынуждает процессор доработать все висящие в плане инструкции полностью закончить исполнении сделать переход и потом снова начать наполнять pipeline снова с нуля в новом месте таким образом потеряв огромное количество процессор на во времени один джампа стоимости может достичь там 10 20 инструкций это реально огромная проблема для компиляторов поэтому огромное количество усилий с точки зрения оптимизации и в компиляторах процессора хватит на то чтобы такой ситуации избежать вот я уже сказал как и сбегается такая ситуация с помощью предикатов в брусе но есть еще одна вещь которая в нем реализована для того чтобы по возможности такой вещи избежать это сильно по-другому устроены и команды переходов в обычном процессоре есть ну там 2 традиционной команды jump по которой процессор переходит на новый адрес инструкции начинает код исполнять с нового места и условный jump который позволяет проверить условия кстати валь груси это как правило предикат и сделать переход если условие исполнилось или не исполнилось значит что сделано в или брусе валь брось и переход любой условный безусловный и даже вызов подпрограммы и даже возврат из-под программы можно разделить на две части в первой части мы готовим переход мы говорим процессору знаешь я планирую перейти скоро перейти по такому-то адресу у меня будет там jump по такому-то адресу в этой части инструкции мы сообщаем ему как вычислить адрес перехода аппаратура эльбруса параллельно с исполнением других инструкций выполняет это вычисления то есть она где-то там может сходить память откуда это дело прочитать и внутри себя подготовиться полностью к тому что переход был исполнен в момент исполнения самой инструкции перехода если между вот подготовкой и исполнением инструкцией мы дали ему чем-то другим позаниматься то переход оказывается полностью бесплатным за счет того что параллельно он полностью подготовился выяснил адрес переходы и всю свою аппаратуру к этому подготовил сам jump оказывается для него абсолютно бесплатным и вот такого вот сбоя pipeline а не происходит при чем процессор позволяет знать подготавливать до трех переходов него есть три таких специальных регистра которые используются для подготовки jump off и все три можно использовать если мы скажем точно не знаем еще по какому будем переходить ну скажем там нас есть типичный код где у нас окончив срабатывает и мы может быть перейдем по его может не перейдем и мы это гузно м позже но куда мы перейдем мы знаем заранее потому что это как правило константный адрес вот три регистра обычно 2 используется для подготовки именно переходов внутри кода функции а третий специальный он умеет вызывать функции возвращаться из них он обычно используется специально для этой вещи кстати надо сказать что вызовы функции возврата из них валь брусе это тоже общем отдельное довольно не детское занятии я про него отдельно расскажу следующие вещь которая выброси сделано не как у людей абсолютно восхитительно сделано это регистровые окно значит в обычном процессоре у нас есть с вами там там 10 20-40 факта регистров которыми код пользуется он пишет в регистра промежуточное значение читает из них при вызове функции обычно с в регистрах сохраняются какие-то аргументы возвратные значения в них хранятся при этом как обычно устроен обычная функция на обычном процесса этом на intel она army все происходят одинаковы перед вызовом функции мы командами push сохраняем в память те регистры значение которых нам почему-то важны мы бы хотели их после возврата из вызванной функции иметь вызываем функцию она там то что-то с ними делает с этими регистрами возможно какие-то затирает возвращаемся командами поп поднимаем из стека важные нам регистры продолжаем работу что происходит в люблю си вообще не надо никаких пушей попав происходит абсолютно фантастическая вещь и на что во первых у него есть огромный пул регистров двести пятьдесят шесть штук каждая функция в начале своей работы прямо явно говорит процессору мне нужно вот столько то регистров из этого пула и процессор я из этого огромного множества выделяет кусочек в котором она будет жить при этом видимые функции группы регистров вот это окно вот в этот вот регистровый файл она делится на три части первая часть это те регистры который мы получили от вас от функций который вызвало нас то есть этот блок и они и она видела и мы видим нас общий там находится параметр который нам переданной следующий блок это наша регистра который мы никому не хотим показывать они видны только вот нашей функции больше никому и третий блок готовится перед вызовом и в нем мы помещаем параметры следующей функции когда мы ее вызываем то это окно сдвигается вверх таким образом что вот эти параметры функций для следующей функции становится нижней частью окна регистров дальше там образуется опять же следующие и личная часть и дальше следующая часть это регистр которая то функция будет использовать для вызова своих уже функции здесь это примерно изображена я надеюсь что это вменяем объяснил но вот для иллюстрации то есть грубо говоря при вызове функции мы едем вверх по этому регистра вам файлу выхватывая для него блоки регистров которые используют текущие функции и они частично пересекаются в вызовах таким образом что мы через них передаем параметры какие-то кусочки этого фрагмента вот то что есть серединке нарисовано как это можно вот здесь вот в этом месте от нарисован да это вот собственно параметр который передается из функции из функцию функцию тут кусок регистра файла который виден обоим что же происходит если все это кончается как бы каков бы ни был велик регистровый файл когда нет он кончится конечно так вот прозрачно для прикладного кода да и для системного на самом деле даже процессор просто сохраняет в стек куски этого регистра во файла когда ему не хватает регистров если очевидная функция попросила сколько-то регистров и у нас столько свободных файле нет то все это окно сдвигается влево хвостик одной большой быстрой операцией пробрасывать свои оперативную память и высвобождается еще какое-то количество регистров которые снова можно использовать если у вас очень большая вложенность на самом деле для огромного количества кода все это происходит вообще без обращение к памяти 206 довольно много на самом деле и в существенный там на на глубину там в 1020 вызовов этого может просто хватать полностью без обращения к памяти но если не хватает то процессор абсолютно прозрачна для прикладного кода сохраняет регистры ну естественно когда начинаем возвращаться и все это окно сдвигается влево когда она доходит до места где мы упираемся в левый край регистровый файл а то он процессор начинает подгружать регистры обратно из памяти я чуть-чуть забегу вперед на сказать что одно из ценнейших свойств сброса заключается в том что это очень сильно защищенный процессор он прямо сильно сложнее устроен чем традиционные процессора и всего этого на нем очень многие вещи которые можно находить в традиционных процессорах такие хоть и в нем не проходит и из-за этого многие вирусы в нем не работают в частности эльбруса несколько разных стыков и поэтому например опять же вот вы видите да сохранение регистров исходит вообще аппаратно недоступна для прикладного кода поэтому очень трудно сделать в нем всякие вот фокусы которые на традиционных процессах основаны на процессорах основаны на затирание данных в стеке на возможности подсунуть туда какие-то свои данные добиться того что процессор прочитал из стека неправильный адрес перехода и перешел куда-нибудь куда мы хотим его загнать в эльбрус такие вещи не проходят час я проверю что я ничего не забыл из предыдущего да вроде ничего не забыл к этому надо добавить вот еще вот это самое регистра и окно она содержит в конце концов в конце еще один эй кусок который вообще не передвигает свою raids просто глобальным он виден вообще всем функциям и может использоваться для самых разных вещей но просто как обычный регистра в обычном процессоре либо как временная регистр который мы понимаем что под момент вызова функции будут затираться вызванные функции поэтому не храним в них длительно ничего либо наоборот как глобальные регистры ну там типа регистров в которых хранятся там ссылки на глобальные данные или там позиция independent код регистра который используется компиляторами для хранения некоторых глобальных таблиц в которых лежат нужные компилятору вещи опять же их в общем довольно много община адская что по аппаратуре эльбрус довольно богатый процессор подкачкой данных для цикла вот смотрите нас точно самом деле если говорить про современные процессоры то есть несколько вещей из-за которых все очень тяжело проблема для современной процессора заключается не в том чтобы сделать процессор который может быстро считать это на самом деле не трудно проблема заключается в том чтобы погрузить процессор то есть во первых сделать такой код который позволяет действительно задействовать все возможные мощности процессора а во-вторых и это турова что процессоры реально упираются это вот выл и обмена с памятью обмена с памятью раз в сто медленнее чем операции внутри самого процессора поэтому каждое обращение к оперативной памяти особенно если оно случилось в таком виде что процессор начал ожидать его результатов это просто кошмар и трэш поэтому все современные процессоры пытаются сделать так чтобы обращение к памяти главным образом нас считывание с записью не проблема запись выполняется отдельными записывающими юнитами которым выдают значение говорят на паги запиши в памяти и бегут дальше потому что ну запишет когда-нибудь не страшным нас это уже не останавливает а вот считывание нас останавливает поэтому и аппарат на процессоры пытается это делать и программное для этого очень много делается в процессорах разработчики архитектур стараются сделать так чтобы мы узнали о потребности считывания из памяти как можно раньше желательно до того как это считывание стало для нас критичным когда эти данные нам реально потребовались к примеру например в современных процессорах практически во всех существует инструкция которая говорит я скоро собираюсь использовать данные которые находятся по такому-то адресу памяти она просто говорит процессора поди попробую эти данные в каждую тащи чтобы мы потом когда будем их реально считывать мы их получили мгновенно эльбрус идет дальше значит он volvo себя общей совершенно фантастическая поддержка для циклов фиброз как вы понимаете создавался для вычислений для путем вычисления вычислений поэтому всякие вот именно цикловые операции в нем поддержаны очень хорошо значит что умеет эльбрус как как правило устроен цикл в программе как правило цикл обрабатывает какой-то массив в памяти то есть вас есть какой-то индекс этого самого массива вы бежите по индексу массива считываете из массива каких значения например в этом не знаю там видел картинку обсчитывать или звук у вас есть буфер вы из него считываете значение там по сэмпла вы их обрабатываете куда-то записываете совершенно типовая банальная операция совершенно очевидно что если вы за кодируете эту операцию обычным циклом то есть кусочек кода jump на начало снова тот же кусочек кода который исполняется в цикле на каждой итерации у вас будет обращение к памяти на котором процессор зависнет пока данные из памяти не приедут это настолько фантастически медленно что создатели и груз эльбруса сделали специальное решение которое эту ситуацию закрывает были броса есть специальный отдельно параллельно работающий юнит аппаратной подкачки данных он устроен следующим образом внутри цикла вы не пишете инструкцию считывания из памяти опишите специальную инструкцию выборки данных из фив он до начала цикла вы запускаете аппаратную подкачку которая начинает делать следующим образом вы и сообщаете куда памяти идти и как считывать значение она бежит с опережением цикла и выдергивает из памяти значения которые этому циклу нужны и записывает их сифон цикл убежит параллельно и вытаскивает с считанное значение из этого фифа и с некоторой вероятностью с довольно существенное на самом деле вероятность особенно если правильно сделано можно получить ситуации в которой считывание из памяти идет со скоростью которая практически не будет тормозить исполнение самого цикла данные самих вот разработчиков или бруса показывают что в десятки раз возможно увеличение быстродействия вот за счет этой реализации мало того эльбрус поддерживает схему исполнения циклов которая позволяет запускать следующей итерации цикла на исполнение в процессоре до того как закончились предыдущие традиционный процессор у вас цикл кусок кода вы дошли до конца куска этого кода jump в начало jump гарантирует вам что вы точно совершенно и начать исполнять этот код который вот следующую итерацию до окончания этой поэтому они будут исполняться строго до исполнения последний инструкции что делается в эльбрусе в эльбрусе внутри регистра во окна выделяется еще одно маленькое под окно некоторого размера и коду цикла дается не конкретный регистр указывается а его говорится вот будешь брать данные из этого под окна использоваться использовать регистры в этом под окне и аппарат на процессор будет для каждой следующей итерации цикла из этого падок на выдавать следующий регистр это позволит там скажем 10 подряд идущим операциям цикла в коде будет написано обращение к одному и тому же регистру а физически каждая следующая операция будет получать следующие отдельные регистр и это позволит этим операциям работать с той степени параллельности с которой вообще хватает аппаратура процессора это тоже позволяет вот в совместно две эти вот две эти штуки позволяют с ну прям катастрофически ускорять исполнении циклов и очень сильно снижает зависимость от обращений к оперативной памяти несколько стеков я про это уже начал говорить значит что самое важное значит процессора эльбрус есть стек вызовов который полностью аппаратно поддерживается у него инструкция вызова функции она сохраняет очень большое количество информации о текущем состоянии на специальный стек и удар сохраняет адрес возврата в общем все что нужно для возврата в предыдущая функция но при этом на этом стыке отсутствуют данные то есть на него не сохраняются данные вот из регистра во файла на него не сохраняются никакие пользовательские данные и в силу этого поскольку он может быть организован вообще в отдельной части памяти совершенно невозможно пересечение между памятью адресами возврата и тем местом стыке где они хранятся и данными пользователя потому что они находится просто в двух разных стеках на самом деле там больше стыков но вот настолько я уже не разбирался что это означает вот совершенно типичные для интела метод атаки на код носи выглядит следующим образом мы пытаемся построить код таким образом чтобы в какую-то переменную обычно строковую переменную который лежит на стыке записалась больше чем эта переменная в размере то есть вот такие старые функции типа str копии это очень легко позволяли если строка длиннее чем буфер в которой мы копируем да и буфер находится на стыке то мы перезаписываем буфер и дальше затирая данные доходит до места где на стыке находится уже не данные а адреса возврата в этом место мы пишем coin специальный адрес и при выполнении возроди функции функция возвращается не туда куда должна была а туда куда мы направили а там обычно находится уже код который мы тоже в это место подсунули и это перехват управления через переполнение буфера довольно такая типовая банальная проблема которая до сих пор на сказать в общем еще встречается в или брось и это абсолютно и полностью невозможно в силу просто всего того что стеки находится в разных местах и там дальше еще одну интересную вещь скажу которая еще сильнее может защитить код но даже даже вот это на самом деле уже ощутимо помогает вот защищенный режим этот то свойство эльбруса который очень сильно недооценена и очень мало используется в основном потому что с ним очень тяжело потому что на самом деле чтобы засечь затащить код защищенный режим с ним очень много работу надо проект проделать скажем гидру linux вот на сегодня в защищённый режим перетащить не удалось что он из себя представляет основное свойство защищенного режима заключается вот в чем как я вам уже говорил данные которые лежат в памяти для процессоров эльбрус тэги роются то есть рядом с каждым значением памяти лежат обе текке тегов которые говорят это число а вот это указатель это позволяет процессору твердо знать что он считывает из памяти это позволяет процессору вот в защищенном режиме полностью запретить преобразование целых чисел в указателе вообще чего бы-то ни было в указателе в защищенном режиме есть только один способ получить указатель это получить его из другого указателя внимание вопрос откуда берется самый первый указатель да там есть специальный режим в котором он порождается мало того защищенном режиме указатель это не просто адрес памяти это огромное 256 бит там получается число которое содержит себя три поля это базовый адрес собрался 28 конечно 4 бита базовый адрес еще четыре бита все остальное это базовый адрес это размер окна в которой мы смотрим это текущее положение в этом окне все это может быть хлопну то да там окна не знаю там в четыре или восемь байт и тогда мы имеем просто обычные указатели которые смотрят на одно число в памяти а можем иметь его раздвинутые он может смотреть на массив или на структуру и в общем на какой то большой объект в памяти в этом случае когда указатель имеет какой-то большой размер внутри себя вот это вот предел у него побольше чем там восемь байт мы можем применять к нему адресную арифметику но только внутри вот этого вот поля если нам передали скажем pointer на массив то он указывает на начало массива в размере указан размер массива и сам он смотрит какую-то точку массива которую нам почему-то педали как опорные мы от нее можем двигаться адресной арифметики вверх и вниз можем вот внутри этого массива делать все что хотим но выскочить за пределы не можем никак вообще совсем и грубо говоря когда функция защищенном режиме получает какие-то параметры то она абсолютно никаким образом не может обратиться к данным которые не адресуется явно переданными ей указателями то есть грубо говоря мы вот на уровне session авокода получаем защищенности уровня там я вы или сишарпа то есть среды с менеджер указателями проблема с этим на самом деле небольшая во первых на самом деле существует довольно много кода просто тупо с ошибками которые вот таком режиме начинает взрываться во вторых кто видел там код ядра видел что часто очень легко hydra в одно и то же поле которая описана как указатель кладу целые числа например да это как в режим который не применим для защищенного режима и еще есть некоторое количество тонкостей например такие вещи как сет jump & long jump эльбрусе защищенном режиме это не то чтобы вообще невозможно но это прям война и немцы довольно трудно реализовать для прикладного кода они могут быть реализованы ядром а для ядра все совсем сложным вот тем не менее на самом деле я щит и вот лично я считаю мне кажется даже сами создатели не так уж сильно верят защищенный режим как я я считаю что это в этом огромная ценность на самом деле в этом есть огромная ценность даже уже на уровне какого-то фрагментарного использования потому что защищенный режим можно использовать например как инструмент тестирования кода если вы свой код прогнали защищенном режиме и все тесты прошли то считайте что получили в общем защищенный режим это такой аппаратный valgrind скорость исполнения с абсолютной скорость исполнена вроде скорости процессора который проверяет все ваши указатели всегда можно не использовать его в продакшин коде но в во время тестирования здорово время кончается поэтому нас ради мне довольно мало осталось и под конец вернусь к вопросу о в исполнении 800 кода x86 wakodo значит процессора эльбрус штатно вот на уровне поставки имеют возможности для исполнения этого кода вплоть до того что на них можно windows загрузить и в общем весь код работает и происходит это дело через технологии бинарной трансляции то есть конечно же эльбрусский исполняет код процессора 8086 каких-то более поздних вместо этого в нем запускается бинарный транслятор который буквально читает инструкции 88 6 процессора транслируют их вас там инструкции из бруса и их уже исполняет но надо сказать что в чистом виде бинарная трансляция стоит очень дорого особенно для интела в основу потому что у intel есть так называемые сегментные регистры и операционной системы их активно используют в своей работе и сегментные регистры это означает что мы учим на каждое обращение к памяти должны выполнять некоторое количество математики с этими сегментами регистрами если бы это стимулировало с инструкциями эльбруса то нам пришлось бы почти на каждую инструкцию интела делать там по две-три инструкции эльбруса это было бы ужасно поэтому разработчики или бруса сделали такую очень интересно гибридная модель некоторые вещи которые очень дорого эмулировать они реально захочет загнали в аппаратура процессора в частности процессор поддерживает эту самую сегментные адресации в режиме вот эмуляции их 8 6 кода как раз адресное вычисления он проделывает сегментами аппаратно почти все остальное делается программно есть еще некоторые тонкости которые будут были сделаны в аппаратуры для очень чистой совместимости с 86 м кодом но не буду вдаваться в детали сам по себе на ретранслятор это же вообще то прям peace of art потому что он сделан как набор из трех трансляторов на самом деле еще интерпретатора который может прямо без трансляции бежать по коду и прямо интерпретировать его транслятор состоит из трех уровней кода генерации самый банальный бинарный транслятор делает по инструкционная трансляции берет тупо одну инструкцию intel а то подлиннее синтезирует соответствующий набор инструкций или броса которые исполняют это конечно очень неэффективно вот но для кода который один раз исполняется это с учетом стоимости трансляции которые тоже общем занимает процессор на и время это оказывается достаточно хорошим трейдером 2 транслятор это быстро регион и я транслятор он уже берет ни одну инструкцию я фрагмент ну как правило линейный фрагмент ну может быть на самом деле сложнее и компилирует его уже учитывая взаимосвязи между инструкциями где то он делает это более эффективно и если при этом при этом во все эти вот скомпилированный код вставляются естественном точки замера которые показывают что код исполняется там где-то редки или часто якут исполняется очень часто то поднимается насчет тяжелой артиллерии в виде последнего этапа это тяжелый оптимизирующий компилятор который работает медленно но зато он выжимает из бинарной трансляции все что возможно и синтезирует действительно довольно эффективный код который в общем да безусловно все равно конечно к быстродействию вступает прямому исполнению на родном intel и но тем ни менее показывает очень вменяемо и быстродействие с которым в общем можно жить я честно сказать в общем нас на сегодня это уже не очень актуально там лет 10 назад когда он только появился это была осмысленна потому что родного кода под эльбрус было мало сейчас это в общем то уже я скорее этим восхищаюсь как фантастически хорошим инженерным решением потому что общем сделать бинарную трансляцию для полноценного с 64 бита современного in the love's кого процессора это в общем дорогого стоит вот тем не менее на сегодня а да вот еще вещь про который чуть не забыл сказать еще одна вещь и это на сегодня уже более актуально в штатный скомпилированный под или брус операционной системе linux возможен запуск бинарной трансляции для прикладного кода если почему-то у вас нету прикладного кода в исходниках вы не можете wacom пернуть под брус то или босс позволяет внутри запущенного приложения сделать бинарные трансляции и ваш экзешник извините пожалуйста ваш ооо там или файл с транслировать и запустить его на эльбрусе прозрачно как если бы он прям вот цель бусины под альбуса был скомпилирован в этом наверное еще в некотором смысле есть резон на сегодня потому что в общем даже под open source не весь source upon и не весь к сожалению доступен время совсем уж кончилось быстро там подведу итог вот с моей личной точки зрения я в общем знаю довольно много процессоров только они устроены очень много существующих современных очень много старых довольно много разных странных солнечных процессоров вот с мы точки зрения или груз это в общем инженерное чудо я восхищаюсь людьми которые его спроектировали этот процессор при всем том что я говорил сейчас про то что он в некотором смысле проще чем волжские процессоры это не простой процессор с ним надо уметь в общем жить и в общем практика показывает что если у вас реально вычислительный код то надо приложить определенные усилия по оптимизации чтобы выкачать из эльбруса в силу производительность но во первых надо сказать что по этому поводу уже есть довольно много инструкции есть отличное руководство от собственно от разработчиков для программиста носи есть библиотеки готовые которые уже оптимизированный под эльбрус есть уже довольно большой опыт перенесения кода на него и в общем на сегодня это уже довольно стабильная развитая среда в которой перенесена много кодов который работает много людей ну и мне кажется правильно будет сказать присоединяйтесь потому что это здорово спасибо спасибо большое дмитрий друзья давайте зададим пару вопросов и сразу 9 ну погнали здравствуйте и спасибо за доклад же скажите пожалуйста что но если такое есть вообще что нужно сделать простому человеку чтобы попробовать процессор можно не зрительно настоящий там ему лет значит доставлен пройти надо спрашивать инцеста конечно не меняя их не работаю но кроме очевидного ответа купить себе или bros его можно купить уже на самом деле не существует программа дистанционного доступа вот прям свяжитесь с инцест и у них есть возможность дистанционно зайти на эльбрус и на нем скомпилировать запустить поработать там они довольно договора способна так что обращайтесь можно 1 раз я здесь слева спасибо за доклад я не сильно разбираюсь процессорах но вопрос такой насчет предикатов очень интересная тема заменяет ли она собой писатель переходов смотрите спасибо большое на самом деле реально невозможно даже в час втиснуть все что хотел услышать и предсказание переходов есть и спекулятивный исполнении люси тоже есть есть специальная поддержка для спекулятивного исполнения которая откладывает эксепшен и и вот на самом деле там в частности почему еще предикаты имеют два бита на предикат потому что у него еще есть значения типа но то нам берн который недопустимо и соответственно да это тоже присутствует не могу сказать в какой степени заменяет это свод опять же надо уже говорить с людьми которые на нем реально гоняли но спекулятивно тоже есть но раз есть прекратив кота начать безопасности получается всякие врезаемся типа спектр работ вы знаете опять же разработал разработчики процессоров отвечают что нет не происходит них не готов на и вот на сегодня ответить как именно не происходит но утверждается что вот я сейчас вам не совру прям чтобы твердо сказать надо надо посмотреть что-то из этих последних вот атак на эльбрусе я вообще не проходит с какими то есть тонкости на не готов вам сейчас подробно ответить помню что с частью попарно даже не поборолись об сходу не прошло спасибо здравствуйте меня зовут андрей у меня вопрос по поводу тех случаев когда у нас нет компилятора совсем то есть процессор зависим от компилятора а что если у нас программа написана на интерпретируемым языке или на языке который скомпилирован в промежуточный байт-код типа г-н или код сишарп или например получается что код x86 проходящий через двоичный транслятор оказываются в точно такой же ситуации то есть для него не применялся компилятор эльбрус и получается в коде который прошел через двоичный транслятор нет вот этой вот рекомендации по параллельному исполнению и мне кажется в таких ситуациях очередной какой-то performance будет смотрите начнет на самом деле почему нет рекомендаций вот последняя фаза бинарного транслятора она довольно серьезная и в общем перед довольно серьезный кот на иначе на в нативном альбусе но вообще в целом для языков тёплая вода у которых jit компиляция происходит это все записывается в jit компилятор то есть в принципе это вопрос качества jet компилятора это на сами хороший вопрос потому что действительно вы правы backend стандартного си компилятора эльбруса и довольно сильный серьезный бы кант который реально хорошо оптимизирует насколько это реализовано с g том насколько и на сегодня знаю ситуацию до java для него есть jack сделан существует я не могу вам сказать что качество этого jetta ну запредельная да мне по сложилось ощущение что там пока еще есть место для подвига вот в по оптимизации именно невского jetta под эльбрус но по сути дела это вопрос именно написание правильного качество jetta опять же это это все та же вопрос времени конечно времени и усилий я знаю что есть усилия по написанию или львы им бэг-энда для эльбруса и это было бы конечно очень ценно потому что через или backend можно довольно много того чтобы уже как бы вот в том большом мире происходит эльбрус перегнать и получить качественную куда генерацию но не могу вам сказать на каком она сейчас состоянии но пока я знаю хотя что интересно я знаю что в онлайне существует сайт на который можно зайти в лево окошечко пишете код на эльбрусе а справа прямо показывают сгенерированный ассемблера эльбруса для вот этого хищного кода и чет у меня есть подозрение на 1 или 2 им используется внутри но не буду вам брать по моему львам для него еще не готов и джедда есть качество обсуждали льный не готов в общем сказать что очень высокая друзья наше время истекло но финальный вопрос и потом пойдем в цифровую дискуссионную зону да пожалуйста спасибо за доклад в продолжение вопроса про компиляторы хотелось бы понять насколько существующие компиляторы под эльбрус умеют генерить достаточно эффективный код для этой архитектуры и если можно как-то сравнить его со существующими решениями там для x86 и на в clank и g7 спасибо значит смотрите по поводу эффективности но как более эффективную компиляторы вергуса чем родной все равно не существует поэтому разработчики полагают компилятор очень эффективным тем не менее что интересно что каждый год вот у самой компании st есть такой теперь добиться на повышение качества компилятора еще 10 процентов увеличение скорости кода и пока общего я понимаю у них это удается листам в общем есть еще определенный запас по глубине оптимизации хотя если вы почитаете их статьи по оптимизации то они очень впечатляют опять же вот на на мой взгляд вот что касается gcc вообще надо сказать что или любит родной компилятор по француз gcc очень хорошо совместим то есть как бы ну просто в его можно подсунуть место в целом по опциям по всему что вообще релевантно прямо втыкается и генерится с linux собирают и понятно делается просто вот эти вот компилятором который вставлен вместо gcc по качеству оптимизации я я полагаю что в общем он довольно серьезно на уровне потому что опять же если почитайте статьи по качеству оптимизации то там люди занимаются в выжиманием таких вещей что видно что это довольно глубоко при этом тем не менее есть очень много вещей которые на эльбрусе будут хорошо скомпилирован если правильно написаны вот там на самом деле вещь это нехитрые ну грубо говоря если вы будете там например оптимизировать циклы которые считывают значение из массива с шагом там в 256 байт то конечно у вас будет постоянная война с кишон да и цикл будет работать медленно если вы положите значение вплотную то вот этот самый prefetch механизм для циклов будет тащить линейками каша и правительств будет очень большая там на самом деле эти вещи не так уж сильно завязаны на спецэффекты самого эльбруса но с учетом вот этого prefetch механизма да тем не менее там в общем есть вещи которые можно еще сильно выжимать понимая как он работает и на эту тему кстати довольно много статей даже на том же хабрия которые показывают как люди достигали на нем хорошие при длительности понимаю как устроен процессор дмитрий пасибо огромное за доклад спасибо за ответы на вопросы друзья конференция продолжается и зона стендов и of the party's и скилл боксом и завтрашний день знаний и куча работы в остаток жизни хорошего вечера меня зовут алекси образец увидимся завтра здесь утром а дмитрий уходит в цифровые кулуары для того чтобы отвечать на вопросы пока ru и"
}