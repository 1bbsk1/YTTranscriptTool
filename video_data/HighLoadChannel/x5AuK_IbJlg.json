{
  "video_id": "x5AuK_IbJlg",
  "channel": "HighLoadChannel",
  "title": "CSRF-уязвимости все еще актуальны / Михаил Егоров (Odin — Ingram Micro)",
  "views": 14209,
  "duration": 2133,
  "published": "2018-07-19T04:58:47-07:00",
  "text": "всем привет я вам сейчас расскажу про цср iv уязвимости или кросс-сайт request for джерри или если переводить на русский то это поделкой между сайта вых запросов расскажу что это зависимости какие обычные мб лимитируют механизма защиты и как их обходить и эксплуатировать данные уязвимости в 2017 году небольшой дисклеймер вся информация которая представлена в данной презентации является сугубо мое мнение мы все совпадения являются случайными немного о себе я работаю в компании инграм айклауд занимаюсь application security моя должность application security инженер в свободное время я занимаюсь поиском уязвимости и бак холдингом и иногда уступаю на различных security конференциях выступал на troopers hack in the box за ранец и бич дэйз здесь представлен мой twitter вы можете его читать если захотите погромче можно дай ok почему же все срыв атаки работают во всем виноват вот этот cookies монстр дело в том что многие в приложении они используют cookies для управления сессии пользователя да и дело в том что браузер он устроен так что автоматически отправляет cookies пользователя вместе с из степи запросам если у него есть cookies для данного домена и пути что такое kookie cookie это небольшой фрагмент данных которые веб сервер отправляет клиенту в виде символ ем и браузер пользователя хранит эти данные и всякий раз при необходимости отправляет их вместе с ищите по запросам и степи заголовки с названием kookie cookie имеют различные атрибуты такие как xps пас domain secu и ешьте пион ли вообще впервые cookies появились в браузере netscape в далеком девяносто четвертом году и до сих пор в многие в приложении используют cookies для управления сессии пользователя рассмотрим как работает вообще классическая кросс-сайт request for джерри атака допустим у нас есть в нашем приложении возможность изменять адрес доставки у пользователя и нашего приложения используют cookies для управления сессией у нас есть html формочка которую пользователь должен заполнить вести туда адрес и нажать кнопочку сохранить в результате в бэг-энд полетит такой запрос post запрос ищет эмаль формой и мы видим что браузер автоматически поставил туда со вселенную куку пользователя backend когда получит такой запрос он посмотришь туда есть такая сессии это в легитимный пользователь и изменит ему адрес доставки что может сделать атакующий он может на своем сайте такер dot com разместить такую ищет эмаль страничку которая на самом деле совместит html форму на сайт и газом полком и так как браузер автоматически вставляет cookies пользователя и степи запросто backend он просто не поймёт является ли данный запрос легитимной легитимным а то есть результате заполнения формы пользователям либо это сесарев атака и поменяет адрес shipping адрес для пользователя назначение которое выгодно для атакующего есть другой вариант тестеров атаки с использованием x и чар и пиаре а если с офицеров а так используем с использованием html форм знают многие то в данном способе не так много знает но он тоже работает то есть мы здесь используем ix35 и обратите внимание на атрибут виз придерживалась который заставляет браузер автоматически отправлять cookies пользователя и так как content type у нас значение content type a равно applications x3 w форм а ю л л н коды то данный запрос есть браузер его отправят без общем preflight request и и опять эстеров атака будет работать рассмотрим теперь как это более наглядно происходит то есть у нас есть приложение газом полкам которая узи макси srf есть пользователи есть сайт атакующего где есть еще страничка систер f x и чар . html пользователю над инфицирован в приложение которое находится на экзампла ком и если он зайдет на сайт атакующего и откроет это html-страничку то автоматически выполнится под запрос который поменяет адрес доставки пользователю и браузера он автоматически вставит сессионные cookies в запрос и backend поменяет адрес вообще о сесарев атаках о них известно с 2001 года когда их начали активно эксплуатировать и вот в период где-то 2008 2012 такие уязвимости они были на каждом первом сайте то есть вот представлен список некоторых сайтов которые были уязвим на рассмотрим насколько вообще серьезно сесарев уязвимости ну на самом деле все зависит от критичности узи мова-экшена то есть это может быть аккаунт такого а то есть атакующий захватывает аккаунт жертвы путем смены email через есть р.ф. это возможно возможно повышение привилегий за счет того что атакующий через есть рф создает нового пользователя с высокими правами системе или даже выполнение кода за счет эксплуатации комнат injection в админке через сесарев обратимся к международным устоявшимся классификация музе масти что они говорят по поводу серьезности тестеров например есть такой проект который называется о вас тот темп он содержит 10 наиболее критичных уязвимости в приложении например в 2010 году сесарев уязвимости там находились на пятом месте потом разработчики начали имплементировать различные варианты защиты и уже в 2013 году sister of уязвимости сместились на восьмую позицию и то что происходит семнадцатом году сейчас есть release candidate вторая версия для у вас топ тим и там все срыв вообще туда не вошли потому что якобы а по статистике сейчас только в 8 процентов случаев то есть 8 процентов penetration тестирований находят сесарев уязвимости ну я лично не как бы не согласен с данной статистикой потому что буквально за последние полтора года я ходил много сесарев уязвимостей и я дальше расскажу как я это делал следующая классификация это классификация бакр out where they all норы и рейтинг taxonomy там апликэйшен white все сыры фузи масти они имеют сверить и петух что означает хари выше только severity критику то есть достаточно серьезной уязвимости теперь рассмотрим какие наиболее популярные варианты защиты возможны а от сесарев этой сестры в токены дабл сабмит cookies защита основанная на контент taipan ари ferrari на подтверждение пароля или достаточно новая технология это сам сайт cookies рассмотрим как работает каждый из вариантов защиты первый первый вариант защиты это срыв токены то есть генерируется для пользователя уникальный и высокую энтропию ный токен для каждой сессии и токен может вставляться в дом html страницы либо отдаваться пользователю через и пиаре и пользователь с каждым запросом которые что-то меняет он должен включить запрос в хедер или в параметр запроса этот токен так как атакующий не знает о кента классической асессоров а так и не работает следующий вариант это дабл сабмит cookies опять генерируется уникальный и высокую энтропию talking для каждой сессии но он помещается в cookies и пользователи он должен в запросе то есть передать одинаковое значение в cookies и в параметры запроса backend то есть если эти два значения мочиться в cookies в параметре то а считается что это легитимный запрос так как атакующий просто так не может изменить cookies в браузере пользователя то классической асессоров атака не работает следующий вариант это защита основанная на контент тайпе то есть пользователь должен отправить запрос http с определенным значением content type a например applications джейсон и так как через в браузере через html форму или x и чары 5 мы не можем отправить произвольный content type кросс origin а то классической асессоров атака опять не работает следующий вариант это защита основанная на ресивере то есть опять пользователь должен отправить запрос с определенным значением заголовка refer backend его проверяет и если он неверный то считается что это сестре фото к так как браузер не может отправить произвольный реферат через за ищет эмаль форму или x и чар опять то опять считается что это защищает от классической атаки следующий вариант это паспорт a confirmation а то есть пользователь должен подтверждать действие с помощью пароля или секрета так как атакующего не знает то опять а так и не работает классическая и заключительный вариант это сам сайт cookies это новая технология которая призвана защитить от все срыв но в данный момент она только работает в двух браузерах это chrome и опера то есть как она работает у cookies устанавливается дополнительная атрибуции 7 сайт который может иметь два значения алекс или strict и суть этой технологии в том что браузер не отправляет cookies если запрос и осуществляется с другого домена например сайта атакующего а таким образом это опять защищает от классической атаки но к сожалению есть везде особенности работы браузеров в приложении их дипломе нта которые позволяют иногда обходить все сыры в защиты теперь поговорим о способах обхода защиты их от тех способах которых я сегодня расскажу их я насчитал восемь первый способ это xss кросс-сайт скриптинг если вашему в приложении есть xss к то это автоматически делает ее узи миксе срыв и от этого как сложно защититься можно только смириться следующий вариант это так называемый mark up допустим у нас есть узи масть нашем приложении html injection но нет xss например есть content security policy которая защищает от xs но такой все равно может инжектить ищет эмаль теги и допустим если у нас реализовано в нашем приложении защита основанная на тестеров токенах то атакующий может инжектить такой html то есть это не закрытые так теги и мыши или форм и в результате часть дома html-страницы она будет отправлена на ресурс атакующего то есть высока вероятность что если атакующий правильные jacket такой системы то то что придёт на сайт атакующего будет содержать асессоров токен таким образом узнав talkin' атакующим может использовать эксплуатировать классическим способом систер следующий вариант обхода это уязвимость на суда менее допустим у нас есть субдомен food замком и он уязвим сам на мейн триколор или xs-s а то есть результате сам domain т.к. атакующие полностью контролируется субдомен может туда грибы html-странички инжектить и в результате если наше субдомен уязвим дак таким вещам то атакующий может обойти защиту основанную на сестра в токенах дабл сабмит cookies и content type best protection допустим наше основное приложение она использует кроссовер ресурс шеринг для между домена взаимодействия и в ответе сервера то есть вставляется два заголовка access control origin для субдоменов example.com который уязвим и 2 заголовок access control украден холст руб то есть она говорит чтобы браузер отправлял cookies пользователя на чтобы с помощью x и чар опять можно было сделать запрос с куклами пользователя и если эти условия выполняются такой просто может прочитать все саров токен субдомена который он контролирует и дальше эксплуатировать классическим способом допустим следующий вариант что на основном домене которое мы хотим атаковать есть файл кросс domain xml этот файл используется flash плагином pdf плагином для мер для субдомена взаимодействия и в этом файле то есть мы разрешаем доступ с любых субдоменов и атакующие если он может загрузить джесс file no fuck зам полком то есть он может в этом случае использовать service worker для субдомена фуксом полком который на самом деле отдает full flash файл и так как у нас есть кросс domain xml на основном домене которая разрешает взаимодействие с субдоменов то такую через flash файл просто читаете саров talkin' кстати такая зримость недавно была найдена на v и w с консолью и даже если даже если они сконфигурирован cars и нет файла кросс domain xml а то но используется защита добыл сабмит cookies атакующий просто может inject субдомена кукин для родительского домена на интересующий пути где он хочет эксплуатировать все срыв и таким образом обойти добыл сабмит купе защита следующий сценарий обхода он основан на pdf adobe есть pdf плагин когда устанавливаете adobe reader он автоматически устанавливается и этот плагин поддерживает так называемый форм как скрипт сейчас к сожалению дев плагин работает только в 11 firefox и resser вот и в форум cold есть два замечательных метода get и post с помощью них атакующий может с помощью метода get он может прочитать асессоров токен и с помощью просто отправить к себе на сайт допустим у нас есть возможность загружать pdf файл нашего приложения но на самом деле это может быть даже не pdf-файл а как файл какого какого-либо другого формата например картинка которая загружается в качестве аватара пользователя и у нашего приложения есть некоторые и пейна основном домене который позволяет получать содержимое этого файла тогда атакующий может использовать такой такой системой страничку которая с помощью тега embed им ведь от pdf файл которой атакующий загрузил на интересующие сайт их зам полком сам сам файл лик pdf он выглядит следующим образом он содержит форум как скрипт который как раз читает страниц с этим section где есть сесарев токен в доме и отправляет с помощью метода пост на сайт атакующего так как так как pdf загружается сайта example.com то сам этот pdf имеет доступ к полностью к реджину htp с example.com то есть он может оттуда и читать это как бы не нарушается ему режим полюсе вот и дополнительный фокус заключается в том что где в плагину не важен с каким контент тайпом отдается pdf файл и даже может в ответе присутствовать дополнительные заголовки например контент dispose диспозиция attachment pdf плагин все равно будет рендерить этот pdf и выполнять форм как скрипт следующий вариант это купить injection а то есть если используется дабл сабмит cookies защита от а если атакующий сможет каким-либо образом инжектить куку то это game over то есть наиболее популярные варианты cookies injection это серый лев injection то есть если атакующий может инжектить в ответ сервера дополнительные заголовки то он просто может инжектить туда заголовок сет cookies с нужной кукой и то есть займитесь куку отвечающий за сестер защиту то есть возможен вариант с тем что различные браузеры допустим сафари они интерпретируют запятую как то есть можно через запятую вставлять новую куклу допустим у нас есть параметр url параметр в заголовке с именем ленгвич и мы потом а его обрабатываем и вставляем то есть яндекс team а пользователю куку с названием ленгвич а значение этой cookies то значение которое мы передали вёл параметре если атакующий вставит запятую то он может инжектить дополнительную куку с любым именем и еще один вариант это различные баги в браузерах например фаерфоксе то есть там была возможность инжектить куку через свет же картинку если у нас есть еще темы редактор какой-то и мы разрешаем пользователю вставлять имидж теги то атакующий просто может в сердце атрибуте указать на и свет же картинку которая установит cookies следующий вариант я назвал очень content type некоторые считают что если используется какой-то нестандартный формат для общения с букин дам то это может спасти вот crossed request for джерри на самом деле это не так в качестве примера то есть то уязвимость которую я нашёл недавно в одном очень популярном сервисе по управлению заметками там использовался apache ii ost rift и 5 то есть это бинарный бинарный формат данных и использовались cookies для управления сессии то есть допустим чтобы добавить новую заметку пользователь должен был отправить такой post запрос в теле передавались бинарные данные и то есть указывался content type апликэйшен x шрифт но на самом деле в бэг-энде этот контент так него лидировал оси можно было поменять на текст plain и с помощью из и чары и 5 то есть эксплуатировать эту все срыв уязвимость передав просто бинарные данные в теле post запроса но на самом деле защита основная на контент айпи это очень плохой вариант защиты он в большинстве случаев обходится через html форму или с помощью xhr и пи ай мы можем отправить следующий контент типы текст plain applications x3 w форм и уралом кода ты le mal de parfum de это но есть возможность на самом деле отправлять любые значения content type a через плагин и через 5 pdf или flash plugin либо через допустим фреймворк jaxx rs фреймворк а почти все xf он поддерживает в ее реле параметр считает в этом параметре можно указать любой content type и backend он посмотрит на этот параметр и будет его использовать вместо контента по которой передается федоре и довольно известный баг в браузере chrome который был найден в 2015 году он после того как был найден где-то через месяц попал в паблик и был пофикшен только в семнадцатом году этот баг позволял отправлять post запрос любым контент тайпом с помощью и пий которая называется навигатор сын бекон как выглядела эксплуатация мы создаем новый блок с нужным content type мы просто отправляемого с помощью навигатор сын бекон еще один snare обхода который до сих пор работает это с помощью flash plugin а он до сих пор поддерживается в браузерах даже есть сайт за хакер блок . конкурс domain где уже есть готовая флешка вы просто указываете юрий собственных и дыры нужный контент type и данные который надо передать просто отправляете и в кант улетает запрос с нужным контент типом но есть одна хитрость то есть нельзя просто указать юрий ресурсы сайта которую мы атакуем нужно указать ресурс который сделает redirect с кодом 307 на на ресурс который мы атакуем тогда это будет работать и последний варианта входа это вход защита основанный на рефери есть баг в microsoft edge браузере который до сих пор не пофикшен который позволяет подделывать значение рефери но только для git запросов к сожалению если допустим наш backend не отличает get at post то можно эксплуатировать эту уязвимость если все же нам надо пост то есть такая небольшая хитрость мы можем отправить хедер рефери с помощью pdf плагина и funk а калка где то год назад можно было с помощью pdf плагину отправляйте вообще любые хедер и в том числе хост там любые потом в общем adobe пофиксил а это сейчас есть благ лист хайдаров то есть если мы укажем и реферера просто не отправится этот заголовок но мы можем вообще formula kolt позволяет это отправлять нам легально контент любой content type и если мы будем инжектить символы серии шри темный лайтфит то мы можем дополнительные кадры инжектить в запрос и что будет если мы за инжектит хедер реферер пробел и степи : 2 слушай газом полком ну понятно что это не находится в black листе и в бэг-энд будет отправлен headers именем refer пробелы ешьте пи двоеточие 2 слушает зам полком некоторые серверы они например в fly jboss они когда видят пробел они думают что это конец имени в хедере то есть что это : то есть таким образом такие сервер они увидят что к ним пришёл refer значением ешьте пи двоеточие дослушай газом полком таким образом мы спустим феррер это итоговая таблица в столбцах представлены варианты защиты от все срыв и в строках представлены методы обхода в каждой ячейке собственно указано браузеры против которых работает обход означает что для всех браузеров алсо звездочка означает браузеры которые не поддерживаются им сайт cookies в час только два браузера chrome и опера поддерживают данную технологию как все-таки правильно защищаться от все срыв наиболее кардинальный варианты работающие это избавиться от cookies использовать кадры стоки нами ну если мы все таки не готовы отказаться от cookies для управления пользовательской сессии то нужно моделировать угрозы проверять реализацию все саров защиты комбинировать различные варианты для более надежной защиты наверное лучшим племени имплементировать своим сайт cookies сейчас трюка 2 браузеры поддерживают наверное дальнейшем будет больше браузеров поддерживать и плюс есть смысл спрашивать у пользователя пароль для выполнения каких-то критичных действий и лучше всего отдавать файлы которые пользователь загружается отдельного домена вот на этом все это все что я хотел рассказать спасибо михаил вопросы спасибо больше за доклад мне такой нубский вопрос каким образом может произойти подмену вот ну вот такую как он может отменить там qq или talking кроме того чтобы ну как-то через fishing каким образом ну либо это injection какой-то да вот injection cookies да как вариант если добыл сабин cookies защита используется вот такой наверное наиболее распространенные даст вопрос такой в общем мы применили на защиту используя хедер origin естественный refer как бы new за начали юзом origin можно ли подменить себя режим ну то есть если возможность его сделать то же самое что сделали sorry for подставить каким-либо образом вот origin можно поставить перине на сколько я знаю нет но если вы используете курс допустим то возможно если у вас под домен уязвим то через него атакующий можно распланировать и мы используем также синхронизировать и ну то есть сасори в токио получается да сейчас на получается узнавать можно таком случае xss да вот проблема там с доменом либо то есть утечка каким-то образом то есть там есть много вариантов допустим кросс-сайт include есть такие иллюзии масти допустим если вы через опять давить все саров токен там атакующий может допустим ваш айпи поддерживает джейсон атакующий может указать там call back довели его тут токен утечет ну 58 александр команды герман точка ру спасибо большое за доклад небольшой вопросик ты вроде бы но вначале говорил что примерно расскажешь как еще основном различные уязвимости может быть есть какие нибудь фишки у тебя такой спойлер я еще буду выступать на конференции за раной там я как раз представлю плагин для birds with который позволяет автоматизировать поиск эсеров уязвимости ну да то есть я использую ну как и многие наверное люди которые безопасности вы бы занимаются используя birds with и как бы с помощью неё ещё будем асти ещё вопросы есть дали ну если нет давайте еще раз поприветствуем михаила спасибо"
}