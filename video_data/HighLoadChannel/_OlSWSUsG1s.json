{
  "video_id": "_OlSWSUsG1s",
  "channel": "HighLoadChannel",
  "title": "Дизайн движка метапоиска aviasales / Борис Каплуновский (Aviasales)",
  "views": 1518,
  "duration": 2767,
  "published": "2017-04-22T14:47:46-07:00",
  "text": "итак позвольте представиться меня зовут каталонский борис я работаю в и пользуюсь аналогией коллеги из году я пересел с легких наркотиков на тяжелое в моем докладе будет очень много картинок поэтому особенно те люди которые сидят в центре не видят картинок пожалуйста откройте свои гаджеты от и открыть мой доклад на них а итак я расскажу о последней ревизии поискового движка aviasales мы работали над ним последние два месяца и переход на них позволил заработать нашему бизнесу значительно больше денег и так о чем я расскажу в своем блокноте а первое ну наверное не все в курсе что такое aviasales поэтому я потрачу немного времени чтобы рассказать в чем наш бизнес на чем мы зарабатываем деньги а я расскажу о нашем предыдущем решили ревизии движка и чем он нам мешал и расскажу о трибуне в новой системе и затем я расскажу о domain специфик языке который был реализован нами для того чтобы работать с системой стало проще быстрее и очевидно также я у тебя некоторое время устройся на устройство нашей базы данных для того чтобы она работала отказывался то есть отказоустойчивая и организации кластера а и так что мы делаем в aviasales к нам приходят вот этот вот веселый дяденька путешественник потому что он хочет авиабилетов он заполняет форму в которой указана дата вылета дата прилива то пункты вылитые назначениям и посылает эту форму постом нам использую эту форму мы должны послать запрос и к здесь нарисована всего 4 на самом деле это 40 60 а то и больше online travel agency они получают наш запрос ищут жизнь с подходящие билеты и возвращают их нам виде джисона xml но или чем такого причем мы-то посылаемым небольшие запросы по 2 килобайта в ответ нам приходит большие xml большие xml до двух мегабайт так получается что мы мы делаем запрос ждем 20 секунд и потом нам прилетает 40 мегабайт xml мы очень радуемся но обработать это надо очень очень быстро иначе пользователь не дождется ведет покупать билеты в другое место а немножко нагрузки 1 summits пытайтесь понять хай вот это или нет но а мы обрабатываем 20 тысяч поисковых запросов в час 13 гигабайт данных минуту ну и самое наверное пугающие мы продаем 6 тысяч билетов в сутки я чтобы вы понимали что это такое это 15 самолетов boeing 747 и так целый слайд своей презентации я под посвятил конфигурации потому что конфигурация в нашем бизнесе это одно из самых важных вещей потому что наборы gate of который мы посылаем поисковые запросы очень сильно освещаются в зависимости от для положение пользователю пунктов вылета и назначения набора пассажиров источника трафика и кучи-кучи куча других параметров причем в неделю мы обычно подключаем три четыре новых агентство ну конечно старые ним по ними по немножку отпадают а и правила конфигурация системы меняется по несколько по несколько раз в час еще расскажу почему я так заостряю внимание на конфигурации системе с тем чтобы сделать ее простой программиста как а наверное знаете любит программировать на нее не любит конфигурировать систему одной из задач которые я ставил перед собой при разработке нового движка было освобождение программистов от особенности конфигурации системы и дать возможность не техническому персоналу нашей компании конфигурировать систему и так пару слов о той системы с которой мы жили до в разработке нашего движка и так это было довольно простое ruby on rails приворожу приложение ну собственно взяли рубил сына и начали писать с течением времени руби приложению 1 разрослось разрослось она настолько что один процесс руби в памяти выхожу за внимал 300 мегабайт довольно много а причем причем есть такие особенности руби что запустить приложение ruby on rails это 5 10 секунд но то есть что это такое это значит что программист чтобы узнать результаты своей напитка как работают последние 10 10 написанных им строк вынужден ждать пять десять секунд на мой взгляд это довольно сильный снимок снижая скорость разработки кроме того если вы помните пару слайдов назад я рассказывал о том что мы после посылаем поисковые запросы к поставщикам аппетитом и 20 секунд ждем пока они нам ответят эти 20 секунд 300 мегабайт памяти который за жрал руби ничего не делают мы платим за память которая со дна сторона становится дешевый но с другой стороны все еще значительно дороже жестких дисков ну вот память просто его кроме того система написанной на ruby on rails со временем росла умножилось она обрастала значительным количеством спагетти кода и со временем вхождение новых программистов работу с проектом стала довольно сложным ну вот приходит новый программист и несмотря на то что все условия созданы документации есть ему быстро помогли развернуть систему эффективно писать код он не мог начать раньше чем через три дня по сток вышел на работу ну вот мне жалко зарплата программиста за трения кроме того была еще такая проблема в системе были участки кода с которыми программисты не очень любили работать ну то есть менеджеры знают что есть какая-то проблема приходит программистом и тут есть несколько вариантов развития самой простой программисты говорят ну это невозможно исправить просто потому что их невозможно исправить сталкивались с таким наверное а я вот сталкивался nokia при этом есть другой вариант развития событий менеджер приходит программисты говорят вот это надо исправить программеры нет но при этом она не чинится и так случается tver 3 4 1 то потом когда приходит мы уже случается такая считаться он как бы заходит комнату программистом говорит про медведь а программисты делали что они не слышат а я просто не хотят этим заниматься вот бывает еще одна наверное самая последняя ситуация это когда есть участки кода за которых от винта соответствие в которых принимает что-нибудь всего один программист но это в общем ставит зависимость компания от одного программиста я потом мы пытались создать систему с которой сможет работать практически любой человек и так в моей голове живет мысль что объектно-ориентированное программирование это один из крупнейших файлов индустрии за последние 5 лет поэтому при создании новых системах них они захотелось сделать функциональную декомпозицию то есть создать систему строящихся из независимых компонент каждый из которых имеет один входной аргументы один выходной аргумент довольно просто эти компоненты должны быть полностью изолированы друг от друга эти компоненты не имеют зависимости от среды исполнения и эти компоненты должны быть легко протестирована как внутри системы так и в ней системы а в левой части слайда вы видите ну вот такую вот функциональную схему которая довольно близко отражает наш workflow асв ну собственно приходит поисковый запрос пользователям его лидируем параметры посылаем запрос 3 это результаты как-то мертвым и отдаем результаты пользователь просто понятно но надеюсь всем просто понятные в правой части экрана вы видите то же самое записано в формате json ну вот примерно такой язык хотелось создать и так требование которые предъявлялись к системе первое требование это конечно же простота разработки и низкий порог вхождения чтобы этого сладкого и дяденька с бумажки готового программировать на нечистым и во флуд мы могли нанять и чтобы он эффективно смог справляться со своими задачами ну наверное все знают что на эти хорошие программисты в довольно сложно поэтому хотелось написать систему с которой могут работать все также хотелось сделать чтобы система была очень отказоустойчивой чтобы отменять программистами пока не ст и по ночам спали вот таким спокойным и безмятежным сном как или дилинга нам нужна была хорошая масштабируемость чтобы при росте нагрузки который случается ну например когда в нас показывает по первому каналу мы могли подвести на автопогрузчике новых серверов и нормально работать и как я уже говорил для нас важно конфигурация и конфигурация конфигурировать систему необходимо очень и очень быстро и просто чтобы не напрягать этим программистов и так чтобы проиллюстрировать насколько простая система я на следующем слайде показывал совсем чуть-чуть кода это два рабочих юнита компонента системы которые взяты из реальной системы я думаю все из вас кто знакомы с потянем языком программирования или быстро разберутся что делает этот код левый участок кода трости сообщение в зависимости от того какое число является конфигурация этого сообщения этот этот юнит либо пропускает запрос дальше либо возвращают но и 2 unit тоже довольно простой все что он делает это он проставляет запрос курс курсы валют а как видите в этих кусочков кода нет никакой зависимости ни от каких фреймворков единственный импорт который есть в левом в левом юнити это рэндом логично подумать что такие юниты можно запускать просто каком онлайн-инструмент без всего окружения и так что что еще интересно про юнитов хотелось чтобы юнита был с ним юнитами было легко работать как вне системой так так и внутри системы для того чтобы из юнитами был работать внутри системы было сделано такое решение каждый юнит имеет ты юрий 1 герои для того чтобы непосредственно вызвать юнит пояснить и передаются кодированные в час он данные они попадают в юнит юнит их обрабатывают и в качестве ответов выдает результат их обработки а также юнита конфигурируется поэтому второй по второму your air view не загружается его конфигурация и 3 и 3 юрий этой игры по которому эта конфигурация из него выгружается таким образом даже в ран тайме можно посмотреть как ведет себя unit причем сделать не всю систему целиком да как ведет себя каждый конкретный юнит и и как он ведет себя при так при одно воздействие при другом воздействие чтобы понять что происходит системой каковы каков размер этих юнитов что было unit ну вот запрос билетов и gate от таких вещей мы обычно пишем unit добавление в результатах поисках информации о аэропортов на который мы показываем билет это тоже unit удаление дубликатов предложения от разных агентств и это и юнит отправка данных пробитым тут тоже рунет расчет цены в рублях для дельцов отдающий билет другой валюте тоже отдельные units итак у нас есть у нас есть юниты и теперь нам из этих лимитов нужно строить workflow а первый способ она собственно и решили что вот объединять юниты будем так своими цепочки цепочки будет нескольких типов я на них они сейчас расскажу первый тип это последовательные цепочки последней цепочке как следует из название выполняется последовательно данные попадают попадающие на вход последователь цепочки в но я сначала в 1 и нет результата работы 1 июня попадают во 2 unit результаты работы 2 юнитов 3 и так до конца результат работы последнего и день это является результатом работы всей цепочке а при этом если юнит возвращает нил то выполнение цепочки привет прекращается и и результатов работы цепочки тоже является нил ну в общем все просто и понятно вот так вот выглядит примерно цепочки двумя юнитами до 1 1 unit 1 плюс 5 на вход подается 0 есть или еще будет в результате но наверно будет 6 хорошо второй способ объединения юнитов цепочки это параллельной цепочки в районе цепочки работают следующим образом входной аргумента цепочки подается одновременно ворти юнита цепочки результаты работы всех элементов цепочки собираются в массив массив с результатами работы всех юнитов цепочки является собственно результатам работы цепочки такая вот задачка снова есть 0 есть параллельная цепочка из двух юнитов чего получится 1 и 5 получится ну и последний тип цепочек это так называемые отложенные цепочки они совершенно не чем отличаются от последовать под последовательных цепочки кроме одной особенности результатам работы последовательные цепочки всегда является всех всегда является ровно тот аргумент который был потом ей на вход зачем нужны такие цепочки такие цепочки очевидно используются для сайт эффектов ну вот здесь например показано что в в отложенную цепочку записано отправка данных в очередь то есть мы сначала отправляем данные пользователя а потом отправляем данной в очередь и так что будет если на вход сложные цепочки подается 00 и будет что логично а примерно вот так выглядит рабочий workflow aviasales который который собственно строится из цепочек попытаюсь объяснить что же на нем происходит и так она вход происходит приходят запросы пользователя который варьируется после но как запрос провале zero ван посылаем запрос и гейтом здесь нарисована 4dita как и говорил раньше где тоф на самом деле не 4 не 5 не 10 и даже не 20 значительно больше потом эти все эти результаты сваливаются в uni смерш который объединяет результаты поиска после мерз вызывается делает цепочка собственно которая не задерживает выполнена правка данных пользователя пользователь уже в этот момент получает данные а потом эти же данные о синдром отправляются в в очередь на которые висят обработчики что-то с этими привычками делают этот workflow своей формой очень сильно напоминает ровно то что у нас есть продакшене правда продакшене у нас unit of work лавину 1 раз в 10 наверное побольше и так что дает нам dsl да и сыр вот этот самый называется есть а ним и собственно что он дает он нам дает просту простоту локальные удаленной отладки приложения до любой юнит мы можем это отладить как внутри как вне системы просто запустив пито новый файл можем удалить ее можем отложить ее на удаленной системе послав запрос джейсон среда исполнении дает нам контроль за скорости выполнения юнитов и цепочка то есть каждый раз когда мы тестируем системы теплом ся на продакшен или просто хотим понять что происходит на просто смотрим логи в которых написано сколько сколько времени исполняется каждый юнит это дает нам хорошую предсказуемость системы мы понимаем а какой юнит работает слишком медленно какой юнит там не вызывается совсем да ну и видим собственно какие юниты вызываются кроме того это да и цель дает нам свободу менять модель выполнение цепочек как и говорил раньше пара мы параллельно опрашиваем 60 ну уж от 60 до 80 удаленных api и которые отвечают нам xml а на данный момент у нас вполне получается обрабатывать эти данные асинхронно но четко осознаем что в какой-то момент их будет не 60 и не стоит может быть 300 и если нам пришло ну допустим там 100 мегабайт xml обработать их на одном процессоре в одном потоке будет довольно сложно и todays или дает нам возможность распараллелить обработку данных на несколько процессов потоков но может даже на несколько машин то есть нигде нету при привязки данных нет взаимозависимости так далее итак у нас появился dsl на котором четко понятно описывается в workflow вокалу описывается так что его логика понятна не только техническому персоналу но и менеджером зачастую сейчас сейчас случается такая ситуация что они приходят это вот сюда вот такой юнит воткните ну в общем так общаться довольно просто и так workflow совершили еще нам нужно спроектировать каким-то образом базу данных для работы чтобы она работала отказывай устойчивым способом итак посмотрев что за с какими данными мы работаем данные удалось разбить на три типа первый тип это справочники это данные которые часто считаются но редко обновляются к этому типы данных относятся такие вещи как курт курсы валют справочники аэропорты справочнике авиакомпании но интуитивно понятно что курсов валют у нас на планете довольно ограниченное количество настолько ограничено что там бы меньше сотни интересных нам аэропортов тоже ограниченное количество их меньше 10000 авиакомпании и это вы меньшим второй тип данных это логе это данные которые часто пишутся но редко читаются к этим типом данных относятся такие вещи как параметры поисков пользователя параметры того по какому билету кликнул пользователь вот ну и собственно информация о поведение пользователя которую мы довольно четко тоже лагерным последний тип данных это динамические данные данные которые часто считаются и часто пишутся ну пример таких данных это ссылки на покупку конкретного билета на сайтах наших партнеров github результаты поиска тоже является таким типом данных для каждого из этих типов данных был разработан собственный способ хранения так первый тип данных это справочнике небольшие справочнике храним прямо в памяти каждого процесса каждого рабочего процесса ну понятно если это там справочник аэропорт вас 9 тысяч записей находясь память поместье процесса доступ к нему будет быстрее чем даже доступ к мамке что если это курсы валют то тоже хранить его а в памяти процессы довольно рационально и очень быстро если же справочник большой ну больше одного мегабайта и процессы от этого могут пухнуть такие справочнике можно сложить в файловую базу данных иметь тайбе столкнуться с фазовым файлами и базами данных но и не хотелось верить что все но на самом деле вряд ли в качестве файловой базы данных мы используем чего-то кабинет мы собственно это такой очень очень uniq ставил файловая база данных причем довольно современной вот такие справочнике мотаться в адресное пространство каждого процесса и мы не расходуем адресное пространство процессов для для дублирования одних и тех же данных кроме того для того чтобы иметь возможность редактировать и обновлять базы данных мы информацию до справочников хранятся прямо на файловой системе и виде файлов ну это довольно удобно для администрирования потому что там если изменилось какая и нужно поменять какие-то данные данная авиакомпании или аэропорте достаточно там открыть но если это делает программист достаточно открыть файл на редактирование дописать туда что-то собственная система эти данные сразу же подхватит не нужно там никаких никаких инструментов с работы банда с базой данных собственно никаких инструментов после того как данные были отредактированы у нас есть демон который использует а и на тихой это демон понимаешь что файл был был изменен и закидывает измененные данные в собственно в рабочие процессы кроме того висит отдельный демон elsen где который через ой найти файлы узнает что файлы были файл был изменен и раскидывает эти файлы по многом кластеров а все знают что такое нaйти фай оптимизируйте кто знает ну окей да и notify это такая подсистема ядра linux которая рапортует в процесс и о о том что какой-то файл был изменен довольно удобно и подсистему почему-то не получила широкое применение и так второй тип данных это логе рабочие рабочие процессы не могут писать логии прямо прямо в глобальное хранилище данных потому что это негативно скажется на отказывай устойчивости если логе рабочий процесс попытается записать данные в неработающую хранилища дата он либо упадет ну может мы потеряем данные поэтому было принято решение что рабочие процессы пишут логии всегда в локальное хранилище и по мере доступности глобального хранилище эти данные будут в него перетаскивается и последний тип данных это самые сложные данные это динамические данные причем эти данные должны постоянно пишутся постоянно считаются причем скорость от скорости доступа к этим данных напрямую зависит напрямую зависит зависит наш бизнес то есть если пользователь выбрал какой-то билета кликнул по кнопке купить мы не можем позволить пользователю ждать даже секунду ну и 500 миллисекунд тоже не можем позволить сдать наши эксперименты показали что увеличение загружу ожидаю во времени ожидания со 100 миллисекунд и 500 убивает конверсию процентов на 30 то есть эта вещь должна должна работать крайне быстро причем особенность наших динамических данных таковая что она замечательно сводиться к моделей ти вылью и их не очень много рабочий объем динамических данных у нас сейчас это порядка порядка четырех гигабайт собственно на вырост мы подумали что можно будет взять там прокси когда мы перестанем помещаться в памяти одной машине но сейчас мы помещаемся в одной жжение и так мы взяли и нам америки в или хранилище редис как уже говорилось в предыдущем докладе редис не умеет делать мастер строю free при кация поэтому мы на программном уровне сделали сделали избыточность то есть у нас стоит два рельса может ставить больше и каждый раз когда мы пишем туда данные мы пишем их сразу в несколько инстансов на случай если один редис упадет чтобы иметь доступ к этим данным и так пару слов о деталях реализации производительности вся эта система описанная выше было реализовано на третьем питоне отцы под цепочки и unity внутри цепочек исполняются асинхронно с помощью библиотеки торнадо для быстрой обработки этого бешеного потока xml который к нам приходит на используем библиотеку или xml в качестве файловой данные файлы в базу данных мы используем базу данных отчета кабинет а в качестве локального хранилища используем редис рабочий процесс сейчас у нас занимает порядка около 60 мегабайт причем 1 1 но до с 8 ядрами 16 гигабайтами оперативной памяти обрабатывает до 150 поисковых запросов одновременно для сравнения системы на ruby on rails обрабатывал с такой же конфигурации обрабатывала всего сорок пять поисковых запросов ну то есть потребление памяти мы немножко сократили и за счет этого в три раза бой в 3 раза больше нагрузки может тянуть одна машина что в общем довольно радует меня и так пойдем дальше немножко по организации кластера в самой правой части экрана это собственно все база данных которые нам приходится работать чуть чуть левее и собственно такое схематическое изображение кластера на на народов кластера живут пчелы это нашей терминологии это рабочие процессы которые обрабатывают собственно запросы который приходит от пользователя это поисковые запросы запроса на переход мы собственно все другие запросы пчелы никогда не пишут никакие хранилище кроме локального хранилища при этом пчелы могут считать из глобального хранилищу но желательно только из избыточного локального хранилища второй тип процессов которые живут на ноги это муравьи муравей такие процессы которые читают данные из локального хранилища и перетаскивают их в глобальное хранилище когда глобальное хранилище по какой-то причине становится недоступна муравьи расслабляются отдыхают и ждут ждут когда глобальное хранилище станет доступным как только она становится доступно муравьи перетаскиваю туда данные а таким образом обеспечивается отказоустойчивость также на ноги располагается локальное хранилище в которые пишут пчелы откуда достают данные муравьи ну и все это как то так работает дальше давайте посмотрим что может пойти не так и как обеспечивается отказоустойчивость предположим у нас сдохли два внешних хранилищ и причем сразу веры биты бахил и майской что в этом случае происходит пчелы с вообще не замечают никакой разницы они как писали в локальное хранилище так и пишут муравьи в этот момент конечно же расстраиваются им работы нет внешних хранилищ они работают ну и собственно данные хранятся в локальном хранилище до того времени когда когда эти сервисы восстановится мы когда проектировали ноду мы закладывали закладывали размер локального хранилища таким чтобы система могла проработать не теряя работоспособности до 8 часов восемь часов это время за которое стандартный админ может выспаться и потом привести систему в порядок после того как админ выспался и привел систему в порядок морали перенесут данной пользователи ничего не заметит что еще может пойти не так может сдохнуть 1 is not resist в нашем кластере да в этом случае пользователь тоже ничего не заметят так как данные одновременно пишутся в обе копии редиса и читаются они тоже из обоих к опере одессы если у нас хотят хоть один редис еще жив то все работает полноценно когда 2 редис поднимется ну все будет хорошо известна и тонкое место которое здесь может быть найдена это неправильный расчет нагрузки на рельсы что релиз просто не потянет обработку но считать надо правильно что еще может пойти не так ну тут совсем полная катастрофа в дата-центра попала попал метеорит и убила в сирии одессы нафиг при этом каким-то чудом но да еще живы в этом случае система уже по немножку начнёт давать отказ но мы еще какие-то операции будут работать например в нашем случае поисковые запросы будут работать но в глобальное хранилище не будет не будет попадать информация о ссылках на переходу покупки билетов то при этом если пользователь сделал поиск тогда когда керамическое хранилище недоступно но кликнуть кликнул по билету уже тогда когда она снова стала доступна есть вероятность что после восстановления динамического хранилище муравьев успеют перенести туда данные и клик все таки отработает однако такая система такая такое падение довольно редкий случай и рассчитываем что их не будет именно поэтому редис у нас избыточным а что еще может пойти не так конечно же у нас может отказать локальное хранилище ну в этом случае нам ничего не остается кроме как развести руками и вывести всю воду из кластера мы выводим но да и с кластером и нагрузка нагрузка распределяется по по оставшимся модам ну или можем ввести еще какую еще но дух plaster и так ну теперь наверное расскажу о том как как работаем с этой системой и как она выглядит целиком наверно понимаете что пчел и муравьев слова локальном хранилище мне достаточно чтобы система работала хорошо ещё нам понадобится 3 странных сущностей находящихся в левой части слайда 1 сущности это сущность которая будет балансировать нагрузку на пчел сущность которая будет знать какая пчела у нас уже занято и каким челом можно давать нагрузку в качестве такого балансировщика мы используем h прокси мы в общем это такое очень хорошее решение лучше блокировщиков мне своей жизни видеть нет не удалось а при этом запроса на поправок все шлет вот этот веселый человечек с чемоданом и фотоаппаратом таким образом я пытался изобразить путешественника вторая сущность это вот сразу подхо прокси находится многоножка многоножки это веб-интерфейс для редактирования конфигов юнитов как я говорил одну из задач и системы была простота конфигурации то есть через многоножку для редактирования всех конфигов юнита создан довольно простой интерфейс с которым может работать не технический персонал и в общем не технический персонал сейчас действительно работают с этим и в общем у программистов работы с неинтересной работы по конфигурированию системы довольно сильно уварилось и еще один интересный инструмент стоит у нас на каждой ноги это манит манит нужен нам чтобы следить за отказываю стоишь за работоспособностью системы манит собственно следить за тем чтобы все пчелы были запущены если пчелы начинают жрать слишком много памяти он их убивает и перезапускает то же самое делает муравьями он следит чтобы они были запущены также манит следит за тем чтобы нормально работал по прокси нормально работал web-интерфейс ну и в случае чего в случае чего сообщает обмену о том что что-то пошло не так при этом до пользователь нашей системы обычно работает со прокси не технически придти персонал всякий менеджеры configured систему через многоножку и админы вот тут изображена меня виде пингвина работают с мони там могут понимать что сейчас творится в системе сколько свободной памяти и так далее и того что мы получили юниты и цепочки могут быть независимо сконфигурированы в ран t'aime причем они не просто могут быть сконфигурированы они могут быть сконфигурированы не техническим персоналом вряд ли в одном ряде случаев и в другом случае не технический персонал приходят программистом и говорит создайте мне юнит который я хочу ставить вот сюда ну собственно довольно просто среда исполнения позволяет контролировать скорость выполнения юнитов и цепочек ну понятно что происходит у нас есть логе каждый раз когда мы тепло и msi на продакшен мы внимательно смотрим как изменилась скорость работы юнитов конечно мы делаем это и ipod и до deployment она production но в общем эта информация довольно полезно когда система начинает вести себя странно ну то есть система начинает работать медленно что мы делаем да мы идем смотрим какие юниты тормозят и разбираемся почему они тормозят это в общем было довольно сложно за этого пришлось приходилось использовать внешние инструменты непростые вроде new relic а сейчас нам показывает это ибо она просто так отладка система теперь осуществляется через через ищите себе то есть фактически каждый программист может слабо свободно послать запрос в рабочую систему даже production системы и посмотреть как она на него отреагирует по сути когда нам приходит какой-то фидбэк от пользователей который говорит вот вас система ведет себя странно мы достаем что за запрос был у пользователя и прогоняем его по очереди по всем юнитам это позволяет довольно быстро локализовать в каком unity происходит проблему поправить unit разработка юнитов в этой системе не требуют не то что каких-то там знает она в принципе не требует специальной подготовки если человек способен написать hello world the unit он сможет написать вот ну и к чему все это благолепия нас привело скорость системы у нас сейчас стало 0 1 секунды до если сравнивать с тем временем которые запускались рельсы ну в общем прирост значительно значительный на пару порядков повышение скорости запуска системы значительно сказалось на скорости разработки по сути сейчас программист мгновенно но может запустить запускать систему со своими новыми изменений в общем программистов стали ходить по офису еще более счастливыми еще интересный момент когда мы сократили количество серверов два раза вот наши менеджеры которые пекутся о расходах и доходах были приятно удивлены чтоб когда после запуска системы человек за сервера пришел в два раза меньше и последний пункт который очень сильно радует меня лично это тот факт что кот кот в эту систему ясень пишут не только программисты которые собственно работаю в команде я себя легко и просто в эту систему пишут код программисты из соседних команд а ну наверное я свое повествование закончил и готов ответить на все ваши разгромные вопросы особенно жду вопросов из баду добрый день я не из баду а такой вопрос насколько я понял юниты каждый юнит это отдельные торнадо сервер не они неправильно а каждый юнит это десять строчек кода нефть и все юниты работают в одном форматтер надо сервере понятно в одном on тогда вот какие сервера вы описали получает на вход джейсон 3 а интерфейс этот смотритель джейсон не получают какие-то конкретные сажают же сон это язык общения системой то есть внутри система юниты между собой не занимаются сериализации диси реализации данных джисона не работают просто передавая тупой карты же между собой но в любой юнит мы можем здесь сделать запрос на своей стороны сериал данный джейсон тот фреймворк в котором работает юнит одессе реализуют их в кортеж и передаст в юнит соответственно когда ей не завершит свою работу обратно си реализует iverson я даст пользователю понятно как тогда при таком подходе реализуется система когда вот начинать запросы типа юнитам и доходит до опрос вот поставщиков билетов да отлично значит точкой входа является так называемый адаптер адаптер это url который стоит снаружи системы все что делает адаптер он преобразует печь степи заголовки тело запроса cookies юрий он преобразует их ну вот тоже тоже в кортеж да за ним стоит тот самый param.sfo людей шин юлин что он делает он во лидирует что параметры более-менее валин и и складывает их во внутренний формат который уже по нему принимают июне the gate of ну да у меня собственно вопрос в чем вот у вас есть несколько поставщиков билет но у них у всех разная скорость ответа не за 20 секунд много мне все ответят а соответственно вам надо а можно ли при такой системе сделал так чтобы результаты вот этих битов которые открылись ответили раньше сразу вывести на экран а потом какая мир джингу добавить когда ответят отличные вопросы я не уверен что люди поверят что вы задали этот вопрос не сговариваясь со мной одним из побуждений к разработке этой системы явилось то что мы хотели получить real-time поиск билетов старая система у нас принципиально этого не позволяло она ждала 30 секунд и когда все всякие ты либо ответили либо не успели ответить в тридцать секунд она давала результаты одним из побуждений к созданию такой системы было то что юниты с junit агентов совершенно независимы никак не связана с другими частями и в тот момент когда мы захотели сделать real-time поиск то есть отображение билетов на стороне на стороне клиента именно тогда когда ответил gate мы просто взяли и собрали из тех же юнита в другие цепочка и сейчас на сайте 1 л свои именно это можете видеть действительно что мы сделали мы вводили эту систему пошагово сначала мы на на базе этой системы создали workflow полностью повторяющий работоспособность старые системы а потом для создания for real-time поиска мы просто перекопана валию нет итак чтобы чтобы данные возвращались на клиента по мере их поступления собственно вот пару пару недель назад aviasales перешел на real-time поиск и без этой системой это сделать не получалось понятно спасибо можно вопрос про дублирующий результата я что-то с про результат но что про него рассказать я не понял если гид который дает лучшую цену природ позже торгует обрабатываете пользователю уже показали лучшую цену да да собственно тут есть два аспекта этой проблемы во первых обычно если gate показывает лучшую цену то это является свидетельством того что у этого гейта работают хорошие менеджеры которые придумали придумали как это хорошо организовать второй аспект что если в компании работают хорошие менеджеры то в этой же компании работают хорошие программисты на у которых системы работает быстро но это так отвод в сторону а на самом деле мы показываем пользователю билеты которые у нас есть самый дешевый и текущий момент и у нас есть прогресс бар в котором видно что сейчас идет поиск еще и по другим агентством и по мере поступления мы показываем что де самый дешевый билет стал другим берите его я ответила на воду ну как же так но вы обещаете что вы меня хотя бы в коридоре поймаете спасибо отлично нет скажем так нет все юниты работают в одном процессе они не общаются между собой протокол они внутри общаются да но как к каждому юниту мы имеем доступ поищите себе то есть система она очень открыто а между юнитами проблемы быть не может потому что между юнит мы берем одни данные передаю другой другие редис и кабинет кабинет зачем все очень просто смотрите может описать фрёйдис да но не вижу никакого смысла нагружать его этой работы все равно у нас юнита должна быть конфигурация да и доступ колокольников играть с локальным данным внутри у схема например с тем что есть редис мастер да на каждом юните slave как источник информации процесс репликации заместо ваших муравьев суждено на самом деле такой вариант в принципе возможен и если вы видели то архитектурой системе позволяет сми не перейти к такой архитектуре довольно быстро но вот чисто исторически так сложилось что я люблю файловые базы данных если кто ну если она станет работать плохо но перейдем на ту систему которой вас на самом деле мы и рассматривали но вот мне захотелось какие-то кабинет попробуй просто попробовать ну я пробовал раньше ну вот так наконец-то от лица компании но отличная я правда автора по не так вот так устал сиделку сна развлекал делаете при печень какой-то данных вот типа вы показ и билет показать дешевый билет на завтра на послезавтра какой-то про активный поиск который подсказывает что можно сэкономить если перенести там будущее скажем так смотрите поиски которой мы делаем какие там они нам бесплатны а вот поиски гейта в пиджаке сам они уже не бесплатны поэтому про активный поиск мы делать ну не можем потому что они скажут ребята вы делаете вы делаете больше поисков чем хотят ваши пользователи это стоит нам денег на что мы делаем на самом деле мы а если видели в одном из слайдов я показывал такой units and took you вот на этой очереди в которую мы отправляем данные и десяточки веселые обработчики кроме статистических обработчиков которые работают и маркетологов там есть обработчики которые сохраняют результаты поисков довольно длинный интересный кэш у нас есть такие поиски как колин сервиса как календарь низких цен карта низких цен вот эти данные использую вот этот вот длинный кэш он используется для этих сервисов который приходится от медленных gate of вы на клиентской стороне через java script пример животик результатом да как я говорил у нас на данный момент конкурировать две версии и которые на на клиентской стороне в java скрипте их придерживает и на сервере и мы ведем об и тестирование то есть каждый раз когда мы вводим какую-то фичу да мы не просто заменяем одну другой мы пускаем 2 phi2 фичи в параллели и довольно долгое время пока новая фича не начнет приносить больше прибыли чем старой мы не заменяем полностью на другой вот буквально за пару дней до того как я прилетел сюда из таиланда a real-time поиск начал выигрывать это была большая победа этого движка и собственно ближайшее время мы полностью перейдем на merging на стороне клиента спасибо я рада я на я надеюсь что я ошибся но у меня сложилось такое впечатление что если на седьмом часу сна админа упадет но до вместе со своим local store джим то все билеты которые будут проданы за 7 часов они пропадут ли не совсем не до меня порадовать осмотрите данные в local store g хранятся только тогда когда муравьи их оттуда не забирают если у нас local storage ну не работает но если у нас не работает около 2 что надо полностью выводится из кластер до нагрузка раскидывается по остальным много винилов час сначала all редис админ спит седьмой час после этого падает но да ну вообще как и говорил редис у нас работает в избыточной конфигурации сейчас у нас их 2 и если вдруг случится ситуация что упала дворе диса админ еще не встал утром я поставлю 3 regis ее выгоню админа извините можно повторить в tracker давайте вот если упала дворе 10 мин спит 7 часов а то все то что вы продавали за 7 часов пропади в ней нет правда то что мы пропадали за 7 часов не пропадет пропадет только переходы которые за эти 7 часов продавали все чтобы продавать все чтобы продали работает ok но как я уже говорил для избавления от этой ситуации regis у нас работает в отказоустойчивые конфигурации сейчас у нас их два вероятность того что сдохну дворе диса но на общем довольно мало если внезапно не дай бог это случится что админ устроит настроит все так что дворе среди редиса сдохнут ну во первых я наверное начну верить в бога во вторых волю админов третьих ставлю 3 редиса нет я не ответ услышать я потом с вами поговорили думаю пьем отвечу на вопрос прошу конечно вы имеется виду нашу знаю старую систему или но вы отлично сотни прайс-листов ну и у нас миллионы записи про рот и мы тоже разбили все тоже на ноты у нас там и ваши пчёлы и муравьи те же у нас не варлок же называете а давайте называть их одинаково так ну ну такой вопрос цепочки тоже у нас есть да как ни странно и будет размножаться по крайней мере будем встречаться да да но есть такой один вопрос ваши данные на выходе передаются другим юнитам на вход да если это допустим 2 мегабайта или день 20 мегабайт то эти все там джейсон 20 мегабайт в другой умения прожить и джейсон мы используем только для общения с внешним миром внутри данные никто не смеси реализует по сути внутри системой перри мы передаем только ссылки на данные вот тоже как у нас отлично ну что вы за это просто важное чуть-чуть прокомментирую если вы помните довольно много открытий в ученых называется двумя фамилиями ученых да это кажется тот случай похоже похоже у нас балансировщика правда немножко свой какой собственный вы не взяли характер нет возьмите возможно но нас наруби наруби да но мы добились того что мы нас 300 мегабайт а сколько занимает ваш в памяти ваш балансировщик наруби балансировщик там мало у нее на вы скажете сколько буквально там не знаю может быть 1020 ну вот as a proxy 4 хорошо то есть получается та же система я просто смотрел на вас и думаю как так ну все отлично так и должно быть это будущее индустрии ясному тогда в принципе наверно все я просто хотела продать именно на то что ссылками пользуются внутри юниты на данный конечно конечно ссылки дрался добрый день сюда сюда да я вижу ваза вот еще один вопрос из баду это вот интересует такой вопрос почему рассматривали угги вы вместо едется converted скажем просто почему так вопрос возник потому что по скорости в общем все на высокий тоже очень быстр и там есть импликация я я понимаю ваш вопрос но смотрите на мой взгляд и редис и москве являются решением примерно одинаково уровне стадии зрелости причем редис на мой искушенный взгляд значительно проще в разворачивании кроме того в общем есть у меня такая черта я люблю всякие извращения до трети значительно больше извращения еще москве и если это из рук нет ну окей я запишу это в список непроверенных извращений и обязательно следующий проект и где-нибудь попробую но мне хотелось редис если она перестанет работать ну в общем с меню тут ничего хитрого нет но это просто еще уменьшает количество сущностей в вашей пушкину на самом деле количество сущностей при переходе от старой системы к новой у нас и так довольно сильно изменилась при этом аки вылью хранилище нам нужно по соображениям скоростью ну вот просто нужно да и одно пиво или хранилище у нас можно было использовать мозг верим в вив в ротике вылью хранилища можно но к этому извращению я конечно же еще вернусь мы не рассматривали честно говоря рассматривал но вы знаете вот редис в индустрии както применяется чаще для kiwi чем майские льда и как бы ну в общем мне очень хотелось пробовать моя сквер с таким извращенным способом как хэндлер socket просто ради того чтобы попробовать nokia спасибо спасибо спасибо"
}