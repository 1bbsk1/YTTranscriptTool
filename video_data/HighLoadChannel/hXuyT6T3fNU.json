{
  "video_id": "hXuyT6T3fNU",
  "channel": "HighLoadChannel",
  "title": "Микросервисы через боль и превозмогание / Филипп Дельгядо (lekton.io)",
  "views": 17688,
  "duration": 2965,
  "published": "2023-04-28T06:19:52-07:00",
  "text": "Привет вообще доклад называется микросервисы через более превозмогание и Судя по количеству людей в 10 утра в зале наверное с более превозмогания в микросервисах все хорошо уж при размоганием точно Меня зовут Филипп дальгадо я занимаюсь уже довольно давно разнообразными относительно сложными системами и последний много лет со всех сторон из всех Радио России слышно про микросервис Я не выдержал решил что надо наконец тоже сделать по этой теме доклад начнём с определения как всегда Разумеется определение любой подобной вещи дофига Ну возьмем самое классическое определение Криса ричардсона автора сайта про микросервисы где рассказать о том что такое микросервис вообще очень прикольное определение не буду его зачитывать целиком Я думаю все его более-менее знают Вот но надо заметить что в этом определении половина пунктов вообще говоря пожелания к тому как это должно выглядеть часть вообще говоря про процессы а не про конкретно технические вещи например то что она там с маленькими командами связано а часть вообще по результату То есть то что мы хотим получить и самое интересное что вот я лет 10 назад делал десктопное приложение вот и оно полностью соответствует всем этим требованиям к микросервисов Кроме того что точно не является микросервисом там были независимые плагинчики которые общались друг с другом которые были высоко поддерживали всё это внутри там уезжая компонентные системы и ничего кроме и при этом точно это не было микросервисом или вот у меня там рядом есть проект огромный проект на урок ли который тоже соответствует всем требованиям маленький команды тестирование поддержка выкладка по частям и тоже очевидно что огромный проект на три оракова не микросервиса поэтому это хорошее определение но к сожалению не очень работающе и в общем я бы Разумеется нельзя там увидев 150 определений какой-нибудь сущности не придумает 151 Разумеется я тоже решил сказать что мы будем здесь называть микросервисами это когда у нас довольно много компонент Ну один - это ещё мало Пять - это ещё не кучка 10 уже наверное кучка то есть вот когда у нас там больше 3-5 компонентов это уже похоже на микросервисы Когда у нас несколько баз данных э есть много Мы даже будем говорить каких-то архитектурных стилей Где можно говорить про одну базу данных много сервисов работающих с ней но это всё-таки не то что мы привыкли называть микросервисыми Это где у нас используются современные протоколы общения там Кафка grpc современные там коробо Соуп Не современные Поэтому если вас 20 сервисов общается через коробу мы это микро сервисами назвать не будем Ну пусть никто так обычно про них не думает Хотя наставника будем честными какая разница и современные подходы к разработке Ну то есть если вы делаете какую-то сложный продукт компании где кто-то использует слово скрам там не знаю разливают с утра сервисы Если нет то нет Окей то есть вообще всеми красиво это про ощущение современности про ощущение того что это современный подход к разработке Зачем вообще нужны микросервисы вернёмся опять уважаемому который копирует половину определениями хотя бы говорит что это самое то для чего они нужны то есть там тестирование диплоид и так далее и так далее и так далее если быть совсем честным с моей точки зрения ни одной из этих свойств не является свойством микросервисной архитектуры более того оно обычным противоречит но мы не будем туда углубляться потому что это не то о чём мы хотим заниматься пусть даже всё это написано является честной правдой Вот но надо понять что вот если для нас эти цели или любые другие цели которые там описывает фауле описывает неумных В общем много кто пишет американцы соответствуют то насколько бесплатно мы получаем все эти бонусы там тестирование развёртывания там простоту а Должны ли за них платить Разумеется ленте даром не бывает вот не бывает такого что мы взяли бесплатно мы получили какую-то интересную важную для нас фишку ничего за это не заплатили попытаемся как раз сегодня в основном говорить о том что нам приходится и как именно приходится платить за появление микросервисов в нашей с вами жизни некоторые проблемы самый первый самый простой это аналитик у нас много-много баз данных в них есть какие-то данные эти данные иногда согласованы иногда не очень и нам нужно там отдать пользователю какой-то отчет за какие-то несчастные там не знаю 5 секунд Вот и выясняется очень сложная задача Потому что сложная потому что стандартные привычные инструменты никакие не работают поэтому мы поговорим побольше целостность у нас опять-таки много баз данных живут какие-то данные в одних эти данные актуальны другая база данных в какой-то момент почему-то отвалилась не старые данные и нужно это целостность хотя бы в конечном итоге хотя бы сохранять тоже реальная проблема которая постоянно приходится сталкиваться Надёжность э-э у нас много компонентов каждый из которых живёт в очень ненадёжной среде под названием современные вокальные или не вокальные сети которые постоянно падают сами сервисы постоянно падают и нам нужно уметь с этим работать это тоже проблемы это вызов которая постоянно приходится решать для любой микросервисной архитектуры Ну и главное сложность у нас много взаимодействующих кусочков которыми нужно понимать как взаимодействовать которые требуют некоторых новых подходов все это приводит к резкому увеличению сложности разработки Мы про это еще отдельно много будем говорить Итого У нас есть некий набор проблем Это Разумеется не все проблемы Вот с которым точно всем кто занимается микросервами придется работать так зачем нам вообще на самом деле нужны микросервисы какие реальные пользы от них есть рассмотрим пример Я из финтеха поэтому все мои примеры будут откуда-то из платежных систем и так далее вот у нас есть какой-то сервис покупки товаров у него снимки набор вполне понятных требований Мы хотим покупать товары по банковской карточке поэтому мы сразу попадаем на требование pcss Мы хотим работать в кредит чтобы выдать человеку кредит надо собрать персональные данные мы подпадаем под там закон 152-фз либо любой другой закон о работе с персональными данными совершенно отдельная реабилитарка Мы например хотим делать распродажи это значит высокая пиковая нагрузка у нас чёрная пятница и там X100 последней нагрузки за год и при этом мы хотим чтобы пользователи были какие-то личные счета это нужно очень высокую надежность того что с ними работать если бы мы это делали на монолите у нас был бы один прекрасный Монолит который надежный он же производительный он живет pcss он же под 152-фз будем честными Я не знаю как делать такие проекты вот чтобы одну огромную сразу всему удовлетворяла поэтому мы пытаемся взять Вот как Верка поехала вот сделать несколько маленьких аналитиков маленьких сервисов каждый скатах реализует что-то одно там сервис счетов пользователей надежный сервис распродаж производительный шлюз работы с кредитными карточками соответствует 50 dss там кредитный шлюз 152 ФЗ то есть мы наши большой набор требований пытаемся разрезать по кусочкам и собственно это одно из самых важных Зачем нам нужны микросервисы это разнообразие подходов к разработке то есть мы можем использовать в разных частях проекта разные не функциональные требования то есть для надежностью безопасностью эффективностью требованием по памяти вот мы можем говорить о том что у нас в разных частях проекта продукты разные процессы А без процесс обеспечения качества процесс чистоты изменений я года три назад как раз делал доклад о том как в разных частях проекта имеет смысл использовать разные процессные подходы И где-то вам нужно там не знает тройной к ревью потому что это процессная логика а где-то в общем чем быстрее выйдет в Продакшен тем лучше И даже если будет куча ошибок неважно главное там то маркер Вот и как раз микро сервисная архитектура потом определили которая приводило позволяет это сделать мы можем использовать разные технологии Если вдруг Нам действительно нужно какое-то специфическую функцию там на eml который есть пока только под Paint они ну сделаем сервис на питоне вот если нужно где-то совсем уж топовая производительность возьмем там не знаю раздра воры или если совсем все страшно си можем обычная это антипата мы будем честными то есть разные технологии использовать очень дорого и не всегда полезно но мы пока имеем такую возможность Ну и главное что мы можем использовать очень разных людей команда люди разные команды из люди собираются разные и когда вас одна большая Проектная база они постоянно сталкиваются лбами и разные культуры приходится пересекать в одном системе Когда у вас разные сервисы Вы можете разводить разные культуры производства по разным кусочкам взаимодействия там жёсткое выстраивание взаимодействие имя консервисы позволяют немножко упростить взаимодействие людей это собственно одна из очень важных и не самых тривиальных польза от микросервисов как идеология коммерно братьев подходов к разработке микросхемы создает нам изоляцию изоляцию проблем то есть у нас один микросервис упал остальные вроде бы выжили один микросервис съел всю память Ну окей мы его убили перезапустили заново вся остальная система как-то живет изоляцию неопределенности У нас очень часто бывает много разнообразных неопределенности во всех наших проектах продуктах то есть где-то мы не знаем как будет изменяться законодательство где-то у нас пока еще нет точных требований где-то мы не знаем А какая на самом деле у нас будет нагрузка на данные конкретные там функцию там может быть здесь человек в месяц А может быть 100 человек в секунду и это неопределённость Мы можем распределять по разным кусочкам продукта по сути по разным элементам нашей системы по разным сервисам и совсем изолирует эту неопределённость от всего остального и наверное самый главный пункт который дает микросервис на архитектура Это упрощение архитектурного надзора Когда у вас какая-то большая кодовая база она очень часто сваливается там в Big Ball of Mod Вот то есть там если Можно контролировать сложно убеждать людей что не надо там использовать напрямую ходить в чужую базу данных пользуются только там внутренний интерфейсами постоянно приходится сложно контролировать то что люди не сделают что-то не того поскольку в микросервисной архитектуре у нас четкий протоколы эти протоколы как-то формализованы У нас есть возможность снаружи как чёрному ящику отнестись к микросервису и понять правильно его используют или нет архитектурный надзор для для тех кто гораздо проще вот и это наверное основная причина по которой на самом деле микросервы сейчас так популярна Ну надо не забывать ещё про маркетинг потому что микросервисы хайп и гораздо проще набирать людей в команду где у нас используется микросервисы Где в команду где у нас огромный огромный Монолит Вы можете всегда в микро-сервисе сказать Вот мы используем дико модные там где-нибудь в уголочке сбоку чтобы никому не мешал и под это дело добирать людей в больших системах монолитных системах так не получается Итого подытожим что основной плюс от микросервисов это возможность реализовывать разные и функциональные требования в разных частях системы когда вас неофициальные требования относятся не к системе целиком к ее кусочкам и обеспечит надзор на взаимодействие различных кусков Окей Мы даже осознали Зачем нам нужны микросервисы Давайте подумаем А как их собственно строить Вот мы выписали какие-то проблемы а как эти проблемы можно было бы решать Ну начнем самый любимый Мои проблемы со сложностью Кто узнал эту картинку она очень популярная Замечательно Это набор это карта микросервисов убера примерно по моему 5-7 летней давности сейчас гораздо больше всё гораздо хуже выглядит Прямо скажем как спагетти в лучшем случае это как раз про то почему микросервы сейчас-то оказываются солочными потому что вас много независимых элементов которые как-то взаимодействуют которые сложно влезают там в одну голову или в несколько голов и как всегда у нас есть некий набор стандартных инструментов не связанных на самом деле напрямую с микросервисами которые позволяют работать со сложностью систем Я про Некоторые из них расскажу очень популярные слова сцепленность и связанность которая на самом деле если внимательно разобраться А что люди пишут когда говорят про разделение системы на подсистемы Когда у нас каждый из элементов системы рассмотрения тоже является системой и как именно можно разбить какой-то на большой большой элементов так чтобы все внутри кусочки были связаны внутри больше чем снаружи на самом деле куплен конфликт про это а есть огромная теория теория систем которая на самом деле очень много работает с подобными задачами с тем как именно смотреть на систему Как именно систему резать на разные кусочки Как именно можно выбирать уровень рассмотрения Очень советую читать материалы по этой вообще говоря Вполне себе науке Вот и применять её как раз сервис архитектуру топология у нас уже проработана очень много разнообразных топологий для распределенных систем для микросервисных декораций там layt-системы там securies Цитадель есть би там пайпсенфа и фильтрс очень много разнообразных решений есть Вот и нужно про них знать и понимать и уметь называть какие-то части своей системы какими-то правильными словами в свое время в описании было сказано что для того чтобы отвечать на вопросы Какие сервисы С какими могут взаимодействовать и вот если вы ограничиваете себя Если вы не даёте всем сервисам взаимодействовать друг с другом а как это описываете какие-то из них внутренние какие-то внешние какие-то относятся а-а к доменной модели какие-то красные бал этот контекстам то есть тем самым описывает типологию своей системы и вот этапологии указывая ограничения нам гораздо проще думать вас меньше возможностей поэтому не надо думать про них про всех типизация на самом деле не всегда всем микросервисы одинаковые когда иногда сравнивают микросервис на архитектуру с соо сервиса рент говорят о том что в соло была проработана это по типология разных сервисов А вот в микросервисной архитектуре этого нету да Когда мы читаем про msa там обычно говорят просто что все сервисы одинаковые на самом Реально если Вы посмотрите на любой реальный проект они будут про разные некоторые про работу с данными некоторые пополнение бизнес-операций некоторые реализацию опили адаптов к внешним системам они все очень про разные и количество этих типов даже в большой системе довольно ограничено их эти типа стоит выделять осознавать использовать и активно внедрять свою постоянную практику потому что это позволяет упростить мышление вашей системы самое главное проблема программирования нейминг от точно также принципиально нужна для микросервисов Если вы не можете придумать понятное и четкое название для конкретного микросервиса скорее всего выделить неправильно лет так 10 назад когда только-только начал заниматься с определенными системами Мне бы очень прикольно давать интересные имена компонентам там не знаю имена японских богов там название датских ветров это всё прекрасное название очень красиво смотрелись документации пользоваться этим было неудобно Потому что ты смотришь на какой-нибудь прекрасно там Винду и не знаешь А к чему это вообще А что это должно делать у сервиса должно быть одно понятное Точное название определяющее Чем он занимается Если вдруг оно не находится значит с выделения микросервиса произошла какая-то ошибка Значит надо как-то подумать либо другое название либо по-другому при разбить вашу систему нейминг принципиально важен для простоты а с консолью надо бороться контролем опять-таки вот в прошлом году делал дизайн доклад доклад про дизайн ревью как про инструмент Управления сложностью архитектуры в том числе вот можно посмотреть потому что умение по сначала подумать как вы будете делать а потом реализовывать позволяет контролировать сложность того что вы делаете Рисуйте простые картинки архитекторы очень любят рисовать картинки кстати замечательно смысл картинки не в том что люди лучше воспринимают визуальные а в том что сложно картинку сложно рисовать и невозможно понять поэтому вы прессуют картинку вынуждены оставить только самые важные на ней и выкинуть неважное И именно поэтому надо рисовать картинки простые картинки там из пятидесяти пунктов максимум Ну и для микросервисов можно устраивать мониторинг-ложности А сколько реально у вас один сервис взаимодействует с другими реальным данным поломкам А сколько разных типов событий он принимает насколько насколько широкий контролируя там Можно контролировать сложность всей системы а и пишите документацию документация тоже про сложность документация надо указывать как раз все то что мы до этого перечисляли Какие интерфейсы причем в основном даже важнее описывать асинхронный интерфейсы Какие события сервис получает Какие отправляет как он их обрабатывает синхронными все к счастью гораздо проще последние годы Какие типологии вы используете и к чему относятся разные типы и что вы можете сказать по каждый тип каждого сервиса Вы можете как его тестировать потому что разные типа сервисов по разному тестируются как он теплоится с кем он может взаимодействовать с кем не может ну и Разумеется надо описывать и паттерны которые вы используете как стандартная практику которую почему-то никто почти не применяет собственно по материалу по сложности я отдельный свой специально под это выделил теория системно ничего не репа это сейчас много разных хороших текстов стоит читать это все сложнее книжки и их сложность как раз позволяет дальше проще работать со сложными системами поэтому точно не сложно это большой плюс трисс дает некий набор инструментария по управлению сложными системами и некоторые набор мыслительных конструкций Как думать про них современная психология тоже очень много про и нейропсихология про которую вот Гриша Петров любит рассказывать она тоже работа сложностью и многие инструменты которые мы описывали на самом деле тут оттуда что нельзя работать в сложной системы не поименовав её вот как именно определяется границы сколько систем вы одновременно можете удерживать и некое набор хороших книг статей То есть я очень нежно Люблю Ричарда фильмы Но я считаю что это лучший учебник не которого учебник физики Хотя первый том прекрасен а статьи лучший инструмент по развитию физического мышления сегодня про то как можно подходить к сложному системам вот теории функции комплекта переменной она вообще никак не понадобится коробос в работе но если Вы внимательно туда погрузитесь и начнете научитесь работать со всеми связями которыми там есть дальше система которая встречается в работе будут казаться довольно простыми вот ну и тут прекрасная статья на хаббре как спроектировать табуретку где очень многие вещи описанные и много текстов не моя и много каких-то правильных цитат и текстов приведены Окей со сложностью разобрались вот хотят как вечный бесконечный процесс надежность на самое надежность бывают разные бывают незапланированные проблемы оборудование отказало там сервис упал еще что-нибудь вот и запланированные проблемы на самом деле запланированными все гораздо проще сейчас огромный набор инструментариев там мониторинг про это все на конференции рассказывали вот эти последние 10 лет почти на каждой много и запланированными все примерно знают Как справляться гораздо интереснее запланированные проблемы То есть выкладки какого-то нового обновления программного обеспечения системы железа попытаемся немножко про них поговорить поподробнее Ну кажется все просто вот у нас Мы хотим выкрутить новую версию красненький квадратик он с кем-то взаимодействует нам нужно там опустить старый сервис поднять новый все простенько Окей но у нас на самом деле обычно не один сервис запущено несколько экземпляров и мы пока их одного опускаем другой поднимаем остальные должны работать нам нужно обеспечивать совместимость То есть у нас должен Новый сервис уметь работать с базой данных которые одновременно работать старые версия вот старая версия должна тоже понимать данные которые пишутся в новый и нам сразу приходится как-то возиться с поддержкой версионирования структур в базе данных замечательно но когда вас этих сервисов много нравится не часто то поддерживать версионирование базе данных там на 20-30 версии в обе стороны сложно приходится организовать какую-то миграцию то есть какой-то отдельный сервис который берёт ваши данные старым в одном и записывают уже в новом но чтобы точно знать что у вас там не хранится запись старом формате 10-летней давности это нетривиальный на самом деле программка ее приходится писать потому что должна брать там маленькими кусочками преобразовывать не добавлять дополнительные нагрузки уметь учитывать зависимость миграции друг от друга миграции могут быть долгие Я как-то в Яндекс деньгах у нас одна миграция данных шва 3 месяца на Боевой базе вот потихонечку при этом выходили новые релизы новые функциональность она работала работала работала работала работала потом наконец доработала это была огромная миграция где можно отдельно рассказывать вот это нормально нормально одновременно много длинных миграции Потому что если много данных с ними приходится долго работать И для этого приходилось специальное решение файлы не ликвид Бейс ни тем более какой-нибудь он не помогают это реализовывать просто дальше поскольку у нас появилось много каких-то маленьких кусочков сервисов Мы хотим так или иначе балансировать нагрузку устроить канарейку просто потому что у нас уже сложная логика и мы не можем быть стопроцентно уверены что мы все абсолютно протестировали со всеми совместимости реальных версий на нашем продакшене с версиями назад версиями Вперёд поэтому хотим взять какое-то количество пользователей поиграться Сначала с ними если всё хорошо выучить обновление всюду для того чтобы реализовывать их наречной которая только что писал нам нужно уже какой-то бунтировщик нам пришлось значит им добавить балансировку но при этом у нас часто одна какая-то фича расползается по нескольким сервисам и мы не можем просто только там не знаю Говорят что на Новый сервис Мы перенаправили один процент трафика протестировать новый функциональность нам приходится делать более сложную вещь когда помечать какие-то входящие запросы какими-то метками и делать так чтобы они обрабатывались только на конкретном наборе сервисов с версией не меньше чем такая-то чтобы можно было протестировать И сделать канарейку по функциональности которую вы совпадавшим тут нам уже стандартная балансировка не спасает и приходится ставить всякие навороченные сервис мыши там типа истину которая как раз умеют помечать запросы дальше эти запрос равномерно распределять по всей системе учитывая что куда попадает всё замечательной Но кроме простых там синхронных вызов у нас в системе часто бывают очереди и нам вообще говоря нужно то же самое то есть канарейку сложный роутинг делать для очередей и Например я не знаю красивых решений для реализации канарейки поверх например Кафки то есть там есть много разных сценариев там избыточное количество партиций и консьюмеров и мы умеем играться с разными консилмерами подключаемыми там накоряличных сервисах или у нас есть топик который отдельный сервис который прикладывает данные с одного топика в другой в зависимости от какого-то набора тегов редкостное безумие Вот э-э получается что-то такое очень сложно не простое но с этим Приходится работать представляете наша простая картиночка слева стало только из-за того что оно необходимо обеспечивать нормальную выкладку гораздо более сложная картиночка снизу более того мы понимаем что выкладка у нас перестала быть декларативной то есть мы уже не можем сказать мы хотим у нас была такая система на продакшене стала такая сделай как-нибудь чтобы перейти станет б нам уже нужна сложная императивная логика с какими-то ответвлениями с какими-то проверками с какими-то обращениями к опсам за контролем там всё ли можно продолжать для которой сейчас увы нет решений потому что все классические Наши Любимые все было они все про декларативную выкладку а тут на самом деле она чисто императивная есть несколько плохих решений все плохие по-разному то есть там дженкинс коммунда вот не n8n Вчера буквально рассказывали как на нём можно сделать либо вообще все писать наше тоже нормальный вариант Но это становится тоже новые сложные компонент в ней этой картиночки которые обеспечивают оркестрацию сложного процесса выкладки Если вы говорите выкладке 24/7 где вам реально нужна высокая Надёжность большая часть элементов всего вот этого Вам приходится удерживать главе реализовывать что тоже добавляется сложности пока простых решений этой задачи Я не знаю Если кто-нибудь знает с удовольствием послушаю публично причем Open socks желательно Окей с надежностью тоже разобрались целостность есть простой пример какой-нибудь платеж перевод денег одного физического лица к другому и в рамках этого процесса надо сделать очень много вещей проверить самцы получателя плательщика там зарезервировать суммы проверить лимиты и так далее так далее и так далее И все это вообще говоря одна бизнес транзакция Какое слово возникает у вас всех голове когда мы говорим про распределенный бизнес транзакции крикните кто-нибудь правильно вот Сага также проблема что с микросервисами слово есть а содержания нету это называется симуляк собственно в оригинальной статье там Гарсия малины под Сага имела сюда вообще просто любая длинная транзакция просто длинная Неважно какая Ричардсон чуть-чуть по-другому переформулирует статью малины и говорит о том что на самом деле транзакция там Сага это у нас про разбиться на арены шаги каждый шаг является транзакции мы умеем компенсировать каждый отдельный шаг и мы транзакцию разбиваем на такую цепочку все замечательно идея классная но при попытке реализовывать выяснять сразу много вопросов появляется там не знаю как понять что возникла проблема кто должен понять что у нас в процессе выполнения транзакции возникла проблема кто и как запускает компенсация я последние года два пытаюсь коллекционировать методы реализации сак вот я про некоторые Сейчас расскажу если у вас есть другой метод который не попал в этот список Я с удовольствием послушаю и добавлю в свою коллекцию Потому что когда люди говорят что у нас что-то реализовано Сага это не значит ничего надо сразу взять А как именно у вас эти Сайги устроены самый простой вариант - это регистрация с регистратором То есть у нас есть исполнители бизнес-процесс исполнители Саги которые регистрируют в регистраторе начала шага там указывает компенсация которая потребуется через какой-то тайм-аут нужно всё сделать выполняет шаг регистрировать следующий и так далее Вот и сам исполнитель он не надёжный он без состояний он знает сценарий регистратор он надежный он хранит все пришедшие а запросы на шаги считает тайм-ауты и если понимают что произошло ошибка он инициирует собственно выполнение компенсационных шагов Это один из самых популярных вариантов реализации в котором есть много Разумеется проблем Например нужно делать так чтобы регистратор упавший при выполнении списка компенсаций тем не менее до конца что-то довел вообще предусматривать сценарий ошибки при откате при компенсациях саге логика регистратор вообще при этом очень непростая обычно это отдельная очень специфически нетривиальный сервис с которым обычно довольно много проблем тут я думаю здесь довольно много коллег которые у себя в реальности используют подобный подход они могут про него отдельно рассказать но при этом самый простой вариант Можно говорить не про архистрацию пахреографию и сам Ричардсон рекомендует использовать хореографию там все примерно то же самое только мы вместо указания о том что что-то сделали Отправляем сообщение о том что вот нам шаг какой-то совершенный вот типа пожалуйста Там учти что мы его начали выполнять Запусти потом цепочку обратно если что не так та же самая ситуация только нам нужно обеспечивать на исполнителя транзакционность и самой операции и отправки сообщений и что не всегда тривиальные и требует отдельного набора паттернов Вот и при этом она всё равно остаётся ситуация что регистратор очень много на самом-то знает о нашей системе он имеет запускать компенсации он знает много таймаутов он должен быть тоже очень масштабируемый он как минимум должен уметь отправлять в непонятно куда в какие-то незнакомые э-э очереди какие-то сообщения То есть очередь в системе знать что мы нормально работать и гарантировать выполнение Тех самых работает это нормальная схема особенно она хорошо работает для простых линейных сценариев когда там 4-5 шагов и в общем-то компенсации не очень сложная Но работает можно сделать хореографию без регистратора Когда у нас на самом деле весь контекст придается прямо в сообщении то есть мы когда говорим сообщения Сразу говорю Какие шаги до этого были какие компенсации для них потребуются Сколько уже там тайм-аутов прошло и каждый исполнитель проверяет типа мы вообще дальше выполняем это операцию и нас уже пришли тайм-аут и нам надо опять и нам нужно откатывать всё тут своя сложность у нас сразу исполнитель становится сложной он должен уметь понимать этот контекст выполнять эти самые откаты запускать компенсации хотя бы отправлять какие-то события куда-нибудь Вот Но при этом мы избавляемся от единой точки отказа типа регистрации от единой точки сложности типа регистратора Ну и можно делать то же самое архистратор оркестрацию без регистратора когда адгистратор надежный все знает сценарий умный умеет восстанавливаться после падения и он сам знает сагу выполняет шаги при падении там когда он заново поднимается понимает что нас нужно запустить компенсацию её запускает минус в том что это сложная логика она требует весьма нетривиальной разработки не под все платформы есть технические решения которые позволяют такие вещи реализовывать небольшие и при этом всё равно она требует много ума и много сложности от того кто её реализует Ну в общем все бизнес транзакции во всех этих сценариях требует хорошо понимать а что произойдёт в случае отказа вообще при этом у Саги как у паттерна из некий набор существенных проблем во-первых нам в реальной жизни компенсации шагов не очень интересны во-первых они всегда возможны мы отправили там не знаю СМСку мы не можем откатить отправку СМСки и компенсировать ее Мы в каком-нибудь не двухфазном шлюзе отправили сообщение о переводе денег мы не можем откатить если мы вернем заплатим отрицательную сумму на основном дважды снимут комиссию это не откатываемый процесс не откатываем не компенсируемые шаги вот компенсировать при любой проблеме дорого зачастую нам интереснее попытаться добиться результата Ну да у нас там получилось ошибка о какой-то сервис не отвечает Давайте подождём попробуем ещё раз Зачем нам сразу откатываться или попробуем другим способом то есть мы пошли там не знаю проводить платёж через один шлюз это там через одного банк этот банк упал бы через другой Это не по компенсацию это другой альтернативный сценарий и компенсация как таковая обычно интересно они для конкретного шага а для бизнес-сценария целиком потому что самый популярный вариант компенсации это сообщить оператору что у нас проблема И на этом все закончится а дальше он как-нибудь сам почистит если у вас не 10 тысяч ошибок в день Это самый дешевая процесс компенсации но на актуален не для шага а для бизнес-процесса целиком поэтому я последние годы заметно больше сок люблю концепцию скорее вакфлоу То есть когда у нас оркестратор он умный надежное состояние не пытается компенсировать процесс по шагам он выполняет какой-то шаг сохраняет результаты выполнения берёт следующий шаг сохранится от выполнения при сбой он повторяет весь сценарий с самого начала вот при этом поскольку звучать шагов уже выполнен он их второй раз не выполняет просто подменяет на результат если шаги у нас повторяем Мы даже не до патент это легальные операции выполняет сценарий отмены и при этом любой сценарий там отмены компенсации Это точно такой же сценарий который то что это шагов которые тоже можно повторять откатывать и которых тоже есть свои сценарии отмены и в этом случае можем довольно сложно логику делать для этого подхода Я знаю сейчас три технических решений собственно cads который сделали человеческим лицом на Я уже года сделали но при этом поддерживает Чуть более широкий набор баз данных как хранилища всем знакомы реализации бпмэна Накануне на который если вас не очень высокие требования к нагрузке Это все можно делать Хотя проще всего иногда сделать собственно решение в виде библиотеки мы такое делали я про него там как раз поршень хайлоуди рассказывал Год назад где все это сделано как замечательно DSL на котлине делается прямо внутри вашего кода и работает очень прозрачно для разработчика то есть можете тоже посмотреть и пока по моему опыту минимальная сложность реализация сложных бизнес-сценариев получается именно при концепции архистратора не при концепции разнообразных реализаций Исаак Окей ну осталось у нас аналитика из проблем вот тут много замечательных проблем которым уже говорили Особенно с коллекционированием данных я могу сказать что я не знаю как решать эту проблему сейчас очень много популярных подходов типа дата мышь дата свам тогда-то Лейк Но все они очень трудоемкие очень сложные и скорее просто пытаются назвать проблему чем предложить качественные за проблема ее решения есть несколько отдельных микро паттернов типа Например если вам нужно делать на BF и выборки из разных сервисов и нужно иногда делать руками что-то типа джойно то стоит написать инструкцию для разработчиков Как именно какую стратегию обогащения данных выбирать зависимости от используемого сценария вот какие-то простые советы есть но реально нормального удобного решения не придумывается Итого у нас появилось вот четырехглавый такой дракончик четыре основные проблемы Если вы думаете что это всё разуме нет кроме этого есть проблемы с производительностью потому что микросервы добавляет в этой всегда с организацией мониторинга вагирования с безопасностью прекрасным нежным но любимая проблема Как определить обеспечить микросервис архитектуре с ограничения прав доступа это тоже по нему Можно говорить там часами Вот и при этом все равно ни к чему хорошему не прийти суммируя на самом деле все наши сказанное Если вы будете делать микросервиса то вас точно будут проблемы более вы это проблема на первоначальном этапе на старте вашего проекта для вас не будут очевидны потому что они находятся не столько в самих сервисах есть только в самой бизнес-логике сколько на связи разных кусочков в инфраструктуре и поэтому в классических топологиях Когда у вас ответственность за сервисы распределена по командам взаимоотношения сервисов ответственности нет ни у кого раз нет ответственности там точно будут проблемы которые будут возникать не будут иметь хорошего решения Не потому что вы глупые а потому что этих проблем просто вообще нету хороших решений это нормально и с этим надо жить приходится жить и Самое печальное никакие книжки не помогут не книжки не статьи не доклады не курсы потому что у всех свои собственные решения этих проблем и чужой опыт вам может быть интересен но никогда нельзя будет взять однозначно применить свои деятельности Поэтому всегда придётся много думать это очень большой плюс микро сервисов для разработчиков Хотя очень большой минус для бизнеса что с ними приходится думать это интересно можно делать много интересных докладов но проблема остаётся Ну и напомню что вчерашние лучшие практики завтра становится антипатерными и Я подозреваю что это микросервисом это тоже безусловно относится попался рассказы о том какие у вас проблемы Но это скорее в куарах вот оценки доклада и так далее Спасибо большое друзья Поднимите руки и получите микрофон У меня даже есть подарочек Повышаешь градус галерка тоже можно День добрый Константин Скажите пожалуйста вчера был доклад по поводу соединения микросервисов Монолит Как вы видите ситуацию На каких может быть свойствах показателях нужно балансировать между разделением на микросервисы и реализация монолитов все что я говорил про Зачем нужны микросервиса это как раз про задачу выделения микросервисов ваши предметной области То есть у вас всегда есть какой-то домен и дальше можно сначала там использовать контексты возможно имеет смысл в разных под системах реализовывать система дальше требования если есть компоненты с разными нафт значит их имеет смысл разделять разные микросервы с разной неопределенностью может быть имеет смысл Вот и дальше смотреть про основные проблемы Монолита то есть про архитектурный контроль если вам удаётся его обеспечивать то наверное можно пока не не требований к специфических функциональных хорошо оставаться каком-то частично монолите Если вы понимаете что вам не удается обеспечить контроль что у вас там сервис должен быть одновременно и производительным и надежным и соответствует требованиям Центробанка то возможно его пора бы уже поделить на несколько раз вообще по моему опыту основная Реальная причина выделения микросервов скорее nft вот а при внесении их в систему как бы до этого там на уровне это маркетинг хайп То есть вы тоже согласны с тем утверждением которое было вчера на первой лекции что архитекторы особо не нужны и нужно действовать по ситуации архитектор как раз те которые выстраивают ситуацию не нужны потому что всё это не должно это все Тролли и когда у вас любой разработчик говорит что надо бы делать какой-нибудь сервис делить на два он на самом деле надевает на себя шляпа архитектора Ну бывает что ситуация просто когда хлеб архитектор надевает человек там не с максимальным опытом а не так давно приехавший с конференции это скорее проблема вот этот просто отслеживать когда человек какие шляпы одевают и насколько он может за них отвечать архитектор нужен это вообще отдельная тема вот архитектор нужен скорее для выстраивания глобальных храмов вот вчера как раз очень хорошо говорили про архитектуру и структуру Вот и говорят про архитекту вы там говорили как раз про настраивание глобальных храмов в компании А как именно мы думаем о своей системе Вот и в этом случае архитектор архитекторы там неважно всегда нужны могут говорить о том что конечно архитектура коллективное дело но финальная ответственность висит на каком-то одном которое можно назвать как человек носящий я по главного архитектора Но это скорее особенность социальной динамики они реальности предметного гостя Благодарю Филипп Подскажите пожалуйста как вы думаете что будет в будущем то есть Мы перешли от Монолита к микросервисам Будет ли в будущем переход от микросервиса к чистым лямдам и функциям Я думаю что через какое-то время после перестанет думать в этих терминах что с одной стороны проще решать лямбдами есть задача которая проще решать небольшими сервисами в разных топологиях есть задача для монолитов и в любой нормальной системе будет сразу всё как сейчас в общем мы уже наверное не используем редко вспоминаем всякие споры по поводу того использовать длинную или короткую адресацию внутри ассамблерного кода Давно вы про это с кем-то спорили Ну вот уже не нужно многие подобные вещи то есть Может быть мы будем думать что выделениями консервисов автоматически как сейчас соответственно антипата вот а-а понимание какой именно размер сервиса тебе нужен в данном конкретном кусочке Ну вполне нормальная тема обсуждать двух видов и понять Как это сделать потому что будет какой-то набор базовых Практик поддержка в языках поддержку инфраструктуре это будет просто кому сувенир отдадим вопросики Молодец хорошо Добрый день спасибо за доклад У меня вопрос про нейминг вот когда вы отошли от каких-то специфических названий к точным не возникло ли у вас проблема что чтобы дать Точное название оно становится длинным как иногда название там класса из трех-четырех пяти слов боролись вы как-то с этим или Да пусть будет 5 слов никому не мешает вопрос какие-то пять слов если это 4 прилагательных одна существительное то нормально если это Пять существительных через запятую это проблема Спасибо Да здравствуйте вопрос Спасибо за прекрасный доклад абсолютно профессорского уровня именно с этим связан вопрос очень похоже что это академические подходы какие-то прямо университетские но судя по уверенности ваших ответов на вопросы за этим стоит еще много практики можете рассказать буквально в двух словах про пару практических задач Где вы решали таким способом проблемы на самом деле никаких способов ты не описывал как всегда в моих докладах нигде нет конкретных рекомендаций рекомендации всегда врут понятно что все из этого там вот методов работы со сложностью каждый день их используем мы выделяем контекст контекст выделяются стандартами практическая она там мы рисуем событие смотрим Какие события на Какие сервисы прилетают группируем их это вообще говоря как раз в отделение под системы системы дальше мы пытаемся эти Баунти контекста как-то назвать потому что понимать какая у них ответственность какую часть наши предметной области они обеспечивают реализуют это про наинг дальше мы пытаемся там не знаю понять какие не функциональные требования там возникают это нормальная работа любого архитектора-аналитика базовая там тут нагрузка высокая тут низкая вот тут Нам действительно требуется там реализация pcss Поэтому нужно будет аудит на каждую строчку хода поэтому это кусочек изолируем и будем делать в отдельном сервисе а весь остальной наш код который занимается там не знаю продажами будет совершенно независимой потому что и мы бы менять Там не обращаясь к аудитору Вот это всё абсолютно практически простые вещи Ну в повседневной действительно Я старался в этом докладе делать только очень повседневные вещи выбор того как именно делать оркестрацию Ну ты приходится в каждом большом проекте делать опять с нуля пытаться просто понять какая есть какие языки Какие реализации решения есть на этом языке как есть ресурсы Ну вот потому что не всегда есть возможность найти готовы сеньора и чтобы он там три месяца реализовывал собственный архистратор там на котлине как мы смогли это сделать но у нас там был некоторый набор требований мы делали коробочку для большого бизнеса и мы не могли говорить типа Постав Всем нашим знакомым клиентам поставьте себе темпуром они все хотят типа ну вот вы сами все поставьте сами отвечаете Поэтому нам выгодно было делать свое решение кому-то другому там если вас собственное решение поставьте там пару не паритесь вот очень много разных тонкостей поэтому он так довольно про много разного опыта пытался собрать Поэтому иногда кажется что на абстрактный реально там каждый пункт очень конкретный Может в кулах по любой из них поговорить на конкретном примере приходить своими проблемами подумаем как исходя из всего сказанного про них можно подумать пожалуйста еще Сергей компании ervision Филипп Спасибо большое за доклад очень интересно у вас был интересный слайд на котором было написано оркестратор не Сага я хотел вас попросить уточнить А где вот собственно грань между Сага и не ОСАГО только ли это в части компенсации каждого шага или всей бизнес-транзакции именно в подходе чтобы это не сагов смысла это Разумеется остаётся Сага В смысле малины вот В смысле малины всё чтобы делаем Это Саги там другого ничего нету По хорошему Вот то есть это именно про то что мы не пытаемся думать про бизнес транзакцию как про маленькие космическое большое количество независимых красавчиков начинаем думать по неё целиком это такое скорее цитата который приводит к изменению технологического решения ещё вопрос Да спасибо за доклад то у меня такой вопрос касательно микросервисов Мы собрались на конференции highload и вопрос связан с тем Существует ли рекомендации по какому-то минимальному функционалу микросервисов я поясню к чему вопрос С одной стороны Неплохо бы вообще все все задачи разбить на микросервисы но в этом случае само количество микросервисов и связей между ними как вот там большом графе будет просаживать производительность само по себе и может быть стоит делать микросервисы которые допустим Один микросервис одно но да В противном случае если у тебя 50 микросервисов на одной ноге то они А если они ещё на соседних тотах Они между собой столько будут коммуницировать что ни о каком хэйловоде уже речь не пойдёт специальность вот поизучать эту тему связано с прото как выделять кусочки То есть если у вас много тесно связанных микросервисов вы не получаете никакого выигрыша от того что у вас микросервисы в среднем то есть они должны быть не слишком сильно связаны и сильно зацеплены после этого добиться и тогда станет гораздо проще с производительностью Ну да иногда имеет смысл взять и несколько микросервисов вроде бы даже не очень связанных объединить в Один потому что у них много довольно много напряженной коммуникаций друг с другом и хочется ее там не значить память гонять нормально а может быть использовании протокола которые например эффективнее обмен через память внутри ноды взаимодействие какое-то совсем странное Но это зависит опять конкретного проекта то есть вот абстракта не могу сказать что есть вот универсальное решение делать ими красивый с Ровно в 98 строчек и будет вам счастье не возьмусь Спасибо поговорим финальный вопрос Спасибо большое за доклад А вы в докладе обозначали проблему канареечного диплоя при асинхронном взаимодействии микросервисов а Поделитесь пожалуйста опытом Как вы ее решали потому что все решения которые есть у нас выглядят максимально ректально потому что они все к сожалению такие есть пока мне везет и мне удавалось просто делать очень много партиций очень много контейнеров и в процессе диплоид просто указывать конкретному там к наречному микросервису что он сидит на там обычно у него там нормально 50 например партийцы размечена и 50 консинтеров А у него только один То есть тогда на него попадает только очень маленький процент делать на топиках на кавке интеллектуальной канарейку с тегированием входящих запросов например там не знаю Новый сервис обрабатывает сообщение только по тестам Я такого пока к счастью не делал вот я несколько раз пытался думал думал и уходил от этой задачи гречал что её решать дороже чем плюсы которые она даст Вот потому что это не знаю красивого решения я знаю несколько проектов где перед действительно перекладывались топиков в топе где есть базовые топик там сообщениями есть специальный тестовый топики для канарейки и хитрый роутер транзакционный Кафки берёт перекладывается с одного в другой в зависимости от текущих правил но это не самое дешёвое или не самая простое в поддержке решение Я вообще поэтому люблю оркестрацию они хореографии в регистрации в среднем всё гораздо проще в том числе с манипулированием подобными вещами и сейчас в общем-то использование той же Кафки как транспорта не так осмысленно Потому что много технических решений обеспечения достаточно надёжной доставки внутри бизнес-транзакции поэтому я просто потихонечку уменьшаю количество очередей в своей жизни Филипп ты хочешь фото с полным залом ребята помашите ручками пожалуйста Спасибо вам огромное Вот это комплимент спикеру Ну что кому так наставник больше понравились первый вопрос вот молодой человек Да собственно получается две штуки Наша компания год назад делала концерт Борис Гребенщикова корпоративный у нас некий набор уникального мягче а именно футболочек аквариумных и книжки класс"
}