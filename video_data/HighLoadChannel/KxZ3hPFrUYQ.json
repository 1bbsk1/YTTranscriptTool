{
  "video_id": "KxZ3hPFrUYQ",
  "channel": "HighLoadChannel",
  "title": "Быстро — не всегда хорошо: рейтлимиты в мультикластерном окружении / Дм. Виноградов (Wildberries)",
  "views": 258,
  "duration": 2673,
  "published": "2025-01-17T02:29:14-08:00",
  "text": "Всем привет Спасибо за Аплодисменты сразу хочу попросить прощения я немножко волнуюсь когда выступаю перед большой аудиторией поэтому первую минутку я возможно буду немножко нескладно говорить пожалуйста Не обращайте внимания Итак тема нашего сегодняшнего доклада - это Рей лимиты в мультиклаб ре лимиты это способ защитить наш хрупкий наш нежный бкд от большого количества запросов которые приходят на него из вне причём запросы бывают добросовестные предм селер превысил установленный ему лимит бывают недобросовестные когда идёт какой-нибудь ДС и вот ВС вот это вот от всего этого нам надо прикрыть наши базы наши брокеры всю нашу эту инфраструктуру чтобы она не развалилась Казалось бы задачам нормально чей пятый не пропускаем до свидания Да пока не истк период мира но мы будем стараться решить сегодня эту задачу не просто в вакууме А в контексте Когда у нас много дата-центров на много дата-центров там всякие куберы крутятся кластеры в них поды всё вот это Крутится вертится и естественно сетевая связанность между всеми этими компонентами когда-то хорошая когда-то не очень хорошая восст я возглавляю команду публичного а до этого я полжизни 18 лет пахал как волк Шнайдер электрик компания занимающаяся Промышленной автоматизацией аэропорты газпромовские перекачивающие станции вот всё это мы занимались автоматизацией учётом оптимизации электроснабжения ресурсо снабжения всего всего этого писали ВС начиная с програм программировали после четырнадцатого года когда пошёл тренд на локализацию переписывали всё А здесь локально м Window совские клиент-серверных Саз системы вот когда у нас клиент Когда у нас целевая аудитория - это владельцы бизнеса аналитики эти все ребята любят чтобы картинка была вот очень красивай А где у нас красивые картинки они у нас красивые на вебе поэтому хочешь не хочешь всегда приходишь к тонкому клиенту Итак о чём мы сегодня поговорим поговорим о лимитах о лимите в контексте экосистемы wildb Ну я думаю представлять саму компанию никому не нужно все про неё слышали все на ней наверняка что-то покупали Кто ещё не купил имеет возможность такую Но что важно на этом слайде вот там цифры Много заказов очень много заказов очень много площадей очень много селлеров вы их можете сами прочесть я их Конечно не буду зачитывать тут смысл и посыл весь в чём мы в разных странах вот Россия Беларусь Казахстан Узбекистан в Китае сейчас есть для селлеров часть и всё это значит что когда у вас много клиентов и они геора вам нужно стараться быть ближе к каждому и для вас в принципе одинаково важен опыт там селлера который находится в Москве во Владике в Китае в Киргизии в Армении Неважно где начинаете геора спредер поближе к селлера cdn раз статику а дальше уже начинаете к ним поближе двигать саму опиш про которую мы сегодня и поговорим Вот это первое второе - это конечно же у ВБ очень большие объёмы продаж А где большие объёмы продаж там высокая стоимость ошибки чуть-чуть накосячил прилёг на минутку отдохнуть Лови там 10 млн я с потолка взял сумму но сумма довольно большая упущенные выгоды причём это часто бывает как прямые убытки представим у селлера что-то не продаётся там он не может обновить остатки цены поймать заказ это репутационные естественные на доходах Компани и нервах всех вплоть до разработчиков что ж определились Давайте подумаем теперь что такое А в контексте кто вообще его использует какая у нас вообще целевая аудитория ошка это один из трх Я бы есть опиш везде более-менее одинаковый функционал где-то чуть-чуть Больше где-то чуть-чуть Меньше но в целом Функция управления доступны везде конечно же а популярна среди крупных продавцов ну вы представляете у вас там огромный выбор номенклатур очень быстро меняются цены остатки вы там в акции в эти заходите из этих выходите и так далее а тут ручным трудом не обойтись Да как бы Когда начинаешь вручную всем этим управлять это и долго и муторно и естественно вероятность ошибки довольно высокая вот эти ребята очень любят пилить сами ции но есть ещ и маленькие продавцы и они тоже и они тоже любят пользоваться А конечно же у них у всех нет своих собственных программистов системных аналитиков Да там условно говоря если я шью носочки продаю их наб Но откуда мне программисты И зачем главное брать они просто берут готовые плагины у них там может быть Оска там плагин под неё мой склад Ещё что-то ещё что-то то есть пользуются уже готовыми продуктами разработанными другими программистами вся ошка поде 12 категорий на самом деле цифра не суть важна там 10 12 15 это всё разные а разные бизнес категории То есть вы когда управляете магазином У вас есть каталог У вас есть цены маркетинг отчёты Финч всё всё всё всё всё вот это вот и всё оно бьётся примерно на 12 категорий сейчас завтра их будет 13 послезавтра 14 Не суть важно что важно важно что у всех этих категорий свои бизнес-требования Ко пишки Вот мы сейчас постараемся рассмотреть Рей лимите именно в контексте каждой Да как правильно как правильно сделать й лимитер как мы сделали Рей лимитер мы будем смотреть на это именно через призму конкретных требований у конкретной категории управления пихоя перед нами ставит бизнес их очень немного Их всего три Ну естественно это Надёжность это безапелляционно требование тут нечего добавить Да всё должно работать если оно не работает у всех всё болит там болит бонус болят нервы всё болит все части тела со следующими требованиями с ними поинтереснее скорость работы Ну вот на самом деле скорость работы - это всё про высокий РПС про низкие задержки мы всё же говорим про кабинет продавца вот кабинет продавца - это не кабинет покупателя там меньше целевая аудитория и там всё-таки не такие Заоблачные ПС как на покупательской части сайта но всё же есть более требовательные есть менее требовательны Давайте возм пример Если вы недостаточно быстро будете синхронизировать остатки крупный продавец вас остатки на складах вы продаёте их на ВБ Не дай Бог на Озоне ещё у вас есть офлайн шопы и вот между всеми ними вы эти остатки синхронизируйте Вдруг вы п продали последний товар в оффлайн магазине остаток ноль в ВБ Вы ещё об этом не уведомили ВБ думает что остатки есть ловит на них заказ отправляют вам и такие сорян Ребята да товара нету Вот это называется заказ на нулевой остаток то есть ВБ думаете что у вас есть товар у вас его нет и как бы покупатель недоволен потому что у него не получилось купить выб недовольны что покупателя не недоволен потому что заказ при отменять вот тут важна скорость работы скорость синхронизации А есть методы у которых важна точность работы Ну давайте возьмём вот Какие тут тут мы делим всё на дорогие дешёвые на самом деле запросы есть Запрос который стоит недорого с точки зрения вычислительных мощностей Ну там посмотреть наименование вашего товара Да это недорого а е представим загрузить Отт за 3 меся продажах это дорого если в первом мру уйдя за лимиты ничего особо не потеряем никто даже не заметит то во втором случае можно Ну получить серьёзный афект это может сильно за аффект наш наша база данных да А мы это всё не любим это начинает всё пятисот перестаёт работать и как мы уже выяснили у всех начинает всё болеть что ж рассмотрели требования Давайте теперь взглянем такой bir viw вообще Как устроена архитектура А чтобы понимать где вообще там лимит места это очень поверхностная картинка ну выглядит Всё наверное как и у всех есть какой-то актор человек чаще машину кто посылает запросы всё это пройдя какие-то там Верхне уровневые слои атмосферы попадает на балансировщик L7 Application Load balancer у нас дн стоит вот который парень простой он берёт это всё там по какой-то политике Round Robin там что угодно list Connection раскидывает по разным дата центрам по разным кластерам кубера Вот и запрос в какой-то момент прилетает А тут его хоп ждёт уже сервис аутентификации А ofc это вот основной сервис мы на всех следующих слайдах как раз на НМ будем основное внимание застрять в принципе он осуществляет аутентификацию немножко авторизации работает предельно просто вообще всё что мы делаем на самом дельно просто прилетел запрос взяли из заголовка авторизационный это шка ничего серьёзного Да проверили подпись проверили взяли из поняли от кого запрос проверили всё всё хорошо прено В добрый пр отправляем запрос дальне уже там все вот эти 12 категорий что-то плохо назад что ж Давайте посмотрим где здесь реализован лимитер первое первый лимитер стоит наверху но Мы помним из предыдущего слайда что НС понятия не имеет чей запрос Да у него есть IP адрес у него есть джвш не проверенная он не знает что это за селлер он не доверяет поэтому он может оперировать только IP адресом Конечно же это DDoS атаки то есть когда начинается какой-то массовый вал запросов из каких-то подсекция Да чухча селлер он не программист и когда он начинает что-то писать иногда получается не сразу хорошо вот мы написали запрос вот он не отработал Ну что почему бы его ещё раз не попробовать да Ну давайте это Вт и получаем сразу десятки от одного селлера вот это может обрубить сразу то есть видим резкий рост рубим хорошо прошли дошли до аутентификатора тут шека Всё проверили мы знаем селлера мы доверяем се ID конечно же здесь уже есть Самый классический лимитер к нему вернёмся позже Но помимо всего прочего здесь же мы реализуем называемые Тае поменьше у кого-то больше номенклатура у кого-то меньше остатков много мало И на самом деле Всем им нужны разные лимы Да какому-нибудь огромному магазину чтобы синхронизировать остатки по всем своим складам нужно 100 запросов небольшому ишни который счёт носочки ему там и трх достаточно Вот соответственно информация о том У какого селлера Там какой тариф Премиум не Премиум всё это доезжает вми устанавливает по какието уставки допустимые пороги и их обрабатывает корем обм ке функционала вот меня сейчас закидают из зала Но всё-таки на самом деле мы стараемся Везде где можем соблюдать обратную совместимость нашей опиш То есть когда мы делаем V3 какое-то время доступно V2 и так далее будем честны Да не всегда получается Но стараемся Как же это работает сделали что-то обратно несовместимое была V3 написали V4 вывалились То Сё пятое десятое праздник а что видим дальше никто никуда переключаться не будет Ну вот прямо единицы в лучшем случае все будут сидеть на V4 Что можно сделать можно взять там дать пи 2 недели и рубать что мы получим мы получим просто тотальный у всех кто работал по апе если это какая-то Чувствительная для продаж категория Ну прямо продаже хорошо просят Что можно сделать Ну можно сделать такой финту ушами и начинается потихонечку каждый день по чуть-чуть сжиматься лимит ися 9080 каждый день поменьше поменьше поменьше И большинство на это какой-то момент обращает внимание что у них что-то стаёт хуже работать начинает хуже работать и переходит на новую версию вот удивительно простое решение и прямо вот опробовали очень нам понравилось Ок нашли Лим Давайте определимся с техническими требованиями к клиенту во-первых Что такое клиент Лима Ну клиент ли это просто тот код та Гош библиотека которая заезжает на каждый сервис аутентификации и помогает ему правильно посчитать можно нельзя пропускать запрос вниз У нас требований пять они довольно простые первые - это неизменный интерфейс неизменный контракт А через аутентификатор проходит фактически весь трафик Да их много этих сервисов Да всё там изолировано разные категории друг от друга но всё равно мы очень не любим ре деплоить лишний раз вот поэтому Чем меньше нам нужно кодить каждый раз когда мы что-то меняем в северной части тем лучше простота конфигурирования тут тоже я думаю Понятно Мы любим всё конфигурировать где-то через админки не любим всё это делать через Вары на следующих слайдах хочуть поподробнее расскажу группировка методов корзины - это про то что на самом деле не всегда а 100% проек проецируется на бизнес-функции У вас есть бизнес задача скачать отчёт А есть отчёт CSV XLS там J ещё какой-то это надо всё считать общим общей корзиной фбк фбк Мы недавно выяснили что у нас Надёжность номер один вот поэтому чем сложнее лимитер мы проектируем чем больше кода мы пишем тем чаще всё это отваливается не всегда даже по прямой вине программиста не ловили Поэтому всегда должна быть какая резервная схема и поддержка заголовка ответа чуть попозже расскажу чтобы клиенты могли автоматически подстроиться под наши лимите что ж интерфейс я кратко пробежался на самом деле здесь мы Америку не открыли фактически библиотека представляет собой обычную реализацию интерфейса с точки зрения клиента это простейший вызов как хотите егова это категория А метод это какой метод а он хочет вызвать интерфейс клиентская часть она Просто говорит я селлер номер один Я хочу обратиться в а каталога и вызвать метод там установки новой картинки для карточки товара всё он больше ничего не знает про группировки ничего ничего ничего вот ему известно только это а в ответ всегда тоже он ответ очень простой Да нет можно нельзя Если да Сколько ещё можно если нет когда можно будет вернуться простота конфигурирования хочется чтобы во-первых не было перезапуска перезапуске это всегда боли они не всегда бывают успешны даже если изначально казалось что он должен быть успешным Да и мы ничего не меняли минимизация зависимости на клиенте Вроде бы мы конфигурации хотим с него убрать но при этом мы не хотим тянуть какие-то дополнительные связи на клиента например куда-то в админку в баску чтобы он ходил нет клиент должен быть максимально простой у него должен быть какой-то источник Правды там счётчик куда он за ним ходит всё остальное его не должно интересовать и работоспособность при сетевых отказах тут имеется в виду что Да действительно бывает что-то отказывает в этот момент весь софт всегда должен не только работать но и правильно стартовать то есть должны быть какие-то захард кожанные лимиты прямо в клиенте чтобы даже если база прилегла вдруг что случилось мы всегда могли поднять а группировка методов чуть-чуть Про неё рассказывал в принципе сильно добавить и нечего есть бизнес функция есть куча методов которые её так или иначе реализует скачать так скачать сяк установить картинку через загруженный файл установить картинку по ссылке это на самом деле один и тот же метод имы хотим прозрачно Для клиента объединять их в общие какие-то бакеты общей счётчик на сервере Да что-то Одно сломалось переходим на схему которая попроще но понадёжнее вот да у нас мы допускаем какую-то деградацию функционала но хотелось бы избежать полного отказа в обслуживании и с заголовками всем домен всяке на селлера вот селлер Вася 100 rps выдано и такой селлер Вася берёт и выписывает два токена это отдаёт одному сервису этот другому это в 1S Это мой склад вот и получается что на самом деле rps написано 100 а 1S и мой склад видит по 50 Вот и таких кейсов очень много поэтому очевидно что клиенты должны каким-то образом сразу подстраиваться они должны видеть что можно что нельзя Сколько ещё остаётся потому что в проти на случай начинается 429 429 - Это Че - это то на что очень смотрит наши антифрод команды и вообще их хорошо когда их фон держится Ну на достаточно низком уровне прекрасно мы рассмотрели требования с точки зрения клиента давайте теперь подумаем как это можно реализовать на сервере Ну начнём будем двигаться от простого к сложному и самая простая схема Я думаю что все когда-то с неё начинали мы её назвали изолированной in Memory как угодно Тут даже рассказывать Нечего никаких внешних связей Ничего просто совсем ничего У вас есть ВМ есть шка которая просто считает вот прил запрос посмотрели прямо внутри себя можно нельзя увеличили счётчик если можно там оставили если нельзя пропустили ниже прекрасная схема супер надёжная Почему надёжная ломаться нечем нет внешних связей простая нет никаких дополнительных компонент Ну естественно у неё есть колоссальные недостатки если она такая вся из себя изолирована от всего остального У неё очень низкая точность она прямо Нако низкая Что не можно не говорить сечас у вас две реплики вы хотеть в Каждую из них сказали Ну хорошо здесь 50 здесь 50 надежда на то что трафик сверху при робине при лист Кокше при каких-то других политиках разольётся вам равномерно на эти поды мы чуть-чуть надеялись но нет абсолютно неравномерно не стоит у вас будет полный перекос А тут ещё флуктуация ночью селлеров меньше днём селлеров больше включаем горизонтальный подов то больше то меньше И точность пр с ша то есть схема хороша схема быстрая с точки зрения точности абсолютно неуместная по характеристикам получилась у нас у неё Ну то есть задержка которая дополнительно эту схема вносит 200-300 наносекунд Очень низкая очень хорошая но скажу сразу бутылочное горлышко у нас было это мьютексы то есть Сначала мы сделали одну хш маку на всех селлеров а потом оказалось что через каждый под несколько десятков тысяч Серов ходит у на лю ло ри дивали по раскидали на 16 внутренних МАПО получили 20000 до этого было раз в 10 больше Где используется схема схема может использоваться где как основная там где Ну прямо колоссальные требования к высокопроизводительное требования к точности Мы же используем в качестве схемы для всех остальных есть база кото пори чтото отказывает переходим нарака супер с изолированной разобрались она нам не подходит Очень низкая точность переходим к классике жанра Да мы знаем что там сечас политика поменялась сейчас там уже или не помню разные форки пошли Вот но суть одна и та же вы берёте этот кэш и наружу его из сервисов выносите прин Независимо где-то на вирту висит соответственно клиент когда-то попадает в свой дис когда-то попадает в который физически расположен на другом дата-центре там хеширование могу соврать вот Обычный рин клиент запускается клиент смотрит ле выбирает на какую рду Реди ему пойти в неё идёт считает всё тоже самое только вынес конси фактически стало централизованное обновление про это поподробнее рядом с редисом админка Неважно как она сделана на чём где важно что это какой-то интерфейс в котором задаются пределы объединяются методы в корзинке селлера указывается там где Премиум где не Премиум и всё вот это вот из админки раз там в какой-то там в 10 минут например в 5 минут неважно раскидывает по редиса Почему раскидывает Потому что опять-таки мы на клиентах не хотим ходить никуда кроме редиса о должен быть один источник в него сходили посчитали вернулись вот поэтому у нас есть админка и синхронизирующий и синхронизирующий процесс супер в редис пришлось запихнуть лу потому что логика проверки была чуть сложнее чем хотелось бы тут тариф учти банный или Не банный в какую корзинку это всё попадает в общем написали скрипт всё супер С какими проблемами столкнулись Ну это конечно стало существенно медленнее мы на следующем слайде увидим н пришлось писать ло скрипт А у нас не было ло программиста Да пришлось шников заставлять И самое главное с чем на что мы наткнулись причём заранее не предвидели прогрев редиса что это такое у нас редис ринг у нас шарды там 10 завтра 12 после завтра 20 этих ресов какой-то упал какой-то поднялся В общем они меняются и в какой-то момент редис входит вводится строй и он пусто он атно в ничего в него прие конгу а клиент в него уже хочет попасть тут есть конечно же вариант Можно просто клиента отбивать у клиента будет там либо пятисотка либо нужно будет что-то на нём Гать чтобы он шл соседний либо второй вариант мы придумали менять пароль ди стартует с паролем неизвестным клиенту клиент к него просто не может подключиться он его тупо не видит А вот админка знает этот пароль и когда у админки срабатывает е крон который раскидывает конфигурации он с параметров дис пароль меняет на тот который клиент знает клиент такой Опаньки могу и подключается что видим примерно у нас получилась 01 миллисекунда задержки когда клиент находит в своём дата центре и полторы в разных в принципе Вполне себе хорошие показатели вот да они на несколько порядков выше чем у но тем не менее они вполне уместны для большинства категории где не требуется совсем высокий rps сейчас мы откаты эту схему только на одной категории набиваем шишки на опечатать с покупателями Окей подумали мы Ну у не вро текстовый протокол А есть такая штука проба называется мы наверное сейчас возьмём и напишем свой редис он будет намного быстрее написали Давайте посмотрим что получилось назвали это Go Неважно как обычная Гош шка крутится отдельно наружу Тор ли по jpc уре запрос ответ можно можно можно нельзя при этом эти лимите мы уже раскидали по дата центром то есть не стали их делать в какой-то общий пул Крос дата-центров ский а в каждом дата-центре подняли эти лимите между ними запустили jpc Stream Что это значит нам естественно нужно чтобы учитывались остатки из разных дата-центров когда мы считаем поэтому каждый лимитер когда через себя что-то пропускает отправляет во всех смежники счётчик на один вот такой поток между ними всеми фактически синхронизирует остатки уже нет Да уже появись но как Мы помним зависи категорий где-то там уместно где-то Нет давайте посмотрим что же мы увидели с точки зрения показателей А мы увидели 03 миллисекунды 1 миллисекунд в разных дата центрах напомню в редисе эти показатели были лучше но порядок тот же самый мы были удив получились Даже хуже от того что мы тестировали изначально на сообщениях в 100 байт а фактически на проди они оказались поменьше то есть более-менее выровнял там прото баф с редисом но тем не менее никакого серьёзного улучшения мы не увидели но но мы померили поток пропускную способность потока grpc Stream между разными лимите в разных дата-центра вот у нас получилось 300.000 ПС сразу забегая вперёд это слево перекрывает любую из наших категорий помним что мы говорим сечас проле а не покупатели Да там не такие высокие ы Ну конечно да вроде бы провал но не совсем и мы родили мутанта мы придумали новую схему мы вот верхний видите красный квадратик мы взяли и заменили там на стт са потоковый прой это вот мы его сделали для синхронизации между и родным для него ближайшим для него лимитером что мы получили внутри каждого опять-таки наша любимая с первой самой схемы шка он считает ВС а параллель него крутится простенькая гонка Она читает входящий поток сообщений и остатки обновляет чтобы видно было наком из соседей двойной Стрим чи показатели чуть-чуть уступает Почему Потому что фактически у нас теперь помимо собственного трафика в шма у нас ещ появилась дополнительная тинка которая постоянно читает входящий поток сообщений и обновляет остатки в нашей внутренней хш мапке этом 4Е микросекунда для любой из наших бизне категорий а напомню наша одна из Ну важных задач была реализовать лимитер так чтобы он по минимуму за афек то есть минимальные дополнительные издержки внс в основную опиш которую реализует Ок плавно к выводам в итоге мы поиграли с четырьмя схемами изолированный и при точени с на самом деле нет какого-то единого правильного для всех решения и везде какой-то везде какая-то схема более уместна какая это менее уместно где-то важнее точность где-то важна скорость работы изолированная схема с её колоссальной скоростью работы в 30 на на секунд мы её оставили как фолк для всех что бы где не развалилось любая другая схема любая другая интерпретация переходит на изолированную потерялся редис полностью представим Да там сеть упала всё бывало Да у нас между оптику рубили и так далее прекрасно переходим на inem и сидим на ней пока связь не восстановится дис всё отлично единственное неудобство при централизованной конфигурации пришлось делать прогрев во всём прочем схема получилась крайне простая довольно высокая производительность cons grpc Ну можно считать воспринимать это как временный эксперимент попробовали посмотрели гипотеза что проба вот прямо так с налёту окажется быстрее чем дис не подтвердилось и мы воспринимаем просто как промежуточной Шаг к jpc стриминга Ну и стриминг Очень низкая задержка относительно высокая точность сейчас пилотируемых самых высоких самых требовательных категориях на этом я закончу Всем спасибо за внимание Вот с удовольствием послушаю ваши вопросы Спасибо большое за доклад Я бы сейчас рейд лимит на ветер наложила а то он как-то очень часто во время твоего доклада бушевал для того чтобы задать вопрос поднимите пожалуйста руку мы к вам подойдём с микрофоном ваш вопрос можно будет задать в микрофон и необходимо будет держать микрофон у своего рта говорить чётко Ясно громко Если вы нас смотрите онлайн или не хотите задавать вопросы в микрофон задавайте их пожалуйста в чат я их зачитаю со сцены и вы тоже получите на них ответ Ну а теперь вопросы Давайте подойдём например вот сюда Привет Дим Спасибо огромное за доклад конкретные чёткие доклады про технику Это круто Вот и в реализации есть jpc стриминг из какого-то Центрального сервиса в сервис клиента С каким битрейтом он идт там не забьём ли мы нашим стрин канал благодаря тому что R limit работает на соседнем сервисе я вот с сожалением признаю я чуть-чуть не услышал вопрос У меня не очень хорошее слу если можно пожалуйста погромче почёт я прошу прощения есть grpc Stream из сервиса Рей Литера в сервис outs C Да всё верно в этом стриме идут какие-то ивенты о том что смотри вот где-то ещё лимит съели на соседях да С каким битрейтом идут эти ивенты и как бы как вы защищаете от того что они будут слишком большим битрейтом ити завалят ан потому что в соседа пришли я понял вопрос там максимальная пропускная способность 300.000 которую мы ещё далеко не выбрали но тем не менее конечно всегда есть риск что мы можем заспамить поэтому защищаемся мы таким образом койт из неё переполняется просто внутренний буфер То есть все входящие вот эти вот как их декремента от соседних сервисов они просто падают во входной буфер если этот буфер если этот канал а там канал фактически шный переполняется у него дай Бог там может быть 10 может 20.000 событий то просто новые события начинают от А отбрасывать из минусов Да абсолютно точно в случае если бы этот канал переполнилась Мы конечно же потеряли точность мы перестали бы учитывать что о пишка дёргается на смежных сервисах при этом естественно вот Кати и текущий размер этого канала он монитори есть алерты и пока мы ещё ни разу этого не получали эту ситуацию Когда получим будем думать почему так произошло либо это надо чинить с точки зрения сервиса либо что-то просто где-то пошло не так и нужно докапываться до до первых причин пока такого вот не было спасибо большое Если ещё вопросы в зале тяните руку слева вопрос в зале Если можно погромче пожалуйста э Дмитрий Спасибо за доклад э Такой вопрос э вот первая схема когда всё в памяти там из-за балансировки в шифте могут быть совершенно ужасные отклонения по нагрузке и соответственно всё очень неточно Как вы говорили А вот в последних схемах оценочно Какое может быть отклонение там же тоже не ну не СН consistency да то есть как бы Сколько сколько закладывать на вот если в первой схеме с изолированной там отклонения просто кратные причём по часто трёхкратные пятикратное то в последних я вот честно скажу Мы ещё не померили Да Сколько сколько оно там получается фактически оно всё обусловлено временем прохождения то есть Сколько нужно событий чтобы пройти представим от лимите расположенного в одном дата-центре до лимите расположенного в другом дата-центре чтобы тот его учёл вот с учётом 300.000 rps вот нужно пропустить это Соти по-хорошему туда и обратно и померить вот половину от этого времени которое прошло Вот за это время мы можем на пропускать лишнего измеряли нет будем будем пытаться да сказать почему мы ещё не придумали Как точно это сделать если честно Спасибо большое Давайте дадим возможность задать вопросы например Сначала с правой половины а потом перейдём на центр Привет Спасибо за доклад у меня возник когнитивный динан в начале описывал задачу что нужно защитить серверные ресурсы там базы данных всё что можно Ну завалить запросами и по-хорошему нужно лимитировать там на той стороне чтобы дорогостоящее что-то вычислительное было защищено И постепенно перешли к задаче лимитирование там per запрос как это произошло Ну вот постараюсь ответить вот насколько понял запрос Да внизу у нас бизнес логика бизнес логика там всегда какие-то персистентные сервисы неважно база брокеры всё что угодно вот и Наша задача по сути дела Вот Чем раньше мы запрос отбросим вот Чем меньше мы дадим ему путешествовать по нашей инфраструктуре тем Для нас это лучше Поэтому если мы можем на каких-то более ранних стадиях например на жинси или на сервисе аутентификации уже понять что лимит превышен то зачем его пропускать в бизнес логику и считать его там Пусть он не бегает по нашей инфраструктуре Пусть он не отъедается наши сетевые ресурсы или я неправильно понял вопрос то есть на сам конечно же сами лимиты сами пороги они приходят от бизнес команд то есть есть команда занимающаяся условным каталогом она знает сколько их база выдерживает сколько они могут выдержать общий rps общий и им не столь важно Вот откуда к ним пришёл запрос даже с вебки пришёл запрос из апе он пришёл из какого дата-центра он пришёл вот у них есть общий rps и они его в админке устанавливают он из админки доезжает во все Конфигураторы и проверяется на верхних этапах то есть до них уже вот излишки эти не доходят идея такая если что-то неправильно ответил То уточните можно будет дальше обсудить это если что в дискуссионной зоне Напоминаю что если вы не сможете задать вопрос можно будет пройти в дискуссионную зону она находится слева от входа и там лично пообщаться с докладчиком и собственно задать те вопросы которые не получилось задать на сессии а Давайте следующий вопрос Мы перейдём в левую потом в центр и так вот будем ходить из левой половины зала громко громко хорошо такой такой вопрос вы не думали использовать вместо фулка какую-то схему деградации чтобы не сваливать сразу в худший вариант а проходиться по скажем так сначала чуть хуже чуть хуже и потом уже использовать Я думаю мы не хотели слишком уж мы говорим про фол Беки на самом деле он ещё ни разу не отказывал Вот то есть да мы это имеем в виду но пока тьфу-тьфу-тьфу вот поэтому вот делать чейни такой представим тут деградация тут фулбэк тут следующий фулбэк вроде бы пока выглядит излишним просто вот основываясь на исторических данных Да вот пара раз была а ну некоторые вещи не приятные происходили переключение на лбк оно было кратковременным и оно Решало эту проблему то есть конечно же там не те лимиты которые были в последний раз с конф в админке там сильно ужа то есть аварийный режим просто аварийный режим система она продолжает работать у всех всё в принципе работает но не очень быстро вот база восстановилась всё поднялось вернулись Поэтому вот именно деградации Нет не рассматривали Спасибо большое вопрос по центру зала Здравствуйте спасибо за доклад Скажите несколько маленьких вопросов Вот вы говорили про Рим про 300000 способность Всё верно какая А вот ваш ваш запрос на самом деле очень похож на вопрос вашего коллеги задно из того конца зала вот мы не смогли её пока померить Ну со го от этого зависит точность То есть если большая Даже при большой способности это алгоритм который позволяет очень большие пики дать а соответственно второй небольшой вопрос А у вас используется Ну какая скорее всего вариация Бакета я вот хотел избежать этой высшей математики тон баткин Бат цра Скользящие не Скользящие окна у нас изначально был токен buet сейчас цра с стами Ну то есть соответственно опять же при большом тенсе при большом окне алгоритма это может выдавать очень большие всплески при большом лете конечно может да и последней про шп а странно слышать про коже на Мук на который тормозит потому что Казалось бы а куча вариаций Каким образом это можно избежать там и Локи и локализованные Локи на каждого на каждом бате так получается что у нас есть Сервис через который уходит условно 50.000 продавцов у каждого продавца есть свой се ID и условно 100 методов то есть вот мы видим такое количество ключей вроде выглядит самым простым вариант просто взять Вот эту хш маку в которой хранятся остатки по всем этим селлера разбить по ID часте Да будет 16 Юсов 16 МАПО вот не очень понял почему он кажется сложным или не очевидным у меня есть ощущение что это очень хорошо будет в дискуссионной зоне обсуждаться Потому что тут как раз диалог а не просто вопрос ответ просто не до Кон понял Да поэтому дискуссионная зона идеальная для этого места вопрос Давайте дадим из второго ряда центра задать громко я Дима я из Озон Спасибо большое за доклад А я пошутил про Озон если что да Значит Вопрос такой Насколько я понял вы используете ограничение по IP на инсе и по celler ID а Бывает ли у вас такой такие ситуации Что селлеры используют какие-то средства автоматизации и когда это средство автоматизации обновляется у вас каждый селлер наваливает по небольшому количеству rps но в целом это получается серьёзные псы Бывает ли у вас такое И как вы с этим боретесь конечно бывает это вот как раз то что я рассказывал биты битый реализации на стороне селлера вот когда он что-то путает очень часто он просто какой-то Шторм запросов от него че сох начинается либо токен неправильный либо не туда вложил Да это 41 третий там какие угодно 44 и он просто отсе кается сразу по I Наверное я не полностью ответил вопрос нет если не полностью ответили на вопрос то всё ещё можно будет обсудить В дискуссионной зоне Возможно у нас останется время на то чтобы до задать вопрос Ну давайте сейчас Поднимите руки пожалуйста У кого есть вопрос в зале чтобы мы к вам подошли с микрофоном Ага тя жели А вот смотрите слева есть вопрос Давайте дадим возможность человеку который ещё не задавал вопрос задать вопрос Добрый день спасибо за доклад э Расскажите Вот ещё раз Почему Отказались от использования редиса кластера редиса говорите то что ну это серпи и там не такая большая нагрузка не отказались не отказались не отказались продолжаем пилотировать то есть для каких-то методов определённых продолжайте его использовать Да всё верно а ди се на самом деле показал очень хорошо Если не считать вот нашего этого ноу-хау с прогревом то всё даже очень просто показать продолжаем пилотировать набивать шишки на одной из категорий то есть на самом деле цель бы ещ раз показать что разные схемы они применимы в разных в разных случаях и тоже более чем Ну как вы говорите то что лень иногда что-то Там новое накатывать то почему бы не отказаться от дополнительных схем учитывая что не такая большая нагрузка и использовать вот приме сза между кластерами и этой оптико В смысле между дата центрами оптику рубили А в схеме с редисом получается что клиент ходит в редис независимо от того в каких они DC То есть он РВ там хэш и он может попасть в любой редис он может быть в другом дата-центре и в случае переруб оптики там это всё сильно деградирует поэтому отказались супер спасибо Есть ещё вопросы в зале то давайте дадим возможность задать вот Выбирай сам какую сторону давай влево влево Привет Спасибо вопрос про Open Source Какая сейчас ситуация с лимитами Вот такими вот большими В опенсорс С админкой и дадите ли вы в Open Source свой Open Source лимиты не очень понял Какая что в микрофон Верните пожалуйста Я полагаю что вопрос про то есть ли такие решения как ты описывал в докладе в ОС видел ли ты ИБИ Есть ли аналоги У нас есть такой тренд мы ВСС откладываем откладываем но мы точно это всё выложим в Open Source на самом деле это своего рода вот как мы воспринимаем как для себя качественный рост и Челлендж да то есть как только свой код открываешь наружу но за него если он плохой становится стыдно вот что скрывать так и есть вот поэтому да В ближайшем времени Ну как Давайте На горизонте этого года мы хотели большую часть всего что связано с за осор Да спасибо А другие Рей лимите в опенсорс есть посмотреть не наши конечно полным полно А есть ли ещё вопросы в зале я где-то видела поднималась рука нет Хорошо спасибо большое спасибо за то что задавали вопросы помните что можно пообщаться дальше будет с докладчиком напрямую вести диалог Спасибо большое за доклад очень круто Надеюсь мы когда-нибудь всё-таки для погоды А то как-то как-то сегодня нас ми Вот давай выберем вопрос который тебе больше всего понравился для того чтобы подарить матрёшку от онтика А что скрывать тут самые лучший вопрос был естественно от коллеги прон который как раз вскрыл то про не хотел рассказывать я изначально потому что этот эксперимент мы ещ не провели не хотел на этом акцентировать внимание сразу обрати на это внимание поэтому наших симпатий уходит к нему поднимите пожалуйста руку что ну или поднимитесь сами Да мы вас найдём и подарим вам подарок у нас также есть ещё один подарок от компании от твоей компании давай выберем ещё один вопрос Если что у меня есть список я запоминал только лучший Я подрабатываю секретар пока зада вопрос запис про Open Source вот мы чем больше акцентируем на этом сейчас внимание тем больше у нас будет поводов поскорее чтобы про это не забудут и потом опять спросят это знаеш селф челленж такой поднимите пожалуйста руку чтобы мы вас видели и доставили вам подарок от компании wiber большое спасибо что пришли доклад очень крутой вас Мы тоже Хотим поблагодарить и подарить подарок от конференции Приходите к нам ещё Рассказывайте ещё доклады Спасибо всем спасибо большое Di"
}