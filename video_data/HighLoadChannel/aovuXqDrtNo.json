{
  "video_id": "aovuXqDrtNo",
  "channel": "HighLoadChannel",
  "title": "Магия Elixir в рассылке e-mail / Александр Швец (Xeteq)",
  "views": 1548,
  "duration": 2888,
  "published": "2019-06-03T08:58:01-07:00",
  "text": "давайте таблиц для начала меня зовут александр швец и и я буду сильно докладывать тумбы ну на самом деле я работаю в компании exiteq и мы в общем такая технологическая компания но мы работаем в основном в сфере марте к идти к нас довольно много клиентов которые являются рекламными агентствами или рекламодателями они рассылают очень очень очень очень очень очень много писем на самом деле это более сотни от несколько сотен миллионов и и скоро уже там будут миллиарды то что мы сейчас рассылаем и то с чем мы столкнулись когда общем то пришел в компанию у нас было ужасное древние решение на печке которые как-то что-то пыталась там что-то отправлять и на самом деле она уже давно практически не работала ее в основном чтобы справляться с нагрузкой использовался уже в внешний сервис рассылок ну их в общем достаточно много поэтому мы столкнулись той ситуации что объем у нас очень большой свое решение но какое-то совершенно не рабочая за внешние решение но трахни очень хочется платить тоже на таких объемах и во-вторых тоже под себя как-то конфигурировать не особо получается и вот хочу вас просили кто вообще вот здесь сталкивался с конфигурацией почте с конфигурацией рассылки почты так ну вообще много рук практически наверное каждый когда-нибудь сталкивался по крайней мере наверняка там с какого-нибудь своего сервера что-нибудь отправлять до приходится вот ну просто хочется немножечко рассказать на то как как сегодня вообще ситуация обстоит именно с рассылкой почты с различными mc и прекрасно есть действительно ряд проектов которыми сейчас в основном пользуются для рассылки если он действительно ничего там супер пупер configure конфигурации конфигу родильного простите не нужно вы наверняка будете использовать там какой постфикс да и если вы там любите на прием технологии от microsoft и у вас все там на microsoft есть замечательнейший exechange сервер и вопрос наверное в том что насколько вообще эти средства на сегодня современные они все прекрасны конечно развиваются они выпускают новые версии так далее ну например нашему встречку sendmail задумайтесь уже 35 лет восемьдесят третьем году была выпущена первая версия самой молодой у нас как раз получается постфикс ему получать всего 20 лет пока но несмотря на то что действительно очень такие старые ивашко и проверенные решения в которых очень много функций с ними есть довольно мог проблем во первых это тяжелое абсолютно наследие которые там у кого-то 30 у кого-то 20 лет тянется и несмотря на выход новых версий все равно что то там для обратная совместимость что для чего-то ну вот так вот исторически сложилась такая но сейчас есть и в принципе это вытекает следующий пункт пункт что если вы хотите сделать что-то гибко и что-то вот именно под ваши нужды the uk сконфигурировать в ваше рабочее решение это будет совершенно не тривиальная задача ну и в конце концов на самом деле каких-то хороших таких может сказать каналов коммуникации чтобы можно было как-то собирать правильную статистику как-то динамически менять конфигурацию их нет и все в общем то основном упирается в парсинг логов ну парсить логии почтовые службы знаете такое отдельное тоже удовольствие поэтому в общем то у нас были конечно какие-то идеи где-то вот использовать уже готовые текущие решение но мы от этого быстро отказались и конечно есть масса сейчас сервисов таких был платных для рассылки емейлов они все сделаны там на разных технологиях они все сделаны там с разной степенью гибкости у них у всех там есть разные полноты apes к но да тут как бы с одной стороны вроде бы кажется чем делать еще свой велосипед когда у нас есть и так уже дофига готовых решений но тут в общем то опять же вопрос и цены возникает что это все руки внешние решение и потом по сути ну если чего-то вопишь кинет но этого значит и не будет значит к сожалению вы можете идти лесом или там оставляется какие то и четыре квесты в поддержку поэтому собственно было все-таки решение принято запилить свой собственный сервис при этом кстати да вот если посмотреть на то там древние решение которое он был напичкан о там под тысячу серваков использовала что в общем-то мы с одной стороны нормально с другой стороны хотела все-таки сократить для простоты администрирования количество ну и в конце концов сделать все таки ты решений по нам было дешевым и надежно вот ну и такую мы еще себе задачку поставили что мы хотим максимально это решение написать на эликсире потому что понятно что в страну узкие какие-то места будут и чтобы не делать какую-то дополнительную оптимизацию то лучше писать сразу на том что тебя заставляет оптимизировать сразу что в принципе является сразу них колец теперь вот хоть и где спросил кто когда почту настраивал рассылала кто пишет на эликсире так буквально пару рук но интересно то есть в основном пришли послушать наверное что же такое elixir круто ну тогда небольшая вводная тогда еще вот такой вопрос а на эрланге кто-нибудь писал пишет так еще пару рок отлично по сути elixir это язык программирования до всего лишь язык программирования такого ковать можно удить но основной смысл эликсира в том что вот то что вы на нем программы получается они запускаются на ерлан графской виртуальной машине и это значит что у нас появляются совершенно на легковесные потоки которые но я не буду сейчас уходить нам в терминологию как правильно это все называть потоки нить и так далее а смысл в том что можно делать очень легковесных worker of которые в принципе даже не являются в точки зрения там операционные системы какими-то отдельными потоками процессами и с другой стороны если вы когда они там видели код на эрланге или что-то писали но это такое относительно и удовольствие конечно она там начинаю через какое то время может быть доставлять но уровень входа в высокий ну и в принципе все таки скольких неприятные вещи elixir же он значительно упростил вот это вот вход в орландо в сколько система что и в общем-то придумали руби стаи в нем масса как вот синтаксического сахара вы можете написать какой-то более человека читаемый более человека понятный код который легко поддерживать и расширять вот соответственно поэтому мы решили попробовать на эликсире ну посмотрим что из этого получилось ну и такое общем-то вопрос он практически риторический если вам нужно сделать свой сервис рассылки и рассылать дофига писем все вообще начнете ну как ну в общем-то да правильно сначала с чего начать и вы наверняка попробуйте в принципе посылать какие-то письма ну и надо же может быть они даже в спам не будут попадать может быть там вообще все хорошо что у нас есть в этом плане в эликсире для почта есть во первых шикарнейшая библиотечка ген smtp она на самом деле ерлан графское может сказать вообще стал вот в ерлан графской к системе таким стандартам для работы с почте там есть и серверная часть есть клиентская часть важные клиенты и серверы с помощью написать ну и плюс а качество она такая конфигурация достаточно чтобы ее как-то кастомизируют можно использовать другие решения есть ли про такие библиотечки как mail мы или бекс entropy strenx'а ним прямо помогают сделки дополнительные механизмы типа диким этом и и прочего и в общем-то они все хорошие из них можно различные куски взять вот единственным нас была трудность с моей любек сам если будете использовать скорее всего придётся перемывать серьезно так почителе просто выдирать те куски которые вам нужны потому что к сожалению в том видео вот в целом которому она есть она не очень пригодны для использования вот ну и как альтернативу можно использовать другие какие-то стыке теперь с 20 керним тоже библиотечка большая или даже у нас от celik тела есть библиотечка пэт но мы вот пока становились вот этого четверки 1 ну и правильно уже сказали что следующий вопрос после того как вы вас получится разослать письма нам прекрасным там станет в очереди различных служб рассылки приема сообщений и первое с чем вы дальше толкнете что ваш письма почему попадают в спам ну и наверно это вообще основная проблема с которой придётся бороться дальше и здесь выясняется очень такая интересная вещь ну вопрос хочется понять а почему почему собственно мои письма попадают в спам такие хорошие белые и пушистые в основном чтобы понять почему они попадают спам вы можете использовать сервисы пост master of у всех в общем-то служб почтовых но у самых популярных на смотреть ему возьмем россию это джи mail это mail.ru это индекс это практически не знаем про процентов 80 наверное ящиков а то и больше на который приходится рассылать конечно включая какую-то корпоративную почту которая опять же на них же сделано и так далее вот ну по крайней мере если вы поймете почему у них попадаете спам то остальное хвост можно вообще даже не смотреть вот всех этих сервисов есть замечательные админские интерфейсы где вы можете там подтвердить что вы и да вы отправляете там почту с этого айпишник из этого домена и посмотреть рейтинг какой есть у вашего айпи и какие то другие там сообщения об ошибках там нажимают люди что это спам или там еще какие то есть штуки все это можно прекрасно мониторить и даже есть вот есть такой еще сервис-центр score по сути она основана рендер пози такая технология через которую многие почтовые службы вообще обменивают с информации о недобросовестных рассыльщика ху всяческих спамерах и так далее вот ну и у неё там тоже можно посмотреть скоринг такой обобщенный вообще не много чего прикольного дело вот но на самом деле это вот такой вот путь которым вы придете когда вы будете уже рассылать очень-очень много писем пока вы будете рассылать еще одна только начнете вас еще эти сервисы скорее всего вообще никакой статистики не дадут потому что они начинают отдавать уже на каких-то определенных объемов и дальше с чем вы столкнетесь то что каждый вот сервер который вы вводите в эксплуатацию которого будете рассылать почту его нужно прогревать и даже на самом деле не сервер и пешку что удивительная когда до того как начал этим общим заниматься я думаю что там основной скоринг рейтинг он идет там по доменным с которых рассылается письма на самом деле основное критерии по которым будут смотреть и накапливать вообще статистику это именно айпи адрес то есть и в зависимости от того сколько вам вообще писем нужно отправлять столько вам нужно и пишет и получить при этом когда вы вот ввели совершенно новую фишку совершенно новую который не знаю там другие почтовые службы снять нельзя сразу много писем отправлять буквально вот в первый день когда только нового фишка появилась не может там писем 50 например отправить потом на следующий день 100 писем потом где-то может там скачками допустим там 500 отправить но в принципе такая не совсем арифметическая прогрессия но и не совсем такая экспоненциально вот примерно эти данные даже мы сейчас тоже примерно столкнулись той же картины мы вот эти данные нашли из снг это тоже такая почтовая служба довольно большая это вот их рекомендации то есть в итоге чтобы с одной лепешки рассылать несколько миллионов сообщений в сутки но вам придется там прогревать этот сервер где-то под месяц иногда конечно зависит от того что вы рассылаете там как вы рассылаете можно при каких благоприятных условиях там за пару недель прогреть его но вот в целом там нужно рассчитывать около месяца и в принципе в дальнейшем это конечно очень сильно влияет на то как вы деплоить как вообще все это дело арки регистрируете то есть нужно сразу предусматривать что у вас на каждая айпишник для каждой почтовые службы есть вот такие вот ограничения что больше такого то нельзя рассылать вот и при этом вот эти ограничения не меняется динамически и можно вот либо смотреть вот вот это вот таблички как ты делать либо хороший вариант когда вы еще как каким-то образом в томате автоматизируйте получение скоринга по вашему айпи и тогда зависимость от этого скоро уже увеличиваете количество рассылаемых писем ну и понятно не буду сейчас углубляться в детали потому что то можно там еще делать отдельный доклад на целый час нужно будет действительно там работать как сделать правильный spv как делать правильно дэ ким дэ марк и избили все эти механизмы они помогают либо как-то ddns специальным образом дел чтобы понимать что действительно вы имеете право с этого доме на рассылать ли подписывать там электронной подписью ваши письма опять же там по ключу которой есть в dns ли получать какие-то отчета чтобы понимать собирать статистику но в общем это такой предмет предмет для исследования действительно помогает бороться с тем чтобы ну чтобы улучшать общем то ваш вскоре и дальше с чем вы сталкиваетесь и пишет нужно до фига и получается что но обычно в нашем представлении там молить один айпи это один сервер но при этом даже если мы возьмем какой-то самый легкий там самый какой-то минимальный сервак и мы поставим там него чтобы крутились наши эликсиров ские worker и мы память что эти сорвать и совершенно не до загружены ну то есть вроде бы взяли такое решение которое там до по производительность должно бы быть супер но здесь упираемся какой совершенно другую непонятную вещь и получается вопрос а можно ли нам все таки на 1 сервак сделать многое пишет но наверняка вы с такой там конфигурации сталкивались и принципе для сервера это нормально вполне но здесь у нас получать что оно нужно именно в иметь внешние и кишки у сервер ну где-нибудь тому хотят допустим вот 8 штук чтобы их было и наверняка вы себе представляете если когда нибудь там писали с нуля сервер как кому указать какие айпи ну какие интерфейс и с какими айпи слушать сталкивались ли вы когда-нибудь задачей что вам нужна именно исходящий трафик направляется через определенное пи чтобы я ушел через определенный интерфейс ну ну например и сложно если вы отправляете на как не имею ввиду если вы отправляетесь на какой-то конкретный адрес и вы там в таблице маршрутизации прописываете что вот на такой то адрес нужно обращаться через интерфейс это все просто а здесь у вас получается что вам нужно на абсолютно не знаю в тот же там джимейл пойти по одним и тем же там на одни и те же и печники но с локальных разных и пикников и в принципе если вы действительно эту задачу ну даже кто-то наноси когда невысоких колупался довольно несложно edition пса канонические каких-то примеров практически нет но если посмотреть как как когда запускается там сервера и бинты socket на определенный интерфейс то в принципе при отправке можно сделать примерно так же просто никто об этом не говорит но другая проблема есть в том что вот это вот функциональность и и выше обычным никогда никто не пробрасывать если вы используете какие-то стандартные библиотеки например как тут же библиотечку для отправки почты то чтобы вот ей сказать что а ты пожалуйста установить connect вот именно через эту через этот интерфейс это достаточно нетривиальная задача и вот здесь вот наверно единственное чем мы пока запылились мы не смогли пока это сделать на эликсире но здесь нам помогли наши друзья гош ники с которой запилили просто малюсенький такой сервис который себя представляет socks5 proxy то есть такую абсолютно правильно sky прозрачный прокси или непрозрачно борту который короче говоря не заметен не для отравителя не для получателя и там уже вот как тоже очень хитро можно создать там свой транспорт можно там как то есть библиотечка дилеров который бил и вот через вот в этот дил уже пропихнуть вот это вот опция соки то что отправляя через вот этот вот через вот этот вот интерфейс и тогда действительно он будет через него отправлять и соответственно каждой и пишем который у вас на сервере заводится вот такой вот прокси и noise прокси уже проще прокси все уже поддерживают через него нужно просто уже отправлять получается ваш запрос ну да я надеюсь что на самом деле пока руки не дошли но нужно покупаться наверняка внутри внутрях эликсира тоже это можно все таки все пробросить ну и потом когда у вас раз получать что вы уже научились рассылать вы поняли что нужно многое пишет вы даже научились прикручивать эти а и кишки и дальше будет вопрос стабильностью на самом деле наверняка пока вы все это будете делать вы его уже решить и потому что в эликсире со стабильностью вообще никаких проблем не это вам ну не знаем например много писал достаточно там на бетоне или когда ты совсем там лет 10 назад там должны пить перед приходилось писать там с проблема с маркерами огромная чтобы вот у вас какие-то процессы что то что то что ты что-то делали и нормально держались то вот в эликсире это решается с помощью какие-то может быть стандартных таких паттернов то есть паттерн ген сервера который реализует вот ну ну как сказать можно сервис какой-то сервер worker и его сразу же есть там встроенный супервизоры которые следят за тем чтобы действительно эти маркеры они держались что если с ними что-то вдруг случилось они там и ментальные перри запускаются и вообще очень классную такая технология при этом там с явными stay to me ну то есть там по сути же у нас получается функционально но есть возможность опрокидывает стоит но делать это явным образом поэтому получается все очень супер быстро и мало того что есть вся эта функциональность есть тоже библиотечка который по сути тоже является стандартом который называется пул бой пол бой позволяет вам делать именно динамические пулы этих маркеров вы можете сконфигурировать так что у вас будет по умолчанию сколько the worker of но если задачек получается на них приходит сообщение больше чем они могут обработать но этот пул динамически увеличивается и все это делается очень просто вот буквально там пример кода запуск такого маркера по сути нужно указать там его имя нужно указать его модуль через который он там запускается и вот эти вот опции сколько мы хотим по умолчанию сколько мы можем насколько можем максимально увеличивать и вот запускаем там су супервизора на него здесь буду больше такую как практически декларативным это все объявили и так все равно это не знаю если сравнить каким-нибудь там конфигурацией salary питонов sky который там работает чертик окно это вот работает супер стабильная никогда с этим никаких проблем нет дальше после того как вы все это настроить и научитесь рассылать письма научитесь прогревать серваке и это будет работать абсолютно стабильно мы память что функциональности на самом деле не хватает придет там менеджеры скажет а вот мы сейчас рассылаем там одинаковые письма абсолютно а на самом деле каждому получателю нам нужно сказать что там не просто привет к при этом александр владимирович вот у нас там для тебя какой-нибудь индивидуальное предложение и по сути на сегодняшний день практически все письма отправляемые они конфигурируем и нужно все этой системе рассылки предусмотреть в том числе и рендеринг но в общем то наверное ничего как у какого-то рокет сайенс и нет единственное что тут стоит обратить внимание что можно того как мы взяли сразу взять шаблонизатор эликсиров ски x есть и он прекрасно и там есть масса замечательных конструкций но скорее всего у вас будет тоже бизнес требованиях то чтобы чтобы перетаскивать например клиентов с других рассыльщик авто нужно будет реализовать еще несколько систем шаблонизация ну например самая сейчас популярный наверно это mandrill у них есть свои такая достаточно рисовать инька на мой взгляд шаблонизация с мерфи лбами и например на может быть mandrill вы не слышали если не сталкивались может быть слышали mailchimp это вот именно такой админка по созданию com компании и меловых и mailchimp он на самом деле вот поверх этого мандрилы работает как раз ну и или например мы реализовали еще unisender то что у нас очень много до этого через него рассылалась ну и наверняка то есть вам надо предусмотреть что будет какая-то такая плагина я система что чтобы 1 1 одном одним видом шаблонизация вы скорее всего не обойдетесь вот после того как вы это сделали следующий вопрос а где вообще посмотреть статистику где посмотреть сколько писем у нас действительно дошло сколько у нас было открытие сколько там щелкали по ссылкам сколько по ним кликали ну и бог знает том что еще ну и конечно если тут ничего не остается кроме как считать все это дело для этого тоже можно использовать эликсир но там очень такой получается на самом деле тоненький worker по сути то что вот внутри есть это клика us цена клика us использует кстати вот хотим даже больше больше рук чем те кто пишет эликсире отлично правда прекрасны и технологии я тоже очень давно пользуюсь практически с тех пор как яндекс выпустил и она вот прям снимает весь головняк то есть мы в нем можно записывать какое громадное количество информации и можно потом хочешь во-первых тем же менеджером дать какой-нибудь там доступ к скале чтобы они сами запросы делали ну и в принципе тоже вытащить в какую-то основную информацию там чтобы она писки отдавалась тут проблем никаких нет а ну единственно иногда там нужно у кроме записях ли cows отправлять хути в какие-то внешние сервисы но как такая дополнительная функциональность вот ну и здесь получается что практически все у нас уже реализовано все отправляется вся статистика считается все супер стабильно за одним исключением нас не всегда вот когда вот происходит smtp соси отправки почты нам далеко не всегда почтовую службу отвечают сразу что у нас что то не так очень часто какие то сообщения об ошибках они приходят нам отложено и в том числе например когда там вы в почтовом клиенте щелкаете это спам на вот эти вот сообщения тоже можно подписаться и вопросам читать их и не читать все эти сообщение но в ответ однозначно что ты все нужно читать и все это нужно учитывать свои статистике что кстати интересно самый нормальный способ чтобы вот тоже вас не посчитали какими-то злобными спамерами все вот эти вот ваши worker и которые занимаются там отправкой там трекингом ссылок которые занимаются получением писем идеально если они будут как именно на одном и печники находиться то есть вот именно на одной машине у нас все эти сервисы располагаются то есть у нас приемщик написано том же эликсире используется тот же ген smtp но уже с другой стороны и единственно он через rabbit отправляет уже в счетчик информация есть он сам на самом деле ничего не подсчитывает а тоже такой достаточно легкий ну и понят следую чтобы после того как у вас всю труппу полнофункциональная система получится нужно будет еще и описку скорее всего сделать если вы хотите чтобы этим действительно кто-то пользовался кроме вас и тут вот наверно 2 только единственный момент в котором мы немножечко отошли это эликсира ну так сделай может параллельно и вот та пешку мы сделали на питоне не могу сказать что это нельзя было бы сделать мои эликсире но возможно для таких вот каких-то супер стандартных задач и ты не требуется то есть там уже можно использовать тот же ласк маршмеллоу который будет заниматься там валидации марше лизации генерить там с схемы для того чтобы автоматическую документацию по описки делаться так далее ну и в том числе например у нас вот эликсир нигде получается с подбросом и общается пошта по сбросу нас используется только для того чтобы хранить какие-то пользователи аккаунтов ну какой-то куст стабильную информацию все остальное уже на уровне такой статистики вот ну возможно вы все-таки доберемся до того что тоже это на эликсир переведем что просто не держать какого-то зоопарк технологий вот в целом если посмотреть если посмотреть на это по отправке письма вас получается есть вызов опишите у вас есть разбиение дав когда вызывается песка там сразу передается огромный список получателей то может быть 100 тысяч там миллион базы рассылки их нужно там разбить на пачке отправить на разные worker и потом рендеринг потом отправка но это чтобы часто бывает что потом все-таки чего вас остается сбор статистики и остается перейдем вот этих вот отложенных ответов от почтовых служб ну то есть если вот по основным сервисом таким разложить то такая вот цепочка получается и перевод этот менеджер тире dispatcher рендер sender каунтер ресивер все в общем то в итоге получается довольно кажется что просто но если мы эту вот раскладываем прямо по реальным машинным по способом коммуникации все получается чуть чуть посложнее здесь вот тоже интересно на что посмотреть но вот как я говорил есть вот машины именно worker of да где у нас сгруппированы все сервисы которые занимаются там рендером хоть рендер почему то что до запихивается потому что в принципе сама функция отправки приему почта она не очень ресурсоемкая поэтому чтобы занять как-то ресурс рендерить можно вполне тоже на тех же worker of strangers in der ресивер ну и менеджер который тоже может внутри какую-то делать маршрутизацию все что у нас там общается между машинами общение тет через rabbit которых стать тоже на эрланге написал но вот именно внутри между worker мыслим нужно общаться они используют уже внутренней ланговски и очереди это прям тоже такой бальзам на душу очень крутая штука я об этом чуть дальше расскажу а и здесь вот единственное что в этой схеме не получается показать а как же действительно все-таки в такой парадигме следить за тем чтобы не отправлялась очень много писем чтобы мы действительно могли вы динамически увеличивать нагрузку на наши внешние почтовые службы с разных айпи ну и здесь на самом деле нам помогают те же эликсиров ские очереди здесь вот есть приведены наиболее популярны эликсиров ские библиотеки но fireworks он немножко отдельно стоит потому что fireworks он сделан для того чтобы именно с рыбе там работать а вот например ханидью или упеку они надстраиваются над ерлан горскими очередями ну и даже на самом деле не только надир ланговски мин тхо ханидью она может даже над мнение настраивают надстраиваются но много над чем и в принципе вот в каких-то из библиотеки ква пи кью например уже встроенную функциональность по write лимитом вы можете задать вам сколько вы хотите чтобы максимально worker письма ну какие сообщения обрабатывали но если допустим вот мы использовали ханидью на потому что более функциональный но к сожалению вот именно этими то там нет но для этого используются тоже паттерну практически стандартные эликсиров ски который называется ген стоишь в принципе как правильно правильно сказать ну вот так вот паттерн который этапы обработки данных что ли позволяет лю любые вам закладывать и в том числе вот в эти этапы можно заложить ни пера такую функциональность как ограничение по количеству обработанных сообщений ну-ка по количеству отправки в нашем случае но даже при этом если в этом будете использовать все равно у нас на ринг а где тут будут узкие места и вот мы когда начали делать роутинг сообщений мы сначала сделали вот таким достаточно наивным путем но оказалось наиболее таким гибким понятно мы сначала когда у нас идет отправка отправка идет всегда с какого-то от какого-то от имени какого-то доме на конкретного то есть мы можем на каждый домен завести отдельную очередь ко мне кстати есть да на каждой даме завести отдельную очередь потом например если это какой-то домик большой там большой клиент у него может быть привязана к этому доме но несколько и пишет с которых идет отправка либо наоборот если это какие-то мелкие клиенты там мелкие сайт это может быть так что снова и пили отправляется от нескольких доменов и потом соответственно с каждого и пи чтобы нам как раз вот эти райт лимит выдерживать у нас есть очередь отправки в google отправки в mail оправки в яндекс ну отправки во все остальное тут поставлю 3 точен участком даже делаю еще остальном то что 80 процентов здесь покрывается к чему мы здесь пришли что к сожалению вот при такой системе у вас получается смотреть что у вас не все рассылки одновременно равномерно размазаны по гуглу и мылу может так оказаться что в какой-то вот рассылки у вас там угла значительно больше и у вас принципе уже что вот это вот worker там загружаем а вот этот вот worker там еловый которая отсюда из этой очереди получает он уже там все тоски и выполню при этом где-то здесь вот еще есть отправка на mail но она сюда не может попасть потому что здесь застряли еще сообщение в google и получается что действительно вот здесь вот такая такое узкое место поэтому оказался не нужно все-таки делать такое огромное количество уровней очередей а нужно сделать достаточную плоскую структуру и у нас есть очередь который прям сразу связано там айпи и почтовая служба на которую мы отправляем и по сути есть просто там сервис dispatcher и который выбирает в какую очередь мы засунем сообщения в которой нам нужно отправить и в общем то все это классно отправляется единственно когда у нас много таких очередей много достаточно этапов можно в общем то запутаться и не понятно как иногда некоторые письма отслеживать то что здесь вот на разных этапах от действуют совершенно разные идиш ники ну вот таких вот найди шик наверно 9 штук основных это начиная от конкретного там ленкой диета идиш к ссылке в письме что можно было собирать с каких на какие ссылки кликают в письмах да там юзер айди это уже пользователь то мои кишки который делает рассылки но из такого интересного да тут получается отдельно получается сервера иди-иди жку с которого мы отправляем и есть айпи а иди и потому что понятной и пишет больше чем серверов вот ну и всегда вот тоже внутренние какие-то интересные механизмы а вот есть компания диета иди конкретной рассылки а есть еще список рассылки ну то есть вот вы когда подписываетесь куда-то вы падаете список рассылок какую-то изменяемую такую штуку но вам нужно всегда хранить еще и конкретные вот слепок этого списка рассылки по которому было произведено конкретная правка отсюда появляется вот компаний найди еще ну и до майло идея то прям стандартно то что вот в заголовках оценки питом идет он прямо у каждого письма отдельные конкретно и помимо того что столько нужно взять хищников на них обращать внимание вам нужно будет еще обеспечивать их уникальность при том что вам нужно совершенно все это делать распределена то есть сделать какой-то единый центральный сервер который вам будет обеспечить генерацию опишет но практически нереально но мы посмотрели на опыт как там делает instagram twitter в них не пункта 1 пом twitter снова flake в инстаграм и они что-то сделали похоже ну и мы вот типа того тоже сделали свой сервис здесь может быть не не очень хорошо видно весь смысл в том что а едешь к генерируется когда там 64 бита там первые биты они используются для того чтобы запихнуть туда таймс темп потом там есть биты чтобы ну отойди туда запихнуть ну то есть одышку сервера скан котором это генерится ее можно мы сократили вот мы прячем от snowflake отличается мы сократили у всех именно временной то есть мы не читаем там не семидесятого года например миллисекунды а считая с 2018 поэтому у нас еще была дополнительная стойкость получилось за счет того что мы можем несколько там бит использовать для рандомный ну для рандомных битв вот ну и собственно я уже про практически подхожу к концу после того как вот всю эту функциональность сделаете ну может быть конечно об этом стоило это мы сразу подумать о может быть в об этом все таки подумаете ближе к концу тут вопрос возникает как это все деплоить и регистрировать с одной стороны lexer прекрасен тем что есть такая штука к distillery и вы можете сгенерировать прям исполняемые наших программы которые будут работать вообще без и вам без орлан графской виртуальной машины и по сути их можно грамм вот закидывать голову операционную систему и тут есть там разные лагеря кто то считает что запихивать эликсир еще в докер это перебор но мы вот например мы считаем что все таки докер с равно не помешает ну что в целом чтобы сделать какую-то хорошую нормальную оркестрацию ну в докер мать все-таки делать проще чем просто эликсиров скими программами ну и единстве чем вы там столкнетесь с проброс сам конфигов потому что получается вам нужно это все скомпилировать и очень много какой-то информации нужно именно помещаться компилируемый конфиг поэтому это нужно сразу при подготовке образов учитывать ну и еще вот единственное по если так по бизнес части задачи с которыми вы столкнетесь чтобы тоже предусмотрели что новые оки что новые рассылки их нужного лидировать то есть когда он приходит новая база если вы сразу ее непроверенные начнете рассылать вы скорее всего подорвете себе авторитет поэтому вот все не проверены на непонятные адресаты их лучше сразу подмешивать по чуть-чуть прогретом айпишник of и если вы подпортить цветам рейтинг то себе совсем чуть-чуть ну и вы только что у нас получилось мы сейчас где-то посылаем по 40 миллионов писем за 8 часов при этом почему кстати 8 часов и не сутки на то что если мы возьмем какое-то определенное дела например там center центральный округ россии там москву петербург не кроме в основном все рассылает ту это один часовой пояс и будут стараться рассылать в рабочее время эти рассылки поэтому там диапазон убрать 24 часа не совсем актуально вот ну и пока мы для этого используем 70 серверов мне стал что у нас там была под тысячу но практически те же объема на 70 но пока они еще у нас не все прогреты и мы вот этот вот количество писем будем еще увеличивать ну и пока где-то надо где-то даже по 1 мпа одной пешки всего но вот пока у нас максимальным 8 напишет на сервере из таких вот совсем минусов эликсиров прекрасен шикарен единственными наверное минут что пока мало каких-то хороших библиотек которые мину на эликсире написаны с тех что есть они в основном в ирландии ну и стал что принципе lexer сейчас набирает популярность за счет своей просто супер способности делать очень крутые сервисы но сообщества пока еще довольно маленькая из-за этого тоже мало документации то есть будьте готовы что он скорее всего придется много кода читать то есть даже вот если найдете хорошую библиотечку это смотреть там pull request читать код как это все нужно использую а в целом вообще супер ну это вот наш план и dance что я не покрыл не рассказал очень хочется с автоматизировать как-то в работу с dns томас проблем отдельных это попробовать цепи и в 6 но там рейтинг просто проблема в том что он ведется по диапазонам и пишет ну и хочется конечно примерно такую целостность экосистем нам все-таки все перевести на эликсир то что нагона и питоне сейчас есть тоже перевести вот ну и в заключении собственно вот мы может как поставили себе такую задачу сразу использовать эликсиры но мы наверное ни разу не пожалели о том что мы ее используем тоже действительно каких-то оптимизации там по производительности у нас не бы у нас была вот серьезная оптимизации когда мы там ошиблись тем как правильно очередь сделать в остальном все получается так очень гладко ровно и какие то специальных усилия на общем то не требует так что общем это не страшно абсолютно это полезно от этого прим если будете сами писать от эту прям можно получать удовольствие и при этом но не можно не бояться как-то измельчать те сервисы которые у вас есть например вот там сервис который генерит родишь кидает там тоже отдельный внутри эликсиров ский worker и никого там не смущает что это одна функция какая-то небольшая там на десять строчек и в принципе ну вот там делать какие-то мини worker и такие в абсолютно без проблем да ну и несмотря на то что мы сейчас вроде живем в эпоху мессенджеров и каких то огромных там до других каналов коммуникации почте на самом деле живее всех живых и вот понял что действительно она видимо еще умрет довольно не скоро поэтому тоже много чего важно знать и не бойтесь использовать почту но надо рассылать конечно полезно и хорошие письма не рассылаете спам вот на этом у меня все спасибо христа вопросы буду рад ответить а третью меня насчет вашего вопроса про винница капищ ником в мануале про генте первые между опциями идут с какого каком айпишник убедиться локально посмотрите это но другой вопрос в докере докер хорошо но сети у него все не так идеально как у голого linux если у вас проблемы с пробрасываем пачки и печников его докер так чтобы это нормально выходила наружу тушить скажу скажу честно я вот именно этой областью не заниматься но там в общем все хорошо и мы использовали абсолютно там тут тут уже к систем который у нас использовался для других проектов там не алексей русских хорошо второй вопрос вы если у вас такая практика чтобы вы сохраняли каждые отосланные письмо у себя где-то в базе каждый хранится нереально так мы сохраняем факт отправки в клик house то есть сразу нас вот есть счетчик он записывает что было отправлено а так не храним конечно понятно просто вы сказали что у вас пока еще нет нет связи с подвесом но достаточно что пол боя если вы пытаете него под возраста я как раз про то что хочу сказать он для каких таких очень персис там данных и действительно в нем вот какая-то говорю там табличка с пользователями с доменными с какими то там какой-то агрегированный статистикой то есть там ничего вот такого ужели низкоуровневыми но на всякий случай не пользуйтесь пол боем для по сбросу это не рабочая штука она выглядит как рабочая а потом это превращается в кошмар но в дамы наслышан поэтому тоже решили вообще уйти от использование поставить там действительно не нужен он только лишние создает узкие места если хотите чтоб все работало быстро и лучше там не использовать скин себе хороший хороший замечаний может быть стыдно что-то что-то упустили но я думаю что может быть тоже не просто так там все это пропитывается можно до меня денежный вопрос вот у вас там парка машин аренда и печник of parks crack house of parks подгорит так далее тому подобное получилось это дешевле или дороже если да то сколько раз чем когда вы пользовались сторонним сервисом просто выписку обращались постоянно да определенно получилось дешевле в во сколько раз во сколько раз верно сейчас не скажу но там прям сильно здравствуйте очень хороший доклад спасибо спасибо хотел задать вопрос а как х рингом программистов с перспективами из переучивание вот кто вас до этого был это не стоит горники или может быть хищники на самом деле правда найти готов сейчас алексей программиста практически невозможно и у нас получается их там всего сейчас 3 штуки и но в основном это люди такие мультиязычные которые там много на чем писали на этого то чтобы взять там какого то это не стоит там или пхп книг сразу в эликсир переучить но довольно сложно то есть основном люди которые там с какой-то с функциональной например работали но хотя бы не знаю хотя бы с джессом тоже том как то спасибо спасибо за доклад хотел спросить а вот у вас там такая съемка была замечательная с тем как все происходит да как все устроено вот где примерно на этой съемке вы подписываете письме есть не секрет подписываем чем таким рядом при этом при отправке вот как-то мне за могу свернуть но это тоже вас какая . алексей используется это понимаю да вот это вот прям был сервис центр который подходит в mail service и там что-то для этого используется я точно не помню начала самый нужно мотать то ли для этого mail используются то или мы или бекс я понял и flash времени в трее в принципе в этом самом ген smtp и тоже есть эта функциональность на тогда нам тоже много чего за собой тащит все нам было проще именно использовать вот из этих библиотек спасибо да кстати а дед оставил слайд с результатами если какие-то потом еще вопрос вспомните вот можете не там написать фейсбуке или в тележечку будут тоже рад пообщаться спасибо за доклад интересно узнать как статистику собираете по открытием писем вот это через пуст мастера делаете как-то оптимизирована но в основном сами стараемся трека то есть там есть треки на ссылке в письме есть там и или ну клики понятно но там тоже вставляется пиксель как можно определить было открыть письмо не спасибо так всем на пол вопросов больше нет есть карточка тогда всем спасибо в кулуарах если на что могу ещё покричать"
}