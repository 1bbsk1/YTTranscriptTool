{
  "video_id": "USA7sRJ8Ln4",
  "channel": "HighLoadChannel",
  "title": "Управляем доступом в распределённой Linux-инфраструктуре / Антон Жаболенко, Павел Пархомец",
  "views": 1451,
  "duration": 3058,
  "published": "2024-04-17T01:10:28-07:00",
  "text": "Да коллеги Всем привет меня зовут Антон жаболенко я руководитель информационной безопасности в Wildberries здесь Мой коллега Павел Павел отвечает за направление безопасности инфраструктуры тоже Wildberries сегодня мы с вами поговорим про управление доступом в распределенный Linux инфраструктуре а Поднимите руки вообще кто сталкивался с администрированием большой высокой нагруженной распределенный Линукс инфраструктуры здесь присутствующие многие ожидаемо сталкивались на конференции по для разработчиков высокой нагруженных систем значит многие проблемы будут сегодня вам знакомы которые мы про которые мы сегодня поговорим о чем вообще будем говорить предположим что у вас есть большое количество хостов линуксовых и у вас нет какой-либо системы для управления доступом к этим хостам какой-то централизованной системы и не описаны правила собственное предоставления доступа к чему это очень быстро приведет к тому что ответить на такие вопросы как А у кого вообще куда есть доступ отзываются ли доступ уволенных каких-то избыточных полномочий в собственно говоря у сотрудников надежны ли вообще настроена аутентификация на конечных астах часто становится невозможным инфраструктура очень быстро так превращается на самом деле в хаос и собственно говоря например для ответа на вопрос опять же у кого куда есть доступ часто приходится вот как персонаж картинки на слайде разбираться проводить менее расследование кстати опять же у кого так было у некоторых было и собственно говоря Расскажи пожалуйста как мы эту проблему решали Да мы достаточно основательно подошли к этой проблеме мы проанализировали большое количество решений большое количество всевозможных подходов и поняли что оптимальным путем для нас будет построить свою систему управления доступом на базе такого решения как Телепорт подробно на его архитектуре мы останавливаться сегодня не будем как собственно и на многих других вещах которые мы обсуждали наших докладах ранее критерии которые мы выставляем к этим системам и так далее Сегодня последний заключительной точке и собственно Мы хотим обсудить следующее а именно проблемы с которыми мы столкнулись на этапах проектирования и внедрения нашей системы как мы эти проблемы решали и собственно что из этого Получилось но для того чтобы ввести вас контекст вообще чтобы вы были с нами в одном контексте о том расскажи пожалуйста Как вообще для конечного пользователя выглядит взаимодействие с конечными ресурсами Да предположим что у нас есть некоторый хост тест машин на который администратор некто паркомец хочет получить доступ При этом тест машин убран собственно говоря за Телепорт что нужно администратору для того чтобы получить доступ Он вводит такую командочку и получает дальше так как администратор использует Macbook получает приглашение пройти аутентификацию с помощью Touch ID администратор прикладывает пальчик и если система считает что у него достаточно привилегии для доступа на хост-тест машин он получает туда доступ и какие можно сделать выводы о том что такое телепорты какие у него есть отличительные особенности на основе этого простого но показательного Дема во-первых такой первый вывод наверное не очень приятный для тех кто хочет использовать Телепорт как ядро системы управления доступом первый вывод заключается в том что для доступа в инфраструктуру приходится использовать утилиту tsage это гостная реализация протокола ssh с некоторыми дополнительными фичами которые поставляются вместе непосредственно с телепортом а вывод второй с помощью телепорта для аутентификации на конечных ресурсах можно использовать э-э Touch ID на самом деле можно использовать любые аутентификаторы к примеру какие-либо аппаратные токены поддерживающие протокол 2 вывод третий Телепорт пишет э сессии всех администраторов и позволяет просматривать записи этих сессий и в принципе делает это довольно-таки надёжно и последний вывод телепорт в том или ином виде позволяет управлять привилегиями пользователей на конечных хостах например привилегиями суда чуть позже про это подробнее расскажем А собственно говоря Так выглядит не такой юзерский пользователя который получает доступ на конечный хост с помощью консольного утилиты но у телепорта есть еще и такое webuis Chicco которая например позволяет смотреть каким сервером У пользователя есть доступ но так как мы говорим с Вами про систему привилегированного управления доступом понятно что понятно как это выглядит для юзера но нам бы интересно было посмотреть А как же выглядит Эта система для администратора потому что управлять собственно говоря привилегированным доступом предстоит некоторым администратору который эту систему в том числе поддерживает Паш ты вот как человек который у нас внедрял в систему на основе телепорта Расскажи пожалуйста как собственно говоря выглядит админка Да тут всё просто на самом деле для администратора это выглядит примерно вот так а для того чтобы понять почему это так надо они всё-таки немножко обратиться к архитектуре телепорта а именно к одному одному его компоненту это сервис прокси вообще э сервис прокси нужен для того чтобы проксировать все запросы пользователя до конечных ресурсов То есть как бы такой промежу шлюз также сервис прокси совмещает себе функциональность графического интерфейса причем очень-очень сильно обрезанного То есть как такового какого-то выделенного административного интерфейса у телепорта нет собственно и из этого вытекает множество различных недостатков и Первый из них это что нету нормальной возможности смотреть и управлять устройствами многофакторной аутентификации пользователя То есть вы не можете смотреть какой у него привязан тип устройства там ТТП и так далее вторая проблема заключается в том чтобы вроде бы мелочь но тем не менее в административном интерфейсе который поставляется телепортом нет возможности смотреть время последнего логина это довольно-таки Забавно с учетом того что мы встраиваем себе в инфраструктуру система управления привилегированным доступом и хотели бы иметь такую простую функцию как посмотреть а когда вообще человек последний раз заходил на нашу инфраструктуру может быть он это делал несколько лет назад и у него уже можно собственно говоря отозвать доступа Да следующее это что когда вы строите систему управления доступом Скорее всего вы хотите сделать так чтобы ваши пользователи ходили под персональными и уникальными учетными записями так вот из интерфейса вы это сделать не можете вы можете сделать так что например пользователь Вася может ходить только под какими-то общими пользователями например Root Там и так далее при этом из консольного утилиты это можно сделать следующая проблема заключается в том что раньше было нельзя блокировать пользователей нельзя было смотреть статус блокировки этих пользователей и причину блокировки этих пользователей Почему я говорю нельзя было раньше потому что пока мы готовили этот доклад обновилась мажорная версия телепорта и там такая функция на самом деле в каком-то виде появилась Да следующее это что нельзя гибко управлять токенами для подключения ресурсов что это вообще такое все ваши ресурсы которые подключаются к телепорту в первый раз проходит некую процедуру аутентификации и проходят они с помощью специальных ролл токенов так вот в графическом интерфейсе вы не можете определять сколько будут жить эти токены Какие роли они будут наследовать то есть Какие типы ресурсов Вы можете подключать и так далее следующая проблема заключается в том что опять же в административном интерфейсе нет возможности управлять роботами это подробными тут имеется в виду различные сервисные учётные записи с которыми автоматика ходит внутрь вашей инфраструктура Да следующая проблема Это что вы не можете смотреть А к чему все-таки пользователь имеет доступ и потому что у вас может быть большое количество ролей Вы можете смотреть У кого какие роли но при этом каким конкретно ресурсом Эти роли предоставляют доступ пользователю для вас будет определить достаточно проблематично И на самом деле когда мы столкнулись с этим разрабатывая свою систему управления привилегированном доступе на основе телепорта мы с Пашей прямо обнялись и сплавнули потому что опять же система централизованного управления доступом вроде бы есть вся нужная информация для того чтобы этого делать но оно к сожалению не делает также Следующий пункт заключается в том что нет возможности анализировать учетки то есть вы по учеткам пользователей которые вас получают доступ к инфраструктуре не можете понять Вообще что это за четко какому она сотруднику относится увидеть какие-то комментарии когда она заведена кем заведена такого тоже нет да И последнее в этом списке Это плохо работающий поиск по записям сессии и событиям в графическом интерфейсе У вас есть возможность просматривать списочкам то кто вообще куда ходил потом искать этих людей смотреть их сессии и так далее Также вообще все что происходит в пластыре это определенное событие которое вас точно также собираются этих событий при большом количестве ваших пользователей при большом количестве взаимодействий может становиться так много что поиск просто перестает работать то есть на каждый запрос у вас будет уходить по одной более минут но как бы Эта история становится совершенно неудобно и нерабочий А если у кого-нибудь мысли как мы с этими проблемами боролись Когда строили систему управления доступа на основе телепорта какие-нибудь идеи а нет Телепорт на самом деле как Паша вначале сказал достаточно хорош мы сравнивали его с большим количеством другим систем про это рассказано других докладах в том числе с проприетарными системами системами и Телепорт по многим параметрам очень хорош но у него есть недостатки которые нужно побороть ещё варианты Как еще раз Отличный вариант да в принципе наверное примерно так мы поступили Да мы если скомпилировать вот эти два ответа Но примерно так и получается вообще нам придется вернуться опять же немножко к архитектуре телепорты и в общем у телепорта В качестве базы данных для отказа устойчивости высокой доступности используются эти сети Где хранится вообще все состояние кластера делается Это примерно аналогичным образом с кубером так вот мы сделали свое отдельное приложение назвали его когда максимальная экзотично Вот и подключили его в параллель кластером телепорты и собственно это графический интерфейс Который реализует всю необходимую на функциональность Некоторые из которых мы сейчас расскажем и первое конечно что мы сделали мы сделали такую Казалось бы обычную штуку но которая решила многие наши проблемы это обычная карточка сотрудника то есть теперь мы смогли нормально видеть что это за человек какой у него вообще статус заблокирован он или нет Если если он заблокирован то статус блокировки ой причина блокировки Какие устройства многофакторные аутентификации привязаны когда они использовались какие у него типы и так далее мы наконец-то получили возможность гибко управлять логинами пользователя и последнее что мы сделали мы сделали интеграцию с нашими кадровыми сервисами чтобы дежурные которые у нас разбирают заявки на доступы могли понять а Действительно ли этот человек принадлежит к тому отделу который действительно должен иметь доступ к этим ресурсам или нет да Но следующее что мы наверное еще больше хотели это все-таки анализ доступа А то с чего мы начали здесь и начали мы здесь такой простой вещи как Автоматизированная скажем так инвентаризация тех ролей которые нужны для доступа конкретному ресурсу Телепорт устроен Так что для доступа к конкретным ресурсам используется ролевая модель то есть пользователь должен получить роль которая доступ к этому ресурсу предоставляет И в чем здесь загвоздка загвоздка здесь в том что когда у вас большая инфраструктура несколько тысяч хостов количество ролей может переваливать за 10 тысяч спокойно и в ручном режиме с этим всем работать становится абсолютно невозможно И вам каждый раз для того чтобы понять собственно говоря Какую роль нужно выдать для того чтобы пользователь мог получить доступ к какому-нибудь хосту нужно взять и потратить там 10 минут опять же провести менее расследование как вот на Первом слайде чтобы этого не было мы написали систему которая собственно говоря по ресурсу выводит список ролей вроде всё очень просто которые дают э-э доступ к этому ресурсу Да следующим шагом Ну собственно На данном этапе у нас уже было был ресурс и был списочек ролей который предоставляет к этому ресурсу доступ также у нас есть пользователи и У пользователя тоже есть роли которые ему выданы и мы смогли это связать между собой и собственно по имени ресурсам мы смогли определять кто же к ним имеет доступ Да и последним шагом Здесь было то что мы как бы обратили в 5 это функциональность и теперь по имени пользователя мы смогли все-таки определять каким ресурсам и с какими привилегиями он имеет доступ и выводим это в виде списочка что не очень интересно больше нас интересовало какой-то графическое представление И Антона расскажи пожалуйста про него что в итоге получилось Получилось довольно простая простая функционал система Мы в нашей админке вводим логин пользователя например все того же администратора и получаем средние колонки список ресурсов до которых у этого администратора есть доступа и в крайнее правовые колонки список ролей по которым к этим ресурсам человек получает непосредственно доступа Да ну это еще не все на самом деле наверное можем еще и смотреть пересечение доступа Да действительно хорошо заметил можем еще смотреть о пересечении доступа если мы введем два Логина 3 логина или более система на самом деле рисует те ресурсы по которым введенных людей пересекаются доступы в целом показывает Там Граф доступа опять же этих людей можно видеть то что например для пользователя который внизу отображен когда доступ к двум ресурсам предоставляется по одной роли система тоже это подсвечивает а вот мы собственно говоря кратко рассказали о том что такое Телепорт и что нужно сделать и как его можно доработать для того чтобы он стал чуть больше похож на нормальную систему управления привилегированным доступом то есть в таком состоянии грубо говоря можно внедрять теперь осталось ответить на такое на самом деле вопрос А насколько вообще все это дело надёжно и пригодно для эксплуатации в продакшене насколько на твой взгляд оно надёжное в целом Надежда но как и у всего есть как бы некоторые нюансы и сейчас Антон расскажет про Первый из них Да несколько таких детективных историй О том э-э с чем мы столкнулись в рамках эксплуатации телепортов вроде А как-то раз вечером Паша пил кофеёчек смотрел в окно отдыхал наслаждался жизнью и одним глазом поглядывал как всегда на график доступности телепорта а в том числе сейчас например на экране выведен график того сколько вообще серверов подключено к кластеру телепорта и в один момент количество серверов начала неожиданно резко падать Паша испугался и мы пошли разбираться собственно говоря с тем А что вообще происходит и почему наш кластер неожиданно начал разваливаться потому что у нас за него уже было заведено порядка 9000 продавых серверов доступ которым нужно обеспечивать 24 на 7 я стали разбираться начали анализировать различные показатели компонент телепорта и как Паша сказал в качестве бэкента для хранения стейта кластера в телепорте используется и tcd посмотрели на то что происходит и заметили стопроцентную корреляцию с падением количества подключенных серверов кластеры с тем как эти неожиданно съел всю выделенную ему память жесткого диска Паша почему это вообще в итоге оказалось плохо Да дело в том что вообще все события которые происходят в телепорте то есть будь то аутентификация пользователя вход пользователя на конечный хвост или даже биты которые присылают вам успешные агенты Да своим состоянием на самом деле это все операции записи в базу то есть при достижении потолка по выделяемым ресурсам ваши эти сети просто переходят в режим редонли Но это значит что все ваши пользователи теряют возможность логиниться в prod ваш кластер рассыпается И все А из-за чего так в итоге произошло собственно из-за фрагментации потому что ну как я уже сказал создается огромное количество событий при подключении большого количества ресурсов и базу надо постоянно дефрагментировать мы столкнувшись этой проблемой пошли как приличные люди смотреть документацию если там что-то про документ Если там что-то против фрагментацию при необходимости вообще и делать в документации мы ничего не обнаружили после этого посчитали что можно теперь и помучить немножечко разработчиков задали тоже им этот вопрос Вообще что за проблема такая дефрагментации планируется ее решать и получили ответ то что автоматически дефрагментации на самом деле нет и планируется что мы сделали дальше пошли разбираться и все-таки безопас пошли разбираться из 10 подумали может быть мы что-то делаем не так начали смотреть А как же сообщество и сиди рекомендует собственно говоря проводить дефрагментацию базы в ситуациях похожих на нашу и вышли с их смело рекомендовали написать собственно говоря свой скрипт для дефрагментации эти сиди из коробки дефрагментацию умеет делать там есть специальный метод но он не запускает Ну мы собственно говоря последовали последовали советы советом мудрых разработчиков и написали своего просто из H Демона ой с hdman System deman который а-а периодически мониторит потребление базой дискового пространства и запускает процедуру дефрагментации при достижении определенных пороговых значений а на самом деле вот эта проблема Если вы эксплуатируете и строите какую-то систему управления доступом на базе телепорта она может вас подстерегать в самые неудачный момент и про неё обязательно нужно знать и её стоит учитывать Если вы такую систему управления доступом строите а но это проблема такая серьёзная но далеко не единственная Давайте теперь поговорим про более Небольшие проблемы следующая проблема Проблема связанная с прокси-протоколом второй версии что это вообще такое Когда вы строите отказа устойчивый кластер Скорее всего вы захотите перед ним поставить какой-нибудь балансировщик нагрузки например там haproxy так вот на удивление там 12 версия телепорта прокси протокол второй версии не поддерживала Хотя 11 версия поддерживала и при обновлении в какой-то момент часть нашего кластера просто рассыпалась но мы зарепортили эту проблему разработчикам они достаточно оперативно ее пофиксили собственно Теперь вы скорее всего с ней больше не столкнетесь а следующая интересная особенность которой мы столкнулись А если почитать документацию телепорта то там очень часто рекомендуют использовать Телепорт на самом деле Вместо такого VPN сервера Да рекомендуют выставлять прокси-сервис телепорта прямо в интернет и предоставляет доступ разработчикам к вашим ресурсам напрямую из Интернета но сервис телепорта который собственно обеспечивает идентификацию он подвержен доступ если сделать огромное количество подключений к этому сервису он может просто упасть на самом деле поэтому рекомендации о том что всё-таки прокси выставлять в интернет она такая сомнительная Да также у нас одним утром можно было от Антона увидеть такое тревожное сообщение в чатике в котором он призывал разработчиков и всех остальных не беспокоиться Да по разработчики уже пришли с вилами к комнате где сидит команда и Б поэтому пришлось успокаивать да на самом деле проблема заключается в том что ну глобального телепорта на самом деле есть две основные компоненты это Control Play Да который обеспечивает работу и это какие-то конечные сервисы которые ставятся на ресурсы предоставляют к ним доступ так вот разница между этими компонентами не должна превышать больше чем две мажорных версий иначе у вас может произойти непредвиденные ситуации и придется это фиксить а следующая проблема с которой мы столкнулись тоже может быть выглядит такой небольшой но тем не менее она достаточно сильно помучила Если Вы администратор который сидит опять же на макбуке то если вы захотите поставить какой-нибудь пакет Вы обязательно захотите воспользоваться пакетным менеджером для macos Blue аналог opta собственно в чем проблема Если вы поставите утилиту ты Саш из Брю то в ней по умолчанию на самом деле не будет работать Touch ID и про это нужно помнить Если вы опять же внедряете Телепорт потому что нашу поддержку которая администрирует и поддерживает Телепорт собственно говоря разработчики замучили там и догоняли примерно как папуасы Джека Воробья в известном кино поэтому это нужно учитывать и описывать в своей какой-то внутренней документации на самом деле это не Саша нужно скачивать К сожалению с официального сайта из Bios скачать не получится да следующая проблема у вас может возникнуть на высоконагруженных серверах например там балансировщиках нагрузки и так далее Дело в том что телепортент он по факту как и Агент просто слушает определенный порт только не 22 3.022 и при необходимости поддержки большого количества коннектов диапазон эфемерных портов на ваших хостах может быть сильно расширен и он может занять порт Агента таким образом надо его просто резервировать а последняя такая тоже не очень большая проблема а заключается в том что в административном интерфейсе телепорта можно видеть как у вас остаются висеть сессии которые на самом деле давно были завершены это связано с некоторыми особенностями поведения сиди данная проблема На текущий момент не решена и приходится подвисшей сессии удалять на самом деле руками И на самом деле это полный список таких небольших проблем с которыми мы столкнулись за последнее время но есть еще одна такая грандиозная проблема про которую хочется тоже рассказать что это было да нас приходили на самом деле будить уже несколько раз по ночам из-за неё она заключалась в том что при исчерпывании места на диске у пользователей просто теряются возможность там повышать свои привилегии и мы теряем возможность на самом деле вы давайте доступа туда она заключается просто в том что Что такое пользователи в системе пользователи это просто по факту строка строка в нескольких файлов Что такое привилегии привилегии это тоже строка тоже несколько файлах вот и получается что при исчерпывание места на диске вы не можете делать эти изменения вот ну и собственно не можете создавать пользователи не можете менять их привилегии и так далее это проблема она дефолтная для телепорта она там никак не решается абсолютно никак Вот и мы подумали что нужно какое-то для этой проблемы найти простое изящное решение что же мы сделали Как вы думаете Да мы просто пошли написали как бы свой по модуль который дополняет нам добавляет нам дополнительный слой аутентификации Что такое по модуль по модулю это просто линуксовый линуксовый пам который добавляет вам дополнительно какой-то логику для аутентификации вот собственно Да и собственно говоря Какие же проблемы по модуль непосредственно решает мы делали по модуль для того чтобы решить как изначально ровно две проблемы первая проблема Это собственно переполнение диска как мы уже сказали Мы резервируем место под судоверс для того чтобы можно было нормально рулить привилегиями второй телепорта есть в принципе как бы правильная но не совсем ожидаемое поведение Особенно для каких-то старых металлоинфраструктур Дело в том что после лагалота пользователя Он полностью подчищает все данные этого пользователя удаляет его То есть как бы поведение не совсем как бы ожидаемое людьми что может в принципе поломать мозги Ну и на самом деле свой по модуль добавляет вам неограниченный простор для воображения Вы можете потом прибавить к нему какую угодно функциональность и так далее И как же собственно говоря в итоге по модуль наш работает по модуль на самом деле получился достаточно простой и он вызывается ровно в двух случаях Первое это при старте сессии пользователя То есть когда пользователь у вас логинится на хост второе это собственно при окончании сессии то есть либо если пользователь вышел сам либо если мы его оборвались все либо если сессии что-то случилось Там соединением Там что-то просто сессия разорвалась вот и что происходит при входе пользователя Значит первое идет на самом деле нативная аутентификация авторизация телепорта это как бы базовый уровень мы его не изменяем незаменяем вообще ничего не делаем то есть мы как бы не влияем настроены настроенную безопасность телепорта следующим уровнем мы докладываем как бы свою логику она заключается в том что мы Для начала определяем все роли которые могут пользователю дать право на этот хвост потому что у пользователя может быть очень много ролей и с пересекающиеся областью действия и мы ищем роли которые выдают ему именно привилегии на данный ход затем из этого ограниченного множества ролей выбираем ту роль которая дает максимальное привилегии на этом Хосте после вообще такой пользователь если пользователя Нет мы этого пользователя создаем затем мы наделяем пользователя теми привилегиями которые он заслужил что же происходит при Луга у тебя прилагаете мы делаем просто мы как бы удаляем все привилегии пользователя то есть пользователи получаются такие беспроводные Да когда пользователь не аутентифицирован через телепорт когда у него нет сессии по факту ему эти привилегии не нужны мы их забираем То есть все оставшиеся время он находится там без привилегии Да и следующее Мы в принципе уже все построили Да поняли как нам что делать выстроили процессы но нам оставалось ответить еще на два концептуальных вопроса Антон собственно говоря на что завязать выдачу этих самых привилегий мы тут завязались на две такие основные вещи во-первых то какая унификация есть настроенного пользователя во-вторых А в какой среде девелопмент там или продакшн пользователь вообще запрашивает доступ и мы установили у себя там следующие правила жизни скажем так если у пользователя есть любая любое устройство для многофактной модификации это не обязательно какой-то фиде 2 устройства это может быть то он для доступа к какому-то тестовому хосту может запросить роль на суду без пароля судов паролем или без суда если оно ему не нужно то есть для этого ему достаточно любого многофакторного устройства например ТТП Если же окружение это Production то тут мы пускаем с суду без пароля позволяет получать такие роли только в том случае если у пользователя настроен на аутентификация с каким-то фиды два устройства Если же фиды два устройства нет и используются Я например только ты утп то пользователь приходится использовать сюда с паролем Ну либо не запрашивать собственно говоря отсюда Ну и целом Мы двигаемся к тому чтобы все-таки у всех пользователей которые получают доступ прот аутентификация была только по фида два устройства потому что они наиболее безопасные а как это все в итоге выглядит для пользователя мы рассказали про то как По модуль устроен какой у него алгоритм работы по какому принципу мы водоем роли как в итоге это выглядит для пользователя на самом деле нам получилось сильно упростить весь этот процесс сделать прозрачным использовать его что нужно ему нужно просто запросить роль получить ее после этого зайти на хостинг и дальше как мы уже сказали у нас есть три варианта привилегий то есть пароль отсюда без пароля и вообще без суда и в зависимости от типа выданных привилегий У пользователя будут различные пути действий первое когда пользователь получает суда с паролем то есть для того чтобы получить привилегии суперпользователя ему нужно использовать пароль ему при первом логине будет показано приглашение О том что необходимо этот пароль установить то есть далее просто использует этот пароль повышает свои привилегии затем Если точнее если у него суда без пароля то ему даже не нужно использовать пароль у него не будет показываться сообщения с необходимостью да на самом деле то есть когда мы встраиваем какую-то систему управления привилегированным доступом очевидно что она на самом деле затрагивает не только людей но и какие-то сервисные учетные записи Они же роботы они должны ходить на самом деле тоже через эту систему управления привилегированным доступом мы Для этого ввели такую сущность собственно говоря как робот это автоматика которая периодически ходит в Телепорт получает сертификат для доступа конечным ресурсам из телепорта и по ним дальше это автоматика например какой-то CCD может получить доступ на ресурсы и что-то там понастраивать а но на самом деле работать с роботами может быть не очень удобно конечным администратором такая довольно-таки сложная сущность А поэтому мы сделали построили свою ферму роботов для чего Да просто сама концепция роботов оказалась как-то неожиданно не совсем прозрачная В общем мы сделали такую штуку как ферму А это максимально простая автоматика она просто берёт сертификаты всех роботов за которыми она следит идёт и обновляет их раз в какой-то промежуток затем она берет и складывает эти сертификаты волт то есть для каждой команды там отдельные пути вот что зачем это вообще нужно было это нужно было Для того чтобы мы могли забрать в какой-то там место обслуживание этих роботов потому что как я уже сказал их обслуживание было неочевидно то есть для каждой команды теперь надо было просто пойти и забрать этот сертификат который был обновлен просто из болта что собственно никак не меняла их рабочие процессы То есть у них один секрет заменялся на другой Таким образом у нас получилось достаточно быстро перевести на телепорт вообще не сломав абсолютно практически ничего Да мы в общем-то построили кажется что наше решение написали по модуль но нас все-таки остается достаточно много мест где что-то может пойти не так Антон Давай расскажем Как бороться с этим да Ну для этого понятно что нужно ввести какой-то надежный Брик глаз механизм механизм который позволит получать доступ к конечным хостам в обход телепорта если что-то пошло не так что мы сделали для построения такого механизма тут очень важно заметить что такой механизм при этом должен быть надежный Безопасен чтобы не получилось так что есть глаз и в итоге там все разработчики ходят инфраструктуру через него как мы такой брейк-данс организовали мы оставили на конечных остатках Open Sage Но со специфичными настройками во-первых мы разрешили доступ к хостам по Иса только с конкретных хайпишников на которых находятся сервера которые контролирует б эти сервера максимально за хардные безопасные и в целом за ними там в общем следим а Это значит что мы сделали Мы подложили в настройки Open ssh сертификат сертификат сертификат для серий который позволяет собственно говоря получать доступ на эти Хосты только с помощью сертификатов которые этим сеи подписаны как конечно пользователь получает доступ туда конечный пользователь получает доступ максимально Просто он обращается к дежурному и говорит чувак дай-ка мне пожалуйста доступ после этого дежурный выписывает ему 2 сертификата первый сертификат собственно говоря для доступа непосредственно к Jum has to второй сертификат для доступа к уже конечному хосту и пользователь может пробросить сессию через Jum Host попасть на конечный хвост при этом вся эта история заход на Джам Хосты аутентификации на конечных остатках с сертификатом для экстренного доступа центр который ну такие ситуации разбирает как инцидент наверное такие важные замечания что мы никак не флоркой вообще не серверную часть мы все наши решения встают параллельно и мы никак не флоркаем клиентскую часть то есть именно Агента мы используем стандартные штатные механизмы Linux для нашего по модуля то есть на самом деле о чем мы сегодня вообще поговорили мы вам рассказали как мы построили свою систему управления привилегированным доступом на основе телепорта рассказали какие там были функциональные проблемы которые мы исправили такими своими доработками и рассказали про то с какими проблемами столкнетесь Вы если вы тоже попытаетесь такую систему управления доступом построить И на что вам собственно говоря нужно обратить при этом внимание при этом в принципе очевидно наверное чем такая система полезна для безопасников Ну может такое ещё возникнуть вопрос зачем она полезна например для команды эксплуатации и вообще Полезно ли И на самом деле тут тоже можно сказать что да полезно потому что такая система Она позволяет всегда понимать у кого куда есть доступ а всегда понимать кто собственно говоря является владельцем того или иного ресурса что позволяет повысить скорость выдачи доступа Потому что всегда опять же Понятно У кого Этот доступ нужно запрашивать И последнее чем она наверное может быть полезна не последняя О чём хочется сказать чем она сейчас будет поле да то что такая система Она позволяет в том числе более надёжно расследовать причины различных поломок в инфраструктуре кто-то куда-то зашёл что-то сломал не признаётся всегда можно с этим там надёжно разобраться и понять В чём была в итоге причина какого-нибудь инфраструктурного инцидента на этом собственно говоря всё Мы кстати активно ищем людей которые помогут нам эксплуатировать вот эту всю систему дальше её развивать вот а теперь готовая ответить на ваши вопросы коллеги Большое спасибо за Спасибо маленький президент он конференции Но первый вопрос от меня они хотели ли вы эту систему за опенсорси потому что потребность Мы ждали этот вопрос что скажешь Мы в первую очередь думали над по модулем потому что там получилось достаточно много различных во-первых по модуль Он меняет точнее изменяет там логику действия конечного Агента таким образом что он перестаёт падать Просто периодически точнее доступа отваливаются и так далее и нам виделось так что на самом деле это наверное самая ценная разработка что у нас есть мы сейчас уже переписали на оглушку и в ближайшее время я планируем концерсить Так что можно у нас наверное детали узнать после доклада ждём анонсов и Наверное сделаем доклад в следующем году как это всё-таки взлетела и вопрос Здравствуйте Я правильно понял основной смысл написания своего собственного по модуля это из-за того что место на диске заканчивается а плоховато было слышно вопрос Можно я слышал из-за того что место кончается на диске Да это Это наверное самая первая и основная проблема которую мы пытались решить но надо понимать что по модуль у вас это просто код который Вы можете а-а как бы дополнительно улучшить вы не какой-то другой потенциал в него вкладывать не хотите или у вас какие-то задумки на будущее смотрите Угу сейчас Извини тут немного дополню то что я более такой вопрос переформулирую Зачем надо было делать свой по модуль если можно просто диск разбить на 2 вольма системы Да я как раз хочу прокомментировать переполнение диска только одна из таких серьёзных проблем вторая проблема заключается в том что Телепорт по умолчанию без такого по модуля удаляет домашние директории администраторов с Хоста после того как они разлогинились это такое скажем так э возможно правильное поведение такое хипстерское Да а но э ну так применить его к существующей большой legacyber META в инфраструктуре достаточно поле достаточно тяжело потому что всё-таки админы Привыкли что у них могут быть домашние директории в которых они что-то хранят но особенности в деве и разработчики к этому привыкли поэтому изменения этого дефолтного поведения на то что после логины у тебя удаляет домашнюю территория оно усложнило бы просто из-затормози внедрения системы управления привилегированным доступом поэтому все-таки по модулю решают две проблемы не только проблему с недостатком места на диске но мы еще там планировали добавить несколько дополнительных проверок но пока еще это не в релизе так сказать но коллеги после открытия проекта на вопим сорсе вы сможете сразу написать ишью это все обсудить А у нас следующий вопрос Можно ещё вопросы Я тогда уже а про телеметрию и метрики из коробки вообще ничего не было сказано такой функционал какой-то есть там да там есть просто экспортер вот и вы можете собирать в графану там куда хотите А ещё такой вопрос Ну я люблю вообще задавать вопросы мы поняли коллеги я предлагаю всё-таки золотая другой вопрос А подискутировать мы сможем в зоне хорошо вопрос Здравствуйте коллеги ещё раз такой вопрос А где вы храните А вот сущности как пользу аккаунты роли Хосты я к чему просто по-хорошему это надо в репозитории хранить и каким-то образом это через репозиторий делать изменения вот у вас как это реализовано это все хранится ведь CD вообще вся информация о кластере подключенных ресурсах а пользователях которые есть они все хранятся в одном месте только видите сиди Если вот то есть там Не совсем понятно как это делать именно через код потому что нас инфраструктура динамическая То есть у нас там в день может подниматься по несколько сотен виртуальных машин нет конечно это можно сделать через год но мы пока подниматься Ну да если есть глобальный переезд Когда день поднимаются десятки железных серверов не смотрели в эту сторону на самом деле Почему мы в эту сторону смотрели и в том числе думали о том чтобы завязать историю с хранением пользователей в том числе на репозитории всю эту историю проектировали опять же встраивали такую большую живую инфраструктуру Мы в том числе хотели избежать того что у нас комплиментация gitla бы внутреннего которому мы там на старте доверяли не так сильно как хотелось бы не приводило к комплиментации системы там централизованной управления привилегированного доступа то есть мы в целом ее строили как такой Независимый компонент у которого там даже доступ к Q осуществляется немножко по-другому чем у остальной инфраструктуры более более как это более захард поэтому мы там не делаем А вот идентификации через кейк-луки Там и так далее То есть она полностью себе вещь в себе и полностью независимо от силы остального ответили на вопрос Спасибо за детальные ответы на следующий вопрос ребят Спасибо большое за то что популяризируйте Телепорт у меня такой вопрос а сколько телепортов для счастья нужно Ну то есть как бы Можно же поднять один Телепорт для тестовой среды разработчиков отпускать можно отдельно для обоев либо один Для всех это самый лучший выбор Как вы считаете Сейчас сейчас я по-моему вопрос был про то сколько кластеров телепорты мы подняли Да мы подняли э-э это очень сложно на самом деле вопрос мы очень долго про него только что телепортные дрио у меня такая же Бога на этот на тему этого вопроса внутри дискутировали ожесточённо бились там с нашим it в том числе на эту тему и в итоге всё-таки пришли к тому что у нас один основной кластер потому что разделение всей этой истории на несколько кластеров на самом деле не добавляет нигде безопасности а только усложняет эксплуатацию Ну потому что поддержка там десяти кластеровых вместо одного это надо все эти кластера обновлять для них нужно построить правильную инфраструктуру на которой они тепло и вероятность ошибок просто повышается так как система там критическая оба ошибок вероятность ошибок в не минимизировать А если грубо говоря в телепорте будет какой-нибудь зеруды через который можно получить доступ все равно то он будет сразу во всех там 10 инсталляциях кластера то есть Увеличение количества кластеров только увеличивает административную нагрузку но особо пользы никакой На мой взгляд не добавляет Паша может быть поправят нет спасибо большое у нас следующий вопрос Спасибо за доклад очень интересный раздел был прокин глаз я как раз хотел рассказывали спросить про проблемы яйца и курицы ваши сервера и сидишь и тоже используют эту систему Не используют то есть вот кластер телепорта он живёт у нас на Толе который администрирует команды б у которой есть доступ тому нескольких человек выделенных изб по аппаратным токенам и туда доступа осуществляется по обычному ssh и там всё максимально захарда то есть мы проблема курицы яйца избежали так собственно вопросы может быть даже рекомендация вы не думали о том чтобы Дописать свой по модуль так чтобы можно было им пользоваться если допустим пропал доступ к телепорту чтобы какому-то там суперпользователю с какими-то определёнными ограничениями там с определенных хостов или там с авторизацией по колючу фида два там давался доступ на эти сервера вы бы решили бы и свою проблему и не надо было бы напрягать безопасности и так далее и тому подобное а мы тут по модулю хотели писать Так это такое важное на самом деле замечание Спасибо за вопрос важно мы по модулю старались писать так чтобы он не мог ухудшать ту тот уровень аутентификации который по умолчает по умолчанию дает Телепорт то есть вот эта система у нас все работает Так что обязательно проходит аутентификация на уровне Телепорт ноды это тот компонент который осуществляет аутентификацию на серверах непосредственно а потом только вызывается по модулю который делает некоторое дополнительную работу и мы как бы специально не хотели чтобы наш Код э-э корявенький Да чтобы он имел такую возможность Здравствуйте спасибо за доклад у меня вот такой вопрос я не присутствовал наверное на предыдущих докладах серии да Но мне интересно а вот сколько времени заняло внедрение этого телепорта до Ну хотя бы там первые версии Да на такую систему из там десяти тысяч почти серверов и сколько времени допиливали до более-менее такой системы вот которая перестала переносить проблемы именно времени заняло это сколько тут Паша Сейчас я просто не слышно было не нет было слышно хорошо я просто пытался сейчас осознать у нас мы одновременно просто решали очень много задач у нас там достаточно гетерогенная инфраструктура и мы пытались сделать следующее Что у нас там есть куча проксов У нас есть куча куберов на самом деле у нас там еще есть внутреннее облако и так далее мы делали так что там все ресурсы подключаются Ну всегда автоматически теперь там с наливкой автоматических доступов и так далее чтобы теперь любой ресурс который создается имел владельца и инвентаризировался обязательно и чтобы к нему прорастали доступа и мы еще и эту проблему параллельно решали Просто я для того чтобы обозначить масштаб и примерно мне кажется по нашим оценкам наверное месяцев пять от начала того как мы как бы это решение согласовывали до того как мы там дописывали там нашу конечную версию модуля Вот примерно вот в таком формате и админку параллельно и аналитику параллельно как мы все это делали Примерно за полгода Да я правильно админка вообще на самом деле у нас появилась случайно То есть это я сидел просто думал было бы здорово отрисовать доступы Ну как-то как-то в общем так она появилась Потом думаю получилось а давай еще что-нибудь сделаем Давай еще чем сделаем В итоге она из такого небольшого проекта выросла Достаточно серьезный инструмент который нам позволяет решать наверное процентов 80 всех наших задач которые у нас сейчас есть меня тогда такой вопрос полгода это прям такие хорошие сроки Вот Вы прям с нуля внедряли Телепорт до этого его не было или вы как-то оптимизировали то что было другое решение сейчас скажу об этом на сервера Ну в смысле на виртуалочке он был полностью с нуля но у нас некоторые команды вопсов его использовали для доступа в кубы поэтому именно кубы нам получилось очень быстро перевести все замечание тоже Телепорт позволяет управлять доступом помимо серверов ещё губернатосу и к базам данных проектов не говорили понял Спасибо у нас следующий вопрос Добрый день спасибо за доклад У меня как у профильного дба такой вопрос Почему вместо etcd с его проблемами очевидными падения от перегрузки и прочие вот эти классные вещи его не использовать метастор в качестве метастора какой-нибудь условный пост Я думаю то что разработчики телепорта когда все это дело начиналось очень сильно вдохновлялись губернаторством и делали упор на том чтобы Телепорт был таким кластерным распределенным супер отказа устойчивым решением именно с точки зрения распределенности которая вот например там нас Телепорт кластер он распределен в 300 там куча инстансов всё это и всё это там в распределённом виде очень хорошо работает возможность такое было бы сделать там чуточку сложнее на самом деле Тоже периодически думать почему не Познер более от этого довольно много Собственно как бы да действительно чуточку сложнее но Профит значительно больше и нельзя ли подменить То есть если там я условно хочу использовать Телепорт нельзя подменить базу данных которые он использует смотрите поменять нельзя и Для нас это для начала поддерживать свои форк это значит слишком большие затраты с точки зрения человека ресурсов в целом поменять базу данных там сиди на пост пришлось бы там примерно вести репорт переписать я понял хорошо спасибо а вот еще был вопрос на четвертом и все у нас последний вопрос Здравствуйте Здорово что пошли такие бойки безопасники Спасибо вам за доклад интересует два вопроса Первый шутливый еще ближе да можно чуточку погромче очень плохо слышно да хорошо первый вопрос Смогу ли я пробросить эти порт и Если да то как если нет то почему и как все-таки это можно было бы сделать и второй гораздо интереснее вопрос Если я правильно понял то логируют действие администратора на хостовой машине в том числе команды логируются ли вы вот этих команд Что будет если например Tell минус F запущу на хорошо прирастающий Лог и если некий стоп команды по которым можно будет отслеживать превентивные действия администратора да давайте начнем наверное какой там первый был вопрос Какой был первый вопрос Да пора бросить порт можно это делается на самом деле опционально То есть вы можете запретить для всего вы можете разрешить для всего вы можете разрешить только для конкретных хостов мы пошли По модели такой что у нас в целом на уровне VPN мы заряжаемся порты У нас есть некоторые Хосты специальные жопы куда логиниться нельзя Но вы можете пробросить порты именно то есть там есть тачка идёте и пробрасываете порции в Def то есть мы таким путём пошли это что касается портов второй по второму По второму вопросу А был вопрос по-моему про то логируют целевый вывод в том числе команд Да логируется а-а телепорте достаточно оригинальная модель того как всё это история реагируется там есть три способа э первый способ заключается в том что у вас на самом деле вот это вот Телепорт нота которая заменяет Open S hdman э и выступает в качестве такого Демона для приёма Логинов он просто расшифрует на своей стороне уже видит расшифрованный трафик эпический Вот то есть на стороне прямо серверы и отправляет Телепорт А и как бы там всё нормально логируется второй способ заключается в том что вот этот самый а-а это самое Телепорт Ну да она умеет с помощью epv логировать то что происходит и позволяет собирать ещё больше на самом деле там телеметрии о том какие команды запускают и третий способ э такой наименее наименее на наименее наверное интересный он меньше всего там позволяет логировать информация он заключается в том что Вы на самом деле Телепорт можете использовать без Телепорт ноды А с обычным opens H демоном тогда у вас прагся будет расшифровывать на себе трафик и его пытаться логировать вот в таком случае я не уверен Будет ли логироваться вывод команд вывод команд тоже будет надо поэкспериментировать Паша говорит что будет как я понял да и там ещё был уточняющий вопрос про стоп команды их нет нету И вот такой возможности вообще в принципе нету Вот то есть вам придётся самим их как-то на уровне сиема отлавливать и делать триггеры а небольшое уточнение буквально вывод команд будет лежать где то есть если я запущу Тейл который мне там несколько гигабайт будет высылать логов не положат ли они классные положат это одна из проблем которую мы как раз там где доз аусервиса был это одна из них поэтому там надо это учитывать что у Вас как бы ваши пользователи могут приложить аусервис и Да хорошо спасибо большое пожалуйста друзья Спасибо за доплату у кого остались вопросы Коллеги с радостью ответит в зоне Фея тема очень очень интересно я завершаю финальную традиционным вопросам выберите лучших Я предлагаю по очереди Я бы отдал при за лучший вопрос тому кто спрашивал про количество Телепорт кластеров потому что на самом деле вроде бы вопрос простой но проблема Очень острая Если вы будете внедрять свой Телепорт кластер обязательно с этим вопросом столкнетесь и потратите немало часов на то чтобы разобраться как лучше это дело делать Пожалуйста теперь ты а я бы отдал человеку который меня спросил потому что это мне тоже запала в душу кажется где-то он там сидел Этот человек поэтому спрашивал поднимите руку а он уже ушел Давайте другого участника И все кто остался а где у нас вопрос Я знаю что вы задавали про по модуль на самом деле интересно было вопрос Давайте бы вам тоже дадим и третий еще одна да и третий и Давайте вот еще вот коллеги которые сидит в первом ряду тоже спрашивал что-то всё да все коллеги Всем спасибо"
}