{
  "video_id": "NGJQ-V6uIdE",
  "channel": "HighLoadChannel",
  "title": "Хитрости устройства офферной системы в многомиллионном игровом шутере / Лилия Крючкова (Pixonic)",
  "views": 124,
  "duration": 1907,
  "published": "2023-10-06T07:19:57-07:00",
  "text": "Всем привет Меня зовут Лиля Крючкова я из компании пиксоник и я расскажу о том как мы зарабатываем Я занимаюсь серверной разработкой пишу на javascaly в компании пиксоник я с 2017 года я не буду в этом докладе подробно рассказывать про архитектуру нашего проекта мы делали подробный доклад об этом на прошлом хайлоуиде я не буду рассказывать про настройки баз данных и не буду рассказывать про настройки облаков я расскажу как мы сделали оперную систему в нашем топовом проекте с помощью Кассандры и дома дизайн проект War robots стартовал в 2015 году наша текущие показатели 480 тысяч ццу 30 тысяч к в 2016 году у нас случился успех нас ждал вырос более чем в 4 раза и конечно мы хотели больше зарабатывать Однако этого не произошло это график нашей выручки 2016-2017 годов и Как видно несмотря на рост объем выручки существенно не изменился в то время наша выручка складывалась из так называемых прямых покупок прямая покупка это покупка в магазине за реальные деньги продукты в магазине соответствует некоторые контент Контент это монетки такие продукты не очень интересные игрокам потому что для того чтобы захотеть потратить деньги ему сначала нужно захотеть купить какого-то робота посмотреть сколько не хватает монеток затем пойти в магазин и докупить необходимые монетки а также на такие продукты накладывают ограничения магазины и самые существенные из них то что таких продуктов не может быть бесконечно много а мы хотели чтобы наши продукты более-были более гибкие И настраиваемые что же такое оффер в нашем понимании это контент интересный роботы пушки те же монетки самое главное это скидки то есть продукты теперь становятся интересной игрокам и мы можем добавлять со своей стороны какие-то ограничения например Время активности оффера выдавать оффер по каким-то критериям или мы можем создавать оффер супер выгодный оффер но ограничивать количество покупок его покупок после того как мы определились что мы хотим мы стали проводить эксперименты Вот это красная линия на графике это наши эксперименты мы хардкодили оффер с определенным контентом и смотрели как на это реагирует Наши игроки Ну и как видно игрокам поначалу это очень заходило правда потом интерес угасал но мы поняли что направление это перспективное и Нужно копать в эту сторону бизнес поставил нам задачу со следующими требованиями офферы должны выдаваться по различным событиям игрока должны быть рассчитаны на разные группы игроков они должны предлагать очень разные контент их должно быть много Ну и самое главное Они должны продаваться не только за внутриигровую валюту Но из реальные деньги у команды разработки тоже были свои требования Мы не хотели участвовать в при добавлении нового оффера на новый контент Мы хотели чтобы система была легко расширяемая и быстрая мы оценили нашу потенциальную нагрузку напомню наше социолог 30 тысяч офферов больше тысячи получается что в один момент для перебора всех офферов для игроков требуется 30 тысяч коопераций система Критична для проекта это то что нас должно кормить а значит она должна работать быстро начнем разбираться с требованиями Первое это выдача офферов выдачу офферов запускают триггеры этот некоторые действия игрока в системе которые могут собственно запустить выдачу это может быть логин повышение уровня получения робота пушки Ну и потенциально по требованию бизнеса это может быть любое изменение состояния игрока начнем заполнять наш конфиг офферов Ну пока это только айдишник и наименование триггера в реализации этого требования Нам очень помогло то что к этому времени мы уже внедрили элементы domain Driving Design во-первых это изоляция контекстов мы разделили большой стоит игрока на маленькие независимые друг от друга домены изменениями в этих доменах занимаются модели доступ к этим моделям только через изолированные сервисы а взаимодействие доменов только на уровне бизнес-сценариев Ну и второй элемент очень для нас важный это то что модели изменяют свое состояние с помощью событий это примеры наших доменов Ну во-первых это контентные домены игрока роботы пушки и во-вторых это может быть какие-то служебные домены те же офферы платежи бои и так далее ну схематично это работает следующим образом у нас есть модель роботов игрока у нее есть несколько действий добавить прокачать продать каждое действие генерирует какое-то событие которое модель собирает и в конце бизнес операции они преобразуются и записываются в базу а также отправляются которые перенаправляет их подписчикам если таковые есть вернемся к офферам оффер который выдан игроку будет иметь следующий атрибуты Player ID offer ID время когда выдан время докуда валиден время прочтения чтобы убрать красный восклицательный знак из интерфейса Ну и операции которые с офферами возможны это выдать оффер пометить прочитанным и конечно же купить Так мы определились с тем как наши данные выглядят Давайте посмотрим как мы их храним В качестве базы данных мы используем кассандру в этом докладе я буду упоминать только те свойства Кассандры которые имеют непосредственное отношение отношение к теме доклада Кассандра это Киева или хранение Кассандра это быстрая запись и это отсутствие полноценного что вообще значит Киеве или хранение это очень похоже на мапу то есть по ключу хранится какое-то значение вот Кассандра Это то же самое только чуть-чуть сложнее ключ становится композитным А в качестве значений может быть кортеж значений мы используем две схемы хранения наших данных Первое это очень похоже на реляционную табличку в колонках хранятся атрибуты различных типов а вторая схема здесь мы храним атрибуты не горизонтально а вертикально то есть наименование атрибуты уходят в ключ уходит ключ Кассандра гарантирует атомарность записи в рамках партиции то есть второй вариант хранения подходит для случаев когда можно Независимо можно параллельно обновлять атрибуты одной и той же сущности Независимо с разных серверов в подавляющем большинстве случаев мы используем первый вариант немножко модифицированный в качестве мы храним Джейсон таким образом со всеми необходимыми атрибутами Таким образом мы получаем унифицированные операции чтения и записи и гарантию консистентности данных партиции вернемся к нашим офферам у офферов будет две сущности в базе первая сущность это сам оффер игрока с ключами Player ID offer ID Ну в джейсоне даты и платежи офера с ключами плеер ID и композитный ключ из оффера ID ID транзакции Так мы Я показала как мы храним наши данные Давайте теперь я покажу как мы их пишем для записи мы используем паттерн юнитов Fork этот паттерн предполагает сбор всех изменений в процессе бизнес сценария чтобы записать их в базу только в самом конце Таким образом мы получаем нечто похожее на роллбэк в случае если происходит какая-то ошибка мы просто все изменения забываем ничего в базу не пишем схематично это выглядит следующим образом нас есть объект юнитов которые создается в начале бизнес-сценария у него есть два метода зарегистрировать модель и зафиксировать изменения в процессе бизнес сценария модели регистрируются в юнитов орке собирают события которые с ними происходят А когда бизнес сценарий заканчивается и изменение нужно зафиксировать юнитов Форт проходит по всем моделям перебирает все события записывает их в базу и отправляет в eventbus Казалось бы на этом все про то как мы пишем но нет и обусловлено это нашей архитектурой У нас есть несколько http Java серверов которые общаются с кассандрой есть балансировщик который раунд Робином распределяет запросы от клиента на сервера Таким образом мы имеем постоянные конкурентные запросы на запись от одного и того же игрока это могут быть одни и те же запросы а конкурентная запись это конечно плохо и очевидное решение здесь использовать синхронизацию но Синхронизация это всегда недешево и мы конечно тоже ищем пути Как это синхронизации избежать Ну и в ряде случаев нам здесь помогает как раз Кассандра внезапно Кассандра пишет быстро и если получится спроектировать бизнес сценарий таким образом чтобы результат операции получился и дымпотентным синхронизация нам не потребуется Сейчас я покажу как это работает с офферами для примера возьмем оффер который продает робот индустрии и разберем сначала сценарий выдать offer этот сценарий изолирован в рамках домена то есть будет сгенерирована только одно событие которое изменит только одну сущность в базе и вот таким образом оффер этот Avent событие будет записано в базу Ну то есть в Ключах Player ID наименование офера и Джейсон с датами по требованиям бизнеса у игрока в один момент может быть только один offers идентификатором offer ID это ключевой момент Потому что если прилетит второй запрос на добавление того же самого оффера то эти записи просто схлопнутся по ключам совпадающим ключам получается результат этого бизнес сценария и демпатентный и синхронизация Здесь нам не требуется бизнес-сценарий оффер прочитан здесь на самом деле все то же самое записи будут схлопнуты по ключам и тоже здесь не требуется синхронизация А вот бизнес-сценарий купить офер он другой он чуть-чуть сложнее он затрагивает несколько доменов Ну во-первых это домен офферов нужно сделать информацию о том что был совершенно платеж и во-вторых это какой-то контентный домен в нашем случае это домен роботов для начала разберем операцию записи информации по платежам Здесь тоже все уже нам знакомо записи будут хлопываться по уникальным ключам то есть будет одна запись в базе о проведенном платеже а вот доменом роботов чуть-чуть по-другому роботов Мы храним в таком виде у нас в качестве ключей Player ID и ID робота А в jsonia для простоты просто Тип и уровень но у игрока может быть несколько роботов одного типа то есть вот здесь у игрока два робота-дастрира один первого другой пятого уровней и на самом деле нам ничего не остается кроме как хранить в робот ID гуиды Поэтому если прилетит два параллельных запроса на добавление одного и того на добавление робота destria первого уровня но с разными гуидами они не схлопнутся в базе в базе будет две записи о том что игрока есть два робота-дастрира первого уровня получается результат этого бизнес сценария В общем случае нельзя сделать импотентным мы не выдавать несколько роботов за одну покупку А значит здесь нам требуется синхронизация для синхронизации мы используем два механизма это распределенные Локи на звукипере и evensorting в подавляющем большинстве случаев мы используем распределенные Локи Но на самом деле просто потому что sevent Surfing в кассандре очень сложно расследовать какие-то Корнер кейсы потому что в том числе потому что в кассандре нет возможности строить сложные запросы Ну Лог Мы берем при в начале бизнес сценария при создании юнитов орка и в конце бизнес-сценария его отпускаем соответственно наша архитектура на самом деле выглядит более реально вот так то есть наши http сервера еще из кипером общаются Так мы Я показала как мы реализуем наш первое требование от бизнеса Поехали дальше офферы должны быть рассчитаны на разные группы игроков Согласно требованиям бизнеса игроки должны распределяться в группы по многим критериям в том числе например Это уровень игрока страна боевой рейтинг рейтинг наличия отсутствия пушки суммы платежей за последние дней Ну и так далее здесь Мы приняли решение сделать гибко но менее удобно то есть мы предоставили доступ к нашим доменам через скрипты груве оператором монетизации чтобы они могли указывать условия распределения такие какие им только придут в голову для защиты данных мы дали доступ не напрямую к доменам А через адаптеры а также на этапе компиляции скриптов груве мы ограничиваем доступ к классом и пакетам Это пример конфига группа распределения здесь видно что в целом эти условия довольно читаемые их можно задавать довольно сложные Ну а в конфиге офферов нам остается только добавить еще одну колонку и указать там ID группы в которую должен попасть игрок чтобы ему выдался этот оффер с этим требованием разобрались Ну офферы должны продавать различные контент поэтому требования бизнеса Ну и не только бизнес и разработки к контенту было чтобы он был Легко расширяем легко конфигурируем и переиспользуемым здесь на самом деле мы поступили по классике У нас есть абстрактный класс контент прото от него наследуется конкретные прототипы Карен прото робот протону и так далее есть иерархия классов процессоров которые могут выдавать этот конкретный контент осталось только собрать в реестр эти процессоры чтобы выбирать нужный когда это потребуется получается что для добавления нового контента требуется реализовать новый контент-прото и добавить новый процессор это фрагмент конфиго контента здесь в первой строчке указано указан контент в виде 40 миллионов монеток серебра во второй 1000 монеток золота в третьей строчке Мы указываем роботы он слота первого уровня но в последнее это пушка 12 уровня в таком виде мы задаем контент для всего проекта то есть также мы задаем контент для сундуков для лотереи и также мы задаем контент для наград в постах Ну а в конфиге офферов остается только через запятую указать нужный нужный контент который будет продавать а я показала как мы реализуем третье требование поехали к самому интересному бизнес говорит что офферов должно быть много Ну и первое что мы сделали помня Про наш тцу Мы решили сократить количество офферов которые будут прогоняться через скрипты груви Ну на самом деле здесь мы поступили Просто мы просто вынесли уровень игрока и даты активности оффера из критериев группы распределения в основной конфиг Ну и Сначала по этим колонкам отбрасываем офферы которые точно не подойдут игроку Ну там остается порядка 100 штук 100 офферов вот их уже Мы прогоняем через криптогруве еще мы оптимизируем работу с конфигом все наши конфиги хранятся в памяти полностью готовые к использованию скрипты груве мы компилируем при загрузке конфигов И они также хранятся в памяти И еще мы придумали положить конфиг в юнитов форк для того чтобы доступ к конфигу был более простой и удобный юнитов мы создаем вот следующим образом у нас есть фабрика которая знает про провайдер конфига в этом провайдере есть только один метод отдать конфиг класс имеет два поля версии и конфиг и по таймеру он ходит в базу считывает версию и если версия изменилась зачитывает весь конфиг поэтому когда фабрики нужно создать новый юнитов Fork она забирает провайдера текущую версию конфига текущий конфиг и передает его в юнитов орг Мы не перечитываем в процессе бизнес сценария конфиг То есть он считается валидным до конца жизни юнитов орка еще мы оптимизируем данные работу с данными игрока для этого мы используем распределенный кэш на основе хозяйкаста репозитории когда ему нужно загрузить какую-то модель сначала Проверить наличие значений в каше и только если они отсутствуют пойдет в базу загружены в модели Он положит в юнитов Fork это график попадания в кэш домена офферов мы запускаем новые офферы каждый день в 9 утра и в это время попадание в кэш падают до 40 процентов к концу дня офферы попадание в кэш офферов достигает 85 процентов еще иногда в течение дня нам требуется докинуть какие-то офферы это тоже вызывает падение попаданий в кэш это конечно не самый идеальный график попаданий в кэш У нас есть домен который ведет себя гораздо лучше это домен пушек игрока и Как видно он более чем в 95 процентов случаев попадает в кэш но это и не худший пример у нас есть кандидат на худший результат попаданий в кэш вот этот домен более чем в 50 процентах случаев не попадает в кэш и его мы будем просто отключать для экономии ресурсов это график нашего rps к офферной системе конечно максимальное значение в 9 утра 321 операция в секунду средние значения 120 операций в секунду это график клиентских запросов к офферам это 99 средние значения 70 миллисекунд максимальные 175 здесь захвачен период в 9 утра и Как видно в 9 утра У нас как раз пиковая нагрузкой и Как видно график существенно не меняется то есть Старт новых офферов не напрягает систему не напрягайтесь тем усиленно заканчивая разговор про быстродействия Давайте посмотрим еще один график это летонси нашего самого тяжелого клиентского запроса это запрос лобби игрока и наложим на него график попадания офферов в кэш Ну и посмотрим что происходит в 9 утра Ну как видим не зависит Ну то есть совсем не меняется от того попадаем в кэш или не попадаем А значит мы можем быть уверены что наша офферная система не оказывает существенного влияние на прочие части системы Так мы разобрались с нашим четвертым требованием Поехали дальше бизнес говорит что офферы должны приносить деньги Поэтому мы интегрировались с несколькими магазинами AppStore Google Play Amazon Steam My Games типовой процесс покупки выглядит следующим образом клиент с ID продукта идет в магазин происходит оплата магазин возвращает квитанцию это квитанции клиент идет в на сервер и сервер выдает купленные вроде бы все просто но в чем же проблема Проблема в том что никто не может быть застрахованным от человеческих ошибок Однажды в течение нескольких часов мы не могли выдать игрокам купленное просто потому что уже был загружен некорректный конфиг а также нужно не забывать что время на банковскую операцию это не моментально это может длиться три дня и больше ну и конечно может быть могут быть недоступны сами магазины для решения всех этих проблем Мы решили добавить еще один этап у нас в наш процесс покупки то есть сначала игрок идет на сервер сервер сохраняет snapshot продукта который игрок видел перед покупкой и возвращает айдишник этого снапшота дальше затем айтишником и ID продукты клиент идет в магазин происходит оплата магазин возвращает квитанцию и с этой квитанции клиент идет на сервер сервер выдаст купленная только если будет найден продукт snapshot продукты который видел клиент если будет найден то сервер вернет ошибку и клиент игрок может обратиться либо в грамм Саппорт либо оформить рефанд но надо сказать что случай когда отсутствует snapshot Это не то что в подавляющем большинстве случаев всегда говорит о том что это какое-то мошенничество со стороны игроков Ну и вот это один из примеров У нас есть оффер так называемый стартер Пак который предлагает игрокам на низких уровнях очень классный контент за дешево Ну и некоторые Наши игроки догадались что Если завести себе второй аккаунт в игре по той же Google или Apple четкой получить там офер тыкнуть купить выключить wi-fi переключиться в основной аккаунт то покупка приходила именно туда Ну а теперь сервер говорит Нет ну и игроки в общем-то перестали пользоваться этот вариант мошенничества мы рассмотрели все требования ОТ бизнеса Давайте посмотрим что у нас получилось в результате мы можем легко заводить новые офферы можем задавать сложные условия распределения офферов У нас есть универсальные механизмы универсальные механизмы конфигурирования контента требуется минимальное участие разработчика при добавлении нового контента Ну и наша система быстрая это наверное самое интересное график во всей презентации это объем выручки наших офферов с момента их полноценного запуска Как видно за годы она не упала только растет сейчас она составляет более 90 процентов от общей выручки остальное остальной вклад делают Продажи от прямых покупок мы не хотим останавливаться на достигнутом Мы хотим упростить жизнь команды монетизации внедрив алгоритмы машинного обучения для выдачи офферов нам не нравится пессимистичные блокировки на кассандре Мы хотим внедрить аквастер шортированием по игроку для решения этой проблемы и еще мы хотим синхронизировать алгоритм и распределения в каше и авторов лака кластеры для сокращения сетевых расходов Ну какие же выводы можно сделать всегда нужно прорабатывать сценарии конкурентного доступа Ну во-первых это конечно помогает избегать досадных ошибок во-вторых может открыть неожиданные пути оптимизации пути оптимизации конечно тоже нужно всегда искать это делает систему устойчивой к нагрузкам Ну и если Вы только собрались делать офферную систему у себя нет смысла делать сразу сложный highload начните с простого это даст вам представление о потенциале системы Спасибо за внимание по qr-коду можно оценить доклад и оставить комментарии А я с удовольствием отвечу на Ваши вопросы Спасибо за доклад такой вопрос сейчас заблокирован Google Play Apple Pay в России и как сейчас пользователи могут задонатить в игру а на этот вопрос я не смогу Вам ответить сейчас это довольно сложный мы сделали Work Round вот мы можем это обсудить после хорошо у нас есть дискуссионные зоны если что и там можно вот такие неудобные вопросы обсуждать так спасибо спасибо за доклад вопрос Следующий офферной системы интересная но планируете ли вы ее развивать в обратную сторону то есть не для бизнеса а для пользователя допустим он все время отклоняет ваше предложение по какой-то причине собираете ли вы метрики с этой стороны планируете или там допустим менять ему предлагаемый контент или еще как-то адаптироваться то есть она сейчас работает на это Если нет то Будет ли работать в будущем смотрите сейчас она работает в ручном режиме на эту проблему Он решает в ручном режиме у нас когда офферы когда система решает какой оффер выдавать игроку она учитывает там наличие или отсутствие у игрока каких-то роботов такого-то контента также там есть критерии покупал или не покупал игрок такой-то оффер там до этого то есть на самом деле мы пытаемся правда в ручном анализировать Ну наши операторы монетизации анализировать что действие игрока для того чтобы предложить ему оффер который с большей вероятностью купит то есть вся аналитика сейчас выполняется человеческим ресурсом Спасибо раз раз Спасибо большое за доклад по моему восхитительная система очень технологичная поэтому может быть мой вопрос покажется неудобным как но я немножко поговорил на стенде с нашими ребятами про фреймворк сингулярити которые вас строятся Для более молодых проектов и собственно возникает вопрос почему не перенесли туда вот кассандрусингом 2015 год проекту даже больше но невозможно на самом деле перенести код там есть особенности например какие-то сундуки как-то там особенно работают пушки титаны вот эту логику перенести очень то есть это заново написать в этом нет смысла скорее не логику А сам подход хранить хассандре сортингом вот этот момент почему поздности выбрали как более простой вариант почему выбрали пост для сингулярити испугались может быть что разработчиков не найдут на кого достаточно высокого уровня на кассандру Ну да нет На самом деле это все очень ну как бы это несложно Нет проблем постигнуть вот это все То есть как бы не это причина но мне просто на самом деле кажется что мы у нас как раз было уже у нас был проект на War robots который на кассандре Ну в целом он показал себя хорошо но вот есть некоторые неудобства от того что это Кассандра хотя она там очень стабильная очень быстрая с точки зрения там Записи масштабируемость но определенные неудобства есть и мне кажется Когда решали вопрос что делать потому что в общем-то других Ну я не знаю мне кажется нет причин особенных использовать кассандру все-таки не такие масштабы у нас Большое спасибо так друзья не стесняйтесь еще вопросы подарок за самый лучший вопрос очень классный Ну что тогда если вопросов больше нет Я предлагаю выбрать вопрос который тебе больше всего понравился Ну наверное вопрос про кассандру почему тут Кассандра там поезд Грис отлично за кассандру подарок у нас будет очень классный подарок от selectel наверное все догадались что это такое Стань пожалуйста чтобы наши помощники могли его тебе вручить Спасибо большое за вопрос и тебе огромное спасибо за эту тему потому что действительно интересные сложные темы и у нас для тебя тоже есть небольшой презент от конференции холод тоже маленький подарок Спасибо большое Друзья давайте поаплодируем линию Спасибо"
}