{
  "video_id": "A6w_7QZGgrg",
  "channel": "HighLoadChannel",
  "title": "Как работать с секретами в Golang, чтобы минимизировать хаос / Сергей Киммель (Quadcode)",
  "views": 1745,
  "duration": 1800,
  "published": "2023-01-19T07:01:39-08:00",
  "text": "всем доброго времени суток доклад и начну коротко рассказов о себе за 10 лет работы войти успел поработать как стартапах так уже устоявшийся компаниях прошел путь от обычного разработчиков до руководитель отдела в котором более там уже 25 человек за это время успел порешать как обычная задачи так и задачи связанные с высокой нагрузкой с real-time обработкой там market данных и много чем еще я могу все долгой свет так рассказывается что давайте уже будем переходить к следующему слайду в чем собственно проблема момента секретов да то есть если вообще в этом проблема чтобы ответить на эти вопросы я проведу вас через небольшой экскурс того как у нас развивался менеджмент секретов нашей компании с какими проблемами столкнулись начну нас все начиналось так же как у многих далеком 2012 году у нас стартовал проект который основная разработка велась в одном git репозиториев это был php там лежали все секреты связанные со всякими а фишками и базами данных нашими проект очень активно роз мы активно пилили фичи принципе задумался о том где хранить секреты как хранить у нас времени не было и мы вообще не считали это какой-либо проблемой это намного важнее катить быстрее все впрок следующим этапом у нас было это появление так называемых микро сервисов многие уже наслышаны о них мы начали уже распиливает нашу наши репозитории на несколько отдельных репозиториев и предметным областям за которой они ответственно часть из них так и осталась на php и там просто были скапе пачино все секреты мы даже не задумывались что где использовалась то что надо активно анализировать код и понимать что еще используется что нет и другую части в историях мы сразу же попутно переписали магазин к тому же хотя бы секреты вы нескольких переменные окружения стало чуть получше но все равно при появлении нового микро сервиса нам нужно было соответственно какие-то секреты крепости же в но в репозитории в переменное окружение то есть создавался уже вот такой вот эффект того что мы уже начинали терять терять контроль ним они многого того что где какие секреты лежат что вообще используется даже была попытка завести небольшое excel файле в котором мы вели здесь этот учет ну этот инициатив очень быстро заглохло потому что не могли найти собственно ответственного который бы так сказать отвечал за актуализацию этого файла поэтому в этот файлик быстро вышел из обихода у нас и сути мы также не замечали в проблему большой секретами ну не замечали мы их до тех пор пока кто-то не слил наши как дальше выходной запишет что произошло до в один из дней мы пологом заметили что у нас свалится ошибки о том что мы упираемся в лимиты по а пешком мы зашли даже личный кабинет и этой пешки и посмотрели что вообще за какие методы используются и понял что некоторые из них общем и и когда и не использовали то есть новых релизов нас не было то есть каких-то увеличения трафика вас тоже мне наблюдалась по пользователям поэтому стало понятно что кто-то скомпрометирована шашлыка пьют к этим а пешком поэтому нам надо срочно выпускать новые обновлять их во всех сервисах собственно здесь и начали с иные проблемы что первых мы не знаем в каких сервисах какие секреты используются ну и вторая проблема вообще в том что как быстро их поменять чтобы не полнее поломать axe все качну все полностью так что хотя бы благодаря метрикам и logo мы смогли выявить и сервисы которые сительно вас вышли из строя из-за того что перес лимиты туда pink мы прописали новые секреты и перезапустили эти сервисы стало полегче все отпустила мы немножечко вы вдохнули стала прямо очень хорошо вот и мы решили мода аппарата давать старые cargill и в том собственно и сделали после этого еще obara сервисов упала которые нас не упирались и лимиты при этом мы не знали о том что к станете секреты использовали этому тоже быстро побежали там тоже поменяли все эти секреты на новые и также перезапустили уже ближе к вечеру наконец мы выдохнули руки уже писали уже трястись весь этот монтаж прошел у нас что считали почти весь день у нас сервис то скотину не выполнял свои функции соответственно тоже большие потери для бизнеса поэтому здесь мучительно поняли что она нам пора наводить порядок на секрета в том что и с ростом проекта нам будет все сложнее и сложнее решать такие инциденты посовещавшись с коллегами целом мы пришли к следующему выводу что нам все-таки надо поднимать централизовано хранящий секретов чтобы у нас все наши с интуитивной информации находилась в одном защищенном месте в нашем случае мы выбрали вот есть хаш окопа проект продукт название world то есть выбрали его hail велите версию развернули заранее сразу же договорились с коллегами о том как мы будем миновать эти секреты то есть у нас правило простое было что мы вначале имени секреты обязательно должна присутствовать имя сервиса который использует данный секрет что простая договоренность нам позволило создать этот связующее звено между сервисом и секретом который он использует то что вот это очень сильно не хватало при том инциденте ну и постепенно все наши сервиса мы уже перевели на то чтобы они забирали секреты при старте из хранилище секретов и в целом у нас наконец появился появилась возможность контролировать эти секреты то что все находится в одном месте и мы знаем какому сервису какие секреты относятся мне были бы инженеры мисс и бы все-таки и не провели да насколько обсе помогает новое решение поэтому решили воспроизвести достать искусственная ситуацию с тем что как будто вы опять у нас кто-то съел креды к одной из записок вот выбрали всего одно в качестве испытуемого тесно выпустили новый край дальше вы прошлись по всем притчам хранилище секретов нашли где эти города решил это сказать к на примете раваны использовались обновили там секреты уже на новое значение и так спокойно перезапустили сервисы сервисы стартанули все хорошо и потом отозвали старый когда шел и также сервисы не вышли из строя том что все везде обновилась все три подтянулась то есть сам результат на в целом устроил да несмотря там научную перезапуск поэтому следующим шагом наш инженерная душа рванула в сторону того что давайте ещё попробуем сделать что в сервисами узнавали о том что секрет обновился и собственно попробовали на одном из сервисов добавили туда возможность периодического запроса в расход корпус кинаш world то есть суть простая там каждую минуту я просто находили болт и забирали текущее значение секрета и сравнивали с предыдущими сама меня было отличалось от предыдущего соответственно мы приложение как-то реагировал на это зависимости от того какая там у него логика была в одном и тут же сразу уперлись в особенности безопасности volta что у него в три тонны токена имеет время жизни поэтому через 15 минут у нас с этаким прыгнул таскать приставал быть валидным из-за чего мы уже не могли забирать новому делать запросы к пии болта нам надо было три либо перевыпускать токен либо продлевать и время его жизни немножко за час документацию мы сделали добавили войку продление аренды токена принципе да тоже помогло но где-то на месяц потому что все-таки у артрит сонных токенов есть и максимальное время жизни бал стену по молчанию это равно около тридцати двух дней где-то через месяц мы столкнулись с этим сюрпризом он так что это тоже стало таким неприятным моментом для нас ну повезло что это был только один сервис этом сильно у нас не затронула и попробовали пойти ещё дальше давайте еще сделаем логику то чтобы еще перевыпускать и т.д. авторизационный токен и и но вовремя остановились то что поняли что в тридцать talking все тот же секрет получается с которым тоже нужно как-то управлять следить за его затем чтобы его никто не слил либо перевыпускать периодически поэтому решили отказаться от этого решения и остаться все-таки касс вариантом что пока будем перезапускать сервиса и пошли дальше думать на будущее что делать и пришли пока к двум основным вещам что первое это нужно все-таки добиться этого варианта когда можем отказаться от манипуляции всех стран токенами из приложения потому что эта сеть мы очень большая дополнительная работа которую бы не хотелось пихать в приложении если усложнять его этим ну и второе достаньте стандартизовать механизму уведомление для приложений в том что вообще секрет обновился потому что без этого то есть даже если все вот этому про нету что вы хотели сделать сделали мы бы не были уверены в том что вообще сервис получат эти новые секреты чтобы что мы будем сто процентов уверены что секреты везде обновились ничего новых стартовать не надо так теперь давайте перейду уже в технической части доклада сейчас я расскажу про основные варианты организации работы с секретами которые являются выжимка из нашего опыта в компании все эти варианты в принципе использовали или продолжают даже сейчас использовать наши компании вот естественно у каждого из вариантов есть свои плюсы минусы которых расскажу ну из а заранее скажу что к сожалению варианта серебряной пулей тут не будет первый самый такой стартовый вариант это хранить секрет их переменных сайту линга суть здесь на схеме изображено в том что на в блоке связь эту лингам есть специально выделил блоки с секретами для стайлинга для продаж ну то есть для каждого окружения вы получается все это линги web-интерфейсе не знаю в конфиге зависимости от того какой вы себе turn будете использовать вам надо будет соответственно прописывать эти секреты ты уже при тепло и приложение вместе с приложением все touring кладет в контейнер или 8 на сей раз сами секреты и уже ваше приложение используется секреты даже не подозревая о том что их кто-то туда подложил вот здесь вот акцентирую внимание о том что секреты не находятся в коду территории это очень плохая практика не советую общее следовать тому что вы тихо секреты в репозитории с кодом наш опыт надеюсь вам показал чем это может может стоить ну и давайте перейдем к плюсам и минусам данного варианта первый плюс это собственно самые такой жирные что можно быстро вам девять проект то есть судя для стартапов это вполне хороший стартовый вариант с него можно начинать потому что он в как его 2 + не требнике до этих ресурсов вам не нужно поднимать эти сервера ничего не на то что вас секреты по сути границы стал вашим все риту линги в его базе на его серверах поэтому какие-то до при сусов вам не потребуется но имелся естественно есть это основной корневой минус что есть восстановится больше чем один репозитории с кодом то здесь уже начинаются те же самые сложности что были у на что у вас начинается дублирование секретов они лежат нескольких местах чем больше вас репозиториев тем сложнее вам за всем этим делом следить ну и соответственно если нужно какие-то секреты будет обновить то это опять же не удобно то что вам нужно по каждому репозиторию бегать смотреть переменное окружение той всякие там это дело все обновлять следующий вариант является сказать в лицом ноготком предыдущего допустим когда уже осознаете что вам все-таки нужно кое централизованное хранилище это нет собственно можно переходить к этому варианту здесь вот на схеме краски он изображён уже отдельно и колечко это в куда featuring восходит при тепло и забирает оттуда секрет и также из кладет вместе с приложением на север а здесь вот основное отличие в том что теперь секрет у вас хранятся не сайту линги централизованным хранилищем какие же здесь плюс у нас первый же важный плюс это секрет лежат в одном месте теперь нажми секретов гораздо проще упрощается потому что вы можете спокойно искать по хранилище секретов производить аудит доступа к этим секретом то и да давай только там к чему можно давать доступ ну и второй плюс что это изменение носят вариант вообще не требует каких-то сильных изменений в коде вашего приложения максимум только лишь вам нужно будет немножко подправить вашу диплом q чтобы она уже брала секрет они из переменных окружения своих доходило входящие секретов и сыграла их оттуда ну и минус естественно тут есть тоже что раз поставляется отдельно хранилище секретов тайм серебра подниму нужно разворачивать прошу прощения и и поддерживать вес на это тоже ресурсы но чисто мое мнение что они того стоят верьте лучше немножко потратиться что потом и заплатить еще больше большую ценам и еще небольшой минус для тех у кого именно используются какие-то публичные сайты типа travis и сайкл вся этого подобные что он здесь надо будет еще ломать голову как безопасно открыть ваше хранилище секретов на внешний мир хорошему конечно ваших отлично должно храниться где-то у вас внутри вашей 2 структурой и должно быть максимально защищены от внешнего воздействия давайте перейдём к следующему варианту он больше уже подходит тем у кого и приложение работают да уж и в таких вот регистраторах контейнеров на как кабинет с и докер здесь суть заключается в том что в самом этих регистраторах есть уже встроенная функция работая с хранилищами секретов как минимум элтон точно насколько я знаю вот тут простая как на схеме забавно что у вас при тепло и артиста торги забирает также необходимые секреты из хранилищ и подкладывает их также в контейнеры с приложением если приложение также работает и даже не подозревает что есть какой-то хранилище секретов и оттуда оказывается кто-то ему положил секреты также плюсами здесь также является что секрет лежат в одном месте я уже упоминал и вот повторяться вот так же не требует изменит приложение то что по сути для как пас на схеме здесь было видно что приложение общей никак не взаимодействует с сохраняющим секретов для него все работает как и прежде также кто-то либо под к эллады этому в конфиг ли вы в перемену окружения что это очень тоже удобный вариант ну и минус естественно тоже есть опять же все тоже нужно поднимать инфраструктуру для работы хранилища секретов и тоже такое весьма увесистыми нас то что и вас все-таки все вся инфраструктура по-хорошему приложения должна работать купер на этой силе в докере то есть без этого вы уже теряете определенные преимущества данного варианта то что сбу что-то работать в кубе что то будет не в камере максимум придется и частично принять один вариант в кубе и другой вариант невку бери что создает то же строение удобства мы последний такой самый навороченный вариант когда приложение забирает из хранилище секретов то здесь вы получаете максимальную гибкость работы сохраняющим секретов но тут тоже есть своя цена собственно в плюсах минусах и по ней расскажу здесь главная на схеме хочу акцентировать внимание ваше что приложение самого получается уже авторизуется хранить до выписки хранилище секретов и забирает самостоятельно эти секреты из хранилища и здесь тесно плюс солнце том же является что вас есть централизованное хранилище секретов которым все хранится не очень легко это все можно менеджер и вторая плюшка очень такая по крайней мере полезное с моей точки зрения что вы можете производить аудит запросы в хранилище секретов тем сам можете понимать какие секреты используются реально по факту да какие уже просто лежат мертвым грузом хранилище секретов и их уже просто давно не использовать то что забыли туда удалить ну или по ошибке завели так что это тоже такое плюс на не знаю насколько он вам будет полезен и но и минус естесно тоже тут увесистый за того что все таки за такую гибкость наворочено сть возможности непосредственно общаться хранящейся деток использовать его возможности вам вы можете очень сильно усложнить работу вашего приложения поэтому здесь нужно быть очень максимально осторожным и не ну не наворотить кучу всяких там штук лучше как-то в рамках всей компании договориться какие возможности будете использовать и можете это как-то оформить в виде отдельные библиотечки которые вас в сервисах будет вашей компании использоваться потому что иначе вы можете прям огромный запах себе развести ну и второй минус то что я упоминал из нашего опыта что нужно как-то решать вопрос авторизацией то есть здесь это такое будет хронический it off использовать но на переслал там учитываете наш опыт все-таки поизучайте более детально этот момент потому что этот минус может вам очень сильно попортить жизнь а может и нет может вы найдете решение получше потом напишите мне покажете буду рад услышать почитать но не последний минус тоже нужно разворачивать необходимо до окружения для работы хронических это здесь только подчеркнул момент здесь жирного специально выделено что должно быть именно отказоустойчивых они счета что своими с предыдущими вариантами где есть восходящий можно было вывести обслуживание и при этом ваши инфраструктура не упадет и продолжить работать до здесь уже это будет не совсем получится то есть вам нужно все-таки поднимать для этого варианта отказоустойчивые решения то есть дело с уже будет работать какой-то кворум из нескольких серверов что вы могли спокойно выводить обслуживание какую-то часть потому что приложение вас напрямую будет ходить хранилище секретов если вдруг она будет недоступна ваше приложение тоже не запустится если вдруг кто-то захочет за тепло и например в этот момент ну думаю наверняка уже многие задумываются вроде как и ответка в конференции посвящена голлинга но что-то ничего про гаван пока не сказано сейчас я компенсируя недостаток сейчас я немножко расскажу вам покажу точнее даже небольшой кодовый выжимку того что собственно у нас да какая что в рамках года мы такие выводы сделали возможность много из этого вам пригодится сразу кусали что это не какая-то прямо истину в последней инстанции не надо прямо к крепости этот код используя проекте просто тоже поглядите переварите для себя какие-то выводы сделайте может быть какие-то там тоже минус увидите и улучшить и даже то что мы сделали ну давайте начнем с получения секретов здесь вот на небольшой листинг изображен здесь что зная основная суть в чем что нужно просто сделать простой интерфейс который да у вас будет на капсуле вать работу по работе с секретами здесь максимально простой один единственный метод друзей си есть который красно вход принимает имя секрета да и на выходе возвращает этот секрет либо ошибки вдруг что-то пошло не по плану здесь важный момент который хочу акцентировать ваше внимание что здесь метод get секрет боится возвращает специальными тип да то есть он ниже тут объявлен это сделано специально не пашет почему я расскажу на следующем слайде вот а здесь и на про самый метод get секрет бойцы так акцентирую внимание что его лучше вызывать непосредственно в том месте где вы хотите использовать до секрет то есть лучше следовать принципу потребовался секрет вызвали этот метод получили значение секрета воспользовались непосредственно в том месте где этот секрет нужен где-то его сохранять какой-то глобальной переменной потом использовать не лучшие варианты то что иначе тогда у вас механика обновление секретов будет очень сильно хромать и собственно теперь про этот тип байт здесь он сделал для того чтобы вязать такую очень простую защиту от утечки секретов влоги чем просто плох обычно слайс байтов лист young то что если вначале нападет блоге либо в трейсер ваш но еще какие-то технические ваши dash этом блоге да он ужасно может потом постепенно вас утечку дата вовне поэтому здесь сделал специальный тип бойцы который комментирует здесь интерфейс стрингер который при попадании формате лаггера у вас вместо содержимого секрета просто заблокирует слова фразу сенситив да это все если вам действительно нужно получить назначение секретов то соответственно есть второй метод байтс который уже возвращает непосредственно до осла из байтов вот его тоже нужно золотить посредством вместе использования секретом нежелательно куда сохранять значение этого метода чтобы ваш секретный чайна куда-то не утек сразу скажу это это пример то есть это не законченное решение на просторах гитхаба вы можете погуглить есть много вариантов тоже лизации там ребята даже с шифрованием в памяти то есть решение очень много которые можно можно воспользоваться здесь это просто в качестве примера того что показать какие есть риски того что может случиться с вашими секретами если их просто как слайс байтов с ними работать ну и также теперь давайте немножко поговорим про слежения за секретами то что я говорил что из что если хотите что ваше приложение умело реагировать на изменение секретов то здесь тоже лучше такую небольшую абстракцию вести машка чтобы потом было проще если что переходить с одного варианта на другой который сегодня рассказывал здесь вот это интерфейс watcher который имеет также всего один метод очень секрет боится который на вход принимает также не секрета и на выходе возвращает три выходных параметров которые которых сейчас чуть детальнее расскажу что не значит значит первое это краски канал который будут прилетать текущие либо новое значение секрета как раз таки из него можно получать читать и снова отдельной грудь и нет зависимости того как вам будет удобнее и на производить какие-то действия связанные с обновлением секрета у кого-то может быть обновления коннекта пулов у кого-то просто обновление не знаю клиента по работе со фишкой все зависит от ваших безусловно 2 просвещаем протираем функция остановки watcher то есть случае с и вдруг понимаете что вам больше не нужно следить за этим с секретным то эту функцию можно вызвать и она как бы резиденции операции чтобы watcher перестал следить за этим секретом чаще всего конечно вызывается при завершении приложения но вдруг у вас более гибкие тито механизма работы вашего приложения поэтому интерфейсе это тоже старались в честь ну и третий классический параметр это ошибка если случае сознания очерк что-то пошло не так то этот шутка будет возвращено и последнего что о чем я здесь хочу обратить ваше внимание это то что поведение этого метода ожидаешь что все-таки когда watch будет создан канал будет сразу же брошена текущее значение секрета это очень удобно как раз вашего обычно при старте приложения вы будете скорее все задавать watcher его после этого нужно получить текущее значение секрета это как раз таки можно сделать просто синхронным вычет его не и мы с канала то есть без создания какой-то отдельной грудь инны пока что уже когда проинициализируем приложение уже можете запустить на свои грудинки кто из этого канала будет читать уже получать новые значения секретов если они будут появляться так ну собственно все подходим уже концом секта то вниз и друг заснул или что-то отвлекся то стоят на сейчас да немножко сконцентрироваться сейчас будет основная выжимка самого полезного что я рассказывал иначе 5 основных выводов первый вывод на наш но секретов нужно задумываться сначала проекта и вот наш надеюсь опыт вам показал насколько это может быть чревато поверьте вот те варианты который сегодня рассказала первым там первую парочку самых если вы задействуете уже поверьте вам будет очень легко потом если что переходить на более сложные варианты если тем более будет вас следовать этим выжимка мкадом которые сегодня показывал 2 выводы то что нужно выбирать тот вариант который вам подходит дейсвительно по зрелости вашего проекта не нужно сразу там стрелять из пушки по воробьям выбрать самый навороченный вариант там самый крутой в том что возможно что все плюсы которые у этого варианта есть вам не пригодятся вот а в довесок получите эти минусы этого варианта поэтому очень советую взвесить все плюсы минусы варианта каждого и понять насколько он подходит на данном этапе вашего проекта третий вариант нужно уделять внимание тому как ваше приложение вообще реагируют на обновление секретов без этого вы можете оказаться в той ситуации что вы после обновления секрета хранилище будете за так и сидеть и думать блин а точно ли везде все обновилось до может где-то что-то не обновилась вот этот смоюсь ощущение дано неприятное будет особенно когда вас горит продакшен у вас что-то не работает за то что вас продукт там секрет ли еще что случилось поэтому тоже здесь уделите пожалуйста внимание от этого момента много может сэкономить много много нервов то есть отмечу единственно что обновление секреты даже просто реагирование за счет рестарта приложение это тоже вариант у нас такое работает их не себе рабочий вариант в главное что мы об этом договорились вот что важно что у вас не было разнообразие четвертый вывод собственно используйте да какие там с кирой маскирующее типы при работе секретами чистые слои субары то ли строки не используйте иначе есть риск того что ваши секреты утекут туда куда не стоит обтекать как и говорил на гитхабе можно найти много уже библиотеки который эту механику же реализует ну и последний но не самый неважно в общем в общем тоже важный вывод это надо именоваться секреты так чтобы под названием света можно было понять о ком и сервису этот секрет относится этот раз тос вида связующее звено между сервисом и секретном то что охранники секретов am этого этой возможности не дает вам нужно ее как-то на уровне договоренности сформировать ваши вашем проекте поэтому если вы в этом тоже договоритесь то вы получите эти два важных жирных плюс одо из всего этого доклада что у вас есть центральное хранилище секретов где вы все можете управлять у вас есть связующее звено между этими секретами и сервисы все если у вас это будет то мы уж точно будете жить спокойнее чем служили мы спасибо что пришли на мой доклад сейчас я готов ответить на ваши вопросы"
}