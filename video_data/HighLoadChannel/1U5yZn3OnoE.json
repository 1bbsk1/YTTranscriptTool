{
  "video_id": "1U5yZn3OnoE",
  "channel": "HighLoadChannel",
  "title": "Кадры решают все или стриминг видео в «Одноклассниках» / Александр Тоболь (Одноклассники)",
  "views": 259,
  "duration": 1445,
  "published": "2017-04-22T13:21:21-07:00",
  "text": "то есть вы начинаете смотреть видео у вас плохой канал вы смотрите например на 3g у вас очень низкая пропускная способность ваш плеер автоматически от этого выбирает нужные качества начинает играть например 144 дар это не рубли эта пена прогрессивно размер дальше соответственно он играет вы переключаетесь на вай фай тут у вас понятное дело просто способность сети растет он смотрит что последний сегмент был скачан довольно быстро сегменты по пять секунд и дальше следующий сегмент нам переключает и таким образом зависимости от изменения в просто тех во времени мы можно автоматически переключать качество видео прямо в стык стык вы просто ничего не заметьте это основная как бы вот где видео стриминга и через вы чего все то же самое протокольчик чуть чуть постарше у него тоже есть манифест он описывает каждое качество но он не использует индекс для фрагментов видео пяти секундах оон каждый фрагмент видео по пять секунд варит отдельным файлом соответственно у вас есть яндекс качеств и каждое качество видео она указывает на свой манифест в котором указано время просто и путь на конкретный сегмент видео ну и все это еще упакована в контейнер и mpeg-2 т.с. помню что сто восемьдесят восемь байт пакет на мне нравится собственно да простое решение вот исходя из той архитектурой стала что он рассказывал про видео что напрашивается взять пользуюсь к и видео запустит о нем в впк получите mpeg4 дальше есть готовые tool фмп куб может вам сделать и через mp4 бокс вам может сделать даже вот вы соответственно в этот файл сохранили в дешёвый через и все это сохранились в хранилище но мы помним что у нас хранилище уже 10 петабайт и это примерно 5000 дисков если мы хотим сделать хранилище 30 петабайт ну 15 с дисков на верность такого количества дисков уже можно коттеджик строить вот помимо того что это дорого не хотим еще и не знаю кружащую среду загрузил загрязнять что ли вот есть еще другая проблема помните динозавра которого нам рассказывал им про кашированные если мы начнем видео хранить в разных форматах под разные девайсы таких динозавров у нас из одного станет 3 и вот это стада динозавров мы тоже не хотим разводить самое интересное что когда вам рассказывал про кодеки я вам рассказывал про опорные кадры может быть забыл сказать что видео поменять кодек видео это крайне дорого контейнер это всего-навсего упаковка а вот сменить даже порядок опорных кадров это действительно сложно мы сделали в свое время реверс инжиниринг ютьюба и посмотрели как youtube отдает дыши effect 4 видео оказалось что опорные кадры у них находятся в разных местах то есть в принципе можно предположить что youtube использует вот именно это простое решение потому что пока я не знаю и существуют ли такие решения которые вам могут позволять менять кодек на лету вот с учетом того количества полис или которые у них есть посмотрим ну простое экономное решение которое прямо вот идет в глаза заливаем пользовательское видео там происходит какая-то магия из этого магия мы сохраняем h264 отце и какую-то дополнительную эту информацию которая бы нам позволило на сервере раздачах восстановить любой контейнер ну вроде все просто но есть проблемы что у нас с и чавесом и чего вспомним до видео разбили тоже на сегменты по пять секунд и каждый из них упакован вот в такой контейнер и эту пакета по сто восемьдесят восемь байт если вспомнить что наш раздающий сервера сдавал 40 мегабит в секунду и пакеты по 180 байт то это 26 миллионов пакетов в секунду и каждый из них нужно формировать подставлять заголовок это основная проблема и чавес ну в общем да то есть посмотрев на них есть решение и учитывая что база у нас вся в mpeg-4 h264 акция мы поняли что мы хотим поддержать ее через для ios девайсов и smart tv а для веба больше использовать дэш надеюсь что его поддержка будет расти на других устройствах готового решения мы не нашли ну посмотрим как бы собственно как реализовать streaming самим то есть у нас есть база есть базовый mpeg4 совместно ну там кодеки я рассказывал попробуем собрать из и mpeg4 mpeg dvd streaming вспомним значит видео в mpeg-4 заголовок данные дэш все просто небольшой индекс который говорит что где и заголовки понятно дело что само видео оно осталось ну примерно неизменным чтобы не хранить полную копию видео мы просто дополнительно нарезаем нарезаем только дельту то есть разницу и mpeg-4 оддиш и дополнительно с видео и mpeg-4 сохраняем дэш делать действием прямо в лоб в лоб запускаем для olympic 4 mp4 бокс который нам на выходе даст видео потом мы партиям заголовки того и другого и вот считаем эту дельтав раздавать ну понятно раздавать пользователи есть дельта есть и mpeg-4 подтянули накатываем дельту раздаём проблемы помнишь что видео можно на как его воспроизводить только начинается опорного кадра то есть если мы возьмем видео в mpeg-4 и нарежем u-образные качество 720 2160 например то сам кодек может растаять опорные кадры в разные времена в разные моменты времени в свое время разрабатывая видеосервис я хотел его заставить принудительно сбрасывать как минимум не меньше 500 опорных кадров на видео и не чаще раза в секунду я допустил небольшую ошибку и не круто повезло во всех качествах я сбрасывать принудительно заставлял кодак сбрасывать раз в 5 секунд опорный кадр ну вот воспользовавшись этой удачей принципе для каждого качества у нас уже были синхронизированы опорные кадры на интервале времени 5 секунд мы взяли и mpeg4 и сделали без него дэш то есть взяли качество 720 2160 и вот у нас эти опорные кадры принудительно сброшенные есть и мы по ним нарезали эти сегменты видео даст вам свои проблемы мы испытывали и во flash player и то есть пришлось реализовать во флеше свой дэш проигрыватель но эта тема скорее для flash конференции тут мы столкнулись с рядом проблем которые мы реализовали дополнительно вот в этой библиотеке на тоже open source сыщи лес и чудес ну да будем его тоже кодировать тут мы учились что все-таки лечилась неудобный формат и не очень много девайсов на на нем будем поддерживать пользовались загружать видео ffm пега мы из него делаем impex 4 дальше этом перст 4 сохраняем хранилища и применяемых f impex чтобы получить и mpeg 2 тыс фрагменты вот у нас две копии видео и mpeg-4 video и чего с видео в упакована в mpeg-2 ts понятно что мы не хотим хранить две копии и мы написали свое решение называется панда deep в принципе она вообще ничего не знает про видео его основная задача она берет и mpeg-4 то есть мы берем один файл другой файл его задача вам выдать минимальную дозу с фактическим и вот натравливать на польской видео наш div и небольшие дельту и дополнительный индекс сохраняем хранилища то есть не храним полную копию видео о небольшой дельты накатываем вот если посмотреть на видео в mpeg-4 в mpeg2 ну будет понятно что небольшие куски данных а некоторые сами видео они такие же они вот повторяются плюс есть небольшие заголовки специфичные для mpeg-2 ts вот наша панда пробегая по файлу и делая сравнение прямое выдает на выходе небольшую дельту и яндекс noindex нужен для того чтобы вы файл могли воспроизводить там середины сначала с конца вот чтобы воспроизвести соответственный чавес вам говорят там воспроизведите мне там десятых фрагменты и чавеса мы берем этот фрагмент находим в яндексе смотрим с какого места нужно применять дельту из какого места отдает отдачи mpeg4 это соединяем отдаем пользователя все в принципе реализовали сами панда используют там специфичные для и mpeg 2 тыс кодирования то есть используя т р е по денги что-то мы зимуем собственно говоря что мы в итоге получили на выходе производительность ну пока мы делали streaming мы немножко потеряли 3 4 у нас сейчас diptyque габец со среднего сервера там с 12 ядрами 24 в гипер трейдинге дэш мы получили очень хорошую производительность порядка 40 гигабит в секунду мы не ожидали такого для и mpeg-4 мы на каждые 80 килобайт делали тот самый специфичный вызов send file который отправлял видео пользователю сейчас мы в дэш вынуждены таких вызовов на одну отправку пользователь одного сегмента порядка 300 тысяч делать но системный вызов send file оказалось достаточно дешевым и вот раздача дельта из двух мест оказалась очень эффективной мы почти не просели в производительности сочилась чуть сложнее пакетики маленькие и мы использовали дополнительный к чтобы их формировать и там уже выигрыш от send file не соответствовало просто его количество вызовов на каждые сто восемьдесят восемь байт делать системный вызов как бы очень дорога поэтому производительность получилось с одной железки порядка 20 гигабит в секунду результаты до что мы получили изначально старт видео был порядка там 4 секунд на достаточно коротких роликах на 2-часовом фильме это было двенадцать секунд я смотрел статистику по просмотрам по регионам и видел людей узбекистане которые ждали первого кадра видео порядка 60 секунд они у дождались у нас плеере портит когда а пальцы получил первый кадр действительно есть такие люди которым мы в общем очень бы хотели помочь используя технологии mpeg дыши через старт и перемотка видео это константа вот цифры которые мы средний по порталу получили получилось что мы ускорили 1 кадр в 6 раз стоимость хранения ну порядка одного процента у нас всего div для дэш и для и человек он там порядка семи процентов то есть это ну довольно мало на мой взгляд стоимость раздачи но двум и после запуска за загрузили еще на плюс 20 процентов если учесть что другие сервисы просто делать копию видео то есть если у вас сервис кто нибудь небольшой и у вас все видео хранится на одном сервере вам принципе ничего не стоит поставить еще два сервера dildo другой 2 часа и покрыть всех клиентов стременкова видео но как бы у нас пользуется виде очень много и вот мы здесь как раз экономим процессоры экономить сторож да со всем этим мы сейчас активно выходим на смартфон и планшет и и телевизор что мы получили мы получили автоматический выбор качества что-то еще можно полезного сказать автоматическому бури качество мы были приятно удивлены мы сэкономили порядка 30-40 процентов трафика почему если вы смотрите видео небольшом окне то вам нет смысла его отдавать full hd или ещё как-то если у вас даже широкий канал мы решили сэкономить от канал провайдером и производительность себе то есть наш разрешение видео подбирается автоматический под размер player когда вы переходите full screen или размер применяется система адаптивная и она переключается уже на другое разрешение через пять секунд у вас опять все будет хорошо если вы разбираете полки максимум 5 секунд посмотрите в старом качестве и дальше она переключиться что мы реализовали мы немного подпилили библиотеку дышать очень мучились в html5 это поддержали и человечно долина адиос и smart вы сделали канона и хранение файлов и тут с точки зрения пользователя очень интересная вещь за одни только сутки одноклассники сейчас пользователям экономит 6 лет жизни я когда пересчитывал сам был шоке я учил что у нас 50 миллионов просмотров порядка четырех секунд с одного старта видео мы можем сэкономить пользователю это 200 миллионов секунд сутки я пересчитал вы можете проверить сильно 6 лет то есть пользователи в среднем по порталу стали на шесть лет меньше ждать и смотреть на это против они теперь могут посмотреть на это время больше видео или заняться чем-то полезным да но сердце говорят проведя анализ и сравните с другими сервисами мы вот решили что августа и на столько лет мужчина в болиде вы можете потрогать наш сервис одноклассники всегда доступно все всем спасибо если у вас есть вопросы задавайте я правильно понял что вы вот эти 60 серверов в которые раздают у вас контент ну да нет раздают меньше 20 контент раздают меньше 20-60 занимается нарезкой да да да я я правильно понимаю что у вас эти сервера не раздают видео из одного дата-центра какого-то да где-то расположенного это москве или где там неолита распределенность сеть у вас это распределенная сеть мы используем и седин дополнительно у нас он есть в разных городах выносные площадки по раздаче видео и в даже в москве мы храним видео минимум в трех дата-центрах на случай отказа вас от седины то ваши даже тоже разобрали вы клевые гуляют используем свою разработку то есть те же самые сервера раздачи установлены на стенах единственное что данные они получают не со стороны жестких дисков а запрашивают их по сети и вот этот эффект кэширование там 80 на 20 он тоже очень важен для седанов то есть у вас в владивостоке например есть там сервер свой который раздает именно этим ребенке новосибирске во владивостоке не так и вопросу 2 я правильно понимаю что у вас эти сервера вот эти вот 50 гигабит вы выдаете с с двумя 6-ядерными процессорами как бы всего киос да и 96 гигабайт рама и нам 4 терабайта ssd понятное дело когда мы отправляемся дейэн мы его пакуем жесткими дисками чтобы у него heat-ray был еще выше потому что он раздает обычно меньше до хранить можно старт черничным всего круто да задавайте вопросы я после конференции буду не доступен сразу же уеду поэтому если есть что спросить спрашивайте подскажите пожалуйста вымыв этом видео чем перемещать мы перемещаем его там и mpeg-4 боксом и минному о нет не вините mp4 парсер от google используем для перемещения мува тома но в свое время когда мы реализовывали перемотку видео мы попробовали этот м 3 4 парсера от google использовать чтобы перематывать видео вот и он написан на java очень сильно напрягал гарбич kollection и мы решили реализовать свою систему для парсинга и mpeg4 и для того чтобы перематывать видео когда мы это сделали мы удивились что google максимум мог обеспечить на одной машине там порядка 100 перемоток в секунду наш ту который перематывает mpeg-4 video сейчас держит на одной машине порядка 10000 перемоток видео секунду то есть 10000 пальцами могут перемотать видео мы а спарте в весе mpeg4 выделяем нужный кусок когда мы это в свое время сделали поняли что у нас есть такое классное достижение мы поняли что мы можем обеспечить mt обеспечить streaming streaming основном заработать на том что мы делим видео на кусочки по пять секунд и вот как раз это чтобы мы используем это собственно говоря сейчас работает наша нативное решение еще один вопрос вашу магистральную команду этом пик может где-нибудь подобрать ну наверное вы сможете на слайдах и и посмотреть но не знаю что оно вам даст то есть но принципе слайды будут доступны вы сможете посмотреть ну я собственно горит сейчас мучаюсь с тем же вопросом составляю команды были так сказать адаптированную к нашему проекту да но она зависит от каждого качества и каждый параметр вычисляется зависимости от входного видео там битрейтов и всего остального то есть просто так как констант эту команду взять не получится ну и последний вопрос ffmpeg вы компилируете или скачивайте сред ох у нас с этим занимаются системы администратора насколько я помню мы его компилируем с дополнительной библиотеками чтобы обеспечить максимальную поддержку пользуясь кого видео там где вы стали еще где-нибудь за интересный доклад момент вы вопрос вот эти сервера которые дают которые например тоже новосибирске у вас есть скорее всего статистика по каччит мессир еще пир сервер ну примерно средний потому что все volvo на промахов доходят до жесткого сертифицирован 44 терабайт ну или там 20 байт но у вас лай бориса ест вам 55 байт очевидно что он не можете почитать 50 терабайт себе локально то есть вот эти куски которые к нему приходит очень низкую таки фитнесе еще и вот вы смотрите на вот и смеси ищу сколько там процентов да мы смотрим это у него порядка 20 процентов то есть как ни странно у нас получается 20 серверов по 4 таро бать на них ssd и там по 100 гигабайт рама то можно легко посчитать то есть там то есть на каждые 100 хитов только возить обслуживается локально 80 идут пробиться через и хвойными обслуживаться локальное только 28 процентов хитрый да добрый день у меня такой вопрос а можно где-то посмотреть ваши рецепты по оптимизации h 264 кодека и очень интересна информация по вашему player можно где то почитать посмотреть ну просто по возможностям открытым или как-то доступен или этот внутренний разработка закрытую со player именно flash его это внутренняя закрытая разработка но на слайде я давал ссылочку на библиотеку dcs она в принципе реализует все ваши задачи единственное что мы делали очень хитрый адаб ну адаптивное переключения качества то есть плеер запоминает каком играл в прошлый раз начинает с него вот эти всякие хитрости мы делали но для дэш уже есть даже с готовой имплементации она вам полностью вас удовлетворит а рецепты оптимизации вот вы сказали тюнинг h2 64 где-то увидеть можно лишь ну основной тюнинг h 264 заключался в том чтобы заставить его каждый нужный интервал времени спрашивать опорные кадры также мы очень боролись с потерей качества то есть если вы каждая заставляете кода каждый там пять секунд сбрасывать опорный кадр у вас может возникнуть ситуации что качество вашего видео снизилась то есть вы там проверяли измеряли к сожалению не собрались со время не нашли время чтобы вот прямо написать статью и вот выложить как мы с этим работаем планируете маловероятно спасибо продолжай вопрос вот у вас есть 20 серверов а собственно кэш у них одинаковы везде вот 4 тиранит они конечно все парте цианирование все на самом деле все вот эти детали можно на хабре в наш нашем блоге там посмотреть там все будет прямо расписано ну понятно cache partition нерон по серверам каждый серы отвечает за конкретную партицию но так как сера может выйти из строя все ненадежный ли дата центра выйти целиком из строя у каждой партиции есть дополнительно прогревочные резервная partition которая немного прогревает пользователями чтобы вот самая горячая видео где-то еще хранилось когда дата-центр падает у нас есть как минимум там 3 сервера в каждом дата-центре которая определяет степень жизни каждого сервера и перестают отправлять туда пользователи и там все очень интересно и это можно посмотреть вот из предыдущего доклада но владивостоке наверно один серверная когда мы делаем сидел площадку там всегда два сервера у сибирских ладно спасибо пожалуйста боишься-то коммерческой информации то есть как раз пластика так много- до нее есть парочку городов я назвал дальше не буду продолжать извините хотим расширить если у вас есть интересное предложение обращайтесь потому что мы трафик вам сэкономим то есть гарантируем что 80 процентов видео останется внутри сервера да и только 20 процентов от канал вы будете использовать могу расти александр спасибо за доклад вопрос такой вас в результатах там было указано для двух часовой длины для средней длины первых что иметь подразумевается под средней длиной да какое там значение для средняя длина роликов которые у нас смотрят это 5-7 минут у пользователя не любит короткие смешные ролики клипы наверное не знаю соответственно мы собираем статистику с player player каждый первый кадр нам или портит время от кнопки play пользователя до первого кадра вот это та самая средняя которое я вам рассказал и соответственно вытекающая сюда вопрос используется ли все то же самое для коротких круглый роликов длиной меньше минуты и соответственно какие приросты производительности там это дает мы сейчас используем у нас действительно был переключатель свое время чтобы плавно запускать и смотреть вот эту границу то есть у нас есть возможность указать что ниже какого-то качества можно отдавать в mpeg4 avi выше нужно обеспечивать streaming но в принципе мы пришли к выводу что streaming всегда эффективен и сейчас на всех роликах любого качества используем только streaming вы не пробовали экспериментировали с коммутации на видеокартах я здесь ускорение времени да сейчас мы работаем над этим то есть общались сцен видео у них есть различные интересное решение там свои кодеки но пока результатов у нас нету думали нам не понравилось очень сложно вот тот набор параметров ffm пега портировать от чьей-то встроенные h 264 кодека"
}