{
  "video_id": "SeGK_NxmWOk",
  "channel": "HighLoadChannel",
  "title": "Тонкости работы трассирующего JIT-компилятора / Антон Солдатов (IPONWEB)",
  "views": 1006,
  "duration": 2985,
  "published": "2018-08-16T04:50:20-07:00",
  "text": "всем привет меня зовут антон я работаю в компании пион веб сегодня я расскажу вам про то как мы продакшен много-много лет использовали logic как потом и почему мы съехали на собственную реализацию и разберем пару кейсов того как мы itune ли производительность в жидком пилят ари который достался нам по наследству от лоджа то компания pioneer занимается разработкой технологических решений в сфере онлайн реклама такие большие потоки аукционов арты в rtb аукционов каждом из которых нужно что-то решать показываем и пользователю рекламу или не показываем у нас есть проекты которые работают на с нагрузки где-то вот порядка пяти миллионов таких вот rtb оксанчик в секунду довольно серьезная нагрузка чтобы это все как-то разрулить и чтобы все работало хорошо есть такой разветвлённый сложность так сложность так технологий туда вот включены все рт по работе с big data и с машинным обучением с новой склеили в общем вот все что предполагает современное работать на больших нагрузках с вот и в сердце всего этого есть написанный на си плюс плюс сервер приложений в который в свою очередь встраивается интерпретатор языка lua и уже с помощью нло мы скрипту им бизнес-логику наших конкретных проектов в продакшене больше девяти лет мы использовали logic начиная ещё с версии 1 потом перешли на версию 20 версию 21 которая насколько я помню до сих пор в бете мы так и не использовали в боевых условиях но тем ни менее накопил сказать большой опыт использования лоджи то в продакшене но при этом с течением времени с ростом бизнеса наших клиентов мы столкнулись с довольно серьезными архитектурными ограничениями лоджи то настолько серьезными что в 2015 году мы фыркнули logic убрав из него кроссплатформенность оставив linux и сестер битную архитектуру начали на работать над нашим формам в течение 15 и 16 года мы активно все это дело разрабатывали стабилизировали у нас были первые успешные миграции наших проектов к началу 2017-го года более 95 процентов наших боевых серверов уже использовали нашу реализацию и в течение 17 года мы уже занимались поддержкой мы работали над какими тут совсем новыми фичами чтобы удовлетворить бизнес требованиями которыми нам который на предъявлял компании собственно чем мы работали это же почему мы в итоге ушли от лоджа то самое первое самое такое больное место заключалась в том что мы решили проблему гигабайта я думаю что все кто более-менее серьезно использует лоджик знают об этой проблеме когда значит в лоджике 20 я говорю о 20 pointer и там прибиты 32-битные соответственно когда мы попробуем запустить и на 32-битной системе нам доступно 4 гигабайта виртуальная память когда мы пробуем запустится на 64 битной системе нам оказать доступно но там либо гигабайт либо два в зависимости от ядра linux для нас это было очень больной темой потому что наши проекты устроена таким образом что вы в память при запуске вот момент старта наших проектов мы загружаем довольно большие объемы данных собственно говоря которые регулируют вот эту самую rtb торговлю туда складываются всякие параметры там то что называется в мире rtb таргетингами да то есть как бы кому какую рекламу показываем еще в итоге это все разрастается бизнес-клиентов разрастается данных становится больше в один прекрасный день ups и это оказывается серьезной проблемой эту проблему мы успешно решили и на вот эти вот 4 работаем со всей доступной памяти мы заменили новую функцию хэширования строк казалось бы что тут может быть не так пока в один прекрасный день то функция которая исходно использовалась в лодже 20 не положила нам проект а добавили тесты при чем я говорю здесь неё бы игра ционных тестов вот этого нашего интерпретатора и jit компилятору да с и не с кем сервером приложений в которой он интегрируются а собственно говоря о тестах самого вот отдельного продукта от нашего форк потому что в тот момент когда мы начинали работать например вот флот же тел публичной репозиторию лоджа то был а тестов там никаких не было а когда в какой-то момент они появились там было написано что это не тесты ну в общем как то с этим было очень трудно работать особенность черно того что мы начинали свой сайт изменение довольно значить когда нужны были какие-то тестовые сюита моих добавили добавили такую штуку как неизменяемые объекты в самом языке lua сам язык не определяет константность объектов но нам это нужно было в том числе потому что вот те большие те данные которые мы загружали в память до которые были параметрами определяли поведение нашей системы они не менялись вот в течение жизни там всего приложения соответственно по умолчанию garbage collector по ним ходил спрашивается зачем мы взяли и вот сделали такие не изменяем объекты которые еще пропускались горбач коллектором разгрузили его добавить улучшили этим самым производительность и еще мы потом пошли дальше и эти самые а неизменяемый объект еще стали шарить между мир между в между нативными потоками и это конечно не совсем новый ну скажем так мы во первых начали свою реализацию мы уменьшили существенно уменьшили потребление памяти к тому моменту уже были проекты для которых даже после того как мы сняли ограничения на выйдут на поиск решили проблему гигабайта для них оказалось что уже вот даже вот так вот такой полностью доступной памяти им не хватает а вот решив таким образом нашу проблему моим сделали лучше кроме того несмотря на то что в к рутины к рутинного кооперативные вы так немножечко в сторону там примитивности сдвинулись и добавили возможность совершать грудины по таймауту опять-таки потому что это важно для rtb мира потому что вся торговля вот рекламы в реальном времени оно происходит в условиях каких-то жестких таймаутов и если например там в какой-то момент локу от решает а не по исполняются калия 300 миллисекунд во-первых уже этот обед никому не нужен после этого вторых эксклюзивно вот занимаются этим потоком вычислительные ресурсы которые на самом деле можно было бы потратить на что-нибудь более полезное добавим мы написали свой профилировщика чтобы понимать лучше что происходит внутри у системы мы добавили какие-то новые утилиты об этом я поговорю чуть позже между тем я предлагаю вернуться примерно на год назад осенью 2006 года 2000 2016 года мы решили все самые насущные проблемы у нас состоялись первые миграции и собственно стала задача вот мы фыркнула аджит нам достался в ком-то видео jit компилятор давайте посмотрим как он устроен насколько хорошо он добавляет там улучшает производительность нашей системы до виджет компилятор базовая идея это про перформанс до тип раз посмотрим нельзя ли там что-нибудь улучшить принц происходит летом все оптимальные и не тратим ли мы деньги там где этого не нужно делать мы поставили серию довольно простых экспериментов мы взяли несколько проектов и вот на каждом кластере на каждого проекта взяли проект взяли какой-то какую-то одну машину и отключили jit компилятор и сравнили сравнили время средние время обработал об обработке запросов вот что мы увидели вот у нас есть проект один в котором вот синенькая это то что у нас было с выключенным джед компилятором доран живенько это включенный вот тут в миллисекундах среднее время обработки обработки запроса вот у нас есть проект хороший в котором включение джейд компилятора добавляя порядка там 20 процентов производительности вот вот такой вот большой большой разрыв у нас есть проект группа проектов словно в категории ожидаемо но не очень хорошо тот выигрыш производительность он либо минимален либо находится на грани статистической погрешности ну тут уже можно смотреть почему это происходит ведь известно что не все конструкции языка lua поддерживаются jit компилятором есть что-то не компилируем а я и коду проекта могло не повезти в нем вот таких конструкций было много и вот звезды закладывались так что ну нет существенного улучшения производительности с этим еще как-то можно было жить хуже всего оказалась ситуация с проектами в которых включение jit компилятора приводило к ухудшению производительности это как-то уже совсем не укладывалось в картину мира ну потому что если джек про производительность как же так получилось что мышку мы включаем компилятор проектов замедляется значит нужно было нужно было что то делать нужно идти дальше и смотреть дальше как она устроена общая картина как работает как работает трассирующий jit компилятор вот не вдаваясь какие-то технические подробности можно сказать что он работает примерно как то вот так давайте представим что у нас есть национальный парк или просто лыжный парк какой-то снег все хорошо снежная целина приходят лыжники начинают кататься как то кто то катается хорошо кто то катается плохо там падает но так или иначе лыжники это наши данные которые вот по нашему снежному коду ездит и доезжают таки к счастью до конечной точке своего путешествия выполняя тем самым вот то что приложение работает как надо теперь представим такую ситуацию от нас есть специально обученные люди сотрудники этого самого горнолыжного курорта который периодически рывка их конечное количество он у них есть замечательное свойство они в какой-то момент приходит смотрит где больше о натоптано и начинают в этих местах улучшать лыжни и с чего-то такого не очень ровного рыхлого строят ровной хорошие трассы вот таким образ что нам наши данные лыжники начинают вот ровно по этим трассам ездить быстро и хорошо и вот если им надо из точки а в точку б и между этими точками проложена трасса то а не доезжают быстрее чем если бы этой трассы не было а попутно еще наши сотрудники каких-то таких нетривиальных местах расставляют флажочки куда ехать куда не ехать для того чтобы лыжники вот заранее видели во что вы тут нужно повернуть а вот кур от в бок сворачивать не надо вот этого то что называется assertion гарц до в мире grid компиляция при этом если вдруг кому-то действительно нужно в бок все честно он игнорирует флажок он попадает в условия снежной целины начинает ехать медленно но тогда по прошествии некоторого времени если этот поворот окажется популярным опять придут наши волшебные помощники и проложит улучшит вот эту трассу и получится таким образом что у нас от основной трассы до это идет боковая трасса которая тоже будет которая тоже будет быстрой и при всем при том у нас наши на нас компилятор down начав начав один раз трассировать начав один раз улучшать не очень хорошую лыжню он начинает вы прям желательно до победного конца улучшают улучшает это то что соответствует понятен лайнинга да то есть если у нас на пути встречаются какой-то вызов функции мы берем и вот как он есть что же вставляем его в там вход там трассы и вот еще улучшаем нашу трассу он остается еще дольше и вот по ней можно ехать с большой скоростью дольше а в результате спустя некоторое время наш ландшафт приобретает вот такой вид что вот у нас есть хорошие значит вот наш горнолыжный курорт вот тут где-то проложены трассы вот там можно ехать быстро а там где быстро ехать нельзя ну давайте попробуйте может поехать из-за кто время опять то можно будет ехать хорошо отлично это была общая картинка нам к сожалению не было понятно что на самом деле у нас как в нашем случае выглядит вот эта карта а что происходит какому состоянии мы приходим и хотя общее понимание было стала за стало интересно как бы как-то все исследовать глубже ну вот какие в тот момент у нас были инструменты для анализа на самом деле инструментов или анализы у нас было немного во-первых у вас был графит это не что то что мы там прикрутили клод жад улик наши реализации да это обычный графит с помощью которого он назван взгромоздили моего на наш сервер да и смотрим там от среднее время обработки запроса такое-то для какой-то integra интегральной оценки для плаща никаких то вот общих общих метрик а кроме того в наследство отлова jetta достался специальный режим дампира этот такой режим при включении которого jit компилятор начинает подробно выдавать вы подписать прогресс что он сейчас делает вот получается куча куча такого текстовая информация при этом кстати сейчас да за последний год уже появилось много новых много новых инструментов для для аналитики для того чтобы понять как работает как работает jit компилятор появился примерно год назад блоджетт web inspector чуть меньше года назад на гитхабе появился loom от клауд флаер еще позже начал началась работа над довольно интересным проектом под названием raptor jit который является for камбоджи так тоже кстати по мульт только linux только x64 и ребята сделали замечательную штуку под названием studio которая позволяет вот проанализировать как как оно все работает но мы работали вот примерно с этим вот получается не надо пытаться это читать какие-то текстовые потоки данных вот приноровившись можно понять вот как она там работает внутри анализировать какие какие-то выводы делать что дальше мы с этим будем делать ну дальше вроде бы все просто давайте возьмем какой-нибудь сервер на нем включим режим дампира до 10 15 минут больше не надо и давайте проанализируем собранные данные ну и тогда он станет понятно вот тут плохо да вот тут но можно подкрутить тут улучшить поехали и мы вот начав действовать по такому казалось бы простому алгоритму стали что тут же столкнулись с проблемами и нашей проблемой номер ноль стала проблема вот того скудного инструментария если посмотреть под капот дампира который нам достался наследство от лоджи то там можно увидеть не очень хорошо читаемый ла кот полный каких-то магических констант что-то с ним сделать как-то поддерживать что-то подкрутить не очень представлялось возможным это наш сильно расстроило более серьезной проблемой стала другое вот мы взяли просто по собирали данные 10 15 минут и оказалось что у нас в нашем многопоточном сервера приложений только с одного с одного нативного потока в среднем получается 700 мегабайт в тесто в эти самых вот dump of plain текстовых в каждом порядка но содержалась информация о нескольких тысячах успешно скомпилированных трасс кроме того там были записаны попытки того что не получилось компилировать кроме того там были какие-то внутренние дам по поводу внутреннего состояния кроме того если вспомнить вот ту метафору изначально программа про горнолыжный курорт да я сказал что у нас есть какие-то начальные трассы появляются какие-то боковые и вот эта вся информация была выплавлена в этот data stream 700 мегабайт ней ну и понятно как бы глазами глазами вообще непонятно что делать ну вот глеб ать не ясно как делать какие-то выводы совсем непонятно это было очень большой проблемой что мы сделали ну для начала с amd ампер мы переписали слова носи и за использовали вот вместо всех этих магических непонятно константами за использовали вот интерфейс и платформы достала хотя-бы легче читать это стало легче поддерживаться при этом что немаловажно в этом случае это стало быстрее работать вот казалось бы кого волнует скорость работы дебаг инструмента на самом деле в данном случае скорость работы дебаг инструмента оказалось важно потому что вот этот damping шел в параллели о том что то дам пил да а потом через несколько секунд он начинал что-то компилировать соответственно все то время что мы забирали у нашего у нас на нашей дам белки нашим дебаг инструментом у основной системы да вот все это время могли бы больше скомпилировать получить больше данных в итоге сделать анализ был гораздо лук а дальше мы написали собственный анализатор собственный анализатор вот этих текстовых дампов и выложили его буквально той неделе на git хоп и поскольку мы вот сам формат дампов он совместим сложит он то вот эта вот штука она может парсить и обычный лоджий то вы дампы что она умеет делать во первых она уйдет большие потоки данных а на диком позируют на какие-то более осмысленные кусочки она может строить какую-то базовую статистику вот сколько то там утра скомпилировалось с такими-то типами но вот так далее и тому подобное и что самое главное она у нас может строить вот какой-то графическое может визуализировать то как наши трассы устроены и в буквах для дальнейшего это оказалось очень очень важной фичи вот вот так мы думали что она как-то должно примерно быть вот так она была на самом деле вот пример такого куста трасс где красненьким красненьким выделено какая-то такая корневая начальная трасса с которой все начиналось вот тут уже пошли какие-то боковые в этот момент стало понятно как дальше строить анализ хотя бы вот с таким инструментом вот на таком уровне мы смотрели на эти волшебные картинки смотрели на наш исходный код и видели вот находили местах где было мало слово кода покрыт скажем так небольшое количество лака доказывалось покрыта какими-то большими вот развесистыми структурами трасс вот в эти места вызывали подозрений в первую очередь потому что ясно было что там что-то не так и только-только начал пользоваться этим инструментом уперлись ровно в такой случай причина которого была в том что при переносе при включении в ridgid компиляторе 64 битого режима мы допустили ошибку и вот увидели такую замечательную штуку это такая вот макаронина большая но есть и о некоторой частью нужно читать вот как бы как такой свиток вот здесь потом это продолжалось вниз и опять вниз и опять вниз и опять вниз и опять вниз и на самом деле это только было вот наверное одна треть той картинке которая которая вот есть в оригинале ясно было что то что то не так по исследовали нашли ошибку оказалось что на самом деле трасса должна была было выглядеть ну элементарно то есть вот какой то какой то основной горячий путь основная наши вложения в пар ответвлений увидев это мы обрадовались сказали что вот наш инструмент работает давайте вот применив этот метод посмотрим нет ли у нас еще мест которые работают не оптимально и такие места нашлись следующий наши проблемы стало вот то что обозначена как большое число точек входа речь здесь пойдет вот о чем вот у нас есть проект на который мы проводили наша оно наше тестирование а он устроен таким образом вот тут написано загадочные аббревиатура ссп в word обычном мире со спину это скажет так источник трафика вот вас есть несколько источников трафика люди которые ну скажем к сущности которые вам предлагают предлагают показать рекламу где-то для какого-то пользователя на каком-то сайте неважно там как они эту информацию агрегирует но у нас есть приложение которое подключено к нескольким с usb этом ромашка одуванчик что-то еще от них она получает вот эти вот бесконечные потоки событий потоки предложений на неё не значит они по не купишь ли ты рекламу и вот эту всю информацию передается в некоторый это вся информация передается в некоторый общий слой are the block а потом ответ выдается обратно вот эти вот точки входа и удается уже вот в этих если посмотреть на это дело гроза глазами компилятора то очевидно что вот это вот этот слой общее rtb логике этого то полянка которая касас вытоптанный 1 она она компилируется раньше всего и хорошо вот там компилятор проходит что-то начинает наносить какие-то непоправимо улучшения все остаются хорошо и поскольку он у нас такой человек оптимистичный он начинает пытаться выходить за пределы вот этого слоя общая от обычной логики и компилировать вот эти вот кусочки те кусочки в которой он передает сам сам ответ там не очень много там не очень много собственной логике и проблема оказывается в том что у нас таких модулей вот на данный момент да у этого приложения больше больше двухсот эта коса с проблемой это кажется проблемой потому что вот представьте да если опять же мыслить в терминах то метафора которая привела раньше вот у нас получается есть какая-то полянка которую лыжники про топчут и сами они проедут она не очень большая но мы говорим компилятору компилирую здесь здесь здесь соответственно он буквально всю полянку такое-то флажками таким образом что лыжника просто не разобраться они начинают сталкиваться друг друга не понимают куда им ехать в результате тратится ресурсах на компиляцию этого кода в результате это получается не не оптимально хорошо давайте наш калькулятор добавим такую опцию что мы по завершению а вот выхода как по выходу из слоя вчера таба логике мы будем завершать компиляцию естественно вот когда мы работали с компилятором мы компилятор не знает про то что он там работает с какой-то rtb логикой но неважно вот смысл смысл конечно был именно такой и мы померили мы померили производительность значит с левого синенькая это вот то что было наше исходное состояние оранжевенькие с включенным с этим самым сна жучкам что получилось мере ли мы два параметра мы мерили держателя это перцентиль самые медленные request of которые очевидно входит тире квестов во время которых работает компиляция имели средние время в которой исполняется бизнес-логика мы получили что время компиляции улучшилась процентов там на 10 и процентов на 5 интегрально мы получили ускорение ускорение работы без услуги ки что для нас в общем то хорошая хорошая цифра тем более достигнуто путем довольно незначительных изменений в код отлично идем дальше прогоняем весь процесс заново собираем значит эти самые дамб и начинаем их парсить смотрим на картинке где можно что-нибудь улучшить натыкаемся на такую на вторую проблему связанную с тем как компилятор обрабатывает доступ к углю к значениям политера льном ключам в таблицах вот о чем пойдет речь на самом деле речь идет об очень простом ловок воде вот мы в какую-то переменную по ключу que fue из некой таблички забираем значения что значит да чтоб что происходит в этот момент очевидно что у за каждый табличка стоит какое-то внутреннее хранилища которая представляет собой обычный обычный сильный массив и для того чтобы получить значения нужно как-то нам попасть вот в какой-то индекс этого массива и получить это самое значение мы вычисляем хэш от нашего ключа a massive этот имеет определенный размер мы складываем мы значит применяем and по приди по масочки зависеть от этого размера до удаляя все ненужные биты и вот таким образом получаем конечный индекс идем по нему получаем наш наш элемент что здесь можно сказать с точки зрения компилятора вот смотрите вот эта вся схема она обладает такими любопытными свойствами вот функция хеширования на постоянно она не меняется очевидно это литерал который пока ваш и вот пока вы исполняете ровно этот код он будет ровно таким это не переменная это тоже некая константа да с точки зрения компилятора вот что если мы работаем с таблицами у которых внутренние представления все время тоже одинаковая вот тогда мы можем сделать такой простой трюк мы можем не перри вычислять каждый раз вот это все полностью сложное значение а там где мы видим т . как бы вот внутри заменять а сходи-ка сразу вот по такому ты индексу ты получишь значения дальше уже работы с ним так как тебе надо прекрасная оптимизация при этом обращаю внимание что вот это вот предположение об одинаковой структуре таблицы до ног с очень важно потому что если нам на вход подать таблицу с другой внутренней структурой то конечно попытка применить вот эту самую логику и не вычислять хэш и взять что-то не глядя да но нет не приведет каким-то хорошим последствиям но в этом случае jit компилятор сделает простую вещь он скажет что ну хорошо отлично он забьет вот-вот проверочку на размер на внутренний размер table на размер внутреннего хранилище таблицы в самом скомпилированный код и если размер будет другим мы просто выйдем из страз и да вот поставили флажок вот не ходи там налево пойдешь на левый ну значит работы уже по честному вычисляешь так далее и тому подобное это замечательно работает когда мы работаем с большим потоком объектов одинаковой структуры конечно вот когда у нас там шел миллион объектов которые плюс-минус устроены одинаково про про за обработав там пятьдесят сто таких объектов мы сразу видим что о круто она не имеет похожую структуру применяем эти все наши многочисленные то найденного хитро оптимизацию все становится замечательно проблема заключается в том что вот в rtb да вот те запросы которые прошлом примере проходить проходили там через с поеду ваш одуванчик чите ромашка они имеют гораздо более рыхлую структуру потому что вот в один момент к нам приходит человек который например со смартфоном с приложение включена у нее службы геолокации ему нужно показать баннер в другой момент времени к нам приходит человек ну а на самом деле там тысячи там десятки тысяч сотни тысяч пользователей с настольного компьютера не смотрят сайт в браузер не включен думать трек им нужно показать видео 3 человека это такая вот интересно этом нечистым суперпозиция да вот со смартфона но на сайте зона трек хочет там нужно ему аудио послушать и на самом деле вот для примера у меня тут в таких параметров обозначена 4 до их десятки их десятки и из-за этого вот те таблички которыми описываются вот эти вот rtb сообщения не они не ударяет этому свойству постоянные структур они постоянно меняются в результате чего получается вот придать что получается вот как ехал булыжник по трассе ему было бы хорошо а другой приходит говорит знаешь у меня лыжи на 5 миллиметров шире и не не нравится твоя трасса я рядом в полуметре от тебя начну делать свою тельник то время компилятор приходит помогает ему хорошо так вот третьих лиц слушай а вам я вообще там одна влажнo там на 10 миллиметров шире другая на 5 мне вообще не нравится что вы делаете и таким образом тоже мы заставляем бедный компилятор компилировать то что в общем то не нужно было компилировать и мы в таком случае решили отключить это самое быстро индексирование которое явно не работала в нашем случае померить производительностью и мы увидели вот зелененький вот зелененькая колоночка это эффект последовательного совместного применения вот 1 фикса и 2 мы получили что мы вот вы играли в скорости компиляции уже там примерно 10 плюс 10 порядка 20 процентов и среднем средней скорости исполнения мы выиграли порядка десяти процентов опять же второе изменение тоже было довольно локально не приходится там компилятор переписывать с нуля вот как раз ровно под поэтому да все то что о чем идет речь она может быть применен о точно так же все это знание к водка ванильному лоджи ту тоже хорошо вот мы уже добились каких-то результатов давайте этот трюк провернем еще раз и попробуй может мы еще найдем будет подозрительную картинку где ловок вода мало а оказалось бы трасса слишком сложен и вот та немалых на них глазами смотрим и они нам кажутся сложными и как нам показалось нашли в такой случай он называется пожалуй не очень понятно выход выход боковых транс из циклов суть вот в чем суть вот в чем посмотрим на такой довольно простой лак вот несколько искусственный суть в том что мы не котором цикле долгоиграющим исполняем какую-то функцию при превышении определенного порога мы начинаем использовал нять и другую функцию тоже из-за циклом у нас стоит еще тоже некоторая полезная нагрузка очевидно что пока мы не при не превышаем порога нас jit компилятором скомпилирует по сути только вызов вызов этой самой первой функции а потом когда мы начнем превышать этот порог и если нам так вот повезет то опять же силу своей оптимистичности компилятор возьмет и скомпилировать не только бар а вот если если так будет устроена если так он повезет процесс повезет а время процесса трассирование до выйдет и за пределы цикла и начнет компилировать вот все что там идет идет дальше вот и нам показалось что это может представлять какую-то проблему мы тоже попробовали с этим как-то поиграться что если нам это отключить давайте померим производительность и вот тут уже не сработало наш метод мы не понятно что мы выиграли или нет скорости компиляции там были какие-то там непонятные нолик то ли вы играли три процента неясно а в производительности мы потеряли и в общем то вот наткнувшись куда я дойдя до этой точки мы поняли что это тоже в принципе не который результат тоже смотрите что мы делали до этого мы анализировали работу компиляторы мы говорили вот ты работаешь так то это не очень оптимально компилирую меньше да лучше но мы нажали вату силовую точку после которой уже не нужно не нужно отключать нужно что-то добавлять нужно какие то карта конструктивный лучше не вносить вот так но это соответственно там история пожалуй а для отдельного доклада а позвольте мне перейти к выводам мы столкнулись ситуации когда инструменты общего назначения перестали перестали решать наши специфический бизнес задачи мы решили мы пошли по пути добавления опцию мы стали их тестировать комбинации да у нас что-то получалось что-то у нас не получалось но кажется что это в нашу ситуацию был хороший хорошее решение благо что мы путем не лак довольно локальных изменений получили вот выигрыш в производительности на среднем времени работы без у слойки порядка десяти процентов а попутно создали для себя вот инструмент которого раньше не было который вот у нас теперь есть и который которые мы решали и которое наверно поможет и к системе лоджи то с инструментарием а с проблемы с комментарием у него есть нужно больше инструмент вот ссылки ссылки во первых на доклады по поводу про нашу реализацию доклады были в том году на на hail audi и на ложных метопах отдельно немножко хотел бы остановиться вот на блоке ссылок в по поводу инструментов аналитики здесь есть все те инструменты о которых я говорил при этом нужно понимать что вот инструмента кроме нашего они решают безусловно важную но немножечко другую задачу они сконцентрированы в первую очередь на визуализации вот этих вот текстовых дампов потому что если вот вспомнить да там были даны этом 1 группа данные другой группы этот вот был важный байт-код какое-то внутреннее представление компилятора это все та же нужно уметь бегала хорошо читать и эти инструменты довольно успешно с этой проблемой справляются и дают наглядное представление вот можно посмотреть вот мой важные байт код соответствует кругу я вот такому то машинному коду избавляешься от лишних там минут там получался который ты попытаешься руками глазами свести вот вопрос по чтению не может по другому пути мы сразу стали вот с production system собирать таким мощный массив данных и уже по поводу уже на на основе там стали раз стали строить какую то какие-то свои выводы кажется что эти подходы друг другу не противоречат на этом у меня все спасибо большое прошу вопросы а можно я сразу вот задам вопрос когда в open source выложить ваш вашу реализацию джотто вопрос задают до регулярно пока скажем так разговор об этом ведутся постоянно планах пока нет но вот мы начали с того что мы начали выкладывать наш tool kit если ты помнишь еще в начале года мы ее ты того не выкладывали не нет не то чтобы там вот смотрите работы идут а вот талкитна питания да написано почему написан был свободный программист на питоне нет был свободной программе снайпер ли понятно и в качестве компромисса вы парни к вот до 0 или что наверное большинство бы обрадуется если это будет это будет питон если ты спрашиваешь почему почему нила в тот момент было легче хорошо дурацкий вопрос я был первый дурацкий вопрос насчет того почему ло но это наверное очень толстой не буду сдавать его вопрос задавал такое почему вообще решили что у вас какие-то проблемы компилятором то то есть вот как бы с какой стати вот так дошли до такой жизни да то есть почему почему почему вы решили что вот ваша проблема верховная на в области компилятора значит ну все таки наверное не проигнорирую первый вопрос 0 ответом будет ну силу исторических причин потому что я давайте вот тогда почему мы стали смотреть именно в просторную производительности вид компилятора ну ровно потому что мы когда переваривали вот этот код лоджи to do и адаптировали какие-то решали решали свои проблемы очевидным образом вот архитектура распадается на какие-то части и каждую из них мы посмотрели а вот после наших изменений что стало там с горбач коллектором там или с системой типов там с виртуальной машины и в том числе в какой-то момент дошли давайте попробуем объять умом jit компилятор и посмотреть что там происходит и вот с тех пор началась вся вот эта вот вся вот эта история вот и потом осторожно смотреть как же компилятор работает внутри поняли что некоторые вещи работают для нас не оптимально самом деле коллега эрлих здесь присутствующие на прошлом хайло де читал доклад в котором он очень подробно рассказал почему open web пришел к такой жизни стал переписывать компилятор ну давайте тогда некоторый да так в доклад от игоря был смотрите logic это нет нет нет нет не просто жить компилятор да это не то что вот вы ставите ванильную lua а ещё сверху там какой-то jit компилятор да он полностью этот такая полный самостоятельно реализация ло там есть интерпретатор на горбу там там все все свое это такая система вот и как раз там набрался уже помимо лежит компилятора там набрался некоторый список проблем вот проблема памяти до про которые сказал проблема хэш-функций и так далее там упал ребят просто данные перестали влезать в ограничении лоджа то и все я так понимаю основного это стало триггером а потом уже да ещё вопросы у кого второй микрофон кто съем второй микрофон здравствуйте спасибо за интересный доклад к системам у меня вот маленький вопрос к своему стыду я вот не знаю лоджии то центрирующий ли профилирующий компилятор ну то есть он собирает профиль как бы входов функцию и срабатывает по набору счетчика или он просто в бане которому событию там не отчете к решает вот сейчас на чем обрабатывать по счетчику стоят в определенных местах спасибо вот но это восполнить пробел просто на них вопрос можем так вот такой вот если вы перенесетесь вот мысли на 2012 год вот экспириэнс конечно ну очень интересный понятно что компиляция это просто интересно вот а с точки зрения бизнеса и посмотрите вот тот путь который вам пришлось пройти вы бы грубо говоря не отказались бы от лаут в тот момент если бы знали что вас ждет я бы для того чтобы вот когда в 2012 когда вы принимали решение использовать или не использовать смотрите немножко тайма и нужно подправить мы вот в пятнадцатом году решили делать собственный fork-а к этому ложит мыса мы использовали больше девяти лет уже и это даже не это не 2012 год и к тому моменту я боюсь что что не было в интернете не было маленький вопрос меня смутило почему не считать отдельных ешь константу это в последнем примере когда вы та самая до статическое отдельных ешь не читайте строки очевидно это наиболее вычислительно сложная процедура и перемена доится допустимое решение почему нет потому что потому что бы стали стали смотреть как как было сделано в лоджике в том коде который достался нам по наследству когда мы формуле вот и мы увидели вот такое решение моего поправили домой поправили просто из ключей отключением это возможно это не самый оптимальный способ и спасибо пасе большое вам спасибо большое за доклад вопрос а у вас планы по развитию jetta какие-то вот конкретные есть там на ближайший год например ну и медленно наш реализацию до план а и план план и есть я не как раз том числе включаются попытки улучшить эпилятор а вот какой следующий шаг в аналитике вы в этих инструментах для вас потому что сейчас это все равно такой достаточно эвристическая штука я так понимаю но экспертная она экспертная донос дальнейшем было бы интересно например вот как раз прикрутить такие на автоматически эвристики которые помогали бы и сбываться снять этот груз с экспертов да и вот уже не показывать чтоб посмотрите-ка вот тут возможны какие-то плохие трассы можно начать вот те грехи которые вас в голове переносить в код таким образом развивать инструмент аналитики за доклад у меня один маленький вопросик чисто технически может быть глупой я немножко плохо поставлять внутри работает ло вот именно поэтому вопрос с обращением по ну и цитированием таблицы по функции как бы там же получается хэш-таблица и под индексом от сша и лежит целый может быть массив других элементов которые падающие вот так что в этом случае вот сделать или вы просто индексируется вот этот под таблицах спасибо за вопрос да там есть естественно есть разрешение коллизий и вот эту часть я просто выпустила доклад для того чтобы там не еще не вот эти слайды не перегружать информацию о том как разрешается калязин в данном случае там до обрабатывается поток мы найдем индекс - если есть коллизии мы это как-то другими спасибо за доклад очень интересно очень сложно и вопрос если какие-нибудь мысли по изменению самого языка lua для увеличения ваших нож производительности то не знает добавление типизации избавление от мир глобальных переменах или еще чего не таких константные да посмотрите спасибо за вопрос очень к вопросу что естественно об этом все время думали но конечно пока нет пока мы стараемся но вот на данный момент на данном этапе развития проекта текущей версии мы как раз стараемся как-то вообще вот устранить возможность этот зазор между ложит вам и в отдельном ло которое существует не несовместимость вот а что делать с этим потом насколько менять язык ну конечно как бы было бы клево вот но сознательно мы не хотим и не хотим оказаться в такой ситуации когда вот там компания работает с этим диалектом луи вот ведь там несколько десятков разработчик слов это не знает от слова больше этого никто этого не знает поэтому конечно желательно было бы ситуацию выходить там уже на уровень создателя языка и пытаться продать иди если мы это понравится такой же мы будем только рады небольшой вопрос интеджер у вас уже есть и интерьеров ну смотрите вот когда работает jit компилятор он у него есть этот тип int и он он работает но вот именно в языке в языке не нет собственной поддержки интерьеров нет все как поскольку форкса jetta 20 то там 251 соответствие только doblo спасибо за доклад меня вопрос такого сорта вы показывали несколько диаграмм по скорости компиляции да вы пробовали компиляцию скучать как факт новый восход постоянный логичный шаг с компиляция не проводить каждый раз а переиспользовать сохранить объект конце концов ампулу а у вас есть нет планируется смотрите значит во первых когда мы говорим о джейд компиляцию мы ее вот так не можем взять отключить как минимум потому что у нас есть проекты где она добавляет производительности или как минимум не не ухудшает поэтому просто его выбросить не можем во вторых собственно компиляция да она же ее суть в том что у нас вот данные входные поменялись в мерности эти потоки данных с которым мы работаем эти данные потекли каким-то своим путям этот быстро сделали это быстрый пульс компилировали получается быстро а так мы поэтому нет мы не можем выбросить компиляцию я просто восьмерку точнее не то что вы красивы отключить его совсем по другим виртуальной машины java машину известно что они это делают их адаб ставим там дает время старт уменьшение компиляцию runtime и так далее есть ни одна машин которые то делать поэтому вопрос был такой может платить техники себе брали или там думаете такой взять пока не брали но в тот момент когда мы будем за ним улучшать компилятор да и над этим тоже мы подумаем извините сразу не понял вопрос из индия еще помочь вас очень интересный доклад я злой немного новичок поэтому спрашиваю вот я сегодня слышал про цифрам другом докладе был что скомпилированный код отстаёт от нативного там 1000 кода условно в три-четыре раза это него это как возможно я не процесс значит вы показывали диаграмм в которой у вас на 20 процентов отставала logic отлов и favourit кейси у вас да где то в начале в худшем случае у вас там в худшем случае у вас было даже небольшое превышение вот после всех тех всей этой работы которые вы провели по организации вот почему соответствовал бы эта картинка и чему соответствовать если вот если ваш вот с включенным jit ваш конечность сравнить чем-то другим по производительности как вот для просто для оценки качества кода который получается вот что что сможет любой данный дару хорошо рис тут только миллисекунды хочу обратить внимание не проценты да ну смотрите после то вот всей этой работы которые мы провели нам нужно вот на том на ту инфраструктуре которую в тот момент располагал располагали нам лучше будет проекты из группы 3 начать переводить группу 2 и 1 вот соответственно что касается вот того где уже было хорошо те оптимизации которые мы предложили вот оптимизация которая работает с таблицами на на более-менее универсальна данная везде то давал давала свой прирост другой оптимизация на которую изначально мы обнаружили на приложение со специфической архитектура вск учит очень входа она естественно не вот на других проектах которые не имели такого количества входа она она не приносила прибор вот но так или иначе мы вот всячески или минировали вот эту третью группу вот а что касается сравнению с другим с другими продуктами нет мы как бы у нас есть какое-то такое понимание что всего будет работать быстрее чем ванильного ваниль ntp интерпретатор ну вот а так как таких подробных бычьих марков мы и делали и свинья все таки как бы а вашу личную какую-то оценку можно вот-вот вне доклада даже что что вы что вы да что может можно получить на выходе папа производительности с чем-то вот как никак докладчика как вот человек как программист как специалист могу позже подойти давайте может обсудим это позже потому что так вот сложно сказать на мужчину есть проект это который в которых содержит если вы вид нам в сторону других виртуальных машин и других языков то я вот так сразу сходу затрудняюсь нужно как-то обсудить подробнее да если у кого то остались какие то вопросы сразу скажу что вот нас есть стенд может на него приходить там буду рад ответить на все вопросы осей paura"
}