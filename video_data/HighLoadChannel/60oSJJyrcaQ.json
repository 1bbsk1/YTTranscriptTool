{
  "video_id": "60oSJJyrcaQ",
  "channel": "HighLoadChannel",
  "title": "Как мы запустили offline-версию сайта RG.RU / Алексей Чернышев, Максим Чагин (Российская Газета)",
  "views": 935,
  "duration": 3085,
  "published": "2018-01-16T13:44:07-08:00",
  "text": "пожалуйста дай сюда всем привет меня зовут максим это мой коллега алексей мы работаем в российской газеты да ох российская газета официальное издание правительства россии после публикации в ней вступает в силу государственные документы то есть как только опубликовали в газете документ вступил сила никак не раньше наша аудитория около 1 миллиона посетителей в сутки сегодня мы поговорим обувь line для начала давайте определимся что такое eveline и и зачем там вообще что-то делать как часто запрашивает страницу мы видим сообщение нет подключение к интернету самый банальный пример который обычно приводит это поездка в метро или на даче то есть ждешь секунд 20 потом получаешь вот все еще это хотя уже давно существует возможность отлавливать события отсутствие интернета и контролировать содержимое которую ведь пользователь давайте представим у нас сервис доставки пиццы клиент заходит у него нет интернета ждет 20 секунд и видит все тоже самое ну не думаю что это остановит его от заказа при слове что он действительно вкусные но вы уверены что для того чтобы зайти на сайт выбрать пиццу наполните ингредиентами отправить форму заказа нам действительно нужен интернет да нет конечно все это мы можем сделать и в off-line а когда появится соединение отправить уже на сервер для обработки заказа если интернет так и не появился можно править нотификацию прямо в мобилку да то есть ой там сын смешным по телефону или останешься голодным вариант конечно не идеальный но лучше ничего вообще это может быть абсолютно любой кейс если у вас интернет магазин можно пользователь сообщить о распродаже в случае информационного контента можно дать почитать какие-то интересные материалы вообще вся работа в офлайн строится на использовании serviceworker а давайте сейчас алексей нам расскажет что это такое это же работать друзья вообще кто из вас использовал serviceworker же в работе как-то на хорошо вообще у него очень много разных есть свойств и опять большой поэтому все вот это множество можно почитать и найти в интернете сейчас я вам расскажу только основные базовые такие части которые просто помогут понимать что вообще происходит с этим so fly нам и так а serviceworker это событий на управляемый worker который получает в себе java script file и соответственно выполняя этот файл мы можем контролировать страницы в контексте которых этот serviceworker был вызван также serviceworker может перехватывать различными запросами модифицировать их на этих же подконтрольных ему страницах и serviceworker соответственно может кэшировать ресурсы через специальное кэш api также хочется отметить что он работает в параллельном от основного потока потоки и соответственно ему поэтому недоступен дома или там какой-нибудь и local storage или объект window но зато он выполнять это действие не блокирует основной ей браузер что же нужно чтобы serviceworker в принципе мог заработать на сайте и уже вот эта вся магия могла действовать его нужно зарегистрировать потому должен пройти этап установки и этап активации как зарегистрировать serviceworker наклеить и нужно вызвать вот такой код в метод регистр передается путь до нашего serviceworker а если он этот файл доступен а если его можно выполнить никаких ошибок не возникает тогда serviceworker считается зарегистрированным и он начинает прослушивать и просматривайте те страницы которые находятся в его области видимости немножечко про области видимости то есть если serviceworker положить например в корень сайта ну рядом с favicon например то он будет видеть все страницы которые находятся дальше внутри нашего сайта если вы положить в какой-то подкаталог например то тогда он будет иметь свое действие только в страницы которые находятся внутри этого каталога либо же мы можем программно ограничить его область видимости через вот это свойство скоб в данном случае мы ограничим его чтобы он работал только в подкаталоге и ortica после того как serviceworker зарегистрирован он уже начинает слушать какие-либо события первое события которые у него возникает это событие установки обрабатывает и событием и каширу им ресурсы которые впоследствии будем использовать для дачи клиенту оффлайн какой-то версии мы их фишеру им через вот это кэш api в браузер после этого срабатывает события активации тут хочешь заметить если serviceworker в принципе первый раз только на странице регистрируется активируется то после этого сразу срабатывает событий активации и там что либо можно сделать обрабатывая это событие если же serviceworker и например обновляется то есть уже до этого у нас была какая-то версия serviceworker на сайте она работала потом мы что-то поменяли файле браузер кстати примерно через сутки проверяет вот эту идентичности и потом понимаешь что она у меня новая версия serviceworker лежит на сайте давайте-ка ее обновлю и после этого он опять в новом serviceworker запускает регистрацию и установку но в этот момент новый serviceworker начинает находиться в режиме ожидания так сказать если вдруг у пользователи открытой страницы со старыми serviceworker только пустого как все это закрыть срабатывать события активации в новом serviceworker и дальше он уже может продолжать работу также есть специальный метод которым можно пропустить все это ожидание и сразу перейти к активации так вот обрабатывая события активации мы можем как раз за старым serviceworker am так сказать почистить какие-то данные или там то что было ранее нужно сейчас она может быть не нужно после того как эту активацию мы обработали serviceworker начинает работать уже в полную силу а именно ему доступны следующие события событий он месяц она возникает внутри serviceworker в тот момент когда мы можем с клиентской стороны serviceworker что-либо говорить сделать ну посылать сообщения через пост message события fetch и она как раз одно из самого важного вот в этой оффлайн методики она возникает в тот момент когда в этих подконтрольных serviceworker страницах запрашивается какой-либо ресурс и то есть обрабатывает и событие fetch мы можем обработать этот ресурс за прошлой странице события push возникает в тот момент когда от какого-либо сервиса например от злого сервиса возникает какой-то push-уведомления в браузер мы его можем также serviceworker обработать и события sing возникает в тот момент когда мы наклеить и хотим что-то фоне serviceworker обновить какие-то данные то есть сказать ему там нами что-либо вот используя все эти методики serviceworker и мы можем идти дальше в построении нашего приложения как это включить слышно теперь когда мы знаем что такое serviceworker и что с помощью него можно управлять пишем хотел бы выделить основные стратегии к подходу по строению фрейм приложения первый вариант это статика то есть мы берем вообще все что у нас есть на странице html css фон тиз в г н г и закидывает кэш то есть это самый простой и быстрый способ сделать ваше приложение доступным офлайн и но у него есть существенный недостаток подходит он для редко обновляемого статического контента если информация у вас меняется чаще чем польза хоть на сайт то есть вариант что она попросту потратиться актуальности станет никому не нужно вот такой вариант можно применить для там запиши ровать расписание на конференции да у нас уже есть докладчики у нас все уже там собрано все скомпилирована и закинули в кэш и все счастливы не обязательно обязательно смотреть вот на эту бумажку второй вариант это offline first то есть вот такой неубиваемый сервис вообще offline first это способ создания приложения где подключение к интернету является своего рода усовершенствованием а не необходимостью то есть по молчанию мы считаем что интернета у нас нет вся серверная логика переносится на клиент как только появляется интернет клиентская часть синхронизируется серверной при необходимости пользователь продолжает работу как ни в чем не бывало но вот конкретно у нас допустим есть сервис какой-то публикации новостей до редактор может написать делать что угодно не и даже без интернет потом когда появится интернет это все синхронизируется с сервером и уже там можем дальше будет выводить как бы на сайт третий вариант это спа то есть развертывание в развертывании мини-приложения со своей структурой рау кингом дизайном как и говорил в такой мини приложение в этом случае мы перехватываем запрос запросов пользователя то есть и в случае если у нее нет интернета мы представляем какой-то контент это может быть все что угодно игра интерактив опрос все что хотите туда можно закидывать такой вариант не подходит для сервисов в силу того что у нас фактически происходит подмена контента но для информационного развлекательного ресурса это и реальный вариант и у себя мы используем именно его и сейчас расскажем об этом чуть подробнее и так примерно пол года назад на конференции маску джесс коллеги из lenta.ru рассказали что сделали одну очень интересную штуку если в процессе чтение приложения пользователь пропадает интернет они предлагают поиграть в крестики-нолики ну сама идея нам показалось интересны но вот одной игрушки как-то маловато как мы рассуждали пользователь заходит на сайт и видит все то же сообщение ну согласитесь банально теперь другой вариант пользу заходить на сайт у нее нет интернета и ему предлагать печать какие-то статьи ну согласитесь же лучше то есть по крайней мере есть шанс что мы завладели вниманием пользователя и после того как он пас того как у него появится интернет он пойдет где-то читать дальше уже на основном сайте прежде чем взяться за работу мы решили посмотреть как же обстоят дела у зарубежных наших коллег вообще тут есть анти сми или ну или как связаны нет вообще ну слава богу окей и собственный вот результат телеграф би би си и таймс garden washington post ну что есть то есть остальные в принципе вот кроме ленты то же самое хорошо как вообще себе представить такое приложение первое что приходит в голову это двухстраничный спа то есть у нас есть главная страница со списком новостей и можно открыть любой для прочтения ну как бы да понятно что это поле заходите в него нет интернет и он видит вот это вот то есть он ведь главную страницу может отлить рублю будет рублей прочтения то есть это страницу в статье тут важно очень заметить вообще как сообщить пользовали когда он заходит да и видит вот это вот что у него открылась именно оффлайн версия они что сайт теперь вот так вот выглядит ну мы пробовали много разных вариантов там и pop-up еще что-то и остановились на просто вот площадка сверху такой максимально заметны который сообщает что это оффлайн версия тут нет рекламы в правом верхнем углу есть индикаторы он красного цвета написано offline он сигнализирует о том что вот нет интернета как только интернет появляется индикатор становится зеленым и сигнализировать о том что доступно целевая страница тут надо заметить что в офлайн попадают не все материалы подряд то есть это связано со спецификой информационно контента то есть ну представьте приложение может быть открыты и через неделю или через месяц после последнего посещения в этом случае мы покажем пользователей что-то вроде в 20 мая в москве потеплеет и климатически нормы ну как бы кому-то в июне в июле начинает информация с другой стороны а советы как сохранить здоровье после 25 ну как бы всегда актуальная тема для того чтобы это все сработало необходимо хотя бы раз зайти на сайт если если пользователь заходит на сайт понятно дело что это не сработает то есть надо хотя бы раз 11 раз зайти на сайт после этого инициализируется serviceworker добавки всю необходимую информацию алексей сейчас расскажет об архитектуре приложения и как вообще все это работает раз раз два три то есть пользователь заходит на сайт и на странице и о клиентской стороне включается регистрация serviceworker а как я уже об этом рассказывал в этот момент пост о как все зарегистрировалась мы отдаем пользователю в кэш несколько файлов для оффлайн версии после этого мы проверяем может быть там уже было что-то старое мы это удаляем и начинаем проверять на доступность самой страницы через события fetch немножечко подробнее как это работает то есть обрабатывая события fetch мы посмотрим если ресурс запрашиваемый на странице в том числе и сама страница доступна то мы просто ее отдаем если же нет то мы уходим в исключении скетч и отдаем через кэш api как вы видите на скриншоте мы отдаём нашу оффлайн версию пока там serviceworker это все проверяет смотрит обрабатывает мы также параллельно смотрим нужно ли обновить данные для этой оффлайн версии пользователю чтобы всегда у него были актуальны новость но об этом немножечко попозже расскажу как вообще работает сама offline а вот эта версия как уже максим говорил это спа приложение анапа стандартные явись архитектуре то есть есть контроля в которых себя получает в нашем случае всего двора у то это либо главной страницы либо страница статьи зависимости от этого мы как раз забираем данные из кэша для страницы забираем нужный нам кусочек шаблоны и отдаем пользователю уже готовы html кстати здесь мы не используем никакие библиотеки типа react атом или angular а у нас только шаблонизатор ему старше и обычный java-script ну просто чтобы все это не перетаскивать пользователю в браузер как бы зачем ему это надо также интересно вот представьте вот мы открыли оффлайн приложению и как пользователи сказать о том что интернет появился есть конечно же такие события он онлайн он оффлайн навигатора и свойства онлайн но они к сожалению не сработают в нашем случае потому что эти события возникают в тот момент когда мы например в хроме в developer толстую меняем вкладка вот эту онлайн не вкладку вот этот чек бокс есть сеть нет сети либо когда мы и сетевой карты выдергиваем сетевой шнур тогда эти события включаются соответственно не нам никак не могут сказать о том если интернета нет ли интернета поэтому мы пошли немножечко другим путем он такой путь в лоб но он самой эффективной мы через определенный интервал внутри этого приложение отправляем статистику в google analytics но и все просто если статистика отправилась то мы понимаем что интернет появился и сообщим об этом пользователям если нет то просто пытаемся отправить вновь в тот момент когда мы запускали эту версию на продакшен и когда разрабатывали мы столкнулись с рядом проблем и конечно же мы каким-то образом решили сейчас мы с этим этим с вами поделимся чтобы когда вы разрабатывали вы бы не наступили на эти грабли как у нас проблема каким-то образом мы должны обновлять данные которые мы записывали пользователю чтобы всегда он увидел актуальную версию новостей на что мне ответили может учесть какие-то идеи бы ты же это разрабатываешь первое что приходит в голову конечно же этот сет интервал внутри serviceworker и почему бы не о том через определенное время будет всегда обновлять данные но он был такой ответ да действительно проблема с интервалом да смотрите мы провели небольшой эксперимент внутри serviceworker напиться написали функцию которая в цикле отправляла цикле каждый секунд отправляла простой get запрос на сервер и после этого мы заходим ну все данные конечно же лагера вались после этого мы заходим на тестовую страницу чтобы синтезировать со serviceworker и закрываем вкладку то есть и ждем пока serviceworker умрет так вот выяснилось следующее что в google chrome на десктопе serviceworker умирает есть пристают отправлять запросы ровно через одну минуту в firefox он отправляет вообще бесконечно то есть пока мы не закрыли все вкладки вообще все вкладки либо не закрыли сам браузер serviceworker работает продолжает работать в мобильном хроме он также работает бесконечно при этом при том что если даже мы и зак убрали его из приложений он все равно отправлять запросы то есть в итоге погостить serviceworker на самом деле удалось с огромным трудом вначале nude я сказал про логирование да мы отправляли что-то начале мы отправление нотификацию мне на телефон вот и в итоге чтобы от нее избавиться она бесило еще несколько часов я все перепробовал помогала только перезагрузка мобильного телефона поэтому ну вот service voip в принципе сорвал как бы может работ почему не стали вы использую потому что во первых не известно сколько это батареи живет у пользователя а это надо все тоже тестировать до его первым и потом неизвестно как бы ну уж в следующей версии что будет может быть они тоже как вам на десктопе ограничит и до одной минуты до поэтому мы решили пойти опять обходным путем как с проверкой на доступность сети пользователь заходит на страницу это сейчас опять когда у нас есть интернет такой вариант пользователь заходит на страницу ему записывается определенный метка времени в local storage в тот момент когда он ее открыл потом через какой-то момент он может эту страницу перезагрузить он может там через месяц зайти опять на наш сайт снимается опять метка времени и она проверяется с той которой была записана vocal сторож таким образом мы понимаем сколько времени прошло с момента последнего посещения пользователями нашего сайта и если было если это время больше 15 минут именно каждые 15 минут мы обновляем пользователю вот эти данные для оффлайн вверх если прошло больше 15 минут там и serviceworker отправляем запрос на то что дружище пора бы удалить из кэша старые данные и туда записать новые вот таким образом происходит вот это обновление данных в спецификации в документациях написано о том что разрабатывается вот это background синхронизация то есть можно фоне будет в будущем через вот например этот метод пиридоксин к обновлять данные для serviceworker и он будет просыпаться и там что то делать то есть примерно это будет вот так выглядеть то есть мы регистрируем по какому-то тэгу определенный интервал через который serviceworker должен просыпаться и что-то там делать вот это все в будущем и пока мы используем вот эти метки времени так сказать проверенные временем было время когда мы в метро тестировали оффлайн приложением и возникла ситуация когда интернета нет приложение нам это инициализировать но данные не поступили что же могло произойти на самом деле все очень просто вот в этом нашем спа приложение когда инициализируется вот это само приложение оно запрашивает данные естественно ну модель для своего отображения так вот запрос был через fitch что интересно в на компьютерах все работало на десктопах а но вот именно с таким с непонятным состоянием интернета например в метро когда мы запрашивает данные serviceworker не понимал есть интернет нет интернета и образовалась какая-то задержка определенная которое нужно было как-то обойти ну вот как это происходило то есть мы запрашиваем и образуют эту задержку а все решилось очень просто не знаю почему мы сразу так не сделали мы просто просим serviceworker у то есть посылаем как раз пост message из нашего спал от этого приложения посылаем запрос serviceworker а ну-ка дружище отдай нам данные которые у тебя есть в кэше вымыв получали и в принципе проблема это тоже решилась когда то давным давно вообще с чего вся эта история началась у нас были push-уведомления но они сейчас есть написаны на сервер с помощью serviceworker то есть у нас был один serviceworker а вот с этим сервисом push-уведомлений и отдельно от этого в отдельной ветке мы уже начали там разрабатывать оффлайн версию так вот что произошло в тот момент когда уже нужно было как-то это все объединять стал вопрос о том как же будут работать два serviceworker а у нас на сайте что вообще делать в этой ситуации сначала мы попробовали их как бы так подружить просто задать им разный scope но в нашем случае это не работает потому что и push-уведомления и оффлайн версия не должны работать во всем на всем сайте поэтому скоб не работает мы подумали задать и корневой скоб естественно но это тоже не сработает потому что serviceworker установленной позднее как бы заместить собой тот который был установлено ранее то есть какой-то сервис тоже будет недоступен естественно самое очевидное решение сделать один файл serviceworker и в него за им портить скрипты с этими сервисами но к сожалению просто так взять и перенести файлы тоже не получилось потому что и и тот и другой сервис они использовали это похоже обработку события инсталла чего и так далее поэтому пришлось сейчас будет конечно банальщина но на самом деле мы почему ценить тоже столкнулись пришлось все переписать заново ну точнее как все заново логика рассталась но мы сделали одно большое уже пава приложения для работы в serviceworker и уже в него мы подключали отдельные сервисы на данные на данный момент это только push-уведомления и оффлайн версия может быть дальше еще будет что-то у нас разработана через это поэтому решили сделать уже вот такой модульный подход ну и такой наш вам банальный совет лучше заранее сделать полностью какую-то модульную структуру в serviceworker и чтоб потом не пришлось переписывать если вдруг надо будет что-то еще в нем использовать и как это все надо будет соединять самое значимое событие настал тот момент когда уже вроде бы мы все сделали все отлажено и мы запускаем serviceworker нашего fly на версию на продакшен вы наверное догадываетесь какой будет следующий слайд что не взлетела а именно очень интересная ситуация на всех страницах сайта оффлайн версия работала но были странице где был video player так вот включая видео плеер видео отдавалась с огромной задержкой в минуту там три минуты зависело от скорости подключения к интернету потом посмотреть в консоли было видно что да это вот самая самая минимальная 9 секунд пришлось ждать до дачи видео и и больше больше то есть вот это видео даже когда мы в плеере включала включали она тоже проходила через serviceworker на самом деле мы подумали зачем вообще это все нужно нужно ведь как это фильтр поставить потому что определять есть у нас интернет или нет и отдавать ли пользователь оффлайн версию мы можем только проверять сам документ саму страницу нам все остальное в принципе не нужно через serviceworker пропускать таким образом мы добавили вот этот фильтр через обычная проверку проверяли на то что это get запрос идет от страницы и проверка на то что документ содержит себе заголовок текст html самое интересное после того как запустили вот это все равно не сработало потому что видео отдавалась тоже внутри serviceworker с таким заголовком почему я не знаю пришлось каким-то образом еще определять что это видео конкретно вот таким образом то есть у видео есть заголовок ренж и исключать еще из вот этих всех запросов видео вот через такой тройное условие это работает и благодаря этому мы смогли дальше уже этого fly на версию на продакшене и работы с нее вот он и сейчас у нас так живет ну что все бы хорошо но нам еще нужно как-то в оффлайне аналитику собрать да действительно есть еще одна проблема это аналитика то есть ну как бы интернет у нас нет запрос они отправляются это очевидно а знать что там происходит нам очень хочется может быть вообще мы все зазря делали самый простой вариант который мы реализовали это если в процессе чтение приложения у пользователя про и появляется интернет мы отправляем данные в г ну как бы вроде все хорошо просто данный начали собираться но есть одна проблема что делать с пользователями которые закрыли приложения до появления сети то есть вот я в метро до тому хрень какая-то в закрыл все ушел мы их потеряли а тогда следующий вариант давайте это хоронить где-то на клиенте и потом уже когда у пользователя повлиять интернет отправлять это решили что лучшим вариантом для хранения будет index is baby то есть если совсем коротко то индекса тебе это стандарт хранения больших объемов структурированной информации на клиенте и так индекс тебе работает синхронно поддерживает транзакции умеет работать с индексами умеет хранить большими большие объемы структурирован формации файлы было бы и работает непосредственно прямо и serviceworker а на самом деле наше приложение небольшой и и нам нужны из этих пунктов только первые и последние тверским выглядит вот так пользователь хоть по странице все данные отправляются падшую в базу данных и дальше мы делаем простую проверку на отправить данные в google analytics если данные отправляются мы считаем что интернет у нас есть и все базы данных очищается как бы все хорошо если данных нет если интернета нет запрос не отправляете как бы мы ждем следующего цикла после того как мы прикрутили вот эту штуку мы нашли примерно 10 процентов пропавший аудитория причем совершенно неважно когда пользователь зайдет к нам еще раз на сайт еще там может быть через неделю через месяц главное чтобы у него базы данных все еще был были наши метрики да и они уже отправятся к нам и мы их посчитаем чтобы именно данный момент когда вот только запускались данные были скажем так себе то есть это две тысячи пользователей в сутки ну для нашего сайта это не большая цифра тут сказалось необходимость установки serviceworker а нет то есть такой своего рода инфицирования пользователя на данный момент сейчас мы имеем около 6 тысяч пользователей в сутки но это порядка ста восьмидесяти тысяч в месяц да еще мы замеряем сколько пользователей пришло к нам из оффлайна основную версию сайта здесь получается около 3000 ну несложно посчитать 6 минус 3 да ну половинку от пропали с этим мы разбираемся когда мы только запускали приложения мы рассчитывали на мобильную аудиторию там метро дача рыбалка все дела там загребаем пошел с интернетом как только запустились 30 процентов от и десктопы для нас это было честно говоря неожиданностям десктопах у нас до сих пор это выглядит как просто мобильная версия в общем над этим тоже работаем есть в планах это исправить теперь о неожиданных применениях serviceworker а две или три недели назад было новостью блокировки российских сми на украине ну и вообще тему блокировок она и у нас достаточно актуальна ну я думаю все понимают о чем я говорю так вот пока админы настраивают бесконечные зеркала мы с вами также можем сообщить пользователю о переезде на другой домен или дать какую-то информацию и поможет разумеется нам в этом serviceworker вообще что происходит когда провайдер блокирует сайт по углу а на самом деле он в большинстве случаев делает простой 302 redirect в итоге нам всего-то нужно это отловить 302 статус ответа сервера как-то сделать через fitch то есть вот как мы уже уходим в офлайн как же горел алексей когда мы уходим через печь в исключения да в этом случае мы наоборот отлавливаем request и проверяем на ну а проверим на response статус смотрите здесь это спрос тост равен нулю не 302 они 301 а именно 0 почему так потому что на самом-то деле а serviceworker в случае редиректов не понимает вообще что происходит у вас на сервере вот в случае это только 301 тристану любой 300 redirect он не понимает вас происходит поэтому она дает статус 0 еще один вариант это отлавливания ошибок сервера то есть здесь все по аналогии с 300 вторым редиректом но код ответа нам приходит правильный давайте модифицируем модифицируем наш предыдущий вариант вот смотрите да здесь все тоже самое но статус нам приходит правильно поэтому можно спокойно вот лови то есть вот все что больше 500 до 500 1 500 вторая третья четвертая ошибка мы здесь вылавливаем и показываем какой-то контент а где это можно использовать если у вас наглухо лежит сервак пока админы пытаются его поднять фронт героически отдает какую-то информацию из кэша либо из резервного источника ну вообще этим нужно пользоваться мелочь конечно но мы не пользуемся поэтому у нас фронт выглядит вот так но мы не пользуюсь не потому что мы не могли сделать а потому что там есть что показывать пользователям и пока не определились какой контент подставлять в случае вот 500 и ошибки немного ну смотрите вообще вот работа с оффлайн эта часть как бы повода progress of web applications мы специально обошли эту тему стороной в конце с есть ссылки на информацию в интернете и полно ведь это немного поддержки браузерах здесь представлен поддержка serviceworker а в браузерах то есть смотрите ну на десктопе в и речь сафари serviceworker не работает в е можно сразу забыть о нем я думаю лучше все похоронили быть находится в стадии разработки без звука без указания конкретных сроков в сафари там написано что рассматривается поддержку течение ближайших пяти лет на самом деле он там есть но он там выключен по умолчанию то есть его можно включить через там какие-то функции разработчика но как бы для продакшна до для пользователей вы его не запустите ну на доставку на самом деле у нас это где-то 86 процентов аудитория поэтому в принципе не так уж и плохо думаю что у всех примерно плюс минус также на в мобиле несмотря на вот такую картинку до все красная тоже не так уж всё и плохо то есть в android браузере в 5 что версия это работает в chrome android тоже это все работает а это примерно 55 процентов аудитории в принципе тоже так ничего ну а теперь немного резюме да то есть это serviceworker то есть оффлайн работает уже сейчас как бонусом мы можем отлавливать ошибки redirect и вообще любые статус хотите 404 от лаваль пожалуйста хотели 200 отлавливать на здоровье никто вам не мешает и собственно говоря это расширяет доступность вашего сайта то есть теперь вы не только в онлайн о его flight если до каких для каких-то сервисов это будет крайне полезно иногда по моему на прогоне ко мне подошёл парнишка говорит что вообще сейчас интернет есть везде да на что ему ответил что вот сейчас я в автобусе сидел прямо в автобусе в москве и у меня интернета все еще не было то есть я зашел на российскую газету ну к нам я иногда сейчас так делаю вот и у меня не было интернет и мне показалось какие там статьи даже что интересно было как там мужик какой-то в ванной пять дней пролежал чтобы невесомость измерить ну в принципе интересно спасибо за внимание если есть вопросы задавайте спасибо за интересный клад у меня два вопроса первый вопрос я хотел еще раз понять как происходит и наблюдаться скриптов который загрузил serviceworker и второй вопрос правильно я понимаю то что ну допустим к dore открывая настолько там на страничку мы всегда какие-то популярные кстати да к примеру который по идее может заранее загрузить как предсказать что будет человек нажимать заранее загрузить да и следующий раз ну то есть когда я ножом на сайте то запрос на север не пойдет вот этот сохраненный страничку подключается смотри я сначала отвечу на второй вопрос потом уехать на 1 мы до теоретически вообще это возможно но смотри дело в том что ресурс обновляется очень быстро то есть вот то что теперь не интересно то что вчера было было до если это конечно не какая-то такой материал там вот то есть вот событий какое то произошло она сейчас есть варианты есть вариант такой с push push notification то есть вот пользовать который подписано напускная чикаться когда им приходится дефекация serviceworker будет и в этом случае то есть вот мы отправили модификации serviceworker разбудил ся и может загрузить ему в кэш какую-то вот эту статью которые как раз таки мы пукнули в этом случае он может открытию даже без интернета вот такой вариант возможен в других случаях мы просто обновляем какие-то интересные статьи то есть у нас редакция она помечает интересные статьи вот специальный там бегом или галочка я точно не помню и мы ее кладем десант и все это отправляется уже до заранее и все это отправляется пользователю в кэш первый вопрос до 1 там там все надо как-то рисовать мы нашли здесь нет потом я могу нарисовать удовольствием кто хочет понять интересно было шанса максимум в соседней комнате я рисовал здесь хотели на доске ну доски не просто нет в общем если просто еще с другой стороны то есть есть вот эта регистрация установка и активация вот эти три события возникают только в тот момент когда serviceworker либо в принципе первый раз на сайте устанавливается либо когда сервис serviceworker мы файл поменяли руками и пересолили его там вот каждый как раз сутки потом смотрится вот это hash-сумму в общем проверяется браузером обновился он или нет так вот только в этот момент опять срабатывает события регистрация во время регистрации нко раз проверяет надо его дальше обновлять не надо и потом всплывает вот эта установка и активация и вот самый сложный момент это активации то есть как бы но если представить не знаю как там компьютерные играли windows то есть как есть установка она всегда всплывает в serviceworker есть два теперь представь есть две версии serviceworker старой версии новая версия старая работает и вдруг пользователь а у него там в кладке эти были открыты со старой версии и они у него до сих пор открыто и тут он открывает новую страницу и у них уже новый serviceworker пытается проломиться соответственно но это по соображениям как бы разработчиков если мы сейчас всем обновим serviceworker тогда все вот эти страницы с которой старые используют они все то переломают но мало ли там что serviceworker делает поэтому новый serviceworker устанавливается там он может в кэш что ты записано что то сделать в в момент установки и все и он начинает ждать то есть он блокируется как бы у него бесконечно вот это ожидание пока не закроется странице использующий старый serviceworker вот по столько как все закроем ли полностью браузер закроем тогда новый только после этого ну то есть представим все мы все закрыли открываем заново страницу вот эта регистрация установка уже как бы ну пролетает мимо и всплывает событий вот это активация и в этот момент мы что-то можем сделать а можем и не делать как бы тут есть определенный инструментарий в serviceworker и мы можем им пользоваться либо не пользоваться то есть мы можем и install не обрабатывать событие установки и активации вот и мы там подчищаем что не нужно старый кэш вот у месяц благ этом если который благополучно забыл к чему эти боже ну вы поняли сам смысл то есть и потому тот активация возникает потом у него подробнее расскажет нам три версии рисунка есть вот буквально да да да там у нас как раз мы рисовали это все в нескольких вариантах спасибо за доклад судя по вашим же слайдам скрина usa да да да именно по этим то есть у вас на а и расина на ну в общем на на всех сафари и ничего нету да да да все это работает только в android в сафари ты не работает в принципе если вы в мобильниках откроете то у вас не заработать у нас до была проблема там у руководства только там майдане заходит эти бы привет вы че вообще занимаетесь то собственно вот отсюда я вопрос по вашей же статистике это примерно 50 50 процентов аудитория не пробовали appcache использовать как кубок нет не пробовали просто на самом деле ну как бы вот этому штуку сделали чтобы ну как не то что поиграться да интересно было вот поэтому что-то там докручивать допиливать какими-то костыля не костылями как и все я да я ещё добавлю только бы в чем дело все началось как я рассказывал сертификацией то есть в росте вроде у нас уже serviceworker а потом вот как раз мы посмотрели доклад lenta.ru они крестики-нолики сделали как в общем бы и нет никак не потому что почему и нет там только давайте уже не крестики-нолики там а давайте вот сделаем ленту с новостями и вот оно как то вот так поехала поехал то есть у нас не было задачи а давайте мы теперь еще и оффлайн зацепим то есть она вот как-то так случайно возникла и просто в чем самый интерес в том что на самом деле то есть это оффлайн версию написать или не очень сложно то есть там буквально вот самое сложно понять как вот эти события там когда что отрабатывается а так просто отдавать что-то из кэша это очень просто и поэтому мы как бы взяли так и вроде бы как по-быстрому той из запилили а потом вот я начал рассказывать какие проблемы из-за этого стали возникать в том числе там дальше аналитик честно как бы можно идти превью надо еще ну как будут у нас конкретно такая проблема это монетизация да то есть ну как бы пока мы не монетизируем оффлайн то что то там делать вот на остальные процентов территории достаточно бесполезна и лояльность пользователей время из пользователей ну те кто не знает что такое вот оффлайна работает они как бы и не знают ну что вот я на яндекс зашел у меня там или google у меня не загрузился ну как бы ему и он энергия зашел ему в принципе как бы достаточно все равно но не то нет вот здесь как бы вот эта штука это как раз таки бонус какой-то то есть это не то что то необходимость какая то это именно бонус довесок но я бы даже добавил это скорее для тех кто в принципе посещает то есть не просто зашел там с поисковика случайно на сайт те кто вот постоянный посетитель это им такой как бонус и к сожалению game тоже сейчас не могу пользоваться у меня слишком старой android вообще маленький и iphone и по ритму но с телефона жены я захожу и как бы но трешь радовать до лишь тестирует все джинны я не знаю нас есть еще время нет просто это это вот пример из жизни он действительно работает я это видел своими глазами то есть я тестировал на телефоне жены мы вместе едем есть какая ситуация все в метро ездит то есть открывается сайт нет интернет он redirected подключись к метро ну вот это вот все там потом кучи рекламы она открывает и из-за rg они не переходит на подключить к интернету он не нашел flyme версия врубается и она такая опять то тестировал у меня на телефоне типа не могу подключиться к интернету приходится другой сайт набирать но и в этот момент она о какая типа какая-то новость там было чуть против про жильё как ну так как универсальное общем и я заметила она так всю дорогу в метро залипла все эти новости читала и я присяде работу ну то есть она работает но это к сожалению нужно как-то узнать мы не какие баннеры там по этому поводу не вещи никому не говорили там у нас offline здравствуйте пасибо что можно сделать чтоб при первичной загрузки она как-то быстрее но сейчас пробую да там секунд 30 может в принципе прикольно там 10 статей есть позалипать метро хватит чтоб первичный старта и не знаю ходьбы показывал там еще интернет первичный старт в плане вообще вообще когда устанавливать элис уокер или сейчас сейчас да да да смотри после у тебя до если у тебя и как бы нет интернета то он он там браузер пытается да конечно не пытается помощница показать в то время потом пытают в этот в это время нет наверно в том то и прикол как бы serviceworker внутреннего когда мы fetch обрабатываем вот этот запрос в том то и дело что он уходит в этот в promise то есть печь с запросом уходит и он ждет либо ему уйти в резерв либо в реджекты мы в этот момент ну гипотетически может быть можно что-то вне этого засунуть там не знаю но мы либо то прорабатываем либо то либо у нас вот в том-то и была проблема как раз я рассказывал прости макс это больная тема наши просто проблема когда по глупости вот в этом спа приложений самого оффлайна мы запрашивали данный через печь потому что как раз нет интернета зачем-то через свич запрашиваем данные соответственно опять пытается получить эти данные интернет это не ты вот эти задержки происходит ну это же история от я нажимаю назад вот это уже чуть чуть больше на другой лад не уверен у это онлайн версию могилу потом на середине интернет попал в офлайн нажимаем назад он такой тогда он думает как раз я он запрос пытается отправить не получит ли в первом старте atarraya и матипа его нет а при назад такой да если у тебя допустим а вообще мы в настройках выключены мобильные и вай-фай да и он в принципе понимает что трудится он очень быстро должен отлавливать то есть ну по и действо вот пока я на сингл печь моментально ну да да а это когда этого был напал на май страница он вот день за я был бы метод понять что интернет не слишком хорош чтобы тебя дать полную версию вот это уже это как говорил макс над этим надо работать принёс спасибо за рассказывается очень раз мы должны на авто mail.ru деньгам сделали оффлайн версию мы не сделали отдельную версию marinika из минету есть есть недавно на наш тег сценария хитом и даже на гугла его показывали наш логотипчик все красиво ну это под маркетинговый мой бомб lo-fi технология вопросов если ночь короткий по прошлому вопрос у вас правду про процент files 4555 окей и по поводу на сумму технологии вы депо и spring сначала пытайтесь пасти получить данные да потому даетесь каша можешь сделать наоборот и периодических актуализировать это же ответить вопросам тоже достаточно короткие что вы делаете с медиа ресурсы минуту статья не только текста тысяч какой-то без интерактивный и что у вас с трафиком но как следствие досмотрите мы специально для того что ну как бы мы рассчитывать на мобильной аудиторию поэтому мы не грузим вообще никаких медиаресурсов туда то есть там нет ни фотографий да да да вот как раз когда придет стоп рассказал 30 процентов у нас вот следуешь как раз таки итерация это загрузка туда меди то есть мы собираемся оптимизируется для десктопа показывать какие-то изображения до превьюшки и меди контент какой-то загрузить но думаю да фоторепортажей каких то огромных да и видео мы скорее всего не дойдем но какой-то небольшой медиа да какое то представление скорее всего там будет да да я просто добавлю тут так вышло мы с максимом любим пользователей просто не хочется все пихать в брак бывает гипотетически гипотетически можно реально прям полную статью закатать в этот в кэш там вообще проблем нету ну в этом к shape просто перечисляешь ресурсы то есть принципе то можно но как бы зачем да просто чтобы ну у нас есть рекламная служба которая пихает баннеры да там по 2 мегабайта по 3 мегабайта пользователь если мы еще будем этим заниматься то ну совсем нехорошо получится да я добавлю насчет каша здесь есть все-таки различие то есть есть кэш который браузер кэширует там кают страницы от понятно он там самые кэширует и мы этим управлять не можем а вот как раз кэш api позволяет то есть вот мы если зафиксировали пока мы сами не удалим она там мы будет так валяться поэтому как бы ну не хочется привет спасибо два вопроса вы во-первых проговорили такую вещь что у вас внезапно оказалась треть оффлайна на десктопах и вы собираетесь этим что то делать но вы разобрались откуда вообще кто эти люди как эти люди эти люди в основном из регионов то есть можно даже посмотреть у нас есть у нас монитор и там выведена оффлайн версия но как в города кто знает там в реальном времени и мы прям смотрим вот регионы там х поход посещаемость 1 так хоп регион какой-то отрубился прям такой красный вот этом fob здесь регион отрубился вот десктопы это вот оттуда в основном до стоп оттуда это жизнь мы здесь смотреть не знаем об этом она сразу оказаться у людей на десктопах нет интернета да ладно спасибо и второй вопрос это то что вы сказали что можно отловить и директ и в этот момент там в случае блокировки что-то своя туда пропихнуть не будут меч понятно если вас уже заблокировали то как вы сможете сказать куда переезжать да да да смотри а это надо заранее сделать serviceworker и то есть если ты ты как бы заранее получать ты а ты заранее допустим ну мы же все знаем вот коллонна заранее заблокирует да ну как бы чуть-чуть скрывать ну может быть не все может быть не все до нас кстати ну мы федеральное здание и нас у нас блокируют тоже там где-то кто-то указал не ту информацию там в краснодаре на заблокировать такие случаи бывают уже но мы сейчас не об этом а вот мы конкретным напряглись и чуть каталог на украине даст мне начали блокировать она с такими заблокировали что обидно да вроде мы тоже крупная смех у нас не заблокировали да да да чуть чуть вот но и тем не менее получается чем я говорил то о том что надо заранее продумать вот это все надо заранее продумать то есть вот это вот если тебя звала киртан от заранее то закинуть туда при этом до важный момент что после того как я заблокировали ты уже serviceworker не обновишь как бы все это уже вот мертвая . поэтому там можно через какие-то там импорт скорее туда сделал то есть такие хитрости то есть где то откуда подгрузить его с другого домена там из идея но это только через импульс скриптов можете сервис лорка так не обновится вот сама в этом же доменико что как бы ну домен уже не существует и его как бы уже отдал тебе уже отобрали ну не надо продолжать вот как вот мы и оффлайн открываем да как оффлайн открываем версию там какие-то эти вы все что угодно это может все что угодно страниц вот как ты открываешь да там странице сайта это может быть такая же страница сайта может нам написать чувак мы переехали сюда сюда там куда заранее узнать первые то надо продумать стратегию такая вроде как продумали на пять лет вперед как вот сафари делает даже вы продумываете нет если у вас такой небольшой сайт у вас не будут блокировать то здесь вот клевая штука это как раз таки вот ошибки сервера отлавливать вот вообще потрясающая штука можно вообще без проблем то есть показать реальный какой-то контент хотите с крыша хотите вот из резервный источник а сидит что-то там тяните вот это прямо причем это делается буквально за вот если вы офлайн уже сделал вот это делается за пять минут я не ну вот скопипастить вот проблема то как бы постит только вор не вы продаёте все ну да как бы вот ошибки сервер пожалуйста я просто сейчас на самом деле она так и работает вот берешь кусок пример и пластичные но там очень просто все serviceworker это обычный java script там чё такого не дай можно вечере использовать прямо как печь без всяких ну конечно полифилы полифилы в парке работает тоже 6 точно бы трахнуть это плюс даешь 6 можно использовать по полной хоть и стрелочные функции наслаждаетесь хотите fetch вообще без проблем то есть никаких полифилы просто фигачить и туда в serviceworker все это будет работать это на самом деле очень круто то есть но как бы скилл повышает я не разрабатывал к сожалению меня скилл не повышена вот лёха прокачала да все так"
}