{
  "video_id": "XHBKl70st5Q",
  "channel": "HighLoadChannel",
  "title": "Использование Docker в CI / Александр Акбашев (HERE Technologies)",
  "views": 1550,
  "duration": 3231,
  "published": "2018-01-16T12:34:15-08:00",
  "text": "компания hero компания занимается геолокационных сервисами продуктами среди наших собственных у нас есть как карты так собственно трафик я не знаю различные вычисления маршрутов среди наших заказчиков являют и затем просто произойти сферы являются amazon в фейсбук microsoft ну и соответственно сергей автомобильного сегмента тоже там почти все марки то есть mercedes бмв и audi и очень очень многие то есть три четверти всех автомобилей которые ездят по европе ездят так или иначе с с нашими продуктами это могут любой карты либо программное обеспечение навигация так далее компания работает 6 тыс человек компания очень огромная и я представляю офис который берлинский собственно о чем сегодняшний будет доклад то есть я расскажу о том что такое continues in the гриффины в понимании he то есть понимание конкретно то этой команды той области где работает где-то шести ста человек ну и собственно какие мы прошли этапы развития нашего continues in the графина в плане поддержки инфраструктуры моя собственно как мы сделали и мониторинг да многие кто-то уже видел спойлеры вот и собственно к чему мы пришли туда для начала установим контекст что такое собственно continues in the гриффин наденешь на гриффин система в нашем понимании то есть когда мы говорим про себя про seo систем мы имеем ввиду не только сервис который делает continues in the грешим мы имеем ввиду также там всю обвязку да то есть там нсс гид все все все все вместе все то что позволяет нам делать continues in ты грешен несколько фактов о нашем континиус фотографии то есть в качестве основы мы используем дженкинс который развёрнут на наших инстансах то есть это не какой-то там общедоступный drinking нас используются разные версии то есть есть там платиновая версия 1с с чем-то двух-трех летней давности есть там более новые версии которые также используются на всей он находится в доке преимущественно то есть у нас как правило каждый новый день мы встречаем с абсолютно новыми нодами то есть нас облака организована на основе амазонского облака но используемые ситу плагин для этого тоже платиновой версии ну и собственно у нас также есть какие-то девайсы то есть там реальные устройство из автомобилей то есть вместо того чтобы там ставить автомобили или подключать их к интернет вот у нас есть точные копии этих девайсов лабораториях и лаборатории также у нас подключены к continues on the графини ну в некоторых частных случаях мы разрешаем разработчикам подключить их локальный девайсы ксиай а также у нас очень много сконфигурированных проектов в рамках нашего continues to the грешно то есть там все это идет на 1000 вот о нескольких горы на абсолютно разными образами теста месте pipeline плагин есть и фристайл то есть когда там надо кликать ручками и есть там с помощью друг детства или созданные проекты очень важно заметить в то абсолютно все изменения которые у нас вносятся в код они все проходят при commit проверки то есть там не один там разработчик на чем бы он ни писал не может закомитить код не получив + 11 то есть пока нет плюс 11 код не в мастере есть + 1 тб seo пожалуйста можно в мастер очень много разных платформ и очень много разных продуктов то есть там счет продуктов десятки ну и платформ тоже там есть iconx и android os и linux конечно windows это все нужно как-то тестировать нужно как-то связывать мы собственно тоже очень важный момент большинство наших пользователей 99,9 это наши коллеги оставшийся оставшееся до доля процента то мы сами то есть грубо говоря все что мы делаем мы делаем для людей которых мы знаем так или иначе ну или по крайней мере не могут нас найти в любой момент времени рассказать нам дать обратную связь в любой форме вот тут то есть вот накладывается свой определенный отпечаток ну и собственно вот вся и как он есть да то есть такая махина большая вот и какие-то этапы развития были в этом все это есть вот например самое на иное время то есть первые первые первый напиток сказать денечки все очень было очень просто с точки зрения настроек и также простота можно было все разломать и остановить просто работают всего какая то есть чем это время можно охарактеризовать первых это было переменное окружение hasta да то есть например если какой-то коллега хочет сделать какой-нибудь интеграционный тестом я не знаю и поменять и тисе halston его меняет без проблем для себя то есть там су доне су дон не важно он меняет и соответственно следующий билды которые ведут на этом же к стене начинают падать просто не думали что не делать интеграционный тот против продакшена они делают интеграционный тест против сервер и которого нет но там утаить исихастов поменяли все как бы и ты ты так смотрится такой узкий ты думаешь вашу как так вот но при этом сделать ничего не можешь то есть людям же реально нужно делать вот такой вот интеграционный я могу сказать нет вот у соответственно было также требование но не требованию рекомендации что хорошо было бы чтобы пакеты не повторялись на агенте дохтуру на каждом агенте была одна версия питона одна версия каждой системе эти вообще всего одна версия то есть для чего это делалось ну потому что очень многие продукты они странные то есть грубо говоря если взять там семейка 3.2 например у него один порядок и нсо лизации питоновский библиотек если взять семей там 3.6 у него другой порядок а то есть там если у вас разные проекты требуется разный семей то за бесплатным также может достаться разный питон то есть и в общем все это превращала континента гриффин в спагетти ну и соответственно любое обновление любого пакета тоже было кровавым месивом потому что ты обновляешь пакет вроде обновляешь minor на вот но оказалось что там есть какая-то дикость и ниже по стыку которая меняет и pr в этом системном пакете собственно все опять сломан ася и сломан разработчики заблокированы + 1 никто не видится вид -1 все злые чатик просто кипит вот а ты не хочешь этого допускает дать тебе нужно всё проверить и что вы проверить тебе новый пакет тебе нужно понять новую ноту там новую виртуалку не знаю с каким-нибудь новым лейблом спланировать какую-то существующую дро пультом с помощью параметров запустить ну вот работает на масштабе когда такая гроба 1 а если их сотни а если тысячи в общем процесс был очень плохой ими масштабируем ни разу еще были проблемы социализации то есть были достаточно интересные кейсы например когда кто-то хочет проверить совместимость с пятым центросом да то есть ну пусть то он ему хочется 5 centos то есть мы не важно кто то мол ты загнул поддержка закончился уже старенький вот и для этого нужно держать ноту то есть вот там что то делать собственное поэтому пробыли проблема в том все социализации были проблем то было много собственно была еще одна проблемах то очень многие утилиты имеют стараюсь закачивания то есть там дрова там maven грабил закачивать бетон из из интернета питон заканчивает с помощью пипа руби то есть и там мне нужно запустить не знаю какой нибудь проверку 3 трех строчек кода для того чтобы запустить три строчки кода проверить я скачиваю там пакетов на там сотни мегабайт я это делаю на огромном масштабе вот и собственно это все нестабильно работает медленно и и собственно никто не счастлив ну и соответственно да это в принципе очень небезопасно долбить интернет из при коммент проверок вот потому что он там кто угодно может мы видели пятисотке от google от не знаю бен 3 млн пеппи внутри сим и везде видел пятисотке вот время 3 мес разные частоты разумеется но идея в том что все равно никто не хочет получать негативный фидбэк то есть трубы его тесты подари из за того что там кто-то там большой большой компании сделал ошибку ну и мы решили давайте вот решил мы все наши проблемам и вот у нас есть такая клёвая вещь как докер там пик hyip обл все за контейнеризации за изоляцию и вот начали проект докер для чего мы его начали вот для того чтобы мы понимали что мы как команда который отвечает за continues on the grave мы можем отвечать за контент докер образов соответственно мы также получаем плюс 100 окружении которые используются в кантине сцинтиграфии полностью полностью может быть повторен о локальном разработчиками ну и соответственно самое главное для чем это делали чтобы у нас тесты не эффект или друг друга да что там главный плюс контейнера в том что каждый apple техник который запускает внутри контейнера думает что он единственный для него это как отдельной операционная система ну и соответственно мы можем внутри контейнера копировать что-то да то есть мы можем записать за запихнуть нужные питоновские там не знаю но две соски и все угодно dependency таким образом нам не надо их каждый раз вы кажетесь интернета не просто нас будут лежать внутри образа ну я понимаю что время может быть не самый удачный второй день и все-все-все наверное рассказывали в этом помещении про докер но тем не менее я дам парочку слайдов поставив как минимум один человек здесь не появлялся в этом зале вот и специально для него я расскажу про докер собственно докер он предоставляет изолированная пользовательское пространство то есть как я уже говорил то есть для каждого процесса который запускается внутри докера он думает что вот он один такой отдельные у него есть свое силу своей памяти и остальных остальные процессы он не видит чтобы создать дудка докер-контейнер существует decat файл так вот выглядит простейший джокер файл в этом файле мы на первой строчке говорим в тот мы в качестве базового образы используемого бунту 1604 ну и соответственно дальше но от нас есть там два слоя да то есть мы вы два вызова командира то есть первым обновляем список пакетов до 2 мы устанавливаем 10 секреты себе печать ну собственно все дальше мы называем команду докер build который нам дружелюбно собирает по контенту decker файла докер-образ собственно вот видно что мы там первым шагом мы сделали фромму ubuntu да то есть мы скачали образ ubuntu вторым фрагом и накатили первую команду ранную дальше мы накатили вторую команду ран есть такая команда который называется докере мы history это команда помогает распечатать контент образом то есть вот здесь вот например 4 missing строчки это вот собственно то что нам приехала за бесплатно с образа ubuntu две первые строчки то что мы сами уже накатили в этот образ и можно заметить что команда apt-get апдейт нам обошлась нам 40 мегабайт да то есть мы там я не знаю нас общий размер образа стал там 350 мегабайт но я на глазок 330 вот и там первый слой да вот этот то что ну собственно установили занимает 153 мегабайта вот просто надо то есть можно посмотреть распределение даже там был бунт и занимает всего 129 мегабайт небольшим вот все остальное это наша вот если мы там смежным командой apt-get апдейты apt-get install и после этого почистим за собой список пакетов дата мы удаляем вот эти 40 мегабайт и у нас остаются только 153 мегабайта вот собственно простейшая техника борьбы за размер докер образа то есть это просто для того чтоб когда понимать тот сделал дико build посмотри что там внутри пусто всегда бывают какие-то сюрпризы соответственно после того как образ собран его нужно куда-то доставить какое-то центральное хранилище из которого потом другие люди другие пользователи там или боты смогут образа стать то есть качестве центрального хранилища можно использовать docker hub я не знаю арки factory вот сейчас мы мигрируем в amazon elastic load registry и можно там сидеть на дефолтный docker engine который предоставляет там просто но есть докер-образ который содержит докер регистре вот тут главное помнить что в каждый ряд дистресс свои плюсы и минусы если там вы присаживайтесь свою инфраструктуру на одну из них то нужно подстелить соломку чтобы можно было если в том мигрировать на какое-то другое решение собственно после того как образ находится в registry можно сделать команду be careful которые достань этот образ команду дэдпул достаточно есть интересное свойство то есть она сверяет стоимость который запрашивается он самой последней версии офисе локальность и мышц такие с таким же именем тасс равно он сходит спросит registry и сделает проверочку но если соответственно образа нет то скачают это образ и разархивируем ну и собственно команда докером если делать докером без докер пула то он вытащит иметь если его не существует но при этом если уже есть им с таким именем и с таким тегом то он не будет проверять последний ли это самый им с таким тегом он просто поверит ну просто запустит то что сейчас уже есть ну и соответственно для киран как и запускает какую-то команду внутри контейнера но в общем то казалось бы вот так просто вот там буквально три слайда и вас все докер вся и др а вот есть даже докер seite докер плагин для дженкинса то есть ничего не нужно вот но оказалось что это немного на юна и наше ожидание не совпали с реальностью вот во первых оказалось что докер пул он очень опасен то есть например если вы используете greatest то вы попадаете на ровно ту же проблему которая не важно самом деле какой-то knot просто как всегда делает докер пул пул лекарства например тупо выдайте ровно ту же проблему которая была до этого с случаем ставят скажем так обновлением пакетов потому что мы сделали докер пул сделали докер пол через там минуту мы получили два совершенно разных образа то есть тот тест и который проходил назад начинает падать потому что новый образ там содержит новый пакет все все плохо для того чтоб решить эту проблему мы отказались бегали тест она стала обязательно versio нирования качестве версии мы используем этот текст то что идет после : ну он может только возрастать то есть там 10 до 11 там 20 так далее нельзя перезаписывать то есть нельзя запустить два имиджа с полностью одинаковым именем то есть мы нет возможности торца доктор пол вернет для одного и того же имени разную контрольную сумму ну и соответственно ту версию которую сейчас должна использовать continues не грешно это все определено в конфигурационном файле который также проходит continues in the grave на проверке то есть нельзя внести новый докер систему без прохождения при commit проверок таким образом мы мы себя защитили от того что нас появятся какие-то изменения которые ломают обратную совместимость хорошо мы сделали теперь есть 2 фото 1 функциональное корпулу обезопасим а но есть 2 со докер пол иногда вызывает тайм-аут ну потому что он скачивает там в три потока по умолчанию он потом разархивируем три потока по умолчанию вот ну и соответственно это все может вызывать таймаут на стороне тестов потому что ведет тестов низко на одной машине маркете параллельно если они все на времен начинаю делать декор pull the sad фанатам очередь будет так далее для того чтобы решить эту проблему мы сделали две вещи первое это мы сделали отдельный шаг в тайм аут плагине для дженкинса что можно делать уже таймаут на отдельный шаг и вынесли докер пол в этот отдельный шаг везде где могли таким образом если оно случается тайм-аутом он точнее тайм-аут там значение тайм-аута задрано вверх для того чтобы в тестах иметь маленький тайм-аута для докер пула уже можно иметь большой тайм-аут ну и соответственно все все образы докеров которые у нас есть мы их периодически перри запекаем на образы в образах и май то есть это образы not который поднимает нам amazon мы их при запекаем для того чтобы у нас как можно больше образов уже было на ноги чтоб не надо было их в принципе вытягивать и freddy's 3 также у нас была проблемах тот командочка минус минус р м который должна посещать контейнеры поставок скрип завершил работу она оказалась ну в принципе не очень стабильно работала на заре ну и в принципе дженкинс не очень стабильно работает экзо кепвелл степом то есть грубо говоря зенкин силен стопроцентной гарантии остается 2 блуза аборте ли то она пристрелит от fila скрипта все все что было вызвано тем со скриптом который был внутри запущен чтобы решить эту проблему мы вот использовали утилиту трэп утилита трек позволяет запускать какой-то странный скрипт каждый раз когда он шел прекращает свою работу мы используем вот такой вот билл так это тоже встроенная свеча дженкинса это вот уникальное имя то есть это грубо говоря полное имя полное имя проекта в котором запускается скрипт плюс его номер вот ну соответственно эта командочка говорит нам о том что если на момент завершения скрипта контейнер еще остался пристрели его еще мы читали в интернете что докер-образ должны быть очень маленькими очень легкими вот но как тот оказалось что в неправильных руках так не бывает вот у нас добрых начали расти то сначала там стукнут как я показывал 320 мегабайт там 500 потом три с половиной гигабайта в общем я думаю если мы не остановились она бы и дальше пошло вот для того чтобы остановить рост докер образов мы решили что мы сделаем правильные экономические розовые янди физике базовый имиджа то есть там конфигурацию до вынесем настройки пользователя пакетов ну собственно так вот выглядит это процесс то есть мы смотрим у нас два есть имиджа и у них одинаковый пакетом напрягитесь и встречается им его выносим в общий образ и уже потом от него наследуем с таким образом обращение таким образом у нас получается что мы ну там два раза там или сколько там экономим ну и в какой то момент мы поймали себя на мысли 2 ст начался хаос то есть тема с docker engine и настолько хорошо зашла что люди начали использовать везде везде везде что было собственно хорошо проблема в том что большинство это было по принципу о докере нас я хочу такое только другим пакетом control center в смена пакетов вот и у нас появилось огромное огромное количество образов которые делают одно и то же но как бы про по 5 написано мануале докер-образ должен делать ровно одну вещь но выразилось это в то что если я хочу что-то добавить себе ровно одну вещь я просто добавлю в базовый образ тогда мне не нужно волноваться какой конкретный имидж нет а потом до сумки так иначе получил эту с базовым образом пришлось сделать еще следующий шаг мы разделили все образы на билды и тест образы то есть грубо говоря если нам надо собрать какой-то продукт у нас есть один образ который собирает этот продукт там только dependency которые нужны там для компиляции этого продукта например а уже всякие там пакеты для тестирования не в других образах так как команд много например да то есть как бы провела компиляции более-менее одно для всех то получилось так что на суд для компиляции мы используем один образ для всех а уже каждая конкретно команда собирает образ под тестирования для себя соответственно таким образом получилось получить меньшее докер образом мог быть и большим в общем объем но при этом сам докер-образ был всегда меньше дай как я сказал вот у нас были проблемы с ктп с там то есть очень очень легко было все копировать то есть с одной стороны это было очень круто на стадии роста то есть нам получить у нас получилось очень быстро покрыть все команды разработки которые у нас были но были проблемы с тем что да что там как там качество оставляло желать лучшего поэтому мы порезали просто доступ к репозиторию который содержал decker файл и вот такая вот драконов ска и мера но очень эффективное то есть только те люди которые знали более-менее как настраивать докера не только этим и занимались но тут появилась другая проблема так как этих людей было очень маленькое количество по сравнению с количество входящих запросов на review объяснять одни и те же вещи многим людям несколько раз и при этом как бы человек говорил вещи вроде ну как же я вот этот образ только что заметил там я не знаю все было хорошо так теперь мы его переделывать собственно нужно было спорить убеждать это чтобы не решать эти проблемы мы сделали статический анализ докер образов то есть мы это сделали на сам описанном петровском скрипке кивот на в принципе есть уже проект decker докер link называется который может сделать это за вас собственно статический анализ могут выносить те вещи которых я говорил то есть мы проверяем что у нас там схема versio нирования которые мы там утвердили мы проверяем ростом количества слоев ну хорошая дата есть нашем случае нам два слоя рекомендуется один большой один маленький вот что у нас нет захардкожены каких-то значению реджис всегда в том этом все посты и так далее там через него и мы тварей был вытягиваем который мы потом подменяем во время сборки в общем все что мы могли мы вынесли вот такой статистика анализ простенький и это сильно снизило нагрузку на риверов во первых потому что оказалось что разработчики не споря с ботами то есть если бог говорит что образ плохой то они о переделывают как бы железках то есть не спорить вот мы в принципе как бы каждый runner view стали приходить более качественные продукты уже была сильно лучше но все еще были к определенные проблемы например имидже так не хотели уменьшаться то есть и и какие-то вещи до сих пор мы пропускали то есть там например но install recommend было тяжело ну не то что тяжело но вот как то мы их пропустили этот допустим пункт в верификации нужно было его добавить в очень большое количество образов то есть подчищение списка пакетов тоже то есть там каждый каждый раз он там стоит 40 мегабайт ну там вызов удаление старых пакет в общем очень много вещей которые хотелось как-то лучше донести до до разработчики как-то автоматизировать и быть всегда на безопасной стороне этого мы собрали новую базовый образ в которой мы положили вот vape the concept следующий конфигурационный файлик это конфигурационный файлик очень простой он говоришь там не нужно копировать да например вообще ничего не кафиры мне всегда удаляй список пакетов которые ты скачал никогда не устанавливали рекомендованы не всегда делай очистку таким образом когда есть один такой базовый образ системе и все образы от него наследование все те best practice которые мы доносили из уст в уста из skype флаг они все уже просто не есть я не за бесплатно ну и собственно да то есть проблема которая была никуда не делась оказалось то есть ты просто начинает использовать докер это еще не знать что ты перестаешь ходить в интернет вот это да это было тоже откровение ну и соответственно да то есть очень долго там течение года мы уговаривали всех всех всех всех всех порезать доступ к интернету то есть вот это сделал сильно быстрее кто-то сильно медленнее ну тогда мы закончили на том что у нас есть только два где опции запуска docker и теперь это вот минус минус на это равно на то есть совсем без доступа к сети ник локальной сети ник сети внутри контейнеров и вот минус минус нет с каким-то конкретным контейнером который использует тот вел самый бил так это которыми говорил ранее то есть грубо говоря внутри одного теста 2 дойка контейнера могут общаться но только два докер-контейнер а внутри теста нельзя не может быть такого что должны общаться два контейнера из разных тестов ну и соответственно мы разрешаем чуть чуть больше свободы в билдах потому что первых билде не как во время компиляции правьте компиляция найдет сильно раньше то есть не так дорого заселиться в компиляции с одной стороны другой страны компиляции но не грех все-таки когда нам сходить например в корпоративную артефакт или там скачать что-то и так далее то есть ну и в принципе у нас нет ничего лучше мы не можем предложить какой-то замену для этого пока соответственно кроме внешних ресурсов у нас есть также внутренние ресурсы да то есть там была мысль что просто запускаю все тесты в контейнер и in теперь друг друга никак не эффект от вот но это тоже оказалось заблуждением вот оказалось что не все тесты одинаковы вот хотелось бы вот соответственно с были проблемы с 32 то есть грубо говоря когда у нас один тест интеграционный какой-нибудь запускать этом не знаю 16 32 потока и но с не осталось циpкa нас был проблему сон киллер когда тот же самый тест который запустил 16 потоков он еще и память выбирает вот мы собственно нас были проблемы с агрессии но вообще этот тест который запустишь нас потоков и утирает память он еще не должен был выбирать памяти и запускаться шанс потоков вот нам хотелось это все от отлавливать таким образом мы стали вот использовать такие также настройки для докеров siplus то можно просто сказать сколько то есть раньше нужно было плясать с количеством относительным количеством тактов процессу на время сейчас можно просто сказать сколько процессоров нужно использовать вы собственно сколько памяти можно дать то есть там хотите там два гигабайта на интеграционный тест хотите там я не знаю стоил 100 килобайт на юнит-тесты то есть это все теперь можно задавать таким образом ловить регрессию ловить моменты когда теста начали выбирать больше или памяти или ресурсов на ранней стадии но при этом да то есть мы у нас был случай когда у нас например упала наши внутренние корпоративные деки registry и это было очень обидно то есть во первых потому что она упала было обидно вот вторая беда была связана с тем что нам нужно ничего из докер игристым не надо то есть у нас все же есть локально но при этом все заблокированы потому что команду докер пул как я уже говорил на должна сходить decker industry is верится что имидж последний а так как докер адрес 3 лежит то она то сходить не могут соответственно все разработчики заблокированы работа стоит в общем он идет вот чтобы решить эту проблему мы написали небольшого пилочек для дэдпула чтобы не проверять то есть докер пул перестал ходить сразу вряд ли теперь докер пул проверяет если такой имидж нас локально так как мы запретили перри переписывать версии да то есть и появилась version ность то теперь соответственно все очень просто если есть там я не знаю имидж и я не знаю тестируем проект а версии 1 то соответственно только один такой у нас образ мог быть системе соответственно достаточно но при этом мы сделали исключение для того ли тест хотя я сказал что он был зайди причин это не правда вот все-таки как для каких-то релиза для каких-то продуктов во все равно приходится использовать то есть если люди делают сиди да то есть они хотят rise & decker 100 грамм не даст а потом они хотят тестировать допустим клиентские приложения против за резиной версии сервера то есть против dignitas соответственно мы всегда проверяем что у нас lithos последние но таких тестов очень мало вот и они не всех предками . большинство из них не примет проверки поэтому мы пошли на этот риском и добавить исключение для того лиц но соответственно все в том не вне нахожусь прямо тоже не можем гарантировать что нам хватит такого именно проверки то есть андрей x так далее то есть там некоторые образы нас народ тянет тестах не наши радости мы тоже не проверяем наличие локально мы всегда делаем честно запрос интернет ну и соответственно да каждый новый день 12 какие-то новые вызовы вот не было еще ни разу такого чтобы мы решили все проблемы то столько решаешь одну просто вырастают новые на ее месте там как ну никак с гидрой к счастью то есть проблемы меняются и они немного ца вот но для того чтобы лучше понимать состояние системы то есть грубо говоря какие-то вещи мы нам допустим казалось что мало час проблему пофиксим мы меняли остановилась еще хуже то есть чтобы это все наблюдать not сделали мониторинг мы например мониторим аптайм для каждой команды докер on the сколько у нас докером съел ресурсов вот сколько занял мы мониторим параметры мы записываем статистику по параметрам с которыми нас запускался докер ну и соответственно мы обязательно регистрируем все докер ищу с которые у нас были но не только декарт принципе все еще с которым нас были дальше будет небольшое повторение для тех кто был на предыдущем докладе для этого мы используем build forlano lider плагин то есть этот плагин позволяет с помощью каких-то правил спам с помощью регулярных выражений задать список паттернов для ошибок то есть грубо говоря tna первая строчка значит дата сессии мы увидим что у нас есть в консольном ноги строчка докер response from демон бла-бла-бла то это ошибка в докере это будет ошибка инфраструктурного уровня эту ошибку нужно залакировать систему дольф нас есть гру и в and we старый плагин который собственно слушает абсолютно все билды в нашей системе каждый бил проходит через этом игру иван фестоны плагин там мы делаем следующее если у нас буду если у нас есть поле которое было записано билды фигура на лазер плагинам и это поле у нас мин ал тогда мы собственно смотрим какие у нас ошибки были в этом поле и мы складываем с карту данные о это ошибки то есть мы складываем там полное имя проекта который у нас есть то есть мы складываем собственно что за ошибка была какие категории то есть там категории как и говорю тоже инфраструктурная там еще что-нибудь timestream в какой момент случилось имя ноты потому что контексте докера в принципе это было очень часто ситуации когда докере демона какой-то конкретный ноги у нас становился менее стабильным чем в среднем по больнице и собственно был у спайк ошибок именно на одной конкретной ноги ну и после того как все это у нас есть мы это все отправляем в лагерь в качестве лагер мы используем с линди лагерь для дженкинса такой плагин и мы собственно записываем вы флинн дейв людей у нас есть такой конфигурации такая конфигурационной а секция который говорит что все что пришло у нас с тегом infix . be free мы это все про перенаправляем в infix и собственном это приправляем вот вы на flex он там на такой-то адрес он такой-то порт с таким-то текис такие назначают это что потом мы сможем у нас в базе мы сможем сделать запрос и что покажи мне все докер ошибки там с таким-то nae mam или с такой-то надо или с таким таком зале с таким-то категориями вот но соответственно таймс темпа totems темп когда у нас все это было запущено для чего нужна вся эта сложная портянка это все нужно для того чтобы строить такие вот красивые графики то есть этот график у нас ошибок докера который у нас исторически до сложилось это график за один год говорят вот собственно график срабатывания вот вот этих вот ошибок то есть грубо говоря это означает что-то ровно год назад когда мы начали мониторинг у нас было 100 раз нас мочилась такая-то строчка в консоли на дженкинса да то есть сто раз в неделю там пять рабочих дней до начала 220 разработчиков день страдала вот ну там были разные периоды то есть доходило до 200 то есть можно вот оценить насколько был стабилен докер вот там были разные моменты вот но в конце концов это там на рубеже 2012 13 года то есть была новая версия джокера новая версия амазонской операционной системы на нее перешли из овса стала сильно лучше да то есть в принципе мы там от 100 файлов день мы перешли там к 20 файлом то есть сейчас там где-то страна в районе там 2050 не в день в неделю простите вот ну соответственно езжай что принципе сайте мурыжить можно то есть всего лишь там моли малая часть комментов мало малая часть билдов у нас аффекте нам проблемами decker но при этом нужно понимать что благодаря этому графику мы смогли точно таргетировать все те настройки которые например вредят используем дагер у то есть например на 1 рубль 100 / и которые запускаются запускает докер слова минус минус привлечь они более подвержены риску то есть потому что там сложнее идет точки зрения кем она работает сложнее на требуют синхронизации соответственно она падает чаще ну и в принципе то есть там запутаться с двух одинаковых контейнеров да то есть там параллельно тоже плохо то есть запуск контейнер с большим количеством слоев то есть то место запускать там 20-40 слоев за раз и это делаете там сто тысяч раз за день это тоже как бы очень высокий риск отказа то есть но благодаря этому поможет у нас есть статистика мы смогли все эти моменты отловить вот и мы в принципе готовы к следующему зам собственно какая мораль после всего этого вообще в принципе до сих пор не забрали серебряную бурю пулю дай-ка тоже я не является вот если вы еще не перешли на докеры или вас они не очень массовые то нужно всячески пропагандировать мысль о том что докер файл это тоже своего рода исходный код то есть должны быть те же самые правила то есть там keep it simple stupid там я не знаю дон 35 и сел в то есть все все все проверки труда кому не нужно туда от засунуть соответственно если нет мониторинга continues навечно нужно нужен мониторинга перед перекатыванием по крайней мере массовым чтобы понимать становится лучше или хуже нужно понимать что докер до сих пор находится под активной разработкой то есть там они разделили докер на несколько проектов то есть там ведро переделывается так далее тому подобное то есть и нужно ожидать что докер будет просто работать то есть скорее всего с ним будет какие-то вызовы какие то проблемы то есть там можно с одной стороны очень стабилен то есть ну если вот посмотреть на графики то есть я напоминаю что нас там сотня тысяч билдов в день и там творится у нас 10 раз да то есть принципе секс с это очень очень хороший но может быть не для всех да ну и самое важное что в принципе дайконом сильно помог со стабилизацией нашего континента грешно да то есть мы выпилили обращение во внешнюю сеть мы запекли какие-то пенисе пакеты которые у нас там использовались но в принципе стало сильно сильно лучшим спасибо спасибо за внимание вопросы необходимо это был первый давайте давайте from a beach club спасибо день добрый спасибо за рассказ вопрос в следующем какое примерно у вас применяется количество уровней для базовых образов вот да уже окончательным образа с проектом но грубо говоря ubuntu докер как бы канонически док докер-образ build образ тест образ как то так вот то есть четыре уровня должно быть я про то что вот есть базовый образ ubuntu дальше некий базовый образ где до установили питон например 3 базовый образ где до установили пи pumpkins зависимости и уже 4 конечный с проектом когда чисто уже вы имеете ту слой или образ ранг я говорю про фронт сначала идет from ubuntu то есть мы собрали базовый образ потом нас from базовый образ мы собрали базу ну то есть что-то на на основе базового образа то есть билд и потом в тестовом у нас from build там что то еще то есть внутри каждого каждого из этих образов у нас там может быть два слоя по крайней мере сейчас такое правило вот но получается что суммарно слоев там я не знаю 10 именно оверлей в этими налоги decker и хромов 4 а сейчас как ну вот так мы сейчас тоже находится то есть вот тут то что я рассказал да то есть это такой опыт это надо понимать что нельзя вот в один момент все сделать хорошо то есть как бы у нас сейчас текущая версия скрипта если который готов тим desert собирает образы есть и меня их parent она не при собирает child то есть тебе нужно с ручками сходить не знаю отредактировать файл excel до поменять там версию тогда она перри соберет вот но следует но новая версия скрипта она автоматически это супер собирает здравствуйте вопрос такой вас какая хостой протоны системы используются и давай снайпер и были ли проблемы сдавай снайпером плане зависание да да то есть если вот там посмотреть нет здесь девайс мы пустим так конкретно не засвечена в общем проблем было проблем было много вот собственно это вот и есть то изменения которые у нас используются на зону с к операционную систему то есть я полна но я не помню как называется ну заносили с каждым такой вот она основана на centos а вот меня но они подсели у себя именно вот девайс мы-то ему для стабильности decker а потому что но как я показывал на графиках это очень не стабильно работал сам начале сейчас нам это после патча какого-то атаку риска падения был на графиках да то есть это обновилась обновился именно мазановский образ и 1 то есть я не помню на самом деле обновился ли докер но точно обновился мазановский образ то есть только который мы стали использовать в продакшен как правило тестируем отдельно этот график с продаж но потом котами в продакшене то есть тот если я не знаю вы захотите там смотреть релизнуться так далее то есть я могу он точную дату сказать вот судя по графику это середина декабря спасибо вы говорили что докер-образ перед тем как папа депозитарии проходит там ряд при коммент проверок не замедляет тестирование по штампу тестов могут нас два часа например да и два отдельных pipeline на грубо говоря сборка докер образа которые dapper сборка докер образов который используется внутри самого себя до 300 мм для тестов так далее этот отдельный верификационной pipeline он никак не завязано разработчики pipeline то есть грубо говоря все там при камин проверки не есть если докер-образ прошло тепреь коммент проверки мы его запускаем и меняем конфигурационном файле циферку и начинаем использовать в континенты графини уже новый докер-образ те докер образы которые собирают разработчики для каких-то своих продуктов релизов так далее мы они вообще не беспокоимся и я не про жира бочков а про инженеров которые прошли по проверке я говорю то есть есть ну то есть грубо говоря докер может использоваться вот как у нас вся этом для тестирования для изоляции какой то есть а продакшена то есть листья и мы его проверяем в полностью отдельном pipeline и там грубо говоря разница на там сенат статически проверки так далее там миллисекунду секунда вот а те докер образы которые используются для produces они собираются в другом месте другими людьми то есть мысли как за них не несем ответственности мы за ними общение смотрим и вот там вот вопрос есть и вот там ещё спасибо ещё раз за доклад очень было интересно я бы хотел вернуться к началу вашего доклада именно о том о причине того почему вы начали использовать докер вопрос мой такой же говорить о том что проблема были в тем что нужно быть у вас там версии куда-то благо вида вперед допустим в питоне и так далее не рассматривали вообще возможность там установка und praxis типа нексуса чтобы он и там в марине соответственно прописывать статические версии автоматизировать именно при себе задавать конкретные версии сборке данного продукта но чтобы ничего не ломалось из-за этого и соответственно почему докер если рассматривать собственно не знаю до конца ли правильно про вопрос у нас используется в качестве прокси артефакта рида например то есть грубо говоря мы не ходим честно-честно в интернет да то есть ну там где мы можем проконтролировать среду исполнения мы не ходим час в интернет мы уходим в артефакта рита есть оттуда выкачиваем то есть нужно понимать что и там мы работаем в команде continues in the grave нас там девять человек да то есть мы обслуживаем порядка там шестиста 700 разработчиков то есть и мы не можем залезть там то есть мы можем что то рекомендовать но нам нужен какой то именно возможность контроля за тем что собственно самом деле происходит вот поэтому и докер потому что мы не можем просто сходить каждый бит скрипт обновить но мы можем например выключить везде сеть то есть ставят ставить только артефакта рида то есть что можем то и делаем у меня был вопрос именно драйвер говоря джаве можно там бы вспомни как домовину например приписать конкретную версию да да я был автоматизировать именно in комментарию например то нового централизовано держать допустим что мол там для такого-то проекта у нас есть артефакты такие таки-таки да да и я их зоны комиссия по мере я я понимаю что так можно просто как бы ты же не поедешь там не знаю в торонто объяснять людям что ну хватит так делать делаем вот как я тебе объясню то есть и ну собственно да то есть из за того что нельзя было форсировать людей использовать такую то практику да то есть вот выбрали докер в принципе да то есть такой refin тоже имеет право на здесь нас просто дрова это там 35 процентов наверно сирот из нас в основном плюсы и питоновские руби пакеты для тестирования ну то есть там на там за колонный вопрос которая существует отсутствует но мы команда кто рвет комнат continues in the grave есть команда которые делает сиди собственно там для сиди используется гоп гоп google pipeline так далее то есть в принципе это очень разные там техпроцесса в разные силы и так далее то есть прозрачный продакшен континиус на грешной к нему сам факт которые были получены в результате сборок релизных они никак не протаскивают production вообще никак протаскивается то есть грубо говоря если ну грубо говоря есть билда 2 обычно дробот рэнкин сюда который что делает что она делает для нас секрет то есть если там кто-то закидывать артефакты в хранилище потом и 3 grease полный там какой то сиди сборку он точно ну сиди процесс да то есть это та это работает то есть мы это не запрещаем просто это не наша зона ответственности то есть ничто не мешает людям прописывайте на наш докер-образ production просто он не был для этого за дизайнер то есть он был за дизайн для ася этом создается например пользователи которую на ну из-под которого запускается все тесты зачем этот пользовать в продакшене понятно но другие всякие вещи я не расслышал синхронно с чего как-нибудь поддерживайте синхронность среды на то есть тот образ который используется по если мыши и то что на продаже я бы сказал да каким-то образом поддерживаем ну собственно то есть я могу сказать что ну как как вся и мы отвечаем за себя при коммент проверки если люди положили в предка при commit проверку проверку того что не в те пакеты которые используются в продакшен используется в тестах да мы это делаем потому синим чем-то большое спасибо за доклад у меня два вопроса первое это я хотел бы узнать подробнее как вы побороли хардкот вы сказали про день раз ушел то ли статистический то ли синтаксический анализ этически собственно там такой код который показывает не хочется но есть просто на питоне написано скрип тогда который у нас помогает собирать образом части эта скриптик а у нас есть валидатор того откуда мы берем образ то есть там мы проверяем строчку from мы проверяем все все строки которые у нас есть и мы знаем что обычно люди хардкоре от то есть и то есть там какие-то url и так далее то есть мы говорим что там не использую там захардкожены имя радиус 3 место этого использую там registry girl январь март variable ну и так далее то есть просто это ну я не знаю там строчек 15 на питание там строчек 100 с тестами но я говорю я и секунду извини что перебил есть говорю проект который называется докер линд или доки файл линд в котором который сейчас у нас то достаточно хороший стадию чтобы его посмотреть и использовать и у него есть как бы очень много проверок то есть возможно там эта проверка есть я если честно не помню 0 но случае туда очень дешево будет дописать спасибо еще один вопрос от вы показывали график с ошибками мне интересно вот то что сейчас находится ближе к концу этого графика да то есть то с чем вы сталкиваетесь сейчас по факту это понимаю какого характера это ошибки на сколько там серьезно все взрывается это это это это те люди которые используют минус 5 минус привлечь в основном то есть а те кому нужно там суда юзеры лимончики удаленную шару так далее то есть если при вы лишь не использовать то шанс ну он и так близок нулю дата всех говорит она 100000 запусков вот но как бы вот насколько я знаю да насколько вот мы смотрим время от времени поднимаем там тикет это это все еще привлечь этикета на гитхабе тоже не закрыта потому что но там ноль точка ноль четыре процента то есть это не то priority понятно спасибо больше ну вот в первом ряду есть вопросы спасибо за доклад вы говорили что за счет того что вы выносите общее пакеты образ вы экономите место номер да да я говорю что может быть мы грубо говоря total союзы увеличим до таким образом может быть ног зато там грубо говоря базовый образ реже обновляется очень реже сильно-сильно реже соответственно там его не надо выкачивать то есть где то там примере был 2-4 дней до то сегодня нужно повторно выкачивать так далее то есть я да я согласна что может быть не очень удачным донес мысли но идея была в том чтобы декор пол проходил быстрее дата не надо было было пулить 3 гигабайта надо было запулить там поменьше и еще вопрос вы говорили что запуск конечно уже контейнера с меньшим количеством слоев он проходит более гладко до ток ток ток а и запада то есть в коде мы смотрели то есть грубо говоря если мы много раз запускаем с большим количеством докер-образ большим количеством слоев то есть там 10 20 до то мы наблюдаем контента на но панкрас девайс мы перебирали то есть и и собственно но отваливается то есть я честно то есть мы не чувствуем себя настолько зубодробительной мир чтобы вести советуете фиксить вот поэтому мы просто со стороны наблюдаем всем спасибо а если опроса больше нет большое всем спасибо всем"
}