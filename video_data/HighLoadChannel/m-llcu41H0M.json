{
  "video_id": "m-llcu41H0M",
  "channel": "HighLoadChannel",
  "title": "Борьба за живучесть в условиях DDoS / Георгий Тарасов,  Артём Гавриченков (Qrator Labs)",
  "views": 2210,
  "duration": 3211,
  "published": "2019-05-15T04:51:55-07:00",
  "text": "всем привет меня зовут abs уже больше занимаясь pro curl решение по защите достать aqua наших клиентов и партнёров со мной сегодня накладывается тема говорить чанков наш технический директор у него будет очень интересные детализации по проблемным местам по интересным вопросом в предмет новость которую мы сегодня затронем ну а я скажу что мне вот очень интересно я вот очень люблю две вещи первая это хорошо работа еще онлайн сервисы которые не падают под атаками а второе это военно морскую историю корабли сражения конструкторы и сегодня я решил выбрать такую параллель потому что мы попробуем примерить на себя роль конструктор кораблестроителя который проектирует непотопляемый онлайн-сервис непотопляемый под постоянным обстрелом до dos атак и так ставим перед собой задачу мы хотим создать онлайн сервис который будет отличаться высокой посещаемостью хорошей скоростью работы он может быть новым крутым с нуля реализовать какую-то новую идею он может быть новой инкарнации какой-то старой платформа которая уже не удовлетворяет нас не по защищенности не по производительности ну или у нас есть уже что то что нам нравиться как работает но мы теперь хотим чтобы она еще и был защищен от dos атак потому что конкуренты не дремлют потому что public activity потому что хакеры совершенно оборзели итак мы выбираем решение по защите подключаемся подписываем документ на котором написано стола и сорвал огромен в его условиях написано что ваше приложение будет находиться в полной доступности для ваших пользователей в течение девяноста девяти , 9 процентов времени за этот месяц но цифра серьезно если там даже не три четыре девятки 99 девятьсот девяносто пять гиней мид но в этот момент возникает мысль стоп секундочка что вот с этой половинка процента или половинка и десятой доли процента что если эта половинка десятой доли процента попадет на самое важное для меня события в этом году за которое я получу наибольший профит как онлайн бизнес что если это моя черная пятница что если это трансляция спортивных мероприятий которые будут смотреть миллионы людей на моем ресурсе что если это в конце концов электронное голосование в моей стране как я могу надеяться что она будет работать если мне обещают какие-то процента что остальное время она обязательно будет лежать как мне угадать здесь придет на помощь здравый смысл и понимание того что от архитектуры приложения зависеть достаточно много едва ли не больше чем от того средства защиты которая собственно говоря предотвращает до dos атаки на ресурс с помощью определенных факторов на который можно повлиять при проектировании как приложение так инфраструктуру под него можно вывести два простых условия которые помогут нам не бояться этих процентов и закона мерфи в критические моменты мы хотим чтобы наше приложение работало быстро красивый уверена в обычной ситуации когда атаки нас не донимают или имеет какой-то незначительный для нас уровень по общим показателям угрозы и оно должно решать важнейшие задачи которые перед ним ставится в нештатной работе когда его активно атакуют когда мы пытаются залить линки когда пытаются вывести строй маршрутное оборудование или веб-приложения мы хотим чтобы у нас было некоторое подмножество задач которую мы имели возможность продолжать решать до того времени пока шторм не стихнет как это можно реализовать какие под задачи можно себе сформулировать на разных этапах тогда мы пытаемся придумать и за дизайне и задевает наше приложение на этапе когда мы выбираем инфраструктуру от самого самого базового размещения от адресов на собеседованиях в разные крутые компании типа microsoft и google и часто задают такой вопрос вот его правда можно часто встретить что происходит что произойдет когда вы возьмете клавиатуру и в объекте в неё доп топ-топ google.com в адресную строку и нажмите enter настолько часто задавали этот вопрос что на гитхабе есть целый репозитории где указано значит где собраны значит различное пошли квесты на тему того что реально произойдет вот там есть список вот из того что относится к сети они к прерываниям и нажатием кнопки там описано вот такой порядок дэнни запрос открывается socket tls dp и поехали ну на самом деле если детализировать то там побольше всего у нас есть 3 4 5 6 upper 6 является приоритетом но если он не работает есть копия и болт у нас есть всевозможные middle боксы у нас есть tls это не только рукопожатие это еще system link ещё у нас есть балансировщик нагрузки еще у нас наверняка где-то есть сидел это зачем задают вопрос на собеседованиях хотят узнать понимает ли человек все этапы работы сети и приложения чтобы если с чем-то будет проблема он смог идентифицировать где проблемы это на самом деле список того что под атакой или даже без атаки просто в ситуацию аварии может взять и рухнуть круто из этого можно сделать простой вывод у нас будет куча компонентов как бы мы не старались их минимизировать компонентов нам придется включать довольно много и они будут так или иначе зависеть друг от друга он не здесь мы хотим самое главное что если в результате атаки что ты что-то какой-то из этих компонентов прикажет долго жить те самые основные задачи мы смогли продолжить решать дальше этап дизайна приложение когда мы говорим конкретно про прикладной уровень про то как запросы наших пользователей будут приземляться в ту логику котором реализуем здесь мы будем отталкиваться от самой логике работы что мы хотим дать возможность пользователю сделать в каком порядке в каких этапах насколько вообще можно будет по тому какую структуру запросов мы предложим определить что хотел и каким образом хотел этого достичь наш юзер ну и наконец так как скорее всего у нас либо возникнет соблазн либо возникнет строгой необходимость использовать nextgen технологии которые ускоряют во многих случаях работу на прикладных уровнях нам нужно будет убедиться что наша логика которую мы строим для того чтобы понимать что делают наши юзеры не была скомпрометирована тем как эти механизмы работают и какие возможности в том числе атакующим эти технологии предоставляют ну и наконец когда мы подключаем средства защиты будь она внешние средства или некоторая кастом про мизес решение которое будет установлен инфраструктуру нам нужно будет убедиться в том что сделав нам защиту и и будет затруднительно обойти атакующему в том или ином варианте и соответственно как в дополнении к этому если мы хотим чтобы нас защищали снаружи мы хотим иметь обратную связь с тем кто нас защищает сообщать ему о том что привет мы еще на плаву или мы тонем сос спасайте нас делать это надежно то есть не вводить заблуждение средства защиты и делать это своевременно и так я веду два понятия которые будут агрегировать себя решил факторы которые мы будем на котором вы влияет в рамках решения подзадачи первый из них это живучесть 2 это целостность ты если 2 какой-то степени как термин который родилась в процессе подготовки к этому доклада по первой у нас приходит непосредственно из военно морской терминологии о чем мы здесь говорим говоря сначала про живучесть но есть общего потребляемого общее употребимы определение которому уже много много лет она из экологического заверяя за в морской энциклопедии ему его учат в академиях флотов по всему миру в чем его краткая суть в том что боевые корабли строятся не для того чтобы выступать на парадах они стараются для того чтобы участвовать морских сражениях решать боевые задачи если корабль участвует в сражении нет никакой никакой идеи в том чтобы ожидать что в него не попадет ни один снаряд ни одна торпеда он не получит повреждение не загорится и так далее и смысл в том что даже при получении существенное количество повреждений он должен сохранять возможность решать те задачи для которых он был построен для которых был обучен и его экипаж то же самое с приложением который мы хотим спроектировать никто не говорит что его не буду атаковать никто не говорит что его когда-нибудь успешно не атакуют мы хотим предусмотреть такие варианты еще на этапе дизайна приведем примеры того как живучесть влияет на судьбу кораблей вот хороший позитивный пример это американский авианосец и с hornet был построен до войны как один из первых специально проектируешь авианосцев и в сражение у острова санта-крус он получил от японцев попадание 3 торпед самолета в трех крупных авиабомб еще три бомбардировщика в него врезались с полной нагрузкой он получил серьезнейшие повреждения был охвачен пожаром но его удалось оставить на плаву и спасти боль то в американцы даже попытались буксиром утащить его обратно в сторону своих баз для того чтобы восстановить потому что он совершенно не хотел идти ко дну и сражался за свою жизнь однако с буксировкой по тем или иным причинам не получилось японцы продолжали осаждать корабли эскорта поэтому адмирал дал приказ потопить это корабль чтобы не достался врагу но черт возьми этот уже не удалось быстро и просто сделать потребовалось еще порядка 13 торпед как от союзников так и от продолжавших атаковать японцев и порядка нескольких сотен снарядов от эсминцев и скоро ты только через сутки он наконец не хотя отправилась на дно естественно что потери были в основном среди той аварийной команда которая добровольно вызвалась спасать корабль тогда косяки паж был с него снят еще после первого сражения обратный пример этой же ситуации это японский скажем так одноклассник этого корабля это корабль под названием тайху который тоже строилась как эскадре наносится решал те же самые задачи имела похожую конфигурацию однако на нем борьба за живучесть была провалена абсолютно полностью он получил одну торпеду под погодной лодки не в сражения там в процессе совершая путь с одной базы на другую он получил одно попадание и в результате неумелых действий экипажа и не предусматривают высокую живучесть дизайна примерно через восемь часов он испытал сокрушительный взрыв и перестал существовать как паучьи и средства отправишься но одно почти со всем экипажем вот как бы мы имеем два очень похожих корабля решающих очень похоже задач при котором стоят примерно одинаковые риски но то как сложилась их судьба в условиях атак в условиях неблагоприятных она диаметрально противоположна какие факторы мы рассмотрим говоря про живучесть уже в контексте нашего онлайн-сервиса проводя те же самые налоги и мы поговорим про адреса про то как компонент наших нашего сервиса будут жить в этих сетях мы говорим собственно про те самые компоненты про building блоки из которых будут складываться наш сервер без которых его жизнь невозможна мы поговорим про прикладной уровень как пользователи обращаются к приложению и про те самые технологии механизмы фичи которые могут нам помочь а могут и подгадить начнем как водится с адресов приведем самый простой самый базовый пример небольшого сервиса все начинают с чего-то маленького у нас есть несколько ресурсов доступных поищите печь дпс они живут в маленькой провайдер skype сети которую нам выделил наш оператор связи допустим все те же 28 все хорошо к нам приходит атакующий он начинает выясняет один из наших адресов начинает устраивать на него нагрузку паразитным трафиком но казалось бы мы предусматривать такой момент мы принимаем контрмеры мы гидролизу им атаку и делаем так чтобы она что запрещаем попадание паразитного трафика на соответствующий адрес но такую щий включает смекалку и перебирает подсети начиная от самой маленькой при возрастании массаж 3029 ваш 28 перебирает адреса находят остальные наши ресурсы наливают туда замечательно даже несмотря на то что мы предприняли какие-то меры скорее всего канал нам уже залили и оставшийся ресурс который мы пытались защитить он уже не будет работать не зависит от того принимали какие-то меры или нет казалось бы пример достаточно вырожденной однако в дикой природе не встречаются повсюду есть хорошие кейсы по этому примеру в прошлогоднем докладе прозвища и масть приложение да да сутрами или хантимиров там один из похожих кейсов рассмотрим но мы двигаемся дальше возьмем больше у нас уже не одна маленькая провайдер skype сетка адреса из нескольких сетей класса c одного или нескольких провайдеров мы следим за тем чтобы у нас не были открыт какие-то произвольные порты которые не обслуживают юзеров снаружи вот и здесь видно что для атакующего задачи уже становится намного сложнее потому что простым перебором от маленькой большой сети эту задачу решить уже невозможно ему придется потратить больше времени больше ресурсов на то чтобы нащупать другие компоненты находящиеся в рамках этого сервиса и это возможно отобьет у него желание продолжить атаку или просто серьезный и и у дорожит что в общем-то нас интересует возьмем масштаб побольше у нас есть свой провайдер независимый блог адресов или же достаточно большая потеть выделенное нам нашим поставщиком связи мы говорим про с 24 в этом случае обычно у нас есть корпоративная сеть то есть те ребята которые обслуживают наш ресурс который ведут бухгалтерию все они будут прятаться с этим адресами у нас там находятся и сайты и какие-то бэкапы с базой и шлюз для наших офисных сетей которые открывают исходящие соединения через тот же самый edge из того же самого адресного блока в интернет что есть может произойти ну на самом деле довольно похоже ситуация в такой картине атакующий уже из болтов же кто знает что этот эта сеть принадлежит или используется вами он устроит перебор адресов так как сегодня 54 адреса с попытка атаковать каждый из них попытка найти выезжаем и порты вот и в такой картине может пострадать атака на любой из совершенно не связанных по решающим своей задачей компонентом может привести к отказу остальных то есть нам нальют в офис олегу сайта который зарабатывает для нас сейчас деньги вот наверно это не самая хорошая идея от нее тоже в принципе довольно легко выйти вот хорошим тоном в плане живучести будет вынести те ресурсы которые непосредственно не связаны с обслуживанием наших юзеров на адреса провайдеров в другие сети если это какой-то промо-сайт который не проваливается сервисы и можно вынести на хостинг и не держать свои инфраструктуре решать вопросы разнесено sti на военных кораблях происходит ран дрон та же самая история там никогда не бывает 1 радиорубке обязательно есть одна в верхних настройках и одна где-то глубоко в нижних палубах корабля с рулевым поставим то же самое потому что выведение из строя такого компонента может привести в итоге гибели корабля и резервирование разнесения по-разному защищенном участков здесь критически важно говорим про компоненты здесь мы будем рассматривать в основном самодостаточный ресурс который так или иначе либо помогают либо жизненно важны для того чтобы наш сервис делать то что он делает например у нас уже есть инфраструктура но нет не такая вы туда не смотрите ведь мы учли все принципы отказоустойчивости дублирование резервирования и у нас на самом деле вот так у нас есть резервная площадка или площадка на которой балансируется часть трафика там все хорошо нет нет конечно еще не все хорошо как шток нам еще нужно поднять в европе между эджем и нам еще нужно соединить наши площадки присутствия где живут сервера отдельным и 2л валенком чтобы отказ любой связки в этих звеньях у нас не приводил к тому что один из один из центров присутствия пристает обслуживать пользователей казалось бы все хорошо мы все предусмотрели мы настоящие конструктор караби строители но на самом деле нет нам нужно заглянуть внутрь каждого право кусочек чтобы понять что может быть не так ну начнем с балансировки и то что как бы первое что придет на ум от нардо dns balancing потому что с этого начинала совсем балансировка в какой степени в интернете и вроде бы ничего проще придумать нельзя но если мы присмотримся чуть чуть поближе мы поймем что те задачи которые мы перед собой как строитель непотопляем его сервиса ставим вообще никак не решает чужие находящийся в интернете name-сервера ничего не знают про то насколько доступный сейчас те адреса на которые не будут отправлять трафик какова там нагрузка жевание вообще сейчас или нет ну и наконец для того чтобы что то поменять в этой схеме нужно будет дождаться tl нас тут есть а сильная история я думаю тема нам сейчас расскажет значит замечание про the tail исторически рекурсивные резон изол веры у провайдера ломали то тель двумя способами а значит что такое та цель это запись это атрибуты на записи который означает насколько ее можно закодировать то есть в каких к в течение кого промежутка времени она не поменяется логично что это целое число и не уважать это целое число можно в обе стороны можно его занижать можно его увеличивать и когда-то так и было однако последние исследования в частности там приведена ссылка с последнего райп митинга в амстердаме согласно этим исследованиям которые конечно нуждаются еще проверки развития dns-сервера перестали ломать tt в большую сторону они могут его уменьшать что логично но если в зоне прописано 5 минут это будет пять минут и не дольше рекомендую посмотреть достаточно интересные методы в частности вот познакомиться с тем как работает райпо туз для чего можно будет ну что ж про боль сыров с помощью dns мы свои выводы сделали мы ее откладываем и не смотрим больше что у нас еще может быть у нас может быть отказоустойчивой сиропчик внутри нашей точки присутствия понятно что это вагон во многом хорошая идея на позволяет нам балансировать нагрузку внутри каждого point of presence однако нам скорее всего раз уж мы все зарезервировали имеем backup инфраструктуру или схемы активов нам нужно как-то между площадками раскидывать трафик нам нужно как-то решать вопросы если нам хочется трафик поезд из разных регионов приземлять в разные места блокировщик на площадке эти задачи для за нас никак не решит что нужно что мы можем здесь сделать перестает единственный вариант это внешний балансировщик причем этот блокировщик обязан быть распределенным и доступным из любой точки где находятся ваши юзеры откуда они хотят попасть на тот сервис которую вы предоставляете это как правило множество локаций это больше производительности в плане подачи ответа иже с ними ну и логичным выводом из-за ситуации будет то что нас устроит только вот такая комбинация балансира внутри площадке не лучший способ которым мы умеем но при этом полагаемся и на внешнем балансировщик в идеале доступный одновременно по одному и тому же адресу из кучу локаций то есть тоже то что мы называем и не кастом примеров таких балансиров можно привести много почти все облачные провайдеры каких-либо услуг защита до доз ускорение сайтов сидим умеют эту вещь и будут рады предоставить тому кому она нужна говоря про она им сервера раз уж мы затронули тему dns сам себя на им сервер который возможно располагается ваш инфраструктуре и доступен пользователям снаружи это очень уязвимая штука она может привести к полному отказу без особых затруднений без особых затрат страны ну мыж не к который производит dos атаку потому что атаковав даже простым худом вашем сервер атакующий приведет к ситуации когда честные легитимные юзеры не смогут получить разу и не смогут прийти на сервера приложений за вашим сервисом весь мы имеем ситуацию когда с приложениями ничего не случилось оно продолжает работу нагрузки на нее нет но легитимно нее тоже не приходит потому что никто не прописывает в haste и ваши и печники всем нужно ли зов призов вы не отдаете чего-то ситуации делать ну наверно подход здесь будет абсолютно понятно очевидно всем если вы не можете на своей стороне от резервировать отмасштабировать и защитить name-сервера их нужно вынести за пределы нужно использовать внешний dns в идеале построены по тому же самому принципу которую мы или про балансировщик доступный из большого количество локаций одновременно по одному и тому же адресу то есть они каст и как это перекликается с дизайном дизайном боевых кораблей так что в принципе вот этот подход не можем отмасштабировать защитить у себя выносим куда-то еще он уверен в общем-то и для кораблей как правило всех боевых кораблей существовало мы говорим сейчас про capital ships с большим это замещением они там где-нибудь эсминцы и так далее у них существовала бронированный от 100 del который было максимально защищена в центре корпуса и прикрывала наиболее важной части внешние участки были либо слабо защищены либо вообще не защищены и таким образом ресурсы на защиту тратились туда куда они должны тратить на самом деле рассказываю крутейшую историю с последних и тех там очень много времени тратится на то чтобы сделать dns как можно более реселлинг надежным к в том числе атакам и почему и в частности в рабочей группе dns а по сейчас есть вот такой вот черновик под названием 40 style значит его суть примерно следующим как устроен dns-сервер значка он он отправляется запрос recourse да он отправляет запрос и проходит повтори то тип нам кладет запись в кэше предположим что у него долгое время не работает garbage collector отель потухает клиент очередной раз запрашивает ресурс сервер идет до этой записи памяти видеть этот отель проток выкидывает ее и идет за нее заново в черновике предлагается поменять два действия местами то есть если есть запись протушим ttr если на ней есть определенный флаг то не выкидывайте и а вначале запросить eyes of the ride отивно сервера и если он ответит тогда отдать эту если авторитете вный сервер недоступен то вы дайте хотя бы то что я слегка же потому что что-то лучше чем ничего из этого рождается значит какой-то такой значит будущий гомункулус устойчиво веб-сайта плане dns то есть мы сервер вот это вот запись с флагом surf style после чего сами себя караулим через рекурсивные серверы многих провайдеров чтобы запись появилась в их памяти с флагом surf стоял и можем выключить дэн сервер на несколько часов вот но это такая концепция которая мы понимаем что вы наверное когда выйдете с доклада не пойдете сразу перри горячего свой продакшн да вот к моменту когда вы начнете это делать и откроете эту презентацию этот черновик возможно уже будет стандартным поэтому обратите внимание будем надеяться но и в завершении про компонента естественно здесь нельзя обойти стороной проблему или задачу ног часть в раде кучка проблема сбора логов с наших приложений сбор логов с наших ключевых мест о которых мы хотим знать что на них происходит частая ситуация мы поставили себе крутой балансировщик слэш мажьте затар слышь-ка сервер многофункциональная стоит в устройство которое из коробки решает 90 процентов задач которая мы хотим там видеть и мы собираем на него access logs наш хлеб серверов храним там отдаем куда-нибудь либо складываем у себя либо transmitting куда-нибудь наружу но здесь мы возьмем посмотрим с другой стороны и скажем что лучше бы наш бог ресивер сторож и трансмиттер отделить от того места куда приземляется do the plain вынести отдельно собирать туда логе как раз смог балансировщика и уметь отдавать их наружу через наши основные канала почему это важно вот об этом мы поговорим чуть дальше пусть это будет некоторые чешского ружья или вот тот самый винчестер из 1 у него папа из одного хорошего фильма когда он терял я думаю нам пригодится а пока перейдем к уровню приложения к логике того что делает наш пользователь здесь мы будем исходить из следующего принципа как кораблестроители что того их который мы закладываем в приложении а должна пользоваться помощью протокол в котором мы используем они бы спрятанной под какими-то технологическими ухищрениями которым мы пытаемся сделать себе дешево или быстро или одно и то же что это значит простой пример у нас есть некоторые приложения у которого есть два способа общения с пользователями 1 после делает get flash получает все содержимое главной странице а навигации у нас сделать с ничью вера я там через куку например и пост отношу юзер который заполняет какие-то данные формы загружает файлы и там несколькими габаритном присылает казалось бы мы сделали все минимизирована все удачно все здорово но с другой стороны у нас обойти запроса они дорогие для сервера они тяжелые они не очень быстро и если злоумышленник поймет в чем фишка для него не составит большого труда подобрать паттерн таких запрос таким образом чтобы сделать нашему серверу приложений а максимально дорого и больно за минимальное количество денег потраченных на атаку а что самое обидное что в такой конфигурации нам будет очень трудно понять вот этот пост он от нормального юзера или от злоумышленника потому что и там и там с точки зрения лодки приложения содержание абсолютно валидная проблем только в количестве этих запросов в их интенсивности а в такой конфигурации их не будет слишком много в сравнении с остальными потому что они так и так медленно работают получается мы сами себе создали загадку угадать правильный ответ на которую нам максимально трудно вот еще пример уже из нашей практики и в работе с одним из клиентов это было достаточно много лет назад однако случай довольно яркий у них был запрос к странице генерации отчета по приходу request a сервером начинают собирать отчет по каким то внутренним хранилищем отчет размером примерно 200 мегабайт и работает это внутри работает это минут 15 еще пять минут идет передача данных то есть нам пишут клиенты просят увеличить время таймаута на 20 минут на один из степи запрос но казалось бы как black приложение обязывает над надо идти на встречу с другой стороны это мало чем отличается от так и на исчерпание ресурс сервы на прикладном уровне каждый такой запрос это просто удар по печени для приложения если их будет хоть сколько-нибудь много на 1 маленького количестве api адресов это все это крышка гроба понятно что в такой ситуации придумать какую-то защиту от злонамеренного использования вот той самой заложенной строителями логике приложения ее почти невозможно она сама себя убивает таким подходом вот как как посмотреть на это с хорошей стороны как как так как так не делать чтобы не получить закономерный исход в результате прикладной атаки лечь и при этом сэкономить ресурсы нашему туда серу но во первых в идеале должны быть мелкие запросы и каждые действия пользователя каждый запрос какому-то отдельному компонент который интересует должен превращаться в запрос до бэг-энда должен там старица должен попадать в логе пусть даже это будет асинхронно не одновременно с тем как он попал туда но зачем нам это нужно как минимум для того чтобы понимать что черт возьми у нас происходит в каждый момент времени для того чтобы мы могли понять что хотел сделать наш юзер для того чтобы могли понять как он пытался это сделать там нет того были это добрые намерения или не очень как когда и намерение очень от особенно интересно наблюдать паттерна размышления атакующего на примере того какие запросы он перебирает на какие и иран пытается прийти и же с ними вот так же поможет нам найти ботаники в производительности на прикладном уровне какие запросы для нас максимально дороги может быть их можно как-то удешевить или распределителей разделить не делать самим себе больно ну и конечно trouble shooting если все-таки что-то на вернулась опять же локализации этого места для нас будет максимально просто сравнению с гетс ваш пост flash ну и здесь важное замечание что когда у нас возникает такой лойк появляется серьезное ограничение на шаг со слов содержащий фактически все паттерны поведения тех юзеров которые к нам приходят паттерна поведение злоумышленников как только нам приходит он становится наш интеллектуальной собственностью он говорит про наше приложение скажет может рассказать про наше приложение тому кто увидит гораздо больше чем любой дизайн любые перформанс цифры и так далее это фактически ключ к нахождению хорошего и плохого в самом приложении его нельзя никому пока с полной виде его нужно скрывать ну и наконец наверно моя любимая тема про технологии фичи я уже затрагивал эту историю на митапе highload сибирь в этом году у меня там был узкий кусок предметной области про он полем тип сокета ну и я не могу пройти мимо в этот раз мы будем исходить из следующей парадигме все что мы хотим получить в плюс от использования технологий который позволяет нам либо ускорить время ответа или уменьшить число одновременно открытых соединений чтобы все эти действия все эти нововведения не отняли у нас живучесть которую мы так тщательно пытались заложить на предыдущих этапах которые мы уже рассмотрели адрес ты пространство компоненты логика запросов о чем здесь речь ног простой пример это любимый многими ищите пе-2 который действительно решает задачи как по ускорению так и по экономии ресурсов в большом количестве кейсов особенно про мобильные приложения однако есть как минимум одна серьезная причина задуматься перед тем как внедрять его без всякой задней мысли этот например export под названием ищите пе-2 цунами я привожу название статьи очень рекомендую вам ее почитать изучить цифра который там приводится я же процитирую непосредственный а уткам в часовом представления статьи речь не о том что в ешьте пе-2 заложена возможность атаки типа амплификация используя прокси который обращается к старому доброму и степи 11 бэг-энда за счет компрессия заголовков можно превратить один запрос типа еще два в сотне запросов и степи 11 в бэг-энд что при должен нагрузки может превратиться в катастрофу когда мы говорим про амплификация здесь мы видим фактор увеличения то есть то самое плечо насколько мы умножим наш трафик господа рассмотрели будучи не архитектором приложения они рассмотрели это в контексте полосы пропускания и пакет в секунду на однако по факту при проверке с запросом происходит тоже самое виде цифры на большом количестве кантор на соединения у нас же все таки хайло дали нет мы имеем что 1000р psp2 прощается 173 тысячи запросов ты по 11 к нашим брендом мы взяли и утопили сами себя через ftp вопросе погнавшись за скоростью вот такие ситуации нужно учитывать в том числе когда используем средства защиты при проектировании приложений если же мы говорим про уже не очень любим многими технологией он полинга пушить из гипса китае вот с ними отдельная история дело в том что базовая логика работы этих механизмов она фактически не отличается по внешнему виду и по численным параметрам от атак на долгоживущие соединение которые используют dooster на прикладном уровне мы говорим про суарес просто рис тир дроп орудие когда мы открываем соединение начинаем в час по чайной ложке писать-читать резервировать буферы при должной сноровке атакующему не нужно изобретать этот велосипед на своей стороне он использует предложенный механизм тот же самого он полем вишняк поладить эти соединения дело серверу плохо не тратит дополнительных денег а если вы используете на своей стороне прокси для балансировки для защиты для анализа трафика для чего-то еще вы делаете себе еще больнее потому что терменируют такие долгоживущие соединения на прокси и поддерживая хл оба конца вы каждый раз тратите вдвое больше ресурсов у вас нет возможности мультиплексирование соединения сэкономив хотя бы один конец вы можете поехать по ресурсам балансировщика вы можете приехать по количеству серый портов да такое тоже бывает в итоге затраты на нашей стороне после внедрения этих технологий увеличиваются существенного профита особенно в плане защищенности мы здесь не имеем нужно хорошенько подумать перед тем как рассматривать эти технологии для внедрения в наш непотопляемый сервис однако у нас может возникнуть ситуация когда с этим ничего не поделаешь у нас либо она уже есть и там никто не позволит его выкинуть как конструктору как строителя либо бизнес этого требует либо задачи который мы решаем ставки результаты матчей котировки акций нам нужно что-то кушать нужно делать эту реальном времени но куда деваться здесь к сожалению хэппи-энда не бывает приходится идти на компромисс a compromise здесь опять же из опыта строителей боевых кораблей достаточно простой если у вас есть что-то что вы не можете эффективно защитить но оно обязательно должно жить на вашей стороне готовьтесь потерять от компонент во время dos атаки готовясь к тому что вам придется просто обрубить его закрыть порт к примеру где-нибудь на верху и перестать принимать туда трафик все время пока атака идет до этой цели у вас должен быть fall back на старый добрый чипе 11 с понятными короткими запросами с понятными тайм-аута my с понятной аналитикой пусть он работает хуже пусть он работает медленнее может быть это не очень понравится юзерам однако мы вспоминаем что номер два в основных требованиях которые мы перед собой поставили как конструкторы что мы должны важнейшие задачи решать в период когда нас активно атакуют важнее задача это как-то доставить тоже сам контент до пользователя и пережить период атаки чтоб потом включить снова наш фастекс джен технолоджи ну и когда мы уже спроектировали все уроне о которых мы поговорили когда мы предусмотрели все эти возможности осталась еще одна вещь мы хотим защитить приложение с помощью средств защиты внешних или внутренних насколько хорошо то что мы на проектировали вяжется с тем что средства защиты предоставляют насколько оно гармонично там был простой пример и с флотских историй при конструировании кораблей заключается в том что американцы проектировать тяжелые крейсера вот один из примеров это тяжелый крейсер миннеаполис конструкция корпуса было сделано таким образом что каждый отсек обладал очень высокой прочностью и устойчивостью к затоплению большое количество мощных переборок но целостность самого корпуса между отсеками было не очень высока поэтому при попадание торпеды в носовую часть корпуса но на картинке видно что произошло он лишился всей носовой части вместе с носовой орудийной башни и всеми кто там находился собственно срез шел точно по стенке переборки вот и и отогнуты кусок виден в передней части экрана он сохранил плавучесть добралась до базы но мог бы пойти с меньшим повреждениями если бы общее целостность корпуса была чуть выше как это параллели с тем что у нас происходит но средства защиты должно правильно реагировать на то что у нас происходит и должно быть устойчивы к тому чтобы его обошли и мы на нашей стране тоже должны это предусмотреть там простой пример когда мы защищаемся через reverse dns проксирование и за умышленных из изобретает варианты как бы ему не сталкиваться средства средства защиты вообще значит простой пример который теперь любой кто внедрял внешние решение знает каким образом происходит подключение значит у вас есть origin сервер на котором стоит engine x и чтобы пустить все запросы через допустим облака вы переводите зак вы меняете а запись dns а и все запросы теперь начинают идти в облако а на ваш сервер они уже сваливается через настройки прокси рования соответственно у вас есть два и pr риса оба очевидным образом доступна через интернет один из них вроде бы только один из них виден снаружи потому что находится в dns записи виден ли только один вот этот вопрос на этот вопрос как это ни печально атакующую как правило ответ находится раньше атаки которая до используют для обхода защиты через прокси называется общий термин дар актера джим прямо к источнику так называют зарубежные м и со спины примера в своих публикациях но термин уже достаточно общей употребим ой вот вариантов реализации такой атаки их много их больше десятка самый популярный самоочевидно из них мы перечислим это заглянуть в историю dns куда раньше указывала а запись до средства защиты найти старый адрес возможно он остался старом налить туда об мы попали посмотреть на под домены находится ли они под защитой не указывают ли они на адреса из той же сетки где живет защищенный сервис если да но мы опять нашли ответ на свой вопрос посмотреть по сканить айпи адреса все вопила 4 пространство можно пройти за несколько часов таким образом посмотреть какие сертификаты отдают адрес а потом посмотреть на какой домен выписан сертификат увидеть совпадение опять же мы нашли исходный адрес можно туда атаковать загрузка файлов с онлайн-сервиса пути к файлу может найти себе пи адрес тоже частая история ну и всеми любимыми исходящие соединения ваш почтовый сервер с даст вам атакующего если вы не предусмотрите то чтобы он не жил рядом с ваш новостным ресурсам или не сидел в сети или не было как-то ещё защищён есть неплохая статья на русском языке которых вкратце из эти другие методы я привожу ссылочку ее можно будет взять из слайда что нам с этим делать но здесь нужно понимать что задача маскировки айпи адресов при роберт и нас проксирование она условно говоря на сто процентов не решаем и мы можем предусмотреть все методы но возможно атакующий придумать что то еще или где то все таки мы что-то забудем в этом мы составляем чек-лист термин который тоже пошел из военного дела но уже от авиаторов мы составляем чек-лист тех проблемных мест и методов которыми а такер может нас обойти мы пробегаемся по нему каждый раз когда мы вводим в эксплуатацию с внешним доступом новый ресурс на новом адресе новый вдм и стараемся это это учесть если же у нас есть провайдер независимый собственный блог из у нас есть своя автономная система если у нас есть бюджет и соседи то здесь ситуация немножко другая акцента смещены с таким образом мы не прячем ни от кого наши адреса и мы можем защититься с помощью тех самых распределенных свет защиты так что достаток и никак нас не обойдет потому что эти адреса анонсируются провайдером защиты весь трафик приходит туда и все хорошо все хорошо только если мы одновременно не держим анонсы например более крупной сети на других провайдеров или вообще на точке обмен от райском чтобы иметь дополнительный свет и вдруг провайдера защиты сдохнет и перестанет доставлять нам трафик тогда он только такая ситуация открывает ту же самую лазейку для обхода если трафик на льется из того провайдер который просто не видит анонса от средства защиты это значит что мы опять же сами себе открыли обходную дверь для атакующего и ничего не можем с этим поделать ну и плюс когда мы решаем задачи по защите уже провайдеры независимых сетей через общение по протоколу бюджет и перед нами открывается риски по серьезнее чем просто получить ddos-атаку угон префикс это уже не просто пропавший трафик это 100 это чревато и более страшными последствиями но это тема уже для другого доклада я думаю вы скоро нему знаете про обратную связь мы вспоминали что мы хотим чтоб средства защиты всегда знала о том что у нас все хорошо или уже все нехорошо так же как и корабль если он остался в бою без связи с остальным флотом без связи со своей базой он не сможет попросить о помощи что мы можем рассказать о себя наружу как онлайн-сервис можем дать какие-то масках со слогом и помню что весь этот звук показывать нельзя это очень конфи циальной информация но какие-то данные из него вроде времени ответа в роме вроде количество ошибок можно и нужно уметь отдавать наружу если время про наших borders то это конечно над fotpix информация о трафике если мы хотим быть уверенны что средства защиты ему не все равно как ваш бизнес себя чувствует от разных действий после можно there some business метрики сформулировать в численном виде и отдавать как time series одновременно с техническими показателями здесь есть варианты что мы пытаемся таким образом достичь мы хотим не ставить опять вопросом и не ставить того кто на защищает снаружи перед вопросом мы не получаем обратной связи потому что ничего не происходит и потому что все уже умерла с точки зрения внешнего средства мониторинга или внешнего средства защиты без обратной связи ситуация будет абсолютно идентичны это плохо и тут мы вспоминаем что мы при проектировании компонентов сделали с нашим сборщиком транслятором ожёгов что мы убрали его с дат faina и сделали более менее автономным вот тут-то нам и пригодилась эта схема например простого кейса у заказчика логе собирались сироп приложение на балансировщика атака исчерпала ресурсы балансировщика не нагрузив вам канал связи до предела то есть возможность про итоге была но балансировщик приехав по do to play ну не имел вычислительных ресурсов для того чтобы агрегировать и отправлять логе он просто замолчал средств защиты не увидела каких-то панических графиков каких-то подозрительных вещей в временных метриках запрос просто потихонечку ушли на нет как будто трафика стало меньше вот это не выглядел как атака и только уже про диагностирует изнутри стало понятно что бой сиропчик был залит трафиком осталось у плохо если бы бог сервер в этом случае стоял отдельно вот он бы первым среагировал на ситуацию и какие-то тревожные сигналы от балансировщика отправил бы отдельно от него средства защиты об этом был узнала и принял соответствующие меры то есть в такой ситуации наличия обратной связи как в критической так и в нормальной ситуации она абсолютно обязательно ну и наконец для того чтобы наша обратная связь как-то правильно интерпретировать теми кто не читает теми кто воспринимает нам нужно присылку прядь к ней информацию о том что вот эти данные они нами как сервисом как бизнесом который тот сервис использует считаются нормальными или нет мы же говорим нас есть технические метрики связанные с там с тем как отвечает наш сервер а мы добавляем к ним бизнес критерии которые тоже можно выразить пример в таком же виде если нам важна и количество кликов в секунду на определенное место на сайте если она напрямую превращается для нас в деньги или в известность или в распространенность почему бы не учитывать это эти данные в совокупности вместе с постоянными данными от мониторинга позволят тому же самому средства защиты отвечать на всякие сложные скользкие вопросы как например у нас есть некоторый паразитный трафик которого сейчас не очень много он сейчас не делает особо больно приложению но если вы станет чуть чуть больше возможно у кого то начнутся деградации увеличится время ответ увеличатся ошибки мы можем ничего не делать можем попытаться вы сейчас заблокировать но если мы будем это делать по тем данным который мы сейчас собрали могут случиться ложные срабатывания могут быть заблокирован на какое-то небольшое количество реальных поиски что для нас дороже в этот момент потерпеть лишнюю нагрузку паразитную или кого-то по банить вызвать у кого то неприятное ощущение здесь ошибка второго рода вспоминаются я думаю что про них можно пару слов то рассказать в темпе вальса данный чит при в процессе если в решении использовать машины обучения у него могут возникать проблемы двух типов либо ложное срабатывание либо пропуск события соответственно если вы используете такое решение напрямую или она входит в продукт который вы пользуетесь крайне рекомендуется уточнить во-первых какие проценты заложены как фолз позитив так и ползти к тевс и если у вас есть какие-то пожелания то сразу их выразить потому что построить решение которое будет иметь ноль процентов волос позитив слегка у него быть просто стопор in the falls на быть сломаны это как сломанные часы которая два раза в сутки показывают правильное время если это не полгода так что обязательно уточнить эту поддержки и вот ну или если это описано в даташите продукта тут уточните прямо там как настраивать ну что ж мы пробежались по всем палубам нашего будущего непотопляем ого корабля доступного для сотен тысяч пользователей из интернета посмотрели где могут возникнуть повреждение от вражеских торпед бомб таранов можно сделать простую выжимку на каждой палубе какие вещи мы хотели бы предусмотреть я не буду пробегаться по каждой в отдельности потому что мы про все это уже поговорили остается наверно два ключевых момента здесь напомнить наверное как наверно как самое важное из всех этих вещей первое это то что нужно быть готовым повреждения нужно быть готовым к тому что какие-то компоненты обязательно выйдут из строя от ddos атак и это нельзя будет моментально предотвратить и второе то что нужно быть готовым те компоненты которые могут еще больше вреда причинить если их атакуют отстреливать и заменять их более надежными на время атаки даже если они чуть хуже чуть медленнее чуть скучнее работают надеюсь что эта информация поможет сделать много количество сервисов более непотопляем более устойчивыми более подключаемыми к разным защиту но туда сером осложнить жизнь спасибо большое за внимание и если есть вопросы"
}