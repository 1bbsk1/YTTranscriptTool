{
  "video_id": "phqkO7pG7d4",
  "channel": "HighLoadChannel",
  "title": "GraphQL Federation, или Как не выстрелить себе в ногу / Иван Решетин, Игорь Малюк (Юла)",
  "views": 3322,
  "duration": 3095,
  "published": "2021-10-04T02:11:30-07:00",
  "text": "Всем привет Меня зовут Ваня решетин Я руковожу Командо Кэн платформы в Юле А мы сегодня с Игорем малюком расскажем вам про Граф Q Федерацию сразу надо уточнить почему же Нас двое Дело в том что исторически я отвечал за внедрение граль в Юле Игорь занимался внедрением Федерации поэтому наш доклад сегодня будет состоять из двух частей первый расскажу я второй расскажет Игорь А давайте начнём Игорь вернётся потом не переживайте в середине мы поменяемся а Итак Какая же цель доклада сегодня это в первую очередь поделиться своим опытом то как мы пришли к клю как мы пришли к Федерации и рассказать о своих ошибках и может быть предостеречь вас от их повторения А что сегодня будет расскажем какие у нас были проблемы до граля Почему мы в итоге выбрали И как мы переходили на Федерацию а также расскажем о том с какими сложностями мы столкнулись на каждом из этих этапов чего не будет сегодня не будет копипаста документации Я думаю вы сами сможете с ней познакомиться и не будет примеров кода больших листингов чтобы вас не перегружать мы пройм так более Высоков по всем тем Во что Тае ла с точки зрения цифр ла - это нагруженный проект у нас 27 мл пользователей в месяц у нас больше 30 мл активных объявлений 200.000 запросов в базу мы используем db как основное хранилище и больше 120к rps на наши бэнды мы используем Современные технологии которые пот нам акв Варах Поль основные платформы это iOS Android и конечно же и это использует масштабируемых мы где можно используем кластер на решение у нас более 500 серверов распределённых по трём независимым дата-центра Давайте поднимите руку вообще кто использует вдак как сейчас ещё использовать не использовать Прекрасно Я очень надеюсь мы вас не разубедить запросов в ашапе он предоставляет полное понятное описание в вашего апе а описывает Какие структуры У вас есть а и позволяет клиентам получать только необходимые данные которые им нужны а также производить какие-то манипуляции с этими данными буквально два слова про тип операций есть в это запрос за на получение данных ну аналог ГТ запроса в росте есть мутации это запрос на изменение данных аналог Del в ст есть ещё подписки Ну из названия Понятно позволяет клиентам подписаться на какие-то события от в понятиях gql занимает Гра ql схема Что это Это собственно и есть описание того как как выглядит ваш А какие у него структуры Какие имеют типы Ну вот например наша такая базовая для юлы сущность как продукт может иметь Вот например такой набор полей А у например пользователя будут другой набор полей А И как Видно у продукта У пользователя есть такой тип как IM кроме стандартных строк там Ну Тип и может выглядеть вот так там с одним полем URL картинки мы поговорили про Операцию вообще что такое как он выглядит клиенты запрашивают на какой-то странице только те поля которые им нужны и перечисляют собственно должны перечислить все те поля которые они хотят использовать из данного примера видно что клиент в данном случае Не запрашивает наме описание здесь не нужно и его не перечисляет в своём запросе ну и соответственно его не получает Это позволяет экономить ресурсы если у Вас например описание хранится как-то отдельно от сущности от базовой сущности продукт соответственно на бэнде вы не будете его собирать и экономить тем самым ресурсы на построении этого поля и на пересылке но историче архитектуру про Конечно уже очень много всего сказано не буду здесь останавливаться на всех там плюсах минусах и недостатках я расскажу Только о тех там двух основных проблемах с которыми мы столкнулись и которые для нас были а наиболее критические а Первое - это увеличение От даваемый данных на ручки ну ручка все знают да это endpoint А можно я буду говорить ручка Спасибо А вот такая ручка такой endpoint да как продукты на старте юлы на старте нашего проекта имел Ну какой-то ограниченный набор полей а но проект развивался продукт рос увеличивался проводились какие-то эксперименты добавлялись поля А не все эксперименты приживалка и часть полей стала ненужно и в новых клиентах она не использовалась мы не можем просто так взять и выпилить эти Поля из респонс потому что у нас есть много старых мобильных клиентов которые не обновляются а Force update мы не практикуем по продуктовым соображениям И если мы начали отдавать какое-то поле для мобильных клиентов мы должны его поддерживать до конца и таким образом наш респонс продукта вырос до очень больших размеров он бы сюда не влез и что мы сделали мы сделали V2 выпили все ненужные поля переключили новых клиентов на новую версию но Собственно как понятно он повторил версию О он вырос и добавились куча ненужных полей версию 3 мы уже Решили не делать решили на этом остановиться и искать другое решение Давайте посмотрим вторую проблему которая у нас была это Множественные запросы с одной страницы О чём это речь здесь главная страница лына Давайте посмотрим состоит из разных сущностей это баннеры сторисы какие-то гео заголовки карусели сами продукты в общем реклама и так далее И какие же есть варианты запроса такой страницы с мобильных клиентов посмотрим как это было и Какие есть варианты изначально мобильные клиенты делали множество запросов в такие целевые сервисы за этими данными а делали они рестом здесь в общем-то все проблемы понятны все реста это либо у вас растут данные либо необходимо версионирование а плюс это множество запросов на наши бкд и одна из проблем ещё - это походы напрямую в сервис а часть сервисов у нас на Go часть сервисов на PHP часть сервисов вообще живёт в монолите И если нам нужно например распилить монолит это уже становится проблемой а потому что клиент ходит в него и чтобы вынести функционал и перестать его поддерживать Ну в общем здесь определённые проблемы и то на что мы посмотрели Первое - это какой-то IP Gateway тоже ростовый клиент делает ростом запросы в этот Gateway а он уже под капотом начинает ходить по сервисам А ну из минусов это всё та же необходимость версионирование то на что мы посмотрели уже gql это перевести все наши сервисы на gql протокол чтобы клиент запрашивал только те данные которые нужны он был бы счастлив всё здорово но от этого сразу отказались даже не пытались Это внедрить потому что здесь кроется очень критическая недостаток А это конфликты типов которые нужно решать на стороне клиентов если у вас придёт один и тот же тип там из разных сервисов там от продукта и не знаю от сторисов придёт какой-нибудь юзер он может конфликтовать это приведёт к крашу приложения очень усложняется поддержка особенно со стороны клиентов и в общем для большого сервиса такая архитектура не подходит А поэтому мы остановились вот на такой когда у нас есть gql gway Клиенты по GRA Q протокол ходят в этот gway а он уже под капотом ходит собирает данные всех сервисов А да здесь появляется дополнительный слой и на тот момент когда мы это выбирали нам показалось других недостатков у этой схемы нет всё классно давайте внедрять мы выбрали Граф KL а чего мы получили мы получили типизацию ну здесь Наверное тоже нет смысла объяснять почему это хорошо а так как у нас разные клиенты и разные отображение А есть там мобильные Клиенты у них маленькие экраны мало данных есть Web вылезает больше данных они могут другие данные запрашивать и всё это нам помог решить Граф ql а также мы получили под капотом статистику запрашиваемых полей по всем нашим данным мы смогли понимать где Какие поля используются Какие не используются чтобы перестать их поддерживать А И самое главное мы скрыли реализацию вот этих самых целевых сервисов И тем самым смогли нормально пере как там распиливать наш Монолит переписывать сервисы там на другой язык и Возможно даже менять у них интерфейсы клиента при этом не нужно было переп они все были завязаны на gql А из нюанси мы расширили тек нам пришлось проводить обучающие Мета для коллег вообще как этим пользоваться и очень важно нам пришлось очень глубоко переработать на шапе А так как например та же ручка продуктов отдавала просто всё включая юзера и какие-то данные по аналитике И ещё что-то нам пришлось очень внимательно подойти к разделению вот этих доменных зон на то что является продуктом и базовой этой сущностью продукт Что является юзеров нам пришлось очень хорошо переработать всю эту доменную а область Итак выбираем graphql А какую же библиотеку выбрать м большинство сервисов У нас написано на Go м gql Мы тоже Gateway Мы тоже решили писать на Go А посмотрев в библиотеке мы выбрали ту которая практикует подход схемы First А о чём это а мы описываем схему как в левой части экрана видно мы описываем схему какие там типы А как Они между собой связаны генерируем код Вуаля всё здорово у нас генерируется огромное количество го кода с резольвера всё здорово нам такая схема понравилась мы используем библиотеку Из плюсов это меньше ручного труда мы просто описываем схему причём делаем Это с мобильными Ну с клиентской разработкой мы прорабатываем вместе с ними что важно всю нашу структуру будущего а и на выходе получаем готовые моки резолв с помощью которых мы можем уже энд наполнять их какой-то бизнес логикой А по существующей схеме параллельно мобильная разработка Может начать там пилить свои фичи иногда это очень удобно а Итак мы получили главную страницу одним запросом это показалось удобно всем и мобильная разработка была довольна и Энд был доволен и мы начали активно внедрять всё это все радовались и на Первом запуске когда мы перевели главную страницу наша Гра схема выглядела вот приблизительно так мы перевели все основные сущности какие у нас были и запустили всё здорово но время шло прошло полтора года всем это нравилось количество команд которые захотели так сделать увеличивалось И эта схема за полтора года выросла в несколько раз приблизительно до такой более того это ещё не предел оставалось очень много рест ручек которые должны были переводиться тоже на Граф ql А И как я говорил вроде бы такая схема нам казалась идеальной какие у неё могут быть недостатки вообще всё прекрасно А мы начали сталкиваться с проблемой И основная и главная проблема в которой мы упёрлись это бутылочное горлышко нашего гевея с точки зрения разработки Дело в том что gql Gateway пилила кор Команда А целевые сервисы пилили продуктовые команды и когда продуктовой команде нужно было добавить какое-то поле к себе они прибегали к кор команде с задачей добавить это поле поддержку этого поля на Гра Ну собственно надо было деплоить и сначала например юзеров потом ql количество сервисов увеличивалось количество команд и и полей увеличивалось и это в общем стало серьёзной проблемой и плюс А усугублять это всё тем что Gateway начал обрастать какой-то минимальной бизнес логикой А и всё это пришлось поддерживать кор команде нас это конечно не устраивало А мы хотели в общем-то что-то поменять что же можно было поменять Ну в принципе можно было поменять отношение к данной проблеме смириться терпеть Ну конечно нет Ну мы чуть-чуть потерпели нам это очень быстро надоело и первое предложение было открыть полный доступ для в репозиторий этого гевея для других команд Ну тоже такое себе кор функционал команды Большие В общем от этого тоже сразу отказались и мы пришли к практике когда другие команды делают реквесты а команда кор команда их реют и собственно применяет в какой-то момент мы так жили всё было почти хорошо Пока этих котиков и команд не стало настолько много что кор команда начала превращаться в команду ревью Веров и это стало просто невозможно очень тяжело и собственно мы тогда ушли дальше думать и искать наше какое-то идеальное решение как же Как выходить из сложившейся ситуации а но чтобы его найти нам нужно было сначала формализовать вообще все наши требования чего мы хотим теперь получить новое А что же мы хотели получить первое мы хотели оставить вот эту единую точку входа для клиентов А и также мы хотели оставить единую схему для клиентов А не а чтобы её не разбивать и чтобы не мержить эту схему на клиентах то есть схема для клиентов Должна остаться единой но а мы также хотели разбить эту схему таким образом чтобы каждая команда отвечала сама за свою часть схемы и только она бы за неё отвечала И ни на кого не афек и при этом любые изменения этой схемы должны происходить Ну на литу То есть если у нас какой-нибудь сервис продуктов добавляет поле то никакие другие компоненты системы нам не нужно переп чтобы они ну собственно разграничить вот эти вот доменные области о том как мы искали решение о том что было дальше а расскажет Игорь а Игорь прошу А и Да вот мы собственно хотели вот прийти к подобной схеме СБО Ир Всем привет Меня зовут Игорь Я занимаюсь разработкой в команде платформы и сейчас расскажу какое решение в итоге мы пришли Какие искали какие были альтернативы и об этом первое что мы хотели сделать это разбить схему по файлу Что это значит изначально у нас была Вот такая схема то есть в нём была один файл и один генерирующий файл кода такую схема было не очень приятно поэтому первое что мы сделали просто разбили схему по файлам то есть мы пишем под каждую домену областьа погоне отф с кодом таким образом реть проще Понятно Куда Кто изменил вносил правки какие-то и так далее но это ВС ещ основался Монолит от него мы хотели уйти на самом деле последнее что мы рассматривали и что нам приглянулось это была Граф Федерации вообще кто-нибудь из вас слышал пробовал граль Федерацию можете руки поднять Понял сейчас будем во концепция заложена ребятами из компании а Наверное вы сталкивались с ними если работали с клиентскими библиотеками или северными библиотеками и так далее вот относительно недавней концепции которая была разработана году что она позволяет делать вообще Она позволяет вам объединять схемы из нескольких сервисов предоставляющие графе воо позволяет Раши так чтобы клиент об этом ничего не знал и также она в ран тайме умеет валидировать схему чтобы не допустить каких-то критических наложения типов друг друга друг на друга конфликтов и так далее поэтому вы можете быть уверены что текущая ваша схема которую получит Федерация как сервис будет Валид и линты ши не ут поэтому вс всё то что может нам дать Федерация и опробовали это решили рассматривать дальше я уже говорил о аполо Граф Федерации так как они первые самыми стали те кто реализовал саму сам сервис Федерации и у некого конфига а вы даёте на вход ему список сервисов списком сервисов является объект в котором должно быть название сервиса и URL URL по которому Федерация сможет общаться с сервисом пересылать какие-то конкретные части схем от клиента а также сможет первоначально забрать схему из этого сервиса чтобы знать как Отвечать по ней но такая схема естественно подходит не всем потому что Федерация это делает в ран тайме она сама запрашивает сервис говорит Дай мне свою схему и по ней начинает уже работать в этот момент сервис может лежать или что-то не получится стянуть на этапе первоначального запуска и соответственно Федерация не сможет корректно работать вам подойдёт такая схема Если Вы не боитесь конфликтов самих типов схем То есть вы заранее ВС лидие проверяете и вручную оцениваете риски Если вы лите монолитную схему здесь есть несколько нюансов которые не позволят вам сделать это неким некой конфигурацией статичной и также Если для вас кратковременный дата не проблема Это вытекает из второго пункта будут моменты когда вам нужно будет остановить работающий сервис но вы можете в принципе это сделать если например разрабатываете внутренний портал и Он поддерживает Гра ВТО второй способ запуска этого Серви называе здесь основной ключевой момент является то что вам необходимо чтобы у вас был некий сервис сма registry немножко об этом сервисе схема registry - это по сути сервис который предоставляет Центральное хранилище для ваших последних актуальных композиций схем много слов композиция схемы композиция - это по сути набор набор схем сервисов последней версии какой-то версии так вот с помою этого сервиса Федерация сможет вы сможете добавлять схемы в сре а Федерация сможет получать эти схемы из того же схемы один важный нюанс В будущем я скажу подробнее про это Но мы сделали себе свой что же такое федерация Федерация стоит из не компонентов любо первую очере KL стала Note JS сервис Федерация включает в себя сам компонент Федерации который занимается тем что создаёт некий планировщик запросов планировщик запросов - это структура которая знает какую часть в какой сервис отправить а это сам поло сервер он собственно занимается тем что просто трансформирует из слоя htp Граф KL схему и передаёт её Федерации и поверх этого всего у вас будет лежать какой-нибудь htp фреймворк по умолчанию все используют JS Express но вы можете использовать тот который например вам больше подходит соответственно в такой схеме когда Федерация получает набор схем Они прилетают уже валидные и также Федерация выполняет требования обновляться без пере деплоя ВС делается в ранта мы посмотрели такую схему поняли что в принципе Нам нужен был что для нас представляло из себя напомню что первоначально схема нашей работы выглядела Так у нас есть некий Граф написа он поддержит Гра интерфейс принимает запрос от пользователя и раскидывает всё по не слежавшийся ци подключаем к этому всему делу сре добавляем схему Монолита в СХ и всё должно было работать как мы запускались в первую очередь для нас запуском успешным нужно было Для нас было успешным запуском то что пройдут все тесты по сути мы взяли все Цион которые были поверх их Наде были отработать если бы они отработали Это был бы знак что всё работает всё ок так и было в принципе так наше лицо выглядело когда мы запустили тесты Но что по скорости как я уже сказал ну Федерация аполо реализации Федерации написано на not JS А у нас везде Go Мы думали как бы так чтобы всё было идентично мы начали запускаться из левой схемы в правую за базовую базовое время мы взяли 100% работы граль Монолита для нас показателем что всё ок И можно дальше работать было примерно такое 10% увеличение времени ответа По сравнению с текущим монолитом но тут Пошло всё не так как мы ожидали и мы увидели что приро времени Отта состави аж 300 когда мы посмотрели на всё это дело у нас было запущено около 10 инстан сов накинули ещё 10 увидели что CPU используется на 100% на каждом ноде и время ответа сократилось сократилось вдвое но всё равно оно превышало наш порог Поэтому покопали у себя вызов функции которая вызвалась синхронно для каждого запроса и это собственно и стало проблемой всех бед мы добавили фикс и увидели что время финальное ответа превышало наш gway всего лишь на 5% нас это устроило и мы решили попробовать распилить схему то есть не просто взять монолитную схему воткнуть поверх неё Граф Федерацию но и начать выносить микросервисы Граф интерфейс как мы это делали в первую очередь мы хотели добавить всем лежащим сервисам в которые Монолит ходил а GRA ql ией дальше мы хотели настроить поэтапный последовательный пуш каждого сервиса схемы в сервис СХ Reg и По мере того как мы делали этот пуш кусок схемы из монолитного граве он уменьшался и уменьшался до тех пор пока мы не смогли полностью убрать GRA KL Gateway как монолитный KL и собственно финалом всего этого стало то что Федерация ходила напрямую в каждый сервис через интерфейс граля как это примерно выглядело на схеме то есть представим что у нас есть Гра монолитный у него есть много-много кода здесь он упрощен у нас есть базовые типы пользователей базовые типы продуктов есть для продуктов Поль Дале по доменным областям соответственно у нас есть два домена продукты пользователи здесь это ВС превращается примерно в следующую картину у нас остаётся в сервисе создаём два сервиса у нас получается что в сервисе продуктов остаётся схема только продуктов в сервисе пользователей только пользователи но Федерация нам позволила пойти дальше мы смогли расширить сервис пользователе добавив в каждого пользователя продукт при взаимодействовать с самим сервисом пользователя так как зачастую у Вас например если есть сервис товаров то вы будете знать его own ID или User ID Вы вполне сможете предоставить информацию по товарам конкретного пользователя чем собственно сервис продуктов и занялся как мы реализм это дело вообще я уже говорил что у нас был схема registry и это достаточно большой компонент который позволит вам позволил нам сохранять новые версии схем позволил нам создавать версии композиций и позволил нам валидировать на этапе перед тем как Федерация получит вообще новую версию Что делает Федерацию в принципе не нужной к пере деплой Если только вы не меняете её код поэтому когда мы получили такой сервис мы задумались о том как мы будем добавлять изменения вносить изменения в такую схему распределенную первая первый способ релиза и первый сценарий релиза - это когда вы добавляете Новый сервис представим что у нас есть три сервиса работающих в продакшене это Например какие-то продукты пользователи и баннеры мыж добавить СМУ в назовём его дальше мы пушим его схему в сам сервис Reg На этом этапе после того как мы зашили Деп сервис сам по себе но о нём ещё никто не знает ни Федерация ни схема Reg далее схема Reg СХ Схема этого сервиса добавляется в сре Прошу прощения за оговорку на первом этапе мы дием его с что быть уверены что в дальнейшем мы сможем запушить его После добавления схемы СХ registry Федерация автоматически получает новую версию этого схемы этого сервиса и Может с этого момента рассылать клиентские запросы которые придут в федерацию по куску схемы из Stories здесь достаточно всё просто то есть добавляем никаких конфликтов нет но есть е один нюанс сри между сервисами То есть как в нашем примере было это работающий Монолит у которого есть много много много типов у которого есть много доменных областей и его нужно как-то распилить так вот как это делается первым образом как это делали мы как первым этапом это создание сервиса продуктов Мы хотим выпилить продуктов туда схему с продуктами далее нам нужно сделать пуш этой схемы в с Но на этом этапе как очевидно мы получаем конфликт типов потому что и Монолит предоставляет идентичные типы запросы и так далее и сервис новый продуктов предоставляет те же самые типы поэтому схема Reg продолжает отдавать монолитную СМУ для Федерации но при этом он держит в голове чтото кото конфликтный пуш далее мы Несмотря на то что мы не смогли запушить эту схему в схему рере мы плом сервис продуктов то есть о нём никто не будет знать но теоретически если к нему обратиться по протоколу Граф то он сможет ответить После этого мы вырезаем все типы связа с продуктами из Монолита Вот как раз на этом этапе сма будет знать что раньше у него слилась схема на валидации продуктов и когда Он попытается сопоставить или смержить эту схему с монолитной схемой там уже не будет типов продуктов поэтому здесь будет успешный рж схема создаст новую версию и дальше Федерация прожит использовать но новую а продукты будут принимать все входящие запросы от Федерации с клиента при этом здесь важный нюанс что мы не деплоя Монолит На этом этапе ни разу сам как сервис поэтому все запросы которые происходят от клиента в федерацию по схеме продуктов и и происходят они в момент вот в эти нано микросекунды Когда происходит миграция Федерация всё ещё продолжает пересылать Монолит поэтому мы можем быть уверены что все входящие запросы по мигрируют на монолите у нас не будет никаких там конек таймаутов и так далее а все новые пойдут в сервис продуктов я вот говорил про схема registry в принципе что Он позволяет делать такие штуки и мы написали его сами Но на самом деле по умолчанию Ребята с которые сделали Федерацию они предлагают сервис сопо Studio называется это SAS решение которое позволяет вам по сути делать всё то же самое то есть у вас есть некий некая веб морда которая в которой вы видите валидации свои прошедшие для схем сервисы работающие какие версии схем используют они и на самом деле там очень много функционала дополнительного который упростит вам вообще в целом работу с распределённых мами мониторингом их отладка но нам не подошёл этот сервис К сожалению потому что как я уже сказал это сас сервис и он прис решения они не предоставляют на этом в принципе хотелось бы подвести выводы в первую очередь это минусы Какие минусы У нас появились при разработке сервисов и поддержки граля в первую очередь сложные миграции схем то есть Тот процесс который мы видели он явно не пахнет тем что нам просто вы что-то со схемой грав Production и все дела второе а в Федерации нет подписок возможно пока но если для вас как для разработчиков использующих подписки это критично важно то возможно вы найдёте другую альтернативу например прямые веб сокеты но или оставить сервис один из сервисов фке открытым Для клиента продолжать с ним общаться через подписки а всё остальное перекинуть на Федерацию и ещё один минус усложняет архитектуру сервисов теперь сервисы должны знать как взаимодействовать с Федерацией то есть в схему добавляется некий функционал который сервисов обязывает для того чтобы например расширить тип одного сервиса другим Вам необходимо знать некий набор директив И последнее - это усложнился процесс релизов у нас теперь Дело в том что вот такие вот миграции типов из одного сервиса в другой они вызывают необходимость к тому чтобы у вас был определённый процесс То есть как мы видели мы сначала плом один сервис схему выкатываем по-другому у второго сервиса мы должны приостановить его деплой и так далее какие плюсы вообще есть у этого во-первых заставил нас заставило это более вдумчиво проектировать AP я говорю сейчас конкретно про схему келью потому что теперь команды более плотно взаимодействуют друг с другом а также с клиентами чтобы не создать лишних типов а они более вдумчиво погружаются в домен и так далее а даёт каждой команде независимость при разработке самого сервиса я сейчас говорю не про схему gql А про конкретно Код да схему мы пишем вместе зачастую но сам код команды разрабатывают Независимо То есть вы реализовывается своих резолв получение данных по Граф отдельно от остальных и типизация это в принципе относится ко всему Граф клю нам это очень помогает Потому что есть куча клиентов нам не нужно гадать Что будет при смене Типа если потому что такое такая смена вообще в принципе невозможна в наших реалиях какие есть нюансы у вот этой всей разработки Федерации поддержки вы Если вы захотите использовать такой подход как Федерации что-то другое может быть нело Определите модераторов схемы это в принципе везде говорится поло сами ребята говорят что у вас должен быть либо человек либо группа людей которые погружены полностью в ваш продукт и знают как тот или иной тип объявить Где сделать какую-то кри и так далее Потому что зачастую если у вас не будет модератора схем то все начнут родить своё и в итоге у вас получится одна огромная хоть и распределённая но схема разграничить зону ответственности сервисов это просто вы просто на примере с пользователями и продуктами не пихай сервис продуктов в пользователей Если вы знаете что это два раздельных сервиса два раздельных домена то просто Старайтесь разграничивать их зону ответственности И последнее у AP не решения как я уже сказал Если вас устраивает сас решение то в принципе ой почему бы нет Но если у вас жёстко завязаны по каким-то политическим причинам вы завязаны на свои сервера то наверное вам придётся разработать свои схема registry А есть осные версии но в Вы можете сами их протестировать если заинтересуется этим вопросом на этом всё спасибо большое за внимание будем рады ответить на ваши вопросы Да да спасибо большой ребят Так вопросы во-первых могут быть из зала во-вторых напоминаю тем кто нас смотрит в онлайне что вы можете либо ткнуть на кнопку и прямо выйти в эфир к нам Если вы не стесняетесь и мы были бы очень рады вас увидеть либо давайте пока сюда Здравствуйте Фёдоров Андрей МТС digit А вот я не очень понял из вашего рассказа А кто отвечает В итоге за модель данных если это ваша команда не оказалась ли вы не оказались ли вы узким звеном Хотел бы уточнить кто занимается моделью данных В текущей схеме или раньше В текущей схеме моделями данных занимаются как раз люди которые ответственны за свой за свой кусок Например если это продуктовое направление Если вы команда занимаетесь продуктом то Вы отвечаете за модель данных если у вас какая-то вы понимаете что ваши данные будут ша сма будет дальше возможно использована в других командах то вам нужно более плотно просто взаимодействовать с другими командами так как на нашем примере это вертикали и несколько направлений поэтому вам просто нужно банально организовать встречу и обсудить всё это дело наверное так Здравствуйте спасибо за доклад Меня зовут алее Компани а у меня два вопроса Первое - это сколько времени у вас ушло на переход на монолиты fql и переход на Федерацию и насколько вы уже перешли на Федерацию в процентном соотношении И второй вопрос - Это при распиливании Монолита Когда вы обновляется схему в Федерации гравли А есть ли возможность перегонять часть трафика на микросервис всего Ну то есть чтобы не 100% уходить Туй переезд в принципе награ ql наверное Ну около месяца занял это что в это входило это собственно написание самого гве это разбитие вот по доменным областям наших ручек продуктов и так далее Ну вот приблизительно месяц мы переезжали на на Федерацию тут большая часть времени заняла собственно разработка самого этого СХ Reg Давай ты да на самом деле с переездом на Федерацию было неоднозначно всё то есть сначала пробовали решения сас как раз таки от Студио но потом мы поняли что как бы не катит и схем примерно полтора-два месяца заняло разработка А дальше Просто плотная интеграция его с сервисами которые у нас были в первую очередь это Слим но тут просто нужно понимать что интеграция с микросервисами заключается не только вот взяли схему зашили её переправили трафик и всё пошло это ещё плотна интеграция с процессами потому что вы не будете это всё вручную делать Вот поэтому в целом где-то полгода от полугода заклады вос Насколько я понял вопрос второй заключался в том что можно ли нам перераспределить трафик Там половину например направить на Федерацию а половину оставить в Граф кель старый в рест А да можно действительно можно вы просто на самом деле трафик можно перенаправлять вообще как хо хотите поэтому изначально так и было мы Федерацию Раскаты там 5 10 15 20% она ходила в граф и у вас вам Никто не запрещает ходить в тот же рест он параллельно существует просто в конце концов вы должны прийти к тому что у вас в нашем понимании что у вас есть единый интерфейс для клиентов чтобы потом не было каких-то проблем да здравствуйте Спасибо за доклад яников Артур теньков мли Подскажите А у вас как-то вот можете прокомментировать ситуа кода о из сервисов хотелось бы получать вообще пустую страничку как-то Вот вы это обдумывает и как это собственно происходит Спасибо Да суперский вопрос вообще на самом деле как происходит ситуация без Граф K Федерации то есть приме Например у нас есть тот же самый Граф K Монолит который ходит в какие-то по http сервисы там по jpc Неважно Что будет если этот один из этих сервисов откажет тоже самое как бы тут мне кажется Вы должны продумывать логику сами но с Федерацией в случае с Федерацией Вы можете кастомизировать сервис сам таким образом что всё будет как вы хотите или если в случае если мы говорим что например сервис вообще лежит полностью и мы не получили его данные Да действительно здесь нужно будет скорее больше клиенту заморачиваться с этим как не отрисовывать мы с такими пока что проблемами на самом деле не сталкиваемся возможно лкм в будущем что сок отвалился и мы ничего не показываем но пока что это решается на клиентах аллон porche Rus вопрос Следующий Есть ли у вас карманы у Федерации в целом под интеграцию с Аро для оптимизации н трафика вопрос есть ли у нас карманная Федерация для карманы под закладки под интеграцию с Нет я момент один мы не разрабатывали саму Федерацию мы взяли библиотеку поэтому интеграции с авра или с jpc нету Федерации lpc тоже нет Давайте микрофон на трансляция Здравствуйте Меня зовут Василий разработчик тоже очень интересный доклад Спасибо у меня несколько вопросов они в принципе коротенькие первое очень интересно на чём написали саму Reg схиму схиму Да как бы Что это Это просто Статик какая-то которая отдаётся м или что это Ага и вы туда наверное путе просто гитом и всё да Вопрос в том как написано схема Reg на ЧМ что это такое вообще да вообще на самом деле его работа примерно похожа на гит как бы версии Там и так далее но это сервис на го так как в начале говорили что на го микросервис пишем Нет это просто обычный сервис на Go у него есть внутренняя реализация наший там cli штуки которые позволяет нам все icd работать с ним и у него есть там документа То есть вы можете сделать пуш там А всё понятно да спасибо на Go Мы тоже в принципе планируем у нас уже тоже такие реализации Сейчас думаем на чём а второй вопрос не не думали вы о том что есть смысл фильтровать вот эту большую Jon схему Да разными клиентами то есть одна схема и каждый Клиент говорит Я хочу вот это и получает то что он хочет а не пытаться вот так вот создавать какое-то универсальное такое штуку не было таких вопрос заключается в том что не думали ли мы отказаться от Гра смотрите была проблема что одна большая схема очень много данных о чём говорилось в начале Да может быть просто каждый Клиент будет говорить что он хочет забирать эта схема будет сама обреза под те потребности которые есть у клиента у косме что-то у вас такое есть наверное да или нет Я не совсем по вопрос как клиентам фильтровать эту схему Ну пожалуйста Get параметрами там дай мне только такие-то поля и всё тогда на ке пришлось бы типа если такая-то версия Ну это ну да не очень удоб ещ хотелось бы спросить вот нету проблемы большого жена то что один ДСО такой вот страница Да загружается с помощью одного большого Джейсона он очень тяжёлый и клиент сидит ждёт особенно если мобильный трафик вопрос в том что есть ли большой дн трафик который передаётся с клиента на сервер правильно не с сервера на клиент да ну безусловно у вас трафик в любом случае идёт то есть Может быть это отдельными кусками отправлять действительно по старинке они вопрос про то что у нас главная страница запрашивается с одним запросом получается огромнейший gip Нет проблем с этим Нет ну всё прекрасно работает у меня всё спасибо спасибо спасибо Здравствуйте спасибо за доклад Андрей Максимов мор ТВ вопрос в следующем не было ли задачи и если была то Как решали её когда нужно запросить с клиентов какие-то связанные данные например получить пользователя по пользователю выдать рекомендации там ещ ещ что-нибудь вот такого рода Да это собственно т т одна из тех проблем которые решает Федерация у нас то есть у нас есть несколько сервисов одна схема Для клиента вы видите её Ну то есть связанные данные То есть к примеру есть пользователи есть его отзывы например отзывы обычно это представим что они лежат в сервисе продуктов Как нам сделать так чтобы пользовательский ничего не знал вообще о том что у него есть Отзывы очень просто вы берёте в сервисе продуктов там где есть Поль там где есть Отзывы вы просто пишите Я как сервис продуктов Я хочу расширить тип пользователя который предоставил вот тип как раз-таки сервис пользователей я хочу его расширить и добавить ему там что-то связанное таким образом когда клиент видит эту схему он видит что у типа пользователь оты но сами отзывы предоставляют не сервис пользователей А сервис продуктов но Для клиента это реализация скрыто полностью он видит это как единую одну схему большую Федерация как раз занимается решением Такой проблемы те Спасибо за доклад Василий Можно я уточню вопрос может быть понял может нет то есть сервис продуктов который ничего не знает отзывах и наоборот точнее про об отзывах он делает запрос и получает данные и возвращает их в ответ Для клиента или клиент потом идёт ещё за этими данными персонализированным клиент делает один запрос Дай мне пользователя и его отзывы А смотря смотря на то Какую информацию он хочет получить по пользователям Например у нас У пользователя есть Last name и есть Э reviews что будет отзывами Федерация сначала загрузит э пользователя загрузит его lastname из сервиса пользователя Угу а затем возьмёт э Дело в том что в Федерации чтобы расширить тип Вам нужен чтобы он каждый тип имел некий primary Key то есть пра ключ там foren Key как хотите чтобы она смогла передавать его После того как она загрузит этого пользователя она возьмёт его ID Ну что является primary и отправит в сервис э продуктов Ну то есть Федерация как раз этим занимается острие вот эти запросы между собой всё понял спасибо О'кей продолж вопрос Я как понял У вас был botle именно в самом монолитном ФКУ схеме Да вот вопрос не думали ли вы решить как раз её другим способом то есть сделать несколько условно монолитов по условно клиентам Ну там применить БФ Да чтобы клиенты сами сопровождали а не вы бы их сопровождали вроде бы есть избыточная дублированной потому что фактически мы получаем много схем к примеру если там usame нам нужно будет в три схемы вносить Но с другой стороны сопровождение падает с коман команду клиента котора в принципе может договориться то есть в добавляем поле А дальше нужные клиенты добавляем вот в этом направлении кажется что не пошли если есть какие-то причины Расскажите очень интересно нет в этом направлении не Пошли потому что поддерживать Это тоже стало бы тяжелее и ещё раз у нас да разные клиенты разные верси наших реалиях и мы не рассматривали вообще такой вариант Окей спасибо большое"
}