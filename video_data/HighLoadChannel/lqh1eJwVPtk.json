{
  "video_id": "lqh1eJwVPtk",
  "channel": "HighLoadChannel",
  "title": "Patroni Failure Stories or How to crash your PostgreSQL cluster / Алексей Лесовский (Data Egret)",
  "views": 4184,
  "duration": 3224,
  "published": "2020-02-26T11:58:31-08:00",
  "text": "стандартный слайд немного расскажу про себе я начинал системным администратором работал веб-разработки с 2014 года работаю в dota играть компания занимается консалтингом сфере пожгли со и мы обслуживаем именно под grease и каждый день работаем с посольством поэтому у нас есть всякая разная экспертиза связанные с эксплуатацией вот и в конце прошлого года в 2018 году мы начали потихоньку использовать патроне и накопился какой-то определенный опыт мы как-то диагностировали его tune ли пришли каким-то best practice сам своим внутренним и вот в этом докладе я буду про него рассказывать помимо под grease а я люблю linux люблю ковыряться в слинг сам исследовать его собирать ядра и все такое люблю виртуализацию люблю контейнеры docker кубер нити смена все интересует потому что старые админские привычки люблю разбираться с мониторинга me i люблю пожгли совы и вещи связаны именно с совместным то есть репликация резервное копирование и в свободное время пишу нога не являешься в инженером просто для себя пишу того и как бы мне это доставляет удовольствие о чем будет доклад я думаю многие из вас знают что в патроне нет хавела бельке из коробки чтобы получить х и ловите нужно что-то поставить настроить приложить усилия и получить это собственно есть несколько инструментов и патроне это один из них который решает хавела убить довольно таки круто и очень хорошо но поставив это все в тестовой лобби и запустив мы можем посмотреть что это все работает как это воспроизводить какие-то проблемы смотреть как пан троне их обслуживает хиндли эти все ситуации и видим что все это прекрасно работает но на практике мы сталкиваемся с разными проблемами сталкивались вот и вот про эти проблемы как бы мы я буду рассказывать расскажу как мы это диагностировали что в итоге подкручивали и помогло это нам или не помогло вот чего не будет в докладе не буду рассказывать как установить патроне потому что это можно нагуглить в интернетах можно посмотреть файлы конфигурации как это все запускается как настраивается схемы архитектуры все это есть в интернете не буду рассказывать про чужой опыт буду рассказывать только про те ошибки с которыми столкнулись именно мы не ошибки о проблемы даже скорее всего вот и не буду рассказывать про проблемы которые за скопом пожгли со и патроне то есть если какие-то проблемы связанные с балансировкой когда у нас там кластер чего ты развалился я про это рассказывать не буду вот и небольшой дисклеймер перед тем как начать все эти проблемы с которыми мы столкнулись они были у нас примерно в 1 6 7 8 месяцев эксплуатации со временем мы пришли каким-то бы с процессом своим внутренним и проблем у нас исчезли вот поэтому доклад тоже заявлялся где тот полгода назад когда это все это было свежо в голове это все прекрасно понял по ходу подготовки доклада я уже поднимал старые пуст марты мы смотрел логе вот и часть деталей могла забыться либо часть каких-то деталей могла быть не до исследована в ходе исследования проблем поэтому в каких то моментах может показаться что проблемы рассмотрены не полностью либо из какой то недостаток информации поэтому прошу меня за этот момент извинить вот и перед тем как начать небольшой опрос зала кто использует патроне поднимите руку а кто планирует использовать патроне хорошо но давайте немножко пробежимся по азам по началам что такое патроне но патроне то шаблон для построения hail ability так написано в документации и с моей точки зрения это очень правильно и уточнение то есть патроне это не серебряная пуля которую поставил и она решит все ваши проблемы то есть нужно приложить усилия чтобы она начала там работать и приносить пользу по сути патроне это агентская служба который устанавливается на каждом сервере с базой данных и которая является своего рода и нет системой для вашего пузырь со она запускает под grease останавливает перезапускает меняет конфигурацию и меняет топологию вашего кластера соответственно чтобы хранить состоянии кластера его текущее представление как он выглядит этот кластер нужно какое-то хранилище и с этой точки зрения патроне пошел по пути хранения state а во внешней системе эта система распределенное хранилище конфигурации это может быть эти сиди консул музыки пир либо губернаторские кессиди какой-то из этих вариантов и одной из особенностью патроне является то что авто failover вы получаете из коробки только его настроив если взять например для сравнения реп mgr то патроне там идет в комплекте и файлов идет в комплекте мы получаем средства для свеча вера но если хотим of the flower нам нужно там поднастроить патроне уже есть of the fall over из коробки плюс есть много еще других вещей таких как обслуживание конфигурации наливка новых реплика резервное копирование и так далее но это как бы за скопом докладов про это я рассказывать не буду а и небольшой итог это то что основная задача патроне на мой взгляд это хорошо делать авто failover и надежно чтобы кластер у нас оставался работоспособным и приложение не замечала вот этих вот изменений в топологии кластером но когда мы начинаем использовать патроне наша система становится чуть сложнее если раньше у нас был под grease то при использовании патроне мы получаем сам патроне мы получаем dcs где хранится state и все это должно как-то работать поэтому что может сломаться ну может сломаться под gris это может быть мастера и реплика что-то из них может выйти из строя может сломаться сам патроне может сломаться dcs где хранится стоит и может сломаться сеть да вот все вот эти вот моменты я буду рассматривать в докладе и буду так или иначе все эти компоненты затрагивать 1 случае он самый простой я начал буду рассматривать случае по мере их так скажем усложнения не с точки зрения что это сложный кисть или там он затрагивает в новых компонентов это такое субъективное ощущение ощущение того что этот кейс сложно его было легко его было сложно разбирать о какой-то кейс был легкий его легко разбирать и 1 случае он самый простой это тот случай когда мы взяли кластер баз данных и на этом уже кластере развернули наше хранилище de ses это самая распространенная ошибка она не только связанные вообще с ошибками развертывания под грехе и патроне вообще ошибка построение архитектуры совмещать много разных компонентов на об в одном месте итак произошел failover мы идем разбираться что произошло мы как-то узнали о том что произошел failover вот и здесь нас интересует когда произошел failover да то есть нас интересует этот момент времени когда произошло изменение состояния кластер а вот но failover он не всегда одномоментно то есть он не занимает какую-то единицу времени он может затянуться он может быть продолжительным во времени поэтому у него есть время начала и время старта то есть это такое продолжительное продолжительное событие и мы делим все события на 3 интервала у нас есть время до файла вера во время файла вера и после файла вера то есть мы рассматриваем все события вот в этой такой временной шкале и первым делом когда произошел failover мы ищем причину что же произошло что стало причиной что именно послужило к файлу веру если мы посмотрим налоги то это будут классические такие патрон невские логе он в них нам сообщает что сервер за промо учился и роль мастера перешла на другой узел то есть тут довольно таки подсвечена все написано все в общем то понятно дальше нам нужно понять почему произошел failover какие произошли события которые заставили роль мастера переехать с одного узла на другой и в данном случае здесь все просто он с есть ошибка взаимодействие системой хранения то есть мастер понял что он не может работать здесь с какая-то возникла проблема с взаимодействием и он просто говорю что я не могу быть более мастером и я слагаю себя полномочия собственно вот эта строчка dimond от elf она говорит именно об этом а если посмотреть на события которые предшествовали файлы веру мы там как раз таки можем увидеть те самые причины которые послужили проблемой для файла вера ну проблемой для продолжения работы мастера да если посмотреть налоги патроне мы увидим что у нас есть масса всяких ошибок таймаутов то есть патроне агент он не может работать здесь с в данном случае это консул агент может 8 500 он не может с ним работать и проблема здесь заключается в том что под троне и база данных запущены на одном кости и на этом же узле были запущены консул сервера это было проблемой создав нагрузку на сервере мы создали проблемы и для сервера консулов и не смогли нормально общаться вот через какой-то момент когда нагрузка спала наш патроне смог снова общаться с агентами все возобновилась и тот же самый сервер pg db2 он снова стал мастером то есть был такой небольшой флип он сложил себя полномочия мастера потом снова их на себя взял всё вернулось как было вот и это можно расценивать как ложную сработку либо можно расценивать как патроне сделал все правильно то есть он понял что он не может поддерживать состояние кластера и он просто снял себя полномочия и здесь возникла проблема то что у нас консул сервера находится на тех же на том же оборудовании что и базы соответственно любая нагрузка будь это нагрузка на диске либо нагрузка на процессор а она также влияет на взаимодействие с кластером консула собственно мы решили просто что это не должно жить вместе мы выделили отдельный кластер для консула вот и он у нас с ним уже работал отдельно то есть был отдельно кластер базиса отдельно кластер консула это отдельная такая как бы базовая инструкция да как нужно все это все эти вещи разносите держать чтобы она не жилой вместе как вариант можно покрутить параметры tt или глупые 3 3 mode то есть как бы попытаться за счет увеличения этих параметров постараться пережить вот эти вот кратковременные пики нагрузки но это не самый подходящий вариант потому что вот эта нагрузка она может быть продолжительное по времени и мы просто выйдем за вот эти вот лимиты вот этих параметров и это может не совсем помощь вторая проблема то есть первая проблема как вы поняли она такая простая то есть мы взяли de ses положили вместе с базой получили проблему то есть она такая мужчин слов своих ног на ровном месте вторая проблема она похожа на первую и она похожа тем что у нас снова есть проблемы взаимодействия с системой dcs да мы посмотрим если налоги мы увидим что у нас снова ошибка коммуникации и патроне он говорит что я не могу взаимодействие здесь с поэтому текущей мастер уже не становится мастером он переходит в режиме реплики старый мастер становится репликой здесь патроне отрабатывает как и положено он запускает поговаривают чтобы отмотать журнал транзакций и потом подключиться к новому мастеру и уже догнать новый мастер тут патроне отрабатывает как ему и положено здесь мы должны найти то место но опять же я уже говорю это второй раз чтобы это запомнилось мы не должны найти то место которое предшествовало файла в руке ошибки которые послужили причиной почему нас failure произошел и в этом плане с патроне вский мелодиями довольно удобно работать он с определенным интервалом пишет одни и те же сообщения если мы начинаем наматывать эти лаги быстро мы просто пологом увидим что а логе поменялись значки то проблемы начались мы быстро возвращаемся на это место смотрим что происходит вот и в нормальной ситуации логе выглядят примерно в таком виде проверяется владелец блокировки вот если владелец допустим поменялся могут наступить какие-то события на которой патроне должен отреагировать вот но в данном случае как у нас все в порядке мы ищем то место когда начались ошибки вот и про матов до того места когда ошибки начали появляться мы видим что у нас начинается какое-то произошел of the flower да и раз у нас ошибки были связаны с взаимодействием здесь с и в нашем случае мы использовали консул мы заодно смотрим и в логе консула что происходило там примерно сопоставив время происхождения время файла вера да и время в консоли время влогах консулом и видим что у нас соседи по консул кластеру начали сомневаться в существовании других участников консул plaster а плюс если посмотреть налоги и других консулу агентов там тоже видно что там какой-то сетевой такой коллапс происходит и все соседи и все участники консул мастера сомневается в существовании друг друга соответственно и это послужило как раз таки толчком к файлу веру если еще посмотреть раньше что происходило до этих ошибок можно увидеть что есть всякие ошибки дедлайны рпц файл то есть явно какое-то какая-то проблема при взаимодействии участников консул глостера между собой самый простой ответ это наверное чинить сеть not не стая на трибуне легко как бы это заявлять обстоятельства могут сложиться так что не всегда как заказчик там клиент может позволить и чинить он может жить там зато центре и он не имеет возможности чинить свою сеть может не иметь возможности там как-то влиять на оборудование да и нужны какие-то другие варианты варианты есть самый простой вариант который написан по моему даже в документации это отключить консул проверки то есть просто передать пустой массив и мы говорим консул агенту не использовать никаких проверок за счет этих проверок мы как бы можем просто игнорировать это сетевые штормы и инициировать failover другой вариант это перепроверить ровд мультиплеера это параметр самого консул сервер по умолчанию он выставлен значение 5 это значение по документации рекомендуется как stay джин hawaii значение для station гав по сути это параметр влияет на скорость общения сообщениями между участниками консулу кластера и для production окружения рекомендуется уменьшать другой вариант который мы стали использовать это увеличение приоритета для планировщика процессов операционной системы то есть есть такой параметр найс он как раз таки определяет приоритет процессов мы просто взяли и консул агентом уменьшили приоритет чтобы операционная система давал этому процессору больше времени на работу и на исполнение своего кода это в общем случае решила нашу проблему другой вариант это не использовать консул у меня есть товарищ который очень большой сторонники эти сиде вот и мы с ним очень регулярно спорим что лучше иди сидели консул но вот в плане вот что лучше мы обычно с ним сходимся в ту мнение что у консула есть агент который должен быть запущен на каждом узле с базой данных то есть взаимодействие патроне с консул кластером идет через этот самый агент и вот этот вот агентом становится таким узким местом если с агентом что-то происходит то патроне не может уже работать с консул кластером и это является проблемой в плане эти сиди никакого агента нету под троне может напрямую работать со списком эти сети серверов и уже общаться с ними то есть в этом плане если вы используете у себя в компании эти сидит у эти сиди будет наверное лучшим выбором чем консул но мы у наших заказчиков как вы всегда ограничены именно тем что выбрал и используют у себя клиент и у нас по большей части консул у всех клиентов вот и последним пунктом это наверное пересмотреть значение параметров да то есть мы можем поднять эти параметры в большую сторону в надежде что наши кратковременные сетевые проблемы они просто будут ну короткими и не попадут за интервал от этих параметров то есть таким образом мы можем здесь уменьшить агрессивности патроне на выполнение авто failover если какие-то сетевой проблемы возникают третья проблема я думаю многие кто использует патроне они знакомы с этой команды то есть эта команда она показывает текущее состояние кластера и на первый взгляд эта картина может показаться нормальной у нас есть мастер у нас есть реплики логарифм акации никакого нету но эта картина нормально ровно до тех пор пока мы не знаем что в этом кластере должно быть три узла они 2 соответственно произошел of the flower и после этого авто фил озеро у нас реплика пропала нам нужно выяснить почему она пропала вернуть ее обратно восстановить да и мы снова идем в логе смотрим почему у нас произошел of the flower в данном случае произошел of the fall over 2 реплика стала мастером здесь все в порядке и нам нужно уже смотреть на реплику которая отвалилась и которая не в кластере мы открываем логе патроне и смотрим что у нас процессе подключения к кластеру возникла проблема на стадии по горе wine да то есть чтобы подключиться к кластеру нужно отмотать журнал транзакций запросить нужный журнал транзакций с мастера и по нему догнать мастера в данном случае у нас нету журнала транзакций и реплика не может запустится соответственно мы пузырь останавливаем с ошибкой и поэтому ее нету в кластере надо понять почему ее не иду в кластере почему не оказалось логов мы идем на новый мастер и смотрим что же там у него влоги оказывается во время когда делался по гарри войны произошел чекпоинт и часть старых журналов транзакций просто была переименована когда старый мастер попытался подключиться к новому мастеру и запросите логе они уже были переименованы их попросту не было я сравнивал таймс темпы когда происходили эти события и там разница буквально 150 миллисекунд то есть 369 миллисекунд завершился чекпоинт были переименованы вала сегменты и буквально в 517 спустя 150 миллисекунд запустился rewind на старые реплики буквально 150 миллисекунд нам хватило чтобы реплика не смогла подключиться и заработать какие есть варианты мы использовали изначально слоты репликации нам как бы это казалось очень хорошо хотя мы на первом этапе эксплуатации мы слоты отключали нам казалось что если слоты будут копить много вал сегментов мы можем уронить мастер он упадет мы помучились какое-то время без плотов поняли что нам слоты нужны мы вернули слоты вот но тут есть проблема что когда мастер переходит в реплику он удаляет слоты и вместе со слотами удаляет вал сегменты такой момент и чтобы нивелировать эту проблему мы решили поднять в параметр вал keep сегмент он по умолчанию 8 8 сегментов мы подняли до 1000 посмотрели только у нас свободного места в принципе 16 гигабайт нам как бы не жалко и мы эти 16 гигабайт и подарили на вал keep сидиус то есть при переключении у нас всегда на всех узлах есть запасы 16 гигабайтов журналов транзакций плюс это еще актуальны и для продолжительных ментона задач допустим нам нужно обновить одно из реплик мы хотим ее выключить нам нужно обновить там софт может быть операционную систему еще что то когда мы выключаем реплику для этой реплики также удаляются слот если мы используем маленькие валки psy gangsta при поднятии при продолжительном отсутствие реплики журнала транзакций про играются мы поднимем реплику она запросит те журнала транзакций где она остановилась на мастере их может не оказаться и реплика тоже не сможет подключиться поэтому мы держим большой запас журналов четвертое проблем у нас есть production база уже работают там проекты все работает произошел failover мы зашли посмотрели все в порядке реплики на месте логоритмика ции нет ошибок по журналам тоже все в порядке , команда говорит что вроде как должны быть какие-то данные но мы их по одному источнику видим а в базе от мы их не видим и надо понять что с ними произошло мы ну понятно что это поговаривают их затер короче мы как бы сразу это поняли но пошли смотреть что происходило у нас и влогах мы всегда можем найти когда произошел failover кто кто стал мастером и можем определить то был там репликой кто был старым мастерам и когда он захотел стать репликой то есть нам нужны вот эти логе чтобы выяснить то расстояние журналов транзакций но тот объем журналов транзакций который был потерян наш старый мастер он перезагрузился и в автозапуске был прописан патроне запустился патроне он следом запустил под grease под grease решил стать участником патроне кластер а и запустил процесс по горе wine до соответственно он стерся из журналов транзакций скачал новое и подключился то есть здесь патроне отработал шикарно хорошо как задумано так и положено кластер у нас остановился у нас было три ноты после flower а у нас три ноты все круто вот но как бы мы потеряли часть данных нам нужно понять сколько мы потеряли мы ищем как раз-таки тот момент когда у нас происходило rewind мы можем найти это вот таким записям журнале запустился rewind что-то там сделал и завершился нам нужно найти ту позицию журнале транзакций на которой становился старый мастер да и нам нужно вот это в данном случае это вот это вот отметка и нам нужно 2 отметка то есть то расстояние на которое отличается старый мастер от нового вот мы берем в обычный поговорил с n div такую функцию и сравниваем эти две отметки и в данном случае он получаем 17 мегабайт много это или мало тут каждый для себя решает сам потому что для кого-то 17 мегабайт это немного для кого-то это много и недопустимо на то есть тут уже каждый для себя индивидуально определяет соответствие с потребностями бизнеса вот но что мы выяснили для себя во первых мы для себя должны решить всегда ли нам нужен автозапуск патроне после перезагрузки системы иногда даже наверное не иногда чаще бывают так что мы должны зайти на систему на старый мастер посмотреть как далеко он уехал возможно по инспектировать сегменты журнала транзакций посмотреть что там вот и понять можем ли мы эти данные потерять либо нам нужно как-то в standalone режиме запустить старый мастер чтобы вытащить эти данные и только уже после этого должны принять решение что мы до можем эти данные отбросить либо мы можем их восстановить подключить уже вот этот узел в качестве реплики в наш кластер помимо этого есть параметр максимум логан failover по умолчанию если мне не изменяет память это параметр имеет значение 1 мегабайт по сути как он работает если наша реплика отстает на 1 мегабайт данных полагаю репликации то эта реплика просто не принимает участие в выборах до и если вдруг происходит failover мыс патроне смотрит какие реплики отстают если они отстают на большое количество la журналов транзакций они просто но не могут стать мастером то есть это очень хорошая такая защитная функция которая позволяет не про долбать очень много данных но тут есть проблема что вот лак репликации в кластере в патроне в de ses он обновляется с определенным интервалом если мне не изменяет память это по моим 30 секунд значение эту цель по умолчанию вот соответственно может быть ситуация когда лак репликации для реплик в disease 1 а на самом деле может быть совершенно другой лак или вообще лога может не быть весь этот штука не real time ago и она не всегда отражает как бы реальную картину и закладываться на нее как бы ну очень сильно делать на ней какую-то на ворочал логику не стоит вот и риск потерявших всегда остается и в худшем случае одна формула в среднем случае другая формула то есть мы когда планируем там внедрение патроне и оцениваем сколько данных мы можем потерять мы в принципе должны закладываться на эти формулы примерно представлять сколько данных мы можем потерять плюс есть и хорошая новость когда старый мастер там уехал вперед да вот он может уехать вперёд за счет каких-то фоновых процессов то есть какой-то был of the vacuum он написал данные сохранил их журнал транзакций ну и понятно что эти данные мы можем запросто игнорировать и потерять в этом нет никакой проблемы вот и вот так вот выглядят логе в случае если выставлен максимум lagoon failover и произошел произошел failover и нужно выбрать нового мастера реплика просто видит что она not heal все и она как бы отказывается от участия в гонке за лидера ну и соответственно нас ждет когда будет выбран новый мастер чтобы потом уже к нему подключиться то есть это такая дополнительная мера от потери данных пятое проблема здесь у нас была такая проблема у нас продуктовая команда написала что они испытывают проблемы с при работе с ну их продукт испытать проблем при работе с после сам перед при этом на сам мастер нельзя зайти потому что он недоступен по ssh никак нельзя попасть на него при этом of the flower тоже не происходит этот хвост отправили принудительная в перезагрузку из-за перезагрузки стри делился of the failure хотя можно сделать был и ручной failover в то время вот как я сейчас понимаю вот а после перезагрузки мы уже идем смотреть что у нас было с текущим мастером при этом мы заранее знали что у нас проблемы были с дисками то есть мы уже по мониторингу же знали где копать что искать мы залезли в подрисовок начали смотреть что там происходит мы увидели коммиты которые длятся там по 1 2 3 секунды что это вообще не нормально мы увидели что у нас of the vacuum запускается как-то ну очень долго и очень странно плюс мы увидели временные файлы на диске ну то есть это все как бы показатели проблем с дисками мы заглянули в системный до мест лог ядерных сообщений и увидели что у нас есть проблемы с одним из дисков дисковая подсистема на сервере представляла собой софтверный рейд мы посмотрели проком до статуи увидели что у нас не хватает одного диска то есть тут рейд из 8 дисков у нас одного не хватает если почитать список вот этот вот первой строке то мы увидим что у нас там с да и отсутствует у нас условно говоря просто выпал диск да это стри guerrilla дисковые проблемы и приложение тоже испытали проблем при работе с кластером после со вот и в данном случае патроне бы нам никак не помог потому что у патроне нет задачи отслеживать там состояние сервера состояния дисков здесь патроне как бы нам не помог и мы должны такие ситуация связывать каким-то внешним мониторингом мы внешне мониторинг добавили мониторинг дисков оперативно да и была такая мысль замок были бы нам помочь fencing либо software док вот и мы подумали что вряд ли бы он нам помог в этом случае вот потому что во время проблем патроне продолжал взаимодействовать с кластером de ses и как бы не видел никакой проблемы то есть с точки зрения с точки зрения одессе с и патроне с кластером все было хорошо хотя по факту были проблемы с диском и были проблемы с доступностью базы 6 проблема на мой взгляд это одна из самых странных проблем которые я следовал очень долго да очень много лагов перечитал перри ковырял вот и назвал ее кластер симулянт проблема заключалась в том что старый мастер не мог стать нормальной репликой то есть патроне его запускал патроне показывал что этот узел присутствует как реплика но в то же время он не был нормальной реплика сейчас вы видите почему и вот весит разбор я делал согласно паспортом у которой у меня сохранился там с разбора с той проблемы вот и с чего все началось началось опять же как и в предыдущей проблем все началось дисковых тормозов у нас были коммиты по секунде по 2 были обрывы соединений то есть клиенты рвались были самые разные блокировки разной степени тяжести c-tick кто узнает запрос это это это zabbix это вот zabbix у нас под патроне у клиентам вот и соответственно очень какие-то проблемы дисками дисковой подсистемы очень отзывчивая вот и самое загадочное для меня это прилетевший и медиа туда он request кто знакомств пузырь сон после есть три режима выключения и the grace of all когда мы ждем когда все клиенты отключаться самостоятельно есть фаст когда мы говорим клиентам отключаетесь потому что мы идем на выключение и имеет вот в данном случае me dit он не сообщает клиентам что нужно отключится он просто выключает а всем клиентам отправляет сообщение типа рст tcp сигнал типа все как бы соединение природа и вам нечего ловить кто послал этот и миди оттуда он то есть под grease фоновые процессы после со друг другу такие сигнал они посылают то есть и такие у -9 это secu signal они друг другу такое не шлют они на такое только реагирует то есть это экстренный такой перезапуск после со кто его послал я не знаю я посмотрел по команде last я увидел одного человека там кто-то же был залогинен а это сервис вместе с нами но я постеснялся секрет задавать вопрос вот но наверное скрасить возможно это был kill -9 но я бы влогах will kill -9 postgres пишет что он принял kill -9 но я не увидел этих логов так вот ковыряя дальше я увидел что патроне не писал в лоб довольно долго 54 секунды то есть если сравнить два таймс темпа тут примерно 54 секунды ну там миллисекунды начинаем то есть не было просто сообщений да и за это время произошел авто failover то есть патроне здесь снова отработал прекрасно у нас старый мастер был недоступен что-то с ним происходило и начались выборы нового мастера здесь все от работалось хорошо у нас пгс quelle 01 стал новым лидером и 2 реплика то есть у нас есть старый мастер у нас есть реплика которая стала мастером есть вот вторая реплика вот со второй ремни как раз таки были проблемы она пыталась перри конфигурировать то есть как я понимаю она пыталась поменять recovery konce перезапустить адрес подключиться к новому мастеру то есть вот она каждые пять секунд пишет сообщение что каждые 10 секунд пишет сообщение что я пытаюсь но чуть-чуть не могу вот и во время этих попыток на старый мастер прилетает от этой миди от сигнала вот и мастер перезапускается и также recovery также прекращается потому что старый мастер уходит в перезагрузку то есть реплика не может к нему подключиться потому что он уходит в перезагрузку он выключается в режиме выключения вот но в какой-то момент она заработала но репликация при этом не запустилась вот у меня здесь единственная гипотеза что в рекавери конф был адрес старого мастера и получился новый мастер но 2 реплика она пыталась подключиться к старому мастеру вот и патроне когда запустился на 2 реплики узел запустился но он не мог подключиться в по rip ли кации и образовался лак рипли кации выглядел это примерно так то есть все три узла были на месте но второй узел узел отставал при этом если посмотреть на логе которые писались можно было видеть что репликация не может запустится потому что журналы транзакций отличаются и те журнала транзакций которые предлагает мастер который указан в рекавери конф они просто не подходят нашему текущим узлом вот и здесь я допустил ошибку то есть не надо было прийти посмотреть что там в рекавери ком чтобы проверить свою гипотезу что мы подключаемся не к тому мастеру но я тогда как бы только только разбирался с этим мета в голову не пришло либо я увидел что реплика отстает и и наверное придется перри наливать ну как то так я спустя рукава отработал добыла майк мой такой косяк вот через 30 минут уже пришел админ то есть я перезапустил патроне на реплики но как бы я уже на ней крест поставил честно говоря я думал что и придется перед давать вот такой дома перезапущу патроне может у sony получится хорошая запустился recovery база даже открылась она была готова принимать соединение репликация запустилась но через минут она отвалилась с ошибкой что ей не подходит журнала транзакций вот я думаю ну еще раз перезапущу такой папина и по колесу постучи по дворником такой подход вот я перезапустил еще раз патроне причем я не криза пускал пузыри перезаписал и на патроне в надежде что он там как-нибудь магически там запустит базовый вот этих ли catia снова запустилась но отметки в желая транзакции отличались они были не те которые были в предыдущей за предыдущие попытки запуска репликация снова остановилась и сообщением было уже ну чуть-чуть другое но как бы оно все равно для меня на такое было не особо информативное и тут мне приходит в голову а что если я запущу патроне но за перезапущу адрес в это время на текущий мастере сделаю check point чтобы подвинуть . уже знали транзакций чуть вперед чтобы recovery началось другого момента плюс там еще были запас его love же у нас я думаю вдруг поможет вот я перезапустил патроне сделал в поручик поинтов на мастере сделал пару restart поинтов на реплики когда оно открылось и да это помогло я долго думал почему это помогло вот ну как бы это сработало и реплика у меня в общем то запустилось и & replication больше не рвалась вот такая проблема на для меня одна из наиболее загадочных для когда которых я до сих пор как бы ломаю голову что там происходило на самом деле так вот какие выводы здесь да можно сделать патроне может отработать да и он может работать как задумано без всяких ошибок но при этом это не стопроцентная гарантия что у нас все хорошо то есть реплика может запуститься но она находится у нас в полу рабочем состоянии мы не можем с ней но не можем на нее отправить приложение потому что там будут старые данные и после файлу игры всегда нужно проверять что у нас все в порядке с кластером нужно количество реплик нету логарифме кации вот и на этом все и вот по ходу рассмотрении этих проблем я попытаюсь ну взять вот ты home с 3g с которой вы должны там взять с собой типа чтобы вынести пользуюсь доклада я пытался их объединить два слайда наверное вот эти все истории можно было уместить в два слайда и наверное только их рассказать когда вы используете у себя патроне у вас обязательно должен быть мониторинг вы всегда должны знать когда произошел авто failover потому что если вы не знаете что вас там произошел of the flower вы не контролируете кластер и как бы ну это плохо после каждого файла эра мы всегда должны зайти руками проверить что у нас действительно 0 его нас в мониторинге должно быть настроена мы должны всегда убедиться что у нас всегда актуальное количество реплик что нету лагере клика ции что влоги нету ошибок связанных вот с потоковой репликации с патроне с системой de ses потому что автоматика может успешно отработать до патроне очень хорош хороший инструмент он может отработать но это не приведет кластер к нужному состояние и если мы об этом не узнаем это ну для нас будет чего-то проблемами плюс патроне не серебряная пуля мы все равно должны иметь представление о том как работает пузырь в том как работает репликация о том как пожгли скандалит работу с после самые как он обеспечивает взаимодействие узлов это нам нужно для того чтобы уметь чинить руками какие-то возникающие проблемы про диагностику как как как я подхожу к вопросу диагностики так сложилось что мы работаем с разными клиентами из т.к. елки ни у кого нету и приходится в логах ковыряться вот открыв 6 консолей ну две вкладки 6 консоли у меня обычно в одной вкладки этологии патроне для каждого там узла в другой вкладке это логе там консула либо под гриссом при необходимости то есть диагностировать все это очень тяжело вот какие выработал подходы во-первых я всегда смотрю когда произошел failover и для меня это как бы такой некий водораздел я смотрю что произошло до файла вера во время файла вера и после файл озера на то есть у хиллари есть две две отметки это время начала и время конца далее я в логах смотрю время ну событие дал файлов то есть что предшествовало файла и руда то есть я ищу причины почему нос 3 делился failover то есть это дает уже как бы картину понимания что происходило и что мы можем сделать в будущем чтобы failover там при таких же обстоятельствах не происходил и куда мы смотрим обычно я смотрю куда я смотрю в логе патроне то есть это первым делом я лезу да дальше я смотрю либо логе после стали балоги de ses в зависимости от того что там в блогах патроне накопалось ну и логе системы тоже иногда дают понимание того что послужило причиной для flower а вот и небольшое послесловие как я отношусь к патронник патрон отношусь очень хорошо на мой взгляд это лучшее что есть сегодня я знаю много других продуктов это стол он и то есть репом грпб of the file a verb of 4 инструмента я пробовал все патроне не понравился больше всего если меня спросят рекомендую ли я патроне я определенно скажу да потому что патроне мне нравится я как мне кажется научился его готовить вот если вам интересно посмотрите какие еще бывают проблемы с патроне за скопом вот этих проблем которые я озвучил вы всегда можете сходить на страницу из на гитхабе там очень много разных историй несмотря на то что половина из них это неграмотные индусы которые задают глупые вопросы но там очень много интересных проблем рассмотрено обсуждено и по итогу и какие-то баги были заведены решены то есть это очень интересное чтиво там есть интересные истории как люди стрелять и в ногу вот очень познавательно ты читаешь такой как бы понимаю что так делать не надо поставил все галочку вот и хотелось бы сказать большое спасибо компании за лан за то что они хотят и как он трибьют проект александр кукушкин который вот сидит здесь зале вот алексей клюкин который один из соавторов сейчас zalando уже не работает вот но они два человека которые начинали работу над этим продуктом то что не формуле governor мы оставим за кадром вот но governor нынче мертв патроне жив вот я считаю что патроне это очень крутая штука и я прям довольно что она есть с ней интересно ну и большое спасибо всем контрибьютором которые пишут пачек в патроне я надеюсь что патрон не будет с возрастом становится более зрелым крутым и работоспособным он так работоспособен но я надеюсь что он пытается еще лучше поэтому если вы планируете использовать себя патроне не бойтесь это хорошее решение можно его внедрять использовать этом все если у вас есть вопросы задавайте вот во время этого доклада мне было реально страшно я даже пролил на себя воду почему я научился у алексея что профессионал сюда может продолжить выбросить вот этот в отдельный сборник мусора и и работать дальше спасибо тебе огромное у нас есть для тебя диплом за то что ты к нам пришел и поделился этим мне кажется что вот это вот татуха на запястье помогает быть профессионалом где ее можно заполучить татуха временная не настоящая можно заполучить на стенде дата игры в зале недалеко от водопада где-то буковки hell вот там наша наша будка стенд там хорошие девочки технически подкованные даже они отвечают авто failover от свича вера вот поэтому к ним можно подойти и попросить татуировка если у вас есть иконостас ты можешь туда поставить эту благодарность а поскольку ты любишь путешествовать тебе может быть пригодится наса сектор большой спицы я вижу уже много рук давайте начнем задавать вопросы 1 рука была вот здесь спасибо за доклад ну вот такой вопрос все-таки если после файлов все равно надо туда смотреть очень внимательно то зачем нам автоматический файловик то зачем смысл до того что это новая штука мы работаем с ней всего лишь год мы как бы лучше перебдеть чем недобдеть мы хотим зайти посмотреть что действительно все работало как надо то есть это но такой уровень как бы ну взрослого недоверия типа позже перепроверить и посмотреть то понятно что тебе паре человеком и утром зашли там и посмотреть не утром и обычно узнаем above to feel very практически сразу у нас уведомление приходят мы как бы видим что произошел of the flower мы практически сразу заходим смотрим вот но все эти проверки не должны быть вынесены на уровень мониторинга вот в патроне если обращаться по нему пар из т.п. есть так называемые history по history можно смотреть временные отметки когда происходил failover то есть на основе этого может сделать мониторинг можно смотреть history сколько там событий если у нас прибавилось события значит произошел autochel.ru можно сказать посмотреть либо у нас наша автоматика в мониторинге проверила что у нас все реплики на месте влага нет а вертов никаких не зажглось на щите хорошо вот примерно так как сессии вопрос на верхнем ряду справа от тебя большое спасибо за отличный рассказ у меня такой вопрос есть мы вынесли кластер исчез куда-то вдаль от кластера по сгрыз этот кластер тоже надо обслуживать периодически горах какие best practice вот в том что какие-то куски кластеры cs надо выключать потому что то с ним делать и так далее как при этом живет цвета конструкции и каким образом эти вещи делать а ну смотрите я делал для одной компании нужно было такую матрицу сделать матрицу проблем что происходит если ломаться китай вниз из одних компонентов если мы обслуживаем отдельно de ses консул или кессиди то вообще на этих продуктах делается сервис discovery во многих компаниях и она как бы ведет уже ну не знаю стандарт инфраструктуры она у многих есть вот и админ он это как-то администрирует уже как бы полагаемся на 2 naw которые стирают если нет то мы развертываем до disease но как бы особо за ними следим потому что мы не отвечаем за интер культуру правильно ли я понял что надо отключить патроне отключить failover отключить все перед тем как заниматься делать что иметь поставим на которых же вернется вот слайд и у нас узлов в diseases кластере если мы выводим из строя одного из узлов тона скором сохраняется и патроне он остается ну мы работоспособен и ничего не 3 делиться если у вас какие-то сложные операции которые затрагивают больше узлов и которые могут входить в корм то да возможно имеет смысл поставить патроне на паузу у него есть соответствующие команды патроне котел пауза патронника тела резюме мы просто ставим на паузу и of the flower не срабатывает в это время мы делаем какой то maintenance на десерт кластере потом снимаем паузу и продолжаем жить спасибо большое буквально очень простой еще второй вопрос если мне позволят не очень позволит у нас времени мало следующий вопрос вот с первого ряда игорь игорь ты можешь подойти к нам на стенд и я попрошу еще алексеев потом вот на выходе лизал около флипчарт стать поговорить софи позади большое спасибо за доклад о конкурсе руку где это я спасибо за доклад вопрос такое а как еще продуктовый команда относится к тому что данные могут потеряться то есть там гигабайтом это просто я вот само приложение разрабатывал автобус командам пофиг а вот тим лиды волнуются тим лиды продуктовая команда как бы новый пишем код мы выкатываем а там грамм of the failure произошел она мне нужно конфиге там приложение метила щи круто они довольны вот тимлид волнуются о том какие гарантии вы еще можете чуть как раскрытие служите с гарантиями очень тяжело есть доклад у александра кукушки как рассчитывать р п о р т а время восстановления и ну сколько можем данных потерять я думаю нужно найти эти слайды их изучить там есть в принципе насколько я помню там есть вполне конкретные шаги как рассчитывать вот эти вот вещи сколько транзакции мы можем потерять сколько данных мы можем потерять вот как вариант можно использовать синхронную репликацию на уровне патроне вот но это опять же палка 2 как два стула всем известных мы либо имеем надежность данных либо теряем скорость то есть да но синхронная репликация есть вот но она опять же тоже не гарантирует 100 процентно защита от потери данных мир как бы не идеален у нас осталось время на два вопроса следующий на верхнем ряду резко вправо алексей спасибо за прекрасный the club я хотела спросить вот если опыт использования в части вот вопросов powerpivot вообще использовали патроне для oзеру level protection да то есть но вкупе с синхронным с комбо и вот это первый после второй вы использовали разные решения мы используем гриппом gr но без of the flower сейчас планируем как раз и занимаются подключать of flower и патроне рассмотрим как альтернативное решение с рипом горда что можете сказать вот в качестве плюсов именно сравни с рипом grd осмотрите 1 первый вопрос про про синхронный реплики да я так понял у нас никто синхронную репликацию они используют потому что всем страшно вот нам и для себя выработали такое best practice что в классе или синхронная репликация должно быть три узла минимум вот потому что если у нас два узла если мастер или реплика вышли из строя то патроне переводит этот узел в standalone режим чтобы приложение продолжала работать в этом случае есть риски потери данных вот относительно второго вопроса мы использовали rib.png rip ангар до сих пор используем у некоторых клиентов по историческим причинам вот что можно сказать в патроне авто failover из коробки в репом г of the flower идет уже как дополнительная фича которую нужно включить нужно запустить гриппом города демоны на каждом узле и тогда мы можем of the flowers настроить реп mgr хранит состоянии кластер а ну как он просто проверять живые или узлы ip-адреса на то есть он друг друга там чекает это не очень не очень эффективный подход вот самопроверки и проверки что кластер живой вот и вы нас стэйта кластеров de ses вот как делает стол он как делает патроне это такие наиболее живо способны что ли варианты друзья у нас осталось время на один вопрос он там следующий вопрос вы сможете вот алексею я буду вот алексей у меня такой вопрос немножечко может быть ламерский конечно вот вы в одном из первых примеров de ses вынесли с локальной машины на удаленный узел но понимаем что сеть вещь достаточно такая она имеет свои особенности она сама в себе живет и что произойдет если допустим по какой-то причине 10 класс стр стал недоступен то есть причина говорить не буду тут может быть масса от кривых рук сетевиков до каких-то реальных проблем но вот вот такой вот момент я не проговорил это вслух но кластер de ses должен быть также отказывал стой чем то есть это нечётное количество узлов чтобы кора мог собраться что происходит если кластер de ses стал как-то недоступен либо не может собраться корм но какой-то сетевой сплит да в этом случае кластер патроне переходит в readonly режим вот это как бы хорошее ну то есть мы не можем определить он кластер патроне не может определить состояние кластер и и что ему делать да он не может связаться в de ses и сохранить то много и обновленное состоянии кластер поэтому весь кластер переходит в редон ли и ждет ручного вмешательства от оператора но группа ручное переключение сделать либо дождаться когда 10-е становится ну грубо говоря disease для нас становится сервисом нас настолько же важным как и сама база да да да но я еще раз говорю в многих компаниях особенно в современных которые следуют там современные методологии разработки там два фактора п.п. сервис discovery это неотъемлемая часть инфраструктуры то есть но внедряется даже раньше чем появилась база данных в инфраструктуре то есть мы запустились там развернулись там тира форму где-то дата-центре а у нас уже сразу сервис discovery есть если таком султана ним dns может быть построен если это эти сидит у это там может быть часть кубер нетесова кластера которым уже все остальное будет разворачиваться то есть я ну мне кажется что сервис discovery она как бы уже неотъемлемая часть инфраструктуры о нем думают гораздо раньше чем о базах данных спасибо друзья сожалею я видел еще три руки что я не могу вам дать слово потому что время нашего доклада закончилась внутри наверное вспомнишь забросит вопрос да да мне понравился вопрос про синхронную репликацию где то вот эта часть и зал выходе автор плат рода репликация к нам расскажи как тебя звать где ты работаешь в микрофон конечно life компания рту labs александр алаев компания vertu labs спасибо небольшой небольшие презенты от компании аль antico я тоже конференциях и лот рада вас видеть надеемся на других конференциях эту книжку я сама хочу себе хочется лесам ну договорились это его теперь книжка вот это ваш подарок даже является я надеюсь вы откроете свой стартап он станет успешным и решите какую-нибудь проблему с которой столкнулся мир и до сих пор не решил спасибо за мага всего доброго до"
}