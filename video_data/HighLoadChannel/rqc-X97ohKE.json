{
  "video_id": "rqc-X97ohKE",
  "channel": "HighLoadChannel",
  "title": "Правильный staging для баз данных Postgres / Николай Самохвалов",
  "views": 795,
  "duration": 3390,
  "published": "2019-05-14T14:48:18-07:00",
  "text": "придется немножко очень коротко немножко повторить тезисно то есть о чем речь от что а сейчас такая ситуация что очень много всего классного сделано для того чтобы не тестировать интерфейсы руками будь то это графический там и пеев интерфейс или каким-то мку онлайн интерфейсом и все тестируем автоматически у нас есть соседи pipeline и очень много классных инструментов все это уже там больше чем 10 лет развивается и ни одна не один новый проект естественно не будет стартовать не имея так не рассматривая автоматические тесты но когда речь идет про базы данных стандартной сложность что нас ты дженги мы там либо не имеем столько же данных либо мы отставать начинаем носит вечная боль плюс еще бор клод нам собрать правильные и так далее в интерфейс секторе есть например что они не надо и дал мне такой спасибо в enterprise секторе допустим у оракла есть дтп с реплей relocation testing a и средства для того чтобы делать стенды приближенных к боевым и смотреть что с базой происходит так с помощью лупы у нас пока в open source и такого ничего нет то есть мы очень много делаем вручную и если кто пользуюсь использует прекрасно знают эту проблему когда мы опять же состоит нас нашли тормознутый запрос то мы просто так не можем его быстро проверить потому что у нас ряд проблем у 50 стать это встроено решив встроенная штука в плоскости которая собирает статистику по запросам агрегирует это не просто и параметры и вот этого бросание параметров она сама одна из проблем потому что мы нашли тормозной запрос но чтобы пойти и написать эксплей нам нужно что-то поставить вместо знаков вопроса вместо параметров а мы этого уже не знаем и и параметры влияют на план то есть один и одна и та же группа в подъезд экман банальный пример с звездочка фронте был в колонка равно что-то может давать как яндекс контакте секс к понятно да то есть если строчка ожидается мало будет индекс к если ожидаем что мы почти все таблицы должны просканировать пользуюсь не будет выбирать индекс can он бы ты брать секс к и поэтому параметр нам нужны чтобы знать о чем мы имели дело чтобы найти культ плохой случай и его дальше уже оптимизировать они оптимизировать хороший случай вот это проблема который сейчас есть она будет решаться там есть патче которые будут улучшать мы нам хочется уже сейчас что-то делать правильно вот и по сути очень много личных вещей и вот для того чтобы лучше слышать позволительно нам нужно либо ты ведь конфигурацию либо менять индексы либо менять сами запросы или даже схему либо просто наращивать ресурсы но даже банальный пример на очень ресурсов которые по идее не так что сложно делается она включает в себя много все в частности деньги может включать и прежде чем понять сколько мы получим нам нужно поставить эксперименты без экспериментов в это будет какой-то слепой шаг вообще я не ждал что будет такой формат в прошлый раз у меня был метод мы сидели это кругленьким столом и общались от а тут получается презентация то есть я вообще так вот к этому формату есть они вообще не готов то есть я думаю сейчас сядем и так потрендим поэтому пожалуйста давайте вы может быть будете тоже как-то участвовать какие то вопросы задавать вам с ходу нет пока вопрос да микрофон можно вот какой-то формат мне не очень понятно нам микрофон теперь да вот туда пожалуйста микрофон дать для сбора нагрузки что вообще лучше использую это уже забегаю вперед сейчас сделать все сделаем все все объясним классно да ну то есть я просто вчерашний доклад немножко повторяю по быстрому тюнить конфигурацию сложно почти 300 параметров плоскостью масик или уже больше 500 индексов у нас целый зоопарк соответственно когда мы добавляем индекс нам на запрос вот там сейчас быстро пробегу пример был что мы добавили нет 10 пример не только если мы добавляем индекс мы ускоряем какой-то запрос классном руками проверю этот запрос explay нам он ускорился кто-нибудь проверял другие запросы потому что есть ситуация когда они замедляются мы теряем had апдейт опустим если мы индекс решились сделать пошел уменьшили их размеры select и ускорились некоторые модификации тоже ускорились но в основном за отдайте insert и замедлились потому что они раньше они не требовали модификации индексов возле себя теперь стали все вообще ноль охота байтов в общем это такое один из примеров когда который год что надо в целом смотреть надо взять какой-то вор класс genitive мы сейчас поговорим как и покажу и и дальше гонять это все вот и дальше я рассказывал вчера про то что здесь а ну вот дефолта сектор гид очень классный пример типичная история что у нас он по умолчанию 100 то есть для каждой колонке подписи есть 100 пакетов статистики да но допустим таблица уже миллиард записи там очень много разных значений хочется более подробную статистику и мы в статье прочитали и таких статьи полно что вот можно тысячи поставить круто но обычно это идет продакшен более продвинутые ebay смотрит как замедлился of the vacuum в частности и аналог часть насколько стал медленнее ну а запросы обычно никто не смотрит то есть считается что это классно иметь больше статистики и вот есть пример таджин индекс был и в целом у нас вот слева 100 проката прогон вот эксперимент как раз инструмент который час буду показывать он сделал прогон на нагрузку мы собрали с помощью логов там это было можно с полных логов и с помощью инструмента пиджи реплей мой вот этот наш инструмент он глуп все в коробке там пиджейпай встроенный он проигрывает эту нагрузку на на базе два раза то есть он в один раз был дефолт стасик таргет 100 другой 1000 и в целом все улучшилась на 8 процентов классно то есть вот 2200 запросов поиграли улучшилась все хорошо но если про стоит вниз а у нас там идут уже сравнение по каждой группе из пиджей состоит нас точнее спи джинджер ну по каждой группе запросов то вот 4 поттер по вкладу в нагрузку группа она замедлилось на 88 процентов это там был джон индекса и почему-то для него ст 1000 bucket of стало хуже и вот почему мы вот можно не думать в данной ситуации я показываю как можно не думать вообще увидели откатили только для этой колонке с помощью alt и ball z статистика обратно 100 и опять стало также то есть мы про патч или наше общее решение на конкретном участке чтобы там хуже не делать потому что принцип оптимизации мы что-то должны улучшать но хотя бы не ухудшая ничего потому что если что-то ухудшается тоже плохая оптимизация если это что-то серьезное а здесь 4 на 4 по вкладу в total time запросу это понятно в целом то что очень рассказываю вроде простые вещи хорошо или нет вопрос и вот про эту часть нету хорошо но я рассказывал про то что у нас себя сиди там все автоматизировано что в других отраслях вот есть ради мимическая труба что там тоже берется какая-то какой-то копия объекта и моделируется нагрузка и главные фишки которые вот как раз мы и стараемся для подвеса сделать это то что мы делаем специальную лабораторию и причем мы желательно не одну а много по запросу это вообще идеальный случай что что кому-то надо мы ее развернем с нулевыми ручными усилиями практически там есть спецсредства которые мы не будем production фигачить потому что если мы хотим of the extent чтобы планы влогах видеть в продакшн это нельзя включать обычно то что-то слишком сильно увеличивает количество лагов и большой стресс и высокий уровень автоматизации то есть нам ничего не стоит провести эксперимент я прям сейчас будут показывать вот демонстрация красота кажется надо к теме пришлось повторить им вчерашние материалы но в общем и толпа насосный инструмент oh come on line интерфейс только имеет гуй у нас пока не open source но вы можете скачать его сейчас покажу насколько это просто вот я еще крупнее сделаю установить от всего две строчки это просто на самом деле набор баш скриптов которые оркестре руют всякие другие похожие инструменты называется нэнси и можно посмотреть халк есть несколько команд мы сейчас будем пользоваться главный ран у нее тоже есть help свой и он большой потому что там много всяких параметров но возвращаясь к презентация параметров нужно всего четыре знать главных ну то есть концептуально нам нужно определить четыре вещи где мы будем запускать что то есть какую базу мы будем проверять и какую нагрузку до и четвертый параметр у всех есть нюансы да и четвертый параметр что-то поменять хотим например шанс boffins мы хотим 10 вариантов значения проверить вот четыре вещи мы должны задать на выходе будут штучки которые сейчас похоже уже буду показывать вот и вот в общем есть эти параметры всякие допустим простой самый пример мы сейчас зададим базу с помощью дампа причем можно онлайн просто сказать crate tы ебал т1 с select from generate series давайте допустим миллион строчек на генерим просто да и вот целом все то есть я сейчас запущу он скажет что тревор клода не хватает вот понятно ли как я сейчас здесь задаю базу я издаю самым простым способом логический дам причем онлайн опишу его клеить ты его вот этот понятно да если вопросы лучше задать руку понять а вот можно микрофон опять нас у нас митап поэтому будет все время так не не в конце таки вижу у вас тут тесто у меня зовут nickel и так вижу тесная интеграция с есть возможно ли поднять дамп сразу из бинарного дом по яма из того зря не зажата бинарные да ну там прямо из того snapshot агара делается автоматически когда дались backup который должность да возможно я покажу час эту опцию тоже да можно причем уже использовать которые уже развернутое что времени тратить такой тоже есть я покажу ну кстати в этом правда управление моему будем еще развивать потому что хочется иметь вот у кого-то бармену кого-то во львове вал джип джип и крест их сзади из них тоже можно взять из бэкапа сделать базу вот пока ну то есть у нас такое состояние вы пришли на новое поле там вообще просто непаханое вот и поддержку разных систем бэкапов классно бы иметь но мы пока очень-очень занята другими штуками но будем это скорее всего это будем однако заказчиков отталкиваться у нас нет компании тому разные backup системы вот значит workload зададим опять ручками самый простой вариант я просто с банального варианта начинаю самый банальный вариант это каста москве соответственно давайте просто поищем в этой таблице все строчки у которых ой от десяти до двадцати все больше но на самом деле ничего не надо все пошло то есть поднимается докер-контейнер там по газ с кучей расширений для того чтобы все собрать вот он понял что у нас 4 процессор atom 8 гигов памяти я половину только на ноутбуке дал это я все ноутбуки запускают диски не rotational то есть это на самом деле там сейчас вот я не указывал на пол я сейчас будет брать братцы дефолта вай конфиг но там есть опция сгинуть автоматически типа бюджету на дать ему там побольше на шайба фирс диск из мира тишина сделать range cost равно 1 тоже значит рандомный у нас дешево обходится и она вот он сейчас это finger of пытается установить на понятно значит вот он сейчас делает восстанавливается из дампа генерит миллион строк какой то время займет обычно он быстро этого было до вставим графом у него на маке именно в этой with a virtual key здесь не вышло так я сейчас чтобы вам а думаем да мы ж на это был лес тоже посмотрим зря я наверное миллион строчек решил делать да вот 44 секунды занял оно было 100000 все тайсон создал эту базу сейчас сгинет нагрузку и мы видим что я что-то ошибся да а где ошибся а н господи синтаксис причем я уже 3 конфи даже больше митапа еще были я не ошибался первый раз так и ошибся давайте прерывать он сейчас привет и докер-контейнер должен убрать причем артефакты тоже приводит чтобы можно было разобраться если что-то шло не так где мы сидим давайте сюда пойдем и здесь всё удалим а вот я еще раз то запускаю делаю 100 тысяч . мы ждали меньше все-таки 44 секунды в наших условиях это много и да и вот это вот а вот раньше были сказать наверное столько на их столько глаз наблюдает а никто не читают верим что так можно так нельзя сейчас мы 100100 чекан гелием и попробуй найти эти от 10 до да вот замедли они тем это у меня коллеги они заметили этим установкой первой здесь надо убирать отсюда вообще потому что это буду раньше просто намного быстрее двигаюсь у нас все бур называется сейчас версия 09 вот релизная версия где-то в январе будет 10 там статьи пойдут уже и такой production уже больше хотя мы сейчас уже используем этот инструмент ряде проектов для экспериментов для ног боевых условиях вот мы нашли эти 11 строчек от 10 до 20 включительно гением отчеты один для человека выглядит довольно роботов джейсон xml сейчас все пока банально вообще тут хотя до этого тоже нужен был дойти вот и вот все мы сейчас можем пойти туда пойти куда-нибудь сюда в tmp здесь эта территория спалось вот эти наши артефакты и среди них да но пирах он самаре пишет да то есть мы видим что что у нас 18 миллисекунд вот для случая конечно миллиона строк было бы побольше там было бы типа там приближаясь к 100 миллисекунд и я обычно говорю но это плохо для такого запроса конечно за очевидно что это медленно поэтому давайте мы сейчас попробуем у нас есть идеи оптимизации давайте попробуем дельта дельта и скай льду мы скажем karait yandex вот на эту таблицу на эту колонку и мы требуем дельта x квиллингу на самом деле можно он там вот так написать но давайте дропаем индекса просто для скриптов миграции которые потому что мы думаем про то что мы будем соседи пай плане вот и просто давайте попробуем пока он запуск пока он тоже самое делает но уже с индексом вот запомнил 18 секунд было мы посмотрим что здесь есть здесь есть вот перебежать счет мы можем его открыть посмотреть не проблема то есть вот там один запрос если было много запрос мы все увидели но обычный пейджеров чет такой настрой знай 70 отчета как-то раз считал здесь и главное обычному судоходен да но до этого нужно еще здрасьте чтобы понять куда ходить здесь очень много есть тут все снапшоты в cs в формате кстати на маке вот так удобно потом смотреть да в спирте стад все внутренние сделали мы snapshot то есть можно понять что с базой происходило в том числе вот причесаться эту нас есть вот он вот он наш запрос здесь есть который 18 секунд занял что еще есть мы привозим конфиг которые использовали логика логе подготовки в когда вот мы там базу разворачивали и логе отдельно самовар клода если его нужно будет их нужно будет анализировать мы также отдельно с недавних только пор запоминаем и как мы все запускали на всякий случай чтобы потом не запутаться и оффлайн графа здесь нет это я потом покажу ну то есть вот в целом вот они все наши артефакты они позволяют то есть мы уже имеем очень обширный анализ того что происходило уже как бы лаборатории вот сейчас закончил делиться наш наш второй проход который проверяет что что что идея правильно и мы видим что сейчас меньше чем полмиллисекунды значит мы сработали индекс помог все хорошо естественно тут появилась вторая дикторе со старым набором я сейчас буду вопроса да со вторым набором артефактов теперь я потому что нам сейчас возбуждать минутки три потому что мы начнем работать следовал вес я буду делать все то же самое вот без допустим с индексом тоже да но я еще скажу ран он это был с то есть будет запуск происходить удаленно мы будем оркестре ровать прямо отсюда с ноутбука попросим значит ensis запустить нам эксперимент на ын сон seo и 3 lodge давайте я я не помню давайте посмотрим вот есть курсу сосед уинстон счас info и просто а и 3 сейчас ты дождись надо брать сейчас вопрос обязательно мы посвятим время но это в общем 15 гигабайт и два процессора будет но это даже хуже чем у а на букву посмотрим у нас было четыре 100 микросекунд с индексом да вот все что нужно для запуска на амазоне нам нужно указать что мы запускаемся дома зоне нужно сказать какое тип инстанса хотите и а да он он вам экономят деньги то есть будут спорта в инстансы которые могут пропасть мы там добавляем несколько процентов выше текущей цены чтобы минимизировать вероятность что она пропадет но вы получаете сервис процентов скидку но если пойдем повторим эксперимент это не production но зато мы можем больше экспериментов на те же деньги на на проводить ее нужно указать свой приватный ключ и как он у вас как у вас называется мы чаще ему при по публичные ключи амазоне лет назад скиппер name это вот ну то есть это получалось не понятно но мы это будем объяснять в статье в январе ну вот в общем это в если вы смазан работаете в любом случае с этим уже столкнулись и вы тоже по тут уже то подгрузили свой публичный ключ и вот имеете приватный все запустили он пошел это делать теперь можем а вот тут вот она цена в час там будет обходиться меньше пяти центов вот нам нужно все сейчас посекундная тарификация в конце в конце нас еще напишут паскаль coromant эксперимент обошелся посмотрим то есть но это полезно как когда то есть мы сейчас уже говорим про мы сейчас рассматриваем потратить там 20 тысяч долларов на продаже хиппи и нам уже хочется очень много всего за эти деньги получить то есть пошла оптимизация такая что это да ну вот вопрос а теперь можно то что он 2 минут обед он три минуты сколько запусков теста выполняется то есть на сколько там каши чистый и прочитать я заметил очень хорошо вопрос возник пуст и начали переключать вкладке там лети в браузер и то есть это влияет на тест вот сейчас материале время локальный запуска обычно длился минуту где такого рода вот такой простейший там была проблема что мы добавили несколько назад первым графы я буду показывать вопрос несколько раз выполнять запросы какие хочу забрасывать в данном тесте у нас koston просто москве с одним запросом и все это грубо его можно скормить файл он будет в одну сессию выполнять хотите разогреть кэш там есть там отдельно отдельно возможностью припиши прибором разогреть то что он хочется а там автоматизация пока минимум у нас есть идеи как это soft музей лед что понимать какие именно крыши же каши нужно греть чтобы продаж но приблизительно если мерить насколько это число хорошие то есть мы видим там 180 секунд второй запуск мы видим там 185 3 запуск 400 верно но как вы как вообще в как если там будут физики там лабы делаем нужно минимум четыре раза делается автоматизированных пока нет пока не делать более того вы можете попасть на instance который не очень хороший или же допросе на железку который не очень хорошие да и здесь у нас есть идеи как это в будущем улучшить то есть мы будем делать без беслан чек и сравнивать что мы видели до того другого такого же инстанса и понимать что это и лучше этот выбросить у нас фикса искать инструменты когда они проверены в амазоне bws машины они проверяют что они нормальные если нет лучше выбросить взять и попросить другую то есть это такой слот а и еще если мы что-то сравним на самом деле лучше на одной машине получаете сравнивать магии пока нет но есть с идеи магии полно разных и здесь есть thread'ов в идеале вы должны взять одну машину и на ней по очереди гаити эксперименты но если вы делаете большое исследование собираете dtc для машин лена вам нужно это делать параллельно потому что последовательно вам жизнь их white то есть amazon чем хорошим уме мы можем чтобы сейчас проверить допустим тысячу значений шайба фирс последовательно это будет если вор коту допустим получаса выгоняем вот она можем а мы можем тысячу сразу попросить но мы должны убедиться что они эквивалентны в этом сложности вот ну и конечно с продакшном сравнивать значение стоит потому что они если вы его руку же мама звонит классно конечно вы ваша ваша штука иногда мы делаем это не в амазоне а прям на железе это такого же как продакшном у заказчика иногда он там джесси пи мы это делаем тоже локально потому что удаленной поддержки джессика сейчас на гугла нету но спартак сам это самое то не стоит а нам и не надо потому что мы хотим что-то менять приближенных условиях и смотреть дельту можете отослать у вас есть самолет а в одиночку трубам и суем не самолета некоторую его копию но поменьше чудо но это что же выполнил запрос увидел что он до экспериментами нам важно относительности она не может быть может если там ну ну мы стараемся брать как такое же количество я такой же память может быть там процессор немного другой но можно же но можно постараться стараемся приблизиться дома даже если на амазоне то приблизиться либо либо вообще если он нужно четко лучший талон делать но все то огромная проблема то есть я уже там откопал то книжки там как эксперименты ставить этом огромной теория вокруг это то есть но она ислам физики пришла из статистики так далее так все amazon там наконец-то нам 100 а вот опять этот фон граф ставится клей мы его еще не завезли просто в докер в там сложностей с ядрами и пока еще вопрос так можно как-то подкинуть туда прям образы базы и то есть и запустить уже готовенькое даст типов значит вот да значит у нас четыре вещи энвайроменталисты январе мент объект это наша база и workload их дельта in warm and сейчас может быть плоскость 96 10 и 11 уже поддерживается но самой последней минорной версии нет не последний вчера последний вышли нож предпоследнее вчера после не вышли мы еще не перри собрали дальше база можно указать либо дампом либо можно сказать указать физический физическую копию базы то есть с помощью бежит бежит из бекапа созданную либо может быть в этом другим способом сандаль неважно вы можете просто сказать она лежит здесь и мы еще у нас есть там трюки когда мы на и без валим на амазоне кладём этот прежде это а гоняем на e3 not of insight ренессанса у них есть локальные диски довольно мощные там ну в смысле они onlime они очень быстрые и их мы их можно там несколько работ набрать то есть там вот у этой но до 900 с чем-то почти терабайт следующий будет два терабайта там до 6 по моему и что происходит мы обычно делаем серии экспериментов нас уже есть поддержка серии экспериментов в пол request но пока еще не смел этому большой довольно мы хотим допустим 100 значение эрба first последовательно на одной мысли для чистоты да и мы там происходит копирование пережидает и локально и дальше еще раз копирование еще раз локальный и дальше он отматывается рынком а есть крутой подход который мы обязательно будем скорость следовать с помощью snapshot of файлы системы в яндексе я слышал что в яндекс яндекс метрики вот мы слюну тема стейджинг до базы данных правильной вот они 100 джек баз данных для masi кула делают за две секунды по запросу разворачивают production там молча то работ куда нужно было сходить с этим ну куда смысле где-то конь не доклад давайте так я могу я вам как то могу выложить мяч ссылка то есть я могу в twitter сильный выложить еще россию здесь до в конце до ильичу а закончилось все да значит кто круче был нас было сколько чуть похуже но меня на буксе получше да можно к и сама за несколько лет не будете брать микрофон дайте пожалуйста там на amazonas ребят очень хитрый поэтому поправочка значит если будете брать с нас это лучше брать как у николай правильно заметил с жестким диском который идет в комплекте с инсам а не отдельным тому потому что на внешних намах которые монтируются командор русскими сносом есть такой некий шейпер и они когда и опции вылетают за пределы о них начинают срезать поэтому у вас теста могут получиться весьма и весьма интересное у вас роксу буду скакать как сами понимаете что то тут и тут вряд ли он солдат уже есть но да это это точно то есть облака жить это отдельная история там надо быть готовым ко всякому и пройти инстансе вот с этими локальными дисками нужно тоже помнить что они так называемые эфемерные то есть если машина рестарта все пропадает но для экспериментов нам это окей то есть мы нам вот она сейчас только до а по выходным данным вопрос а сейчас кучку с и без воли вам классно что вы можете его заготовить за attach ночью заточить прогнать эксперименты серию did очнуться к или другая но до его там откатит к предыдущей версии ну как то так да и о и у нас они готовы вот прям прям сейчас готова да правильно вот по входным данным ну то есть комнату за не делает какой-то магии над данными то есть она берёт указываешь какой-то backup поддерживаем информации из него разгадать ребят ну да но здесь у дампа логический диск велим просто есть опция я сейчас покажу указывает мы поговорим что вот у нас поджидает уже лежит прямо тут и 1 слой нет возможности допустим опускаться и данных каких то они есть есть утилита на эту тему недавно новое кажется для подвеса появилась есть даже компаний код который только этим занимаются это большая такая проблема она близко то есть она как раз здесь должна быть да то есть допустим сна пшёлты систем те же ноты говорить про snapshot ну то есть снял там какой дтп snapshot или что им такое назад шатов выпускаться задержана тема не не имею ввиду но только сейчас поддерживает формат два формата логически или физически пока по сути ну дальше на данными не происходит никакой работы у нас есть опции которые вам позволяю туда засунуть и модификацию потом он делать модификацию потом он делает вакуум full по то можно еще сделать прибором немножко покрыта потом гнать серию там в общем это и то есть уже что-то для себя использовали тоже там при там есть припас таки можно даже если сыч какие-то штуки сделать ну в смысле базовые вещи какие свечи абашево кит штуки сделать ее искали тоже то есть это даже уже сейчас есть вот сейчас из амазона мы посмотрели то же самое и а вот нам стоило сколько этот эксперимент длился 5 минут и обошелся в полцента меньше чем в пациента ну такой банальный инструмент на какой-то простой тачки мы гоняем тачки то майтри максимальные они поскольку они там вот они до 480 8 гигабайт 64 сервисе пью вот один человек он танки догоняя догоняет эксперименты базы там одна чуть меньше терабайт 1 паттара и вот мы гоняем гоняем там из счет за месяц 300 долларов у нас там куча всякого там происходит параллели гоняем их причем половина денег на то что поддерживать вот этот валим чтобы данные там рядом уже можно было брать то есть только половина из этих там нескольких сотен долларов уходят на сами вот эти три насоса в общем это сила спад в их инстансов это очень дешево и вот у меня на ноутбуке виртуальных машин там с версиями ядра проблемы а здесь в случае амазонов должно быть все окей у нас еще один артефакт должен появиться который нам должен что да вот flame граф то есть мы можем здесь посмотреть тут не интересно смотреть и давайте еще один и запущу чуть более интересно и и посмотрим тогда то есть чуть право клод над рассказать вот это конечно не интересно когда в один поток какие-то там искали гоняем но и так этот детский сад хотя в некоторых случаях по сути human тебе так и действует он период explain начинает его в один поток оптимизировать то есть тут как бы тоже можем так идет интересно смотреть на картину в целом поэтому как я вчера рассказы один из подходов собрать логе желательно включить все логе собратьях и потом подготовить и джери play сценарий это бинарный файл который ну есть такой проект по джери play вообще то есть из кусков которые уже есть то есть вы просто склеили оркестрацию вот эту сделать что просто нажал и пошло опять же реплей на основе логов генерит сценарий как как во много потоков приближенную к продакшном нагрузку сделать то есть вот если там одновременно опять юзеров ходила вот он будет пять этих запросов гонять конечно там будет некоторые отличие от в частности потому что мисс темпл подгрести resolution самый максимально это только миллисекунда они микросекунда и поэтому там если ну в общем начинается но нам когда очень много запросов закон больших чисел до там в целом но начинает стабильно и результатом тысячи десятки сотни тысяч запросов уже это будет о'кей то есть собрать там полчаса вы нагрузку в какое-то загруженное время не положив себе прот это очень важно потому что если у вас число как я вчера объяснял syslog и journal de я просто эту картинку должен взять на показать если вы будете во всю эту тему идти идеально можно на большие грабли наступить вот журнал действий слог вот настолько вам это пиджи bench от без логирования слева 317 тысяч дпс это стр это свисток с логин коллектором а это syslog journal de вот он так так сильно нам просаживает производительность вас все ляжет просто если вы полное логирование включите у вас услуг журнал дик слева это ubuntu там было без журнал диетам что-то на какая-то ночью немножко другое вот соответственно вы собираетесь помощью перри реплей делайте workload опять же реплей есть такая опция доказать свой клад переплыть и указываете путь к этому бинарному файлу и у вас пошли эксперименты на основе вот приближены to the grill workload в терминах oracle на самом деле applications testing пошел один парень из портленда после митап после конференции пережидая там был я показал это все он у нас была идея и он тоже и и естественно образом эту идею получить как бы тоже принес что пиджи bench тоже нужно сюда впилить соответственно у нас есть в опциях так побольше и вот есть в опциях workload можно задавать вот они в оклады опции вот есть каста москве ль который мы делали вот есть rifle да и неправильно залпе jay park the rifle они пережили play и можно кстати его ускорить допустим прогнать нагрузку нагрузку как было на продакшн в два раза быстрее с мальчика учиться и вот их появился workload пиджи бенч и появился ди би пи джи bench то есть можно базуки использующий 5 женщину стандартным образом ну и не инициализация переживаний тестов там дэш и она вот есть вам все что нужно там задать опции передача и таким образом вы можете даже bench гонять допустим там сейчас мы можем проверить сравнить как будет коллировать от 1 до 10 одновременных этом даст одновременных con carne connections сравните 96 и 11 например там 10 и 11 нам ничего не стоит нам нужно всего лишь написать вот эти вот опции запулить вот таким образом можете и там но каких следования делать но то есть не обязательно при этом они должны идти в паре генерации оба объекта вашего с помощью пиджи ганча такая вот искусственно ивар клода они могут идти отдельно если у вас есть наша база она лежит в передайте локально мы можем ты же день чем видеть нагрузку понятно то есть мы можем просто пулять нагрузку с помощью него и я раньше этого не знал но оказывается у кого-то тоже были такие уже идеи и ту же сделано прижимали чем можете сказать опция д шеф можете ряд файлов ему подсунуть и на 200 мм вес а то есть если вы смотрите перестал стоять у нас что у вас там в 10 процентов случаев вызывается такой запрос ну по количеству calls просто в пяти процентов такой ну делаете 10 вес этому 5 вес этому и в общем и это дает возможность не включать полное логирование на продакшн но она конечно будет не близко но не совсем то же самое там главный вопрос как вы еще параметры будете видеть тут тоже можно обсудить но это будет безболезненно production вообще не затронули мы не включали логированием их только взяли спереди состоит националь из запросов и просто начали это в начале много потоков приближенных production ноги и с помощью пиджи бенч и вот я сейчас запущу еще один прогон чтобы вам показать вот 30 секунд всего здесь будет скилл фактор 10 там значит миллион строк в таблицах просто давайте ещё один прогон это сделаем и можно еще поговорить какие вопросы если есть тоже на амазоне горшок венгров к себе интереснее посмотреть то что при женщин а ну вот кстати вот возник вопрос вот пиджей play мы там гоняем переживания ниже когда где ряд нагрузку они тоже потребляют ресурсы процессора они по-любому потребляют их надо вынести мы пока еще не внесли все еще внутри пока насколько большой вклад насколько их вклад в performance ну смысле в нагрузку системы и как раз тут вот на несколько де назад буквально вот мы добавили поддержку flame графов она уже масть я пошла и не не пошла сегодня нужно пойти и сейчас мы как раз делаем эксперимент мы с помощью переживания гоняем нагрузку на нос на нашей тоже с помощью поджиганий сделанной базе искусственной и посмотрим ну там вот 4 до 4 клиента хотя у нас сегодня мы видели два процесса процессор а9 пью до посмотрим насколько большой вклад у переживания будет если он будет допустим 30 процентов так вообще делать нельзя если меньше десятину но понимаю что он там над лоном процессор но пожить жить так можно принцип пока что вот я чувствую загрузил как-то много информации слишком вот вопросы давать очень пообсуждаем чудо что здесь можно в этом тесте выполняется мы берем на 33 лачин 100 сот 22 secure 15 гигабайт памяти и мы с помощью ты же банщик или наш объект скилл фактор 10 означает что 10 100 тыс 100000 на пачек строк но краж миллион строк гоняться 4 таблицы там в пять женщин от стандартной опал готовый инструмент для проведения быть марков миллион строк теряться и дальше to select only запросы будут минус с большой 30 секунд 4 клиентов четыре потока то есть у нас будет ну под все процессор все наши два процесса точно будут заняты и скай всего один будет занят занят этим самым генерации и вопрос сколько он будет занят этот фильм кровавая часть опять наверное да это же bench это такой да ну как бы и плоскостью настройки может тестировать это типа теперь like тест записи и человек то есть ну то есть он там приближенный к этому для в цепи нагрузок короче то есть много select a fight of insert нам в нашем случае только-только select и будут вот еще одно место где можно ускорить тут щас контейнер вытягивается долго с другого региона похоже а можно вопрос а можно я здесь я здесь да м какая то есть возможность сравнить например между двумя версиями пожгли со да конечно есть ну то есть самой задается для как бы вот именно в том ключе где вы говорите что поменять там как это версия там 96 лет десять или одиннадцать вот там сейчас у нас нет такого потому что там какая история вы не можете тоже поджидает использовать нам нужно новый взгляните на обед устроить но нужен для поджидает устроить но вы можете сами проект сгнить 2 прогона сделать у нас же появился сейчас диск раев еще которые комп консольки вам сравнить артефакты из двух папочек нэнси и нарисуют разницу я к сожалению не владивосток всему так недавно добавили без меня он полностью целиком два каталога сравнивает какой-то него там джейсон файлы которые подпиши беджера он берет total таймс разницу какие там еще общий бренд и дальше top н запросов 10 или сколько самых медленных их сравнивает в этот мир этот ускорился это замедлился таким образом not таким образом вы можете до взять 200 под газ и это один из кейсов когда перед обрядом мы посмотрим заранее спасибо человек возвращаюсь к моему вопросу при сборе нагрузки как именно свою нагрузку собрать то есть вот у нас исключаем логе раз ну и из этих войн логов уже джери play да хорошо сэмплирование там какой то возможно хороший вопрос ну то есть возможно конечно то есть пока в плоскости нет сэмплирования из патч на эту тему не принятый это хорошего большой вопрос как бы сделать нормальное сэмплирование если у вас 5 же боишься поможет и притом в конфиге пиджи боишься можете указывать что что такой-то такой-то запросам не в каждой каждого начале каждой сессии и вы можете написать функцию где внутри функции бросать рандомы делать светло командировочным statement в зависимость от того лука через 10 процентов притом одном процентов случаев сами может такое сделать ее там всякие define r5 deformer сделать чтобы везде работал и просто против в кого его нет вы не джебом но если не ошибаюсь но я вижу только нормальный подход на стороне приложения в каждой сессии прописать вот тут кидание монетки этой вот только такой в будущем после себя будет сэмплирование логов это хорошая вещь очень вот еще вопрос по поводу м или сейчас из кучку а вы можете не собирать логе если вам дорого можете взять 50 стоит масс взять топ 10 или 20 запросов а и и дальше с помощью придумать как им подсовывать параметр тут надо знать предметную область если у вас 11 после случае брать не слэш рэндом опять же buncha слэш рэндом zip финн понизив будет неравномерной а вот ближе к этом социальным сетям условно там есть пример документация 11 подвеса и дальше бомбардировать пиджи бенчи сделав pisa приближенное тому ну смотрите на calls если calls видно что там 50 пациент временем нас запросы были вот это вот кто первый . вперёд нас мы повесим вес такой-то в переживании можно навешивать веса делаем отдельные файлики для каждого запроса вешаем веса и таким образом мы можем моделировать не собирая логе так можно делаем то что никаких случаях невозможно включить логирование все ложится частности зассе journal de до вопрос следующий собственных 2 1 по поводу того как вы планируется применять земель потому что не зале королевы по это не слышу как машины они планируется применять это первый да ну а второй потом наверное да ну вот кто сколько шер баффер ставит вчера спрашивал машины они как раз здесь начинается потому что шайба фирс нормально подобрать вот мы заходим на коне пережить юную леопард юрий да и там всегда 25 процентов для вас спинам за советует неправильно вот если у вас как вот ноги tab 700 гигабайт памяти у них накажем и позы с машине там шесть машин от github.com 700 с чем-то там гигабайт такой мощной инстанция и у не стоит 25 процентов сейчас еще предстоит оптимизировать ну как же это неправильно там практически в два раза будет быстрее если вы поставите 8 гигабайт и дальше возникает интересная история что почему 8 гигабайт это только ваш boffins это умный кэш для подвеса он умнее чем конечно персоной система потому что он знает чем мы делаем и когда мы допустим вакуум огромную таблицу такая персона системе в сосет все все все данные и вaм вы может нам полезный кэш а в 62 offers у нас будет кольцо так называемая буферная и когда вакуум и он будет только кого кусочек баферов использовать не вымывая полезные конечно нужно знать что вакуум операций от одноразовая вещь нам не нужно трогать уроки и короче из этого хочется сделать большие 6 больше 50 процентов и в некоторых тестах когда нагрузка не сильно не сильно много tps и процессоры допустим 10 процентов они заняты а это кстати поправочка так и должно быть в этих случаях оказывается что много шариков с хорошо но когда мы приближаемся к увеличиваем дпс возникает ну его и особенно если ваши ваши данные рабочие данные не попадают шайба фирс сильно больше возникает такое что при чтении чаще и чаще мы должны вымывать когда мы меняем вымываем что-то ну новый до новой баффи я новые данные в буфер какие-то новые данные впихиваем лучится хэш-таблица и если много tps мы короче сидим если больше и больше огромное количество больше 6 больше восьми больше 16 гигабайт памяти от от водяного шайба fish конкуренция становится дикое просто и оказывается так что вот 816 это лучше чем чем четверть точно чем там больше чем пять процентов но в некоторых случаях и от почему про машину я говорю нам хочется понять сколько ставить но мы хочется найти идеал для разных ситуаций а тут зависит а к-какого с базы как там рабочий свет попадает не попадает как сколько там вас ресурсов короче мы уже гоняем разные эксперименты и мы будем гонять еще больше экспериментов чтобы сделать полноценное исследование но чтобы сделать его даже если вы при условии что у вас очень много денег в жизни не хватит и поэтому там нужны мошенник чтобы если вы проверили как себя ведет после сна 12-я я не пью и на 16 у вас 14 почему-то до на джессику например что вы могли исполнить хотя бы одну чтобы могли предсказать что будет на об этой ситуации вот просто задача по сути задачи оптимизации гипер параметров то есть тут их типов 280 ручек то что в начале уговорили подобные задачи есть сам внутри самого имели до days и есть стандартные методы на данный момент решений которые более менее хорошо работает то есть какой-нибудь гипер об или там смак старый или еще что-то который вот этот подход мне очень нравится но я понимаю чем речь только чтобы доклад энди павла коту который раз рассказал про отортен машин лирник под подбор параметров для москве ли и подписала пан собственное решение 6 процентов батарейки и статья есть даже низко статей классная штука классная штука но я верю в том что если мы будем комбинировать знания предметной области глубокая экспертную систему и машинок методы мы еще просто ну пока пытаемся понять что за что за чертовщина творится эти ребята они сделали по-другому они относились к полюсу к черному ящику у них of active кажется со идеальный больше превышает память я такого не хочу то есть это есть то есть они там сделали они там лассо применили чтобы понять там ну а не сгруппировали настройки память поняли какие настройки с какими связаны коррелирует но там много чего хорошего до до лагеря не совсем про это не про то что еще раз вот у вас есть допустимым альный pipeline есть резко вариантов обработки данных есть несколько вариантов моделей вес до фигища вариантов параметров для каждой модели и так далее есть непрерывные часть дискретные на данный момент то есть изначально там больше двухсот восьмидесяти ручек да как бы гораздо изначально все это пытались тело через грицевич тупой где-то отстаешь для каждого параметра как бы отдашь ок ну да diligence и спускаем должны туда сейчас то есть именно уже готовые более умные решения которые внутри себя проводя эксперименты по сути делают свои модели упрощенный я решил просите которые сами учатся другие сети такой по сути до отвала баловные ваня рассказывал такое сейчас есть более простые штуки которые гарантированно рабочим и потом вообще это очень очень да вот мы просто мы сейчас машинок отодвинули вот это случилось для того чтобы набрать данные то есть где мы возьмем данные нужно площадку сейчас я уже понял что это нужно и без машин линга нужно просто ну или грешен там это сиди pipeline обязательно хочется пообщаться значит вот мы прогнали здесь у нас было сто сорок девять тысяч запросов успел вы пункт за 32 секунды и давайте посмотрим какой здесь получился сейчас а где одну секунду почему то я не вижу где мы сидим ну понятно мы сидим другой директории здесь вот туда приехал эти артефакты я просто хочу посмотреть вклад теперь ты же bench а вот как он там один одно из наших лидер мучил и давайте посмотрим это здесь вот смутами я сам сейчас не знаю результаты надеюсь что меньше десяти процентов если больше не хорошо так вот здесь вот он flame граф видно что позвизд много ближе пять женщин от увеличивает тут много всего было до а вот переживаний то есть венгров это вот но для принципа перфоманса видим до 6 процентов отлично вот можно увеличить вот он пиджи bench здесь у нас классная штука флангов и конечно вот видно что 1 6 процентов overhead нам давал внушать пацанов вклад от на всю нагрузку нам давал переживет соответственно я пока готов с этим мириться и эксперименты считать пальме недостоверными потому что там меньше десяти процентов это этакий и он вкладывает будет на всех экспериментов примерно одинаковой ну понятно факту ации то никто не отменял и соответственно мы будем получать достоверные данные особенно если мы проведем там четыре или более одинаковых экспериментов чтобы потом потом взять среднее или бросить отбросит граничные вот ну я много чего могу рассказывать показывать вот например например еще он там у нас есть веб-интерфейс для этой штуки но пока не публичный вот то что я показывал там были скриншоты вот можно создать эксперимент то же самое все тут просто ну визуально выбрать какую нагрузку там и так далее 5 же банщик стать еще здесь нет и дальше смотреть результаты ну видно видно там вот результаты каким можно там зайти внутрь посмотреть как там у слева с права там здесь не было ничего да в общем можно один вопрос а скажите а вот не не на вес запускать эксперименты но на своем сервере это же воздали рассказывал звали да да да то есть вот узок заказчика приходим говорим нам прежде всего выдайте одну хотя бы лучше несколько машина которые такие же как production мы туда забираем дальше поджидает уклон и начинаем это ложь это наша лаборатория отлично тут начинается вопрос что подождите недельку мы там сейчас нам ну как обычно ну вот чтобы там запустить эксперименты много действий руками то есть там доктор надо поставить рублей ираке и не с миссис как будто они джокер должен стоять на машине очевидно чтобы но чтобы до и там есть требования ридми ну вот он все описано то тогда то есть вот ссылка здесь ну в общем она такая простая в докладах было я щас твиттере засуну тогда тоже ну доклад я засуну в твиттере сегодня или завтра вот здесь вот адрес данных об пол ездишь и я это слышно nsi здесь нормально людьми мы стараемся поддерживать здесь есть рекомендация установка она состоит из вот этих трех строк планируете с гитхаба себе репозиторий ну ну да то требования еще докером поставить вот и джек еще поставить потому что диск райбэк раз нужно джейсоном иметь работать но работает сейчас мы на маке в начале начинали до должна make работает но лучше конечно ринулся и таком же как на продакшн можно но без докера будет все та же самом нужно повторять просто мыслящего дойки чтобы при уже все приехала и и там уже все стоит можно без докером в одном том же железе в докере не в докере насколько разные результаты хорошие хорошо посмотреть ну вот но опять же да это у нас ни у докера ни в коем случае то есть она прямо научно конечно обязательно потому что на чьи-то ну там просто много особенностей там как блокировка как и вот просто очень интересно интересно когда-нибудь займемся этим может вы займетесь и покажите нам пример потому что все же вне молись и вывели вы вытащили из докера это был ранен а у нас вот проводится хочется да это driving свяжем здесь делает хочется посмотреть разницу именно вот пощупать был production was gres просто там с ума сходил в докере вывели из докера кожи вот глеб мы посмотрим хорошо хорошо сейчас мы гоняем тоже ну вот там почти двух терабайт на я база много тысяч дпс ну мы понимаем что это никак production но мы в разнице смотрим на мы нам удобно что уже привели приезжаете в принципе они ну я не фанат докера конечно просто классно что там установлен восстанавливают все быстро поэтому просто ну да у нас вот программисты ну это же больше года назад была делали замер производительности позы риса в докере не в докере на сравнении с голым замолчи на пережидает конечно ну вот это самое главное ну скорее всего да то есть вряд ли по другому дану там был была какая-то все таки разница не в пользу докера но она до 10 там от пяти до десяти процентов из ну вот таким бы я жил потому что там очень много все уставились вам разные кейсы были там следовательно пара директивам был настроен что что директория была настроим откуда директор для подлинной это вопрос про журнал день почему такой вклад вносят не смотрю знаю я просто заметил бы классно если об абсолюте подробнее я сам очень интересно очень на другой в докладе говорили как раз про то что это если через число клонировать нам удачи если слог джонович да ну то есть логирование syslog идет через искал то есть через ядро то есть как запись каждая запись лога идет через бедро из-за этого нам ну да вас journal de может просто еще больше переключение контекстов получается да между ядром и users ps может из-за этом ну да так я и так что там мы больше ничего не прогоняли да да все в принципе у меня вот такая содержательно часть все тем более мы уже если времени вышли все вот еще вопросы или или как можем или просто вообще да есть вопрос да так как ну вот как это этим инструментом пользоваться вот допустим у меня есть продакшене база достаточно большая я делаю дам на которую на каком-то там вот один вариант можете пиджи ps backup сделать физических а какие каким-либо вариантом do no similar in vermont рядом и потом допустим тот кот которая знаю что поменялся на кату ну тестирую версию с того что было вот если вы меняете 10 р миру ментам не забыл как анти аккаунт менеджмент я как backend разработчик поменял день за какие-то запросы добавил какие-то колонки индексы и что-то еще и стандартный сценарий проверяю вот сейчас смотрите да если вы допустим хотите проверить как вас индекс повлияет это вот там сейчас можно делать вам вы собрали собрали на нагрузку с production лучше настоящую да вот в dialed полный лог там ну если не джим аудиторы собрали и дальше вы проверяете один вариант с индексом другой нет я не показывал там есть опция а показывал да и яндекс которая создает и у вас будет в одном случае без другой сравнили если же вы меняли колонки подключается ножка сложнее но множестве ну то есть эта область которая мы еще не знаем как классно как классно было из автоматизировать потому что вы должны 2 немножко разных в холода уже делать потому что она разные имена что-то будем делать с этим ну то есть это вы можете сами просто скормить два разных форм клода заранее подготовившись и сравнить но пока туникой маги нет к сожалению спасибо"
}