{
  "video_id": "HEoTKXpZniY",
  "channel": "HighLoadChannel",
  "title": "Почему вам нужна платформа межсервисного взаимодействия / Артемий Рябинков (Авито)",
  "views": 3985,
  "duration": 2848,
  "published": "2020-04-14T10:50:51-07:00",
  "text": "да меня зовут артемий собственно работая в компании avid ее монолит не распилен ребята поэтому если вы надеетесь узнать как распилить монолит до конца ну простите не сегодня вот но конечно вообще говоря хочется хотелось изначально узнать типа кто вообще знает про сервисы но понятно что на холоде все знают про сервисы давайте поднимаете руки не опускать их тех кто использует у себя в продакшен ну сервисную архитектуру которые устроят ну давайте не стесняйтесь ребят я астрал почти не вижу так что супер а теперь ну погодите держите держите руки опустите только те ну в рио ставьте руки только те кто вот знает как строить сервисную архитектуру суть а вас много вас много обычно я тут говорю приходите пишите заявление ловит устраивать вас будем но в этот раз вас много и это даже лучше у нас хорошие программ или рекомендации я смогу отпуск ездить так что давайте начнем на самом деле я тоже не знаю как вот строить идеальную сервисной архитектуру я попробую рассказать о том какой опыт есть но по сути все начинается с какой-то историей и это история обычная но у нас с вами она скорее всего похожа потому что у всех у нас есть монолит такого монолит есть давайте поаплодируем стекол монолит вот плуот вот поэтому поэтому приходится приходится делать этот доклад у нас у всех монолит мы с этим монолитом долгое время жили как жили жили просто да у нас было взаимодействие которые было внутри этого монолита мы вызывали какие-то функции и по сети мы ходили только в базу данных все какие проблемы никаких не было проблем счастливо жили потом какой-то момент мы решили давайте строить сервисную архитектуру и у нас появился первый сервис мы начали в него как-то ходить да мы пытаемся использовать там протокол который наиболее популярны в интернете http скорее всего начинаем с http и конечно в теле запроса мы отправляем с он ну в какой-то момент когда уже начинают эти сервисы пилить ни один человеком хотя бы парочку появляется идея а что если нам сделать спецификацию спецификацию на запрос на ответ на то как как минимум ошибки мы возвращаем и приходит первая идея давайте типы ошибок специфицирует ну и мы начинаем жить с таким протоколом взаимодействия который имеет какую-то спецификацию который мы вот на берегу так договорились просто на словах и ее используем но в какой-то момент да мы начинаем расти команда растёт количество сервисов растет мы приходим к чему купер лица конечно приходим и появляется у нас кубер нить из этот монолит начинаем распиливать на сервис и сервисов становится все больше с каждым днём с каждым днем все больше людей и самое главное что люди которые приходят они скорее всего могут вообще не знать о том что мы там договорились о каком-то протоколе для взаимодействия их как бы нужно обучать они может быть не хотят адам бар такого следовать просто потому что он как бы на словах там договора и в итоге мы скатываемся в историю когда вокруг много сервисов эти сервисы как-то взаимодействуют не всегда это взаимодействие строится как-то консистентной поэтому ну поэтому мы обретаем большое количество проблем какие проблемы конкретно ну во-первых если мы это делаем руками мы тратим тысячи реально тысячи человеко-часов на то чтобы просто написать запрос верней а то чтобы написать код клиента и код сервер обработки запроса и отправки запроса мы давайте мы это время мы пытаемся делать как-то взаимодействие много разных уголках нашей большой команды это взаимодействие начинает чуть-чуть по-разному строится у кого-то один формат запрос в ответ в тот другой зависит от команды а в целом по компании это не консистентной мы получаем какие-то не консистентные взаимодействия с тобой сервисы ну и конечно об сервами лети в том смысле что логирование метрики вот это все она тоже начинает сильно разнится мы не всегда можем сказать по конкретному сервису что с ним происходит если мы о нем в не знаем изначально то есть хочется как-то понимаете это но мы не можем контекст запроса контекст запросы я имею ввиду что вот пришел какой-то запрос да на сервис а что мы об этом запросе знаем кроме вот его тело на самом деле ничего изначально мы не знаем ничего мы не знаем о том какой там предыдущий сервис отправил запрос какой пользователь изначально инициировал этот запрос пользователю смысле вот прям человек какой браузере нажима или в телефоне кликая мы этого не знаем и из-за того что мы не знаю вот этой информации таких мета-данных запроса контекст запроса мы не знаем мы не можем делать авторизацию мы не можем понимать можем ли мы там какой-то ресурс отдать на выход или не можем и мы не можем там делать об и тестирование например в том смысле что часто оба тестирование это ситуация когда мы по каком ты там юзера иди и купи вот этому всему какому-то признаку пользователь делим что-то и на самом деле оба тестирование так как бы маленькая концепция сегментации фичей в том смысле что иногда нам хочется разделять фичи между пользователями мы хотим например пользователям там из одной страны и пользователям из другой страны отдать разную информацию мы хотим зависимости от того какую валюту нам пользователи используют отдать разные данные вот это вот всё мы не можем делать хотим ну и конечно мы приходим к тому что давайте строить давайте строить какой-то спецификацию уже более более мощную спецификацию который нам позволит добавить метаданные все остальное и мы приходим к чему к swagger у конечно опыт и 5s вагеру начинаем пытаться писать свое схемы swagger схемы сразу же притаскивать за собой сон схемы потому что мы хотим вы лидировать входящие данные да мы описываем схему запросам и описуем там или с агирре финишем записываем этот swagger и пытаемся с этим как-то жить начинаем жить что оказывается что на самом деле это не всегда удобно и часто просто нам даже может мешать почему мешать вот возможно и субъективные минусы но я считаю что swagger и его подход очень сильно заточен под рост прям очень сильно навязывают тебе рис подход не всегда хочется использовать rest хочется иногда она как бы рпц строить без необходимости думать о том как у тебя там называются путь вовсю теперь у нас при использовании swagger нужно работать что он с кем мы скорее всего нам приходится это делать и на самом деле это вот не очень удобно в том и это от нас требует необходимость вам поддерживать файлы с он схемами swagger из посмотреть всю информацию сразу мы не можем нам необходимо проводить с учетом схемы как как это все вместе связывать тоже возникают вопросы сразу вопрос возникает в том числе и при попытке генерировать код поэтому мы думаем но ведь у нас есть схема давайте понять генерировать код пытаемся это делать оказывается что тот код который генерируется нам не подходит мы идем и пишем темплейты новые темплейты эти темплейты необходимо распространять на всю компанию то есть каждому человеку при разработке сервиса необходимо использовать те же темплейты которые используют вот все другие люди вокруг него ну проблем это остается не все люди будут их использовать а кто-то захочет их по почти себя и в итоге мы тоже придём к ситуации когда как бы то что мы хотели получить мы не получаем сон многословен в обоих смысл до его как писать в принципе он довольно многослойным с точки зрения там чтению его написания но и с точки зрения просто того как все реализуется данные когда мы гоняем данные в зоне у нас есть определенная orchid по ключам которые мы передаём вот тот же но есть более оптимизированный под обработать эти протоколы тот же парта барда вот они сейчас поговорим схемы они не актуальны и в том смысле что мы если мы нигерию не генерируем код а мы например не смогли до распространить template на всю компанию перестали генерирует код пишем руками или там изначально не писали не делали коды генерацию в этом случае чего получается что у нас схема 1 а кот другой мы приходим в сервис морем тут вот описаны ручки там запрос ответ всё такое смотрим в код он так вот не отвечает этот сервис он работает по другому совсем потому что конечно мы там вечером в субботу быстро пофиксить что-то выпить и да и в итоге схемы на самом деле не актуальны их люди не пишут ну и если у нас нет куда генерации мы кучу времени опять же начинаем все все еще про темнота что вы писать код который можно было бы не писать но тут надо остановиться и подумать о чем мы хотим то что нам на самом деле хочется вот как-то структурирована знаете вот есть в го джоэл подхода к там мы говорим на ставим старики да и говорите по как там пользователь не знаю я хочу то-то то-то но тут вот как разработчик я хочу я хочу как разработчик на самом деле я хочу немного вода я хочу простоты и скорости разработки на самом деле на самом деле по секрету мне вообще не интересно как разработчику какой-то продуктовый например в печи как происходит взаимодействие между сервисами какой протокол используется какие когда найти реализуются то есть для того чтобы вам сделать какую-то продуктовую фичу вам не хочется об этом знать и особенно мне не хочется думать о том как мне назвать вот этот почти типе путь правильно какой метод запросы использовать сидеть часами вычитывать спецификацию о том как раз правильно готовить хочется вызвать в коде функцию да и получить ответ все как в монолите нашим вот хочется также ну конечно хочется находить проблемы хочется их быстро находить да не хочется приходить там на сервер с и сепеда пам сидеть ковариация вот это вот все хочется как-то вот системе мониторинга ошибок увидеть вот тут ошибка вот пойти и исправить да и даже если это происходит там субботу вечером не хочется тратить на этом на время авторизации запроса об этом я сказал мы и хотим как минимум понимать что за пользователя к нам пришел вот первоначальные там или сервис мы хотим понимать можно ли отдать ему ресурс или нельзя ну и все это ведет нас к тому что мы хотим сегментировать vici тоже об этот тоже самое оба тестирование но вот как раз про это мы конечно хочется взять и одним махом все проблемы решить вот чтобы сразу все и мы приходим к платформе для межсервисного взаимодействия платформа именно то что позволит нам решить эти проблемы вот я говорю платформа дачу это вообще такое то есть понимает о чем я говорю кто понимает так вот там человек массовое сейчас поговорим о платформа на 10 и теперь на этом мы будем базировать нашу платформу в том мы будем понятно что мы будем строить сервисные взаимодействие мы будем как-то взаимодействовать между сервисом пытаться сделать это максимально удобно решить наши проблемы depay'a depay это два протокола который мы можем как бы взять для этого подумаем дальше нам нужно какой-то более верхний уровень так скажем прикладного уровня протокол да ну и в том числе стерилизации данных какая то нужно ее тут все вместе объединил в этот слой ну мы можем из чего-то выбирает даю на рынке есть решение дальше сейчас уже люди пришли к тому чтобы делать при уборке для взаимодействия то есть платформы это платформ framework фрэймворк это джипси может быть вот 3 вт и который фейсбук стать используют во многом можем свой написать но по сути нам скорее всего понадобится какой-то framework и дальше дальше следующий слой в этом докладе скажем так его называю communications фромборк то есть если у нас есть пример для взаимодействия этого 3 этот слой пирамидки то последний слой коммуникациям прям брак это та часть которая на самом деле мы не можем взять из окна source а почему потому что это та часть которая позволит нам интегрировать нашу платформу в инфраструктуру это touring это возможность автоматически как бы покрывать код какими-то метриками логе писать и так далее именно именно вот эта часть платформ именно вот эта часть вообще платформой к мельчайшим from rock позволит нам достичь достичь того идеального мира которым мы идем и и как ты придется написать на но вопрос естественно мы задаем сразу а вот люди вообще говоря наверное уже это делаю да мы ж не первый к этому пришли скорее всего кит большие компаний уже как-то с этим работают и вот я пообщался с ребятами из разных компаний как раз по спрашивая как что почему и на этом слайде собственно есть компанию с людьми из которых я как бы ну либо лично пообщался либо то однозначно описано в блогах статьи об этом я думаю кстати тут на этой конференции достаточно людей из этих компаний да можно подойти поспрашивать суть чем смотрите вот если в предыдущем как бы ипостаси нашего мира когда мы делали монолит иначе перелить сервисом у нас привели ра вал вот растите персонам это видно то сейчас уже люди начинают компания переходить к живописи люди начинают переходить к мыслям приходит к тому что необходимо там сервировать данные более эффективно использовать про табов например то есть если вы посмотрите есть тенденция к тому чтобы использовать как минимум тот же про the bald сейчас уже все его используют так как максимума джипси начинает использовать либо какой-то другой протокол фреймворк для взаимодействия джипси например да или 3 ст и что хочет сказать давайте начнем с того что мы точно не хотели бы использовать 3 вт фейсбучный капан про the protocols реализации данных хороший кстати его написал парень который писал просто баф версии 2 в гугле тот вопрос где бы написать что-то свое это те варианты которые ну которые как бы хороши но у них есть проблемы мало экспертов мало экспертов по этим технологиям скажем потому что сейчас ну наверное набирают больше популярности он тот же про табов соном и нас много экспертов по работе с анандо вот таких людей у нас много вот cisco служба fierce ликопин просто людей мало инструментов мало опять же для того же сон у нас там есть postman можно по запросу постам гонять там если у нас про табов у нас есть инструменты какой то тут все под этих вот про to see вокруг него плагины вот это все есть для этих технологий скорее всего придется делать руками из теста третий пункт многое работай руками которую придется делать ну опять же хотелось от эту хочется дадут уйти чтобы делать работу руками самим хочется вот взять и залпа source готовы поэтому мы не будем использовать этот инструмент и а что мы что стоит использовать если мы хотим вот как бы быстро построить платформу если мы хотим быстро научиться это делать джи-би-си конечно о чем речь на этом можно заканчивать в принципе доклад берем джерси и живем частую вот хотел найти водичка но не нашел ладно буду продолжать дальше до gr5 это отличная но мы выкатываем она прот и получаем вот такую картину спасибо мы получаем следующие проблемы с балансировкой трафика частности купер на эти за которым мы сейчас взял и смысле мы в кубер лезть в том же самом получаем проблемы с балансировкой трафика если вот выкатываем в чистом виде ну почему так получается можно почитать подробнее вот по этой статье суть на этом графике как бы показывает что у нас один под перегружен сильно остальные вообще не нагружены и как бы эта проблема подробнее вот статье почитайте я попробую так ну кстати а много людей не знают почему так происходит давайте просто я подробно расскажу если много людей не знают хорошо тогда у меня специально для этого есть слайд собственно суть чем у нас есть какая-то железные но да и как работает купер нить из как работает маршрутизация внутри кубинца на этой железной ноги у нас есть ну понятно какая то подсистема ядра до готова отвечает за то чтобы можете жировать de happy connect и найти себе connect и и это может быть там ой опять apple сыну ну это мой певец может быть как более современное не суть главное что мы когда делаем запрос с нашего сервиса с ноты он сначала приземляется грубо говоря в подсистему ядра и в этой посетим ядра у нас мы идем на какой-то кластера api когда мы призываем поставим мы идем в класс 3 класс трапик терминах убирается это на самом деле такую виртуальная пи адрес которую у которого физические какого-то бэкенда не от эта виртуальная реальность который просто на каждую ноту записывается и дальше когда запрос идет на этот виртуальный api адрес кластера и при на уровне сам этой самой ноды мы железные машины в то есть мы понимаем на какой backend нам стоит идти себе запрос тисе пи connect приземлить и при земля ему он один из бэг-энда который за этим класс терапии кровь кроется в этих брендов своей api адреса уникальные но суть в том что кластер айпи будет монетизировать в один там из n вот этих вот собственно подав и почему это все работает и теперь 11 на году мы долгое время почему это работает http 11 котором мы использовали ну потому что на самом деле у тебя 11 очень плохо утилизирует ты себе соединения на http изначально была история что мы делаем один http-запрос и это один от 10 1 5 соединения когда запрос завершает соединение падает вот так вот . изначально был спроектирован потом там keep-alive появился и вот эта вся история но проблема в том что эти типы все равно работает достаточно неэффективно с соединениями и самое интересное что это проблема ешьте тебе дает нам возможность не думать о балансировки трафика в купюрницы потому что эти стихи присоединения они как бы рвутся появляются новые достаточно часто и постоянно происходит такая берут перебалансировка и все нормально как только мы переходим джи пи си и ну что получаем мы получаем на самом деле архетипе 2 под капотом архетипе 2 это протокола который позволяет лучше утилизировать эти соединения он там у него есть внутри мультиплексирование тоже соединения то есть много запросов через 1-го гонится и значит что значит мы можем держать только одно соединение все какие проблемы но проблема в том что так как балансировка купюрница происходит на уровне l3 на уровне api адресов и приземление типы соединений мы в итоге принимаем от соединений какой-то backend и больше она уже никогда не другой банк не перебалансирована когда например другой backend падает и все сведения с него перетекают на наш текущий backend получается перегрузка потому что назад они уже никогда не возвращаются такая вот история но в джипе сию из-за этого достаточно сложен в интеграцией да это хороший from work и про то ну да да это хороший фильм окно изначально мы вот просто так взять на голову коллекции его начать использовать мы не сможем как минимум из-за проблем с балансировкой но у джер писи на самом деле есть еще проблемы во первых это большой runtime и в этом рандами есть ломающая обратную совместимость изменения то есть есть шанс при обновлениях кода нашего примерка попасть на проблемы с обратной совместимостью runtime я имею ввиду в том смысле что у нас есть какой-то групп горя код который работает 106 типе 2 код который реализует плойку герметичность слой джер писи и все это все это например в языке гол это все как бы в одном пакете долгое время лежала но сейчас принципе здесь немножко но суть в том что они по сути это один большой пакет и вы когда генерируете код а4 как вы пишете про то схему по определенном формате и дальше по этой схеме вы генерируете код и вот этот код он очень сильно зависит от тут-то гибли отёки который рисует runtime джер 1000 если библиотека весна обновить и там что-то сломается у вас сломает сервис но это библиотека она довольно большая и этот ее величина как бы она приводит тому что там нереальное количество багов если там в языке гол мы еще можем пойти и по поводу посмотреть а что за badger писи и даже там улику я сделал да но например в том же письме и в других языках во многих runtime реализован на уровне какой то се библиотеки и разработчики в рамках этого языка вообще говоря не могут туда сходить и просто так вот посмотреть ну то есть могут понятное дело но часто не хватает экспертизы разбираться в каком-то стороннем модули ну и поэтому записи например так больше более распространён в у людей которые пишут на голо там или даже тоже на той же чави да гнар ный протокол который джерси использует под капотом это про табов и про таба он стресс на сервируется во что-то непонятное до снаружи и это что-то непонятное на самом деле довольно тяжело отлаживать здесь раньше мы все-таки могли прийти тисе пи дампом посмотреть что там у нас на сервере происходит то теперь теперь мы не теряем эту возможность и так же мы теряем возможность тестировать там пример postman отправить запрос и вот это все мы нам очень нравилось да нам очень нравилось просто случай проблем каких-то постому запросов пойти посмотреть чуть сервис возвращает тут приходится городить какой-то инструментарий да там можно кавер жарку плагин написать можно еще что то но суть в том что как то необходимо работать этим дескриптор импорта бабскими вот это все нам нам как-то нужно обеспечить но хочется да изначально как-то попробовать платформы сделать минимальной затрате фусиле и хотя я уже сказал что я считаю живописи реально хорошим инструментом и он очень популярен он становится популярность каждым днем его можно использовать в том числе вк убирается если ну похимичить с балансировкой игнорировать его уже сейчас тяжело но возможно мы можем сделать проще возможно для старта нет необходимости использовать герпесе что если решить наши проблемы тем что у нас уже есть например тот же http 11 он не приводит нас проблем с балансировкой и поэтому если мы будем использовать его под капотом то проблем с блокировка не будет а при этом мы можем взять и генерировать код просто поджечь тысячным схемам то есть вот с кем eager посещения вместо того чтобы генерировать код который тянет за собой джипе сирота мы будем использовать библиотеку языка к туру уже умеет работать сушить и т.п. и geniled небольшой кусочек кода ну и то есть получается если раньше мы работали вот с такой связка когда мы перешли к джипе там пытались использовать герпесе да мы работали вот а что тебе два порта баб и джерси схемы то тут мы приходим к такой связке мы берем и говорим http 11 потому что тогда у нас не будет проблем с балансировкой про добав мы давайте позволим просто вместо того чтобы только про добавки загонять мы будем в рамках там федора контент об загонять информацию а что мы сейчас посылаемую будем с на посылать либо потапов либо персон и все и по живописи схемам мы сможем генерировать этот код то есть от старого описания контракт наших сервисов мы не будем уходить но конечно при использовании http один мы теряем такую возможность как streaming который по сути записи streaming который позволяет общаться не только там клиенту запрашивать сервер но и серверу что запушить клиенту этот возможность мы теряем но если она не нужна возможно мы сможем жить счастливо и без нее и знаете что вот эти ребята уже все сделали twitch сделал свой протокол ну такой свой фреймворк называется тверд который реализует ровно то что я сказал суть в том что они пришли они начали используют живописи и они пришли к проблемам хоть с которыми как бы я который описал и они сделали более простую вещь которые у них работают в прозе сейчас и как бы наверное от вич достаточно большая компания чтобы поверить что им хватает той же производительности http 11 что им не нужно прямо сейчас более там эффективную работу с соединениями но при этом там все реализацию данных в прато баффи мы не теряем мы в праге можем гонять про добав в рамках там тестов мы можем отправлять на тот же самый сервис тот же самую in point ту же самую ручку что если герпесе был не вариант то почему утвердили она стала более приемлемым да потому что если были проблемы с балансировкой записи то мы возвращаемся к же теперь 11 и на уровне l3 продолжаем балансировать запросы большой runtime и баги из-за этого большого runtime а и ломающая обратную совместимость изменение решаются следующим образом нет runtime и нет проблем все что генерирует тот же twitch ideer по сути ложится в один файл то есть весь генеральный код это один файл который не имеет каких-то сторонних зависимостей и за счет этого за счет того что мы просто уберем тот же момент который мы генерировали код для жидкости берем там процессе и генерируем код но без runtime а мы и не имеем проблему гарсиа нирования в библиотеке мы не имеем проблем с versio не раване им отдельную версии про то бафа с ней вчера мы сталкиваемся но суть в том что мы избавляемся от этих проблем и самое главное что возможно во многих языках уже из коробки есть работа сочтите пи 11 и нам не нужно тянуть какие то хищные либо для того чтобы цивилизовать данных про добав например если мы не хотим в печке работы с просто бафом хотим при этом взаимодействии с сервисом который написан на головы позволяет принимать запросы формате wav твер по достаточно всего лишь послать часов до мы не будем достаточно эффективность и реализовывать данный но может быть это нам и не нужно ну и если бинарный протокол был тяжелее тестировать то сейчас у нас есть возможность использовать и soon it with which twitch из коробки работы с двумя языками это голову и питон поэтому собственно тверда заточен под них из коробки умеет генерировать код под эти два языка как кот как клиента так как от сервера но уже сейчас есть много библиотек которые позволяют все то же самое дело для других языков для роста он даже тоже есть все можно брать и использовать все готово ну мы давайте считать что вот мы пришли к такой схеме да у нас вот типе под коробкой под капотом архетипе 11 мы стерилизуем данные про то базе насколько это возможно вроде мы используем такой прибор как твер и вот тот компонент который я говорил это communications framework это то что вот эти все open source наработки встроят нашу инфраструктуру подход в это дело пигмент это дело мониторингом и метаданными логированием вот этим вот всем и в итоге реализовав вот все мы получим платформу для взаимодействия с которой будет удобно работать мне конечно фреймворк что должен добавить этот последний компонент как минимум как минимум я считаю нужно добавить метрики и трассировку мы хотим наблюдаемости сервисов что в монолите с этим было лучше сервисов уже тяжелее отлаживать проблемы если у нас этого нету rate ли митинг да мы говорим часто о том что мы должны там обрабатывать проблемы деградируя деградирую но не падая и рейки митинг это одно из вообще в принципе решили не которые необходимы для того чтобы под нагрузкой не умирать контекстуальные запросы но это суть это это о том чтобы метаданные передавать о том что мы хотим знать откуда пришел наш запрос при этом мы хотим знать о разных вещах мы хотим знать как о том какой сервис был вызывающим то есть кто нас вызвал кто как был предыдущим в цепочке вызова и также мы хотим знать я уже сказал об этом что какой конкретный пользователь сделал запрос знаете что люди тоже это уже сделали есть вот 2 ссылочки которые я очень советую почитать я очень сильно вдохновлялся курьером когда надо над этим всем думал и и все это делал курьер это бокс разработка великолепные это вся красота механика платформы для работы с сервисом в рамках дро бокса и это о том как они делают и вот отличный цикл из трех статей отель bambi о том как они готовят такую платформу для взаимодействия между сервисами очень хорошие материалы советую если интересуетесь почитайте ну и конечно говорить можно много да но хочется увидеть код поэтому прототипируем делаем прототип как вот как это должно быть сделали прототип за одну ночь на ночь она всегда да лучше чем намного длиннее чем 1 человека день поэтому делаем эту ночью чтобы вот не было истории типа сейчас на деле стенда бежать дальше там пообедать надо потом встреча там планирование вот это все ночью за одну ночь делаем берем твер пробуем использовать документация великолепно и очень удобно с ним работать попробовал завелось сразу понравилась минимальные сеты данных которые нам необходимо передавать в контексте запроса ну какие данные ну от минимально вот мне кажется request айдида нам хочется хотя бы как-то уметь эту цепочку коту запроса отслеживать и в рамках теста попробуем еще и и кто ради передавать эктор иди это идентификатор the first paty пользователя то есть пользователь который в приложении нажимал кнопку какой ну и пишем plugin то есть нам нужно генерирует код если та часть кода который отвечает за то чтобы делать запрос генерируется но мы хотим навесить еще и метрики трассировку логирования валидацию запрос вот это все и мы хотим чтобы это все было внутри нашего генерировалось другая из просто схемы поэтому нам необходимо написать процессе плагин который генерирует набор медоваров эдвард для того чтобы меня маннитола мониторинг навесит трассировку и вот очистил и это заводится то есть реально за одну ночь можно попробовать сделать вот такой минимальный прототип получается это сделать и что дальше дальше эксперимент конечно пробуем запустить эксперимент который уже в бою покажет что ну покажет насколько реально это удобно использовать собственно в рамках эксперимента что мы получаем мы пишем вот такую схему пример того как выглядит схема какой-то ручки но не ручки от мыса какого-то там сервиса например или какой-то часть сервиса в этой схеме мы описываем в том числе как каждый из полей нашего запроса будет вы лидера ваться и дальше мы запускаем одну команду до внутри мы гена будет там про то вызов протащить плагинами и получаем на выходе набор файлов давайте снизу вверх что это за файл и мы получаем файлы которые первые снизу это как раз реализации кирпа дальше мы просто это монета наша схема вылетает мы его лидируем мы хотим вы лидировать запросы если групп в городам работаешь в сон схемами мы это делаем все рефлексы или чем-то таким то есть мы пытаемся как-то ну мы пытаемся лидировать как-то запрос то тут мы берем и прям вот код валидации генерируем сразу и за счет этого за счет этого валидация начинает работать достаточно быстро то есть она реально максимальная максимально производительно работает понятно что дальше генерируется сериализация про то бафа и вот последний файл вот этот better это это как раз наш коммуникациям фреймворк это то что внутри себя содержат конструкторы и middleware для то чтобы собрать эту часть который будет обрабатывать запрос и сразу же до вешек него контекст запросу новейших или метрики до решек него трассировки а на выходе как разработчик что я пишу для того чтобы реализовать вот на сервере обработку этого запроса не нужно писать реально вот 15 строк вот это весь код на этом слайде для того чтобы на уровне как бы хендлера обработать запрос понятно что у нас есть доменная логика вот на 1 с . это домину like вызываем но вопрос о том что у нас нет никакого кода валидации там логирование вот этого всего то есть нет никакой машинерии ненужный нам в рамках вот обработки запроса все что мы делаем это вызываем домену лайков и обрабатываем ситуации как отреагировала домен на века на наш запрос все при этом ошибки уходит достаточно типизированным мы можем в ошибке завешивать например метаданные стоит ведь свалок от и клиент может этот state выловить и обработать то есть с то он видит там стоит ловко например перри повторить запрос через там 20 миллисекунд потому что сейчас ресурс заблокируй молоко до который нам нужно написать руками много кода генерируется мы экономим огромное количество времени и сил ну и конечно в итоге к чему приходим в итоге мы приходим в итоге к тому чтобы в запросе передавать достаточное количество метаданных чтобы покрыть все наши из кейс и это request айди это самая важная часть нашего запроса чтобы вот эту цепочку построить и всегда иметь возможность эту цепочку как-то раскрутить посмотреть проанализировать дедлайн дедлайн это важная штука которая позволяет нам строить редкий митинг то есть если мы знаем в момент старта запроса сколько времени на этот запрос есть мы можем а читать . во времени в будущем какому времени этот запрос должен завершить свое выполнение и дальше это позволяет нам понимает точно в какой момент запрос должен завершиться на каждом из сервисов то есть не важно сколько работает каждые сервисов . остановки 1 передаем этот дедлайн и за счет него в рамках робот каждого запроса можно смотреть там а успеем ли мы обработать этот запрос а может быть там у нас проблема сейчас с сервисом может надо его отбросить вот это вот все можно делать использует line на основе экстра директор api информация о пользователе акт ради нам нужен как минимум для авторизации запросов а как максимум экстра и директор api позволяет нам смотреть на то что послужило ошибкой ну чтоб пришло пошло причиной ошибки например какая нет ошибка которая затрагивает только одну какую-то подсветят айпи адресов имеет сразу можем увидеть женщина эти визиты ради user agent это все та же самое про наблюдаемость все еще найди это идентификатор сессии пользователя и визит ракеты . 3 ст пользователь не аутентифицирован на нашей платформе если на сайте нашим он не ответила на него экстра иди не будет а визит ради у него все равно будет мы ему должны как-то привязать этот уникальный идентификатор счет этого мы будем точно понимать что пользователь делает user-agent мы конечно хотим знать информацию о нашем пользователи ну и sorcery alabay это история про то что мы хотим знать кто был источником запроса предыдущего то есть вот я там 5 series цепочки а кто был четвертым и реал опираясь на этапе адрес этого сервиса и вот на основе этих данных мы действительно можем строить уже какую-то как решение проблем строить на основе данных знаете что самое крутое в этом всем что используя опыт собственные инструменты вы можете гуглить вас есть документация которая написана не вами и пример такой документации которым можно следовать это google слоя стал гайд для просто файлов вас practice твер по и репозиторий с огромным количеством и 5 которые делают сам google делает и как результат что он получаем простоту в использовании это просто написал схему сгинь girl code написал доменную лайку все возможность авторизовываться запроса возможности коментировать фичи об этом поговорили на схемой всегда актуальны и потому что код генерируется по схемам то есть не будет разница что с кем в одном код другу ход за друга и обтерла белить и за счет того что мы имеем полную информацию о том почему почему а о том в каком контексте произошла ошибка мы можем ее быстро решить рейки митинг мы хотим деградировать а не падать поэтому 3 митинг это важная часть вообще говоря другой сервисного мира и с возможность сказать погугли это просто невероятное невероятный плюс для того для адаптации новых разработчиков на выходе мы имеем графики которые показывают нам с одной стороны говоря сколько времени у нас сервер отработал это метрики сразу в нашей платформе заложены они генерируются как только мы генерируем какую-то ручку а с другой стороны мы знаем да сколько времени отвечал сервер и благодаря тому что мы клиента тоже генерируем мы закладываем в метрике об информации сколько времени клиент ждал ответа и если стресс на эти цифры расходятся эта проблема у нас на серединке и вот например если мы используем какую систему мониторинга ошибок на пресс центре ту же мы имеем информацию в рамках одной ошибки о том что это был за пользователь конкретно какой действие он делал какие данные он менял какой вой пи адрес был кокаин пример он пользовался версии нашего приложения на телефоне каким версии какой каким мобильным телефоном пользовался вот это вот все и за счет этого мы можем как-то там сковывать ошибки по платформе так далее все это мы видим сходу если раньше у нас были вот такие проблемы там тысячи человеко-часов потратили чтобы написать код теперь мы не пишем код на его генерируем взаимодействия merser висельник инцидент на теперь она одинакова для всех метрики логирования идеально контекст запроса метаданные передаем авторизации и аутентификации об это стирание сегментации печей всё это становится возможным платформа для взаимодействия дает возможность решить эти проблемы принципе что я хотел сказать перед тем как вы похлопать я хотел сказать что в рамках сервисов если вы начинаете строить сервисы уходите от монолита без платформы вам будет очень и очень тяжело возможно возможно вам просто не стоит изначально уходить от монолита стоит долгое время его придерживаться потому что сервисный мир он такой не всегда приятный поэтому спасибо артемий спасибо друзья прежде чем мы голодному под кассиру отдать им слово в коридор из иркутска у нас голодной мы сначала сытым из новосибирской петербурга дадим задать вопрос сначала один вопрос из москвы потом один из него cefiro из новосибирска я один из петербурга москва вы готовы поднимите руки можно свет залито не видно свет зале вот отлично побежали белить монолит послушали тебя смотри так встаем говорим меня зовут так-то и свой вопрос куда смотреть когда будут сейчас дадут 1 микрофон смотри ту ту ту ту ту ту ту ту раз-раз-раз-раз а где вы махнуть рукой здесь вот отлично поехали один вопрос из москвы так меня зовут вас за доклад артемий вот смотрите у меня быть не более 2 небольших вопроса вы сказали в самом начале доклада что вы распиливать и монолит еще не раз пили вино тем менее вас наверняка есть сервисы которые появились одними из первых и соответственно у них какой-то архаичный до подход платформе взаимодействия первый вопрос звучит так вы планируете ли их переводить на последнюю эту вашу платформу вариант платформы или же вы оставите их как есть чтобы не нарушать их работу и второй вопрос если же дальше в будущем появится другой подходит легко ли будет перейти вам из текущей платформы на новое спасибо до первого вопроса значит это отлично темы да вот сервисы которые уже были написаны до того как там принимается какое-то новое решение и всегда нужно поддерживать и поэтому сейчас есть практика попытка другая сделать схемы которые вызывают позволят нам сгенерировать код для но в таком виде в котором работают старые сервисы то есть если у нас был какой-то изначально там заложены вот какой-то протокол в sony со спецификацией давайте попробуем сделать какие то может быть даже свои схемы не просто баф не смысле не просто схемы свои схемы и по этим схемам сгенерировать уметь уже генерировать код для вот этих старых сервисов чтобы при этом по обратная совместимость соблюдалась и за счет этого уже сделать первый шаг платформе и собственно такое решение мы делаем до второй вопрос я уверен то что я забуду на java забыл собственно давай еще раз повторять по моему прыг-прыг а все если вдруг выйдет новое решение легко ли перейти до перейти если тебя есть схема но решение это что такое это какая-то реализация скорее всего если есть схема и реализацию можно менять в этом и преимущества так как вот основной point мой что друга леджер писи популярен просто схемы реально популярные и если мы используем просто схему мы можем там реализацию под капотом менять при этом контракт соблюдать вот так спасибо отлично новосибирск все внимание на экран да да о класс у вас уже стемнело система у нас есть целая один опрос да я иду я иду человека который его задал вот держи твой вопрос приветствоваться доклад меня зовут михаил у меня вопрос такой я правильно понимаю что все эти штуки которые вы будете гиней которые называете платформы в итоге залезут в бинаре каждого отдельного сервиса если да то как вы будете заставлять команды принять новую версию то есть как раскатывать потом добили допустим tracing от racing от такая штука которая разваливается если кто-нибудь посередине не обновился как бы вылетают организационную проблему чтобы до всех доезжала очень свежая версия и как сделать так чтобы при этом один баг не развалил вообще все сервисы сразу спасибо ну как сделать чтобы один баг не развалился сервис сразу это я наверное отвечу конечно а как а как сделать так чтобы ну дам или конечно лингу и за все в бинаре но понятно что люди с одной стороны там трассировки которые можно достичь просто навешиваю про прокси уставе между сервисами это трассировки как бы вот как раз сервис меж это решение проект поставим практику будем трассировки делать на уровне вне сервис в небе моря и обновлять их на уровне инфраструктуры но а трассировки есть не только вот между не для запросов между сервисами например тебе нужно трассировку сделать на то сколько времени твой запрос база выполнялся дрессировку на то сколько у тебя какая-то функция выполнялось и какой-то там участок домен на логике мне за подсчета чего-то и это все тоже можно и нужно писать трассировки потому что в этом случае ты будешь видеть в итоге полный профиль то его запроса при решении проблемы и вот это кроме как внутри сервиса реализовать нельзя а значит тебе нужен какой-то этот рейс айди по которому тебе нужно все связать и то есть эта платформа это не про то что тебе ничего не нужно делать снаружи эту про то что у тебя есть возможность сделать многое сделать внутри вот спасибо новосибирск перемещаемся в культурную столицу санкт-петербург привет снова задайте ваш вопрос и лет москва здравствуйте новосибирск у нас есть вопрос от участника пожалуйста представьтесь и задавайте здравствуйте меня зовут артур у меня вопрос по поводу репозиториев как госкомпании в общем все сервис в одном репозитории ли в разных и соответствии с этими схемами если смысл их класть в один репозитория все схемы там для компаний или они в сервисных проектов и ну есть более глубокий вопрос связан с этим что там есть bounded контекста да и одна сущность там может быть более сложной в разных модулях там и нам валидации может не применяться для от правила валидации могут не подходить 1 раз сложнее 2 до вас слышно я просто отдел набираю на пробу я забуду второй вопрос из трех задач первый вопрос по поводу с тем есть два разных подхода это типа да иметь общий репозиторий схем иметь другая схема каждому сервисов попробуйте попробовать стоит как вам зайдет каждый делать по-разному у нас сейчас есть но подход мы думаю ну как бы подход когда мы схемы и кладем в репозиторий сервисов для того чтобы эти схемы могли круга рядом меня меняться в рамках сервиса при изменений версии смогу сервис вот примерно так но стоит просто попробовать как вам будет удобней и вторая часть вопроса ровно то вы говорили про ищите pit-11 да давайте попробуем на 10 лет вперед заглянуть когда будет там еще 34 как вот какие мысли в этом плане не будет ли это слишком устаревшим теперь htc петри все будет просто великолепно потому что quik привносят нам место tcp соединений youtube и соединения которые великолепно балансе цыпа на уровне l3 поэтому с 6-ти петри там как бы вопросы будет другие будут вопросы скажем так куратор кстати неплохо них рассказывали ребят из кураторов каком докладе я не буду как бы пересказывать от села но суть в том что там меняется концепция теперь коннекторов поэтому говорить не стоит сейчас об этом артемий пасиб большая петербург новосибирские москва спасибо отлично"
}