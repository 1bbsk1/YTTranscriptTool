{
  "video_id": "Pm8PONakdP8",
  "channel": "HighLoadChannel",
  "title": "Внедрение YDB CDC на примере Yandex Monitoring / Егор Литвиненко (Yandex Infrastructure)",
  "views": 316,
  "duration": 1531,
  "published": "2024-04-17T01:10:18-07:00",
  "text": "слышно меня да Всем добрый день будем говорить про этот Давайте немножко Познакомимся с вами сначала Кто знает что такое я тебе много рук а кто использует сейчас я пытаюсь увидеть кого-то не из Яндекса Так а кто знает что такое cdc Для чего нужен кто использует не обязательно там я тебе вообще как технология руки руки несколько человек есть Спасибо так кликер Меня зовут Егор сейчас проверяем да меня зовут Егор я работаю там занимается всем от центра обработки данных для разработчиков и часть этой системы Яндекс где собственно работаю я мы будем разбираться как обновлять данные в сервисах по сути задача очень простая это сервис инвалидация кэша так познакомим Она обычно звучит людям И для этого мы будем использовать adbcdc поэтому мы научимся ее готовить это план доклада теория практика использования что пошло не так итоги начинаем с теории Яндекс мониторинг сразу цифры 700 миллионов этих секунду это то сколько у нас сейчас записывает поток данных мониторинг понятно это система для того чтобы пользователи могли мониторить кто мониторит свои сервисы хорошо 700 миллионов секунду это 8,5 ГБ данных в секунду чтобы понимали храним шесть половиной петабайт 8 миллионов лет и каждую секунду считаем около 150 это могут быть прям какие-то программы люди там пишут для того чтобы себя что-то посчитать и как звучит задача есть какой-то сервис Он запущен на тысячах нот у этого сервиса есть конфиги хранятся в базе данных таблица таблицы между собой связаны и образуют иерархию каких-то там приоритетов настроек и так далее они меняются редко потому что их меняют люди вручную через Контрол плейн и мы хотим чтобы ноды быстро забирали изменения этих данных почему это важно я потом объясню как мы решали эту задачу раньше Мы решили раз таблицы маленькие давайте мы просто их будем перечитывать по таймеру так будет делать каждая нода можно для этого использовать Селект и но в есть специальный механизм Я table которые позволяют вам таблицу вычитать распределенную и у нас были вот такие вот лаги доставки пол это две минуты потому что таймер приходилось увеличивать Извините таймер приходилось увеличивать интервал чтобы снижать нагрузку и там уже доходило до двух минут и плюс или ты был из-за того что нагрузка большая много начинает расти на несколько минут этого у нас две три четыре минуты загружались данные когда она не загружается настроек Нет это может влиять на то что у пользователей потом дырки на графиках в результате поэтому для нас важна эта Метрика мы загружаем всякие таблицы таблицы между собой логически связаны при этом нет никаких форм Kiss они меняются все в разных транзакциях и они постоянно растут потому что приходят новые пользователи как обычно решается эта задача как обычно лишается эта задача Кто не знает наверное все решаете как-то Это задача да Да хорошо посмотрим с точки зрения баз данных на это базах данных есть семейство подходов называется словно Dimensions речь идет о том что мы имеем какую-то таблицу и добавляем какие-то данные которые будут хранить изменения в этой таблице там их несколько типов от 0 до 6 чем больше тип тем больше данных дополнительных у вас хранится для этого всего нужно дополнительные данные индексы для этого скорее всего вам пригодятся триггеры чтобы обрабатывать и так далее выглядит это может как-то так У вас есть таблица Вы из нее читаете по какому-то интервал времени с каким-то темпом Что изменилось может быть кому-то это выглядит знакомо триггеры все деби нет Давайте другой подход рассмотрим логирование транзакций в базе данных может быть кто-то слышал мессик ли есть белок в пост версии если он часто используется для той же цели выглядит это как-то так можно посмотреть какие файлы что в них лежит читать вы сами не будете скорее всего потому что есть готовы технологии Типа дивизиум вы настраиваете кафку настраиваете все это между собой и вас все изменения из бенлога сами будут перекладываться Как вы потом будете читать здесь мы получим новый брокер надо подписать код на клиентах настрой дивизиум вот такой подход если мы пишем в очередь то мы можем и сами это можно назвать сортингом когда у вас много пишет в базу вы сами пишете что-то в очередь и потом читаете и здесь вы сами будете гарантировать каким-то образом целостность между базой данных и очереди и попишите код для того чтобы что-то писать что-то читать и наконец через это captcha с одной стороны это семейство подходов термин который бывает реализуется через все то что я сейчас перечислил с другой стороны иногда эта технология встроена в базу данных Например я тебе и тут можно глянуть подробнее схема будет такая что вы пишете в базу данных уже вам не надо писать код для писателя для продюсера база данных сама перекладывает очередь каким-то образом предоставляя какие-то вам гарантии Там и вы из них потом читаете вы сообщение об изменениях если сравнить потому сколько пописать кот или избыточность данных в таблицах то получается cdc здесь самый простой вариант особенно если ваша база данных его поддерживает я тебе распределенная база данных и в ней есть очереди что для нас важно ими можно пользоваться отдельно как брокером А в случае среди bbcdc у вас получается что Это какая-то связка таблицы и очереди и база данных сама отвечает за то чтобы туда перекладывать все изменения в этом случае таблицы и очень депортированы одинаково соответственно масштабируется все записи в очереди идут асинхронно поэтому записи в таблицу не тормозят У вас есть гарантия на то что порядок изменений в очереди такое же как в вазе для прямо реки есть exect levance внутри базы между очередью таблицы и ТТ по умолчанию 24 часа вот такой пример сообщения чтобы можно было представить этот же сон там есть признак апдейт Это значит что что-то изменилось не имеешь это все ваши колонки их значения какие это ключ и вы получаете такую схему что-то пишете в таблицу потом читайте из очереди это теория есть практически вопросы здесь вот у нас есть схема мы с ней читаем сообщения из очереди в этой очереди есть такое изменение но нету самой таблицы изменение это к чему-то применить Значит нужно первый раз загрузить таблицу мы можем для этого использовать Select и так делают некоторые технологии дядя Биби мы можем сделать также Retail как мы делали раньше и Тогда ваша схема уже превращается в такую что вам сначала нужно прочитать ли Table только потом читать изменения делает ли Table каждый раз на старте и вы получаете такую ситуацию У вас есть пользователь таблица но да пользователь что-то пишет какое-то время надо начинает делать Table пользователь продолжает писать операции идут идут и возникает вопрос что из этого увидите Table который загружает вашу таблицу первое увидит точно все это будут разные транзакции и нам это надо увидеть прочитать скорее всего как-то через сидите все эти изменения тоже и мы тут воспользуемся виртуальным таймстепами это такая штука она уже вернется вместе с литейблом и можно ее получить вместе с сообщениями тоже если там включить заранее этот настроечку что это такое Это пара чисел такое искусственный таймс Темп координатор Time это время на специальной ролевой db транзакшн ID Это номер транзакции который выполнил операции и вот эта штука вот эта пара чисел позволит вам все отфильтровать отсортировать чтобы понять где Что было что было последним что было первым сообщение это выглядит вот таким образом добавляется маленький TS внизу из двух чисел и нам остается решить когда подключать cdc после Table может быть надо начинать читать виртуального таймс темпа К сожалению наш клиент этого не умеет У нас свой клиент сейчас и поэтому надо использовать обычный стенд на то время когда детей был начинается минус лак получается cdc будто бы подключился в прошлом Все изменения Идут ли ты был идет и мы через cdc по виртуальным темпом выбираем что у нас было последним другая проблема вот у нас есть таблицы они связаны между собой с точки зрения логики это вот так выглядит с точки зрения очереди это выглядит вот так 4 параллельные очереди и вас может быть ситуация что приходит шарт приходит проект а не логически между собой связаны но шаг приехал на ноду первый проект такого еще не существует как-то нужно гарантировать целостность Как можно поступить можешь сделать очень просто читаем сообщение cdc на лету валидируем все связи создаем такую сущность агрегат если состояние невалидное не используем и ждем когда придет следующее сообщение и поменяет наше состояние иначе можно что-то перечитать и так будет работать Идем дальше вы здесь пишете один раз и читайте один раз если НОД много то читаете Вы много раз тысяча нот в тысячу раз умножили трафик в ADB есть лимиты cdc по умолчанию это 2 мегабайта на подписчика есть подписчиков на очередь 5 очередей на таблицу 100 мегабайт на ось на таблице в общей сложности здесь можно было поступить по-разному у нас так получилось что когда мы делали cdc интегрировали команда я тебе как раз разрабатывала cdc поэтому мы могли протестировать свой сценарий и сделали так как делать не надо было Мы решили раз обновление редки давайте мы все полторы тысячи подписчиков Вместо 10 на одну очередь подпишем и все правильно было бы зеркалировать сталкивались может быть когда там одна очередь в другую дублируется таким образом умножается трафик Это довольно запутано поэтому хорошая новость в том что сейчас это сценарий уже тоже поддерживается полностью можно подписать полторы тысячи Но тогда что-то пошло не так как оно бывает Представьте что мы потратили пару месяцев на то чтобы это все сделать запустили на продакшене получаем вот такие вот персентиля это четыре с половиной минуты то есть стало вместо двух-трех минут стало четыре с половиной минуты Победа начинаем разбираться первая проблема Это то что мы перезагружаем ноды это принципе не проблема ноды первый раз грузят таблицу поэтому это долго и первые и Верхняя персентили они всегда такие большие это нормально там все персители были плохие Мы сели пока валялись посмотрели померили перфом и поняли что проблема в том что мы подписали полторы тысячи подписчиков на очередь хотя там ожидалось больше десяти и есть CPU тратятся там на подсчет специальных счетчиков это поправили лежит другая проблема которая тоже бывает если вас успел запрос тяжёлый ресурсы которые нужны для пользовательских запросов и для сообщения одни и те же Поэтому если у вас тяжелый запросы тормозит будет надо запросы оптимизировать либо таблицу позиционировать либо ядра добавлять у меня тут много qr-кодов потом посмотрите другая проблема массовый листа Представьте что вы в один день взяли нажали кнопку Или стартанули вверх ваш кластер и он пошел грузить первый раз таблицу операция долгая у всех тайм-ауты кластер не может подняться что здесь нужно делать нужно проектировать систему так чтобы вы понимали в любом cdc и первая базовое Что нужно сделать это добавить Просто литраж если ваша нагрузку база данных вытягивает рано или поздно кластер поднимется Если нет то нужно придумать что-нибудь чтобы ограничить количество нот за окружающих таблицы одновременно какой-нибудь симфор либо с помощью по-разному вот так вот другая проблема тоже со стартами связано Представьте что вы стартанули ноду и все висит ошибок нету Просто все хорошо но сообщение нет здесь нужно немножко узнать как работает балансировщик чтение для очередей когда нода хочет почитать очередь она идет в этот балансировщик там записывается Что есть такой-то консьюмер с таким-то именем он хочет читать определенные партиции балансировщик Говорит хорошо читай после этого уже идет чтение если по какой-то причине вы сделали Kill минус 9 своему сервису Или он просто умер у вас сессия не закрылась и она осталась на балансировке потом надо поднимается идет заново и балансировщика появляется два одинаковых подписчика с одинаковым именем потому что для него это нормальный сценарий он должен разбить распределить кому назначить партийцы Если кто-то хочет стать одни и те же птицы значит он думает нам все равно и поэтому выбирает Случайный если вам повезло случайно Это ваша новая сессия и вы все получаете если не повезло то вы висите несколько минут пока на балансировке не уйдет старая запись только после этого вы получите все данные несколько минут висеть мы не можем Поэтому нужно на клиенте настраивать клиентский кипила преодолел тайм-аут чтобы такого не отхватывать еще одна проблема это методы чтения у вас может быть Select у нас vitable Select тоже есть есть еще cdc получается 3 метода чтения форматы могут быть разные где-то про Табу где тот же сон единая библиотеки нет для того что все это прочитать и кто-то может забыть добавить колоночку из-за чего данные Разойдутся поэтому здесь нужно добавлять тесты можно прям в тестах У нас сейчас так сделано поднимается локально я тебе в него что-то пишется прогоняется читается другими способами проверяется что поля заполнены и все хорошо также стараться не фиксировать код и иметь какой-нибудь флаг рубильник который Вам включит один Метод чтения у нас Зачем он вам пригодится если все хорошо конфликт с очень маленьким лаком будут совпадать если все плохо то вам нужен механизм который синхронизирует все ваши ноды и дата-центры плохо может быть из-за проблем в коде или из-за других известных проблем чтобы находить здесь расхождения в вашем кластере его нужно мониторить для этого на метрике сервисе на метрике сервиса нужно смотреть на задержку за доставки сравнивать время последних событий на разных нода чтобы находить отставшие ноды следить за пропускной способностью вашего кластера И ошибками обработки на стороне vdb есть разные стандартные метрики которые можно посмотреть загрузку по топиком вот так вот выглядит наш борт и того что мы получили все таки слогам слогам получилось вот так сейчас у нас доставляется изменение за 50 секунд Все изменения доходят на ноды это дополнительный бонусом в два раза на самой базе данных то что мы стали меньше грузить гораздо и получили мы такую сейчас инсталляцию полторы тысячи подписчиков на очередь 6000 сообщений в секунду 80 мегабайт в среднем трафик в пиках там бывает до 200 МБ несколько сот миллисекунд это персентиль наш и два раза упала загрузка по CPU сейчас мы планируем еще больше таблиц переводить на cdc есть возможность в я тебе протестировать среди синие желтый был скан вместо литейбла то есть полностью через и получить все данные думаем проверить я тебе языково-2 вместо нашего клиента и в самом cdc планируется сделать консистентность между очередями это может для целостности транзакции и эфемерных подписчиков помогут и того таким образом рассказал как мы реализовали нашу доступность это все по поводу того что мы можем обсудить дискуссионной зоне зачем зачем cdc Если другие варианты можно ли еще быстрее как-то доставлять изменения на свои ноды Что делать если вы вас нету и буду рад вашим вопросам Если нужны такие доклады Вы можете вот там вот отметиться на голосовании Да спасибо большое за доклад друзья перейдем к вопросу вот сюда микрофон пожалуйста Спасибо за доклад У меня вопрос по одной из последних картинок 99,8 Почему не показал там совсем все плохо или просто ты рассказывал что если стартовыми сервиса если надо где-нибудь стартуется то она загружает первый раз таблицу это будет долго Поэтому А мы на этом же графике Первая загрузка таблицы поэтому там всегда вот эти спайки возможно Ну то есть мы берем ситуацию Когда у нас нет рестардов соответственно ещё вопросы зала Вот вот там вот Да спасибо за доклад А подскажите пожалуйста они планируйте ли делать Извините тут что-то пролетело Можно повторить Не планируете ли делать чтобы постоянно при ошибках либо Ну инициацию сначала сразу не делать например сетевая или еще что-то чтобы можно было как бы данные из прошлого достать как сделано в какой например по поиск откат там по Ну виртуально Правильно ли я понял что вы спрашиваете не планируем ли мы через cdc прочитать по виртуальному таймс темпу да да чтобы если например у нас там сетевая ошибка случилась и например cdc разорвало и там на всего лишь там ну минуту там даже две даже если на час чтобы мы заново полный искан таблицы не делали а просто как бы из прошлого прочитали и всё потому что ну как виртуальном у нас сейчас так сделано Ну то есть мы читаем не через виртуальный Темп мы читаем через Темп но у нас сделано так что клиенты и если там что-то разорвалось он сам начинает пили стартовать себя и докатывается потом сообщения Нет ну там же полный этот как его ритей был полный происходит только на старте Спасибо пожалуйста микрофон Здравствуйте спасибо за доклад коротенький вопрос простой А до этого то есть выгружали на каждую ноту просто все таблицы еще так Ну если вопросов из зала больше нет Егор было три вопроса нужно выбрать Два лучших Давайте первый вопрос который задали и вот молодой человек по поводу как раз тебе хорошо Helper пожалуйста помогите и Егор также Вот здесь на первом ряду да Да Егор также для тебя у нас есть подарки подарок от онтика и подарок от Группы компаний ВК умная колонка Маруся Еще раз спасибо большое за доклад если у кого-то остались вопросы их можно будет дискуссионной зоне в кулуарах на выходе Спасибо за внимание"
}