{
  "video_id": "u1KpLxN-owg",
  "channel": "HighLoadChannel",
  "title": "Репликация между SQL- и NoSQL-базами данных туда и обратно / Александр Горякин (Tarantool, VK)",
  "views": 230,
  "duration": 1746,
  "published": "2023-10-06T07:15:20-07:00",
  "text": "а Всем привет Меня зовут Александр Я разработчиков представителя Тарантула и Сегодня мой доклад посвящен репликации между SQL или Новой скел базами данных Но сперва я хотел бы задать два вопроса Первый поднимите пожалуйста руки те кто в своем проекте использует более одно более одного хранилища более одной базы данных а теперь поднимите пожалуйста руки те кто задумывался о том как бы синхронизировать данный между этими хранилищами Вот именно синхронизации данных мы сегодня поговорим начнем мы с постановки задачи то есть какая цель перед нами стояла Какие требования поговорим про вариант интеграции баз данных посмотрим решение на основе одного из вариантов это стихи поговорим про одно из решений более подробно итоги Какая задача перед нами стояла перед нами стояла задача переливки данных между разными хранилищами в разных конфигурациях то есть там sqli новый SQL хранилище и комбинации могут быть разной то есть из-за новой SQL или наоборот например Какие требования были самое основное требование это низкий Лагер репликации то есть время между тем когда запись попадает в источник и когда она попадает приёмник он должен быть где-то порядка 40-50 миллисекунд Кроме того должна быть низкая нагрузка на базу данных источниках так как в основном большинство наших клиентов Это либо банки либо Телеком то есть интерфейс то система чаще всего бывает высокая нагруженные дополнительная нагрузка на источник Может в систему просто отправить разнос Вот кроме этого если в момент пиковых нагрузок решение также должно быть устойчиво к высоким нагрузкам то есть там лак репликации должен быть примерно постоянным и система должна быть отказоустойчива то есть случае если у вас упала сеть либо там перезапустилась виртуалка или машина с решением да то при восстановлении сети при перезапуске все должно продолжить штатном режиме какие варианты интеграции баз данных есть мы рассмотрим три основных это etline ctc есть еще также комбинации которых мы касаться не будем начнем с Китая трансформу наиболее универсальное решение которое можно реализовать на любой базе данных то есть мы берем из источника с помощью некоторых это выгружаем всю информацию которая есть некоторые человек читаемый формат и с помощью другого сайта загружаем всю эту информацию а плюс этого решения в том что механизм универсален то есть сделать там Селект всех записей на любом можно на любом хранилище и выкрутка происходит человек читаемый формат То есть если он или еще какой-либо но есть и минусы минусы основной самое главное это в том что есть дополнительная нагрузка на источники как мы делаем по сути Full Scan на приемник нагрузка у нас будет в любом случае то есть при любом раскладе потому что мы должны загрузить данные Кроме этого etl отличается низкой скорость репликации пока вы выгрузите все данные промежуточный формат потом загрузите приёмник пройдёт очень много времени это ведёт к тому что лак репликация у нас огромный а кроме того Так как происходит выгрузка в промежуточный формат да то есть некоторые промежуточные представления то нам для хранения этого промежуточного представления требуется большой объем диска если мы посмотрим на минусы то на самом деле мы понимаем что данное решение нам не подходят случае высоко нагруженных систем Давайте посмотрим следующий вариант следующий вариант это change Tracking change Tracking состоит в том что изменения в источнике они записываются некоторые журнальную таблицу которая учитывается некоторым сетом и данные загружаются приёмник плюс данного решения в том что во-первых мы стримим изменения из источника и Как только они попали в эту промежуточную журнальную таблицу да то скорость репликации за счет этого довольно таки высокая и достигается низкий лак но при этом есть и минусы во-первых все изменения приходят в виде Дельта то есть мы не получаем записи до изменений после изменения Кроме этого не все базы данных умеют делать это из коробки то есть какие-то умеют какие-то Нет там где это сделать невозможно из коробки нужно придумывать своё решение например а следующий минус это то что за счет того что мы делаем выгрузку из промежуточной журнальной таблицы то есть по сути делаем селектор У нас есть дополнительная нагрузка на источника на прием и на приемник и гарантии консистентности в данном случае для каждого кейса свои так как база данных источники приемники могут быть могут отличаться журнальные таблицы также может быть разные такая же Окей с Поэтому данное решение подходит нам очень хищно за счет того что во-первых изменения то есть стриминг из источника У нас есть высокая скорость низкий лак но здесь дополнительная нагрузка поэтому это решение отменить следующий вариант и собственно которым мы остановились это сидихи в случае Все изменения которые происходят в базе данных они записываются журналы опережающий записи то есть так называемый Райдер и за счет того что есть вот этот журнал Да мы читаем изменения из него то есть мы с помощью некого читаем изменения из-за райта хэтлога причем можем либо читать напрямую либо по репликационному протоколу И после этого загружаем изменения в источник плюсами данного решения является то что во-первых все изменения нам приходят полностью то есть мы знаем как выглядела запись до изменения как она выглядит после изменения за счет того что мы читаем валы у нас нет нагрузки на источник и также за счет этого достигается Так мы стримим данные достигается высокая скорость репликации низкий лак и у нас гарантируется консистентность данных за счёт того что мы используем по сути репетиционный протокол то или иной базы данных из минусов только дополнительная нагрузка на приемник но она я уже говорил будет всегда потому что мы должны как-то эти изменения записать приём а какие решения на основе cdc мы рассматривали так как большинство заказчиков это чаще всего банки то у них основной стек это Oracle плюс Java вот для орла есть такое решение которое называется оркл Golden Gate то есть решение позволяющее извлекать изменения из ряду логов соответственно данных плюс пишется библиотека userjet которая позволяет переливать изменения в приёмник Из плюсов это решение работает очень быстро но оно сложно в настройке оно дорогое то есть там лицензия стоит пора десятков тысяч долларов лицензии Голден гейта и работает только 40 км то есть решение не является универсальным а второй вариант это аналог Golden гейта называется IBM info сфера cdc то есть Golden Gate для ibmw он также быстрый но сложный дорогой и только для добывав поэтому мы данное решение отметаем Какие еще варианты есть вариант самому реализовать 10 взять библиотеки например указаны здесь Да это поговорка то есть библиотека которая позволяет парсить протокол Познер и логической репликации и реализовать на их основе там на гошке приложения из плюсов мы понимаем как это решение работает то есть так как мы пишем его сами но решение Хорошо для конкретной задачи потому что чаще всего такие решения используются нужно очень быстро на коленке сделать какой-то прототип который поможет вам перелить данные из источников приёмник и забыть вот из минусов для разработки полноценного решения требуется очень много времени то есть чаще всего да когда нет готовой библиотекта нужно соответственно писать библиотеку реализовать решение и потом его как-то поддерживать данное решение чаще всего является Не универсальными потому что нужно там для конкретного проекта быстро сделать и потом возможно вообще забыть про это решение или отдать его заказчик и так как вы делаете решение часть всего Под каждый проект то со временем У вас появляется зоопарк таких решений то есть там один проект и их становится сложно поддерживать то есть там доработки улучшения какие-то это уже занимает очень много времени мы у себя иногда используем такие решения и есть на самом деле решение которое более универсальное но остановились мы всё-таки на следующем решении а почему дибил теперь написан на Джаве стек наших заказчиков чаще всего это Java Возможно даже какая-то Legacy то есть там в старых версий типа 5 6 Вот Но также в депежи ума есть несколько основных компонентов позволяет довольно просто его используют первый компонент это собственно коннектор то есть коннекторы к источникам изначально они работают поверх коннекта но есть библиотека которая называется depedium baid Она позволяет строить коннекторы в ваше приложение То есть если вы делаете приложение например на фаренгей или корпусе то Вы спокойно можете встроить эти коннекторы в него и потом как-то конфигурировать и сделать более-менее универсальное решение а когда мы познакомились теперь на тот момент не было этого решения сейчас же оно появилось называется depetium Server То есть если вы не хотите разрабатывать свое приложение Да вы можете взять Готовое решение от команды дипетиума и воспользоваться им и добежим сервер своей поставки содержит также Синг коннектор то есть коннекторы приемником который позволяет вам сливать информацию смотрят на такое количество компонентов Мы подумали что Сейчас возьмем в принципе почитаем документацию и довольно быстро сделаем решение Это было года полтора назад мы хотели с помощью дивизиума заменить Golden Gate дорогой в принципе его можно как-то дорабатывать мы начали делать предложение и как новый коннектор теперь умеет две вещи это читать с помощью читать изменения с помощью Но на самом деле три он еще умеет жрать деньги Почему Потому что чтение ряду логов с помощью логмайнера ведет за собой следующие грабли первый логмайнер он не стабилен то есть какой-то момент он может прислать вам сообщение да помимо дм Эль которое вы не можете коннектор не может распарсить и соответственно решение Может просто прекратить свою работу второе локмайнер не прикиньте то есть последних версияхла логмайнер не может стримить данные как это было раньше и спецификации меняются от версии к версии а если работает то Почему бы нам не использовать экстрим Да экстрим Мафия есть же еще одно Решение вот здесь как раз момент про то что он ест деньги экстримать работает по лицензии Golden Gate то есть на самом деле если мы будем использовать Extreme Mafia мы ничего не выиграем то есть что покупка Golden гейта Да что покупка лицензии чтобы стримить данные а это первая грабель на которой мы наступили и мы ушли где-то на полгода думать так у нас же было некоторые прототип Да но не знали в принципе где его применить больше и через полгода Мы решили сделать то есть вернуться к этому прототипу и попробовать на чем-то Чуть более простом настройки Чуть более доступным попробовали на примере после данное решение мы решили сделать более универсальным так как в изначально мы парсили табличку которая была в принципе захорошена прототип Да здесь мы сделали упор на универсальность на выходе мы получили монолитное приложение которое содержит в себе несколько сортовых коннекторов и позволяет стримить данные в нашем случае использовать Коран Вот но лак репликации при этом было очень высокий там в районе нескольких минут и лак рос пропорционально количеству записи чем больше записей нам приходила тем выше словил флаг одной из причин этого было то что записи нам приходят Джейсон это следующая проблема с которыми мы столкнулись и мы решили начать попробовать решить проблему с высоким благами репликации Да мы пытались его уменьшить первый вариант который мы придумали Это мы отправляем данный приемник но не дожидаемся ответа от приёмника что изменения применилось а Проблема была в том что когда мы начали смотреть логи таранкала то мы увидели что данные то нам приходят не в том порядке в котором они идут из источника А вообще в разнобой то есть и применение Все изменения применяются разнобой это ведет к тому что мы получаем не консистентность данных то есть нам в лучшем случае записи будут вставлены в разном порядке да в худшем у нас могут прийти например операции Элита раньше чем операция несёт и приемник это просто не обработает вторая на второе решение это проблема даже которую мы столкнулись это Джейсон так как запись приходили уже сегодня на парсинг Джейсона тратится довольно много времени мы решили перейти от Джейсон Кафка сорта потому что нативный формат крафтил бинарный и время на его парсинг тратится намного меньше это привело к тому что мы смогли уменьшить лак репликации Но он все равно еще составлял несколько минут то есть немного мы его уменьшили но не до того значения которые хотели получить данные у нас посылались в одном потоке соответственно когда мы получали в том же потоке в котором мы получали их из приёмника и при этом отправки расслабь по одной записи изначально мы решили собирать данные в матче Да и отправлять эти почины приемника на приемники их уже как-то обрабатывать это позволило нам примерно в полтора-два раза снизить лак репликацию но опять же он занимал там минутой секунды но никак не десятки миллисекунд и за счет того что мы нас отправка происходила в одном в том же потоке в котором мы получали данные источника А мы решили разнести эти две операции по отдельным потокам то есть разделили поток приёма из источника и порог отправки в приёмник то есть батчинг и отправка происходили в отдельном потоке между этими двумя потоками мы использовали некоторые транспорт Там очередь или канал который позволял нам собрать батч нужно в размер там например 500 записи до 2.000 более-менее приемлемый размер это позволил нам достичь лагарификации в районе 45 секунд следующая проблема с которой мы столкнулись Это отказоустойчивость почему у МП удивительного есть проблема с откозоустойчивостью он хранит офсету то есть некоторые чекпоинты записи которые он прочитал датчик poin там является либо лсн либо это будет век записи Но конечно это файле по умолчанию файл машину с инструментом Да очень легко зайти в принципе случайно удалить или он хранит их в Кафки Кафка может быть в какой-то момент недоступна и в случае если у нас нет ни файла ни Кафки то есть мы не можем прочитать последний абсцесс то наше решение начнет перечитывать Все изменения из источника заново по новой что-то создать дополнительную нагрузку на как на источник а мы решили хранить абсеты в приемнике То есть когда мы отправляем батюшка у нас автоматом сохраняется офсет для каждой записи И после этого при старте мы можем это встать Вычитать чтобы Вычитать офсет было написано хранилище апсетов то есть отдельный класс для невериума который высчитывает абсолютно при старте и начинает стартует уже получил следующая проблема Это ошибка запись в приемник То есть может получиться Так что записи приемник у вас может быть шортирована и записи пишутся но когда они записываются части изменений может применяться а часть нет причем могут быть пропуски из коробки То есть он будет писать файл и это плохо то есть по сути он скажет что вы применили изменения которые на самом деле изменений Не применили вот мы делаем повторные попытки записать бачты если у нас запись изменений Не смогло мы не смогли его применить то мы возвращаем лсн этой записи да и с этой записи начинаем повторно отправлять батч это позволяет нам гарантировать консистентность приемники для чего вообще хранить офсету предположим У нас вот есть устройство есть исходная база данных есть репликатор то есть приложение которое получает изменения из источника и кладет их в нашем случае карандал а вот предположим Тарантул шарнированный есть здесь показаны изменения это инфер И апдейты причем insert зеленым показан те изменения которые применились красным те которые не применили Да изменения идут в правом порядке в котором соответственно они представлены может получиться Так что у вас там Например одно изменение применилось Потом три не применилось Следующий применилось там последние не применил в случае того как это работает с коробки вы увидите что у вас лн будет последнего примененного изменения а Возможно даже не применённую то есть последствия если сделать ретрая Да и сделать хранение для каждого шаровка вы Представьте прочитаете минимальный офсет который был то есть минимальным лсрном и сможете по новой накатить изменения это гарантирует консистентность также ретраи тоже То есть если на каком-то шаров произошла ошибка мы об этом узнаем и с этого лсм начнем посылать новые бачи и последняя проблема это монолит то есть приложение у нас получается монолитном с одной стороны у него есть плюсы то что коннекторы доступны из коробки да мы их подключили у нас уже все коннекторы и его очень легко настраивать Если вы используете там спринг или кваркус вам достаточно указать профиль конфигурация описать подключение там к источнику приёмнику в конфигурационных файлах и приложении но есть и минусы во-первых это решение сложно масштабировать то есть у нас есть два потока один считает изменений из источника пишет приёмник и всё как бы мы не можем масштабировать это приложение изначально на Несколько сайтов если источник нужно как-то вручную запускать новый инсонсы или там либо вручную либо там антиблог например на нескольких машинах Кроме того любое изменение как сорт коннектор так и хендлера который будет получать изменения которые получать изменения пишет их в приемник приведет к тому что вам нужно перебирать ваше приложение чем больше изменения Во власти тем больше тем большее количество раз Вы собираете ваши приложения это не очень удобно поэтому мы решили воспользоваться ещё одним решением от дебириума это дивизиум сервер он содержит себе сорт коннекторы то есть коннекторы базам данным источником также он содержит коннекторы то есть коннекторы приёмником а внутри вот эта коробка Да она по сути реализует тот функционал который мы сделали а что это нам дает Какие плюсы у него есть во-первых люди бежим сервера есть готовые сборки То есть вы можете пойти на сайт недвижимого и по сути скачать просто дистрибутив и запустить его там конфигурация в одном файлике вы указываете источник приемник и запускаете есть возможность легко Добавить новый сорт коннектор то есть там поставки берем сервер Насколько помню идут два коннектора это Майское или позже Вы можете добавить там коннектор корку коннектор к мсq Почему угодно то есть вообще любой коннектор которого нет в поставки и это позволяет также вам создать например собственный коннектор к вашей базе данных которая вам нужен как мы это сделали для трампала и можем спокойно тестировать мы подкладываем коннектор в папку с библиотеками недвижимом сервера и он запускается вот конфигурация очень простая то есть в конфигурационный файл этот Файлик по сути Application Property с которой вы прописываете источник приемник и параметр подключения и дальше скребком запускается приложение начинает переливать данные Кроме этого данное решение разработчики позиционируют как решение поэтому его очень легко масштабировать с помощью кубера и будущем разработчики обещают выкатить губернации оператор который еще сильнее облегчит процесс иди пишем сервер позволяет также добавить сохранилище об этом как мы это сделали в депезиумбэдов то есть Он позволяет сделать хранили сейчас это для вашего приемника который позволит и записывать туда данные и вычитывать то есть при этом конфигурация будет опять же через файл конфигурации То есть вы просто указываете класс который хотите использовать для хранилища но у него есть и минусы первый минус которым мы столкнулись Когда решили добавить свой стиль коннектор на основе того что сделали в дивизию МВД на основе нашего врата типа это сложность добавления То есть Вам нужно заимплементить коннектор от библиотек зависимости и прописать его в dipedium сервер То есть просто так его подсунуть не получится и указать там например после этого собирается дистрибутив и по сути С одной стороны да на каждое изменение синка можно перебирать дистрибутив чтобы поставлять заказчику Либо вы можете просто перебирать сам коннектор и класть его в папку с библиотеками но в любом случае если вы хотите добавить свой коннектор вам нужно собрать дистрибутив который будет его поддерживать и последний минус это то что из коробки э-э дивизиумбет э добимся они там стоят либо файле да либо в Кафки но данный два варианта мы отметаем как в случае с нашим прототипом или Да но ради тоже не всегда может быть доступен что делать случае если хранилище наш шортированы То есть как например мозга может быть или тарантул в случае с dipezium embated мы шортируемся по мы масштабируемся по шардам то есть на каждый Шарп Мы запускаем один из нашего приложения но делается это все вручную и абсолютно мы храним приемники для каждого шарда в случае тебе чем сервером мы делаем ровно то же самое но масштабируемся уже с помощью приемники также храним обстоятельств для каждого шарда чтобы потом мы могли их Вычитать и стартануть нужной точки нужно есть варианты Если вы берете сортовый коннектор И хотите просто писать вам ваши ваш коннектор по использованию То есть у вас на каждой жерт запускается отдельный танк который будет вычитывать данные для этого достаточно конфиги указать количество максимальное количество танков больше или равное количество и для каждого шарда будут также в кафке хранится офсет это при старте connector вычет вычеты эти офсеты из сказки и продолжит работу какие выводы можно из этого сделать мы выбрали cdc как наиболее горячее нас решение то есть низкие низкая нагрузка на источник низкий лак репликации и высокая скорость репликации так как мы Стрим данные из источника мы Выбрались так Java + dium так как большинство наших заказчиков у себя использует Java собрали кейсы неправильного использования То есть это высокий лак репликации это отправка бачей отправка бачей в отдельном потоке попытки неудачности попытки заменить Golden Gate и так далее на выходе мы получили инструмент который позволяет позволил нам переливать данные из подростов Коран низким лаком репликации данные переливались консистентно также мы его тестировали на других хранилищах типа добровольские Эля И оно работало и следующий шаг последний который мы сделали это Мы перешли от дивизиума этот dipsium серверов как наиболее универсальным решением которое не является монолитным и позволяет добавлять свои коннекторы и масштабироваться с помощью на этом У меня все спасибо за внимание Если есть вопросы Александр Спасибо тебе большое так и Давайте если у нас Спасибо большое так Если есть вопросы давайте мы поднимем руки к вам подойдет девушка с микрофоном и можно будет их задать В микрофончик так вот пожалуйста вот сюда на 4 ряд Добрый день во-первых хотелось сказать что на самом деле поддерживается несколько баз данных и Можно списать свои коннекторы второй момент Хотелось бы по поводу вашего решения такие Трансформеры возможно было написать или данные переливаются из той же самой структуре но они проливаются изначально в той же самой структуре но чисто теоретически это можно сделать Спасибо Спасибо большое так вот сзади чуть-чуть буквально два ряда микрофончик заранее поднимайте руки чтобы можно было передать микрофон Спасибо Добрый день Хотел поинтересоваться А чем мониторить процессы Когда уже все настроено репутация это все мониторится с помощью прометеоса изначально теперь отдает метрики в gmx но Есть же экспортер который позволяет их преобразовать формально прометеос дальше соответственно прометеоса и графана хорошо спасибо так и Давайте может быть еще один вопросик возьмем из зала так не вижу бьет немножечко в экран Так ну что ж а у нас же есть еще приз Да небольшой Я предлагаю первым вопрос первый вопрос молодой человек на четвертом ряду А тогда давайте еще раз поблагодарим докладчика спасибо да молодой человек вот на четвертом ряду Когда вы задавали вопрос Вы не уходите к нам Потом после того как мы закончим и у нас есть небольшой презент для докладчика от организаторов конференции так спасибо большое вот Благодарим за участие Всем спасибо большое за вопросы можно будет конечно наверное на стенде и подходите пожалуйста Всем спасибо большое До скорых встреч Давайте в следующий раз встретимся еще раз здесь"
}