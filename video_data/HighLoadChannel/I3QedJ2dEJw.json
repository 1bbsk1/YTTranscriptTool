{
  "video_id": "I3QedJ2dEJw",
  "channel": "HighLoadChannel",
  "title": "Высоконагруженная платежная система \"Мир\": что под капотом / Юрий Бабак (Мир Plat.Form)",
  "views": 28992,
  "duration": 2636,
  "published": "2021-10-04T02:47:02-07:00",
  "text": "сегодня мы будем говорить о национальной платежной системе не такой который не принимает другие карты у нас намного лучше у нас много чего принимается у нас все принимается но сегодня мы будем говорить конкретно про платежную систему мир про то что происходит и я думаю что если сегодня вечером кто-нибудь чего-нибудь будет покупать или завтра утром брать кофеек то после этого доклада вы узнаете что же за макетом происходит с момента как вы воспользовались после терминалом с помощью карты до момента как острыми на сказал что кофеечек наконец-то можно получить и позвольте мне представиться меня зовут юрий бабок и я руковожу разработкой платформа авторизации в национальный систем платежных карт и представляю наш технологический бренд мир в платформ это бренд под которым мы объединили все наши решения все наши какие-то платформы достаточно очевидно из названия которым мы пользуемся сами и которые мы предоставляем нашим банкам партнерам и первое с чего я хочу начать это с того что фильм тех это просто и сейчас я расскажу как все это работает и если мы говорим про платежные системы то основные две части которая у нас происходит это онлайн обработка и оффлайн обработка онлайн обработка она же платформа авторизации она же фронт-офис и как это выглядит когда у нас есть какой-то человек у которого есть банковская карта ну в нашем случае это мир но если бы это была карта какой-либо другой платежной системы то схема была бы абсолютно точно такая же вот он приходит куда то это обычно это место называется tsp торгово сервисное предприятие где находится pos-терминал point of service и строго говоря таким вот pos-терминал может являться банкомат или любое устройство которое может взаимодействовать с банковскими картами схема все еще остается той же самой найди схеме у нас есть два банка первый банк это эквайер это собственно этот банк который предоставляет услугу эквайринга он предоставил pos-терминалы на самом деле ему принадлежит этот пост терминал и в этот банк будут отправляться все финансовые сообщения сгенерированные этим терминалом у нас есть второй банк банк эмитент банк который выдал карту то тот банк чей логотип на этой карте находится тот банк которому это карта физически принадлежит потому что если вдруг кто-то не знает то нам банковские карты наши не принадлежат они являются собственностью банков и соответственно только банк эмитент может авторизовать ту или иную транзакцию то есть разрешите и будь это запрос баланса будь это перевод будь это вот непосредственно авторизация когда мы что-то хотим где-то купить и задач фронт-офиса платежной системы это связать эти два банка потому что они друг о друге ничего знать не должны и не знают опять же платежные системы в том числе нужны для того чтобы банки связать потому что в противном случае каждый банк должен был бы соединим быть с каждым банком а это очень-очень тяжело с точки зрения обеспечения этого процесса например если мы даже будем говорить в пар шифрование и в тех и тех сообщениях которые у нас ходят по этой схеме у нас есть достаточно большие блоки зашифрованной информации которые характеризуют собственно собственно говоря это все то что записан на чипе это вся информация платежная это и в том числе это и и имя этой пин-код это и множество других полей которые там есть об этом расскажу чуть подробнее и платежная система здесь нужно для того чтобы эти банки между собой связать обеспечить сквозного шифрования перри шифровать теме ключами которые банк получатель поймет чтобы он мог дать какое-то решение здесь есть еще краевой случай когда банк-эквайер ее банк-эмитент это один и тот же банк но в таких сесть в таком случае ему платежная система в общем то почти не нужно у него есть все что ему необходимо для того чтобы полностью провести эту операцию вот и таким образом мы видим схему онлайн а то есть как работает фронт-офис и это все происходит в режиме ну очень близком к реальному времени насколько реально сколько такой режим вообще достижим при работе сетью потому что каждый вот из этих вот 4 скажем так картиночек это отдельное и это отдельная железо железяка которая лежит в отдельной сити пас терминал находится в магазине aqua эквайринг банка находится в одном сотен наш про наш фронт офис находится в третьем соде банк-эмитент он живет в обще в следующем соде и это очень много всяких разных взаимодействий которые должны укладываться в если об этом тоже я расскажу чуть подробнее второй этап это клиринг представим себе ситуацию что у нас есть три банка и три банка допустим держатели этих карт с помощью карты на самом деле карты здесь не важны потому что схема клиринга она универсальная много для чего вот и банки друг другу начинают передавать деньги но если мы начнем физически проводить эту операцию физически осуществлять пересыл денег чем либо напрямую либо через core счета в расчетных банках дополнительных то мы влетаем в то что каждая такая операция будет требовать оплату комиссии потому что ничто не бывает бесплатно и ровно для этого существует клиринг если мы вспомним ситуацию когда еще можно было нормально ездить за границу массово и пытаться во всяких странах оплачивать интересными картами то часто было такое что мы возвращаемся еще через несколько дней после того как оплатили что-то и только еще через несколько дней к нам приходит сообщение о том что сумма списана собственно говоря физически она списалась ровно тогда когда закрылся операционный день с этим банком когда посчитался клиринг когда сделались расчеты комиссия они делаются на этом этапе и все друг друга мы договорились и все передали пачку денег одним этапом одной транзакцией и соответственно все те стрелочки которые у нас были до этого с помощью клиринга у нас могут превратиться вот в такую одну что очень существенно экономит нам средства ну и на самом деле даже время и в итоге вся схема выглядит следующим образом здесь у нас оранжевые стрелки это онлайн компонента и серые стрелки этого оффлайн компонента все начинается с того что банк эмитент выдает нам карту в данном случае это карта мир далее мы можем им воспользоваться где угодно в плюс-минус любом пос терминале pos терминал передает сообщение об операции в банк-эквайер банк-эквайер передает нам в платежную систему платежная система передает в банк-эмитент чтобы он решил готов он одобрить эту операцию или нет ну и соответственно по обратной цепочки потом в конце в это включается клиринг и уже происходит реальное движение денежных средств по итогам операционного дня обычно это один календарный день и я вот говорю операция я вот говорю транзакция я бы хотел здесь сказать что же это значит применительно к нашему случаю одна транзакция или же операцию на самом деле это одно и то же будет она состоит из нескольких сообщений и дальше мы будем говорить про нагрузки и я буду оперировать уже не сообщениями а именно транзакциями и вот в данном случае если мы говорим о том что вот у нас обычное сообщение могут там как я сказал кофеечек хотим купить у нас будет сгенерировано два сообщения сначала запрос с внутренним кодом мы сочетаем нотификатор 0 100 более подробно это описано в стандарте iso 858 3 это стандарт которые реализуют абсолютно все платежные системы работающие с картами не важно будь это мир или любая другая абсолютно любой они все будут реализовывать этот стандарт и тогда сообщение состоит из 128 полей но поля могут быть очень разные могут быть простые числа могут быть какие-нибудь строки могут быть бинарные поля в которых вложены другие бинарные поля с другими под полями которые там и и далее до бесконечности и размер одного такого сообщения может достигать ну скажем 4 килобайт но это пока что теоретически практически там самые длинные сообщения которые были это по моему где то в районе двух килобайт вполне вполне ходят вот и такой же ответ от банка-эмитента сгенерированный им и вот вдвоем эти две эти два сообщения они организуют они собираются в одну транзакцию и про нагрузки я уже упомянул что у нас есть случаи когда банк-эмитент и банк-эквайер это один и тот же банк ну в таких случаях поскольку этот банк может сделать все самостоятельно об этих операциях мы ничего не знаем и когда я говорю про нагрузки мы говорим именно в том случае когда включается именно наша платформа фронт-офиса и она соответственно проводит межбанковские операции по картам мир и этих операций за прошлый год у нас набежало три с половиной миллиардов три с половиной миллиарда вот таких вот транзакций каждая может развернуться в 7 миллиардов сообщений а бывают более сложные случаи когда этих сообщений в одной транзакции могут быть больше и таких транзакций у нас в среднем где-то 800 в секунду там 99 перцентиль это 1200 и пике за прошлый год были в 1800 ну то есть с одной стороны если бы мы пытались это сравнивать там с базой данных какой-нибудь то можно было бы показывать пальцем и смеяться но я надеюсь что я только что достаточно подробно объясню почему это не так и для всей вот этой вот система нужно давать определенной гарантией например гарантию доступности и в нашем случае это 5 9 кто-нибудь еще поддерживает система с пятью девятками раз ну два увидел не очень много поэтому до ими имело смысл добавить информации что же такое доступность 5 девяток если мы эту в доступность будем время во времени мерить эту доступность во времени то у нас получается что допустимое время простоя системы за один календарный год из расчета что каждый месяц это 30 дней это пять минут 26 секунд ну соответственно в месяц мы можем позволить себе простой в 26 секунд условно и 6 секунд в неделю соответственно вот с такими гарантиями доступ такие гарантии доступности мы должны обеспечивать для нашей системы помимо этого мы также должны обеспечивать очень высокую производительность потому что для всей вот этой вот систему для всего этого онлайн а общее целей и the time out as терминала если pos-терминал решил что он не дождался сообщение все транзакцию надо откатывать вне зависимости от того в каком она была состоянии даже если банк-эквайер в этот момент нам уже по проводам пересылает сообщение о том что все успешные все состоялось но ему не хватило там каких-то миллисекунд не волнует необходимо откатывать потому что главное здесь pos-терминал если он сформировал отмену все всю вот эту вот систему мы должны откатывать и у нас по рождается новое сообщение об отмене и ну и разумеется в это сразу за ним у нас будет зарождаться новая снова я транзакция потому что когда можно вдруг сказали что банк не доступен традиционно нам либо мы сами хотим либо нам предлагают попробуйте еще раз что может ну что порождает дополнительную нагрузку на систему если же мы говорим именно про и целый фронт-офиса то у нас для в случае с миром мы должны укладываться в одну секунду в нашем контуре вот и он здесь опять указана эта схема взаимодействия с банками-партнерами и когда я говорю одну секунду это общее время нахождения транзакции в нашем контуре то есть вот здесь 4 место которые за в которых мы замеряем время соответственно это пара вишен мониторинг и если вдруг мы из этого если выбиваемся там начинают гудеть alert и и в спешке пытаемся размеры понимать что происходит и при необходимости это можно чинить вот ну и разумеется самая главная гарантия это доставка сообщений чтобы ни произошло чтобы не случилось мы не можем ни в каком виде терять информацию о транзакциях которые сейчас либо уже финализирован и как-то либо в обработке ну потому что начиная с того что это наша прямая финансовая ответственность перед всеми заканчивая тем что наверное никому не понадобятся ни никому не понравится если у него деньги спишется товар ему не дадут будет очень и очень приятно или например что будут происходить двойные списание или ещё что-нибудь такое это абсолютно не то что нужно и посмотрев на все эти требования я хочу рассказов про все эти требования сейчас хочу рассказать о том как же устроены с точки зрения архитектуры как мы спроектировали наш фронт-офис чтобы он всем этим требованиям удовлетворял чтобы и доступность у него было необходимо необходимого уровня чтобы производительность была даст достаточного уровня ну и разумеется чтобы у нас была гарантия доставки и сейчас наш фронт-офис выглядит примерно следующим образом у нас есть праксис балансировщика мы-то примерно одна и та же штука это абсолютно самолетом сам описанное решение которое с одной стороны прокси ru этот банков-партнеров нашу инфраструктуру и за ним стоит балансе балансировщик который умеет перекладывать трафик из сотов цод в зависимости от того какие работы у нас происходит ну и собственно говоря из кластеров до кластеров и на самом деле таких . подключения у нас минимум 2 может быть даже больше в некоторых случаях все это развернуто на 200 ах и в каждом соде у нас есть резерв еще по одному кластеру то есть у нас очень серьезное резервирование идет причем на всех этапах почему это может быть важно почему нужно так вот серьезно вкладываться в инфраструктуру потому что у нас бывали случаи когда например если бы это был один сот то я думаю что здесь есть коллеги которые знают эту историю о том как приходит excavators как будто бы специально начинает искать капнул так кабель здесь не здесь давайте копнём ещё раз и бывали случаи когда там 1 сот или одну точку подключения чуть ли не целиком а копы вале и мы должны быть готовы к этому и быть устойчивы к этому выдавая все гарантии которые я упоминал ранее и давайте же наконец посмотрим на то как это выглядит внутри поползла форматирование ну да ладно выглядит это следующим образом в нашем контуре happy пас это примерно 12 стадий для сообщения у нас есть шлюз доступа в котором садите в котором также содержится бизнес-логика вся которое нам необходимо и этот шлюз доступа он является точки подключения для банка-партнера ну минут понятное дело minaj прокси minaj балансировщик минуя там весь сетевой слой вот после этого начинает стекать наш таймер мы получаем сообщение мы отправляем карте координатору координатор знает где у него ближайший свободное и gateway до внешней системы в данном случае это fruit мониторинг который нам обязательно нужен чтобы оспорить текущую транзакцию в рамках всей платежной системы ну и сделать отдельную анти фродо вы и магию соответственно получаем результат от этой системы передаем назад снова идем в координатор координатор знает где у нас находится точка подключения с банком эмитентом получить через пересылаем на эту точку подключения там тоже делается подготовительный этап именно логика которая нужна чтобы преобразовать сообщение так чтобы банк митинг был готов его принять и соблюсти протокол взаимодействия участников все таймер в этом месте для нас остановился мы ждем ответ от эмитента когда ответ к нам приходит снова запускается таймер но здесь уже проще потому что у нас есть статический бэкграунд и в нем мы уже знаем напрямую нам больше не нужен координатор но опять же если все хорошо и это happy паз и топология сети не поменялось и он не уехал куда-нибудь на другую на другой сервис или даже вообще на другую машину вот получаем его назад передаем в эквайер таймера становился все мы все успели мы молодцы но транзакция полетела дальше и начиная с этого и давайте посмотрим что же у нас там есть вот в этих вот наших узлах потому что я говорил что вот общая схема это у нас есть сот в соде у нас есть кластер кластер состоит из узлов узлы это конкретный берм этом железяки на которых развернуто где-то примерно штук 400 сервисов и чтобы всем этим зоопарком управлять у нас есть отдельное приложение это отдельная standalone application джорджа вас java приложение которое мониторит за состоянием всех локальных сервисов которые развернуты вот на одном узле она умеет их запускать она умеет их останавливать она может собирать их состоянии делать на них чеки и откидывать это все в систему мониторинга ну и также рядом с этим у нас есть интерфейс которые нужны для синхронизации распределенного состояния потому что локального состояния у нас нет никакого все что нам нужно мы ищем храним в казань кости но тут есть такой момент что с одной стороны все что нам нужно это полезная вещь с другой стороны это все можно восстановить при необходимости так что гарантия доступны гарантия доставки все еще сохраняется потому что там не хранится ничего такого чтобы мы потом не смогли найти в аварийной ситуации более того хотели к с помощью не нужен для happy паса который я показывал до этого что же мы в нем храним в нем мы прежде всего храним текущие актуальное состояние всего кластера в нем же пробита дырки для мониторинга через rest ребята уме ребята из службы мониторинга умеет забирать и там дальше анализировать что у нас происходит как с продам новые уровни приклада ну то есть как бы что там серверами как как какая там лейкен си и там еще что так и глобально в рамках платежной системы там собираются метрики чтобы уже бизнес-аналитики могли прям очень быстро понимать что у нас общий сейчас происходит в стране с платежами ну и некоторое количество вещей которые нужны для бизнес-логике и то там проверка дубликатов для ограниченных случаев и там хранение контекстов для быстрой формирования отмены чтоб нам не нужно было лезть в холодное хранилища для этого и также в том случае если мы на лету будем переводить трафик то текущей компе ток контекст текущих транзакций которые вот прямо сейчас в обработке мы запихиваем целиком в хозяйка ст гасим этот класс ну точнее сначала запихиваем в козырька ст передаем нас на второй кластер который мы сейчас подключаем после этого гасим полностью гасим этот кластеры все мы готовы бесшовно продолжать обработку поток от инфекционного будь это штатная ситуация если мы например обновляемся если у нас гарантия 5 9 так то мы не можем катится в релиз мы не можем делать релизы и при этом останавливая обработку это физически невозможно поэтому мы не останавливаем сервис следующая важная вещь следующий важный узел как-то не нет не все правки доехали поэтому я буду показывать это узлы обработки на этой схеме это эквайер овский шлюз и и микенский шлюз здесь они так написаны потому что к ним подключается на этой схеме клэр эмитента на строго говоря это одна и та же это один и тот же сервиса просто разные инстанции одного и того же сервиса и в этих инстансах у нас содержится вся бизнес-логика которая необходима почему мы не стали их разделять ну во-первых каждый банк он может быть и эмитентом и эквайером поэтому это бизнес-логику разорвать нельзя в противном случае нужно было бы удваивать количество активных точек подключения во-вторых по нашей архитектуре вот вот вот такой вот процессинговый узел узел обработки он является и точки входа-выхода и занимается обработкой также на нем мы считаем время и выставляем таймс темпы и так же в нем когда мы считаем что когда сообщение туда заходят и когда сообщения из него выходит она меняет как-то свое состояние и именно эти изменения мы журнале ру и мы скидываем уже в архив о прикольно а здесь отмечено предыдущие класс в общем эта картинка должна была быть на предыдущем слайде тогда не выделенная красным маршрутизатор это то на что мы сейчас будем смотреть он занимается во-первых построение маршрутов в том числе динамических и он знает о текущем состоянии кластера он знает и его топологии при не он знает где находятся какие точки подключения до каких банков он это умеет вычислять по той информации которая находится в транзакции это этот мой координатор он занимается генерацией иди шик для каждой конкретной транзакции в рамках всей платежной системе на протяжении но такого достаточно длительного периода соответственно вопрос генерации уникальных айтишников финансовых вот этих вот сообщений для платежной системы которая размазано по нескольким кластерам который раз и по кучи машин которых там десятки железных машин это отдельно интересный вопрос надо будет как-нибудь сделать доклад на эту тему ну и разумеется он занимается маршрутизации то есть передача сообщений и если говорить про более сложные случаи например если эмитент подключен к одной физической машине эквайер подключен к другой физической машине то тогда между ними надо организовать пересылку и нагружать еще этим именно узлы обработки было бы неправильно потому что это ник задача и для этого мы выделили отдельное и шлюзы которых инстансов которых у нас n минус 1 от количества серверов в кластере иными словами у нас полна связа у нас полна связанная сеть где каждый узел нашего кластера знает о каждом другом узле и может передать ему сообщение вот примерно таким образом опять же если мы обращаемся к вопросам доступности то даже во время этой пересылки счетчиков слышите кой ты все еще надо успевать и еще один интересный кейс из архитектурных решений это архив долговременный в нашем случае из за того что у нас есть гарантия доставки сообщений из за того что у нас есть требование что мы ничего не можем потерять мы не пишем напрямую в базу данных мы сначала пишем на диске причем на локальные диски которые там рядом стоят это нужно для того чтобы узел был готов работать даже в условиях абсолютно полной изоляции ну то есть я не знаю там у нас база могла упасть мы все равно должны сохранить информацию об этих транзакциях или просто текущий узел остался вы бы выбитой сети его из топологии выбило там почему-то я не знаю там весь рэп мадонна там куда-нибудь внести кто знает что-то вроде происходит мы все равно должны быть готовы обработать и сохранить ой боже мой я остался в полной изоляции но отличное мы ничего не потеряем мы запишем это в архив что вот у нас есть столько-то сообщений мы не смогли их доставить когда целостности tengo становится и мы вернем назад в онлайн этот модуль мы узнаем там все что у него есть и как-то с этим и как-то это обработаем обработать мы можем это например вот с помощью такой схемы это наша система отложенной доставки сообщений очень примитивно очень схематично выглядящие но смысл такой вот у нас есть один но и наших узлов обработки и он понял что он прямо сейчас не может доставить сообщение в банк не может нету банка то что он делает он вот с помощью того архивиста записывает в отдельные таблицы отдельные базы начинает писать туда конверт и начинает писать туда сообщения и забывать о них потому что он полностью стоит вас и мы не хотим чтобы он забивал чтобы он забивал этой информацией у нас есть отдельные сервисы которые в каких-то количествах развернуты на всем кластере этого передать это вот наши передатчики которые анализируют эти таблицы в базах и спрашивать-то маршрутизатора скажем не появилось ли в нашей топологии маршрут вот до этого а вот до этого до этого потому что там в этой таблице строго говоря могут лежать разные сообщения для разных адресатов и как только он понимает что появилось начинает их выгребать в соответствии с теми ручками и правилами которые у него есть передавать маршрутизатора дальше сообщение встает на нормальные рельсы как если бы она сразу была получена от обработчика разумеется мы скажем что там про и за если это авторизация мы скажем что за это время у нас успел произойти тайм-аут и уже это все не актуально но мы все равно должны все эти сообщения передать ну потому что это протокол и его нужно соблюдать но не все сообщения которые проходят через платформу авторизации они все являются вот такими вот авторизационные которые требуют немедленной реакции это могут быть опять же какие-то оповещения какие-то нотификации который все равно нужно доставлять а вот их-то как раз можно доставлять в любое время но все равно опять же нужно вне зависимости от того есть у нас наш таргет и или нет его здесь интересно еще момент с этим передатчиком тем что это коза и и работа над ним оказалось не так тривиально как хотелось бы потому что есть например такой случай представим что вот наш таргет он упал каким-то причинам обычном бывает такое что происходит какой-то аномальный всплеск активности начинается много транзакций они уходят в какой-то банк его processing не справляется и падает а мы продолжаем получать сообщения продолжаем их записывать мы видим что банк оффлайн его нет мы то обязаны обрабатывать сообщение они начинают приходить вот в это время на хранилище в эту таблицу потом банк оклемался он поднялся он снова к нам прицепился и тут мы взяли все что у нас накопилось снова в него отдали и снова упал и так до бесконечности и чтобы этого не было вот в этом передатчики у нас есть большое количество крутилок которые позволяют для каждого участника отдельную стратегию задавать доставки от ложных сообщений это может быть регулировка количества сообщений в секунду это может быть регулировка одновременно отправленных сообщений по которым ты ещё не получил подтверждение что их приняли потому что банк должен подать нам подтверждение что он принял сообщения это может быть регулировка в принципе по всему потоку сообщений через этот передатчик и через этот узел фронт-офиса и множество других интересных крутилок которые нужны для того чтобы очень кастом на этим управлять ну и разумеется каждый узел наши платформ авторизации каждый узел нашего front office он должен быть интегрирован с большим количеством различных систем которые у нас есть и которые все вместе вот этот вот мир платформы образуют это разумеется master data которые у нас своя это бэк-офис том же клиринг про который я вот уже рассказал немножко интересный случай резервная авторизация которая у нас также есть она нужна для того для такого случая если банк-эмитент недоступен в этот момент но он нам разрешил сказал что мы тебе верим ты можешь авторизовать от нашего имени вот такая же такая штука тоже возможно но разумеется fruit мониторинг риск-менеджмент system platform атаки низации которые нужны как раз для переводов токенов из кошельков таких как samsung pay мир и apple pay в номера карт чтобы уже потом перевести работу с этой транзакции в на нормальные рельсы потому что но банки особенно друг с другом про токены точно ничего не знают и нету у них никаких шансов узнать со это вообще чей токен даже в том случае если это он так называемая он а с операция когда и эмитент и это один банк им все равно приходится лезть платежную систему в случае это генизе раваной операции чтобы узнать о какой же номер карты и по номеру к что он уже сможет понять что это оказывая ах это оказывается я но сообщение все равно улетел платежную систему мы его посчитали что-нибудь с ним сделали и например интеграционная платформа для платежных систем там то тоже интересный продукт отдельные и множество-множество других я обещал что я расскажу про нагрузку про тоже что там на самом деле происходит и у меня есть вот такой вот интересный слайд который я снял прям с продаж настоящего правда вот как оно есть в один очень конкретный день а именно 31 декабря 2019 года и вот здесь вот мы видим реальную нагрузку что происходило в этот день по платежам это дпм и в минутах то есть 18 тысяч операций в минуту ну там понятное дело пике скачки потому что по секундам там все очень по-разному будет но тем не менее вот и то же из интересного это а что же с платежной системой мир произошло через год 31 декабря 2000 уже 20 года и мы приросли процентов кажется на 40 если я не ошибаюсь уже по пику по пиковым значением здесь и от 18 18 тысяч уже превратилась 28000 с нетерпением ждем 31 декабря 2020 года 2021 года обязательно будет бой будет очень интересно посмотреть смотреть на это нужно потому что было бы недурно знать что вообще с платформой вот я вот говорю что у нас есть гарантии доставки у нас есть гарантии производительности у нас есть гарантий доступности а в какой момент это станет для нас проблемой в какой момент производительности поток транзакции нас завалят соответственно что нам нужно сделать нам разумеется нужно построить систему нагрузочного тестирования желательно еще и стресс-тестирование нагрузочный регресс еще много чего другого интересного и мы начали строить и соответственно для этого нам нужны реальные данные с провода чтобы понять а как же выглядит наш профиль нагрузки и вот в этот день у нас один ярко выраженный пик а бывают например дни с двумя ярко выраженными пиками с когда сначала все обеду это потом все и вечером едут магазин закупаться и это еще вот так вот скользит по стране потому что часовые пояса и плюс есть разные разная структура этих операций есть такими zero ван и и не таки не zero ванны и у них своя статистика и свое разбиение по процентам есть операции отмена есть операции так называемые с и дмс это сингл мэсседж авторизация еда мастершеф 3 завишин когда авторизация в два сообщения проходит два прохода идет и множество других интересных и все это нам была нужна для того чтобы построить этим нагрузочное тестирование и узнать а где же наш предел сколько же мы можем держать что bootleg что сейчас нужно все бросать и чинить чтобы у нас не было такого что под нагрузкой уже упали мы и здесь должна была быть какая-нибудь коул история о том что мы что-нибудь очень крутое нашли как мы героически это пофиксили но к несчастью у меня сегодня такой кул стори нету потому что когда мы построили стенд когда мы на него пустили правильно нагрузку когда мы сделали там кластер джей метров который начали в носки да тьму перста что кластерный метров не может завалить наш кластера фронт-офиса потому что когда он зги не начал генерировать за день сообщений за час он начал генерировать такую нагрузку которую там по моему за неделю мы перед и вида и мы поняли что у нас x10 по производительности что в принципе уже тоже не мне дурно и нам нужно дальше наращивать нашу лабораторию чтобы у нас было больше ресурсов сахар на на именно ту часть которая занимается генерации данных и их валидации потому что для этих тестов мы разумеется полностью про дни подняли весь фронт-офиса и далее на него всю нагрузку в правильном окружении и я хочу перейти к выводам я надеюсь что я достаточно детально описал как работают платежные системы которые работают с банковскими картами я рассказал как устроена платежная система мир я показал вот этот самый хопи пас что происходит в самом лучшем случае когда мы пользуемся нашими картами рассказал про архитектуру платформы авторизации ну и показал нагрузку которую в реальную нагрузку на платежную систему одну чашку кофе хочется купить а сколько всего прикольного происходят и всем спасибо красота друзья руки в небо давайте зададим вопрос и вот здесь уже слева да вижу сейчас до вас добегут но пока добегают я все таки да говорю что всем спасибо за внимание переберите аплодисментами в зуме так не сделаешь да пожалуйста представьтесь и вопроса привет зовут меня сергей спасибо вопрос такой тестируете львы сценарий отказаться от или вы просто верите что все будет хорошо фиксируем а как разрываем сеть ну на боевом пластыри на тестовых в тестовом окружении на уровне ю а то на уровне стендов на уровне нагрузочного стенда это там лабораторий с большой с хорошим количеством железяк на который мы можем сформировать ситуацию двух судов и взять и физически вырубить половину то есть вы между собой мы вообще стараемся чтобы у нас не было между 2 взаимодействия чтобы соды были но мышцы тестируем сценарии быстрых переходов на новый сад в данном случае потому что растягивать одну транзакцию по двум сводом но тут можно огрести всякого разного а у нас жесткие силы и этого не хотелось бы нам лучше быть ход стендбай как внутри сода так и между сотами чтобы гарантировать что мы быстро поднимемся и от чего-то у становимся хабблкаст он внутри каждого свой он даже внутри каждого кластера свой но между ними мы можем сделать репликацию спасибо вот справа прямо под фонарем можно завяжу добрый день павел вопрос такой а вот здесь прозвучала цифра пять девяток что невероятно через цифра для меня вопрос а что за из лап под этими 5 девятками и что вы делаете чтобы ну я уверен практически на сто процентов что они нарушаются но но бывает все вот как какой у вас процесс чтобы эти 5 9 держать ну во первых у нас есть начинаем сперва основ в тестировании вся пирамида правильно выстроена потом еще тесты для тестов потом нагрузок иные тесты регрессионные тесты стресс-тест исследовательские тесты тесты на тесты я уже это сказал это первое второе дежурная служба которая тоже отрабатывать свои сценарии и может как-то активно в случае нештатных ситуаций что-то делать с продам и множество других вещей ну то есть как бы мы к этому готовимся мы стараемся минимизировать потери от этого что есть то вот эти села просто ну есть какие-то вот ну как бы транзакции пошла от потери транзакции не прохождение не укладывания их во время отказы по тайм аутом ну то есть вот когда вот это вот все растет это значит что мы нарушаем наше если а если не секрет как часто происходит вот нарушение хотят такие дневных например целый вы можете повторить последний ну вот то есть если там шесть секунд в неделю вот так часто бывает что вот эти шесть секунд они пропадают потому что человек не реагирует за 6 0 6 секунд в неделю поставил для примера потому что слое мы считаем за год 6 секунд понятное дело мы не ним не уложились бы никак ну просто потому что время реакции но счет еще и счет в год на простой и счет идет на минуты и мы в них укладываемся всяком случае именно по фронту офису спасибо осиба вот там слева здравствуйте распутин спасибо за доклад скажите как выбирали мдг почему выбрали их исокаста например не там решение из реестра российского по спасибо в 2015 году какое а другой вопрос тогда ты да как как выбирали то по каким критериям и почему христос победил на тот момент получилось пастой построить да это grid который устраивал требованиям которые у нас к нему были но и потом как бы при развитии мы прокручивали потому что не вся функциональность про которую я рассказал было прям сразу со старта начиная с классического так исторически сложилось что является универсальным ответом на подобные вопросы заканчивая тем что коллеги сказали каста помогали в тот момент когда я присоединился к компании а это было полтора года назад в общем-то на тот момент он уже работал и уже не мешал вот здесь добрый день добрый спасибо за доклад у меня такой вопрос вот вас была картинка где у вас было два дата центра и нарисована что между ними настроена репликация вот не могли бы вы рассказать как это все у вас реализовано какие механизмы вы используете стандартные то какое-то решение или может быть самописная какое-то решение я какой лак там между тем как это происходит то есть понятно что там быть задержка какая задержка во первых как я уже вот упомянул мы не протягиваем транзакции между сотами а во-вторых мы не поскольку сам по себе кластер скорее stateless в большинстве своем то у нас нет необходимости в активной репликации когда здесь вот указано репликации она на самом деле указано между инстинктами архива что мы реплицирует наш архив и при необходимости мы можем реплицировать контекст и из кластеров газоля но вот здесь вот уже дальше про механизмы детальная не это это будет а то есть 2 нужен чисто для того чтобы какие-то зависимой операции можно было провести от и да и не в том случае если у нас доступен хозяйка ст то в нем содержится контекст в том случае если если у нас заказ недоступен мы можем стоит хозяйка 100 восстановить из архива архив нам нужен потому что на самом деле это холодное хранилище сейчас потому что у нас есть отдельный дейта lake в котором и по которым мы уже строим аналитику и вот и в этот архив мы даже не ходим архив это уже какая-то реляционные базы данных да все так и вот на основе на основе нее построен как раз to the light нет дата лайк это вообще отдельная штука здравствуйте спасибо за доклад вы упомянули что но да не сразу скидывает журнал в базу данных а сначала на диск скидывает и и потом боже это сбрасывается в базу может ли случиться такое что в базу не успеет броситься потому что там надо умерла диск умер и вы потеряли эти данные но если да то как вы с этим боретесь но случиться может абсолютно все что угодно как справедливо замечено наша задача достичь этой ситуации что у нас нет ни одной единой точки отказа то есть мы можем выжить если что-то одно отвалится абсолютно любое мы выживем если отвалится сразу все но отвалится сразу все с этим ничего нельзя будем там не знаю промежуточные логе поднимать еще что то но вот в таком случае как вы боретесь то есть вы по логам в других модах вы становитесь что одну какие операции были мы по другим логом можем попробовать восстановить по мониторингу можем попробовать это восстановить еще каким-то способом ну то есть зависимости от того какая ситуация происходит вот скажем так я не еще вот зато за то время что я знаю за то время что я над этим работаю и еще какое-то время назад я еще не слышал чтоб такая ситуация произошла физически ну просто отказ одновременно нескольких системы это все-таки уже похоже на полный крыш от которого уже все"
}