{
  "video_id": "0EStLed_tv8",
  "channel": "HighLoadChannel",
  "title": "Tarantool как платформа для микросервисов / Антон Резников, Владимир Перепелица (Mail Ru)",
  "views": 3040,
  "duration": 1748,
  "published": "2017-04-09T13:07:31-07:00",
  "text": "я снова рад вас всех видеть у нас последний доклад сегодняшний секции видите так получилось что а микрофон есть микрофон есть голос тоже есть это последний доклад сегодняшний секции про микро сервисы игра сервис это модно да то есть я не знаю видели ли вы это демотиваторы старайся вас а была одна большая говняшка а вода стала много маленьких но насади тарантул это не говняшка поэтому сегодня у нас владимир перепелица и антон резников рассказывает про так как они собственно делают и что то есть вот опять же реальная история про то как на этом что-то сделать почему это работает что то что что нет до этого не давался объяснить мне может быть удастся спасибо добрый вечер добрый вечер всем это владимир кайфе лица осетия к облаку могу это антон резников он еле тимлид команды разработки в облаке mail.ru наши коллегию уже рассказали с фото грантов это быстро и эффективно но мы пойдем немного другим путем мы расскажем как тарантул может быть сопряжен с уже известными использованию вами технологиями или заменить их но сначала небольшая разминка кто из вас в зале использует escape вот поднимите пожалуйста руки отлично кто использует нам кеш отлично кто использует очереди вообще прекрасно кто уже подсчитывает возможно экономят использования тарантула замечательно ну чтож начнем мы расскажем о нескольких социальных сценариях использования тарантул расположив их в идти возрастания сложности мы расскажем как использовать устаревание данных используя тарантул как простой киева илью мы расскажем как мы использовали то гранту в качестве кэша боксирую щего мы обязательно рассмотрим как использовать тарантул как различные сервер и очередей мы расскажем что из себя представляет приложение на базе тарантула в нашем проекте и на закуску мы обязательно расскажем как самостоятельно собирать собственные кластер и немножко для начала прояснил если вдруг этот вопрос был упущен что же такое тарантул трандл это но sql персистенции in-memory key и value хранилище но не только в tarantul и довольно неплохая производительность в tarantul и есть множество различных индексов помимо того что есть разные индексы можно делать составные индексы и можно создавать несколько индексов поверх одного space а ну что дает реальную свободу этого сочинение лоджии да это как и кооперативную многозадачность на базе файеров это каналы для синхронизации файлов это готовы библиотека для работы с сетью и возможность использовать и фифой для начала рассмотрим маленький простой пример чаще всего когда мы переходим сискель она но я склеил мы больше всего страдает от отсутствия джонов join и нам приходится делать за пределами базы данных если мы используем тарантул мы все равно можем сделать джо и если у нас есть несколько space of с родственными данными мы можем написать небольшую lua функцию которая приведена для примера которая выполнит по сути для нас join за 1 запросов ну давай не будем на этом заострять внимание перейдем к иным примером нам часто ну живо именно и данные например ac100 тины для скачивания или просмотры тактирования документов и сказал временные может быть возьмем memcache хорошие шине до 1 и старта но это же временные данные подумаешь перезапустим потеряем токены много мы потеряем токены пользователи теряют доступ к своим данным это особенно обидно редактирование хорошо говорил берем тарантул сего пирсе с тентом да но теперь на другая проблема у нас получились вечные тотен и данный вопрос можно решить мы добавляем полис экспорт ой мам кто кину мы на экспорт н вешаем индекс мы создаем фоновый файбер который удаляет устаревшие токены хорошо еще бы ни пуха статистику как сколько у нас тут и но сейчас как быстро они растут используя файбер и используя фоновую обработку и внешние соки ты мы можем с легкостью собирать статистику и сливать и его внешние источники например в графит да еще при завершении сессии пользователя нам необходимо удалить тотен а ведь он вышел без проблем добавим юзера идеи в базу сделаем еще один индекс по этому индексу будем удалять хорошо раз уж зашла речь о вам крыш давайте рассмотрим классический паттерн его применения нас есть приложение sql server с высокой нагрузкой 20000 select of 2000 авдей тов вероятно он уже не справляется с нагрузкой поэтому я там поставленном к.ф. я думаю данная схема знакома очень многим из вас зале то есть если столько человек поднимали руки про иски или про memcache то скорее всего вы знакомы с этими проблемами более того наш коллега обрисовал все проблемы которые возникают это происходит в основном из-за того что кэш и база данных являются раздельными независимыми сущностями ну представим что если на шкаф подходить в базу данных самостоятельно за недостающими данными к счастью в tarantul и есть готовые коннекторы к sql база камаз келью и к пост грессов замечательно ставим тарантул один тарантул одним иную точку отказа хорошо 2 ты уговорил я хочу еще отправлять часть запасов вы клику без проблем но коль уж ты сказал про реплику вот у нас там три тарантула моих как реплицировать будем зачем нам в данном за в данной задаче persistent ность нам не нужно мы выключаем их судьи выключаем снапшоты и радуемся производительностью погоди отключаемых слоги только что денисом говорил про проблемы с холодным стартом мы перезапустили крепло залегла это решаемо мы можем агрегировать запросы по ключу опасен бобер один запрос замечательно к нам приходит первый запрос напоминаю у нас был только что из tarth и данные в кэше нет кэш пуст мы проверяем наличие запроса к базе данных по этому ключу запроса нет в этом и только в этом случае отправляется за плоскость кавер серверу все последующие запросы создают канал ожидания и ждут канал это недорого не дороже мьютекс а когда сервер ответит данные попадут в кэш все каналы ожидания будут заполнены данными и приложение получит ответ также ответ придет на первый запрос может быть покажем код да и то в простейшем случае не больше 20 сук но пойдем дальше у нас возникла еще одна задача по хранению wales токенов ну стоит обратить внимание на цифры да у нас 10 миллионов пользователей соответственно около 10 миллионов wales токенов кто в зале знаком с технологией wales и работой с токенами думаю стоит поезд чуть-чуть пояснить но для тех кто не знает о знает большинство у токина есть время жизни у токина есть refresh токен то есть у нас один токен живет один час соответственно 10 миллионов токенов мы должны за час полностью обновить до если не ошибаюсь это две три тысячи запросов в секунду именно так в холоде при взаимодействии с внешними системами при распределенных системах очень часто принято использовать очереди мы не являемся исключением и под данную задачу мы тоже построили схему хранения с очередями подожди у нас несколько провайдеров очередей периодически один из них используют испытывают проблемы почему должен страдать все хорошо уже марианне сколько мы добавим несколько планировщиков и несколько очередей и целую группу обработчиков которые каждый будут работать со своим сервисом да уже лучше но давай вспомним о том какая у нас случае приоритет задачи на обновление dota на напрямую зависит от времени жизни сотен она но после x-terra он падает очень быстро почти до нуля до это довольно сложная логика довольно сложно реализуется на классических очередях поэтому для реализации очереди мы тоже взяли тарантул но когда мы взяли тарантул вы посмотрели что у нас тарантул под данные тарантул под очереди и логика в общем то легко переносится из очереди в тарантул у нас получился один тарантул в котором непосредственно хранятся данные в котором непосредственно работает логика очереди маркеры ходят непосредственно в этот тарантул так подожди но свадьбу планировщик планировщик больше не нужен у нас очередь работает по индексу который построен по типу токена и по его explorer тайму мы берем токены дочери де обновляемого во внешнем сервисе сохраняем обратно он сохраняется с максимальным экспорт ой мам и автоматом попадает в конец очереди мы помогаем автоматическую множественную кольцевую очередь двое перейдем к еще одну задачу с очередями мне кажется на интереснее возможно у нас и вы будете есть мобильные подписки их нужно проверять по требованию клиента клиенты у нас мобильная а следовательно с плохой сетью тут стоит заметить что подписки за проверяется во внешнем сервисе appstore и он тоже работает не всегда стабильно так как у нас было уже написано очередь мы и решили расширить доработать и улучшить и сделать из неё двунаправленную очередь когда к нам приходит мобильный клиент он имеет идентификатор подписки с этим идентификатором он создает задачу если ее ранее не было эту задачу берет обработчик и обрабатывает во внешнем сервисе если к по какой-либо причине клиент не дождался ответа либо у него порвалась сеть он повторно приходит с этим же заданием если задание еще в обработке он ждет если задание уже была обработана он получает результат сразу же то есть в этой очереди данные хранятся дольше чем в обычной прошу но очереди интересы в контексте приложения давай расскажем о том что представляет типичное приложение на базе тарантула у нас в облаке в первую очередь это интерфейс никаких прямых обращений к данным из приложения все взаимодействие идет на основе api то есть вызова процедур передача данных в обе стороны идет с упаковкой джейсон что очень удобно если конечно позволяет производительность здесь стоит заметить что на момент создания всей нашей инфраструктуры у нас в распоряжении был тарантул 15 это предыдущая версия если вы хотите вы можете использовать же сон точно так же и в 16 в современным но должен заметить что в торонто ли 16 есть довольно хороший эффективный протокол massage pack он компактный он бинарный он быстрее то есть если вам нужна максимальная производительность вы можете использовать massage pack но про давай пойдем дальше итак мы имеем api поверх база данных что-то нам дает высокий уровень изоляции возможность поддерживать несколько версий интерфейса возможность менять структуру данных логику в приложении и вадику внутри тарантула независимо а также возможность обновлять кот без десяти тарантула за счет замыкания не нарушается работа процессов которые начались в момент м давление но послушай ведь такая схема спокойно работала и на обычной москве делаем стоит процедуры вот у нас все то же самое да ну во первых это немного быстрее во вторых давай посмотрим что у нас под капотом под капотом у нас файбер и на их базе фоновая работка данных запись данных статистику мониторинг родирование что очень удобно возможность общаться с внешним миром на базе сокетов а еще втором туре есть коллектор тарантула то есть наши приложение могут общаться между друг другом по своему протоколу с чем мы активно пользуемся отлично ты сказал про то что один тарантул может ходить в другой тарантул да мы здесь плавно перейдем к теме шарден га тема sharding и так понимаю очень многих интересует все на нее очень живо реагируют знаете лучше и правила шарден га это не шарди данные вот если вы можете избежать шарден га лучше из бегите шарден гав но если по тем или иным причинам вы не можете избежать если вам ибо захотелось либо вам стало скучно либо у вас данные не вмещаются в память либо вам не хватает процессора для обработки вам приходится использовать sharding что у нас бывает у нас либо какое-то решение баз данных предоставляет нам готовое кластерное решение в виде шарден га либо она его не предоставляет то есть у нас есть просто сингл instance базы и если у нас база не предоставляет готового решения для шарден gotta что мы можем с этим сделать ну обычное решение у нас есть шанс функциям которые по ключу выдает нам интенсивный а куда мы должны пойти мы в зоне в отдельную прокси-сервер либо включаем этот функционал в приложении и все работает а если мы вдруг в какой-то момент вот что-то обновляли не везде обновили функцию вывод так лучше не делать но а если мы уже так сделали случайно и испортили данные на каком-то шарди может либо за проанализировать свои данные и исправить таком случае нас ждет долгий ручной разбор данных даты дня но если у нас база данных может ходить само в себя то мы можем унести функцию шарден гони посредства внутрь тарантула и в таком случае при обращении к базы данных мы вычисляем номер шар да и база сама решает на какой sharp нужно пойти то есть приложение не знают куда ему пойти за данными приложение может пойти на любую доступную ему ноду туве что-то быстро это ровно на столько же быстро как использовать промежуточную прокси крышу что у нас сша рингу с ришар генгам у нас все просто он у нас есть в предыдущем докладе вам говорили об одной схеме реализованной при помощи прокси также на базе тарантула на базе lua на базе коннекторов было сделано решение для шарден газ ришар dengan она в целом доступна на гитхабе вы можете его взять попробовать ну как вы понимаете тема шарлин га она довольна обширна и это вообще возможно тема отдельного большого доклада поэтому мы просто говорим что у нас есть sharding он есть на гитхабе вы его можете попробовать давай лучше расскажем как мы делали мастер мастер ну не совсем мастер мастер итак вернемся обратно задачи про тутин и добавим к ней сегодня высокой доступности что ты понимаешь под высокой доступностью иногда у нас выключаются сербина уходят становятся недоступными дата-центры случаются трагедии хорошо и что мы с этим делаем мы можем использовать мастер мастер репликацию для передачи данных на все ноды квартира я здесь делаю тоже еще одну ремарку в tarantul и 16 есть асинхронная мастер мастер репликация на момент разработки нашего решения тарантул 16 его мастер мастер репликации был не готов поэтому наше решение было сделано изначально налог на базе тарантул 15 то есть тарантулы ходят в другие тарантулы да именно так но что случается если вдруг между нодами теряется связанность на самом деле все просто как работает наш вариант репликации при поступлении данных любой из нот кластера она отсылает уведомление с остальным участникам о том что нужно сохранить данные как показано на схеме в один из connect of отсутствуют и соответственно один из серверов не сохранил данное что произойдет когда к нему придет запрос не надо данных у тебя участник власти зашлет запрос всем остальным участникам с которыми он имеет соединение и попросит найти данные у себя в данном случае данные пойдут ну а если у нас все совсем плохо вот все ломается все будет работать пока доступен хотя бы один из участников кластера тут стоит заметить да мы не требуем наличии большинства not властей что делают уязвимым данную конфигурацию сплету но мы считаем что в нашей конкретной конфигурации уход одного или двух нот более вероятен чем разделение их на той части мы подошли к концу доклада мира тихо выйти не тем что в нем нет или почти нет единственного иных решений нам нравится подход о котором мы рассказали мы считаем что вычисление рядом с данными это быстро и эффективно эта концепция очень хорошо ложится на тарантул поэтому из мы его используем основной слоган тарантула держите данные в памяти делайте вычисления рядом с данными и наслаждайтесь производительностью основной центральный слоган вычисляйте рядом с данными мы попытались вам описать обычно все занимаются либо измерением производительности либо собственно наслаждением производительностью мы попытались раскрыть вам возможности которая открывает вычисление рядом с данными на этом у нас всё вы можете почитать документацию про тарантул на его сайте вы можете также попробовать тарантул прямо из браузера на трой тарантул орг вы можете посмотреть репозитории а также те примеры которые мы описывали присутствуют в последнем указанном репозитории у нас осталось довольно много времени на вопросы и мы готовы на них ответить добрый день здравствуйте слушай я немножко по пользовал тарантул ну совсем чуть чуть и есть такой вопрос как же быть с обновлением кода если у нас кот лежит месяца с данными до учить как вы сказали вычисление происходит вместе с данными да как нам это все деплоить особенно если он с несколько инстинктов и еще раз пожалуйста нас происходит изменение бизнес стол и те нам нужны обновить приложение да у нас есть несколько работающих инсов да но та же самая проблема что с хранимыми процедурами в базах данных как там это все дело обновить так чтобы не было downtime так чтобы нам не опускать весь кластер да то что у нас мы обновляем одну ноту у нас там меняется бизнес-логика даны уже пишется по другому обновляется по другому на тех пастором но вот такие вещи если я правильно понял ваш вопрос он звучит так если аппликация кода в tarantul и возможно если если вы на него сейчас ответьте ему сожалению нет репликации кода нет на самом деле у нас довольно часто возникает задача обновления того функционала того функционала приложений который находится внутри базы мы это решаем либо поэтапно то есть сначала мы заменяем схему данных потом мы выкатываем обновления api например вторую версию и потом мы выкатываем новые данные потом мы убираем старые то есть это наиболее частая схема она проводится полностью без downtime а lua можно обновлять в runtime и без перезапуска базы также как и в общем то с обычными стоят процедурами в sql то есть вы можете просто на лету создавать новые хорошо спасибо не могли бы вы уточнить еще про persistent на из данных в том же радисты например я могу сохранять данные на диске довольно прозрачно там в контузию прописываю колье интервал между запросах между симками или этом в интро по времени правильно понимать что у вас и достигается допустим финком данных в москве или там какой-то традиционную базы данных и что для этого необходимо налог какие то дополнительно предусмотреть скрипты нет вы неправильно поняли тарантул может быть использован как не persistent на и хранилище то есть в нем можно отключить экология там такой же механизм которые являлись и используются там используется лак операции про него рассказывал dinis в предыдущем докладе то есть каждая операция ложится в их слог делается периодическое снятие snapshot а но они сильно ели мы хотим да мы можем дополнительно реализовывать вот кстати к предыдущему докладу был вопрос а как бы нам данные забрать и выгрузить например те которые стали холодными дамы для этого можем использовать коннекторы к стилю либо софию либо дождаться движок софия я ответил на ваш вопрос здравствуйте а можно просто короткий вопрос по коннектором к раку и есть коннектор прошу прощения и сказали что у вас есть коннекторы к базам данных вот здесь коннектор к подвесу есть мы искали а коробку и сканер высоты время как на разделили отдельности назвали нет нет и не планируется о планах вы можете узнать на стенде хорошо а также вы можете создать тикет на гитхабе хорошо спасибо если вам что-то требуется очень все классно мне все понравилось только есть небольшой нюансик из тарантул ну если ему такой xml рендеринг еще туда воткнуть то будет вообще прям золотое приложение но только у меня вопрос уже подойдите я вас удивлю бендеры суть внутри тарантула есть х ттп серверов написанный на lua у него есть рендеринга движок ну тогда вообще просто супер только есть небольшой нюансик да он же вас может хостится на кластере да там одновременно на нескольких серверах то удаленных так чтобы нагрузка на процессор равномерно распределялась до чем это может смотря что вы под этим понимаете если вы подняли один instance и хотите использовать вот все равномерно процессоры танец воду о процессор используется одно ядро под сетевую работу под все что можно вынести используются раздельные 3d нола процессор работает на одном ядре если вы хотите скиллинга по ядрам вам нужен либо sharding либо репликация по нескольким instant сам ну то есть нормальный такой алгоритм расчета каких-то данных дополнительных я там не смогу нормально сделать то есть параллельный ним со всеми передовыми технологию вас данных скажем так немного и вам не жалко их разместить в памяти несколько раз на одной машине у вас там много ягер можете поставить мастер к нему можете поставить сколько хотите реплики на репликах считать например так ну это слегка неэффективно это то на что нам пришлось пойти для того чтобы сохранить транзакционному целостность в лонг удобную транзакционному целостность в рамках ло машины в противном случае пришлось бы бороться с совершенно другим классом проблем присущим взаимодействия между thread'ами через ну я через модуль через балансировку это возможно сделать мы это сделали то есть да и вопрос вам парни когда на 1 и 6 перейдите это отдельные долгая история возможно на следующем хай роде будет доклад о том как быстро и прозрачно для пользователя можно переехать на с 15 на 16 на самом деле тут даже интересен фидбэк ваш чердак будет лично что ей больше все больше нет вопросов все вопросы закончена давайте поблагодарим наших коллег да хороший доклад"
}