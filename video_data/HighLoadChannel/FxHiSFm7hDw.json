{
  "video_id": "FxHiSFm7hDw",
  "channel": "HighLoadChannel",
  "title": "Нечеткое хэширование для детектирования спам-писем / Алексей Марченко (Лаборатория Касперского)",
  "views": 786,
  "duration": 2712,
  "published": "2021-10-04T02:47:02-07:00",
  "text": "коллеги здравствуйте как меня уже представили меня зовут алексей я работаю руководителем отдела развития методов фильтрации контента в лаборатории касперского проще говоря отвечаю за качество детектирования анти фишинга антиспама технологии родительского контроля и некоторых других сегодня я хочу рассказать вам про подход который мы выработали в конце предыдущего года для детектирования спам писем этот подход объединил в себе нечеткое хэширование кластеризацию и извлечение максимальной общей подстроки собственно для детектирования спам рассылок если конкретно то наш доклад будет поделен на следующие части вначале расскажу вам что такое спам наверное все себе это и так представляют но я немножко формализует а понятие вот расскажу почему это даже сейчас 2021 году является большой проблемой затем мы поговорим про методы детектирования спама как они вообще в целом устроены какое место в них занимает машинное обучение и плавно подойдем собственно к идее которую мы реализовывали дальше я расскажу вам что такое нечеткое хэширование кластеризация расскажу подробно про сам подход после чего мы поговорим про то как моего внедряли дело в том что наверное ни для кого не секрет что зачастую внедрение какого-то алгоритмы это может быть ничуть не проще чем его создании в конце мы поговорим про результаты которых нам удалось достичь правда достичь в продакшене и поговорим также про дальнейшие планы которые мы видим для развития нашей технологии и в самом конце конечно я отвечу на вопросы максимально подробно стреляют и так давайте начнем самого начала что вообще такое спам существует множество определений слова спам мы в лаборатории касперского придерживаемся небольшое запаздывание отлично мы в лаборатории касперского придерживаемся следующего определения спам это массовое не запрошенной рассылка причем оба фактора являются ключевыми что касается истории появления спама то еще до того как появилось само понятие спам и на самом деле до того как появился интернет в таком виде в котором мы знаем его сейчас первые спам рассылки принято считать рассылку deep 78 года верить у йорк маркетолог is digital equipment corporation разослал реклама их нового продукта просто по всему своему контактному листу по всем кого он знал общественность достаточно негативно это восприняла и принято считает что это как раз и есть та самая первая спам рассылка с тех пор спам порядком эволюционировал и помимо ну такое относительно можно сказать безопасной цели рекламы он также начал преследовать и другие значительно более опасные цели такие как мошенничество распространение фишинга распространением алвари и ddos-атаки ну и конечно многое другое если говорить более конкретно то в начале 2021 года уже можно сказать первой половине мы выделяем следующие основные тренды в спаме это blackmail да то есть ситуация когда кто то кого то шантажирует по почте это массовое такое мошенничество сейчас распространением алвари письма с предложениями о заработках пассивный доход выше лотереи компенсации за коронавирус реклама тот самый тренд еще зародившийся в семьдесят восьмом году и так и оставшиеся с нами до сих пор рейтинг обычно этой рассылке каких-то сайтов знакомств или мошенничества когда кто-то должен к вам приехать но стоит оплатить ему билет и не будем погружаться слишком сильно имел fishing категория которая пожалуй является одной из самых опасных с точки зрения финансового ущерба потому что здесь как раз приходится максимальные потери и и mailbox да это тот самый доз почте он бывает разных видов на самом деле эта история заслуживающий отдельного доклада но сейчас мы говорим не про эту итак дальше я хочу показать вам некоторые примеры реальных спам рассылок супер значит сейчас на экране вы видите пример реального письма который рассылает малварь здесь вот zip-архив чек на самом деле в нем вирус и собственно письмо призывает вас его открыть и посмотреть что там еще один пример это как раз те самые заработки пассивный доход 8 половиной тысяч долларов день принципе это неплохо следующий пример это дейтинг здесь дженни предлагает нам посмотреть ее фотографии но для этого придется сходить по очень стрёмный ссылки вот я бы не рекомендовал и последний пример который сейчас появится после некоторой задержки на экране и это как раз почтовые fashion когда в данном случае вам пишет про то что ваша посылка была возвращена в пункт а из которого она окружала здесь подделка под крупную компанию курьерскую вот и вам нужно заплатить всего 2 доллара для того чтобы отправить ее снова итак переходим собственно к следующему слайду здесь мы поговорим про то какой вообще ущерб бывает от спама то есть чем это вообще все плохо дело в том что для физлица скажем так ну для обывателя для пользователя интернета спам это что-то вроде шума со стройки то есть он как бы где-то там есть он может быть вам иногда докучает но реального ущерба он вам не приносит вы просто берете эту песчинку и кладете и в джанг в общем проблема для вас решено ситуация драматически меняется когда мы говорим про крупные компании дело в том что спам он нарушает непрерывность бизнеса переполняет почтовые ящики сотрудников и приводит к повышению собственного времени которые люди тратят на свои ежедневные активности чем это плохо представьте что вас каждый сотрудник полчаса в день тратит на то чтобы письма при перекладывать jambox ну чтобы отфильтровать свои легитимные письма который хочет почитать от спама представьте что вас компании 100 тысяч человек представьте что стоимость часа каждого сотрудника 10 долларов в день и вот вы уже полмиллиона долларов теряйте ежедневно на перекладывание спамов jambox вторая проблема которая появляется в организации связи со спамом это что спамом как я уже говорил приносит с собой фишинговые ссылки и малварь и это уже приводит к серьезным финансовым потерям но например бухгалтер может куда-то не туда перевести деньги ну или вашей машины сети могут закрепит алопеции соответственно вам придется как-то справляться с последствиями умножается это все на количество спама согласно нашим исследованиям 2020 году более 50 процентов писем почтовом трафике были спамом да то есть реально каждое второе письмо а нас памирская также в общем выводом из предыдущих пунктов является то что согласно публичным отчетом ущерб нанесенный спамом коммерческим организациям исчисляется миллиардами долларов вот это реально большие деньги ну так в общем напугал теперь давайте поговорим про то как вообще борются со спамом конечно методы тактирования спама развиваются на самом деле практически так же долго как сам спам здесь много чего сделана и сейчас мы поговорим о том как в целом работают все методы у них есть нечто общее и так как обычно выглядит задача детектирование спама вы собираете какие-то данные у вас там попадутся из памирские письма и легитимные письма затем вы в них выделяете рассылки то есть группируйте письма по похожести скажем так выделяете каждую из рассылка отдельно затем вы фильтруете легитимные письмам то есть убираете оттуда все что вам не нужно детектировать затем вы проводите анализ и выделяете характерные признаки для каждой спам рассылки в конце концов вы упаковываете эти признаки в какой-то транспортируемый формат который потом можно будет применять в других средах ну и собственно рассылаете этот эти сигнатуры по всему миру и по всему миру детектируется похожий спам профит чтобы по подробнее разобраться как это все работает нам нужно будет сначала понять что вообще из себя представляет электронное письмо наверное многие знают но мы все равно пройдемся по этим пунктам это совокупность трех факторов первое это информация об отправителе сюда входит альпи адреса отправителя то сервер который непосредственно инициализировать mtp сессию и также smtp from адрес это адрес куда должно прийти отбивка о не доставки сообщения но и некоторое другая сессионная информация это полностью технические как бы момент и конечный пользователь получатель письма и вообще не видит ни как дальше есть заголовке письма это набор технической информации в письме который регулирует большое количество вещей которые используются mail юзер и джинда то есть ваш mode луком для отображения письма здесь есть и какая-то информация техническая которой вы увидите но там например фронту да то есть часть который вы не увидите этого контента и plain white chicks мейлер и прочее прочее прочее ну и последнее это собственно тела самого письма здесь ну как все знают то может быть текст ну и конечно же вложение картинки да и вообще на самом деле любой другой бинарный контент поговорим про каждую из этих про каждый из этих элементов отдельно собственно заголовке письма заголовки как я уже сказал описывают как видимую информацию так и невидимой информации на самом деле современные почтовые фильтры современной почтовые сервера современные почтовые программы да вроде outlook они накладывают достаточно большое количество ограничений на то как эти заголовки должны быть составлены нельзя туда напихать что ни попадя и отправить письмо он просто может не дойти до адреса до или не отрисоваться поэтому и в легитимных рассылках и в спамер ских рассылках все обязаны следовать этим правилам к чему это приводит приводит к тому что с по мирам тоже приходится формировать длинный длинный список заголовков и конечно же они оставляют там некоторые зацепки за которые методы детектирования могут цепляться вот в частности от правильно подобранная правильно подобранный набор заголовков или правильно набор подобранный набор признаков из заголовков позволяет создать уникальную сигнатуру который описывает всю спа мерзкую рассылку двигаемся дальше информации об отправителе но как я сказал здесь у нас есть айпи адрес smtp from 8 to from есть домен до в частности в этом адресе и это позволяет нам составляете репутационные списке айпишник из которых идет к спам или домен из которых идет только спам это хорошо работает потому что опять же есть ряд соглашений ряд технологий которые регулируют что вы можете указывать например smtp from в частности technologies pf и поэтому подставить то что угодно не получится а значит это дает нам некоторую реальную информацию за которую может зацепиться для того чтобы рассылку по детектировать ну и последнее это тело письма здесь огромное поле где можно развернуться здесь у вас и лексика в письме да то есть какие-то характерные для спамеров выражения и конечно же ссылки которые ведут иногда на фишинг иногда на что-то еще ну и конечно здесь есть вложение картинки которые тоже можно поанализировать хотя это зачастую сложнее в какие вообще есть проблемы с анализом заголовков и отправителя вот казалось бы зачем вообще лезть в текст письма вот состоим репутационные списке опишем спам рассылки по заголовкам не проблема решена текст вообще не придется анализировать дело в том что есть виды спама для которых заголовки и отправитель будут абсолютно хорошими и легитимными в частности спам отправленные через формы обратной связи как это атака работает спамер просто заходит на какой-нибудь большой крупный сайт там есть формочка обратной связи свяжитесь со мной он вписывает в e-mail запрашивающего обратную связь email жертвы а свой спам текст вставляет в поле комментарий нажимает кнопку запросить обратную связь что делать сайт такой ситуации он отправляет поэтому и мэйлу оббивку вы попросили обратную связь на таком сайте и цитирует комментарий ну собственно спам текст доставлен а доставляет его хороший проверенный сайт с хороших проверенных серверов с хорошими проверенными заголовками проблемы bags котором еще один вариант не буду сейчас описывать этот относительно сложная схема но смысл в том что используется плохо настроенный почтовый сервер абсолютно легитимный хороший прилежащий к в it-компании и при помощи но он delivery репортов то есть отбила к не доставке письма отсылается тоже контент пользователя ну и в конце концов есть веб майло клауд да любой из нас может зайти на какую-нибудь крупную паук площадку и создать себе там почту и послать мне что-нибудь конечно владельцы этих площадок они борются с исходящим спамом там продвинутые технологии но а не дают стопроцентной защиты и мы в частности в своей статистике видим достаточно большое количество спама улетающих с подобных площадок хорошо значит придется анализировать текст некоторых ситуациях если здесь какие-то проблемы до проблемы есть и первое это за шум лени и спамеры отлично понимают все они знают что текст наверняка будет анализироваться и они намерены его за шум ляют допускают ошибки используют 5 сквотинг unicode spoofing этой техники в которых вы например берёте слово спам и вместо английской буквы и пишите русскую букву а для читающего это выглядит абсолютно точно также как исходное слово но с точки зрения автоматизированного анализа это абсолютно другой набор юникорн их символов также перебираются синонимы и то есть в разных сообщениях одной и той же рассылки используется с какие-то слова синонимы или условно подходящие по контексту там например в одном предложении в одном письме из рассылки будет click here to get your board другом будет click here to get you price меняется одно слово смысл точно такой же но уже нельзя как бы сказать что целиком вот такое предложение во всей рассылки содержится в конце концов языки спам отсылается на всех языках мира а если там с европейскими языками вы можете мне возразить но там все наверное взяв google переводчик как-то там смогут понять что все таки в письме написано но когда речь идет про катить эксклюзивные языки там хинди и урду на которых тоже идет спам здесь вам понадобится целый штат переводчиков и профессионалов для того чтобы анализировать текст этих писем и эта проблема да это огромные касты собственно здесь мы получается очертили задачу которая нам надо решить у нас есть спам письма у которых все в порядке с отправителем которых все в порядке с заголовками и текст которых сильно зашумлен и очень трудно анализируем как текст даст лингвистической точки зрения то что на разных языках с разными перебираем и синонимами и тому подобное собственно прежде чем мы перейдем к идее которая к нам пришла мы должны немножко разобраться с техникой сейчас я вам расскажу что такое нечеткое хэширование возможно некоторые из вас ним уже сталкивались в процессе своей работы кто-то не сталкивался любом случае не четко хэширования это такой вид не криптографического хэширования который порождает хэши обладающие и красным уникальным свойствам чем сильнее отличаются исходные данные которые мы их аширова ли тем сильнее лексические отличаются полученные хэши ну и соответственно оборот чем похожи данные тем похоже хэши как это работает в основе нечеткого хэширования всегда лежит простая идея давайте исходные данные нарежем на кусочки про фишеру им каждый кусочек а потом просто этих и шить и склеим получится такая длинная длинная длинная хэш строка да но если кусочки были в исходных данных одинаковые то они будут одинаковыми в этих и шах существует масса реализации нечеткого хэширования мы сейчас поговорим о таком типе который называется контекст 3 герпес вайс fishing он отличается от остальных тем как именно выбираются вот эти вот точки отреза для кусочков которые мы проходим традиционным хорошо посмотрим например слева для вас он находится окажется справа значит у на этом примере мы видим что у нас два очень похожих текста но во втором случае у нас добавились какие-то слова да поэтому средняя часть отличается если бы мы смогли нарезать этот текст вот так как выделено цветами то все было бы неплохо потому что когда мы сложим кусочки хэши от каждой части у нас будет отличаться только средняя часть а это как раз то чего мы хотим на вопрос как же так нарезать ведь если мы нарежем просто по количеству символов на равные отрезки то у нас кусочек зеленого скажем так попадет в синяя да ну по понятным причинам собственно в сити печь до в контекст игр вписываешь fishing используется так называемый роллинг хэш который позволяет эти кусочки на скажем так выделять исходя из маленького окошка контекста рядом с точкой отреза как это работает у вас скользит хэш который покрывается на 5 например там 78 последних байт и как только он принимает некоторые специальное значение вы ставите точку отреза почему это срабатывает если вы посмотрите на два этих примера которые сейчас на экране вы увидите что в них в обоих есть один и тот же контекст в районе точки отреза да вот это о вания и провело да то есть в этих точках у нас rolling ешь и в первом и во втором случае примет одни и те же значения значит мы в одном том же месте поставим точку отреза собственно перейдем к следующему этапу у нас появились какие-то хэши я сказал что они лексически похоже но это надо как-то формализовать начали физически похоже не глазами их сверять есть функция которая позволяет и тех ешь и сверить между собой с точки зрения как бы математического расстояния математической дистанции между ними называется эта функция дистанции левенштейн а если просто на пальцах объяснять то работает это следующим образом это количество изменений которые надо сделать в одной строке чтобы получить другую при этом под изменениями имеется это добавление символа удаления символа или замена символа математическое описание функции вот здесь но мне кажется на пальцах и и проще значительно понимать собственно чем хорошо вообще дистанции левенштейн это тем что на дистанции математическом понимании этого слова на является метрикой точно удовлетворяет правило треугольника она всегда не отрицательно и если вы переставите а и б в ней да то есть ее параметры то дистанции не изменится до то есть от точки а до точки б дайте то же самое что от b до это нам сильно пригодится а пока что давайте поговорим про то где вообще используется фазе хэширования сейчас она активно используется во 1 в системах антиплагиат а потому что как раз модификации одного текста это очень удобный случай для применения есть повторяющиеся фрагменты текста кто-то его украл и модифицировал но соответственно нечетко хэширования позволяет за эти точки зацепиться и выделить их и хэши получится действительно один ок ну не одинаково похоже да детектирование малварь и то же самое а злоумышленники модифицирует исходный код своего вируса для того чтобы он не детектировать с обычным традиционным hашем чтобы нельзя было от него им до пятку посчитать и дальше все файлы у которых такая же md пятка забанить но здесь опять же нам на помощь приходит фазе хэширования которое в похоже в бен арах выделит эти элементы похожести ну и конечно поиск похожих изображений похожих аудиозаписи и похожих видеозаписей все это покрывается нечетким кэшированием то есть важный момент на который здесь нужно обратить внимание это то что нечетких широ вне работает с данными как с бинарными данными она никак не лезет в их структура просто есть гомологии в виде похожих последовательностей байт в исходных данных будут гомологии в шах собственно теперь мы подходим к предпосылкам идеи да и нашего подхода который мы разработали мы посмотрели на тексты писем из одной и спам рассылки вот есть вы приглядитесь не знаю сможете ли вы с такой расстояни действительно приглядеться но в них очень много общего и очень много разного одновременно если даже прочитайте первую фразу то для тех кому не видно я прочитаю и оценки сам матч хочу zeng аура online streaming solutions первом случае fences focusing on internet streaming сервис во втором случае и finds a lot for selecting an internet streaming solutions третьем случае да то есть смысл один и тот же но обвиняется слова-синонимы немножко меняются глаголы и вот уже непонятно даже за что здесь зацепиться я не поленился и выделил здесь все отличающиеся фрагменты да точно то что вы длина красном отличается то что выделено белом не отличается если приглядеться то получится что того что не отличается процентов 40 50 и мы подумали и тоже не так мало информации до 40 50 процентов остаются неизменными даже в такой сильно варьирующийся рассылки может быть их можно как раз каким-то образом зацепить может быть как то вот эти вот элементы кусочки похожести в исходных письмах можно за детектировать собственно еще на что я хочу обратить внимание здесь есть достаточно длинная общая под строка мы потом вернемся к этому это нам поможет на последних этапах но здесь я просто хотел отметить что она одинаковая во всех этих письмах и так собственно в чем заключалась наша идея собственно все достаточно просто давайте исходный текст и писем мы запишем в виде и четких и шей а дальше используя дистанцию и левенштейн а в качестве функции расстояния от класса рисуем их наше предложение было что в результате мы выделим спам рассылки итак следующим этапом для нас стал выбор алгоритма кластеризации на самом деле здесь если вдуматься есть достаточно много ограничений ну во-первых алгоритм не должны опираться на точки за пределами исходных данных до какой-нибудь cummins который требует посчитать средним между меня . нам не подключат к средней между двумя хэшами непонятно у нас все таки как бы объектные данные во вторых нам не известно количество кластеров никто вам не скажет сколько спам рассылок у вас есть в исходных данных кластеры не имеют четкой формы то есть нету никакой гарантии что плотность каждого кластера скажу так и форма его будет одинаковый для разных спам рассылок ну и в конце концов у вас присутствует шум в виде легитимных писем до развивали бизнес письма каких которые не принадлежат ни к одной рассылки нам надо их как-то отфильтровать и как-то жить с ними в результате мы выбрали dbsk почему нам показал что он хорошо подходит для этой задачи собственно три причины начала я напомню что такое дабы скан в принципе это плод нас но и алгоритм кластеризации которая основан на выделении компонент связности он использует понятие соседство между двумя точками и прямым следствием этого является то что ему не нужны центры кластеров там нет такого понятия и как следствие не требуется считать промежуточной точке в пространстве только определять соседстве между точками он позволяет находить кластеры произвольной формы в частности он позволяет находить один кластер окруженный другим не каждый алгоритм кластеризации так может ну и он умеет прекрасно работает зашумленным и данными вот это буква м в самом конце это applications но из то есть умение работать шумом прямо в аббревиатуру зашита прежде чем мы перейдем к эксперименту и каким-то результатам я хочу вам рассказать про небольшую оптимизацию которую мы применили дело в том что если вы вспомните как вот эти в фазе их ишида нечетких ешь и формируются вы вспомните что там есть кусочки данных в хорошей за кашированная да то есть маленькие кусочки информации так вот идея простая если у двух ушей нет ни одного общего курса . ни одной общей гомологии значит и в исходных данных не было ни одной скажем так общий единицы информации да и получается нет смысла пытаться скал авторизовать между собой хэши у которых нет ни одного общего кусочка а и это позволяет нам нарезать исходные данные на непересекающиеся группы чем это хорошо в худшем случае для запуска на вам придется посчитать r-квадрат расстояний в вашей коллекции из n элементов так вот если это н вы разобьете на две непересекающиеся группы например пополам то несложно понять что количество по парных расстояний которые вам придется считать для каждой группы она значительно меньше в сумме чем количество по парных расстояний во все исходные коллекции и это позволяет существенно социализировать количество вычислений собственно почему я хотел обратить внимание на эту оптимизацию она может быть применена не только в нашей задача там связанность детектированием спама а в любом случае когда вы работаете с нечеткими хэшами просто знаете вы можете поделить исходные данные на ней пересекающиеся группы используя вот это прекрасное свойство и так мы подходим к эксперименту мы подумали хорошо у нас есть идея некоторого 2 шагового алгоритма давайте попробуем его каким-то образом оценить для того чтобы это сделать мы собрали коллекцию спам писем из наших ловушек туда попала 145000 спам писем и поделили ее на 2 под коллекции 1 под коллекцию мы назвали известный спам а вторую под коллекцию мы пометили как неизвестные письма почему мы так сделали зачем вообще этот прием нужен дело в том что ни одна методология детектирование сейчас не работает в одиночку обычно в продукте есть множество множество различных методов и другие методы помимо того который в этом придумываете сейчас они позволяют про часть исходных данных заранее знать что это спам потому что они тоже что тут фиксирует мы хотели конечно же учесть этот эффект нашем эксперименте чтобы оценивать качестве нашей технологии не в одиночку а в совокупности с другими методами детектирования плюс к ста сорока пяти тысячам спам писем мы давали 45000 легитимных писем собранных из различных источников здесь были и массовые легитимные рассылки на которые мы подписались было и частично личная переписка сотрудников лаборатории касперского и частично письма полученные из публичных коллекций и все эти письма мои маркировали как неизвестные и свой эксперимент мы видели следующим образом давайте попробуем при помощи нечеткого хэширования кластеризации каким-то образом вот эти вот 90000 неизвестных спам писем разметить на а мы не спам как мы это сделали мы взяли смешали с известным спамом и класса рисовали и дальше мы фиксировали следующей ситуации если легитимное письмо из неизвестной коллекции напомню они все как у нас неизвестное помеченные оказалась в кластере только с другими легитимными письмами или не оказалось ни в каком кластере мы можем сказать что это тру негатив но потому что мы не смешать легитимные письма со спам рассылкой если у нас спам письмом 1000 горя так легитимное письмо попало в кластер со спам письмами и the force позитив мы его определили в спам рассылку значит детектировать и как спам плохо дальше если у нас неизвестная спам письмо попало в один кластер только с известным spawn или только с известным и неизвестным спамом ну то есть условно говоря autostar в котором есть только спам письма то мы говорили что это труп позитив мы верны и вот классифицировали ну и в конце концов если у нас неизвестная спам письмо не попал ни в один кластер это наше упущение мы вынесем не собрали и не можем сказать она легитимные нелегитимны это фолз негатив собственные результаты у нас получили следующие здесь собственно мы варьировали параметра эпсилон в допускания не стал указывать конкретные значения параметров вот из целей безопасности потом на докладе моего коллеги никита bing о вич если посетите вы узнаете почему плохо писать гипер параметры в публичных отчетах но факт в том что мы при всех значениях видели достаточно высокий при сезон да то есть у нас достаточно точно все работало и мы очень редко фал'си ли здесь вот количество файлов последней колонке указаны этой 45000 действительно немного при этом при достаточно больших значениях эпсилон нам удавалось добиться достаточно высокого рикулло уже практически 80 процентов мы посчитали что это нам подходит дальше мы и все он уже не наращивали потому что при более высокие значения количества фаллосов еще росло на большее количество мы уже не были согласны собственно наверное на текущий момент у вас сформировался ко мне один большой вопрос пора ли нам расходиться потому что мы вроде как за дизайн или эксперимент . грета мы разобрались предметной областью мы сделали алгоритм мы за дизайне ли эксперимент мы получили результаты они нас удовлетворили но в общем все можно сказать дело сделано если вспомнить в самом начале я говорю про то что интегрировать какой-то алгоритм может быть ничуть не проще чем его создать так вот дело в том что если вы вдумаетесь мы сделали алгоритм который требует огромного количества данных но их нету когда у вас почтовое защитное решение работу вас одно письмо обрабатывается над сказать спам это или не спам данных нет у вас нету мощностей нужных в почтовом решение да то есть у вас там ну вы продаете какому-то клиенту свое почтовое защитное решение и говорите купе еще 10 серверов мы там чего не тебе пока ласты рисуем но он скажет вы что совсем что ли нет не буду ну и в конце концов у нас нету времени да то есть одно письмо у вас представьте на клиенте идет поток там тысячи писем например в час вы не можете задерживать их на пять часов чтобы что-то с чем-то там пастеризовать вас нету времени большой вопрос как это вообще интегрировать как это использовать собственно здесь мы переходим к следующей нашей теме это архитектура нашего метода это как мы его внедряли прежде чем мы поговорим конкретно про наш метод я хочу вам показать архитектуру в принципе защитных решения на достаточно скажем так общая всегда и здесь можно выделить некоторые важные особенности у вас есть клиентская среда в которой у вас установлен продукт для почтовой защиты и есть какие-то входящие письма с памирский низ памирский но и соответственно продукт для почтово защиты их просто раскладывает в inbox и не спам а спам спам folder здесь у вас следующие характеристики у среды а во первых у вас здесь мало данных во вторых у вас здесь малой мощности и очень жесткие требования по скорости работы но нельзя бизнес переписку задерживать на часы с другой стороны у вас есть инфраструктура вашей компании где у вас большие мощности большое количество данных и полный контроль над процессами того что происходит поэтому как обычно делают в инфраструктуре обрабатывать большие объемы данных потом формируют из них некоторую выжимку и уже эту выжимку доставляют до клиентской среды где ее используют для проектирования очередного письма спам это или не спам здесь стоит еще отметить то что канал между этими средами он дорогой но представьте что вас миллион клиентов вам нужно каждые десять минут отправлять им по одному мегабайту просто представьте себе объем трафика из стоимости да поэтому конечно через этот канал нужно пропускать как можно меньше итак сейчас смотри миль от резюмируем мы приходим к тому что считать кошельку срезать в клиентской среде попросту нельзя нет необходимых данных нету необходимых мощностей нет времени и нет возможности удобно проконтролировать качество так как же быть обратимся снова к тому примеру спам рассылки которые я показывал вам когда говорю про идею использовать нечеткое хэширование помните я скажу что там есть достаточно длинное общая под строка вот мы подумали а что если в большинстве рассылок все-таки можно выделить достаточно длинный уникальный кусок которые затем можно использовать как простую сигнатуру для детектирования спама но просто смотреть если такая подставка встречается в каком-то сообщение значит она из той же рассылки не встречается значит не из той же в чем был бы плюс если в нам получилось такого достичь ну во первых это очень легковесно текста мало и он сжимаем отлично поэтому и вот через этот узенький канал его будет легко и дёшево передавать его легко применять всего лишь нужно применить поиск подстроки это очень дешевая операция никаких вычислительных ресурсов не нужно ничего кластере заводь хэшировать и легко интерпретировать да то есть глядя на эту строку вы посмотрите да здесь уникальная ряда чисел k относительно уникальное есть обрамленное достаточно большим количеством слов вряд ли такая под строка встретиться еще где-то в каких-то сообщениях вероятность невысокая собственно и это привело нас к идее так называемых спам терминов то есть под строк характеризующих уникально с по мерзкую рассылку мы спросили себя хорошо мы хотим еще поэкспериментировать давайте попробуем поискать эти спам термина но как нам этого добиться нам нужен какой-то алгоритм который будет эти постройки общее находить вас есть пам рассылка вы ее уже скала store завали там 1000 писем как найти в них максимально длинную общую подстроку есть готовый алгоритм точнее говоря семейства алгоритмов лангуст commons об string extraction которая позволяет как раз находить максимально длинный общее подстройки в зад на множестве текст существует куча реализации они разные с точки зрения перформанса разные с точки зрения внутренней реализации мы выбрали вариант на генерализованных суффикс ных деревьях потому что он нам показался наиболее привлекательным с точки зрения перса собственно здесь стоит отметить что не каждая максимальная длинна я общая под строка это хорошая подстрока то есть хороший спам there на почему потому что вы можете натыкаться на общее не для спам рассылки подстроки в принципе для почтовой переписки вот как например красный пример на экране ли slap me now if you и ты не крещен tanks такой можно встретить где угодно включая бизнес переписку это очень общая фраза поэтому перед нами встает задача надо еще как-то момента чтобы эту подстроку найти отфильтровать те случаи когда у нас попал туда какой-нибудь дисклеймер а конфиденциальных данных скопированных из легитимного письма или вот например окончании письма в таком виде собственно для этого мы внедрили фильтрацию под строк мы выделили два класса фильтров первое это по виду под строки дело в том что мы мгновенно обнаружили мощнейшую корреляцию на общий на поверхности лежит между тем насколько под строка длинная интим насколько она уникальна характеризует рассылку чем длиннее тем лучше вот малое количество слов тоже плохо и соответственно плохо когда нет идентификатора вы помните в той нашей под строке которые мы обсуждали до этого там есть 39.99 от на самом деле очень жестко прибивает эту подстроку к этой конкретной рассылки по коллекциям мы подумали хорошо если мы ищем подстроку которая характеризует данную конкретную спам рассылку не должна на характеризовать другие спам рассылки был бы странно что не такая уж уникальная для этой спам рассылки поэтому в качестве фильтра мы ищем получившуюся под руку в других спам кластерах до которые мы получили на этапе кластеризации си где-то еще в текст находится мы говорим нет это плохо ну и конечно присутствие в коллекциях легитимных писем в интернете огромное количество доступных коллекции там тоже коллекция урона где вы можете поискать получившийся подстройки посмотреть встречались ли они когда-нибудь каких-то легитимных письмах мы повторили наш эксперимент но на этот раз мы добавили еще один шаг в самом конце смотрели сколько валидность спам терминов мы сможем получить после кластеризации и здесь вот на что хочется обратить внимание да у нас очевидно при маленьких значениях эпсилон то есть когда кластеры получаются более плотными получается больше валяных спам терминов построить почему потому что у нас более похожие письма в кластерах и соответственно более длинные общее постройки находится очевидной корреляции самое важное то что даже для наших желанных значений dbsk на эпсилон до параметра мы получали где-то 50 процентов конверсии 50 процентов случая получалось построить валидные спам термины мы решили что для первой версии это хорошо в дальнейшем и конечно показатель значительно улучшили и сейчас продолжаем работать над тем как повысить его ещё ещё ещё выше собственно давайте теперь обозрением все в целом у нас есть четыре шага в нашем алгоритме сперва превращаемся в нечетких ешь и затем эти нечетких ешь и кластере зум затем извлекаем максимально длина вообще подстроку и в самом конце фильтруем плохие подстройки теперь как это все ложится вот в ту глобальную архитектуру защитных решений про которые я говорил и вы наверное уже догадываетесь но это будет не доклад если мы это не проговорим смотрите у нас есть клиентская среда туда идут входящие письма и мы должны их классифицировать на спам не спам мы и спам ловушек получаем похожие спам письма относящийся к тем же спам рассылка смешиваем их с коллекции уже известных нам спам сообщение получено при помощи других методов детектирования превращаем в каше и сохраняем соответствие текстов и хэшей класса рисуем отсеиваем легитимные письма которые у нас выделяются там как шум и из получившихся спам кластеров даст вам рассылок извлекаем максимально длинный общей подстройки для этого нам приходится естественно паху шоу обратно вернуться к текстам вы лидируем их и отправляем в продукт для почтовой защиты через вот этот узенький канал через который отлично пролезает хорошо сжимаемый текст ну и соответственно продукт для почтовых защиты мы просто ищем подставку для детектирования спама и это класс собственно сильные и слабые стороны этого алгоритма давайте их коротенечко разберем а сильными сторонами является 36 дешевизна трафика до при доставке такого дефекта до в виде таких сигнатур простота в интерпретации дать тут вам не приходится оценивать качество кластеризация вы можете посмотреть на реальный скажем так выхлоп всего алгоритма дано подстроку которая вас получилось и скорость детектирование клиентской среди от самый главный факт слабые стороны временные затраты на получение спам термо вот давайте к этой схеме вернемся вот смотрите полетела спам рассылка она попала одновременно в ловушке одновременно во входящие письма но нам нужно успеть провернуть вот этот весь pipeline и отослать пам термин клиенту за это время письмо уже может к нему прийти и провалиться в inbox эта проблема на самом деле для ее решения существует несколько подходов но самое главное здесь это так называемый карантин подозрительных писем вот мой коллега до вечера сатаной никита белькович будет на докладе который будет следующим правда в другой аудитории проходить как раз рассказывать про то как построить карантин на машинном обучении чтобы вот эти вот он верительные письма придерживать на время пока мы разберемся действительно ли их нужно по банить и как именно по банить ну и собственно большие затраты в инфраструктуре это на самом деле не такая большая проблема потому что в инфраструктуре как вы знаете достаточно дешево можно закупать ресурсы их можно достаточно эффективно оптимизировать под разные задачи и это не тоже самое что предлагать каждому клиенту покупать по 10 серверов поговорим про результаты запуска самое интересное то вообще то все полетело или так и осталась на этапе теоретических экспериментов до таблички и рассказа про то как это все было интересно делать полетела запустили технологию мы полгода назад приблизительно в начале октября 2020 года и с тех пор она опубликовала более 50 8000 спам терминов валидным и на наших пользователях да у которых сна наш продукции фиксировал более 25 миллионов спам писем мы регулярно выпускаем новые технологии поэтому я могу как бы сравнивать эти числа с другими различными запусками это очень хороший результат то есть технологии действительно привнесла свою большую лепту детектирование спама собственно здесь пара примеров как она хорошо сработало на некоторых рассылках вот пример рассылки на английском языке где технология мастерски вырезают общей кусочек из середины несмотря даже на то что сообщение здесь даже разные по форматирование говоря уж про текст здесь на русском языке в общем-то тоже самое у меняется как бы начало меняется концовка но в середине сохраняется некоторой общей кусок и за который можно зацепиться и он такой длинный что никогда вам больше нигде кроме той спам рассылки не встретиться вы помните я говорю про языки я не знаю про что эти письма я думаю что большинство из вас тоже не может определить на глаз на что мы можем определить на глаз это то что в них есть действительно общей фрагмент и при помощи мощнейшего переводчика я убедился что он действительно уникальный собственно что дальше как еще можно развить эту технологию мы сейчас видим два основных направлениях помнить у нас не очень хорошая конверсия в спам термины до 50 процентов ну неплохо но он недостаточно хорошо и что мы исследовали и частично уже использовали это весовые спам термины смысл в следующем но представьте что у вас есть много много общих подстрок но только в совокупности они уникально описывают рассылку да хорошо бы им дать весна катин ну там не знаю 0.3 каждому если нашлось больше трех там можно сказать раз нашли все вместе значит detect второй вариант развития это не самые длинные подстройки ну представьте вас есть вам рассылка куда спамер вставил огромный дисклеймер о персональных данных скопированы из легитимного письма утром вниз и когда вы анализируете эту рассылку вот этим алгоритмы вы всегда находите этот дисклеймер длиннющий одинаковый но где-то в начале есть общая подстрока поменьше которая уникальна описывает эту рассылку которую можно забанить значит надо искать не только максимальные подстройки на и вообще анализировать какие общие подстройки есть может быть выбирать не самую длинную а предыдущую по длине это все что я хотел сегодня вам рассказать и собственно сейчас у нас наступает время вопросов спасибо итак у кого есть вопросы из зала на у нас пару вопросов добрый день игорь и шатало кинокомпания костя с семья до вопроса что такое спам ловушки и используете ли вы машины обучения для определения с по местам да спасибо за этот вопрос спам ловушки и это в общем скажем так некоторые то есть как вообще рассылается рассылка да у вас есть некоторый список адресов если вы там спамер представим такой ужасный расклад вы берете по всем этим адресам рассылаете письма да то есть достаточно как бы спамером попасть вот в эти вот списки рассылок для того чтобы начать получать копии спам писем которые они отсылают пользователям в интернете ну и собственно да то есть ловушка это некоторые там домен зарегистрирован и еда на которые можно получать спам за счет того что он попадает вот в эти с памирские списке что касается машинного обучения для детектирования спама да мы его используем на самом деле у нас на бэг-энде есть технология которая по виду спам письма может сказать спам от или не спама на на основе по бустинга работает вот а также у нас есть ряд технологии облачных которые мы используем в качестве скажем так одни одного из факторов для детектирования спама то есть они не говорят точно спам не спам они горят мира письмо подозрительное но если совокупности выполнился еще какой-то признак например машинное обучение по виду ссылки предсказывает что она вероятнее всего фишинговые тов на стыке этих факторов мы уже письмо заболеваем как у нас бы ничего вопрос да добрый день у меня такой выбрасывать вы говорили что вы изначальный текст письма анализируйте там считаете нечеткие хэши и потом уже смотреть глазами за этих вот а вы в общем можно же его еще при подготовить то есть там убрать лишнюю пунктуацию там с тренировать и брать данные предлоги и все такое чтобы еще больше общих деталей выделить да спасибо за этот вопрос на самом деле мы это делаем я опустил этот момент потому что он является не очень существенным данном случае он не позволяет избавиться от основной проблемы которые решает метод на самом деле в принципе когда мы анализируем тексты для любой методологии детектирование мы стараемся их чуть-чуть хотя бы нормализовать вот но здесь стоит отметить что на самом деле в реальной жизни это далеко не всегда помогает потому что это нормализация конечно не убирать уникальный spoofing с синонимами она никак не работает да но и спамеры постоянно придумывает что-нибудь новенькое да сегодня запятые просто дублируется там после слова а завтра в середине слова появляется маленькая маленькая юникодная . так у нас ещё вопрос здравствуйте спасибо большое за доклад у меня вопрос следующего плана в ходе экспериментов по кластеризации вы отмечали что у вас было сто тысяч помеченных спам писем но не было ни помеченных но обычно хороших писем вот почему это было сделано так объясню потому что мы не можем набирать какие-то актуальные коллекции скажем так нос опять что-то со звуком я тоже здесь пока не закончен что-то происходит у нас есть вопрос из онлайна пищу а вот язык очень интересно давайте я быстренько да да да да да да брось а пока можете формулировка повторить чтобы я по точнее ответил почему в ходе эксперимента по класса лизации было 100 на 100 тыс помеченных спам писем но не было никаких помеченных обычно хорошим до в общем отвечу так что и мы делаем все таки технологии для детектирования спама да и поэтому у нас есть другие методы при помощи которых мы можем точно сказать что что-то является спамом да но если считает что detect не строго сто процентов то вы не можете говорить какие письма являются точные легитимными то есть в обратную сторону это приложение не работает вот поэтому мы конечно хотели отталкиваться в первую очередь от того что мы точно знаем что является спамом и эту информацию точно можем использовать водка легитимным письмо к сожалению это неприменимо плюс легитимным письма есть такой момент что мы конечно очень ограничены в сборе таких коллекций потому что если спама можем актуальней свежий поймать в ловушке то легитимные коллекции найти в интернете очень тяжело и их очень ограниченное количество вот и конечно же здесь намного проще отталкивался от спама и так итак давайте поблагодарил нашему спикера зауч интересный доклад там хорошо так лучше вопрос все должно звучать учить прямо сейчас сейчас выбрать выбрать то добавляем 5 частично мне честно говоря больше всего понравился последний вопрос спасибо"
}