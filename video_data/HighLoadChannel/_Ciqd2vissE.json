{
  "video_id": "_Ciqd2vissE",
  "channel": "HighLoadChannel",
  "title": "Как создать высоконагруженную систему отправки уведомлений по событиям / Артём Гашкин (ЦФТ)",
  "views": 1461,
  "duration": 2224,
  "published": "2019-12-05T08:24:53-08:00",
  "text": "доброе утро меня зовут артем я сегодня расскажу как мы создавали высоко нагруженную систему по отправке уведомлений по событиям я работаю заметили направление разработки процессингового центра карт стандарт и занимаясь архитектурой процессинга ну естественно участвую в разработке сервисов карт стандарты в области тружусь больше чем боль больше 10 лет и я бы на этом догнать и хотел поделиться своим опытом и надеюсь что вам он пригодится в при разработке ваших сервисов немного цифр и фото это очень крупная эти компании россии и это подтверждается множеством рейтингов мы работаем на рынке финн тех xfp два направления бизнеса это автоматизация банковской деятельности и бизнес золотая корона наверное все вы слышали о денежных переводах золотые короны возможности гасить кредиты в любом банке россии о программах лояльности например спасибо от сбербанка это продукт центр финансовых технологий а транспортных карт от транспортных картах в системе город то есть коммунальные услуги можно платить не выходя из дома в интернет-банке faktura.ru ну и я работаю в процессе нам центре карт стандарт немного корр стандарте корр стандарт это крупнейший процессинговый центр в россии по работе с международными платежными системами виза мастеркарт ну и теперь еще и мир нашим процессинге обслуживается наверно порядка 120 банков и около 50 миллионов карт другими словами каждый третий россиянин пользуются услугами к стандартно ежедневные условий основе мы при этом ничего не знает о к стандарте чтобы чтобы понять в чем заключается суть доклада немного терминологии что такое processing процессинговый центр по факту это программно-аппаратный комплекс который включает себя как софт так и железо процессинговый центр отвечает за две вещи за все процессы которые связаны с выпуском карты это называется эмиссия из-за все процессы которые связаны с обслуживанием карты это называется эквайринг два важных термин дальше рассмотрим сам процесс покупки то есть авторизации это процесс обработки запроса по карте например покупки вы пришли в магазин оплачиваете покупку по карте в этот момент терминал передает запрос в processing эквайер и processing акаиро передает запрос в платежную систему а дальше платежную систему уже передает запрос в processing банка-эмитента например вы покупаете товар там в ленте или в другом гипермаркете каком-нить там есть терминал терминал принадлежит какому-то банку так вот этот банк это банк эквайер соответственно какой карты вы расплачиваетесь владелец этой карты это как раз банк-эмитент так вот пункты 1-4 этот процесс обработки авторизации соответственно как только вы что-то оплатили processing должен информировать об этом владельцы карты и он это делает посредством sms информирование либо push либо еще чего при этом в банк-эмитент все эти авторизации попадают как-то пост-фактум но это за скопом этого доклада на этом останавливаться не будем но наступил момент когда банки эмитенты захотели получать эти уведомления об операциях оба авторизация в онлайне для чего например они договорились с оператором сотовой связи каких-то льготных тарифов либо еще такой сценарий банки хотят делать индивидуальные предложения предложения своим клиентам ну в авторизация то есть вы совершили покупку а вам приходит кроме 18 кроме информации о покупке еще какое-то не данное предложение о вкладе а кредите или еще чего-то такой банке захотели таким образом получать уведомление прям сейчас вот и как раз пункт 51 это и цель нашего доклада мы определили цели нашего проекта для начала нам необходимо было реализовать модуль отправки уведомлений который справляется с нагрузкой x2 на processing конкретной нагрузки на processing я здесь говорить не могу могу сказать о том что нагрузки нагрузка на отдельные модули системы процессинга у нас достигает 200 транзакций в секунду вот и вторая цель проекта это разработать модуль который борется с проблемой увеличении нагрузки за счет изменения настроек системы ну другими словами не хочется возвращаться к вопросы производительности как можно дольше чтобы работать над другими проектами проектов у нас очень много теперь сформулируют требования к решению которые нам нам были озвучены во-первых решение должно быть горизонтальным масштабируемым но это уже обычный практик такие тревоги дальше уведомление по одному клиенту должны отправляться последовательно это естественное требование каждый хочет получать и sms уведомления в последовательном порядке уведомление должны быть доставлены гарантированно как минимум один раз очень важное требование работа модуля никак не должна заметить обработку авторизация то есть весь в традиционный цикл должен также выполняется очень быстро и наша модуль в давлений не должен замедлять процесс обработки авторизации но из этого следует что модуль должен держать минимально возможное количество соединений с базы данных ну что это значит у нас oracle oracle горизонтальный масштабировать если можно то очень сложно вот поэтому у нас у нас база данных она во первых очень сильно нагружены и ввод в промышленную эксплуатацию любого нового обработчика это всегда дополнительная нагрузка на базу данных поэтому нам нам требовалось реализовать модуль который держит минимальное количество соединений с базы данных только то что надо для этого мы выбрали кафку почему потому что у нее колоссальная огромная пропускная способность увеличение количества потребителей горизонтально увеличивает производительность ну и собственно кафка это распределенная система которая работает в классе если какая-то одна нота упадет у нас система как работал так продолжит работать дальше немного эскиз диаграмм как это у нас все работает владелец карты выполняет какой-то в традиционный сценарий после этого после совершения этой авторизации события поэтому авторизации попадает в очередь после этого это событие подхватываются модулем отправки уведомлений и отправляется в банк секундочку еще раз основной остановимся на терминах что такое событие события в данном примере это факт обработки авторизации что такое уведомление уведомление это конечный способ представления этой авторе этого события ну то есть это в нашем случае это джейсон в этом джейсон и джейсон не уходит информация о покупке это место совершения покупки сумму покупки ну и другие какие-то дополнительные реквизиты этой авторизации так вот мы построили наш модуль и какова его архитектура для описание архитектуры рассмотрим жизненный цикл обработки события сначала сначала все абсолютные авторизации попадают в общую кучу в какой-то глобальный входящий топит первый компонент нашей нашего модуля это модуль роутинг роутинг отвечает за маршрутизацию то есть он его роль фактически простая определить кому это событие принадлежит какому банку и его цель переместить события из этой общей куче в конкретный входящий топит конкретного банты то есть как только события попала во входящий топик банка дальнейшая его дальнейшая обработка дальнейший жизненный цикл обработки этого события уже будет зависеть только от обработчиков конкретного банка то есть обработка событий 1 банка никоим образом нельзя не сказывается на процесс обработки другого события ну например у нас какой то банк есть как который дает нагрузку там 50 транзакций в секунду а какой то банк у него там одна транзакция в секунду мелкий банчок такой модуль маршрутизации он просто раскидывает эти уведомления соответственно дальнейший ход обработки этих событий уже зависит от обработчику конкретного банка и все второй компонент всей этой нашего модуля это модуль его называется м хендлер это компонент который отвечает за создание уведомлений по событиям то есть он лезет в базу и вытаскивают оттуда какую-то дополнительную информацию но основную информацию о событии место совершения покупки сумма покупки и другую информацию то есть его основная роль только взять события из входящего топика конкретного банка сформировать по нему уведомления и переложить его вот исходящий топик банка и все его роль только сходить в базу и создать уведомления последний компонент который у нас работает это непосредственно модуль отправителя за что он отвечает он отвечает только за отправку уведомлений то есть он просто берет уведомление которые уже есть в топике и отправляет его в банк все то есть каждый компонент отвечает только за свое причем после маршрутизации за дело берутся конкретные обработчики конкретного банка и эти обработчики для каждого банка они свои и их работоспособность никак не сказывается на обработчики другого банка других банков для того чтобы выбрать вариант реализации мы провели исследование цель нашего исследования это измерить за сколько времени 400 тысяч записей будут перемещены из одного топика в другой но вопрос почему 400 тысяч четыреста тысяч это потому что мы считаем что это недопустимый простой нашего процессингового центра ну то есть задачи исследования другими словами можно сформулировать так за сколько processing восстановит свою работоспособность после какого-то большого сбоя какие начальные условия у нас были две для исследовать ввергнута звуки пир и 3 но тыковки 2 топика каждый из топиков по 3 партиции то таки партиции руется но все ноды ну и соответственно мы в 1 топик сохранили 400 тысяч записей какие у нас были варианты реализации для начала мы просто замерили сколько времени мы у нас этот весь процесс займет если мы не будем дожидаться от катьки результата переноса мы это пробовали через кавказ 3 мы продюсер без ожидания достатке и это все у нас за него восемь секунд ну минус это то что мы не знаем переместилась запись или нет ну как бы это решение для нас не допустимо но мы по крайней мере знаем сколько это времени займет это восемь секунд дальше мы попробовали реализовать это перемещение через продюсер с синхронным ожиданием достатке ну что это значит мы взяли какую-то пачку и по каждому по каждой записи мы ее переносим в следующий топик дожидаемся ответа от катки с мета информации ну и дальше берем следующее следующую запись ну и так далее по циклу последний вариант реализации которые мы пробовали это продюсер с асинхронным ожиданием доставки как конкретно мы ну собственно продюсер с асинхронным ожиданием доставки для этого варианта реализации время переноса у нас было от 20 до 30 секунд и мы остановились на этом варианте решения есть посчитали то что 20 секунд на восстановление после какого-то тяжелого сбоя ну это вполне достаточно вот дальше как мы собственно это сделали собственный его самый главный вопрос на самом деле на самом деле у нас было требование о котором я говорил все уведомления по одному клиенту должны быть доставлены последовательно это наше требование и читаем в документацию катки кафка гарантирует что если последовательно послать две записи в одну партицию топика они будут иметь последовательные а все ты ну вот и как бы мы можем наши требования удовлетворить таким образом нам достаточно просто по одному какому-то клиенту по одну по то по одной карте все авторизации всегда сохранять в один в одну партицию топика и кафка или коска сама гарантирует то что все вся дальнейшая обработка будет производиться последовательно ну и как бы чтобы забыть я обработала всего лишь всего лишь один раз надо выставить соответствующий настройки вот они вы можете почитать документацию на так необходимая необходимость это наши требования сейчас я вам покажу как мы собственно реализовали асинхронные ожидания через некоторые псевдокод для начала мы консью миром забираем пачку какую бочку запись что дальше мы бежим в цикле по каждой записи для каждой записей определяем партицию куда мы сохраняем буквы q в какую партиции мы будем переносить наши события ну как мы это делаем мы просто по индикатору клиента считаем хождением по модулю на количество партийцы ну вот и мы имеем фактически гарантированно то что все события по одному клиенту попадут одну партицию собственно дальнейшие действия продюсер неправильно написал мы переносим с помощью продюсера эту запись в конкретную партицию и запоминаем ключи и фьюче запоминается в каком-то списке таким образом мой в цикле накидали сначала всех этих все эти записи в кафку а дальше а дальше мы просто бежим также уже по списку этих сохраненных фьючерсов и по каждому этому списку мы получаем результат в этой информации нам приходят куда мы сохранили в какой-то так в какую партицию из и в нем еще хранится а в свет куда мы сохранили эту запись и нам осталось после этого костюмером закомитить синхронны нашу транзакцию вот собственно как бы и вся реализация на самом деле она на поверхности но чтобы до нее догадаться пришлось почитать очень много документации вот дальше я покажу график скиба на чем такой мелкий прокомментируем внутри внутри нашего подразделения мы определили какой то наш внутренний слой пусть это будет две секунды то есть две секунды это достаточно времени для того чтобы это приемлемое время для отправки уведомлений в банк то есть пока чистили человека станет телефон ему уже придёт из карманов ему уже придет sms вот и мы видим то что на данный момент но у нас выполняется наш внутренний ссылаясь запасом то есть мы уведомление в банке отправляем где-то за полсекунды если надо будет как-то ускориться но мы ускоримся вот дальше на самом деле что делать в случае если нагрузка увеличивается например был какой-то банк у него была какая-то стабильная нагрузка ну например на 20 транзакций в секунду банк rose rose rose клиентская база росла 1 го росла и теперь у этого банка нагрузка 50 транзакций в секунду мы это видим и собственно что надо делать в этом случае нам необходимо просто увеличить количество обработчиков для компонент который отвечает за формирование уведомлений и для компонента которые отвечают за отправку этих уведомлений в банк дальше сценарий например у нас по каким-то причинам уведомления стали медленно доставляться до банта ну канал просел либо сервер банка начал тупить либо он в конце концов там были новогодние праздники он лег его там недель неделю он лежал мы накопили огромное количество огромное количество уведомлений для отправки в этом случае мы можем что сделать мы можем временно у увеличить количество обработчиков для отправления и он и этот модуль эта компонента модуля которая отправили которой есть отправитель для конкретного банка в приемлемое время доставит все накопленные уведомления в банк и это никак не еще раз подчеркну это никак не скажется на даст на доставки уведомлений в другой банк в остальные банки вот мы еще рассмотрим один сценарий это например то что у нас по какой-то причине уведомления для банка начали формироваться медленную но я не знаю база маленько начинает по ту плевать либо еще что то в этом случае для того чтобы мы успевали отправить до клиента банка банка не все уведомления мы можем увеличить количество обработчиков для компонента которая создает эти уведомления ну например временно либо на постоянной основе и тем самым мы добьемся того что уведомление будет формироваться и достал являться в в приемлемое время но еще отвернемся нас на несколько слайдов назад вот на вот этот сайт на жизнь и цикл обработки события на самом деле на самом деле у нас получился некоторый фреймворк другими словами модули маршрутизации роутинг а модуль отправки событий уведомлений они как работают так и работают за всю прикладную логику за бизнес-логику отвечает только модуль который формирует эти уведомления то есть в в контексте вот на моего доклада мы наша задача была сформировать уведомление об авторизации если нам ну а нам в скором времени это потребуется сделать наверняка например нам потребуется отправлять быстро одноразовые пароли в банке по совершению операцию то в контексте следующих задач нам необходимо просто будет реализовать новые варианты обработчиков ems finder и это будет просто какая-то доработка сбоку и никаким образом новой обработчики на текущий функционал повлиять не смогут то есть все регрессионные тесты которые у нас есть они будут проходить и не не будет и не будет требовать никаких доработок ну и того то есть у нас была реальная инженерная прикладная задача реализовать быструю гарантированную доставку уведомление в банке с минимальным возможным количеством соединений с базы gun задачу гарантированные доставки мы решили с помощью кафки собственно количество соединений с базы данных у нас зависит от количества обработчиков настроенных на банке и конфигурируется через настройки модуля если нам требуется увеличить количество обработчиков мы меняем настройки обработчики запускается потом меняю настройки назад возвращаем значение обработчики был удаляются примерно так спасибо вам за вниманию вопросы привет артём спасибо за доклад я хотел бы я хотел бы спросить про модуль rating которого использовали как вы написали это обычно приложу к на джаве который сбоку написано или это коварен будь вы использовали котовске вообще использовали гориллами шкаф cqe и нет у нас и у нас реализация спринт был тыковка для взаимодействия скатка мы используем обычного клиента к кавказская котовского у нас это собственноручно написано компонент мы вручную вот как вот так псевдокод написано мы вручную выбираем записи их перекладываем к митинг это собственно реализации вообще довелось использовать курилович какой нет нет не доводилось спасибо артем с доклад можно вопрос по количеству банк out сервисов ну то есть как я понимает каждый нет у нас на самом деле реализации нас пилинг пути у нас это единый jar очень удобно получилось мы запускаем jar дальше высчитываются конфигурационной настройки из базы данных поднимается необходимое количество там консьюмер of продюсеров и все это начинает само по себе работать а для за горизонтально масштабируется нескольких серверах разместить да да да да да у нас горизонтальном масштабировании то есть управление через звуки пюре несколько серверов это все автоматически работает и грубо говоря это все только один архив да да это то есть было требование от наших прикладных администраторов конфигурирование должно быть удобным и они должны просто запускать приложение и оно должно работать и как бы настройки каждого компонента они внутри этого джара границ спасибо себя почему был выбран а имя кафка или сравнении с другими какими-то решениями на самом деле у нас сильно времени думать не было у нас был положительный опыт реализации накатки предыдущего модуля и он был очень он был положи положительный и мы выбрали его в качестве решения для текущего проекта до текущей задачи можно ну да вот у меня вопрос собственно как я понимаю вы для того чтобы ограничить количество транзакций всю необходимую информацию для отправки сообщения получали в самом начале а дальше она просто лежала трамп кафки не совсем вот я говорил об рассказывала понятие события и уведомления так вот когда только события сохраняя создается мы в кафку складываем только фактически идентификатор авторизации и и и его протаскиваем до до момента формирования уведомлений как то есть как только события дошло до туда вот тогда вступают себя вступает дело в дело обработчик по созданию уведомлений он уже формируют уведомления и это джейсон уже переносится в исходящий топик ну да вот а теперь у меня будет вопрос то есть а что если но я надел каких-то действий ну предположим на авторизовался и и накопилось очередь сообщение ко мне а потом я захожу в банк и меняю номер своего телефона а в сообщениях которые стоят на отправку у меня возможно еще старый номер остался а не потеряются смотри не совсем так то есть мы отправляем уведомление в банк а кому отправлять это уведомление решает band то есть если ты в этот момент ну как бы поменял телефон успел сообщить это в банк банк поменял у тебя в настройках анкета там номер телефона мы уведомления про mv bank они как они клиенту а банк уже посмотрит в номер телефона не отправят тебе его на надо же задание банка я понял это все абсолютно стране банка всем привет назову биксель спасибо за доклад у меня пару вопросов может выйдет контейнер перекладываешь продюсера chose в общем лишь там асинхронно перекладываете какой фолловеры если как общения кафка развалилась на ключ и еще дальше блокируется полностью мы будем мы во-первых никами team мы перезапускаем консьюмер рестартнем консьюмер а и продюсера и пытаемся так что-то улетела как бы ну она улетит и она при повторной обработки еще раз может улететь на самом деле таких как бы но еще прецедентов не было вот ну то есть мы по факту случай если мы не получили ответа от катки мы рестарте мы консьюмер и продюсеры и папа повторяем процесс обработки этой пачке это жгут в рестарте как ну у нас кормили рестарта мы фактически на прикладном уровне мы консью мира удаляем и создаем заново то есть моего по факту удаляем немного себя приложение внутри добавляем за да это имени самотыков перегружаете да не сам оправку перегружаем да мы перегружаем именно прикладным действием прикладной обработчик и еще вопрос а вот получается система перекачки дочери dior cherie данники каскад такой даррен мониторить и снова то вы автоматически где-то там где-то подступила даты скапливается очередь но где-то видите в динамике карта реагируем сизо пикс но таких есть или это все у нас прикладные администраторы насколько я помню мониторит на данный момент кафку через borrow'd linked-in а вот ну наша задача состоит том что еще вручную написать ни интернета в процессе посева меня зовут деннис спасибо за доклад вопрос следующего характера вы говорили что у вас один jar-файл соответственно конфликте тоже наверное лежат вот нам месте что потребуется сделать кафки в вашем случае чтобы там добавить новый банк добавить новую моду в общем всю систему берти юрист перри стартовать или как-то по-другому устроен на данный момент для того чтобы добавить новый банк необходимо завести необходимые настройки на уровне база данных то есть на файловой системе них хранится никакая информация обо конкретных банков то есть все все настроечной информация хранится в базе на текущий момент надо будет ли стартовать по нового обработчики и соответственно перед этим всем необходимо создать там топики для банков то есть как бы все предварительные действия сделать в базе настроить и просто перезагрузить модуль на каждом сервере в отдельности ну то есть глобальную систему не режет очередь проспери загрызть но это на данный момент то есть в целях в дальнейших планах у нас стоит релиза реализация перечитывание перечисленный строить базу данных периодической спасибо пожалуйста друзья еще вопросы на парочку есть время пожалуйста а тут уже коллеги начали задавать вопрос такое получается здесь новый банк это не отдельный джорджик не нет это смотря если например такая ситуация вот по поводу нагрузки на этом посмотрел один топик это 3 партиции ну партиции это пример был а это пример это примерно вообще сколько выделяете у нас ты чё там но обычно кратно там 2 3 4 порядка четырех и вас больше меньше ну для пикников у нас больше для обычных банков на нас 10 партийцы по-моему так но я точно не поминутно не знаю на настройки по моему есть и еще один вопрос по поводу каско стрим не смотрели стоит стороны рассматривали не смотрели не смотрели то есть нас было ограниченное время на реализацию и у нас собственно был положительный опыт моего перри использование спасибо артему спасибо за доклад а вот логика подготовки сообщений для каждого банка на своей чем-то отличается но она может быть переопределена для требований банк может быть если если она и если требуется мы переопределим насколько она очень отличается для разных бланков можно не сильно то есть если какому-то банку необходимо что-то на своем мы можем сделать кастомный обработчик и запустить его под банк но мы стороны все на самом деле все наши решения мы стараемся масштабировать на все банки и это как все обобщить то есть это у нас остановиться мы процессинг у нас много банков мы стараемся не делать кастомных разработок спасибо спасибо да быстро спасибо за доклад подскажите какая у вас нагрузка . какую нагрузку выдерживает от вашего построенная система это может быть как как к я пиковая нагрузка которой он от 1000 до 3000 tps она выдерживает то есть мы скажем так ты перед тем как запустить все это в промышленную эксплуатацию нам надо было убедиться что наше решение работает как мы это сделали мы фактически создали сервер банка на своей стороне и все уведомления по в банку мы запустили на наш сервер то есть нагрузки качество ps у нас выдерживать спасибо артем кому подарим книжку за лучший вопрос мне понравился вопрос про номер телефона если я успел поменять номер телефона в банке то что там будет они убежали а вот к вам бежит очаровательные барышни спасибо большое артем тебя в dice менты и"
}