{
  "video_id": "UyRBouT6vZQ",
  "channel": "HighLoadChannel",
  "title": "Как выжать 1 000 000 RPS / Андрей Аксенов (Авито, Sphinx)",
  "views": 5401,
  "duration": 2644,
  "published": "2023-01-19T05:55:16-08:00",
  "text": "времени как обычно не хватит доклад называется как выжить миллиона рпс лимона наверное не знаю с чего важная предыстория какого черта мы вообще вдруг занялись те подобной деятельностью потому что нам не нужен миллион рпс даже те меня зовут андрей я воронежской было интересуюсь информационным поиском и работаю в малоизвестной компании авито командую там группу инфраструктура поиска держим на руках основной поиск этого самого авито там несколько сотен миллионов пользуются запросто в сутки там миллиард или два технических неважно поиск у нас на некое спец зубы д как я или последние много лет стараюсь называть все равно утверждать что-то полнотекстовый движок под названием space war клоду поиска у любого поиска в любом месте любого мира даже загробного достаточно особенной и это не olap это не will цепи это не нечто что-нибудь привычные условно говоря это так называемое тяжелое чтение с моей точки зрения в чем суть у нас есть понятное дело и так называемые легкие чтение ну то есть так прилично привычный там happy workload которые там 10 15 миллисекунд занимают или даже меньше то есть 50-процентный перцентиль по все эти нагрузки она довольно невысокая и плевать на нее длинный хвост очевидно создает относительно тяжелые запросы которые относительно долго исполняются 95 30 снят с продаж 230 миллисекунд 200 300 м сек иногда она больше а там в периоды неизвестно чего там 350 и т.п. нетрудно посчитать что если у нас 95 перцентиле это 300 миллисекунд 3 запроса в секунду с ядра даже на 100 спальном сервере в смысле двуспальным с двумя процессорами и под сотню тредов там дай боже три сотни рпс этого сервера в секунду будет так мы и живем последние 20 лет были поисковой движок мы не редис мы там не знаю не спаси господи под grease или что-нибудь еще вот у нас нету супер легковесных запросов системы мы там большая хэш-таблица и как бы persistent на и но нет вот и мы хотим делать много-много очень легких очень супер быстрых запросов в секунду и у нас во рту от другой наш типичный запрос это мы жарим ключевые слова вытягиваем наш типичный тяжелый запрос который жидкость о цепью вытягиваем ключевые слова ранжируем 2 миллиона документов легковесной формулой тяжеловесны эмаль моделью ля ля ля zhu zhu zhu рпс всю жизнь маленький будет маленький и я не думаю что когда-нибудь на скажем так основном в арку где у нас когда-нибудь будь там не знаю условный 100000 рпс сервер тем интереснее было при случае по забивать гвозди отверткой не предназначенный для этого по расскажу как забивали что из этого получилось по большому счету весь доплат история одного профайлинга и тех конкретных странных мест которые вылезли конкретно у нас понятное дело насколько они будут у вас применимы или нет не понять надеюсь что будет только по минимуму как минимум интересно вот я как обычно не уложусь в той wing скорее всего из остина меня будут сбивать палками и я еще как бы накидал вам идеи для фидбэка конструктивного по мотивам всех предыдущих фидбеков разумеется будет слово я бы стараюсь удержаться от других слов но не гарантирую и зато гарантируя определенное количество математической латыни это будет хуже чем слово а и конечно же обман вскрою в 5 раз предыдущие четыре были в аннотации клик клик миллиона рпс не будет мы не выжмем ровно миллион рпс может быть больше может быть меньше посмотрим в конце дело в том что как я рассказывал нам не нужен миллион у нас три сотни и нормально для нас миллион не цель это направление мечты и мы лежим в направлении мечты потому что у самурая нету непроизносимым только этот как его с палочка еще по нему ходят путь до тем не менее путь возможно при велел чему-то интересному поехали на кой черт мы вообще занялись этим непонятным занятием под названием давайте выжми много-много рпс далекие прав of concept для колец соседней группе внутренние заказчики у которых возникла такая задачка они хотели достаточно часто для начала раз в сутки потом по быстрее загружать и в пофиг что достаточно большой csv хоть какими-то грубо говоря им to me абсолютно не важно какими и что это были за данные для этой задачи с выходов была умеренно большая несколько миллиардов записи быть чем быстрее загружаем тем лучше чаще сумеем перезагружаете и после этого начинается чистой readonly нечистая выборка по ключам какие-то немного более интересные запросы им тоже были нужны в основном выборка по первичному ключу мы таки white мы убьем по нашим ожиданиям индексация будет быстро быстро и вот с поиском наверняка какая-то параша образуется проверили так и вышло сделали первый тест индексация из коробки работает нормально за несколько секунд в 1 евро вместо там условных несколько часов на и спальные базе данных без наркомат кого тюнинга поезд дает чудовищном малое количество тех самых корпусов сраные 10000 подчеркивают для нашего про да это нормально у нас там порядок меньше как ни странно для заказчиков это было теней потому что у них на начальной стадии планировалось сильно меньше нагрузка от моменту когда бы она разогрелась но наверно мы бы что-то придумали уже с оптимизирует вот но конечно же мириться с таким было нельзя не задело что сознался взялся знающий человек наш военком и вот challenge цептор начали оптимизм все что сумели оптимизм и счастью все свои заметки за предыдущие два года я продал бал точнее я продал бал половину а по второй половине и не удается установить полной картины кроме того она не сходится сегодняшний сегодня мне выдали абсолютно такой же железо которое было тогда я меряю не получается вообще ничего но зато у меня свежие результаты и адекватные современным предсказать реале еще изменилось не знаю мерил два запроса на в основном все все гонки происходили на 2 запроса ходил совсем тупой который не делает ничего неких q1 который мне дает тем самым просто не и верхнюю границу что в принципе возможно выжить с той или иной системой и 2 мясной собственно интересовало в конечном итоге и интересовало производительность по интеллекта в банальных там select звезда всему дроздов из-за тестовой таблицы на 300 миллионов записи и дескать сколько это будет давать рпс 10000 рпс вот на этом вот курином смех и это неприлично на машине где сотней один поскольку у насыпи а ему нашего малоизвестного движка это из play наш собственный используя лепта через mais quel протокол то выбор бы и слайда совершенно очевиден давайте возьмем какой дисплей myspace мысли неважно какой конкретной версии они отберемся от него все получится тут у меня в этом сезоне возникли отдельные сложности с тем чтобы получить нормальные цифры потому что первые десять миллисекунд первые 10 секунд bench пока у меня моя цель выдает 700 до 1000 ps с полочной нагрузкой всех ядер потом куда-то дропа еца ну по до 200 до 25 но пофиг как бы да но тем не менее что тогда что сейчас я из него порядок одного миллиона в рпс выжимаю там 700 тысяч девятьсот может быть если его потянет удастся выжимать 1200 кажется совершенно неважно потому что мне плевать там сколько конкретно я выжимаю смысл или мне жизнь стрельцов интересно выжить и папки мезек ну отлично bass line подсказывает что при чувствами не подвели и вполне возможно на этом work лоре делать свой заветный 1200000 это запредельно мало конкретно запредельно мало выглядит вот так на примитивном запросе который вообще ничего не делает упираемся судя по всему в сетку и так оно и есть а точнее даже не все сплав модель обработки сетки это значит не нужно эзотерическое знание о том что он в москве или дефолтные режим обработки в летающих сетевых соединений это один прибитый гвоздями трэп к каждому сетевому сокету он влетают connect очередной ему выдает с его личный трек это трата занимается и сеткой и обработкой запросов и всего подряд это не так удобно managed когда маленький тим запросов и там все 10 кей проклятый в этом случае дефолтный трек пул который у вас работает лучше но вот для таких бенчмарков и для таких уровней нагрузки такой режим работы но он лучше так сложилось как-то так вышло что этот режим работы у нас сразу был и пришлось его тупо включить нажатием кнопочки но то есть правкой конфига заодно была идея о том что может быть мы люто бешено опиливаем локаторы заодно я еще и джея молок включил жизнью запроса который не делает вообще ничего резко перри можно наладилось вместо сотни тысяч фпс стало практически полтора миллиона рпс но у всех решетка задача решена но нет это не то задача я выяснил что оверхедов на обработку грубо говоря сетки парсинга запроса и еще не пойми чего у меня действительно нет ну а не адекватные по меньшей мере москва ль там делает два мульта я делаю полтора хорошо какого чёрта у меня на интересным не нормальном запросит 12000р ps ну хорошо вот есть потолок в сетке если бы это был потолок в сетке я бы и на q1 такую же проблему видел я ее не вижу дальше понятное дело но как бы капитан очевидность тут вот этот плач все дела включаем профайлер это красивая картинка я статьи никогда не смотрю я смотрю унылые текстовые дампы и профайлер четко показал ups и но тем не менее мне здесь небольшой интернет как вы думаете по какому графику двигается типичная оптимизация подобного характера когда вы знаете что программа должна работать в 100 раз быстрее чем она работает сейчас правильно график profile скажем так разгона этой оптимизации всегда будет выглядеть абсолютно одинаковым образом первое что вы найдете первое что вылезет на этом профиле это будет какой-то чудовищный актер который вас тормозит в разы или в десятки раз и после этого уже вы будете выгрызать дальше из гранита науки отдельные процентики а слава богу у человечества есть фотоаппарат фотоаппарат и конечно же мы все знаем что вот есть например такая линия как циклоиды эта линия качения линия которая формирует . зафиксирована на колесе вот есть красивые еще всякие название вот и петра например что это такое я не знаю потому что вчера сам нагуглил выйти в википедии многие ли здесь сдали пользуются jira есть такие люди я плохо вижу сейчас а вода а таким образом вы знаете что вот эта спринт и burn down чарда вот тоже знаете такие словами увидели некоторые уже поменьше руб но тем не менее я кажется что примерно десяти процентным сдала знакома вот это важная кривая она называется пениса это это типичный спринт в ходе которого команда занимается разработкой что 10 а в самом конце достал двигает ticket и так вот при чем тут пенису это дело в том что готовясь к этому докладу да вот у кого-то желаем фантазия сейчас практически упадет с кресла дело в том что готовить к этому докладу я понял что profile оптимизации в таком случае когда собираешь разобраться в сто раз это обязательно обратная пениса это то есть то есть сначала делаешь свои 20 концов а потом по 2 процента грызешь собственно так и будет что же за актер был исполнен номером 1 и дал мне мои условные там 10-20 концов актер был интересный и это был обзор под названием статистика ну а ups ups ups совершенно не звучит во все в топе чарта в профайлер а у меня вылезал вылезла статистика потому что как все мы как бы стараемся админ сервера предоставить какую-то там информацию из для этого не наливать там не знаю 10 миллионов отчетов графа ну хотя в принципе можем и у нас сервер внутри себя считает не только лишь минимальные и максимальные так далее время исполнения еще и квантили запросы значит как полагается последнее действие этот мы делаем через структуру под названием ти дайджест кто об этом пин услышит первый раз почитает в интернетах или я расскажу потом есть два объекта по большому счету а один для я имею ввиду в ходе каждого запроса будут подробно два объекта один с глобальной статистика один в каждом яндексе все это работает как будто бы годами жрать не просит но вот навар клоде под сотку 1000р ps а под миллион внезапно вы вылезла годами работал нормально что же оказалось не так а оказалось не так именно то что она годами работал а значит метод внимательно взгляд показал что последний раз эту имплементацию которую естественно и начальной аль имитация имплементация было десять лет назад и на джаве мы ее переписали один раз на си плюс плюс и забыли она тянет war плод в 1000 рпс и тянет она суточки ломается неожиданный совершенно вывод раз в десять лет надо обновлять библиотеку которой пользуешься даже если ты ее переписал черт подери собачка взволнованы ей это не нравится мне это не понравилось тоже но слава богу и довольно простой алгоритм мы его довольно быстро переписали а толку нету никакого но в этот момент у нас хотя бы был другой бы ислам я значу переписываю доблестным наливаю туда отсчет и этих самых наших времен запросов но сайте написано английским по белому что типа там в особо элитных реализациях 140 наносекунд у меня вообще не близкие цифры у меня 20 миллионов значение туда не успевает за летать смотрим в новый код внимательный и тут у меня такой флэш-бэк короче из прошлого как будто 1917 опять наступил батч patch патч оказывается для того чтобы она быстрее работала нельзя туда пихать по одному отчёту за 1 а надо пихать тем чем больше тем лучше и вот флешбэк вот примерно такой нельзя вот так вот кормить не каталоге алгоритмы данные как бы при привыкли кормить по одной циферки за 1 а надуем нормально навалить чтобы в принципе все ядра процессора были чем-то заняты и вот достаточно быстро передвигались по трассе или по меньшей мере количество перемещаемых килограмм в секунду было достаточно высокая флешбэк вот такой смотрите смотрите это логотипа nvidia догадайтесь какого года в это помнит кто не такой логотипе nvidia хоть один roma roma roma не помнят а он не алды здесь ну или просто исторические каналы смотрят короче это логотип в виде 2003 года то есть по моим вычислениям он старше чем половину сидящих в зале сеньоров вот и соответственно конечно флешбэк был мощнейший и даже тогда это мантра матч матч матч была не нова ну ладно внимательно смотрим на кой черт мы это делаем мы же не снимаем статистику миллион раз в секунду мы ее снимаем раз в 17 месяцев когда скучающий админ заходит на сервер и смотрит в эти метрики так давайте ее не обновлять миллион раз в секунду давайте вместо того чтобы совать в этот тормозной дайджест данные сразу накапливать их в небольшом буфере на этом нам под придется потратить малага малага памяти дайджест уже и жрет 4 килобайта мы сделаем буфер на тысячу значений и сожрём еще восемь ой ой ой всё на этом в принципе доклад можно заканчивать потому что именно от этой нехитрой оптимизации произошел немедленный взлёт в космос вот это тот самый актер номер один который дает основной эффект в обратной пенису иди буферизация те дайджеста естественно никак не повлияло на запрос номер один почему то кстати о птичках потому что глобальная статистика всё рассказать тоже есть даже любопытно запрос номер 2-местный разогнался прям вот от души в 22 раза 22 блин раза кажется на этом можно успокоиться уже мы делаем там вполне пристойной почти 300000 рпс of и честно говоря можно забить и на этом в принципе закончить все но нет я же было бы не интересно да я понимаю что прорывов короче отсюда точно не будет еще двадцать раз от этой отметки сделать не то чтобы не возможно возможно я знаю как от этой отметки сделать 20 раз и даже 200 но это конечно усилия все по возрастающей возрастающей возрождающий а вот таких вот простых прорыва в двадцать раз больше не будет совсем но мы не сдаемся и продолжаем прохилить прохилить и профазе i скрывается интересная 2 cups он достаточно маленький но его на мой взгляд важно привести чтобы все понимали что дескать программисты они в кода не совсем бриллианты в коммиты вают как бы вот так это давайте сформулируем и постоянно в коми тут что-то не то кто угодно насколько хороший значит разработчик бы ни был мы полнотекстовый движок да у нас бывает два принципиально класса запросов один которым в котором есть ключевые слова хоть какие-то другие в котором нет исключительно параметрическая выборка по идее по какой-то колонки по вторичному индексу по специальному крэш индексу по этому самому по айди и т.д. и т.п. в данном случае у нас коне в этом вич марки что правильно не какими ключевыми словами не пахнет тем не менее кое какие внутренние объекты таки назир для запроса так называемые ранки как эта штука которая будет как раз считать полнотекстовые сигналы для ранжирования динамически и по ним считать некий real-time ранд они все равно создаются они не используются они создаются инициализируются они достаточно тяжеловесны оказываются для одного миллиона запросов их становится видна в профайле ре ну чтож прекрасный почти там реально деф на двадцать строк или что то типа того и конечно же основные из них это убрать new path if неожиданно этот нехитрый патч дает нам аж 25 процентов рпс и вместо 270 мы выжимаем 330 не что такие две лишние строчкой отлично погуляли уже можно успокоиться но самое интересное в этот момент только начинается следующее что вылазит в топ профайлер а это был конечно же вид контента на конечно же с ним сделать ничего не возможно конечно же у нас не один индекс на весь сервера несколько этой сервером севера несколько индексов а возможно несколько сотен или тысяч конечно же есть глобальная таблица конечно же в не надо взять лак конечно же внутри самого объекта индекса есть та же масса разных лаков конечно какой-то из них надо взять конечно же это не просто бьют аксесоари драйт локи потому что бывает только читающие селектора бывают insert и которые мутируют индекс конечно же это r в лоб по си плюс плюс там у шерлока никогда им не пользовался такое грустное признание и когда мы должен там 128 select и у нас 128 на соответственно redo log off захватывается постоянно отпускается захватывается отпускается захватывается отпускается делали мы это совершенно каноничным образом ps3 дрю лакорди лот на винте какая-то своя обертка 80 ничего с этим сделать правда правда но нет пионер не сдается тот pokemon быстро и внезапно догнал значит две вещи первую и вторую первую вторую во первых что называется я об этом знал но не догадывался но проверил и она оказалась правдой что r в лоб в такой ситуации хуже чем мьютекс если его в тупую заменить нам ю так что уже будет лучше результатов у меня нет потому что я их продал балл по мере в кулуарах я об этом знал но не догадывался далее pokemon быстро и он как бы вот местами какой-то идея приходит 10 лет но если уж пришел то в цепляется ей в самое горло следующее о чем подумал pokemon быстрый было что а знаете ли вы что на 64 ядерной блин машине долбанный atomic поверх которого скорее всего построен этот мьютекс будет тормозить сам по себе банальный долбанный счетчик на тонике no hay por машине и или при хай контента не надо резать на части а это было очень интересно значит я чуть было не упоролся начни взял собачка на полгода и не упоролся в.в. reset но тут внезапно в москве наступили те самые пять минут декабря когда вышло солнышко кришна осиял меня своим сиянием и пришла еще одна гениальная идея она озвучила так не делая reset не изобретай велосипед по кукле вот я такой сразу бахну чуток можно было спасибо давайте действительно погублен хотелось позаниматься рисе о чем честно скажу очень хотелось подниматься весть о чем но я взял себя в руки потом взял себя в руки повторно и погуглил google нашёл такое количество разнообразных аббревиатур что нет никакой человеческой возможности их привести они возможно не влезут на слайд кроме того я их специально не хочу приводить здесь честно говоря потому что это от садами и дорога просто как бы не понятно куда то ли к полу году собачьи колотова то ли обратно в академии века докторской диссертации не понятно что в этом хуже есть масса научных работ есть масса research и по поводу того как нам построить скейла умею так скейла белок это дтп основная масса из этих работ это какие-то страшные аббревиатуры подавляющая часть из них не оснащена кодом какие-то дурацкие игрушечные которые работают плохо и хуже чем трейдер вилок кодом оснащены самые интересные кодом не оснащены и лучшие что ты можешь принципе найти если находишь хоть что-нибудь будет какая-то реализация на китайском где на китайском все там на китайском идентификаторы комментарии отсутствующие но ридми мда есть просто вообще все даже не к значит автора тоже на китайском и как известно всегда есть восьмилетний китайский школьник который что-то умеет лучше тебя в любой области человеческие жизнедеятельность вот у меня такое ощущение что значит проблемами масштабирование рыболовов занимаются исключительно восьмилетние китайские аспиранты потому что другого кода на гитхабе нет макей я поскольку китайский не разумею и внятный аудит не способен провести это пришлось написать самому там не так много года но тут я столкнулся с другой проблемы что нельзя просто так взять программу под названием сервер баз данных извините все-таки несмотря на то что косплеит в том числе полнотекстовый поиск и вырвать из нее все рвал оки и вставить другие казалось бы можно но нет оказывается какой-то вредитель в свое время дизайнер позиции 5 который не был ознакомлен с творчеством восьмилетних китайских аспирантов и оказывается в позиции мамой 5 анлок общей на ритлока ритлок а в любом вообще нормально предсказать элитным research и вам алгоритм не обязательно надо мочить внутри одного thread'а аретула кредо на край тек right angle вот и пришлось сидеть и перепахивать все вот эти вот redrock redrock на райт мокрой тондо очень медитативное занятие и естественно в его ходе выяснилось кое-что еще опять таки pokemon быстрый вот эти все дела индию зоркий глаз заметил что есть одна фундаментальная проблема которую честно говоря можно было бы осознать если бы просто сесть и подумать заранее минут 5 в этом не интересно лучше проволок при factory проблема называется райт контент шум удивительным перед этим была вид контента на еще и райт контент и есть вот опять pokemon быстро и заметил что у нас на этой самой долбаной глобальные статистике извините когда мы эти дайджесты обновляем достаточно тяжеловесные объекты мы должны их заблокировать на запись нам там не надо в отличие от полнотекстового индекса с которым мы ничего не делаем 128 конкурентных лидеров которые прекрасно скейлится по рядам по ядрам нам надо взять лоб на запись и нам надо его взять тот же самый миллион раз в секунду ничего не сделаем статистика по сложнее чем два счетчика если там было просто два счетчика я бы сделала домиками размазывать и а томики на маленькую таблицу не всем у меня было в жизни хорошо а здесь я сделал еще не могу мне вот такой объект на 12 килобайт данным youtube сам прикрыть что же я могу сделать с этим youtube сам но как вы понимаете поскольку пионерку не сдается то как бы вот ну хорошо есть у нас каждый запрос семантику каждого запроса довольно простая там побывали там время исполнения этого запроса количество найденных строчек еще что-то и надо просто по большому счету сложить это дело в буфер и когда-нибудь потом раз в тысячу запросов о посчитать до или в тот момент когда спящий сисадмин проснулся что не наступает никогда очевидное решение раз у нас тормозит мьютекс надо от него избавиться и сделать log free я точно знаю это несложно мне я сам не обучался но пацаны которые обучались в шаге рассказывали что это возможно есть у них там ровно один человек который способен это делать в раз он делает то и мы сможем но нет тут слава богу случились остальные три минуты солнечного света в город-герой москва вот и опять кто-то просиял лучиком в глаз и я решил что не буду его порваться в украину структуру я сделаю вот такой вот буквально вот это семь основных строчек кода который делают как бы всю работу 8 lock free структуре которой не лоб free но большую часть своего времени такие лоб free такие сотрудниками и так далее код буквально вот такой я его скопипастил и немного как бы под сократил название идентификаторов и возможно сделал их попонятнее возможно нет в чем суть держим буфер махонький буфер под названием как нетрудно догадаться мини буфер размером на там условные тридцать два элемента пока этот буфер не заполнился вписываем туда очередное значение которое накопили а то при помощи от турника а томиком получаем очередную свободную позицию записи и очередной тренд туда без каких либо блокировок и спаси господи мьютекс of что-то пишет как только значит труду не повезло как только на нём буфер закончился то и ему значит вы даете медаль сутулого и шапка из канализационного люка и именно этот тред обязан позаниматься флашем буферов обновлением статистики и для этого взять лук взять лопни от остальных трейдов читателей которые запросы исполняют от того самого спящего сисадмина который не дай бог именно в этот момент обновляемую в этот момент статистику захочет посмотреть вот натурально вот такой код а да ну и соответственно все остальные три дыры ридеры которые пытаются покинуть свою статистику все эти две микросекунды будут вынуждены по стоять на спин локи для такого интервала нормальный человеческий экспоненциальный быков скин локи эту работу значит вот так вот то есть я к несчастью уже все рассказал но вот семантика вот такая значит обычный кот пас такой что мы берем от а томиком обновляем позицию в буфере и в этот буфер записываем 3 числа изредка и нато томик пост переполняется именно в этот момент мы в вашем статистику берем мьютекс и все такое не трудно догадаться что такое размером юта размер буфера востока раз меньше мы и стали брать мьютекс если размер буфера ты сам ест или в тысячу раз меньше было брать меню топиться два элемента в два раза меньше и так далее это не настоящий лоб free ну и отлично настоящий лоб free очень-очень сложный у меня на него мозга не хватает а главное ни малейшего желания этот мост качать здесь лог есть он кратно реже натурально в сотни раз но и этого хватает разгонная динамика там довольно прилично но возникает еще одна головная боль мы же все-таки базу данных пишем и желательно чтобы она не падала такое противоестественное желание чтоб род не падал этом олимпе орды денег не прекращали зарабатываться как проверить слава богу это не настоящий лоб free a7 строчек кода здесь мало состоянии поэтому я применил три разных методы проверки я расписал все возможные состояния на листочке нашел баг который сам случайно внес копипастой я исправил этот баг сделан у него тест внес его обратно и показал коллегам убедился в том что коллеги сильно лучше меня потому что коллеги втрое быстрее меня проанализировали этот код и самые бодрые из них нашли этот один бак и больше ничего не нашли но в этот момент пионеры было уже не остановить я попробовала средства формального доказательства потому что это очень интересно формально доказать lga ритм на 7 строчек и кажется это именно тот размер с которым еще в принципе можно поиграться в формальное доказательство не из них которые на хаскеле а там ли и вот этом всем и к несчастью меня не зашли на стадии синтаксиса потому что там и opel я не обладаю клавиатурой с достаточным количеством спиц символов я нашел проект а то значит хорошо известного нам товарища из гугла по имени дмитрий в рукав под названием решилась и если я правильно это называю немного смущает тот факт что за последние 8 лет там 19 коммитов и по моему с девятнадцатого года их нет вообще это может немного смутить но не меня я точно знал что бывают божественные идеальные вещи в мире и ревность и реально оказался одну из них он просто блин работает может быть он пласт прав плохо работает для других задач для моей задачи он сработал идеально как вот глеб не надо почти гриб гриб уже давно дошел до полного идеалы веками тут в грепп конечно же не надо систем формальной проверки есть очень много сто пудов какие-то алгоритмы по важнее будет надо проверять чем-то посложнее поинтереснее для меня отлично сработал лилась и несмотря на 19 коммитов ее полное этих самых комментов штанов результат всех приседаний семь строк кода формально верифицированы снимая lock free буфер и барабанная дробь плюс 38 процентов было триста тридцать шесть тысяч рпс стала 463000 рпс причем для этого достаточно оказалось сделать в меню буфере lock free всего-то 30 два элемента довольно немного я правда подозреваю что если я сегодня перемирию с другими размерами буфера то у меня цифры могут разойтись но об этом еще на секундочку позже между прочим мы тут обгоняем немного реальности вот это был коммент маме это было скажем так обзор номер четыре выявленный про файлом в формате чески в четвертом порядке но это был камень номер 3 а я как вы понимаете через два года после событий строго пока мид логу рассказывают commit номер четыре но обзор номер три рид контент шум те самые рва локи борьба за читателей удалось найти в google и про личную статью реализовать ее от рефакторинг вот всё сделать хорошо это очень интересное и по разбирать несчастью для того чтобы этим позаниматься мне нужно тесс те три человека которые мы это действительно интересные три часа времени почему-то на холоде мне постоянно этого не дают тем не менее основная идея настолько значит просто и кратко что все равно надо как я уже немножко говорил но еще раз повторю на системах где может быть даже малая dirty потом два ядра тригидрат 4 3 2 1 бывает такой лодке даже один общий а томик который вы сильно сильно на пили войти банальными инструментами и это тормозной и какой-нибудь простецкий счетчик который вы напеваете натурально 10 миллионов раз в секунду надо немного размазывать на несколько переменных а лучше на несколько для шлангов идея с индексами и рвало камину наверное у меня вот 1 листок идея до угла двигалась в правильном оказывается направление которое я папе перу подтвердил что надо сделать некую такую хэш-таблицу флажков чтобы типичный reader боролся хрен знает с кем ну обычно не с кем за свой личный уникальный флажок и вот его брал а если он учился дзэн началась какая-то драка и контроль что-то в этот момент происходило откат нас стандартный системный пазик самый первый лук собственно в пире ровно такая штука и было написано мне до сих пор обидно что они опубликовали это раньше меня несмотря на то что сэкономили мне полгода research а схематично весь быстрее валок опять же выглядит вот так понятное дело что повторюсь там тоже 200 строк вместо семи самый важный семь строк выглядят вот так буквально если мы находимся в режиме читателя и боремся с высоким контент шинам ридеров то по идентификатору 3d выбираем себе слот в глобальные таблички в глобальные хэш таблички тредов и пытаемся прописаться в этот слот ну а дальше нормально и черной репицу если прописаться без согласия ну то есть наоборот согласен если и слот незанятым него успешно расписался все хорошо ты только что взял быстрый быстрый ритлок если ты не сумел туда прописаться потому что там занято как мы только что наблюдали на перерыве в туалетах крокуса то конечно же начинаются разбирательства кто тут 1 стоял захват лака там судебной вот эти процедуры вот это все откат на стандартный пазик новый код по тем не менее в 99 процентах случаев исполняется естественно fast pace который а один atomic один компонент вот и а один atomic мало того что на некий общий не дай бог and a 1 atomic на никому больше не нужны int в этой хэш-таблицы гениальная идея чтобы плевали в раньше молодцы что сэкономили мне полгода ресеч и и что с этим номером мы будем выступать в нашем цирке таки будем несмотря на то что номер к несчастью один раз оказался так себе другой раз оказался неплохо в несчастью процентов он дал очень очень мало несмотря на то что сам по себе орлок а разгоняется просто до запредельных величин если ты под этим блоком ни черта не делаешь на бенчмарки стиле у меня 2048 трейдов подрывал оком а увеличивают там что-то или читают что-то натуральная вижу ускорение до 200 50 раз если я правильно помню три раза это ускорение под вообще не интересным сценарием под названием 2 3 да вот так вот этот рывок орлок берут ну чем больше контента тем больше трендов тем естественный эффект от масштабируемости лучше но восемь процентов это конечно не смешно это довольно мало процентов как мы все знаем в современную эпоху восемь процентов вообще не о чем но как известно буква д слове флот означает дисциплина а буква в слове benchmark означают воспроизводимость смотрел сходимостью бенчмарков на абсолютно том же железе абсолютно тех же коммитов которые на которые я откатился в которых болин monavie собственно ручно два года назад написано сколько было рпс коко стала на таком железе какой процент ускорения не воспроизводятся совсем разгонная динамика тогда была вот такая сейчас она вот такая что приятно сейчас я выжимаю больше рпс of разгонная динамика давным-давно была более на мой взгляд логичная а то не нужного кода я значит строил тогда восемь процентов налог при буфере тогда скрыл 10 процентов она быстро мурлоки тогда скроил 70 сейчас ровно наоборот на какой-то дури под названием не нужный код 25 и так далее но тем не менее что приятно видимо прогресс не стоит на месте видимо поменялось что-то еще может быть более новая операционка более новый компилятор я не знаю что тем не менее несмотря на то что разгонная динамика обратные пениса и да у меня немного иная финальный результат тем не менее лучше 350 было тогда 500 стало сейчас и результат тогда был если что наблюдаем в проге несмотря на 1000р ps я правда затрудняюсь пояснить нас копытом грубого паучка вниз там условно и 2 процента 5 или что то есть несмотря на то что все эти приседания казалось бы они рассчитаны там на отметке типа миллионы rp с тем не менее результаты и для обычных медленных запросов которые там казалось бы по своей 1902 десятки тысяч запросов в секунду сервером молотят он тем не менее на графиках тоже проявлялся и того итоги подведем с чего начинали начинались системы которая в принципе было никогда не предназначена для нагрузок ну грубо говоря больше 1 тыс рпс не то что мы никогда них не думали но нам это было никогда не важно тем интереснее было поиграться начинались совершенно провальных цифра сотня gps на сотни тысяч рпс на запросе который ни черта не делает 10 на запросе который делает хоть что-то по интеллект по ключу добились ускорение извинить этом в одном случае в 14 раз в другом случае как получается 52 раза и что кажется еще немаловажно тут отметить что вот эти все куда более сложные возможно приседания с а лоб free буферами переписывание марго log off поищем еще и так далее они даже после первого мига шашка который дал естественно прорывной эффект ты выпалил основной диод который все тормозил даже по сравнению с первым мега шагов двадцать два раза мы получили 86 процентов восемьдесят шесть процентов после 20 х 2 раз звучит как нечто чем заниматься не стоит однако 86 процентов от 22 раз это извините вон 52 раза композитный эффект такой а плюс 80 процентов если чё это неправильно посчитал получается навин возможная перемножила не поверила в общем где-то тут брехня рпс и точно и фпс и естественно там 502 270 отогнали они точно я вот в процент я мог ошибиться что сейчас тут место сегодня буквально два дня назад мне стало интересно взяла наше достижение мы утратили или нет оказывается нет оказывается не предпринимая честно говоря никаких сознательных усилий для этого всего мы и хотя бы не продал боли производительность и ой как не не понятно что непонятно какие изменения но понятное дело q5 подозрительный commit у меня есть вот но какие конкретно не уверен далее еще какой-то дополнительный эффект прямо сейчас она работает еще быстрее а если начинать играться с количеством тредов то вот и 700000 рпс даже можно выжить на на повторюсь на абсолютно никому не нужных запросах типа а давайте использовать сфинкс как строчный калькулятор и считать select am один плюс два умножить на три можно аж два миллиона расчетов в секунду сделать но окажется это спаси господи любой java script умеет сделать и без меня по лучшему производительность не продал болит made кликбэйт климат от openid хоть какой-то толк с этого доклада есть или нет мне понятно тут необходимый слайд морали а потом понятное дело моральный слайд есть мнение надо иногда делать стресс тестирование системы которой вообще не рассчитан на тот или иной уровень производительности какой-то странный непонятный для этой системы не подходящий для этой системы нагрузкой и эта нагрузка вам в вашей системе выявить что то вы возможно выявить что-то интересное что потом даст эффект ее обратно на про день несмотря на то что profile нагрузки совершенно другой у нас в итоге если я правильно помню именно этот пруфов концепт в бой ты ни пошел тем не менее эффект от всех этих приседаний был заметен и на основном поиски сильно меньшей нагрузкой неожиданно ну то есть ожиданно но неожиданно мантра 30-летней давности батч борьба работает никогда не работа не делаете какие-то сложные вычисления по одной горошинки за 1 если можно их пакетом обработать вот и как бы на мой взгляд самый интересный выбор самое интересное лично для меня пожалуй вывод был в том что не надо сильно боятся как бы лоб free алгоритмов которые вот там снижают контента ну так далее чтобы честно говоря не звучат очень страшно какой-то там lock free счета записалась память в таком порядке в другом порядке memory or drink формальная верификация все это очень сложно никогда не сделать 302 пара дней еще пара дней коллегам мозги поесть чтобы anybody поискали и все заводится и работает но подчеркивает не настоящий лук фри а вот такой вот половинчатый lock free плане чистый лоб free сработал отлично ну и как бы вывод который может быть новый для вас понятное дело к несчастью не новой для меня это то что в стандартной библиотеке всегда что-то можно улучшить я не очень ожидал что настолько сильно удастся улучшить стандартный пазик savoir валок оказывается тем не менее сделать это возможно самое то главное что не бойтесь этих дебрей обратите внимание казалось бы дебри от холокост лоб free структуры и переписывание блоков своими руками основная масса всей этой переписи семь долбаных строчек я не шучу они скопированы с продаж возможно с богам чтоб жизнь медом не казалась и не бойтесь давать эти своей оптимизации перформанс и так далее до конца кажется если укрупнять укрупнять и укрупнять ровно это и есть единственный такой мета метод выжить необходимые вам приличный результат какой бы это результат не бы в десять тысяч рпс миллион 2 миллиона или 30 спойлер на современном железе возможно 80 а если не получится выжать то хотя бы по пути самурая хорошо развлечетесь я думаю все согласятся стен даже те кто ни черта не понял что в качестве развлечения на спринт вот эти все приседания были все таки интересные и хорошие неожиданно это все спасибо огромное тебе памятные призы как всегда у нас есть вопрос из и передней боюсь дождя правильно вся следующей неделе будет в дождях но если ты конечно останешься здесь такие страшные суси и сейчас остался на экране будет вопрошающий когда давайте друзья выведем вопрос из интернета а остальное будет у нас в кулуарах владимир пожалуйста звук есть так так проверка связи мне рамой пожалуйста все есть слышно так всем привет андрей спасибо за содержательный доклад вы смелый человек показали пенис уйду на докладе хотел бы такой вопрос задать как вы покрывали тестами эту систему и какими паттерн ими пользовались для тестирования насчет фактов не совсем понял как мы тестируем покрывал ну наверно понятно дело просто большое количество стресс-тестов дескать там в том же буфере давайте там нальем нагрузку проверим что у нас старая реализация новая реализация да тут одинаковые циферки давайте сделаем достаточно много раундов это с одной стороны но и формальные checker и с другой стороны что характерно и при стресс тесте достаточно быстрым вот тут вот божок единственный который удалось найти в лоб free реализации он вылезал буквально за несколько секунд раз тестирования и он проявлялся довольно лихо намертво виснет все thread'ы и как бы этого было сложно не заметить так что никаких особенных приколов просто значит большое количество стресс-тестирование эту часть лук фри штук часть серого локов я еще естественно подбавляла кладочного кода который проверял только как какой-то red чего взял такой 3 пусть отпустил сошлась ли вся последовательность если я правильно помню эти дополнительные проверки кажутся не то ли не сработали совсем то ли сработали буквально один раз и поймали какую-то копипасту возможно я пользовался троится не тайлером тоже но не могу это уверенно вспомните как два года назад был в любом случае 30 замысле я пользовался во мне не дал дополнительной информации теста на ничего дополнительного точно не поймал понял спасибо по оси во второй вопрос из 2 интернету 2 интернет есть 2 конечно есть и я думаю есть минимум три интернету один нормальный постом и и третье где китайские аспиранты вот и второй нельзя называть андрей мы тебя сейчас отпускаем в цифровые кулуары во сколько на стенде у тебя сессии вопрос да тут важно то что если есть в зале те три человек которым интересно следующие три часа про детали этого все поговорить-то у меня там забронированного значит на стенде время с 16 до 18 а витушкин цифирь power of пойду туда соответственно догоняйте будем то трендеть про lock free и конечно про пи не стоит спасибо андрей"
}