{
  "video_id": "vHDA6mEAeLU",
  "channel": "HighLoadChannel",
  "title": "Tarantool Kubernetes Operator / Василий Тюбек (Mail.ru Group)",
  "views": 563,
  "duration": 2757,
  "published": "2020-04-14T11:07:33-07:00",
  "text": "вне зовут василий тюбик я работаю в mail.ru group в подразделении тарантул solution engineering и занимаюсь разработкой систем под ключ как видно по сути и сегодня буду рассказывать потоками тарантул на кубик катаем почему из этого оператора вышел и почему это сложно план следующий сначала я кратенько совсем расскажу чем может быть полезен тарантул сам по себе зачем он вам понадобился наку верные все затем покажу варианты запуска тарантула в разных конфигурациях на кубе ри и после этого расскажу уже по волосам оператор как он работает немножко право архитектура подниматься с которыми столкнулись процессию разработки сам тарантул сторон тула меня первый раз столкнулся вообще вот на такой задач это виртуальный хостинг нужно было на уровне и джинсов организовать возможность в динамике конфигурировать хасты и в рамках этих астор configure чем мы тогда просмотрели несколько вариантов в чем эти данные можно хранить чтобы джеймс туда ходил и сделали вот так трубы в один из вариантов которые мы рассматривали и тарантула мне зашел не зашел нам по нескольким причинам во первых данные словарные есть решение которое уже словарь на таран туле нужно делать самому нам не понравилось комьюнити она показалась на тот момент маленьким спросить особо ни у кого кроме к его карман тренеров нам не понравилось к система нам казалось что экосистема довольно маленькие не понравилось отсутствие каких-то саксэс файл stories на то есть не много хайпа вокруг торонто было на круг это все выливается в эксплуатацию один в поле воин когда в общем то ты берешь решение поддерживающему сам от начала до конца было это довольно давно года так наверно 3-4 назад что с тех пор поменялось ну тарантул он такой же тарантул он такой же application servers база данных в одном флаконе который позволяет нам делать вот такие безумные вещи зато изменился изменилось все что вокруг самого тарантула во-первых эко-система например у нас есть отличные тестовые хаймор которым можно пользоваться у нас есть уже какие-то более продуктовые решения sharding например на есть более специфичные штуки типа очередей есть даже фреймах для разработки распределенных приложений на основе то роду еще удар около довольно живенько и комьюнити то есть можно зайти в telegram например и поспрашивать прямо у нас очень по отвечаем трампу даже оброс какими-то коробочные продуктами например у нас есть решение тип торопил datagrid иуд имея вот это вот все мы получаем на круг что у нас есть тарантул быстро вопреки что сервер базы данных у нас есть мощная система которая позволяет быстро и дешево максимально масштабируемой системы создавать и вот мы создали эту масштабируемую систему и на крупные получаем дальше эксплуатации что с решениями для эксплуатации до общем-то у нас их немного на и чем больше классных тем сложнее его оперировать отсюда в общем то и появляется светлая мысль катать торонто купером на чего мы от кубера хотели в этом отношении ну во-первых мы хотели что можно было запускать наше стыками к сервису ранту рынок убери во-вторых мы хотели чтобы на ней на губах можно было переложить максимум эксплуатации ну и в третьих мы хотели получить максимальные автономные системы которые в общем то за счет сочетания тарантула купер notice у переживают хотя бы простые кисы их отказов и живут как cm себе запуск торонто на кубе тарантул накупили можно запустить разными способами совершенно ну сначала я задам не мог контекста расскажу про наш проект очки вот например одно из решений на которые мы катим мегафон это кошек у него есть сторож у него есть об летишь часть которая принимает had это по запросу ходит сторож а вот характеристики этой штуки это классно примерно 100 инстансов тарантула если считать все вместе она хранит чуть полтора порядка терабайта храма она стоит в резерве на x2 и x3 на будущее и держит довольно большую нагрузку вот так крут контекст и вот эту вот штуку на нее мы ориентировались когда поднимались к убери первое и самое простое что мы можем поднять из этого стэк это applications игра applique что сравниваем чтобы поднять нам подойдет любой кумир на песке ресурс на любой стоит вас ресурсы это не в общем то несложно можно взять deployment указать некоторое количество а реплик которые мы в этом диплом эти хотим взять наш официальный фронтальный имидж и мы получим вот такую картинку то есть у нас будет масштабируемые при кишит серых который случай например если возрастёт нагрузка мы можем добавить инстансов за счет механизма deployment cabernet скоро его все вроде хорошо дальше дальше к этому нужно подцепить базу данных чтобы подцепить базу данных мы можем воспользоваться ресурсам стоит ул свет принципе тоже будет несложно начнём с банального с одного инстанция мы можем использовать здесь тот же самый абсолютно tarantino и меч и помочь им уже вот такую историю то есть теперь у нас уже есть где наши данные хранить есть сопляки шестерня которыми эти данные доставать у кого-нибудь из вас есть продакшене база данных без резервов честно поднимите руку ни у кого соответственно нужен резерв чтобы резерв прикрутить нам понадобится чуть больше губернаторских ресурсов во первых во вторых нам понадобится больше ручной работы если с deployment of все было просто здесь на будет делать руками и нам понадобится немного усилий и разработчика и для того чтобы это все поднять берем стоит ул свет тот же самый возьмем две реплики будем считать что первый из нас это всегда мастер все остальные всегда реплики то есть свой чтобы сконфигурировать резерв тарантула нам нужно будет настроить репликации для этого нужно конфигурацию же сам тарантул указать кредо эти порты мастер ее реплики так мы получим в общем-то работающий резерв в этом отношении стоит волшебном что дает стоит full set нам дает гарантию порядка запуска он нам дает какие-то гарантии того что у кодов будут уникальные имена но стоит poolside ничего не говорит про сетевую часть то есть если поттере столкнется мы получим изменившейся ip-адрес и как результат развалившегося репликацию и развалившийся резерв чтобы это дело объехать возьмем да подключим к этому всему хотелось сервис чтобы перейти с использованием хищников на использование денисов dns name of падаван перекрыть курящим репликацию и получим получим фиксированный сетевой dance то есть теперь у нас айдын переживает restart кода и репликация ломаться нибудь но раз мы кантри горячим тарантулы как есть на то есть это кот непосредственно вызов бугского гск british нам такое решение не будет масштабироваться если мы захотим добавить реплик больше например нам придется впереди пояса каждый раз причем хотим скилл апнуть скилл дал масса всегда ready play для того чтоб его объехать подключим конфиг map и в конфе гмо положим конфигурацию репликации какая у нас есть можем положить туда прямо аж не скрип и вот здесь тот самый момент когда может понадобиться разработчика на мы монтируем и to confirm а потом разработчику же на трон кулер реализует гадюшник который будет отслеживать изменения файла конфигурации и перенастраивать репликации на круг мы получим вот такую историю у нас будет африке сервера база данных с резервом который масштабируется опционально да по необходимости осталась последняя вещь осталась на базе данных размазать как-то полтора тыра полтора терабайта в одном базуку складывать не будем будем жарить сразу здесь отличие будет с точки зрения кубера несущественные но в рамках тарантула измениться что изменится способ задания конфигурации репликации вместо конфигурации репликации мы будем задавать конфигурацию шарден га а наши модуль хардинга уже будет настраивать репликацию между инстанциями как-то по-своему ручной работы будет чуть больше потому что конфигурация шарден гораздо сложнее чем конфигурации репликации которая массивчик из двух строк и понадобится уже более сообразительный разработчикам который напишет обвязку которая будет перезагружать конфигурацию шорты для нашего модуля ричарда ему надо будет знать как работает лишь от чтобы нигде не обломаться возьмем да поставим 50 реплику стоит вкус и откуда взялась цифра 50 полтора терабайта если размазывать на 50 инстансов мы получим что-то порядка 32 30 гигабайт на instance время запуска сторон пула зависит от объема которые данных которые торонто хранит с кем данных и от индексов по этим данным соответственно в нашем кисти 30 гигабайтный из нас поднимается где-то за 5-7 минут плюс минус и это в общем то для нас неплохая цифра дальше конфигурацию sharding конфигурацию серфинга выглядит вот так да это уже немножко более сложная история здесь можно и ошибиться задавая это руками здесь присутствует уже группировка присутствует какая-то семантика в конфиге ну и мы получим на круг из этого вот такой стоит на то есть теперь у нас есть deployment у нас есть база данных которые масштабируются у нас есть резерв для базы данных все вроде бы хорошо но есть пара нюансов во-первых один большой стоит full set воды во всей истории это медленно то есть если каждый из нас поднимается в рамках пяти-семи минут оставив усы от гарантирует нам порядок запуска когда по следующей инстанции не запускаются пока не запустились предыдущие на вокруг мы получим что-то в районе 5 часов только для того чтоб костра запустился еще конфигурация шарлин гав такой топологии скорее всего превратится с течением времени в кашу на например если мы в рипли кассеты шарды будем объединять инстанции изначально 0 1 2 3 и так далее но когда например нам понадобится поставить 1 шард добавить туда реплику что мы будем делать мы будем встретил свет добавлять 51 instance и чтобы не решать данные мы будем подсоединять его к нулевому первому и так конце концов у нас будет вот такой вот какая брак конфиге чтобы поддерживать в общем то не очень удобно чтобы это дело обойтись делаю вот чё по шар дым пускает fuse этом из одного большого стрекоз это сделаем пачка маленьких стоит хуситов и получим что-то типа у шард 1 шард два и так далее до 25 штук в нашем случае или картинка будет выглядеть уже вот так на круг чем имеем тарантул подняли критично сервера есть база данных гордиться база данных резервируется но но все это делается исключительно вручную то есть если мы хотели тку вернитесь и получить возможность запускать наши стоит у микро сервиса то запустить на мы смогли а вот автоматизацию мы не получили получили то же самую ручную работу здесь нам чем что можно сделать здесь мы можем воспользоваться тарантул картриджем это такое наша приборчик для разработки распределенных приложений если кстати кому интересно у нас сегодня про картридж будет митап где расскажут как распределенную систему собрать из тарантулов из ума не сойти процессе тарантул картридж во-первых он автоматизирует конфигурацию sharding руками это задавать уже не придется во-вторых он забирает на себя ответственность за управление топологий конфигурации забирает на себя ответственность за управление конфигурацией на то есть помимо топологии есть конфигурация сам а ещё там есть вы бьете куда можно зайти посмотреть что в чем мы вообще развернули логически штука выглядит вот так и на то есть с точки зрения физики не меняется ничего у нас есть инстанции то рамбла которые на уровне логики самого картриджа объединяются в роли роли объединяются в кластеры роль в данном случает манера тарантул карта даже разграничивать ответственность между инстансами на то есть например 100 раджа у них один кот роутеров другой код и у них разные требования например потреблению память вот такая история выглядит здесь важно что встроенная топология и устроим управление конфигурацией этот файлик файлик вот такого формата это я блэк тарантул картридж этим файликом управляет исключительно сам а он обеспечивает к системность этого файла между инстансами и по сути это стыд то есть задать снаружи мы его не можем тогда мы поломаем консистентной этого файлик из единства в кластер а это означает что к стыд у самого тарантула которых сбрасывает иногда время от времени снапшоты на диск пишет вал у нас добавляется стоит виде конфигурации кластера еще который мы точно так же не можем потерять накручу имеем во-первых мы теряем возможность использовать stay close компоненты кубера например мы не можем использовать впереди плотник во вторых конфирмат становится бесполезен и мы получаем уже вот такую историю то есть все что у нас было стрекоз теперь точно так же стоит у компоненты но с точки зрения спора даже не поменялось буквально ничего выглядит точно так дальше с собой тарантул картридж приносит еще несколько багов то есть один из самых интересных это то что нам приходится подпирать dns когда настраиваю или репликацию использовали dns с репликации этой истории работает как dns кудри обновляется не мгновенно соответственно дальше репликации tarantino какое-то время делает это не только потом поднимается в конце концов все работает у картриджей с конфигурационными параметр от вертай свой рай по которому instance картриджа перекидывается для того чтобы понять кто из них упал кто из них работает до сих пор когда мы его задаем первым на и когда кортеж поднимается первое что картриджи делает он пытается пингануть сам себя один раз без редко и не получилось он падает на кубе ли он в легкую таким образом входит в крышу теперь чтобы это подпереть убираем эту жизнь внутри самого приложения здесь как раз в плюс то что мы можем похудеть на tarantul а теперь самое самое первое что мы делаем мы в цикле будем пытаться пинговать себя и только потом когда все заработало будем вызывать карточка факт из плюсов а то что мы этот патч можем занести на сам картридж и в общем то с течением времени думаю это так и будет еще один момент проблемы с масштабированием давно толкая встреч управляет файлом конфигурации своим как он обновляет во первых его 2 разным камерам во вторых для того чтобы его обновить нужен стопроцентный кворум что вокруг выливается в линейное время на обновление топологии и в линейное время на обновление самой конфигурации то есть чем больше инстансов тем медленнее у нас происходит perazzi и jul на присоединение инстансов кластеру тем медленнее у нас происходит изменение конфигурации а еще в классе тарантул картридж не twitter и легче что вливается в то что в конце концов мы можем получить обращается с админскими операциями на разные инстанции картриджа мы можем получить ником системный конфиг и вообще развалить классно просто на части а еще он управляется через админскую а фишечку это интересный момент на то есть чтобы как-то взаимодействовать с картриджем мы вызываем описанные методы пуха ттп используя граф quelle соответственно вся эксплуатацию картридж здесь превращается в вызов определенных граф куриных мутаций в определенном порядке в определённый момент времени на выходе тюрьме подняли тарантул всеми мыслимыми способами стоит у мика сервис нак убери поднять можно но независимо от того какими способов мы его поднимаем и всегда получаем ручной эксплуатацию либо мы оперируем ресурсами кубера либо мы будем оперировать админской а пешкой тут не суть важно это всегда ручная работа важный момент здесь заключается в чем пока мы поднимали мы в общем то пришли к чему нас появился какой-то бы справьтесь относительно того как должен выглядеть тарантул могу вернитесь и вот здесь стоит у светы и вообще везде street у светы в определенных кейсах админские опять тарантул картриджа дает нам ручки наружу на покрутив которых на какими средствами автоматизации мы можем это дело автоматизировать и вот отсюда как раз появляется наш оператор соответственно от оператора чего хотим от оператора хотим чтобы можно было задавать просто сложные топологии картриджа кластеров то есть чтобы эксплуатации не мучилась создавая тестом и 50 60 с толстой функция тов на это во первых во вторых хотим чтобы он на себя забрал все эксплуатационные процедуры по максимуму стареть и хотим задать какие-то быстро акции то есть вот тот самый оптимальный способ раскладки то рамку лавку бери ну и местами подпереть картридж со всеми его богами с которыми мы столкнулись по поводу багов с которыми мы столкнулись мы их все три портили контрибьютором картриджи и один из них ярослав денников завтра будет рассказывать о тех проблемах с которыми он столкнулся при разработке карточки и как он их решил дать сам оператор складывается из чего сам император складывается из какого-то описания до ресурсов которые мы хотим развернуть на кубе ри из гадюшника которые производят эксплуатационные процедура относительно этих ресурсов и кодов кубер найти ну из какой-то механики интеграции в кубах пойдем по порядочку описание кластера описание любого ресурсов купер найти с точки зрения расширения пику burn notice it кастомное определение ресурсов твердых мы и кубера расширили во-первых своей пешкой во-вторых мы добавили три ресурса новых для кубер найти первый ресурс это ресурс кластер это такой зонтичный ресурс который пост предназначен для того чтобы обозначить что есть какой-то кластер тарантула в этом на экспрессе и он еще объединяет все остальные ресурсы дальше покажу как это выглядит от него важна одна единственная вещь уникальное имя в рамках namespace а как принципе у любого ресурса ресурс роль роль это ресурс который соответствует одной роли как тарантул картриджа то есть один в один соотношение здесь важно что в рамках роли мы задаем горизонтальный скиллу то есть количество стоит fuse это в которой в рамках этой роли будет поднята ну и ресурс реплика сет template здесь ничего особенного это просто манера полениться и это template стоит вкус это который из которого будет создаваться стоит full set в рамках олей когда это все поднимается на кубе все наши ресурсы опьянев такой вот иерархи для чего это сделано это сделано для того чтобы делегировать часть работы на кубер ночь когда мы удаляем например ресурс роль если бы мы ни объединили это в такую иерархию то нам бы пришлось стоит full света удалять пушкин и которые к этой роли относятся к с иерархией кубер нить из узких garbage collector приберет за нами все это дело на автомате ресурс эта штука которую мы придумываем сами на основе какого-то нашего эксплуатационного опыта соответственно по сути и грубо говоря из головы достаем первая версия наших ресурсов выглядело вот так то есть сейчас их три они плоские на не отдельные первая версия выглядело вот так вывалил на пользователя все понятия которые участвуют развертывании кластера тарантул карточная со всех слоев ну и первая же попытка развернуть это диво самому самим собой закончилось тем что я сам же в этом и запутался соответственно ресурс это единственное что отделяет пользователя от вашей логике соответственно чем он проще тем пользователю проще будет выдавать свое намерение выражать кубер notice у второй момент который при проектировании ресурс пришлось честь это закрытость ресурсов то есть можно посмотреть допустим соседние операторы их благо не так много и заметить одну интересную штуку все ресурсы свои поставляют по разному кто то поставляет отдельно взятой куски кто-то поставляет один большой ресурс которая описывает все аспекты раскатки здесь игру в том на мы можем использовать что чем сложнее софт который мы эксплуатируем тем более закрытый ресурс получается на это для чему нужно если мы закрываем за своим ресурсам какие-то аспекты имплементации да на кубер найти то мы получаем меньше вероятность отстрелить ногу пользователям самим собой мы на пользователя вывалились то infused как он есть сделали мы это для того чтобы в общем то можно было как раз задать разные параметры конфигурации например топологии сети какую-то особенную ну и в общем-то про ресурсы если коротенькая случки зрения ресурса важно удобство использования важно делегировать часть работы на кубе потому что помимо а у них шипы герм очка election и в кубе мы можем использовать анализатор мы их не используем на в дальнейшем dito1 значит пригодится и чем более сложная эксплуатацию тем более закрытые ресурс имеет смысл создавать дальше эксплуатационные логика эксплуатационные логике этого счета код который в общем то есть контроллер часть оператора у нас этих контроллеров две штуки первый контроллер это роль контроллер это чисто утилитарная вещь он предназначен для того чтобы добавлять стоит fools этой роли он предназначен для того чтобы расширить свои вкусы этой на случай если понадобится больше реплик ну и выполняет всякие сервисные штуки например он назначает какие-то конфигурационные параметры для стоит вкус это второй контроллер это классно контроллер это уже мозг оператора и та самая штука которая событие кумира превращает последовательность описанных вызовов гарантов картридж в определенном порядке в нужное время на с целью привести уже карты работоспособное состояние сам по себе контроллер от почти каноничная стоит машина выглядит он привез тематический вот так если победил на стадии на первой итерации например на мы проверяем что кластеры с которой мы сейчас будем работать у вас существует дальше мы пытаемся захватить владение ресурсами роль если у нас получается мы выходим и возвращаемся в самое начало следующим за ходом мы опять пытаемся захватить владение ресурсами если делать там нечего идем дальше и вот так вот из раза в раз проворачивая весят кружочка пробегаясь по всем стадиям мы приводим в общем-то картридж класса карточек работоспособное состояние важный момент здесь заключается в том что переход между стадиями вот этими невозможно пока успешно и полностью небо не отработает предыдущей стадии с точки зрения написание контроллера важно его надежность надежность нужно почему потому что как любой софт контроллер будет падать во первых во вторых контроллер после того как упал может поднять вообще с любого момента с любого состояния может подняться по середине процесса может подняться когда никого нет а сверху на него накладываются еще действия пользователя то есть пользователь увидел а контролем опалов оператор упал пойду ручками чинить отчета сделал оператором поднялся и теперь он вообще не пример с чем имеет дело здесь в что мы с этим сделали действие очень просто любое внешнее воздействие имеет смысл транслировать в изменении состояния ресурса то есть на примере на примере например операции присоединения инстанса кластера мы отправляем из контроллера запрос на присоединение станцию если у нас операция присоединения проходит успешно то следующие сразу же что мы делаем мы сохраняем это состояние в ресурс поток который присоединился класс так точно так же в принципе работает и сам кубов местами то есть например когда вы удаляете ресурс ресурс фактически не удаляется но в ресурс проставляется время удаления она что мы в общем-то и опираясь когда отлавливаем операции удаления в комбинации с точки зрения надежности в общем очень простая практика нужно сделать состояние частью нашей бизнес логики тогда нам не придётся разбираться со своей играться состояниями с условиями какими-то когда мы поднимемся с неизвестного момента мы можем подняться с любым известным состоянием потому что это часть бизнес-логики контроллера даже с точки зрения надежности важно еще как контроллер отрабатывают ошибки например операция join a возвращает вот такой вот результат если бы этот результат всегда выглядел одинаково а то есть если бы наши api бы выдан патент на тогда мы проблем не было никаких мы могли вызывать его ровно столько раз сколько нужно но наш картридж возвращает вот такую вещь он возвращает ошибку случае повторного джона соответственно в нашем конкретном случае ошибка здесь лучший индикатор успеха операции чем сам успех операции потому что ретро ить мы будем в любом случае и вот ошибка о том что эта операция уже была успешно выполнена она нам будет возвращаться каждый раз поэтому в общем то в большей степени взаимодействуя с картриджем опираемся на коды ошибок чем на успешные члена успешные вызовы операции и последний момент про контроля с точки зрения механики написание кода контролер удобно организовывать так чтобы его потом можно было разводить на составные части что нам это дает во-первых нам это даёт организацию коды виде маленький кусок делает одну-единственную операцию у него одни входные данные и одним выходной результат один переход между состоянием просто такой момент на удобство чтобы при написании большой splat ционного куда это все не превратилась в лапшу и в общем по контроля с точки зрения проектирования контроллера важно разбить работу на мелкие части важна надежность самого контроллера досыта для того чтобы достичь мы можем пользоваться в общем-то состоянием ресурсов и можем до храним состояние в ресурсах и делаем это состояние частью нашей бизнес лодки еще важный момент который конечно же забыл сказать когда мы храним состояние в ресурсах мы оставляем возможность чинить ресурс вручную то есть если у нас например по какой-то причине на на примере того же join a по какой-то причине операция была вызвана join прошел но мы не обновит наоборот join не прошел и мы не обновили состоянии еще раз запутался сам мы вызвали join join упал но мы по какой-то причине записали в состоянии что in стас при джоне мы всегда можем прийти поменять ресурс удалить эту пометку на и контроллер его подхватит и при джоне в конце концов таким образом про контроллер и все теперь про интеграцию с купером принципе весь кубер можно схематически изобразить вот так весь кубер состоит из контроллеров которые как-то там взаимодействуют между собой перекидываясь событиями словно событиями на то есть наш тарантул класть контроллер например захватывает владение ресурсам роль вызывает операцию обрита относительно этого ресурса что привык созданию события роль обновилась на эти события подписан роль контроллер он это событие получает и уже включает к будет свою например 100 и вкус и это создает с точки зрения работы с этими событиями важно вещь вот такая интерпретировать события дело бесполезное крайне в попытке сохранить возможность работать со стэфф и с ресурсами я пытался отлавливать событие удаление ресурса на то есть у события есть некая семантика событие удаления ресурса отлавливать смысла нет никакого на самом деле потому что удаление ресурса приводит к изменению состояния ресурса поэтому с точки зрения обработки событий важно буквально относительно какого ресурса это событие произошло и какое состояние этот ресурс имеет сейчас соответственно каждый раз когда мы получаем события имеет смысл работать вот так событие получили сходили спросили у кумира состоянии ресурса с которым это событие произошло сделали какое-то действие записывали состоянии обратно вторая игра бля на которую я наступил ты попытка сделать кучу работы за один заход на то есть например в нашем случае это была операция масло join a мы получаем одно уведомление о том что поднялся под выбираем целый список этих кодов и начинаем в 1 цикл в один прогон их все joy нить в этот момент пользователь кубер носиться может сделать что угодно может удалить половину пуда кодов на и мы будем половину работы делать уже в холостую относительно удаленных ресурсов то есть чем больше работая за один цикл мы пытаемся сделать меньше вероятность успешности завершения этой работы ну и последний момент относительно рабочих работы с событиями когда мы дробим контроллер на маленькие куски которые выполняют какие-то маленькие части и это всегда приводит к изменению ресурса мы таким образом можем жестко контролировать поток событий которые мы получаем и четко определять себе процесс от и до соответственно например мы причинили роль потом мы для подав рамках этой роли присваиваем replicas эти виды что приводит к обновлению ресурса под что привык к тому что мы получаем это событие еще раз и следующим за ходом мы уже назначаем реплика сетки виды и вот так вот играясь переходы между состояниями можем жигули себе события сами разбивая работу на какие-то четко ограниченные номера объемы в общем ru события если коротко интерпретировать их не надо бесполезное совершенно занятия что вы было нужно балансировать объем работы которые контроля вперед за раз по наступлении этого события чтобы его балансировать контролируемое мы можем четко задавать объема работы играюсь в общем-то изменениями состояния ресурсов или schedule и их таким образом себе сами по сути с точки зрения в общем-то кодовой базы все это базируется на оператор из дикие принципе контроллер можно написать десятью способами условно говоря но оператор с дикие общем-то мне кажется самые зрелые решение для того чтобы выпилить императоры от и до что касается операторов это в общем то все ну и последний момент как нам пришлось подбирать картридж во первых начали мы с чего стоит wool свет дает нам гарантию уникальности имени пода в комбинации с hello сервисом он даем фиксирует нам сетевой айдентики пода но айдентики самого инстанса тарантула представлены не только именем а сетевой часть нужно задавать еще как минимум два параметра это иди самого инстанция единство соври приказ эти здесь возникает интересный момент да что уникальный идентификатор но мы должны его сделать воспроизводимым здесь наш оператор подкасты рует вот так то есть виды инстансов мы вычисляем относительно имени пуда раз у нас стоит вкус и это имя пода всегда одинаковые реплика святые дымы учит своим от имени стоит вкус это имя стоит fools это тоже всегда одинаковое на потому что именно место и вкус этому управляем сами и как под и в рамках стоит full set of это именуется название и яндекс также и стоит вкус этой в рамках роль контроллеров наших наших наших ресурсов ролей именуется точно также имел стоит fools это и яндекс и порядок подъема стоит fools это в точно такой же таким образом мы фиксируем 2 вот эти параметра второй момент это лидера легче первый заход когда мы поднимали это все на купюре мы поставили стоит вас часть нашего кластером за балансирующим сервисом на круп мы получили чем взываю от минска и api мы тыкаем сначала v1ncent потом в другой потом в третий потом 4 получаем 4 разных класса который мы потом вместе объединить же не можем сначала я сделал вот так то есть вынес отдельно стоящую роль которая отвечает исключительно за от минске api и за топологию кластера таким образом просто зафиксировав того момента что все запросы всегда приходят на 1 инстанции проблема с этим решением в том что мы перекладываем ответственность за создание вот этого сервиса исключительно на пользователя нашей системы ну и в общем-то не надежно конце концов мы пришли вот к такому мы перенесли лидер election полностью на кубе работает это очень просто кубик в кубе есть эти сиди каждый раз когда у нас под и поднимаются они объединяются хотел сервисом что приводит созданию ресурсы on point мы слушаем изменения ресурсы импульсно отлавливаем момент создания и самый первый on point например которого у нас появляется в этом ресурсе мы его и делаем лидером на обновляя тот же самые ресурсам points эти седина в этом отношении да и его а пищи к дает гарантию того что мы сделаем проведем эту операцию как ассистент на и последний момент репликация при настройке репликации в рамках картриджи есть один интересный нюанс при очень специфичных обстоятельствах мы можем наступить на d блок при настройке репликации то есть мы настраиваем репликацию между не с танцами и она не настраивается потому что instances этой ночью лишь ожидает друга здесь мы выехали как стойку свет нам гарантирует порядок запуска поводов то есть у нас 1 всегда запускается мастер али только потом свои вы и мы на уровне оператора гарантируем паёк порядок присоединения инстансов поднятых картриджу то есть мы всегда сначала подключаем картридж мастеров потом подключаем уже своего в по порядочку в общем чего мы хотели от кубера чего хотели того все таки добились тарантул картриджи можем поднимать автоматизировать можем относительно автономно получилось дальше уже вокруг этого можно какое-то мясо накидывать в качестве вывода чего хочу сказать во первых стоит full set без оператора это в общем то всегда практических ручная эксплуатации это не очень хорошо но если у кого-то есть возможность сделать это все руками можно и без оператора пожить чем сложнее софт который мы поднимаем тем сложнее эксплуатационные процедуры тем сложнее получается оператор тем больше багов тарантул в этом отношении хорошим у него 10 конфигурационных директив и 5 эксплуатационных процедур но если вы будете поднимать mais quel тем же самым школьным оператором потом придется неплохо сплясать уже настройки мои скрыли надеюсь все знают какая там портянка хороший качественный оператор это сложно сложно по нескольким причинам в основном даже не из-за техники а из-за логики и залог ее работы и залоги проектированию ресурсов но и технические нюансы тоже возникает ну и про кубе кубер надо знать то есть часть работ которые мы могли бы напилить руками мы можем спокойно делегировать на купер мэтис iii общем то так и жить с этим чтобы не делать лишнюю работу знаете разбираетесь и за вас он будет делать что-то полезное и последний момент самый мне кажется важной все это история если ваш софт ох и это вылезло нак убери это вылезет потом везде неважно кубер не технику вернитесь кубер на в этом отношении дает просто более динамичную среду вследствие чего баки влазит быстрее то это же произошло и с картриджем из тарантула в разных конфигурациях в общем на этом всё с оператором наши можно проработать здесь можно познакомиться там же лежит документации там уже лежат примеры пользуйтесь пробуйте пишите баги рапортуйте ну и буду рад ответить на вопрос если таковые будут иметься спасибо огромное еще одна задача нас той страны будет выбрать самый лучший ответ у нас я хочу запугивать ответственно не уходи далеко наоборот возвращайся к нам а ты здесь вот а это тебе спасибо сертификат и такая вот удобная сумочка проще и так дорогие ваши вопросы типа было очень интересно никто не у слова bass вопросу спасибо цвету на весь вопрос ну хотелось просто как-то разбавить эту тишину реально большой этажей сделали будем обязательно попробуем ну для всего сообщества думают прям очень круто 0 кстати я перед тем как с тобой встретиться поговорил с романом побор чем прям очень высокого мнения о твоем докладе был очень странным доклад технически сложной он из разных аспектов да поэтому и причем на стыке такую специфичную вещь это как таран туда кубер поэтому в общем то я не удивлен что аудиторию небольшая у вас здравствуйте спасибо за доклад и такой наверное немного философский вопрос не возникло ли у вас в процессе разработки мысли а лучше бы мы использовали что да такие мысли были на самом деле смотрите можно вот этим всем было поступить разными способами один из самых неплохих способов это работать изнутри то есть наладить интеграцию из тарантулов кубер нить из да например мы могли бы получать топологию кластеры из усэйн болт и работать как-то с этим оператор это внешнее относительная вещь соответственно здесь оператор получился even одна из причин по которой именно вы это внешнее решение потому что изнутри делать это довольно сложно то есть буквально наверное может в этом году где-нибудь концу у нас появится возможность впитывать свои компоненты сервис discovery что позволит нам запилить интеграцию изнутри из например с имплантами и получать топологию кластера оттуда соответственно да есть более лучшие способы скажем так более клауд на этих у и там на и так далее но в целом задумывались варианты есть мы отрапортовали и будем пытаться точки расширения воткнуть наш на рампу наш картридж по возможности уже от этого работать еще напрасно дорогие да у нас за лучший вопрос будет большой приз а за каждый вопрос мы даем футболку тарантул здесь мы дадим один большой приз и одна футболка родил вопрос мониторинг и overthink там мониторинг мониторинг лифтинг в торонто ли в общем-то представлена модулем мы модулем metrics то во-первых да то есть мы можем метрики вывалить наружу и собирать их например формате prometheus а еще буквально не так давно у нас релизу султан tracing модель учит то есть пересчет тарантул можем видеть насквозь от еду завезли ли это как best practice как best practice мы это дело пока не заводили потому что помимо того что ну то есть сам модуль matrix он использует какие-то tarantul ные метрики каждый раз на них навешиваем свои еще бизнесовые поэтому сделать какое-то общее решение по принципу я подключил едешь его не просто соответственно потому что берешь подключаешь получаешь системные метрики какие то соответственно дальше уже допиливают под себя обдумываю время какой завистью в оператор настройку через класс стр через отдельную секцию метрики собираются всех инстанций фоток в таком формате там и так далее тогда получится это делать зафиксировать sim так есть еще вопросы ну тогда собственно между двумя до самый интересный вопрос из всех весовых 3 был край альтернативы то есть наш можно чем бы ни был наш самый главный подарок он пойдет туда эта книга и термокружка класс я тоже хочу такую термокружка любят тьму себе воду для 40 минут ответов сейчас было только что спасибо тебе огромное всем спасибо кто послушал это был будет полезно кабаках пригодится"
}