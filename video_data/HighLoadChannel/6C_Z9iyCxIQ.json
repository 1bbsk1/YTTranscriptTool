{
  "video_id": "6C_Z9iyCxIQ",
  "channel": "HighLoadChannel",
  "title": "Путь DevOps в Parallels / Константин Назаров (Parallels)",
  "views": 112,
  "duration": 1823,
  "published": "2017-04-06T11:39:45-07:00",
  "text": "константин назаров приветствую вот теперь слышали так вот и так всем еще раз я константин назаров я представитель такой не частой профессии как enfants в компании parallels я пришел как релиз инженер в основном заниматься сборочной системой это было примерно 3 года назад и сейчас у меня есть небольшая команда которая собственно занимается infrastructure operations сейчас я хочу рассказать вам как так получилось сделайте скидку на то что компания parallels на продуктовые может быть что то непонятно но в общем потом можно будет задать вопросы продуктовая компания что это значит у нас есть продукт который выходит каждый год и мы не можем его не выпустить соответственно бывают очень такие сильные дедлайны из которых который просто нельзя не встретить и так началось все с момента когда три года назад я присоединился к компании пролет заниматься сборочной системой чтобы было понятно что такое сборочная система продукта parallels desktop это виртуализации он ьный продукт для запуска разных виртуальных машин на маке он состоит из большого количества компонентов дело в том что там нужно запускать разные гостевые операционные системы поэтому драйверы поэтому там всякие сопроводительные тузы и так далее и все они довольно тесно связаны и собираются на разных операционных системах можно было бы подумать что там компоненты как-то друг от друга они отделены но нет для виртуализованных продуктов они связаны воедино из-за того что есть а бинарные фрезы поэтому все это собирается как один большой кусок когда я начинал когда присоединился к компании я встретил впервые там несколько месяцев очень большой порог вхождения потому что вся эта инфраструктура она была сама песчаной то есть в течение там где-то 10 лет сборочную система писали с нуля потому что тогда никаких не дженкинс of не современных систем continues on the gray scheme просто не существовало я поскольку это очень сильно резала глаз я взялся все это переделывать что первое что пришло в голову это на вернуть на это все дженкинс и успокоиться на деле все вышло гораздо сложнее пришлось продукт разбивать из-за того что система была in-house в ней накопилось очень много взаимных зависимостей пришлось эти зависимости резать ушло наверное где-то несколько месяцев на то чтобы разрезать все на какие-то более ли менее атомарные куски и завернуть в дженкинс распараллелить там сделать целый довольно довольно сложную систему распределения сборки в результате что у нас получилось у нас получилось что там где стоят знаки вопроса это значит я просто не уверен что там было или сколько там было компонентов потому что это было очень очевидно сейчас у нас около 20 компонентов которые собираются параллельно на разных операционных системах довольно большой объем сборок в год который мы храним билды собираются примерно полтора часа раньше они собирались 8 часов из за того что был парк машин довольно небольшое не было практически никакого механизма распределения для чего изначально все это было сделано для того чтобы предоставить девелопером какую-то единую точку входа в сборочную систему и чтобы сделать его более понятный до цели мы вроде как добились но мы не ожидали открыть такой очень специфический ящик пандоры называются управление серверами до того как эта система была система распределения сборки она была реализована у нас было всего несколько самых обыкновенных изотопных компьютеров на которых собственно эта сборка происходило после того как мы добавили в комплект серверов начались проблемы потому что управление она была практически полностью вручную когда продукты такого класса выходят очень часто меняются в библиотеке зависимости например какая-нибудь библиотека типа у панаса цель который в которой может обнаружить свою зримость если ее обновлять на всех серверах то можно например забыть один из серверов что довольно часто случалось то есть приходилось перепроверять приходилось перри прогонять тесты и так далее все это ближе к релизу становилось очень напряженным мы некоторое время думали как как решить эту проблему и первое самое простое решение которое пришло в голову это собственно виртуализация но мы виртуализацию делаем почему бы не запускать сборку виртуальных машинах мы так и сделали взяли свой собственный и собственно серверный продукт взяли распределенная файловую систему к счастью она у нас есть я с очень большой болью слышал слышал сегодня докладчика который рассказывал про собственно большое файловое хранилище к счастью нам не пришлось ничего городить и мы думали опять же что это нас спасет оказалось что просто распределение сборка на виртуальные машины она не делает и не дает в результате практически ничего то есть ну да изначальный порог вхождения для того чтобы настроить поднять виртуальную машину поднять эту сложную среду единожды а потом ее распланировать вам может быть не таким большим носом ошибки потом накапливаются вот и постоянно появляются какие-то виртуальные машины снежинки например вышел один релиз для него какую-то сборочную среду приходится замораживать а другой релиз который развивается параллельно сборочная среда продолжает прогрессировать есть очень большой риск и мы неоднократно в это вступали потерять сборочную среду решив что она не нужно просто удалив ее проходит какое-то время вы вспоминаете о черт что что то не так вот пытаетесь найти сборочном среды я нет вот и бэкапы здесь не всегда помогают потому что они тоже протираются и так далее третьим этапом мы решили что да еще где-то где-то в этот момент мы решили что нам поможет vagrant и конечно там погуглили решили что давайте за implementing управлением виртуальных виртуальными машинами через vagrant вот и это сыграло отлично но самое интересное что сыграло совершенно другое русло есть vagrant мы в итоге применяем но совершенно в других целях я был я чуть попозже расскажу значит опять же после вот этих всех мытарств после сломанных сборок после попыток восстановления машин мы пришли к системе управления конфигурацией это не новость что сейчас можно найти там систему управления конфигурации который настроен все что угодно и там линуксе винду и mac все эти операционные системы которые там участвовали участвуют сборки но оказалось что вот мы начали исследовать система управления конфигурациями еще где-то полтора года назад и количество экспертизы которые понадобилось вложить просто в разворачивании тот инфраструктура нога она оказалась просто огромным мы где-то полгода только opti равале процессы вот и учили людей правильно пользоваться шефом вот ну да в результате это все построилась но интерес ситуации в том что до сих пор не все in warm and автоматизировано просто потому что оказалось что вот некоторые сборочные среды настолько сложны что не всегда их можно даже скриптами настроить только в некоторых случаях только человек может сделать руками частью такого немного где-то посредине до пришло что мы получили от этого от система управления конфигурации мы автоматизировали практически все фактически все вокруг сборочной системы практически все наши внутренние инструментарии даже борды девелоперские там порталы и так далее все получилось очень здорово самое главное что мы до чего мы добились мы добились единые прыжки вход для понимания всей системы и люди в команде они смогли как бы шарить знания друг с другом и шарить какую-то общую ответственность за компоненты но результат был бы неполным неполном если бы не система контроля версий дело в том что для мы мы всегда практически всю всю жизнь даже всю жизнь нашего да вот я проскочил немножко пардон этого да это это смен мы практически всю жизнь для большого проекта пользовались с вином работала это относительно неплохо но когда проект централизованный нарабатываться со временем практике люди учатся пользоваться вот этим для infrastructure abs оказалось что пользоваться свеном практически невозможно то есть вам нужно очень большое agility нужно рождается уничтожать маленькие компоненты и маленькие утилиты поэтому нам пришлось очень не кислот повозиться с этим и сам перевод продукта на git он доставил нам просто неимоверное удовольствие счастью все закончилось сейчас вот и мы выработали такие практики работы с очень большими с очень большой кодовой базы и там сняли с несколькими релизами но это было очень тяжело вот и я все больше и больше склоняюсь к выходу что к выводу что некоторые продукты не стоит переводить на git вообще это может звучать странно но если бы мы не начали заниматься infrastructure abs я думаю что этого этой причинам бы у нас не было дано в результате мы конечно получили точно так же как и с системой сборки точно так же как с шефом единый какой-то инвентарь всех наших проектов вот это казалось просто не неоценимы штука потому что review малин маленького вот этого вот кода который от это в инфраструктуре это единственный способ нормальной передачи знания теперь проблемы которые мы встретили на всем этом пути они оказались вовсе не технически то есть технически реализовать это все было сложно но не слишком сложно какие проблемы мы пытались долгое время решить например когда вы когда у нас вот есть большая система сборки код из миллионов строк кода сам продукт за миллионов строк кода очень сложно найти ответственного за починку какой-то ошибки например что будет что-то нужно делать когда ломается компиляция продукта естественно кто-то должен начать чинить особенно если несколько сборок в день и постоянные цикла тестирования постоянно циклу так постоянный цикл про гонки и мы постарались вводить какие-то правила в 1 к сожалению эти правила не не заработали правила о том как должен должен блокироваться цикл починки то же самое как как все правила по настройке машины все все чек-листы так или иначе во время релиза или близко к релизу когда оно наступает самая такая жаркая пора все это деградирует очень хорошо вот результате ничего не остается также у нас был у нас была очень большая большая борьба с операционными фичами если кто не знает операционные fitch это такая штука которая напрямую не влияет на функционирование продукта вот всем понятно что операционные фичи нужно делать но когда у вас есть продукт с большой историей и когда в продукции никогда не было infrastructure abs обосновать вот эти вот операционные фичи о том что нужно инвестировать в инфраструктуру например нужно инвестировать например в тот же сам шеф очень сложно если попытаться планировать это в рамках какого-то релиза это неизбежно проваливается то есть она съезжает на какой-то последний план объяснить почему продукт оунер им объяснить почему нужно сделать что-то с инфраструктуры довольно непросто и контроля нормального контроля не получается нормального контроля который действительности должен быть поэтому мы решили что нужно как-то из этой ситуации вы хотите помогать себе самостоятельно в результате мы придумали такой способ мы наняли себе в команду двух человек которые занимаются исключительно там внутренней работой по инфраструктуре таким образом очень хорошо развязали вот этот вот узел связи с продуктом вот в продукции например могут не не всегда например знать какие операционные фичи готовятся но они потихоньку готовятся и мы знаем по крайней мере что они есть и можем о них потом рассказать вот и это оказалось лучшим выходом чем пытаться встроиться в клуб релизов еще один файл в который мы вступили это попытка модифицировать культуру то есть например на на примере тех же самых сборок очень хорошо рассуждать на примере больших каких-нибудь современных web компаний в которых есть там всякое боем ли скульптура культуру экспериментирования в которых это поставлено на поток но на деле внести это изменения в кампанию снизу практически невозможно потому что для этого нужно там находиться где-то где-то наверху испускать это мы несколько раз пытались носить как мы пытались предлагать какие-то культурные изменения но понятно чем это закончилось то есть это очень сложно для этого нужно обладать большой убедительности естественные я думаю что если бы этот человек был на моем месте или бил по умер из из романа и феникс поджигать конечно они вы пришли в компании все сразу посчитали все померили и конечно доказали всем необходимость от этих культурных или каких-то изменений но на деле я всего лишь обычный человек у меня есть ограниченная сила воли и хватает там на какие-то функциональные изменения и не всегда хватает например большого опыта для того чтобы внести вот изменяя какие-то в клубную культуру но мы выработали для себя вот такой вот рецепт а когда я пришёл в компании если представить себе сборочную систему как как какую-то сложную систему в которой отсутствует внешний порядок подойти как-то к ней начнете менять сложно потому что она постоянно двигается в ней постоянно вносятся какие-то изменения и вообще рассуждать и доносить до окружающих людей эти изменения проблематично какой рецепт мы придумали собственно вводить ограничения какие-то разумные системе попытаться ее прийти посмотреть на в этой сложной системой придумали где можно и вот очертить вот такие круги и понять как выстроить интерфейс между частями системы вот и попытаться сделать так чтобы вот эти вот круги они были достаточно жесткими и на нескольких примерах это отлично сработало то есть например стиль с тем же самым сервис той же самой системы сборки с та же самая система управления конфигурации там с вот этими проектами мы всего лишь за enforce или провела там в ну каких-то нужных местах в чем была наша ошибка в том что мы попытались за enforced такие правила для сложных систем над которыми нас нет контроля то есть там над коллегами и руководством надо вообще над группой в целом это было не очень правильно вот но мне кажется что это была такая важная часть опыта делать этого однозначно не стоит этому мы решили что дотягиваться и делать нужно реально только то она что у вас есть прямое влияние тут есть такой нюанс еще что есть вещи которые вам напрямую принадлежат вашей команде например там сферу вашей ответственности системы сборки а есть вещи которые вам напрямую не принадлежат например какой то creations и так далее но если вы посмотрите и не увидите сопротивлению соседних групп можно спокойно потихоньку начинать вот эти вот куски как вы отъедать что мы сделали в результате это дало гораздо больший выход то есть практики начали расползаться сейчас в компании сейчас нас во многих местах уже даже в продакшен проектах есть вот эта система управления конфигурацией вот довольно хорошие удобные процесса deployment а там одной ручкой вот и все и все вот из-за этих вот небольших изменений которые еще очень много времени вы потратили вот на это она карго-культ многие решения которые мы принимали многие вещи которые мы пробовали мы наверное не до конца понимали и результативность но самое интересное что со временем многие говорят что это плохо там пробовать то что вы не до конца понимаете или применять решение последствия которых вы не до конца осознаете но я вот на мой взгляд то что мы успели на своем опыте понять если не обязательно например деталях понимать как как стреляет автомат для того чтобы его использовать вот и вряд ли есть много специалистов реально потому как работают например система контроля версий до того как внедрить гид я например не понимал как он работает но это в принципе не требовалось важно понимать какие архитектурные преимуществом дает вот и ответ на этот вопрос да в принципе иногда это оправданно заигрываться с этим не стоит но если это позволяет вам очертить какие-то мысленные круги вокруг своих систем почему нет еще один момент вывод из всего этого которое я хочу сделать он такой у инженерной команды есть возможность изменить в компании рабочие подходы и рабочие традиции но делать это нужно при помощи аккуратного инжиниринга и именно технических решений спасибо с добрый день у меня вопрос как то там была смазана я не очень понял как найм двух человек решил проблему на м2 человек решил проблему с кореей и как сказать нет того что появились дополнительно дополнительные мощности до их можно было бы и так нанять включить в проект на м2 человек повлиял ну и их выключение из активной работы на на проект повлияло на то что они как бы вы выпали из общего ласково по планирования никто на них не планировал задачи если бы их включили в проект в общей то через некоторое время там пришли бы люди сказали что вот как бы давайте на них повесим еще что-то ответ понятен но когда у вас есть активная разработка и люди участвуют в разработке продуктов вы хотите продукт оунера всегда есть большой соблазн людей взять на дополнительную работу вот если продукт оунер заранее не планирует этих людей использовать если ему запрещено их например использовать или сказано что вот на это есть мораторий то тогда эти люди практически всегда свободны то есть это такой трюк в общем мне вот вопрос тоже про этих двух мифических но не мифических реальных вполне людей они чем-то зацепили вот возник вопрос почему как бы при сложности обосновать в бюджете время на за пилот этих операционных вич удалось при этом обосновать в бюджете на м2 дополнительно людей девелоперов причем как мы видим они дешевых все равно они были нужны то есть когда тогда можно было выделить нет нет а там проблема не в найме людей и людей нанять как бы не сложно объяснить зачем они нужны при наличии проблем и проблема потом эти этих людей как бы удержать от того чтобы они не были втянуты в разработку продукта наброситься фишка была именно в том что каким-то образом вы сумели изолировать и и держать главное в этой золя какой про какое то время а какое но около года но это круто еще у меня вопрос такой для уточнения вот операционные фичи а их как технический долг нельзя было продать команде можно было продать команде как технический долг но это не не решила сама проблема все равно было бы желание начать использовать здравствуйте спасибо за доклад у меня следующий вопрос несколько более технически вы сказали что расскажите как вы используете vagrant а да да хорошо с его грантом была такая штука что мы же разрабатываем parallels desktop это решение системы виртуализации на маке вот мы под мы думали готовить окружении сборочные на своих машинах при помощи vagrant и потом загружать их грубо говоря в серверную стойку вот на этом резиновую файловую систему чтобы они там вращались вот но нам пришлось для этого разработать для своей системы виртуализации там правой vagrant провайдер зделал так что порылась до стоп был сыгран там просто совместим вот это собственно продадим из продуктов команды который довольно успешно вошел в фича лист 10 parallels desktop а сейчас мы используем vagrant для того чтобы гонять в тесты и проверять прогоны шефа того же самого но готовить окружение и мне очень эффективно оказалось то есть их очень не удобно потом заливать гораздо удобнее там уже в в условном облаке поднять машину и наложить на неё рану запустить на ней шеф грубо говоря зовут стопить вот но vagrant оказалась одной из самых полезных вещей которые мы сделали он как как такой полипа трос в сторону вот мы в общем ничуть не жалеем что мы попробовали спасибо за доклад вопрос следующий подобное изменение нельзя сделать без поддержки топов и без бюджета насколько насколько широкий карт-бланш у вас был для реализации подобных изменений ну скажем так в этом есть наверное определенная моя заслуга да дело в том что когда ты приходишь там в компанию свежий человек и ничего еще не доказал что ты умеешь что-то делать конечно приходится вначале очень сильно поднапрячься поработать на какой-то ну как бы кредит доверия какой-то кредит доверия заработал и просто былa нa постарался быть очень очень убедительным со своим начальником с vip не то есть получается это вы пришли к начальству с предложением сделать свой красивый или вас наняли что сделать красиво ну изначально пришлось делать красиво как-то немножечко овертайм ну я я например работал какое-то время overtime но пришлось это сделать но когда мы доказали что мы например можем немножко подвинуть систему сборки и сделать ее гораздо более удобные вот начиная с этого момента наверное изменение пошли очень хорошо вот этот то что я имел в виду когда я говорил про инженерное решение то есть в принципе сделать что-то хорошо можно как бы начать получать какие-то другие деньги бюджет на бюджет людей ресурсы если вопросов больше нет поблагодарим докладчика еще есть еще все можно строить вопрос кто вместо vagrant тогда то что вы использовать используйте у себя для прогона тестов ну соответственно нет мы сейчас мы сейчас используем стейджинг и production environment и которые мы при помощи так называемого berk berk сплав диплом то есть у нас есть одна кнопка сейчас но в отдельном специальном дженкинс и которую мы нажимаем у нас снимается snapshot со всех рецептов чеховских вместе с и snapshot ами всего кода и они при помощи и там perks биркс оплот попадают на наш сервер и потом тепло и цена машины у нас есть пейджинг январь у нас одна кнопка позволяет с диплоидный дженков другая кнопка позволяет за deployed production при этом еще дополнительно локально можно воспроизвести то же самое в в гранте большей части наверно то в которой мы делаем они позволяют локально сделать какой-то провяжем ну все flagrante смысле при помощи шефа его granta тест kitchen скажет проводится шефом используется knife оркестрацию все что любила своих зависимости при теплую да есть мы используем при тепло и knife ну как как как я говорю мы больше используем конечно такую вещь как bere bere bere full она как раз и позволяет соединить все зависимости проекта это по-моему у джимми vinter что ли предложил оригинально и the right games что ли правильно говорю да играет games человека это его утилит она как раз и позволяет упаковать все вместе залить наши в сервер из-за constraint сразу версии там каблуков и всего остального и потом запустить наборе с серверов сразу шеф клиента тоже ну то есть там уже в этой утилите все автоматизировано да мы используем оркестрацию мы используем но вот шеф сервер для того чтобы инвентарь строить держать"
}