{
  "video_id": "2PCPqI2Em9M",
  "channel": "HighLoadChannel",
  "title": "Aviasales: миграция поискового движка в docker / Дмитрий Кузьменков (Aviasales)",
  "views": 5066,
  "duration": 3043,
  "published": "2017-04-22T14:48:27-07:00",
  "text": "всем привет меня собственно зовут дмитрий а я работаю full stack разработчикам в команде aviasales aviasales я думаю многие из вас уже знают занимается тем что предлагает пользователям найти самый дешевый билет на прилет и сегодня хочу рассказать о том как мы вообще дошли до того что мигрировали наш поисковый движок докер почему вообще это сделали и что общее вышла из этого немножко цифр у нас где-то полтора миллиона поисков происходит где возможно это не так много может показаться но сейчас вам будет понятно вики мы обрабатываем где-то 1000 поисков в минуту пиковая нагрузка обычно происходит где-то ну в обеденное время на но люди сидят там офисах и ищут билеты и хотят как бы купить что то ли просто смотреть стоит иметь ввиду что один поиск это одновременный опрос до 200 партнеров без какого-либо каша настоящим real to me парсинг а всего просто подряд и если ответов xml и vsop просто четко нету то что а фишки разные партнеру мной у каждого свое вот и пользователь получает до 15 тысяч билетов в одном ответе поисковым и все это получает он течение 1 минуты обычно случается бы большинстве случаев где то получается за 40 секунд и дело в том что если как партнер не ответил да ну не ответил он не получит и спина на а ясень именно так зовут наш поисковый движок код расшифровка это надо все очень жаль что про него могу сказать он написан на питоне использует торнадо для для обработки серверных запросов до изначального работал на 8 мощных серверах и все это дело как бы давала первый ответ с метаданными лет информации где-то за 1 5 секунды как вообще все устроено и как все все работал смотрите запрос от пользователя приходит на х прокси к прокси у такой дубовый старый метод но он рабочий он быстрый почему нет он выбирает самый свободный сервер который не загружено и отправляет сера называется пчела да я расскажу подробнее про нее час а пчела получает запрос и далее стартует поиск и сразу же отдает ответ 1 с метаданными пользователю чтобы это побыстрее рендерил за какие-то метаданные непосредственно там по баннерам и прочие вещи приходят далее пчелы уже отложенное идет из это поиск идут от всех где-то собирается параллельно одновременно аврил тайме да никакого конечно отправляется локальную очередь есть еще такие тяжеловесные штуки как муравьи они забирают собственно из очереди уже конкретно то что получили да уже в билеты и эти билеты на втором запросе через редис то есть у нас чанг амида от поняли когда второй запрос приходит от пользу на другой in point опять проходит через чуму и уже и среди за ответы мы отдаем просто обычный был поп из листа и это достаточно просто примитивно работает это быстро вот а более того он ты еще имеет много чего другого делать они отправляют кучу статических данных вообще сами результаты поиска достаточно такой широкий спектр столь же да мы используем массе клип от греции ряде церквей но это на самом деле не все а есть еще у нас у пчелы есть состояние мы настраиваем работу гитов конфигурационные файлы и есть еще такой сервис которое двоится watcher он собственно следит за изменениями файлами и прям were all to me обновляет конфигурационные данные в жилах сейчас я расскажу вам будет понятнее как вообще все это устроено по компонент пройдусь пчела пчела пчела это собственно такой сервер на тормозе она служит организует нашу apes куда там несколько инвайтов получения билетов там крики собственно инсоляция поиска и прочие вещи она умеет взлетать и падать и так уж сложилось до что у нее есть свой цикл жизни это цикл жизни ну примерно 30 минут равен поэтому чтобы это как-то компенсировать мы несколько пчелы запускаем ну и более того это параллельность то что это async раньше надо да и все-таки она не параллельная и чтобы занятия дорадо мы запускаем несколько пчел то есть нас запущен где-то 16 чел на одной машинки физической еще скажу почему очень падает она за 30 минут до конфигу много этого много все это поститься как вас совсем разнообразными способами xml и там зоб и чего только нету да я даже ищите медленно для парсится и происходит memory leaks так называемый как бы с этим как бы особо ничего не поделать она просто умирает поэтому вот таким образом консервант окей учил есть состояние как я уже сказал и такой компонент как watcher он в одиночку на каждой ноги просто следит за физическими файлами когда они изменяются до конфиге у нас файла хранятся и прямо в через and paid отдельные обновляет почему всех пчел проходит и так собственно это работает и доставка конского происходит есть еще муравьи я уже говорил это такие жила весны и сервисы которые делают отложенные задачи и у них есть несколько приоритетов зачем приоритеты спросите вы на самом деле например высоко приоритетный анты занимается тем что как раз таки фигурируют результирующие поиски для пользователей то есть они просто у них высокий приоритет и они работают быстрее забирают быстрее эти данные из очереди сразу быстрее время с кидают потому что это важно что пользовать получил ответ 1 чанков да как можно быстрее 1 чанг у нас там может порядка топ 3 5 секунд обычно приходят вот где-то так и есть еще низко приоритетные и нормальный ант и собственно я уже говорил что они отправляют кито статический статические данные до в лебедь и вообще историю поиска мы тоже кого все все все храним вообще всю информацию что только можно гоблин для аналитики она нам нужна и он не имеет состояние и как бы его было квартировать очень просто никакой боли никакой сложности не возникло вот а очередь а чтобы муравьи и пчёла как бы имели какой-то зверь связующее звено и работали до корректно между собой у нас есть очередь она локальная оно запущено по одному процессу на каждый сервер и работает это достаточно быстро потому что собственно используется был и в качестве бэг-энда л д б немножко скажу почему на тебе у нас означает так сложилось что использовали койотом но в один прекрасный момент получилось так что кто-то просто теряла данные но у нас-то если может не знаете и не знаете какие то очень старый такой сара либо да и там есть стороны ряд проблем и мы как бы столкнулись с тем что не получалось поэтому перевели на тебе у меня например на маке она выполняет 3000 конкурентных запросов на запись и чтение это достаточно быстро как бы это даже покрывает то количество запросов которые у нас проходят собственно что она предлагает это простой api-интерфейс пример чтобы записать мне просто пост что получить год это удобно нам как бы не нужно ни какие-либо мы просто можем использовать стандартный протокол о типе штаба работает в очереди вы просто да и она еще у понтус можете взять называется бурлеск поиграться возможно даже применить своих проектах окей вроде как арчи тур на все работает и не так уж плохо да и вроде как был казалось бы что не так и зачем вообще нам это нужно достаточно долгое время на подъема сервисы разработчика много у нас вся система это несколько компонентов и чтобы все это завести разработчику нужно во-первых поставить пакет и питоновские ну иметь сам питон сыщик конфиге взять да и более того поднять базы тем более а скорее всего разнообразные потому что у нас вся система пишет разные базы уже говорила и это реально неимоверно долго и только его причинила боль еще такая вещь у нас тепло и совершался в течение 2 часов это прям pain очень сильная боль почему два часа спросит а я вот рассказывал про пчел и что у нас несколько да и у нас была такая штука как манит она следит за тем что процесс и работали до и она умеет контролировать их если наедается память или в какого-то предела да на призыв сказать процесс и дело в том что когда этих процессов много на 1 физически ноги манит вообще не справляется тупит он последовательный вот допустим мы за тепло или и нам нужно перезапустить сервер чтобы новый год подхватился что у нас несколько и когда мы перед и запускаем этот сервис манит тупит и может так случится если вдруг не параллельно на все но за тепло или до что вон в одну часть я просто насчет и просто так так так всех положат и мы получим пятисотке для пользоваться как мы это себе позволить не можем вот поэтому это достаточно было болью еще у нас пользовалась чем так сложилось что он вообще лежал в отдельном проекте и ну так так так исторически сложилось что ни один программист не хотел туда залазите что там менять наслоилось очень много кода и это достаточно такая новая технология хотя многие люди до сих пор используют ну тут как бы на вкус все знаете окей как-то собрались подумали что можно с этим делать круто нулю рулетку и давайте за юзаем докер у нас это кстати частая практика мы этим иногда пользуемся все-таки технологии много и пощупать как бы хочется тоже каждый да окей докер так докер но вообще в итоге зачем и что он нам даст во первых это будет единое окружении везде да у нас уже не будет такого как программист написал код локально запустил все круто работает за тепло и а в продакшне и короче не взлетела и почему в окружении разные до продакшна там стоит или на sens кого-нибудь что я разработчикам make no make там работает естественно не центр 6 вот а более того образы можно собирать вообще где угодно на винде там на мать и на линуксе да где угодно собственно и они будут одинаково работать одинаково как бы им еще более того ориентирована dogs 2 теперь как бы не парится грубо говоря а внутренних вещах да они им не обязательно значит что общем внутри то что этим уже апеллирует программистом он решает что ему нужно какие пакеты какие штуки до в системе чтобы все это заработало dogs как вы может посмотреть просто контейнер работает окей работает не работает ну проблему давай чувак разбирать как часто вообще не знаю вас происходили случаи редактирование на продакшене у нас например часто ну да так так бывает собственно почему я рассказал диплом долги да и если что-то там не то пошло а мы теряем деньги если что-то не то пошло до так и хочется зайти на продакшен и ручками там поправить что-то по-быстрому чтобы это заработало но бывает так что вроде как бы сделал вроде все круто да починил а забыл за комитете при следующем диплом 5 развалилась бывает более того докер вот представляете очень крутой простой откат по сути откат это тоже с диплом очень просто очень круто ну в общем как бы решили окей думали думали как вообще нам поступить чтобы систем перевести да и капнули вот в оркестрацию оркестрация такая штука которая собственно зволяет вам автоматизировать все вещи когда у вас много серверов да если у вас много серверов у вас как бы много компьютерных вычислительных мощностей да и чтобы это как бы общей боли чтобы вы не знали где контейнер какой живет оркестрация помогает это автоматизировать но это такая штука достаточно сомнительная ноуте меня не посмотрели есть собственно губернатор rancher из форм я проник немножко просто скажу чтобы было понимание что есть и почему как бы мы решили не использовать купер на это собственно такая ну достаточно сейчас хайповая штука популярная сделанного углом это внушает доверия это как бы несомненно хорошо у более того гугле работает да и но она создана для большого количества хостовый в я боюсь что у нас не настолько много холстов было поэтому это лишний orchid и он очень сложный это нужно время на то чтобы изучить его у него там своя концепция там под да и прочего то есть можете посмотреть почитать поэтому как бы однозначно она отлетела кранчер а это уже не совсем регистрация это такая прям ну круто на самом деле штука эта платформа который позволяет вам помимо регистрации просто управлять всем через удобный веб-интерфейс который позволяет нам создавать контейнеры мигрировать их оперировать ими и чего такого не пожелаете более того он достаточно гибкий и не завязывает воспользовать на свою регистрацию можно использовать там тоже купер на это сдоили с вором свобод такая выбора мне мы она есть он молодой поэтому немножко страшновато было использовать его продакшене потому что как-то еще немножко сыроват и страшно еще есть один вариант который прямо идет в комплекте с джокером он нативный он самый легковесной среди всех свору да и у него прямо реально очень крутая фишка простая примитивная понятная и вроде бы почему вы как бы не использовать его да вот казалось бы вроде подходят вроде можно минимум времени до всеми кодировать но мы искать как вы свою серьезную серебряную пулю сейчас я подробнее расскажу почему так вообще вышло мы хотели прозрачности прозрачная система они как бы простые а простые вещи как бы всегда дешевле поддерживать и проще водить-то много программистов да потому что ну требуется минимум знаний чтобы человек уже начал с этим работать понимать и развивать это как бы очень важно более того не хотелось вообще никак вводить дополнительные технологическую прослойку потому что тоже там купер нету прочие вещи они тянут за собой еще другие зависимости другие библиотеки и там стали зоны хранилище прочие вещи стояла высокая вероятность вернуться вообще назад да у нас расскажу немножко у нас так вышло что попытки перевести счет поисковый движок да а чтобы вы понимали это как бы сердце такой компанией он не работает денег нет ничего не работает это важно и были случае мы как бы переносили в докер да ну не удалось раза 2k попытались этот еще давно-давно года еще докер там не было настолько хобби вам как сейчас это настолько как бы известно мы используем но поэтому шанс все таки такой был возможно как бы в этот раз тоже не вышло и более тот время время время мы хотели добиться максимально выгодного переноса то есть сделать так чтобы пощупать это посмотреть что это как бы работы да если работает и все круто и нам подходит opaque use me to если нет но подкатываем назад и уже думаю там чего сейчас ими дело и стоит понимать что если мы используем эти страстную до в этом плане нам нужно переделать всю архитектуру а это время он у нас как бы более такая достаточно простая архитектура была микро сервисная и ее портировать используем нативных сейчас докера принципе наверное было самое актуальное такое решение которое логично показывалась поэтому выбрали давайте докер просто почему нет что нам нужно сделать всего лишь собрать образ использовать только компост который идет в комплекте чтобы поднять по какому-то конфигурационного файла всю нашу ферму одной ночи до приправить это башен почему ваш потому что ну не знаю башен там ничего ничего просто нужно еще сложно нету почему нет такой образ и все-все-все заведется окей вроде как бы планку и стрэнда нужно двигаться дальше смотрим докер файл нам нужно как было собрать это такая штука которая декларативно собственно описывает как вообще собирается контейнер да у него несколько команд они вообще просты и примитивны например вайран можно использовать для запуска какой-то сжал команды чтобы нам счет выполнить до копья для копирование сходных городов nv ли остановки инварианта и там еще несколько команд которые можно посмотреть документации он очень простой и казалось бы все круто все прям зашибись то и все так вышло даже на docker файл как вы наступили на грабли при попытке его использовать сейчас расскажу почему рут по умолчанию всегда в dockerfile всегда рот и не всегда это как бы может подходить процесс запускается под рутом все файлы копируются под рутом и иногда эта проблема я сейчас расскажу почему это наследуется у натана образа если вам нужно умножить на наследование так чтобы сделать и мощь который наследуется от двух разных образов да и как бы сделать какой-то комбинацию то у вас это не получится такая mittology идеология вообще непосредственно работ докера стоит помнить что у докера вообще слоистая система и каждая команда выделяет отдельный слой то есть тот же ран если вы несколько раз вы скопируете то вы получите много много слоев и это плохо потому что это будет большой размер файла и вообще сложность каширование если вы замените там к слой наверху то у вас броситься весь кэш поэтому по возможности как бы она имеет смысл объединять копия с хвост машины всегда делает рут даже если вы например доки fallen напишите юзера создадите юзеры заюзать его там через юзер там бокс какой-нибудь да и сделайте копию но они все равно будут трудовые поэтому как бы нужно не изменили не забывать изменять права файлов которые копируете и не забываем копию ставить общее в конце вообще славе докер файлов потому что если вы поставите не в конце таких файла вас будет постоянно сбрасываться кое-что скажу просто не будет работать до темный и образ будет всегда собираться сто процентов времени как он изначально забирается вот и говорю root root root root почему а чиррут плохо и что такое еще контейнеры рут немножко они сейчас расскажу по сути рут контейнере это тот же root на хост машине он конечно с ограничением но это тот же рут все потому что как а был в контейнер и руда и процесса труда соответственно все файлы создаются тоже из-под рута на это очевидно а некоторые процессы могут не встать из-под рута примеру позади там насколько я знаю есть защита и они не пускают если рута пользу требует юзера как бы ну чтобы такие процессы до запустить нужно как бы workaround и создавать красному озеру поэтому мы подумали решили давайте не будем париться и будем использовать как бы но наруто везде для консистентной окей я вот говорил что root в контейнере не совсем рут kona hoss машине да и он имеет ряд ограничений и процесс который запускается докером имеют тоже ряд ограничений linux capabilities это такая штука которая говорит что вот этот процесс имеет таких ряд допущений может делать только это и докеры по молчания вот столько ставит допущение это достаточно много да и не каждый как бы код не каждый процесс не каждый вообще на наш сервер который мы запускаем требует всего этого то есть можно как бы убивать процесса да там изменять права читать там из пакистана прямой на порт вверх и не всегда это нужно самом деле поэтому мы подумали что нужно добавить немножко безопасности это сделать в принципе достаточно просто нужно помнить что есть такие команды как аргументы как cup это как дроп который можно использовать при создании контейнер на этапе билда до и вообще best practice было бы конечно изначально сделать кап 2 пол вообще все запрещаете все допущения и не посредством через копыт добавлять то что только нужно вашему процессу вашему коду которой вы как бы делаете и никогда не используют приве лежит в принципе это как бы не очень хорошая практика потому что в этом случае у вас врут в контейнере будет слишком рут а почему то что умолчанию докер ограничивает доступ ко всем девайсом на хвост машине а если вы запускаете предложит например то доступ ру контейнер получает вообще доступ ко всем девайсом на хвост машине он может с этим делать что угодно иногда как вы без этого никогда но я бы рекомендовал все-таки искать какие-то обходные пути чтобы это как бы порешать окей я вот говорил у нас есть пчелы да и у них есть состояние как вообще с этим делать как импортировать в непосредственно контейнеры что можно использовать все просто когда у нас нет состояния нет состояния как бы ничего сложного не то чтобы запихать контейнер до но тем ни менее средств есть состояние нам нужно это сохранить есть несколько способов самый простой способ это просто использовать какие-то общие папки да я про не сейчас расскажу но этот способ работает если у вас как бы работает процесс на одной машине если у вас на нескольких машин этот способ уже не сильно подходит поэтому более сложный способ по этой спали какой-то цены зовут централизованное хранилище распределенная до которую жизнь из коробки умеет масштабироваться более того она отказывала почти случаев например там и т.д. консул даже окей мы так подумали подумали зачем вообще нам это нужно у нас исторически сложилась хорошая схема обновления состояния и мы как бы использовали свой комп и мы у нас есть мастернода на которых хранятся все конверсионные файлы и на этой мастерноде как бы а не редактируются на другие ноты доставка произошли происходит простым образом простой пирсинг и если у нас мастернода падает ну мы просто теряем обновление конфигов ином принципе это не критично поэтому для нас это работало а если работает до золотой про правила и как работает лучше не трогай потому что зачем себе проблем создавать логично правильно я вот говорил про общие папки вообще что есть и как их как ими пользоваться общие папки могут быть просто на вкус машине в этом случае если у вас есть какой-то вас машине вы можете просто взять и пробросить и внутри контейнеры она будет как бы на разных контейнерах до 1 этажей вы можете получать доступ не более того можно создавать так называемые даты контейнеры или просто создавать папочку ассистенты внутри контейнера просто используем волю до ключевое слово и пишем путь в этом случае даже если у контейнер удалите если вот он и создадите чего годности вы делаете полем будет всегда это нужно помнить как бы его нужно удалять вручную потому что и даже если вы утолить вообще контейнеру все равно останется на disqus ok вроде все это круто круто но есть определенная проблема вот мы уже подготовили систему да у нас есть там stating за тепло или и вроде как бы все круто работает да но обнаружилось то что почему-то файлы в про брошенной скос машиной папочки имеет какого-то другого юзера почему я уже сказал что у нас какой процесс запущен из плотного наруто да и мы создаем юзера внутри контейнера внутри образа используемого оказалось что на хвост машине юзер из-под которого работал докер был создан не первым имел там индикатор 501 да допустим если у нас как бы на bundys 500 и начинаются то у нас был 501 а в контейнере когда мы создали юзера он был 500 естественно когда контейнер запущена испытает процесса 500 дома как бы запущен то все равно процесс на холст машине он писал файлы своего 500 юзера и smooth-cast машина как бы ты ни мало как бы это особо поправить удалить там файлик licet с ним делать да вот как мы это у себя решили очень просто мы использовали аргумент сам начале файла и вот таким образом как вы делали на этапе билда му получении его берем просто юзера с которой запущен docker на автомашине пробрасываем качестве аргумента и как бы все ну и в контейнер и создаем юзера с передачи конкретного вида что нужно знать данные данный степман да он кэшируется по значению поэтому как бы если вы надумаете использовать аргументы используйте их с умом если значение будет часто меняться у вас просто будет постоянно кэш сбрасывался аргументы обычно нужны для объявления в начале такие файлы и вы собственно получается что не очень так а дальше мы капнули оказалось что как бы есть еще способ который решает проблему записи ну и он еще решает другие вещи а и называется юзер namespaces он появился совсем недавно в последней версии где-то 110 когда мы выкатывали мы выкопали немножко старую версию докера он позволяет нам делать так что root внутри контейнера будет не совсем рут как бы мотаться не совсем руда на хвост машине и в результате этого при когда мы пишем из-под рута файлик жареный да у нас как было справа и не будет коллизия но к сожалению молчание отключен не знаю почему но так устроено и его включить достаточно просто мы используем юзер ns 3 map запуске демона и как бы можно посмотреть подробнее в документации вы просто знаете если вас проблемы записью да можно капнуть в эту сторону и не париться томсон рут юзерами доброты как бы настроить его и все будет круто работать проблем никаких не возник вроде разобрались со всем прочим самое интересное от прошлого сети что нам выбрать чтобы нам подошла общем есть много сетей добрич хост overlay макмиллан еще есть есть еще крутая сеть но замечательная идеальная носить которая может быть и я хочу рассказать немножко подробнее о них собственно по умолчанию у такера стоит на тверк мод breach но это нифига не мозг это больше над так уж получилось что она дает он дает как бы отдельный локальный ip-адрес внутри какой-то подсети до который докер создает и позволяет изолировать порт внутри контейнера спортом пласт машина то есть у нас никаких калязине будет но казалось бы вроде неплохо да все но расскажу такую историю как то вот раз и так три часа ночи возможно у нас готовые машинки продуктовые нам прямо очень хочется выкатить все этого посмотреть что это за велось это работает до выкатываем все завелось все работает и тут мне же не админ пишет давай попробуем reboot нём машинку и посмотрим что завелось ну reboot нули и завелось но не проходит буквально минут и как опять-таки мне же не наш админ пишет что за фигня чем выше где мои правила впт куда они пропали вообще все потерлись те правила которые были кастомные у нашего обмена записано но естественно как бы бреши он как сказал же надо надо и он правит iptables и с этим кого ничего не сделать можно конечно отключите patterns на этапе запуска но в этом случае как бы вам придется равно запариться с тем чтобы пакеты как-то доставлялись так до контейнера поэтому этот режим на вообще никак не подошел и стали думать вообще выбрать еще замечательный от режим пост он очень простой тем что просто берет сеть машины до физической и пробрасываем как есть внутри контейнера но со своими результатами возможно коллизия портов у нас так устроена что у нас пчелы до запущена были на разных портах изначально и когда мы мигрировали изначально с хост breach мы делали один порт и просто его на рандомный port calls машины выкидывали так вот перевале но пришлось как у переделать это потому что опять таки вернусь к тому что у нас вроде контейнер есть до изоляция есть но используем хост как режим сети и получается так что с портами нужно очень-очень аккуратно работать ну естественно свобода и потребовав от вмешательства тем больше он туда не лезет решили подумали давай выберем это режим ученым париться ok еще расскажу немножко другие же мы по-быстрому а есть overlay это мульти класс сеть которую можно построить можно построить из коробки через форма до или можно там построить вручную использовал какое-то централизованное хранилище да и она будет ничего но по открытым источникам которые нашел она немножко сыроват еще пока что сам я не бей чудо но есть такая информация поэтому стоит очень внимательно относиться к этому есть чего такая интересная штука как мимо крилан вот она достойна как бы внимание и она свежачок появилась совсем недавно с 112 докера который сейчас прям активный и требует поддержки я dirty свежих не все могут позволить свежие ядра но тем ни менее что он делает это сеть позволяет создать одну сеть на один физический сетевой интерфейс машины и каждый контейнер получает свой mac адресом и пакеты они идут мину и вообще iptables и всего прочего напрямую в контейнер потому что тот виртуально терпеть который при отдаче на тактической карте ядро разруливает весь приходящий пакет прямо по сетевую карточку на вот виртуальный тур фейс и мы можем вообще назначать отдельные и выносить контейнер вообще во внешку более того прямой доступ между контейнерами да у нас имеется menace gateway это очень быстро и еще такое минус у в этой штуке но в принципе не так актуален из контейнера нельзя получить доступ к фишке хост машине то есть на которые запущены всех штука потому что сеть изолированное совсем вот детей много но есть ещё такая сеть но вообще крутой выбор если у вас не нужно сесть но таких конечно кейсов очень мало но если у вас в контейнер занимается только вычислительный какой-то штукой да почему нет использовать его не по лицу проблем никаких точно не возникнут просто вырубаем сети все программисты пишут код этот код далеко не всегда идеален и он может навредить как было соседнем процессом до которые запущены на этаже физически машинки поэтому я бы рекомендовал ограничивать все что только можно для контейнера как бы с целью просто стабильности у докера очень много опции которые позволяют сделать можно ограничить цикл можно все взять контейнер до повесить там на первое ядро и ты другу использую только перед r 1 ядро до нашего и физическом машинки ничего другого например так или ограничить просто процессором времени можно ограничить по памяти это вообще самое вообще больная тема потому что обычно мы мерили к достаточно популярная штука и у нас тоже в этом случае если вы ограничите папа memory да просто придет он киллер и убьет девяточка и процесс если он превысит да иногда это как бы не очень хорошо поэтому есть свои work раунды мы например сделали слежение в челах до в своей памяти внутри процесса периодически натеки dat ар надо просто запускается там какая-то функция которую смотрят сколько памяти жилье текущий процесс и если как бы он живет мы делаем ставки обычные и в течение шести секунд пчела как бы умирают до плавненько не прерывая коннект это очень важно то что если он прирос переростка netconnect мы потеряем как у пользователя потеряем как бы деньги но есть еще softly мин который тоже может использоваться подробнее можете посмотреть еще документации память закончилась и начинает свои дать swap его слаб мы тоже можем ограничить и ну режим активность использовав тоже ограничивается так что более того если ваш контейнер использовать очень много столь же его тоже имеет смысл как-то ограничивать чтобы он не навредил его соседям и на самом деле вау такер очень много других есть ограничители можно посмотреть документации по изучать и для каждого конкретного случая до выбрать то что именно нужно вам окей вроде как бы разобрались граблями которые наступили и возникает вопрос как мы вообще это все объединили как соединили все вместе как это заработало что конкретно такого сделали мы генерируем динамический докер композ прадо кирком после я сказал ради но еще скажу это такая штука которая просто по control зону файлу до поднимает на 1 физически нодди все что вы там написали то есть пачку контейнеров там сколько вам нужно писать он все это поднимает автоматически просто пишет он покер кампуса и все работает магия этот докер компост который у нас динамический генерируется по шаблонам шаблон это факту описание одного контейнера одной сущности сущность это пчела почему нас несколько так что понимали и множим собственные эти контейнеры через генератор конфига выглядит тот примерно так то есть есть на скалу который принимает название и количество сколько будет осознанно и он просто берет шаблончик и множество на несколько раз для чего это нужно именно для масштабирования потому что если например а понты не справляется с билетами которым приходят и не успевает навредишь дано нужно их увеличить если принципе они справляются можно уменьшить уменьшить ресурсу дома скопилось но тем не менее мы как бы сделали так возможно немножко велосипеда но тем не менее для нас это работы как мы же планируем по сути я уже сказал шаблон это секция в докер компост просто выделяем секцию сбора контейнера в отдельный шаблончик я мода и используем там такие заменяемые значения которые суд подставляются краски генератором скала котором я рассказывал и просто переменное окружение и все это короче лежит в инвиз h для удобства если нужно что-то поменять мы просто заходим в один файлик с константами да и там меняем и все как бы все понятно прозрачно в одном месте и собираем просто чистым вашим барбаш баш на баш просто наши все я люблю башни на я как бы вот например а вот так выглядит шаблон муравьям это секция докер композ у неё есть секунд это номер контейнера как раз таки он поставляется например когда генерируем 5 муравьи вода там будет ноль один два три четыре он просто ставится и переменные окружения до можем смотреть от как бы реально вот шаблон который у нас есть и собственно для выполнения условия гибкости чтобы это можно было менять да и на каждых окружениях запускать по-разному разные порты и разные штуки да мы используем вот такой метод ваш текст вершин просто если не передано переменное окружение мы делаем и дефолтные значения но поэтому как бы можем просто передать это переменное окружение и уже будет сборка совсем другая можно посмотреть и увидеть что мы еще используем грибы и такая штука которая позволяет фильтровать ряд однотипных контейнеров да просто используем фильтр и указываем лейбл роланд и получаем все хантов сколько на запущена потому что их может быть не один а несколько окей с этим как бы разобрались как вообще происходит на одну ноту что мы для этого делаем все очень просто и тривиально куда можно проще просто заходим по ssh запускаем гибче caught на ноги да далее генерируем докер композ ямал файлик который представляет уже то что будет на этом ноги запущена вся наша ферма для текущей но до собираемся образом делаем докер билду горя и запускаем докер компост об но с игнорированием билдом возникает вопрос на фига вы так возвращаетесь зачем мы это сделали дело в том что докер хоть кэшируются но когда у тебя несколько таких файлов и при сборке ты там собираешь ну 5 там 10 до образов разных то он все равно не так быстро работает поэтому мы сделали каширование своем мы просто собираем образы а ты куда если этот образ есть он собирается если его нет он как бы вообще ничего не делает там за миллисекунды все заканчивается и поднимаем других компасов мы уже уверены что мы сбил деле все образы которые у нас были и как все окей если у тебя несколько серверов как вообще вот этим управлять начиная на сложно вручную там каждый сервер для диплом мы подумали и решили что то почему нет давайте сделаем как бы отдельный файлик консультационные в которой вынесем окружении сервера что у нас есть и что вообще там собирается выглядит он вот так вот этот пример как бы в компе русалок файл который используется у нас есть список серверов у этих список серверов есть как бы свое окружение production тот дальше мастер это окружение а внизу опять таки по такой же схеме примитивный просто плоский м м файл мы описываем каждое окружении что в этом окружении какой набор сервис его нужно поднять до чтобы в этом окружении все работало что нам нужно очень просто очень как бы примитивно куда еще проще окей выходка на ферму нас происходит опять примитивным образом не знаю что тут может сложно быть мы берем этот файлик который показывал выбираем нужное окружении если диплом на продакшен до выбираем сервера которые собственно нам нужны дальше на каждом из этих серверов запускаем тот теплый скриптик на одну ногу и все это делаем параллельно опять таки с использованием ваш ждем завершения и вышло как бы вышел тепло или нет если все процессы завершились все окей кашлем флаг так происходит все окей что у нас вообще вышло и как вообще сколько вы потратили времени что вообще получили с этого всего примерно написание систему на где-то 150 человек часов это где-то может неделя принципе не так много я думаю на полную миграцию 150 человек часов почему именно столько возможно это много покажется да но на самом деле стоит понимать это рабочий стен право на ошибки нет и мы выкатывали когда мигрировали да со старой площадки на новый уже в дочери мы очень аккуратно и делали мы запускали отдельно вообще цепочку поисковую уделили трафик очень аккуратно чтобы это потихоньку работала и еще приходилось много делать работы чтобы как бы допилить это до конца до финального завершения чтобы все было четко и когда мы переключили все весь трафик мы были уверен что мы не потеряем деньги на этом потому что это сердце вообще компания это очень важно всего вышло где-то 500 строк вашего это не так много до несколько файл которым как бы artistry рует вот это все штук и позволяют нам по ролям тепло и цена все наши сервера и генерирует конфиге да и все остальное сделали масштабирование в одном месте вот кластер ямал достаточно простой нам нужно просто найти там увеличить какие-то цифры да и все получить уже в этом окружении больше количество контейнеров которые нужны для работы и автоматизирован это в окружении новым программиста все что нужно это поставить докер себя на машинку сделать сервисов и все работать то есть это очень быстро не нужно как бы геморрое ца с поднятием нам конфликтами пакетов дал снова к нам питоном пакетов конфигов короче всего я заскочу сервисы разных конфликтом отдельные их много компонентов для сравнения что было все что стало изначально у нас было восемь мощных серверов стало сейчас 24 дешевой машинки по деньгам и тут вообще ничего не выиграли принципе но выиграли по гибкости потому что если вдруг у нас вылетает одна мощная машин когда мы теряем достаточно большой пласт такой вычислительной мощности если же вылетает она дешевая машинку ну это как бы вообще просто ни тепло ни холодно был chef манит centos 6 достаточно старый на старом ядре да сейчас как бы ubuntu 16 44 докер но скажу так что контейнером и когда запускаем из-под центра со всеми то есть у нас образом этот используется два часа более никто не хотел теплица сейчас прям тянуться все дипломе то что параллельной проходит за 10 минут он ничего не ломает на как бы уверена что все будет о'кей более того свобода девелопером да они теперь просто управляют ходом управляют пакетами которые нужны настраивают как бы как угодно и мне нужно дергать там админов друг поставив пакет мне там нужно чтобы мой класс заработал да вот и это на самом деле реально круто более того у нас был ручной такой сказал процессов тепло и долгие и а есть вариант зайти в проект deployment настроить там конфиг для монета чтобы запустилась больше процессов и просидит два часа лагало чтобы этот свет сзади плелась сейчас же у нас один файлик тепло 10 минут дам просто заходим меняем и и все уходит production вот на этом наверно у меня все я хочу сказать что надеюсь мой рассказ поможет вам выбрать правильные тузы для работы своих проектов и принципе покажи шторки странство не обязательно используют можно и как бы свои решение главное под находить свои решения в своем конкретном кизи решать его а не обходить все всем спасибо вопрос или без как вы добились того что до часто скажу немножко подробнее то есть у нас есть одна но да и там запущено несколько пчел на разных портах естественно как в х прокси он определяет какую пчелу использует и когда мы делаемся мы в building непосредственно имидже и передаем пчелы перестаем мы их последовательно да мы их не сразу именно поэтому 10 минут на факт по факту deploy происходит там меньше двух мер но чтобы запустить у нас количество ваш нас пчел да на аноде нужно время мы просто по 2 убиваем пересадим сном контейнером убиваем плавненько и с новым контейнер вот так вот последовательно своеобразно как но она работает и он решает наш проблемам почему нет спасибо бы интересно скажи пожалуйста я правильно понял что вот в эту шубу не за цию докер компост сделали только для того чтобы sequins вот секрет сделать уже все остальное там переменное окружение которое так из blink dagger компания даже да да вы правы как можно как бы было и отдельно да и просто и но нам нужны были генерируемые значения например генерируемые порты помимо секунд сюда который показывал есть еще пчел порты которые в случае использования хост мода да нам тоже пришлось генерировать поэтому окей мы вынесли это так в такой вот вариант чтобы реализовать это может быть данным как получилось так это вроде просто все-таки с шаблонами достаточно просто работать тем более когда у тебя небольшой там других компоста выделены отдельные сущности в отдельный файлик и они небольшие там 30 строк кода открываешь и в одном экране правишь удобно такой я вас не вижу ни сторонний не смотрели вот спасибо скорее всего посмотрим это вообще интересно то же самое но они более как бы уже старый и устоявшиеся как да смотрите его как отвечу я рассказывал до что у нас было ограничение по времени и возможно как бы в вероятность откатиться назад поэтому мы оставили в ту туру она достаточно неплохая микро сервисная разделенная до оставили как есть просто пихали в докер но следующий шаг скорее всего сейчас как бы это все работает все круто да мы будем думать как это автоматизировать и масштабировать более простыми способами то есть уже над какой-то регистрация а вот следующая операция и тут как раз таки скорее все будем копать уже дальше что вообще есть понятный получается вы сейчас бил детей имидже непосредственно production сервере то есть перед запуском до отличный вопрос мы делать им час мы не используем репозитория никакие мы просто делим на конкретный текущей моде имидже и все понятно но это получать здесь опасно которая то что признаками то есть опасность есть опасность что это будет не совсем консистентной ну как бы у нас проблем с этим не было и обычно тепло и происходит параллельно да и как бы все собирается окей если мы текущую ноду как бы не за тепло или но ничего критичного не станет потому что там хоть работает старый кот но он работает и отдает все что нужно то что какое ослом и очень мало чего правильно непосредственно в коде такого что меня это ритуальное поведение да какое то мы добавляем сайтов-партнеров взаимодействия с гетами которые дают нам билеты и если мы добавим там gate за тепло им она какой-то надеюсь он не появится ну и что просто не сильно критично и третий вопрос в качестве стороны что вы используете да хорошо вопрос изначально были fs но потом смотрели посмотрели обновили ядро linux до поставили ubuntu 16 лeт с 4 4 да и переключили номер ли как бы вроде с алкоголем позволяет 1 ни с какими проблемами столкнулись пока что нет но не исключено что они меня зажало спасибо спасибо здравствуй спасибо за доклад здесь вот так так так а он скажите пожалуйста что для сервис discovery используете это вот собственный сервис мастернода с конфигами что именно утверждаете под все дисковой vodka саке х практиках формируете а конфиге к прокси да у нас есть шаблончики генерируем да и раздробленной как бы при генерации мы знаем сколько мы сервисов на день и реле и генерируем шаблон для х прокси с этими сервисами с разными портами то есть так как мы используем хост просто создается в конфе где используется локалхост и порт и все это инка ментально и второй вопрос как много боли больше риторический вопрос с затягиванием лимитов то есть я максимально все лимитировано и да мы собираемся нужно как бы это классный подход но насколько он у вас заняло времени много вот по имплементации ну я скажу так что в основном мы как бы имитируем память своп и в принципе на этом пока что все почему потому что пчёлы у нас в мире ликами да и память вы и доится поэтому без этого никак если вдруг он на всю память вас внезапно то другие контейнеры буду страдать своп ну так у нас как бы использую accounting свопа да я как бы не сильно могу рассказать про это этот скажу так что наш обмен на настраивать сервера таким образом что с особым какую проблему никаких быть не может и в этом плане как бы ну а системами вот этими вот вещами которые горели там дро пол и потом это да мы вообще везде дропал делаем и смотрим у только то что непосредственно нужно для запуска этого процесса этого кода чтобы он работал и но если чего-то не хватает дам добавляем как бы capability эту нужную спасибо за вопрос добрый день они fanta приятно знать что покупал билет через докер на самом деле такой вопрос брунель capabilities и про своп насколько я знаю когда памяти чет-то память заполняется и потом все это уходит своп не было ли у вас такой проблемой как вы решили потому что всем случае у нас 12 слитно продаж не в одиннадцатом пишется что пока это не поддерживается links был такой указывается на случай вообще правда на стайлинге когда мы запустили там рыбе для использования в качестве очереди пред проверяли даже он работает он короче провисел какое-то время и получилось так что он выступил там на двадцатку гигов он всю память занял и выкупился но почему это не происходит очень продакшне потому что у нас ход машина тоже настроена своеобразным образом за этим следит как и следит как бы наш админ сказал поподробнее боюсь я не смогу сказать да он он ходьба а тюнин так чтобы он не выдался потому что это реально проблема вот что вы сказали мы это решим это решаемо сима спасибо здравствуйте брат спросил с доклад очень полезно для пару вопросов один не имеет нашей на самом деле к доктору вы упомянули о том что вы используете консул дыхание настроек нет мы используем просто файлики могу сказать подробнее как происходит мне был интересен вопрос вот как автоматически происходит обновление настроек пчел без их перезапуска есть у вас такой функционал да смотрите у пчелы это по сути сервер который представляет какую-то фишку да и есть отдельная фишка которая принимает конфиг она может как бы setconfig делать или год конфиг и как происходит доставка на мастерноде лежат конфиге они правят этому веб-интерфейсе до который там же запущен и обновляются на других нотах пирсинг забирает с этой ноты конфиги и когда они обновились с помощью айна тихая watcher до сервис который следит за этим видит что у тот конфиг обновился он просто его читает это что он прочел закидывает вопит всех пчел на этой ноте это происходит как бы одновременно на всех и без какого-то в downtime прямо фронтами обновляется то есть конфиг приходит через какое-то дтп запрос каждый пчеле правильно да верно и получается что у вас в докере одна пчела на каждом порту да то есть по одному worker условно запущена да на каждой ноги у нас допустим там 16 чел и этих нас пчел они слушают совсем разный порт они один образ наследует но непосредственно как бы разные порты следует один тот же код понял спасибо спасибо за вопрос все всем спасибо"
}