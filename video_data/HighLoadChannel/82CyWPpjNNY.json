{
  "video_id": "82CyWPpjNNY",
  "channel": "HighLoadChannel",
  "title": "Почему надо создавать модули для NGINX? / Василий Сошников (Mail.Ru)",
  "views": 1675,
  "duration": 2947,
  "published": "2020-04-27T12:07:36-07:00",
  "text": "большое спасибо клад на самом деле интересная история что этот доклад он с 2016 года в том или ином виде существует и постоянно модернизируется вот и его последняя реинкарнация было красный engine xcom 2018 года где мы с дмитрием выступали друг за другом примерно в схожем формате и дополнили друг друга и здесь что удивительно сейчас получится тоже история вначале немножечко содержание о чем я сегодня буду рассказывать первые зачем иногда все таки приходится писать на сипадан жена и какие задачи это решает зачем далее мы немножко погрузимся в детали как engine.exe выглядит внутри это важно знать не только тем кто разрабатывает план дженкс но и также тем кто использует а дженесс конфиге lua или какой-нибудь другой язык внутри яндекс а третья часть будет про анатомию именно эти типы модули внутри engine x а потому что engine x от t не только из себе и модуль вон же миксер и engine x имеет модуль речке которым вы все пользуйтесь и я в частности далее мы множечко поговорим о том что если представляетесь и модули для индекса ну и закончим наш рассказ о engine их слова м джей си я успел в этом году попробовать и джесси у меня сложилось свое впечатление о том что это для чего это нужно и что в нем главное не хватает ну что ж приступим с описание кейсов и задач зачем же это необходимо делать зачем нам нужны модули будет немножечко тезисно первое вы все представляете не жалеть конфигурацию думаю представляете и каждое директива там это модуль отдельный модуль который был заботливо написан коллегами из комьюнити джон икса который вы используете поэтому в engine.exe модуль и все то есть любая директивы это хедер прокси пас это модули бы даже комбинация модулей которые работают по определенным правилам далее следующий тезис engine x это framework представьте что это огромный огромный пласт низкого уровня библиотек на который вы можете сделать все что угодно не только для работа с сети но и для работы с диском для работ с кем-то системными историями то есть жены каст огромной фреймворк и вот правильно дима заметил чтобы писать подземных надо знать половину engine.exe много системных вещей вот ну что самое главное надо всегда помнить о том что яндекс быстрей стабильной но сложные другими словами вы должны писать код такой чтобы engine x не стал медленным и не стал нестабильным потому что нестабильный джилекс на проводе это означает что ваши клиенты будут недовольны наш они будут получать много много 500 ок вот ну и ножечка кейсах основной кейс который но часто применяют что обрезают и часто мотивирует создавать тот или иной модуль это преобразование эти типы протоколов некий другой протокол хороший пример как ни странно это всякие рейде спас memcache пас я не знаю правда имели ли возможность это использовать но это модуль который преобразовывает htp в какой-то другой протокол и вы можете работать с другими внешними системами вот на самом деле прокси пас это тоже в каком ты какой-то степени это пор так это нечто что позволяет преобразовать правда which is each типе вич тебе еще хороший пример это фесте j'ai pas в общем это все директивы в виду пойти на такой тобакэт где не ищите теперь вот очень хороший кейс еще есть который ну в частности существуют mail.ru и много где ещё это динамическая врезка контента представьте что у вас есть какой-то backend он может быть даже не ваша я не знаю какой угодно и вам необходимо как-то модифицировать контент который из него приходят ну например борьба с блокером который анализирует я не знаю код вашей вставки рекламы вам надо никому подстроить тем или иным образом другая другая скажем так вещь которая часто приходится делать для врезки контента это когда вам вас есть проблема с кэшированием achiless а когда у вас параметры кэшируются und ich & ich и леса и просто два пользователя мог получить одну и ту же сессию 0 и одни и те же параметры которым нужны и оттуда происходит вырезка некоторых параметров либо наоборот их добавление когда вам надо трогать что-то вот 3 кейс он наверно тоже очень популярный по моей практике это сборка клик стрима с интернета с мобила как-то счетчиков там не знаю как многих компанию чаще всего это делать на яндекс хрень и наикса слогах а чуть более скажем так интеллектуально вот ну и да и преобразование разного рода контента например все знают артем пи модуль для яндекс который позволяет не только создавать и работать но и сыч сам вот этот модуль в частности может очень много чего делать с файлами которые хранят но которые по сути являются видеоконтентом вот продолжим как заметил зимы и это тоже подтвержу очень хороший кейс топике товой то есть представьте когда у вас есть engine и скачать их структура которая умеет делать авторизацию которая умеет собирать какие-то метрики который умеет в мониторинг посылать данные клик stream то есть некое культурные штука которая вам позволяет иметь единую точку входа для ваших брендов но она не как единая точка отказа просто это единый in структурный элемент вот обогащение запросов для их последующей трассировки сейчас современные системы сегодня они очень сложные у вас помимо у вас как правило не один backend там сзади а целая куча брендов и иногда это очень сложно де бо жить вот есть такая методик которую ночевками крупные компании принимай применяться недолго гоняют запросы определенными скажем так кусочками данных так что пользователь не увидел допустим чтобы потом просто проследить путь запрос внутри системы я это назвал трассировкой вроде это так многие называют это понятно ну и вот крис который по крайней мере в этом году я много где увидел это ис-3 прокси то есть сейчас почему-то все любят работать со своими объектами через s3 но все эти вещи можно сделать не обязательно носи модулях потому что выдвинуть и в принципе достаточно в том или ином виде инфраструктуры чтобы это сделать ну допустим можно использовать lua объективное решение некоторых из этих задач для ис-3 можно примерно ngc кое-что сделать тоже без проблем у однако все-таки бывает задача по как ты бывает необходимость писать их иногда носи и когда это надо делать здесь на самом деле два критерия пытался их вывести первое когда вы хотите что-то закон трибетить в open source когда вы поняли что то что вы делаете она нужна еще кому то тогда вы делать какой-то обобщенные функционал во главу всего open source и позволяйте другим скажем так и людям этим пользоваться вот 2 кассеты решение конкретный бизнес-задачи тут все понятно приходит бизнес говорит мы хотим вот это вот это вот так вот так и вы начинаете думать на чем это можно сделать и понимаете что допустим это можно сделать только на engine.exe написав свой модуль вот хороший пример это динамическая резко изменения контента и сборка экстрима это сделать на lua можно но это скорее всего работать нормально не будет особенно в резко контента это в частности связано с ограничений милого о них я скажу чуть дальше вот и плавненько мы переходим уже к деталям а именно к архитектуре engine икса у меня и джины всегда ассоциируется с какой-то матрешкой честно я на нем пишу уже насыщена давно кот у меня уже как минимум 9 модулей написанных мной они не крутится в продаж и зачем давно как минимум один из этих модулей open source он крутится много у кого в продакшене и как бы есть опыт и понимание вот мне эндинг остается с матрешкой что там все построено на до некой корой что такое cara cara по сути это обертки над и полом все же значит такой и пол кто не знает принципе может потом задавать вопрос украдкой непал та штука который позволяет работать асинхронно с файлами district дескриптора me то есть по сути с сокетами или с любыми файлом дискретным же дескриптор от не обязательно саги лот и над этой корой была выстроена up stream и htp скриптинг поскреб тиком я сейчас подразумеваем джон xcode фонем же с точным же с этим ножка сбоку вот а поверх и степей об стримов и скриптов вот этих the sims 2 компа уже выстроены модули эти степи модули о которых мы будем говорить вот хороший пример я прям здесь директивы написал масла и действие можно заметить что вот классический пример из степей об стримов это up stream и серверу директиву внутри конфига конкретный пример уже модулей для их степи это это хедер который вы наверное все использовали в ужин x конфиге вот но а скриптинг это уже сам файл конфига в котором что то есть который как-то интерпретируется и что-то позволяет ну соответственно сделать вам именно как там администратору и бы вашему пользователю вот это если коротко об архитектуре engine x а теперь приходим именно к на тайме комок на тайме уже и именно из степи модулей только этих то есть мы не будем рассматривать кору и мы очень кратко рассмотрим апстримом потому что up stream и это целая отдельная вселенная внутри engine x это ты 10 докладов не хватит чтобы об этом рассказать самое главное правило которым стоит помнить даже если вы не пишете код носи внутри engine.exe но его используйте в engine.exe все подчиняется одному и тому же пантер ну chain of responsibility как на русский перевести это правильно я не знаю но логика в следующем у вас есть request это request проходит через какую-то в плеяду настроенных модулей начиная там от локэйшн а еще чего-то этот каждый из этих модулей возвращает к это результат и если результат плохой то соответственно эта цепочка прерывается это надо помнить потому что элементарно разрабатывая моду либо используя какую-то директиву пишу и или писать если вы пишете код на инже село должны помнить что ваш код может обрушить выполнение вот этой цепочке это надо помнить всегда и вот очень хорошая аналогия chain of responsibility написанная на баше все же знают ваш то есть все достаточно просто представьте что у вас падает посередине и w кей если он падает с той или иной причине у вас сорт и последующие команды не будут выполнены продаван женись на самом деле это можно обойти можно всегда там условно запустить даже в случае если какие-то проблемы были ваш код но вы должны быть к этому готовы и модули которые вы используете после синевы использую в конфиге используешь быть тоже к этому готовы а не факт что они готовы какие есть типы и степи модулей в engine.exe во первых есть обработки false то есть что такое части пит индекс эти секреты куча разных фаз о них я чуть детальнее потом расскажу это фильтр и второй тип модулей это фильтрации либо хидиров либо тело запроса следующий тип модули это прокси типичный прокси модуль это прокси пас фасе j'ai pas memcache от вас от это типичная прокси еще самый наверное нераскрученный тип модулей потому что там действительно как-то мало кто то чет разработать дотла это балансировки нагрузки модули для про для определенной балансировки нагрузки очень хороший пример акита махеш модуль который позволяет делать немножечко скажем так консистентных ашером 3 engine.exe чтобы распределять запросы на бэг-энде вот что такое теперь мы потихонечку будем я потихонечку расскажу вам о том что каждый из этих типов означает и зачем он нужен вот фазовые хендлеры что это такое представьте что у вас есть несколько фаз начиная от фазы доступа то есть когда у вас только произошел коннект к вам пришел ну ка engine x пришел какой-то запрос и вы можете там что-то проверит например проверить авторизированный пользователь можно ли ему выполнять можно ли для него выполнить все дальше или нет это например вы фаза x будет работать вот и таких модулей в этой фазе может быть бесконечное множество то есть каждый ваш модуль это такая вот ячейка вот в этой цепочке вот и последний последний завершающий хендлер такой будет это контент фаза когда уже происходит выдача контента по запросу вот эти коротко вот эта картина как раз ты изображает то есть путь всегда такой запрос прошли цепочку xs тендеров тут ещё много чего есть об этом чуть позже и на выходе получили какой-то контент вот это я приезжал из исходников engine икса это те фаза которые доступны разработчика модулей их можно как-то перед контакт перезаписать добавить туда свой собственный обработчик конечно каждый из них рассказывать очень долго и возможно не все они в реальной жизни нужны если вы не разработчикам именно engine x core но тем ни менее расскажу о самых основных которые соответственно я по крайней мере использовал самые основная фаза и самое нужное и the excess fat особенно если вы хотите добавить и ужин x какую-то свою авторизацию то есть там можно проверить может ли человек вообще это запрос исполненный человек пардона запрос может ли он вообще быть исполнен именно с точки зрения там доступов если нет но на просто как-то либо вы уж какие то действия делать далее очень важная фраза которую я перед часто эксплуатирует а при контент фаз и как фаза контента зачем я их часто эксплуатирую при контент фэйс позволяет скажем так какие метрики собирать о контенте который вот-вот отправиться туда то есть как респон клиенту а контент фаиз позволяет генерировать свой собственный уникальный контент на основе чего-то я не знаю первый можно там send file сделать если это нужно ну и последняя фаза которую я очень часто использую но который имеет тысячи ограничения них надо всегда помнить это фаза логирование например в ней работает xs лоб директива именно фаза логирование и у них дичайшие ограничение которое меня сводят с ума и и ограничения номер один вы не можете там использовать sabre квесты игры чей номер два вы вообще там не можете использовать никакие request и у вас уже свершился факт того что контент ушел пользователю уже все хендлеры постах пост хендлеры какие-либо sabre квестами исполнены не будут почему это напрягает объясню допустим когда вы хотите скрестить engine.exe кафку просто предположим такую задачу и вы хотите это сделать именно правильно в фазе логирования потому что фазе логирование у вас уже все выполнялось у вас есть подсчитанный размер контента у вас есть статус кто вот здесь все просто все данные в это сделать не можете sabre квестом почему подошли там не работают соответственно в таком случае вам приходится писать на голых сокетах фазе логирования чтобы послать данные в кафку вот теперь переходим к фильтрам здесь давайте его фильтра и the body и хедер фильтр очень хороший пример body фильтры и так zip фильтр и наверное все пользовались их на самом деле очень много зачем боги фильтр вообще в целом нужны представьте что у вас есть некий прокси пар пас неизвестно куда и вы хотите каким-то образом преобразовать контент либо его проанализировать я не знаю вдруг вы в апликэйшен free firewall делаете в таком случае вы должны использовать body фильтр как он работает вам приходит в чанки очень много чанков вы с ними чет делать и скажу можете посмотреть что там внутри даже как тасс агрегировать что-то врезать в общем это можете что угодно с бадью делать там тоже есть дичайшие ограничения например если вы решили изменить тело допустим взял скую то врезку или вырезку из тела ответа вы должны помнить о том что у вас контент лент изменится и так и другие атрибуты и час тебе если вы это не предусмотрите и правильно скажем так не у себя в ходе не отразить это это может привести к странным эффектом вот хайдер фильтра это например это хедер я думаю все им пользовались он работ очень просто так же как будет фильтр у вас все готовится response клиенту и это her feet и кадр фильтр позволяет вам что-то там сделать допустим добавить фильтр добавить хедер удалить хэдер изменить хэдер послать я не знаю sabre квест куда-то хотя в боге фильтры и в кадр фильтр sabre квеста доступно то есть там можно даже какие-то внутренние идентификации на к это внешне на какой-то дополнительный локэйшн где посылать вот это вот что касается фильтров секундочку воды выпил вот следующий тип модули он самый сложный самый неоднозначный и вот чтобы писать такие модуль надо знать весь engine x там доки шкаф это прокси примеры это прокси посреди с постам т.н. тарантул посыле тнт паски обозвал и вообще все скажем так модули которые позволяют прокси ровать запросы в какие-то внешние системы то есть например преобразовывать степи во что-то другое классическим путь можно кстати смотрите что такое прокси по сути прокси это интерфейс которой предложили разработчика разработчики engine.exe чтобы писать прокси проще однако если по какой-то причине ваш протоколы не ваш протокол протокол который вы хотите которые вы хотите продать их степени поддерживает классическую схему request replay она тел отличает каким-то образом то у вас начинаются дикие проблемы потому что тот api для прокси и которые дает разгадают engine x он под это просто не подходит и в таком случае вам надо просто изобретать с нуля этот прокси модуль очень хороший пример такого модуля к примеру это пузыри спас то есть модуль позволяет общаться индексу спас grey если обратить внимание там вообще не используется тот интерфейс который предлагают коллектор разработали car engine x а там совершенно скажем так свой собственный путь был найден поэтому горю прокси они они просто надо помнить но желательно их не писать потому что для этого придется выучить весь engine x на визу сито очень долго это очень сложно вот но и лаут балансира их честно говоря я никогда в жизни не писал но я не представляю как они пишутся их задача очень простая представьте что у вас есть секция up stream там есть какие-то серверы и вы указываете веса и способ балансировки это типичный low'll баланс top который работает в режиме round robin round robin не всегда подходит по тем или иным причинам поэтому вот кто-то разработал кита махеш модуль где можно условно запрос прибивать по континентам кашу каком-то сервером это порой очень удобно engine эксла предлагает вообще баланс тир байлота есть вы можете в принципе на любой балансира написать то есть ну например вы можете не знаю многие вещи там сделать например при желании опять же если мы говорим про open russia не классический рынок спасай ты-то куда туда сходить грудь бды взятку какие-то данные на основе этого сбалансировать не знаю где это будет где это пригодится на такой сделать можно вот а теперь коротко и о самом важном проси модули ну сейчас будет абсолютно мое субъективное мнение о разработке си модулей с в даже если вы делаете си модуль который будет эксплуатироваться только вашей компании всегда думайте о директивах то есть вы начинаете проектировать модулем на с директивой почти именно с директив потому что это то с чем будет общаться системный администратор а тот человек который будет эксплуатировать ваши творения это важно если она непонятная если она неправильно мер жаться она не может работать как то так вы должны все это отразить и согласовать всем все который будет эксплуатировать то что engine x это известные продукты и директивы там как бы это сказать они подчиняются определенным знакомым которые знают системные администраторы поэтому всегда об этом думаете второй важный пункт engine x в нем есть определенные скотт style guy code style его надо придерживаться почему я думаю что надо придерживаться представьте что ваш модуль ваше творение будет поддерживать другой человек если это другой человек уже знакомством женёк сам и уже знаком с этим код стайлом его будет в разы проще прочитать ваш код осознать и вы что-то сделать с ним чем из на другом случае вот хороший пример на самом деле не так давно один мой знакомый с германия не просил просто помочь ему разобраться с кем-то богам внутри его собственный джин x кода когда у меня просто показал свой код который был написан но я не знаю в каком code style он был написан просто ужасный даже это прочитать нормально не смог это важно третье важное правило которым надо помнить 24 на 7 даже если у вас очень много опыта в engine.exe в чём угодно и это след не только про между на x используете правильный memory пул типичная ошибка начинающего разработчика модули на сей для engine.exe они берут не тот пул допустим хороший пример индекс он хотя большая предыстория engine x целом использовать в диалоге слабо локаторов то есть там можно пользоваться мало кому не рекомендуется там есть свои слабые свой мемориала катар надо пользоваться им и соответственно каждому объекту у каждого объекта и ссылочка на его полу вот этим поломка раз надо пользоваться и типичная ошибка начинающего что он использует допустим федор фильтре не pull request a pool connection а что это означает это означает что если у нас keep-alive connection этот пул будет пухнуть пока мы не получим out of memory либо какие то другие интересные side effect и поэтому это важно и более того такие вот ошибки крайне сложно де бо жить почему он и потому что ну запустить его valgrind пустим кто хищник тот поймет со слабо локаторами это не работает он вообще покажет ну какую-то странную картину ну и последнее правило она очень важно это тоже типичная ошибка тех кто хочет побыстрее побыстрее что-то заюзать внешние они начинают использовать блокирующие и а и блокирующие соки то этого делать нужен exe никогда нельзя почему engine x1 процессор най до однопоточный то есть там много процессов но он однопоточный там можно сделать многопоточность но как правило это не нужно и даже хуже если вы используя в такой архитектуре блокирующие о то у вас все будут ждать вот этого вот блокирующего куска что не очень хорошо вот ну и множечко расшифрует о чем я сказал выше что самое главное что что надо помнить и директивах во всех когда мы все директивы engine.exe они живут разных контекстах разных scope of допустим если посмотреть на директиву это хедер можно обнаружить что она может работать как инaчe типе ловил так и на локэйшн level так и на локэйшн и плевали и это все как правило описано так вот вы должны первое что сделать понять на каких таких вот уровнях ваша директива может работать почему это важно потому что в engine.exe конфиг мерзавца то есть словно когда вы пишете это хедер где-то там наверху у вас это значение она смел сжаться в самом нижнем от хедере который у вас уже в локэйшн не у вас будет завязана добавлено два фидера и так это это относится к любой директиве либо наоборот ваша директива если вы там указывайте а не знаю х спорт чего-то и у вас там поднимается какой-то пул сокетов должно быть это указан один раз в таком случае вообще не надо вообще надо запрещать любой мерзнут это вам просто не нужно поэтому вы должны всегда четко определиться в какие scope'ах engine x конфига живет ваши директива либо ваш набор директива вот например их хороший пример как я написал это вот эта хедер который здесь просто добавляется в локэйшн такой же от хэдер мог бы где-то выше ему просто все свершилось это принципе документирование понятное поведение вот и кстати внизу здесь под снос . я написал части engine.exe где может жить где могут жить существа директива и the main сервера в степи локэйшн локэйшн iv и опять же исправить и старайтесь избегать локэйшн iv а потому что как правило локэйшн и в приводит к очень странному использование джин x конфигурации да кстати еще важный момент я не помню скажу или о нем дальше поэтому скажу здесь но возможно я повторю ещё дальше очень важный момент представьте что вы разрабатываете базе фильтр и как я сказал выше что у вас нету как сказать engine x просто помещает ваш модуль в общей chain и у вас нет гарантий что gzip модуль на этапе компиляции не встал в чейни перед вашим body фильтром в такой случае если кто-то включить gzip модуль ваш модуль придут за где полные данные но вы знаете чем это грозит вы просто не сможете ничего с контентом сделать ну и это вы сможете его сделать можете его перековать например но это будет просто жесть точки зрения циpкa вот и такие же правило относится ко всем фазовым хендлера у вас нет гарантий кто вызовется перед и кто после и поэтому вы должны уважать того кто вызовется после и помнить о том что вам купить gzip может пролететь неожиданно или еще что нибудь так ну и ножка про engine x-code style нету даже свою цитату любимую засунул принципе он даже принадлежит мне как мне кажется по крайней мере если кто-то что-то создал то это кто-то кто кто то это будет поддерживать поэтому помните о style гайде engine.exe я здесь парочку с носочек привел они такие абсолютно общее ни к чему не обязывающее но тем кто хочет начать писать свой модуль просто ознакомьтесь с исходниками джон икса на самом деле важный момент те кто будет разрабатывать из вас в будущем модуль джин икса очень хорошо будут знать исходники engine.exe вы их полюбить и потому что документации нет то есть вы будете в принципе пользоваться гриппом очень хорошо научитесь возможность сидом когда вы будете кит куски из индекса в своей модули переносить ну и конечно вы будете хорошо знать структуру каталогов и джон икса и вот немножечко о полах как я уже сказал что пулы надо использовать правильно например ни в коем случае при обработке request of нельзя использовать memory пул конфигурации потому что у вас он будет пухнуть в принципе пока engine ок с не перезапустится то есть надо просто понять какое время жизни объекта то есть допустим у request a время жизни но request tripplite то есть время жизни ровно вот этот pipeline то есть таком случае в этом пуле мужчин мог что разместить это хорошо освободиться а вот connection может жить теоретически бесконечно в нем лучше размещать уж что-то действительно важное вот и старайтесь не использовать маллок фри или другие or локаторы внутри engine икса как минимум это плохо влияет на фрагментацию памяти как минимум а как максимум это тормозит действительно очень много использования молоко внутри engine.exe по моему опыту тормозит неплохо так engine x особенно если вы оперируете очень большими объемами данных вот но и для любителей valgrind есть хорошие новости есть хакк который позволяет de bajo тем же наг спал и вот ссылочка на него используя вал бренд это важно если у вас очень много сипадан engine x на engine.exe потому что даже опытные крон так разработчики под эту всю историю может допустить ошибку работа с памятью ну здесь все просто не используя блокирующий его потому что у меня просто был опыт немой что человек использовал в блокирующим режиме куру внутри engine икса не спрашивайте зачем это привело к тому что вся keep alive соединений в принципе нормально перестали работать и все время тайм-ауте или такого лучше не делать вот потому что будет работать очень долго очень неэффективной вам сразу придётся выкручивать million times out of потому что у вас дженкс начал тайм-ауте как минимум на многие вещи вот мы плавненько подходим к альтернативе индекс модулем носи а именно конгрессу ecлu а в этом году у меня появилась скажем так мой первый опыт работы на джесси у меня даже есть сложилось по нему с скажем так субъективное впечатление и я даже понял чего там не хватает чтобы совсем было все хорошо а также я бы хотел сказать свой опыт работы на опытным же in exam и более того поделиться с проблемами которые присутствуют в lua давайте коротко лаетесь ничего нового на самом деле не скажу на самом деле он жены все не используется луганщины все использовал уаджиб вот это нилу а потому что лу ушло уже вперед как ни на одну версию а то и на две а logic застрял где-то там в прошлом и более того если вы посмотрите опен-рейз его пин расти форк но аджита потому что logic перестали развивать по-моему там чё-то какие-то активности ведет автор но по-моему так не сильно и вот это еще скажем так добавляет странных поведений в том же open russia далее важный пункт это garbage collector он требует постоянного внимания эта проблема logic с ней в общей как сказал никак не побороться только придумывается и мистический алгоритм как правильно его вызывать при огромные нагрузки это будет его для следующим образом представьте у вас суточный график у вас нагрузка приличная много keep a la его у вас garbage collector будет вот такими провалами 500 камина клиенте в виде очень часто в таком случае есть много способов борьбы с garbage collector малая них не буду как сказать здесь акцентироваться в интернете на самом деле много информации можно даже доклад например монса послушать из mail.ru ну владимира перепелицы он там это хорошо рассмотрел ся далее это просто зло lua уже не lua пардон allow аджита в lua это починили реализация строк в luat жить и она просто не поддается никакой логике там строки дичайшим образом тормозят это связано чисто из-за внутренней х реализация я тоже детали не буду погружаться можете там эллинге поискать lua где наконец-то от старого love а старого представление лаладжи ты от луаз места представлений строк ушли вот далее далее далее да и что самое важное из того что engine x не блокирующая большинство библиотек которые реализованы уже нло и lua джи ти они используют блокирующие а из-за того что ладно изначально блокирующие скажем так у нее концепции начали что мы все блокируем то невозможно использовать уже а скажем так готовые библиотеки внутри engineers как правило которые используют блокирующие его любое это будет тормозить индекс вообще просто нельзя ну и вот здесь ссылочка на самый актуальный for клу аджита который в принципе вроде даже работает внутрь engine икса неплохо так давайте им поскольку осталось пять минут я все таки хочу очень сильно опэн джи си рассказать я окей силу аджит пропущу они в принципе ничем не смотрите там основное правило в следующем заключается не обрабатывайте огромные body нло а это самое важное правило это вообще не работает и не делайте комп не делайте хендлер н на контент ну а тоже это тоже не работает то есть старайтесь логику минимизировать до нескольких iv чиков регик тиков и так далее например балансер можно простой написать он будет работать но если вы захотите врезку в тело сделать нло это у вас будет работать очень плохо не используйте ширад мэмри вместе слоу вас garbage collector просто вынесет вам весь мозг на проводе гарантированно уже проходили вот я здесь написал все а до их прокрутим и желательно ужин и этих тоже не используя потому что у них есть такая проблема что не порождает еще больше мусор внутри logic garbage collector а что плохо ну и коротко что надо помнить и лава джи ти что там а нужно всегда если вы его уже использую надо сюда мониторить память это важно 2 мониторить garbage collector я даже ссылочки привел где можно почитать о том что там мониторить как им пользоваться но это принципе в интернете все есть вот и всегда изучать принципы работы garbage collector если вы все-таки написали сложные приложения для ло аджита потому что вам придется уйти в reste куда прикрутить вот нгс какой крис по камере я в этом году для себя решил используем же на самом деле переписал код хищный как ни странно я просто менеджер expanse когда был меня убедили что это круто и решил попробовать нет вот первая авторизацию делать можно она работает код получается простой на скорости не сказывается действительно все хорошо все великолепно 2 к из который я сделал то что многие переменные можно вычислять с помощью ндс внутри engine.exe тоже очень классно на самом деле в lua такая фишка есть но это менее классно потому что garbage collector ну вот на самом деле я даже небольшой прототип чик свой с которого начинал здесь выложил кому будет интересно может скачать посмотреть там куда дети строчек кода но тем не менее эти 10 рычи коды сделают авторизации сестре однако не всё так хорошо а чего не хватает в джетте чтобы на нем делать действительно классные вещи не хватает shared memory ну точнее как я за почил теперь хватает но это мой собственный форк дальше не хватает фильтров то есть сейчас в одессе есть только фаза контента и переменные это плохо очень не хватает хэдер фильтр то что приходится костыли тесь допустим ножку чуваков добавить не хватает body фильтров есть хочешь там допустим слов сложнее логику сделать что-то с контентом не хватает информации о том как эту штуку правильно мониторить и я теперь знаю как написал исходники изучать и не хватает ни инструментов и не информации как это правильно профилировать честно скажу я пока мере не нашел вот не хватает си модулей потому что мне на появилось желание расширить нгс как ни странно и не хватает где-то кейсов то есть менее понятность от где его еще до конца могу использовать где не могу вам топ каких-то публичных местах так небольшое предисловие у нас уже финиш по времени смотрите зачем надо создавать engineers модули первого решать бизнес-задачи когда у вас действительно есть предпосылки написать модуль носи например большая нагрузка в резко контента или не знаю элементарная экономия на жалея тогда это но сделать гарантированно носи большинстве случаев в большинстве случаев подойдет и lua нгс но надо всегда помнить что когда у вас что-то надо думать наперед то есть у вас растет количество клиентов какой-то момент то перестанет справляться и вы должны об этом думать и помнить и как-то так вот как ну соответственно на и джей-си пока я вижу что на нем надо писать только когда лак жить совсем достал честно но вот например про авторизацию авторизация генерала на но достаточно много garbage коллекторов ну не критично но и горбач объектов для garbage collector это был не критично тем не менее это отражалось хорошо о мониторинге и раздражало часто перестал отображаться в моем мониторинге все стало хорошо вот спасибо за внимание ножка тут по времени ум не уложился в вопросы василий сошника mail.ru спасибо тебе за выступление это кстати в докладе умудрился все равно сделать вклад в русский язык я никогда не слышал чтобы эти пибоди то есть делайте тебе запроса называли не тебе бадьей значит там выносной зоне я смотрю в камеру вы на своей зоне сидит очень много людей если у вас есть вопросы то вы можете пройти по коридору который перед вами до 3 двери в зал и пройти до экрана проектора там очень много сидячих мест и я напоминаю что за лучший вопрос василий назначит приз вопросы все даже на приз вопросов не отдала вложите в степи 2 поддерживается на так очень хреново там нет sabre квестов приходится костыль дофига а что снг сам она работает лучше но я честно говоря не пробовался части пе-2 но если опять же исходить из общей идеологии работает должно опять же есть ты используешь степи в 2 модуля внутренним жены кстати лишь sabre квест на эти локэйшн тоже дальше просто стриги рид уже 42 и уже там начнет крутить свою логику теоретически это должно сработать слова но я никогда не пробовал ну ну видимо у них тут там много хаков честно скажу его тон расти в интернет слова возможно кстати опять же этого не изучал возможно sabre квесты не поддерживают этого если в таком если они этого не поддерживаю to do in же скорее всего тоже не поддерживает расти алексей мтс и предыдущего докладчика дмитрия за должен вопрос про профилирования собственно подкладку чем в итоге производительной джейси а все просто принтами профилирование тоже принтами да тоже принтами за меряешь время там там дальше ставишь просто хочу с помощью переменной и печатаешь в это в гирлок и смотришь вроде нормально ну это кстати проблема на самом деле это не смешно это это неправильно но вот пока приходится так у меня вопрос когда была задача чтоб имплементировать api гитаре или что подобные но бывали похожие задачи но битва такая тема очень широкая то есть делать словно авторизацию мониторинг статистику и трассировку вот на эту структурам уровень такая задача была нами жена xi она делается вот над просто его правильно собрать правильно скажем так кое-где подкрутить вот и все вопрос еще один на каком уровне нужно делать модуль чтобы реализовать поддержку других крита алгоритмов при построении т с а вот это придется кору патчить все сход без вопроса если мультифинанс на и приложение с разными сср сертификатами динамически выдаваемую например один crypt ну или свои загружены это где а в каком случае с такой дополнительно прост смотри если в случае если у тебя приходите части ps а ты хочешь с кем-то пообщаться у кого там условно другой сертификата правильно нет приложение https на в зависимости от орла свой сертификат свой там не знает tennant это которому надо сбалансировать но на самом деле тут можно подойти двумя путями либо за патч внутрь engine.exe то вполне возможно сделать пачек свое хранить некоторые моды хоть так и делает второй вариант можно изгаляться с в до сих пор не пока не пойму как с условными sabre квестами редиректами то есть либо кору патчить либо изгаляться простыми способами простыли нет там смотрю в чем проблем и все что связанно с элем но интегрируется гораздо раньше чем срабатывает твой модуль и вот и как следствие эти придется в то место вкручиваться и что-то там делать а это уже починки дра спасибо ростех каким образом можно на об стриме реализовать балансировщик полов серверов то есть грубо говоря там географическое разное расположены 3 сервера в одном месте второй пункт резервуара в другом месте но и так далее но у смотреть и логика очень примитивное ты можешь дать балансер байла как вариант вот если тебя соси ну очень высокой нагрузкой тебе неохота себя сослала то ты можешь написать модуль то есть ты можешь делать что взять скопипастить исходник engine.exe round robin модуля посмотреть как он работает он очень короткий на самом деле там он 300 строчек кода вот и просто там вкрутить свою логику человек не всегда является эффективней но скажем по сравнению с листком не понял может отрицать но round robin не совсем эффекты я понимаю я менял витой ножка про другая твари как создается модуль engine.exe джон x черный ящик ты не знаешь там 99,9 процентов о нем как я ты смотришь фуджин x ходики копируешь нужный тебе модуль главное знать о структуре что эта матрешка смотришь эти четыре строчек кода ага понятно вот она так работает а дальше пишет свой код поверх этого модуля меняешь парочку название вот и все будет хорошо то есть начни просто скакать с модуля round robin а и просто прикрыть эту дату логику по селекции сервера нужного да да да просто смотри есть модуль который уже встроены в engine.exe собираются как gzip модуль round robin ops 3 моды а внешние модули это просто точно такие же модули с can find файлом которые внешние по отношению к engine xa он нас сейчас будет последний вопрос поселение спасибо вам за доклад андрейка флант можете подсказать пожалуйста все что мы обсуждали все что вы рассказывали это здорово с одной стороны у нас есть написание модулей носи которая фундаментальна сложно потому что сам себе простой но как писать иди божик правильно это отдельный вопрос с другой стороны у нас есть lua lua jit у нас есть нгс который костыль местами проблемные так далее дело в том что я сейчас купер нации очень много работаю с некросом и прочим и там ребята начинают вот мой бывший коллега например работает с альтернативными реализации балансиров тот же трафик например вы можете сказать куда все таки индустрии и мы двигаемся вообще будет ли дженкс личным лидером вот в такой странной ситуации между касты лингам ну ну а там и джей-си и фундаментальном си и что будет вообще в будущем что вы думаете может быть чудо нарасти произойдет суша но вот опять же не то что многое здесь как-то поискать предсказание будущего вообще дело неблагодарное еще могу сказать одно что сейчас open расти floor кнут тоже его сейчас ребята из конго разрабатывает то есть тема с постоянными for коми она нормальная amazon много чего for каид то есть я думаю что все это куда-то приведет и engine x потом поучаствует все что могу сказать по ощущениям из того что я видел скажем по предыдущему опыту ну вот говорю главное помнить то какую-то задачу решаешь и зачем все остальное не имеет значения то можно было написать свою прокси она возможно будет эффективнее джин x работать но сомнительно и за грудь он все-таки которые на каждый connect кто сталкивался тот поймет спасибо продолжение дискуссии можно устроить в дискуссионной зоне снаружи зала большое спасибо за доклад"
}