{
  "video_id": "RqZ9_Yq-ibM",
  "channel": "HighLoadChannel",
  "title": "Пересядь с иглы TCP на UDP с миллионами пользователей  / Александр Тоболь (Одноклассники)",
  "views": 3939,
  "duration": 3064,
  "published": "2020-04-14T11:20:03-07:00",
  "text": "всем привет привет москва привет питер питер привет и питер нова и новосибирск пусть это реально очень клёво мне очень нравится то что есть трансляции других городах ещё хотел сказать привет олимпийский на нет давайте меня зовут александр и сегодня мы будем рассматривать то как мы пересадили в миллионы пользователей стихе пины египет я вообще в одноклассниках отвечаю за платформу ленты и ленты это тот сервис который вы видите первым когда открываете любое приложение социальной сети качество работы этого сервиса напрямую зависит от скорости доставки контента пользователю поэтому мы очень много занимались этими оптимизация me и сегодня я вам расскажу почему мы пришли на ком мы проводим наши эксперименты и кого мы ускоряем у нас есть месячная аудитория порядка семидесяти одного миллиона пользователей которые нам генерирует как бы определенную сумму трафика вот и при этом у нас больше десяти процентов используются конечно же мобильными устройствами а что пальцы делать на мобильном устройстве они запрашивают у нас больше 20 миллиардов сутки событий ленты и они две с половиной тысячи лет в год в один день 2 span 1000 лет они тратят на просмотр ленты то есть это просто колоссальное количество времени люди влипают в приложении вот если вы поставите за собою наверно тоже заметите что в тех пор царь польский шпион книгах ждать они хотят получить сразу же моментально готовый контент а что сегодня ждет нас 1 часть мы поговорим когда вы пришли к точке когда вам пора ускорять сеть разберем обща чего зависит скорость идти в интернете и на самом деле посмотрим что не все эти хиппи стеки одинаковы потом мы перейдем на и т.п. и потом поговорим о вчера методики в разработке своих протоколов какой инструментарий для этого нужен и так далее а первый шаг вообще в любых оптимизациях тогда ли это измерение начнем с того что померяем сколько у нас занимает сеть в старте приложение приложение стартует у вас клиент устанавливать соединение там происходит хан шейк типичный телесно еще что-то неважно вот потом у нас готовится его лента потом возвращаются данные от ленты и мы конечно же с клиента собираем такую статистику для нас она очень на мы можем собрать отдельно еще время установки соединения время получения первого байта мы это все смотрим о чем нам вообще говорят эти цифры ну во-первых понятно что средняя говорит мало о чем она там довольно хорошие порядка секунды но 9 5 говорит что общем то есть люди у которых она и по 12 секунд открывается это может быть проблемой а может и не быть как это проверить не понятно если вы занимаетесь оптимизацией своего веб-приложения то на самом деле у вас например в хроме есть готовый фреймворк который вам также позволяет полностью получить статистику и залакировать время dns ответа установки соединения request response of всего остального то есть инструментов для сбора статистики масса сначала соберите что дальше нужно сделать дальше нужно собрать низко растущие фрукты и быстро оптимизирует то что можно оптимизировать конечно мы в базовое в приложении боремся за round trip и все каширу им предварительно настроили хорошо тисе пи там поставились идея но и проверили что мы жмем заменили джипег навыки и даже на самом деле вот картинку которую вы здесь видите мы и запихнули в 5 запрос чтобы сэкономить round trip это на самом деле выписанная картинка размером 200 байт запихнутые текстом джейсон вот можно делать разные трюки а если вы хотите именно про оптимизацию мобильных приложений посмотрите доклад там будет много чего нужно сделать на клиенте по этим решением и все равно после всех технизации мы помнишь наши позиции ждут ждут они в среднем там два процента времени приложения работу сетью и ждут где-то одну секунду в минуту ну такой момент думаешь и 2 процента это много давайте а кто-то мышц 2 процента это мало хорошо на самом деле это одна секунд 2 процента ничего не горит очень часто даже оценивая перцентиле медианы и значение так далее очень трудно понять что нужно делать немножко оффтопик а это как мы пришли к тому как нужно проводить такие эксперименты когда вы заходите на портал или вам готовится лента мы пробегаем всех ваших подписчиков все по три на кого подписан и друзей подбегаем все ваши паблике собираем это вместе ранжируем каким-то алгоритм вам выдаем вы это смотрите конечно же у нас используется алгоритм машин леоне нга есть отличная команда отличное решение вот и в очередной момент выкатываю новую модель там их g пусто они несколько отклонили средняя выдачи ленты очень не сильно на 300 миллисекунд вроде бы ничего страшного и давайте запустим запустили о небольшой аудитории нас есть система бы метрик наверное но у многих эта система уже есть если вам интересно канал встроенной здесь есть ссылочка на доклад у нас собираются там несколько тысяч параметров и порталу вы включаете эксперимент на какую-то случайно аудиторию и понимаете куда у вас что вас происходит какие у вас характеристики вырастать и упали бы стать вашего эксперимента получилась история что вот если красно это плохо сенях зеленое хорошо хорошо мало плохо много что что произошла давайте посмотрим почему вообще мы решили что эта модель должна быть лучше понятно что при машинном обучении очень часто работает оно следующим образом вы берете какие-то данные разбивайте их на обучающей на старые берете новые контрольные и например лента предсказывает алгоритм лента в первых предсказывает ваше взаимодействие контентов сока вы будете его смотреть лайкать фидбэки так далее вот модель говорит что в оффлайне она гораздо лучше других моделей предсказывает все эти характеристики прям серьезно мы запускаем продакшном покажет это хуже что делать очевидно мы взяли и замедлили выдачи мы решили что давайте мы возьмем небольшой аудитории посчитаем обе модели 1 вторую и случайным образом по оба выдадим одну из двух по крайней мере во временных интервалах они будут абсолютно одинаковых почему мы не добавили три цели 300 миллисекунд наверное очевидно потому что это средняя там есть распределение вот после этого мы запустили модель и ура оказалось что модель успех мы побежали и оптимизировать выкатили у нас все выросла но самое интересное что мы поняли что время важно и что одним из интересных маркеров того нужно ли вам активизирует ту или иную вещь возьмите перед тем как вкладываться в эту оптимизацию тормозите и посмотрите повлияет на пользователи если у вас есть оба или есть у кого можно спросить убрать я сейчас это все оптимизирую возьмите заметили в два раза если никто ничего не заметит наверное оптимизировать это в 2 раза тоже не нужно итак когда нужно ускорять сеть когда у вас есть все данные все графики когда у вас уже все остальное оптимизирована это точно если вы где то там передаете в два раза больше данных никакой ускорений сети вам не поможет ну и когда ваш маркер эксперимента с торможением показывает что да это можно делать ещё интересный момент которыми для себя увидели что если ваш сервис таймкиллер то все сэкономленное время на сети exe так далее конвертируется в пользу к активность если у вас сервис не знаю по продаже билетов на концерт то возможно сэкономленные там 20 процентов а не деньги как не сконвертируется поэтому всегда проверяйте какими-то экспериментами стоит ли это с этим заниматься при оптимизации тырнета первый же вопрос который возник она сандры интернет можете так быстрый на самом деле есть открытая статистика на спид тесте можно зайти посмотреть скорость мобильного интернета проводного в россии цифры 20 мегабит на download 10 на оплату чем вообще космос что тут оптимизировать проверил дома ну да хорошие цифры работает посмотрел на портале перепроверил всеми разными сервисами среднем там по миру 2 3 мегабита зависеть от клиентов что-то странное то есть получается что в speedtest показывает нам очень высокую скорость по регионам am эту скорость не видим интересно кто виноват магистрали у вас что ли 2 мегабит на ну понятно что спит с ты он все операторы ставят себе сервера спидтеста и мере us у кого интернет быстрее да вот может быть в этом особенность может быть всегда магистраль может нас сервера плохо работают на сами ли кто думает что она там магистрали в этой истории давайте а кто думает что последние миль и вот она у тви над последними а кто думает что те цепи у этих людей больше анер на доклад видели ну на самом деле разберемся дальше если кто то из вас уже видел этот доклад то прошу меня простить а для остальных мы чтоб все на одной волне были быстренько про гонимся значит понятно что в тисе пи вы отдаете какой-то поток данных он нарезается на пакетике там войти который дальше куда-то складываются данные сетях передаются пакетами размер у нас пакета ну там некоторые обычно 1500 что-то около время у нас можно в сети померить round trip а это время пинга или время получения окно уже метана пакет когда вы отправили пакет вам сервер или крем подтвердил что пакет пришел мы еще будем оперировать с вами такими величаем величинами как пропускная способность вы бухаете там 10 пакетов сеть они как-то равномерно приходит на клиента вы можете посчитать размер пакета в единицу времени это будет про на способность у вас есть все тещу такая характеристиках пакет лосс вы отправляете пакеты не все доходят мы и считаем процент и у вас есть джиттер вы пишете пакет и равномерно они приходят неравномерно окей его можно как вариативность пингов хранить поэтому простая модель сети состоит всего из четырех параметров на основании которой в принципе эта задачка может решено быть давайте попробуем у нас последняя миля примерно там имеет packet loss один процент магистрали может для удаленных регионов быть там 100 миллисекунд на ртт выдавать давайте сформулируем ситуацию включим шейпер посчитаем запустим speedtest как это будет выглядеть мой спит с на 70 мегабит я к нему добавил пойти плос один процент ну буквально там на какие-то небольшие than 15 процентов у нас скорость уменьшилась ничего страшного добавил еще стоп 100 миллисекунд ртт и ой извените у нас от 7 до 10 мегабит осталось 5 это хорошо если у меня 70 на старте как носить имя на старте 30 там 10 вот то есть получается на самом деле комбинация магистралей последней мере нас приводит к такой ситуации когда у нас на сетевом уровне все очень неплохо у нас ваш высокая пропускная способность но у нас есть делая есть пакет лосс и на уровне тисе пи у нас достаточно низкая скорость поэтому нас андре виноваты в этой ситуации все как-то так сложилось вот ну посмотрим что можно с этим будет делать на всякий случай еще раз когда вы смотрите свой speedtest и у вас даже есть пакет лосс на вашем локальном вайфай-роутер и дома у вас очень неплохая скорость а когда вы начинаете смотреть и туда удаленных каких-то вещей то она будет несколько другой поэтому смотрите спит с ты можешь смотреть fast ком это сервиса от netflix а он во франкфурте стоит там будут разные цифры с тем что вам будет показывать speedtest это если хочется руками потрогать и у вас нет какой небольшой соцсети где можно посмотреть статистику если посмотреть статистику интернета в мире можно увидеть что есть очень много стран в которых мы тоже там так или иначе присутствует которые там меньше 10 мегабит в секунду скорости понятно что она остается не самый большой и что можно сказать что скорость интернет на самом деле вообще быстро но возможно не до вашего сервера вот скорость на разных уровнях может быть разная вывести передать данные по тисе пена для вас своя и никому не доверяете померить и и сами эти что происходит ну а дальше мы передём к самой интересной части будем заниматься сетевым дайвингом на уровне тисе пи у вас есть определенную скорость вот сервис fast ком например от netflix вы пошли посмотрели на нее уровнем пониже мы знаем что нас есть пакет лосс bands джиттер все остальное вот тот доклад который я до этого рассказывал а там все это раз рассмотрено довольно подробно начнете будем нырять довольно глубже для того чтоб нам разрабатывать свои протокола нужно понимать вообще как работает сеть что происходит внутри а сами интернет это миллиарды сейчас реально миллиарда устройств который между собой так или иначе соединены которые все конкурируют за сеть на маршрутизаторах работают разные протоколы вы понятия не имеете что там происходит но для того чтобы этим разобраться на чем просто с истории интернета когда я родился интернет был проводной сейчас уже больше десяти процентов трафика интернет и мобильный но энтропию от терял пакеты того чтобы эту проблему решить в типе есть перри посылка пакетов работает она в первых версиях работала исключительно так вы на каждый пакет получали acknowledgement если окно жевать не пришел то через сколько тайм-аут строке 3 трансмиссия и transmit тайм-аут начислялась довольно просто он поддерживал средний какой-то за последний интервал round trip видом нажал на куда константу среднем может ли это полтора раунтри по вашей трансфер тайм-аут если вы за полтора round trip а не ответили то вампире пошлю пакет 1 кондрашин коллапс в интернете случился 86 м году и не последний когда из лабораторий до беркли канал который был тридцать два кило by the feast очень смешно прикатился в 400 400 бит в секунду всего когда ребят стали разбираться посмотрели что произошло это график это график номеров пакетов отправки то есть если у вас все хорошо то график номеров пакетов в тисе пи это просто вот прямая который все время растет вот если что сети происходит пакет или транс светиться и вот эти вот падения 3 трансмита если провести полоску видно что порядка пяти там п ри transmit of одного и того же пакета происходит что может произойти в некотором случае предположим вы завалили раутер два раза большим количество пакетов он 50 процентов дропает обратной стороны такая же ситуация и в итоге psy процентов rejects что будет происходить играть с того что получите ок на свой отправку будет 25 процентов то есть весь в разных случаях вы сделаете период правку часть из них будет spears vs и transmit ими на самом деле эти ретро цветы были не нужны вот и ваша сеть на самом деле деградирует это ваша скорость получения то отправки в какой момент у вас настигает пик когда вы отправляете все большую большой пакетов а ваша способность падать как избежать таких потерь поэта что можно увеличивать длину очереди на мушке сотри но это неэффективно с одной стороны есть все равно никакая бесконечную очередь не бесконечный рано или поздно может переполнится а вторая история в том что чем больше длиннее буферном маршрутизаторе тем больше у вас задержки при полном буфере при доставке пакетов вторая история слать меньше данных нотка доставать меньше данных непонятно потому что для этого придуманы механизма кондрашин контрола но они не знают какой момент муж театр перегружен и нужно каким-то образом это определять понятно что в сети миллиарда устройств кого-то централизованного источника информации который говоришь надо слать меньше нет вот поэтому первое что пришло в голову это действительно очевидный факт это можно использовать обратную связь от окна лучшими то по пакетам когда вышли эти данные вот вы шлете довольно быстро у вас есть узкое место можете завтра он пропускает их медленнее и ваш клиент вам подтверждает получение этих пакетов вы можете понять что на каждое подтверждением посмотреть рейд этих подтверждений чистоту и с этим райтом открывать обратно вас будет замкнуть цикл система обратной связи все стабильно работает правда в том что в реальном мире таких людей на дно мортиза тори может быть 1000 или там сотни тысяч из-за случайного характера да рифма выгляд несколько сложнее 1 горит натаха при предложенный там в том же восемьдесят шестом году пусть вот он выглядел следующим образом у нас было 10 он отправлял пакеты получала канала джимми то мы подключили конкретный модуль который контролировал по окна уже в этом состоянии вообще в сети использовал в качестве фидбэка потерю пакетов и управлял окном а в тисе пи есть окна разные есть окно там flow control сегодня мы им заниматься не будем есть кондишен control он в пакетах не передается это состояние некоторое конкретного соединения хотела в том что он нас сверху тоже ограничивает количество пакетов состоянии он за fly то есть когда вы и выход провели но еще не знаете дошли они или не дошли вот в этой ситуации мы отправили 6 head of на 2 мы уже получили ок новый домен вот мы их можем выкидывать из буфера и у нас там четыре пакета создание он за flight хорошо как выглядит кондрашин control и все в принципе общем такая методика похоже у них есть сначала slowstar или faststart как назовете вот я в том что вы еще не знаете эту информацию сети вы просто начинаете что-то слать обычно вы начинаете с какого-то размера и удваиваете там количество разных пакетов и ситуация когда он избегает уже перегрузки сети это у него 2 стоит между ними может переходить определенным образом 1 конечно control the h смотрел только на пакет лосс и самое главное спасал сеть от collapse of slow star наверное вы знаете что в тисе пи есть и не шелвин да вы отправляете к это количество пакетов сразу сейчас она дефолт на 10 на каждый подтвержденный акт все думают что кстати не шелвин дал каждый раунд rip удваивается это неправда на каждый приехавший правильный ок он с одной стороны высвобождает в буфере один пакет его можно отправить а с другой стороны увеличивает окно на размер максимального возможно правильного пакета таким образом она как бы получается что удваивается это если все хорошо вот понятно что у slowstar то есть проблема в начале он супер слова потом с super fast вот то есть он сначала очень долго разгоняется потом быстро перегружает сети а потом начинает работать уже как надо поэтому система выглядит так у вас шоу есть slow star tv потом у вас есть канзаши наводим ситуация когда вы пытаетесь не перегружать сеть в режиме тоха например это в кондрашин контроля это он смотрит pocket лосс снижает окно потом потихонечку его увеличивает опять снижает и так далее если не дай бог у вас случайно пакет лосс произойдет на славу старте то вы сразу переключитесь канзаши на заднице будете очень много разгоняться он просто не повезло когда shine control of очень много понятно что это самый неэффективный самый первый наверно вот их реально десятками просто десятками вот их можно классифицировать по типу фидбэка некоторые смотрят на pocket loox некоторые смотрят на задержку пакетов некоторые смотрят на то и на то некоторые смотрят на рейд оков некоторые даже используют сигналы смажьте за трав самый полярный кьюби который используется дефолтного всех устройствах которые используются в отечески ваши дефолтные настройки linux как он работает он запоминает окно которое было в прошлый раз при потере пакетов но стартовал запомнил что у него вот здесь пропал пакет в этом месте вот он уменьшил атак но и быстро приближается к этому окну то есть вот к тому менту где должен пропасть пакет потом он некоторое время висит в этом состоянии и потом если понимает что он перевалил за эту границу пакет не пропадает с профицитом большей пропускной способности резко уходит проверять пустую способность если вы а коли аккуратно симулируете стенд где-нибудь без лишних провайдеров и операторов то сможете посмотреть в жарком как выглядит количество пакетов на лету и приходящие ваши пакеты кубик основной минус что он смотрит на pocket лосс поэтому если у вас в сети есть потеря пакетов он быстро деградирует наставили в линуксе вы можете его подвигать можете изменить эту уровень кривое так далее просто надо будет игра пересобрать вот и получить может быть какое-то даже преимущество перед конкурентами пример быстрее там разгоняться или лишних пакетов подкидывать когда shine control и можно классифицировать по feedback тайпом когда у вас может работать нормально у вас все пакеты приходят с одной скоростью и выходят и той же скоростью когда вы на него подаете больше чем он может у вас вырастает очередь вас появляется задержки если ваша очередь переполнить у вас получается появляются потери если мы рассмотрим би би ор это современный прогрессивный кондрашин control от google то можно посмотреть на две такие характеристики 1 это верхний round trip и 2 это простая способность сети когда вы начали что эти пакеты у вас round trip вообще не меняется а пропускная способность сети растет потом достигаете пика и у вас начинает копиться очередь на каком-то узком батл на камушке за три тогда у вас простая способность не растет round trip растет потом оставляется packet loss очевидно что оптимальная точка работы где-то здесь вот бибер заниматься тем что он ее ищет то есть на слову старте он пытается тоже определить она находится проскакивают сильно вперед потом возвращать назад довольно интересная штука если сравнить его с кубиком понятно что он поддерживает минимальный round trip кубиках постоянно теряет пакеты с нами проблем конечно control что возможно они внутри друг другу вполне себе fr и честно делят полосу если пять человек пытаются использовать этот же можете затар но между собой эти пакет кондрашин control и ни разу не fair один другого отжимает это нормальная ситуация если бы они были идеальными тут на 50 процентов они бы все сходились а тут они дружба пережимают и еще одна интересный момент что вот на рампе там восемнадцатом году заметили что биби некоторых условиях может вот передавливать кубик вот так вот то есть у вас кто-то сидит на кубики на дефолт и настройки тут появляется с бибером и если проверял на всю полосу забирает если смотреть эти кондишен control и в разрезе потерь сетевых для беспроводных устройств потери это нормально то понятно что бибер гораздо больше подходит для этого какие выводы главных . андрюш incontrol не привести кондрашин коллапсу все капюшон control и для того чтобы работать так иначе убивает сеть они должны либо заполнить весь буфер маршрутизатора чтобы понять что они упёрлись границу либо пакеты потерять у всех есть такие которые называются старт и avoidance когда у вас в начале вы ничего не знаете про сеть а потом пытаетесь ничего не перегрузить вот и bear на самом деле очень агрессивный conditions control on остается записать вот и конечно тронешь решать разные задачи есть конечно control и которые например на минимизирует delay это бибером он хорошо подходит для видео есть который врет там утилизацию канала максимизирует вот точно что нужно управлять они все разные вот и правильных наверное нет все хороши так и только каждый для своего борьба за сеть на самом деле начнем с простых вещей с и низшего window да с которого можно начали стоковый пакетов кидаете клиенту его с тринадцатого года не меняли вот но на самом деле его ничего не стоит поменять давайте рассмотрим путь плохую сеть и посчитаем для какой-то пропускной способности посчитаем какой-то round trip а сам плохо сеть пусть будет там порядка мегабита 200 миллисекунд round trip если мы аккуратно возьмем там 1350 байт например размер пакета посчитаем сколько можно за вертушку отправить получит 20 пакет азарт и отправляется то есть по идее вы могли сразу бы отправить 20 пакетов и не париться вы будете разгоняться ждать подтверждения еще разгоняться не давать визировать канал и не шоу window можно поменять конечно это нужно делать аккуратно это зависит от того чем наш таких клиент вы рассчитывать если у вас с пользой с плохим интернетом наверно не стоит его увеличивать если вы сидена обслуживать исключительно там какой-то регион наверное его можно поднимать например того командам до 32 поднята есть статья где это можно посмотреть и нишу винду легко проверить вы можете war шар com замедлить замедлить сеть и потратить пакеты посмотреть с каким размером отвечает на первый запрос вместе все хорошо аккуратно настроить можно это увидеть это было не очень интересно а вот дальше классные штуки в двенадцатом году когда начался мобайл фёст клаус я предложил что давайте мы начнем кондишен control units под конкретного клиента то есть мы знаем что вот сейчас сеть в каком-то конкретном регионе перегружена и он только подключился и мы уже можем настроить его так под заранее знаешь что у него там будет происходить то есть все работы со статистикой они оптимизируют работу сетью facebook делал свой кондишен control new vegas наверное он хорошо был оптимизирован под профиль работы пользователей facebook google сделал свой концерн control бибер и он отлично работает для видео возможно они как бы смотрели на youtube в 5 тоже в семнадцатом году поставляет определенной коробки которые позволяют вам оптимизировать тисе пи для конкретных пользователей в 5 это те кто яндекс купил вот у фейсбука есть свой протокол зиру протокол сейчас он базируется на крики они тоже занимались этими оптимизация me вроде бы все так борются за сеть активно проталкивают пакеты и вот ребята собираются в рай приговорят слышите ваш бибера реально все пережимает давайте делать хоть бибер 2 как-то двигаться быть как бы более честными с другими кондрашин control a mi то есть получается что сначала мы бежали вперед все боролись за сеть термин понимаешь что рано или поздно мы можем наверное опять попасть к джейн коллапс пойдут может такое тоже случается вот но я не знаю надеюсь что бибер 2 будет быстрее чем пибиар на я не знаю что может меня заставить откатить бега 1 видео ну в итоге выводы те кто попроще занимаются оптимизация и не шил window парни покруче itunes психически свой концерн control серьезный ребята пилят вообще свои кондрашин control и вот и в общем то все борются за сеть а тут еще ребята пришли из гугла сказали давайте поверх этапе свой протокол запилим потому что нам все в тисе пи не нравится наверно все из вас знают про quick я не буду про него рассказывать вы можете погуглить все максимально просто http 2 поверх протокола quick который по верху и т.п. реализует масса интересных классных печей вот расскажу что с последнего доклада по моего по нему изменилось его сертифицировать окажите петри если ваш ешьте теперь два протокола поверки к этаж типе 3 из самого свежего у нас уже 30 процентов трафика конькового на мобильных операторах россии вот его будет скоро поддерживать мази likelihood fly и понятно что все google сервисы и айос и android устройства и chrome браузера вы уже поддерживают другой вопрос что парни из google не раскрывает реализацию своего сервера предположу что возможно сильно завязан инфраструктуру от не очень просто крик был встроен в chrome с 13-го года его уже тогда начали пробовать сертифицирован был только 18 сухари куда катится мир то есть мы смотрим что все занимаются стены оптимизация миа мы просто диплом кубик в дефолтном линуксе и хорошо ну пока одни размещается куда катится мир другие его котят и мы хотим тоже попробовать в этом поучаствовать для это давай сначала потрогаем сеть руками посмотрим что вообще происходит вот та простая модель которую я рассказывал ранее она здесь нам не подходит поработаем чуть более детально возьмем fast кому это сервис которым netflix предлагает померить вашу скорость подключения имя до серверов otrix который раздает видео вот посмотрим для них pink замерим скорость получить какие-то цифры если мы параллельно зайдем на сайт fast ком и начнем мере скорость понятно что наш pink вырастет и вообще все цифры которые у нас были по пингу и по джиттера они изменились то есть наставили чем больше мы вваливаемся эти-то сложную систему нее есть обратная связь которая говорит что нет параметры будут меняться динамически понятно что почему это происходит мы перегрузили можете затар наши пакеты стали доходить дольше давайте оценим какого размера очередь у может завтра у провайдера возьмем по пингу им google где-нибудь который там где-то находится и возьмем запустим спит с который стоит на провайдере вот оно что мы им загрузим сильно сеть посмотрим что он повлияют на пин гугла посмотрим сколько времени пакет проводит в очереди и зная пропускную способность на что очень примерно может оценить что например мне провайдер 3 мегабайта дал на маршрутизаторе буфера то есть принципе 3 мегабайт у меня есть если посмотреть на амортизатор это понятно что на 10 гигабитный порт там порядка может быть 6 4 мегабайт буфер в лучшем случае это может вам делает там давать deep this theme секунд если муж а так перегружен вот интересный момент что у вас есть несколько мегабайт реально всегда где-то где-то там который вы может можете воспользоваться теперь про потери пакетов если вы включите speedtest и запустить его и shark и посмотрите потерю пакетов наносить на довольно большая средняя там 4 4 процента у меня получилось что мы сможем сделать вывод что реальность сложное что чем больше уж эти пакетов тем больше у вас раунтри packet loss все остальное и не факт что ваша пропускная способность вырастет муж татары буфера у вас смериться мегабайтами вот наносить влияет и не только вы то есть куча других устройств которые тоже в с вами как это конкурирует что мы это можем сделать давайте посмотрим на наш профиль пользователей которые пальцы ленты это важно если мы посмотрим профиль локальным и увидим что сначала происходит какой-то хан шейк потом запрашивать пара данных потом простой вы смотрите контент у вас чтобы фрезеруем а потом идет еще подгрузка очевидно что вы сеть используя очень импульс на я очень редко давайте вообще-то оценим предварительно как вы используете возьмем посчитаем распределение по ответу и 5 вообще запросов одноклассниках увидим что 9 перцентиле он укладывается 200 килобайт все запросами 99 процентов запросов укладывается в 200 килобайт не видно что распределение примерно такой поверим картинки там чуть побольше там где вас просто на запрос вкладываться в пол мегабайта но пенсию средняя там очень маленькой там меньше 100 килобайт трафика очень импульс на вначале вы запросили ленту потупили приложение чтобы грузило еще а давайте рассмотрим на старте если вы воруете 50 килобайт скачать данных когда вас открывается лента вот просто первый текст картинки что-то еще если у вас все хорошо настроено то вы на 1 request сможете отвечать большим количеством данных вот но размером с окно например у нас в размер пакета 1500 у нас там окно 10 в общем там какие там и данные перри 15 килобайта prime вот потом отправим 30 килобайт потом еще пять вот эта часть если все хорошо сделано будет 300 миллисекунд то есть мы данные пересылаем вот так а возможно хотели бы вот так хорошо давайте посмотрим вообще на картинке в интернете откроем white shark посмотрим вообще на каких интервалах работы сети канзаши incontrol и окажется что интервал срабатывание секунды то есть вот кусочка 10 секунд это . тоже секунд а есть нас american джош она адаптируется особенно в сетях не очень большой не с очень маленьким раунд рипом некоторое время в равной секунды там пусть 2 секунды вот маршрутизатор высота у него приходят случайные запросы случайное время и у него есть очередь очередь там тоже она такая и примерно за полсекунды она может ситуация изменится то есть там он был переполнить теперь уже что-то подозревать на скорость там 10 гигабитный порт вы можете почитать сколько данных он заполз секунду можешь скинуть как идеально посылать пакеты плохо послать пакеты так вот у вас есть очередь есть ее размеров и туда выкидывайте у вас что то не влезло послушать по дропает каким-то разными алгоритмами вот хорошо распахнуть вот так пакеты это ваш идеальный кейс как вы можете это доставить это называется песенка его можно даже включить для тисе пи но тогда вы откажитесь от лач сегментов лада и других типичных оптимизации где карта за вас может навязать ракеты и у вас на самом деле наверно вырастет очень сильно утилизация на сервере но он настолько эффективен что его даже добавив тисе пи то есть надо пробежать пакет отправлять их эффективным что мы поняли что через пол секунды на самом деле если у вас протокол ничего не передавал хотя об этом пол секунды вы уже без понятия что у вас там происходит в сети мы будем считать импульсным трафиком трафика у которого размер он сравним с количеством данных которые можно передать за ртт лиза 2 ртт если вы не стремитесь и габай ты а ваш как бы трафика потом сколько-то 100 килобайт 200 то может быть 500 даже это некоторый импульсный трафик вот и мы знаем что конгресс incontrol и slowstar ты это все про большое количество времени попробуем напилить свой протокол с учетом вот этих предположений что мы хотим чтобы он только работал в беспроводных сетях и для мобильных устройств по мере мы учтем что мы хотим только пиковый трафика что наш перцентиль 99 говорит что больше 200 килобайт запросов не бывает понятно что он работает с мегабайтами но фокус на 200 кило состояние сети не известно потому что вы пару секунд смотрели ленту пролистали дальше еще посмотрели еще пролистали за это время все быстро динамично меняется вот и у нас есть муршид сатору которую есть размер буфера там бега бойцы пример ok чтобы не делать пронумеруем понятно пакеты сделаем очередь сделаем все как tcp отправим пакеты получим на них окно ложементы если пакет и пропадают будем их чинить помним про transmit тайм-аут помню что когда мы перегружаем амортизатор мастер то растет помню что если мартова неправильно посчитали - пюре trance hits расскажем что этому вообще делать не будем это нас спасет от кондрашин collapse of на протоколе будем делать упор на selective color and soak если кто не знает вот учтем что мобильных сетях очень стандартная ситуация что у вас сеть работает на скачку 70 процентов времени и 80 и 30 на плод может быть отношении 80 на 20 это зависит от формата 3g и lte и вы от повлиять не можете у вас передатчик работа часть времени так часть так как бы у вас просто просто его это повод канал потому что качаете таким образом мы можем раздувать аки мы mtu сделали тысяч триста пятьдесят у себя размер пакета максимально который мы передаем вот и в окно уже тьмы запихали много битовой маски который нам говорит что мы пропустили плане того какие пакеты не дошли мы делаем все основой сне на пакет лосса канарейки то есть мы контролируем рейд при этом мы даже делаем такой трюк что мы сервера передаем например в какой-то момент длину очереди которая есть в отправке на сервере для того что клиент на самом деле знает когда у нас передача подходит концу и чтобы это конец оптимизировать начинает чаще слать аки то есть пока у нас до конца еще есть время клиент не дергается он не подтверждает что у него и пропали пакета или еще что то он может несколько оков аккумулировать в один а потом под конец он начинает слать чаще чтобы notify целовать сервер что у него все произошло хорошо мы используем telos проб в первую очередь раз у нас нет рта то есть чтобы не перегрузить сеть если мы пересылали кучу данных потом 1 пачка пропала эта пачка была последней к сожалению то селектив окна уже нет который мы используем нас не спасет поэтому мы начинаем слать лосс пробы и мы их затухающий шлём то есть пойми что мы кондишен коллапса не приведем таким образом мы просто их там нашли он через десять миллисекунд он говорит через 20 по двоения примерно вот и соответственно тел переработать когда вас простаивает канал пакета не очень большие он не провоцирует can george inn коллапс и при этом в телки можно записать запихивать исправление ошибок мы знаем какие пакеты у нас до сих пор не подтвержденные простому алгоритму можем туда пихнуть аксессуар можем пихнуть какую-то вариацию рида-соломона чтобы там клиент потом мог это те пакеты починить если вдруг ему пришел лосс проб еще из какой-то дополнительной информацией и пропала не так много данных как это штуку писать да очень просто у вас есть люди песок это вы можете отправить в типе соки данные помнишь нужно повесить мы рассчитываем ps у нас right control самое главное повесить пакеты с правильным расстоянием но есть проблема вы тогда будете отправлять по одному пакету тогда вы будете поставим переключаться между users поясом и керном space чтобы этого не было вы можете использовать функцию сын там msg который отправит сразу пачку тогда вопрос как в сеть то есть вы можете править там 200 пакетов новом то нужно их расспросить очевидно на самом деле из архитектуры сервера что это достаточно легко мы везде используем дизрапторы пользовать у нас каждый клиент на сервере сервер для каждого клиента поддержит очередь отправки мы туда пишем данные читаем у нас примерно 1 zerator обслуживает порядка 1 1 3 этап служит только 4 4 тысяч за рапторов он набирает все пакеты которые в текущей ps его устраивают набирает вес 56 пакетов отправляет пачку в kernal собирает следующем так на wild rose подходит своей очереди что еще в разработке протокол вам нужно у нас сейчас порядка по статистике порядка двух процентов сетей есть которые не поддерживают и т.п. если кто то есть из ростелекома и хочет поговорить подойдите я расскажу где есть проблемы не знаем что делать поэтому мы всегда открываем типичное соединение параллельно вот и всегда готова его использовать так у нас пакет и пронумерованы идеальные так далее мы можем даже использовать оба канала если хотим можем за дублировать а какие фишки у нас есть нашем протоколе ю т 2 в принципе все то же самое что есть у нас в крике кроме вот я х плюс те оптимизации которые мы делали исключительно под импульсный трафик плюс у нас клиент знает состоянии кластер а у него есть так называемый пингина в этих пинках которые у нас время от времени ходят мы еще передаем создание кластера чтобы он мог переключиться на другой сервер можем переключить клиентам другой сервер + он сохраняет свое состояние когда поднимается может там сразу выпивку экономя там dns всякие проверки переходить куда нужно что еще сказать полезного помните ситуацию с магистралью когда у нас была длинная магистраль раунд рифам и абонентское окончания с пакет лоссом вот в этих случаях хорошо работает сиди дальше ваш седин ничего не кэширует вот есть google кэша сервер на многие знают они у всех операторов наверно стоят то даже если он ничего не записывал он вам может помочь строением ошибок когда вас там round trip маленький на 10 где есть пропал пропаже он их быстро чинит а дальше у него на магистрали свое хорошее соединение может быть даже типичная посредством поддержали тоже сидел часть что хочется сказать что мы запилили протокол для передачи исключительно импульсному трафика в мобильных сетях он рейд bass в первую очередь он всегда оперирует вот такими вещами как песенкой частота отправки пакетов нет fast or там он статистически анализирует что ему нужно отправлять у него нет ретро и транспорт тайм-аут он использует sako тел п ну если denta очень полезная штука просто зачем ну теперь-то такая вещь который вам работ в дата-центрах который работает на большое расстояние который работает в навозе и черти где крик крик он классный он многие вещи вы здесь исправляют он вот прям вообще норм вот ну а мы на смотрю очень простая штука которая требует доставить небольшое количество данных но очень быстро только в мобильных сетях у нас есть очень узкая специализация мы быстро забиваем гвоздик давайте потестируем на самом деле а там уж видно ну как бы звучит космические в общем то результатом не можем верить на слово поэтому мы все виды тестирование будем использовать эти штуки начнем с простого ручного тестирования можете завести шейкер шейкер можно использовать как ваш локальный на машине на маке этот клин кондиционер у вас есть у вас есть и на линуксе можете спать мы используем фейсбучный библиотеку для в сети в общем разные пробовали все неплохо работают с оговорками вот мы делаем простой тест мы ставим практик перед нашими фоточками перед нашими 5 и смотрим когда работает выбираем конечно профиля какие-то среднестатистические для каждого типа соединения помню что мы работаем с пользователями с плохими сетями мы их первую очередь оптимизируем ну и вот интересный результат работы протокола очевидно что слева у нас люди пышная часть правоте типичная то есть на картинке приходят быстрее пойму что таким измерением на глаз конкретный случай доверять точно не стоит да и вообще на сами при разработке у нас очень много всего нужно было тестировать поэтому посмотрим как это можно затащить в линуксе есть еще такой инструмент копыт und ob который позволяет вам создать например туннель это виртуальное устройство которое вместо сетевой карты подкладывается под тисе пи пи стек linux вы можете дальше все пакета через файловый дескриптор читать и писать то есть по сути вы создаете клиент несколько серверов microsd и стирали переключения нашего клиентов между разными серверами вот мы их всех записываем этот интерфейс и дальше мы можем над und ob через file descriptor читать пакеты и заниматься их марте зации единственном есть нюансик надо тролль на суммы при смене айпи обновлять для пакетов в принципе такая тестовая среда для эмуляции раутером мы используем talkin' bucket и мы знаем про алгоритм рад что муж театр когда он переполняется он дропает некоторые пакеты то есть может сначала начинает дропать разные пакеты так пролежать чтобы кондишен control всех с лопался вот это все легко добавляется поверх этой архитектуры и мы померили результаты мы взяли поки толстого процента там типа сеть похуже отправляли там 50 килобайт например 5 раз отправился килобайт получил еще еще еще еще вот для усреднения но получилось что например при задержке 100 миллисекунд для тисе пи это там такая передача в такой сети занимает три секунды для к века это 13 секунд для т2 это 0 7 секунды я сосед начинает сильно портить например там до 5 классов по 10 процентов выдавать соотношении к века и едва она остается одинаковым при этом типе начинает жестко отстаивать в этой ситуации прямо на разы мы померили конечно еще ситуации без пакет лосс это вот интересно в целом они одинаково хороши единстве что теперь начинает проседать тисе пи мы использовали с кубиком в этом в этом месте он начинает проседать quick мы сначала тоже подумаешь наверно можно каким-то проблемам и плохо собрали мы занимались разными сборками creed по дефолту собирается который в храме у меня он собирается с кубиком и вы пособирались baby арам померили все тесты ну нет получилось что все-таки для наших конкретных кейсов мы быстрее и быстрее прямо вот процентов на 80 если хотите все это проверить и потрогать пожалуйста это лежит в open source и можно скачать этот эмулятор можно туда дописать свою модель роутера если вы знаете как ваша cisco работает можете в принципе не знаю пособирать quick и сравнить как quick там с бибером работать прилете в к веганский бекон понятно что для любого алгоритма всегда существует такой набор данных на котором это алгоритм будет эффективнее других не понятно что мы можем здесь сами себя обманывать подбираю входные данные которых мы работаем лучше это очевидно поэтому ничего кроме теста на пользователях нашу задачу не решит поэтому мы вспомнили что мы делаем шесть миллиардов запросов и 520 миллиардов сутки просто за картинками давайте посчитаем распределение мы помним что средняя обманчивым посчитаем перцентиль посмотрим для цепи время исполнения там делать позади только 8 секунд по птс там на нашем протоколе это два он сократился аж до четырех не видно что распределение сместилась более быструю сторону хорошо давайте посмотрим что с лентой посмотрим время исполнения запроса ленты найти себе этапом понятно штанги установка соединения она не быстро вот и там где взгляд перцентиль прям 12 секунд дожидается даже вот мы его смогли сократить до пяти то же самое по мере листа мы из такие большие ленточной картинки и получили тоже схожие результаты в принципе неплохо даже средний изменились процентов на 10 20 если смотреть какие-то конкретные регионы там даже на 30 процентов быстрее мы можем доставить чем tcp который у нас заставляет в обрезанном все неплохо в москве ускорение очень большой 35 процентов ну давайте посмотрим как что еще влияет на продукт если почитать насколько мы сократили ожидания в пользователя в день то это 4 тысячи часов в день мы сэкономили вам времени у нас и таймкилер поэтому на самом деле от того что мы сэкономили они не пошли ничего стирать гладить они на самом деле просто их потратили у нас в приложении и мы получили рост активности по с кровом ленты пастор там и так далее то есть вроде бы цифры сходятся сейчас у нас больше 20 миллионов пальцами на этой штуке заведено мы отдаем только короткий только шахтером трафик там про больше 120 гигабит в секунду в пике 15 миллионов пакетов в секунду сил 18 серверов до performance конечно люди пион раза в четыре ниже чем те цепи с той же самой машины то есть за счет отсутствия оптимизации карты там лач сегментов лорды всего остального но это нас вполне устраивает что еще хочется сказать если вы хотите за перед свой сетевой протокол сначала для чего вам нужна лента или мессенджером вы передайте короткие сообщения или у вас video streaming и вас на самом деле квебек и беаром спасут мой крик с бибером спасут или там загрузка файлов или еще что-то перед тем как об щепки да ты что-то делать соберите профиль нагрузки посмотрите что у вас специфичного есть приложение что можете зацепиться соберите этот эмулятор посмотрите на эмулятор за счет чего можете быть быстрее ну и конечно использовать продуктовый статистика b чтобы не обманывать себя каких других тестах а это стандартный чек лист помните что надо пить пакеты помните что есть in the uk а века и у нас им тут еще 350 потому что 99 процентов сетей поддерживаем тут и 450 во вторых можно пакет фрагментировать все будет работать помните про исправление ошибок помните про flow control conditions control не забывайте добавлять такие прозрачные штуки как айпи мигрейшн если у вас у телефона поменялся и пинали тут и в общем много классных вещей помните что пользователи обычно обратный канал простаивает его ваке можете пихать времена можете подписать огромные маски все что угодно вас есть куча свободного канала как это все вообще будет развиваться на самом деле хороший универсальных решений нет то есть здесь и пивом вообще решает все ему с этим точно не справится поэтому того чтобы усилить всегда можно использовать статистику действительно как и клауд в я писал в своих статьях когда комп включается поле стиль вы знаете что он в каком-то конкретном регионе сейчас там такая-то ситуация сети можно очень быстро все запретить что мы еще получаем все борются за сеть все больше и больше нагружают пакетами маршрутизаторы рано или поздно можем куда-нибудь в нехорошая скатиться есть кондишен control и которые позволяют явно уведомление от масштабов по перегруженности получать и с этим работать они достали сейчас поддерживают это на ими никто не пользуется что еще интересно когда переходите на youtube и у вас из коробочки получается пир toupper это прикольно если вы там не знаю хотите какие-то не знак звонки может быть messenger пир toupper устроить между клиентами на самом деле эдипе вам позволит даже для поле срезана там их как то так или иначе соединить вчера ко мне пришел мой друг на самом деле надеюсь нам здесь в зале вот спросил сушат и не евангелист часам вот и ну тут я расскажу что я вам ответил вы можете взять наше приложение у нас на три четверти пользователи android это раскатано вы можете взять его подключить его о себе к ноутбуку посмотреть в жарком штаны dippy трафик можете включить шейпер сравнить его с конкурентами посмотреть загрузки в плохих сетях и если уж вы случайно попали в те 25 процентов выключена возьмите посмотрите у соседа тогда ваша вероятность будет вообще 6 процентов что нет если все плохо напишите мне я по вашей кишки вам это включу ну уж вдруг что то не так а выводы про что мы сегодня с вами говорили мы разобрались когда нужно ускорять сеть когда вы уже все оптимизировали и так далее мы посмотреть чего зависит скорость в интернете и поняли что не все стыки тисе пи одинаковы ну понял что можно что-то подключить подкрутить быстро и получить с этого перформанса мы посмотрели про подходы того как это делать детально мы заметили что очень есть крутой трюк с оценкой узких мест перед тем как оптимизировать ускорять замедлить и посмотрите на что влияет может быть никто не заметит ваше ускорение мы посмотрели как зарождался интернет узнали как работают все эти потрогали и даже руками ну и на самом деле мы наверное верим что будущее за юзер спс протоколами которые анализируют статистику и как ты с этим работают если вы прослушали что вам делать 1 через поставьте шей 1 shark посмотрите на вашу сеть посмотрите как ваше приложение работает посмотрите не знаете у вас в посмотрите на вебе мобильный телефон подключите к ноутбуку посмотрите как он может быть вы найдете там лишние данные может быть лишние установки лишний round trip а еще что-то соберите низко растущие фрукты скорее всего это вам позволит получить реально серьезный boost если хотите делать все узкоспециализированные протоколы не надо переписывать я перепишу тисине перепишите вот если у вас на это нет ресурсов то на самом деле просто следите за тем куда катится мир это реально интересно можно пахали варить потом обсудить команды протокола на самом деле очень маленькая у нас на самом деле иван булычев единственный разработчик которые вот это дело но сначала на джаве прототип но и потестили потом переписал на плюсы и клиент-сервер вот так что на самом деле если у вас есть очень узко задачи вам не нужна огромная команда для того чтобы решить это и не бойтесь куда-то лезть с этим делом там против каких-то больших крупных решений даже если вы пришли в последний момент и можете запомнить только одну вещь из этого доклада вспомните что боритесь за скорость это иногда приносит результаты спасибо с вами был александр боритесь за скорость и расскажите полтора доклада за время одного спасибо большое у нас есть время на 2 вопроса задайте вопрос который волнует всех вот вообще всех вот смотри вот да давайте вот вот да да готов да смотрите уже бежит мандарину fakro держит скажу что здесь есть почта есть в течение недели на эту почта написать любой вопрос что вас там случилось непонятно еще что я обязательно отвечу после конференции одна неделя ответов на любые вопросы тайм-аут в одну неделю дарю давай здравствуйте у меня вопрос данную вы в плен тексте отправляете еще раз данную в плен тексте отправляете ли шифруете данной конечно шифру ему некоторый аналог tls а свой но в общем да что то похоже мтс хорошо еще один вопрос который волнует всех ну смотри как поняли как на доступа было вообще не было вот-вот мужчина у попова вся смотри так а ты иди сюда на сцену прямо бегом давай что времени тратить у меня в военно дать трансляция вот зажги вопрос ведутся ли какие-то работы потому чтобы изменить поведение с эдипе там типа и de peche иксом of lading сделать и прочие или вообще ну в мире есть какое-то направление в эту сторону ну вообще есть конечно и направление в плане пачек linux уже процессе в к ядру есть которая оптимизирует работу люди пьют то есть google в эту сторону работает и стильно можно в принципе накатить патч который позволит вам ускорить работу свдп есть реально эти решение есть если вы посмотрите мой предыдущий доклад нам даже ссылки найти решение были отлично отсылка к архиву пожалуйста спасибо за доклад скажите у вас в вашем протоколе количество пакетов увеличилось в итоге или уменьшил это вот очень потерял это отличный кандидат на лучший вопрос почему вопрос да потом может производительность всего оборудования меряется в пакетах в секунду они в бен 2g да я ответственно напоминает ситуацию с торрентами когда они хотели сделать лучше производитель сетевого оборудования от этого вешались потому что в количество пакетов увеличилась отлично мы на самом деле за счет рейд лимита пытаемся держать там packet loss меньше десяти процентов там средний порядка пяти процентов и действительно мы эти пять процентов пакет лосс нам протоколе по то есть у нас сильно больше чем у тисе пи средний пойдет лосс плюс 5 процентов отдаем до сюда по 2 прим это я забыл просто сказать действительно хорошо не уходите и вы уйдете с кружкой из книжкой за спасибо большое для тебя тоже есть подобные призы сейчас мы вручим трансляцию передаем в кулуары да и спасибо большое за доклад"
}