{
  "video_id": "zgzwXNc7L8s",
  "channel": "HighLoadChannel",
  "title": "Как и зачем создавать NginX-модуль — теория, практика, профит. Часть 2 / Василий Сошников (Mail.Ru)",
  "views": 602,
  "duration": 3036,
  "published": "2018-08-16T03:54:55-07:00",
  "text": "а им привет же расскажу чуть больше именно том что в этом году мы сделали используя джилекс то есть по сути это логическое продолжение доклада который я начал год назад краткая джента первое я расскажу о том коротко о тебе расскажут прошлом году далее я чуть-чуть углублюсь в об стримы и ну так и за вами proxy finder и то есть зачем они нужны как с ними работать 3 я расскажу о очень как-то болезненный теме о том как преобразовывать контент на лету 4 коротко шерп memory зачем она почему она как и можно использовать ну и напоследок я расскажу о том как в этом году мы сделали аналитику биллинг и умное каширования для осетин видео используя по сути только engine x коротко о чем я говорил в прошлом году я говорил о том как устроен и джон ix архитектурная и вот этот слайд он хорошо иллюстрировать то что и чем является engine их внутри яндекс как матрешка то есть существует карма долл в котором находятся все самые основные библиотеки для работы с сокетами доработки shared memory для всех основных системных функций второе на этом core module и уже построены дополнительные модули это хоть и т.п. mail up stream engine их скрипт и другие но и самая верхняя часть это те модули которые можно разработать для джен x на самом деле вам ничто не мешает разработать воли вас к роли модуль то есть на уровне ктп скажем подержать какой-то собой протоколы в engine.exe есть определенные как сказать такой негласный code style так чтобы любой человек который разрабатывает модули либо ещё что-то понял о чём ваш модули о чем ваш код первое это принято использовать так называемые префиксы engine x далее новый имя куска модуля домов ключик от т.п. имя вашего модуля а ну а дальше соответственно уже какие-то опасной части нам там увидите пример типичный то как выглядит конфигурации для моды и вот то есть существует несколько видов конфигурации принтеру ему модулей вот в engine.exe все построено на одном интересном поттер не это chain of responsibility другими словами представьте что то тут маленький человечек делает запрос бенджен экспорт т.п. этот запрос пройдет через какой-то chain модулей после чего самый последний модуль вернет ему уже готовый ответ количество таких модулей в цепочке ничем не регламентирована их порядок тоже ничем не регламентирована самом деле в случае статической сборкой только то как тем как вы собрали эти модули воду под ближайшая аналогия это вот смотритесь внимание кто знает баш кто пользовался гриппом вот поймет что такое chain of responsibility вот это по сути то как работает жены кстати это некий pipe который выстраивает последовательность потихонечку исполняя следите за тем чтобы все участники правильно обработали запрос после чего в конце вернется какой-то результат также в engine.exe помимо того что все строится на идее членов посадили войти существует еще набор false false там достаточно много о них я детально не буду говорить то что игры в прошлом году но коротко упомяну в каждый такой модуль он крепится какой-то определенной фазе исполнения таких фас их как я искал несколько другими словами у нас внутри несколько несколько таких чейнов в рамках каких-то фас ну и вот я сделал небольшой скриншотик это те фаза которые сейчас сегодня уже доступны в engine.exe на которой вы можете повесить какие-то свои хендера которые делают какую-то определенную работу ну и ссылочка на файл где их можно посмотреть в большинстве случаев там в 99 процентов очень даже случаев все используют на самом деле 2 3 фазы отсюда либо фильтры ну и поскольку в инженеры все члены то соответственно буфера там построены тоже по принципу chain с правой стороны то через левый для вас вы видите то как выглядит буфер в engine.exe типичный и он объединен в чем другими словами в любом вашем обработчики вы не уверены в том что вам либо запрос либо ответ придет придет едином пуске буфера как правило это куча маленьких раз разбросанных буферов которые срывом как-то надо работать причем они могут быть совершенно разными в случае если это file to las соответственно определенный флаг ставить случае если ты memory тоже природный флаг если вы будете разрабатывать под engine x либо уже разрабатываете то выход будете знать эту структуру хорошо либо уже ее хорошо знаете это по сути основа обработки любых данных внутри engine.exe а теперь подойдём к после этого краткого введения к самому интересному то о чем я не рассказал прошлый раз а именно all bad стримах либо proxy finder ах давайте начнем с анатомией зачем это нужно кто-то пользовался прокси по сам когда-нибудь думаю да безусловно наверное все вот прокси пас это типичный proxy finder его задача очень простая принять запрос от клиента как-то его прям преобразовать и сбалансируете вон спроектировать его на какие-то уже бэг-энда ваши которые работают по протоколу http или https вот так же доступны несколько дополнительных режимов первое это keep-alive модуль ну плохо балансировать на бэг-энда bisque пола его потому что каждый раз будут новые коллекции давать 2 существует совершенно уникальный тип баланс тиков типа кэти стенках balancing либо в случае если вы используете open растили были слова вы даже можете написать кастомный балансира вот это по сути и есть так называемый прокси в proxy finder и баланс хендера вот ну и плюс keep-alive модуль его рекомендую всегда использовать с любым с любым так скажем пупсик ембером и как и любой и модули существует три стадии как говорится к психологии только здесь все проще первое это вы должны инсталлировать свою модуль то есть сказать их жены ксу о том что существует такой модуль второе вы должны зарегистрировать директиву новые выражен x конфиге потому что ну все мы хотим конфигурировать наши модули это вполне логично потому что мы все хотим использовать up stream и передавать блок серверов и так далее вот но и добавляем новый рендер которые непосредственно будет уже какую делать какую-то полезную работу в данном случае пример который вы перед собой видите это как раз все эти 3 фазы 1 мы используем совершенно стандартный механизм реджины то чтобы зарегистрировать свой собственный новый рендер данном случае я взял пример с его open source модулей в уста за фигачил немножко сократив первое это мы сказали edjing существует некая 9-го тнт пас на аналог прокси пас второе мы сказали что существу что этот хамбер выглядит так и внутри этого хендера когда в конфиге она срабатывает у нас по сути регистрируется новый обработчик но текущие там условно контекст shelving сумку сексуально зависим молод но дальше веселья мы в начале зарегистрировали у нас появилась новая функция с которой будет которая будет соответственно вызываться при каждом request и что за функция должна вызываться тот чуть посложнее в данном случае как вы помните здесь мы в строчке вот где троечка подсвечена зарегистрировали хендлер а вот здесь вам уже вызывается на каждый request он на самом деле под номером один здесь и вот здесь вам хорошо видно хорошо и вот здесь на самом деле самые интересные и сложные моменты первое для об стримов не достаточно зафиксировать только один hander up stream а эта часть core функционала ну engine.exe вы должны ему навесить дополнительные калмыки в данном случае первое вы должны а первых вы должны получить весь список об стримов которые сейчас доступны потому что вы можете ваш портили может использовать keep-alive модулю и тогда up stream они будут создаваться они будут браться уже из готового пула второе вы должны зарегистрировать новые хендлера здесь данном случае не отсутствия тоже это очень много кода они на самом деле все находятся функции и нет handler's ну базовый она выглядит следующим образом что у нас есть crate request его задачи то что простая когда у вас пользователь сделал request ох и ттп кукла то вы должны этот request что-то преобразовать в случае допустим с тарантулом он преобразуется в мистер спок эту мысль шпак структур чтобы отдать ее тарантулу далее hinterland request но по сути это rise to request of случае если что-то пошло не так после чего второй раз будет вызван клеить request дальше аборт request hander его задача начну простая в случае если клиент дропнул connection вам надо как-то правильно что-то очистить вот либо не надо если вы используете джин x full touch the engine и все это сделает сам мухина лайс request нужен случае если вы уже все закончили работу над опять же что-то почистить если вы использовать кастомную память вид кастомные вообще finder памятью еще что-то ну и подходим к обработке контента это самое интересное вот мы создали request он ушел наш backend в нужном нам протоколе или формате и нам теперь надо обработать ответ потому что ответа от бэг-энда он допустим если это них это т.п. если какой-то бинарный протокол будет в бинарной форме нам его надо на лету преобразовать в нечто в нечто похожее на хдп скажем джейсон вот для этого существует три обработчика они даже здесь описано на самом деле их регистрация первое это очень это смотрели защита лишь два обработчика 1 т а к тексту обработчик первое это фильтр и нет его задача просто инициализировать какие-то вашу внутреннюю структуру он вызовется перед тем как у вас начнется фильтрации ответа от бэг-энда второе это input фильтр и вот он зараза самое сложное что только может быть в этом коде объясню почему помните что в engine.exe все в членах и у вас нет гарантии что вам придет ответ от вашего бэг-энда в одном буфере вам даже вообще даже не знаете в каких буферах она придет более того если от определенной администратор за configured in жены с определенным образом вас то может прийти в одном буфере здесь я эту логику не стал показывать как она работает но там чертовски сложный потоковый парсер асинхронной который еще держит себе несколько состояний вот так вот типично выглядит любая обработка или жены контента внутри engine икса вам нужно написать свой стоит машина весьма сложный асинхронный и желательно так чтобы он не ел engine и с буфера потому что они не бесконечны и отсюда рождается очень полезное правило если вы понимаете что вы не можете что-то сделать нормально на пол локаторах engine.exe внутри ваших обработчиков то смело используйте малакка lock free это нормально по крайней у вас будет уверенность что у вас engineers не упадет с отсутствием буферов потому что chain буферы они тоже конфигурируются скажем администратором и он может элементарно поставить их очень маленькое число и от чего у вас будет отказ но обработки элементарный вот так же надо помнить еще одну важную вещь что ответ от вашего прокси всегда будет находиться в структуре апстримом то есть у вас не будет привычных в случае фильтров какого-то in буфера у вас всегда конкретным ops 3 му прибивается конкретный очень буферов с ним вам придется работать а вот теперь перейдем это сейчас был кейс когда нам надо обрабатывать преобразовывать контент на лету в случае up stream автомата в принципе логично даже архитектура к этому располагает но важен и все есть другая возможность у нас есть понятие там фильтров то есть вы можете фильтровать любой контент как вы его хотите можете при желании добавлять туда код динамически скажем javascript код не знаю зачем но это возможно но это вызывает огромные проблемы как правило и более того по практике еще и нестабильно работает в праге и я попытаюсь объяснить как сделал чтобы это стабильно работала в праге я не буду говорить о асинхронных потоковых пар сферах это отдельная тема для дискуссионные причем я если скажу о нескольких правилах которые надо соблюдать внутри engine.exe чтобы ваш фильтр работал постоянные как часы начнем с анатомия что такое body фильтр представьте что у вас есть линия call back а в которой просто вызывается на ваш тел ну на тело запроса или ответа их количество не известно скажем завтра админ добавит еще один один фильтр в самое начало configure джон xa но у вас он встанет как самый первый фильтр который вызовется вот это то как выглядит допустим если мы хотим сделать новый фильтр мы добавили в конфигурации все начали компилировать это и естественно перед тем как мы это добавили нашли капитана узнать как это делается этот те же этапы первый этом installer мы должны проинсталлировать наш фильтр для этого надо принципе достаточно завести обычный модуль и на его пост конфигурации просто добавить в этот глобальный список этих хендлеров соответственно наши обработчики данном случае здесь их 2 это хедер и body новых ядер нам не интересны фильтр на матери столько body фильтра поэтому здесь правила которые надо всегда помнить одно что у вас нет никаких гарантий когда он будет вызван единственно гарантия это ваш администратор который собирает engine x если он что-то изменит и поставить по-другому то логика работы может измениться радикально к пример он может поставить gzip фильтр перед вашим модулем а ваш модуль к этому не будет готов естественно если вы преобразовываете контент и у вас есть парсинг и прилетела gzip данные то ваша модуль скорее растеряет совсем к этому не готов об этом надо помнить всегда и следить а вот теперь обработка контента с ней посложнее и вот здесь я взял пример на самом деле идут буквально и своего недавнего проекта вот это то как выглядит по сути обработчику мне достаточно просто лаконичные понятно то есть но вот под этой функции которое производит фильтрацию вне спрятан наверное тысячу строчек кода для преобразователей со некоторых определенных строчек внутри м38 файла вот но выглядят принцип все просто и понятно и о чем стоит помнить случае если вы пишете такой фильтр первое помните что все chain вам приходит все кусками может и одним куском ваш партнер должен быть к этому готов он должен уметь держать состоянии он должен уметь правильно перехода делать между ними второе из у поскольку у вас пришел чейт который вы же и меняете без копирования условно у вас может появиться такая ситуация что у вас какой-то кусок буфер останется пустым ну как пустым вы какой-то причине скажем за реплей сильно столько что у вас от какой-то chain буфер вообще в нем 0 данных во мне то его смысла отдавать клиента таком случае надо помнить что у жены кэс буфера есть специальные опции для этого синко равно 1 если вы не поставите клиент получит ошибку и вы увидите в аль ортер логе информацию о том что у вас пустой chain brighter джинкс это очень не нравится как я и говорил ранее в случае об стримов так и здесь иногда логично использовать малак realloc и free чем использовать engine x овский chain буфера потому что не кончаются и вы можете просто за этим не проследить у вас может быть конфиг другой и просто не бояться их использовать сразу скажу что добавляйте кучу дебага мужчины вся отличные логирования прям не бойтесь добавляйте на каждый чих потому что когда она стреляет вроде она стреляет вроде вопрос скорее вопрос времени просто вам нужна будет эта информация чтобы понять почему стрельнул то что у себя вы это скорее всего не воспроизведете вот ну и важное правило которое сказал самом начале результатам работы предыдущего фильтра может сломать результат вашего работы вашего фильтра и наоборот ваш фильтр может сломать результат следующего фильтра поэтому надо продумывать все для мельчайших деталей это тоже очень важное правило здесь на самом деле еще одно правило забыла отметить поскольку в engine.exe уже есть при лазурный chain буфер и вы с ним что-то сделали поиграли с ним возможно даже скопировали надо помнить что его надо освобождать лошадь и это не опция флаг флаг которая там была вам надо просто там буфере присвоить по сути сказать ему о том что лес травин старту тогда придет реально флаш если вы это не сделаете вы обнаружите что у вас почему-то engine x какого чистку это время перестал обрабатывать запросы просто встал ну обычно просто у него кончились буфера он не знает откуда взять новый чин буфера надо помнишь вода постоянно флаша что то что вам не нужно вот теперь перейдем к ширад memory нужны все есть такая все же знают архитектуру engine.exe что он for кольца и у него там сколько товар киров и бывают такие ситуации когда эти маркеры должны общаться между собой когда они должны иметь какое-то состояние и для этого по сути существуют shared memory то есть ну она там видеть весьма простая у вас есть несколько engine x worker of и вы можете использовать общий жертв memory чтобы общаться между ними условно хранить какие-то состояния очень полезная вещь которую но на самом деле много где используется в том же цель модули для для из отеля коннектов чтобы круг широва тяни платить на каждом warcry отдельно но также у них есть одна скрытая особенность вы можете взять engine x взять эту афишу перенести на свой демон и общаться с engine их сам из своим демонам cherished memory это на самом деле немножко черный пояс нужен в принципе от хорошее тоже к из я так использовал очень даже понравилась потому что условно у тебя 51 не надо ничего городите скорость работы фантастическая я не стал писать о папе широт memory она там просто я там действительно ну очень она простая поэтому решил сразу не углубляться и перейти к реальности а именно о том вот проект текущего года а именно сидели видеоаналитика и кэширование в нем а вот теперь самое интересная задача задача звучит так представьте что у нас уже есть некий его вуза медиа стрим сервер который очень медленно и очень дорогое по железу и просто перестал справляться с основной работы и и о за и задача такая надо ускорить его работу путем кэширования в печь серверах которые engine x но без потери функциональности поясню его функциональности помимо того что он вещает лср темпе или еще или дэш trim пользователем он еще делает несколько важных функций а именно он делает биллинг то есть учет сидел трафика который был отдан 2 в нем есть tracking пользователей он условно сессии просмотров смотрит и 3 в нем есть аналитика ну по результатам этого треккинга выкладывается аналитика какая то вот эти три основные функции которые надо сохранить и вот оно решение в лоб может быть кто-то из вас назовёт какие в нем есть проблемы любовь и от хорошего проблемы там они тоже были но нет кэширования все верно немножко поясню а как работает вообще live streaming либо виа де streaming начали пользователь запрашивает м 3 и 8 и 8 файл в котором будет большой список стримов после чего эти стрима попадают к вам плеер начинает проигрываться вот почему раньше волосы могла делать 3 функциональности потому что это была единая . куда сливалось все а в случае если мы начинаем это кэшировать на и серверах запрос туда просто перестают идти физически вот плюс дает банальная проблема для любого сидя на ли вообще для любого проекте тэн валидация каша я думаю все с ней сталкивались из вас и боролись по-разному но тем ни менее архитектуру мы определили вот она в ней есть проблема но мы теряем аналитику биллинга tracking сразу то есть все эти три вещи исчезают потому что условно учитывать трафик уже невозможно потому что он начинает размазываться непонятно как xs логов недостаточно объясню почему потому что уже есть куча пу который умеет работать с скажем так с определенными лагами волосы то есть это надо тоже будет переписывать плюс надо будет аналитическим но xs логин же носки как-то допиливать поэтому эти три функции теряются что нам уже не подходит поэтому придумали более правильное решение решили ну архитектура осталась такая же но решили добавить несколько нюанс ну так скажем дополнение к ней первое это добавили tracking пользователей на фронтах и к количество их может быть огромное именно вот маркировка и условно маркировка этих пользователю словно производство определенных лагов и 2 ну с на два специальных тагирова ней tracking пользователя по трекингу же на самом деле биллинг строится вот как это выглядит в реальной жизни на самом деле очень грациозно даже пришлось очень простой модуль написать вот представьте себе вот эта конфигурация сокращенная франта если вы заметили в ней появляется одна забавная вещь совершенно идеи это совершенно идея это по сути небольшой модуль engine.exe который умеет определять по углу о том что этот пользователь уже в роли промаркировал с или нет если про парковался он добавляет туда уникальный url объясню зачем дальше это идет в кэш или в эйдж ой потом возу на м38 файл его vsa сама концу угла добавляет вот эту уникальную сессии после чего пользователь уже запрашивая там файлы видео или дополнительным 38 файла всегда ходят с этим потому что это во всех местах промаркированы совершенно идея вот ну в этой схеме я замечу м38 файлы которые запросто они не кэшируются то есть каждый запрос на эти файлы он идет в лозу и вам за это умеет делать и того схема выглядят вот таким образом то есть у нас есть get плейлиста если вы заметили он вначале идет без play без саши найди он идет просто стоки нам что он может условно взять ресурс этот сайт или нет далее когда это поступает воздух добавляется туда саша найди после чего вз и уже добавляет в контентом 38 файлов это совершенно еде вас чего этот пультик гарантированно будет приходить с этим совершенной де в рамках вот своего вот этого просмотра вот ну и логирование угроза была изначально в таком формате с ним ничего не делала она достаточно понятна есть два типа logo это x и слог analytics лоб задача x и слог это по сути делать белен потому что в нем вся информация всем трафике задачи аналитик слог это как называется иметь возможность построить аналитические отчеты сколько польши смотрела тайну или иное событие и так далее там самая проблема была это сделать это сделать tracking события той что пользователь начал сделаем начал смотреть про начал смотреть там условно какой-то стрим что он че это он просто получил м38 файл что просто закачал его что начал смотреть что остановило ли что сессии вообще умерла вот это была самая большая проблема для аналитических логов для x из логов она не нужно вот так вот выглядит процесс полностью сбора этих логов той смотрите у нас есть engineer фронт который постоянно с помощью shared memory общается с некой лучину с неким демоном который висит в этой же системе задача этого демона это по сути контролировать вот эти сессии которые к нему пришли чтобы откладывать xs логе также его задача твой аналитические логе а также задача откладывать exo слоги постоянно вот он за счет складывает файлы после чего уже был готовый сборщик агрегатор всего этого добра который был ранее написана для взрыва задачи эти файлы со всех и j собрать сделать агрегацию а дальше сохранить это в субботу который и графический интерфейс которая система отчетов о всех слоги идут просто в биллинг то есть достаточно простая схема единственный нюанс поскольку количество еще серверов стало огромным то возникла проблема мы не знаем на каком из них сессии умрет гарантированно она умирает на нескольких ну то есть представьте себе что у нас в round robin и она идет на неизвестное количество фронтов вначале он сходил на один фронт там у него сессия зародила в том силу другой взял другой файлика там нас тоже эта сессия зародилась play start будет один потому что только по запросу у плейлиста происходит это событие а вот destroys the будет несколько данном случае поскольку мы говорим в аналитике здесь все равно просто в рамках одного дня вот это все дело с режется если destruction другой день ну все равно бы саму цифру за текущий день в аналитике получим на биллинг на x слоги это никак не влияет там эти события вообще не нужны там нужен просто трафик нужен урок по сути трафик который был чину про который прошел через этот url решена но вскрылись недостатки вы не поверите вол за после того как начали сокращать количество их инстансов значит и машины делал стадии стали делать более слабыми она началась а чувствует плохо и страшно запросы м38 файлов остались она просто перестала нормально отвечать и работать у кого-то есть предположения как можно решить эту задачу у нас достаточно просто мы можем за каширу тем 38 файлов но есть одна проблема если мы visa cash & ruin токены которые пришли с углом и хранятся в м38 файлах они останутся от другого пользователя и совершенно идей останется тоже от другого пользователя другими словами это будет шины консистентные данные вот и поэтому было принято волевое решение по быстрому написать модуль который позволяет делать риф райт данных внутри каша при запросе к нему на cache серверов вот при этом м38 файла кашу из очень маленький intel внутри engine.exe это важно потому что в life 3 bengi эти файлики могут очень часто меняться голод и с точки зрения конфигурации для администраторов а сейчас выглядят следующим образом то есть добавился новый фильтр body фильтра которыми говорил раньше который по сути фильтрует контент также у него есть несколько правил дополнительно точнее директив которые позволяют некоторые параметры не фильтровать но этот нужно было по требованием потому что есть параметр который мы не хотим превратить вот то есть что этот модуль делает он на лету парсит м38 файл смотрят эти строки вычленяет оттуда куски урла который надо евро идут на те которые пришли из запроса и делает риплейс параметров или это выглядит следующим образом как видите у нас все осталось примерно также у нас опять запрос плейлиста идет но он летит уже него взор кришну в случае если в кэше конечно после чего отдается файл не в оригинальное видео ривай перезаписывается все аргументы внутри этого файла вот этих чанг листов файлов но ссылки на них таким образом эта система начала нормально работать вот я добавил несколько ссылок которым возможно вам будут полезны первое этот уриал которая составила прошлом году по yandex модулем а вторая ссылка этот код моего ops 3 модуля которой есть гитхабе я из него примеры взял когда говорил об обстрелах вот мой самый классный ресурсы the engine x-com это вики всех third-party модулей там на самом деле решены почти все проблемы человечества а если они не решен это можно как-то что-то решить и туда закомитить вот но естественно исходники engine x и всегда надо читать если вы пишете подвижен x это очень важности вычитать и исходники engine x а скорее всего ничего не получится но и информации о чем том что такое live streaming в принципе вот черт я быстрее чем планировал наверно чет пропустил ли забыл но вы можете задавать вопросы кстати вот мои контакты в принципе если лодки это вопросы принципе ли тут могу посоветовать обращайтесь спасибо василий вопросы спасибо за интересный спасибо за интересный доклад у меня знаете вот какой вопрос возник вот касаемо очередности исполнения модулей до которых шла речь с одной стороны вы говорите что они выполняются в произвольном порядке с другой страны что их очередность выполнения контролирует администратор джинсов то есть все таки где здесь правда поясню а если вы используете статические модули скажем те же фильтра и у вас в министра таркан фигурирует ваш engine x он там прописывают эту модуль это модуль еду модуль вот прямо в configure и это есть очередность и он может где-то ошибиться у меня просто такое часто бывало что мой модуль скажем так или что-то разносила когда просто ну он добавил фото своем начала или в конец спасибо за доклад такой вопрос а вот насколько я понимаю самим модульный джек достаточно такая трудоемкая операция если какой-то набор решений для тестирования вообще модули как убедиться что у меня могли не течет если что-то вы собственно для этого или все по старинке руками самому и так далее хороший вопрос есть много несколько методологии к примеру большинство моих знакомых использовать первых нету там есть фреймворк для тестирования engineers написаны на перле и в принципе он хорошо работает но мне он не нравится потому что не люблю 1 я поэтому пишу все тесты на питоне волод можно писать на каком-то другом языке просто тот вопрос какой если нужно июня тесты вот чудо внутреннего то безусловно только вот тот способ который искал 1 напирали писать если нужно просто функциональное тестирование которого по моему мнению 90 процентов достаточно то можно писать на другом языке спасибо за доклад если какие-то ограничения для модулей то есть условно я не могу там занять больше чем там 205 6 мегабайт условно или еще что-то или я не могу лезть все эти либо какие-то внешние сервисы нет есть ограничение только логически могу пояснить если вы лезете во внешнюю сеть используя ваши собственные соки the eleventh брайн какую-то машину то скорее всего вы этим будете очень сильно тормозить engine x поэтому идеально если вы в есть во внешнюю сеть использовать engineers кепи для работы с сокетами вот насчет памяти большинстве случаев если вы используете внутренней памяти jin xuan буфера вообще chain целиком поможет вкус проблема что они кончились кончились потому что администратор написал что их мало в конфиге и при старте люксах уделял мало поэтому говорю тут надо смотреть писать четкую инструкцию но ограничение общение каких нету ложечку гонтом делать но конкретный пример мне нужно допустим какая то конфигурируем а я прокси которая используется для тестов для условно тормозящего бэг-энда она мне написано сейчас на джаве просто потому что нам стать быстрее чем разбираться с джинсами так далее то есть есть теоретически для того чтобы мне поднять какой-то rest интерфейс для восстановления каких-то конфигурации так далее мне никаких не будет ограничений страны и джинса я могу просто написать программу которая будет по сути standalone просто за пильный джинс на самом деле для ваших целей даже круче парней за джон их сделали engine x2 которые называли почему-то engine x же него назвали это плюс нет и джинкс + 3g на x плюс вот который игры с junit юнит вот что вы хотите сделать можно сделать на нем я его правда не трогал еще но по-моему на нем это можно сделать то есть это также next он всё-таки умирает потихонечку в камере вот и верю и будет engine x2 окей спасибо спасибо за доклад вопрос следующий вот вы упоминали молока полок вернее молока lock free это родные session и и или так open непосредственно jane exo и память выделяется средствами самого яндекса это родные session и это есть галиб session и как я говорил можно выделять средствами engine и ксана можно столкнуться с проблемой в том что администратор на configurable так скажем а можно использовать молоко лак и фри и из новым если работать с ними и так и так нормально как лучше не знаю парней за джин x тоже как я понял не особо знают как лучше итак итак можно там надо понимать что мало aloka lock free и вообще галиб session ее функции до добавят дефрагментации лишь и внутри джин xa но что engine x в принципе работает по принципу слабо локэйшн то есть он выделил кусок дальше раздает всем кому надо если кончилось ну сорян поэтому надо об этом помнить все хорошо спасибо спасибо большое за доклад у меня вопрос по вашему примеру с сессиями как вы проверяете то что пользователь не подменил совершенно идеи стране engine x где кэшируется эти запрос алгоритму специальном то есть наша сессия вот это вот скажем так строчка она имеет определенный формат и и подменить можно но сложно надо знать алгоритм либо догадаться о нем по сути она стоит там из четырех частей если какая-то часть неправа лидера валось но когда он начинает уже парсить то соответственно генерируется нового и сессия привет пришло время заступиться за администратора который на карте горилла он значит сидела буфера поверял там по три пойти к с каждой стороны весов добавляла а потом пришел программиста кайдо но мы их к короче сделаю молок вот и бодяга вопрос ты какими трушке оставляешь для своего модуля что им то тоже можно было крутить но это все не просто can i do но обычно я никто в документации пишу и в примерах не используя еще даже более того если вот короче вот примерно типичный квестом тарантул джин из ops 3 модуль к в нем проблема я без понятия какой размер получится на выходе я без понятия сколько надо выделить там или иначе вообще ничего не знаю почитать невозможно потому что по кусочкам и хочу собирать буфер и там очень много хаков элегантных там есть такое понятие как memory мультиплеер надеюсь никто никогда не узнает там есть свой собственный стек с а локациями который ограничен поверх нижней границы он тоже configure надеюсь об этом никто никогда не узнает вот и таких костылей обычно очень много и вот насчет м38 файлов там тоже очень много таких же костылей и ручек о которых здесь никто никогда не узнает но они сделаны специально потому что она может долбануть когда-нибудь где-то я просчитался условно то есть доставляется безусловно как же без этого здрасте спасибо за доклад очень интересный пример мне понравился а можно вот два вопроса по этому примеру чуть переключить да если можно даже можно остановить и меня когда надо будет сейчас смотрите первую просто чуть взгляд сверху потому что это не совсем так глубоко важен exe понимают для мигаль там для архитектора просто это некий building block который можно использовать для того чтобы решать какие-то верхние уровни вы задачи вот здесь вот какая задача правил прямая что здесь задача была в первую очередь построить такую схему при которой проблемы с производительностью медиасервера решались вот на самом деле дат цитата на самом деле бизнеса вот правильно я понимаю что у вас таким образом масштабируемость этого решение повышается то есть медиа-сервер офф можно использовать несколько экземпляров или просто увеличивается его ресурсы и балансировка между ними выполняется поясню здесь на самом деле действительно немножко недостаток моего рисунка надо было чуть пошире сайт на самом деле поскольку все сливалось в одну точку в образу она страдала и требовал большой машинки в данном случае и функционал я функционал там по кэшированию по трейдингу и так далее он был разнесен на бесконечное число фронтов и бесконечное число к шее по сути и оттуда нагрузка с радикально просто драматичную снизилась нагрузка на волосы после того как это решение было поставлено в прод другими словами что мне сделать когда у меня там условно мы уперлись в крыше или его фронты не знаю с целью стало много допустим в раз добавляем еще одну машинку с таким же конфигурациям и добавляемый в общей балансировщик на нее начинает все ходить происходит работа безусловно когда-нибудь эта система перестанет работать у нее есть это предел просто до него теперь дайте сложнее а при этом фронт который раздается найди и он не вы что первым или он заберу за счет чего уникальный совершенной обеспечивается алгоритма то есть все параллельно условно работающие экземпляры никогда не пересекутся да у него есть вероятность коллизии но и добиться крайне тяжело это и благо поскольку но не захотелось не хотелось водить некую gd которая делала бы краска условный секунд ломбард просто придумали алгоритм который дает очень маленький шанс на коллизию вот и последнего просто данная тема вот это как бы конкретная задача по для конкретного программного продукта и вот те решения которые вы здесь использовали там перенос части идентификации и вообще но растаскивание функциональности для того чтобы сохранить вы бы сказали по вашим оценкам это применимо именно вот к решению такой задачи для конкретного от этого продукты это там поддерживается фишками узы или это можно использовать как некий такой но более абстрактном уровне такой поттер как вот такую модель например такую верхней уровню сетевой архитектуру в принципе спасти это как патрон можно использованы новый его не придумывал я бы я понимаю виду прям именно с такими технологиями что здесь технологиями да ну то есть смотрите на самом деле две основные части первое это как раз на дефекация пользователя вторая часть это умное каширования вот умные каширы так вообще получилось обобщенная потерпим сто раз выкладываю то есть для тех кто использует м38 файлы и кэширует у и у него есть схожие задачи паре в райту контента он может модуль используется он позволяет вот с трекингом пользователь сложнее алгоритм свои уникальные уже не вынести но благо там модуль крайне простой и то есть желание его может сделать кто угодно спасибо а можно еще вопросик вопрос вернуться опять же к вопросу выделения памяти обработки модулей вы когда говорить о том что памяти может быть выделена очень много у меня сразу возникает вопрос а специфика задача в том что надо получить весь ответ его обрабатывать целиком то есть там невозможно по точная обработка там только по точной можно и целиком получить ответы обрабатывать но это простое торос плату msi то есть фактически нет необходимости все-все буфера складывать в память для того чтобы сформировать ответ вы их вы учитываете и сразу же там я прям вот именно вот как он как коралла приходят немножко с ними играешь так же отдаю весь вот прям совсем файлового но можно копить можно копить вообще свой отдать дальше свой собственный член из одного буфера тоже вариант вопрос по поводу сессии и round robin а а чему же равно / он обусловлен и зачем искать на разных новых логе по конкретной сессии почему их просто не пить то есть конкретная сессия конкретный отличный вопрос да мы думали об ассистент хостинге почему вот мили чистое уже вспомнить не могу он там был кот серьезный мотив оставили пока round robin система на самом деле она еще будет допиливаться там есть че сделать вот один из пунктов которые надо будет сделать это чем то сказал вспомнил чем проблема проблема в том что у нас с точки зрения дальше развития в smart cache но когда умная каширование архи ческой когда у тебя не каждые вот яичко штата хранит когда она все правильно размазывается этот этот алгоритм неправильной и там над по-другому вообще делать вот я вспомнил ты съешь был автором этой идее вот и поэтому когда эта система будет росло в следующей итерации развития там будет умное каширование которые уже позволит правильно находить куст нужный кусок данных окей то есть это за того что правомерно накажет возможность да сейчас правда сейчас самом деле просто классика то есть оно неэффективно это очень хорошее замечание сильно так оно и есть на другой стороны она позволила решить главную задачу вот тот серый прямоугольник но поза позволило сел так что серый прямоугольник продолжал работать и приносить деньги make спасибо еще вопросы спасибо за доклад мы услышали как минимум протри плагина и все они скажем так со своим блэкджеком мы их оками а есть ли какой-то плагин который лично вам очень нравится и на который на код которого посоветуете начинающим или желающим посмотреть даже не знаю сложный вопрос я самом деле на код ужин и куда смотрела когда начинал там в 2011 году но сюда задача были схожие похожие смотрел топ на код engine.exe а он примерно похож на все плагины плюс-минус стилистика до безумия одинаково у всех так даже не знаю есть просто посложнее есть попроще лепс простых начал такой простой технически вопросов срезать станет закончились песня мне пришел буфер кусочек буфера там на 3 мегабайта мая стать машина сказала что вот где-то внутри я должен переписать вот эти 10 байт и вместо них воткнуть 100 байт не получается нужно где то в другом месте в буфере выделить три новых мегабайты перезаписать весь кусок чтобы это сделать все верно более того поскольку там chain ты сокращаешь этот кусочек добавляешь промежуточный там ну такая логика то есть там действительно код похож на спагетти в любом случае стоит машина а иногда это невозможно и приходится просто брать копировать вещей не который есть с ним играться вот и выдавать другой чей на этот флашей полностью там уже крис bike race а переписать кусочек существующего буфера невозможно зависит от флагов иногда невозможно грустно зависит там от последовательности разных иногда вот невозможно в том кэйси что вот коллега сказал он очень хорошенько есть придумал тогда вот таких случаях особенно к там пересечения более глобальные тоже невозможно но говорю сам простой способ на самом деле эффективны как топор это скопировать все поиграться с этим отдать дальше вас не могу молчать извини если у тебя еле эфир на 3 мегабайта я тебе нужно посередине 3 батика поменять то тебе нужно выделить две маленьких структуры на в.т. точнее даже одну в существующем буфере переставить указатели на конец буфера ду этих трех батик и в одной структур ки буфер сделать свой собственный с тремя бантиками новыми и в другой структур ки сослаться на ставшей ну точнее говоря исходный буфер нужно оставить в конце из этого всего сформировать цепочку и отправить дальше не какие-то мегабайты переписывать не надо да нет 3 не надо безусловно нужно просто переписать три пойти к я и оставить 22 бункеров до и после которые будут ссылаться на предыдущий контент да и все хорошо и эффективно будет работать а то что вот переписать все это не но это канале россия конечно смотрю на то что ты рассказываешь людям и вижу что тебе это близко но по хорошему такая же не надо день я на самом деле они переписываю здесь здесь я именно все правильно делаю простой вариант как-то пору то есть это что-то начал делать условное есть проблемы создания такого вот поточного парсера скажем так потому что там кот как правило представляешь какой там кода если других вариантов и да да да да да это плохо это плохо согласен буфер в памяти с полным ответом как-то его преобразовать и отдать долги на самом деле простые там обрезание работают по такому же принципу дошел обрезал кусочек новый создал который нужен добавил ему пошел дальше та же схема о самом engine.exe можно смотреть на какой-нибудь субтитр который делает всякие преобразования там все это разрисовано да кстати хороший пример все это вопросы больше спасибо василий за его замечательный pad"
}