{
  "video_id": "9VVzu87lVbE",
  "channel": "HighLoadChannel",
  "title": "Как балансировать на «сетевом» канате под куполом тяжелой нагрузки / Сергей Зубов (CDNvideo)",
  "views": 1707,
  "duration": 1896,
  "published": "2017-07-30T00:47:27-07:00",
  "text": "сегодня я хотел бы вам рассказать дать такой некий обзорный доклад о балансировке монтировки трафика высоконагруженных системах так как доклад обзорные рассмотрим различные методы балансировки что такое блокировка в принципе различные методы алгоритма балансировки и озвучим плюсы и минусы того или иного метода вот мы давайте начнем я долго думал как начать вступление своем вот и виде мне давно начавшийся дачный сезон сказался на этом решении общем представим такую сюрреалистичную ситуацию что мы некие фермеры которые занимаются селекционной работы уводят допустим знаю вращать новый вид новый вид картофель почему сходим мы значит выращиваем если картошечку картошку нас очень классно если любят всем нравятся продаем ее на рынке и тут значит подумали подумали решили как бы нам еще найти способы подавать можно вспомнить что мы ребята с античным прошлым когда-то этим занимались селекционеры там и так чисто ушли ради хобби вот решили отдать как мы будем продавать ее в интернете вот сходи недолго думая купили сервер запилили на него в некий вид где все раз нашему интернет магазину и пошли к нам клиенты клиенты пошли продажи растут нагрузка на сера повышается повышается повышается мы понимаем что нагрузка растет серого надо тоже как-то апгрейдить увеличиваем его мощности увеличиваем увеличен клиент приходит все больше и больше в конце концов выбираем с такой ситуации что апгрейдить и больше никуда вот получается такой неприятной ситуации что год неурожайный у всех конкурентов картошка умерла она же селекционная картошка у нас на классный засухоустойчивый вот и все ломанулись резко к нам почему ломанулись так что нагрузка на север возросла таких размер просто взял и упал вот мы взялись за голову подумали что же делать начали резко гуглить и отключим такое понятие как кластеризация веришь или а чтобы нам не купить еще один сервак и не размазывать наш веб сервер по нему сходили купили поставили и думаю что с у нас будет хорошо что клиент начнут ходить на оба на шоссе сервера нагрузочку немножко выравняется и все будет отлично но после запуска мы понимаем что нагрузка на один из серверов у нас такая нагрузка на второй слева к прежним вот такая вопрос почему так происходит а происходит это потому что у меня учили не учитывают тот факт что трафик между этими сферами на как балансирует собственность переходим к основному вопросу что же такой балансировка и какие основные цели она преследует но в первую очередь по высок применяется для распределения нагрузки между нашими серверами во вторых за счет было совке мы можем повысить отказоустойчивость наша система то есть например если один из в кластере выходит из строя то нагрузка на себя принимает 2 если сможешь покинуть блокатор балансировки также достигается некая защита от некоторых видов атак например такие на откате соединение где ничего не говорится вот и балансиров как любая система к ней предъявляются некие требования требую не такие облицовка должна удовлетворять требуем справедливости то есть любой запрос пришел пришедший к нашему нашей системе должен быть обслужим они просто выражен затем балансировка должна быть эффективной то есть мы должны обеспечить такую работу чтобы все наша земля в кластере работали примерно равномерным и брали на себя равномерную нагрузку вот затем мы должны благодаря блокировке сокращать время выполнения запроса то есть время от и обеспечивать сокращение времени отклика то есть как только запрос приходит к нам и систему должны как можно быстрее на его и вам служить на него ответить бункеровка должна удовлетворять либо непредсказуемости то есть мы должны четко понимать какой алгоритм балансировки в каком случае мы должны использовать затем загрузки ресурсов системы в принципе это тревоги схожие с эффективностью и балансировка должна быть масштабируемой то есть при резком увеличении нагрузки с тем балансировки должна обеспечивать стабильную работу нашего сервиса условно борцовки различные виды было сироп можно разделить на два вида по географическому признаку то есть областях может быть локальный если у нас все расположенные внутри одного дата-центр и также была совка может быть глобальный кризис у нас на наш ресурс раскидано севера по разным дата-центров ну подробнее о каждом расскажу при балансировке на локальном уровне возможные выполнять как тут написано уже на канальном уровне использован отдельно будет ручки так и без него можно применять систему балансировки на сетевом уровне ебалась автотранспорт новый это не были такие специальные способы которые применяют при локальной балансировки был савкин канальный мой выполняется за счет следующих то есть мы берем и навешиваем на некий специализированный интерфейс всех наших серверов один и тот же айпи адрес нашего ресурса на который будет приходить запросы и из которого соответственно будут уходить ответы но на rp запас с этого айпи адреса сервера не не должны отвечать и мы навешиваем такой же ip адрес на наш балансировщик соответственно него будут приходить запросы и отправляться ответы с него и он же будет отвечать на яхте запросы таким образом получая запрос от клиента наш балансировщик выбирает по определенному алгоритму тотальной сервер который будет обрабатывать от запрос алгоритма хочу подробнее дальше расскажу вот подменяет соответственно destination маг и отправляет его на обработку на данный сервер серой его себя обрабатывает и так как мы не делали подмену заголовков на сетевом уровне то непосредственно мины блокировщик сразу отвечает клиенту соответственно вот тут к нам приходит руководства и говорит что ребят мы тут в контакте в сидели полистали всякими мб читали и понимаем что мужике совершён очень часто вообще требует и подумали мы решили а давайте-ка мы сейчас рекламную кампанию свеклы сделаем будем свекла продавать и все деньги в бухом туда вас попросим как-нибудь сходить сократить расходы на вашу классную систему балансировки мы подумали подумали решили а чтобы нам не избавиться от балансировщика но при этом прикинули как мы можем без него резать быть авторизацию можно очень просто нам необходимо превратить входящий unica запрос бродкаст на либо в мультик 1 пирог хочет делается это следующим образом все сервера просто должны на один тоже на r и запрос отвечать одним и тем же mac-адресом то есть это может быть либо несуществующим mac-адрес либо какой-то multicast и мы либо мы можем навесить этот мультик с той mac-адрес на на шлюз соответственно запрос приходит на шлюз по на наш ресурс и шлюз и вопрос размножает ко всем серверам таким образом запросы поступают на все севера одновременно и каждый сервер должен сам понимать каким образом он не должен ли он отвечать на запросы или нес понимать можно пример очень прост можно просто посадку отделения 0 сердце айпи и дальше уже там дело техники вот плюсы и минусы алгоритма лессировки на канальном уровне в первую очередь он не зависит от про таков вышележащих уровней то есть можно было насиловать нагрузку как по и степи так и по ftp так и по этом типе затем мы скачаем расходы за счет отказа от видимо будет сиропа случае если мы его не используем обратный трафик сторону клиента не нагружает балансировщик что тоже хорошо например для ешьте пик когда у нас входящий запрос как правило довольно таки легкий а вот ответ на него весит порой десятки сотни раз больше затем современных реалиях очень полезны для нас плюс это то что мы используем только один публичный адрес уличная печники нынче дорогие вот это несомненно будет являться огромным плюсом для наша система ну и такая стену способствует быстрому добавлению отключения серверов в кластере изменился стоит назвать это необходимость размещения в одном сегменте ограничение подходящий полосе в случае с разделяем модель сами так как трафик падает на все сего одновременно нагружаю наши систем и из решений применяемых использующих данный алгоритм балансировки можно назвать linux virtual server далее балансировки на сетевом уровне в принципе механизм довольно схожи с балансировкой на канальном уровне за одним единственным отличием данном случае получая входящий запрос наш балансировщик подменяет destination айпи отвесно для меня этого на тот сервер который будет обрабатывать наш запрос сера получает его обрабатывает и мы не должны и должен передать его обратно было всеобщей чтобы тот вы бы выполнил обратную подмену плюсы такого метода он также не зависит от протоколов высокого уровня полная прозрачность работы для сервера то есть я думаю что он получает запрос от клиента и работает с ними посредством напрямую миную всякие там блокировщики он не замечу и здесь так же как и в предыдущем методе мы используем один публичный адрес что тоже является самым большим плюсом из недостатков это повышенная нагрузка на было сиропчик за счет обратную трафика но соответственно каждый сервер должен ответ первичной блокировки отправить чтобы тот выполнил обратный подмен ответственно случае степенного нагрузка на было сеошник тоже будет довольно таки великой или большой далее балансировка на таз уровня здесь очень тонкая грань по которой отличает балансировку на steam на тасс но для простоты скажем что в данном виде балансировки используются при балансировать нагрузки входящий порт и источника и адресата и очень интересный пример реализации данного вид балансировки это было совка при помощи так называемого алгоритма и 7 pe то есть и quill cosma les poupees выяснилось что совет все современный роутер поддерживает могут распылять сбалансирует нагрузка принципе сами для этого нам достаточно народ а просто анонсировать одну и ту же подсеть по разным маршрутам он сеошник данном случае имея два одинаковых маршрута по своим общим метрикам будет распределять нагрузку по ним равномерно но существует ряд нюансов которые тоже надо учитывать в первую очередь мы должны балансировщик должен точнее наш роутер должен стрелять нагрузка таким образом чтобы пакет в рамках одной сессии попадали на один и тот же сервер это раз такой режим на роутерах по моему современных тисках называется перди смешанный per flow и поддерживается по умолчанию затем следующий нюанс если мы пропишем народ и и статические маршруты то мы же должны как-то автоматизировать процесс добавления и удаления серверов из нашего кластера таким образом для того чтобы избежать этой проблемы мы можем использовать различные по такому что такие как бейджики то есть на каждый наш сервер мы устанавливаем некий software by джипе роутер который будет анонсировать серверную сеть на наш код окато принимает запросы из авторов таких готов можно назвать квагга или бёрд вот и также необходимо учитывать что существуют плюсы и минусы этого нет возвращение преимущество значит такого алголь балансировки нас в первую очередь он не зависит от оков высокого уровня как и два три предыдущих методов также используется один публичный адрес отсутствует необходимость приобретать дополнительное оборудование но и существует свои недостатки такие как необходимость ставить на севере дополнительный софт как я уже сказал это программный ltd джипе хотя они принципе не сильно нагружают наше отсутствие сервер affinity то есть в том случае если разрывается и все соединение будет развиваться в том случае если мы добавляем или удаляемся из кластера вот также существует проблема ограниченности одинаковых маршрутов на разных out of the я смотрела внизу полезен и несколько роутеров марки cisco для первых двух одновременно поддерживаются 8 одинаковых маршрутов для последнего поддерживается до тридцати двух одинаковых машин затем мы должны обеспечивать равномерно вступление нагрузки что накладывает некие требования к производительности наших серверов то есть например если мы добавим более производительно серого наш пластах то нагрузка него будет распределяться ровно такая же как и на все остальные и последний минус это тайм-аут и протоколы то есть если серого перестает слать на роутер анонсировать свою сеть то есть мы вышел и стоя на роутер течение которого тайм-аута он может все еще распределять нагрузку по данным маршруту далее и смету этой глобальной путевки можно выделить следующие такими более распространенные методы это было совка наверно dns балансировка на сетевом уровне это проксирование иридий запрос по шпатель и прикладном уровне и балансировка на сетевом уровне можно рассмотрим алгоритм и некрас dns было силах чаще всего применяют так называемый алгоритм и round robin то есть от сам простой механизм балансировки и балансировать таким образом можно любые системы в которых доступ к сервису происходит по имени суть его в чем на dns сервера просто добавляются несколько записей с разными ip-адресами всех наших силах и и серверов сам будет в циклическом порядке выдавать эти адреса то есть первый запрос получит 1 сервак второй запрос второй сервер 3 запас 3 4 запрос 1 40 и так далее плюс этого алгоритма он абсолютно не зависит от протоколов высокого уровня не зависит от нагрузки серая благодаря тому что на всех клиентов есть ли снова каширу ющий dns-сервера которые позволяют им случае резко и не нагрузки наш сервис компенсировать их проблем универсальность то есть dns было совка может выполняться как на локальном уровне в рамках одного до центра так и на глобальном уровне и последний очень весомый со мной главный плюс такого алгоритма совке это очень низкая стоимость и быстрый старт так как любой сайт фактически имея доменное имя имеет dns-сервер соответственно добавят после несколько а записей можно добиться балансировки уже на старте из минуса следует назвать сложность отключать северов случайно примерах выхода из строя в данном случае необходимо предусматривать некоторые алгоритмы лизе способы резервы и вне этих сыров например под протокол карп или вера пи в случае сложно снять нагрузку в нужной пропорции так как dns серы ничего не знает о том насколько загружен каждый сервер а только лишь выдаёт и его их айтишники ограничен сайте адресов это наиболее наверное весомый такой минус данного алгоритма балансировки так как каждый сервер должен иметь свой глобальное пи адреса как я уже говорила api адреса и адреса нынче ли ради и и ограничено и также необходимо держать двойной запас северной мощности в том случае когда у нас один из серверов выйдет из строя а когда будет ломиться на его и печники не повыше соответственно нашу сервис из реализации можно назвать в принципе любой dns-сервер в качестве примера можно привести servername госпакета band 1s его и так далее следующий алгоритм алгоритм проксирование а суть его заключается в том что в качестве балансировщик так применяется так называемый умные прокси то есть если блокировщик получает запрос к нашему ресурсу он али анализируют заголовки прикладного уровня таким образом он может понимать запрос к какому ресурсу пришел на наш балансировщик и соответственно направить запрос кто-то на тот или иной сервер на котором этот ресурс содержится плюс ко всему при получении этого запроса балансировщик может добавляться в заголовке http например информацию о том с какого эпичных пришел клиент для того чтобы сервер знал куда потом впоследствии отправлять системный работу соответственно выполнить запрос на сервер передает его обратно балансировщик тот выполняет необходимые манипуляции снова надо заголовками либо третьего уровня либо и отдает его клиенту преимущество такого алгоритма балансировки в том что мы можем обеспечить сервер affinity то есть мы можем привязать конкретного клиента к определенному серверу например используя различные настройки cookies затем мы можем распределять и разные типы запросов к разным семьям почти не можем одном сервере например держать статику который у нас довольно таки мало весит держать какой-то тяжелый контент и соответственно понимая и анализируя степи заголовок мы можем направлять запросы пользователя на тотальную сервер благодаря этому алгоритму с легким также можем фильтровать запросы по ул защищаясь тем самым отлично года а так и самостоятельно определять работоспособность каждого узла то есть не просто доступность каждого сервер на сетевом уровне но и понимать насколько робот способен на данном случае наш софт на сервере и не применяет при этом никаких дополнительных средств из минусов можно назвать это необходимость балансира балансировать нагрузку на сами балансировщик ах это дополнительно . отказа наша система потребляет очень большие большое количество ресурсов так как как анализируются запросы прикладного уровня и необходимо иметь свой прокси для каждого вида протоколов с реализацией можно назвать такие программные , как х прокси и либо всем известный сервер яндекс директ запроса фредерик запрос имеет довольно ограниченное применение применяется самом для глобальной поселке и в частности для еще и он хорошо применим суть его заключается в том что мы получаем запрос от клиента на наш балансировщик балансировщик отвечает ему редиректом на наш сервер на котором содержится ресурсы то есть например получаем запрос по и степи он сел очки отвечает ему в ответ ошибку выдает 302 в темпуре с указанием адреса того-сего котором дальше будет ходить наш клиент плюсы такого алгоритма балансировки в том что он стреляет запрос по разным 100 грамм за счет анализа заголовка прикладного уровня минусы это достаточно мало применимость к таковым высокого уровня увлечение время отклика за счет обращения к директору и фактически на каждый запрос клиента мы имеем по 2 запрос то есть первый запрос у нас идет балансировщика второй запрос клиент делает непосредственно к таким образом если например клиент запрашивает какой-то контент который уже порезан кусками на каждый кусок клиент будет выполнять по 2 запросу что резко увеличивает время обслуживание клиента из решение можно назвать программный веб сервере nginx и последним видел совке которыми я хотел бы рассказать это балансировка на базе и не каст это уголь блокировки не требует никакой настройки стороны клиента ее суть его заключается следующем мы из разных географических участков анонсируем один и тот же префикс сети таким образом каждый запрос клиента будет маршрутизировать а на ближайшие к нему серго который будет его обрабатывать плюсы такого метода в том что мы обеспечиваем минимальную задержка при обработке запроса так как сера будет клиент будет обслуживаться на ближайшем к нему все не только с географической точки зрения из топологический вот мы обеспечиваем доставку трафика минуя магистральный канал связи соответственно получаем некое удешевление трафика затем плюс в том что стреляет нагрузку сама сеть мы здесь уже фактически никак не участвуем и об этом не заботимся то есть этот процесс ложится на плечи интернет-провайдер высокая отказоустойчивость данного алгоритма балансировки если один из его выходит из строя то все запросы не будут просто переброшен на ближайший от него сервер и соответственно легко добавлять его водить с работы и любые наши севера просто перестаем анонсировать по бюджету подсеть и соответственно все запросы пользователей будут мажьте вернется на других его из минусов следует назвать то что существует возможность перестроения маршрутов что для дисперсии достаточно критично пример если в рамках одной сессии пакет пойдут по долгам маршрутом другой сервак мы получим просто рисует по тисе пи и соответственно сессии прервется отсутствует возможность проконтролировать как ползла узла обслуживается пользователь так как эти мы рулим рулит сама сеть соответствие мы не можем знать где сейчас данный момент обслужить пользователь не прибегая к различным дополнительным каким-то решением ну и соответственно дорогое оборудование то есть мы будем использовать аппаратные роутеры это довольно-таки дорогая штука и такой очень важный момент что при использовании поселке на базе и не каста необходимо учитывать интересы интернет-провайдер так как все мы знаем что интернет-провайдеры любят пиринга ваться друг с другом и соответственно в идеале пакета должны ходить по наименее к наиболее короткому маршруту но по факту получается так что давай проводе передает пакет и там где им дешевле и это необходимо иметь ввиду вот алгоритм ла силла в какие применяются а медных уже сказали теперь расскажу о том каким образом выбираем какой силы нам отправлять запрос существует несколько алгоритмов наиболее таких распространенных которыми я хотел бы сказать про round robin не рассказал и как я уже сказал сейчас недостатком является то что нагрузка в данном случае распределяется неравномерно точнее равномерно не учитывая при этом особенности конкретного сервер алгоритм в этот раунд робин позволяет навесить каждому си на каждой семьи определенный весовой коэффициент который будет учитывать мощность и производительность того или иного сервера соответственно более производительно серы будет получать запросы чаще следующий алгоритм алгоритм так азами лист connections то есть в данном случае будут учитываться не просто нагрузку на сервер но и количество одновременных соединений с данным все равно в данный момент если мы хотим улучшить данный алгоритм того мы можем использовать алгоритмы лист connections интервью с весами то есть навесив еще дополнительно на каждый силой некий весовой коэффициент соответствии с его производительностью и мощностью destination хэштегом kiss с керлинг это так называемый алгоритм и которые анализируют входящий точнее айпи адрес либо источника либо адресата и выбирают из них есть статические таблицы тот или иной сервер который будет прокси ваш вопрос и последним горит это алгоритм стикиз с в данном случае обеспечивается привязка клиента к определенному серверу и соответственно все пакеты как в рамках одной сессии будет ходить только на этот сервер вот дальше хотелось бы рассказать немножко даже не сказать а озвучить несколько решений о в интегратор потому что часто применяются их решение вот мы своих своем в своем сервисе их решение используем поэтому я просто назову здесь перечислено и решение от cisco этот решение на базе cisco эйс некий hard ватный балансировщик который имеет теоретическую пасую способность до 16 гигабит в секунду и поддерживает по моему практически все названные мною методы алгоритма балансировки также а cisco есть решение назовем cisco css имеет новым гигабитные порты позволяет балансировать трафик на сетевом уровне и при помощи понять и глобальных балансировку новым dns от компании f5 решений убегай и довольно таки гибкая имеет свой скриптовый язык и благодаря ему мы можем настраивать балансировку таким образом как нам удобнее как мы этого хотим ну и решение от компании дворе называется на алтан энджи выполняют тоже практически подержит практически все алгоритма балансировки позволяет анализировать настойку кубке выполнять полон привязку клиента конкретном сервер но и ряд других особенности кому интересно может погуглите найти информацию она доступна вот и в завершении немножко хотел бы рассказать о том как мы применяем различные алгоритмы и методы балансировки и как их можно всяческим образом соединять так как мы являемся провайдером сидел у нас сеть для серверов которые распределенные географически тесто надо не просто балансировать нагрузку между сферами нам надо еще и перенаправлять все запросы клиентов на ближайший к ним севы как это работает у нас имеется несколько балансировщика балансировщик у нас представляются себя некий пропатчен dns сервер который мы выдаем просто используя обычные dns round robin вот получив в свое распоряжение клиент отправляет на него запрос на получение о записи то соответственно адрес того серая который будет обрабатывать его запрос каждый балансировщик знает о доступности каждого сервера во всех локациях которые распределено географически ответственно формирует у себя некую комплексным метрику который учитывает загруженность каждого сервера в данный момент использование ресурсов центрального процессора утилизацию памяти доступность сервера с точки зрения сети потом расстояние от каждого сервера анализирует до клиента ну и так далее то есть вы считается некой комплексной метрик на основе которая принимается решение о том куда мы должны перенаправить запрос этого клиента играется как правило ближайший не только с точки зрения географии но с точки зрения пологий таким образом сокращается время обслуживание каждого клиента и ускоряется костусева cyrus ну собственно меня на этом все хотел сказать что балансировка принципе это очень просто даже коты балансировать умеет как мы видим вот ваш вопрос спасибо за доклад ничто не первый вопрос вот вы когда рассказывали про балансировку с множествами анонсами маршруту со стороны как бы реальных серверов 0 протокол bgp почему bdp почему бюджет и вот мы по моим представлением успев гораздо лучше подходит задача но скажем так все любят они каст здесь просто это для того что нет это не тут это не это не и не касты когда у вас в рамках одного сегмента просто бюджета по одна из возможных реализаций естественно возможно там друге и второй вопрос у вас в во многих метрах которые вы описывали ну фактически это бункеровка через над балансировкой через мышцы нация балансировщик является точки отказа вот какие-то методы на резервирование балансировщик с сохранением состояния клиентов вы знаете мы можем что-то применяйте подобное у себя по-моему мы ну я считаю можно принципе алгоритм карп использовать протокол капля резервировать блокировщики то есть случаи выхода например отказа из строя одного балансировщика просто подключается другой режим там стендбай находится соответственном принимаете нагрузку на себя опять же здесь надо учитывать что нагрузка может быть такой непомерной что он тоже можно естественно упасть поэтому думы говорим про физический выход он сгорел взорвался окей просто ну понятно то есть эти рыбы не адреса и при этом все клиенты которые ходили на одни silver они теперь как бы их соединю будут сброшены и нам очень жаль и последний вопрос с моей стороны это каким образом вы получаете информацию о состоянии серверов от вашей системе балансировки сейчас я закон не был продлен и чтобы они два разных толков и отвечать я вас обучу хотел спросить вы забыли о прост как вы как вы сказали что вы собираете вал вспомню я вспомню что спросить насколько у вас упал во первых производительность dns серверов которые вычисляют вот вот эту вот всю метрику и второй вопрос от как вы собираете информацию сцене сироп и какой-то ваш самописный код это стандартный код на самописный мы используем связку повар dns с собственным кодом тесно таким образом нас постоянно анализируется доступность и все вот эти параметры который назвал на прикладном уровне вот 2 pages он стал первым там я спрашивал насколько просила производитель dns серверов то есть были ли например ddos-атаки ну потому что морить одно дело когда мы получаем запрос быстро дали ответ round robin этому ментально все другое дело когда вы вычисляете какую сложную метрику зависимости от сорта клиента ну по моим представлением о прекрасном ваши dns-сервера являются прекрасной . для dos атаки даю т.п. были ли такие атаки выдерживали о них как бы выдерживаем и вообще без проблем и и могу здесь поставить не стал приводить так как маркете особо у нас не допускается рамках данной конференции wise реальные измерения синтаксис мерил производить из нашей сети и мы показали достаточно высокий показатель без у нас мы одни из первых обеспечивали наименьшую на губ наименьшее время отклика скажем так на запрос клиента"
}