{
  "video_id": "Z4JoYrPXPUQ",
  "channel": "HighLoadChannel",
  "title": "Ловля сетями. Инструменты отладки сетевых запросов приложений / Дмитрий Рыбаков (Lamoda)",
  "views": 688,
  "duration": 2097,
  "published": "2018-01-16T12:00:49-08:00",
  "text": "меня зовут дмитрий рыбаков я руковожу мобильной разработки в компании ламода и сам уже больше семи лет являюсь мобильным разработчикам когда-то много писал под android сожалению последнее время с административной деятельности стал писать сильным меньше но нашел тема который хотел бы с вами поговорить не секрет что большинство современных мобильных приложений так или иначе как-то общаются с сервером каким-то и чаще всего это дтп и передачу поэтому самого ттп джейсона или какого-то xml и я хотел рассказать о том как отлаживать такие запросы на примере своего 1 вымышленного друга представляем вам василий п начинающий мобильный разработчик который пришел устраиваться в динамично развивающийся стартап вот где ему на собеседование после прохождения далее тестовое задание написать клиента для гитхаба как и странно гитхаба открытой api нужно было взять это api и написать к нему некое приложение василий ушел домой шибко задумался что же ему делать он был человеком начинающим до этого большого опыта он не имел знал базовые вещи открыв документацию по гид хпп он обнаружил что кроме самой документации в этой там ничего нет то есть никаких playground of ничего что проверить любой запрос нужно было что-то сделать дополнение первое что пришло василию в голову взять самый простой запрос который отдает какие-то данные чей-то профиль забить его в браузер и он увидел результат то есть добился своей цели результат правда выглядел ну так себе просто какая-то простыня из чёрно-белого текста читаем ее до определенной степени 8 захотелось сделать все это красивее он начал искать какие-то способы нашел несколько хороших плагинов для хрома которые помогали и джейсона делает что-то более приличное сворачивать ветки подсвечивать ссылки вообще делать вообще подсветку синтаксиса но сожалению не смотря на все наличие польши большой наличие плагинов для хрома функции его были сильно ограничены в том числе например get запрос и удавались хорошо со всеми остальными приходилось уже либо дополнительные плагины ставить городить огород либо что то еще придумать его силе вспомнил что есть такая простая и полезная вещь как карл консоль у него было уже под рукой он взял тот же самый запрос забил его в консоль хурул и получил практически тот же самый результат то есть тоже простыня джейсона только белое на черном фоне но возможности карла про которые василий читал будет значительно шире то есть там можно было не только джейсон посмотрите сразу заголовки ответа вывести добавить какие-то заголовки в запрос сделать не только get запросов пост будут любой ктп запрос и в конце концов этот пост запрос сделать как добавить какое-то тело и все удачно получалось api начала поддаваться отдавать какие-то данные начал понимать как с ними работать но проблема в том что ему приходилось сохраните файлики в каком-то файлики сохранить кучу строчек сохраненных из курло запоминать наизусть параметры которые нужно в этом корр ли использовать и самая большая проблема случилась тот момент когда ему захотелось сделать пишущий запрос в гитхаба дело в том что гид хоп используя топ канал для того чтобы авторизовываться скажите кто в жизни спор хоть раз внедряла канала в приложении не так много людей но в общем тех тех тех кто знает знать насколько это больно и тем более когда ты работаешь с какой из командной строки это вообще практически невозможно поэтому возили завалился тем чтобы найти какое-то другое решение и вооружившись google он понял что есть целая плеяда инструментов под названием под общем можно сказать названием и 5 тулс первое что ему попалась в руки сопливой такой старый инструмент с интерфейсом написанным на джори он работал кроссплатформенное при этом люто тормозил особенно на маке но очень-очень был высокофункциональным 2 что ему попалась это наоборот сверхсовременный инструмент под названием истцом не который написан на движке электрон гитхаба вс кого же редактора кода атом с очень лаконичным интерфейсом с подсказками с функциями никак из редактора кода но когда он нашел post on василий понял что вот все что его было нужно и даже в раз в пять больше находится внутри этого инструмента и если его минусы довольно перегруженный интерфейс вот я его здесь показал таким общим скриншотам он родился как плагин для chrome а то есть как вот продолжение сначала подсветка синтаксиса джейсоне потом уже все потом post запроса потом пост он внезапно и он решил все проблемы которые вывозили были с файликом в котором он держал за просеки карлу позволял показывал историю всех запросов которые происходил позволял эти запросы обвинять никакие коллекции то есть сохранять их на будущее в осмысленные вас мысленно давать им осмысленные имена более того подставлять в эти запросы какие-то переменные которые можно менять зависимости от окружения и самое главное что эти коллекции можно импортировать из того же самого карла вот файлик с карлом можно просто скормить постоянный пост он сделает из него коллекцию прям разобрав все параметры и также он умеет импортировать коллекции swagger а rumble ova 2 гранд клуб и еще собственный формат который уже поддерживает все функции которые есть в самом постное помимо этого в господи запросы буду редактировать потому что параметры которые есть в get get запросе или в форме если этот пост запрос например как парк мультипарк или как форм идет а также заголовки запросов редактируются в удобной в удобной форме запоминаются подставляются и так далее то есть их не надо ковырять в огромной строчки точно также ответа который приходит уже форматируется и джейсон сворачивается и подсвечивается синтаксис и заголовки запросов не просто разбирается в читаемый приличный вид а и сопровождаются подсказками которые объясняют что это заголовок должен значить по rfc и самое главное что postman предоставляет удобная up on a авторизацию прямо из коробки путем просто берется пост он регистрируется в гитхабе как отдельное приложение вам достаточно просто клиентки скопировать вот внутрь вот этой формы слева заполнить несколько других полей которые обозначают который дается он ghede хоп и авторизовать приложение после этого вы можете делать все заборы любые запросы которые модифицируют данные с ключом или получать этот ключ делать все что может делать любое другое приложение и так путем нехитрых ковыряния василий понял что до приложение можно много чего сделать можно даже в браузер просто спокойно сделать get запрос и он отдаст данные и это будет не хуже чем это самый быстрый инструмент но если нужный функционал шире ты есть курал который вообще все практически все умеет но к сожалению требует огромное количество ручного труда или какой-то там примитивной автоматизации на баше и что есть плеяда инструментов которые позволяют очень удобно работать с большим количеством запросов разнообразных к любому api и таким образом василии успешно изучил did have скайпе написал конева приложения попал на работу в тот самый милый развивающейся стартап прекрасный коллектив где ему досталась уже старое давно работающее приложение которое делало какие-то запросы к каким-то пи и разработчика которого уже давно не было вот по неизвестным причинам и его очень быстро попросили разберись пожалуйста почему у нас перестал работать запросу определенная пей может быть там api уже нет или что то еще произошло неизвестные первое что пришло в голову возили залезть в отладчике есть же отладчик то есть если есть отладчик есть код который с ним работает и есть код можно поставить точку останова в отладчике увидеть контекст запросу то есть не только сам запрос который происходил не только все его параметры но и все переменные в коде которые привели к возникновению этих параметров или при парсинге ответа все все результаты того что произошло также есть стек вызовов то есть много контекста дает отладчик по отдельному запросу ну тут правда возникла небольшая проблема вот здесь я хочу ваш в вашей помощи для василий если вам виден код это код на джиган довольно простой здесь собственно создается и 4 клиент потом создается запрос и асинхронно исполняется вот кто нибудь может подсказать василию где поставить точку остановки чтобы увидеть запрос или ответ 11 какие нить еще варианты 11 хорошая хорошая попытка но к сожалению неправильно потому что здесь нет той точки в которой нужно поставить той строчке куда надо поставить . стонала потому что умолчанию вот этот tab . где происходит запрос в андроиде в данном случае это to make you happy а находится где-то внутри кейт степи и чтобы получить сам запрос и ответ необходимо реализовать такую анонимный класс под названием interceptor который будет перехватывать запросы и позволят их и видоизменять и просматривать их детали и делать с ними все что угодно и и было очень удобно то есть василий описал кусочек кода поставил туда точку останова и начал отлаживать запросы запросов было много и когда их стал там по 80 штукой надо было 79 промотать прежде чем отладить 88 начала низко надоедать и он подумал что можно было взять просто воткнуть логирование но частью к этому моменту василий уже обрел дзен гугле не всякого важного не стал городить собственный лаггера поискал что есть оказалось что там под тот же самый android создатели кейсики при компания square написал из стандартный дефолтный так называемый логики и interceptor который очень легко подключается в одну строчку буквально в белграде добавляется зависимости и там где создается клиентов него добавляется этот самый интерцепторы для логирования более того если посмотрите вторая строчка в java коде это фронтами выставляется уровень логирования таким образом довольно несложно путем там какого-то простого ифа можно сделать чтобы production сборках логирование я была в дебаггер сборках лакировалась по максимуму результаты работы интерцепторы выглядят примерно вот так здесь еще поменьше заголовков то есть видно и запрос который уходил и ответ который пришел все заголовки содержимое тела и определенным причинам что с разработчиками компании было сложновато василию пришлось и союз разбираться и он нашел аналогичную библиотеку для ios называется response детектив подключается также просто и конфигурируется буквально вот как while searching конфигурируется и потом подставляется либо в самую лрн либо валом of our и логирование выглядит тоже очень похожим образом чуть чуть более детально чуть более развернуто ниже в версии с android да если заметите он даже разворачивает джейсон и в древовидный такой вид удобный для чтения но проблема была в чем опять же те же самые 8 10 запросов которые было сложно в отладчике отлаживать точно так же сложно стало отлаживать в блогах потому что логе сильно засорялись то есть вот постоянный поток данных когда вам приходит 200 килобайт на и джейсон ответы снимешь сложно в блогах что-то поделать поэтому пришлось взять google свои руки и ускориться еще быстрее в поисках проблемы и случайно совершенно коллеги из отдела web development и подсказали что в храме есть прекрасный developer tool наверняка многие из вас по правой кнопке нажимали в хроме и нажимали кнопку в меню и inspect и видели сколько там всего интересного это инструмент который очень сильно помогают web developer счастью появились и для мобильной разработки тоже компания facebook сделала инструмент под названием стеха от слова стетоскоп никто не знает как правильно произносить название я в том числе за некоторое время до этого та же самая прекрасная компания square сделала для ios аналогичное решение под названием пони дебаггер подключаются они очень просто пример мы так же просто как подключить лагов в дтп клиенты то есть несколько строчек в зависимости вот для android стоят к подключается буквально одной строчкой в апликэйшен сквер подключается чуть-чуть сложнее но примерно так же узкого помнить багиры есть дополнительный промежуточный слой в силу особенностей в приложении встраивается клиент но чтобы chrome связать с этим клиентом необходим дополнительный промежуточный сервер который написан на питоне он ставится там в одну строчку ставится и в одну строчку запускается и в апликэйшен это ж надо написать вызовите синглтон из любого места собственно с этого дебаггер и и дальше как как как-то с ним взаимодействовать сказать ему там подключаться анализировать трафик и так далее в результате в chrome developer tool по запросам видно вот такую прекрасную картину видно не только все запросы в той последовательность в которые они происходили с левой колоночке но вообще весь этот список это список запросов если вы посмотрите чуть правее посередине 2 колонки сайты time они говорят о размере ответа и времени к за который он был загружен и что очень удобно и показывается timeline то есть видно когда какой запрос стартовал относительно других также идти и стоят х японии отлично форматируют ответы то есть показывает не только джейсон xml в красивом в удобном виде но и бинарные ответы вроде картинок тоже показывают в виде картинок то есть если там что-то не так то вы увидите или вот как картинка и к сожалению плохо видно мониторах с картинкой которые клиенты приложения василия на этой картинке но самое классное в этих двух инструментах то что они мог многое что умеют помимо работы с сетью они еще показывают иерархии view вот аналогично тому как web developers просматривают собственно дерево html-документа java ios и android а абсолютно аналогично они показывают дерево иерархии view текущего экрана с подсветкой в обратную сторону то есть когда вы выделяете строчку в этом коде подсвечивается на клиенте рамочки подсвечивается этот визуальный элемент который вы выбрали но это еще не все они еще умеют показывать сохраненные данные иску light база или волос эту cordata votes еще дополнительно туда можно исполнять осуществлять логирование вместо стандартного как-то нанесло по-моему называется стандартный lover там сварит можно сворачивать ветки и просматривать объект это боль более богатый lover и таким образом василий сильно ускорил свою работу и понял что можно и в отладчике посмотреть когда нужно прямо очень детально закопаться в подробности того что происходит хотя это конечно очень медленно в отладчике сложное дело я василию мини рекомендовал такой подход можно очень хорошо логировать но это как бы те запросы которые делают приложение туда попадают их видно в промежутке между другими логан и можно что-то залакировать ещё дополнительную какую-то информацию но только текстовый ответы ужасно засоряет логе то есть просто вместо нормальных логов видит только ответы и запросы и удобнее всего получились внешние отладчике которые показывают все запросы с кучей деталей и форматируют ответы подключается в одну строчку ну требует некоторые настройки вот как случае спа не нужно запустить сервер на питоне но это не так сложно и главное не забывать их включать и выключать для продакшна сборок потому что за такое там как это как говорит джейк воркман когда вы блокируете в продакшене умирает котенок и таким образом василий успешно прошел испытательный срок отложив все там 80 миллионов запросов которые прошли через него за это время вот и в один прекрасный день к нему пришли коллеги из соседнего отдела и говорят дорогой василий пожалуйста вот вам вот тебе библиотека принесли ее на флешке и и написали наши подрядчики она собирают все действия пользователя отправляют по защищенному каналу на сервера в другую страну вот чтобы мы могли их проанализировать пожалуйста ватки и себе в приложении она обязательно нам нужно он воткнул и заметил что батарейка кончилась даже на эмуляторе то есть эта штука почему-то делала ужасное количество запросов качала дикое количество трафика сажала батарейку при этом запросы лезли кто они такие непонятно потому что канал шифрованные коды нет под рукой все исходников нет разработчики за океаном и взяв руки любимые google и пойдя на stackoverflow возили понял что единственное средство которой он может здесь использовать что вообще понять что происходит и так называемые отладочные прокси кто знает что такое прокси вот прекрасно практически все но я все равно хочу напомнить бокс это отдельный сервер который пропускает через себя все запросы но именно в явном виде то есть он не слушает внешний интерфейс как снифер в него явно за ссылается запрос явно передает потом на сервер и обратно плюс у меня в том что он работает на уровне устройство они приложения то есть он пропускает через себя весь трафик устройству и василий начал искать что же там бывает в отладочных прокси нашел что в андроиде в силу его особенности отладочной прокси есть прям на устройство то есть отдельным приложением с кучей очень опасных permission of можно поставить приложение pocket кимчи и прекрасно видеть весь трафик включая шифрованный также нашлось решение в облаке когда все запросы с устройств и прокси сена прокси-сервер отправляются в облака мы называем к админу мэн но конечно самое большое количество таких приложений оказалась на десктопе на обычных машинах среди таких решений чарльз фокси филлер бург и еще на самом деле 23 название по поплоше и из собственного опыта пользования васильев понял что чарльз самый функциональный хотя они все похожи настройка через очень простая в нем указывается порт известен код айпи адрес собственно машина которой он стоит относительно устройства на которые хочется прокси указать указывается айпи адрес и порт порт прокси-сервера после чего весь трафик начинает идти через charles и предстает в таком вот удобном виде видно весь трафик все-все-все бинарные данные картинки видео все что угодно структурируется все плохо стан и даже разбивается по пути чтобы удобнее было потом читать весь трафик сторонних библиотек которые внедрены в приложении там тоже виден и соответственно даже шифрованный трафик можно посмотреть но вот видно что часть трафика зашифровано что с ним сделать потому что шифрованный трафик на самом деле прокси пропускает сквозь себя на сервер потому что он подписывается сертификатом сервера и отправляется обратно на устройство чтобы данные были надежно зашифрованы как это обеспечивается на устройстве есть корневые сертификаты цель по которым проверяется сертификат сервера соответствует он доверенный он или нет потому что хотя ps это вообще вопрос доверия соответственно если вы как владелец устройства решили что вы готовы пойти на риск и добавить в корневые собственные сертификаты сказать что вы полностью доверяете то этим сертификатом можно перепаковать любой трафик выглядит это примерно вот так то есть прокси выпускает собственный сертификат в чарльза и то есть любой в любой прокси они все так устроены вы ставите этот сертификат себя на устройство вас десять раз предупреждаются что сейчас ваш трафик перестанет шифрованных после чего прокси перепаковать трафик пири-пири подписывает его и вместо вас общается сервером еще по-другому это называется атака менеджмент наверняка слышали что не были тут по сути то есть зато после этого чудесным образом весь шифрованный трафик вы видите здесь вот этот ps хост сверху становится видимым и отлаживаем им точно так же как и любой другой кроме того в proxy прель прелесть прокси в том что они владеют абсолютно всем трафиком который проходит вот устройство я между хотите пышным трафиком который проходит от устройства на сервер и соответственно многие из них позволяют модифицировать запрос и ответ и например подставлять какие-то заголовки модифицировать тело запроса или параметры в запрос подставить они позволяют делать тротлинг то есть эмуляцию более медленного соединения так как они владеют соединение просто более мелкими порциями с большими паузами начинают отправлять и даже делать роста точки останова как в отладчике можно сказать что остановиться в случае если в запросе попадется такая такая то переменная какое-то поле и рассмотреть запрос модифицировать его и отправить дальше то есть любого рода и в том числе они позволяют еще очень удобный вещь делать записываю целые сессии запросов и делать реплеи тоесть можно эту сессию сохранить послать кому нибудь по почте велик просто там зарипова нам файл и человек с той стороны сможет его проиграть это очень удобная вещь в отладке когда как бы команда работает распределенная и просто ткнуть коллегу в экран не получается и так даже без кода приложения пользуюсь отладочные брок сами брак себя хорошо сказал можно очень многое узнать и даже больше чем с помощью инструментов которые внедряются в код и так самые основные игроки здесь чарльз очень удобен тем что он на все платформы есть у него хороший интерфейс огромные возможности если вдруг у вас в приложении есть про табов он умеет спрута бофор аваль не только с джейсон xml там чуть сложные схемы но он работает который p2 поддерживает чем многие много хорошего имеют в себе есть прекрасный инструмент филлер он бесплатный он очень мощный очень давно поддерживается к сожалению он работает только под windows и они пытались его переписать на моно фреймворке на тот нитей чтобы он запускался под линуксом на маке потерпели полное фиаско и с 14 года отдела забросили есть в решении под названием клад мерил мэн это довольно новый продукт облачный показывает все в браузере по функциям конечно сильный пока слабее и самое главное он требует довольно сложной установки он требует настройки vpn соединение локального то есть установки vpn клиента сертификата для этого пьян клиента очень кучу кучу геморроя но потенциально это очень интересная штука конечно в будущем я думаю что будущее за такими решениями и таким образом васильев радостно отладила это несчастная библиотека обнаружил что они гоняли одну и ту же картинку 10 мегабайт на в размеры туда-сюда вот и сказал что большему такого в приложении не засовывай никогда в жизни и не только прошел испытательный срок еще и заработал себе кучу очков компании и вот что василий передает теперь своим юным падаваном которые у него стали появляться что до приложения можно конечно пользоваться и браузером и карлом но гораздо удобнее сразу поставить если есть много запросов к api и гораздо проще поставить сразу специализированный инструмент к их целая плеяда когда у вас под рукой код приложения можно и логировать запросы чтобы увидеть контекст но лучше пользоваться внешними отладчике потому что там видно сразу все видно в очень структурном виде тоже можно сохранять данные оттуда ну и даже если нет кода приложения или если он есть но вам просто лень настраивать что-то то можно использовать отладочные прокси через который просто идет весь трафик снижается это дико удобно даже если вы заранее озаботились то в момент когда вам это пригодилось если прокси запущена у вас уже все данные просто там сохранились поэтому не бойтесь новых инструментов и экономьте свое время на прекрасное решение задач они на тупой отладку успешной вам отладки спасибо огромное жду ваших вопросов да вот молодой человек рук поднимает дабы вы можете сказать я pov я повторю да спасибо я хотел бы добавить вот что по поводу у обычных прокси смотрите по поводу men in the middle надо еще одну до парочку сделать что если либо которую мы отлаживаем было написано суровыми бородатыми дядьками то они туда заложили еще и проверку fingerprint а сертификата который выдается понятно и в большинстве случаев она не будет работать под мид мам я просто к чему да есть определенный опыт допустим так скажем reverse инжиниринга приложение подаешь допустим на я скажу что вот такому вот наивному метнул поддастся ну там 2 из 10 остальные либо начнут выводить предупреждение что дружок тут не там как бы ты уверен что мы хотим дальше работать ну как бы например то есть как ни странно сбербанк например подастся а вот я да и мечту приложение местного банка допустим 1 она мне сказала что дружок тянет связанности потому что сертификат очень принято по себе да отличной комментарии ты правда немножко выходила вот за рамки вина инструмент исследования но спасибо это правда очень важно действительно многие приложения если вы если вы ставите перед собой задачу реверс инженере приложения и тем более если это как вы правильно заметили банковский и софт не знаю правда как сбербанк ни разу не пробовал его реверс инжиниринг то они защищаются очень хорошо вот у меня был нет никого из алиэкспресс у случай я просто пытался их по реверс инжиниринг приложения выяснилось что ребята пользуются вообще протоколом quick и он вообще не типичный даже он через люди приходят его только в и шарки видно то есть способов защиты от просмотра есть очень много и в том числе да то что вы сказали проверка сертификата сервера прямо в приложении называется эта методика с opening если вы не хотите чтобы ваше приложение кто-то исследовал почитайте есть много хороших статей для ios для android с объяснением того как это сделать делается очень просто вот серьезно прям всячески рекомендую пожалуйста вот молодой человек в синей рубашке спасибо за доклад у меня такой вопрос вы же чарльзом пользуетесь до постоянно у меня такая проблема была когда включаешь прокси как бы все лог работаешь и работаешь потом выключаешь а на локальной машине иногда ломается выход в сеть и ничего с этим не сделать пока не перезагрузить компьютер и не у меня одного была такая проблема а локальная машина ну у себя на длину 3 2 мс под виндой и ли мне ему от маком под маком вы знаете я бы у меня правда не было подобной ситуацией я просто никогда не включаю отладку запросы самого мака я всегда отложила эмулятор который там запущен как виртуальный ну там просто прописано адреса все поэтому к сожалению я вот не сталкивалась рада помочь спасибо кто-нибудь еще вот девушка давать вот сейчас вам принесут до что все слышали спасибо большое дмитрий за доклад а подскажите получается вот все эти инструменты это только для отладки http запросов а если вот сейчас уже сок отсоединение спасибо за вопрос да это про в первую очередь проще типе запросы соки соединения к сожалению наука более сложная материя более тонкая для этого лучше всего подойдет vr shark но я его совершенно намеренно исключил сегодня из рассмотрения потому что но кабель лучше него нет но там уровень порог вхождения настолько высокий что сначала надо читать теоретические статьи про его устройства то есть как бы провела конструкции он вообще самый прекрасный инструмент и vr шаг shark если интересно я обнаружил совершенно случайно просто поставив его вторую версию ой или не вторую во второй не важно что он научился отлаживать перехватывает запросы по юсб и например для android-разработчиков будет интересно узнать как работает юсб и в adobe когда подключенное устройство делаете там от а до б шел бла бла бла и смотрите просто флаер шарки просто все это в виде пакетов и успешных очень удобно вообще вершинку уметь любой трафик перехват зависимости от устройства можно переходить gsm трафик если у вас есть специальное оборудование для этого еще ещё кто-нибудь не вижу никого а я буду весь день на конференции если вы увидите меня и захотите еще бегать за вопрос задать чуть попозже я с радостью на него вам отвечу спасибо вам огромное еще раз"
}