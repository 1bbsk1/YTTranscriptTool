{
  "video_id": "Wj-Y1pdNiDw",
  "channel": "HighLoadChannel",
  "title": "Как при помощи бумаги, карандаша и алгоритма Raft достичь консенсуса / Ярослав Дынников (Picodata)",
  "views": 195,
  "duration": 5198,
  "published": "2024-10-29T03:07:37-07:00",
  "text": "Всем привет А давайте я сразу расскажу что за сегодня мероприятие нам предстоит Я подготовил для вас небольшой интерактив значит суть заключается в следующем мы сейчас с вами поделимся на кластера по восемь человек каждый участник будет играть роль отдельного сервера я вам заготовил раздатку листочки А4 - это ваш жёсткий диск сейчас будем повторять алгоритм ра вживую соответственно пожалуйста вот вы молодой человек можете сесть Давайте поку нее Да я ожидал что больше народу будет Поэтому так получилось значит если у вас в кластере не будет хватать людей то кто-то может брать по два листочка играть за два сервера уня скриптов Да по человек в кластере ребят со второго ряда давайте вы чуть-чуть пересадите к коллегам чтобы плот каждому Поче неудобно будет писать Каждому по два Хорошо Окей Пусть будет так так и и ладно пока вы рассаживание я начну вещать начну Ну по формату Давайте проговори вначале будет немножечко теории что это такое О чём речь понятное дело а потом уже я скажу что заполнять Как заполнять и мы начнём писать я это мероприятие провожу уже не первый раз и чтобы Значит сразу синхронизироваться вот у меня в первый раз был такой показательный момент там во-первых по времени вылетел жутко сильно во-вторых самый показательный вопрос прозвучал под конец мастер-класса молодой человек поднял руку спросил Простите а можете ещ раз повторить что такое кластер определение из Википедии что такое кластер кластер - это группа процессов которые работают совместно и что для меня самое главное что они все представляются пользователю единым ресурсом какой-нибудь набор питаня их сервисов ли работающего в кубернетес вполне мог бы подойти под это определение Но мы с вами будем смотреть на й потому что там задачки намного интереснее чем Stat ну состояние есть его хранить надо соответственно у нас есть несколько серверов и ваша задача будет в том чтобы вот в этой группе из восьми участников достичь консенсуса значит Казалось бы всё хорошо это сделать не так сложно бахнем какой-нибудь двухфазный комит и дело в шляпе но двухфазный комит требует чтобы все участники подтвердили что они Ок а у нас сеть может рва мы с вами изучаем алгоритм рафт вообще решений для этой задачи достаточно много в мире но я не буду проводить обзор я вот на одном рафте фокусируют подробно описан вот в работе которая здесь процитировано Диего Ангара также суперские материалы вообще UB кто захочет Даше с этим делом знакоми там стадис любое количество материала есть сам алгоритм построен с прицелом на понятность что нам только на руку а Итак что же нам говорит алгоритм рафт он говорит примерно следующее что если вы ребята хотите построить достичь консенсуса то вам нужно построить такую штуку называется реплицируемый конечный автомат по-английски машина Ну я буду и так и так его называть Понятно ка с английского вот что же это зверь из себя представляет здесь рисунок приведён как раз из оригинальной статьи Значит вот в правом верхнем углу зелёный прямоугольник стоит машина это как раз то что у нас должно быть одинаковым здесь в примере написано X ра 3 Y ра 9 ра 0 Ну понятно какая макая всё состояние сразу мы не сможем это слишком накладно одно значение изменилось Что же делать а решение логичное применяется в огромном количестве продуктов называется журнал журнал транзакций журнал транзакций хорошо значит в журнал мы записываем уже операции которые мы над этой стоит машиной проводим и в принципе рат ничего не говорит о том что должно быть написано это ВС остатся на откуп конкретной реализации То есть вы пишете свою базу данных пожалуйста Там какой-нибудь dml insert Delete что-нибудь в таком духе там логичнее всего было бы увидеть едем дальше ещё один зелёный прямоугольник - это модуль консенсуса он изображает как раз тот алгоритм который с вами и я сразу оговорюсь у вас на листочках нету йт машины у вас есть только журнал понятно что если мы сможем консистентной журнал если у всех участников будет написано одно и тоже вот как на примере там X3 y1 то и машина у нас у вас сойдётся давайте уже знакомиться с реквизитом доставайте бумагу из файлов кто е не вы Нате 4 с состоянием это ваш жёсткий диск и первое наше упражнение будет подписать кто вы есть и проставить идентификаторы рассадка не очень удобная Конечно я изначально предполагал что это будут маленькие столы вокруг которых вы будете группироваться Но что поделать А Давайте попробуем самоорганизованность написали Значит по одному человеку от кластера там поднимите руку Возьмите себе и оди договоритесь как-нибудь внутри а а остальные инстансы ид и три иче и так до восьми а есть кластера у кого людей не хватает да ребята которые только подошли Присаживайтесь с вами кто-нибудь поделится тут раздатки на 12 кластеров этого более чем достаточно а ищите ищите ещё минуточка пожалуйста и оди поднимите руку я хоть посмотрю на вас значит 1 2 3 4 5 6 а вы целиком за один кластер играете сразу да одно инстан хорошо Ну контейнеры не контейнеры тут не принципиально это тоже implementation specific ребят кто хочет вакантное место занять А вон Садитесь к ребятам там можно будет по заполнять тоже всё Поехали дальше а значит что ещё здесь на листочке есть Давайте проговаривать Всё да хорошо термы про термы мы поговорим позже а ло сейчас интересует вот ло - это тот самый журнал который был на предыдущей картинке значит здесь у каждой записи всего четыре Поля это индекс Терм значение и лока в рафте записи нумеруются тоже Ну как по порядку мы будем с вами цифры ставить 1 2 3 4 и так далее про термы ещё поговорим val в принципе как я уже сказал ничего не говорит о том что у вас должно храниться Поэтому в целях демонстрации у нас в игре будут фигурировать буковки по одной буков на запись Мы из них будем составлять слова значит предложение вот Наша задача чтобы у всех в журнале оказалось одно и тоже сообщение значит если получится значит цель достигнута про тоже скажу позже а пока вот что надо проговорить состояние Я уже сказал что это распределённый конечный автомат и Каждый инстанс каждый сервер может находиться в одном из трх статусов значит когда сервер включается первое что он делает он ничего на самом деле не делает он сидит и слушает он переходит в статус это пассивный узел который просто подчиняется лидеру управляет всем в кластере Лидер это единственный инстанс у которого есть право принимать запросы от клиентов обрабатывать их дополнять новые записи вжр это вот центр нашего кластера естественно мы проверим как работает отказоустойчивость этого лидера Ну и промежуточный такой состояние кандидат это инстанс который только собирается стать лидера собирает за себя голоса тоже на него посмотрим значит Флор когда вообще проходит вот э процедура голосования что мы сес буде о стартанул абсолютно пассивен и если он долго ни от кого сообщений не получает он думает Ага наверное лидера сейчас нету стану я лидером Ну попробую стану я кандидатом да Сначала становится кандидатом пытается собрать за себя голоса И если всё получилось то становится лидером начинает рулить продолжается это до тех пор пока кто-то друго не почувствует тогда у на круг замыкается кто-то другой переходит в кандидата и вы можете уже здесь почувствовать у нас намечается такая маленькая терминологическая проблема у нас значит есть Старый Лидер У нас есть новый Лидер как с этим жить вот рафт это объясняет следующим образом в рафте всё время поделено на такие абстрактные отрезки времени которые называются термами кажы тее с выбо зава побе одного лидера либо может случиться Так что Лидер не выберется если ему голоса собрать не удалось Ну и тогда А заканчивается Терм когда соответственно новый начнётся Итак пробуем с вами играть есть ли у кого-нибудь какие-то вопросы пока что давайте у нас вопросы будут посередине Да сечас нет вопрос был Должны ли быть листочки у каждого я попрошу подносить микрофоны тогда ладно листочки по три жёлтых и по три синеньких на каждый кластер всё нормально листочки вы будете передавать по сети начинаем выборы значит давайте для примера там с таймаута у нас сложно воспроизводить поэтому пусть и1 Нант выборы Аа что для этого нужно сделать Нужно заполнить Вот как раз жёлтую карточку она обозначает Ну называется request rpc а raft вообще построен э насчёт сетей он тоже ничего не предполагает Да очень много чего не предполагает оставляет на откуп имплементации Поэтому в реальном мире Здесь э Вы скорее всего увидели бы udp какой-нибудь либо tcp А может быть поверх ТТП всё это короче неважно абсолютно Каким протоколом вы воспользуетесь у нас вот в офлайн ролевой игре топологии сети будет кольцо и вы вот эту карточку будете передавать по кругу там Вот видите в респонс есть поля чтобы каждый мог ответить А в рафте это называется rpc Проси Лидер будущий Лидер и один говорит Жам типа Ребята давайте голосуйте за меня указывает Давайте пробежимся по полям теперь да Терм это как я уже сказал вот тот отрезок времени значит чтобы отличать старые протухшие сообщения от Новых нам нужно определиться К какому моменту времени вообще сообщение относится у нас игра только начинается поэтому Терм первый кандидат ID логично и один агитирует всех голосовать за себя к это последние индекс и тем соответственно в журнале который у вас есть Ну так как у нас пока журналы чистые соответственно это по нулям Вот соответственно инстан и1 пишите что вы тут же голосуете за себя заполняйте карточки пере пом дальше я е минутку дам чтобы А1 К2 Не обязательно но скрипт подготовлен Да я не уверен что в моём скрипте собьётся если идти не по порядку в целом не очень важно смотрите рафт рафт вот не не заин от византийских атно про Доверие можно но тогда Лидер не сможет кандидат не сможет стать лидером у вас кластер останется без лидера и у вас ецд недоступен на запись нужно оно вам я покажу позже пример в котором реально нужно голосовать против чтобы не дай бог не нарушить условия консенсуса но пока никаких препятствий для этого не за соответственно ид ИТ давайте дождёмся пока листочек сделает полный Круг каждый из инстан сов ид и8 которые получает листочек должен принять решение голосует за это кандидата или голосует против значит давайте тоже поподробнее пробежимся Что здесь происходит по правилам рафта голосовать можно только один раз за Терм и в принципе если нет каких-то препятствий о которых речь пойдёт позже то вы просто запоминается что вы уже проголосовали сначала пишите на свой жёсткий диск что вы проголосовали потом ставите галочку в сетевом сообщений что ВС Оке Да чтобы не было такого что мы ответ посли забыли это немножечко ненадёжно поэтому переносите к себе на листочки Вот примерно нарисован Да что ид запомнил что он в первом Терме проголосовал за первого кандидата что ещё можно добавить пожалуйста не надо списывать потому что вы-то списать можете а сервера которые в одной стойке стоят Списать не могут поэтому переносим на свой жёсткий диск только то что у вас в руках а подглядывать при этом не возбраняется Конечно можно Возьмите только микрофон пожалуйста сейчас Да И о не записывает у себя вот это вот то что он проголосовал и1 записал ещё когда объявлял начало голосования То есть можно считать что смотрите Вы можете сразу проголосовать Вы можете подождать пока листочек вернётся вам большой разницы не будет да А давайте руки проверим как у вас с готовностью я так смотрю никто не пишет все готовы наверное да так листочки вернулись к и о правильно отлично сверяя картину всё так значит Вам пришёл листочек в котором восемь галочек микрофон Пожалуйста вопросы Вопрос такой когда происходит такое голосование оно происходит параллельно мультиками обмениваются ноды и так далее или вс-таки последовательно Прим узел знает о последующем узле которому он должен отправить сообщение вообще алгоритм спроектирован таким образом что отлично ложится на udp соответственно каждая голосование это вот в вашем случае udp пакетиков хоть мультикам хоть индивидуально в зависимости от того как у вас Ну как вы хотите протокол спроектировать пакетиков индивидуально восем ответов что все готовы за вас проголосовать а Итак корону Нарисуйте Вы теперь лидеры и один а едем дальше Теперь когда у нас есть один пишущий узел а больше у нас и не будет можно начинать писать значит в принципе по алгоритму это должны были быть запросы от клиентов То есть клиент приходит в кластер говорит такой там значит у меня Ир значит сохраните пожалуйста мой Ир мы с вами просто чисел 1 2 3 4 и так далее Терм У нас сейчас Т1 уже сказал смотрим дальше и после того как вы это дело заполнили теперь надо рассказать остальным что у нас новые данные в кластере и здесь нам понадобятся вторые голубые бумажки под названием рые говорят приме себе отрепьев всё не влезет а сейчас я отвечу ребята можно микрофон пожалуйста вот вопрос Да а почему Терм всё тот же Т1 Мы в нём в Т1 выбирали лидера в Терме Т1 мы выбрали лидера и теперь Лидер говорит что я в Терме Т1 велю вам заревать вот эти вот вот это вот кусочек вот эти четыре записи из журнала уже будет набор новых пакетов это второе сетевое сообщение Да у нас каждая карточка это отдельное сетевое сообщение Понятно спасибо и вот там ещё микрофон пожалуйста я и4 и у меня короны и один Нет да то есть я ещё в принципе не знаю чем закончились выборы Да всё верно пока что инстансы знают просто все кроме первого знают что они чем это закончилось неизвестно так всегда бывает А ну респонс сразу вы Коль записали себе на жёсткий диск можете сразу поставить галочку что у вас эта запись есть значит передаёте её дальше и Давайте поговорим что должны все остальные делать когда это сообщение получили под сре запи себе Вот то что вам в сообщении пришло переносите к себе в журнал и первые четыре записи У вас есть ещё раз А сейчас микрофон Дайте пожалуйста а есть ещё микрофоны в зале чтобы не один таскать по всем секциям А корону надо и один рисовать мы же уже знаем что он лидером стал Вы нет Вы ещё других сообщений не получали Ну в смысле когда мы первое сообщение получили от него А да вы можете Вот когда вы первое сообщение получили Вы можете нарисовать Но это это да Нарисуйте хорошо спасибо а а вот и один Стал говорить другим Угу нужно реплицировать Ну часть к примеру да и пока говорится что до сих пор идёт Т1 А кто нарезает эти Т1 может уже пришло время Т2 а для Т2 может уже новый Лидер Или как это всё Подождите чуть-чуть это тоже будет хорош в скрипте Да скоро всё станет на свои места так готовность есть а ещё вопросы хорошо отрезка вот этих вот четырёх символов она как критичны сейчас то есть если я пишу сообщение которое длиннее четырёх символов мы оставляем в данный момент четыре их а оставшиеся два поме там два или больше они будут где-то дальше Да рассматриваться да то есть у меня в примере их было восемь соответственно первые четыре мы листочки с восьмью галочками Нет ещё хорошо сеть очень медленная Да я согласен медленная узкая а в логе App пока только и один заполняет или мы все должны у себя проставить когда с реплицировать про этот слайд я сейчас ещё буду говорить Могу вернуть предыдущий если хотите про этот слайд я буду говорить когда листочек вернётся к и1 а обозначьте свою готовность пожалуйста кто готов есть уже такие А давайте наоборот кто не готов хорошо а пока кто-то ещё не готов пара вопросов предположим Я мошенник Угу И я начал свою деятельность ещё на момент выбора лидера Я просто отказываю всем А ну то есть В голосовании лидера отказываю Терм протух ет Я так понимаю начинается второй Терм я пытаюсь стать лидером и отказываю всем пока не стану лидером угу вот а после этого получаю от пользователя сообщение там а а отправляю всем б угу так будет работать нет почему А как я уже сказал рафт не не защищён от византийских Атак соответственно Если вы хотите не доверенные э вот такие сценарии рассматривать то Это что-то скорее про блокчейн Аа рафт строится на доверии поэтому Ну просто алгоритм не тот протокол не тот есть если вы узлам не доверяете то вам ра не подойдёт такой вопрос а если получится при голосовании равенство голосов за и1 и и2 допустим два две ноды вдруг предложили себе 4 за и1 за и2 Как решается эта проблема лидером не станет ни Тони другой чтобы стать лидером надо собрать больше половины голосов соответственно в нашем случае это 8 пополам плюс о 5 голосов а остальное называется Split и мы до него тоже доберёмся обязательно кого ещё надо ждать есть такие всё ноль рук кажется отлично едем дальше значит Я предполагаю что сейчас у и1 в руках находится листочек вернувшийся с галочек что все заперли к себе вот эти четыре первые записи и что в этот момент должен Лидер сделать он наконец-то узнал что первые четыре записи законные законная запись становится как только больше половины проголосовало что всё ок это условие обеспечивает нам что эти записи больше никуда не денутся гарантия надёжности соответственно вы ставите ну четыре записи вам кластер подтвердил вы ставите четыре галочки галочки называются немного по-другому App Да вот здесь я сейчас буду рассказывать тонкий терминологический момент под котом подразумевается Что значит запись является законной если больше половины узлов заперли её к себе но вот так условие комита оно включает другие узлы про которые не знаем У нас есть состояние неопределённости Вот пока и1 не получил Это ответ Он не знает сколько сохранила сохранили ли вообще кто-нибудь Услышал Нет вот поэтому мы можем узнать что запись была закамини когда не узнаем что она не была пока там не произойдёт какой-нибудь перевыборы это дальше произойдёт Вот Но что нам главное что если она была закона то е можно применять к своей стейт машине и вот это именно применение к стейт машине Мы отражаем в галочка App что всё я знаю что запись закомельская Вот вы сидите сейчас смотрите на всё глазами сервера А как вообще чувствует вот эта вот одна запись например первая буковка H которая там в примерах фигурировала когда клиент присылает какой-то запрос фтр его обрабатывает Вот пока там до поры до времени единственное где это хранится это в оперативке Ну там сначала tcp очередь входящая прочитали из сокета дальше поехала запись называется unstable Вот пока мы её не сохраним на диск она у нас unstable может так жить Ну относительно долгое время это тоже надо учитывать потом в какой-то момент мы наконец-то пишем её в журнал она становится persisted но то что мы её сохранили это ещё не значит что остальные тоже готовы да и дальше у нас вот есть тянется этот шлейф запис которые мы заперли но пока не получили подтверждение когда подтверждение есть запись становится comed и когда но как я уже сказал мы недостоверно ещё ну не всегда можем гарантированно знать закоченевать Вот как четыре волны которые бегут значит там в самом начале у нас unable записи а самые древние уже должны были бы за котиться главное чтобы этот хвост не слишком отстал А то может и буферов не хватить и Давайте перейдём к следующему упражнению у нас остались ещё незаконные записи Так что и оди вы проделывается всё по той же абсолютной схеме заполняйте ещё одну карточку I а остальные не спешите У нас сейчас будет разнообразие здесь есть одно изменение У нас появился Лидер comit 4 а Лидер комит это как раз Вы наконец-то как лидеры говорите что я узнал что предыдущие четыре записи закоченевать страт информацию про то что там е было раньше и в целом в целом Ну да В общем не буду отвлекать пока что вас Да я вижу вопросы есть в зале то есть Когда лидеру пришло вот эти четы галочки он себя пометил и тепер он е говорит что Вы у себя Тампере следующий стейт то что вы мне отправляли Ну они изначально не отправляли это Лидер изначально отправлял в предыдущем сообщения четыре записи собрал на них подтверждение и теперь рассказывает окружающим что да ребята значит я с вас кворум собрал потому что остальные участники они как бы не знают вот в реальности Когда у нас udp и р to Пир а там приходится как бы пересказывать другим это у вас одна карточка на руках там можно ещё посмотреть но мы этим не сильно будем пользоваться вот лидер Должен рассказывать сколько записей сейчас закоченевать что мы приняли это подтверждение на наше подтверждение я понял Вопрос вот смотрите сейчас нарисован респонс галочка респонс собирается на новые записи вот на 56 78 4 просто инстансы принимают к сведению и на них оть уже ничего не надо то есть в чём фишка рафта Вы можете вообще не знать ничего про то что там происходит но если больше половины кластера успела запер Сить себе какую-то запись э запись боль никуда как ну не как лидеру да ко мне приходят очередные четыре символа которые я должен закоммитить и это является подтверждением что прошлые четыре то что я подтверждал он принял поскольку он мне шлёт следующее не Напрямую это но он Лидер сообщает Сколько сейчас за комичен Там есть много достаточно нюансов Я бы не хотел на них сильно отвлекаться например А что если Лидер пришлёт мне записи 100 10 102 А у меня 1 2 3 4 сейчас на это надо отвечать отказом Пусть Лидер пришлёт 5 6 7 8 Давайте ещё какой-нибудь вопрос Ну я изначально думал что индекс - Это просто как ключ - это значение этого ключа но так как я вижу что Лидер комит это там имеет номер четыре Правильно ли я понимаю что абсолютно все записи условно говоря се реализуемые да то есть то есть вот этот Раф журнал он и нужен чтобы всё чтобы на всём чтобы весь кластер договорился про то в каком порядке записи были добавлены и соответственно у вас не может там комит перепрыгнуть вы не можете закоммитить по п не если Дея Коми Это значит что предыдущие тоже автоматом вместе с ней уже подтверждены что они плива а индексы проставляет Лидер и соответственно запись идёт всегда через лидера индексы проставляет Лидер Да запись тоже да Через лидера Лидер у нас единственный пишущий единственный ющий окружающих а фолловеры чисто пассивные Давайте дамы немножечко задерживаемся проте пожалуста и2 ИТ у нас и1 передавайте карточку дальше и2 и3 отрабатывай её по предыдущей схеме А и4 я попрошу эту это сообщение не обрабатывать вообще сделайте вид что вы его не видели зачеркните Порви уничтожьте всё сообщение потерялось начинаем Да и до 5678 оно тоже не дойдёт когда когда фолловер получает сообщение и видит Лидер комит 4 он ставит себе четыре галочки Да можно микрофон пожалуйста вот по скрипту который изображён у меня на слайдах Давайте отличать его и то что и тот хаос который реально происходит Я знаю что тут легко запутаться а ид и3 сейчас должны получить это сообщение сказать ок и после и третьего оно ни до кого не дойдёт то есть 4 5 6 7 8 всё мимо Угу спасибо тоже не вернётся А вопрос такой если я получил сообщение от сервера в котором написано что Лидер com 4 но при этом у меня этих четырёх символов нету Мне же нужно иметь какую-то случа когда эти данные понадобятся чтобы они у меня были Мне надо запрашивать в сети в кластере повторное отправление этих символов да Значит смотрите вам приходит запрос RC там написано в этом сообщении переданы записи 5678 сообщается что Лидер кот 4 А у вас в логе но говори 5 у меня ещ нету первых четыр Лидер Пришли мне сначала первые четыре получается мы не совсем пассивны мы реагируем респонс вы тоже занимаете но как пассивность она же не так определяется В смысле вы сами не инициируется Да ничего так кого надо ждать готовы дальше двигаться Потерянное сообщение Маленький вопрос вот и2 на прошлом слайде он у него уже есть четыре Да ему сказали всё хорошо ему там 5 6 7 8 Допиши и только сейчас он у себя ставляет App 1 2 3 4 Да потому что всё пока двигается Хорошо как бы да и у него есть И следующий инкремент пришёл Да да спасибо Так и4 и4 у нас падает и я заодно попрошу и один тоже сложить листочки Ну то есть естественно в реальном мире это происходит одновременно А4 упал сначала потому и сообщение потерял всё понятно и один тоже ещё какое-то время поработал Ну и тоже устал Давайте по новой смотреть как происходит отказ лидера обработка отказа лидера Короче все подождали да Значит все поглядывать на часы Лидер долго ничего не присылает Иво первый это замечает и начинает новые выборы Вот давайте Иво у вас уже Терм будет Т2 То есть вы начинаете новый Терм когда начинаете выборы агитирует здесь-то у нас появляются ещё два интересных поля Last logex соответственно у и восьмого по скрипту по сценарию последний Ну вот как бы есть четыре записи да Прим смотрите они есть но они е не заны он не знает что их Лидер зал Да поэтому генерирует новый PC и отправляет в ластер и вот тут значит если предположить что вой переда карточку второму так как первый у нас недоступен то у нас появляется е одно интересное прави Голосова голосовать можно только если кандидат который просит за него проголосовать у него либо Терм больше либо записей больше зачем это нужно чтобы ребята которые проснулись после долгой спячки и такие э у меня пустой Локс голосуйте за меня чтобы они выборы ни в коем случае не выиграли Да и вы можете уже заметить как это работает лидерам нужен кворум чтобы собрать кворум у вас журнал должен быть длиннее чем у половины кластера соответственно если какой-то записи на большей половине кластера нету то и стать лидером такой инстанс не сможет и это нам сейчас поможет сейчас всё постепенно прояснится вопрос слушаю вас только возьмите пожалуйста микрофон а есть взял да Вопрос такой про часы прозвучало случайно алгоритм не базируется на основе того что у всех узлов должна быть часы одинаковые нет одинаковость часов вообще не влияет А как тогда они с термами тогда получается как они определяют что вот они подождали И следующий Терм они не ждут следующего терма Они ждут какое-то время если долгое время не приходит никаких сообщений то это вы начинаете новый Терм то есть Терм - это логическое время А там харби и Пингви Ну то есть хабит никто не отменял Ну вы кажется уже ответили как восьмой понял что Лидер умер по таймауту да то есть восьмой понимает что долго никто ему ничего не шлёт Лидер ничего не шлёт а Лидер ему должен слать либо вот эти App если у вас нагрузка на сте есть Ну либо хотя бы Хард биты Да а что в raft State пишет и2 при отказе голосовать за и8 А давайте смотреть Да по слайду значит он я поставил прочерк вообще не очень принципиально Что именно туда будет написано implementation specific но главное пометьте что вы в этом Терме уже голосовали и проголосовали против и больше голосовать не будете то есть нам Главное чтобы голосовало один раз А что здесь ещё интересного есть а Last Log Икс да я уже сказал что прежде чем отдавать свой голос за Надо проверить что у кандидата Log действительно длиннее и вот например у и2 и3 они у нас уже получили запи от первого того лидера соответственно ид ИТ отвечают не А и голосовать отказываются слушаю вас длиннее или не Короче не короче спасибо спасибо за поправку да кого надо ждать Поехали дальше нет чей хост ВС е лежит первый хост ВС е лежит получиться Вот такая картина листочек сделал полный круг или я Ну ладно поднимите ли руки у кого не так Микрофон пожалуйста а почему ид ИТ отказались потому что Иво у нас кандидат он агитирует всех голосовать за него он всем рассказывает что у него есть четыре записи Ну вот собственно его состояние слева проведено Да у него четыре записи а а у и2 и3 вос записей они больше получили ственно чтобы и8 отстав случайно выборы не выиграл ему и2 и3 говорят не чувак нельзя тебе вот поэтому но они же не зали их или как там не подтвердили ВС равно вопервых ид и у них как раз уже четыре Нури за отставшие узлы вот и8 в понимании и2 он отстав Да у него журнал короче но не должен такой инстанс стать лидером вот поэтому ид А в то же время и 5 и 6 и 7 и8 никто не мешает голосовать также потому что у них абсолютно тоже самое безрезультатно лидера в этом Терме у нас нету потому что чтобы стать лидером нужно N пополам П О И мы переходим к следующей активности и вы сейчас увидите Зачем собственно вот это вот всё делалось потому что теперь у нас и4 возвращается онлайн и начинает выборы Да вот он Побыл чуть-чуть офлайн слуша ум того что вышло уже от надо брать нет от восьми у нас конфигурация кластера фиксированная то есть 8 пополам плюс О мы пополам будем считать всегда от полного количества да то что у вас больше половины кластера офлайн это не значит что кластер стал маленьким отнюдь А мы считаем индексы те которые уже или unable тоже учитывается при выборе голосовать не голосовать за лидера всё понятно Ну unable кому он нужен в оперативен и не было ваших Аблов Я и4 у меня вопрос откуда я знаю что Т3 отличный вопрос Спасибо Сейчас я расскажу значит по-хорошему в реальной жизни и4 когда проснулся и долгое время е ни от кого новостей не получал но мы предположим там что и8 я не знаю что с8 произошло но Придумайте что-нибудь реалистичное неважно в реальной жизни и4 конечно должен начать Терм Т2 он ничего не знает про то что там что-то происходило без него Но мы с вами время сэкономим вот этот вот момен когда и4 начинает Т2 все пото у всех уже Т за голосовали там все голоса свои уже подавали соответственно у4 Т2 тоже закончится провалом мы вот эту часть пропускаем и сразу начинаем Т3 это чит чистый чит не переживайте он начинает голосовать та у нас на предыдущем шаге только и2 успел зако и3 не успел закоментить тогда за и8 было бы больше половина голосов правильно Да и получается что у нас кластер в каком-то отстающей состоянии потому что У лидера нету 5 6 7 8 А смотрите в какой ситуации мы сейчас находимся у нас есть иче и 5 и 6 и 7 ИП инв у которых есть по и Угадайте что произойдет сейчас вот заполняется точно так же мы с вами сейчас должны получить Вот такую картину пять голосов и у нас и4 сейчас станет лидером можно сюда микрофон пожалуйста А если у нас два сервера начали голосование одновременно скорее всего такое закончится ничьей и Терм закончится без лидера и кто-то раньше кто-то позже начнёт ещё один Терм и тогда уже есть шанс что выборы закончатся успешно чтобы такая история происходила пореже в рафте специально предлагается в от до 2 базовое время настраивается А вот реальное в зависимости от случайности будет варьироваться это нужно специально вот чтобы как раз вероятность Сплит вота снизить так в каком у вас состоянии Скажите мне пожалуйста кто что делает я перестал что-либо понимать й вони что не может быть лока в стадии Сплит вота что постоянно два каких-то сервера пытаются выдвинуть себя как кандидата и постоянно получают равенство голосов Ну гарантий никаких нету на этот счёт но рафт старается вот той рандомизации про которую я только что сказал он старается минимизировать вероятность такого события Поэтому вот у Сплит можно говорить только о вероятности того насколько произойдут СБО опять-таки кого волнует если есть живой Лидер и он работает и не падает кого надо ждать одна рука и сейчас дальше поедем кажется мы сломали ваш скрипт у нас упал пятый соответственно у нас получилось проголосовали за 4 А все остальные Ну кроме первого голосуют против а он жёсткий диск с собой забрал вам не оставил он пока молчит В смысле Ну подождите у нас первый инстанс поднялся или нет Нет первый у нас всё ещё оффлайн Ну всё хорошо жёсткий диск при нём не отдаёт Мы же не знаем что у него там на самом деле если он молчит м значит у вас не получится выиграть выборы види нас кворум не сойдётся у нас нету пяти подтверждённых записей Сочувствую вам выли ваш кластер на запись недоступен то есть да в этом весь и прикол что ничего страшного не происходит Просто кластер стоит недоступный на запись вот такой ше слушайте Извините а эту тему продлить а в итоге кто матирует тогда между нодами трафика не очень понимаю лидер лидер а лидера же нет хорошо кандидат Ну на кого на кого сечас от пользователя запросы приходят на кого бы сейчас запросы пользователь Не прислал ему любой иера скажет что у нас сейчас идут выборы пока Извините 500 понятно не не 500 Кто у нас там так всё едем дальше едем дальше а то сейчас народ заскучаешь подруго в ст Нарисуйте корону принимайте запросы от пользователей их там накопилось предостаточно какие-то другие запросы Да вот там было написано я здесь написал voltage вы думаете что-нибудь своё и давайте тоже сразу недолго ожидая реплицируемый а-а записи новые 5 6 7 8 но значения уже другие которые этот Лидер на принимал от пользователей про старых он ничего не знает и смотрите шутку у нас до сих пор Лидер комит на и40 потому что то самое сообщение С Лидер коммитом 4 до него не дошло но это не помешает ему - существовать дальше Кто готов поднимите руку пока никто вопрос вопрос от ИТ на предыдущем шаге я немного забыл вот в мы когда голосуем против мы записываем прочерк или мы дожидаемся результата и потом записываем лидера Вы можете сразу записывать прочерк То есть это Это ваш голос это не текущий Лидер Да и то что вы проголосовали за и4 не значит что именно он станет действительно лидером Возможно там кто-то другой набрал кворум а у вас был минорити вот поэтому сразу ставьте прочерк ну как бы вживав роль Да слушаю вас а вот я и4 который выиграл выборы те записи которые я уже имею Я могу сделать app Да нет а те записи которые у вас есть Вы не трогаете но мы вы можете дополнять ээ следующие А те кому я сейчас передал новые записи они помечают ране Ну вы сейчас отправляете Лидер комит ноль То есть вы абсолютно честно рассказываете что вы не знаете что у вас там как а вот я сейчас боюсь соврать возможно косвенно из того что вы выиграли выборы может следовать то что у вас Значит так как вы выиграли выборы уже гарантирует Что за вас проголосовало большинство Это значит что у большинства эти записи есть и отсюда следует что вы можете их закоментить но опять-таки я по сценарию к этим ухищрения не прибегаю просто продолжаем писать Лидер комит но Ну и ничего страшного не произойдёт просто Попозже У меня третья нода у меня Алат там на четыре р comit приходит ноль Лидер комит ничего страшного игнорируйте Ну то есть да и4 ещё не знает А вы уже знаете вы молодец а и4 узнать чуть позже секундочку Сейчас микрофон а когда и2 и и3 получают новые сообщения с индексами которые у них уже есть мы их Как должны это интерпретировать ид и3 О ну вы уже про следующие сейчас до этого дойдём подождите пожалуйста так так сейчас Дайте я синхронизируются слайдами значит у вас и4 отправил карточку значит дальше вы её передаёте и5 и6 и 7 и8 её обрабатывают там ничего сложного вот это вот прошли поднимите руку кто вот этот шаг прошёл мо вопрос Можно вопрос я i8 сейчас получается яд потеряю да то есть у меня только ха записано и нет алаев сейчас мне придёт w и я перезаписи вам приходит W 5678 567 Ну не Нет не ставите потому что Лидер комит вам приходит Сейчас ноль так давайте наоборот кого надо ждать Вас надо ждать да Хорошо я вот пока на этом слайде остановлюсь чтобы вы уже поразите сная ситуация когда вот этот вот 5678 во новый дот доста доброго и который когда-то бым Кстати да В этот момент как раз вернётся онлайн И вот первое что он получит - это новость о том что он больше не Ну что поехали вот сейчас ещё чуть-чуть а третья но у третьей ноды же у нас и о ид ИТ примерно в одинаковом состоянии соответственно третье ориентируйтесь на первый у вас должна быть Вот такая картиночка хорошо начинаю рассказывать Подробнее по просьбам Трудящихся значит смотрим на и1 и1 вернулся онлайн первое что он получает это сообщение с термо Т3 от некого и4 который говорит э типа записывай себе новый 5 6 7 8 И во А ю1 у нас был лидером а в этот момент значит правило простое увидели новый Терм сбрасывается состояние до фолловерами что он их проспал не голосовал значит там голоса не было и уже не будет И фолловеры у нас подчиняются поэтому происходит перезапись журнала вот то что был написан Всё значит ему не судьба была Выжить у нас записи 5678 теперь вол А можно вопрос Да он вернулся а если он не вернулся всё жёсткого диска нет для этого есть другая процедура больше более сложная configuration CH это когда вы меняете топологию кластера и тогда вот там семь оставшихся узлов да на самом деле тот же пополам п о могут коллективно решить что вы больше не часть кластера но изменение конфигурации кластера мы сегодня проходить не будем Все ли готовы все ли пере записали свой журнал кого надо ждать нет рук Ну и три вам карточка дойдёт Вы то есть да Надо надо точно также поть записи тоже все когото покиваем пишем заново и значит там был Ещё вопрос с просьбой поподробнее объяснить что такое Лидер комит А ну я попробую конечно Значит когда Лидер отправляет это сообщение Он в коммите пишет то что он знает сколько сейчас записи законо Ну у нас это синоним аду поэтому и4 например когда заполнял он туда написал но потому что у него он не знал Есть ли что-то законное а получатель соответственно слушает и подчиняется и ну как бы использует эту информацию чтобы у себя пометить записи как замеченные зать их к машине вот и вс просто одна чисел которая переда онный кусочек информации что вот тот старый хвост журнала уже всё готов созрел закон можно применять это последний App Икс да Вопрос У меня когда у нас передаётся сообщение Вот это вот rpc в принципе ни одна нода не может поставить там крестик я правильно понимаю у меня там записано сейчас мне от лидера приходит что там должно быть яу фактически крестиков быть не должно за исключением того что я поломался в нашей игре крестиков быть не должно в реальной жизни крестик означает что значит вам приходит запись 5 6 78 А у вас в журнале Пусто и вы говорите крестик я 5 6 78 сохранять не буду пока вы мне не пришлёте 1 2 3 4 вот такие крестики бывают легальный абсолютно в рафте означает Ну вот как я сказал а мы с вами на самом деле подбираем к концу ещё немножечко терпения и мы закончим Давайте посмотрим у нас карточка должна вернуться к и4 наконец-то со всеми галочками хорошо И вот наконец-то в этот момент и4 понимает что он восем записей уже законо может проставить восемь галочек App А прежде чем вы разбежимся Но я ещё немножечко поговорю значит Давайте ещё раз пробежимся что мы прошли а выборы лидера раз репликацию журнала 2 поломку spit потерю данных о журнала прошли не прошли например изменения конфигурации не прошли всякие снапшоты потому что вот тоже интересная достаточно тема А что делать если журнал большой А ко мне приходит Новый узел и говорит что у меня пустой журнал не бу вот это вот всё за там 2 года жизни кластера пересылать поэтому там есть Log compaction там есть отправка Snap чтов и вот значит сейчас я вот сюда подгляд ещё две интересные фишечные в игре не так просто продемонстрировать значит Есть такой баг Вот про ты сейчас будет рассказ значит вы сейчас видели как например организуется Сплит Когда вы просто не можете набрать голосов А теперь представьте себе ситуацию Когда у вас сеть порвалась как-то странно например в одну сторону и вот сидит Там и пятый десятый сообщение ни от кого не посылает а его все слышат у него там в одну сторону сообщения не доходят зато сам он не упал и всё с ним нормально Он что делает он таймаут начинает новый Терм рассылает всем что у нас новый Терм старый Лидер который там был уходит вли кластер недоступен на запись начинаются новые выборы А ему Ответ Никто отправить не может Вот эта особенность вскрылась достаточно скоро после выхода алгоритма после начала коммерческого использования и быстренько этот алгоритм расширили вот под назва то есть что там нужно делать чтобы вот такие нехорошие инстансы Да я хоть и сказал что от византийских Атак не защищён но всё-таки немножечко приходится вот чтобы такие полурак работать не мешали там прежде чем запускать настоящее голосование проводится сначала предварительная стадия когда мы при не инкремент тер вообще проверяем а за нас кто-нибудь будет готов проголосовать если я таки его промен или нет в микрофон пожалуйста объявляется избирательная кампания Ну да ри это то не то я вот не знаю термина значит оно отлично и ещё одна важная тоже история из алгоритма рафт которую стоит упомянуть это кворум чтение вот с вами всё что делали это записывали Но грубо говоря А что делать если пришёл клиент и хочет просто прочитать Да потому что ну он приходит на какой-то конкретный узел говорит там Чему равен X ему такой три а эти данные протухли вот чтобы такого не происходило рафт позволяет ещё чтение тоже оснастить собирать кворум на операции чтения и э тогда у нас ещё и чтения будут То есть у него нет механизма либо как бы сделать какой-то комит что либо всё у тебя сообщение должно дойти либо только часть А ну либо всё либо ничего То есть такого у него не получается у нас всё ничего относится к каждой записи вот у нас есть восемь записей 1 2 3 4 он четыре действительно отправил Они целиком записались А 5 6 7 8 вот те которые он предлагал никто не принял и они были пере записаны Ну клиент же ему прислал 1 2 3 4 5 6 78 клиент ему восемь клиентов условно говоря прислали 1 2 3 4 и вот четырёх клиентов он обслужил сказал им ок закамини и ответил 200 а другим восьми он ничего не смог ответить потому что потому что сеть пропала А я готов на этом то есть всё Мы ребят с вами закончили Всем спасибо за внимание э я готов дальше отвечать на вопросы э слушаю вас такой вопрос э значит если э алгоритм raft стерилизуют запись то фактически э у нас появляется некоторая замедление работы с данными в базах данных распределённых когда используется raft используется много параллельных протоколов условно говоря на каждый Бакет свой чтобы было много разных лидеров Ну вот к примеру шарды или там партиции в кафке кавка тоже на рафт переходит то есть каждая Прай партиции получается имеет свой поток ратов ского протокола или нет Или это что-то общее есть такая фка Когда можно в рамках одного продукта сделать много маленьких рафт кластеров например на партию и у вас Один узел будет участвовать сразу в нескольких рафт кластерах и соответственно Ну там несколько рафт журналов и несколько стейтон там значит за эти за этой партиции следят там один набор узлов А за другой партией Вот они так внахлёст чуть-чуть вот такой бы раз раз смотрите клиент прислал на мастер на текущий Да на запись данные о том мастер соответственно у себя эти данные записал по всему кластеру отправил сообщение о том что их тоже нужно записать да и в какой момент клиенту отдаётся подтверждение когда мастер Получил информацию о том что весь кластер данные запи или же Вт ко стр себе это записал или это на реализацию опять же откладывается нет строго строго не раньше чем запись была закамини действия с кластером как увеличение количества нот уменьшение количества нот там ну удаление добавление они же тоже по идее должны подчиняться Ну такому же РАФ голосованию сонно если лаер находится в состоянии когда доно и только доступны он по сути У нас бесконечны выбора или там допустим кластер как в этом случае мы можем подтвердить изменение конфигурации кластера Допустим мы захотели как раз вывести это состояние добавить ноту там или уменьшить количество но вот административное такое вот воздействие оно как вот с этого состояния кластера нужен точно такой же кворум в нашем случае п инстан а если этого кворума нет то увы ничего не поделаешь вплоть до полной потери кластера Ну сейчас я чуть значит ещё чуть позже расскажу как с этим всё-таки можно бороться значит там базовые операции изменений конфигурации есть добавление узла вывод узла и вот вот что ещё в рафте прикольное это так называемый Joint как это по-русски соединённое наверное состояние Joint State Когда у вас кластер находится в таком режиме перевода и вы говорите что значит там я хочу одну ноду вывести и одну ноду добавить и одновременно чтобы это случилось атомарном ни в каком из промежутков вот значит он это поддерживает ну там это реализовано через Joint State там кворум надо очень по-хитрому собирать то есть там для любой записи вот в таком состоянии нужно собрать марити в обоих половинах причём применение вот этого способа оно как бы не ограничено там добавлением удалением одного узла Вы можете восемь старых узлов удалить восемь новых добавить и у вас как бы вообще кластер полностью меняется состав участников и всё это происходит как бы в рамках одного изменения конфигурации Вот но чтобы такое провернуть надо я говорю собрать кворум там кворум здесь тогда всё получится значит что делать если совсем всё плохо если у вас пять узлов отказало и вы хотите сохранить хо что-то на самый экстренный случай в рафте есть лазейка под названием тер ID То есть вы говорите что вот мой старый рафт журнал А значит я инициализировав новый рафт кластер с ним А старый кластер мёртв его больше не будет только так а у меня небольшой вопрос А в чём ключевые преимущества рафта перед другими способами построения кластера Ну перед кем например вот статья рафт Да и вообще все эти материалы они упираются на Надёжность ближайший термин на слуху Пакс например там сильно сложнее вся терминология я бы сказал и Ну вот так уже не поиграешь а Раф Он простой у него понятные критерии применимости это всё достаточно наглядно вот можно передать как я вам сейчас он алгоритмически доказан T что он работает Что ещё для счастья нужно Спасибо хочется спросить на самом деле Почему Нам нужен Лидер почему мы не можем каждую ноду обозначить условно лидером и просто подтверждать консенсуса каждую операцию отдельно что пойдёт не так и плюс К тому же ну вдобавок Да в кассандре сейчас аккорд по-моему Пит Да и это вот в принципе по-моему идея примерно такого рода Да насколько слабо Я знаком с аккордом Если я правильно помню это другого уровня протокол который либо пас использует под капотом для низации логов а а саму суть протокола он ещё уровнем выше навешивается что вот у нас есть механизм который позволяет нам консистентной последовательность Какую мы скажем А давайте построим на этом там распределённые транзакции да Сначала каждый запишет себе Вот этот пайплайн выполнения каждой транзакции и Если вот мы договорились Как мы будем их выполнять то дальше все участники - всем участникам не составят труда договориться В какой момент э-э значит эти транзакции фиксировать но аккорд выходит за рамки нашего мероприятия Так что у вы А смотрите такой вопрос я правильно понимаю что вообще нет смысла от рафта допустим в кластере из трёх нот Потому что если одна падает то две оставшиеся не договорятся образует кворум ИТ - это как раз хороший сценарий трёхногий ецд то что надо Нет как они Ну допустим если Лидер упал опять в середине как у нас было да как они договорятся между а или там надо вот этот флок да перегонять на отстающих они образуют кворум одна из них сможет выиграть Лидер выиграть выборы стать лидером и Продолжить писать ВТО соответственно у вас трёхногий кластер существует живёт и здравствует пока два из трх доступны это ну как раз минимальное необходимое количество услов чтобы рафт имел силу вот два узла действительно смысла имеют мало потому что по одиночке никто из них один без другого жить не может но у вас как бы вот два инстан есть и вс один упал кластера нет гоняем флок Если вот мы отстали Угу нам надо догнать флок получается правильно это вот как вообще схематично он хотя бы происходит как догонять рафт Log Ну вот мы рассматривали ситуацию что ко мне приходят 5 6 7 8 а у меня ещё даже нет 1 2 3 4 Угу я отвечаю всегда отказами получается На любые следующие сообщения Ну и следующим сообщением вам текущий лидер Должен эти 1 2 3 4 прислать Ну он же должен узнать что у меня или вот этот отказ он означает что всегда с Ну значит базово если вот говорить про какой-нибудь implementation specific там конкретной реализации Как делается в сообщении об ответе есть хинты которые говорят что типа это я заперти не могу потому что у меня сейчас ноль записей в логе и отсюда как раз лидеры узнают то есть там в реальном мире карточки не такие ограниченные по пространству да чем обусловлен отказ при голосовании когда кто-то сообщает что у него там либо данных больше либо больше записей закамини данных было больше несмотря на тох их меньшинство таких нот Да почему не считать ну чем обусловлено вот такое поведение алгоритма что Несмотря на то что есть кто-то кто знает больше всё равно Выигрывает тот у кого меньше сейчас я попробую наглядно на этот вопрос ответить на кон что было бы плохого если бы выиграл тот у кого данных больше если он выиграет он сможет заорать записи и вот то что у нас и4 проделал например Так ну где у нас тут и4 что-то проделывает Давайте смотреть перезапись журнала и4 начинает выборы но он сейчас кворум соберёт А вот Представьте что эти данные были бы ещё на 78 то есть на 78 тоже было бы больше данных Да А4 ВС рано выиграл были выборы и смог бы зайди данные которые на самом деле на больше половины кластера уже есть то есть здесь Фишка в том что чтобы закоммитить данные нам нужны N попом п1 и чтобы затереть данные нам нужны N попо П 1 и вот то что у нас не может как бы то что группа такая большая и вот как минимум один в пересечении всегда находится ин что мы вообще можем не знать какие там данные были законы Какие не были но покуда мы этим правилам следуем данные которые есть в большей части узлов они уже никуда не пропадут и со временем мы таки узнаем что они были записаны подтверждены я правильно понимаю что смотрите Да значит Лидер не успел отдать ответ клиенту Угу потому что меньшинство Ну раз мы перетёртое отдать ответ клиенту и это как бы норма для нас да Да всё так то есть вот оно всё как раз ээ согласуется А можно как-то проговорить основные ограничения ф вот в каких ситуациях ф плохой выбор например насколько я знаю он является не самым лучшим вариантом если у нас есть какие-то сетевые проблемы например между двумя дата центрами или что-то такое и есть какие-то альтернативы для таких разных кейсов разных ситуаций у рафта очевидный тне есть это Лидер и вот в тех случаях когда нужен нужна реальная распределённая система сильно параллельный там в ход идут такие слова как Пакс мульти Пакс и что-то другое Я сегодня уже упоминал что византийские атаки рафт от них не защищает соответственно если нужно что-то такое то блокчейн это первые два которые приходят на ум ограничения остальные пока не подскажу Спасибо ещё у нас есть вопрос здесь по центру поднимите руку а Итак всё Пойдёмте в кулуары не так быстро а не так быстро точно вопрос Я же должен был запомнить я забыл а вот Давайте Николаю он активно доста участвовал подарим ему подарок за вопросы Спасибо за ваши вопросы Давайте поблагодарим спикера за этот прекрасный мастер-класс если у Вас будет желание собрать консенсус ещё раз то ловите Ярослава в дискуссионной зоне и прогоняй с ним это всё ещё раз А у нас ещё осталась раздатка шучу ещё всегда Можно напечатать что ж Спасибо тебе за эту прикольную историю Спасибо Давайте ещё раз поблагодарим спикера"
}