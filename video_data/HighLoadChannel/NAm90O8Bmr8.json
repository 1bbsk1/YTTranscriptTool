{
  "video_id": "NAm90O8Bmr8",
  "channel": "HighLoadChannel",
  "title": "JIT-компиляция запросов в ClickHouse / Максим Кита (ClickHouse)",
  "views": 844,
  "duration": 2288,
  "published": "2023-01-19T06:56:45-08:00",
  "text": "всем привет меня зовут максим я разработчик или coles и сегодня моем докладе мы поговорим про то как мы копируем запрос и с использование jet компиляции криков план моего доклада будет примерно следующий для начала мы поговорим из каких частей вообще состоит выполнения запроса вплетался что такое логический физический план запроса клипов затем мы поговорим немного про базовые вещи и бюджет компиляции немного про историю как магнит reality компиляции и затем мы на трех примерах разберем как в принципе некоторой части запросу можно компилировать получать за счет этого он лучше сначала следует сказать что увлекался это база данных которые хранит она и пока логично это важно так как например при запросе только необходимые данные диска будут прочитаны но также следует отметить что кликов не только хранит данные по колоннам но и обрабатывает тоже потому что единица обработки данных запросе называется блоком блок это просто массив колонны какого-то заданного размера потом это 65000 строк и почему вообще такая конфигурация работает такой как отрисованы берет выполнение основная причина то что компилятору если данное обрабатывать таким вот образом удобно например циклах использовать векторизованное инструкция также приятно работает для процессора используется хорошо пиши pipeline процессора есть и целом работает робость если провести что-то еще колонка то в целом все базовые колонки то просто некоторыми сильно вот если мы будем говорить про колонки и америк типов например учишься 432 плод то это просто массив у нас называется пузырей это аналог stood вектора и стандартные библиотеки и основные его отличие это то что во-первых он использует алла кратный у которого есть интерфейс с методом realloc также он так не делается дополнительными с этого места и еще одно важное улучшение за то что во время например по операциям котик это нужно из одного массива данной скопировать другой массе дополнительно мы имеем в конце по 1 и нам не приходится обрабатывать хвостик прокрасться мимо если говорить про более сложные колонки то они состоят из них оставили эта композиция более простых вот например но упал колонка это какая-то комок астральными и колонка uint8 который отвечает принципе как некоторые битовая маска новый элемент или нет например который также представлен колодкой какой-то сданными и еще дополнительные колонки с офф сайта и в самом простом случае есть какая-то константной а колонка она представляет из себя просто одно значение теперь 190 поговорить про певцы кликал себя как я уже сказал что данная обрабатываем около ночь на то с функцией довольно простой про принимает несколько колонок его со шведкой и стоит заметить что на примеру в большинстве случаев чтобы это все они там дела нам нужно использую много специализации так ребят ли функции плюс это конце deploy для для всех комбинаций которые только могут быть в идеале сгенерировать специализации вот например что могу это сделать а функций пес на space opera типы и плотности около 10 по может быть как-либо изменять как правый аргумент не так же один из этих аргументов может быть констант и в целом на все это нужно примерно 400 специализации мы действительно всякими там использует преимущества такого подхода к тому как у нас сделал уницикле кофе во первых мы обрабатываем данные по колонкам и в качестве случаев функциях внутри будет из а некоторые цикл который просто и тренируется по колодкам или например компилятор может довольно эффективно его реализоваться использовать например сил деструкции затем стоит отметить что в принципе добавить функцию клика устава это просто большинство например каких-то внешних атрибутов приходит как раз такими патчами принципе это сделать довольно просто за счет того что у нас отлично интерфейса и хорошо изолирована ноги нас и че такого подхода это во первых у нас возникает принципе распухание кода потому что нам приходится много таблеток использовать за счет испарения flight of принципе некоторых местах карта вольно сложно становится его тяжело как-то поддерживать и еще один из минусов про котором мы будем говорить позже что например если у вас есть несколько функций такой пример дикси умножить на y плюс 5 то мы бы хотели как-то эти функции скомбинировать в одну вот текущей интерфейс такого делать не позволяют нам придется для начала x умножить на y и затем еще прибавить 5 и теперь поговорим немного про выполнение запроса в принципе выполнение запросов прям все ничем не отличается от выполнения запросов больше средств ухода то есть основные шаги такие же первый шаг это это тот запрос который нам пришел например по ешьте теперь и или таки happy мы для начала должны его распад этого мы у нас есть собственноручно написанные портьеры и запрос мой парк символ abstract syntax 3 абстрактно синтаксическое дерево затем на его уровня мы делаем некоторые оптимизации в принципе большинстве случаев они довольно просты и пока что хотелось бы от всех этих оптимизацией избавиться и перевести их на уровень логического плана физического плана или дага выполнение выражений в одну потому что есть некоторые квесты оптимизация затем из-за вот это вот с темы для начала строй магический исполнении запроса деле мы делаем некоторые оптимизации логического план а затем из него можно делать физический план делаем тебя за от физического плана не начинают собстна говоря выполнения для всех вот этих вот шагов грехов все есть инспекция то есть довольно просто можно посмотреть что вообще происходит ну например может посмотреть вывести st абстрактности тактическое дерево с использованием команды expand если например нужно посмотреть логически японцы просто то тоже можно использовать команду explain то есть для такого запроса select брилев ложек него присоединить к из какой-то тестовой таблицы с фильтрацией и с сортировкой магический план будет выглядеть примерно так самым он начинается с принципом ваш 3s листовых узлов и поднимается номер или например если мы будем говорить про физический план и низкий план отличается логического тем что уже выбираются конкретные алгоритмы которые будут использоваться ну например там для агрегации может выбраться какой-то алгоритм для join of какой максимально оптимальной скоро определяется какое количество такой будет использоваться для выполнения запроса и выглядит он примерно так все нужно чуть побольше но тоже видно что есть например чтение пицца марш 3 потом какая-то фильтрация какая-то сортировка выполнение каких-то выражений так теперь поговорим немного про джип взгляд вообще что такое jit компиляция это такая техника когда мы генерируем машины код и выполняем его знает а то и исполняем его модель собственно пример таких систем это виртуальная машина hotspot джаве или песок вы 8 для java скрипта немного расскажу про то что мы используем для жить компиляции в принципе в этом месте есть некоторый выбор хотя конкретно у нас используется аллерген то есть мы используем реви для для всех этапов в регуляции на свингеры компилятор из вот этой вот библиотеки и что важно у нас написано для этого всего спой wrapper то есть мы прям хорошо разобрались как то эти вот вещи работают и не используем готовы компилятор по дефолту поливе им для jetta там есть несколько компиляторов из например axe jet air jet но мы их не используем нас написана своя бёрд теперь немного про историю как вообще я джек добавляли free клаус тут следует сказать что вообще это было не быстрый процесс и мы начали добавлять пример с 2018 года девелопер дениска багов богатов добавил первым имитацию компиляции выражений затем и и улучшали алексей алавитов и саша сайта ей удалось принципе отключить ее в продакшне 2019 году но затем к сожалению пришлось выключить возникли проблемы у некоторых пользователей проблемы такого рода что там где . что что ни одна компилируется каких-то случаях есть утечки памяти и принципе пришлось вот это все выключится но джейд остался как экспериментальная фича при помощи то есть его можно было включить под специальный настроек затем уже в 2020 году удалось подписать какие-то проблемы с компиляции выражений включить лежит по дефолту и это было доступно примерно с версия dust1 то что 8 вообще какие-то были проблемой почему это удалось принципе сделать когда обеспечить что принципе ну как мне кажется да сильно повлияло то что у нас много лучше стала система себя у нас появилось очень много фазеров которые находили проблема смерти что-то там не так скопировать затем упала в принципе не было очень больших каких-то трудов уже когда готовую презентацию которую там мы мы это официальные какие-то проблемы просто интегрировать и уже на нашем сервере стать дополнительно кишит затем в том же году удалось добавить чуть кооперацию для оператора грубой лень и вот в этом году удалось добавить компиляции для оператора ордер buy начнем и как бы говорить в общем проще компиляцию прогуляться выражение только перед основной тирский спрятался и давайте для начала посмотрим на физический план выполнения запроса вообще когда запрос выполняется довольно часто нужно посчитать некоторое выражение ну например фильтрация данном примере есть целью больше десяти и данном случае нужно выполнить некоторые выражения логическое которая в принципе крейтер называется cliff house если например мы посмотрим на проекцию тут видно что целью нужно умножить на 2 и прибавить еще единичку и для всего этого у нас есть отдельная трансформация она называется express and transport частичка фильтр transform он включает в себя экспаншен транспорту затем делает ситуации вот эти вот x прошлых раз пор как мы как раз поговорим сейчас подробнее вообще что как мы выполняем выражение мы делаем это дело во многих системах мы представляем выражение направленного циклическим графом у которого узлы могут быть либо некоторые константы либо функции либо колонкой сданы и затем плита это выражение нужно выполнять мы колонки станами условного мы делаем интерпретацию этого и был ее результат выражение быть находиться код на слайде есть картинка как это так в принципе выглядит для такого очень простого выражения a + b + c листовых услов у нас есть колонки это input узды и в других вузов есть корпус и плюс еще 1 плюс так теперь вообще какие проблемы с текущим выполнением выражений были но основная проблема из-за которой вообще следует следовал добавляет компиляцию это то что во время выполнения выражение полимент британцы вот этого вида рака данные приходилось где-то хранить каких-то промежуточных функциях и это было неэффективно вот даже в таком простом примере a + b + c видно что вы для начала но если мы это будем интерпретировать нам нужно сложить колонки альба хотя вот нужно поместить какую-то там пора ли колонку и затем нужно вот этого контроля колонку сложить фон кольца ну понятное дело никто так описать не будет если вам нужно было слушать три колонки мы просто написали цикл где балансировали коробка для с результатом и просто и три колонки служить и это действительно может быть значительно быстрее так вот туда-сюда когда нам не нужно хранить в некоторых некоторые топор и колонки это может измерить для разных функций чего следует заметить что у нас получается приказ я уже говорил что используется довольно много тогда это для функции и в самом месте например для функции плюс у вас около 400 специализацией из этого финального насильно распухает случает жить операции может убивать только те функции нам действительно нужно нужно скопировать осени дейсвительно никакого для запроса еще немаловажный фактор который следует упомянуть общих rekkles распространяется как такой универсальный binary и мы используем мы не используем самой новой strings и например вы 256 а вы x 512 по дефолту мы используем два расставлены не страшно с из 42 вот но когда мы используем эту операцию компилятор может выбрать самые оптимальные инструкции которые здесь на текущий машине брат армейском если они весь смысл для как от функции использовать если например ноутбук rekkles а также используем некоторых местах его x 256 я выспится 12 большинстве случаев мы это делаем через динамик dispatch то есть мы просто проверяем например если пытаться поддерживает экспорт 206 то можем использовать принципе специализаций увидеть как выглядит примерно алгоритм если говорить идей на то что мы хотим сделать у нас есть некоторый граф некоторое дерево выражение и из него мы хотим взять какую-то часть которая компилируется самую большую часть возможность их может несколько этих частей и скомпилировать их для этого мы ведь в каждом узле считаем количество детей которых можно скомпилировать затем это сортируется бы сначала апеллировать узлу который больше всего детектор можно скомпилировать все проверка того стоит ли коллировать функции нас довольно простая мы никак не ровно пример функции если а + б мне компилируем но a + b + c мы-то периодом то есть нужно чтобы был хотя бы один шанс который у которых компилируется но ведь из наса махнуться тоже нужно компилировать и дальше укрепилась примерно следующая от функции которое можно скомпилировать они все складируется в было такую специальную функцию и вот в этом вот графия на нее заменяются это место называется рельефом и в своем методе она конвертирует колонки руслан во время всего просто достает сыр и указатели на данные и вызывать участок лего ну давайте посмотрим например возьмем все тоже простое довольно просто выражение адрес офиса и посмотрим как оно могло бы скомпилировать примерно визуально то есть мы две функции соединили боднул и которая принимает три колонки а вырица и если мы посмотрим на все испытать спрошу до черного то может помочь то основной невский с это то что улучшается использование кэше процессора то есть резинка же 2 cache так как данные не нужно никаких там палий промежуточных структура хранить вот вторая довольно важная вещь это то что кода который следует выполнять его становится намного меньше он расположен на одной странице и пример теперь врач предиктор может будет работать лучше затем что тоже немаловажный факт мы избавляемся от вообще всех костных рисковать интерпретация это вот графа вместе с но приходится делать некоторые виртуальными зовут артур налога после на всяких вызовов и от ника всех избавляемся еще немаловажный фактор это то что когда мы будем станок для большего возможности калькуляторы для оптимизации потому что инструкция по + b + c compiler у проклята больше пространства которое он видит он здесь что нужно сложить а при сборе что это все нужно будет возиться довольно много дополнительных оптимизации можно использовать и я про это уже говорил компилятор в олимпиад по дефолту будет использовать самое лучше инструкция которые доступны самый новый страшно при доступна для вашего процесс какие вкусы вообще мог быть скомпилирован самое можно компилировать все любые функции конкретно у нас компиляция выглядит так что нам приходится генерировать такой специальный интернете 3 презентация язык он называется любимая и мы делаем это практически ручную самым если можно компилировать разными другими техниками сейчас у нас это сделала так например какие-то очень сложные функции батаков генерировать руками не очень удобно но вообще нас придерживается довольно много бинарных операторов логические функции и и вот например интересно еще дистанции это врач функции например и фильму и музеев такие птицы тоже давали что можно скомпилировать и это будет как будет работать ok давайте теперь немного посмотрим как вообще это выглядит если опуститься так скажем low level детали и возьмем выражение чуть-чуть посложнее а плюс b умножить на c + 5 и вот то что я сейчас показал на слайде так примерно выглядит это метит representation in which a до того компилятора вот эта вот система оливия собственно говоря я каждой строке написано про комментарий но тут видно что есть например мой тип like есть от есть адрес констант принципе этот интернете 3 признать и china beach представляет из себя можно сказать строго типизированный сэмплер в котором бесконечное количество регистров и затем уже компилятор использует специальные алгоритмы разместит словаря разложите бесконечное количество регистров некоторые конечно которые на вашей машине и вот тут можно заметить на стрижке есть и multipla и есть от есть с константой и есть 100 когда это все как это все вообще выглядит если мы посмотрели бы на то что мы скопировали вот этот вот интернете от representations следующим по обычно катина теперь плюс функции назвал довольно странно но должно быть понятно что мы как бы вся несколько функций и соединили в одну это монетку название a + b мы эти платья + коста и выглядит она пример примерно так . просто циклом и движемся по трем колонкам записан это все результат указатели на колонке мы им примете как-то так как то все выглядит финальном ассемблере и тут можно заметить что тут используется сент инструкции видно я на слайде также пометил что константа 5 она была замена с используем инструкции пеппи подкаст посмотри еще сверху и получился такой довольно хорошо какими зеленый цикл сколько общем все то стоит но для начала следует сказать что как все подряд вы не будете как минимум потому что вас просто хочется память для начала я скажу что у нас тут есть кашу опыт и флот ураган где-то 1 гигабайт у и там есть еще ограничение на количество функций которые можно скомпилировать если говорить про время то стандартная компиляция это выражение занимает примерно 15 миллисекунд там из некоторые довольно высокая константа и затем она растет примерно имеет и для типичных выражений нужно использовать если крестом americans лапшин одну страницу с ходом аллоцировать эту страницу с секций stand для данных или примерно в большинстве конфигурации если rover странице 4 килобайта это будет 8 . и также все это можно посмотреть сколько вообще тратить время на компиляцию с использованием инцидент с pixie clips например можно посмотреть сколько микросекунд компилировали с выражение сколько они занимали занимает бать теперь два интересно посмотреть насколько это вообще какие-то запросы улучшать вот этот вопрос вообще взят из продакшена и он совершенно не упираются в iping пусть он отправится в чтении но даже для такого запроса результат около 30 процентов увеличение производительности что довольно неплох если возьмем запрос который упирается только угу скорость процессора вы читаете sistar на борт чисто нам просто такая специальная система таблица из этой специальной системой таблице данные читаются давать выход оттуда числа и вот этот запрос полностью питается теперь и улучшение будет около трех раз то есть это довольно можно открыто происходит как раз за счет того что мы совершаем меньше in direction of один такой цикл соединилось стабильно хорошие улучшения есть еще такой интересный узкий когда у нас например много функций их принципе реально за просто такое бывает довольно часто если на тебя нужно писать какую-то логику местам и если значение такой-то такой-то такой-то и вот этот вот такой сценарий у нас тоже компилируется и для каких-то вот этого примера улучшения примерно два с половиной раз теперь у нас также в можно скачать посмотреть метрики для запросов на данном графике фиолетовым это запрос это значит компиляции то есть скорость выполнения принесешь выполняет обтекает какая-то метрика и зеленом уже после джед компиляции тут следует заметить что и может что на графике видно что часть запросов нет несколько зелёных треугольников находится рядом с филе от момент это происходит потому что мы в общем компилирую выражение только если встречаем одно и то же поражение три раза и там как раз наш новый год таки зеленом треугольника а слева это как раз уже запросов после jit компиляции мы видим что количество циклов сыпью значительно меньше если посмотреть на крышке цель то после же компиляции и вообще практически нет и если например посмотреть на брачный за то они тоже увеличились не так как сильно конечно но все же довольно серьезно хорошо сейчас мы поговорили про компиляции выражений но прекрасен и какие уровни только выражением они пример еще умеют блевать оператор группа если мы посмотрим на логический план выполнения какого-то запрос из грубая так далее на физический план то мы увидим что здесь есть так что который называется берегите транспорт методы кредите траспортом как раз будет отвечать за агрегации и как вообще устроен агрегация фреклз самым она устроена примерно также как на некоторых системах но довольно optime деле довольно сильно оптимизирована под множество сценариев например у нас есть около 60 различных оптимизации под разные типы данных хэш-таблицы таблица для строк но если вот говорить на таком высоком уровне у нас есть следующий сущность у нас есть оптимизированной хэш-таблицы которая для каждого ключа уникального хранит состоянии агрегатных функций например если у нас допросе несколько книг там будет этих вот нескольких агрегатов курсы для них будет одно состояние просто по разным об этом каждой функции можете всем созданием работать и есть такой объект агрегатор который связывает агрегат на функцию и собстна говоря каждый блиц и агрегат дохните ничего про какие хэш-таблицы не знает что beats понятное дело тоже ничего не знает про агрегатная функция довольно неплохая декомпозиция если посмотреть на интерфейс агрегатных функций стал похож на например на похоже во многих если вы хде она примерно так же для агрегации принципе для того чтобы работать состоянием агрегатных просто нужно примерно четыре метода это метод для естественно создания состояния агрегатные функции для его изменения например тайсон если но можно поменять состоянии ребят над ниц и для какого-то ключа естественно нужно сделать просто сложение вот затем если у нас происходит регаться по много потоков а почти всегда так и происходит после того как к сама агрегация произошла у нас наступает этот мерно когда состояние агрегатных функций для включения необходимо соединить и вот операция меж как раса должна 25 агрегатных функций склеить например для функций сон это будет просто положение и и затем не тот который после того как прекрасно произошла обставит ее вставить результат агрегации в салон например в случае с вич не может быть состояние это сумма и тандер и в конце как раз таки производителями то есть собственно поделиться атлантов и уже результат можно будет ставить в около рассмотрим такой пример с пятью сломит и для не могу будет делать примерно такие дети для каждого уникального ключа нужно будет создать состояние для вот этих вот этих вот и крик от функций затем для каждого ключа которым 3 время агрегат состояние нужно быть пересчитывать агрегата пересчитывать конкретных функций данном случае tucson затем если у нас происходило крепятся он поможет а потоком по умолчанию rehau sib происходить и будет нам нужно будет эти состоянии помешать каждый лист с этими состояниями и затем для каждого плеча вставить результат ну естественно для каждой по то вот это вот эта вещь про который я говорил также не поддерживает соединение влага функции вместе и довольно сразу напрашивается решение давайте попробуем все эти действия как бы склеить какие вообще проблемы с текущим методом есть еще ну во первых как я уже показывал у нас вода песнях возникает довольно много виртуальных функций и это может быть проблемой такой виртуальный функция довольно плох оптимизируется также например для нового колонна когда мы реагировать полагал колонке у нас возникает дополнительный слой косвенно sti так как у нас sexy функции которая умеет работает на трешку стасу для долбил колонок вокруг ниже для владельцев декоратор и вот этот декоратор добавлять дополнительные косность и например если у нас есть какие-то комбинаторы например if или array препарат можно писать cold iv эллисон и и туда и там использует некоторые предикат также сделано через декоратор и пути дополнительный уровень косность и в целом как я уже сказал довольно простым решением которые сразу приходит ну давайте попробуем все эти действия для и склеить в одно либо не как из этих действий для но что функции сказать одно например мы можем это же местам 5 пацан мы можем к сестре не и для них создать одной функции но не вызывает 5 виртуальных функций также мы можем добавление значение для них мы также можем скомпилировать функцию для биржа и для финальной ставки и что мы таким образом в общем декорировать увлекался полтаву поддерживаются основной функции для компиляции это самка und миль макса вверх и через как мог совершить также мы поддерживаем их комбинатор и global карат и если посмотреть как это вообще примерно выглядит она примерно такого какого-то интуитивно уровня если у нас был такой запрос сумма веришь свами макс стоит офис компилируется в такой вот одна функция довольно интересно что вода примерно пример со множеством сон такой довольно частый пример например подошли у некоторых людей бывает и 100 и 1000 сум в этом запросе и насладиться что мы вот эти вот 5 функции скомпилировать такую вот эта функция которая будет действие делать будто бы одновременно лепить и вот эти вот 4 действий create наш концерт или давайте посмотрим насколько это вообще может улучшить производительность если например возьмем такой пример с этим словом скомпилируем их то это около 30 процентов улучшения в принципе это довольно серьезное улучшение и вот почему агрегации у нас прихожусь оптимизирована довольно сильно и примерно спикер сказал используется довольно богат кастрик специализацией специальные таблицы алгоритме довольно хорошо оптимизирован но вот эти вот три спа-центр сверху это довольно серьезная где она серьезно результат если мы посмотрим с каким-то с дополнительным уровнем косности и вверх и сделать гектор предикат и использование слова в результате улучшения при длительности будет будет даже больше около 70 процентов если посмотреть на графики то мы уменьшили количество циклов торжественных количество конечно софт понятное дело никак не гни изменилась но количество горячий песок изменилось довольно сильно как раз таки происходит зачитывал что мы убрали принципе все слои косности и пролить его только виртуальных язык окей и теперь одна из последних вещей которого вообще добавляли в клип хаусе так компиляция компаратора в app to buy если мы посмотрим на физический план выполнения запроса например в какой-нибудь сортировкой свет в очереди из какой-то таблица вдоль боевой очереди и портрете мы видим что тут есть некоторые трансформации которые связаны с сортировкой это паша сухих трансформаторов чертик transformed а месяца то чего принципе выглядит довольно круто на но сейчас я постараюсь объяснить для чего не нужны начали строиться прошло 40 transform она нужна для того чтобы блок который был прочитан например диска или вот цитировать также она умеет делать специальную оптимизацию если запросе указан иметь затем используется мир сортинг transform и мирских распадом сортирует блоки используя кого мир стал третьим и его а потом является steam отсортированный блок и внедренцы transform сортирует с 3 мы уже сортированный блоков также используя к выбежал горит и если вообще посмотреть в пир топ когда все вот это вот операция выполняется мы здесь видим некоторые потоки сорт некоторые класс мир сортер но был также почему то увидим комплект и вот этот вот compared он вообще будет выполняться примерно 1 умножить на 2 количество раз смерти трансформеры машинка трансформер и почему это место общее тормозить элемент того как мы нужно сортировать данные затем их нужно понять его время миша мы оперируем уже не и колонками он мы оперируем строками в этих колонках и нам нужно доставать из уже отсортированы блоков минимальное значения используем кого меж алгоритма и в данном случае вот как раз вот компаратором начинаю тормозить например когда мы сортируем по нескольким колонкам такой довольно часто бывает мы можем использую примерно ту же идею что из компиляции выражения группа мы можем соединить их в одну функцию чтобы избежать косвенных вызов для долбил колонок это может быть даже серьезней потому что но lable колонка обычно она покупает методе она для начала проверить бытовые маски постели метанола был лепилина был и затем дальше тестирует сомнения колонки зданий и если посмотреть на результаты такую довольно простой оптимизация пример select площади из таблицы из сортированы по очереди и там 3d то можно увидеть что мы получили около 20 пациентов улучшения производительности примерно народа месть что довольно таки серьезные лучше если взять и например на любую колонку как я рассказал для налоги колодки улучшение должно быть даже больше то мы видим получения при длительности до 30 проц от самом заключение хочется сказать что вообще добавить чуть было довольно сложно есть довольно много лечить пришлось переделать довольно много всяких интересных проблем и обнаружили и если вот именно про результат этого для интерпретации выражений у нас получилось лучше не производительности примерно полтора в три раза для грубая нас улучшение производительности составляет 15 центов до двух раз и например для word обоим улучшение при длительности от 15 до кисти казань если какие-то вопросы по докладу кэшируются результаты частота компиляции и каким образом так до результаты компиляции кэшируются мы кладем их в кэш unibody можно задавать как размер байтов так и размер на максимальное количество скомпилированных функций и мы используем там алгоритма ларио что является ключом каширование причем кэширование мы используем например для компиляции дерево в выражений вот это вот все дерево с типами уникальные выражение есть какое-то число рассчитывается на основании абстрактного синтаксического дерева нони параметров да то есть это как бы просто хоть берем если три компиляции использовать это будет 3 n 3 в выражении грубой ордер да это будет 3 как бы and rev каша мы не вот это вот место мы не оптимизирован принципе вот эти вот вещи они вообще абсолютно ортогональные то есть компиляция выражений компиляция грубая компиляция бар дубай а то есть они пока не мы их никак не пытаемся связать принципе одна из таких хороших оптимизаций на будущее это попробовать скомпилировать большую часть запроса вместе максим спасибо за такой у меня такой вопрос 2 слова как вы тестируете или компиляцию ну там каретный запросов там это очень хороший вопрос потому что как я уже сказал общее основной блок для внедрения где-то 2018 года было то что у нас не было нормальной системы си то есть у нас не было многих азеров которые находили проблемы и паоло такое мы например компилировали какие-то константин бывала там где-то память течет всякие такие штуки происходили и принципе у нас вот сейчас становится системой чай а затем хороший party я про не понимаю что лазер и этапа историю как раз получателя да у нас есть такой пальцев клика ухе кстати возможно он где-то их других системах есть но вот у нас он сделан довольно хорошо потом многие вещи то есть там мы перебираем и константы и пытаемся разные функции и там довольно странные запросы пытаемся генерировать это ты про рискую lancer или перловый ваш fazer просто латте спасибо скажите пожалуйста у вас используется как а это максимальное время тома течение на компиляцию после которого она отменяется просто не у нас вот таких штук нету и тут как раз почему нас принципе такого нету на тех вообще запросов которые я тестировал а мы там генерировали стресс-тесты там какие-то кому очень огромное выражение в целом относительно запроса то есть это действительно к это продакшен запрос это будет там очень мало времени составлять то есть почти всегда выгодно скомпилировать и потом на больших данных все же запрос выполнить единственной оптимизации которой в этом месте возможно это посмотреть какое количество данных персиком будем читать потому что словно если там нам нужно прочитать условно какой-то один два блока то можно ничего не компилировать и но так будет быстро работает спасибо за доклад я хотел спросить пробовал ли ты механизм библиотеку и сэмплер которая позволяет оптимизировать на разных слоях дерево представления нет такие вещи мы не пробовали целом я слышал про это это нужно все это дело пробовать то есть вообще с альбомом я тоже вот могу сказать что у нас была такая были некоторые проблемы вообще почему довольно ну той сама библиотека вот например про болели из team secret и вручит компиляторы но использовать их довольно тяжело потому что там ценам интерфейсы перегруженной получается то есть у нас такой сварию свой wrapper есть и это довольно много времени заняло его написать"
}