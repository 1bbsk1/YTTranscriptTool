{
  "video_id": "jWLv0WXQnyk",
  "channel": "HighLoadChannel",
  "title": "Высоконагруженный блокчейн в mission critical-системе / Иван Косарев (Waves Enterprise)",
  "views": 641,
  "duration": 2089,
  "published": "2023-04-28T06:10:46-07:00",
  "text": "Всем привет Я Косарев Иван я руководитель продукта webout это блокчейн сервис для голосований разрабатываем компанией Вектор технологии Мы работаем с юридическими лицами у нас голосуют и советы спортивные ассоциации самоорганизации но сегодня я расскажу о другом проекте который сделан на той же технологической основе в девятнадцатом году мы совместно с ростелекомом приступили к созданию системы дистанционного электронного голосования по заказу ЦИК Почему электронное голосование ради чего все это делается на самом деле причин довольно много часть из них достаточно понятна и банальная ниже стоимость выше явка быстрее идет подсчет голосов вот также есть не совсем очевидные причины есть ощущение что мы можем сделать систему электронного голосования более надежную прозрачную чем то к чему привыкли на бумаге причина на самом деле неожиданная потому что для большинства пользователей информационные системы являются черным ящиком которых происходит какая-то магия Главное чтобы ящик работал в случае с электронным голосованием такой подход не работает потому что ящик для голосования должен быть прозрачным и эта идея использовать блокчейн в применении голосования возникла не только в России многие страны в мире проводят такие эксперименты с разной степенью успешности чего хотел ЦИК от системы электронного голосования в России первое чего от нас требовалось это запустить более тысячи голосований одновременно для тех кому любопытно это не цифра с потолка это реальный масштаб на единый день голосования в двадцать первом году мы запустили 1700 голосований в 6:30 избирательных компаний разного уровня второе это объем участников перед нами стояла задача обработать 10 миллионов голосов за 12 часов то есть 230 транзакций в секунду и по ходу работы над системой эта цифра была удвоена Когда возникла необходимость на каждый голос отправлять дополнительную транзакцию помимо требований по производительности есть несколько ключевых поинтов которые система тоже должна соответствовать Первое это гарантированный учет всех голосов второе это не дать возможности кому-либо нарушить тайну голосования не дать возможности получить промежуточные результаты и не дать повлиять на ход и итоги голосования а также необходимо иметь возможность убедиться что все эти требования были соблюдены что мы имели перед началом работы над проектом во-первых это свой собственный блокчейн платформу со смарт-контрактами и При правильном внедрении блокчейном Мы тоже закрываем Требования по защите исторических данных но с блокчейном есть нюансы во-первых производительность наши коллеги из команды разработки ноды всегда уделяли большое внимание нагрузочному тестированию Но к 500 транзакциям на смарт-контрактах мы очевидно были не готовы второе это подход блокчейна к исполнению транзакций он заключается работает как Спасибо за ваш звонок он очень важен для нас то есть это best of basis блокчейне гарантирует что он исполнит вашу транзакцию он просто обещает что очень сильно постарается это сделать вот случае с голосованием такой подход тоже недостаточно второй кусок пазла который был у нас на руках Это протокол криптографический mvp протокола голосования с использованием открытого реестра Спасибо нашим криптографам за это по мне это очень красивые изящное решение оно очень хорошо ложится на блокчейн Сейчас я покажу как это делается Ну и третья составляющая это опыт реализации больших похожих проектов предыдущие докладчик как раз о нем Рассказывал Ну и классная команда профессионалов как с нашей стороны так и со стороны Ростелекома Давайте посмотрим Из чего состоит Эта система И зачем в ней каждый из элементов базовый слой это блокчейн сеть здесь он работает как распределенная база данных для исторических данных как прозрачный транспорт по которому гоняются данные и используя смарт-контракты мы автоматизируем процессы запуска голосования и обработки голосов следующий слой это набор криптографических сервисов они занимаются распределенной генерацией ключа который используется для шифрования бюллетеней занимаются расшифровкой итогов голосования эти сервисы не общаются между собой они взаимодействуют только через отправку данных блокчейн опять же это сделано для увеличения прозрачности дальше стандартная клиент-серверная обертка То есть это интерфейс для пользователей администратор участник голосования плюс дополнительные сервисы типа авторизации и собственно это то с чем Мы приступили к работе это архитектура нашего публичного vivote но по требования цикла не подходит потому что у цика свои дополнительные процедуры организационные которые мы не привыкли и эту схему нам пришлось дорабатывать первое что мы сделали это изменили процедуру создания ключа в исходной схеме это этот алгоритм полностью автоматизирован не требует вовлечение человека в случае ЦИК Они попросили нас его изменить для того чтобы во-первых сделать его более наглядным и привычным чтобы члены избирательных комиссий имели возможность несли ответственность за запуск голосования и за их приведение и во-вторых для того чтобы исключить возможность что нарушитель проникший в войти контур системы мог бы незаметно манипулировать ключами голосования и влиять на его ход как мы этого добились мы вынесли часть процедуру в оффлайн То есть у комиссии есть отдельный ноутбук на нем с помощью специальной утилиты они создают свои ключи развивают их на несколько частей по схеме шамира и собирают только после завершения голосования и только получив оба ключа ключи системы ключ комиссии в собранном виде можно получить итоги голосования дальше следующий шаг это интеграция с компонентами которые разрабатывает Ростелеком то есть они взяли на себя интерфейсную часть соответственно нам надо было мы просто добавили очередь управления голосованиями здесь нет никаких критических данных там нет никаких требований по нагрузке просто упрощение процесса интеграции более интересный кейс это pipeline обработки голосов он состоит из двух частей первая опять же была разработана ростелекомом это часть реализует схему двух агентств первое агентство это авторизованная зона где пользователь проходит авторизацию на есиа отправляет заявку на участие в Дек система проверяет Имеет ли он на это право проверяет вычеркнут ли он из списков оффлайн голосований и когда все проверки пройдены пользователю выдается условный пропуск пропуск выглядит как слепая подпись его открытого ключа с которым пойдет Отправлять свои голоса тот ключ который он создал локально у себя на устройстве и никому не показывал с этой подписью он приходит во вторую часть во второе агентство в анонимную зону и отправляет транзакцию электронный скидывать транзакцию в еще одну очередь в кафку и транзакции отправляются в нашу Часть системы наш адаптер сидит слушает очередь выгребается что оттуда получит и отправляет в блокчейн он смотрит за тем чтобы транзакции гарантированно были смайнены помогает ему в этом еще один адаптер еще одна очередь исходящий адаптер и очередь обратной связи этот адаптер вычитывает все то что было принято в блокчейн и сообщает всем заинтересованным сервисом с одной стороны это тот адаптер который манит голоса он получает сообщение о том что все прошло успешно с другой стороны используется эта информация используется на портале наблюдателя который в режиме реального времени получают информацию о принятых голосах одновременно со всей остальной системой собственно дальше это схема режется на реплицируется на 3-4 цода в двадцать первом году было 4 цода в двадцать втором было два сода поскольку нагрузка была пониже но это была бы уже слишком большая схема поэтому здесь её нету И в общем архитектуру мы описали можно заняться оптимизацией начинаем очевидно с TPS потому что это одна из самых интересных метрик для блокчейнов И на самом деле достаточно мифическая штука потому что необходимо различать тот ТПС который является маркетинговых материалах где-то можно нарисовать единичку и сколько угодно нулей и тот ТПС который реально могут выдать инженеры которые появляются при внедрении реальных промышленных кейсов где-то можно увидеть данные там 10.000 ТПС с плюсом и маленькая сносочка говорит что это только трансферы либо 50.000 ТПС и опять же маленькая и мы понимаем что это пустые транзакции которые не выполняют никакой логики идёт просто проверка подписи TPS на майонезе Waves Enterprise на тот момент был он сейчас остается 10-20 ТПС для данного проекта совершенно недостаточно Поэтому нам предстояла большая работа первое что мы выяснили это что ТПС значительно как бы линейно зависит обратно линейно зависит от размера транзакции Чем меньше размер транзакции тем выше ДПС поскольку для нас размер бюллетени это внешний внешние параметр который мы не можем влиять потому что очевидно список партий список кандидатов это то что нам приходит сверху Здесь нам было необходимо работать на оптимизацию что мы сделали Мы перевели транзакции бинарный вид научили ноду стерилизовывать эти стерилизовывать протобаф и криптографические константы То есть это точки аналитической кривой перекодировали текст Казалось бы надо получила дополнительную нагрузку в плане стерилизации стерилизации но благодаря уменьшению размеры транзакций производительность выросла примерно в 10 раз второе что мы осознали это то что моды Это нода блокчейна это не монолитный компонент Она состоит из модулей которые выполняют различные функции их при попытке глубокой оптимизации надо рассматривать Независимо функции которые выполняют это сетевые интерфейсы Крипто операции типа проверка подписи их и шеи запуска исполнения конкретно смарт-контрактов и обработка внешних запросов от обвязки соответственно мы смотрели изучали и смотрели какой из этих модулей тормозит больше всего неожиданно для себя обнаружили что наша нода до этого не умела работать с марконтрактами в параллель и пришлось ее этому научить и изучали схемы специализации для нот когда ноды Ну сеть неодноранговые А каждая нода занимается какой-то своей отдельной функцией параллельность дала хороший буст А вот специализация но то особо не сработала Наша сеть осталась одноранговой и все надо в ней равны то есть это Как как объяснял Денис это майнеры по очереди и самые дешевые недешевые самые Казалось бы простой не требующий усилий попытка залить проблему железом то есть мы с помощью Ростелекома и в содружестве с интелом попытались подбирать железо помощнее проводили тесты на Золотых процессорах занимались профилированием при этом и где-то вот на Супер мощных стендах Intel мы уже добивались 500 ТПС или в пиках даже до 600 на самом деле в итоге мы в эту сторону не Пошли потому что во-первых влияние процессоров и памяти оказалась не таким значительным как мы предполагали вот узнали что гораздо большее влияние на скорость работы системы больше всего влияет быстрые диски но тем не менее эксперименты не прошли даром мы с помощью дополнительных инструментов профилирования нашли пару багов и ноды стали работать эффективнее Ну и опять же еще один простой не требующий какого-то умственного усилия подход ускорение блокчейнов это их кластеризация таким разбивая систему на две на три мы кратно увеличиваем ее пропускную способность Единственное что это должен позволять бизнес-процесс когда данные отправляющиеся в разные шарды не должны быть связаны между собой и могут обрабатываться полностью Независимо Вот здесь мы тоже получили хороший буст и в общем здесь возможности масштабирования не безграничны на самом деле для целей голосования в двадцать первом году и в двадцать втором это не то чтобы требуется мы уже выходили на необходимые производительность но во-первых система будет масштабироваться и мы отрабатываем способы дальнейшего масштабирования вот ну и перестраховались потому что этот процесс проекта в котором перестраховка это хорошо дальше вопрос гарантированной доставки как я сказал блокчейн ничего такого предложить не может Поэтому нашим спасением стала Кафка мы поставили на очередь обработки голосов очередь и она работает во-первых как энергия Независимый буфер поскольку данные которые хранит надо те которые не приняла блокчейн это то что у него хранится в памяти и перезагрузка их эти данные уничтожает Кафка у нас остается последним убежищем не пришлось использовать в этом в этом качестве но тем не менее опять же перестраховались помимо этого Кафка является удобным транспортом с гарантия доставки Мы всегда знаем что то что в нее положено оно уже попала систему никуда не уйдет и третье это тот клинг нагрузки для пиковых часов обычно большая часть голосующих от 40 до 50 процентов приходит первые часы как позволяет эту нагрузку сглаживать Ну и дополнительно При работе над этим проектом Это был первый проект где мы отправили в промышленную работу консенсус недавно нами разработанный cft который не приводит к обэкам дальше остается задача тестирования не так ну то есть самое интересное работает конечно придумать решение Но прежде чем они пойдут в рот необходимо перетащить их на новую незнакомую инфраструктуру и вопрос как это все тестировать для нас позитивным было то что интерфейсную часть взял на себя Ростелеком все пользовательские сценарии остались для нас за гранью за рамками Вот и все что осталось нам это довольно простая схема тестирования наша система может быть представлена просто как большая труба Где в нее закидывают в один конец сколько-то бюллетеней и на выходе должно получиться столько же если что-то пойдет не так мы должны знать почему оно пошло не так и понимать что это было был валидным кейсом чтобы тестировать такую систему мы разработали утилиту нагрузки которые позволяла в большом количестве легко и просто создавать голосование пачками и прожигать систему нагрузкой метрики при тестировании оказываются достаточно простыми и очевидными мы просто вешаем на каждом этапе счетчики во входящую очередь мы считаем сколько мне зашло на каждом компоненте считаем сколько вошло и вышло если что-то не получается считаем ошибки майнинга ошибки валидации и в итоге получаем столько же бюллетеней сколько отправили исходно при этом мониторинг в графане легко позволяет отслеживать нормальное состояние системы если у нас увеличивается счетчик голосов pending Мы изучаем это мы понимаем что это то что было отправлено на ноду если он растет Значит надо не справляется и там есть какие-то проблемы если у нас пошли ошибки но очевидно что мы знаем На каком этапе они пошли также счетчики контролируют кафку сколько там было отправлено Какой лак на вычетку и тестирование становится достаточно тривиальным помимо того что мы должны считать голоса нюансом является то что мы должны распределить ресурсы по компонентам в этой очереди таким образом чтобы не возникало бутылочный горошек поэтому каждый компонент в цепочке со своим мониторингом ресурсов мы понимаем уходит ли он за лимиты перезагружается или нет удивительным моментом оказалось то что инструмент нагрузки тоже требует ресурсов местами даже больше чем те компоненты которые обрабатывают голоса потому что генерации бюллетеней их шифрования тоже оказалось емким ресурсоемким делом помимо счетчиков опять же через графоном прикрутили мониторинг майнинга блокчейна если все идет хорошо высота стабильно растет и сливается в монотонную линию значит но дыма нет Если происходит расхождение ноды выпускают принимают блоки в разные моменты понятно что сеть начинает разъезжаться самый интересный кейс у нас был когда мы на скорости 200 ТПС въехали в безопасников которые по ошибке отключили доступы к по сети и было не очень понятно что именно разъехалась но было очень интересно наблюдать на множество разноцветных точек там где должны были быть скучные зеленые полосочки но было приятно увидеть что после восстановления доступа ноды в течение 5-10 минут собрались они договорились между собой модернизировались и майнинг восстановился и вся транзакции которые были в дьютиксе они прошли обработку мы получили за вот за период этого шторма около полутора тысяч транзакций не исполнены Вот но благодаря заложенным механизмам просто дернули ручку от на адаптере отправили их на пересчет и в итоге не потеряли ни одной транзакции чтобы вы понимали это все-таки тест Это не то что было на бою на бою у нас выше 16 TPS в этом году не поднималась В прошлом году суммарно было на 420 TPS Ну и последний элемент требования к системе от ее прозрачность то что можно легко упустить с точки зрения разработчика потому что тебе поставили задачу ты нашел решение система тянет и ты думаешь что все хорошо Но в применении к национальным выборам прозрачность является не менее не менее важной частью и в этом направлении ведется очень много работы в этом году у нас было не так не такая большая нагрузка не так много наблюдателей но в плане в плане наблюдения был сделан большой Шаг вперед Если в двадцать первом году с нами работала всего пять наблюдателей то в этом году их оказалось 20 раз больше из инструментов которые мы предлагаем это портал наблюдателей который подключен к той самой очереди обратной связи и получает данные одновременно со всеми остальными компонентами нашей системы дополнительно была разработана с утилита для наблюдателей который получая выгрузки с этого портала могут загрузить и убедиться что данные которые отображаются в блокчейне корректные и утилита с известными механизмами обрабатывает их точно так же как система и дополнительно были запущены ноды наблюдателей это специальный режим not который не обрабатывают транзакции которые не синхронизирует свой YouTube Они получают ноды из блокчейна применяют их стейту и Наблюдатели самостоятельно имели возможность подключиться к ноде разрабатывать свои инструменты и увидеть те же самые результаты что получают и все остальные Наверное это на этом У меня все как выборы как выводы я могу предложить зафиксировать что во-первых производительность блокчейна Это довольно мифическая вещь и надо очень четко понимать Где начинается где кончается маркетинг Где начинается реальные проекты во-вторых блокчейн не Самая удобная технология для работы но при правильной обвязке можно найти в них подход и строить масштабные системы не теряя свойств которые технология предлагает и эффективность блокчейна зависит от его места в общей архитектуре то есть блокчейн предлагает прозрачность Но для того чтобы это случилось необходимо проложить его по бизнес-процессу таким образом чтобы зафиксировать в нем какие-то ключевые моменты но при этом не перегрузить Потому что его возможности в плане производительности ограничены вот на этом У меня все Спасибо за внимание Спасибо Алло включите мне спасибо за замечательным доклад наконец-то стало понятно что можно блокчейн использовать чего-то другого тебе при физического мира что ты вспоминал нас теплыми зимними вечерами он остался самый интересной часть этой клей вопросы и ответы и будет приз от нашего генерального спонсора от Газпромбанка Добрый вечер вы говорили что несколько конфигураций подбирали серверов а Конкретно можете сказать Какие характеристики остановились конкретно не смогу Но на вот на Золотых стендах Intel это были простые где были десятки гигабайт памяти десятки ядер точно данных у меня сейчас нет еще такой вопрос насколько я помню там пере голосовать же можно было людям правильно смотрите здесь есть нюанс есть система которая есть в Москве создается Дита Москвы и Федеральная система которую создаем мы вот скорее всего перед голосование это то что было в Москве у нас перед голосовании теоретически возможно но отключено и всего сколько вот у вас было голосующих людей в двадцать первом году коллеги такие вопросы предлагаю вывести в Core и не забываем что замечательный qr-код Где вы можете оценить чтобы спикер понял выступать ему еще раз и на следующий вопрос да спасибо большое вот где-то в середине презентация вы упомянули что разработали свой cft консенсус да Но ведь в этом случае можно вместо блокчейна использовать классическую распределенную базу данных которая будет Работать быстрее будет надежно То есть почему здесь Именно cft они bft и второй Маленький вопрос один из основных аргументов у противников такого голосования это закрытость исходного кода закрытость данных вот как вы к этому относитесь Я не знаю находится коллеги Давайте вот такие вот вопросы задавайте про легитимость и исходные коды это отдельно на технический вопрос в данном случае опять же bft нам не так ли он интересен Наверное нет Потому что ну в нашей системе cft Выглядит вполне себе достаточно Потому что если публичных сетях bft публичных открытых сетях где мы не знаем кто является нашим участником проблемы с bft она актуальна если кто-то начинает засылать злой наверно какие-то данные это является проблемой в плане закрытых сетей выглядит достаточно достаточно Потому что если кто-то начинает зловредить мы знаем кто это потому что Наша сеть пермиш Вот и соответственно мы дальше административными средствами исключаем этого участника и Наказываем его но мне кажется эта тема для отдельного доклада более развита и у нас следующий вопрос Здравствуйте а не могли бы чуть более развернуто пояснить То есть почему размер заявки так сильно влияет на производительность если это не что-то такое не этот Здесь нет ничего сложного больше большая часть больше проблем с размером транзакция у нас было именно на сетевом взаимодействии то есть размер блока размер транзакции просто на выкачку этих данных То есть это не вычисление это именно передача транспортеров Спасибо здравствуйте Спасибо вам за вступление хотелось бы уточнить а прошу говорить чуть громче Здравствуйте спасибо за выступление хотелось бы уточнить можно ли было бы использовать такой блокчейн как Солано который является довольно быстрым и показался на практике Вот и второй вопрос выполнение смарт-контрактов у вас работает на evm или как-то по-другому самописное это наша платформа использует такие зоны смарт-контракты это не не вот можно ли было бы использовать салона наверное можно но на самом деле ее быстродействие это как раз опять же немножко маркетинг если посмотреть их документацию то они свои тесты проводят на транзакциях размером 176 байт Вот это достаточно бессмысленные транзакции которые все что делают это проверяют подписи Ну то есть опять же синтетический тест Спасибо а у нас есть еще вопросы Да Иван Здравствуйте спасибо большое за доклад меня такой вопрос боритесь ли вы с аномальным поведением пользователя Я немножко раскрою допустим какие-нибудь и хорошие дяди получили доступ к большому количеству учетных записей госуслуг это не редкость в нашем мире и начали голосовать а просто ну просто и вот такой аномальное Поведение у вас как-то учитывается или нет Мне кажется ответ на это замечательный вопрос мы получим к зоне и все детальные У меня есть мягкий вопрос на эту тему который не приведет к холиваром вот во первых действительно как бы в плане электронного голосования две части типа допуск голосованию и учет голосов вот наша команда занимается именно второй частью вот в плане первой у коллег из Ростелекома есть списки голосующих у них есть и они формируются на нескольких этапах и в том числе они заносятся в нашу систему и мы имеем возможность их сопоставить вот по поводу долготерных пользователей в двадцать первом году мы поймали из полутора миллионов транзакций была одна которую мы отклонили то есть мы не потеряли ни одной транзакции Но одно отклонили и она была отклонена по по этой причине нарушенных зкп то есть это доказательство того что бюллетень зашифрованы бюллетень заполнен некорректно вот Видимо это вот как раз был случай с домашним хакером который разобрал систему и что-то пытался туда заложить На таком уровне технические проверки они у нас есть и работают спасибо спасибо за вопросы Спасибо за ответ коллеги есть у нас еще вопросы Спасибо Здравствуйте я хотел спросить голосование у вас реализовано через Smart контракт и реестр голосующих если это так он хранится и кто контролирует этот реестр Ну очевидно что да как бы тот тот реестр на который ориентируется избирательные комиссии по всей стране как бы его основы его Эталон он хранится не в нашей системе для нас он является внешним но в систему списке Избирателей Мы тоже загружаем То есть со стороны Ростелекома прилетают данные которые мы кладем на смарт-контракт и их потом в дальнейшем можно будет сопоставлять с теми списками которые есть на бумаге в отдельности Спасибо за вопрос Спасибо за детали ответ наверное еще один вопрос есть у нас еще один вопрос два вопроса Здравствуйте спасибо за доклад скажите пожалуйста кто выступает в роли майнера вашей системе и сейчас в роли майнера Ну то есть это на 2002 год это было два цода в каждом соде было они были три цода и два шарда то есть сеть блокчейн разбили пополам распределили по трём содам в каждом соде было по два майнера Вот это соды Ростелекома в дальнейших экспериментах планируется отдавать некоторые комплект ноду которая будет майнить и участвовать в этой системе и стоять на инфраструктуре политических партий Хотя это вопрос я думаю такой политическое обсудим и тут самое интересное в вопросах меня выбери самый интересный вопрос спасибо то есть я правильно понимаю что в данном случае майнеры подконтрольные вам в текущий момент вы моете в данный момент при этом Наблюдатели имеют доступ к этим данным и валидирует их тоже вручную но в режиме реального времени"
}