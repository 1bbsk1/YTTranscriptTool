{
  "video_id": "4zP67uYnsR4",
  "channel": "HighLoadChannel",
  "title": "iptables + consul = :3 / Иван Агарков (Wargaming)",
  "views": 5170,
  "duration": 3197,
  "published": "2020-02-26T12:02:27-08:00",
  "text": "в общем-то да сегодня буду рассказывать как мы своими руками сделали что-то чего раньше не было и она даже работает а для начала я представлюсь меня зовут иван огарков я работаю в минском центре разработки компании wargaming должности руководителя группы инфраструктурной безопасностью подразделениями с подразделением этом отвечает за работу всех игровых серверов компании wargaming от непосредственно самих игр до всех обвязок баз данных описок и так далее рамках то сказать своей деятельности я занимаюсь поиском способов как сделать так чтоб наш production был защищен это включает себя как регулярную работу с какими то там блогами backup ами и так далее да стандартную работу безопасника так и какой-то и рэнди вот пара результат одного из этих людей я расскажу и собственно о чем вообще будет доклад если взять стык нет фильтра и прикрутить нему в качестве источника данных консул получится быстрый динамический распределенный firewall которым мы смогли заменить а цели на железках которые нас были до этого и использовать его практически везде для всех наших нужд внутреннего fair воллинга ну и внешнего конечно тоже но прежде чем я расскажу о том как мы это делали я расскажу о том как мы вообще к этому пришли почему это понадобилось для этого давайте это перенесемся во времени чуть-чуть назад примерно на 9 лет в 2010 году когда танки только-только появились у компании wargaming было примерно 50 серверов собственно вы видите вот график как росло количество серверов по годам и сетевая модель которая была придумана для того времени она была в общем-то ну оптимальный можно сказать да у нас есть frontend в котором живут плохие парни которые хотят нас сломать и в нем у нас есть firewall for волн железяках танцы скинни циски неважно и есть backend в котором firewall нету в котором как бы это наши 50 серверов и мы все знаем о кей работает работает хорошо работает проходит четыре года за это время парк серверов вырос сто раз их стало уже не 55000 у нас появляются первые изолированные сети тогда это были stay джинки почему у стоянки потому что в стрингах часто крутилась что-то непонятное что может быть опасно для production ну то есть эйджинг продакшен ходить не может production station ходить может естественно опять таким продолжая использовать pineapple инерции уже все эти железки все это начинало делаться на изолированных уланов то есть есть вилар к нему пишутся какие-то цели разрешаю еще запрещающий какой-то connect проходит еще два года у нас количество серверов становится еще больше их уже 8000 у нас появляются дополнительные такие вещи как партнеры партнерские сети компании wargaming начинает поглощать другие студии покупатель договариваться и так далее появляются дополнительные сети которые вроде как наши но не совсем опять-таки все это усугубляется тем что для партнеров уже в милан часто не катят приходится делать vpn с какими то там в рифами с какими-то еще более сложными изоляция me и вся вот эта вот мешанина изоляция цели продолжает ублажает продолжает расти к началу 2018 года наш парк машин вырос примерно до 16000 у нас было по моему раз два три 4 5 6 6 сегментов на самом деле может быть даже больше нас появились бизнес критику сегменты в которых начали хранится всякие финансовые данные куда не пускали вообще никакого у нас появились контейнерные сети потому что вот этот кубер нити с devops и вот это вот все все пошло тоже у нас начали это делать нас появились облачные сети подключен и в бабу в ну например завеса и как бы количество правил было настолько велико что в целом это было больно собственно вот небольшая диаграмм к примерно тоже самое только тип изоляции которые мы используем и вела она с отелями там на свечах условно говоря да на l2 и рфс а целями на l3 и vpn и питает и всякие другие разные это кого было много много много много и вот такое состояние нашей сети была на начало 2017 года возможно что кто-то из вас сейчас вот ничего не понял и такой типа ну окей а в чем проблема нацелен увела не все так живут вот я специально для вас нарисовал такую вот диаграмму с горы там скрывающим боль вот он как бы вот вам рассказывает что вообще не так если кратко то проблем массово было примерно 5 во-первых каждое новое правило добавлялось дольше чем предыдущие потому что нужно было сначала как-то посмотреть о чем вообще есть может быть уже она есть falling внутри сегментов в принципе отсутствовал потому что ну понятно сегмента друг от друга как то порезали внутри уже ресурсов не хватает правило применялись долго если какое-то одно локальные правила могли сделать за час уже делали их руками операторы то глобально это могло занять там несколько дней аудит правил был мягко говоря невозможен 1 из правил писались еще в том там самым десятом году и большая часть людей которых когда-то писали просто уже не работали в компании а может быть даже уже уехали из страны и вообще неизвестно где они были и как такой итог жирной красной точкой у нас была реальная проблема с уровнем контроля за инфраструктуры то есть принципе мы не особо знали чел нас куда ходит и что у нас вообще происходит и вот вам диаграмма вот так выглядит сетевой инженер когда к нему восемнадцатом году приходишь и говоришь вот нам нужно еще немножко а цели сделать и вот как был где-то тут вот мы вот там вот сетевой инженер собственно в начале восемнадцатого года мы собрались группы заинтересованных лиц и решили что нужно с этим что-то делать отправной точкой стала то что ноги сказали ребятам и больше не поддерживаем в крупных датацентров изолированные от миланы и а цель и потому что нас кончилась память на устройствах все финиш можете использовать старые сколько у вас там их есть она вы больше делать не будем делать и чего хотите собственно мы собрались и стали думать о кей что мы можем сделать давайте сначала попробуем решить вопрос цены и стоимости интеграции попробуем как-то вот это автоматизировать ok выбираем человеческий фактор по максимуму делаем автоматизацию применение правил ok давайте придумаем какую-то распределенную систему что правила доезжали сами не надо было делать там арсенка или ftp на тысячу железок вовнутрь и сегментов тоже важная штука которая стала нам прилетать когда у нас в рамках одной сети там появлялись разные сервисы чтобы сделать о давайте сделаем хвост действ вырвало собственно с этого все началось давайте firewall перенесем железок на хвост даже везде linux практически там винды и 3 процента машин здесь и 5 bus отлично же аудит правил и вообще вся вот эта штука испражнение руки а если мы возьмем и построим центральное хранилище и будем хранить все правила там сможем же аудирование к сможем и параллельно с этим мы запустили такой процесс больше административной чем технически как инвентаризацию сервисов то есть специально обученные сервис менеджер и пошли по командам спрашивайте у вас вообще есть и зачем вы это подняли что вы понимали вот уровень как бы а да да у нас иногда бывает двести-триста релизов в неделю новых каких то вот доработок еще чего-то особенно вот всякие акции праздники подобные вещи то есть 300 релизов неделю попробую узнать что там есть и куда она хочет пойти и какие ему нужные порты и печники интеграции так далее на эту одну команду который релизе на наших домов и вот в рамках вот этого естественно понадобились специальные люди которые пошли узнавать что вообще вот там будет и такой небольшой сразу спойлер вот вы помните как выглядел сетевой инженер в 2018 году в 2019 году он выглядит примерно так тот который работал на с поваром окей про проблему и вот что мы вообще решили с этим делать ну вроде рассказал да надеюсь что даже те кто с этим не сталкивался немножко поняли а кто сталкивался должен сейчас где-то там тихо плакать в углу и вот да как примерно мой плакали теперь как мы вообще вот к этому шли как наверное понятно из доклада да мы решили что если все что все это надо положить в консул типа давайте мы возьмем вот в чем вот соберем что мы нашли при помощи сервис менеджер положим это консул и из консула будем делать правила и 5 мс казалось бы да консул чем плюс консул консул может работать на каждой ноги и это не какой-то там удаленная api дату и все консул агент у тебя на каждой ноги и он берет и пишет выпить и bulls дальше там нужно только придумать какие-то автоматические средства контроля которые будут вычищать лишние там и в общем то все большая часть проблема решена остальное уже по ходу там допилим и собственно вопрос такое сразу да а почему именно консул почему-то мне что нибудь но тут несколько причин исторической причин у нас был опыт консулом хороший по моему 14 пятнадцатом году мы его использовали как бы can для volta чтобы заменить хранение паролей файликах на хранение паролей в lte у нас это получилось кстати и за это время вот того года вода 18 консул ни разу не при одной аварии не потерял данные это вот прям огромный плюс для системы которая управляет firewall что она не теряет данные то есть вас все вы положили там она никуда не денется это реально круто консул имеет пир toupper связи этом чуть позже буду рассказывать про то как он работает вы это увидите опять таки если есть пир toupper значит все изменения приходят быстро вам не нужно ждать часами пока туда едет какой-то commit все есть rest api например мы рассматривали также звуки перу звуки принят растопил жуки жуки пир для rest api надо отдельно какую-то приблуду ставить ну плюс то что он работает не только как хранилище ключей но ещё и как сервис discovery то есть можно сразу там сервиса каталоге дата-центра это удобно не только нам но еще и соседнюю командам естественно сделаю делая глобальный сервис думаю там сразу всем сущим скупе плюс консул написано кошечки кошечку мы любим кошечка в нашем стеке у нас есть много разработчиков ну и система цель позволяет как бы отсека целями управлять кому куда чего можно писать то есть мы в общем то гарантируем что условно формальные правила не будут пересекаться ни с чем больше у нас не будет этим проблемы но правда консула есть некоторые интересные недостатки во первых консул не масштабируется в рамках одного дата-центра если у вас не консул бизнес он масштабируется только федерации во второй консул очень сильно зависит от качества сети и нагрузки если вы положите консул в все его ну как бы в роли сервера на загруженный сервер скорее всего он нормально работать не будет если у вас будут какие то лаги по сети нервно неровная скорость еще что то он нормально работать не будет связано это с вот этими всеми пир toupper соединениями и модели его распространения апдейтов она еще консул очень плохо мониторится потому что статус может варить что все окей на самом деле он давно умер ну вот так вот тем не менее поскольку большую часть этих проблем мы выявили уже когда стали эксплуатировать большой консулу как бы вот везде да там и консул выбрали хотя сейчас есть так такие входят планы что возможно нужно сделать какой-то альтернативный backend но пока вот мы живем с консул мы научились как то с этим бороться вот вроде все понятно теперь собственно про то как вообще вот немножко работает консул просто что вы что-то вы понимали о чем мы говорим там что такое сервис discovery но я на это не буду рассказывать вы все это все знаете так вот у нас есть какое-то условно в центр начала нам нужно в нем сделать серверов сервера должно быть или три или пять если будет два или один у них не будет форума они не смогут решать кто прав кто виноват случае когда данные не совпадают если их будет больше 5 то смысла нету бы только деградации производительности клиенты подключаются они в общем то тот же агент только с флагом сервер равно фолз подключаются к серверам в любом порядке после того как они подключились они в ту первым делом получают список перов и начинают делать такие вот связи между собой то же самое происходит на глобальном уровне то есть когда мы соединяем между собой нет несколько дата-центров они также пир toupper каждый с каждым но уже столько сервера они агенты соединяются и продолжают также общаться когда мы хотим забрать данные из другого ты цвет у нас запрос идет от сервера к серверу все это дело называется протоколом surf есть такой сайт surf а если вам интересно если вы хотите где-то применить этот протокол у себя в какой-то своей определенной системе пожалуйста там это тоже шаг опускай разработка берете делаете челки вот понятно непонятно но вот вам котика немножко 10 секунд посмотрите на котика расслабьтесь то я понимаю что больше пяти минут утихните хотеть технических каких-то рассказов они обычно заставляю спать посмотрели окей погнали дальше дальше в принципе я вот по плану презентации должно быть примерно 15 слайдов со всякими диаграммами схемами к консулу чет там выбирает не выбирает как там запросы идут потому дублина кому это на самом деле надо ведь если вы захотите вы сами откроете документацию это прочитаете а для того чтоб просто что-то поставить затем поработать вам это не надо поэтому тут просто немножко фактов который вам наверное надо знать первый консул должен выбрать мастера из списка серверов для каждого дата центра если мастера у нас не выбран запросы не обслуживаются если мастер выбран магия все запросы идут к нему форвардом то есть сколько у вас не было серверов все запросы пойдут конкретно к одному мастеру вы хотели горизонтальное масштабирование нет извините соответственно если запрос идет в другой дата-центр то он идет от мастера к мастеру независимо от того на какой сервер он пришел известно мастер получает всю нагрузку ну кроме нагрузки на форвард запросов при этом на самом деле копию данных актуальную имеет все сервера дата-центре но отвечает только один и появился такой как бы хенк есть стоял режим которые мы используем это режим которым типы вы отказываетесь от консистентной sti данных но взамен вам может ответить любой сервер когда вы делаете запрос на чтения то есть мы получаем как бы рид чуть быстрее чем обычно и может отвечать любой сервер но запись естественно только через мастер что в общем то же консул не копирует данные между между центрами то есть если вы собрали федерацию у каждого сервера федерации будут данные только свои за всеми другими он всегда ходит к кому-то другому он вполне гарантирует от омар насти если вы что-то меняете никто никогда не говорит о том что это меняете только вы если вы хотите как-то по-другому делаете транзакцию с блокировкой если вы делаете блокировку ну где то в другом например дата-центре то так как запрос идет от мастера к мастеру они напрямую то это тоже не гарантирует вам что ваша буксировка сработает то же самое касается применение правила целей а цель может не сработать потому что а цель хранится в одном дата-центре федерации которая называется а цель дата-центра если он вам не ответит а цель работать не будет минус всей вот этой фигней в том что когда какой-то из консул мастеров отваливается например он просто завис у него там много трейдов он взял от какой-то тренд обрабатывающих клиента завис вы об этом никогда не узнаете а потом по кругу через некоторое время зависнут все остальные кто с ним общается потому что идет запрос запрос запрос ответа нету трек подвисает все статус обрабатывается отдельным трендом вот этот вот кворум и выбор обрабатываются отдельным брендом перевыборы не произойдет статус вам ничего не покажет вы просто такие руки у меня живой консулу делаете запрос ничего не происходит то есть нет ответа все статус показывает что все хорошо соответственно если у вас хотя бы один мастер завис и к нему идут какие-то запросы через другие дата-центр через какое-то время вас зрительно вся федерация то есть имейте это ввиду если у вас например в одном месте вот у вас федерация там 10 дата-центров в одном месте у вас плохая сеть постоянно вести виснут мастера через там час два три четыре вас будет падать вся федерация и вы ничего с этим не сможете сделать если только не решите проблему в этом том месте где вот эта сеть мы с этим сталкивались нам приходилось перестраивать конкретные куски дата-центра чтобы вот от этого избежать есть консул энтерпрайз в нем есть куча всяких фишечек типа выбора голосующих не голосующих всяких там ну короче распределение масштабирование тогда есть только одно но их система лицензирования пир надо для распределенной системы ну то есть для кластер размером с наш это очень дорого и такой маленький hand если вас что-то не работает и есть копия данных просто вот удалите вот свои данные и загрузите данные из копии вот это скорее все починит консул это стандартного у него иногда что-то такое делает и все вот проконсул в общем-то я рассказал мы даже уложились во время отлично теперь собственно про то что вот мы сверху на консул накрутили да и почему это назвали боев и vbf это просто акроним отбуксировал то есть когда я делал репозитории что в него положить первые какие-то тестовые кометы еще там сначала вообще на баше я писал как тест потом начал тоже надо писать надо было как-то назвать такой ну backend firewall луки bf вы все он так и остался дальше давайте сразу про соглашение первым пускать и слайдам я надеюсь что примерно все понимают синтаксиса и 5 был здесь кто не понимает что тут написано поднимите руку вроде бы нет таких отлично то еще у нас и полисе дроп у нас все все уходит цепочку боев и кроме там establish три лета тылу колхас то это просто шаблон может быть любым это просто для того чтобы мы понимали о чем мы говорим отлично следующее 1 магия у нас есть сервис консоли у сервиса есть всегда порт но до на которой он работает то есть мы можем со своей ноду знать что у нас есть какой-то сервис локально спросив своего агента и можно ставить теги пожалуйста легким движением руки любой сервис который у нас раз запущен как внук зарегистрируем в контуре превращается правила и пятибук у нас есть ssh пожалуйста мы открываем порт 22 просто просто делается баш на баш скрипта мк url плюс айпи тип все больше ничего не нужно по сути 2 магия давайте мы хотим открывать не всем доступа только кому то что нужно сделать давайте мы возьмем и по имени сервиса начнем в киеве лью хранилища складывать списке айпишник а в кого мы хотим пускать примерно следующая как бы продолжением если типа вот у нас есть сервис ssh tcp-порт 22 мы хотели чтоб все из десяти системах ли к нему ходить кладем кладем добавляем еще одно маленькое поле называется отель зачем чтобы делать какие-то временные разрешения например сотруднику нужен доступ на сутки моем доме доступ на сутки все соединяем получаем пожалуйста у нас есть сервис нас к нему есть севилью как бы сторож кота к этому сервису на каждый сервис он сделан все он мы даём доступ нет ни всем а конкретно кому-то ну вроде все просто и еще немножко котиков неожиданно правда я сам не ожидал я все время забываю тайком они слайде поехали дальше нам нужно давать доступ но если мы будем каждый раз писать все там 1000 и печников мы устанем давайте придумаем группировки сделаем отдельный sap сет в киеве лью назовем alias или группы и будем хранить там группы по тому же принципу просто ну вроде все очевидно соединяем теперь мы можем открыть ssh не просто конкретно на 1 пи до а вот прямо на целую группу или на несколько групп если мы хотим пожалуйста то же самое то теле есть то есть можем временно в какую-то группу добавлять и удалять и так далее там был где-то про проблемой был пункт про человеческий фактор и автоматизацию мы его решили пока что следующим образом ну кто не знает там никогда не слышал мы работаем с по пятам у нас все систем сайт как бы штуки приносится по пятам другими системы приносятся только непосредственно код приложений соответственно в папе db лежит список сервисов которые там запущены ну просто потому классу сервис можно их найти точнее как-то типу ресурсов вот там же можно найти кто куда ходит в некоторых местах в некоторых теперь мы заставляем и у нас есть система как бы пул request умерший квесту штук что люди сами могут что-то запушить она приедет и принесет вам то что они хотят совместно мы взяли написали сенгоку которая идет с одной стороны впопец baby которая работает там по сути обычный позы груз и сверху там к нему ктт папе мы идем от их и ттп спрашиваем типа какие у нас есть сервис и что нужно сделать другим концом мы идем в консул то есть такая простейшая как бы штука она оттуда сюда вот так вот перекладывает все интеграция есть есть разрешили сделали там всякие правило разрешили принимать полу request и на эти штуки то есть если человеку сейчас нужен какой-то порта или нужно куда-то хост засунуть в какую-то группу он просто делает pull request он приходит проходит там какое-то review и в общем то никаких больше вот этих там найди 200 других отелей попробуй что-нибудь с этим сделать ну вроде тоже просто пир вопрос к залу представим что pink нашего локалхост а занимает 0075 миллисекунда с пустой цепочкой правил давайте добавим туда 10000 адресов в и 5 был в эту цепочку как вы думаете какой у нас будет результат того же самого пинга ну давайте вы интерактивно немножко варианты ответа сколько будет а три икса чего-нито мы проходим вот всю цепочку в пять раз на самом деле то есть за счет того что я перебил линейный полностью если кто не знал каждый вот обработка каждого адреса занимает определенное количество миллисекунд если у вас много правил а если мы говорим про firewall в которой мы как бы мигрируем тысячи а цели у нас будет много правил это вносит задержку задержка особенного на игровых протоколах это плохо хорошо следующий вариант теперь мы берем укладе матовый писать какой будет результат неправильно 074 даже меньше хотя на самом деле все это просто что что-то такое ну короче смысл в том что о большое для офиса это всегда равно 1 что сколько бы там правил не было правда там есть ограничение что максимальных может быть 65535 но мы пока с этим как-то живем если что-то можно их короче комбинировать расширяет там делать 2 и песета в одном там делать с этой pissed off ну так далее вот и собственно логичное продолжение вот это и всего процесса вот эти расы как мы это придумали достало то что мы стали хранить информацию о клиентах для сервиса в эпизодах то есть теперь у нас есть ssh например тот же самый и мы не пишем там сразу вот 100 и печников которые вот в этот ssh а мы пишем имя и песета с которым надо пообщаться и следующее правило пишем дроп но принципе можно этого одно правило переделать типа кто не тут тот дроп ну так наглядно окей просто просто все у нас есть теперь у нас есть правило нас есть эта самая главная задача уж какая сделать сет до того как ты делаешь правило потому что иначе и потребовал с ним пока не получит правил записать вот собственно этот слайд я сделал для тех кто будет смотреть нас по ютубу или захочет там какую-то презентацию ставит то есть это просто повторение всего того что рассказал виде такой общей схемы вот нас есть человечек да он там комитет в пакет все это приезжает на пост сервиса кладутся сюда его пускает там описано кладутся сюда как кто не прописан того не пускает в принципе это скорее для наших будущих зрителей вот и еще две штуки о которых я расскажу прежде чем будет дома до тоже есть дему но она не life поэтому не на 10 что она зависнет для того чтобы иметь возможность быстро спасать мир или быстро кого-то отрубать в начале всех цепочек мы сделали 2 и песета один называется руль езды на и другой занимается руль и салоу как-то работает например кто-то сдал намеренно какими-то ботами создает нагрузку на наш веб раньше это было как ну нужно найти пологом его айпишник отнести его там сетевым инженерам они пойдут на какую-нибудь там найду на какой циски его надо забанить через какого трафик идет и там его забанят как это выглядит сейчас как бы пусть консул две с половиной секунды всё причем как бы vol 2 и поскольку консул вот за счет пир toupper быстро очень что это распределяет то практически везде доедете до всех концов мира то же самое роли салоу это наша страховка то есть если что-то пойдет не так мы где-то накосячил с firewall что-то где-то заблокируем сюда можем кинуть туда там условно 00 слеш ноль быстренько чтобы что-то быстро вот поднялось и потом все это удалить уже починить руками примерно такая была мысль все косячат и я как-то полностью остановил танки вот h&h ип ошибившись и минус вырвала меня чуть позже расскажу в общем вот а теперь собственно должна заработать дымка есть что отлично значит что тут происходит изначально я показываю базовый шаблон который мы говорили вот и показываю что у нас пустая песета чтобы как бы никакого учительства запускаю консул вдв режиме то есть он хранит все in memory никаких там при дефайны штук нету консул у нас запустился и сказал типа все-таки я зарегистрировался сам себя выбрал вот запускаем собственно главную штуку которая называется bff firewall где то что управляет и 5 был сам запускаем в дебаг режима чтобы смотреть что происходит вы видите что он сразу пошел в консул сразу там себе нашел всякие ключики которые он будет смотреть он всегда смотрит за ключиками и сразу он залил первые правила то есть он залил руль с диной ролью столовую сразу и сделал сеты соответствующие то есть пожалуйста дальше мы смотрим вот как регистрировать сервис например вот просто не в рамках там папе то вообще да просто вот куб корр лома в консул сходить регистрируем сервиса саша которым во всех примерах я рассказывал проверяем ssh у нас поднят отлично и сейчас мы его зарегистрируем из внимательно смотрим на соседнюю консоль где у нас боев его видят что произошло изменение думает немножко генерирует там правила и собственно перри генерирует все прошло сколько там прошло ну секунд 76 вот смотрим как изменились правила появились у нас появился наш ssh там где-то и теперь мы высосав попасть в общем-то не можем скорее всего все дальше будет целая минута слепа и пока он будет делать slip я расскажу зачем это нужно дело в том что внутри вот этого боев и в firewall где есть свой снифер который отслеживает при помощи а вот это вот правило не флаг это кто не знает она флаг это такой девайс который поднимается как бы в внутри ядра как такой виртуальный сетевой диск который можно и 5 был скидывает пакеты теста вот эти правила говорят что если у нас пакет не прошел в описать то есть это какой-то вредоносный пакет положи его в этот и на флаг баев его при помощи стандартной ли ппкоп его читает и пишет себе в статистику зачем очень часто бывает что мы не знаем кто ходит к сервису тогда мы вот последний дроп убираем и это так называемый перми сиф мод но это как бы типа мы просто пишем что к нам ходит и собираем информацию потом проходим как-то ручками это анализируем потому что для этого в общем не нужны там не сетевики никто инженер проходят типа а вот этих ас ты кто там вот эти отлично и вот сейчас я показываю как раз как эту статистику собрать вот мы видим там от нашего су-100 над 7001 там были пакет и все теперь мы знаем что около хвост ходил в ссср что не попадал под нашей цели окей окей теперь собственно берем и запускаем сенгоку то что я говорил по поводу синко спать при дебитом поднята фейковая копия по 5 дбв фоне где-то которая отдает на пешку нужный джейсон видим что bff волди сразу нашел что ага у меня изменились тонкий вылью обновил все это дело добавил новые цели мы увидим что у нас появились наши сети в эпизодах отлично но собственно ssh после этого естественно станет доступен исходный код всего этого дома доступен а на гитхабе то есть я все вот эти скрипты включая фейковый паппет тебе все это выложил вы можете попробовать просто взять повторить вот по шагам пом 8 простых шагов чтобы это сделать окей поехали дальше помимо вот этих сетов которые дэна и allow есть еще возможность добавлять любые другие сеты в вот этом пространстве доллара и пятьдесят долларов для чего потому что иногда кому-то они нужны кому-то нужны какие-то конкретные писать например чтобы эмулировать там отключение какого-то какой-то части кластера кому-то они нужны для изоляции кому-то они нужны еще для чего пожалуйста каждый может себе принести какие-то любые секты их назвать они будут из консула подсосался при этом они могут как участвовать в правилах и питалась так и быть как бы командой noob то есть они просто будут созданы и их консистентной будет поддерживаться демону дальше как бы параллельно мы еще и пользователь туда засунули то есть раньше как было пользователь подключался к сети у него ему через там домен при грубо говоря присылали какие-то параметры ну то что все в домене естественно том числе вкусные машина по этому вкусному машины давали доступ куда-то ну потому что до появления некст-ген firewall cisco не умела как бы вот понимаю что вот этот вот пользователи это вот этот вот айпишник но не как только пафосный что сделали мы мы взяли вклинились вот в момент получения адреса то есть там это обычно тот 1x либо какой нибудь вы по я я потом либо в п ну ты все это через радиус идет короче мы в радиусе тот момент вклинились и так искали а давайте мы возьмем вот сделаем для каждого пользователя от группу как я там раньше показывал которая будет по его имени пользователя и мы его айпишник туда будем класть с отелем который равен и водящий пи лесу то есть как только он истечет она туда исчезнет и теперь мы можем открывать доступ к сервисам просто водку вот вот этому пользователю суда можно все просто вот так же как другие группы username пожалуйста полностью вот взяли и вот по сути так походя избавились от этой боли там сходственные маме с тем что у кого-то они меняются с тем что там конфликты host name of бывает ну в общем кто с такой системой работал тот знает как это хорошо работает ну естественно сняли нагрузку с сетевых инженеров то что больше не нужно все это нацистах прописывать теперь это devops и на своих серверах сами как будут нужны ну чтоб том чтобы разработчик ним сюда пришел они выпускают просто быстро параллельно мы начали разбирать изоляцию примерно по тем же принципам что я рассказывал ведь если мы возьмем все наши сети проанализируем как я говорил на сервис менеджер и делали инвентаризацию и разложим их на такие же группы и в ну на нужных серверах нужные группы засунем допустим в дaнной то тоже самоизоляция stay jing попадает в улиц дунай у пруда и не может ходить в рот работает быстро просто снимаем все опять таки все эти а цели железок разгружаем железки снимаем количество изолированных филонов nokia таки аура пасибо все в качестве такого маленького бонуса вы получили контроль целостности потому что боев и очень ревностно следит за тем чтобы правила которые он делает не менялись если вы попытаетесь что-то там поменять он придет и вернет все обратно у нас раньше даже триггеры был специальный который говорил что типа кто то поменял руками правила firewall сравнивая там я писал огромный такой линдер проверки правил firewall но общем это было сложно а теперь все гораздо проще кто-то пришел поменял правила firewall боев его пришел быстро поменял их обратно все никаких проблем никаких больше типа я тут быстро поднял прокси чтобы сработает как бы и не сработал из дома там на работу за коннектится что то сделать вот таких вариантов больше нет все очень хорошо и в качестве такого вот как бы надстройки над тем что наш консул работает как вы знаете не очень было сделано еще защита от аварий который заключается в том что пфф всегда сохраняет последний удачный стоит прям вот в бинарной структуре в той бен если что-то пошло не так он откатывается всегда назад на этот стоит бен то есть может быть что консул дал какие-то не дал данные или кто-то ошибся например дал ну правила которые не могут быть применены чтобы нас не остались без firewall боевое откатит последний стэйт если где-то на каком-то этапе продают ошибка если стоит вообще не получается мы считаем что это новый сервер потому что если начал там был какой то стоит и просто открываем все серые сети надежде что админ то идет и починит ну то есть там идет просто вот в хардкоре наверное когда-нибудь это вынесу в конфиге частом просто hard кодом 3 серых city 10th 8 172 там слэш из 12 и 168 16 таким образом случае если что-то пойдет не так мы с гарантий по останемся с рабочим firewall ну вот в рамках нашего консула и того что мы видим это на самом деле важно фишка позволившие развиваться дальше немного таких как бы баек и всяких других богов с которыми мы столкнулись как вы думаете что будет если вы добавите в и песет какой-нибудь 00 слеш ноль вы думаете что вы открою как бы добавить и все и печники нет вы получите багу причем это бага не работает это 16 года бага найдено на вот лежит проходили под этим номером и теперь в боев в стоит жесткий такой хардкот что 00 сплошной превращается в два адреса в там 001 и 128 лишь один да вот так вот что вы думаете описать делает когда вы говорить ему restore думаете он работает также как и пит ибо с нами фига он делает мер шине restore вы такие думаете что вы делаете ristora нет вы делаете мир и старая-старая адреса никуда не делись доступ вы не закрыли кому не надо вот пожалуйста поэтому теперь там довольно сложная система вместо просто ristora там делается греет темп потом restore флаш темп restore в темп потом своп чтобы делать это атом арно потому что если вы делаете сначала flash и в этот момент придет какой-то пакет то он соответственно будет отброшен и можно что-то пойти не так особенно на их dippy поэтому там немножко в черной магии так вот как я уже говорил вы думаете что вы просите какие-то данные и вы получите ну либо данные либо ошибку при чем вы можете сделать это прям вот локально консулом как клиентам смысле вот программы да вот такие окей он также должно быть что то да вот а нет у вас зависит и то и другое причем локальный вот этот консул клиент который по сути обертка на там какому-то хоть и т.п. а педан адрес там он просто виснет не отвечаете на control сцене на контру z ни на что только kill -9 соседней консоли и вот как только вы сделаете большой кластер вы с этим тоже столкнетесь потому что к горю где-то что-то за весла и директор время она приедет сюда у вас вот не отвечает мастер дата-центре вы думаете nokia сейчас наверно там сработает алгоритма перри выбора нет не сработают причем непонятно как они сработают или не сработают они сработают и мониторинга ничего не покажет консул инфо скажет все окей commitment индекс есть лидер лидер найден все хорошо и как мы с этим боремся сервис консул restart в кроне реально как бы вот вот так я говорю как есть потому что это опять таки если у вас 50 серверов вам это не страшно когда у вас их будет 16 тысяч вы поймете как это работает поверьте мне собственно на этом такая техническая интересная часть подошла к концу и тут вот теперь заключение которое ну нужно делать потому что такие правила конференции в общем то вроде как и так все рассказал но окей так что мы получили мы получили стопроцентное покрытие всех linux машину получили скорость мы получили автоматизацию мы получили освобождение железа и сетевых инженеров от рабства мы получили возможности по интеграции который в общем то практически безграничны там хоть с кубер нити сам хоть sensible им хоть просто с питоном может интегрироваться что мы получили в нагрузку мы получили консул с которым нам теперь жить и мы получили очень высокую цену ошибки как я уже говорил один раз я в 6 вечера то есть в прайм по россии что-то правил в списках сетей как раз когда мы разбирали вот эту изоляцию на железках и дело изоляцию на б.ф. я где то там чуть чуть ошибся ну чуть-чуть то ли маску нет указал короче легло все вот буквально за там две секунды так раз 2 poms загорается мониторинг прибегает дежурный как бы сервиса пор говорит у нас все у нас все лежит нет седой седой потом был тот этот короче начальник нашего департамента когда он обещал бизнесу почему так произошло то есть цена ошибки такая что мы теперь свою собственную сложную процедуру придумали вот как этого избегать если вы это будете внедрять на большом продакшене то не надо давать мастер токи над консула всем подряд серьезно это плохо закончится а стоимость многие там сразу то типа сколько вам это стоило ну вот писал я 1 400 часов примерно грубо округляя положительную сторону пошла там многими вещи не помню и прав там типа стандартную неделю поддержка вот на мою команду из четырех человек мы тратим примерно 10 часов в месяц судя по тайм трекингу на всех ну то есть по сути это бесплатно по сравнению с ценой любого индекс ген firewall это бесплатно чем он будем делать дальше ну как я уже говорил долгосрочный план это поиск какой-то код альтернативного транспорта то есть мы смотрим может быть какая-нибудь кафка может быть ещё что-нибудь ну то есть как такой вариант но пока первых ближайшие там годы мы точно живем на кон суда а ближайшие это интеграция там стоил туба нам интеграция с мониторинг интеграция сынов ты был с возможность какими-то другими дистрибутивами там ну всякие метрики оптимизации так далее то есть такие простые планы то есть ну понятно но в дальнейшем мы рассмотрим вариант отказа или хотя бы дополнять альтернативного транспорта к консулу ну собственно поддержка кубер не тесто же гетов в планах потому что сейчас у нас их несколько кластеров есть и люди вроде как хотят вот а теперь вот у вас для вас я сделал семь мест 5 слайдов а теперь вот один слой это сделать для себя зачем я сюда приехал вообще на самом деле не просто чтоб она вас посмотреть а для того чтобы сказать ребята приходите и к мите я считаю что получился очень крутой проект но к сожалению пока это проект одного человека меня того кто написал этот код я не хочу чтоб он был проектом одного человека я хочу чтобы каждый из вас по возможности пришел и попробовал и что ты сделал за к метил сделал и шью сделал pull request что-то предложил просто хотя бы по ты сказал что получилось что не получилось ну серьёзно давайте не давайте хорошим проектом умирать на этом у меня все спасибо иван я как будто знаешь вот смотрел на человека который импровизирует и танцует для себя ну ты можешь танцевать на велосипеде ты можешь танцевать на самокате на моноколесе и даже на сигвее спасибо большое за это наслаждение и тебе в цель на благодарность организован комитет это маленький подарок спасибо я уже вижу руки даже человек с микрофоном добрый вечер дмитрий завьялов компания smi2 спасибо за доклад клевая штука сам хотел такое делать вот обязательно воспользуюсь вашим опытом хотел бы начать с небольшого уточнения в 10000 адресов то что время пинга будет разная если у нас будут разные с разных адресов king ваться потому что он работает до первого попадания в правилах естественно естественно что я симулировал эту штуку именно для того чтобы показать как влияет просто количество записей естественно что один был последним разрешается это просто так по поводу зависающего клиента не пробовали вы применять команду тайм-аут который отстреливает ну если бы это как бы мы пользовались бы клиентам то да но я скорее рассказывал про то что даже сам клиент внутри себя который написан теми же кто писал как бы консул сервер не умеет работать со своими собственными ошибками что насчет кастомных провел ну например там с одного борта разбрасываем на несколько переадресации там пожалуйста то есть никто не мешает базовый шаблон там все правила как бы шаблонах шаблон в конфиге конфиг можно править как угодно то есть можно из этого ходите хоть над сделать можно при желании хоть что от себя еще добавлю вот у себя мы используем ansi бы в том числе для firewall когда раскатываем и там я написал фильтр результаты пи который понимает проверяет валидности api адреса там сеть под сеять айпишник вот и resolved вейпе адрес очень много более пропадает не это у нас сейчас на было сразу из коробки то есть что 0 пушка в проходит через ряд преобразований чтобы тогда не заметили что-то непохоже на и печник спасибо спасибо за вопрос правый от тебя иван спасибо большое за доклад у меня несколько маленьких буквально вопросов во первых как вы регистрируетесь и сервисы тип из sh в консоли глобально мы их стандартные все сервисы мы просто при регистрировали заранее для всех нот то есть если если мы подняли но тут на ней точно есть ssh и на ней точно есть в начале они firewall не нужен спасибо и у вас я так понимаю ну вот клиент написаны вами ходит именно в консул локальные в агенты ну в тот который мы укажу то есть его можно указать любой консул у него какой то есть токен или что-нибудь в этом роде да естественно мы пользу полностью имплементировать и как бы все по все шутки со цели меня история на чтение там правил усен колки есть токен написание правил можно без . а где таким хранится в кафе время в конфиге хорошо и последний буквально вопрос когда вы говорили про большой кластер это размер примерно как сейчас у нас по моему блин а я уже не помню в районе 16 или 17 дата-центров федерации но и вот эти 16 машин спасибо размазанные как бы самая большая сам большой дата-центр в европе там по моему чё-то типа 4 600 машин подключены к тем сервером у нас еще три заявки на вопрос следующий слева тебе вам спасибо вам за доклад а вот вы сказать что у вас в правилах счет отеле есть да вот кто контролирует исполнение этого отеля а сам firewall де у нас все сервера у нас симку it's a point т.п. в обязательном порядке это стандартный сервис и сам firewall если видишь тот отель превышает текущие у них стоят это правило не применяется то что периодически консул опрашивают по вся его не надо у него все как бы у него хранятся все правила тест отелям плюс есть клинер который ходит и вычищает лишний правилов просто чтоб консул не перегружать и ищем такое маленькое замечание а вот вы говорит что теперь нету варианта что инженер зашел там все прокси дано время добил какой-то такой момент если он мог себе там отправила создать его и 5 бусидо что не мешает ему приостановить демон убит 7 прокси нет в как бы ничего просто вопит уровень ну во первых побед придет его запустил вторых уровень как бы я сделала себе маленькую дырочку на пять минут и я грохнул продакшен сервис уровень как бы ада и ответственность немножко разный это уже административными процедурами решается привет спасибо за доклад на самом деле делал подобную штуку ну ложка писала обертку рука петерболд я понимаю как это достаточно тяжело общаться именно вот с правым выводом вот потом появился ну-ка потом примерно в это же время очень большими шагами show and frames языком описания там же все прекрасно там против ноября он даже описывает описывается вот почему вот именно восемнадцатом году он уже там вовсю вовсю был распространён к чему бы hell 711 от ветра hell 7 у нас везде hilton контур не было еще and they'll с не поддерживаем ведро 310 вот когда мы перейдем на архэл 88 и у нас будет он автобус но это будет наверно все чем году спасибо иван ровно напротив верку привет диван спасибо за доклад у меня несколько таких вопросов скажи цыпа у сильно поедает вот самообслуживания циpкa поедает снифер если вы используете снифер и у вас много пакетов не попадает в матч sniffer джобс и повода если вы и на флаг не используете как говорил вы можете кастомизировать это как хотите циpкa практически то есть он по сути он спит и ждёт сигнала от консул о том что там что-то изменилось надо что то сделать если ничего не меняется на вас 30 минут на всякий случай перечитывает чтобы убрать то что не попало под отель собственно все второй вопрос для я так понимаю что когда я 5 был сперри принят применяются то дропа еца connection и перед . камень ему приходит рилот и 5 был ни там ни там ни делается полный рилот там делается flash flash restore так называемый короче который не прерывает connection ну и последний вопрос какие-то метрики есть какой-то способ отдавать метрики например я хочу видеть что камни наплыв прямо на этот хвост что там или натан пока по каждой из цепочек и 5 был сам считает каунтер и мы их пока никуда не экспортируем но и пожалуйста полу request еще раз спасибо последний вопрос мы успеем друзья простите к брюкам и сидел за доклад вопрос такой вот вы спасли ног of от огромного количества правил как вы все это мигрировали мигрировали говорил нам помогали сервис менеджер нам помогали сами ноги просто не были этом заинтересована то есть мы сидели разбирали где какая сеть вот потратили то есть ну это нас был сделать один раз раньше для каждого нового цели нужно сделать это еще раз точно тогда потратили сколько мы по-моему месяца три у нас ушло на то что полностью снять изоляцию вот перенести на абаев его и просто не вопрос какую вы лидируете то что все таки переменился применился тот который должен быть если firewall не применится как я говорил у нас вы возникнет ошибка ну самый пить его скажу что firewall плохой и мы откатимся назад к прошлому стоит у всего не то чтобы плохой а так ну хреновенький а ну в смысле для этого как бы кадре view и теста и все еще тут это никак никаких там vr map of money запускаем локально что что-то проверять друзья просьба видите его нужно снаряжён чтобы поговорить с вами да тут след привет ребята не будем подавлять коллега зайти задавать вопросы дискуссионной зоне какой-то вопрос был лучшим правда какой-то вопрос был лучшим и наверняка об этом не думал она и не надо надо просто вспомнить конечно но там был какой-то вопрос да а почем сложно сложно было сложно вопрос да наверно как что-то вот там спрашивали выходи к нам пожалуйста быстро я помню что там дарта то интересно и представься и где-то работаешь расскажи пожалуйста да всем привет я коллега его на и это не подстава я пользуюсь пользуясь его сервисом могу сказать что у request и сделать не буду но проекта желаю самого большого успеха потому что действительно вещь полезные вопрос наверное хорошее второе место которое занял им не видит перед браво спасибо большое"
}