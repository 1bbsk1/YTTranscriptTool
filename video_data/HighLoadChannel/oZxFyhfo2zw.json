{
  "video_id": "oZxFyhfo2zw",
  "channel": "HighLoadChannel",
  "title": "Синхронная репликация и выборы лидера в Tarantool / Сергей Петренко",
  "views": 534,
  "duration": 1920,
  "published": "2022-03-21T14:08:24-07:00",
  "text": "меня зовут сергей петренко я работаю в тарантул в основном занимаюсь рипли кации и последний год эту синхронная репликация и выборы лидером мой доклад сегодня будет состоять из двух частей начнём мы с того что кратко пробежимся по алгоритму ровд а дальше я расскажу где мы втором туре отклонились от равта у нас был отличный план надежные как швейцарские часы взять готовый алгоритм все поспеть и написать и у нас будут готовы и идеальные выборы лидера но получилось не совсем так из-за некоторых особенностей тарантула с которыми мы уже долго живем мы не смогли прям взять целиком готовый ровд и все поспеть и сделать про это я и буду рассказывать но сначала ровд и так цели рафта это создание идентичных копий журнала на всех узлах власти при этом система должна продолжать работать до тех пор пока более половины узлов в кластере живы каким образом ровд это этой цели достигает он решает две независимые задача 1 задача это синхронная репликация журнала лидера и 2 это смена лидера или выбора сначала проговорим про нормальный режим работы когда в кластер есть один лидеров все хорошо он просто реплицирует свой журнал на всех остальных как это выглядит в кластере один лидер все остальные узлы фолловеры этого лидера только лидер может что-то писать журнал и он реплицирует записей своего журнала на фоловеров фолловеры ничего писать не могут сами лидер применяет изменения только после коммита соответствующий запись коммент происходит после попадания записи на большинство узлов в кластере то есть никаких грязных числе не тут нету сначала мы ждем пока большинство получат изменения потом их комиссии мы только потом применяем если вдруг лидер пропал-то нужно начинать новые выборы и пока новый лидер не появится никто в кластере писать не может весь кластер доступен только на чтение вместе со смертью этого лидера с картинки заканчивается мой рассказ про нормальный режим работы и теперь пора поговорить про смену лидера ровд кластер живет интервалами времени которые называются тюрьмы каждый терм начинается с того что появляется один или несколько кандидатов которые баллотируются в лидеры для того чтобы выиграть выборы кандидату нужно набрать большинство голосов и как только он это сделает он становится лидером и сообщает всем остальным что они должны подчиняться с одним лидером кластер живет до тех пор пока с ним что-нибудь не случится после этого надо которая 1 заметит что лидер пропал увеличивает терм и становится кандидатом уже в новом термин там либо за неё либо за кого-то еще голосуют этот кто-то становится лидером в новом терме и так они и живут долго и счастливо даже если лидер старого термо вдруг вернётся он становится фоловерам нового лидера какие гарантии раздает при смене лидера первое это то что двух лидеров не может оказаться в одном термин ну и второе то что на свежие избранном лидере точно есть все за комичные транзакции старого лидера ну и естественно всех его предшественников достигается это благодаря правилам по которым фолловеры голосуют за кандидатов во первых ал'вир может проголосовать только единожды затер голосует он за первого попавшегося кандидата который его об этом попросит но при условии что кандидаты удовлетворяет некоторым условиям про который я дальше расскажу 5 секунд голосующие отдаст голос только если кандидат новее чем он сам это значит что на кандидате должны быть все те же записи что и на голосующим ну и на нем могут быть какие-то еще записи это ничего страшного благодаря этому на новом лидере точно будут все за комичные записи почему это так ну надо вспомнить что к месяца запись только после попадания на большинство узлов кандидат становится лидером тоже только после того как наберет большинство голосов вот рассмотрим какую-нибудь одну запись за конечную почему она точно есть на новом леди предположим что за нового лидера проголосовали все у кого этой записи нет таких not меньшинство раз она закончена и и голосов не хватит чтобы выбрать его лидером нужен хотя бы один голос от того у кого эта запись есть это значит что в новом лидере она тоже есть раз голосуют только за тех кто новее сейчас посмотрим на полный список правил для голосующего каким образом он голосует за кандидата голосующий как я уже сказал выбирает первого попавшегося кандидата который удовлетворяет нескольким условиям во-первых тером кандидата больше чем тером голосующего а все остальные правил и они касаются как раз новизны кандидата как ровд понимает что одна но до новее другой во-первых голосующий смотрит на корм последние записи в журнале кандидата и сравнивает его со своим телом кандидата должен быть больше или равен чем там голосующего и во-вторых длина журнала кандидата должна быть не меньше чем голосующего по этим двум последним параметром и не определяются коту новее какой-то сервер удовлетворяет всем этим условиям набирает большинство голосов и становится новым лидером если вдруг голоса так разделились что никто не стал лидером то ничего страшного выбора просто перри запускаются все по новой набирают голоса и рано или поздно кто-нибудь победит новому лидеру нужно все равно еще проделать кое-какую работу чтобы привести кластер в нормальное состояние как мы уже поняли за комичные транзакции на нем все есть но все-таки части записей на нем может не оказаться например если старый лидер успел отослать последнюю запись какому-то одному фолловеры не за коми тела и естественно то этот фол wear совсем не обязательно станет новым лидером поскольку лидер единственный источник правды в кластере все что ему остается это удалить все лишние записи с фолловеров ну что он и делает вообще лидер сразу после избрания оказывается в такой ситуации журналы лидера и фоловеров совпадают до какого-то момента дальше начинаются расхождения что то есть у лидера что то есть уфолога что в таком случае лидер делает он находит последнюю точку в журнале фолловеры для которой их журналы совпадают все что после этой точке пуловер у себя из журнала удаляет прям реально берёт и отрезает кусок журнала с конца на место этих удаленных данных лидер присылает свои собственные транзакции вот теперь уже все хорошо журналы лидеры фолловеры совпадают и начинается нормальный режим работы когда лидер время от времени становится автором новой записи в журнал of all вера и и со временем получают это крафт в рафти у нас есть термы термо это период работы с одним лидером внутри каждого термо либо идут выборы и никто не лидер никто не может писать либо лидер строго один узел который победил в голосовании голосуют но ты только за тех кто обладает теми же записями что и они сами это нужно для того чтобы за комичные записи старого лидера не терялись при переизбрание лидера и для голосования и для того чтобы закомитить запись кворум одинаковое большинство голосов ну и наконец самый такой важный момент на который мы еще посмотрим попозже это то что фолловеры могут удалять конец своего журнал давайте себе похлопаем потому что мы всего за 10 минут изучили ровд и я думаю это рекорд спасибо теперь поговорим где мой от ровд отклонились начну я с таких самых безболезненных и простых изменений я закончу более серьезными вещами во первых у нас можно конфигурировать кворум следующие изменения связаны с голосованием а именно с тем как ноды понимают кто из них новее кто старше дальше мы поговорим про момент применения транзакции и закончим up and only журналом тарантула ну сперва прокурором в raw те кворум это большинство то есть если у нас в кластер есть n узлов кворумы т.н. пополам + 1 в тарантул можно указать любой кворума какой вам только придет в голову можно например использовать числа сказать что кворум всегда равен 13 можно formule 1 какую нибудь написать формула будет вычисляться каждый раз когда вы добавляете в кластеру узел или удаляете его формулы дают большой простор для воображения можно в принципе много чего написать можно даже вот по такой формуле обновлять кворум это не является профессиональной инвестиционной рекомендации так сказать лучше так не делать теперь поговорим про голосование как мы все помним в raw те достаточно посмотреть на длину журналов ал'вира чтобы понять есть на нем последние данные или нет ну при условии конечно что мы посмотрели и на черном последней записью журнале стран туле это не совсем так у нас есть похожие налога индекс понятия это л с н то есть всем изменениям сделанным на одном сервере присваивается последовательно увеличивающейся lsn и если бы сервер у нас властей был один то тут было полное соответствие с raw том прочтя сравниваются logo индексом и бы сравнивали lsn но когда сервер 1toy выборов лидера никаких нету поэтому серверов у нас обычно много и теперь уже все данные которые есть на ноги их актуальность можно сравнивать смотря только на массив lsn где каждая компонента отвечает изменением на одном из узлов этот массив и лосьонов называется вокруг значит при голосовании нам тоже надо сравнивать вы клоки а не просто какой-то там пару чисел проблема здесь в том что вы коки могут быть несравнимы например если мы два таких вы клок а возьмем здесь куда не поставь кандидата и голосующего вверх или вниз ни один из них не сможет проголосовать за другого поволоку явно видно что у каждого из них есть какие-то данные которых нет у второго сервера тут если вы клоки будут выглядеть так то за кандидата который сверху конечно можно голосовать если данные совпадают естественно тоже в общем мы можем лучше чем ровд на самом деле понимать какие данные у кого есть о каких данных кому недостает это даже нам немножко помогло сейчас посмотрим на ровд кластер забудем вообще что втором туре есть выбор и лидер здесь вот ровд пусть на дворе 4 терм и лидер который сверху так только что он разослал желтую записи с 2 thermona большинство узлов если вы хорошо слушали начал это вы как и мы думаете наверное что теперь эту запись можно коммитить ведь попала на большинство с ней уже ничего не может случиться но на самом деле это не так потому что все еще может произойти ситуация как с права на картинке это связано с тем что кандидат который здесь внизу нарисованном все еще выборы может выиграть ровд ведь смотрит только на длину журналы и на терн последние записи в журнале о кандидаты этот терм 3 а у большинства голосующих 2 или даже он вообще один из ли кандидату взбредет в голову устроить новый выбор и он вполне может победить и и желтую записи все остальное чего у него самого нету удалить там это конечно не подходит мы хотим как-то не дать такому кандидату победить вот оказывается в raw те для этого нужно дождаться пока хотя бы одна запись из нового термо лидера попадет на большинство узлов вот в такой момент уже можно комитете желтую записи розовую одновременно теперь уже кандидат понятно выиграть не может потому что у него тер последние записи в журнале 3 а у большинства 4 ситуация справа невозможно то есть в ровд новоиспеченному лидеру прежде чем коммитить записи старого термо надо дождаться пока хотя бы одна запись из его собственного термо закомитить это такое неприятное отступление от общего правила что запись к метиса как только она попала на большинство узлов в трандл все не так у нас желтую запись можно коммитить сразу же как только она попала на большинство с ней уже ничего не случится мы ведь сравниваем в клоки они logo индекс этом какие-то и как только желтая запись есть у большинства выхлоп большинства по желтой компоненте становится не сравним с его кулакам кандидата он уже большинство не наберет не победит и малину нам все не испортит поговорим теперь про момент применения транзакции в raw все работает следующим образом сразу же после получения запроса от клиента лидер создает новую запись журнал реплицирует журнал ждет пока большинство фоловеров ему сообщит что они эту запись получили только потом он запись комитет и применяет соответствующие изменения в таранто ли все немножко по-другому сразу по приходу запроса от клиента изменения применяются и уже после этого создается запись в журнал и начинаются репликации когда-то потом там когда большинство получит эту запись происходит commit это значит что между применением изменений и коми там возможно грязные чтение но это не очень большая проблема у нас есть менеджер транзакций если его включить он с этим справится ну и наконец самая большая проблема с которой мы столкнулись самое большое отклонение от равта это up n down ли журнал тарантул дело в том что у нас fall where не может удалить конец своего журнала если его лидера об этом попросит как только какая-то запись журнал в журнале появилась и и уже оттуда не убрать поэтому нам пришлось изобрести специальную запись она называется рыбак действует оно вот так она содержит указания на какой-то кусок данных которые надо отменить которые попали в журнал но еще не закончены и как только сама это запись roldex журнала попадает эти данные отменяются не данные на реплики теперь выглядят точно также как будто этого каскада куска журналы последнего реально на ней нет лидер используют эту запись для того чтобы привести данные на фол a very в одно состояние с собой он вообще не смотрит там где их журналы совпадают где не совпадают он просто пишет rollback на все чего у него нет в журнал рано или поздно по репликации этот rollback достигает остальных узлов если у них ничего не надо отменять то все хорошо rollback просто не работает если есть что отменить to roll так действуют и вот лидер добился того же чего добивается рафта вы лидер отрезанием журналом теперь данные на лидере и фолловеры тоже совпадают и можно начинать нормальную работу и так в то время как в raw те лидер удаляет конец журналов о лавера если вдруг заметит какие-то расхождения со своим журналом в tarantul и вместо этого лидер пишет рбк свой журнал ждет пока это трал когда едет до фолловеров и когда это происходит данные на лидере if all we rock совпадают в этот момент мы думали что у нас все хорошо что каждая из отличий которые есть между тарантула моря в том мы учли и все должно работать прекрасно мы появился один достаточно удивительный бак мы заметили в тестах что время от времени появляются такие самостоятельные фолловеры у которых есть данные которых больше нет ни у кого в класть и это при том что фолловеры дом 2 и более того там если посмотреть на информацию о репликации написано что в клоки уфологи раз лидером совпадают в общем полная гармония но данные разные я был отправлен расследовать это дело и вот что я выяснил давайте посмотрим на тарантул кластер из 5 узлов не обращайте внимание что их тут три мне квадратики надоело рисовать ну вот у нас есть какой-то лидера и он только что записал очередную запись в журнал он даже успел эту запись отправить на один сервер на 3 после этого умер лидером становится второй сервер за него проголосовали сервера 4 и 5 которые вы не видите но они есть он начинает работать как нормальный лидер отменяет все чего у него нет эту запись получают фолловеры отменяют лишние транзакцию у себя рано или поздно возвращается первый сервер он теперь фолловер нового лидера он тоже получает эту запись и вот на данный момент все хорошо ни у кого нету этих отмененных транзакций все синхронизированы все в порядке но к этому моменту и первый сервер уже то гнался до всех изменений который сделал 2 и вполне может выиграть новые выборы тут надо вспомнить про еще одну особенность репликации в tarantul и она заключается в том что каждый кусочек журнала лидера должен рано или поздно доехать до всех фоловеров здесь например вот этого серого кусочка нету 2 фоловеров значит лидера добросовестно ему его посылает в этот момент на фол very и появляются данные которых нет ни у кого ведь когда красный сервер писал на них ral бег он вообще не знал о существовании таких данных у него rollback журнал попал раньше чем сами данные all back конечно действует только назад на уже существующие в журнале записи он не может действовать вперед тут еще надо заметить что в raw те такая ситуация была не возможно именно благодаря тому что все лишние данные с фоловеров лидер бы просто удалил вот этого куска журнала бы вообще не существовало но поскольку в тарантул это не так такой вот удивительный бак у нас получился но теперь когда уже было понятно в чем проблема была достаточно легко придумать как с ней справиться на самом деле ведь каждый кусок журнала он относится к тому или иному тюрьму для второго сервера например новый термин начинается вместе с этой записью вот этой записи rollback как только становится лидером нужно просто сделать так чтобы после попадания хотя бы одной записью с новым тюрьмам журнал все записи со старым тюрьмам не применялись а заменялись на пустые операции так мы и поступили теперь все действительно стало хорошо консистентную и похоже на ровд насколько у нас это получилось и так в то время как в raw те при голосовании сравнивается пара чисел лог яндекс или же длина журнала кандидата и голосующего в тарантул сравниваются массива чисел в блоке конкретно это изменение не только не приносит нам дополнительных проблем но даже дает маленький бонус про который я говорил чуть раньше в то время как в raw те журналы фолловеров же из журнала фолловеров реально удаляется лишние данные если вдруг они там обнаружиться в tarantul и лидера достигает похожего эффекта записывая журналы фоловеров запись ral бег с номером термо в котором оно сделано потому что реально удалить конец журнала мы не можем ну и наконец в ровд с перво камень транзакции только потом применения соответствующих изменений автора 0 наоборот сначала изменения применяются и через какое-то время они комитете это значит что между двумя этими моментами времени возможны грязные чтения но с ними можно справиться включив менеджер транзакции на этом у меня все спасибо за внимание вопросы друзья руки в небо вот первый готов второй третий и ребята в онлайне вы тоже можете к нам подключиться в соседних залах мало подключений мы пока лидируем да пожалуйста спасибо за доклад есть такой вопрос в tarantul и мы можем настроить к вору однако какое у этого есть применение если при кворуме на 2 мы получаем возможность плит брей а при кворуме на 2 плюс 2 мы уже имеем меньше отказоустойчивость но на самом деле это наследие тех времен когда у нас еще не было выборов лидера а было только синхронная репликация там можно было выбрать какой угодно кворум например сказать что при попадании на хотя бы одну реплику транзакция уже может к месяца вот чтобы хотя бы какую-то там отказоустойчивость получить сейчас этим вот как можно пользоваться в ровд есть такая штука configuration чингиз там если вы меняется конфигурацию кластера нельзя по старому кворум вычислять большинство голосов может получиться что кто-то уже увидел новый сервер а кто-то еще о нем не знают и там короче они могут так посчитать кворум что получится два лидера на один терн у нас самих configuration чингиз пока нету они еще только в планах но вот в качестве варка раунда можно установить например кворум ван пополам плюс 2 и тогда даже если вы добавляете новые узлов кластер в вас они никак не смогут одновременно два и новые старый выбраться лидерами ну то есть это пища для администраторов для восстановления кластера упавшего ну не обязательно почему в живой кластер ведь тоже можно добавлять новые ноты спасибо а ты знаешь кто тебе вопрос задавал это сейчас чемпион по сапера короче все ломали сапер но 20 минут вы не могли выгон выгнать он продолжал и продолжал насколько у него очков сколько очков porsche там как запредельная сумма 2 75 дрожишь пожалуйста большое спасибо за доклад на сколько я понял есть в клоки которой нельзя сравнить а что делать если все вы клоки not несравнимы как выбрать лидеры ну если совсем честно то надо понизить кворумы руками кого-то назначить лидером все сегодня спасибо я хотел спросить вот про бак которого о котором рассказывали последней части доклада мне интересует почему маркер рбк не переехала на второй узел совместно с хвостиком logo с первого узла потому что вот это репликация она работает так что давайте вернемся на этот слайд вот здесь уже каждый кусочек logo с какого то из серверов есть везде rollback например он здесь был раньше чем лишние данные но всех остальных он позже лишних данных оказался в журнале с 1 когда начинает реплицировать что-то себя на второй узел он видит что второму узлу недостает только вот этого кусочка данных он видит штурвал бег в журнале 2 узла уже есть его нельзя второй раз прислать он уже по счетам учтен в в клоки то есть во втором компоненте вокруг и 2 узла это throwback уже есть его не надо еще раз туда засовывать это получается дублирование записи вот вот эту проблему она характерна только для вашего имплементации raw то кому то вы не читаете да дело именно в том что мы не могли удалить конец журнала но больше этой проблемы нет я здесь хотел рассказать про то какие неожиданные последствия могут быть у кастомных решений скорее вот спасибо еще вопросы друзья а вот пожалуйста слева слышите какой эхо здесь не встречи как тяжело звукорежиссера отсекать все это чтобы в эфир красивый звук шел мы старые поэтому мы выключаемся рим микрофон и отлично сергей привет пассива а меня интересует вопрос про rollback как вы им и ролл бэг-энде ли ты еще раз можно но если у нас операция далит ключа и нам нужно я утром бегать нам нужно вернуть часть данных как мы это и делаем ну вот в этот момент времени пока мы видим грязные данные между применением транзакций либо коми там либо rollback все данные для того чтобы транзакцию откатить они хранятся в памяти то есть для делита тоже когда происходит делить у тебя получается на месте старого ключа какие-то данные на месте нового ключа ничего и если надо сделать rollback они меняются местами и ключи обратно вставляется в яндекс смотри только вы как у аккуратно просто смотрите это звезда может не вставать сергей спасибо за доклад очень интересный момент такой будет вопрос как-нибудь вы корректность вот этого всего доказывайте или проверяете того что она там сходится и так далее но сейчас у нас есть тесты с различными кейсами которые нам пришли в голову как можно все сломать и у нас в процессе адаптация джобсон фреймворка к тарантула чтобы на нем проверить что все будет так там формальные варианты потыкаться возможно формальная верификация этом с мучительная плюс например тоже будет но попозже еще вопрос год смотрите юношу в клетчатом очень легко привет спасибо за доклад был очень интересным и у меня вопрос сколько времени нужно тарантул чтобы восстановиться после сбоя мастер отказал выбор нового лидера потом подтягивание за комичных транзакций в да тут все зависит от того какой election тайм-аут поставить по умолчанию он стоит 5 секунд то есть лидер пропал через пять секунд все это замечают начинают выбора если повезет и они с первого же раза а кого-нибудь выберу тут получается там ну порядка 10 секунд пройдет если нет то там пройдет несколько раундов выборов но может быть два три но вряд ли больше это же как бы вероятностный процесс вот получается скорее всего три или четыре election тайм-аута пройдет смотря какой вы election time at поставить и в это время будет класс стр недоступен на записи да он будет readonly спасибо отлично у меня есть супер роль еще благодарить партнеров и спонсоров поэтому ты сейчас выдыхай друзья вы аплодируете я вам рассказываю про байкеров да все были на стенде с мотоциклом это читер это не мотоцикл все были у ферзей дико то есть вы уже знаете что это хостинг провайдер со своим хостинг центром в москве до тир3 и у них супер игра стратегическая сейчас запущена вы уже поучаствовали у нее вот сейчас сразу после цифрового кулуара но в общем вы поняли что делать если вам нужно развернуться на на новом хостинге с банда нами и чопперами без птс вы знаете куда идти старик спасибо за доклад мы тебя пластырем кому подарим за лучший вопрос книжку так сейчас давайте последний вопрос от гражданина в клетчатом или клетчатые да отлично вот вот и теперь тебя посчитали сувенира спикеру аплодисменты спикера"
}