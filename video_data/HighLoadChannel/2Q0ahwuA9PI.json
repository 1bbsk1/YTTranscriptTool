{
  "video_id": "2Q0ahwuA9PI",
  "channel": "HighLoadChannel",
  "title": "Ускорение показа превью изображений в Яндекс Диске / Сергей Нечаев (Яндекс)",
  "views": 308,
  "duration": 1717,
  "published": "2017-04-08T14:05:08-07:00",
  "text": "Меня зовут Сергей Нечаев Я работаю в компании Яндекс делаю разные технические проекты и об одном из них об ускорении показе картинок я и хотел бы сейчас рассказать он будет такой достаточно абстрактный с жизненными примерами и если какие-то будут глубокие технические вопросы я буду готов на них ответить в секции вопросов и ответов или где-нибудь в кулуарах Итак то есть для пользователя когда картинки не грузится это выглядит как-то так на это не очень приятно смотреть но в принципе это нека Обычно когда не грузится какая-то одна конкретная картинка пользователь уже знает что он примерно ожидает на ней увидеть и готов какое-то время подождать гораздо хуже когда он смотрит какой-то альбом с фотографиями или страницу где много картинок и он вообще не понимает что это что тут должно быть чего здесь не должно быть просит пытается найти нужно у него это не получается вот эту проблему пользователя мы и решали собственно генерация Мы в первую очередь хостинг файлов поэтому все файлы пользователя Мы храним в исходном виде ровно что положили то и лежит то и доступно по запросу А во всякие интерфейсы тамб моды там мобильные приложения мы отдаём уменьшенные копии чтобы пользователь Видел что у него есть всего мог быстро найти нужное и по запросу уже скачать там полную версию если она ему нужна соответственно из Большого маленький ктото его сгенерировал об этом и речь Почему размер бедствия для нас важен и это нельзя просто взять первую ссылку не в Гугле А в Яндексе конечно открыть и сделать потому что с ростом числа файлов это прямо серьёзная нагрузка и вот что интересно то есть примерно 25 С5 мил файлов к нам в сутки загружается из них с чем-то там это картинки около 60% Но что интересно то есть вообще зачем люди файлы в облако складывают то есть первое причина - это Надёжность Да Что они хотят чтобы файлы у них лежали в надёжном хранилище и никуда не пропали Вторая причина - это то что у них нет места на жёстком диске А в Облаке наоборот есть они всё скидывают туда локально удаляют и забывают про это пока оно не понадобится третья причина - это то что люди хотят делиться этими файлами показывать их друзьям и вот картинки это как раз тот случай их очень много смотрят то есть в три раза больше че на каждую картинку три просмотра примерно Если так считать сутки и это в два раза больше чем файлов заливается всего Итак как я уже говорил превью сами по себе не появляются нужно чтобы их кто-то сгенерировал самый простой тупой способ - это при обработке входящего файла сгенерировать превьюшку там в одном или нескольких типовых размерах положить их в хранилище записать там метаданные про то что она есть и когда Понадобится тогда Взять её и отдать всё здесь просто никаких задержек для пользователя нет запросили получили Но как только типовых разрешений становится слишком много одна картинка превращается в 10 15 млн превращается в 150 Это как-то не круто совсем ну и Кроме этого если у нас появляется какая-то новая платформа мы можем на ходу начать генерировать превьюшки в новом разрешении но что делать с ране сгенерирован нужно там запускать скрипт который все их обойдёт обходить меся коллекции то ещ удовольствие поэтому это нет Если таких размеров много другой вариант - это динамическое превью мы с самого начала берём в каком-то относительно большом размере картинку сохраняем То есть например 1280 по ширине или там наибольшему измерению и по запросу из неё всё нарезаем что здесь круто мы не храним никаких лишних суно можем сно то что попросили есть никах ограничений там 257 на 343 пиксели пожалуйста если это круто выглядит вставляйте там в лейауты приложение никаких проблем но это требует времени если это время заметно для пользователя это вот все преимущества такого способа убирает потому что пользователю всё равно статическая там динамическая он хочет быстро картинку получить Итак собственно Вот это время которое пользователь ждёт из чего оно состоит здесь написаны стандартные фазы запроса обычно рассмотрение заключается только в них Но что есть ещё на клиентах может быть логика запрос картинки может начаться не сразу И показываться она тоже может не сразу то есть Бывает так что картинка уже загрузилась но там у неё вибили или N она чего-то ждёт какого-то волшебного события всё это время пока картинка не показана пользователь её ожидает И это время надо измерять и понимать Нужно ли что-то в этом месте делать возникла задача всё это ускорить и разобраться из чего оно состоит мы выделили у себя три направления оптимизации первое направление - это изучить всё то что происходит на клиенте задержки там до запроса почему там всё запрашивается не сразу задержки перед показом Зачем вообще нужно чего-то ждать но у нас их нет перед запросом есть а перед показом нет Вот это всё надо было прежде чем принимать рение что с этим делать собрать и осмыслить ВТО это если у нас принято решение что мы не можем хранить 100500 размеров разных и без генерации нам не обойтись нам нужно знать чего она стоит и третье направление - Это доставка уже готовой картинки потому что опять же как бы вы быстро не генерировать как бы вы мгновенно не запрашивали если что-то доставляется медленно пользователь видит крутилку и негодует типа дорогой кто это с тобой на этой фотографии не знаю какой-то Круг крутящийся и надпись Picture The loading меня на ней вообще нет что ты спрашиваешь вот поэтому все эти направления важны одинаково с содержательной точки зрения А какой из них в первую очередь брать изучать более детально Это для этого нужны измерения Сейчас расскажу как они у нас устроены У нас они устроены в таком стилен то есть что происходит ровно тоже самое измеряем сначала у нас загружается картин страничка на которой какая-то шапка есть если человек зал на страницу фотографиями это ВС загружается если он перел навигации внутри диска оно всё уже есть после того как эта шапка есть запрашивается список картинок список запрашивается там сложная логика это занимает какое-то время и после того как оно прошло начинает рисоваться сетка и уже когда сетка отрисовать запросы к конкретным картинкам и они уже появляются по мере готовности и соответственно ровно эти три вещи мы измеряем так Роме этого пользовательского ожидания то есть когда он перешёл на страницу или остановил скролл он начал чего-то ждать когда он получил последнюю картинку из тех которая должна быть на экране Он ждать закончил если например у нас девять из дети картинок загрузились быстро а последнее затупила это всё равно считается некруто это пользователь ждёт мы это измеряем и за этим следим Вот теперь Что же касается отдельной картинки мы измеряем для неё время установки соединения чтобы понять чего нам стоит это безопасное соединение и время собственно загрузки зачем мы это делаем Казалось бы в серверных логах это всё есть не надо ничего собирать агрегировать там с пользователей логи нса взял посмотрел делаем Это мы Затем что кроме клиента и кроме сервера есть так называемый мужчина посредине в виде антивирусного программного обеспечения или других анализаторов трафика который может как-то вмешиваться в процесс и Бывает такая ситуация когда жа что ни чтото медленно работает мы можем посмотреть на серверные логи бывает Конечно и так что это у нас медленно работает но довольно часто Дело в том что антивирус хочет посмотреть на фотки французских Альп прежде чем показать их пользователю измеряем мы это всё средствами Это отличный документирования по стадиям Сколько занимает время зазрения установки безопасного соединения вот все времена расписаны Единственное что то есть документация по нему исчерпывающая на что хочется обратить внимание Вот этот заголовок Time in Orion он описан в самом конце до него добираются не только лишь все вот если картинка отдаётся с другого домена не та не с того с которого грузится основная страница то считается что это может злоумышленник подгрузить картинку или ресурс и что-то важное на основе таймингов узнать поэтому говорить ему нельзя эти тайминги и там ВС выставляется в ноль и получается такая идеальная картина мира графики горизонтально там безопасное соединение ноль там DN ноль всё отлично но по факту Это конечно не так просто защитили от злоумышленников и в итоге сами от себя вот Что же касается времени измерения порций картинки о которых я говорил пару слайдов назад мы сделали такие приборы и там процентили всякие показываются конкретных значений не видно но я потом про них расскажу то есть мы видим сколько примерно пользователь ждёт всего и из чего это ожидание состоит и надо ли что-то с этим делать или не надо вот видно там что с какого-то числа со временем запроса листинга стало нужно что-то делать и видно что до сих пор этого не сделали так до того какп сделать раздел все фото в котором фотографии пользователя бы автоматически бы разбивались на различные там моменты во времени и пространстве то есть чтобы пользователь не вручную раскладывал свои фотографии там это такой Отпуск это ской Отпуск это там Пикник на обочине это там Завтрак у Тини это там ещё какие-то мероприятия а просто все фотки побросали у нависшей профайлы то есть загрузили получили без всякой удобной магии с фотографиями как только мы задумали этот раздел ключевым требованием стало то чтобы картинки отдавались быстро и пока проблема не была решена со скоростью запускаться было нельзя поэтому мы сделали следующее мы этот раздел реализовали выкатили внутри Яндекса компания у нас распределённая поэтому во всех городах люди этим пользовались попробовали и данные из клиентов обезличенные Разумеется прилетели в статистику и вот в этой статистике это семдесят пятый процентиль стало видно что больше 3 секунд занимает доставка порций картинок но там же и генерация и доставка 800 миллисекунд листинг и рендер какие-то 200 миллисекунд это тоже неприятно но по сравнению с вот предыдущими двумя можно на это внимание пока не обращать а"
}