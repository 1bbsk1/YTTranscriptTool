{
  "video_id": "BP2lgKrjuBw",
  "channel": "HighLoadChannel",
  "title": "BigMemory - работа с сотнями миллионов бизнес-объектов / Дмитрий Хмаладзе (Agnicore)",
  "views": 951,
  "duration": 2717,
  "published": "2018-01-16T13:38:01-08:00",
  "text": "я парень предлагает прикладных занимались разработкой приложений более 10 лет и учил графство там и прочие вещи потом со временем это все переросло в нативные языки когда появилась java когда появился dotnet и как-то так всегда получалось что у нас все наши клиенты все наши разработки тем или иным способом были связаны с high-low то есть с высока нагруженными приложениями я потом чуть-чуть об этом расскажу значит компания к декор как раз это то что мы сделали последние несколько лет стартап чтобы систематизировать весь наш ноу-хау виде готовых решений и так о чем сегодня пойдет речь значит в первую очередь это будет 64 бита management server platform и ну раз много памяти 64 бита теперь обработка данных памяти используя нативную модель то есть это миллионы десятки миллионов или даже сотни миллионов объектов хранящихся в процессе длительное время почему длительное время потому что вы многих бизнес приложениях надо например хранить кэш или надо хранить какие-то данные которые там могут храниться 2часа 3часа может быть даже днями или неделями мы будем говорить о мэнни что у дрон таймах то есть проблема используя большого количества памяти нас интересует именно для - языков таких как джавадов нет там и так далее где из гарбич коллектор у всех этих языков есть своя какая-то нативная модель например вдохните это вэлью типы это readonly поля это свойство томов джаве анонимные классы если мы используем нативный какой-то язык мы хотим использовать его нативную модель мы не хотим скакать там си плюс плюс и в другие какие-то вещи мы попытаемся остаться в рамках процесса без меж процессор на воссоединение без мест процесс родных соединений почему мы сейчас об этом поговорим значит наша методология мы опишем методологии of hip hop хип с точки зре а то есть это может быть меньше он хип но of hip с точки зрения гарбич коллектора чтоб гарбич коллекторы этого не видел просто этих данных и не встревал и результат применения этого подхода он на самом деле не не очень очевиден без проведения детальных всяких промеров замеров как это будет работать да и в принципе это все уже usa был система этим можно пользоваться и так первый вопрос который хочется значит озвучить это что такое стекло системы нам с утра до вечера вдалбливают что нам вдалбливают информацию что stateless все стекла с веб стоит лес все системы встретилась так ли это на самом деле но какой бывает во первых тип скейта в принципе подумал первую очередь о совершенстве совершенство и the user to the state да но дело все в том что state может быть не только you здоровый он может быть какой-то биржевой например синус бирже работает стоит какой-то комнаты социальной группы например это тоже социальная группа это какая-то кофейнике kiouni юрий одеваюсь какой-то стиль и так часто и так встреть меняется но может меняться очень часто там раз в секунду он может меняться раз десять минут он может меняться раз 15 минут и так далее то есть это данный вопрос где хранится где хранить этот стейк ну естественно стейк можно было долгосрочным каком-то хранилище таком как базы данных либо можно хранить в операционной памяти в оперативной памяти если стоит быстрый да то есть если он часто меняется и часто нам нужен а следующие где же мы собственно храним нас как данные которые нам нужны для того чтобы система работала все понимают что такое кэш ну кыш это обычно проектируют запрос в базу данных черепке опять-таки кэш может использоваться просто для хранения как интерфейс какой-то прокси перед какой-то антики например перед клитор системой или перед там какой-то социальной системы перед биржей например в котором меняются данные постоянные мы эти данные хотим значит знать что с ним происходит это конечно же обход графов собственно ваша задача откуда все у нас пошли эти разработки это социальные сети нам надо было много хранить долго хранить данные о социальной сети зачем чтобы узнать кто кому что сказал и установить цепочку прохождения так скажем сигнала до персонаж был twitter twitter шел какой-то хит и нам накапливалась много очень объектов и потом надо было отвечать на вопрос откуда эта информация пришла она пришла от такого-то человека и так далее и тому подобное то из построение связи travels прогрессирование данных поиск на графе и семантические сети семантические сети мы применяли например для медицинской системы что имеется ввиду видит то есть что такое семантическая сеть это сеть каких-то памяти и со связями диагнозы болезни и симптомы там и так далее и тому подобное вот для чего эта модель загружается в память и прямо в памяти она существует и отвечает на вопросы ну и по точная обработка по точная обработка применяется например в системах high-frequency трейдинга у вас идет большой объем данных этот объем данных надо как-то busy регировать для двух целей во первых показать это трейдеру трейдера много мониторов много экранов они хотят видеть вот эти вот все графики где эти данные братусь это как бостонской данные на ты не юзера сашин стоит это трейдинг сошел стоит плюс там идут еще сеть и раз уйти извиняюсь стратегией стратегии то что такое какая-то функция которая навешивается на какой-то торговый инструмент ей надо знать состояние то есть так как меняется баланс как меняется динамика каких-то рыночных данных она принимает какие-то решения в реальном времени то есть опять-таки где это хранить базе данных медленно мне офис базы данных что постоянно память что ли затягивать это же неправильно если у меня есть торговый сервер и там вот эта вся штука ранится это очень приемлемое решение использует память и так три основных из кейса это кеш это обход графов этапа точная обработка что объединять эти вещи нам нужно детерминированная пропуская способностью способность определенная пусть мы не получим например миллион репостов в секунду пусть у нас будет 100000 эрик ласка в секунду но они должны быть гарантированы они не должны скакать вниз вверх и сейчас мы это с вами увидим так два слова два слова насчет того что вообще есть на рынке чтобы не быть голословным значит мы во-первых видим что в основном эти решение они связаны с java хабблкаст игнайт дега space is big memory терракота sap hana и прочие вещи они в основном рассчитаны на для меня взяли но это системы в основном distributed in memory база данных то есть что это значит что в этих проектах можно даже сиквелы какие-то писать и они то есть это как бы замена вот такого такое бродить вы как раньше мы использовали там тяжелый oracle который на диске все хранит и пишется здесь мы можем все это использовать памяти и работать и тоцком с каким то таким распределенным как бы даже сиквелы либо дтп сервера мы же всего не будем концентрироваться на обработки данных памяти здесь еще учиться звонко биби и редис и они здесь внесены сюда для того чтобы мы могли значит отдых оценить то популярные проекты они используют нам иримед файлы у меня какие то по моему проблемы со связью слышно меня видно может отключить камеру будет лучше screen оставите камеру отключить олег пожалуйста прокомментирую но я продолжаю значит локальная память сегодня не используются в принципе и такое жесткое заявление давайте разберемся использовать использовать много использовать много памяти при в прикладных приложений сейчас не принято просто люди об этом даже как ты не задумываются но есть и меня там какой-то сервис есть там у меня какое-то решение а мы что кажется сразу на внешнее хранилище надо хорошо себя давать отчет что это cortex switching мэппинг моделей почему если вы пишете на джаве вы не можете вставить так давайте скажем что java допустим круглые объекты горох нативные вот живем да вы не можете вставить в треугольные ликов или квадратная какое-то как скажем отверстие которого нужно the sydney туда просто не хит вам надо для этого дела цивилизацию если вы храните вне процесса вам надо делать сериализация обычно для этого используют что используют и в сексуальные даже стерилизаторы такие как джейсон и не задумываются чем это чревато мы сейчас с вами увидим почему происходит так почему не используется парники не принято даже об этом как бы говорить из-за сборки мусора опять таки это не критика java или дать нетто или других информантов где есть коллекция мусора она просто так есть и этот доклад именно об этом это не то что мы критикуем кого то что они плохо сделали не сделаете номинальную работу и microsoft и разные живьем машины но проблема есть как столкнулся с проблемой сборки мусора не некоторые люди говорят а мы даже не знаем а что что она существует но сми столкнуться очень просто не нужны никакие специальные примочки просто берем дело ему плетей she например там и лакируем юзера какого-то и делаем список этих несколько миллионов получше десятков миллионов экземпляров этого лузера . делаем какой то там пару полей у вас может быть не очень большим по рублей достаточно можно в одном поток можно многопоточную сделать штуку и приложение начинает уже подтормаживать при любой последующий нагрузки то есть приложения что-то пытается сделать окей приложения что-то пытается сделать и и пока блокируются объекты даже для нормального использования вещей которые длина для нормальной работы приложения приложение начинает тормозить просто потому что там лежат десятки миллионов объектов ok следующий слайд 14 сейчас на экране видно не видно менеджмента им збигнев то есть проблемы с большим использованием памяти в мене штерн таймах несколько миллионов объектов приводит к подтормаживание у процесса чем больше физической памяти тем ситуация хуже сейчас мы это с вами разберем решение оптимизации решения оптимизации гарбич коллектора всевозможные которые применяются в последней там так скажем несколько лет не является панацеей это именно какие типы оптимизации гарбич кофактора ты там например отложенная параллельная конкурентная оптимизация то есть маркин sleep в одном сайте происходит маркони я потом с выполнен в другом среди комп компакта еще в другом потоке и так далее и так же есть такой подход это обработка обработка событий звонки мусора то есть гарви чкалов первом предоставляет уведомление о том что щас начнется сборка мусора и вы можете это уведомление каким образом схватить и на балансировщик свой сказать так я сейчас буду под нагрузкой я щас буду недоступен переключились трафик на другой узел вопрос это раз ты хорошо это же нехорошо мне тогда на другой узел надо держать копию всего вот этого ну большого количества память мне тут обычно задают вопрос а разве тебе не надо держать копию этого всего потому что твой ноут может отказать на котором твой узел на котором ты находишься может отказать да действительно может отказать в давайте не будем забывать что в 99 процентах случаев все таки серверами отказывают они работают и пока они работают конечно же 2 0 должен иметь возможность обработать толстую для первого то есть для первого узла предоставлялась но все равно лучше иметь такое понятие как началась его в жертву и то есть локальность доступа и и никто не отменял понимаете поэтому лучше эту память не перегружайте раз мы ему заз памятью работаем иметь эту информацию в том месте где она нам нужна итак сейчас 15 слайд не знаю олег пишет что немножко с видео какие-то проблемы значит 15-тый слайд на заметку несколько несколько квалификаций гарбич коллектора до сути не квалификация его свойств задержки пропорциональны количеству объектов в первую очередь с чем больше объектов они могут быть даже маленькими чем их больше тем медленнее все дефрагментация первых памяти она вы знаете похоже как-то если вы из пирамиды хеопса будете удалять из первого там какого-то ранга маленький какой-то кирпичик вы уделили вся пирамида должна перри создастся то есть дефрагментация дырок память это реальный убийца если вы хотите объект поменять его адрес существующей в памяти в другое место его вставить она этот объект смотрела допустим десять тысяч ссылок вам 10 тысячах местах в памяти причем абсолютно скатывать то есть разбросанное такое запись вам надо записать новый указатель это очень медленно чем больше физической памяти тем реже задействуется гарбич коллектор до современный гарбич коллектора сборщиков мусора применяется этом эвристические всякие алгоритмы которые пытаются оценить всегда ему надо включаться все равно сожалению этого не достаточно чем больше памяти он оттягивает оттягивает комп комп акцию вот этого generation tool то есть последнего динарий шимада и а именно там у нас хранится если у нас долго храниться оно все уходит старое поколение и наступает полный конец вашему процессу и чем меньше объекты тем большее количество памяти смог смотрим пункт номер один так двигаемся дальше фарма памяти формат памяти надо понимать что в марийский язык с 16 байт есть всегда хедер и массив из тысячи строк это 20 4 килобайта даже пустых производит джек джастин тайм компилятор прорыва их выравнивание полей и увеличения скорости доступа это чисто как работает там motherboard процессор и так далее так это происходит это зависит этот конкретный джек машины и конкретной операционной системы но не будьте удивлены если объект состоящий из нескольких строк и чисел 1 и занимает 100 байт памяти почему ну потому что так устроена память сейчас видим слайд с желтыми фейдерами виден двигаемся дальше или передается борьба с джесси борьба ждите борьба с гарбич полотером немногие придумали это очень известная тема особенно с кругах высотных торговцев на high frequency трейдинг на они там совал старики нью-йорке им надо обрабатывать много данных и они не могут терпеть вот этих вот задержек и пойму в основном там все вписаться на си плюс плюс и и так далее но визуализирует часто на сишарпе и на джори и вот возникает вот эти вот проблемы встроенный механизм поколений гарбич кого сторон не эффективен как я уже сказал потому что объекты могут долго жить pulling ноги используют pulling предала церу it какие-то полу и перес пользуют объекты мне подходит не подходит для решения бизнес задач почему вы не можете работать с этим подходом просто для решения каких-то прикладных задач где объектов может быть очень много person надо как-то память много смысле типов равна вам надо как-то память к ней подходить тогда с с каким-то аккуратным подход специализированный иметь то же самое если мы выйдем где управляемый код на си плюс плюс и что равно 100 выходу в открытый космос без скафандра почему потому что на си плюс плюс и опять-таки представьте себе business applications котором много домен объектов босс приходит и говорит а я сейчас хочу вот смоделировать такую то и ю а там допустим вот в медицинской программе там какой то и так далее очень много надо всяких вот этих вот entity там моделей создавать ручно распределение памяти то же самое то есть все эти подходы они их можно конечно сделать самый простой способ самый перформанс способ это писать какой-то специализированный solution для очень конкретной дачи но есть таких задач становится очень много то вы захлебнетесь просто rating ну и как я уже говорил переключение трафика между узлами по уведомлению о приближающемся гарбич коллекторе это тоже костыли это не от хорошей жизни только разные режимы карточка виктор не универсальный давайте посмотрим на реальных бизнес-объекта сейчас вот слайд неким таким юзерам можно здесь не вчитываться тут просто несколько там 15 лет 112 полей одно из них только сложная string б все остальные поля это пустые the flight объект такой флаг то есть плоский да давайте потестируем его на моей машине вот на которой я сейчас нахожусь это 12 среда в 10 2 6 физических ядер 12 рядов 10 потоков дают стабильно стопроцентной сепию все что мы делаем мы просто блокируем объект блокируемых записываем какой-то список никакой магии вот здесь пожалуйста есть source code в верхней части link можно пойти посмотреть на чит пробовали бэкграунд сервер пробовали состоянии квинси мол все что можно пробовали ничего не помогает что-то работает хуже что-то лучше 6 потоков все равно в пиках достигает 90 почти до 100 процентов выбивает и джиттер что такое джиттер но это изменить паркинга пришло то есть джиттер это притормаживание то есть это не неоднородности солей то есть допустим с какой скоростью вам отвечает ваш процесс до на 10 миллионах объектов 700 милисекунд милисекунд замерзания начинается раз в секунду на 60 миллионов объектов вообще невозможно измерить это потому что процесс начинает просто виснуть там на 20 секунд на 15 секунд это проверить это надо на несколько суток процесс оставляет на сорока миллионах объектах где-то две секунды торможения то есть зависания всего раз в полсекунды то есть представьте себе в полсекунды полсекунды процесс работает потом рад раз и завис на две секунды потом опять его отпустила на полсекунды ра рас и завис то есть пользоваться этим невозможно вот собственно таблицы сейчас на экране таблица детальных промеров то есть тут много информации это для того чтобы вы посмотрели детально это все в оффлайн я только скажу что опять-таки мы разделили это тест на два типа подтипа 10 рядов из 6 рядов 10 потоков и 6 потоков и что самое страшное мы видим что мы видим при использовании обычного команда че runtime то есть обычных объектов на этой машине мы видим стопроцентной сепию на 10 потоках и 90 процентов сепию на 6 потоках мы видим потрясающие потребление памяти и мы видим то что количество записей в секунду очень сильно деградирую 10 миллионов четыре с половиной миллиона записей 20 миллионов объектов 3 240 миллионов 1 и 5 а потом уже имели не пришлось то же самое на 6 средах но что самое страшное что вот этот джипер вот этот игрек джиттер 2 и 4 секунды то есть две целых четыре десятых секунды доходит периодически до 48 секунды процесс просто виснет на 48 секунд полностью опять-таки это серверный режим 64 гигабайта машина 6 ядер 32 кгц это не не не плохая машина не самая лучшая но не самая плохая вот и мы видим что система становится просто невозможны до 60 миллионов объектов даже нечего пытаться и тестировать это все что же нам с этим всем всем делать мусор он есть это продукты так сказать жизнедеятельности процесса и что делать с ним то есть неужели нельзя в процессе в - к его все время надо перезапускать рвать его выносить из него куда-то во внешнюю среду вот выносим внешнюю среду то что мы уже говорили собственно то что какие-то решения делают вот эти все ребята там memcache как там играют и так далее опять таки это сетевой трафик и так он так switching и это сериализация как вы можете перенести объекты реальный куда-то и вам надо его си релизе ровать чему-то об этом забывают думаю что она я буду в памяти хранить это нет вы будете это хранить в памяти но не в своем процессе тогда будет вот этот контекст свечин передача панику и так далее то есть это за это все надо платить платите временем у сложностью и даже финансово платить потому что лишние вещи давайте подумаем как можно хранить данные прямо в процессе в неуправляемому ферри этого нам нужен марш аленькай для этого надо все усложнить во много раз почему потому что это все трудно портировать невозможно поддерживать вам нужны специальные модели данных вы не можете писать объект просто так вон сейф в анса их буфер сейф объекты ты сменишь объекты не пишутся в анси буфер просто так ну первый вопрос что делать с полиморфизмом что делать с ссылками на другие объекты не понятно что с ними делать в анси буфер on self defense они не сочетаются можно придумать какие-то ограничения типов то есть например использовать вэлью типы которые есть дохните но опять таки это все к сожалению не от хорошей жизни и так что мы делаем мы идём либо в неуправляемый буфер либо ограничиваем типы тогда бы не можем собственно пользоваться этим для написания бизнес приложений легко нам надо какие-то типы платить ведь отрез объекты и так далее либо используемся реализацию прошу заметить что аута процесс решения это все равно всегда сериализация и будет ли решение основанная на сериализации внутренней работать приемлемо быстро помните вначале говорил не напишешь это все не проверишь не узнаешь никто тебе не скажет будет ли это основано на стерилизация работать быстро несколько слов о сериализации но все понимают что силе зация двух типов бывает бинарное и текстуально текстуально и ямал там джейсон xml сейчас я джейсон пишут конечно большинство людей кто-то пишет в этом л как у кого-то есть существующий код который пишет в xml это все текстуальный форма бинарная сериализация в первую очередь думу того про про the buff там элизе рукописи реал азиз 1 про табов это не есть формат для например циклических графов и полиморфизма несмотря на то что господин морк grivel сделал потрясающую имплементацию и вставил туда специальный значит как сказать режимы до которые могут что-то эмулировать вы на выходе просто буфа не получаете то что вы падали ему на вход поэтому protocol buffers это не есть a sailor стерилизатор но опять-таки его можно использовать но опять через костыли то есть надо подготавливать модели вы не можете взять просто дохнет класс какой-то в котором есть просто домен объекту чистый домен объектом может методы какие-то даже есть нам просто поля и использовать его теперь пару слов насчет xii рукописи реализаторов xii рукописи реализаторы это на самом деле обманка это вообще неси реализатор это формат памяти который хранит данные уже в специальном каком-то привет установленном виде и вы амортизируйте время сериализации переносите во время доступа к этим полям просто то есть опять-таки шила меняем на мыло в рукописи реализатор они великолепно применимый для специализированных задач когда вам не надо много логики писать бизнес и вам надо в основном информацию хранить и relay делать ее как это передавать эту информацию куда-то в другой процесс но не надо забывать что это не наша задача наша задача получить transparent ну тыж прозрачную си реализацию для того чтобы разобраться сериализации мы написали такой tool сербенчук вот пожалуйста опять таки backup ссылка здесь вот есть типичный такой человек опять таки не надо вчитываться в этот ход тут 6 полей булевые шесть шесть строк 24 поля всего шесть строк daytime там интеджер и так далее си релизеру им на одном потоке и что мы видим на этом графике чем ниже и чем краснее тем медленнее тем больше больше плохом смысле то есть больше поил out а чем выше и так сказать фиолетовый более голубой цвет то быстрее что мы видим верхнем графике мы видим здесь бинарные си реализаторы внизу скопили всех текстуальный си реализаторы мы специально протестировали большое количество серии se реализаторов которые есть на рынке от разных фирм производителей да что мы видим что даже такой супер крутой си реализатор как джилл автор кевин манро us рекомендую посмотреть на него это парень из тахографа очень классный стерилизатор самый вообще быстрый для джейсона вский си реализатор он дает 368 килобайта наш стерилизатор как который мы сейчас расскажем который мы используем для бега мире дает 114 килобайт тот же самый пылу что запылал типичный вот этот typical person вот этот персону которого 24 филда создаем список из 500 таких людей и кидаем его туда ну на первом месте по скорости про табу про the buff для этого великолепно подходит это flat структура 888 транзакций в секунду вот таких вот это на одном потоке наш стерилизатор держит 882 вот давайте посмотрим что начнется с запутанным графом объектов мы берем делаем 16 конференций 16 участников и 5 ивентов и как ты их всех извращенным способом перекручиваем друг между другом то есть что в они там ходили в разные конференции так далее сложный grub мы видим наш реализатор и про табу в 102 105 дают килобайт а java скрипте реализаторы все то есть в смысле джейсон овский дает около мегабайта в 10 раз больше почти понимаете ну куда это годится то есть когда вы сели лидируете в свой внешний данные хранить его внешней там редиски какой-нибудь или memcache не забывайте что если вы используете джейсон вот вы смотрите что вы получаете это наглядный пример плюс на самом деле здесь сравнение тоже такой то есть мы все сели за тары сравнили на самом деле вот среди дак натовских стерилизаторов только microsoft баян реформатор и наш стерилизатор slim это полный си реализатор который поддерживает все примочки такие как сериал ой забыл до сериала есть детализация callback и так далее и тому подобное про табов на выходе даёт так мягко выражаясь немножко не то что вы послали к нему на вход и также си реализаторы обычно не поддерживают режим пакетный режим пакетного использования которые поддерживают на все реализатор про табу и войны реформатор ну вот вы видите здесь и результат это пакеты по 1000 человек тех же человек который мы смотрели 158 наш про табу в 97 но с большим очень вариацией он очень как-то не стабильна на этом пологи работает даже когда много раз его прогоняешь непонятно почему вами реформатор 17 этаж в секунду операций в секунду да и пайлот вы видите какой итак наш стерилизатор сделан как он использует динамическую компиляцию экспресс-энтри то есть он для каждого типа кэширует пишет код и джипер потом это переводит все в машинный код значит он в 5 10 раз быстрее чем войны реформатор microsoft of 10 на 10 50 процентов плотнее упаковки данные чем нативные объекты прямо в памяти когда охраняться поддерживает полный полиморфизм readonly поля вэлью типы ой серия elite был пусть полностью transparent ный прозрачный си реализатор и нам не нужны никакие мета атрибуты которые нужны в случае просто пуха и прочих стерилизаторов или специализированные схемы это очень важно вы создали 25 типов новых вашем приложении они автоматически а все будут работать связано это с тем что мы не поддерживаем version ность в этом сериале затари мы не поддерживаем делегат они нам были не нужны просто version ность она не нужно потому что вы храните этот объект прямо в памяти то есть какая-то version ность одно и то же приложение работает с теми же данными и это мы называем телепортации объектов тоже что такое телепортация это просто вот этот вот прозрачный перенос объектов вот этот код взят из одного приложения которое оценивает можно ли там страховать определенных докторов учитывая там их историю кто их судил за нарушение сервиса с пациентами и так далее то есть dictionary of payment of полосе medical что надо сказать представьте себе что у вас есть 20 типов всего-то навсего но теперь представьте себе что эти типы они обобщенные дженерик type-s да и теперь эти 20 типов можно очень легко превратить в 200 просто комбинаторикой по бизнесу то есть вот листов полосе вам playman то есть вы все представляете чтобы было бы если бы эти все типы каким-то образом писали с помощью septas plaza руками и листов с помощью того же дать нетто или джавы это можно просто сойти с ума это все поддерживать поэтому нам нужен прозрачный sirel yzer итак для работы с большим количеством памяти мы поняли что нужен стерилизатор мы его сделали теперь надо собственно начать managed как-то память для этого нам нужен диспетчер памяти мы сказали что мы хотим быть в менеджере давайте попробуем реализовать диспетчер памяти без си плюс плюс а в управляемом коде хранить все сегментами просто байт реями то есть что такое батарей это просто большой и рейгар бич коллектор для него он видит его как один большой айсберг такой да он не видит что внутри этого айсберга какие маленькие кусочки хранятся и опционально зеркалирование то можно в memory мэрт файл кстати говоря на диск чтобы это не терялась что мы храним мы храним строки байтерек и объекты мы храним с помощью вот этого си реализатора slim строки байкеры можно неси реализовать описать directly в буфер всевозможными там значит копиями да так и что мы получаем мы получаем диспетчер памяти опять таки тут не совсем хорошо видно много кода что здесь хотелось значит подчеркнуть на этом слайде что для работы с памятью вам нужен put вам нужен get когда вы делаете put объекта вы получаете некий pointer pointer эта структура сейчас мы ее по смотрим что это такое get вы берете pointer получаете объект назад вы можете делить по по интеру объект который там есть получить says того что там есть по контуру и так далее с полной статистикой сколько объектов хранится сколько памяти и лакированных сколько памяти утилизировано какой о warheads какое количество сегментов и так далее и тому подобное вот можете в офлайн посмотреть все эти детали значит и так как мы используем павел мы берем человека то есть объект предметной области присваиваем его свойства прямо вот здесь вот и мы теперь берем и в этот файл записываем данные и получаем некий поинты этот пойнтер этот океан это не объект это такой маленький таким по которому мы можем этот объект потом назад восстановить а теперь мы можем с этим объектом работать через свойства last name речь и так далее и тому подобное и можем этот объект потом удалить у этому же пункту что такое pointer в джаве нам давно уже обещает вылью типы когда у нас появится наконец-то но пока их нет в джаве можно хранить вот два этих интерьера коллапсировать в один long просто да значит это интеджер это айди сегмента и интеджер адрес это а все три этого сегмента вот этот параметр мы сегодня рассматривать не будем это один тифе катар ноутов в распределенной кучей такой как делает хейзел каст и прочие у нас это все тоже есть но мы сегодня об этом не говорим мы говорим о памяти внутри процесса только и так вдохните есть такое понятие как в youtube то есть они хранятся на стыке а значит что рей павел пойнтеров из десяти тысяч pointer of это один фрс для гарбич коллектора они 10000 это всего лишь один reference сбили тип кормить коллектор его не видит прекрасно это то что нам надо то есть мы опять таки объект предметной области превращаем в такой-то какой-то таким на который гарбич коллектор он для него прозрачный так очень важная фишка здесь в том чтобы мы могли по существующему по интеру менять пейлоуд который там хранится каким образом мы это делаем мы имеем один из о world of на путь где мы он существующей pointer и пишем туда объект он пишет его поверх того объекта который там есть если новый объект умещается в то в том диапазон в том куски памяти который уже выделен он там умещается если нет создается внутренней алиас это знаете на что похожа на сем более клинг в этом самом в unix и например да на новый блок если вы удаляете то есть это вот этот вот разрешение вот этого символического линков ноту смысле внутреннего алиса она автоматически делает с этими мари менеджером вы как программиста в этом не паритесь делить делаем p1 вот этот вот для нас только ппп один здесь есть все pointer и если поднимись алиас тоже удаляется вся память высвобождается то есть что мы этим всем достигли мы достигли такой несколько призвук on men edt памяти flywire такой то есть как бы вкус до отменишь памяти внутри менеджер процесса зачем это все нужно костыли какие то сейчас посмотрим это очень нужный очень работает классно на самом деле а как устроен павел внутри значит он состоит из сегментов вот эти сегменты вот эти которые вот идут поперек экрана это просто байкеры это массивы байт у каждого сегмента это просто сами сами сегменты это массив каждого сегмента есть яндекс и потом адрес адрес это просто смещение вот этого кирпичика внутри этого сегмента также у каждого сегмента есть таблица дескриптор сегмента таблице аллокации который говорит о том какие отверстия какие дырки здесь есть у нас когда мы будем пытаться сюда что-то записать плюс это все опционально зеркале руется в маринад файл на диск для хранения и так здесь в принципе все ясно как устроен диспетчер памяти теперь с точки зрения вот слышали наверно боди и лакей то что такое body allocate а вы берете кусок памяти режете его но это не совсем болела хейтер алгоритмы использую мы используем больше как малак это делает то есть все куски сегмента размечены его можно проползти то есть пройти по метаданным в каждым из этом из этих кусочков при этом у нас в отличие от этого не 16 байт восемь байт и данные очень классно пакуются и так как работает павел мы берем объект все какой-то канала и much runtime и записываем его в массив байт реализатор динамически наш там адаптируются к ширу и тому то что он откомпилировать что быстро работать и так далее и тому подобное дальше мы ищем свободную область нужного размера значит при этом особое внимание было уделено потоковой безопасности потоковой безопасности если мы находим место записываем согласна-согласна дескриптор у пустых мест обновляем этот дескриптор иначе выделяем новый сегмент обеспечивается потоковая безопасность как я уже сказал с помощью легковесных спин log off то есть что такое spylog вместо того чтобы делать лоб делать contex вич мы делаем спин loctite крутится потому что поскольку операции вот эти копирования они сегмент локу только в момент когда в него происходит запись вот и мы еще разными потоками перебираем сегменты существующей попытаемся чтобы они не пересекались такие окна как бак который не пересекается с целью предотвращения лог контент шина чтоб не было никаких слишком сильных локов в системе и система обеспечивала с рецепте вопрос фрагментации фрагментации мучает всех фрагментация проявляется при удаление объектов фрагментация появляется при вставлении объектов я например не могу взять лоб на этот сегмент там есть отверстия но я в него не могу записать информацию я пишу в другой сегмент фрагментация накапливается павел не двигает задействованы и блоке мы не делаем комп action поэтому она работает быстро комп action это основная причина остановки гарбич коллектора торможение гарбич коллектора так ok периодически в зависимости от статистики мы делаем значит крол плюс пропал за им это и фрагментация незначительно влияет фрагментация незначительно влияет на общую производительность поскольку решение более высокого уровня локальность доступа важно в момент материализации вот этих вот байтерек sailor объект опал обычно используется в любом случае брендом xs режиме тестируем на реальных бизнес объектах берем бизнес какой-то объект значит и мы получаем наш значит у нас получаются цифры с файлом опять таки на это все есть линк вы можете посмотреть 103 миллиона объектов значит 10 гигабайт блокируется при этом вот здесь вот график внизу идет джиттера график джиттера очень медленный потому что в смысле немедленная джиттер маленький 43 миллисекунды дальше и лакируем память память идет очень спокойно вверх 212 миллионов объектов 21 гигабайта блокирован пропал за им память память как была пустой так и осталась в смысле очень быстро за одну одну секунду все это просматривается теперь времени уже не остается вот ли олег не пишет значит здесь мы видим скорость работы по ул она такова что мы луки равале 300 миллионов объектов у нас как была скорость ставления 1 и 4 миллионов смысле one point однако четыре десятых миллиона так и остается больше миллиона даже когда 300 миллионов объектов и джиттера никакого нет напоминаю что у нас было в бюджете какие у нас были торможению то же самое пытаемся сделать вдохните и видим вот такой вот график и не знаю насколько это видно на слайдах потом в офлайн можно посмотреть колеблется сруб у that 160 тысяч в секунду до 4 миллионов очень всё медленно и невозможно вообще и лакировать больше 40 миллионов в принципе система просто не отвечает и так в итоге по позволяет хранить больше объекта в том же объеме памяти за счет компрессии значит обеспечивает детерминированную пропускную способность процесса после той силе зации вы получаете копию объекта что удобно а мальте среды программирования плюс что еще получается что на основе пола реализуется более высокоуровневые структуры такие как хаш деревья и так далее зачем нужен кэш чтобы вы не работали с павел пантерами вы можете работать с объектами предметной области эти объекты предметной области такие например как и айди там какой-то там твита или чего-то и работать с ними на следующем слайде мы как раз видим это социальный пользователь создаем таблицу какую-то путаем в кэш берем из кэша удаляем из кеша здесь нет ни одной строчки кода низкоуровневый только предметная область то есть все делается очень быстро и я них меня не интересует из чего эти объекты собственно делаются то есть я могу сюда добавлять какие-то поля и так далее и система автоматически все это transparent на это сделает значит заключение заключение за чьи что надо сказать что мы использовали исследовали подход к ранению большого количества объектов предметной области in process путем стерилизации не задействуя си плюс плюс и прочие вещи значит ценность этого решения что вам можно использовать бизнес модели данных которые у вас уже есть и решение вот такого меньше менеджера позволяет сжать менеджер print хранить миллиарды объектов в процессе хранить их долго в течение часов дней недели там и так далее и проектировать высокоуровневые структуры данных для решения специализированных задач в итоге вы можете написать зачем это заключение зачем это все нужно ваш там веб и пьян или прочие какие-то вещи может легко обслуживать 100000 бизнес подчеркиваю запросов со сложными join me look up a mi и так далее прямо из памяти 100 тысяч запросов в секунду при этом процессор на я нагрузка у вас будет там 40 50 60 процентов но не сто процентов вот и вы полностью разгружаете и базу и другие источники спасибо за внимание здесь приводится линки на последнем слайде тоже дополнительные есть линьки на обзорные статьи и на наш документ документ ориена и нафиг slip dot com все всем спасибо тогда вопросы к олегу"
}