{
  "video_id": "7ShA_LQ4XRw",
  "channel": "HighLoadChannel",
  "title": "Как автоматизировать разбор проблем в дебаггере / Сергей Козлов (Лаборатория Касперского)",
  "views": 309,
  "duration": 1437,
  "published": "2023-01-19T07:01:38-08:00",
  "text": "добрый день меня зовут сергей козлов я уже представлял лаборатории касперского сегодня я хотел бы поговорить с вами об ошибках о том как их автоматизировать хотя бы часть каких-то вариантов значит начнем пожалуй ошибки и проблемные ситуации которые возникают при работе высоконагруженных системах они имеют свои особенности свою специфику и в процессе работы у нас накопился уже целый ряд приемов по анализу таких проблем часть из них мы недавно выложили в open source видео течки скриптов для орла чиков она расположена вот здесь там есть скрипты для винды bgn и для gdb немножечко я хочу показать сегодня работу нескольких скриптов на живых примерах начнём с простенького тест убит на из 3 предположим у нас если любит на приложение запущено носите что убитый венгер там сто пятьсот потоков работает и тут внезапно мы палимся всей q&a естественно дальше мы хотим посмотреть что же наше приложение в это время делал но поскольку она работает в основном видео моде after на в моде мы видим списком именно и аналоговые стики вот в таком вот виде исключить каждый конкретный поток битный режим не сложно но у нас их очень много и собственно любой кто с этим сталкивался занимался с тем что писал свой скрипт для того чтобы пробежаться по всем потоком ну вот собственно у нас тоже такой скриптик но только на дискете вот вот собственно что хочется видеть вот давайте посмотрим здесь у меня простенький сэмпл чисто для демонстрации он запускает сотня потоков рандомна сырными задержками и вот как это выглядит в дампе значит сейчас найдем нужный нам процесс вот он и вот как в нем нам показывают striking собственно что я говорил здесь или этот опыт fir 0 часть и ничего особо интересного не видно ok запустим тогда скриптик который нам покажет что же у нас на самом деле в этих потоках находилась и что там работала ну собственно вот он всю эту сотню потоков нам и демонстрирует дальше следующий момент поиск исключений а иногда и разборе проблемы возникает подозрение что что-то у нас было до этого что-то произошло такое что собственно и привело нас в той ситуации которую мы видим как это ошибка какой-то исключения которое видим то ли было обработано ранее и нам не попалась то ли она была вообще подавлено но очень любопытно бывать заглянуть вообще попытаться пока не имеет заглянуть в в то что было до этого не всегда но в ряде случаев можно попытаться действительно это сделать можно пытаться найти запчасти структуры описывающие исключение при его обработке на стыке обычно при этом ищут структуру контекст она содержит состоянии процессора на момент исключения в том числе все регистры практически чаще всего искать ее берутся либо по флагам либо по сегментам регистром в частности ищем сегментный регистр если мы что-то нашли то выше по стыку пытаемся найти структуру exception плинтус она у нас содержит всего два указателя как раз на контекст и на структуру xhd код это структуру уже содержит саму информацию об исключении код исключения адрес параметр который там были и все остальное поэтому попробуем посмотрим как это работает живую вот у меня тоже простенькая программка здесь она вот как видите в конструкторе здесь бросается просто исключением затем мы его вот тут ловим и просто выдаем ошибку а при обработке то ошибки но уже свалимся окончательно и как это выглядит в отладчике потом это не то вот это нам нужно значит вот здесь мы свалились свалились это уже вот вот собственно где мы непосредственно упали мы упали потому что вызывали здесь по левому адресу некий метод ok но хочется узнать к чему что нам у нас вообще вызвало это эту ситуацию поэтому будем из искать исключение на стыке скриптик по умолчанию ищет в текущем потоки вот как раз он как раз он на мой вы нашел исключение c и мы можем посмотреть что там реально произошло собственно это мы кидали его мы знаем что это был + ova исключение и можем подключить своего стык и увидеть где его собственно кинули посмотреть что к этому привело до этих структур сохранять у нас такие естественные всегда и иногда не перетираются в процессе работы и мы их не можем найти но в значительном проценте случаев это действительно может помочь найти что-то интересное так следующий момент очень актуальны и всегда это ситуация с пожиранием памяти я не говорю сейчас об утечках это не утечки это просто ситуация когда какие-то компоненты какие-то части программы начинают позволяет себе несколько больше чем рассчитывалось в смысле потребления памяти и когда затем мы падаем очень интересно всегда узнать кого за это поблагодарить значит начнем с простого опять же значит на windows у нас есть терпелив и которая нам может очень сильно помочь ударом смысле он много вещей но помимо прочего при при отладке hippo он в том числе добавляет в каждый блок свою собственную запись с информацией в который помимо прочего содержится стык выделения данного блока задач просто возьмем и учителем все блоки посчитаем кто с каким стеком был выделен или увидим кто у нас больше всего по выделял вот у нас для этой ситуации вот вот этот примерчик значит здесь простенькая программка 3 методы в каждом из которых мы выделяем один блок одного и того же размера ну с разным содержимым us . записываем блоки такие большие кучи исключительно демонстрации что вы этого василий работала выделяем рандомна заполняем раз давно поэтому я в общем сам не знаю обычно что именно будет в итоге с кто кто больше всего съел значит найдем 100 начнем с того что найдем вообще стык который нас интересует которого самый большой ну вот он посмотрим ну est вас понятно здесь мы выделяли блоки одного размера ну собственно не все одного размера и есть и теперь поищем в этом в этом happy блоки вот этого размера и статистику по ним вот собственно этот скриптик нам чего вы даете он отсортировывают найдены и блоки по точнее с найденной стеки по количеству выделены блоков странным стойкам соответственно вот здесь мы видим что больше всего у нас за время работы на выделялась структур и вот этой цену поменьше бы и меньше всего структурка а вот так но понятное дело что со стеками это читерство и это деле может сделать любой что делать из вас нет very fair если мы работаем либо без него либо мы вообще например на линуксе находимся и как нам искать кто же у нас скушал лишнего а здесь гарантированных способов уже естественно нету но можно попробовать прикинуть о данном которые мы собственно сохраним памяти что останусь лежать там может лежать но гразно интересного там ты иди всякие путь и строчки повторяющиеся в его вообще супер вещь то есть на самом деле вещи по которым мы можем эти блоки как-то совместить достаточно много и не всегда действительно не всегда но зачастую удается найти тех товарищей которые несколько больше себе позволяют вот для примера у меня здесь тоже покажу часа лиц рогатка программка собственно идентична предыдущей те же самое вот у нас три структур ки одного размера с разным содержанием точно также удобно одно отличие для того чтобы наши что битным linux нам не ждать слишком долго пока это все будет анализироваться я поставил ну вот мы ее сейчас посмотрим за так запускаем запускаем новую собственность работу на что и поищем теперь загрузил естественно скриптик промахнулся загрузим скриптик и посмотрим что у нас найдет значит кантик он сделает собирать статистику сразу по нескольким вариантам потому что по разному бывает данные расположены то есть он бьет по по одному указателю статистику собирает по первым четырем точнее под потом блоками по 2 и целиком по 4 в 1 здесь здесь у нас была очень простая ситуация и собственно мы сразу видим что у нас тут штукатурку а мы на уделяли больше всего больше чем две остальные вместе взятые честно скажу это действительно не всегда срабатывает но несколько раз там удавалось вроде найти товарищей которые решили похоронить чего-то лишнего так и еще один момент картинки на прошлом колоде я показывал картинки под windows но поскольку были вопросы про linux сейчас мы сделаем это на линуксе значит опять же хочу отметить мы говорим про пустого и картинки первой версии их там 2 но интересно именно первую стандарт пошли вообще третье но самое интересное не 1 густого и картинки потому что низ тыкву это значит что когда мы выполняем картинку мы уходим в ее собственный стык и потока настолько потоком и под не видим вообще значит как нам из этой ситуации выкручиваться так вот у меня опять же ну программка получается тут несколько такая более массивная вднх сервер на густо осел я сейчас немножко просто поясню значит здесь начинает но вот собственно классы сия это по сути просто подключенный socket на котором висят две картинки вот эта вот картинка у нас просто читает то что пришло и зеркалит это обратно в соке у простых и сервер и вторая картинка она таймаут на отключение держит дальше все запускаю серые пост слушающий соки и мы все что с него приходит все что нему подключается мы создаем видел этой сессии и также простенький клиентский запрос точно подключаемся к серверу дальше пещер . читаем оттуда строчку и сравним что достиг вот единственное что для того чтобы сымитировать какую-то проблему в самой картинки ездить опять штаб поставил так запустим теперь все это дело так промахнулся так значит запустили вот он наш трюк сработал и смотрим что у нас встретил что у нас 10-ки ну естественно увидим только степ картинки надо было ожидаемо вот у нас здесь работает или и на этом все как нам вернуться в исходный поток посмотрите что же там там то происходило но в этом нам поможет контекст который крутинка само собой тащит в данном случае он у нас находится вьют вот мы сейчас на нем и посмотрим переключимся туда и посмотрим что у нас там лежит вот здесь у нас лежит 2 пойнта водку а вот он дальше если посмотреть сердцах это делать уже не буду просто поверьте если посмотреть сердцах можно посмотреть в каком именно поле там лежит pointer вот он лежит на самом деле так и вот вот там как раз лежит контекст который нас интересует если у нас поля кулер и колей коли это собственно сама крутинка мы там находимся а вот поле нас очень даже интересует то что там должен быть контекст переключение в него вот он этот контекст вот мы его нашли значит посмотрим что у нас собственно там находится что то что то там находится что с этим делать ну но это немножко подглядеть а как собственно boost делает сама переключение у них в саках очень подробно расписано что же там они делают и вот собственно вот это вот табличка она по идее описывает у нас вот то что мы видим здесь скачать сохраненных регистров и приключений здесь есть ip vpn уже хорошо но нет стыка нет текущего указателя опять же откуда его взять ну посмотреть немножко вот тут вот идет процесс загрузки перри переключение и вот как мы видим распилу загружает у нас адресом который идет прямо за этим блоком то есть вот этим собственно можно попробовать ставили ты что то что мы нашли это действительно она вот это должно это должен быть у нас риф смотрим но похожа на the jump он именно переключает крути мир картинки между собой поэтому это похоже 10 нам поэтому попробую и включиться в то что мы нашли так выстрел сначала вот он дальше дальше у нас идет вот он и выстрел текущей стык он у нас за это структурой вот он смотрим получилось или нет получилось получилось вот видно как раз запущенная наши программка вот он то вот это сию и вот тут у нас а вы их умы jump брались в эту самую картинку то есть можно дальше покопаться уже тут посмотреть что происходило в других частях программная на этом у меня сегодня все надеюсь это вам пригодится при анализе проблем если кого заинтересовало милости просим к нам ссылочка здесь в ходе у меня нескромный вопрос спасибо за внимание не убегай мне есть парочка вопросов и вот там я же правильно понимаю что contribution & drop принимаются до хорошо 2 а ты там аккуратно так говорил про крутилки которые пошли стандарты те которые ты показывал они тебя тоже также нравится как мне в свежем стандарт ну как сказать наравится они не были скучные а почему они более скучного но здесь видишь как здесь так еще переключать приходится они просто так не разберешься что происходит на там все так просто хочешь сказать ну там несколько попроще а мозг ресниц поскольку там ты работаешь что он же стыке ты пока не имели можешь видеть ситуацию несколько дальше чем в этой ситуации и плюс нету вот этих вот хакерских приключений между контекстами расскажу страшная тайна а почему именно первые крутин они вторые ведь они вроде за deeply kitchen и 1 хотя могу вот как раз потому что они степу мне и мне нужно было именно а там вот именно там то есть по идее в принципе используя вторые первые крутин и аналогично f контекст и и юрьев контексту которые позволяют тоже был такие же крути ну окей и попробуем у меня лично мои вопросы закончились но вот не знаешь это некоторая магия когда в какой-то момент тебе узнают что ты ведешь начинает вопрос создавать короче в личку они они в каналы я говорю очень интересная ситуация вот интересуются а вы принимаете ли вы к другу шины для конкретные библия но для конкретных для тех принимаете или нет ну то есть что то очень точечно то есть тогда мы на самом деле там зависит от библиотек потому что там на самом деле выложим opensuse целая пачка у нас готовы и но насколько я знаю там сильно зависит от того от команды которые укладывал основном в основном до основном приняли могут принять как обычно"
}