{
  "video_id": "N9hEynzsXNo",
  "channel": "HighLoadChannel",
  "title": "Архитектура биллинга: как не стать единой точкой отказа / Илья Иванов (Яндекс 360)",
  "views": 768,
  "duration": 3140,
  "published": "2025-01-17T02:29:57-08:00",
  "text": "Всем привет Меня зовут Илья Иванов Я из биллинга Яндекс 360 и Сегодня я расскажу вам про архитектуру биллинга Как не стать единой точкой отказа Окей давайте для начала введём немного контекста билин Яндекс 360 - это сервис который работает с 1000ps И включает услуги пользова из Яндекс 360 Яндекс 360 - это сервисы которые созданы для решения рабочих задач через них Вы можете поставить встречу отвести рабочую переписку сохранить файлы созвониться с коллегами много чего нужного и полезного Но кроме того Яндекс 360 - это ещё и десятки миллионов пользователей и сотни тысяч организаций которые пользуются нашими решениями а ещ множество наших сервисов держат наз больше 100000 RS ой о ЧМ же сегодня пойдёт речь для начала мы поговорим про как про то как устроен билин для экосистемы И что же в него входит кроме обработки платежей Кроме того поговорим о том что как мы пришли к концепции при билин что это такое зачем они нам понадобились мы опять придумали поговорим о том как мы постро гибкую архитектуру которая поет нам удовлетворять всем требованиям нашего бизнеса Окей с чего же мы начнём начнём мы с биллинга для экосистемы и Смотрите тут нас сразу встречают два термина давайте для начала разберёмся с ними что же такой биллинг биллинг - это система выставления счетов и взимания платы за товары или услуги Ну тут вроде бы всем Всё понятно определение укорочено из Википедии вроде вопросов не вызва Давайте дальше А вот что такое экосистема Ну мы будем брать цифровую экосистему это множество разнородных цифровых объектов и их взаимосвязи ориентированных на взаимодействие с целью повышения полезности и получения выгод Ну слушайте вот такое определение примерно нам дают научные статьи я его попытался приземлить и как-то скомпоновать чтобы оно Хотя На СД вза оно сложновато Давайте немного пора смотрите первый вопрос который может возникнуть А в ЧМ собственно отличие экосистемы от системы и Давайте будем разбираться на примерах хорошим примером системы является интернет-провайдер у интернет-провайдера есть одна конкретная понятная цель Он должен обеспечить доступ в Интернет пользователю какой же пример экосистемы все что я буду брать за пример экосистема Яндекса - это множество совершенно разных бизнесов которые взаимодействуют друг с другом для улучшением пользовательского опыта О'кей А какая у экосистемы цель Ну вообще говоря как правило цель экосистемы приносить прибыль Надеюсь я здесь ни для кого открытие не сделал Окей если цель экосистемы приносить прибыль значит её нужно как-то монетизировать и возникает вопрос и в ЧМ же сложность Ну бери свою экосистему делай в ней разные сервисы у них будут какие-то способы монетизации и монетизируется мы будем на примере опять же экосистемы магического дома Смотрите магический дом - это такая супер полезная экосистема которая делает жизнь жителе этого в неё будет входить несколько сервисов Первый из сервисов пусть будет такой Волшебный календарь Волшебный календарь это сервис которому пользователи приходят и спрашивают А что бы мне поделать Волшебный календарь на основе многих разных параметров там погода за окном настроение пользователи придумывает чего Чем бы заняться пользователю продавать Мы такой Волшебный календарь будем через ежемесячную подписку о первый сервис есть чего е кулинарный помощник Ну слушайте действует он похо пользователь приходит к нему и спрашивает что мне поесть а он ему говорит Ну если хоче что-то приготовить Вот тебе ингредиенты вот или если хочешь готовую еду вот тебе готовая еда ты это можешь заказать и монетизировать мы наш кулинарный помощник будем через оплату за заказ ничего не напоминает Да окей ещё один сервисный серс будем называть е всесильны погодни ВМ Он меняет погоду по желанию пользователя вот нужно пользователю там солнышко ИТ будет солнышко монетизировать такой сервис будет по секундно за каждую секунду изменённой минуты за каждую секунду изменённой погоды мы будем взимать пользователя денежку Какой ещё сервис Ну конечно все любят котов Все любят обнимать котов их гладить А что для этого нужно ну нужно чтобы код был спокойным будем также продавать тренера по йоге для котов и монетизировать мы его будем через заплату за загрузку приложения с дополнительными пакетами Итого что мы имеем У нас есть некая экосистема в которую входят сервисы с разными типами монетизации и возникает вопрос А какая вообще должна быть архитектура у биллинга который будет обслуживать такую экосистему и все эти сервисы Окей давайте для начала предположим что у нас будет единый биллинг то есть единый сервис который будет обслуживать все все сервисы в нашей экосистемы Они через него Бут монетизировать мы уже с вами сформулировали какие есть сценарии то есть Волшебный календарь монетизируется через подписочные механики кулинарный помощник через писание по запросу погодник там через посекундно тарификацию а приложение для йоги для котов будем продавать через внешние сторы по факту Это значит что всем этим сценариям монетизации на он их должен обслуживать он должен содержать в себе логику для всех этих сценариев Окей вопрос А нам это подходит вот есть вроде есть множество сценариев они все живут в Едином биллинге все сервисы монетизируется через единый биллинг Ну давайте разбираться возьмём за пример пусть у нас есть всесильный погодник у которого есть покун фикация предположим что в какой-то момен в Эко умного дома решили добавить ещё один супер полезный сервис планкой планка сятери который начисляют пользователю бонусы за то сколько он простоял в планке Ну вроде всё понятно да но Любой кто Стоял в планке знает что первые 30 секунд в планке и там вторые 30 секунд - это вообще не одно и то же это значит что по секундную тарификацию мы не сможем использовать обычную нам нужна какая-то посекундно тарификация с ростом стоимости и какие у нас дальше есть варианты Мы хотим очевидно монетизировать наш Банко сятери будем добавлять по новой механике Ну вы Ну мы представим да С какой у нас биллинг будет огромный в нём будет просто ну огромная гора каких-то механик и пойди разберись как они работают Какой ещё вариант есть унифицировать механики То есть к уже существующей механике добавить новую и вот тут возникает вопрос а как это сделать Ну то есть у нас планкой ль приходит в биллинг говорит я хочу через тебя продаваться добавь туда механику биллинг приходит к погодник спрашивает Так мне тут надо унифицировать значит слить как-то твою механику с новой ты не против изменения контракта Ну в общем тут на самом деле возникают вопросы погодник вообще никого не трогал никому не ходил и тут его что-то хотят менять ему это вообще не надо у них там у этой команды у этого бизнеса там у них другие цели Зачем им это всё надо он идёт к планте и говорит чел ну давай как-то без этого вот и на самом деле тут надо понять что к какому бы мы решению не пришли мы всё равно уже очень много времени потратили на коммуникацию и даже я здесь предположил что мы добавили новую механику Я уже Говори тоже не особо решение Итого Ну наш единый биллинг нам Ну не очень подходит потому что у нас будет много времени тратится на что по факту будет но тратится много времени на реализации новых фич их все надо будет согласовывать А вам подходит А У всех бизнесов разные хотелки Ну как-то в общем это всё будет долго идти дальше могут возникнут конфликты интересов одни хотят механику вот так развивать вторые её хотят развивать вот так добавлять в неё вот такие штуки ну и в общем они могут А ну в разную сторону тянуть как Лебедь рак и щука Окей Какие ещё варианты Ну не Какие ещё варианты Какие ещё проблемы приоритет поддержки Ну если что-то случается надо кого-то спасать надо понимать кого спасать первым и тут тоже могут быть вопросы в разных ситуациях А пу-пу-пу что же нам делать-то а и мы в Яндексе придумали решение мы его называем Линг смотрите Какая суть Давайте вернёмся к нашему предыдущему примеру У нас есть всесильный погодник есть планте и предположим что мы добавим между ними и биллинга прослойку мы её так и называем при биллинг за что будет отвечать при биллинг И зачем он нам нужен по факту вот посекундно тарификация посекундно тарификация с ростом стоимости - это логика формирования запроса на списание средств Давайте е вынесем вынесем конечно же в прибили и у нас получается вот у нас была экосистема и для для сервисов нашей экосистемы мы добавляем по при биллингу М что здесь хочется отметить смотрите конечно же не имеется в виду что мы при биллинг добавляем для каждого сервиса или Тем более микросервиса при биллинг нужен отдельному бизнесу чтобы отдельно обособлено от других невзирая на их там требования и так далее развиваться Окей вопрос а что же остаётся тогда в биллинге Ну смотрите вообще говоря как минимум обработка платежей формирование документации отправка чека пользователю мы это всё можем оставить в биллинге общем в Едином и в нём также будем оставлять всё то что не специфично для конкретного бизнеса вопрос а что же тогда вообще есть ли какое-то правило Мы выносим в Линг в при биллинг мы будем выносить всё то что нужно конкретному бизнесу Окей давайте перейдём от абстрактных примеров к вполне конкретному биллингу Яндекс 360 как он работает И чего в нём есть прежде чем рассказывать конкретно Давайте немного истории много лет назад был и он сейчас есть Нон тогда появился сервис диск который хотел продаваться по подпис продаваться по подписке Ну тогда других вариантов не было он продавался через единый биллинг Яндекса Окей соответственно подписка жила в Едином биллинге Яндекса и в какой-то момент пришла почта и говорит ребята Мы хотим монетизировать Ну по той же подписки какие у нас варианты нам либо доки давать логику в Единый биллинг либо на своей стороне что-то как-то поддерживать Окей ну в общем там уже начали думать а потом появился Яндекс 360 в который вошли уже много сервисов и все эти сервисы хотели продавать по единой подписке это ключевой момент и вот чтобы это делать унифицированы для всех удобно и так далее придумали билин Яндекс 360 придумали и реализовали он соответственно отправляет запросы на списание средств в Единый биллинг Яндекса и управляет купленными услугами в продуктовых сервисах таких как диск почта календарь и так далее смотря на эту картинку может возникнуть вопрос так и что ну есть Линг в Яндекс 360 есть билин Яндекса и а остальные Как живут но по факту здесь ответ Следующий у каждого бизнеса Ну в общем случае у каждого Конечно есть свой пре биллинг который и помогает формировать запрос на списание средств и делает это так как удобно бизнесу невзирая на требования других бизнесов как удобно своему бизнесу конечно ой давайте веся у на есть Яндек 360 и для начала разберёмся вообще о пользовательских сценариях вот приходит пользователь и говорит что он хочет допустим купить тариф куда он попадает Ну попадает он Понятно через фнт вбк Яндекс 360 далее мы отправляем его в Единый биллинг и говорим кликер говорит что не говорим говорим произведи оплату соответственно пользователь плату через биллинг Яндекса А мы из биллинга Яндекс 360 ходим и спрашиваем Так что как там оплата она прошла не прошла когда оплата пройдена мы считаем что пользователю мы можем выдать услугу и теперь предоставляем ему доступ в наши продуктовые сервисы Окей Итого А что же со сценарием разобрались А теперь давайте по частям что есть в билин Яндекс 360 что мы туда вынесли собственно Почему смотрите логика тарификатор тарифов это в общем тарифы и то как мы в какой момент показываем их пользователю в зависимости от множества разных условий далее есть логика промоакций промокодов В общем всех тех сущностей которые помогают нашим менеджерам эффективно продавать продукт Окей платные механики по факту Яндекс 360 знат что списать сколько списать когда списать с пользователя и следить за состоянием купленных подписок О'кей дальше управляет купленными услугами То есть у нас как я уже упоминал есть продуктовые сервисы они предоставляют пользователю конкретные услуги Ну давайте приведём пример там место на диске допустим и всё это конечно включает билин Яндекс 360 и следить за тем чтобы когда подписка была у неё истёк срок собственно это всё надо дело ещё и отключить так понятно Давайте теперь немного а про разделение ответственности таким образом собственно у нас часть живёт в общем биллинге как я уже упоминал это обработка платежей подготовка отчётности отправка чека пользователю и часть живёт в линге это логика тарификатор то есть создание администрирования управления сущностями для бизнеса это платёжные механики и это управление услугами в нашем бизнесе разберёмся чуть-чуть Подробнее по каждому из компонентов что в них входит и зачем они нужны А ну всем известно что менеджеры любят гибкие способы продажи своего бизнеса и любят создавать много разных сущностей они любят создавать акции генерировать промокоды новые какие-то продуктовые линейки добавлять И вообще говоря когда мы только со сделали наш сервис менеджер приходил и на любое его действие мы приходил несчастный такой зна ТК говорил Ладно зарабо и писал какие-то миграции накаты это ВС и в общем-то всем очевидно Да что так жить нельзя мы сделали отдельный модуль это тарификатор он не только теперь умеет создавать сущности типа там промоакций и других но он ещё умеет следить за условиями когда их показать какому пользователю какой группе пользователей Почему И зачем Окей п механи вообще говоря сервисы из Яндекс 360 продавались в сегменте b2c b2c - это соответственно бизнес to Custom Лим потом в один момент возникла необходимость их продавать и в сегменте B2B тоже О'кей если с b2c Мы вроде обсудили уже затронули там есть подписка она продаётся пользователю пользователь ей пользуется то вот с B2B возникают вопросы а как продавать B2B тоже подписку сделать Но тогда вопрос А что если количество пользователей в группе или организации уменьшится А что если увеличится причём сильно увеличится У нас есть кейсы когда человек купил для организации там тариф когда он там один а потом их стало 1000 2000 10.000 и так далее и в общем здесь мы пришли к выводу что продавать подписку не вариант и мы как решение придумали продавать в BB и монетизировать тарифи е с помощью почта использованного времени о Итого Давайте вернёмся назад чуть-чуть обратно кнопка уже не работает Ага здесь Хочется подметить ещё такой момент то есть по факту для в нашем биллинге Яндекс 360 живут разные платёжные механики и мы на своей роне формируем формировани запроса единый билин Яндекс об этом никак не знает и ну мы в него только ходим и отправляем наши платёжные намерения третья часть управление услугами Давайте разберёмся Собственно как вообще происходит управление услугами их включение для пользователей в Яндекс 360 смотрите пользователь приходит и говорит что я хочу купить тариф мы ему говорим окей Как вы помните отправляем в Единый биллинг там он проводит оплату на своей стороне когда оплата успешна мы запоминаем что ему нужно активировать услуги Мы идм в наши продуктовые сервисы ну здесь конкретно пример будет Яндекс диск И говорим Ну на примере сервиса Дай пользователю 200 Гб которые он купил в рамках тарифа диск говорит Окей я выдал запомнил и теперь если пользователь хочет идёт в диск и хочет совершить какое-то действие загрузить новые файлы и так далее диск уже знает на своей стороне можно ему это делать Или нельзя он не ходит в бинде 360 что у на получается Бин Яндекс 360 - это такой оркестратор услуг который управляет услугами в продуктовых сервисах следит за их жизненным циклом и знает когда их нужно включить отключить или изменить вопрос а можно ли сделать как-то по-другому Ну вот мы придумали страто во-первых тут же понятно да что взаимодействие между сервисами оно не мгновенное на это тратится время и мы можем какое-то время пользователю вчать в что если мы будем на своей стороне сохранять данные о том что пользователь купил а каждый из продуктовых сервисов будет ходить и спрашивать Ну что там что пользователь купил можно ему предоставить то или это И на самом деле конечно авторизация примерно так устроена пользователь приходит спрашивает Ну мы в системе спрашиваем Можно ли его там предоставить оден услуги но в этом случае мы по факту получаем нашем Яндекс 360 больше миллиона rps я уже говорил что сервис у нас продуктовый довольно нагруженный если просуммировать там даже больше миллиона будет и Ну тут все понимают Да что нужно новое железо заказывать у нас появляется такая Огромная точка отказа если она лежит у нас проблемы и вообще ну лишний раз клепать сервис на миллион rps никому не хочется И никому не надо поэтому мы живём на оркестра фиче она полностью удовлетворяет требованиям нашего бизнеса и на с нек Окей синхронизация услуг давайте мы уже рассмотрели с вами Как выглядит пользовательский сценарии Какие компоненты входят в наш Бин 360 Теперь давайте поговорим о нашем одном из самых высоконагруженных функциональной скажем так синхронизацию улуг во-первых вопрос а что же такое синхронизация услуг вообще по факту это приведение системы в ожидаемое состояние когда допустим пользователь купил у нас какой-то тариф мы знаем как мы должны изменить состояние системы чтобы удовлетворять его спросу Окей рассмотрим пример у нас есть организация большая организация она пришла и сказала ребята я купил тариф купила тариф и мне его нужно всем моим сотрудникам включить Ну О'кей возьми да включи в чём проблема большая организация Ну мы же как-то в B2B сегменте вообще работа а давайте немного усложни пример А что если несколько больших организаций одновременно к нам пришли кто-то хочет купить тариф кто-то улучшить тариф и нам нужно всем за адекватное время Ну удовлетворить их услуга то есть предоставить услугу которую они купили так давайте чтобы не было на всякий случай каких-то лишних вопросов недопониманий разберёмся с тем а Что такое большая организация Ну вот интернет нам говорит что большая организация - это та в которой от 250 человек мы интернет очень уважаем И конечно не хотим с ним спорить но Давайте в нашем конкретном случае Будем считать что организация большая Если в ней есть Ну хотя бы 10.000 сотрудников О'кей Итого у нас приходит несколько организаций в них в них больше 10.000 сотрудников и все они хотят получить за адекватное время какую какую-то услугу Что же нам делать-то как жеже нам быстро это всё сделать Окей смотрите Ну давайте для начала разберёмся с тем А что такое групповая услуга Она состоит из двух частей из групповых фичей и фичей участников и тут появляется слово фича Да ну что такое вообще была услуга стала фича фича - это некий бонус или некое преимущество которое пользователь получает заплату Итого приме групповых чез организациям рассылать там 50.000 писем либо предоставляем единый вход ССО О'кей Ну с групповыми фичами Ну по крайней мере на примерах мы разобрались это значит фича которая предоставляется всей организации как единой сущности А дальше у нас есть также в организации фичи для каждого из её сотрудников и мы по факту для каждого из сотрудников включаем определённого вида фичу такую как й место на диске отсутствие рекламы фильт их на самом деле много разных возникает вопрос да А зачем так почему не на всю организацию отсутствие рекламы включать почему не на всю организацию место выдавать Ну что же вы там придумали ответ Ну вот на этот конкретный вопрос много разных Почему именно у нас есть фичи участников внутри групповой услуги Как пример могу сказать что предположим мы выдадим место на диске на всю организацию и у нас может быть вполне сотрудник в организации который утилизирует всё это место и остальным не достанется одно из требований чтобы такого не произошло соответственно каждому из сотрудников или участников организации мы выдаём место отдельно кроме того если вдруг участник из группы пропадает либо там ну к примеру сотрудник был уволен мы конкретному участнику оторвём его услугу на на него конкретно О'кей Ну вроде с тем Из чего состоят групповые услуги мы разобрались Давайте теперь Угу може может мы так разберёмся с тем как мы их включаем включаем их следующим образом Ну как вы помните вообще говоря фичи мы включаем в конечных продуктовых сервисах то есть на включение там терабайта место на диск или трансляции Мы идём с походом в конкретный в конкретный сервис Окей Теперь смотрите пусть у нас есть такая стоит машина в которой есть состояние ИТ инициализирован Син синхронизируется и актуальный Когда у нас создаётся групповая услуга она переводится в состояние ИТ далее У неё создаются дочерние сущности они Ну соответственно когда они все созданы они переведены состояние основная сущность приводит состояние и так далее создание лдо У нас они переводятся в состояние и родительские сущности в состояние Син и мы продолжаем так до тех пор пока не будут отправлены запрос в наши продуктовые сервисы а далее мы ожидаем от них ответа когда мы получаем 200 Ок ребята мы включили на своей стороне мы говорим Окей эти сущности в актуальном состоянии эти фичи в актуальном состоянии Они включены в продуктовых сервисах мы тут нас всё устраивает возникает вопрос А что если неуспех если нам кто-нибудь из сервисов ответил Не ОК Куда нужно направить кликер чтобы точно работало сюда О вот сюда сработало если значит сервис нам отключает нек он у нас есть специальное состояние оно называется СН и по факту происходит следующее мы аккуратно с оден промежут вме делаем И говорим дорогой Пожалуйста включи нам фичу потому что мы должны пользователю обеспечить конечную согласованность собственно Мы выполняем ретра Итак аккуратненько ко с промежутками времени мы делаем й до тех пор пока сервис нам не ответит Окей я включил Здесь всё хорошо и так далее дерево приводится всто и когда последня суно в состояни когда все её дочерние сущности уже тоже в этом состоянии по факту мы считаем что наша услуга организация уже выдано и выдано успешно при этом возникает вопрос так а что А почему это работает Быстро смотрите как я уже говорил для групповой услуги в итоге создаются сущности которые говорят Включи фичу в конкретном продуктовом сервисе для каждой из суно мы е включаем асинхронно у сода которые отвечают за поход в продуктовый сервис и так как для каждого из пользователя и для каждой организации мы это делаем отдельно и все таски друг от друга не зависят и мы их можем отдельно трать то по факту если надо соответственно мы их ретра мы их складываем просто в очередь и обрабатываем воркера и этих воркеров может быть сколько угодно тук за с этого мы собственно и достигаем скорости обработки И даже если большие организации там сотни тысяч участников к нам приходят и говорят Мы купили у вас тариф мы включите нам пожалуйста услуги мы это делаем за адекватное время Ну за несколько минут Окей Если вас заинтересовало наше внутреннее устройство вы можете послушать доклад моей коллеги Даши она рассказывала как раз как у нас устроены другие йт машины и остаётся вопрос Ну понятно что мы собираем кучу разных метрик с нашего сервиса Чтобы понимать что он работает Окей и с ним всё хорошо потому что это биллинг и нам это важно а какая же вообще основная Метрика качества как мы Мерим что наш сервис работает хорошо и без перебоев Ну тут В общем не буду долго томить по факту основной метрикой качества в нашем конкретном случае для нашего биллинга Яндекс 60 - это скорость получения всех услуг момент от соответственно когда организация либо пользователь произвёл оплату до того когда мы включим последнюю услугу которая была куплена в рамках тарифа Окей Итого в Бин Яндекс 360 хранит знания что и как бизнес хочет продавать отвечает за логику формирования запроса на списание средств он управляет купленными услугами собственно вот в заключении Сегодня мы я вам собственно рассказал что точнее мы поговорили о том как выглядит биллинг для экосистемы о том что собственно в него входит Не только обработка платежей там ещё и логика формирования запроса на списание средств и она для каждого бизнеса Ну разная не похожая далее я рассказа Какие сложности могут возникнуть прини биллинга что мы можем получить если будем пытаться пихать всё в Единый биллинг и обслуживать сразу много разных бизнесов тут Конечно хочется отметить что мы не придумали серебряные пули нам она Хорошо подходит у нас это работает но можно конечно и сделать единый биллинг вопрос в том сколько будет стоить его поддерживать Ну и собственно сегодня рассказал что такое функциональность него входит и разобрали на примере биллинга Яндекс 360 О'кей задавайте ваши вопросы Давайте обсудим Спасибо это было энергично вот к кому ближе идти Давайте вот да А здравствуйте Спасибо за доклад большое А друзья ещё раз микро мастер-класс микрофон параллельно земле и не дальше чем 2 см от Орта тогда голос мужской прямо будет Спасибо доклад Дмитрий Терещенко МТС У меня вопрос к первой части доклада пролинг и биллинг Если я правильно понял здесь у вас получилось что-то наподобие паттерна медиатор А когда я ну есть единый сервис к которому обращаются другие сервисы Да вот здесь не может ли возникнуть проблема когда этот единый сервис будет сильно раздува например чтобы подержать какую-то новую платёжную механику в при биллинге может быть какой-то экзотический кейс возникнет и нужно например подержать какую-то финансовую форму отчётности Вот и будет раздува раздува дуться нам по факту никто не мешает декомпозировать и при биллинге тоже в чём проблема в рамках одного бизнес будем име некоторые Бут отж за сво будет раздаваться сам билин а сам билин смотрите Ну в него входят вполне конкретные части как я уже говорил там Обработка платежей отправка чека введение документации подо отчётной для отправки в налоговый и так далее в в него по сути не добавляется новый функционал все сервисы на своей стороне реализуют орр менеджмент и просто ходят для payment процессинга в Единый Белен хорошо спасибо спасибо Вот изнурённый сонн пожалуйста Илья Спасибо за доклад хотел узнать про прибили подробнее Ты рассказывал что когда у менеджера появляется новая идея для тарификации он идёт к разработчику и тот пишет какой-то код добавляет этот расчёт и по итогу это сейчас так работает Или вы сделали какой-то удобный для менеджеров инструмент по типу таблицы формочки графы что-нибудь такого чтобы они сами могли реализовывать эти тарифы Ну я же вроде да про это и говорил это есть логика тарификатор тарификатор - это отдельный модуль у которого есть ua в который просто менеджер ходит и автоматически все сущности создаются тут никакого участия разработки это я говорил про первый этап скажем так как у нас изначально было тарификатор тарифи тарифи тарифи ривали пожалуйста Да спасибо за доклад очень интересно вот не очень понял один момент а как вот условно если биллинг - это просто там платежи Да условно А на при биллинги секундная фикация как-то вот по ощущениям кажется что проще замерять там ну Короче как это происходит то есть если каждую секунду То есть какой-то запрос прям типа идёт с как это сейчас то есть билин это просто система платежей так при биллинг когда посекундно то есть это надо перевести как-то вот из одной абстракции именно Ну то есть именно в платежи То есть это каждую секунду идёт запрос или там какая-то всё-таки есть логика для секунд в самом биллинге в при биллинге есть логика формирования секунд и он соответственно их просто компот и смотрит допустим как угодно дальше Сколько за день организация потратила или пользователь Сколько за неделю Сколько за месяц он сам решает В какой момент отправить а на своей стороне Просто ведёт подсчёт Сколько было предоставлено услуги Ну ну вот если я возьму услугу которая посекундно у вас работает а вот из при биллинга в биллинг будет каждую секунду запрос идти нет нет ну Ну слушайте тут э дальше вопросы да как это реализовать Ну мы так не делаем у нас не идёт каждый секунд запрос Ну просто идея в том что тогда биллинг должен уметь секундами короче работать а не совсем смотрите в биллинг же отправляется запрос на списание средств конкретную Спиши с такого-то пользователя такую-то денежку вот там вот за это-то ну и соответственно самому биллингу уже не важно за что конкретно он списывает это но как часто мы будем запрашивать идея в том что как будто тогда значит какой-то таймаут должен стоять что каждые 5 секунд мы будем обновлять эти данные там что-то накидывать Ну ещё раз смотрите здесь же требование бизне если вам нужно прям вот каждую секунду вот прям секунды в секунды с организации списывать деньги и там прям транзакцию проводить Ну О'кей вы так Ну наверное Вы можете не подойдёт Да вот этот получается а а в чём здесь разница если бы это всё жило в Едином биллинге бы единый биллинг каждый там секунду ходил в банк и списывал денежку нет идея в том что тогда можно было бы завязать на само время то есть условно время было бы именно разница времени от текущего от Ну как это Т2 ми Т1 да и мы бы просто умножай коэффициент Вот и тогда бы мы могли актуальную информацию всегда получать А тут мы типа завязаны на вот этой синхронизации получается ну в моём понимании здесь не особо Ну типа это нормально то есть ну у нас здесь даже не возникает никакой синхронизации у нас просто есть при биллинг он считает Сколько нужно заплатить и соответственно отправляет запрос просто в Единый биллинг у нас ну как вы и говорите здесь нет потребности каждую секунды это делать ну понял спасибо Прикол вообще да я хотел пошутить но забыл Да у меня есть вопрос связанный с использованием стоит машины и в целом заворачивание всего трафика в сторону Яндекс 360 биллинга зачем мы используем как единую точку входа Яндекс 360 Когда например мы могли бы поставить между Яндекс 360 и целевым сервисом наме Яндекс какой-нибудь Вот вот как мы между пользова Сталин только какой-нибудь полинг типа или ещ что-нибудь подобное поди сейчас Яндекс предлагаешь ещ один велоси вот вопрос почему мы действительно используем костыли со стоит машиной и завязываем состояние обновление лицензий слушайте Давайте немного уточним О каких сценариях идёт речь вот смотрите когда пользователь покупает тариф и нам нужно выдать ему тариф он конечно приходит в 360 когда нужно сохранить файл через диск или там отправить письмо понятно что Бин Яндекс 360 здесь вообще ни при ЧМ и он в него не идёт то есть в билин 360 идут запросы которые Ну типа связаны с продлением подписки отменой подписки апгрейдом подписки и так далее но при этом когда мы Обращаемся в условного потребителя Яндекс 360 60 верно ци Я же говорил да по факту мы впи Яндекс 360 получаем допустим оплату Да получаем сведения о том что оплата произведена мы идём в конечный сервис такой как диск и включаем на стороне диска услугу диск на своей стороне хранит данные о том актуальна услуга включена она или не включена ему не нужно ходить в биллинг потом когда истекает срок и допустим было авто продления и либо пользователь отменил мы просто отправляем запрос в диск И говорим Выключи и опять же диск знает что теперь уже эта услуга Нет я не ответил на ваш вопрос вопрос остался тот же а зачем-то в таком случае нам нужна стоять машина стоит машина - это просто ну абстракция которая нам удобно работать в в коде Спасибо отлично Будь добр Спасибо за доклад Павел Т банк первый вопрос - Это про Вот про пре биллинги хорошая абстракция всё понятно вопрос А кто её реализует команда биллинга или команды которые хотят подключиться к биллингу что есть у вас границы вот этой платформы биллинга и второй вторая часть вопроса в этих всех при биллинга всё равно будут какие-то общие части каких-то небольших механик которые будут нужны там во всех при биллинга или там по части их тоже это каждый раз дублирование каждый раз команда сама отдельно это реализует или там тунга подключается как это делается ответ на первую часть вопроса каждый бизнес сам выделяет команду для того чтобы сделать свой Линг и монетизировать свой бизнес при этом Ну тут нужно понимать что у нас так но можно сделать и по-другому никто не мешает второе Ну части механик действительно похожи есть Ну мы соответственно смотрим Мы стремимся конечно к тому чтобы это как-то унифицировать Если действительно часть механики одинакова Абсолютно для всех то почему бы её не вынести да пожалуйста я вспомнил как я это не шутка была э Мне очень нравится эта конференция именно здесь Потому что это уже четвёртый раз когда мы говорим о том что инженеру надо очень хорошо понимать что бизнес хочет то есть не ты говоришь бизнесу как оно будет это время как будто бы прошло а есть диалог то есть ты чётко чётко решаешь зада Да спасибо что дали мне высказаться Да добрый день Андрей лопухов Сбер У нас тоже классная система есть Кстати а вопрос про групповые услуги и когда приходит бизнес и говорит А нам вот в рамках вот такой групповой услуги надо всем всем всем компаниям которые её купили дать какую-то фичу новую в новом сервисе Как вы вот эти кейсы эти сервисы тут уже не 10.000 тут уже 10.000 помноженные количество пользователей этой услуги ну такие кейсы мы соответственно они у нас происходят на самом деле автоматически это тоже по факту сценарий пересисленных Как как ответить на этот вопрос Ну никто не жалуется адекватное время Спасибо Спасибо Да пожалуйста Да Женя из Яндекс вертикали здесь в середине примерно Ну ладно в общем я у нас в нашем бизнес Юнити делал похожий при биллинг на основе биллинга Яндекса и вот засада была в том что у нас было несколько случаев которые требовали доработок в биллинге Яндекса и обычно это занимала там месяцы согласований потом ещё месяцы разработки на и строне на нашей тяжёлая интеграция А было ли у вас такое напильник которым надо дорабатывать а то паровоз получается Да Слушайте Ну давайте оставим это для дискуссии короче Без микрофона подходишь и получаешь да буд соб привет такой вопрос Ты упомянул механизм пересисленных ответ и есть ли какой-то механизм для того чтобы сервисы пересиливая или вы там регулярно переобуть всех У кого что-то есть ну по факту то есть если мы рассматриваем случай когда сервис нам сказал что всё ок я включил но при этом он не включил правильно Ну да условно так Ну тогда мы с Ну есть ли у сервиса кака какой-то способ узнать что всё же включено у него Ну для конкретного пользователя ну у нас есть таски которые Да просто по расписанию синхронне актуализируют данные о том что у нас всё О'кей хорошо спасибо спасибо я вот сейчас поймал себя на мысли что я пользуюсь платным диском уже 4 года а он взял с меня деньги только один раз а логин я тебе не скажу Да пожалуйста Илья Спасибо большое за доклад Пётр Лима Pro У меня вопрос такой э в данной картинке в схеме нигде не было отражены механики скидок или механики когда один из сервисов предлагает скидочной вот куда было бы корректно вынести все промо механики которые взаимодействуют не только внутри одного сервиса но и с каким-то соседним здесь Наверное имеется в виду бизнесы да то есть когда у нас ну на данный момент у нас реализованы промо механики которые внутри Яндекс 360 работают Вот Но мы скажем так в процессе развития здесь получается что промо механики сейчас живут внутри каждого бизнеса самостоятельно и никак Ну и с друг другом взаимодействуют не через Центральный напрямую Ну между собой они тоже В общем обмениваются при необходимости спасибо спасибо Прошу Добрый день Спасибо за рассказ вопрос У меня два будет вопроса Первый который касается разделения групповых услуг и конкретно пользователей в частности по времени пользования сервисами если мы каждому пользователю выделяем мы получается каждому выделяем конкретное время пользова и они рифи конкретно по пользователям мы вот мы организации продали там 100 минут пользования сервисом Вот и соответственно каждому пользователю выделяем по 5 минут или там по минуты пользования Ну мы соответственно приходит организация говорит что мы хотим А у нас там не знаю 100 человек Мы хотим покупить тариф себе на месяц мы соответственно Ну считаем сколько она должна заплатить заранее и ну по факту просто в зависимости от того сколько было пользователей в организации мы подсчитывая время использование сервис Ну и потом списываем просто да я к то к тому что ну Мы продали им 100 минут мы как распределяем между пользователями эти 100 минут Ну если 100 минут было пользователя было продано на всю организацию то поделим на количество пользователей а то бишь всё-таки каждому достанется по чуть-чуть пользователе И второй вопрос темах би стать единой точкой отказа А у нас есть основной биллинг который является точкой отказа для биллинга Ну кажется с этим-то сделать ничего нельзя где-то же всё равно надо проводить платежи отправлять чеки пользователю хорошо спасибо спасибо Вот здесь Да пожалуйста Илья Спасибо за доклад У меня такое вопрос Если я правильно понимаю То вся тарификация находится нане соответственно продукты которые пользуются билин отправляют информацию о размере потребленных услуг и это наверняка асинхронный процесс и может быть такой момент когда подписками же тоже управляет билин соответственно продукт отправил информацию об учёте потребления продукт в этот момен Запроси бан тут состояние гонки происходит то есть может быть такое что ещё потребление не учтено а но при этом биллинг разрешил потреблять услугу продукту вы как-то с этим боретесь или ничего страшного если чуть больше услуг будет потребления мы просто потом пересчитай в следующем Ну какой-то период времени и актуализирует столько сколько сколько надо Если было соответственно Ну списано меньше мы просто до спишем а а если это какой-то условно пакетный тариф где ограничено количество и это предоплат ная модель то есть пакет куплен и с этим ничего не сделаешь то больше потом ничего не получишь с пользователя он же купил тариф он его пользует и всё слушайте ну здесь тоже такие тонкости Давайте просто в дискуссии это обсудим Спасибо Да так что не не уходи пожалуйста Да прошу Добрый день спасибо за доклад у меня вот тут вопрос возник когда к вам заходит новый пользователь он получается тоже генерирует вот эти вот волны рассылок доступности фичей или как-то у вас какие-то пред дефолты есть всё-таки на уровне сервисов что если у меня нет информации о биллинге если она ещё не поступила как-то вот такие пограничные случаи Как вы их решаете Давайте ещё раз к нам пришла Организация или пользователь и Ну вот физическое лицо например просто ну он зарегистрировался на вашей системе Ну то есть с существующими пользователями у которых уже подключены там какие-то тарифные планы это всё понятно А вот когда новые пользователи к вам приходит например там маркетинговая акция или ещё как-то и у вас такой большой наплыв ваша система верных рассылок она как бы не успевает это сделать то Вот вы пользователя не знаю у вас пред дефолты есть какие-то на конечных сервисах там на почте там ещё где-то как вы к этому подходите Я вот тут плохо понимаю что здесь пред дефолтное имеется в виду у вас сервис когда выполняет услугу он не ходит в биллинг он использует информацию под ногами если её нет Ну вот в случае волны там новых пользователей ну по факту если условно пользователи новые систе его до этого не было то он считает его условно зарегистрированным но без услуги когда данные об услуге придут из биллинга тогда пользователь получит ус нее СЗ к конц поэтому Давайте последний вопрос микрофон остальные в кулуарах и надо будет в чатике ещ ответить Добрый день Меня зовут Андрей товар свая биржа подскажите пожалуйста билин учитывает механики когда грубо говоря пользователь остался недоволен услугой и хочет отменить платёж там сторнирование операции или просто Ну вот вот ошибся получении услуги и быстренько хочет обычный механизм рефан то есть возврата средств конечно хорошо спасибо А И теперь мой вопрос ребята о махни пожалуйста ру кто задавал вопросы вот сейчас надо выбрать чей вопрос является инвестиции в сообщество и тому мы дадим матрёшку а а остальным потом просто раздадим там у нас ещё мне понравился вопрос из СТ банка вот собственно от человека в красном жакете Да вот самый дорого одетый Джентльмен получает матрёшку Да спасибо спасибо за инвестицию в сообщество и у нас ещё три Да так ещё три вопрос ещё нет Три три Ваших Нет А Это телефон Да от MTS Digital кому дарим приз Вот кто тебя напряг прямо вот вопрос мне понравился вопрос про синхронизацию слог Когда у нас добавляется Новый сервис новой фич что мы делаем это А вот у тебя же 10 уже тебе есть кому А дайте ему лучше индексов Дедом Морозом Причём я чужое дарю Да так ещё два последний вопрос мся последний восходит уходит вот махни девчонкам пожалуйста Да так и кому носочки наденем на уши Давай сейчас о махни ещё раз кто вопросы задал махни скажите про что вы спрашивали Да ну нет так это тебе месть за молодо человека который отправил в дискуссионную зону А ты ты их обоих отпра одно ВТО носить розовое Да получать носочки Яндекса отлично тебе тоже памятный приз мерч от конференции Спасибо большое и потверждает"
}