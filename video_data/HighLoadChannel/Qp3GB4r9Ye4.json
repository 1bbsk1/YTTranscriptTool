{
  "video_id": "Qp3GB4r9Ye4",
  "channel": "HighLoadChannel",
  "title": "Введение в KernelShark / Александр Костриков (Яндекс)",
  "views": 392,
  "duration": 1820,
  "published": "2023-01-19T05:55:17-08:00",
  "text": "взводе монаха и ладит конференция про высокие нагрузки довольно часто происходит так что мы уже оптимизировали базу данных мы добавили каши все у нас работает замечательно но при этом какие-то проблемы системы обычно мы говорим про windows of high lords возможно тот обычно это linux когда я делаю запрос в linux искал меня обычно это было как отправление данных в черную дыру то есть я понимаю что что туда послал новая шипы то барьер сингулярности я вообще не понимал что происходит к счастью пятимерные люди из будущего могли создать нам подсказки как посмотреть что происходит внутри ядра внутри этой черной дыры и сегодня я хочу рассказать про один из этих инструментов этот инструмент называется керна shark и меня есть план по знакомству с ним и я буду его придерживаться итак план состоит из введения в керр shark мы его сравнил шарко и посмотрим как можно использовать для trouble суть ингой для анализа производительности конце я дам обзор полезных ссылок в общем приготовились к этому в честь и так рассказ обо мне я костриков александр я сейчас работаю в яндексе в сетевом департаменте и мы занимаемся большими объемами трафика это трафика так много что она бу машину не влазит и даже в один дата-центр поэтому нам надо оптимизировать искать проблемы и делать какие-то гипотезы чтобы понять почему нам надо добавить столько машин для обработки трафика либо столько до этого салон сетевые вещи они работают так же из системных ранений со всем остальным что работает на линуксе теперь хотел бы узнать о вас побольше последний вопрос уже не revival так как в предыдущий доклад был проеби пев вы про него слышали знаете не было то посмотрите дума и так можно узнать сколько человек значит открывая shark этого отлично себе там использовали когда-нибудь туда стресс и кинул shark я думаю ну в общем понятно всем и принципе понимаем что твой shark зачем нужен здесь педанты как работает с trace'ом ближайшем приближение проблема сидром у нас есть вроде бы estrace у нас есть какие-то из строки данные которые можно посмотреть и тому подобное но часто такая ситуация что непонятно куда вообще ткнуться вроде есть это функции ведре там мы прописали вайпер был что делать на такого адреса такой но куда мы ставим этот стресс стресс что стресс ничего вообще не особо понятно также при таких объемах трафика просто ну нереально какой-то взять а стресс вот он тратит на все потому что вы либо у нас надо держать кучу машин для того чтобы проводить свои лаборатории что очень дорого последнее время это примерно реально и кроме того если мы так будем делать на боевом трафик то у нас будет дропаться и но у нас не будет будет что и проблем с которой мы столкнулись у нас будет проблема что трафик улетает в никуда могу рассказать то и проблема что у нас было совсем недавно это проблема с нагрев и шум есть такая функция как куда стать пакетики чтобы примерно помнить и зафиксировать этот путь можно использовать maglev хэш и у нас была такая проблема что на некоторых машинах при некоторых ситуациях и происходил дроп трафика было непонятно почему это непонятно как создать лапу для этого и проверить быстро было понятно что это происходит в апреле он момент когда пересчитываются те вещи куда достать пакет непонятно из-за чего эти за объема трафика или за еще каких-то вещей и так и можно было либо жить су ядро но можно поступить проще мы примерно знали что у нас функция используется айпи нет их ешь и сделали trace по этим функциям чтобы понять к уровнях и проблемы да это была боевая машина и поэтому хотелось выбрать такой инструмент который позволит все это быстро и без большой нагрузки на трафик произвести мы запустили trace на этой машине увидели следующую картину дано тут не самое понятное к сожалению не вижу как вы это видите но в принципе можно посмотреть что кое какие вызовы занимают очень много времени если обычно для ядра микросекунда для инструкция по наносекунда то тут у нас гораздо больше числа то есть была ситуация что при пересчете сша очень неоптимальный был метод пересчета хэша который при больших количествах элементов хеш-таблицы занимал блага и время хеширования и тогда мы решили что не будем на этих машинах использовать эту схему фиксирования перешли на другую и таким образом вместо каких то долгих дебатов и попыток собрать лабы гонять трафик но и сразу там буквально за 15 минут увидели что происходит ведре другие варианты как я уже говорил можно попробовать делать принтер х и так далее но после того как произойдет системный вызов ну тяжело найти будет я в принципе не знаю как получить эту информацию есть trace но с помощью стресса непонятного загрузили в моду гидро и что нам стрессе есть такие вещи как кедр shark тут же я могу до из многие знают о the perv эссе стенд-ап это тоже в делите которые позволяют посмотреть что за функции ядра были вызваны как как происходил tracing и тому подобное все эти системы очень хорошие перстни особенно нравится но не всегда есть возможность спирт поставить кинул shark им и его боккен дам это of trace практически сделал есть и также есть общий уровень бпф можно даже на уровне аргументов функции перехватывать функции можно подменять функции можно быстро обрабатывать пакеты в общем это прям супер вещь из кто не смотрел предыдущий доклад советую посмотреть и так что же из себя представляет три из индейки на шар как он работает вот тут обзор на могут сказать что это набор функций внутри ядра который уже встроена в ядро ничего не надо там дописывать дать у него вы просто передаете набор функций которые вы хотите тратить внутри там если вы посмотрите это обращение через систер но и все же там готова но lightweight скажем так ну никакой нагрузки практически не везет там просто счетчики увеличиваются и подробности можно узнать по ссылке очень хорошие tatra из мдф trace of trees это функция которая так и по сути делаю называется faction trace и снг это просто очень удобный инструмент для того чтобы смотреть на эти трейси у нас есть педант как многие знают гавай шарко и вот это по сути дела аналог типе дампа для первого шарко отличие от лебедев льда есть тебе пев который на уровень и лучше выше и больше но для того чтобы с ним работать вам надо будет гораздо больше инвестировать времени и знаний чтобы разобраться в нем там прям функции ядра и заголовочные файлы linux надо будет прямо если вы работаете с питоном и лежала скриптом вряд ли вам получится просто разобраться бите фом но он не так сложен там в принципе хороший компилятор который вам сразу скажу что вы делаете что-то не то поэтому можете посмотреть на кино shark и дальше надо будет глубже именно по параметрам и аргумента функции смотреть а не просто как функцию было вызвано то используйте лебедев и так white shark до многих на 6 shark и white shark and shark когда они похожи совпадение не думаю это ваш арка я думаю все вы видели и ну что тут рассказывать идут пакеты вы можете в любой пакет заглянуть и узнать что вашей сети происходит вы делаете pink куда-то и вам приходит какой-то ответ вы просто смотрите на него вот так выглядит керну сарк да не самый тигер френдли интерфейс но тоже можно заметить что можно по вызовам походить посмотреть и увидеть что происходит так почему и похоже не только названием ну я так подозреваю что кинул shark специально взял имя похоже на ваш арк и в обоих инструментах мы имеем дело с вещами которые хорошо посмотреть обычно этот в интерфейс это посмотреть и эти вещи происходят как-то по времени последовательно на всегда интересно посмотреть что было до что будет после и кроме того нам интересно какие были данные при этих запросах то есть нам интересно какой пакет ушел от нас какие пакеты по щекам нам интересно какие функции были вызваны когда мы производили те же самые работу с пакетами и так чем же керна shark отличается проблем в том что пакеты как правило имеет определенную структуру поэтому в shark может показать вот уровень ethernet лад уровень api вот уровень россии mpi все эти данные очень удобные кроме того можно даже тисе пи пи пи сессию увидеть там очень много хороших фильтров и на самом деле это очень простой инструмент и во многом он хорош потому что у нас пакеты имеют зеленую структуру но при этом ядро и функции в ядре сожалению определенной структуры не имеют может быть когда нибудь перепишут на расти или ногой тогда там структуры к это будет в общем у нас в общем смысле в общем случае есть вызов функции и по сути дела ничего что мы можем делать в таком generic виде получили функцию мы знаем примерно около какого процесса это происходило и какие дополнительные данные ведь функции то могла записать большой плюс при всем этом что у нас можно показывать call stack то есть функция будет важную функцию будет понятно что сначала у нас было получение сетевого пакеты novell 2 это ethernet фрейм потом внутри то можно увидеть что и пересилив происходил дальше там какой-то тисе пи обработкой и так далее то есть это очень полезное итак после того как мы познакомились примерно в широкими мазками с тем что карл shark можно поговорить о том как можно использовать 1 шарик для того чтобы завтра был судить какие-нибудь проблемы потому что у нас бывают ситуации что вроде бы функция ядро работала но потом происходит что-то непонятное при нагрузке и от дибашки совсем непонятно как поздравляю с моим политическим примером это как работает orm часто когда я что-то пытаюсь разобрать и узнать я делаю какие-то запросы простые функции от них перехожу дальше допустим не понимал как работает орб и что происходит вот есть у нас какой-то сетевой запрос непонятно откуда как и в какой момент появляется arp запись и куда я могу посмотреть хочу именно в ведре увидеть эти записи для того чтобы сопоставить эти адрес mac-адресу это довольно таки важная вещь если хотите понять куда у вас будет отправим пакет и какие данные этот пакет будет нести примерно такой код можно сделать можно выбрать вес кеш mac-адресов что-то пингануть и посмотреть что происходит и в керна шарки это будет выглядеть вот так то есть мы видим что есть or просив и дальше мы сможем добавлять функции которые мы захотим увидеть в этом arp запросе то есть команда are passing и так далее а если мы хотим сделать понять каким образом pretty happy запросе происходит от запрос мы заменим оси фенотипе и так далее если мы хотим узнать как работают от записи то нужен пойти на такой сайт эликсир будет венком не знаю многие если сталкивался гром-то знает его существование посмотреть как эта функция работает там если попросту он уже идти совсем то может зайти на get копач каком торвальдс linux там увидеть как эта функция устроена к сожалению не все функции внутри ядра окружены вот этой of trace маги и потому что это уже начало бы внести какой-нибудь overheat поэтому только основные функции которые нас интересует обычно покрыты можно сделать почти добавить свою обработку вокруг этой функции носа но как правило хватает того числа функции f trace которые существуют и так простейший вариант как кинул shark может помочь нам узнать о производительности какой-то системы пример мы можем ну взять и понять работает файла кэш и за счет каких функций он работает файловый кеш как вы можете знать ускоряет работу файла систему во много раз мы обращаемся к файлу и после этого уже можно считать что следующее обращение к этому файла будет гораздо быстрее на как найти ту логику по которой работает этот файл и кэш и функцию он вызывает и что происходит при его работе тут мы можем опять воспользоваться керна жарком и затратить функции типа блок типа с и так далее допустим тут можно увидеть что когда я не очищая файловый кеш у меня происходит запрос к некоторым функциям которые имеют такие вот сигнатуры и если я после того как уже получил этот кеш запущу еще раз команды работающий с диском то я увижу что в принципе ничего не происходит дальше можно добавить уже tracing других функций которые будут вызывать эти функции которые на предыдущем слайде были то есть там добавить больше фильтров в принципе это делается как тип как ваш арки только надо искать именно имена функций который вас интересует они типы пакетов и так далее итак в общем весь у нас нет обращение к большим устройству то у нас и гораздо быстрее все работает это видно по тем цифрам который каждый программист должен знать ответ загуглить а по фразу latency нами в программе но то можно увидеть что если мы читаем из памяти у нас там 250 микросекунд из создает а одна миллисекунда с жесткого диска 20 миллисекунд как видно но на порядок и тому подобные вещи можно смело говорить кроме того расскажу про одну историю из своей предыдущей работы это было внедрение шифрования в модуль ядра там были пакетики которые надо было каждый зашифровать и у нас было два инструмента 1 перекладывает пакетики это у вас второе их шифруют это vanguard общем мы взяли эти две вещи соединили их и захотелось понять насколько быстро это работает и в результате того как в кино шарки мы увидели что там поэтому стеклу всего лишь деталь 10 20 процентов добавляя совершил это стало понятно что действительно это позволяет пересылать и зашифровать пакет очень быстро в чем была проблема в том что у нас если брать просто в свой regard to пакет сначала заходил в ари-гард там заз пробовался в брился визерс вас обратно зашел в всв если там через бридж выходил и это все перепрыгивание буквально на несколько порядков замедляли работу обработка одного пакета тут получается просто пакет зашел сразу был зашифрован и все это было видно с помощью вояж арка можно было кита 3 составлять принты и так далее но понятно что принтер может замедлить и потому что это многопоточная программа модуль ядра который мы хотели чтобы работал на всех играх и ебашить это было ну довольно таки сложно керна шашкам это было просто следите доказать что но система будет работать и выдержит принципе то же самое что и обычно пересылка пакетов и так заключение на заключение могу сказать что в принципе керн shark это прикольная тема особенно тем кто использовал a shark раньше вам будет быстро понятно что и как происходит вы просто самое сложное найти название функции которые заходите запросить и пересев в тисе пи и так далее можете начинать с больших блоков то есть там просто api или белка так далее ну на домашнем ноуте у вас точно ничего не произойдет системой на productions фигурах конечно лучше сразу не трейси большой набор функции можете нас тут нарваться я пока не вырывался 20 равно не советую это делать и в общем после того как вы освоитесь с этими инструментами можете дальше уже смотреть как это реализовано в линуксе и добавлять и бпф функции то есть уже будет понятие функций у вас есть какие над затрещит точно какие аргументы эти функции получают и получили 1 делать аналитику типа flame граф и либо в зависимости от того какой аргумент и драму какой аргумент функции ядра можно мерить эту функцию быстрее и сильнее чем обычная функция сюда можно добавить ваш шаг свои любимые инструменты тут ссылки сожалению она заехала мне думаю кларку от будет работать так что можете я думаю что все таки там презентацию будет выдано и вы сможете и через копирование ссылки сделать спасибо я был рад вам рассказать надеюсь вы будете использовать кинул shark и выпив и так далее и попробуйте кирнос арка это просто ничего не стоит из вас есть двинуться ноуте или еще где то запускаете его и смотрите спасибо спасибо за ваши вопросы вот у нас есть здрасьте меня зовут андрей я мвд разработчик и соответственно вопрос у меня сразу встает аж какой инструментарий должен быть установлен на торги ти чтобы воспользоваться первым жарком и надо ли как то что то конфигурировать в ядре надо поставить треска м.д. вот frontend для f3 со обычно пакет ставится без проблем у меня на всех машинах в яндексе который я видел он ставился довольно спокойно и дальше уже можно найти и скачать прайс дат там будет создан файл стрессом и уже на своей машине где есть графический интерфейс можете там запустить и посмотреть эти трое со но погодите у меня на торги ти допустим там 200 мегабайт дискового пространства и столько же оперативной памяти вот этот треск м.д. он насколько большой что она выдает он очень маленький мегабайт 10 наверное потому что это просто по сути лаком обработка которая весь и посмотреть что внутри происходит она шлёт за просеке в ядро света ведре уже есть как правило во всех новых кадрах но я не встречал я дерге нету стресса там генерируется набор вещей который надо стать ведро то есть там можете сделать как синди покорного print к допустим и вот примерно о том же формат формате она работает то есть вы получите на выходе результат данных зависимости от того сколько функции вытрясите то но чем больше функций больше можете конечно есть вот там минуту трясите много функций то ну сам этот файл с данными будет большой но в остальном это легковесная система которая в отличии от верха который иногда ну не всегда можно поставить требуется кенди бак символы что такое ip-пакеты дополнительно тут просто по сути дела можно этот приз кмд написать для саму на ваши который будет просто выкидывать в систему дебаг эхо что-то там я хочу допустимых a function граф в трейсер хорошее описание как работает of 30 по этой ссылке там по сути дела во всех играх это уже есть она работает и ну доставит простейшую программу которая за вас в удобном в удобном формате закидывают эти данные в сизо и баков с вот вся эта программа на следующий вопрос александром спасибо за доклад меня зовут артём я занимаюсь базами данных в частности пас грессов довольно много и у меня собственно логический вопрос по игре сам давно часто используются страничные кэш ядра операционной системы с помощью кажется системных вызовов sic erit могу ошибаться в общем смогу ли я посмотреть более подробно как пост близ работает со страничный пешим нет очень интересно на тему системных вызовов то есть как вообще происходит взаимодействие что если возможно это история что мне необходимо для этого сделать но понимал от приведенных рекомендаций да вы сможете построить определенная как вас гая работает с файловой системой с дисками и так далее но дело в том что вы будете смотреть как вся система работает с дисками есть вас но пользователь дисковая подсистема это postgres то да вы сможете определитесь вас несколько вещей которые пишут диск то будет сложно просто на этом уровне но вы видите какая из-под стен работы с диском вот да это следующий вопрос как мне можно будет отфильтровать все вызовы то есть там до папе дал или там полно . грубо говоря чтобы было какое-то понимание что вот есть визир space в нем есть мой пост раз я хочу нападать только этот визир space ну то есть все то что проваливается на уровень ядра погреться да с этим сложно потому что такая простая вещь которая просто посмотреть как вот ядра это работает принципе там есть фильтры не всегда некорректно отрабатывают потому что ну допустим приходит пакет и еще непонятно кому пи дон принадлежит и так далее то есть не всегда это будет актуальная вещь всегда это будет корректно но зачастую такой bird's view там посмотреть потом примерно происходит с это можно будет сделать качество такого реактивного регионе такие спасибо большое спасибо следующий вопрос александр спасибо за мир такой практический вопрос первым вопрошающим насколько зависит скорость записи файлов то есть если подключить или фасту шару и туда описать насколько критично будет для сбора дамб для сбора данных 3 синди да я в качестве хранение файлов мы используем и f с ним шар соответственно высокой лестнице и так далее насколько это повлияет на получение данных и вообще возможно но смотрите это просто запись файл после дела пайпа который расположен в ядре какой спам скоростью она сможет передавать куда-то с такой скорость вы получите там если у вас очень много вызова функции и сама система умирает но по факту вам никакой разницы нет что вы пишете как может стать файл также будет и в 30 то есть никакой нагрузки не будет нести на это дело спасибо спасибо еще вопросы вот у нас есть по центру спасибо общем-то за интересную презентацию меня такой вопрос а правильно я понимаю что фильтры которые мы используем собственно при фильтрации они будут ограничиваться фактически аргументами функции которую мы тестируем к сожалению да если брать первый шар клеев 300 это по факту функции именно функция что-то более сложное и gpf вот там можно развернуться вопросы еще что-нибудь да кстати вот про ваш вопрос а главное не трясите функции f с как знаете где степи дампа сыч зашел делайте себе дом 22 порт и там она шьет на что она тебе данность"
}