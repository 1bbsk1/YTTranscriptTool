{
  "video_id": "-dZNNLsKxOk",
  "channel": "HighLoadChannel",
  "title": "Радости и гадости регрессионного тестирования вёрстки / Алексей Малейков (HTML Academy)",
  "views": 2449,
  "duration": 2103,
  "published": "2017-04-22T14:47:51-07:00",
  "text": "Добрый день всем как меня как правильно сказали да меня зовут Алексей Я работаю в HTML академии и сегодня мы поговорим с вами о регрессионном тестировании немножко с другой стороны нежели вы привыкли слышать этой осенью вот Небольшая предыстория мы совместно с платформой открытое образование запускали онлайн-курс посвящённый базовому HTML и CSS что он включал в себя этот курс этот курс включал интерактивные курсы и интерактивные задания непосредственно которые можно было выполнить на самом сайте и итоговый проект и на момент регистрации уже на этот курс записалось более 12.000 участников итоговый проект представлял с собой полноценную вёрстку которую нужно каким-то образом проверять И мы уже тогда понимали да то что это придётся каким-то образом автоматизировать и руками это сделать не получится мы взяли за основную технику которую мы стали использовать регрессионное тестирование вот если в двух словах для тех кто не знаком с этим это вот та самая любимая детство игра Найти отличие То есть сейчас при помощи всех этих новых технологий эта игра становится достаточно простой и нелепой и очень легко да найти все эти отличия Как это работает в вебе Как это работает в проектах допустим У нас есть какое-то текущее состояние проекта и мы сделали скриншот этого состояния это может быть скриншот отдельного компонента это может быть скриншот целиком страницы может быть какого-то отдельной кнопочки потом накатывают какие-то изменения и делается скриншот этого состояния невооружённым взглядом изменений практически не видно но машину не обманешь и при сравнении этих скриншотов видим то что изменения достаточно критичны и если это действительно нам важно да мы можем оценить Вот именно уровень различия и в зависимости от того насколько наш проект должен соответствовать дизайну насколько должен быть поддерживать Pixel Perfect это может быть очень полезно немного расскажу о бэкграундер технологий которые мы использовали у нас на сайте есть интерактивные курсы что они из себя представляют они представляют из собой блок с теоретическим материалом по например по какому-то CSS свойству или по HTML тегу или по какой-то по какому-то приёму есть редактор с кодом Где работает студент есть preview браузер - Это самый обычный iframe и набор целей которые нужно выполнить по данному заданию Если студент Выполняет все эти цели задание засчитывается как мы это проверяем на самом деле всё просто мы используем всеми нами любимый JavaScript анализируем изменения в дом дереве и анализируем изменения СТ элементов есть этого нам в принципе достаточно но иногда возникает такая ситуация когда какая-то фича в одном из браузеров не поддерживается ещё или не срабатывает например в том же фаерфоксе вот у нас есть проблема то что Letter не отображается о просто свойство засчитывается но студент не видит изменений и надо это было проверять на этот случа мы онива серную проверку которая работает на Phantom JS - Это тот же самый webkit только без какой-то графической оболочки который имеет жава скриптовый IP и при помощи него Да легко можно оперировать там со страницами Ну вот пример простого запуска скрипта на Phantom JS Да где в качестве там параметров можно передать в принципе всё что угодно что находится в наших скриптах Фантом ДСА там Мы открываем страницу в качестве урла можно передать Как реально существующий адрес в интернете так и какой-то временный файл хранящийся на на жёстком диске Мы из того кода который создал студент в редакторе вот то что он видит в preview браузер этот код из него создаём временный файл и натравлю на него Phantom JS есть отличный метод page vate который позволяет запустить на странице открытой любые скрипты собственно мы здесь запускаем те же самые проверки что работают и на клиенте но главный плюс мы знаем абсолютно всё об этой оболочке То есть фактически мы знаем браузер в котором запускается знаем все его баги и знаем как как с ними работать при помощи ко L мы обратно прокиды в приложение которое это всё запускалова отлов консольных сообщений на странице либо отлов алертов которые там всплывают Фантом это всё прекрасно позволяет делать помимо таких заданий за иния для НТО потому что они проверяют компетентность в том или ином вопросе насколько они действительно не только Да умеют копипастить свойства и значения Но насколько понимают как они работают как они влияют на страницу и что здесь точно также редакторы кода превью браузера но главный момент Они видят образец который должны получить и главная их задача сверстать как на картинке как это проверяется проверяется это вс Да здесь например этапы отражаются этапы работы студента Да вот он выполняет какие-то задания видит чем как его выполненная работа отличается от образца как это проверяется проверяется при помощи того же Фантом ДСА только используется другая его возможность мы снимаем скриншоты при помощи вот метода P render и дополнительно мы передаём туда параметры размеры скриншота которые хотим получить помимо Да получив скриншоты нам эти скриншоты нужно сравнить есть отлич консоль утилита IM Magic которая предоставляет большой Спектр возможностей для работы с изображениями начиная от кропа там ресайз изображений в том числе и сравнени сравнивает он среднеквадратичные отклонение для каждой точке по разным цветовым каналам в том числе и альфа-канал он высчитывает отклонение и вот выдаёт в качестве результата изображени в котором подс отличия приме запу просто и на выходе получаем вот два числа мы используем второе потому что именно оно измеряется от нуля до единицы и показывает уровень различия изображений Нам же в нашей задаче требовался уровень сходства ну как бы это всё легко вычисляется немного того Вот какие цифры получались Да при сравнении разного рода изображения это вот все скриншоты сделаны из наших курсов То есть это можно ВС действительно попробовать но здесь ВС очевидно разли действительно уровень совпадения достаточно высокий другая картинка да вот видим то что гораздо большая область отличается Ну тоже в принципе вполне предсказуемый результат третье сравнение вот на картинке мы видим то что у нас вся область закрашена красны потому что действительно они очень сильно отличаются сильно Да не очень потому что здесь в данном задании использовались CSS фильтры они не так сильно изменяют цвет да В каждой отдельной точке поэтому средне квадратичное отклонение полу небольшим поэтому уровень совпадения всё-таки остаётся высоком Да при том что у нас фактически всё изображение отличается с текстом всё хитрее потому что даже маленькое какое-то изменение жирности там лишняя точечка влияет на на изменение Да показывается он красным нам различие но при этом уровень совпадения остаётся достаточно большим потому что пустая белая область всё-таки доминирует здесь и не так сильно влияет Вот это не изменение вернёмся к системе прове проверки вёрстки что она из себя представляла мы подготовили для студентов макет Ну как вы видите макет вот для как раз базового уровня здесь нету каких-то очень сложных элементов Всё достаточно просто мы подготовили образец вёрстки назвали эту вёрстку идеальной с этой вёрст мы сравнивали работу студентов То есть это был наша Вот то самое Да вот если смотреть на регрессионное тестирование наше первоначальное состояние проекта студент нам промы получаем Трей скрин различий этих работ в каждом мы в этом макете тут очевидно есть п пять ключевых блоков в каждом блоке Мы проверяли разметку сетку и оформление и делали скриншоты при помощи фантома J сравнивали ВС это и одним из таких сложных сах моментов бы так это жая вфа и идентификаторы студент использовал мы не знаем какими тегами он пользовался он мог использовать семантические теги А мог верстать на обычных девах мы знаем только общую структуру то что здесь вот есть пять блоков по которые надо проверить и одной из первых задач которую мы решали это выделение этих самых блоков то есть вот чтобы получить скриншот для каждого блока каждого состояния решилось это достаточно про при помо такого доста известного просто по порядковому номеру мы получали нужный блок например да вот для второго блока с преимуществами вот мы выделили его при помощи Box Shadow Почему Box Shadow на самом деле Здесь тоже интересный момент Но все мы знаем то что поведение бордера зависит от того есть ли бокс сайзинг или нет да и он может повлиять там вёрстка может развалиться и соответственно Результаты будут плохие Алай тоже ведёт себя хитро если есть какие-то декоративные элементы которые вылезают за границы блока он обведённый размер блока Вот который хотим получить в зависимости от того нам нужно оставить блок в контексте Ну на странице и скрыть всё остальное Да мы использовали либо visibility hiden тогда страница имела первоначальный размер который должна была Да но при этом выделялся только нужный блок который Мы проверяли либо если нам нужно было скрыть всё остальное Да мы при помощи селектора Note скрывали все остальные блоки таким образом Да мы смогли уже проверять для каждого блока состояние вот которые нам были нужны и мы Ну собственно вот то что мы использовали в обычных заданиях Да загрузка каких-то скриптов на страницу и вот снятия скриншотов при помощи Phantom JS мы вот это объединили здесь то есть вот в методе фактически мы внедряли на страницу наши стили при помощи которых получали нужное состояние для съёма скриншота как мы искали разметку Ну в разметке на самом деле нам нужно было получить абсолютно чистый HTML Без какого рода без стилей вообще у фантома есть прекрасный метод он может не загружать по какой-либо маске там по регулярному выражению в данном случае ресурсы запрашиваемые на странице мы таким образом отрезали все стили дополнительно на странице мы Ну как бы ещё раз поверяемого всего нехорошего Ну вот для шапки сайта получилась примерно такая картина то есть вот скриншот той самой разметки Да и по этой разметке мы можем использовались так приблизительно возникла такая интересная проблема с которой мы столкнулись внешне абсолютно два одинаковые блока табличные данные вроде ничего не предвещает беды результат Вот такая вот картина и соответственно студент там ну Порядка 70 уния потому что он отправляет обычную таблицу валидный HTML код проблем никаких нет почему стали копать и обнаружили что вот на самом деле эта особенность вылезла только вот в фантоме ките в обычных браузерах мы не воспроизвели её наличие гах отодвигал строчки которые были ниже на там один или два пикселя и вот давало вот такие вот различия собственно Каким образом это решили решили просто мы для данного блока руками проверяли при помощи скрипта проверяли если есть х вс хорошо если нет мы искусственно оборачивали первую строчку в Х сетки с сетками всё было немножко интереснее потому что нам нужно было Да вот мы выделили легко достаточно эти пять основных блоков нам нужно было выделить уже сеточные блоки и скрыть при этом Да все декоративные элементы которые в данном случае там ни шрифты ни там какие-то позиция картинок нам особо не важна нам нужно было основное положение сеточных блоков как мы это делали мы постепенно углублять при помощи вот универсального селектора звёздочка тем самым мы охватывали и семантические теги обычные дивы Да постепенно углублять с каждым уровнем всё ниже и ниже и выделяли нужные нам блоки Ну на Первом уровне мы подсветить основных блоков дополнительно на каждом уровне мы скрываем все декоративные элементы которые очень часто располагаются в псевдоэлемента просто вот им ставим visibility hen чтобы Они продолжали занимать свою позицию но но при этом Не отображались переходим на второй уровень вложенности Да вот у нас уже появились эти контейнеры которые самые сеточные блоки которые мы хотели как раз и получить скрываем декоративные элементы и дополнительно мы скрываем всё что лежит уже внутри то есть оно нас уже не интересует там скорее всего не то все все уровни глубже visibility hidden они продолжают занимать своё место Да но не видны и нам не нужны тексты и шрифты заголовков мы их тоже выставили прозрачный цвет тексту всё получилась сетка проекта и мы для каждого блока Да уже снимали скриншоты для шапки получилась такая картина для подвала такая не совсем то что мы хотели увидеть но благо систему сразу разрабатывали гибко и мы могли конфигурировать На каждом уровне уровень вложенности здесь увеличили на один получили сеточные блоки которые нам нужны оформление для студентов оформление Это был наверно самым сложным для прохождения потому что они действительно бились за Pixel Perfect вроде незначительные отличия но критичные результат который не позволяет зачесть данный блок и данную проверку и на этапе проверки оформления было несколько таких интересных проблем с которыми мы столкнулись первая из проблем - Это различие в цветах вот здесь Внизу указано изображени Почему произошло Да Вот одна Одна часть левая часть картинки - это наш образец Да правая часть - это Работа студента и вот сравнение результата То есть это интерфейс который видел студент в чём особенность на самом деле идж маку для того чтобы сравнить два изображения необходимо чтобы изображения были одного размера поэтому мы работу студента и скриншот снятый с его работы прогоняли искусственно через операцию подго под оригинал и эта операция повела к небольшой потере качества то есть для в при сравнении двух изображений из-за того что цвета отличаются не очень сильно Image Magic не показал Да большого различно там средне квадратичное отклонение очень маленькое но на экранах с хорошей цветопередачей очень чётко было видно то что цвета отличаются и у студентов тоже возни непонятки что почему почему не так что Что сделать чтобы было правильно ре решили это всё тоже таким хитренький изображение прогоняли через эту же операцию уменьшения Ну фактически Да размер мы никак не меняли но потеряли немножко в качест качестве цвета и смогли получить вот да аналогичный цвет картинок другой момент фантому для того чтобы рендерить страницу нужны шрифты и он использует только те шрифты которые установлены в системе и первоначально Да мы не обратили внимание потому что на наших девелоперских машинках там шрифты стояли Но если использовать неправильный шрифт Да там какие-то строчки соскакивает на сервере и вс всё заработало вот та самая идеальная вёрстка которую Мы считали идеальной которую мы использовали как идеальную оказалось не идеальной потому как очень много было мелких ошибок например там неверно был снят неверно был снят межстрочный интервал Да и проставлен неверно там в смысле с макета неверно был нят цвет у логотипа бы там ошибка пикселе в размере прописано в общем вот такие мелочи так скажем много нервов расшатанной хорошо благодаря тому что да мы тестировали это на Большой аудитории мы смогли эти все Баги отловить и всё это усовершенствовать вот Казалось бы возникает такой резонный вопрос ведь вёрстка она сама по себе неоднозначно один и тот же макет можно сверстать огромным количеством способов но мы ставили перед собой и у нас стояла такая учебная задача Да чтобы студент повторил вёрстку оригинала он сразу видел все вот эти состояния которые должен получить он видел и разметку да и сетку как она должна выглядеть и как должно выглядеть оформление для каждого блока это позволяло нам там с большой долей вероятности Да прогнозировать что он пойдёт по тому сценарию который мы запланировали и мы могли вести его по этому сценарию э когда мы когда мы всё это дело проверяли первоначально мы ставили следующие планки Да 15 из семнадцати проверок у нас Мы проверяли собственно в каждом блоке три проверки разметка сетка оформления и дополнительно мы сетку всей страницы снимали и оформление всей страницы Итого 17 проверок для успешного выполнения испытания достаточно было 95% уровня совпадения на каждой проверке и Так с так как Да эта система запускалась первый раз и требовал Ну мы в итоге снизили до 12 из 17 проверок и до 90% совпадения в каждой проверке немного о результатах Да вот естественно из тех 12 тысяч которые записались на курс приступили к нему значительно меньше то есть там чуть-чуть меньше половины и для успешного окончания курса проходить итоговое испытание было необязательно То есть это итоговые испытание вот эта от вёрстка и проверка этого проекта это уже требовалось на оценку отлично но при том количестве участников которые Да прошли этот курс 520 успешно завершили итоговые испытания но особенно хочется отметить вот этих 10 упорных студентов которые довели до 100% Потому что когда мы следили э система особенно там когда уже приближался делайн студента использовали е как систему тестирования Это буквально они дописывает 30 пока это всё проверится смотрят как изменился их скриншот пишут следующую строчку кода снова делают архив В общем мужество героизм отвага вот можно награждать их смен в нашей системе это не единственные естественно инструменты регрессионного тестирования потому как эта тема сейчас очень популярна очень много всевозможных инструментов есть например Это аналог фантома только там внутри работает геко есть Magic это аналог име который в принципе работает нараз на базе фантома JS или на базе сра JS и позволяет предоставляет огромное количество инструментов для в целом тестирования страницы и под него вот есть НМ CSS и бап JS которые тоже работают на базе тех же фантома JS и и сра JS они уже направлены на регрессионное тестирование дают большие большой такой спе для регрессионного тестирования Ну и Одна из таких самых тоже известных вещей - это Яндекс gem которая вот на самом деле делает вообще магию там можно доводить до такой степени что создавать эффекты наведения на какие-то элементы снимать скриншоты Да в разны на разных платформах в разных браузерах В общем рекомендую попробовать не так давно был как раз доклад вот субботники вроде по Вот они рассказывали все возможности этого дни А вообще хочется пожелать вам не бояться Да использовать какие-то уже существующие известные технологии да Или подходы немножко с другой стороны потому как это может привести к интересным результатам интересным открытиям и вот позволить немножко нам всем Да улучшить отрасль Спасибо за внимание ваши вопросы Спасибо за доклад вопросы Вот вы сейчас всё Что рассказывали это всё-таки привязка к конкретной модели булочной и всякое такое То есть а если использовать именно регрессионное тестирование с точки зрения всё-таки Какая картинка конкретно должна получиться просто вот допустим Взять тот жет если Ну объект допустим Ну кабуд там поно рисовать обычно там прямоугольники там рисовать простенькие такие если использовать например свойства там Top Left И аналогичные цифры использовать в Трансформера Узер их будут по-разному рендерить и там разница может быть вплоть там до п пикселей и вот как вот в реальной жизни то есть не Какие тестовые задания простенькие А вот именно в реальной жизни ВС это можно использовать нуде какие у вас требования к проекту и что вы какие браузеры поддерживаете Да это первый вопрос от которого можно отталкиваться а во-вторых если приводить конкретные картинки Собственно как и мы в нашей системе мы не ограничили студентов в выборе вот использовать марджин или падинни это на их усмотрения Да они были так скажем движимый концепцией Вот то того что должны получить но например да вот Рекомендую вам попробовать дни которая позволит делать скриншоты для разных браузеров собственно виде в разных браузерах на разных платформах отличие и они вам дадут какое-то понимание того вот действительно вы к тому идёте или не к тому хорошо Спасибо ещё вопросы Здравствуйте хотел спросить вы связку ид маджика и фантома писали вручную или у вас была какая-то библиотека которая давала какие-то бинди на команды и мы мы писали вручную потому что нам больших задач от этого не требовалось мы просто на носе было написано мы спавнились быстро можно протестировать там сотню тестов И второй вопрос Вот вы говорите про сетку а её можно автоматизировать или это всё вручную делается Каким образом автоматизировать Ну в смысле что что вы имеете как-то там разметку подстроить чтобы искать либо ещё что-то то есть Я как понимаю все сетка у вас делается именно вручную вот по я говори Мы сравнивали с оригиналом идеальной вёрстки то есть там уже сетка была создана и вот для неё использовалась там определённая разметка в мле да То есть те же там дивы Да вот или там Илай блоки флоты Собственно как бы это и то есть мы как бы ну собственно вот здесь просто я не очень понимаю да Именно какой автоматизации с в данном случае да это была система сконфигурирована под Конкретно этот проект но она позволяла на там на для вот мы сечас на Академии тоже запускаем собственный собственную проверку итоговое испытания Да там система просто конфигурируется по другой проект там сетки другой другого уровня вложенности на каждом блоке там блоков больше то есть это легко настраивается Вот Но всё равно Да основное сравнение происходит с оригиналом то есть и здесь она эта система Да не позволяет загрузить абсолютно любой любую вёрстку Да сравнить е но как бы вот общи принцип регрессионного тестирования кото мы использовали проектах Там просто бывают сотни там тысячи страниц И вот вопрос как это дело оптимизировать то есть не будем же мы каждую страничку индивидуально расставлять вот не думали над тем как можно это а так смотрите на Большом проекте у вас уже есть текущее допустим состояние какое-то которое вы считаете Ну так более-менее идеальным и при выкладывании каких-то обновлений Да вы запускаете автоматически эти тесты и они вам сравнивают состояние там по каждому по каждому компоненту например и по каждой странице и в зависимости от того какой у вас там порог Вы допускаете да погрешность там допустим 90% 95% вы смотрите потом В результатах Какие страницы ээ у вас там не прошли эту проверку вот А по поводу нагрузки нуно сам по себе Фантом не очень быстрый мы сейчас смотрим на Электрон потому там там во-первых хромиум там уже поинтереснее можно и какие-то фичи использовать вот там вообще всё живенько прямо вот очень быстро здесь в среднем у нас при в не пиковые часы одна проверка занимала там ну одна проверка 17 скриншотов Да сравнения занимала порядка 15 секунд в пиковые часы там это всё в очереди стояло где-то в районе 30 секунд туда вот передайте микрофончик Спасибо за дола хотел спросить а вы не пробовали селенид и в разных браузерах Просто селениум он тяжелее и у нас была задача во-первых быстрого старта потому что были ограничены в сроках и под это выделялась там одна такая не шибко мощная машинка вот поэтому мы с селениум сразу не рассматривали мы использовали те технологии которые вот уже имели опыт с ними работы поэтому бы мы взяли это за основу вообще да как бы селениум он хорош беро тло было ресурсов СБО за док а как вы проверяли каким способом срн был тот или иной блок может быть человек набросал там по Абсолют например из позиционировать хороший ВОМ очень похожий на этот и в нём там были демонстрационные материалы и видео туториалы по которым их вели То есть это не просто вот садись верста и Да вот тебе Есть образец состояния Делай что хочешь нет о им всё равно как бы пропагандировать определённая Методика и скорее всего Если бы это было с позиционированию там возможно какие-то проверки у него бы стали отваливаться то есть там и какие-то блоки если он допустим да мы при такой классической вёрстке поддерживаем какую-то вложенность а у него абсолютом всё лежит на одном уровне на какой-то прове э б скро и у него ничего не отобразится и поэтому там будет совершенно другое не любят меня микрофоны да то есть просто проверки какие-то не пройдут и например ну тут тутки могли на проверить например Какие свойства там у того или иного элемента на самом-то деле не совсем мы этоко эче див который которым он сверстать как бы ну Мог мог ведь Ему же никто не запрещал как бы и мы не знаем то что вот это действительно тот самый элемент который нужно проверить что вы делали в том случае когда Говорите пожалуйста Дели случай когда например вы проверяли первый уровень ложности в Боде да А если у человека там ещё какая-то вязка в рапе Ну он просто на самом деле студент бы Да он просто не проходил бы даже первую проверку у него как бы не Нашёлся бы нужный блок то есть стало бы понятно что этот впер лишний потому что он на Первом уровне вложенности не нужен о нужен уже на втором уровне то есть ну как бы то есть это больше была проблема Ну грубо говоря да проблема студентов найти Вот то состояние и немного естественно мы понимаем что это не идеальный вариант проверки вёрстки Да но как возможность на каком-то базовом уровне Да проверить знания это это работало Добрый день спасибо за доклад у меня небольшое дополнение к вопросу который продолжение вопроса про Электрон вы упомянули А каким образом предполагается делать если НМ Jon уже безголовый а Электрон предполагает какой-то интерфейс то есть Опишите Какая идея была за вот на самом деле э Электрон можно запускать и без без веб-интерфейс Ну в смысле вообще без интерфейса мы уже даже там проводили тесты просто таком Silent Mode и он он делает эти скриншоты точно так же как бы просто там ну на убунте там тоже есть возможность запустить без то есть уже там гуглили эти варианты То есть это это есть такие как ещё раз называется мод этот режим там вроде как стоит параметр Show fse Show fse там у веб пейджа вроде или у браузера точно не помню сейчас не Спасибо Спасибо за доклад скажите вот вы качество вёрстки получается определяете визуальным картинкой и структурой HTML Да а всякие неочевидные вещи типа там каких-нибудь атрибутов Тап индекс или состояний посещённых ссылок или то что по хове появляется или при скролле как это проверить ну это такая действительно уже более глубокая проверка и ну здесь у нас такой задачи не стояло вообще тоже есть же много разных библиотек которые позволяют и парсить и HTML и CSS разбирать там и пост CSS позволяет это всё дело получать А можно это всё анализировать то есть у нас помимо Да вот этих онлайн-курсов на сайте есть интенсивный курс где точно также есть там итоговые проекты вот там мы уже подумываю о системе такой более глубокого анализа не только Да внешнего соответствия макета но и качества кода спасибо спасибо за доклад А что делает элементами с относительными размерами как их тестировать Ну в смысле которые в процентах заданы Ну либо в процентах либо ещё в каких-то величинах Ну во-первых да здесь у нас в принципе в этом проекте резины нет но можно задавать размеры страницы и если например да мы ту же адаптивную вёрстку какую-то проверяем мы знаем состояние макета Да у нас там есть на 700 пикселей допустим там на 300 пикселей просто открываешь окно в этом размере снимаешь скриншот и получаешь Вот то состояние потому что каждое промежуточное Ну можно проверять конечно но оно надо ли То есть это такие уже какие-то более субъективные проверки А вот действительно соответствие состоянием на брейкпоинт на опорных точках это всё можно регулировать именно размером окна который в котором делается скриншот Спасибо ещё вопросы Спасибо за доклад следующий доклад у нас будет через 25 минут да Через 25 минут и мы поговорим про вёрстку и ЦСС"
}