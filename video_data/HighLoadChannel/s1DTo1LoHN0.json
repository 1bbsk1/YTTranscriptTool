{
  "video_id": "s1DTo1LoHN0",
  "channel": "HighLoadChannel",
  "title": "Database Performance at Gitlab.com / Jose Cores Finotto (GitLab), Николай Самохвалов (Postgres.ai)",
  "views": 770,
  "duration": 2615,
  "published": "2021-10-04T02:31:02-07:00",
  "text": "солдаты гитлера станет ли анализ . jon boat and business for sale ночью beat of the drum обалдели зал он нанял вас слушаюсь улучшилась grounds of the best lounge белиберда и наступает сын tragen еще ведь талзин толку ты видишь выбор шин гитлер кендо логики нет ком автосервис андерс фронт soft and sales and all the way борис гордится он видел свою zeroes имя руки данный момент из комикса организме и поговорки устроили owens people working as a rule that свидетельстве сам дейта позво развития матки тела вера евреям компании и ставьте лайк опыт со спросите ничего не надо и эффективность старте компа ли вы обозвал гайдлайн за угол зонта и диско-зомби чарочку добавлю кам до янцзы pandemic из бирюлево вроде как раз аланов кобальтовые че нас чуркин калорий oshit нужный фокус ведь этот all of tanks кинг хочу вас экспресс али 7 причин hold купе бьют и мирных здесь соседи мебели добили фобия keyword tool гитлер инсайтов гитлер выше завис некий черный маркер показывает вам праймари wish патрули фары чай оказались импульсов трафик вижу то x-факторе но фрироллы новый баланс интервью the desert зазвал за на windows phone пусть и тетеньки среди заставишь алсу used for sale прудик benchmark ними узлом должен знать чуть-чуть и база fresh ideas for production подвинь узкие джинсы он родители за встречу oxydant до радар до мистера бека скорость заказник спать варды это близится партию даровать sol арестант навыки индекса марс собиралась класс собственники так что вы резина diseqc курс и я всегда до сих пор гиговая собран здесь машин за рынком ресурс блестки архитектура пришли не растрепалась так цивы яблоки свистком судей нас names алсу сборки не спал тоники и мудрость импорту съездов патроны покрывал и классно за счет уилер трафик desura вид волны targus далеки чудеса honda весь мир нужен состав сон orphans degradation вернули морковь и чую спор optima стены чарльз микоз и норды италийский вот седай направлялась разных а из травки китайский 10 раз варвар айда на ранчо optimizer сбор диспетчеры виден в трафик you sing sing ruv также видят чуток загибался подвигах и из кейсов лайки долбал сафаров долларов дубинин transaction могут так м я др valve иды де саша могут достигнуть workstation ноут или всегда сборка синатра затянуть уезда в 10 бит гдн optimizer famas applications эмбер сайт и набрать полный газ на выходе h-сервис warmia park майсен give all дефарж normal дистрибьютер up the new year увеличенными праймале асв твой шины на сценарию that are secure лезешь и у вас оригинал формы анализе stark surfer тайный и баланды start at the distance and dice зато прометею или ползать export выглядим фармящего кисточку кросс а за высшую валер on sea was haben но не станет адрес похер из на полный fashion king гитлер и на кого в moms кулаки горки выйдет он перформанс яндон через плавного consultants and development and daxter отвечать хинди и promising повысился из армии и этот анус time of course and then our sales and service agency in sand sun to me with alina and great айпад и стадиях комментах маргиналами 0 comments из компа на сцене водевили мы здесь lucky fields накида не беру и портами от диска метода беге не стоит в выявили кризиса застонал от него глаз вот сам таймс сантиметра stinger сильно звук архив facecam а был там с нами экспорт органа лизис взяв курс на радик один ползунков на миде на сайт лишь возврат работал виктор ильич орк simple and sunset in various таки обычно ему соло портфель с диодом танчики all the балки за балды его не сидят рыбаки новость 500c пентхаус и сколы на ощупь он seller иди стань лицом вере windows intune resources on screen и золото сау это дефолт стоит мы сотворили этот вид и five должен авентин талзин танку и и достигается дмк пресс андрей чур одежда подписи ехать моралиста других и вернулись к швы и статусом там здесь statements а до я уолден bad вы имеете investigate на сито для леди кейтлин да и одежда frequency фундамент языки высушен с все и of these states is simple удобства для также горки мы знаем из леса индексе ртс of which had so many times резинку и сквален select доллар ван 2 с лаком далеки еще не груби coat в или файлы so she was он будет это весь от выпивать и недель учу вас пальца grace do you like this has a gun to switch to rush я просто фалик sorry for technical issues извините за технические накладки я видел видео screen sharing был медленнее чем должен быть я ну давайте на русский перейдем чтобы я просто постараюсь объяснить по-лучше что к чему и немножко вам было понятнее и может быть пообщаемся какое-то время нас останется до сложная организация поэтому ссоре еще раз давайте переключим на мой экран пожалуйста дайте мне управления о отлично тут тоже лагает на всего 2 секунды вот лет он все огромная значит как хасси уже говорил от было не техническая часть на самом деле она может показаться не очень le mont на и какой-то маркетинговый на самом деле он очень очень важно то есть girl up компания которая ремонт работает уже очень много лет то есть много лет сильно docs вида да и большая проблема в том что все распределенные и вот допустим разработчику нужно что-то там проверить какой то запрос sql оптимизировать и но у него нет доступа соответственно кого-то просят этот кто-то живет на другом континенте все откладывается до завтра потом ответ приходит вот так вот дни теряются да то есть обычно когда мы в одной комнате сидим мы можем все сесть и разобраться да да это обычно тот кто с доступом у него нет времени тоже частая история но в git лобби так как распределенная команда очень важна именно и часовые пояса плюс удаленка очень важно тот факт что нам нужны какие-то артефакты и какое-то асинхронные общение и как можно меньше ожидания других людей вот этот момент я давно его прочувствовал еще только ведадо но сейчас мне кажется еще больше компанией подвергаются таким же условиям да и поэтому вот эти ботаники процессах оптимизации производительности как раз мне кажется инструмента которых мы сейчас поговорим они как раз и позволяют устранить один из них это плоскость check-up то есть он пару раз неделю собирает проявляет здоровье подвеса то есть мы там собираем блок здоровье индексов если не валидны индексы и так далее так далее если проблема не вылезла не вылезли какие-то таблицы с 4 байт нами первичными ключами общем очень много всего про этот инструмент можно отдельной доклада посмотреть но главное что он привозит артефакты все на одной странице всегда можно сослаться вот у нас мы видим проблему он дополняет мониторинг более таким глубоким анализом конкретных база дань ческих пожгли совах вопросов тут конечно плохо сейчас задержка еще больше да я вот перелистнул а что у нас тут тоже сеть плохая да вот почему я не вижу своего слайда получается у всех докладчиков такая давайте оптимизировать эту этом си у нас отличный фрукт у нас куча людей в зал может прийти да ну я не могу вам доставить информацию во время то есть я вот при листвы вот пожалуйста да и мы ждем сидим окей вот наглядная различие лет инсеев руб от хорошо я постараюсь что вообще без слайдов выступать что ну там какие-то слайды будут печи ски появляться значит у нас такие скучные подробные очень графики которые конечно как бы выглядит скучно но извините меня если вы делаете эти запросы руками это еще скучнее тут хотя бы у нас есть такая длиннющие простая всяких таблицу которых мы видим что к чему случилось алвеш check-up он подсвечивает разные проблемы то есть вот например вот этот картинка с неиспользованные индексами у нас тут везде нолики мы видим здесь плохо вин мы выйдем там суну total сверху мы видим сколько мы можем сэкономить если мы подробно им эти яндексе процессе бурной разработки а насколько я знаю гид лобби сейчас парализо в день то есть это прямо-таки очень такой связь идея очень большая скорость всякое может остаться соответственно если индексы не используются ну мы можно зачистить но как всегда есть некоторые но во первых нужно проверять или реплики потому что там индексы могут использоваться и под горчаков он проверяет реплики видите вот тут столбиками тут все хасты которые есть второе индексы бывают нужны там раз в месяц поэтому если у нас статистика очень молодая здесь оно было шесть месяцев она очень старая была статистика вы видите ну там в углу описано 6 месяцев статистика но если бы она была меньше 30 дней там бы был в предупреждении что осторожнее может быть вы сейчас дроп лития первого числа к аналитикам или кому-то вам понадобится этот индекс но в git лобби все еще сложнее потому что у них есть больше 100 тысяч инсталляцией и они не все миссии разные могут быть то есть какие-то индексы которые ну а продукт 1 и вот он выкатывается на 100 тысяч мест и одно из них нет лобком и это очень сложная ситуация то есть весь и коробка и из и к были облака да и south и а индексы вот этот набор единой и если мы будем означать это тоже увеличение сложности до соответственно вот этот табличка она долгое время показывает некоторые индексы которые в которых мы не уверенны что мы можем капнуть потому что возможно каким-то сетапом вот например там вашим они еще нужны то есть это реально сложная ситуация и я не знаю как с ней быть кроме как до всех довести чека потом все эти там сто тысяч отчётов склеивать в один но это такая гигантская задача которая пока не решена есть хотя показывал как про me fills можно там запросы смотреть вот этот основная purchase the statements анализ макро анализ когда мы всю нагрузку целиком анализируем и там видно исторически хорошо когда там спайки по total time пополз по чистоте вызовов но в чьи copy есть информация в глубь то есть можно увидеть каждую группу запросов разные характеристики то есть мы взяли все is the statements перед statements это стандарт для подвеса анализа запросов да и мы видим там duration общее количество запросов между двумя точками во времени общие и так далее так далее сколько там хитов буферного пола сколько чтения извне в буферный пол но мы еще делаем дополнительно дифференцируем подумалось по двум метрикам во первых по времени то есть просто разделили на расстоянии во времени между этими двумя точками и получили если пополз это будет сколько запросов в секунду это наш экипаж если мы берем тот алтай мы делим на время мы получаем секунды в секунду это мой любимый метрика который означает сколько каждую секунду секунд мы тратим на обслуживание вот этого запроса если бы у нас было одно ядро и это был бы больше 1 секунда в секунду но это мы лежим точно соответственно если нас 90 der и там всего одна секунда в секунду но у нас есть такое время то есть мы грубо говоря у нас есть мощности такая вот некоторая очень абстрактная величина которое позволяет чуть-чуть понятия что у нас вот каждое место каждого запроса в нашей нагрузки какое оно да ну и так далее мы можем там поток хитов сколько байт в секунду ситец а там ну в буферном поле сколько читается в него и так далее это очень интересное упражнение можете тоже попробовать просто вот так вот развитие и осознать каждую из метрик в секунду но второе тоже тысяч не все мы делим еще на количество запросов ну конечно calls если количество запросов развить на качество запросов будет один я пытаюсь внимание публики увернусь то что один понятно да если время разделить на количество запросов получится как раз нашел it and see то есть наше среднее время выполнения запросов среднем по больнице для этой группы это очень важная характеристика если там оно там 0 1 миллисекунда а у нас этот запрос видно что грузит сервер path to the time много ну скорее всего вопросов в африку люси да то есть нам нужен частотность уменьшать за счет кэширования или типа того ну то есть вот за счет таких штук а 4 там строчка это проценты просто какая доля по этой метрики в общей картине у этой группы запросов и таким образом мы видим полную картину за счет этой табличке мы видим полную картину для каждого до каждой группы запросов 3g состав макс и мы можем намного лучше понимать наш workload как он себя ведет на на конкретном оборудование в конкретных условиях но ясно что здесь понятно минус тут нет исторических данных вообще то есть мы все равно должны смотреть мониторинг что понять где какие спайки то есть этот в моменте мы касарес анализируем до совмещая эти два подхода мы начинаем лучше понимать что вообще происходит мы еще кстати вот пальчик об инструменте мы еще агрегирует переходим на следующие уровни то есть мы ну вообще this statement уже сак реагировали да то есть они называют это нормально из тыквы с если по исходникам смотреть выкинули параметры получили группы запросов у нас вот есть 11 запрос есть другой сколь запросов если выкинув параметр мы получаем одно и то же заменив их на доллары 1 доллар два и так далее мы считаем это одной группой никого не интересует на этом уровне что могут быть разные планы выполнения вообще и по сути совершенно разные запросы хоть они выглядят одинаково ну на этом уровне вот на пляже состоит на с уровнем мы оставляем как есть всего но интересно мы поднимаемся еще на уровень выше и так называемый анализ по первому слову он подходит только для тех у кого рынке да ну это большинство к сожалению я у рынке очень не люблю с одной стороны с другой стороны очень люблю потому что они приносят очень интересные задачи по оптимизации ну гид лап он написан на ruby on rails то есть этого рынка большинство запросов они голые там select insert и delete и так далее то есть мы можем взять первое слово среагировать и получить чье-то станут чистую долю вы такую долю по опять же стад системным каталогом не увидите увидим долю select of долю апдейтов долен чертов в общей нагрузки вот здесь видно что селектор 94 процента было вот на этой ноте конкретно допустим апдейтов 2 процента это пополз по метрике calls если по total time там другая картина 68 процентов select of и уже 10 процентов по апдейтом то есть апдейта занимают два процента пополз но 10 процентов а тот алтай опять же вот это вот он смотреть эту картину это очень полезно вы начинаете понимать какая у вас какая вас природа нагрузки и это еще не все мы в конце концов игровым полностью но это многие делают и получаем одну группу метрик это вообще все да то есть надо понимать что перед 16 - это не совсем все потому что там есть обрезание по перестал светлость . макс насколько я помню детали 5000 стоит дефолт по моему да и и довольно много но там все но иногда хвостик обрезается то есть мы что-то можем потерять кстати под газ check-up следить за этим вот у нас два snapshot а из предательницы мы смотрим а как там поехала если расхождение по запросам пришли ли какие-то новые и вышли ли какие-то старые если это число большое там тоже будет предупреждением что типа мы напрямую эти два snapshot а дельты по ним считать не очень-то можем потому что они разъехались тут в общем это интересно то есть в мониторинге все это как бы игнорируется вот то есть мы там думаем об этом картинки строятся и особо не паримся вот ну пару слов о том что вообще вот кроме check up of что дальше да то есть после того the little up get up очень важные для нас клиент доползли сияет для моей компании и вот оптимизируя производительность для разных разных клиентов причем когда люди в разных точках мира и так далее я понял что узкое место на самом деле todos оптимизировать сначала процесс об оптимизации то есть процесс оптимизации он очень не оптимально то есть мы ой очень много ручного труда очень большие ожидания люди не могут исправить сами они постоянно нас спрашивают у тех кого есть до какие то знания про базы да и ответом вот на эти мысли как раз это то что чем мы занимаемся последние два года это по сути мы полностью ушли в тонкие клоны и возможность быстро получить свою независимую копию базы проверить на не какой-то там запрос проверить на не какой-то индексы и выбросить эту копию соответственно как раз и упоминал сейчас база гид лобо 14 терабайт она клонируется там пять секунд за 10 за 20 вот и клонов бывает одновременно штук 30 люди с ними работают параллельно причем уже не только люди я сейчас об этом тоже немножко расскажу соответственно идея в том что вы больше не ждете не только другого человека который из доступ к пруду вы драк разработчик например а еще вы не ждёте новую машинку чтобы оно поднялось там вы там что-то делали что-то при проверяли там троп далеко эту колонку там и vacuum food они запустили все данных этих не то вы решили актер надо было немножко иначе проверять у меня другая идея оптимизации а в эту копию базы больше уже не можете проверять все упрется выбрасывать в обычных условиях но с помощью тонких клонов о которых сейчас немножко расскажу вы можете сделать разрезать за те же там 10 секунд исправлять все заново и это работает гид лобби как раз то есть мы говорим о том чтобы вот когда разрабатываем и тестируем у нас маленькие базы это большая беда потому что маленькие базы маленькие размеры там совершенно другие планы другая производительность вы не можете вообще ничего понимать по производительность маленькие база вам нужно было размерная базы и но на всех не хватит то есть сотни работ не разработчиков гид лобби мы не можем всем каждого каждом выдать свою дев копию а кому-то и много потому что некоторые работают очень интенсивно разрешаю разные задачи там за один день можно кучу всего обсудить соответственно заканчивается все тем раньше так было гид лобби и это так у многих сейчас тем что настоящие настоящие проверки происходят только напротив либо на стайлинге который тоже отстал на год или два вон там в 10 раз меньше ну или там 5 раз меньше и у него тоже не те ну другие другое поведение и мы стараемся реализовать вот эту идеологию я узнал о том как называется совсем недавно называется shift лифт testing то есть вот задвигаем влево да то есть мы как можно раньше в нашем devops цикле раньше делаем вот эти проверки производительности и ну у меня вот картинка среднем была такая в голове как здесь да то есть у нас раньше устои если смотреть с точки зрения базы у нас в деве нет полноразмерных босые у нас девку цей он как бы скукоженный и вот как слева на картинке да когда мы приносим вот эти клоны тонкие полноразмерные любой разработчик может им воспользоваться с конечно же с оговорками про доступ к персональным данным потому что не у всех далеко есть доступ то но если мы это отдельно обсудим сейчас-то у нас становится вот это выровненная картина у нас дев iops сбалансированы и возможности короче справедливость восторжествовала традиционного в традиционном подходе сейчас появится слайд в традиционном подходе у нас обычно есть какой-то набор тестовых стендов полноразмерных и кучка людей вокруг каждого потому что ну так тогда дорого развернуть там 10 терабайта ли там даже даже трогать развернуть долл 1 терабайт развернуть обычно занимает час в лучшем случае половина иногда два часа то есть среднем 1 2 терабайта в час но скорость разворачивания и таким образом получается что вот у нас базой там несколько людей они как синхронизируется тут поработал с этой копией не поработал или же вообще у них нет доступа к разработчики они даже не мечтают об этом чтобы проверить на таком полноразмерной копии они даже не знают как иск вели себя ведет они его видели только у себя на маленькой базе если же мы возьмем сделаем так что у нас физически будет одна база но у нас будет возможность делать логические клоны вот эти тонкие клоны за счет копи он райт здесь используется ctfs файловая система до который предоставляет это плюс это без лап это наш продукт он open source ный любой может его использовать соответственно этот продукт позволяет просто черепа любому человеку сказать данный клон вот тебе клон через 10 секунд и вы можете на нем проверять свои запросы одна оговорка нельзя делать нагрузочное тестирование потому что нагрузкам тестирование мы утилизируем все ядра и начинаем мешать всем остальным это очень не хорошо и году это другая задача там все-таки нужна отдельная машина с той же файловой системой что и на проводе и так далее напротив гид лопата по-прежнему более традиционной a file system x 4 соответственно здесь у нас в лаборатории ctfs и это еще не все он постоянно он по сути является репликой продакшена то есть у нас через вал shipping через бэкапы через с котла в google cloud находится у нас накатка вал g делает вал fitch если кто знает во лжи то есть вот backup опасную новые валы всеми приезжают соответственно нормальной ситуации дтп слаб отстаёт от prada всего 0 секунд там 20 30 то есть это реплика с небольшим дел с небольшим лагом иногда лаги увеличиваются когда очень большая нагрузка очень большая нагрузка на самом тобой слеп там возникают часовая на отставания но это все на фантастика иметь очень свежие данные соответственно мы можем попросить то получить тонкий клоун не только за 10 секунд а мы можем еще выбрать точку во времени и это уже несколько раз спасала например к во время инцидента что-то произошло с продам сделали hotfix то есть производительность восстановилась нам интересно что это было и как сделать чтобы это больше не старалась мы идем дтп слаб и говорим дай нам два клона один в середине инцидента один допустим доли там после и мы сравниваем поведение explain каждого запроса вот проблемных запросов которые мы получили мы можем посмотреть как они себя вели в конкретную точку времени вчера там и 12:30 и это очень серьезный инструмент прям дельты смотрим работаем с двумя колоннами и смотрим какая разница ну это общая концепция копию райт я не буду на этом останавливаться я по нему это за его все и так понимают да у нас со временем уже не очень хорошо так я промотаю здесь небольшие небольшие скриншоты то есть под поверх спонсорской части у нас есть еще коммерческой части vitlab является пользователем соответственно у нас есть так называемый джобот как раз немножко про безопасность то есть у разработчиков у большинства разработчиков нет прямого доступа к персональным данным как production ну и так далее они работают опосредованно через работа который рисует мою давнюю мечту я не хочу чтобы люди ходили ко мне и я был завален простыми вопросами я хочу чтобы какой-то робот отвечала на простые вопросы как будет себя вести этот запрос доминик становилась на продакшене может быть это апдейт то есть это серьезный такой это изменение может могут быть и может быть даже еще запрос а что будет с запросом если мы применили такой-то индекс соответственно этот бот очень хорошо уже там больше стать человеком пользуются регулярно и по мы уже 160 и здесь он отвечает на базовые вопросы как себя будет вести запрос xp на лайс люди не видят данные они видят план запроса с визуализацией то есть у нас встроено визуализация трех видов депеш до либо 52 до eveline графа еще и еще есть кнопочка сша сейчас вы видите да правом верхнем углу кнопочка шер она была сделана специально для girl оба потому что это специфика гид лобо то есть они стараются информацию по умолчанию публиковать если там нет персональных данных запрос запрос допустим касается адэшников только самого гид лобо никаких клиентов стоят на такой запрос разработчики могут посеять пойти вышлю обсудить конкретный ссылка и и она видна даже вам то есть вы можете посмотреть общего котла по разработка очень акт открытая как вы знаете вы можете посмотреть у них происходит и вы там в обсуждении производительности конкретном эскильд иногда можете встретить ссылки на пол версия и конкретно вот эта кнопочка широ отрабатывает еще мы поняли что нужно переводить баффер собой ты это гораздо понятнее становится всем то есть мы вот хиты ряды умножаем на размер страницы 8 кибибайт из пишем просто вот здесь сколько у нас там хитов вот там ведут маленькие числа какие-то 7 мегабайта мы и рядов там 5 и это понятнее становится то есть это вот этот запрос должен быть быстрым он является быстрый там на хотят он на чтение немножко потратили да там видно да плюс у нас еще есть новой разработкой уже не буду там если кому интересно найдите меня обсудим мы стараемся стиме шин для продакшена еще для x4 сделать потому что ну все конечно хорошо и мы ориентируемся на батерс но тайминг тоже хотелось бы понять вот бывает он там индекс в лобби занимает там 10 минут она продакшене три минуты построении индекса и мы сейчас создали дополн дополнение которое позволяет эстимейт для продакшена сделать на основе разные статистике который check-up кстати привез таким образом а это еще не все последняя вещь как я упомянул не только не только люди пользуются дтп слеп в кислоте в том числе и уже и другие роботы пользуются этим там этими роботами так сказать то есть если кит push в мир чикаго есть и в git лобби у нас какой-то разработчик привез миграцию то есть в 5 часов я буду рассказывать про миграции так называемая миграция них не очень хороший термин но прижился то есть изменения схемы базы иногда изменения достаточно жесткие самих данных если есть миграция в кабину вкус люди комментов это меньше класть и автоматически будет в безопасном специальным окружение с помощью тонкого клона она будет проверено то есть вы увидите как она себя поведет на продакшене ну production с небольшим отставанием типа там час назад таким образом намного лучше поймете применится ли она по-настоящему правду и вот он здесь нет скриншота но забавная история закончу этой истории когда отключили это в в работу там через пару дней человек который его версию гид лобо создал дмитрий запорожец с харькова он вырос был пойман этой системой потому что его умерший квест содержал некоторую ошибку как выяснилось не хватало какого-то триггера который почему-то был на продену не был в гите описанной схеме и как раз его умерший квест его миграция она упала database ли потому что вот разъехалась схема и это была поймана даже до сталинграда всего да и соответственно очень легко по какой такой легко правится но это было очень приятно видеть от был первое срабатывания где-то в начале февраля еще было первое срабатывание именно вот этой новой фишке привоз тонких клонов все это наша новая тема на которую мы в этом году осваиваем собственно все вот я надеюсь она донес вот этот главные мысли которые которые у нас лизу ются теперь вопросы можно можно вас и привлечь на английском до вопрос есть асессоры иван шагин датой топ-3 нашим я извиняюсь мы прослушали своими огромную дозу очень крутого контента поэтому нас осталось не очень много времени право на вопросы по возможности вопросы краткие николай можно будет найти в виртуальной дискуссионной зоне ато давайте пару коротких вопросов возможности спасиб еще пять часов доклад про миграция конкретно tanks порток твой след в его part of you time set и волейбола в шопинге . and like how to get lots дизайн сэнсэй нисида развал response график android m и b файф хандред он этап buy that all time goes с бандитами создаст like отсохнет limited x экзо клиника настоящий добрый день виктор зовут меня x5 вопрос такой магия вот все которого описали по параметрам и папа игре на грин план как-то применяется нет вопрос по глен план у нас было пару вопросов таких же вот это третий пока никак спасибо но можно сделать"
}