{
  "video_id": "Of-xg6OKpLg",
  "channel": "HighLoadChannel",
  "title": "Отладка производительности приложения на Erlang / Максим Лапшин (Erlyvideo)",
  "views": 2298,
  "duration": 2648,
  "published": "2017-04-22T14:48:15-07:00",
  "text": "и программиста у нас ножка специфика есть значит сейчас мы поговорим проблем именно про мультикоры прежде всего с программой когда она запускается больше чем на одном ядре это далеко не всех касается то есть например люди которые пишут на java скрипте они проекты пройти провели в принципе знают они думают местам самый складывается но как правило за там за любым проектом написано мадам на javascript те питания стоит какой-нибудь код написанный на осях на эрланге который как раз уже вас multi-core например там база данных по сгрыз или выбитым кью который вполне себе запускается на кучей ядер и работает работает уже в multi-core режиме multi-core платформ не так много это си плюс плюс я в лонг глуши sharp вот поэтому некоторые специфичные могут быть какие характерные проблемы которые очень нетипично для линейного кода для обычного ядерного кода проблема такая что программа начинает загружаться все больше и больше в культ менты не начать падать скорость обработки особенно добавлением новых ядер то есть вы покупаете 2 процессора лучше не становится только хуже становится и процессор нас не загружен скорость обработки падает что-то происходит вот здесь как раз мы и попадаем в веселую ситуацию которую практически невозможно воспроизвести на компьютере но девелопера потому что например нужно двадцать четыре ядра таких букв не бывает и в отличие от как раз предыдущего докладчика мы очень часто работаем мы заходим кассиром клиентам на продакшен сервера потому что и все плохо не говорят срочно помогите нам у нас время реакции например может быть там пять-десять минут чтоб срочно зайти посмотреть потому что проблема возникает только в часы пик часы пик это там два три часа вечером причем в чужой той зоне и нам нужно быстро понять что происходит с нашим софтом чтобы больше такого клиента не повторялось значит вот что раз да мы говорим про multi-core это прежде всего там где нужно состыковывать клиентов одновременно это важная штука потому что если такой по проблематике нет как как как поддержание в памяти стоит а клиентов которые еще у нас онлайн то возможно там не нужны какие-то ситуации с multi-core а значит о чем мы сегодня как раз поговорим это на примере одного тикета значит что у нас по нашим обмани чтобы было так вот более живо что у вас произошло мы делали-делали наш код и в кайт мент нам пришел клиент играть ребят я войти от обновился полгода не обновлялся молился у меня все все плохо ничего не работает там кластер подняться не может сервера загружена на сто процентов видео не раб и счет все плохо мы пошли разбираться в что же там происходит причем это проблема возникла сразу то наверно парочки клиентов но у них была очень разные разные симптомы но как бы объяснение было одно ребята все плохо ну что происходит как бы с чего начинаем сюда когда заходим на сервер заходим на сервер запускаем чтоб чтобы посмотреть ну что мы здесь как правило чтобы хотим видеть что например человек раскидал affinity папа affinity сетевой карты до если там например если человек воткнул 200 гигабит ную карточку и начал натравлен наливать трафик на этот сервер то классической картины это когда на первом ядре у нас все красненькая уперлась до конца и дальше уже ничего не будет потому что сетевая карта полностью обслуживаются первым ведром процессора по умолчанию и в таком режиме с вредны процессор опирается примерно в 23 24 гигабит и дальше ему некими возможно дальше разогнать обычно скрипт запускается цветом который идёт к сетевой карте который раскидывает affinity вот именно гигабитных каналов карты по разным in der мы все становится хорошо также здесь хорошо видно что это сервер скоро сдохни потому что не включен swap особ на продакшн сервера это первое что мы обязательно требуем выключить потому что свапа на продакшн сервис сегодня быть не должно никогда ни при каких обстоятельствах потому что если свапа нетто но все просто тихо спокойно сдохнет там киллером а если своп есть то вы не сможете словенец она загружена сервер до тех пор пока наконец своп до конца не забьется его не бьет твоим киллером а в этом случае как правило быстрее через скрываем прибудет сервер чем пытаться за него залогинится вот лучше лучше как бы быстро и конец чем обучение без конца значит в штабе нам ничего не видно да что происходит внутри по программам чуть не работает у нас у нас есть все яды не загружать это картинка с такой штуки как teller экзотическая штук ищут у intel и не было таких многоядерных сильным значит мы зашли в топ здесь нагрузки никакой нет но программа вот наши слов дальше не работает какая-то беда беда в ранге внутри используется модель акторов модель акторов это один из способов программировать код который работает на многомерном режиме значит писать продакшен код бизнес-логику использовать при коте примитивы который дает 3d обычные это безумие мучение это практически невозможно и можно этих индексах повеситься вот поэтому люди люди уже примерно там лет на 50 думаю так как же так это сделать чтобы вот было было было поудобнее тесно actor это один из подходов когда вся память делятся между разными между разными таким вот микро процессе коми который находится в ирландии они враги тагаз в процесс и хотя это вот ну-ка рутина actor это все примерно об одном и том же посмотрим что происходит значит actor это микропроцессоры разбиты полностью по данным в ирландии нет проблем с потерей у тех утюг и памяти как правило вся коммуникация помощью сообщений начало ланге есть и мьюту был дан мы это здорово облегчает как раз коммуникаций факторов потому что между акторами нет шаринга данных то есть там нет такого что на одни и те же данные ссылаются 2 актара но это если по простому объяснять и вторая важная штука которая договорить это то что в ирландия из такая к редукции вот в ро нельзя посмотреть сколько тактов от артиста какой то какой то вот этот актор отработал там показывается редукции о редукции это вызов функции учитывая что варлав г нет такого явления как и цикл то практически каждый оборот цикл это вызов рекурсивной функции то есть редукция мы можем посмотреть кто из актеров и жрет например нашу кто кто загружает там какие-то и др мы запускаем youtube youtube это стандартная программа варлав для который показывает кто вот этих редукции больше всего живет например кого-то увидели что с ним дальше делать какой-то процесс поднялся мы запустили профилировщика встроенный ланговски f профи а честно говоря их их пользу на грани на грани на грани абсолютной бесполезности потому что они опять же меряют по редакциям достаточно например переписать код использующий модули лист на сенокос использующий модуль maps тогда количество редукции пропадает а количество тактов которые реально были потрачены примерно тем же самым в итоге и вправду другую картинку и за ним нужно очень долго ходить то есть они дают примерно вот серии наверное проблема вон там посмотри покумекай попробуй посчитать ну а я еще и очень сильно искажают еще важная штука с которым мы столкнулись это с тем что чтоб вообще показывает не совсем то что происходит внутри где в том что or long очень активно и агрессивно борется с операционной системой именно сама виртуальным машинам он жжот так ты впустую до того чтобы его не снимали для того чтобы его и вот его 3d вот который непосредственно enough свои 3d чтобы их не снимали шиллинга поэтому что говорит вот ваших там по ваш ваш мир sonic живет 75 процентов всех ядер мы заходим до 75 процентов живет на самом деле загружен только до 5 процентов потому что фактически могут могут сами scheduler и внутри у таиланда работать например тама тычет она на 2 3 в холостую есть механизм виде орлан кстати стикс которые это вызов в статного модуля который которого можно собрать реальные данные по загрузке как раз всех этих шутеров этого мы тут намерили мы даже нашли какие-то предположительно perfumes проблемы вроде как по правильно все равно сеть работает вот цыпы у нас не загружены ничего не понятно значит как же все эти вообще акторы профилировать что же с ними дальше делать чтобы было понятно очень частая вещь это бутылочном горлышке то есть вот на том примере которая сразу показал в пятом не совсем та картинка изображена но если при нас одно ядро полностью загружен остальные не очень то скорее всего наверно проблема именно в том что вы слишком много положили на одно ядро например мы взяли один actor у нас тут он будет заниматься все работы с диском от в ирландии по умолчанию для практически всей работы с дисками серии там пойдет пойти например там к файлу спросить у него и встать и делать вот вся эта работа доверяется одному синглтон достаточно одна муха радует всей вот пачки на диски на сервере лечь и вы не сможете уже больше сделать и вставки на одном файле если про это не знать как про это как с этим разобраться поскольку у нас все коммуникации акторов она бы использовать сообщение там и с пикируем очереди сообщение перебираем все процессы в системе как это например сделать в комнату я не знаю можно ли там перебрать все грузины узнать кто из них вот там сейчас чего-то ожидает новый лонг и это возможно именно за того что у каждого автора и своего через сообщение входная дверь процессов забираем мисочку или мы сортируем baby смотрим собственно говоря чем занимаются топ-10 процессов вот что такое перегружен да у разных проектов это по-разному для нас например 2000 очереди 2 тысяч сообщений в очереди это очень много почему у нас все работает в режиме около real time ago у нас нет такой такого варианта как подождать полчаса чтобы нагрузка спала потому что когда все рф тикает гигабит даных это 100 мегабайт в секунду за полчаса накопится безумное количество данных которые невозможно забыть рисовать поэтому у нас в соннике очень жестко такая как бы около real time ago история что-либо мы справляемся со всеми сейчас тем потоком данных сейчас максимум в течение там минуты может быть двух либо мы просто должны сбрасывать данные с ними как бы их терять выбрасывать и иначе как бы иначе все будет плохо если какой-то веб-проект в котором шквал пришел то в принципе там за буфере заводь ком перебитым пью сообщение на два-три часа это вообще не проблема поэтому для тех кто занимается небом здесь например миллион сообщение о chery диеты но это не смертельно а для нас 1000 тоже очень плохо значит такой такие процессы которые перегружены как правило надо шарли 3 factory еще есть важна такая важный момент что орлан ключи на педали зиру и того кто обращается к такому загруженному процессу поэтому тупняк процессов он начинает расползаться как бы налево от проблемного налево чтобы и это очень не сразу я как бы не сразу ясно что здесь происходит в других системах которых тоже есть какие-то посылки сообщений там точно такая же проблема да если вы сделали в рутину которая выгребает 1 1 и сковала чего-то то если мы 1-я массив голтон на то в этом случае у вас вся обработка ложится может лично одно ядро как бы я обращался они слабенькие там другие герц уже нет 2 2 2 гигагерца слабенький поэтому все будет плохо вот один из как раз способы в котором им очень часто пользуемся мы используем it s и t с это внутри ландграфская внутри внутренняя таблица что м м и теперь мой брэда the bass а вот и мои ученики на пользуется потому что обращение к ней не требует посылке сообщения она не требует блокировки более того он очень неплохо работает с многоядерность ю а вот но там есть проблемы проблемы связаны с тем что 3d они как бы atmos их спрятали акторами стала сильно легче но они 2 есть по тренду вот там где то там всегда я смею таксу без них ничего без них никак не бывает и теперь они от нас стали спрятанным их невидимыми не управляем мы не знаем что мы сделаем мы не всегда понимаем что мы сейчас какой-то мьютекс используем и помогает судил отследить где эти view такси есть они там очень очень много вот когда в программе многом индексов то в принципе наверно это не так плохо потому что чем больше мы у таксы хотим сказать им наверное более гранулярный каждый миг стоит то есть тема реже возникает ситуация когда два отряда пришли за одним youtube сам и один другого ждет но тем не менее есть вещи которые сильно блокирует особенно если у нас идет часто обращение к одному и тому же месту например у улиток есть целая пачка миксов центральный головной mintex там на чтение на запись у каждого процесса порядка шести мьютекс of 5 может быть и еще кучу кучу всякого-разного как же нам понять что происходит . как нам убедиться в том что или узнать хотя бы про то что мы начали вляпываться в телок контент су-100 что называется есть такая вещь как айленд и lct толок контент это инструмент который есть в ирландии непростой его сложно бывает не так просто разобраться ночь очень важны и нужны с ним как раз нам пришлось разгребаться когда к нам пришли клиенты вот за проблемы lcd и по нему можно попросить собрать статистику статистика конечно же нагружает сервера то есть если у вас там час нагрузка на 95 процентов от вас от вас максимально как бы допустим это запускал центр все похоронят вас полета лемке м киллер и посечет все это все эти мучения поэтому это лучше делать немножечко заранее вот и lcn ты может показать что например за какое-то время вот мы здесь видим на этой картинке что нас один из мьютекс of был зал был заложен в чине 65 процентов времени когда был сделан за меру то есть очевидно это большая проблема days у нас за какие-то там за 5 секунд какой ты секс был заложен и к нет возле него топтались другие три достичь и не 6 5 процентов времени . чем плохо значит у нас фактически по процессора простаивал значит процессе нашего разбирательства sales and и нам даже пришлось вот некоторые патчи потому что не все было не все было понятно и мы как раз дошли до ситуации когда нам ребята из люди которые делают or long они сказали ну типа молодцы гребите дальше потом нам расскажите как как как вас там все получилось вот еще есть такая редко вещь как и локи в гетто и осах это не бьют x они не отслеживаются lcn то их пришлось эмпирически случайно найти и перекомпилировать подобрать как с ними жить значит как я сказал тот инструмент который запускается собирает данные после воды выключили обязательно если вы не выключите все умрет и по нему можно его можно посмотреть что мы выяснили какие проблемы мы выяснили в паттерн и проблему который мы внесли в нашу sonic в течение шести лет разработки во-первых поскольку но мы все же себя умным видом узнаешь узнали что если у процесс очень много сообщений ему не надо ничего сладкого перегружен давайте будем проверять процесс инфу другого процесса пришел дать ему сообщения классная идея то спрячем попросить кого что-то сделает мы спрашиваем а не занят ли ты можешь ли ты этим заняться а это классная идея которая вроде как помогла но выяснилось что допрашивании процесс инфо особенного одного-единственного процесса затрагивает мьютекс как раз и итоге у нас получилось что огромное количество процессов много раз в секунду то есть мы говорим там 50000 событий в секунду например хочет beautix чтобы просто спросить у процесса а можно ли пойти к тебе и послать поэтому фактически это просто убивала все наш performance мы эту штуку убрали у нас это собственно говоря наша система пульс дебит наша система записи статистики мы это убрали все стало полегче но проблема которая пошли клиентам они понизилась дальше мы выяснили что у нас как раз мы вглядываемся в меню токсины и таисия мы решили перейти от записи втс на посылку данных в процесс то сделать за пишущий процесс по крайней мере большое количество сообщений в очереди сообщениях можно увидеть а тоже to my youtube залочены сложно увидеть следующие проблемы это очень часто и международное взаимодействие то в принципе проблем для любого для любой программы которая работает на кучей один если вас так получилось что процессы которые у вас работают они какие то какие то данные какие куски кода расползлись по разным трендом и они частые много общаются друг другом и шарят данные они хороши с каким же данным у вас будут проблемы здесь очевидный рецепт мышь станьте ёжиками то есть уберитесь бесстыдное взаимодействия локализуйте данные в одном треде постарайтесь так чтобы данные которые обрабатываются соседними кусками кода желательно обрабатывались на одном треке как это сделать честно говоря очень сильно зависит от откуда и следующий пленку на столкнулись это очень частая локация это в принципе большая пролема для любого при любой программы на любом языке сейчас расскажу значит как мы собственно говоря вот синглтона про что говорил elsen ты нам показал что у нас есть процесс пульс db который безумно перегружен вот это уже это уже ему полегчало но его еще дальше там после этого вычищали делали чтобы был еще меньше перегружен механика поломок с ним было понятно как я уже сказал прежде чем записать данные систему сборки статистики мы спрашиваем можно ли выписать он говорит да можно и мы получаем что нас все thread'ы стоят на на вокруг одного одного индекса выстроились значит записи втс тоже как я показал та же самая история так что мой пульс db наша всплыла мы выяснили что у нас и в ней есть мьютекс который головной и и мьютекс и частые частое обращение пришли к тому что у нас шумно и количество времени до две тысячи процентов времени значит у нас все просто вела вокруг одного убьют оксида это означает что из четырех ядер а мы умудрились сделать так что у нас фактически 20 я лера стояли в холостую ждали только четыре ядра чет там делали ну как бы штука просто яда нам показал где больно дальше рефакторинг правил от пока но пытаемся осознать что же мы наделали и и факторы сыт с вами мы сделали поступили по какой рефакторинг да значит про первых пропускаем середины процесс запись и чтение из разных процессов от нормального запись случае влаги на казалось и самый важный что шар ведь это очень простая вещь простой рецепт когда у нас есть multi-core кот-то когда мы упираемся в сигал тонный про синглтон ее данные всегда удобную таблицу jardim режем пилим и при этом думаем как оно все будет работать потому что как только мы начнем шар ведь мы теряем от омар насти и как бы локальность данных то есть возможно мы здесь можем дать больше проблем чем чем было но это путь к которым а дайте как правило прошу мы здесь говорить не будем но помнить про это надо это то что более есть есть эффекты от от multi-core про которых искажения не отследить мы не смогли их увидеть мы надеемся на правило не туда потому что если вы пропишите объявляете о томе к переменную на 2 процессор на машине то каждый к ней обращение это очень болезненная вещь потому что она требуется экранизация между процессорами есть такая как file sharing что это такое например вы завели массив в котором двадцать четыре байта вам про по количеству ядер и у вас каждое ядро пишет какой-то в свой байтик по номеру ядра в этом случае вы получили ужасную вещь потому что вы получили необходимость с на каждое обращение к когерентность каша во всех процессорах и всех играх которые есть потому что для радости кэш линейки помощи 16 байт или 32 и то цена это нравится file sharing такая такое явление когда вы думаете что у вас параллельно доступа ведь это на самом деле у вас нет вы фактически сделали один большую dax только он теперь не виден вообще не откуда он не виден не linux то что он находится на аппаратном уровне вот так это фестиваль ланге я не знаю наверное здесь такие же методике как и в обычном коде носи но инструмент к которой сделана для кода носить его жить виртуальной машины ирландия вы г это это это больно но к сожалению это тоже приходится значит что было у нас дальше мы вот узнали про lcd для себя открыли вы узнали какие-то проблемы которые он показывает вроде как там примерно с индексами разобрались который нас аккаунт услуг контент шинами циклу как бы поднялся в полку дальше очень работает клиент уже так это волнуется говорит ребята когда чего у меня тут production вот но мы работаем не спим работаем что нам пришлось сделать как я уже сказал в орлан и ланговски и методики отслеживания того кто живет они не очень хорошие потому что можно попарить по редакциям до ведутся точно такая условная штука но это это слишком условно чтобы ей доверять мы сделали другой инструмент для себя мы запустили страшный механизм trace the race это такая штука которая умеет на каждый чих системе слать сообщения которая говорит что что происходит в частности мы сделали inspired который шлет сообщение кому-то там 1 о том что процесс встал машин процесс снятся днк теста мы знаем время теперь мы реально знаем кто стоял машину или какое время мы знаем кто реально какие процессы занимают актара акторы ланговски занимают внимательно наши scheduler и это очень важно потому что это говорит мне о загрузке процессора а в принципе офис загрузка системы да то есть если про процесс встал на scheduling и ожидает там локации или работы с диском то он тоже будет все еще наши гренки значит этот настрой этот инструмент который пропахали рутой нам тоже дал определенное оборонную очень интересную картину а потому что мы здесь увидели что данные продукции мне совпадают с тем что реально происходит дальше как раз пока мы ковырялись ребят из орландо выпустили масок масок это микро state accounting это еще один инструмент там ещё очень много разных цветов которые некоторые них заброшены некоторые из них развиваются почти все из них как ты мог быть полезными вот и масок умеет очень дешево прямо в реальном времени не создавая никаких прав никаких накладных расходов давайте примерную картину то вообще на что расходуются так ты процессора вашей системе там примерно в районе 10 12 разных разных замеров которые можно снять в частности это там аллокации код который написан на си код который написан на эрланге там летит еще вещи подключается выключается точно так же как и все станет включить собрать данные быстро выключить пока пока не убиваем killer при этом понятно что мы говорим это все только на подарочную клиентам подъема пользователям потому что на ноутбуке ничего не происходит все идеально все прекрасно в офисе на тестовой лаборатории там на 10 гигабит нам стенде все прекрасно никаких нет ничего не проблема все только у несчастных клиентов на продакшн и отсчитываем исаком можно мерить данные длинные интегральные по 2 10 секунды вообще такая как бы ну то есть вопрос на какое время спуска запускать эти инструменты чем на длительное время вы запускаете темы себе сглаживает улаживайте пике потому что внезапно им исаком оказалось что если мы запускаем на 200 миллисекунд или на две секунды мы видим совершенно разную картину то есть чем чем меньше мы чем меньше чем меньше время запуска инструмента профилирующему тем мы можем тем у нас будет шанс будет интересный всплеск а если этих списков очень много в секунду то они могут быть интересными и важными в частности как раз что нам показывает и масок он нам показывает что у нас 20 процентов вообще всего процессора занята локации просто вот-вот обговорим молок внутри ланговски явление там там в этих вызовов кодом молок там их может быть несколько штук на весь код аваланж замороченный реально замороченный локатор прочую попозже так вот короче мы его замучили сейчас на локатор что с ним делать не очень понятно потому что они многотрудный то есть простая локацию вообще некий кодекс не трогают у каждого schedule расовая локатор ерлан кота боясь и таких систем который умеет данные операционки отдавать обратно то есть например взял забрал 40 гигабайт попользовался вернул обратно это большая редкость обычно такое делать не умеет вот он еще и общем еще очень полезным почему очень крутой крутой как любая крутая штука которая занимается а вообще на абстрактным вещами его очень просто удобно и понятно настраивать вот интуитивно понятные строчки для настройки локаторы сразу понятно что здесь происходит но наверно понятно там двум людям которые вы писали до сих пор не по что значат эти абракадабры но мы их там набрали где-то из рекомендаций собственно говоря авторов эрланга где а есть еще важная штука которая помогает всему этому прежде чем прочту как говорить мы расскажем как мы собственно говоря разобрались со локатором вот у нас проблема локатора очень много кто занимается локаций есть еще один буду инструмент который позволяет нам понять куда утекли все данные в системе причем если например есть простой способ мы можем попросить все процессы спросить сколько ребят у вас binary и больших блогов аллоцировать это примерно похоже на готов хит дотана отчасти то мы не можем таким образом понять у кого на про какие более примитивной структуры аллоцирование вот там нам показал что у нас есть процесс у которого 99000 binary и аллоцировать тут бобов это явно многовато потому что ну как бы это неправильно мы нашли это место мы нашли что у нас был сын неправильный код который гигантскую совершенно чудовищных размеров структура данных копировал для каждого приходящего клиента ктп клиент это был простой бак но она при этом работала она проявлялась только на когда у человека там скажем 1000 стримов добавлено вот и там возникал такой милый отель факториал код практически который мы поправили таким образом так вот как нам подобрать эти страшные настройки локатора из так модельер ты as a log config который как раз дает подсказку о том как тебе настроить чтобы было получше с ним есть правда небольшая проблема что сначала надо разбираться со всеми you take some а потом запускать ртс a log config потому что при его запуске он убирает этот все красиво многоцветность и локаторов это гена локатор на одном 3g перед ним стоит мьютекс который естественно будет гореть в центр сразу так большим красным большой красной лампочкой вот но я ртс a log config от один из двух инструментов для подбора один из трех лет для подбора настройка локатор тест на второй момент это собственная голова 3 наиболее эффективные это уже как бы помощь в рассылке от атман тренеров того значит что у нас произошло после всего этого когда мы со всеми инструментами разобрались который нам предоставил long мы прошли через разбирательства слов контент мы прошли через поиск анализ работая локатора посмотрели что оказывается может найти что он перегружен сколько процентов от он живет и видеть где вы тоже происходит таких процессах здесь важная штука что эти процессы они были естественны все быстро умирающие тут них был срок жизни там секунда поэтому вручную это все проектировать невозможно то есть нужно найти того кто отожрал все-все-все и быстро собрать него stack trace там возможно даже состоянием трудовой процесс и чтобы понять что это за процесс такое что же он делал вот но проблема клиента никуда не делась у него все так же мы вроде бы все все все все все сделали вот итоге оказалось что мы просто сделали было очень очень редкая комбинация которую никого больше не встречалось вот мы исправили три строчки кода которые отпустили вам и полностью всю загрузку процессора она ушла в никуда не пропала полностью все стал у него хорошо вот так что по факту что мы имеем варлам есть достаточно старые развитый набор инструментов которые может быть не очень красивую без какого-то красивого клик клик гуя но это штуки которые помогают разгребаться в реально живущим продакшне причем эти инструменты они как правило позволяют заработать бы на живую на боевом сервере потому что сделать сделать микро benchmark кода его можно локальным как правило сюда и лучше делать локально если вы пишите какой нибудь там продюсерами пик т с а транспортного потока его конечно лучше от профилировать локально посмотреть сколько там мегабайт в секунду может распаковывать это нужно но есть вещи которые к сожалению можно ходить только на про башню клиента одна из проблем как верно было сказано предыдущем докладчиком когда вы делаете софт у вас детского сервиса а вот у наших клиентов например стоит 10 машин подключенных на 20 гигабит ах и у них клиенты которые реально выживают эту полосу ну нет у нас вот такого мы не можем как девелоперы себе такую штуку с собрать и набрать столько людей которые будут иначе смотреть видео это а к сожалению повторить локально такие вещи такие ситуации далеко не всегда получается особенно когда мы говорим про сеть потому что а 10 гигабит собранная на лабораторном стенде это совершенно другой ниже 10 гигабит которые реально выгребается людьми из интернета совершенно другое поведение сетевого стека другое поведение буферов другое поведение всего-всего вот но значит как это все может быть полезна людям которые не пишут на и ланге вы можете посмотреть на эти инструменты если их нет в вашем ваши жавель его и посмотреть возможные какие-то попытки людей что-то сделать или скажем вы про это не знали но они оказывается есть я думаю что там того же она лгала цента еще нету а вот джаве я надеюсь что все таки за годы там что-то такое появилась если нет тогда горе печаль и слезы и страдания вот так что вот так вот примерно наш над наношу ваш опыт работы с мультику ram если какие-то вопросы три строчки спросили какие три строчки мы сделали систему которая мы сделали кусочек кода который выключает перепаковку в эффект с дорогая процедура поэтому мы сделали ее on demand и получилось так что 1 к 100 мира него не срабатывало этот переключение в постоянно работающий режим поэтому и мы мы мы сделали примерно 50 кратный рост нагрузки на процессор что конечно было не возможно когда-то это был очень сложно найти потому что когда приходят с на него там 10 серверов 1000 стримов это 10000 принтов приходит одновременно и они дают там 50 50 и 100 кратны нагрузку на процессор основном настолько настолько сильно нагружает процессор это именно с самими своими redux summer long орландо то есть когда мы убрали там все эти лохи разгребли сюда следует а проблемы вот смогли наконец увидеть вот таким образом и получили что сама была очень тяжело даже даже даже просто вот дамы из памяти даже не принимались сокеты соединение вот мы починили поправили стал хорошо но там значит приходит клиент делает хтб запрос на ход по запросам за какие-то микросекунды мы доходим до кода который перри пакует простые фреймы в mpeg ты с упаковывают дорогая приступ потому что взять примерно примерно мегабайт 2 данных попилить их на кусочки по сто восемьдесят восемь байт хитрым образом перепаковать собрать обратной отдачи а да она была она была просто был не поэта почему это то есть вроде как вот можно очень много отдавать данных да всё кстати там все 100 видели большую очередь как большая она там 10 тысяч клиентов в очереди все и ничего не понятно а вот а когда мы выключили камере поменяли сделали так что с комплект с готовится для всех сразу и починили этот код то все 100 сразу сразу сильно упала вот но это уже как раз проблема линейного года то есть это просто баг в линейном коде которая давала бешено нагрузку но чтобы до нее дойти оказалось потребовалось разгребаться именно вот этих приятных особенностях мультик ура да она отлично доклад очень интересно служб уж какой вопрос ты рассказал про холостую нагрузку на процессоры да как она вот выявляется можно ли средствами базовых систем администрирование понять что-то могла на чем-то знает или он просто делать вид что теперь убивайте меня специально невозможно то есть это значит это известная штука да например от в прошлом году он выступал человек который делал бы биржевой софт у них там в принципе нет так как бы для того чтобы никогда никогда не к выходу линга там просто стоит цикл ду дун дун один клуб который выжигает все все все все так ты которые можно может ядро выдать как раз чтобы не дай бог начнет не знали шиллинга ланге отдачу мягче он примерно он дает какой-то там какой-то запас небольшой сверху чтобы его не сняли и есть есть как раз механизмы позволяющие регулировать вот спала нагрузка до у него кучу по таймеру то есть он знает что после спока господа не и нагрузки и разгрузки щедро еще какое-то время жжет так ты впустую чтобы чтобы его не сняли то есть нагрузка волнообразная то может быть ситуация что ты следующей волне как раз успешно в линуксе снять три доставка это длительная процедура если так скажем весь цикл занимает 2 3 миллисекунды то ты будешь будешь обратно ставить thread наш эту машину линк и в итоге ну все будет не очень красиво поэтому это увидеть а снаружи вот простому сисадмину нельзя поэтому мы сделали специально суд нашей как раз системе сборки статистике есть отдельный график в котором рисуется вот цикл а под ним сколько реально сейчас загружен штука видно и мы еще поговорим суд вот сюда не смотри сюда смотри то есть проблема в операционке она еще не созрели яда для для такой работы для таких именно приложений нет это не проливать рисунки эта проблема того что есть вот операционка решает очень широкий спектр задач и пути решения петр задачей бренд есть своп да он есть там на каждом компьютере да но вот даже насера сейчас как будто мы заходим на сервер клиенту первым делом его всегда выключаем потому что практически все клиенты не кандидат не смотрят но вот просто пример даст в опыт вещь которые неприемлемы в принципе для production in the stream ag сервера а для там для бытового компьютера вполне себе ничего пока ты читаешь типа того да да раньше мы жили за сейчас виртуале память их не знаете родакам распределять а еще дума есть ты думаю что ты сейчас попросишь процессор пойти к этой памяти на самом деле ты отправишь к другой процессор прочитать тебе данные из этой памяти это тоже то есть это вопрос именно того что 2 абстракция не состыковались это абстракция которой оказалась выше выше вот нежнейший абстракции она пытает она пытается как бы известными способами на обмануть вот абстракцию которая ниже чтобы и чтобы операционкой думала что здесь эрланга очень нужна вата быть на быть на наш эту линги вот в принципе не особо большая проблема до сих пор пока люди не про не то не то что там сайт на php например рядом с тренингом со стримером ставят фильм про базу данных том говорит о чужой плохо это работает потому что уничтожили 20 долларов в месяц разнесет и все будет спасибо очевидные вещи вы сказали что если у вас как торопится очередь сообщение то это сообщение просто выбрасываете смотрите значит мы можем не послать сообщение до моего дропы то есть что это может быть например мы видим что по этой причине код который занимается обработкой данных на процессоре да мы считаем что в принципе у нас должен справиться всегда мы рассчитываешь нас есть 1000 стримов на вход вида видеопотоков этом с 1000 камеры тысяч телеканалов входят мы должны их там распаковать и субъект с в обычный кадр что-то с ними сделать вот все эти данные все-таки процедуры мы считаем что мы всегда должны быть состоянием обработать таких ситуациях легитимных то что мышцами легитимным у нас может быть такое что актор перепугался и не пишет и не может примет сообщение например эта запись на диск но это вполне нормально датчик запихал например все триста стримов пытается их на шпинделе записать шпиндель не может понять 300 мегабит там или 500 мегабит 11 пильный диск вот поэтому мы выносим вот эту запись в отдельный процесс и смотрим что процесс перегружен если он уже в течение там минуты считать это диска никак не может что записать это означает что у нас неправильность собран весь вот весь программно-аппаратный комплекс он работать и расчетном режиме и все что мы здесь можем сделать это отказаться записи данных на диск потерять это видео качество флокс дружище там поменяю hard или или так как бы не рвать из добавь еще еще два диска это как бы эта аварийная ситуация на аварийный на потому что весь комплекс вышел на не расчетную нагрузку какой-то причине про неправильно спроектировали неправильно прежде не подумали да чаще всего 2 вариантом считается не аварийным а вполне себе рабочий мы с лаем данные процессу чтобы в целых 40 клиенту вот а клиент не может выгребать он закрыл крышку ноутбука расписание не осталось или пролетом вайфай и и все в этом случае мы шлём процессу сообщения новых обрабатывать означает что просто с той стороны соки больше доныне выгребает вот здесь мы просто перебиваем потому что больше ничем общаться то есть это это не аварийность это вполне нормально просто на что значит что либо клиент не подкачал всю попу по соединению которые для него не гадь не годится либо уже если таких как бы по если такого умного в системе значит что возможно просто надо уже расширять каналу сервера на себя так да здесь еще а в эти микрофон дано все значит не слышно людям окрошка про слаб наверное то ли нам в до имеется ввиду что linux swap слаб или ну то есть проблемы с linux везде абсолютно не на одном сервере productions вот нельзя потому что смотрите вас уж такой своп обозначать что вы пытаетесь записать 5 на память данных больше чем вы готовы обработать как бы иногда то есть во первых почему своп не пригоден для production использования вы не можете прогнозировать в этом случае примерно оценочную скорость доступа к памяти для вас запись одного байта памяти может превратиться из например из там из из микросекунд в а минуту то есть это вот вполне себе такая допустимая это понятно если сервису лет слаб и товаре скорее всего они просто но я вот как админ bsd больше десяти лет а вот эту задачу лет восемь назад решили то есть крутого лодейного рутовые со саша всегда есть приоритет уж зайти починить можно отключать не нужно нужно проследить чтобы ничего не падало потому что если это зачем совсем убрать что неизвестно что там salt of memory вылезет то что съела или то что выпихнул а значит у нас нас я значит вы говорить о том что вам киллер всегда имеет какой-то собственный там логику того как кого прибивать когда на сервере есть процесс который сожрал сорок восемь гигабайт и все там 20 или 40 ядер таймкиллер в этот случай никогда не ошибается то есть у нас не было ситуаций чтобы интер решил здесь есть плюс сонику то создал там все ядра всю память о не пожелаем я прибью жаждем и нармер номер 1 или админку там что-то пышную может не то нас в одном процессе у нас в одном процессе вот у нас вот ни разу не было такого что уинклер здесь перепутал и и обознался насчет free везде slope есть еще такой интересный момент что free везде ядро чтобы записать корку на самом деле нужно включенный слов вот конечно это плохо когда система падают в кору вот на если она падает вы скорее всего везешь это очень полезно потому что корка а наутро не утренник орг это наливаем наливаем наливаем кофе начнем читать ведь на эти ночные корки я к тому что если если она падает ну хорошо если оно не падает на если падает вы хотите записать корку поэтому на сервер scribe easy я бы конечно свопа держал на всякий случай я понял да но это да это это важно и проблем она точно также есть у вас какой-то продакшин коде по бы заползает заползает swap tv это все это сам больше прямо то что здесь даже иванова прибит надо спокойно перезапустить тоже в принципе ну перезапуск production сервер это как бы по крайней мере мы знаем что это минут потери времени а там минуты пять минут а запасание в своп это мучение которое длится может длиться например там час ну это это как раз случае вы им киллера здесь скорее тракторов трактор в болото заехал и мучительно пытается выбраться до все да наверное вопросов ко мне больше нет вроде бы спасибо большое за внимание спасибо за доклад"
}