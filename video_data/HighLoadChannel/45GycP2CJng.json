{
  "video_id": "45GycP2CJng",
  "channel": "HighLoadChannel",
  "title": "Как мы данные готовили: ORM и все-все-все / Кирилл Филимонов (Mail.Ru Group)",
  "views": 439,
  "duration": 1481,
  "published": "2017-06-01T23:33:21-07:00",
  "text": "всем привет я кирилл филимонов и я работаю в команде мобильной почту и дело почту mail.ru и мой mail вот и сегодня я расскажу как мы обходимся с данными в нашем приложении и собственно какие подходы мы применяем для того чтобы данные сохранять и пользователю все это отображает вот ну давайте посмотрим типично по что приложение собственно какие функции на него обычно возлагаются но неплохо бы в приложении письмо написать отправить это письмо получить ну и конечно получены всему куда сохранить вот про сохранить сегодня и будет весь рассказ сохранить надо ни одно письмо а сохранить на самом деле надо много писем ну и честно говоря сохранить нужно не только письма на самом деле довольно много объектов чтобы приложение корректно отображала всю информацию которая требуется для пользователя этого мобильного приложения посмотрим немного на предметную область тех объектов с которыми мы работаем у нас есть такой бег письмо эти письма как право хранятся каких-то папках и есть такая сущность как трек трек эта цепочка писем это такой инструмент который позволяет по какому-то правилу использую разные алгоритм объединять письма последовательности соответственно у почты mail.ru весь свой алгоритм по которому письма были обвиняется в 3d там у нас на сайте целая статья с описанием это алгоритма сегодня я расскажу только базовые вещи которое необходимо для понимания в общем этой штуки вот а помимо этого есть еще куча сущности которые нужны для работы нашего приложения нам нужны такие бит как сессии фильтры вложения нам надо куда-то сохранить рекламу и так далее если говорить об этих трех сущностях которые являются основными которые пользователь видит на своем экране то в общем они между собой как-то связан и если так бегала на них посмотреть то ну вроде как схему данных можно построить довольно очевидно но вот у нас есть письмо она там хранится какой-то папки и в общем эти письма также в каком-то треде вот вроде все понятно но на самом деле все не так просто наша модель данных которые мы оперируем приложение она еще немножко зависит от тех абстракции которые используются мощность у нас на сервере и вот как раз thread здесь играет особую роль thread имеет помимо писем в себе еще и такую штуку как представление этого отряда в каждой папке вот и таким образом вот у самого-то уходить от red появляется прудная двойственность в свою очередь это набор писем которые к этому тренду относятся но в тоже время это набор представления этого треда в каждой папке вот и с этим надо как-то жить если чуть более детально посмотреть на схему данных то есть на что самый пресловутый thread этот трек он связан как с письмами так и с представлениями и еще к этому всему добавляется папка и в общем все это как-то связано и все это ведет к тому что связи получается довольно много и объектов тоже довольно много если взять простого пользователя и типичное действие которое длилось письмом ну например перемещает письмо в какую-то папку с точки зрения пользователя он лайкнул элемент списка на экране так ну на иконку перемещения выбрал папку письмо еще раз экрана все произошло все здорово вот на самом деле поменялось довольно много данных мы должны изменить письмо мы должны изменить папки источники папке назначения мы должны поменять трек представления если вдруг извинился список настолько сложно появится реклама это тоже должно быть изменено выходит что действие пользователя они на самом деле могут порождать довольно много операций с данными эти данные они могут быть как-то между собой взаимосвязаны и самое главное кида эти операции могут быть довольно длительного времени но возил нашего пользователя что же он хочет от нашего приложения на в 1 чем хочет чтобы его и был отзывчивой вот пользователь очень не любят когда то миски это подлагивания когда он видит прогресс бар и когда что то идет не так а сама страшно чего не любит это всякого рода inner а вот и от этого надо пользователя конечно предостеречь еще пальцах хочет видеть результат своей операции независимо от того была на успешный неуспешный надо пользователя известить о том что же все-таки произошло с его действием ни в коем случае нельзя оставлять пользователи в неведении и с точки зрения намерения пользователя выполнить операции она тоже должна быть быстрой то есть если пользователь хочет переместить письмо то письмо нужно переместиться быстро именно с точки зрения операции перемещений ну вот исходя из этих задач мы в своем приложении за использовали искупать ну как ну наверное единственный вариант хранения данных ну общепринятый вариант хранения данных структурированных в android клиенте мы завязали форму light чтобы нам проще работать с этими сущностями зеленый пильник и допилили это все до того состоянии с которым нам было бы комфортно работать и которая бы решала пользоваться какие задачи а еще былого гибкой и позволил бы нам довернуть всякие известные штуки прокуроры если расскажу позже как обычно работает мобильное приложение вот у нас есть ей который отзывчиво нас есть база данных присыпкой там магии в общем эти изменения данных отражаются в и в общем все счастливо вот вот эта магия оно как раз является ключевым моментом вот во всей этой цепочки ну так как данные операции на данными не довольно длительные нам надо все это спрятать в баграм thread в какой-то фон у нас есть там стандартные инструменты в первую очередь это стандарты java white red ну понятно что это наверное не лучший вариант что можно использовать для работает в фоне вот у нас есть asynctask и безусловно есть такое понятие как лодыри и вот есть осень перри хандлер ну в общем наверное это основные компоненты которые мы можем использовать для того чтобы убрать эти операции изъят рада и у каждого из них есть свои какие-то плюсы и минусы каждый в чем ты силен в чем-то нет если взять инструмента начать использовать много чего может пойти не так но стандартный киз это нам надо как-то отменять те операции которые заказ телефоне ну соответственно и в принципе на модель эти операции как-то контролировать стандартная проблема смена ориентации с ней тоже надо что то делать если мы используем лодыри и контент-провайдеры то очевидным решением является заюзать курсор адаптер вот но в общем cursoradapter начинает работать с курсорами и непосредственно с моделью данных базе данных и это все становится доступного в ухе и в общем все это становится очень сильно связана и если мы захотим поменять kate элементы view у нас ну на самом деле возникнуть большие проблемы а если мы захотим использовать как только 100 мл воды то здесь уже нас ждут плотности в реализации этого себе механизм и еще одна задача который нужно решить это notification пользователю надо быстро отображать изменения в данных в интерфейсе и в общем нам конечно необходимо чтобы наш интерфейс адекватно изменялся и нотификации были своевременно и в общем тогда когда их ожидают вот а еще есть такая штука как такой эксепшен ну наверняка кто-нибудь на наверное все хоть раз не сталкивались вот три эксепшен приводит поставит еще одну задача перед нами особенностью нашего приложения наверное особенности многих приложений является такая задача что у нас есть какие то данные и они должны быть доступны для потока но при этом мы хотели бы иметь возможность изменять эти данные фоне и возможно эти змеи не сила должна быть отображены кого ты если мы возьмем и применим какой-то ну подход довольно простой и интуитивный возьмем эти данные начнем с учетом сжатия это вполне вероятно что можем поймать такое исключение когда данный поменялись а мы баяндина юху в адаптере и общем в общем бабах и все упал вот что же мы решили применить нашем приложении вот у нас есть уайтред там какие-то ее компоненты и есть какой-то исполнитель запросов который будет собственно доставать нам данные из нашего хранилище а ещё там есть определенный кэш который доступен верою который быстрый и в общем лежит рядом с теми элементами которые будут эти данные отображать есть фоновый поток которым собственно есть наша база данных в котором есть да так сосок же который представляется нам ормом есть объект кэш который тоже предоставляется на мормон ну не совсем так который мы сделали сами и этому арму засветили вот и все это идет собой взаимодействует собственно теперь немножко о том что мы используем в качестве абстракции как-то работает все сохраненные город в нашем приложении представляются по данным команда вот собственно операции над данными имеет обделенной особенность особенность она заключается то что наша команда для работы с данными это суть транзакция то есть мы таким образом обеспечили атомарных тут этой операции над данными еще у нас есть возможность компоновать операции могут используем обычный composer вот и мы можем создать группу операции и это получается только юнитов орг то есть мы можем взять намерение пользователя представить в виде одной команды и отправить на исполнение в газе кьютер там осмотрели могу быть гетерогенной команды не только доступа к данным и наш экзекутор zippers ли ты низких пор там весь пол для работы с командами на данными на тур по пол для синхронизации и в общем еще какие-то пулы в общем он конфигурации можно его расширять команда исполняются на вход принимается любая плимута ция интерфейса команда и результату возвращается так но вызывать или для того чтобы разделять команды пополам мы завязали аннотации и таким образом мы можем взять любую команду аннотирование полем и крики шум пул с ответственным типом по на котором то команда будет исполняться и они попадут на нужны пул собственно там уже исполнится вот еще эти аннотации они у нас наследуемые ее кейс там некоторые базовые имплементации этих команд и поэтому если мы хотим взять операции над данными мы можем секс ценится базовый командой на данным и собственник их аннотации добавлять не надо они сами попадают нужны пол и там исполнится о механизме транзакции которые мы завязали чтобы сделать нашу команду атомарной ну если взять простой sqlite тут все понятно вот такая конструкция и и многие применяют при работе с базами данных открыли заткнул транзакцию в трофейном блоки и вообще что-то сделали там и все произошло arlight но предоставляет два две возможности как мы можем запустить транзакция первое это использовать это статический транзакций менеджер там сделать к он transaction передать туда connection сурс и в общем она как-то там через кого было заработает вот но это как-то сильно сильно низко и наверное не самый лучший вариант для того чтобы использовать сам он такой подход еще есть надо о возможности использовать коба что ск то он тоже принимать cable собственное это мы применяем при реализации наших команд на данными типичная команда для модификации и запроса данных на пули базу данных собственно она является наследником базовой команды и там нужно реализовать эти метод request этот метрик вестон будет выполнен рамках одной транзакции там уже есть до takes a subject основной базовый с которым работает эта команда и в общем есть результат который туда вернется вот и все довольно просто ну замечательно вот у нас есть инструмент который позволяет команда исполнять у нас есть абстракция которая определяет вот эта синхронная операцию и нам на таки как то результат это влияет и тут мы пользуемся таким подходом который какой-то неизвестный свое время озвучивал что чем до находится ближе чем собственно с ними проще работать и тут мы решили данный кошелек которых памяти во вторых сделать доступными из его отряда прям сразу ну то есть без всего взяли коллекцию и отобразили какие инструменты позволяют это сделать вот у нас есть обжиг кеш который доставляется давай и рядом с ним мы построили наш ей кэш но это не совсем копия обжиг сша это такой вариант реализации мимо и зации то есть это определенных слепок каша который актуален для данной вьюки или для данного состояния приложения собственно как вдова работает этот кеш и когда мы вызываем метод она долл он идет о брат конечно советов там нет он собственно как базу данных его запросы понимает их в кэш и удара есть несколько классных операций мы можем закрепить за верить там за долететь и все эти изменения также отображаться в кэше вот это нам дано из коробки с этим ничего не надо делать это здорово но есть еще такие операции которые из коробки почему-то в кашине пробрасываю ца и рекомендации разработчиков фреймворка такие ну ребят если вы бредите ну делаете clear cache и потом собственно заново даны туда поднимайте вот это наверное в нашем случае не очень удобный кейс и мы расширили наше того и поддержали эти операции операции как простого бей то так и апдейтов позволяющих делать обновления через prepare the blade statement и это определенные объекты похоже на запросы в базе данных когда мы можем взять с точки зрения арма скан фигуре запрос через builder и очень передать вот апдейт в нашем deuter вот и теперь наш механизм доступа к данным выглядит так что у нас есть наш кастомный до о который поддерживает наш обжиг кэш он поддерживать все операции которые нужны для модификации изменения данных и таким образом любое изменение и запрос данных надо он поднимает данные во взятках и таким образом данные в память уже поднимается для того чтобы связать наш опыт который работает фоновом потоке с я пишу мы привели стандартный fender собственно в этом киндере ходят сообщение нам надо как-то наполнять что мы передаем когда собственно background и ивой обменятся сообщению пойдем туда тип операции мы передаем тот класс который изменился и собственно сами сущности которые были изменены сами объекты и тут возникает задача нотификации так работать наш механизм модификации когда клиент начинает транзакцию мы создаем определенный буфер нотификации в нашем до о каше в нашем рядом с донку шел вдоль и когда надо вызывается операции какие-то апдейта и делита мы создаем абстракция кэш операция и складываем в наш буфер собственно когда транзакция заканчивается мы разворачиваем наш буфер и формируем из этого сообщения для хендлера это сообщение поститься hitler который попадет в поток и собственно обработается тем кто обработать в потоке фингером который работает снашим я пишу тот свою очередь принимает сообщение и начинает применять из операции к данным и каши как он их дела как он их применяет он собственно берет от достает объект оттуда выполняет приложенную к этому объекту в сообщении операцию и создают нотификации начихать и складывая тоже в буфер как только сообщение обработано эти модификации они собираются по признаку объекта которые должен быть обновлен играю нас подписан на обновление объектов через ей райан собственно нас там реализованных низм data by роллов и наши сущности они имеют у себя определенный юрай по которому не идентифицируются мы группируем эти модификации по каждому верою и затем когда сообщение из хендлера обработано посылается одно сообщение в в notification для наших api роллов которая шлет по одной модификации для каждого ее райт таким образом мы можем изменить изменить и модифицировать довольно много данных но наш ей получат одну аккуратную дефекация и собственно сможет обновить свои данные и все будут корректно для того чтобы получить данные из кэша мы используем своего рода реализацию паттерна репозиторий нос на называется эти менеджер вот но это не совсем репозиторий потому что у нас там есть такой метод get from cache и этот метод get from cache может принимать расширение запросов кэш для чего это сделано и расскажу чуть позже так же там есть такие запросы как ну загрузить еще и обновить эти запросы к этому никите менеджеру они как раз создают тот самый юнитов орг который формирует нашу компас команду которая включает себя операции на запрос к серверам на обновление данных в базе данных и на вот нотификацию и поднять этих данных в кэш что позволило нам сделать такая реализация кашей и такое взаимодействие данных нашим приложением мы реализовали поиск на клиенте обычно работает поиск в почтовом приложение но как он работал нас до этого пользователь вводит поисковый запрос поисков запрос отправиться на сервер сервер умеет всякий классный умный поиск и когда сервер приходит результату она отображает вот но проблема в том что запрос на сервер и ответ занимали примерно ну вот у меня быстрей секунды ну никак не получалось дождаться ответов а если там плохое соединение много данных то это могло быть прям значительное время все это время пользователь видел пустой экран и крутящийся прогрессбар но мы захотели шить эту проблему тем что давай или поиск по контенту нашем клиенте собственно что мы и как умеем сказать мы умеем искать по тексту мы умеем сказать по содержанию письма по теме по отравителем по получателям в общем почти все то что умеет сервер и как мы это реализовали собственно мы с вами поисково яндекса в поисково яндекса мы строим когда работаем с нашим дало когда у нас вдова приходит операцию на изменения данных в баграм потоки помимо операции поднятия данных в кэш модификации крыша мы изменяем наш поисковый индекс это дэн вас хранится в общем то там же и формируется том же багрон потоки рядом скажу когда операция на данными заканчивается и формируется сообщение для отправки мы копию индекс отдаем в наш илай и собственно vive и есть уже сформировано индекс момент изменения последнего изменения этих данных в бэкграунде и в базе данных uiaa доступен индекс только для чтения и собственно этот индекс он принимает запросы похожие на запросы которые можно делать к формировать да то есть там мы можем делать комменты дизъюнкции артом и всякие такие штуки и в общем этот индекс он умеет искать как я уже black от по тексту так и по каким-то отдельным полям в наших сущностях вот внедрение такой штуки нам позволило уйти от тех самых не более не менее чем одной секунды прогрессбара на экране и вот этого ожидании пользоваться кого до того что результаты появляются на экране но менее чем около 20 миллисекунд данные собственно это те которые доступны сейчас локальный которые улетают условиям поиска собственно пользователь уже сразу видеть результаты в это время мы обрабатываем запрос на сервер и как только данный сервер придут мы их поддержим потому что у нас есть локальное собственно обновим данные на экране пользователь а вот все спасибо за доклад ваш объем работы которую проделали он поражает достаточно хорошо сделали интересно было послушать вы сказали самом начале тезис что польский хочет что все было быстро с учетом этого отеля было бы интересно узнать почему была выбрана warm white который спорить рефлексию работает достаточно очень для высказал медленно среди потенциальных конкурентов и выбрали бы вы сейчас что-нибудь другое формула это достался по наследству в общем-то вот и стоимость наверно перехода сейчас на что-то новое на довольно высоко и мы пока не смогли вот наверно выделить ресурс наверное переход на какую-то другую технологию но сейчас бы мы наверное не стали использовать warm white возможно посмотрели в сторону гриндал вот но а возможно и вообще в форму отказались на самом деле спасибо очень очень круто на самом деле что вы сделали это называется secures и ван сорс другими словами слышали когда тут лиги аббревиатуры командон клэрис принципы execration мне знаете что интересует очень сильно вот это подписка пою арай например view это отображение с письма какой-то конкретной папки и она подписана какому йоро ирой папки она нужна подписано несколько и конечно то есть вам нужно будет подписываться все аурой писем и на ее рай папки когда мы подписываемся на ее рай писем мы обновляем информацию только о письмах вот собственно информацию о том что надо обновить какую-то папку ну у нас есть другие элементы view которые собственно то есть оно подписывается например 10 писем на 10 рай но на один там у нас не специфицированы по там как wildcard что но keep the вода потому что у меня был вопрос потом вы говорите что вы группируйте да то есть у вас десять теорий будет писем все разные получается вашую получить 10 нотификации мы пошлем одну модификацию напою но на wild card на подписку на обновление писем и собственно на wild card на подписку господним вот это был вопрос привет спасибо за доклад бесконечно круто я просто разрабатывал рамблер почта для ios и прямо на удивление насколько нас много похожего потом даже можно обсудить меня вот один вопрос есть ты сказал что у вас есть полный текстовый поиск по телом писем выпрет загружаете все все все письма в папке да тут тот нюанс на самом деле нет мы получаем только сниппеты изначально это ну выдержка из там тело письма там ограниченное количество символов вот по ним строится индекс сразу тело письма мы загружаем соответственно в момент отображения этого письма вот и мы можем строить яндекс по нему и применять но на самом деле мы сейчас это вот именно поиск по тело письма особенно форматированного мы на своем мобильном клинике не используем мы пользуемся серверный поиск всем спасибо поблагодарим еще раз"
}