{
  "video_id": "ilmfmxJbQI4",
  "channel": "HighLoadChannel",
  "title": "Делаем Сбербанк Онлайн надежнее и надежнее: как мы готовимся к пиковым нагрузкам / Артем Арюткин",
  "views": 1355,
  "duration": 3129,
  "published": "2024-04-17T01:10:27-07:00",
  "text": "Артём сложный год был наверное да сложный два года перед этим еще много-много лет расскажи что со Сбербанк онлайном тебе слово так Всем привет давайте я начну с небольшой истории из вопросом смотрите Я выступаю на концах и люблю задавать один вопрос но меняет прям никогда не устраивает ответ Может быть сейчас получится чуточку получше У нас есть два сценария мы можем поговорить про успешный успех мне кто слову очень нравится прям именно это сценарий А можем немножко поговорить про ошибки какие-нибудь провалы и вот ту херню короче которая периодически случается Давайте поднимем руки кто за ошибки провалы я понял короче поддержки Пока как-то не получается найти Ладно давайте я представлюсь зовут Меня Орион Артём я руковожу проектным офисом Сбере и занимаюсь Сбербанк онлайн в целом практически весь мой опыт внезапно для меня по крайней мере связан с надёжностью с бала Я когда-то со Студенческой скамьи пришёл начал заниматься Сбербанк онлайн как раз его Надёжность там в роли аналитика системного аналитика и так далее сейчас занимаюсь Конечно уже в основном ненадёжностью а в целом там руковожу различными проектами Да но это одна из тем которые мне нравятся и которые возможно будут интересны чем не хочет чтобы вы сделали Сейчас после обеда это рискованно конечно вы все можете уснуть но хочется чтобы вы закрыли глаза и представили себя на месте того человека кому поручили сделать Сбербанк онлайн надёжным и подготовить его к периодам пиковой нагрузки Ну давайте Не стесняйтесь прямо на секундочку Закройте глаза я не могу закрыть потому что я боюсь упасть но О'кей супер вот собственно говоря Вы все тот самый человек которому поставили эту задачку я еще никогда так мощно не размазывал ответственность Так что за все что будет происходить вопросами ко мне собственно говоря наш главный герой это его антагонист то есть тот злодей те внешние обстоятельства которые нам мешают которые не позволяют нам достичь наших целей все что угодно какие-то новые внезапные бизнес-требования какая-то фича которая к нам прилетела и мешает нам это сделать не знаю возможно вендор поставил нам железку вполне реально кейс обещал одну производительность а производительность кроме оказалась совсем другой Возможно мы косячные например нагруженные тестирование проводим неправильно Это ещё один мешает нам фактор принцесса которую нужно спасти Она всегда тоже есть нужно подготовить сбоку это может быть принцесса это может быть сбол это может быть наш клиент Ради моего мы стараемся работать что будем обсуждать смотрите для тех кто любит определённую структурированность простите меня пожалуйста мы обсуждаем Что такое Сбербанк онлайн мы посмотрим на его архитектуру ну эволюция такая небольшая будет мы её прошли за 10 лет у нас с вами на 25 минут поэтому прямо придётся под напрячься то есть нужна эволюция Сбербанка онлайн и мы посмотрим как мы готовимся к сезону к периодам пиковой нагрузки у нас будут кейсы различные я буду приводить Буду периодически говорить о том как у нас было в монолите И как у нас было и в конце отвечу на вопрос поднимите руку тем кто пользуется Сбербанк онлайн или любыми иными клиентами дебо остальные в банкоматы ходят Да по-прежнему я так понимаю или как вы с деньгами только с наличкой пользуетесь что ли Хорошо я понял смотрите если бы я был на вашем месте тем кому поставили подобную задачку Я бы хотел знать вообще что передо мной за продукт То есть как клиент Я бы зашел потыкал пощупал я понял почему меня так переключается нет анимации Почему поехали Что за продукт такой Сбербанк Онлайн это 79 миллионов мал ну то есть серьезная такая история Если вдруг у нас сервис недоступен для одного процента клиентов у нас 790.000 клиентов страдает моменте это 200 плюс команд зададите вопрос зачем это знать потому что вы этим просто не можете фактически управлять 500 плюс микро сервисов чуточку еще стало хуже с управлением практически 120 тысяч ходов в минуту ежегодный рост нагрузки То есть то что вы сделали вчера в прошлом году как бы в следующем году вам вероятнее всего не поможет вам придется придумать что-то другое и У нас четыре девятки Ну собственно говоря зачем вам знать все эти цифры Если вы готовите Сбербанк онлайн к периодам пиковой нагрузки у вас должна быть цель 4 9 ваша регулярная цель многие сервисы имеют 4 девятки такая нормальная история на самом деле для хороших красивых сервисов в чем минус В чем особенность финансового сервиса давайте так представимся на минутку Вот Новый год вечер вы сидите там с другом с подругой не так важно хотите показать какой-нибудь мем достаете любую социальную сеть заходите туда и не грузится вот у вас сервис но не загрузилась картинка не загрузилась Обидно Обидно согласен неприятно даже немножко но бывает теперь Представьте другую ситуацию стоите вы в очереди с тележкой значит в Ашане огромная такая очередь вы отстояли победилища сзади вас еще большую часть собралась вы судорожно перекладываете товары товары Короче переложились нужно складываете их в пакет вам кассир называет сумму вы прикладываете карту вам не хватает 1000 рублей Что вы делаете правильно заходите Сбербанк онлайн в это время кто-то сзади тыкает вас тележка говорит давай быстрее уже тут все торопятся а сервис пополнения недоступен деньги у вас есть вы их видите физически вот на вкладе а перевести не можете Ну и тут начинается Да там Галя у нас отмена вас ненавидят вся очередь которые стояла вы в целом ненавидите продукт которым только что недавно пользовались ситуация Короче не из приятных Я бы не хотел не оказаться Давайте немножко еще разомнемся после обеда чтобы не заснуть смотрите дальше будет небольшой архитектурный такой трек и для того чтобы Понять насколько детально погружаться хочется понять небольшой опрос поднимите руку те для кого стринги Это скорее тип данных супер Блин я переживал что шутка не зайдет короче хорошо я рад что зашла Посему поехали место Сбербанка онлайн ландшафте банка Ну смотрите здесь вообще должно было красивенько все постепенно появляться но Бог с ним не появляется не появляется У нас есть клиент клиент приходит в разные каналы каналов много их больше четырех Но объективно больше четырех не за доклад не запомнить это банкоматы это мобильное приложение Web и приложение для обслуживания клиентов есть еще короче большой список сервер ставить Сбербанк онлайн Ну вот та самая принцесса которую мы с вами готовим слой интеграции вообще классический в систему банках давайте так в банках классические это USB интерпрайсервис бас у нас не она уже к счастью Да там еще движемся вперед но вот так вот устроено и дальше идут фабрики различные карты кредиты вклады платежи не знаю инвестиционные различные продукты и так далее зачем вам это знать а затем чтобы вы понимали что Сбербанк онлайн не принимает решение о том выдавать ли он кредит Сбербанк онлайн не принимает решение поставки для вклада он не проводит ваши платежи Да условно за 100 оператора Если вы платите за сотовый как бы болт - это сервис для интерфейс для доступа к сервису платежа а затем стоит ещё вот вся вот эта цепочка которая здесь показана потом фабрика платежей за фабрикой платежей стоят платёжные шлюзы за платёжными шлюзами стоит система оператора за системой оператора стоит ещё платёжные шлюзы короче очень далеко Эта история уходит это на самом деле Типовая история для любой системы класса дистанционного банковского обслуживания Тут нет ничего особенного небольшой суммы что у нас здесь есть так устроен вот тот самый сервер сайт То есть у нас есть шарды шарда полностью изолирована как некая такая подводная лодка То есть она полностью самостоятельно в ней живет конкретный клиент Вот я например живу в шарде седьмой Да кто-то из вас живет шарди 1 и Это не меняется условно никогда понятно что есть разные кейсы сценария но в базовом для 99 процентов клиентов это никогда не меняется вы всегда живете в какой-то в одной шарди это определено Ну не совсем рандомом там была определенная логика Да но условно это так Что представляет себя шарда но это приложение база данных для хранения операций до 12 месяцев затем вынесено отдельно архивная база данных это архивный слой хранения там данные хранятся старше 12 месяцев Но не только на самом деле они там в онлайне реплицируются Golden kidom Да и хранятся в принципе плюс-минус актуальные там с отставанием 10 максимум есть резервные шарды зачем они резервные шарды нужны для того чтобы если вдруг одна из основных шар упала мы клиентов перебрасываем в резервную шарду данных там в моменте нет но эти данные подтянутся из архивной базы как только клиент То есть ты вошел мы тебе сразу подтянули в онлайне данные все у тебя появилось ты видишь сбол для тебя ничего не поменялось ты не знаешь ни о проблемах Ну и конечно тот же самый подход используется при обновлениях Ну типа накатываем новую не знаю версию приклада на шарду 1 точно также клиентов шарды 1 направили в шарду 1 в резервную и все обновляем без всяких проблем как мы здесь оказались И как мы сюда пришли чуть позже расскажу еще один короче на прошлом helloudi я рассказывал как трансформировал как раз наш легасе Монолит огромный на вот эти вот безумные 500 плюс микросервис руководство больше не разрешает эту историю рассказывать поэтому я не буду здесь рассказывать как мы офигенно взяли большой Монолит 2 года его пилили распиливали и получились офигенно классные микросервис ни слова об этом не будет больше что получилось в одной шарди вместе существует Legacy Монолит в одной шар вместе существует у нас соответственно наши микросервисная платформа То есть это базовый библиотеки и приложения которые нужны для обработки клиентов Это там сервис аудита обязательная штука для банков без этого нельзя сервисы журналирования мониторинга история операции и так далее их там порядка 40 штук что здесь у нас есть значит соответственно изолированные каналы обслуживания клиентские мобилка и Web они на самом деле разные просто чтобы не усложнять график то есть это два разных канала затем приложение для офиса atem и другие каналы В чем фишка опять делаем изоляцию То есть у нас было шортирование изоляция была чуть раньше на прошлом графике здесь еще дополнительно изоляция упал один канал упала ТМ все остальные каналы живы в целом можем принять решение о том что ну не так страшно короче Поживём ничего делать не будем всё нормально а чёрт вот так организационная структура Офигенно да слепит смотрите затем вам это знать у вас возникает вопрос помните что я говорил что это очень сложно управляемая история Если вы тот человек которому поставили эту задачу то вам будет непросто Почему Давайте вместе порассуждаем если кто-то работал в матричной структуре управления Он знает что это от внутри ада и для тех кто это придумал вообще отдельный Круг в аду для тех кто не знает почему значит матричная структура управления это грубо говоря когда ты работаешь с теми с кем тебе дают ты не можешь этого человека бить не можешь только наказывать не можешь принять решение его депремирования его повышение ничего Короче не сделать не можешь какой был Не хороший не был ты можешь ходить к его начальнику говорить Не знаю там дурак не работает нифига но это тоже может не поможет Может она осознанно дурак и твоя задача просто не хочет заниматься Это плохо то что вы условно находитесь вон там он влево в левой части платформа Сбербанк онлайн а ваши визавидо находится в платежах переводах там в коровских продуктов кошельках разных и так далее таких обычно штук 20 у нас короче разных называется смотрите Что такое хайсизм то к чему Мы собственно говоря с вами переходим вот я для вас придумал такой акроним он отвратителен настолько ими за него стыдно что я даже это даже его готов был показать все-таки в итоге Короче мне хотелось придумать акроним Я два дня его придумал придумал Вот это убожество но не знаю Надеюсь вы запомните значит ВДВ кроним такой хайсизм это периоды пиковой нагрузки их больше чем показано здесь на экране Но ради акронимы я пошел на небольшое обман значит нас 8 марта период пиковой нагрузки 23 февраля и в Новый год да Судя по правде в Новый год вы видите какой-то уборство просто мне даже не стыдно насколько это плохо На мой взгляд значит смотреть периодов больше там у нас еще всякие зеленый день Да у нас есть различные там майские праздники подготовка к школе то есть периоды когда клиенты чаще всего заходят Сбербанк онлайн и совершает какую-то транзакцию если кто сможет придумать офигенная акроним напишите мне пожалуйста я прям очень я не смог столько усилий ради пары дней кажется да Ну что нам заморачиваться там ну не будет доступен сервис и не будет доступен сервис Ну во-первых вспоминаем кейс тележкой эти же кейсы могут случиться 8 Марта 23 февраля под Новый год и в любой другой на самом деле праздник и важный для нас то есть ну нам нельзя упасть нам нужно продержаться как угодно доползти на пузе на чем угодно но дать клиентам базовые сервис может быть недоступна какая-то красивость Бог с тобой Аватар Не подгрузился ещё что-то Да но базовый сервис и кормовые должны быть доступны Что будет если мы упадём э-э Мы переживаем за наши клиентов если мы упадём собственно говоря будет беда Да и клиенты не получат доступ к своим средствам в реально важно для них моменты времени у нас есть какая-то тактика то есть что мы делаем да как мы готовимся У нас есть какая-то тактика мы это какой-то тактике как-то придерживаемся и в целом каждый раз становимся лучше то есть на самом деле кажется что в системах класса как бы правильно сказать движущим фактором является не бизнес требованием движущим фактором на самом деле является требование надежности это особенность На мой взгляд систем класса Halo не только наши на самом деле всех вокруг То есть она архитектурно меняется каким-то образом только потому что она должна быть все время 4 9 собственно говоря возникает вопрос что делать там как нам с этим быть и как нам с этим работать Блин они все раскрываются это прям грустно Ладно секретов практически не будет тогда поехали начнем мы делаем стандартно анализируем нагрузку в прошлом посмотрели что было посмотрели на свои инциденты Да там за прошлый период посмотрели как мы пережили пиковый момент времени и подумали что с этим делать дальше строим прогноз нагрузки это всегда кстати интересно кейс потому что например бизнес к тебе приходит вот я показывал там 120 тысяч ходов в минуту целое ну обычные нормальные деньги для нас Да пиковых он там достигает 200.000 ходов приходит бизнес и говорит в этом году у нас сто процентов будет 300 тысяч ходов в минуту ты как бы гаш откуда они говорят вот мы такую фичи придумали такие фичи Все офигенно будет 5 destion прогноз конечно не было так ни разу Ну вот Давайте строить тренды Давайте строить графики и никогда не получается Поэтому нам надо всегда анализировать на самом деле обсуждать вместе в неком диалоге как же нам этого сделать Ну и что нам достичь зачем мы строим прогноз нагрузки Да отсюда вытекает следующая наше действие нам нужно определить максимум который мы выдержим мы там используем нагруженное тестирование понятное дело мы там используем всякие подходы хаос инжиниринга и так далее ну то есть пытаемся максимально сломать систему и посмотреть что будет здесь выявляются всякие классные штуки например такая история как не знаю там единая точка отказа вот допустим аудит Да есть у нас такая штука для банков аудит это обязательно сервис вот у нас он был таким образом реализованный что под нагрузкой Он падал А если аудит недоступен то сервисы не должны работать Все до свидания короче с бербанк онлайн падает вместе с одним единственным отказавшим сервисом Хотя Казалось бы не критичен ну то есть Клиенты могут пользоваться могут работать да и все же хорошо у них будет но Видите вот есть нюанс такой оптимизируем конфигурацию а здесь на самом деле прям широкий спектр задач скрывается мы можем добавить шарду мы можем поменять не знаю там из ходы можем поменять железки можем подкрутить что-то в параметрах например когда мы офигенно мигрировали с нашего Монолита на микросервисы то о чем я не рассказываю здесь вот у нас возникла такая особенность что из-за особенностей реализации асинхронных сервисов микросервисах короче рыбаков много у нас переполнялись tcp коннекты кампушкам это приводило к определённым проблемам с тем что мы короче их убивали своей нагрузкой особенность реализация была в том что через них даже запросы не ходили Ну то есть они просто поднялись короче и убивает их нафиг сразу ну не вдаваясь нюансы была такая особенность естественно нужно было задачку порешать оптимизации конфигурации Почему Потому что в наших условиях изменения и доработки заняли бы порядка наверное года на тот момент а мы подошли к этому конкретному то есть мы знаем что у нас там 8 месяцев до хасисана наших максимальных нагрузок сделать мы ничего не можем соответственно оптимизировали конфигурацию на пузе проползли Нам повезло ничего не упало Потому что есть секретный ингредиент 6 скрестить пальцы да вот собственно говоря То есть вы там что-то работаете трудитесь в конце стряхиваете пальцы и у вас всё получается пятый самый неприятный тяжелый выполнить доработки Ну то есть вы берете какие-то истории и начинать что-то разрабатывать например вам нужно реализовать кэширование допустим к Вам пришел бэкенд ваш который отвечает за вклады и говорит ребята Короче все баста мы не знаю развиваться не можем ваша нагрузку не тянем что делать Окей давайте кэшировать Хорошо будем там клиенту с небольшим отставанием показывать Потому что клиент не всегда например не знаю там обновляет вклады условно дальше будет еще кейс поинтересней основные принципы Те про которые я проговорил частично и Те про которые еще расскажу смотрите шортируй Об этом я уже сказал резервируй мы это тоже видели изолируй да об этом мы в целом тоже поговорили верхнего уровня кэширы деградируй Я здесь Рассказывал а то что мы готовы потерять какой-то сервис и в целом ничего с этим не делать то есть восстанавливать сервис Да как бы в онлайне не предпринимая больше никаких активных действий и заботьтесь о смежных вот короче смежников важно Заботиться об этом истории тоже а с чего начать-то Ну вы же помните что я еще руководитель проектного офиса поэтому у меня есть секретное проявленческий прием просто нужно взять короче и сделать Вот либо начать тут кому как нравится да вот такой вот он специфичный Возможно из-за этого у меня есть определенные проблемы в моей работе что я других подходов особо не знаю смотрите значит здесь они должны были появляться красиво постепенно и мы должны были видеть эволюцию теперь представляем себе что внизу вообще ничего нет архивных баз нет и есть только шарда один вот когда-то была только шарда один и ничего клиент просто туда ходил потом уперлись попасть и базы данных потому что там росло количество данных клиентов к ним обращались базы были там вообще они мощные были до Но типа Нам не хватало по разным причинам была шарла один Потом мы посидели подумали как бы что делать тогда естественно подход добавили шарду 2 и что правильно можете затор потому что не добавишь маршрутизатор непонятно как куда направлять клиент появился офигенный сервис маршрутизатора появилась две шарды это все происходит очень легко То есть была монолитная архитектура на тот момент Давайте добавлять новые шар проблем нет потом ну там количество шарт росло но в них все время росла и количество как бы клиентских данных и нагрузка на базу данных шардах росла и в целом стоимость дисков была как дорогая потому что используется хенда и тому подобное придумали офигенную тему с архивным слоем хранения данных на стать отдельный доклад в 5 часов будет главным зале Илья кайшоуре рассказывает про архивный слой хранения данных как мы его сокла хотим мигрировать Да там в текущем и следующем году на погреб Так что послушайте Там прям детали будет И офигенные зумы во все что только можно погрузиться значит смотрите дальше у нас шарда один шарда 3 появляется архивный слой хранения данных Я кстати хорошо помню когда появился он в 2016 году я тогда аналитиком был писал техническое задание на Вот это архивный слой хранения данных У меня родился ребенок утили Да родился ребенок и мы с ним в 4 часа ночи короче друг другом все время переписывались уточняет требования поэтому я легко запомнил когда это было что дальше Зачем нужны эти архивные слои хранить данных у нас было офигенная идея значит говорим мигрируем туда данные старше года ставим это все на дешевые железки и все получится вот Будут доступ к данным все время да не туда реплицируются удешевим сбол и так далее сбол мы не удешевели Вот потому что так и остались на Супер дорогих железных но сделали другую историю клиент при переходе в резервную шарду Откуда ты должен получить свои данные Ну то есть у вас шорта один упала вас направили в резервную шарду шарду один резервную направили откуда вам взять ваши данные Они же хранятся в основной базе правильно берём её из архивного слоя хранения данных но он условно называется архивным на самом деле то есть взяли подтянули оттуда данные Да ну О'кей клиент типа получил то что хотел пару интересных историй про монолиты микросервисы про которые я тоже рассказывать по-прежнему не планируем смотрите в чем история Значит до шестой шарды был только Монолит добавить новую шарду в монолите было приблизительно легко то есть что происходило мы там заказали железо понятно не супер легко надо деньги получить и так далее да но в целом реалистично заказали железо Да там попросили ребят из саппорта сделать соответствующие настройки накатили приложение отправили туда клиентов протестировали Все работает Вуаля новая шарда клиентов либо переносим из старых шарт либо новых на регистрацию направляем и как бы шарда растет Да нагрузка на другие шарды спускается все прекрасно когда добавляли шарду седьмую у нас уже появились микросервисы То есть это отдельная платформа стоящая рядом с монолитом на ней было на тот момент Порядка 70 наверное микросервисов Вот и я жене Рассказываю что я Седой из-за неё а на самом деле я Седой вот из-за добавления этих шард Потому что когда мы добавляли седьмую шарду так случилось что я лишил порядка 100.000 клиентов вот не в смысле как бы списал им кредиты это было бы ещё Ладно Возможно они бы обрадовались и простили меня а в смысле что так случилось что они подали свои заявки эти заявки потеряли вот а банк банки обычно работают Так что если ты под одну заявку и сразу подал вторую тебе тут же блочат подачу заявок Потому что считается Ну есть подозрение на фрот и прочее такая ерунда Вот и вот так вот случилось эти 100.000 клиентов потеряли были заблокированы то есть посчитали Что это фроту у них произошла повторная подача эту историю пришлось откатывать наверняка были сильно недовольные клиенты Ну вот простите меня пожалуйста Если действительно так было почему так произошло потому что в монолите было легко добавить Ну то есть взял добавил как бы настроил один и тот же приклад у тебя стоит скопировал параметры базы данных схемы прекрасно а микросерв Их дофига за них отвечает разный бизнес разный Саппорт и они Не умели накатывать короче новые микросервиса ну вот ну короче культурно Мы были такими на тот момент культурно слово неправильно Мы были такими короче были такими вот такой этап у нас развитие был психологически Не умели мы это делать быстро так случилось Вот такие наши ошибки Зачем Я показывал вам структуру кажется что Ну вот поставили вам эту задачку Да там сделать сбол надежнее Окей зачем вам знать пророк структуру был такой замечательный проект добавление резервной шары второй как я сказал монолите было легко но момент когда нам понадобилась вторая резервная шарда у нас было порядка 200 плюс микросервисов на тот момент особенность наша в том что у нас появляется разные версии платформы Ну то есть платформы от некий базовый механизмы до которые там библиотеки приклады которые там нужны бизнесу для того чтобы строить там свои приложения микросервисные Вот и мы когда мигрируем с одной версии платформы на новую нам как бы надо пересобрать весь бизнес надо пройти все тесты и так далее когда у тебя там 200 плюс сервисов у каждой команды свой Black Lock Ну то есть ты приходишь в одну они тебе говорят дружище всё офигенно но у меня там не знаю задача на 100 миллионов Прости пожалуйста тебе Придётся подождать Ну у тебя такая цепочка длинная выстраивается В итоге у тебя переход с одной версии платформы на другую занимает год например или больше а резервная шарда нужна там Ну к концу этого года Да ты об этом понял Не знаю в марте и вот почему структура важна на самом деле В подобных той же историях потому что нам поставили ограничение сверху для бизнеса для руководства айтишного было критически важно чтобы бизнес перешел с одной версии платформы на другую вот так вот эта задача была для них приоритетнее чем добавить резервную шарду и по сути из-за этого нам не дали доработать предыдущую версию платформы Ну которую можно было подтюнить как бы и там платформа была бы способна работать на двух шардах Это был наш косяк мы не заложили две шарды Ну то есть Серьезно когда проектировали новую платформу не подумали что бывает две резервных шорты этот момент не учли и чтобы эта учесть нужно было допилить старую версию платформы нам сказали нифига короче есть только в новую версию платформы я создал для нас определенное ограничение то есть нам пришлось усиленно бежать и гнать бизнес короче вперед чтобы появилась вторая резервная шарда потому что монолитами у нас они живут вместе и как бы если у тебя вдруг в одной шард что-то недоступно в микросервисах соответственно не работает поэтому как бы за счет идет и по последнему Ну то есть как работает до шарда вторая могла запустить то когда впром выйдет последний микросервис на новой версии платформы то есть структура тоже внезапно на нас влияет Хотя Казалось бы да задача Там чисто такая тишина чёрт возьми Ну бывает так ничего страшного Мне кажется у меня неплохо получилось рассказать и там ну что ж такое так смотрите разложим все по кирпичиком нас есть бизнес У нас есть платформа и есть смежники сейчас вот будем про всех про них говорить значит смежники Смотрите кто из вас считает что любой проект Да там любую какую-то такую активность серьезную нужно начинать коммуникации потому что коммуникация это наиболее критично это сложно это сложно управляемо потому что не можешь заглянуть в голову другой системе другому сервису другим людям и так далее условно в этом начинаете проект Да если говорим про менеджера то нужно выстроить карту коммуникации договориться Как вы общаетесь да там и серии с кем общаетесь кто кому о чем рассказывает В какой момент времени если там задача чисто Техническая нужно договориться обе Ну то есть логику свою Вы внутри Напишите вы как бы сами решите Как делать А вот а Папе надо договориться на старте поднимите руку те кто также считает это не так много как те кто пользуется дистанционного обслуживанием хорошо короче касса закрыта перерыв на обед когда я Сбер пришел после Универа в 2015 или четырнадцатом году была у меня такая Задачка реализовать механизм похожий на сыркут брокер Да там я писал техническое задание на него У нас назывался технологический перерыв и особенность была в том что он синхронизировался через базу данных ну то есть Breaker Как работает у тебя на сервак прилетает ошибки если набралось X ошибок за 2 минут сервак перестает например слать запросто другому Да там сервису которая ошибок назвал условно у нас работала точно так же но только ошибки в базе копились Ну то есть Пока У тебя там не накопится X ошибок за вами минут все серваки всё равно шарашит запрос а как только накопилось все серваки сразу перестали шарашить запрос то есть первая причина была ну как бы помочь вот там остановить рост ошибок нагрузку на байку системы вторая история была бэковая система может проводить какие-то обновления у себя не знаю там накатывать какие-то изменения ночью Да и надо выставить Вот как раз перерыв на обед то есть сори вклад можно открыть будет но через два часа Прости нас пожалуйста Уважаемый клиент интересно офигенно работал очень долго офигенно работал все прекрасно пока Однажды не убил нас как он нас убил случилось следующее система процессинг то есть основная система которая на самом деле Клиент заходит чаще всего Клиент заходит увидит свой баланс или совершить операцию по карте Клиент заходит не видит свой баланс потому что у бэковой системы проблемы Что он делает перезаходят перезашел ничего не изменилось по-прежнему видит проблему опять перезаходят и по сути недоступность Байковой системы и наши медленная реакция на это потому что пока идет синхронизация через базу Ну короче время много уходит привело к тому что сервис Ну мы по сути просто упали под клиентской нагрузкой Да и не выдержали и сделали выводы перешли на церковь брокеры как бы научившись этому оставили текущий механизм есть моменты когда Он важен когда он нужен но в целом база там пришли к выводу что циркут брекеры работают лучше Вот научились небольшой на таком примере в процессинг Почему важны смежники Потому что когда у вас есть смежники контрагенты от которых вы зависите вы должны с ними всегда договариваться как было здесь значит пришли к нам процессинг и говорит простите ребята нас бюджет нам не дают в этом году мы не можем подготовиться к нашему там хайсизму нам не дают расширится не дают шортироваться не дают денег на новые диски и так далее Давайте что-то делать открываем вместе с ними что делать и выясняется что у нас куча вещей работает не оптимально Ну например У клиента 5 карт он заходит сбол совершает операцию по одной карте что мы делаем После этого мы берем и шлем в процессе запрос Дай нам баланс и по всем картам возникает вопрос Зачем он же совершил операцию по одной конкретной карте давайте как бы запросим баланс по одной конкретной карте это там снизит например нагрузку на процессинг не знаю там в конкретном запросе на 20 процентов пробежались офигенно нашли такие точки оптимизации получилось Здорово Есть нюанс как мы сделали в монолите взяли собственно говоря одно место да там сделали библиотеку кэширования поменяли и все заработало шикарно микросердцев мы до сих пор до конца Так это не доделали потому что команд много мест много ты им всем говоришь ребята сделайте сделайте Да но одна это сделала другая не сделала ты их фиг найдешь короче Вот именно тебя кому-то пофиг его ты с ними так борешься Ну понятно что 80 процентов покрыто Да но если говорить о завершенности задачи говорить об этом нереально это кстати наверное неплохо Ну то есть просто некое ограничение о котором мы все должны знать платформа ну здесь на самом деле я много рассказывал про всякие шортирования Поэтому базово да там чем мы делаем мы строим прогноз там наконец декабря Да мы гоняем нагруженные тесты тыкаем Пальцем в небо и уточняем экспертов экспертов всегда надо уточнять чтобы они помогли нам понять что же у нас есть нехорошо основные принципы Да там еще раз продвигаться по ним не буду но сейчас откроются два дополнительных бам повелевая клиентами и работает с отложкой на самом деле стандартный паттерны до которые описаны в книгах в куче статей я их просто специально называю некими такими терминами возможно которые облегчают всю эту историю нам бизнес Да все это имеет отношение к бизнесу Значит есть сервис который возник свое время под кодовым названием вход в сбол по талоном ну серьезно то есть ситуации когда каждый из вас попадает Сбербанк онлайн только если ему можно туда попасть Вот это было следствием одного из инцидентов когда мы не смогли справиться с нагрузкой от клиентов вот клиенты Все ломились ломились ломились мы убивали наши бэки сами тоже падали под нагрузкой и в целом было плохо еще и Баку вот к нам бег пришел и сказал Короче ребята нам так плохо что мы завтра не поднимемся А если не поднимутся они не поднимемся и мы что делать в этой ситуации что мы придумали значит сели тогда команда часов в 9 вечера и у одного из руководителей тогда уже возникла идея давайте сделаем вход Сбербанк онлайн по талоном то есть на самом деле такой некий стандартный сделали это за ночь сели ребята соответственно написали нужную библиотеку и следующим утром мы очнулись Я между система Вполне себе работоспособна была почему потому что был некий предел Сколько клиентов мы можем можем впустить всех следующих короче условно Не пускай Ну условно мы на самом деле выставляем определенный процент клиентов которые войти не могут все остальные могут войти вот что здесь важно на самом деле этот кейс был тоже кстати актуален для Монолита потому что система некая Да там существовала команда по-прежнему существует которая настолько шарил разбирался с теми что фактически могла исправить любую проблему и сделать это достаточно быстро в данном случае они сделали это за ночь получилось ли бы у них сделать то же самое на самом деле например на микро сервисной архитектуре нет потому что мы тоже пытались создать микросервисов у нас в целевой платформе создать некую супер команду Да супергероев которые способны решить любую задачу но там это не получается Возможно мы просто не умеем не знаю Есть места меня мечта за телефон заплатить этот сервис который нужно было продавать бизнесу Я честно до сих пор не понимаю почему его нужно было продавать но приходилось его ходить ему продавать значит Однажды мы столкнулись с проблемой с тем что Если вдруг не доступен сотовый оператор Ну не работает их шлюз платежный не работает значит Клиент не может заплатить за свой телефон но чё делает клиент он где не может заплатить Сбербанк Онлайн он звонит и говорит у вас не работает ваш Сбербанк онлайн не работает сотовый оператор у нас растет нагрузка на контактный центр и так далее Вот и пришлось практически уговаривать бизнес Да сделать очень простое решение как бы оставлять телефон клиента ой телефон клиента прихранивать по сути запрос клиента платежный Да с информацией о том что дружище мы знаем что что-то не так потом мы тебя оплатим подожди пожалуйста Ну и потом собственно говоря сделать ретрай Да попробовать ещё раз оплатить э-э Здесь тоже интересно есть мы забыли Это сервис офигенный он во-первых повысил нам Ну не то что повысило количество платежей он скажем так в момент когда у сотового оператора есть проблемы позволил нам сохранить Ну некий Да там уровень количество платежей Потому что клиент видит что ему сказали дружище через Через 15 минут мы все оплатим подожди пожалуйста тебе нет смысла идти в другой банк Потому что другого банка тоже не работает вот причина не в нас причина короче условно дальше но мы забыли сервис при миграции на микросервисах Короче получилось На мой взгляд интересно но был момент моим все помнили вроде даже постановку сделали change request Но как-то затерялся короче в огромных баклагах процесс трансформации все вот так короче тоже бывает Значит это еще раз архитектура Да там просто напомню еще раз наши основные сервисы основные подходы паттерны про которые мы говорили шортируй да я вам рассказал достаточно подробно резервируй изолируй кэшируй деградируй заботиться о смежниках повелевая клиентами Да и работы с ложкой ещё раз что мы делаем собственно говоря анализируем наше поведение в прошлом как наша так и поведение АЭС на самом деле одну из фич вот условно мы придумали в моменте когда был инцидент мы стояли вот так вот прям над одним из экспертов сопровождения который Просто сидела так вот и две кнопки туда-сюда нажимал мы стояли смотрели на него спросили Зачем он это делает он нам это объяснил мы сделали автоматизацию штука которая офигенно нам до сих пор помогает То есть это Вот пример того что мы анализируем что было в прошлом строим прогноз нагрузки определяем максимум с помощью нагруженного тестирования хаос инжиниринга неких прогнозов экспертности и так далее оптимизируем конфигурацию в идеале там где это можем добавляем новый шарды не знаю меня не меняем какие-нибудь диски на более крутые возможно просто делаем там другую настройку внезапно все взлетает выполняем доработки Ну и скрещиваем пальцы так собственно говоря секреты отказа устойчивость все всегда падает Да это один из термингов терминов который по-моему сетью амазон сказал да то есть всегда может такое случиться вы Салова когда занимаетесь надежностью Да если вам такую задачку поставили должны исходить из того что чтобы вы не сделали вот это упадет дальше Вы описываете сценарий Что будет если это Упадет и как вам на это реагировать Следующая история Да это вот наш подводная лодка то есть Ну мы так выбрали в свое время да что микросервисную архитектура у нас одинаково что Legacy Монолит то есть нас подводная лодка полностью изолированная между которой тоже существует перегородки То есть если вдруг проблема условно в одном из каналов мы перегородку закрываем ничего страшного не происходит все остальные каналы работают ключевой секрет Да нет пользователя Нет проблем Вот во-первых всегда поможет То есть если Вам плохо как бы ограничить пользователей что поделать Да в худшем случае ну это реально последний наверное такой ваш подход Так вопросы и обратную связь поднимаем руки сейчас повторюсь те кто задает вопрос потом пожалуйста Не уходите зал потому что у нас будет при за лучший вопрос так давайте сначала подскажите пожалуйста вы читали книжку ничего знакомого не было вот так в самом первом ряду там же надо вот Здравствуйте Баир Тимур Тинькофф бизнес первый лайк за матричную структуру все понимают что не работает но продолжают использовать функциональные то не работает второй второй лайк за микросервисы и за Монолит Надеюсь тренд на микросервисе прошел Все осознанно подходит к этому выбору И еще хотел уличить в манипуляции фактами 4 девятки 4 девятки но это неправда Это вы находитесь если разбить доступны недоступно доступно зеленые недоступны красные то вы находитесь в желтом потому что в каждом времени вы недоступны частично 4 девятки Нет не существует Да конечно Про матричную структуру Ну на самом деле как менеджер я все-таки больше менеджеру я прям не могу не согласиться просто неправильно скажем так как менеджер Я считаю что работать нужно с тем что есть как бы в краткосрочной перспективе в долгосрочно это нужно менять еще какие-то новые там наверное подходы Поэтому если сегодня матричная структура то значит с ней нужно работать искать там как это правильно делать что касается четырёх девяток нюансов действительно много на самом деле каждая организация считает это неким особенным образом Вот потому что система она же не существует в изоляции То есть у неё персонально о персональную систему Короче у конкретной системы э действительно может быть четыре девятки вот если она полностью изолирована сама себе существует Да но как только у нас там появляются внешний контрагенты возникают вопрос Что такое четыре девятки если там правая система упала и я из-за этого тоже упал я был виноват не был виноват из серии Ну то есть на самом деле много нюансов как это считается э вот есть особенность каждой организации на самом деле я спрашивал ну считают по-разному эти истории в этом смысле Да что конечно 499 - это то как ты умеешь считать вот и всё И еще еще один наброс слышал Golden Gate как импортозамещение восхитительно об этом будет доклад в следующем году Вот как раз а сегодня будет Вот Илья Кай шаури в 5:00 Рассказывайте как раз как мы планируем это сделать То есть мы этого не сделали но сделали первые шаги в эту сторону вот ну Об этом можно там отдельно поговорить а там Здравствуйте Да Вопрос такой вот вы рассказывали про шарды как они помогают Ну про резервные шорты вопрос следующим что если падает условно говоря основная шарда все переключаются на резервную и резервное обслуживает но резервная Как вы тоже сказали она холодная и каким образом тогда она получает сгенерирует дополнительную нагрузку за счет того что ей нужно дополнительно ещё сходить в архивную базу данных и тогда уже она начинает отказывать вот как тогда работать на самом деле Ну О'кей Мы думали об этом э-э архивной базы данных нагрузка не такая большая с точки зрения чтения потому что в реальности сервисов Ну клиенты обращаются к тем данным которые там лежат наверное где-то в 30-40% случаев всего э-э Вот это не так многоративная база она тоже разбита на самом деле в разрезе шарт Ну то есть когда клиент первый шарды пошёл в резервную Орду Прямо во вторую то за идет к архивной базе первые шарды То есть она на самом деле тоже шортирована архивная база Вот это первое второе по поводу того что у нас она холодная но мы ее на самом деле там используем механизмы прогрева различные я наверное не могу сказать как оно прямо сейчас реализовано да то есть я помню те механизмы которые там использовали серии там год два назад Вот направляя поток клиентов постепенно как бы прогревая каши на серверах Да и потом ошараша уже собственно говоря весь клиентский поток туда и у нас были планы по неким дополнительным сервисом прогрева но я не могу быть уверен что Они сделаны вот Да здравствуйте Александр Авито чек я вот видел был слайд по про прогноз Что вы там на 15 процентов В год примерно Растете вот вопрос такой как вот этот прогноз бизнес метрики да там да у скорее всего или количество входов вы переводите в прогноз именно технической метрики там количество там РПЦ там на сервис какой будет там через год в пиках там или средний есть какие-то подходы мы на самом деле вот практически все цифры которые считаем мы говорим про пики То есть когда мы в целом вот готовим систему к надёжности Да мы всегда все прогнозы строим только прямо по пикам Ну то есть условно вот недавно только там ребята прислали табличку э вот и средняя оно конечно если брать сутки да но значительно ниже будет Вот потому что понятно там ночью мало кто сервисами пользуется и так далее но мы всегда ориентируемся на пике поэтому когда мы говорим там про рост нагрузки Да там и так далее смотрим именно на пике а в целом у нас Ключевая Метрика это количество входов клиентских в минуту и количество документов Ну по сути транзакции да то есть сколько раз клиент там транзак начал например две ключевых метрике наших Нам сейчас вот здесь три как раз а на одном слайде были показаны разные точки входа в онлайн банк и мобильное приложение а ATM было отделено Хотя по функционалу кажется что это очень похоже штука это преднамеренно разделили на разные точки входа и просто так сложилось и пока этого их не объединили не мобильное приложение Web тоже обидно говорят тоже разъединено потому что это разные каналы обслуживания и один из основных принципов наших который мы используем Да но он базовый Тут ничего Супер это нового нет роккинс а-а это изоляция То есть каждый канал он существует отдельно да неким образом в своём мире у него свои сервисы Да там и так далее и мы стараемся максимально изолировать каждый канал от другого как раз чтобы если один из каналов упал или начал не знаю вести себя неадекватно чтоб это не привело к деградации других каналов Ну то есть условно atm-канал это меньше 1% нагрузки если брать весь Сбербанк онлайн если он в моменте упадёт кажется время нашей реакции Да оно может быть чуть-чуть другим при этом если упадёт мобильное приложение очевидно что мы должны вот прям просто моментально решить эту проблему там в резервную шарду направить и так далее То есть там уже нельзя говорить о плавной деградации Там как бы бежим вперёд а у вас есть репликация на несколько дата-центров Почему вы просто не переключать запросы когда там одна что-то падает другой дата-центр Да время перехода из дата-центра в другой дата-центр больше дольше по крайней мере у нас чем переход в резервную шарду переход в резервную шарду Он практически моментален вот а переход дата-центр занимает у нас по крайней мере определенное время Сейчас давайте так я рассказываю сейчас вот в конце двадцать четвёртого года архитектура на самом деле внезапно будет другой мы к этому стремимся может быть даже потом расскажем надеюсь о чём-то но сейчас это так э вот то есть там нам быстрее действительно перейти в другую резервную шарду чем э на другое плечо дата-центра при этом Отвечая на вопрос есть ли у нас правда короче Два два ряда по центру у каждой шарды Конечно же да то есть каждая шарда На самом деле у неё два дата-центра вот Ну и не шахматка естественно идут там отказа условно одного центров Так у нас еще есть вопрос вдалеке слева от спикера вот там вот заколонный накладчик как вы проводите на вычет тестирования сбола и удавалось ли вам выявить какие-то негативные кейсы до попадения до выивки смотрите Давайте честный ответ короче менеджерский на мой взгляд мы проводим недостаточно хорошо вот да вот как раз например один из доклада вот прошлый раз я рассказывал про трансформацию Монолита на микросервиса о котором я здесь не планировал рассказывать поэтому сейчас чуть-чуть расскажу э там как раз был кейс связанный со следующим что мы мигрировали у нас был топовый по нагрузке сервис э-э вот он был сделан на оракли нам аналитите у него была нагрузка Ну давайте из серии X мы перенесли его на точно такой же текст только на микросервис то есть там Oracle тоже версия короче те же 100 BD и так далее мы перенесли его на новый текст так она тот же самый простите так-то окна микросервисах прошли нагруженное тестирование которое показало что нагрузка составляет 0,1x вышли в пром а там оказалось полтора X Вот то есть это как бы наверное говорит о том что нагруженное тестирование Но скажем так не всегда хорошо у нас проходят но при этом на самом деле у нас э было много кейсов при подготовке к периодам пиковой нагрузки к казиновым когда мы выявляем проблемы на самом деле то есть у нас условно там ну вот есть входящие шлюзы Э да которые там запросы маршрутизируют между серверами и мы как минимум Да там вот дважды из того что я в онлайне сейчас вспомнил дважды выявляли проблемы на нагруженном тестировании который собственно говоря устраняли последующие оптимизации точно также у нас была проблема с хд которая поставил намбер а в проме мы не добрались ещё до той нагрузки э чтобы эту проблему выявить Однако на нагруженным тестировании мы выявили проблему с тем что по сути вендор не держит ту нагрузку которую нам обещал по крайней мере в нашей конфигурации и это предотвратило нам кроме Э давайте так пятая точка горела Потому что срок был очень короткий надо было срочно с этим что-то делать но как бы помогло ли нагруженным тестирование да так коллеги я прошу прощения у нас к сожалению заканчивается сейчас время на вопросы в зале но мы попросим Артёма не убегать и остаться в зоне перед залом с тем чтобы все желающие могли такие здороваться и всё спросить кому даем приза лучший вопрос Чёрт во-первых кстати подходите на стенд сбера а то меня девчонки И чаруют э-э вот я забыл об этом сказать Теперь не забыл Давайте лучший вопрос будет про цод потому что я его ожидал но не подготовился к нему Это было очень Логично Спасибо И у нас есть приз и для докладчика от ВК Маруся вместе с призом от конференции Спасибо пришли к нам в трек про архитектуры Мы совершенно уверены что трек от этого стало интереснее и лучше И пусть у вас всё никогда не падает супер спасибо спасибо"
}