{
  "video_id": "cN2dDVU3ZqA",
  "channel": "HighLoadChannel",
  "title": "С чего начинается биллинг облачных сервисов / Сергей Нечаев (Yandex Cloud )",
  "views": 344,
  "duration": 2890,
  "published": "2023-10-06T07:14:59-07:00",
  "text": "Всем доброе утро Меня слышно видно вот можно можно смотрите Я пока не открытие начну рассказывать так импровизации нам всем не привыкать Я пришел в отрасль в 2007 году и началось началась моя деятельность с того что я начал делать биллинг для Телеком провайдера когда я пришел у него была емкость 25000 абонентов он там уже трещал весь по швам и задачей было увеличить эту емкость до 150 тысяч абонентов ну и соответственно считать там трафик полосу все подряд про них и тогда это казалось серьезным прорывом Как же так там 6 раз увеличили емкость там вот они высокие нагрузки В общем биллинг сделали он работал и даже сейчас работает все с ним хорошо потом позанимался всякими другими вещами и в 2016 году мы начали проект Яндекс облако делать И там значит говорят А кто будет делать давайте я у меня опыт уже есть какой-никакое сейчас освежил Воспоминания и будем Значит делать биллинг И обнаружилось что как говорится фанфиках всяких Гермиона очень изменилась за лето то есть билинг для облаков он Кроме того что считает деньги у него крайне мало общего с биллингом для не облаков и про это собственно мы сейчас поговорим и про это собственно мы сейчас поговорим поговорим мы про это ребят кликер не работает доклад будет состоять из четырех примерно частей мы сначала поговорим о том чем облака отличаются от не облаков чем они такие особенные более хорошо спасибо большое да чем облако отличаются от не облаков потом проговорим Для чего нужен вообще биллинг те кто специалисты они знают Зачем он нужен то задумывается о том чтобы получать деньги за свои услуги первая мысль это в том что незачем больше не нужен только там считал описывать и деньги с карты списывать поговорим о том как данные о том что в сервисе что-то произошло за что стоит взять денег попадают собственно в биллинг и в конце важный пункт последнее слово Как говорится запоминаются мы поговорим Как выбирать для этого всего технологии и о чем нужно не забыть когда мы вообще затеяли билинг нашего сервиса Итак поехали Да мы видим на слайде количество событий за которые стоит взять деньги в день во-первых сейчас оно измеряется в миллиардах это уже звоночек что без хайловода здесь не обойдется во-вторых здесь можно заметить что Примерно в четыре с половиной раза растет год от года количество этих самых событий соответственно если архитектура их обработки не заточено под такой рост что будет будет примерно то же самое что с биллингом для телефона с которого начинал работу что емкость какая-то насыщена дальше расти В текущей архитектуре невозможно что с этим делать никто не знает о времени переделывать уже нет потому что ну спрос есть за счет чего такая масштабируемость возникает она возникает за счет роста по сразу по нескольким измерениям во-первых если наш сервис хорош у него в нем появляются новые пользователи они появляются и потому что сервис хороший полезен и потому что в принципе облака достаточно быстро из какой-то экзотики становится стандартом в индустрии и какие-то решения мало кто уже рассматривает во-вторых количество данных о потреблении растет за счет того что растут сервисы и продукты которые в них есть облако начиналось например сервисы виртуальных машин сейчас у нас больше 50 сервисах в таких больших зрелых международных облаках оно тоже измеряется в сотнях ну и соответственно еще один источник роста это потребление одним пользователем за счет того что и сервисов больше появляются и дела у этих ребят которые заехали лучше идут потребление одного пользователя растет больше потребление больше данных о нем больше данных нужно обрабатывать ещё у облаков есть особенность что облачные сервисы Не сами по себе А укладываются в какую-то иерархию там или пирамидку многие видели эту картинку Как устроены облачные сервисы они Практически во всех слайдах про облака есть коротко изложил основную идею что можно выделить несколько слоев и сервисы на очередном слое используют сервисы с предыдущих начиная там от базовой инфраструктуры это инфраструкции сервис там виртуальные машины сидит диски до собственной сервис когда мы конечно ему пользователю какие-то ценные для него вещи предоставляем здесь принципиальный момент в том что все эти слои пирамиды они могут предоставляться разными партнерами что-то самой обычной платформы что-то партнерами которые на ней размещают свое решение но при этом скажем так конечный пользователь он заходит в одну консоль и скажем так видит Расходы оплачивает потребление всего к целиком все что вам есть поэтому я назывался Какие выплаты мне положены этим вопросом задается Партнер и поэтому вместе с тем чтобы рассчитывать сколько пользователь должен занести денег за услуги необходимо рассчитывать также Сколько денег необходимо всякими этим партнерам перечислять в качестве вознаграждения там возникают сложности с налогами с разными резидентствами и так далее важно Это все предусмотреть так это мы проговорили переходим к разделу Зачем нужен биллинг Кроме того чтобы там брать деньги радовать инвестору что их много принесли может так случиться что мы захотим ограничивать наш сервис Тем кто за него не платит может такое не случится но коммерческая деятельность заточена на то чтобы тем кто платит давать пользоваться сервисом тем кто не платит не давать Так что там у нас дальше с кликером вот нам нужно знать кто эти люди которым нужно выставить счета нам нужно знать что мы продаем и на каких условиях что здесь еще важно как вы видели на предыдущих слайдах количество сервисов растет количество продуктов в них тоже растет и необходимо предусмотреть механизмы которые позволят там в один клик заводить десятки сотни продуктов чтобы не было такого что там не знаю появилась новая конфигурация виртуальной машины надо собрать там 10 подписей 5 печатей чтобы это все стало доступным пользователем так дальше собственно За что мы все оценим биллинги особенно бизнес это прием денег от населения и деньги мы берем не просто так а на основании того что что-то случилось и мы посчитали сколько это стоило Ключевой вопрос который стоит задать и себе и всем вообще в принципе когда задумаешься о деятельности где нужен биллинг Нужно ли платить чтобы пользоваться нашим сервисом Бывает так что не нужно вспоминаем мем про праздник в компании WinRAR хоть когда кто-то у них купил лицензию бывают такие благотворительные сервисы когда просто висит там форма на сайте там подойти кто сколько сможет нам на хостинг И все кто хочет Владик Кто хочет не платит никакой интеграции систему контроля доступа здесь нет она не нужна но если хочется зарабатывать серьезные деньги она нужна теперь что касается связи занесения денег и возможности пользоваться услугами есть два варианта как ее организовать первый вариант к чему привыкли абоненты сотовой сети там и физлица абоненты там провайдеров интернета это предоплата что пользователь сначала первым делом заносит деньги куда-то на лицевой счет начинает их тратить Как только они все закончились его там сначала предупредят а потом все выключат что здесь важно Это то что При таком способе организации приема денег мы говорим что как только порог какой-то ухода в минус пересечен Мы должны немедленно остановить оказание услуг и к чему это может привести что не успели там пополнить счет на 100 рублей грубо говоря и остановился какой-нибудь продакшн важный Или там интернет-магазин или какая-нибудь еще инфраструктура минуты простоя которой стоит гораздо больше чем вот эти 100 рублей которые забыли заплатить просто платный биллинг он наоборот он про другое там в течение отчетного периода люди потребляют сколько хотят никто их никак с точки зрения биллинга не ограничивает а после чего выставляется счет и дается какое-то время на его оплату И если уже счет не оплачен там дозвониться не удалось никаких нет причин не блокировать человека тогда уже принимается решение что все хватит аттракцион благотворительный невиданной щедрости пора прекращать и здесь уже такая оперативность как случае предоплат на мобильный не нужна если мы несколько дней давали на оплату счета то несколько часов на то пока там блокировки доползут мы вполне можем подождать это было такая витиеватая объяснение Почему у нас постоплатный виллинг они предоплатный биллинг Поехали дальше нам нужно знать кто эти люди мы оказываем услуги можно хранить досье Примерно вот в таком виде но на самом деле есть какие-то стандарты отрасли и законодательство которое обязывают хранить их строго определенном в каждом юрисдикции Они свои Что здесь важно я конкретно не буду останавливаться специфики просто скажу что вот все данные о компаниях чаще и о людях это чаще всего персональные данные Если вы их храните вам нужно хранить их в соответствии с местным законодательством и Быть готовым ко всякому роду аудит так так так дальше у нас то что называется документооборот и платежи в чем здесь смысл мало посчитать Что сколько стоила надо уметь принять за это деньги и устроить какой-то формальный документооборот на эту тему какие здесь могут быть варианты варианты могут быть Либо вы уже что-то продаете У вас есть система которая все это отслеживается и вы еще один свой сервис в нее заводите отличный более-менее понятный предсказуемый путь мы ровно по нему и пошли то есть облако это далеко не первый платный сервис Яндекса а второй путь это какое-то стороннее решение под ключ примером такого решения является например Stripe Когда вам говорят что чуваки У нас есть сервис у него есть API не о чем вообще можете не беспокоиться хотите хранить карточные данные и снимать с них денег пожалуйста хотите выставлять счета пожалуйста налоги за вас посчитаем контрагентов за вас проверим Все для вас сделаем то есть это с точки зрения разработчика очень удобно и легко с точки зрения владельцев бизнеса и вообще ответственных за бизнес тут есть следующая особенности во-первых это всё стоит дорого каждая операция каждая Услуга стоит какого-то процента от суммы счёта и так получается что процентик за карточную транзакцию сверху комиссии платежной системы в проценте их за формирование счёта процент налогов немного того немного сего раз 10 процентов от всех входящих денег вы отдаете сторонним людям это дорого Кроме того в свете всяких внезапных событий которые могут произойти такого рода сервисы могут Без объяснения причин отказывать в обслуживании на реддите много жалоб на то что там компания не будем ее называть Какая которая примерно тем же самым занимается она просто расторг договор одностороннем порядке всем покупателям Вернула деньги по картам и чуваки которые сделали сервисы остались в некоторых недоумении скажем так типа как же нам теперь жить все деньги которые мы взяли от пользователей у нас забрали обратно новые пользователи не могут заплатить что делать вообще мы не можем исполнять обязательства свои так прошу прощения Ну и Путь самурая это разработка своего решения Если вы Большой бизнес вам оно Возможно понадобится если Вы только начинаете то скорее всего Нет это Путь самурая о нем надо отдельно рассказывать Мы сегодня не успеем так так так так вон это вообще важный одна из ключевых мыслей доклада о чем стоит задумываться при интеграции с этим всем то есть смотрите у вас допустим есть сервис чайник военный Solutions так Я его назвал который что-то продает вы придумали Зачем он нужен какая у него объектная модель объяснили это пользователям все знают все понимают Все короче классно и вы придумали биллинг для него который знает немножко про этот сервис потому что он должен знать за что он деньги берет и у него есть еще какая-то собственная объектная модель продукты услуги там контрагенты кто-то там еще не важно тоже это все что вы сделали вы этим управляете и тут вы начинаете думать все здесь мне нужны живые деньги живые документы у меня есть сторонняя система которая умеет принимать платежи подключу-ка я ее и вы подключаете и вот если объектная модель вот этой системы просочилась сюда она становится очень сложно отделимой от бизнес логики вашего приложения от билинга и может привести к следующему например успешный бизнес в России все сделали деньги там идут рекой все хорошо Вы думаете Все пора на международный рынок и короче вот эту всю свою систему начинаете разворачивать уже где-то международный юрисдикции какой-нибудь и думаете мне нужен биллинг надо как-то принимать теперь деньги и тут так раз у вас вылезает какой-нибудь чисто российское явление или Ну явление российской бухгалтерии это не так еще плохо как могло бы быть если вылезает какая-то сущность которая чисто существует в рамках вот этой системы по приему платежей и документов и больше нигде не используется Все короче эта штука с вами навсегда и работы по ее искоренению сравнимы с разработкой нового биллинга поэтому здесь очень чем раньше чем дальше она будет от корневой объектной модели вашей предметной области тем всем будет спокойнее знаю знаю людей скажем так у которых которые на это наступили Поехали дальше теперь собственно про хайлоад мы поговорим про то Как обрабатывать данные и как их доставлять собственно данные зависит от того какие какой у нас учет потребления самый предельный случай когда надо запуститься быстро это когда у нас никакого учета потребления для Нет вообще просто висит форма для сайта заносите денег если вам все нравится и все мы учитываем входящие деньги но никакой связи с тем За что мы взяли Нет что-то более сложное это разовые продажи но здесь тоже никакого highlo нет Если у вас там не гигантский интернет-магазин здесь факт оказания услуги не отделим от фактов взятия денег то есть как только кто-то задумал что-то купить мы знаем что он покупает и по какой цене все это событие случилось мы за него взяли деньги с Чарли карту расстались значит с покупателем мы получили деньги Он получил товар все больше про это знать ничего не нужно в Реал тайме вот вещь посложнее Это когда у нас есть подписка и есть какие-то регулярные платежи Здесь тоже мало чего нужно отслеживать то есть либо у нас на уровне сервиса есть ограничения что в принципе Невозможно ничего употребить за рамками подписки либо это ограничение проверяем не мы либо мы это тоже какие-то незначительные данные самый тяжелый случай с точки зрения это митинг биллинг так называемый это когда каждый чих каждое событие каждое там у липучечное изменение в сервисе Возможно стоит денег проработал виртуальная машина минуту надо заплатить кто-то что-то положил в истрее забрал из него тоже каких-то денежек это стоит на диске что-то пролежало опять про это нужно событие и соответственно нужно обработать и понять сколько она стоила Ну и как мы видели раньше количество таких событий измеряется в миллиардах что же у нас теперь теперь поговорим про то что происходит вот у нас есть сервис вот у нас есть его билинг они друг про друга пока мало что знают в сервисе что-то происходит Ну и с другой стороны билинг может задумываться о том типа не пора ли за что-нибудь взять денег этих двух ребят Надо как-то друг с другом связать как это можно сделать можно сделать это тремя способами сейчас коротко Мы про них поговорим довольно простая вещь для понимания это Push схема когда сервис отправляет в биллинг события простая но есть У нее особенности которые могут скажем так не в пользу неё сделать выбор то есть во-первых мы здесь возлагаем на сервис ответственность за хранение данных пока он их не отправит если у нас серый сбора данных развернут на железных машинах такое тоже иногда бывает то если железная машина ушла по каким-то причинам А если Ну если таких машин десятки тысяч то велика вероятность что кто-нибудь из них какой-то момент времени и уйдет ну и соответственно и пропадет она вместе со всеми не отправленными данными второе момент мы в такой схеме должны обеспечить для билинга который события принимает устойчивость взрывной нагрузке Если вдруг ничего не происходит ничего не происходит ничего не происходит его обратил внимание на то что довольно долго ничего не происходит там какой-нибудь Купер перед инициализировал что-нибудь конфликт поправил и все не отправленное в последний месяц за весь месяц полилось Ну пять миллиардов событий в день Это много но 150 миллиардов это гораздо хуже если они все полетят Вот соответственно биллинг часть из них примя часть из них не примет что-то надо будет повторно отправлять и вот это повторная отправка приводит к тому что надо все-таки уметь обеспечивать чтобы она там где-то лежала но общем для хайлоуда Мы решили что это не подойдет второй вариант это когда сервис все хранит у себя биллинг забирает когда Ему удобно это скажем так есть свои плюсы у этой схемы потому что билинг знает кого он попросил кого Он меня просил Но это по-прежнему возлагает на сервис обязанности хранить данные и Кроме того каждый новый сервис должен у себя где-то поднимать вот этот какой-то там http или grpc или какой-нибудь еще интерфейс для того чтобы события у него забирались не всем не во все сервисы можно такой сервер строить компромиссным вариантом нам видится очередь сообщений как некий транспорт некий буфер что сервис туда данные складывает обильно Когда удобно ему забирает плюс у такого подхода мы видим следующим что это следует из названия что сервис его через сообщение Он предназначен для того чтобы передавать сообщение и поэтому в рамках этой узкой задачи можно сделать решение которое будет решать именно эту задачу и делать это хорошо мы комбинируем здесь преимущества и для сервиса и для билинга то сервис может быстро туда что-то закинуть и считать что все надежно хранится биллинг Когда удобно заберет для распространенных очередей есть СДК то есть не надо людям самим протокол работы с очередью реализовывать и что здесь самое важное можно организовать Единый центр обслуживания этой самой очереди то есть люди которые мониторят есть люди которые там сопровождают довозят очередные релизы что все с ней было хорошо и обладают богатой экспертизой в этом месте Поэтому собственно мы выбрали в качестве транспорта очередь сообщений так теперь поговорим Вот про что то есть вот сообщение у нас как-то доставили биллинг как-то их обработал и в базу данных их сложил какого рода нагрузка на эту базу создается выделяют два типа нагрузки это когда у нас один из них это OTP Когда у нас есть множество небольших изменений независимых данных и есть онлайн аналитика по процессинг это когда никакого изменения данных нет вообще но мы считаем какие-то тяжелые агрегаты выгребаем все подряд строки что-то по ним строим всякие инстаграмы там процентили все подряд и разные скажем так базы данных заточены под разные какие-то умеют хорошо процессе транзакции маленькие какие-то хорошо работают для аналитики и из этого следует что не обязательно У нас должна быть какая-то одна мастер база которую мы заставим делать И то и другое Поэтому в нашем случае данные устроены следующим образом вот у нас есть сервис в котором что-то происходит и он отправил сообщение в очередь и забыл все он после того как данное правило считает что все что нужно было делать для Беринга он сделал на этом его война закончена он может заниматься дальше своими делами вот после того как события попали в очередь сообщений происходит следующие вещи у этой очереди сообщения есть два читателя важно чтобы их было два первый читатель это его Задача в том чтобы ничего не трогая Никаким образом не модифицируя полученные данные просто сложить их как есть в какой-то надежное хранилище где они потом могут понадобиться может быть и нет зачем это нужно такую штуку сильно просто отлаживать это раз во-вторых если у нас билинг что-то вдруг неправильно посчитает или потеряет или возникнет какая-то Спорная ситуация мы можем сопоставить то что у него получилось на выходе с тем что у него было на входе и принять решение правильно это было или нет Вот про это мы проговорили теперь поговорим про биллинг биллинг события обработал посчитал сколько денег стоило обновил какие-то счетчики какие-то разрезы и обновление случается сразу в двух базах мы обновляем данные в базе который обрабатывает транзакции то ОТП и на ее основе принимается решение по ранее пора заблокировать пользователя Может быть там письмо какую-нибудь послать или там графиком найти употребление или еще что-то сделать но эта база не подходит для того чтобы смотреть что происходит в сервисе В целом по другой базе происходит пока всякого рода графиков для топов для администраторов сервисов для всех кому интересно картина целиком Сколько денег за сервис занесли Сколько всего событий случилось Ну и так далее так так так так переходим теперь к тому как нам Из каких частей это все строить Как выбирать технологии о чем нужно не забыть переходим что нужно выбрать первым делом это базу в которой мы будем хранить данное потребление первое что мы от нее хотим Это масштабируемость потому что Облачный сервис и очень очень все промасштабируемость если база плохо растет то она нам точно не подойдет второе это мы хотим чтобы база умела вычисление с фиксированной точностью смертный грех в разработке это считать деньги во флотах вот сразу нет а дальше Мы хотим чтобы на наши с нашей базой можно было работать на любых распространенных языках программирования чтобы не ограничивать разработчиков стыков технологий так и здесь Прошу прощения этот слайд должен был называться выбрать технологии в скобках которого у нас не было То есть когда мы начали делать билинг было множество решений которые здесь могли бы подойти Но помимо всего прочего у нас была цель облака у команды предоставить сервис подобный базы данных распределенных пользователей и прежде чем давать ее пользователям мы должны убедиться были что на нашей нагрузках в нашей боевую сценариях то что мы хотим предложить оно выдерживает и тут представляем Вашему вниманию базу данных в idb сейчас она в наше мы скажем так на старте она была если честно достаточно сырой когда мы только с ней познакомились но сейчас Уже довольно долгое время она выдерживает наши нагрузки наши масштабы она держит 300 тысяч транзакций в секунду и совершенно не заставляет как-то беспокоиться о том что куда-то где-то мы можем упереться в потолок Отличная хорошая вещь Так теперь про улап про базу данных для графиков здесь на самом деле все те же самые требования что касается масштабируемости и фиксированной точности потому что в конечном итоге там где биллинг там всем интересны деньги Вот но здесь что стоит сказать есть два сценария для аналитики и для них могут быть разные решения первый сценарий это практически в реальном времени какие-то графики в моменте смотреть что типа денежки крутятся нам что-то происходит это Click House здесь практически альтернатив мы никаких не видим но еще бывает задачи что кроме того что надо посмотреть что-то в моменте надо построить какую-то тяжелую суровую аналитику там слить данные из разных систем там базы данных разных сервисов какие-то серым какие-то еще данные откуда что-то там притянуть все это сварить в какой-нибудь куб и напустить на него аналитиков которые будут искать в нем закономерности это тема отдельного и ни одного доклада если вам такая штука нужна ничто не мешает вместе с там слово базой наливать зеркало еще и туда и уже варить эту тяжелую аналитику отдельно далее далее очередь сообщений здесь опять придется повторится когда только кликер сработает кликер Здесь нам по-прежнему нужно масштабируемость и так что происходит языка для распространенных языков и что особенно нам важно Это семантика точно один раз заставить сообщение на уровне протокола то есть тех очередях сообщений где этого Нет нужно придумывать какие-то ухищрения как бы сделать так чтобы то что отправлено один раз было бы прочитано ровно один раз без потерь и без дублей то есть хуже чем потерять деньги это взять деньги два раза за одно и то же для биллинга это неприемлемо и в случае облачных решений это конечно же стоимость То есть если мы рассматриваем какую-то Облачный сервис для передачи сообщений надо смотреть во сколько он нам обойдется и что нам будет дешевле использовать сервис семантикой exect levance или самому ухитриться построить ее поверх сервиса без такой семантики так и здесь мы рекомендуем обратить внимание на Яндекс это Еще одна история про выбор технологий которая у нас сначала не было теперь есть раньше эта штука внутри Яндекса называлась брокер Это небольшой сначала была поверх Кафки потом сделалась самостоятельном решением и приобрело семантику экзек-ливанс то есть здесь очень удобно можно отправить сообщение и убедиться после этого что второй раз его отправлять не надо про Яндекс будет отдельная доклад рекомендую на него сходить в программе когда то есть так переходим теперь к самому важному То есть вот мы захотели считать стоимость того что в наших сервисах происходит Что для этого понадобится нам понадобится Контракт по поставке события сервисов пока у нас все сервисы поставляют события абсолютно одинаковым образом все классно мы можем хоть Каждый день подключать новые сервисы если у нас у каждого сервиса свой протокол общения нам во-первых каждый раз нужно разработка чтобы этот протокол поддержать во-вторых потом этот зоопарк протокол становится не поддерживаю Поэтому лучше сразу в рамках команды в рамках всего большого бизнес-юнита или кого-то еще договориться что метрики биллинг мы поставляем абсолютно одинаковым образом и здесь кстати не так важно можно вернуться к выбору транспорта там Каждый выбирает что ему важно что ему удобнее если сначала выбрали что-то одно а потом поменяли на что-то другое это никаких проблем нет но если у вас с каждым сервисом свой контракт по поставке метрик потом будет очень сложно порядок в этом всем навести далее единое решение для того как эти метрики поставлять повторюсь мы рекомендуем очередь сообщений Но ничто не мешает вам выбрать свой путь далее Что такое потоковая обработка смотрите у нас приходит миллиарды событий в день если для того чтобы вычислить стоимость очередного события нам нужно перешерстить все то что мы получили для этого это сложится потому что это минимум квадратичная сложность Если же мы используем только данные из самого события и какие-то предпочитанные агрегаты Эта история уже масштабируется и мы можем грубо говоря заливать железом при росте все классно все работает Ключевая здесь мысль в том что если при получении нового события стоимость ранее потребленных услуг никак не может уменьшиться все отлично работает и вы готовы к масштабированию далее нужно выбрать базу Где хранить счетчики данное потребление опять же рекомендую выбрать здесь в ADB но тут по крайней мере его посмотреть Далее вам понадобится хранить сырые события они скажем так их понадобится хранить но обращаться к ним понадобится крайне редко поэтому здесь надежность и дешевизна хранение пожалуй приоритет может быть супер холодное хранилище их закинуть и надеяться что не понадобятся никогда далее Ну и зеркало для графиков Вот это вся история про то как рассчитывать стоимость дальше история про то как брать за нее живые деньги во-первых это очень трудоемкая история но при этом опциональная если у вас какой-то сервис в рамках предприятия где Не предполагается выставление каких-то счетов подразделением и не предполагается какой-то прием реальных денег можно про это на старте вообще не думать просто посчитали Что сколько стоила и на этом все никаких там счетов фактов там карт хранить ничего этого не нужно но если все-таки нужно и вы затеяли неважно что там какой-то стороннее решение коробочное или уже там существующие вашей компании вы затеяли разработку Ну что здесь важно Это объектная модель про документы платежи карты и так далее Она должна быть крайне изолированная от корневой объектной модели вашего сервиса чтобы она была отчуждаемой случае необходимости можно было или выкинуть или заменить вот на этом У меня все Большое спасибо за внимание буду рад вашим вопросам обратная связь по докладу доступна по ссылке Ну и Приходите на стенд Яндекс Яндекс клауда там сегодня будет много интересного Спасибо про то что те вопросы которые вы сейчас будете задавать у нас Спасибо за доклад два вопроса один Насколько быстро у вас приходят данные о биллинге то есть сколько деньги то есть текущей реализации когда мы узнаем что деньги закончились или нет Или это для вас не критично и второй как с валютами разных странах или у вас такого нету у нас все есть Спасибо большое за вопрос за вопросы первый вопрос когда-то у нас была реализация где время от того что что-то случилось до того как это отразилось на скажем так балансе лицевого счета назовем это так и вообще на состояние там пара не пара заблокировать В общем до того как пользователь увидел эти изменения тогда это измерялось в диапазоне от 2 до 4 часов Но это стало неприемлемым как для нас так и для пользователей но то грозило превратится в историю с чуваками которые съездили в Египте в Египет и посмотрели там Интернов думали даже заблокировать эти деньги кончатся в телефоне потом Выяснилось что это поездка им обошлась там сравнимые деньги с просмотром серии вот поэтому мы переделали этот старый механизм на вот новый про который рассказывал и сейчас единицы минут на 5 миллиардах это приемлемо про валюты у нас поддерживается несколько валют до и мы считаем потребление у нас скажем так цены могут быть заданы как в рублях За какие-то продукты мы их пересчитываем валюту биллинг аккаунта либо для bying аккаунта мы можем переопределить цены именно в его валюте тогда никакой конвертации не происходит если что 110 долларов за минуту оно так и кажется 10 долларов за минуту без какого-либо конвертации пожалуйста еще вопросы Добрый день спасибо за доклад два вопроса тоже на слайде powerlab вы обошли название вашего выбора для системы хранения ПВХ И второй вопрос в случае с пост оплатой допустимо не потоковый алгоритм расчета хорошо спасибо за вопросы про двх у нас эти аналитические кубы варятся поверх внутренней системы войти которая ну по сути мы придется подобным языком поверх неё но еще существует там решение там на базе там спарка грин-плама то есть в эту сторону можно посмотреть ключевые слова то здесь у меня экспертизы нет могу рассказать как у нас вот второй вопрос Напомните пожалуйста в случае с пост оплатой допустимо или не потоково рассчитывать а опираясь на стоит уже хранимый Ну смотрите оно формально допустимо Но для людей не очень удобно то есть людям важно прогнозировать свои расходы уметь для этого лучше видеть сразу как встречается во-вторых у нас в Облаке есть функционал бюджетов то есть пользователь может задать Сколько денег он готов на что-то потратить и сказать предупредите меня пожалуйста когда будете знать что я эти деньги потратил я там приму меры какие-то и вот не потоковая обработка данных делает Невозможное такой функционал то есть узнаем о том что бюджет пробит когда он уже там много десятков тысяч пробит и никто не будет рад Давайте еще к вам еще подойду Да и потом у нас еще будет Вопрос из чата Спасибо за доклад что-нибудь по поводу стратегии когда суммы в знаках после запятой там несколько там 8 их может быть то есть допустим ртб системы когда мелкие суммы вот как какую стратегию выбрать что посоветуете но смотрите здесь стратегии может быть две например в Google клаудформе сделано так у них есть какие-то абстрактные юниты и нано юниты И то и другое без знаковое целое число по-моему там 8 байтовые туда они в таких юнитах без закруглений может считать довольно точно и уже приводить к валютам в самом конце у нас немножко по-другому мы с самого начала в том числе для того чтобы появилась поддержка типов данных стали считать все наши счетчики все наши суммы в девяти знаках после запятой Ну а всякие агрегатов 13 при этом мы считаем с таким округлением и формируем счета до там копеек рублей там Йен чего-то там еще там минимальный какой-то валютной единицы только в самом конце чтобы не копить ошибку округления Спасибо за вопрос еще раз у нас вопросы с чата для начала Антон Рябченко спрашивает планируете ли вы давать рекомендации по использованию сервисов оптимизация расходов на основе собранных данных и аналитики планируем Но точно сроков Я готов не назвать то есть много запросов на эту фичу есть но она не так проста в реализации Спасибо Здравствуйте вы сказали что Соответственно билинг по какой-то причине может насчитать некорректные данные и соответственно вот эти трое венцы вам нужны для того чтобы по ним ретроспективно понять правильно ли было принято решение А что делать если стало понятно что решение было принято неверно как вмешаться такой обработку данных извиняться на самом деле Спасибо за вопрос важно помимо того чтобы обнаруживать что что-то пошло не так и иметь первоисточник важные важны какие-то механизмы Чтобы потом сделать все правильно вот у нас такие механизмы есть но в их детали я пару раз сейчас не готов Скажи пожалуйста раз раз так Сергей пока тебя одевают я тебя несу микрофон чтобы ты мог уже начать отвечать сейчас сразу два буду говорить раз два три я повторю вопрос потому что он был задан Да что такое я повторю вопрос потому что он был задан без микрофона чтобы в записи Он тоже был и кто нас смотрит трансляции увидели нас спрашивали Что если две базы данных одновременно наливаются по одному источнику одна для лап для графиков другая для того что вообще бизнес логику делать Каким образом обеспечивать между ними консистемность Ну на самом деле строго консистемности здесь нет и она и особо не нужна здесь есть то что называется то есть когда-нибудь они станут одинаковые и нам на самом деле в каждой из вас Достаточно знать время момент времени на который все обработанные данные от сервисов попали в ту или иную базу этого достаточно того чтобы принять решение и для наблюдателя для графиков и собственно для того кто обрабатывает данные базе так но я думаю вопросы Все у меня один вопрос от себя есть когда ты показывал взаимодействие с другими стенами шинами сообщения и так далее Скажи есть ли у вас какая-то стандартизация по работе со схемой сообщений которые вы отдаете в брокер используете ли вы какие-то стандарты вроде осинкай и подобных вещей какие-то стандарты есть но не те которые ты назвал то есть мы во-первых у нас сам сервис работает поверх grpc у него есть собственный протокол как в него складывается сообщение иной языка которые позволяют поэтому протоколу писать во-вторых У нас как я говорил стандартизирован формат входящего сообщения там и от сервиса на уровне нашей бизнес-логики чтобы все писали одинаково спасибо Ну а теперь время выбрать два вопроса которые тебе больше всего понравились мне понравился вопрос про скорость обработки данных как то что случилось отражается на детализации графика которых вины пользователю и мне понравился вопрос про постоплату и не потоковую воронку данных ребят Поднимите руки чтобы наш помощники могли вас быстро найти и Подарить вам подарки и от Яндекс Клауд и от конференции Сергей Спасибо тебе большое это было замечательное выступление и от себя тоже хотим тебя сделать маленький подарок президент от конференции за это классное выступление Давайте поаплодируем Сергею Спасибо большое друзья а я прошу вас не забывать голосовать за доклад и Приходите сюда уже через несколько минут здесь начнется тех толк"
}