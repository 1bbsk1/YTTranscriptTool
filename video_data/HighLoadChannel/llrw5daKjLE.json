{
  "video_id": "llrw5daKjLE",
  "channel": "HighLoadChannel",
  "title": "Хождение по граблям PDO / Валерий Горбачев (Delivery Club) (дубль, но без вопросов в конце)",
  "views": 140,
  "duration": 1571,
  "published": "2024-04-17T00:59:44-07:00",
  "text": "Всех приветствую Давайте знакомиться Меня зовут Валера Я работаю старшим разработчиком в Delivery Club также я занимаюсь развитием PHP сообщества в Краснодаре немного спикер занимаюсь опенсорс проектами вот об этом опыте и поговорим Ну конечно же шутливый план доклада Хотя в чем-то есть правда все о чем я буду рассказывать это мой личный опыт с вашим может не совпадать и не обижайтесь если что-то напутал здесь qr-код что-то напутал напишите мне Ну и как я изучал базы данных Ну конечно же все было на самом деле не так Я начал из файловых баз данных То бишь это стипензированные структуры данных затем перешел на dbf затем узнал о существовании SQL начал изучать по книгам документации и мне казалось поначалу что я умею уже писать запрос все было очень просто я вставлял строчки в строчку запроса свои данные даже иногда заботился о безопасности в какой-то момент Я как мне как и всем приходилось сохранять строковые данные и меня взломали так я узнал про уязвимости начал выскейпить данные дела так не один год потом искусственно Меня заставили перейти на мой sqli он стал лучше когда мои скользите прикете ли и Собственно как было вот сначала появился моисп потом педио появился Майской ленте ребята решили избавиться от лицензионных ограничений переписали все оракла на свое Затем все это произошло полный переход отказались стали использовать майскую ленди библиотеку под капотом и в какой-то момент мои SQL сделали за депрессии пометили устаревшим и удалили со старым кодом надо было что-то делать я конечно активно использовал те моменты Оре но до Старого кода надо что-то делать я начал выбирать посмотрел на сторону мои Сколь а сторону pdio Мне не надо было не асинхронность там неподготовленные с коэль запросы на стороне клиента и обо всем этом даже не задумывался но единственно что я для себя запомнил что используя ПДД легко можно переехать на другую СУБД для старого кода я себя проблему решил так Я просто заменил подчеркивание и чуть-чуть подрихтовал код собственно все и на этом можно было восстановиться новых проектах Я использовал состава фреймворков билдеры вот это все на старых перешел на мой sqli где-то на новых стартанулись видео там где был немецкую вообще это было классно Но я периодически вот букв я путался это приводило К неким последствиям Мне казалось что это лекарство от всех проблем классно код абстрактный сырые запросы писать не надо к very Builder это очень клёво кот классно читается вхождение опять же ниже мне очень понравились к very Builder и кот не слишком привязан к движку Беги соответственно я перечислил там несколько оремок и без обобщений дальше я буду говорить потому что с ними можно наибольший опыт Да конечно там нет и гибкости как при написании сырых запросов сложные запросы вообще писать сложно там приходится если хочется под запрос засунуть приходится там колдовать экспресс нами Конечно же работает немножко медленнее чем нативные библиотеки Legacy по принципу так сложилось это то что не всегда разработчики библиотеки ради вас начнут что-то исправлять мы все это прекрасно понимаем Ну и самый главный наверное недостаток развиваться это все начиналось во времена доминирования mysql поэтому там мой Ферзь подход и поддержка других баз данных она по принципу лишь бы было Ну и вообще как бы мне всю жизнь По всей видимости меня это мешает использовать в рамки я написал несколько вариантов докладов про которые тоже можно было бы рассказать отдельно что я там занимался свое время клипером это во время коаксиальных сетей было потом занимался билдеры Парадокс это Первое знакомство со скуэлем против Москвы вот эти вот проблемы перехода потом я занимался транзакции с ql и это были первые ласточки когда ребята сказали Мы хотим для нашего проекта чтобы вся бизнес-логика по биллингу была процедурах то есть у нас там может быть любой абсолютно другой стоп решение либо решение и мы будем начислять задолженность клиентам и так далее потом я работал в компании занимались интеграции печки и взаимодействовали практически без табличек через табличный функции через хранимые процедуры Ну и в какой-то момент Вот мой классный опыт который мне помог это msql мы капсулировали писали запросы инкапсулировали хватит плюс а потом на стороне PHP использовать в общем Гарри Поттер и Орден Феникса Ну и пропустим все это ностальгию как было у меня я познакомился с Сашей макаровым поковырялся в едва применил свой опыт у нас SQL и понял что мой поверхностного от разных беде где-то нужен Так я познакомился с вилмером и мы вместе рефактором isoft db Ну и как вы сами Понимаете в основе isoftb лежит видео а конечно же с чего начать изучать видео с документацией как-то раз на конференции для джинов абсолютно Недавно я задал вопрос ребята Поднимите руки кто читает документацию поднял ли руки практически весь зал Я говорю а теперь Оставьте поднятыми Руки только те кто читает документацию до того как что-то случилось Ну как вы сами понимаете лес превратился в разрозненные деревья которых было очень мало попробовав пидео после вот этих вот буков С Ай мне показалось что благодаря Player постановка данных может быть очень удобной магии никакой Все выглядит очень просто пишем запрос делаем плейсхоузеры подготавливаем выражение исполняем все взято из официальной документации никакой магии возможностью видео тоже огромные поддерживается куча баз данных Но вот я желтеньким посвятил то с чем работал сам наверное ваш опыт схож с моим может быть нет но это самое используемый по моему мнению Кроме того в какой-то момент рыночек побежал вперед и мы отказались от My sqlo полностью который якобы рассчитан на большие нагрузки он стал новым отраслевым стандартом его должен знать каждый уважающий себя разработчик Вы помните Да я запомнил что используя видео можно легко перепрыгнуть на другую базу данных в одном проекте нам пришлось также делать но Выяснилось что запросы все-таки строятся по-разному универсального кода не бывает И вообще бывает Но работает неожиданно Ну и давайте начнем с простого я расскажу про используемые режимы видео для выборки данных Начнем с того что используют все как мне кажется по крайней мере я делал так Я использовал либо выборку в ассоциативный массив либо в объект и мне этого было более чем достаточно но затем Я почитал документацию выяснил что есть куча замечательных режимов Например можно выбирать ключ значения То есть первый Первая колоночка это у нас ключ остальное значение следите за уникальностью сами что данные не пересекались не перезаписываются и то же самое можно сделать используя первое значение опять-таки как ключ а остальное будет получаться в виде массива тоже очень удобно фич гроб это с группировкой Ну допустим для построения каких-то простейших меню двухуровневых Вполне себе подойдет также есть фичнейт если у нас допустим мы используем звездочку в выборке и значение название колонки повторяется мы там много табличек на Joy или потерять их не хотим вот фичнейм нам поможет также есть феечку Остап это вообще мой любимчик Он позволяет все это дело сразу выкладывать в класс причем классно определяем прям запросе мне это очень сильно напомню паттерн абстрактная фабрика и я задумался что в описании написано что недостающие поля будут добавлены динамически И как я слышал 82 с динамические динамическими полями уже будет беда их будут выдавать пока предупреждения в девятке вообще уберут В общем будет работать в девятке непонятно вообще есть ли еще занимательные флаги Конечно же можно заменять строчки на пустые строки на нулы на пустые строки работает и не только для оракла я проверил спуск тоже прекрасно работает можно вводить верхний или в нижний регистр колонки в ассоциативном массиве это тоже классно про это сейчас будет история и 8.1 появился новый атрибут который ограничивает чтобы можно было загружать запросы из файлов и ограничить директорию с которой это все будет подгружаться есть и странные флаги мне по крайней мере они показали странными во-первых допустим поддержка многострочных выражений то есть запросы можно было через точку запятой писать вместе отличная штука но я задумался Зачем если это не рекомендуется ну и плюс фельдш с именем каталога именем таблицы которые добавляется к имени колонки это вот удобно как раз по поводу выборки фичнейм ты повторяющихся колонок Ну вообще вот посмотрев на список флагов Я посмотрел много сомнительных и грядет bricking change HP 9 потому что ну не только динамический атрибуты много думаю изменится Ну и вообще про MyScore 8.021 как-то раз к нам пришли ребята еще создали и говорят у нас схема данных перестала получаться мы посмотрели написано 8 021 получаем имя колонки в ассоциативном массиве как ключ в том же также как написали а с начиная с версии 8021 так как она создана в BD то есть вот в минорке все поломали для нашего случая наверное было сейчас как раз кейс Очень бы подошел можно было к нижнему регисту приводить и все мы конечно использовали старту Лавр Потому что если мы при создании соединения вот так вот сделаем некрасиво Мы же кому-то что-то можем поломать поэтому мы сделали попроще Ну еще из интересностей мы храним Джейсон в блок полях Да не в силоп не в Джейсон би не в других специализированных типах хранения а ролевую модель Мы храним в блок полях Ну и как это примерно делается Это я написал Два запроса на вставку на выборку все достаточно просто делаем как документации из Москвы Все будет прекрасно мы вставляем данные читаем получаем ровно то что вставили все отлично спас гриску или немножко не так мы удивляемся на этапе получения данных нам возвращается не строка нам возвращается поток Ну в документации конечно же описано мы читаем документацию считываем потока все отлично Ну и немножко экзотики орков тут мы удивляемся на этапе вставки данных и конечно же этот случай тоже описан документацией что для орла требуется несколько иной синтаксис вообще требуется все это делать в транзакции и прочие танцы с бубнами вот такой работающий код для вставки он немножко отличается от сколов вставки для других баз данных большой использовал здесь in Memory Файлик вот в транзакции все это вставил заданием типа значения проверил Вот эти стримы которые возвращаются можно ли их мотать там вперед назад заинтересовала меня Да все отлично и реванты всех работают все хорошо задумался что наверное можно сделать как-то и проще мне вот это ерунда с транзакциями всем прочим не понравилось и данные у нас не совсем бинарные поэтому можно строковую строковые данные в блоге сохранить по-другому порылся по просторам интернета и вот такое решение мы завезли себе для хранения ролевых моделей пользователей Поехали дальше наверное автоинкремент вошел в нашу жизнь очень плотно об этом даже тоже немножечко расскажу и так как мы с этой задачей встречаемся с во фреймворке часто ничего не может Ну что может быть проще есть отдельная функция в pdio Last incide она возвращает строчку в составленном значением или false мы как бы я удивился Почему false выясняется Что может ничего не вернуть Или вообще не поддерживать начал изучать и читаю в MS SQL настолько ребята жалуются что в какой-то момент им что они стали самоцвеем использовать подуем возвращается пустое значение вместо последнего вставлено идентификатор и действительно в драйверах это конечно же решили добавили в какой-то версии Но для старых версий это не работает возвращается пустая строка как это было подчинено в для старых версий Microsoft SQL это было подчинено вот так то есть мы выбираем из пары системных функций через кого леск и все отлично но решение может работать неожиданно во-первых их три для MS SQL разных системных функций одна там ограничивается только таблицей другая только текущая сессии нюансы нюансы нюансы И самое главное все это не всегда корректно срабатывает если на табличке повешенные триггеры которые вставляют значение в какую-то следующую табличку мы как бы я подумал может вообще не использовать но думаю чек Ну как-то работает проверил mysql позже СМС QR все отлично сейчас работает свежих версиях Oracle сразу ругается что наш драйвер все это дело не поддерживает Но если очень хочется я подумал что по аналогии с msql тоже есть решение конечно же погуглил и вот попробовал две параллельные сессии соединения с базами данных никаких проблем все решение работает то же самое чекнул сейчас работает ли решение со свежими версиями все отлично Мне кажется со старыми если у вас простые таблички без триггеров тоже будет прекрасно работать Ну и я сегодня наверное мастер давать советы конечно же Last incer ID хорошая штука но есть и другие способы для каждой базы данных свои для старых версий мои сколько к сожалению Никак а для всех остальных можно вернуть последних ставленный ID прямо в запросе и 40 вам есть такая особенность я наконец-то понял зачем нужна не только бинд валуй но бинт пора потому что значение будет возвращено прямо в переменную которую мы заменили для возврата идентификатор И вообще Зачем нужен Last incer ID я столкнулся разговаривая с клиентами они говорят ребята можно в имени файла вы будете добавлять айдишник вставленной записи Я говорю Ну а чем что не так там уже улит вам Передаем имя файла такой красивая неповторимая и так далее они говорят это тяжело передать по телефону Давайте пожалуйста Циферки Ну и еще немного Советов есть замечательные флаги например при создании соединения можно передать Set names для того чтобы голосовать соединение на сервере на клиенте Ну конечно же не забудьте это сделать в dsn строке тоже на Чем могут быть тоже артефактики выключать конечно же подготовку выражения на стороне клиента Пускай лучше чем занимается сервер опять же связанная с вот этими с подготовленными выражениями штучка в mysql Если вы будете несколько раз один тот же плейсхолдер использовать запросе он будет ругаться скажет количество переменных переданных и количество поисководеров не совпадает Это касается только майскуэль Ну и еще Советую не лениться делать передавать не просто массив по дорожку но и говорить специфицировать Какое значение там integer строка это лучше чем просто передать как массив опять же с приходом специализированными запросами изменилась может быть переполнение памяти вот поэтому выключайте чтобы вам сразу резервный запрос не вернулся в клиента Ну и Используйте многострочные скорость запросы с умом Если уж так получилось помните что есть особенности во-первых об ошибке вам его сообщит только об ошибке в первом запросе то есть хотите получить и остальные ошибки надо перебрать все роузеты и смотреть сколько там колоночек какие-то Ошибочки и так далее вообще про это есть отдельная история когда мы решили получше сделать Возвращение инсор ID для msql нам не удалось избежать много строчек запросов мы сделали примерно так выключили в обработчике msql через ноукаунт чтобы он не сообщал после каждой строчки Что я сделал вот потом сделаем временную табличку вставляем возвращаем это во время вставленные значения во временной табличку и выборку делаем из этой временной таблицы соответственно код на стороне PHP достаточно простой и вот вся эта история с временной таблицы это особенность для msql и табличек с триггерами если с триггерами попытаться просто сделать ID и попытаться выдавить это сразу табличками с триггерами Не сработает он будет ругаться поэтому такой костыли с временными таблицами Ну и тоже нюансы разные драйвера подобных поддерживают по-разному штатные мастерскую вернет один Роу с ним все классно мы сразу получим последние ставлен идентификатор все будет классно с db-либом мы получим три значения Ну три роллсета и нам надо будет их перебирать Вот как я написал в примере предыдущем опять же Это тоже не всегда хорошо работало я там ниже привел несколько ишью что ребята чинили и пропуски лишнего И вообще пустые результаты возвращаемые СТС вот ну Давайте еще в мсql уже поняли что я его люблю вообще используя официальный драйвер Microsoft нельзя забиндить больше будет 1100 значений это причем за хардкожена в кот вот примерчик с кода есть еще на эту тему это именно тот факт который подталкивает использование Используйте нашу библиотеку она классная постоянно свой нос туда куда не надо неприятности Меня ждут И что же может пойти не так при обычном селекте вот у нас набор Ну прошлый год или позапрошлый даже 74 80 тесты все отлично проходят Мы выбираем все значения из таблички все возвращается в качестве строчек Обратите внимание что все параметры они в виде строк переходим на 81 и тесты крашится становится красненьким началась типизация Вот так вот неожиданно мы ничего не переключали а типизация появилась Мы конечно же подумали что надо тесты починить есть два пути мы пошли самым простым добавили стринги фич чтобы сохранить совместимость поведения то есть возвращались строки Ну и продолжим возвращать строки А если покопаться чуть глубже то Выяснилось что флаг млд припарис перестал 8 версий 8.1 влиять и они всегда теперь типизированы Ну и стало интересно полез в исходнике как было раньше то есть мы проверяем что возвращаем и в конце Вот я пометил что вот это самое место мы значение Превращаем строку и возвращаем Как стало прошла небольшая оптимизация и мы Превращаем в строку только то что не влазит у нас в Лонг 64 до 64 битной системы для всех остальных случаев возвращаем данные как есть то есть числовыми нашел как Power Quest посмотрел Вот комедик который сделал Никита чтоб оптимизировать это все дело вообще с этим связана Еще одна история начал чекать написал Вот такое слегка придуманный пример когда у нас включена подготовка выражение на стороне клиента и забить у колонку привязал ее к integer значение и потом тоже значение использует функции anywork и оно в процессе получения через флаг fitch Bound раз и стала строкой соответственно получил ошибку с типами вот тоже такое подозрение что будет что-то не так Ну и транзакции Классная штука первый совет раз уж я мастер давать советы это включайте жесткую обработку ошибок vermode помните что если у вас в запросе встретиться дидель выражение которое будет изменять что-то в структуре базы данных будет автокомит это из Майского м40 со многими базами данных так и связи с этим не совсем понятно рекомендация Почему говорят Давайте транзакции да он делать это про и опять-таки история Ведь если у нас изменения таблички все равно это Не сработает Ну и при старте питье на самом деле только проверяет что поддержку драйвера А насчет активных транзакций он проверяет весьма странно Ну и вообще вложенные транзакции не поддерживаются И тут я тоже начал смотреть на за изменениями если раньше для того чтобы проверить находится сейчас наше соединение в транзакции или нет было все просто был прям флажочек булевский который Да нет то сейчас начиная с версии 80 добавили методы handle in transection и для маску или они узнают о транзакции даже если вы не стартовали стартанули к примеру там через Вот как это выглядит внутри там проверочка и в пдвойне транзишен проверяем что не соединение ругнемся и как этот сам метод выглядит мы проверяем идем такие через handle на сервер и проверяем сервер Скажите транзакции он такой да да транзакции и вернем А раньше это было вот через интексен булевский флаг Ну и в целом если у нас Инна db база данных и только одна табличка мои Сам думаю Дай проверю и так я туда укладываю данные потом делаю роллбэк при этом данные прекрасно вставились потому что в отличие не так написано в документации что мы должны ругаться но мы не ругнулись потому что на самом деле как бы у нас же вся база данных на диби и про вот эту мои сам таблицу драйвер ничего не знает даже Интересная история смс-скуэлем в дуба либе все было хорошо а со старым драйвером сибэйзным который как бы sebase + msq раньше поддерживал было такое замечательный костыли как раз SQL стартами транзакций Но вот таким вот esql стартом транзакции можно использовать делать ложные транзакции если ваша Свобода их поддерживает конечно не про сейв поинты речи Именно про полноценный помните рассказывал про согласование соединение на клиенте на сервере там указание час dsn строке это вот история именно про это наверное в кучу мест уже расписано что есть такой символ немецкой кодировки который содержит вот так красиво выглядит содержит себе остров Но если посмотреть Да моя Сколь драйверек квотирование это просто добавление перед апострофом бык слэша Поэтому вот Наверное поэтому если не согласовать национальные будет беда и нас могут взломать вообще не рекомендую конечно из копирование Как вы поняли вот стринг Используйте подстановку это классно Ну и вообще если все-таки способ как можно вставить строку напрямую васql запрос Без бензинга без вот этого всего и Да если у Вас msql он прекрасно интерпретирует вот эти вот хек значения как строчки и мы это использовали тоже У нас для msql вот опять же та же задача хранение Джейсона блокполе мы сделали вот так вот конвертируем потом преобразовываем строчку warbinary в общем Спасибо Андрею это он научил Мой коллега бывший хороший человек и вообще специалист вот я вот это сам порассказывал остановился подумал Блин так ведь выгореть можно Ну и В целом все вот преимущества вот этих квери билдеров классные но они выплаканы слезами разработчиков то что код Может быть абстрактным там сырые запросы все вот эти преимущества их кто-то написал но если вам понадобится своя Оре Я думаю что вы будете к этому готовы наверное Ну и конечно же Огромное спасибо Саша макарову моему коллеге вьюмеру с которым модель вечерами переписываем вообще всем кто вносит вклад в insource проекты вот здесь использована литература конечно же читайте официальные документации которые никто не любит ну и спасибо что выслушали голосуйте за мой доклад Я закончил Теперь ваша очередь задавайте вопросы"
}