{
  "video_id": "E8tYIgVzujU",
  "channel": "HighLoadChannel",
  "title": "Хорошо поддерживаемое в продакшне приложение / Николай Сивко (okmeter.io)",
  "views": 1943,
  "duration": 1812,
  "published": "2017-04-22T14:48:24-07:00",
  "text": "Всем привет нормально слышно отлично Меня зовут Николай я вам буду рассказывать про хорошо Поддержи мое приложение но не из серии как писать чтобы было быстро а как писать чтобы было понятно что происходит значит говорю я это на основе опыта эксплуатации крупных проектов ряда плюс ко всему Мы сейчас в ходе работы в акме мы делаем мониторинг мы общаемся с клиентами не у всех всё гладко и в общем-то стало понятно что болячки примерно у всех одинаковые А откуда вообще ноги растут потому что софт пишут разработчики поддерживают их админы как правила Ну мы сейчас про пока забудем это разные люди разные специализации в этом на мой взгляд проблема и у них разные цели то есть одному важно реализовать какой-то функционал мы поставили задачу он работает над задачей Хорошо если пишет при этом тесты написал закол передал в каком-то виде тоже большой вопрос В каком виде передал это в Продакшен если это в продакшене не полетело начинаем всё сначала потому Амина немножко другой ему дают нечто что он запускает у себя потом ему пролетает SMS всё пропало ВС упало он идёт разбираться потому что ну допустим это ночь Он же не может просто ничего не посмотрев девелопе разбудить и сказать твоё подели там что-то не работает он идёт смотрит влоги там пусто он пытается какими-то системными средствами понять вообще происходит ему ничего не Удан звонит разработчику говорит типа Проверь Моё приложение работает с базой с моим кшм с РБ битом Проверь что все они живы что все они отвечают быстро Он такой ну не помогает Ну перезапустил ная ерунда и как бы человечество решило что наверное пора этих людей скрещивать Ну я так решил Э что именно это значит депс и начало всё делать неправильно На мой взгляд а начали говорить девелоперы Ну давайте вот тоже будете вникать что в проде происходит они такие блин классно у нас есть доступ к проду нам надо более мелкими изменениями доставлять свой своё нечто на прод мы будем это делать 10 раз в час Delivery всё такое мы не понимаем что такое железки сервера и прочее Мы хотим запускать некие контейнеры они должны им хватать должно ресурсов и они должны работать а всем этим рулить нам дайте 10000 желе разм сво некое облако с оркестра запустим там ВС это это будет работать и это будет скели и бизнес как бы вообще не этого хотел изначально Ну то есть я говорю про проблематику именно стабильности То есть если у кого-то бизнеса болит Деливери в прот Ну это как бы про это а я говорю про то что прот работает нестабильно ажен работо сделать чтобы не падало Ну только самый глупый руководитель такую задачу Может поставить а более земная задача сделать так чтобы было быстро понятно что происходит и быстро чинить а и здесь можно было бы надеяться что devops как раз про это то есть разработчик думает как оно в проде живёт или админ начинает писать код Ну все говорят что это как бы очень Жуть потому что функциональность кода написанного админами она нищая в этой теме Я хочу поговорить про диагностику софта который делают девелоперы То есть как нужно делать диагностику софта чтобы админу или самому девелопе было понятно что происходит А ну вот просто вещать из ниоткуда я не хотел Поэтому я решил что мы посмотрим на осные штуки на на пог на Мон посмотрим пытаемся сформулировать какие-то подходы и посмотрим как натянуть это к себе всё А начнём про что есть вот в Исе так вот с высоты птичьего полёта есть запросы пользовательские есть бэнды есть кэш есть какая-то логика может быть на лу Не дай Бог а и собственно Что с этим eng какие средства предоставляет во-первых логи рло в Иксе Хорош тем что я выделяю здесь те вещи которые можно было бы позаимствовать во-первых когда пишет какую-либо ошибку прежде всего он пишет какой клиент страдал Ну в данном случае IP адрес из-за какого бэнда произошла ошибка конкретны IP адрес конкретного бэнда и всю необходимую Мета информацию Если мы возьмём Access Log причём стандартный Access брать нельзя там ничего нет ну там нет Там есть ошибки там нет списка кэндо там ну ничего нет если мы его нормально расширим это делается из коробки ничего дополнительного не нужно сразу получаем сколько ждал клиент это вот чёрненький 103 миску список того сколько врем времени отвечал каждый энд какие статусы он вернул и осники этих самых кэндо сразу становится понятно что происходило в ходе этого запроса это как бы в КСЕ логи сделаны с умом потому что ну Игорь соев видимо админ и он понимает всю эту боль а более того если вы хотите отладить например Рай или какую-то нетривиальную логику которую вы там по написали есть это супер подробное логирование оно супер сильно Может вам за Поэтому в ие на проде это можно включать для конкретного шника для конкретной сети или если вы хотите прямо получить вообще спш то можно сделать так чтобы это писалось циклический буфер в памяти а потом его как-то сдам на диск уже и с ним как-то работать есть статус Ну статус если честно Ну такая пустая вещь Ну счётчик конешно счётчик запросов быку сюда это написал Соответственно что в икси не понятно в икси непонятно сколько мы висели на ожидании диска сколько при этом Ну как бы блокировался и улу там есть конечно асинхронное чтение всё такое треди ну сейчас не об этом то есть невозможно понять сколько Илу был заблокирован для каждого воркера например при походу диск за данными либо за при записи логов непонятно Сколько времени блокировался е если вы запускали там свою логику например лу потому что ну конечно разработчики икса надеются что вы будете запускать луше которая там меньше миллисекунды работает но понятно что все люди хотят там навернуть логики очень мощной поэтому эта проблема встанет А ну также Вот третье Я недавно наткнулся что реквест Тай у вас может расти из-за того что вы настроили митрей с стом и никак нельзя диагностически отделить почему он у вас вырос вы потом чудом я нашл что там и поэтому там гистограмма была вся красная и если будет вс-таки какую-то тяже вы будете в ик запускать естественно этого не советую Поэтому я там немножко сереньким замазал нужно будет понимать кто прямо сейчас держит управление Ну прямо сейчас я надеюсь этой задачи ни у кого нет поэтому пропустим дальше монго быстренько что есть в монге есть данные которые лежат в каком-то виде на диске есть индекс чтобы иметь доступ к этим данным а есть запросы некая более тяжёлая логика там например агрегации Когда вы запускаете там какой-то дный код поверх данных и есть ресурсы на чём это работает сеть прос диск Мон предоставляет разные ручки для для счётчиков того что в ней происходит А это как счётчики уровня сервера так счётчики по базам данных по коллекции А по запросам в монге есть quy профайлер но прямо в этой же доке написа он может м ВС уложить Я не знаю насколько это правда но если в доке написано Я вот вообще склонен верить туда можно писать либо все запросы либо медленны то есть это настоящий профайлер который про каждый запрос пишет сколько где он что ждал сколько данных Он поднял Сколько из них он отфильтровать в проде для всех запросов то есть полную картину вы не видите и на мой взг мониторинг и диагностику мо себя то есть как пользователь Мон то есть вот как админ который эксплуатирует Мон я могу сделать ограниченный ряд действий я не могу пойти и грубо говоря настроить там БМ фильтр для какого-нибудь индекса или там для какой-нибудь коллекции я могу вот если у меня монго встала в непонятную позу Я могу прибить какой-то запрос Ну вот логически А я могу исправить запрос я могу данные по-другому переложить я могу поменять конфиг и если я понимаю что мой Ну как бы не хватает ресурсов я могу добавить ресурсы но монго на эти вопросы ответа никакого не даёт То есть я не могу прямо сейчас понять какой запрос У меня всё уложил нету таких ручек в монге А на какие запросы во времени уходят ресурсы то есть вот у меня монго сжирает 50% ядра Я не могу понять какие запросы делают эту нагрузку и это для меня проблема Я не понимаю Где оптимизировать я могу включить профайлер на 5 минут но это мне ни фига не поможет мне ещё над ним нужно будет сделать какую-то агрегацию что-то посчитать и так далее какие запросы ВС получили тоже нету нет такой информации Я считаю что это просто по построению неправильный подход дальше рассмотрим постс Ну вот примитивно Да конечно ребята которые разрабатывают по обидятся что данные запросы и ресурсы Ну как бы сейчас девори вни у не очень много системных ВХ про каждую таблицу про каждый индекс есть счётчики сколько он лся Сколько было обращений таких ских и так далее про запросы есть два аспекта Вот то чего не хватает монге есть PG который показывает что происходит прямо сейчас то есть какой запрос висит ждёт ли он Лог не ждёт ли он ло или он наоборот взял Лог какой Какие запросы там висят Сколько времени и там же информация одах их прибить конкретный запрос прямо из консоли А если мне нужно потребление ресурсов во времени то в пог есть PG statements это уже агрегаты То есть это счётчики по наиболее ресурсо ёмким запросам они позволяют понять на какие запросы уходит CPU На какие запросы уходят операции с диском Какие запросы пишут на диск ну там в случае постгрес пачкают страницы а какие запросы с диска читают и это исчерпывающая информация о том что мне как пользователю постгрес надо крутить чтобы не знаю снять нагрузку сервер или lency улучшить своё про Локи все есть чрп сеа информация то есть а какой запрос держит Лок Какие запросы ждут этого самого лока который держит наш нехороший запрос соответственно в постгрес я оцениваю диагностику как достаточно хорошую потому что она сделана для администратора она сделана для людей и ну там есть косяки которые мне хотелось Какие запрос создают Рафик там есть какие засчитывают отдают наибольшее количество результирующих строк но вс-таки С трафиком это может не коррелировать или там совершенно Ну не очень удобная диагностика в плане репликации Но они там что-то делают И в общем и целом это гораздо лучше чем та же Мон который более-менее похож на backend то есть что-то какой-то код который берёт информацию откуда-то допустим в случае из бэнда в случае вашего приложения из базы делает какой-то процессинг над ним Ну допустим рендеринг шаблонов и так далее и отдаёт клиентам Ну похоже по построению и подход здесь можно взять там логи монго пример того как не надо делать то есть нужно понимать Для чего вы выставили тот и иной счётчик Это хороший пример Вот давайте Теперь попробуем ВС это натянуть на нашу задачу соответственно Какие вопросы Мы хотим чтобы наше приложение нам давало ответы Что происходит прямо сейчас это вот вопрос который интересует любого седмина чем приложение занималось вчера потому что вы на графике можете увидеть всплеск нагрузки там назна что Какие задачи ушло больше всего ресурсов то есть на Какого типа запроса То есть это мы отдавали страницу с результатами поиска чего-то или всё-таки у нас во времени больший вклад вносит там страница продукта на вашем сайте я не знаю А сколько было ошибок как мы их обрабатывали это очень важно понимать что если вам приложение пишет а Bad request Ну что е не понравилось в этом запросе как бы другой бкн делает этот запрос получает четырёх сотку и на этом падает а на самом деле ва приложение должно сказать я ожидала что в заголовке таком-то будет такой-то токен а его там нет Или там заголовка нет ну написать же не сложно вот но сильно жизнь упрощает и если вы ходите по всяким ресурсам удалённым там будь то по сети к другим эндам к базе к кшу к чему угодно или вообще там через публичную сеть куда-то попёрлись Вы должны писать сколько это заняло сколько Вы ждали получили ли вы валидный результат получили ли вы ошибку и так далее я выделил здесь три подхода это логи это внутренние какие-то счётчики метрики замеры и это называется это по-разному в разных ран таймах Ну есть ещё профайлеры про них я не стал потому что и так много всякого Dum это штуки которые позволяют понять где сейчас находится управление если у вас ю какие-то треды рутины процессы вы делаете ней какую-то команду она нам говорит я сейчас на такой-то строчке кода такого-то хендлера жду там не знаю ответа А это всё-таки больше не про ваш код который Вы пишете а про платформу на которой вы его запускаете там будь то GM не знаю там Гош ранта или ещё что-то такое и у этого подхода есть высокоуровневые аналоги я их обозвал это вот что-то типа PG А ну вот соответственно в Я встроен в платформу лу этот дам в Гоше тоже Вы можете включить профайлер дёрнуть ручку И вам покажет состояние всех рутин а вот потому что очень много слайдов правильно писать логи вот уже переходим к логам вс-таки это более такая земная тема это всё-таки уже от вас зависит что в лог записать есть конечно всякие платформенные логи Access Log в котором не пишутся никакие тайминги Ну да ладно соответственно правильно писать логи практически Невозможная задача как и сформулировать что такое правильно я сформулировал это правильно писать Нужно не писать ненужно и соответственно если у вас раз под разные задачи нужно выбирать что конкретно вам может понадобиться в этих логах Я предлагаю исходить из сценариев привёл такой пример вы пришли Ну вот вы админ вам приходит эсэмэска вы в трусах до ползли за компьютер открываете Видите Там что у вас 504 ошибка ну какую-то одну выбрали глазами ошиб 198 его 101 миску он поймал что вот вы как админ будете делать дальше правильно вы пойдёте на 19216811 узнать что у него написано в логе про этот запрос но там много запросов и какой этот запрос а вы хотите найти именно этот потому что вы хотите посмотреть чем он 10 куся что на входе в вашу систему будь то задачи или запросы Вы должны каждому запросу присвоить некий идентификатор Ну будем называть это ID в какой-то недавней версии есть встроенная до этого я писал модул он там на гитхабе где-то валяется просто в появляется переменная ID вы её можете Загирова вы её можете передать хером куда-то дальше и на бэнда писать е вло в каждой запи То есть у вас в какой-то момент времени какой-то Его процесс занимается обработкой конкретного запроса соответственно Вы можете при обработке этого запроса в каждую строчку писать этот request ID и есть кейсы когда это прям SQL комментариями пробрасывается начали греть по этому request ID видите что он пошёл в базу А а потом Клиент закрыл соединение Ну то есть к закрыл к нему соединение вы идёте в базу видите что этот Селект база исполняла 147 м секунд Почему неважно но вы разобрались что происходит то есть база виновата в том что клиент поймал запросы Когда Вы начинаете запросы друг от друга отличать у вас получается что вы достоверно и точно знаете что было не так с этим конкретным запросом это очень важно можно работать с потоком я покажу как это работает потом на потоке запросов Когда у вас 500 ошибок в секунду и вы хотите со всеми сразу разобраться но важно понимать С каким конкретном у вас может быть со всеми запросами всё хорошо а у одного конкретного пользователя пятисот а если Ну и тут сразу возникает некая некие рецепты Что писать в логах То есть если вы пошли Пите куда конкретно вы пошли то есть не не подходит писать я пошл в сервис переводов это Это плохой кейс Я пошёл в сервис переводов по айпишник 19281 или там я его резол отрез в такой-то пошёл к нему ждал его 300 миллисекунд не дождался всё там Поэтому я отдал пятисот про обработку ошибок написать что была ошибка хорошо я принял решение от пятисот Это лучше Ну и соответственно все времена значимых операций нужно замерять потому что просто We realtime - это про тайминги то есть быстро надо отвечать И когда вы отвечайте медленно нужно понимать Какая стадия сколько заняла а Про ло то есть Понятно Что вербо логирование грузит диск верное логирование даже если вы пишете не на диск а куда-то отправляете там очень нагрузку может создавать такую не хилу А если вы вводите разные уровни логирования допустим я в де баге пишу очень подробно а в инфо я пишу только самое главное скорее всего при фапе вы захотите переключиться в дебаг и если вы рестарта там свой сервис это может проблема уйти Поэтому если вы делаете разные уровни логирования делайте ручку которая может без перезапуска это уровень логирования переключить Ну соответственно на основе логов можно делать метрики логи можно парсить и нужно но надо понимать что это тоже создаёт нагрузку если мы хотим как-то оптимизировать вот здесь приходит следующий нам кейс что счётчики того сколько мы сделали каких операций сколько мы потратили времени на какую-то операцию можно делать внутри приложения а потом экспортировать куда-то Что с этим подходом мы уже потеряли знания о конкретном запросе то есть мы уже работаем с потоком с как Плюс нам это сильно дешевле по ресурсам соответственно мы цепляем к этому мониторинг То есть к на эта штука экспортирует эти метрики в мониторинг Мы из них рисуем графики при необходимости алерты из готовых инструментов есть любые для всех языков программирования это звёздочка Matrix звёздочка std Client соответственно различия в них примерно у них одинаковая семантика арее в памяти и в мониторинг раз во время выплёвывает просто значение а statsd он каждый ваш замер или не каждый там есть оптимизации над ним по DP шлёт в какой-то сервер который их агрегирующие и начинаете его инкремент просто в код вставляете а в случае с с таймерами вы просто берёте некий таймер вы замеряется время в него там есть разные Либо вы просто передаёте функцию она сама замерить Либо вы сами замерили Либо вы говорите я начал тогда-то и в общем посчитай мне это сейчас соответственно тот же самый кейс но уже на потоке получается Мы рассматриваем видим что в какой-то момент времени у нас было в секун идм в приложение и в метрике приложения там мы посчитали сколько у нас суммарно занял Ну допустим там мы девяносто пя перцентиль мы их постели и видим что вкш нам отвечал столько же рендер нам отвечал столько же и соответственно база начала тупить Хотя её нормальное время ответа за 2 минуты до фапа было такое-то или типа вот это время нарастало нарастало с такого-то момента то есть мы видим в динамике всё что происходило и соответственно можем легко и быстро понимать что не так произошло плюс на эти всякие штуки мы можем ставить какие-то пороги или какие-то другие более сложные алерты и сразу там мониторинг нам покажет что типа у вас тебя сейчас база отвечает за ненормальное время а соответственно и наверное про то что это всё-таки лот Сколько стоит диагностика я взял просто померил первую попавшуюся Любу для го видно что счётчики бесплатные таймеры плюс-минус бесплатные Ну так для примера если у вас 10.000 запросов эн обрабатывает в каждой запросе вы поставите 10 таймеров на это нужно уделить там 10% одного ядра это немного не мало потому что на бэнде с который у Вас тянет 10.000 РПС скорее всего ядро не одно пожертвовать 10% Вы можете Но на самом деле это даже не я здесь Прив заме Сколько стоит просто два момента времени Get time of the day посчитать это дёшево то есть там внутри в данной имплементации какая-то хитрая гистограмма она не хочет суммировать Ну как бы не хочет копить в памяти все значения чтобы потом из них получить присли а она как-то с фиксированным размером памяти работает и это там как-то дёшево ну как как Дорогова соответственно это тоже цифры можно оптимизировать но по Су и в принципе все могут себе это позволить выводы Я считаю что devops надо начинать с диагностики А когда у вас есть диагностика уже там берите модные игрушки и делайте Но если вы запустите там 100 контейнеров должны понимать чем каждый из них сейчас занят соответственно диагностика это просто там тех долг если у вас сейчас ничего нету вы заносите себе тех долг тратите сколько-то ресурсов получаете через 3 дня какое-то решение через неделю уже нормальное решение а просто надо этим заняться и об этом подумать если там у вас админ который не любит общаться и он вас не попросил это сделать Ну Сделайте это просто ради него чтобы простить ему жизнь соответственно инструментов разных куча А и соответственно Когда вы не понимаете как вам лучше сделать что записать А что не записать исходить из сценариев Представьте что сработал какой-то риск и сделайте Ну если вы не хотите фантазировать не хотите представлять вы просто после каждого факап добавляете в лог ту информацию которая помогла бы вам потом распутать этот клубок и достоверно убедиться Ну как бы понять что там происходило Соответственно что я не рассказал сейчас но эта тема отдельная детализация этих самых метрик в приложения то есть в каких разрезах их делать как их отличать и так далее и профайлеры есть платформы которые предоставляют нормальные профайлеры которые можно впускать в прот а и с ними работать прямо в авральном режиме А это не вошло это собственно всё что я вам хотел рассказать готов ответить на ваши вопросы если они есть Спасибо а микрофон надо наверное Саша у тебя рабочий микрофон с Меня зовут Анатолий У меня вопрос про Вот вы метрики говорили то есть мы выпиливаем логи потому что они Нам многого гово имею вду что у на подробные логи занима нагрузки мы их допустим убираем мы пишем там как пишет сходили туда-то туда-то А вот если у меня за один запрос делает там 100 запросов в базу метрику Какою отдавать средне дено пя НТИ или на каждый запрос че Вы можете если это запросы разные вообще вы говорите что поход за сессией в базу занял столько-то поход за не знаю профилем занял столько-то поход за этим занял столько-то не надо вот надо делать по значимому запросу То есть если вы знаете что у ва есть основных запросов они все разные по нагрузке бессмысленно замеры из них агрегировать надо агрегировать в пределах какой-то группы а ну я понял то есть грубо говоря если у меня какой-нибудь там Ke value живёт Я хочу из него 100 элементов вытянуть я их агрегирующие то это отдельная Метрика Спасибо большое Ну то есть вот эти все метрики - это оптимизация над логами то есть вообще говоря Вы можете не знаю там глазами читать логи ну Ну как бы оптимизация следующий шаг логи читать долго надо идти куда-то где их читать Мы хотим сводный график по 100 машинам раз получили а логи дорого Мы хотим Вот вот этот вот кусок мы не хотим знать для каждого запроса сколько занимал этот кусок Мы хотим только агрегат поэтому из Лога уходят частые запросы допустим вы не будете логировать в логе каждый запрос вкш потому что он 1 миллисекунду стоит а грубо говоря запись влог там стоит 3 миллисекунды ну там я сейчас от балды говорю но вы это просто способ оптимизации Понятно спасибо спасибо за доклад у меня быстрый вопрос я увидел то что не вошло в ваш доклад это самом профайлер А где-то это можно потом посмотреть почитать послушать Ну приходите на стенд я или поймайте меня где-то я готов это об этом поговорить У меня есть я не Эксперт в профайлера ещё раз я просто знаю какие инструменты там работают несколько Я знаю подходы я там могу Может быть у нас с вами пересекается технологический стек Да конечно Любой время Спасибо на самом деле доклад достаточно капитанский но когда люди сидят и предполагаем мы предполагаем что вы всё это знаете на самом деле это не значит что у каждого у вас это есть Поэтому я всё-таки взял на себя смелость и всё-таки это рассказал Несмотря на то что инфа достаточно примитивно Гугли и всё такое Так что не судите меня строго Ну если нет вопросов Спасибо"
}