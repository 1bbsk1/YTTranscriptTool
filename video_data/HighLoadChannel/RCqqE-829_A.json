{
  "video_id": "RCqqE-829_A",
  "channel": "HighLoadChannel",
  "title": "Fuzzing-тестирование. Практическое применение / Никита Догаев (Wildberries)",
  "views": 586,
  "duration": 1815,
  "published": "2024-10-29T02:48:12-07:00",
  "text": "Никита дагаев из рис расскажет нам про ва ой господи про Фаин тестирование на практике поприветствуем так слайды так Всем привет Меня зовут Никита дагаев Я работаю в компании wiber На позиции Лида backend разработки в команде контента на портале продавцов И сегодня я хотел бы рассказать как мы в нашей команде используем фанг для тестирования нашего кода но перед этим я расскажу чем мы занимаемся значит наша команда отвечает за бережное и ответственное хранение данных и карточек товаров всех продавцов на Одна из основных задач это тка и поддержка сервиса а предназначенных для работы с карточками товаров для наших продавцов к слову самым контентом карточек товаров является весь текст весь тот текст который вы видите на странице товара а второй немаловажной задачей у нас является это обработка текстового контента а именно валидация и его нормализация причём это надо делать быстро чтобы наши поставщики не долго ждали что обновляются его данные о товаре следующее - это передавать данные о товарах так как мы являемся мастер системой данных и от нас получать информацию о товарах все остальные нашей команды мы должны их передавать другим нашим сотрудникам наш сервисы потребитель данных вот что же нас привело к фан первое к тестированию нашего кода с помощью фан мы пришли из за нескольких проблем одной из основных было то что в наших репозитория скопилось большое количество методов со сложной логикой второе - это множество кейсов в Юнит тестах то есть его там составляло около 1.000 рок кода и когда у нас Возникала какая-то ошибка Некоторое количество этих тест-кейсов ломались опять же разработчики тратили много времени много времени разработчиков много денег компания тратят на это и для решения этого мы использовали фанг Далее в запросах могут приходить непредвиденные данные у нас э ну мы обслуживаем поставщиков с разных стран СНГ это Армения там Казахстан и ещё другие с других стран и они могут писать туда что угодно особенно часто бывает такое что они взяли какой-то ПДФ нек или Word скопировали оттуда данные кинули и все э символы оттуда перекачивать к нам из-за чего у нас возникали какие-то ошибки а также проверка внутренних интеграций всегда когда мы нормали зру и Валиди данные о карточках товаров мы их передаём нашим потребителям сервисом потребителей данных они эти данные получают обрабатывают и что-то с ними делают Бывает такое что у нас какой-то полюс становится deed устаревшим мы его убираем отправляем опять нашим потребителям и какая-то логистика говорит Блин так у нас же от этого зависела вся логика мы лежим и поэтому нам надо это тоже проверять перед тем как делать какие-то изменения в наших системах Но перед тем как мы перейдём к самим практическим примером Я бы хотел поговорить о том с чего мы сами начали с фан а именно с теории как его менять И что это вообще такое значит фанг - это техника тестирования программ которая происходит за счёт сгенерированных случайных значений данная технология широко распространена и используется для тестирования высоко нагруженных приложений фанг лучше использовать при тестировании сложного кода так как с помощью стандартного тестирования физически очень сложно покрыть все возможные вариации входных данных Обычно когда мы создаём Unit test как разработчик мы прокиды несколько тест-кейсов для тех моментов которые мы понимаем где может сплава наша наша программа Но не все и с помощью н мы можем в принципе протестировать полностью покрыть весь наш код тестами А поговорим о fing Go значит в данном языке программирования использует coverage guidance Fazer который доступен из коробки с версией 1 ранее фанг также был доступен в го но в виде отдельной библиотеки Гоф сам тест представляет собой функцию у которой есть приставка фаз обязательная и которая на вход принимает значение тестинг F оно обладает всеми теми же методами что и объект тестинг Т только у него добавляются две новые функции это AD и ФЗ что это за функции с помощью функции AD мы добавляем значение в первоначальный корпус нашего фазера А с помощью метода фаз Мы инициализирует будет фаер генерировать значение которы Мы хотим и исполнять наш тест те значения которые генерирует фаер называются фан аргументами но как же запустить э тесты для запуска таких тестов мы применяем команду го Test с флагом фаз и названием нашей фаз функции также у неё есть флаги которые отвечает за количество времени которое должен проработать фар или количество итераций времени или количество итераций которые минимизируется наш параметр перед тем как записаться в корпус и флаг параллель который отвечает за сколько потоков будет работать наш фаер что же насчёт покрытия кода с фангом опять же повторюсь что в Go используется coverage guidance его фишка заключается в том что при выполнении теста со сгенерирован значениями он определяет Какие участки кода он затронул если с новым аргументом была затронута ве то фаер запомнит данное значение и помет генерис далее он начинает делать мутации над ним чтобы проверить больше часть кода на данном примере Мы видим что изначально вызов функции идт без сидов так как мы не добавили начальный корпус значений Фазер мутирует пустую строку добавляет туда Рандомные значения он то делает пока не доходит до следующего условия на этом условии у нас уже в корпусе есть значение 4a далее мы идм fua Юза и доходим до паники с значением фаз вообще фаер мог сделать значение фаз и какие-то какую-то супер большую строку в которой были бы ненужные нам символы там точка слш и так далее И тут используется minim То есть он убирает все ненужные байты телы убирает и мы приходим к оптимальному значению которое вызывает нашу панику Где же лежат эти данные значит данные сгенерированного корпуса лежат по пути который вы видите на слайде там лежат такие вот файлики и в них описана версия фазера который запускался и само значение также у нас есть начальный корпус И для него Данные лежат в вашем проекте Где вы запускали Фаст в папке тест дата фаз и название вашей функции Давайте посмотрим результат фаз тестирования что же там есть первое мы можем тут увидеть записи о сборке базового покрытия чтобы собрать базовое покрытие фанг запускает тесты с исходным корпусом и со сгенерированного корпуса для того чтобы убедиться в отсутствии ошибок и понять покрытие кода на начало теста исходный корпус мы сами заполняем с помощью метода Add а сгенерированный корпус заполняется по мере работы фазера туда идут выводы которые привели к вызову новой строчки кода далее У нас описа На каких потоках у нас фар заработал это 10 workers дальше показано то что Сколько времени проработала сначала запуска фанга и то что за это время было запущено где-то 1 411000 тестов с какими-то водными данными а также Сколько сидов было записано по мере работы фанга на данном за данные 3 секунды то есть нашем случае это но но всего в корпусе уже ь сидов лежит перейдём к примерам а именно первого С чего мы начали в компании фази это htp хендлера например мы имеем такую задачу У нас есть карточки товара поле описания и в него нельзя добавлять более чем три эмоджи для решения данной задачи мы описали такой хендлер которым принимаем запрос в этом запросе есть поле description этот дескрипшн мы отправляем в метод Check эмоджи этот метод достаёт оттуда все эмоджи После чего мы проверяем количество которые он нашёл если их больше чем три отдаём ошибку Если всё ок то отдаём ОК но для тестирования данного функционала мы можем использовать два типа тестов это нерациональный и рациональный тип Давайте посмотрим на них подробнее нерациональный тип тут у нас описан Target в котором мы говорим фаеру сгенерирует нам сй этот сй мы Валиди то что это валидный то что он ан маршали ИП не равен не пустая строка После чего мы отправляем тестироваться в чём же тут проблема то что когда мы Валиди мы пропускаем эти тест-кейсы и из-за этого из-за этих методов и которые стоят мы фам больше их чем тот хендлер который мы хотим протестить на самом деле То есть все седы которые добавляются в сгенерированный корпус они будут сгенерирован для проверки именно методов val и Maral а не нашего хендлер функции из-за чего дольше будет происходить время до нахождения нашей ошибки а рациональном Фаст таргете мы говорим фаеру Пожалуйста сделай нам какую-то стрин мы сразу отправим её в модельку он маршам её и этот готовый мы отправим для тестирования нашего хендлера тем сам фаер будет фази именно для хендлера мы быстрее найдём ошибку и после этого радостно пойдём её чинить Давайте посмотрим сравнение при сравнении двух вариантов использования мы увидели что время работа фанг в случае нерационального подхода значительно больше чем у рационального сидов в одном из подходов меньше Но они более точны для того чтобы найти ошибку в вашем коде количество запущенных тестов тоже значительно разнятся и в случае использования рационального подхода их меньше из-за чего при вызове фанг такой реализации мы используем меньше компьютерных ресурсов перейдём к следующему кейсу это когда можно использовать фаер и Юнит тестирование обок А именно когда с помощью фаз аргументов нам нужно сгенерировать свои Рандомные какие-то аргументы для тестирования нашей функции Давайте посмотрим на функцию которую мы будем тестировать это функция Са она принимает на вход слайс чисел и находи этих значений в слайс тут заведомо сделана ошибка то что мы игнорируем значения которые делятся на на 100000 чтобы мы могли найти какую-то ошибку Далее описываем фате в котором изначально в начальный корпус мы добавляем 10 чтобы от него так раз и начинал генерироваться Фазер также мы тут добавили чтобы наша длина строки длина слайса кото будем генерировать было больше это мы делаем сюи ходим по циклу от нуля до этого N и генерируем наше значение с помощью Run in 63 далее заполняем наш тестовый слайс считаем сумму которая должна получиться верная и описываем стрин в которой мы будем выводить ошибку и Какие аргументы привели к этой ошибке после чего это всё запускаем проверяем и получаем такой ответ то что при таких значениях сумма у нас получилась ual такая А expected должна быть Вот такой то есть у нас ошибка мы можем радостно взять это и перенести в Unit test в тест кейс какой-нибудь Чтобы в дальнейшем его запускать Почему мы делаем так Потому что если мы запустим опять фанг он на генерирует новые значения и у нас не повторится ошибка вот а в итоге мы получаем такой алгоритм в котором мы сначала а генерируем тестовые данные выводим интересные значения Это те которые привели к ошибке сохраняем эти значения в тест-кейсы исполняем код находим ошибку чиним её запускаем нит тест опять смотрим получилось всё или нет получилось если ошибок больше нет опять повторяем сначала чтобы фаер может быть ещё нашёл какую-то ошибку мы это применяем только для маленьких функций на самом деле для больших функций это некорректная проверка Что опять же coverage guidance не будет работать и мы не сможем как раз весь код покрыть тестами То есть тут какой-то Black B получается не гй бо перейдём к следующему примеру это генерировать текст на необходимом для нас языке опять же повторюсь наши клиенты - это разные продавцы из разных стран СНГ и иногда у нас получается вот такие карточки товаров которые заполнены на том языке которые наш клиент и хотел заполнить не на русском а вот например на армянском такой текст может нам попасть и наш код может выдать какую-то ошибку потому что мы не знали Какие символы вообще могут быть на армянском и там база данных какая-то проблема произойдёт или у нас там в коде какая-то проблема произойдёт там денормализация нормализации строк для нахождения каких-то некорректных слов к примеру И для этого мы сделали вот такой вот Фаст тест который генерирует текст на иностранном языке и мы можем проверять Если к нам добавится кака Это новая строна там нгш ная мы возьмём из Юнит кода вот Как видно на примере нижнюю и верхнюю границы и длину строки далее опишем генерацию длины строки которая у нас должна быть тоже с помощью мод как в предыдущем примере И после этого будем генерировать строку на том языке который нам нужен То есть мы ходим в Unicode генерируем код символа и всё это вместе контини после этого подаём на тестируемую функцию в итоге мы получаем какую-то ошибку к примеру тут символ этот круглый у нас вызвал ошибку и мы после этого пошли радостно это всё чинить всё починили и пошли спать потому что это было где-то 2 ночи Так как же фази SQL запросы А у нас есть на примере такая функция Create тут есть запрос SQ который создат некоторую строку в нашей таблице и мы игнорируем и отдаём идентификатор этой строки которую мы создали мы игнорируем rn rows ошибку остальные выводим для того чтобы это проверить мы написали такой Фаст тест в котором инициализирует контейнер почему же мы инициализирует контейнер э потому что мы пробовали делать это с виртуалкой но есть некоторая проблема то что когда фанг прекращает свою работу процессор сама машина отправляет сигнал Kill на процесс фанга и этот Kill надо было как-то отследить у нас это не получилось из-за чего мы не смогли очищать данные из таблицы после того как он туда что-то на фазил из-за чего мы выбрали решение с тест контейнерами запускаем тест контейнер туда отправляем фанг параметры он создаёт их заканчивается Фаст тест мы отключаем контейнера всё очищается и опять заново можем запускать так после того как мы сделали инициализацию тест контейнера и запустили миграции первичные для тестирования нашего метода мы описываем сам Фаст Таргет в Фаст таргете мы просим сгенерировать нам некоторую строку эту строку отправляем на метод создания строки в базе данных и запускаем наш тест после чего мы обнаруживаем такую ошибку что определённый символ не может записаться в базу данных из-за чего нам надо его починить Давайте перейдём к следующему примеру это чтение с базы данных к примеру У нас есть такой запрос где мы получаем идентификатор с таблицы по значению бар с помощью операции опять же игнорируем добавляем обработку ошибки если у нас Тай и выводим ошибку и идентификаторы описываем инициализацию тест контейнера запускаем наши миграции описываем Target и переводим туда наш метод find Test RS После чего мы находим ошибку а именно SQL инъекцию которую нам надо починить то есть использовать к примеру плейсхолдер в нашем запросе Вот какие баги мы смогли найти в нашей команде с помощью фанга во-первых это конечно же паники это касается методов в которых мы работаем со слайсами го каналами указателями или рефлексией ещё можно отловить ошибку деления на ноль к примеру А дальше это на втором месте это ошибки при вызове неправильного А статус код при работе хендлера то есть к примеру у нас ошибка авторизации А мы отдаём пяти сотую ошибку Хотя должны 403 тоже фанг в этом помог чтобы обнаружить эти проблемы а и в конце нашли очень неприятный баг связаный символами и кратка её Проблема была в том что в методе валидации те текста а именно в функции поиска запрещённых слов нам нужно отловить запрещённые слова или словосочетани из текстового контента карточки товара и вывести их продавцу чтобы он понимал из-за чего его данные не сохраняются в нашу таблицу при поиске строки мы делаем её нормализацию Для дальнейшего поиска и в результате получаем найдено запрещённое слово в не нормали виде для вывода запрещённого слова клиенту нам надо денормализация То есть к примеру У нас есть слово в определенной категории к примеру там Электроника и оно считается запрещенным мы находим и выводим уже не А какой-то где это вообще латинская буква тоже это всё отловили починили и стало всё хорошо спасибо фан что помогает нам находить такие баги поговорим приго что мы хотели получить данным решением при новом релизе ничего не испортить То есть когда мы делаем какие-то правки добавляем какое-то новое Поле или убираем старые поля или изменяем логику формирования нынешних полей мы не должны испортить ничего у наших интеграторов и у нас и второе - это нагрузочный тест нас и наших потребителей во-первых мы должны провести нагрузочный тест при новой логике нашего Тера в брокер какой-то и во-вторых понять то что справляются ли наши потребители особенно новые потребители э с тем количеством информации которую мы передаём брокер м или нет для решения данных проблем мы сделали так изначально написали фастест Далее для Фаст теста описали методы формирования событий карточек товаров с помощью ну к примеру by Shuffle А и сделали значит формирование событий категорий карточки товара размеров и характеристик а далее отправили эти события в брокер сообщений к примеру на jetstream или кавка а передали данные для подключения к брокеру нашим потребителям для того чтобы они смогли протестировать свои интеграции с нами реализовали Бота который который собирал события с графа то что у кого-то произошла ошибка сразу выписывал этот в артин они смотрели в этот бот тега кто ответственный за этот сервис и пошли чинить а настроили мониторинг данных этих алертов при запуске фаз тестов на стейдж окружения и теперь оповещая наших потребителей о том что запускаем интеграционные тесты ждём около часа после запуска если АРВ нет то всё ок И мы можем в принципе двигаться впро и также настроили мониторинг ресурсов если какой-то из сервисов у нас или у наших потребителей начинает тротлит или перезапуска и из-за переполнения памяти Мы также получаем уведомления тем самым новые сервисы потребителей данных могут протестировать нагрузку при интеграции с нами перед выходом в продакшн и также зафак а больше сохранённых нервных клеток при релизе у разработчиков менеджеров И вообще у всего отдела а больше уверенности у новых потребителей при выходе в продакшн то есть они понимают Какие оптимальные ресурсы ресурсы могут использовать для того чтобы э быстро читать свои данные успевать их читать и не было никаких проблем при их чтении а перейдём к выводам Первое - это конечно же фанг - это круто его можно использовать почти везде но не везде а не стоит пропускать тесты Фаст таргета если вам для теста не подходит сгенерированный аргумент из-за того что функция валидации а определила аргумент невалидный потому что тем самым вы будете фази больше именно эти методы а не тот метод который вам надо если пришлось генерировать данные из фаз данных то при ошибке выводить их в результат чтобы на основе сгенерированных значений описать тест-кейс в Unit test для дальнейшей проверки вашего кода но опять же я повторюсь это делается только для маленьких каких-то функций Где вы не хотите описывать тест-кейсы сами и просто доверяете фаеру а для н SQL нужно использовать тест контейнер чтобы не хранить фаз значения в таблицах а также с помощью fing в Go можно тестировать методы которые вызывают skl запросы к пример там и skl инъекции находить А фанг можно применить для нагрузочного тестирования на примере того как мы сделали у себя в команде Всё спасибо большое за внимание если есть у кого-то вопросы задавайте Да коллеги вопросы Напоминаю что у нас ещё интернет вопросы под плееров так Прошу вас да спасибо за доклад я тут я тут Привет Привет Смотри у меня вопрос пробовали ли вы как-то автоматизировать фанг тестирования Пускай Юнит тестов именно в сие то есть ну насколько понимаю они-то ограничены они по времени не ограничены надо понять когда их останавливать или вы гоняется это локально Но тогда наверное у вас есть какие-то регламенты Да как их запускать как то есть Вот мне интересно именно вот этот менеджерский процесс вот как вы их автоматизировали ту тут пока что мы не настроили это на самом деле Хороший вопрос это тема для отдельного доклада как это лучше автоматизировать а пока что мы это делаем на ну у нас есть свой Клауд и там виртуалку разворачиваем запускаем ну туда копируем код и устанавливаем golang и запускаем команду goest F с флагом Fast и Тестируем то количество времени которое нам оптимально пока что мы в взяли это полтора часа или час Вот так вот Аа так коллеги пожалуйста Вставайте когда задаёте вопрос А спасибо за интересный доклад вот такой вопрос я увидел что вы фази данные а фази ли вы ээ скажем так последовательность поступления событий Вот например чтобы детектив аба проблема или более сложные комбинации да Если я правильно понял то есть что когда первое пришло а потом пришло б и мы это записали верно Да конечно тестим мы так раз генерируем э к примеру поле адт который отвечает за это то есть завис адт мы обсмэ но там не мог показать нормальный пример на основе того что у нас на работе было но есть такое Да спасибо большое за вопрос Никита Спасибо за доклад очень интересно подскажи пожалуйста у меня несколько вопроси ков А что является для вас триггером для запуска фанг тестов Насколько часто вы их запускаете И сколько циклов итерации проходит Чтобы исправить обнаруженные баги А хороший вопрос э смотри у нас как было я пришёл на проект в котором уже были описаны методы и была проблема с тем как это тестировать То есть у нас были вот эти огромные тест-кейсы которые я рассказывал и пришёл к выводу то что надо применить фанг первой итерации мы сделали Так мы описали Фаст тест мы его запустили просто на локалке я его запустил проверил всё я говорю ребят давайте это внедрять мы внедрили и написали некоторый регламент какой А мы копируем код на нашу виртуалку вставляем Go записываем Фаст тест Фаст тест мы ставим на 1 час полтора часа и если оно отработала то всё ок на следующий день релизный мы можем это всё релизинг ничего не пришло ни у кого ничто не сломалось и всё потом когда у нас делается какая-то фича минорный баг даже и так далее мы всё равно это делаем перед релизный днём это там ну 2 дня в неделю мы запускаем Фаст тесты час полтора и проверяем всё ли ОК или нет Вот так вот Здравствуйте Никита Меня зовут Юра я из Бер Маркет в общем вопрос такой используете ли вы фьюзинг связки с каким-нибудь testify или подобным инструменту а нет по-моему с testify мы не используем мы просто используем фан с обычным с обычной библиотекой с тестированием я прил примеры как мы в принципе используем а так ну типично фн коробки используем и вс ничего нового Мы туда не добавляли Если вы что-то добавляли можем в корах обсудить было бы интересно послушать Спасибо коллеги Если у вас есть какие-то уточняющие вопросы после вашего первого после в курах можно уточнить всё Следующий вопрос Добрый день спасибо за доклад У меня вопрос в ших примерах тестов токовые н у меня мой какой-то кастомный тип данных я смогу использовать фанг А да конечно исполь Ну сможете использовать только надо делать свой кастомную функцию мутации а именно А у Вас например массив байт есть вы можете оттуда делать байт шал что это такое вы берёте какую-то определённый интервал из байтов и оттуда генерирует строку потом берёте какой-то Рандомный байт из этой строки и берёте оттуда код это будет число и тому подобное то есть вот так вот можете делать опять же если это слайс каких-то данных вы Вы можете взять слайс by и каждый символ оттуда преобразовать число это будет слайс ю интов или или просто компании infotex скажи пожалуйста а есть ли у вас какое-то Центральное хранилище корпусов и если есть минимизируйте вы его как-нибудь отличный вопрос Мы задумывались насчёт этого пока что всё обсуждаем с нашими коллегами девопсом и нами разработчиками хотим к этому прийти но пока что нет такого у меня был вопрос как выбрали один час Ну то есть фанг он может бесконечно продолжаться эмпирическим путём Сколько сколько итераций слушай ну мы уже сколько там месяца четыре это всё используем и пока что это всё Ну окей то есть не находятся баги если вот ты час полтора и у тебя Фазер ничего не отдал то всё хорошо круто круто Всё спасибо большое за ваши вопросы коллеги похлопаем ещё раз да спасибо вам хорошие вопрос давайте вы А тебе теперь предстоит выбрать два лучших вопроса из зала Да ну вот первый вопрос мне очень понравился и вопрос про централи Зро ий тоже хороший выходите к нам вручим вам подарки Не стесняйтесь привет Вот теперь будешь пить с термоса албес так да и второй про централи Зро най хранилище выходите выходите сцена не кусается Вот спасибо большое за вопрос интересно и самая приятная часть это вручение непосредственно подарка тебе за классный доклад Спасибо большое всё коллеги похлопаем ещё раз"
}