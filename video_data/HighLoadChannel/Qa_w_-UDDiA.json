{
  "video_id": "Qa_w_-UDDiA",
  "channel": "HighLoadChannel",
  "title": "Ubisoft в Google Cloud: автомасштабирование игрового кластера / Владислав Шпилевой",
  "views": 878,
  "duration": 3195,
  "published": "2022-03-21T13:13:02-07:00",
  "text": "меня зовут влад я работаю в ubisoft это кто не знает такая европейская комп рабочий игры крупнейшие известно по стоит вам типа assassin's creed фар край дивизион rainbow six и прочее и вот я работаю в немецкой студии в германии в городе дюссельдорф последние пару лет надо одной игрой над задачами связанными том числе с облаком конкретно с гугла клоунами и одна из этих задач по сегодня сегодня про него буду говорить это автоматическое масштабирование кластер и игровых серверов google claude цель моего доклада 1 исключительно эгоистическая потому что я люблю делать такие крутые штуки и потом про них рассказывают и не очень важно воспользуется ли даже этим просто сам факт рассказать что-то интересное мне это нравится и побочная цели то что я буду сегодня говорить проблемы решения они они не завязаны на геймдев то есть ну я как бы одним дева на задаче которая буду решать они гораздо шире можно применить не только для для игровых машин и в облаке можно в принципе их облаке использовать доклад пойдет по плану следующий можете сначала я скажу что такое масштабирование кластер а вообще о том как она у нас обычно работала в ubisoft и раньше и как она работает автоматически в google главное после этого я подниму проблему из-за которой использовать google cloud автоматическое масштабирование гугла не получилось и решу эту проблему в новом сервисе автомасштабирование и еще 7 задач и проблем небольших которые я пишу это же их решу в этом новом сервис потом объясню как он тестировался и какие планы на его развития масштабирование кластер и это добавление или удаление инстансов в него в зависимости от нагрузки на этот кластер я но стоит работает очень сильно по-разному для железных собственных машин и для облачных сервера в случае масштабирования личного железного кластера есть такая проблема что сервера нужно купить арендовать доставить установить настроить это все занимает по опыту от часов до недель из-за этого в кластере приходится держать большую резервную мощность которой обычно не используется но способна выдерживать регулярные колебания нагрузки на кластер это соответственно дополнительные деньги которые приходится тратить на эти машины на их обслуживание даже если они не используют большую часть времени и ну с другой стороны зато железные машины если масштабирование вообще не нужно они в принципе могут быть дешевле чем облачный могут быть значительно дешевле но из кучи еще других оговорок не только про масштабирование и с облаком все гораздо проще делаешь т.п. запрос к провайдеру облака через минуты или там даже секунды уже машины добавлены или удалены настолько мгновенно и практически масштабирования позволяет выполнять его очень аккуратно подгонять емкость кластера максимально близко к нагрузке на кластер платить только за то чем пользуюсь но минус если масштабирование не нужно или оно какое-то неправильное можно попасть на бабки можно взять спустить весь бюджет игры там за ночь например расскажу про это сегодня мы не спустили могиле пример о чем я говорю вот нагрузка на кластер есть пусть оно выражается в количестве игроков которые сейчас играют на всех машинах кластером и вот так выглядит хорошие облачно и масштабирование когда я ем костина анна тютелька в тютельку подгоняется под на нагрузку на кластер только столько машин сколько действительно нужно его так выглядит плохое масштабирование собственного железного класть очень неповоротливы и большими шагами работает и вот разница между этими двумя ёмкостями это не используемая мощность за которую платишь хочется перестать платить греби софте раньше были свои собственные железные кластер а стояли там в подвалах в студию и они имели все вот эти вот проблемы железных кластеров и машин плюс они были усугубленные спецификой онлайн игры именно нагрузка там меняется очень часто и очень сильно ну часто относительно минимум два раза в день в каждом временное временном регионе народ возвращаются со школы сработаем сидят сыграть идут спать уходят и нагрузка вот так вот колеблется каждый день очень сильно несколько раз бывает плюс нагрузку на игру вас сильно на нее влияют события какие-то которые в мире происходят типа игру раздают бесплатно или где-то на нее вы дали скидку или вышел по ней фильм или вдруг какой-нибудь блогер там в нее поиграл и она вдруг завирусилось как и мангас произошло и все это вынуждало компания удержать очень мощные дорогие машины которые бы поддерживали регулярные колебания нагрузки а для предсказуемых больших всплесков нужно было техническим директором запираться в комнатке обсуждать сколько же у нас будет вот там через месяц игроков когда мы выкатим скидку сколько нам нужно докупить машин доставить до настроить все это ужасно сложно дорого решили давайте попробуем поехать в облако либо целиком либо гибридно совместима с железными машинами на данный момент юбисофты используются все облака google всё же и у нас еще свое собственное внутреннее облако юбисофт клауд сегодня в докладе только про google будет google cloud делится на регионы регионы это какие-то географические области типа части европы там запад сша и прочие они делятся свою очередь на зоны которых обычно 3 бывает там плюс минус 1 и зоны определены в документации как дата центры и вот в облаке есть куча всяких ресурсов которые можно иметь в отдельной зоне или сразу во всем регионе поделить между зонами это диски google стареющего bucket и инстанции шаблоны инстансов образы виртуальных машин есть еще один такой ресурс под названием группы инстансов это цельный объект в облаке у которого есть свой интерфейс свои настройки можно управлять группой инстансов как едином целом то бишь и еще у нее есть у этой группы шаблон инстансов из которого новые машины штампует там образ виртуальной машины всякие скрипты и проще и вот эти вот этот ресурс группы инстансов они являются объектами автоматического масштабирования в гугле вот его включаешь и гугловый авто скейлер так называемый он начинает в зависимости от нагрузки которые определяешь сам через настройки что такое нагрузка будет добавлять или удалять машины и вот у этого авто скейлера есть проблема что углового что он теряет состоянии серверов то есть он выключает их как бы не аккуратно on grave это называется по английски он им не дает достаточно времени на то чтобы они успели свое состояние куда-нибудь сохранить то есть они стоит фу google авто скейлер он не дружит состоит full масштабирование из-за этого он совершенно не подходит к игровому серверу по крайней мере в той игре где я работаю и потому что у нее есть состояние во первых игроки сами по себе являются состоянием потому что они подключены к серверу если сервер внезапно выключаются игроки выкидываю просто disconnect происходит это ужасный игровой опыт и что еще хуже когда их выкидывает из сервер из гасили на нем могут быть прогресс пользовательский который еще не был выгружен в центральное хранилище сохраненных игр или где они там хранятся в общем прогрес потерян вместе с сервера его не успели выглядеть google instance удалил и решили в ubisoft и что давайте-ка мы напишем свой собственный of the skilled который будет иметь все то же что и google но он еще будет уметь сохранять состояние серверы и дальше по докладу я расскажу базовый алгоритм очень простой как работает самый простецкий собственный of those келлер google плавания и потом он уже будет решать вот эту базовую проблему стоит full скиллинга и дальше я покажу 7 и проблемы задачи которые решены сверху этого базового алгоритма по сути как модуль отдельными так вот авто скейлер это сервер он работает один на единственный на группу инстансов в claude юные как бы владеет то есть вся автоматика гуглово я на этой группе отключена авто скейлер там гугловый выключен и чтобы добавлять и удалять новые инстанции он авто скейлер общается с google кладом через его api google клауд rest api публичный интерфейс у него есть ссылочка ттп запросы типа создаем не столько ты инстансов удалить-таки это а сервера когда они подключают когда запускаются они подключаются к авто с киллеру посылают ему некоторые приветствия где разные константные данные вроде имени инстанции прочего и дальше раз в секунду посылают серверу количество игроков на этом конкретном игровом сервере и артас келлер в ответом посылают разные команды таким образом of those келлер собирает статистику с каждого сервера индивидуально и видит нагрузку на весь кластер целиком может и и оценить как он решает когда пара наращивать класс для этого понятие нагрузки определяется как среднее количество игроков на один сервер и есть понятие порога или три школ до что если нагрузка стала выше крыш холода среднее число игроков больше чем она то значит надо добавлять новые машины вот пример есть этот прыжком красненькая линия есть средние количество игроков на один сервер и какое-то количество машин пришли новые люди начали играть среднее количество игроков стало больше чем порог добавляем новые машины соответственно количество количество игроков тоже в делителе количество игроков увеличилось количество сервов средние стала меня опять пришли люди средние больше добавили машины в средние стало меньше от совершенно аналогичным образом работает уменьшение кластеры тоже среднее количество игроков но оно должно стать ниже другого тархова на другого порога то есть тех 2 как бы этих порога порог роста и порог уменьшения и нагрузка должна быть должна быть между этими двумя порогами авто скейлер этого добивается плюс небольшая деталь прежде чем можно реально начинать без не гасить машины нужно подождать небольшой time at чтобы защититься от осцилляции когда нагрузка она вот так вот колеблется вокруг порога то вышита ниже мы же не хотим каждую секунду единственности добавлять и удалять поэтому ждем пока нагрузка точно долго ниже порога но долго это как 5 минут уже достаточно обычно и начинаем уже тогда гасить и работает она не так как гугле просто там kill instance как бы все она работает две фазы чтобы сохранить состояние сначала списать серые а потом удалить вот предположим и хотим мы удалить один сервер авто скейлер пошлет ему запрос на списание и commission request сервер входят состоянии дико missing то есть в процессе списания он в этом состоянии больше не принимают новых игроков игроки которые уже на нем уведи всплывающее окно что сервер уходит на обслуживание там через три часа допустим и им дается время чтобы доиграть спокойно и потом уйти они рано или поздно уходят те кто не ушел они будут кикнут и а их сохранения все будут спасены загружены какое-то внешнее хранилище такой сервер входят состоянии де комичен то есть он вписан у него нет ни игроков не состоянии не срывов ничего теперь он просто тратить деньги стоит потому что за машины мы же платьем она ничего уже не работает of those киллер он уходит и такие машины гасят как можно быстрее чтобы сохранить бабки и это весь базовый алгоритм вот он в принципе уже работает пишется буквально там за тысячу строк даже на плюсах потому что у google кладу него очень удобный интерфейс самом деле документации отличная и он в принципе решает проблему потеря состояния и как прототип хорошо работает но в реальном продакшене он совершенно не применим я щас буду объяснять и семь раз почему первая причина решается расширением под названием восстановление машины посмотрим пример какая происходит проблема и как она решается и как вы решать не надо вот вот как она была сейчас я покажу и как делать было плохо есть кластер небольшой нагрузка между двумя пороками все в балансе а теперь а нагрузка меньше порога уменьшения списываем парочку серверов а теперь возвращаются люди снова играть и вот этот базовый алгоритм он что он он добавит опять два сервера потому что ему сказали добавляя когда нагрузка выше порога вот так делать не надо потому что вот эти два сервера мы с мы имеем на два сервера больше чем надо на самом деле можно было эти машины восстановить отменить их списания и пусть люди на них опять идут играю там и новые машины запускать не будем это будет и быстрее и сохранить деньги но и of those келлер новый он так и делает он если секунду значит без клики ливан вниз мне не ли стоит вот посмотрим пример как делает авто скейлер кластер два сервера находится в списание нагрузка высшая порога он восстановит машины какие уже находятся в писании и если нужно все еще добавлять новые машины тогда он их запустит так делать правильно и хорошо это сохраняет деньги следующее расширение называется кворум проблемы стоит следующее вот у нас есть игровой кластер нагрузка какая-то она выше порога опять есть баг в игровом сервере про который мы пока не знаем или знаем но мне всегда стреляет из-за которого игровой сервер и не может подняться то есть каких-то файлов важных не хватает из-за которых процесс просто сразу крышек или в dunlop уходит и вот нагрузка выросла выше порога авто скейлер добавляет машины они сразу же окукливаются на них больше нет рабочего игрового сервера машины запущены нам счет за них приходит потому что в клаудио не стоят мы просто простаивает of those келлер что видит количество живых инстансов не изменилось количество игроков не изменилось все еще выше порога он добавляет еще машина не тоже падаем и вот этот процесс надо останавливать потому что иначе однажды утром придешь на работу а бюджета игры больше нет и у тебя есть там 10 тысяч простых машин которые просто крутятся и ничего не делают нужно процесс остановить и пусть кто-нибудь вмешается и бак этот к-кто-нибудь починен вот авто скерри он вводит понятие кворумы кворум это минимальное количество минимальный процент подключенных сервировка авто скейлер у чтобы он мог принимать какие-либо решения типа добавь или удалив какой нибудь хотя бы один instance как он узнает сколько в кластере реально машин если часть из них просто не подключены вот здесь гугл нам опять помогает можно у группы инстансов через api google клауда узнать ее реальный размер сколько там машины они просто серверов наших на этих машинах вот of those келлер он сравнивает количество машин которая рассказала ему google клауд api сколько у меня в группе реальной инстансов и сравнивать с количеством подключенных машин если оно меньше кворума по пациенту то он будет орать влоги и от будет отказывается что-либо делать а если больше карамат все в порядке например если у вас 10 машин кворум 90 процентов нужно чтобы хотя бы 9 машин были подключены к вто скейлер у и тогда он сможет добавить одиннадцатую или одну машину удалить какой-нибудь следующее расширение называются гибкие пороге когда птиц пришел суть проблемы в чем состоит вот этот порог масштабирование среднее число игроков на самом деле это то же самое что резервирование того что у игровых машин у них есть лимит жесткий на количество игроков которые могут может на сервере быть пусть она будет 100 и если мы говорим что порог масштабирование 90 то есть в среднем в среднем получается 10 человек где 10 слотов на каждом игровом сервере в кластере пусты всегда потому что мы дальше начинаем новые машины добавлять получается как бы в данном примере 10 процентов резерве резервирования что это значит в абсолютных цифрах для одного и того же процента пусть класть 310 тысяч машин на 10 процентах резервы мы получим условно тысячи пустых машин просто простаивающих ждущих когда на плывет кучу и пользователей на классе 300 машин это будет 10 разницы в стоимости в сто раз и в количестве пустых слотов пользовательских тоже в сто раз для одного и того же процента казалось бы не очень большого и вот этот резерв количество пустых слотов пользовательских он еще из разное время закончить пусть у нас вот в кластере два сервера заполняются каждую секунду плюс 200 человек каждую секунду заходит играть и bootstrap нового сервера занимает 3 минуты тогда резерв из десяти машин у нас кончится за пять секунд резерв из тысячи за 8 минут первое это очень мало второе это очень много втором случае можно более чем в два раза сократить резерв очереди все равно не будет оплатить будем более чем два раза меньше за этот резерв в итоге получается вывод что не масштабируется один-единственный процент резервирования или порога роста или как угодно можно называть в 1 . решение практически наивны очень простое берем мы заставляем зависеть порог роста вот размера кластера в конфиге она так и выглядит и сумму что если серверов в кластере меньше ста то порог роста 90 если вот ста до тысячи 95 если больше 98 очень легко вы кодируется очень легко конфигурируется админом который это все мониторит ну и максимальная гибкость настройки принципе все решения которые тут приводятся они мотивированы в сновном простотой следующая проблема мое любимое предсказание в чем суть вот как мы себе представляем масштабирование кластера в теории то есть ёмкость кластера растет сразу как как мы захотели добавьте но там пять серверов и не хёк и сразу появились на самом деле это не так прирост кластера выглядит вот так потому что загрузка сервера занимает время иногда существенное время есть игры где загрузка сервера может занимать там 20 минут и боль нами все это время что это загрузка идет кластер перегружен то есть масштабирование происходит когда уже факт перегрузки произошел они до того как она произошла в этом проблемы получается рассмотрим пример 200 машин один сервер заполняется за секунду резервов 10 процентов bootstrap новой машины 3 минут резерв кончится за 20 секунд дальше люди две минуты 40 секунд будут все ждать в очередях и что еще хуже это будет повторяться вот как на графике эти красные треугольничка не будут повторяться снова и снова на каждый следующий рост это не один раз произойдет решить это можно только если заметить шаблон нагрузки как она себя ведет сейчас и как она себя будет вести как прямая там или парабола или какой-нибудь кубка кубическая кубический полином или что-то такое нужно заметить шаблоны опережать нагрузку как именно это делать в принципе тут особо ничего изобретать этих решений 300 тысяч миллионов просто вводим скаляр google.com кластер лот prediction и наслаждаемся бесконечным количеством реперов как это делать что интересно реально любопытно что нет а не только войти у нас есть это вот похожие проблемы есть областях типа нагрузка на электросеть нагрузка на сеть и и водоснабжение вот на графике на слайде два графика нагрузка никто сети на игровой кластер если ты их не подписал в течение дня если ты их не подписал вы бы не отличили правда здесь возможно возможно не связаны как это нет гарантий что это независимые данные да и отличаются эти решения очень многие чрезмерной сложности они страшно сложные какие-то нейронные сети там предлагаются нам реализовывать их нужно обучать от часов до целых сезонов и модели эти они часто статические ты один раз обучил там вместе с назад и тайны этой модели живешь и предсказываешь не очень плохо адаптируется час и хочется что-то гораздо проще потому что вот возьми любые несколько часов подряд на этой нагрузки они будут выглядеть как прямая или как часть параболы наверняка есть что-то максимально простое ну вот есть регрессия самая обыкновенная простейшая первокурсника и сказать тема полиномиальной регрессия нам нужно линию или параболу берем линейную квадратичную регрессию берем этот сет типа таймс темп и количество игроков в кластере в этот момент и оцениваем его в ближайшем будущем как прямую или как часть параболы которые определяются коэффициентами а бойцы уравнений на слайде и оценить простоту этого решения можно по количеству строк на плюсах сто двадцать строк из 240 строк на плюсах для этих двух регрессий включая комментарии in cloud и пустые строки фигурные скобочки и прочее это максимально простое решение и она действительно работает вот предсказания будет выглядеть его так мы посчитали дома боится подставляем x как некий таймс темп в будущем считаем y получаем число игроков в будущем недалеком и все и вот о том предсказание работает это можно даже конфигурировать оба типа регрессия его в тоске лири я сделал и можно выбирать в конфиге любой без downtime а прям онлайн переключаться тюнить их можно выбирать время тренировки и раз сколько секунд собирать то есть две настройки всего это очень легко и победит даже интуитивно понимается ты видишь эти точки понятно дальше это будет прямая и пара была моя любимая часть вот этих вот и грести всех в том что их можно обновлять то есть модели не статических можно обновлять заказа константное время добавляя новую точку и модель перри обучается постоянно как движущиеся окно она никогда не статична я покажу как на примере линейной регрессии с квадратичный там тоже самое только формулой страшнее и после последнего слайда и paбoтaeм регрессии будут подробные формулы которые можно потом после доклада посмотреть их взять и закончить так вот у нас есть dataset таймс тмк количество игроков мы посчитали а и b посчитать их можно методом наименьших квадратов можно них считываться сейчас в эти формулы особо я посвящу на что надо смотреть вот мы обучили модель посчитали а и b добавилась новая . новый x и y я утверждаю что вот эти вот синие формулы можно обновлять за константное время мы их просто в переменную сохраняемость каждой новой . их обновляем вот смотрим сумма иксов сумма таймс темп когда появляется новый таймс то мы добавляем новый вычитаем самый старый две операции не зависит от количества точек от n и это все с этими синими формулами со всеми так то есть мы их все можем обновлять за константное время зная их мы в любой момент можем посчитать зеленые формулы включая а и b получаются а и б у нас в любой точке обновляются сразу за константное время и можно начинать предсказывать и как это выглядит на реальных данных с одной из игр ubisoft посмотрим как если нет предсказаний выглядят просто ужасна кошмар очередь есть всегда когда кластер растет вот из-за этой проблемы что начинаем буду стопить новой инстанции когда перегрузка уже по сути произошла слишком поздно включаем линейную регрессию видим что чуть-чуть очередь есть вначале и вместе где нагрузка была почти как прямая потом поп и вот так вот переломилась но вот такая вещь прямой не оценивается до включаем квадратичную регрессию и чуть-чуть очередь в начале есть а в остальном все отлично работает почти нулевая очередь причем эта нагрузка это за 20 минут 60 тысяч человек это очень редко бывает обычно квадратичная регрессия работает практически идеально очередь 0 следующее расширение это роллинг апдейт или раскатка апдейта диплоидной знаю как это перевести нормально честно говоря в чем суть проблемы нас на случай если кто-то не знает вот у нас есть кластер игровой днем какие-то машины уже работают обновили шаблоны инстанса вообще не либо какой-то в игре хотим ввести его раз катить заходим на страничку гугла веб-страничку ну в этот консоль кликаем на чьи-то p на клавиатуре новое название тимплей то и ждем новой инстанции будут новый шаблон получать от google автоматически когда resizer группу или добавляя что в инстансе ты ничего кроме имени инстанса выбрать все равно не можешь шаблоны google сам все назначает новым инстанциям как обновить старые вот если используется гугловый of those киллер принципе очевидное решение просто берем в кусочками перри создаем эти инстанции пока они все не обновятся разумеется с потерей состояния чего мы хотим избежать так что эту штуку приходится в новом авто скейлеры тоже делать работает она в принципе очень похожи на google то есть новый инстансы получают чтобы он автоматически как я говорю это не зависит от того используйте в авто скейлер гугла или нет просто api такое он шаблоны сам назначает вот чтобы существующем виде станицами разобраться сначала надо определить есть ли вообще апдейт авто скейлер для этого скачивает с google cloud rest api metadata группы инстансов и там написано какой самый актуальный сейчас шаблону имя просит и каждый игровой сервер посылает свой текущий шаблон авторский леру и of those киллеры сравнивает и видит какие сервера устарели а какие нет и вот эти устаревшие сервера он обновляет трех сторон когда нагрузка падает когда кластер стабилен и когда нагрузка растет первая часть когда нагрузка падает очень просто берем pride предпочитаем списывать устаревшие машины мы хотим от них избавиться быстрее потому что там может быть бага вот пример 3 устаревших сервера есть нагрузка ниже порога уменьшения списываются сначала устаревшие серверы если надо еще тогда уже списываем новое элементарную вторая часть очень похожа на google кластер стабилен а апгрейт хотим продолжать мы же не хотим только по ночам там как-то обновляться нужно быстрее раскатывать так вот вводится понятие апгрейт кого ты тоже самое что у гугла только у него название параметра другое она говорит сколько процентов группы от этой группы инстансов можно единовременно обновлять вот я говорю здесь 20 процентов это два инстанса будет если верх округлять и он начинает обновлять он списывает 2 устаревших сендеры они пока еще живы но уже в списание нагрузка сразу выросла потому что количество игроков то же количество активных серверов только что уменьшилось и of those кевин вместо того чтобы восстановить устаревшие машины он добавит новые то есть кого то позволяет ему немножко перерасходовать резерв ради того чтобы произвести апгрейдить и вот так он потихоньку под воинственно будет обновлять только вот google перри создает инстанции на месте у них даже ими остается та же новый авто скейлер мой он удаляет и создает новый это немножко не то же самое что пересоздать на месте позволяет сохранить состояние устаревшие машины которые может и устаревшие но все равно надо аккуратно ее вывести из строя третья часть во время роста кластера было во время падения во время стабильной работы его и во время рост и очень похоже все опять берем апгрейт квоту и когда авто скейлер хочет восстановить какие-то машины чтобы увеличить количество активных серверов он апгрейт кого-то устаревших серверов ему разрешается поставить в списание вестник создать новое почти то же самое что во время стабильной работы и таким образом апгрейт никогда не останавливаемся он всегда продолжается кластер потихоньку обновляется следующее расширение конри deployment канареечный deploy пробный диплом типа как когда как канарейка заносят в шахту посмотрите они будут биться в клетке значит опасность и от можно уже понять в чем проблема здесь в чем задача не проблем есть кластер есть шаблоны группы инстансов и мы причинили в окно мы не уверенны он всем проблему решает не вносят ли он новые баги почти наверняка вносит на просто страшный или нет надо понять на части инстансов они на всем на где они на всей группе вот такое желание называется кадре deployment и в google и она поддерживается заходим на страничку своей группы инстансов в интернете вот в гугле в консоли клауда это называется там можно для группы задать два шаблона его 1 написать что у него размер должен быть целевой там 50 процентов или какое-то количество инстансов в процентах или в абсолютном числе и тогда новый инст он все будут получать шаблон опять автоматически от гугла старые обновятся угловым of those киллером до тех пор пока целевой размер не достигнут но мы в главы of those келлер не используя на фичу хотим поэтому в новом авто скелетон тоже есть больше того работает она почти точно также как обычный апгрейдить маленьком день потому что роллингов дует на самом деле это же то же самое что пробный диплом кнр depoimento размеры сто процентов так что принципе там все то же самое новый инстанции получают шаблон автоматом чтобы узнать есть ли в процессе конри диплом авто скейлер скачивает настройки группы инстансов с google api и во время роста или уменьшения кластера списание или востановлении машин он будет учитывать целевой размер посмотрим коротенький пример вот кластер есть пробный deploy размера 50 процентов и он будет потихоньку обновлять инстанции но только до тех пор пока не достигнется целевой размер здесь это 5 из 9 если округлять вверх и теперь предположим выросла нагрузка я хочу еще три машины авто скейлер здесь говорит гуглу дай мне еще три машины я не указываю шаблон какой у них в голову сам назначает правильно он учитывает вместе с нами со своей стороны целевой размер пробный подгрупп теперь интереснее я хочу списать шесть машин google здесь уже не поможет он нам не помогает выбирать кого списывать 10 of those келлер будет действовать так он будет пытаться смотреть так чтобы в конечном размере кластера размер целевой по группы все еще соблюдалась то есть если должно остаться шесть машин значит нужно три пробных оставить из 6 остальные все списали нее не в рано или поздно удаляться и вот баланс достигнут следующее расширение называется баланс зон стать следующим вот эти группы инстансов они могут быть зональными могут быть региональными и тогда инстанции в группе могут раскидывали раскиданы быть по зонам региона и в идеале они должны это делать равномерно потому что если одна зона выпадет дата-центр сгорит тогда мы не хотим потерять слишком много инстансов когда создаешь новые инстансе google их сам раскидывает по зонам даже если его of those киллер не используешь там зону тупо нельзя выбрать и вот если используешь гугловый of those киллер то вот уже гасить инстанции он помогает было сбалансировано по зонам так что если одна из них выпадает то теряется только какая-то фиксированная часть кластера хотим такую же штуку в новом авто ски и вот она там есть работает опять же точно также как rolling апдейт потому что теперь немножко подумаем и говорим о давайте положим что инстанцией в зонах которые самые большие считаем их как бы устаревшими и тогда все встает на свои места то же самое что и от греет получается опять google делает полу работы за нас назначают зоны новым инстанциям автоматически список зон можно скачать из метода ты группы инстансов вот прям в таком виде всех грифончика угол очень удобно возвращает его время списания и восстановления машин пытаемся держать зоны в балансе короткий простой пример кластер 12 инстансов три зоны нужно добавить машину of the skilled гуглу говорит дай мне шесть машин google их сам раскидал по зонам авто скейлер тут ничего почти не делал а теперь нагрузку упала и вот здесь of those келлеру нужно выбрать инстанций так чтобы оставлю остались в балансе активные машины в этих трех зону и если теперь нужно восстанавливать машины опять of those келлеру можно самому выбрать инстанция так чтобы зоны остались балансе как это все совместить я привел сейчас 7 каких-то расширений и вот представим теперь у нас их кластер в котором есть устаревшие машины есть конри deployment есть обычная машина есть еще несколько зон и нужно теперь еще один instance списать какой из них как список по какому из этих пример чиков действовать of those келлер решают эту проблему используя болты которые начисляются машинам за определенные признаки зависимости от того что мы хотим с ними сделать вот здесь я хочу списать один сервер и я нужен для каждой машины посчитать сколько баллов она получает за признаки 100 тысяч баллов за то что сервер устарел я хочу избавиться от устаревших машин как можно быстрее они просто могут быть опасны содержать какой-нибудь очень плохой баг может быть даже связанные с безопасностью максимальный балл следующие два балла контролируют размер конри deployment а про пробный пробного диплом если слишком много канареечно их машин выбираем списывать их если слишком мало канарейкин их машин выбираем списывать остальные с двух сторон как бы эти два балла удерживают размер целевой у этого пробного деплоя следующий бал контролирует баланс зон и он для этого зависит от размера зоны в процентах мы хотим предпочитать списывать в тех зонах которые самые жирные чтобы держать их балансе со стальными к примеру если у нас здесь две зоны в них 30 процентов инстансов и 70-ым все сервера в них получат по 130 и посту 70 баллов и последний бал позволяет нам реально нормально так деньги экономить списывать в первую очередь пустые машины если по остальные балом они одинаковые оказались потому что в густой машины у нее уже нет состояния можно и прям сейчас удалить получить немедленно и сохранение деньжат потому что счет за нее идет о игроков на ней нет его в на ней нет и списываем машину самым большим и малым причем вот эти баллы они специально подобраны так чтобы они друг другу друг друг над другом имели приоритет и чтобы по сумме баллов можно было всегда восстановить какие баллы сервер получил за что это очень удобно для отладки посмотрим пример есть все типа серверов есть три зоны есть пробный deploy 25 процентов 12 я хочу один списать я считаю баллы на авто скейлер считается вместе видим что устаревшие машины устаревшие машины получили максимальный балл 100 тысяч за то что они устарели тысячу за то что они не камере и конри deployment в порядке ты из 12 это 25 процентов мы не должны сейчас списывать конри сервере и 125 за за то что в их зоне 25 процентов инстансов списываем один считаем новые баллы они немножко поменялись потому что процентное соотношение урон изменилось теперь в первые 18 процентов incense опять уничтожаем устаревшую машину обновляем баллы точно таким же образом еще по одной машине гасим а вот теперь произошло что-то интересное экономичные сервера вдруг вырвались в лидеры по баллам все потому что 25 процентов кендре deployment он был нормальный 3 инстанса из 12 в начале внутри из восьми это уже слишком много их нужно 2 25 центов это возьми это два один из них стал лишним и конкретно надо списать именно тот который в большой группе для большой в большой зоне и в этом смысле комбинация весов за лишний конри сервер и за самую большую зону они срабатывают и мы гасим конри сервер и самый большой зоны и так далее все повторяется и не нужно ждать каждый раз когда когда сервер пир предыдущие удалиться после списания сервера он уже из рассмотрения выпадает поэтому эту штуку можно молотить просто в цикле столько раз сколько машин надо списать они там дальше удаляться когда-нибудь восстановлением все то же самое просто баллы инвертированные и созданием новых инстансов там как я говорил google назначает все самые зоны и шаблоны мы можем только имя выбрать нового инстанции больше ничего но это удобно меньше работы как все это тестировать авто скейлер он написан на си плюс плюс целиком и полностью вот baby soft и они просто очень любят все + + и пишут на нем все практически том числе и эта штука почти 6 тысяч строк кода на плюсах и тестов легко переваливает за 8 тысяч строк кода просто собрав так сказать строки по самым большим файлом уже переваривает как это все тестировать монолитом конечно это делать невозможно самые простые тесты будут выглядеть просто ужасно слишком много бойлер plate кода будет поэтому of those келлер побит на три части базовые алгоритмы они считают пороге предсказания сколько серверов удалить добавить покрыта июне тестами они даже она не зависят ни на google и даже на время есть авто скейлер библиотека в ней один единственный класс авто скейлер и он реализует решение базовых алгоритмов применяя их google clown ду и он покрыт функциональными тестами которые проверяют как он работает google api с игровыми серверами интересная часть в том что от теста эти работают даже без google clown для этого я написал гугла клауд эмулятор это два таких клас са си плюс плюс ных опять же которые полностью имитируют интерфейс и ответы и запросы google клауда авто скейлер с ними болтает и вместо реальных машин он создает прямо в памяти теста объекты которые ведут себя как игровые сервера я могу туда добавлять разные ошибки задержки смотреть как авто скейлер на это все реагирует и не платить за это деньги не ждать bootstrap реальных машины исполняемый файл там просто 1 авто скейлер живет тестируется в основном вручную там тестировать в общем-то ничего особо и последняя часть тестирование это менее прямое первое это полная копия авто скейлер написанное на тритоне это ну она очень сильно упрощенная но она позволяет позволяет играться с алгоритмами разными на реальных дам пах данных сквозь дров юбисофта разных игр там я могу экспериментировать с параметрами конкретными алгоритмами если мне что-то нравится я добавляю это в плюсовые тоски для есть еще нагрузочные тесты где весь backend игры запускается все типы серверов запускаются десятки сотни тысяч ботов и они пытаются играть и вот смотрим как of those келлер запускает под них машины и есть плей тесты где просто вся команда разработчиков играют в основном там тестируем геймплей но авто скейлер тоже две-три машины поднимают для этих тестов очень короткое быстрое сравнение и без авторского и гуглово авто скейлера я комментирую только пару моментов по-быстрому первое кворум и восстановление они не были бы нужны если мне не нужно было состояние то есть либо ты мучаешься с этими расширениями но зато имеешь состоянии либо у тебя состояния серверов теряется но зато очень простой авто скейлер не тому ни другому не плюс с предсказаниями в гуглово авто скейлеры есть предсказание но ему нужно три дня тренировок прежде чем он хоть что-то на сможет начать предсказывать и он ужасно сложный но зато он наверное очень умный на всяких сложных нагрузках способен работать а у меня нужно вместо трех дней три минуты и он работает на моей нагрузки в принципе неплохо на вот этих линиях и пара балах и на относительно быстром времени bootstrap а но над этим из сложных нагрузках вероятно будет работать хуже никому не плюс-минус куклу однозначно за то что стоит full of those келинга у него нет какие планы на развитие во первых пусть это все в тепло сейчас эта вещь работает только с ботами запускаем столько ботов сколько будет игроков у нас обычно как все работает посмотрим может быть с реальными людьми что как меняется хотя вряд ли тут геймплей никак не вовлекается во всю эту систему и следующего комбинировать облака и железные машины потому что люди играют всегда нагрузка есть какая-нибудь всегда она никогда не 0 и можно было бы часть этой нагрузки покрыть железными наш некоторые были бы дешевле чем всегда держать что-то в клаудио и какие выводы я предлагаю из этого доклада сделать как минимум во-первых идеального авто скейлера не существует очевидно все зависит от задачи как и как и всегда конкретного того какое у вас время bootstrap оного воинственно нужно ли вам состоянии какова цена перегрузки потому что в игровых серверах нет перегрузки там просто новые игроки не принимают не то что они играют и играют хуже там медленнее они просто стоят в очереди очень дорогая перегрузка но к счастью как минимум у google клауда в очень удобная документация интерфейс на которых можно было дать свой авто скейлер идеальный для себя и предсказания нагрузки она как звучит сложно кажется страшным на самом деле его можно сделать незначительно несложно как я продемонстрировал и может очень значительную пользу принести и в плане сохранения денег и опыта пользователей и третье в claude можно на значительное количество денег сохранить если масштабироваться максимально близко к нагрузке платишь только за то чем пользуюсь спасибо за внимание и прошу обратить внимание еще на пару ссылок остальные моей презентации включая вот эту там появится и здесь можно посмотреть чем мы еще в ubisoft и занимаемся и возможно кто-то заинтересуется а то ссылка на немецкие вакансии берлине when he не you die schule darphin вопросы ваши это владислав стилевое друзья спасибо тебе огромное за этот рассказ мы тебя благодарим организаторов конференции есть теперь персональная рамка кассиру шарф и термос ребята у нас всего пять минут на вопрос и я думаю что это будет два если вы готовы потерпеть до кулуаров сделайте это ну что ж у кому-то сейчас достанется микрофон привет интересный рассказ меня зовут стас компания gaijin entertainment ближе микрофон скажи пожалуйста тебе не кажется что ты написал свой огонь из что добиться у гугла есть решение google огонь из это скейлер для побудут кластеров как раз для нашей истории про гейзер да я делала шелк угла стоит флот с келли на него есть авторские легких у него прям буквально написано что он не работает состоит фу серверами которые сименс там групп хорошо будет дискуссия давайте еще по первому ряду тут уж ребята как как повезло кто сел гляжу спасибо за интересный доклад у меня вопрос такой как вы выбираете конфигурацию сервера и или и или количество игроков и что выбирается первым и ну каким образом вообще профиль нагрузки определяется определяются в столом пнуть тем что игровые сервера жрут по большей части в данном случае очень много ресурсов циpкa тратится и и памятью на искусственный интеллект на ботов на дикую жизнь какую-нибудь в этом мире на физику и прочее и в основном памяти цыпа лук вот из-за этих вещей являются пределом до которого можно добавлять новых игроков потому что они мира усложняют и довольно быстро циpкa или память просто заканчиваются и машина теряет ну и количество игроков назначаются столько сколько влезает на сервер который мы можем себе позволить дальше мы занимаемся оптимизация my потихоньку лимит поднимаем машины обычно заранее уже решаем какие будут все метрики скейла это с на цыпочек вот в google о вам авто скейлеры это циpкa и можно остальные настроить как нибудь по сложным у нас цепова это вообще не метрика только количество игроков средней но другой авто скейлер не смотрит остальное это чисто локальная тема для одного конкретного сервера как его оптимизировать а нагрузка на кластер целиком вот в этом авто скерри выражаются только в количестве игроков еще вот один вопрос сразу за этим самым обернись обернись вот та здравствуйте спасибо за доклад а я хотел узнать как формируется кривая скалирование включена ли туда сеть что происходит со скейлера мм сети если сетью плохо и как это скалирование происходит для мобильных устройств так тебя в обратном порядку рад вещать kicks ass т.к. мобильные устройства это неважно это игровые сервера это не клиент но на преважно мы в него например ему надо дать картинку хуже а кому для меня это не картинка этой игровой сервер без карте это никак типа стадия там или луна это просто игровой сервер с логикой это не с картинкой картинка это ты просто клиента запускаешь на другом сервере не сервера именно клиент и запускаешь из три мишени и понял потом потом потом про проблема сетью был учу вопрос что будет делать скейлер если мигает сеть тогда она спасет к вору потому что если например там паук мастер и как-то трудиться и он начнет полнить новые машины он очень быстро упрется в кворум и остановится пока сеть и починить но мы рассчитываем на то что мы как бы google audi вроде как у них сетью должно быть все в порядке пока проблем таких не возникало но если что там куча всяких наворотов с безопасности типа и в google группе этой группе стас фаллос выкручен лимит что нельзя больше не восполнить ё авто скейлеры еще несколько есть настроек типа максимальное количество инстансов которые можно иметь сколько можно максимум их стартовать в единицу времени и вот кворумы все это нас защищает от таких штук вот подробности тогда дальше будут у нас дискуссионной зоне я хочу человеку за настойчивость на держит руку в течение всей сессии надо дать возможно задать вопрос иди предстоит выбрать лучший здравствуйте спасибо за захват очень интересным вопрос что делать ваш автор spieler если в зоне или регионе и нету больше ресурсов и еще маленькая ремарка у вас на начальном свадеб было географическая карта у вас сша уехали в латинскую америку спасибо что он делает с ты в зоне кончились ресурса у нас нет ограниченных зональных ресурсов сервера пользуются только региональными ресурсами типа шаблон инстанции это регионально ресурсы сама группа тоже региональные а если в регионе закончились в каждом регионе свой собственный авто стелио нет таких групп которые намного регионов в каждой группе работает в свой авто скейлер и может быть даже не один там у нас может быть кластер на на x-box кластер на еще что-то если к 1 плеи нет то есть это не то не 11 келлер на все в одной игре может быть много of those киллеров много таких под кластер ков которые конкретные какие с какими-то клиентами может работают или на них раскатывает что-то совсем экспериментальная"
}