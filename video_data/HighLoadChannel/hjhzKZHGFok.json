{
  "video_id": "hjhzKZHGFok",
  "channel": "HighLoadChannel",
  "title": "Как мы делаем web в Skype / Павел Брылов (Skype)",
  "views": 174,
  "duration": 2949,
  "published": "2017-04-22T14:47:46-07:00",
  "text": "Доброе утро ну как вы уже знаете зовут Меня Павел блов Работаю я в компании Skype теперь которая является частью майкрософта подразделением пару слов обо мне родом Я из Казахстана 3 года назад переехал в Эстонию по приглашению Skype и остался и в общем не жалею До этого работал на казахстанской фондовой бирже кстати Интересная история вчера кто-то прошёл на конференцию под моим именем я опасался что он выступать будет так что если ты в зале Привет Работаю я сейчас в команде которая называется volet Team это бывшая большая команда которая называлась Secure Web и занималась всем в Скайпе что связано с действиями которые может делать авторизованный пользователь то есть после того как вы занились грубо говоря Вы попали в наше царство ну есть ещ вторая часть которая то есть страницы которые можно посещать не зарегистрированными об этом я сегодня не говорю эта большая команда была в течение последних лет раздроблена на несколько маленьких и вот Т - это одна из этих команд мы занимаемся платежами то есть всем что связано с принятием у вас денег и предоставлением вам сервисов работаем с разными провайдерами с кредитными картами с кучами провайдеров из самых маленьких стран Ну и логично что платежи - это очень важная часть и мы вынуждены вкладываться в инфраструктуру вкладываться в процессы которые мы используем для того чтобы разрабатывать наше программное обеспечение для того чтобы обеспечить бесперебойную работу и как бы максимальную доступность и стабильность О чём доклад Ну кста можно по-быстрому кто так вот чтобы понять Окей добрая половина зала отлично о том как мы практически избавились от монолитных приложений нескольких в угоду новому новой со архитектуре которая в общем нацелена на облачную инфраструктуру о практиках подходах которые мы используем для того чтобы разрабатывать всё это дело и о том как может быть взять инфраструктуру в свои руки и перестать переживать за консистентность серверов серверов и так далее сразу скажу если кто-то ждёт каких-то больших цифр или какого-то инсайда о хайде Скорее всего я Вас разочарую но мы в Скайпе уверены что для того чтобы действительно делать что-то крупное что-то с высокой нагрузкой нужно иметь для этого все удобные понятные прозрачные процессы которые позволяют любому сотруднику компании там в несколько кликов понять что происходит на какой стадии какие-то части продукта Ну и часть этого и inte и то есть грубо говоря выкатка вашего бафик не должна занимать там больше часа грубо говоря Ну для того чтобы было понятно как мы к этому пришли и что мы этим хотели добиться надо рассказать немножко об истории о том как это было до этого И сейчас я вас немножко попугаю тем как это всё было есть несколько лет наза нало ком на каж грубо говоря скажем был отдельный большой компонент который занимался только платежами содержал в себе там все на свете провайдеры со всеми на свете хака под каждого провайдера там я не знаю в Бразилии нужно вводить там номер своего удостоверения личности для платежей то есть всё это было в одном приложении всё это работало но с эно очень тесно связаны между собой а что-то реально поменять э было сложно потому что было несколько библиотек которые были ещё больше чем эти приложения и использовались повсеместно то есть есть легендарный класс юзер который Ну использовали абсолютно все И как только вы хотели вдруг что-то там поменять или добавить было вообще непонятно где что отвалится соответственно чтобы как-то определить сколько займёт разработка какого-то нового сервиса Ну буквально ходили к гадалке то есть ну может быть там 3 месяца потому что неизвестно что что что дальше спасает настолько тестирования в этой ситуации то есть так как непонятно что где отвалится тестировать нужно всё и под Всё я подразумеваю действительно всё то есть у нас ре тестинг занимал там неделю или две после каждого релиза когда мы Рова каждую ниж но и с каждым Там профайло и так далее и Ну даже учитывая что большая часть этого была автоматизировано это было просто очень долго и соответственно очень не продуктивно Какие ещё минусы У этого подхода одна большая команда одна команда которая занимается и платежами и пользовательскими профайло и рассылкой емейлов и всего на свете и продуктами и кампе кучей всего соответственно люди роти никто точно не знает кому звонить ночью если что-то сломалось Ну потому что ну Позвоните программистам там вот Secure Web команда там не знаю 40 человек в разных локациях в Праге и в Таллине Ну позвоните кому-нибудь соответственно Ну понятно что распределённая ответственность - это на практике это нет ответственности вообще Ну и масштабировать масштабировать это очень сложно потому что большой компонент скажем у вас увеличилось ру на Я не знаю на платежи пейпалом потому что там у пейпала какая-то очень супе доб фича появилась для того чтобы вам позволить делать эти платежи пользователям без тайма и так далее вынуждены выкатывать большие сервера больших приложений ну которые добавляют свой Ох другая проблема - это как раз есть прорве настраивали грубо говоря пону админов были была документация которую они старались поддерживать о том какие там пакеты нужно установить Какая версия ядра дистрибутива и так далее но делалось это практически вручную устанавливалось это всё на металы на реальные сервера То есть если вдруг у нас какие-то пики нагрузки или ещё чего-то дай бог если есть железо Ну которое конечно было в резерве всегда но всё равно это нужно всё установить нужно всё настроить и как правило это занимало там ну от нескольких дней до недели в самом в самой плохой ситуации было у нас решение с тем чтобы накатывать готовые имиджи операционной системы там с настроенными очами PHP и так далее оно работало гораздо лучше чем документация но была с ней проблема с тем что этот имидж грубо говоря устаревает там ну через 2 недели потому что у вас там есть новое ядро К тому моменту там новые какие-то секюрити Фиксы в пакетах и так далее ищем пожи всех вопрос Ну типа А что вы тут делаете тогда О чём вы рассказываете потому что ну это просто что это такое и почему почему Skype у скайпарка Мы вкладывали в развитие бизнес-функции в развитие пользовательских каких-то функций и в общем Сейчас мы об этом не жалеем если вчера кто-то был на докладе из Фейсбука по поводу оптимизации там был хороший пример про их рекламную рекламную систему которая была очень оптимизирована она была супер но параллельно они забыли там работать с родом у кредитных карт и в итоге проект закрылся из-за этого То есть сейчас оборачиваясь назад мы в общем не о чём не жалеем и то что мы теперь часть майкрософта в общем доказывает что мы всё сделали правильно Ну естественно в какой-то момент мы поняли что ну уже всё мы больше так не можем надо что-то делать Ну и в том числе менеджмент потому что просто самые ярые экстрасенсы больше не справлялись с тем За сколько что-то будет сделано и тогда мы придумали новый фреймворк Ну то есть Мы начинали с фреймворка и назвали его стратус стратус это такой тип облаков всё началось с фреймворка на PHP который должен был решить все проблемы Он был там лёгкий и так далее придумала к нему со архитектура В общем не имеет Ниго отношения полу довольно продуман архитектура которая Нам нравится и сейчас в этом стратус облаке работают приложение на питоне Вот ребята из Москвы из Кика делают это на сервисы которые точно также работают в этом же клауде Ну Ира ЧМ очень классная штука во-первых вместо этих больших компонентов огромных используются маленькие и под маленьким я имею в виду это приложение которое может там Серви ТПО три адреса грубо говоря извиняюсь все приложения работают между собой этим жем которые они предоставляют есть скажем если нужно получить профайлы данных из приложений которые не связаны они мы идм к приложению которое отвечает за профа юзера и получаем у него всё это пою Какие ещё особенности версионирование в оден это будет так все того момента пока это не буде пока это не будет там полгода в режиме кидать этому приложению вло что вы используете Уберите Это и так далее то есть ну не страшно никто не боится менять какой-то код если изменени не Вовы видеть как его слить то есть мы можем спокойно определить что если скажем после интеграции с Фейсбука мы знаем что будет гораздо больше логинов и мы знаем что будет гораздо больше там каких-то обращений к Face интерфейсом мы можем очень легко и просто посчитать сколько инстан сов этих конкретных приложений с этими конкретными ми нам нужно задеть никаких угадае бот в этом смы это тоже то что Олег скажем рассказывал на учебном дне То есть если какой-то из сервисов вдруг не работает обрабатываем это и смотрим если мы можем выжить без этих данных круто продолжаем работать то есть пользователь должен получить что-то что для него полезно Ну за исключением там самых критичных сервисов когда бессмысленно что-то показывать Это основан то есть очень любим ием всеми его интересными заголовками и кодами ответов этого на самом деле по шею хватает Но по крайней мере Для нас Для того чтобы строить довольно функциональные интересные приложения используем J как транспорт ещё интересная деталь что мы используем общее дерево рест ресурсов для всех этих приложений то есть грубо говоря адрес вашего энпо он будет в единой рест архитектуре для всех приложений соответственно там каждая команда не может сделать там с к примеру потому что тако такой уже есть соответственно тот кто получает это имя та команда которая получает это имя у неё должен быть Для этого должна быть для этого весомая причина и они должны сделать этот API таким который бы устраивал всех это это как бы Форт нас немножко Ну и это часть которую расскажу На следующем слайде В общем выглядит это приблизительно так то есть с высоты птичьего полта Как вы видите есть там группа алике разных которые делают запросы на регистре в начале своей жизни регистре это реестр который знает в общем всё и обо всём умею Серви вот такие энпо интерфейсы И я готов к работе регистре это записывает и сгруппировав передаёт на Gateway а геями выступает у нас ngx он в общем выполняет работу и такого очень большого роутера и Лансера ну и соответственно там ww Gate - это W skype.com грубо говоря там API - это API skycom то есть один и тот же API скажем или endpoint может находиться на разных доменах одновременно более того там один и тот же код Может там быть на разных API но это уже детали то есть пользователь заходит на Gateway и соответственно запрос этот попадает в Application который занимается именно этим API В общем это я уже рассказал Ну вот так это выглядит то есть скажем вы вы хотите получить там информацию о пользователе с API skype.com попадаете на API gway и API gway знает что отправить на есть он Бет ответ возвращает вам соответственно Если вы хотите уже получить Аватар что в общем там Небольшая разница то вы попадаете уже на другой алике который называется Аватар и который мы можем отдельно слить он вернёт вам картинку соответственно Если вдруг где-то там я не знаю там тенч решил использовать скайповский аватары для аватаров пользователей мы знаем хорошо что делает стратус страту в общем это четыре обязательных интерфейса которые приложение должно имплементировать для того чтобы попасть в ратус Cloud и работать Это в общем то что позволяет приложениям на разных платформах прекрасно сосуществовать в одном облаке То есть это Stratus register который регистрирует его в регист это manifest Это который возвращает информацию о приложении об его библиотеках которые оно использует с их версиями что кстати удобно там Если вдруг найдена какая-то не знаю sec уязвимость Или просто какой-то такой мерзкий баг вы всегда можете из регистре узнать какие приложения пользуются определённой библиотекой в которой был этот Баг и задеть их ратус инфо возвращает список всех Ну то что я называю ми то есть ре интерфейсов с их методами с ИСИ параметрами которые они принимают то есть там строки ли это инты ли это и с их описанием Что опять же тоже очень удобно Потому что всегда можно автоматически проваливать правильный мы инпут отправляем какому-то конкретному или нет Ну и последней но не менее важны это ту опять же обязательный который должен проверять состояние приятно что раз мы должны имплементировать это ту то девелопер уже знает что Ну окей у меня там приложение которое занимается работой спам вот чтобы мне сейчас проверить ВХС логично проверить соединение с лом да то есть таким образом опять же мы форм девелоперов на то чтобы делать какие-то очень полезные вещи то есть тот же ту он может проверять там что угодно соединение к баз соединение м и далее из этого свалилось тут же сработает N aler тут же сработает мониторинг и люди начнут заниматься проблемой стратус как PHP Framework Ну написан он логично на PHP Почему PHP было наверное Понятно По поднятым рукам то есть количество девелоперов которых можно найти очень большое Ну с этим есть проблема что очень много программистов на ПХП которые пишут насе Ну гораздо меньше тех кто реально понимает что делает и пишет хороший код Сам же язык ну по нашему мнению довольно неплохо эволюционировал с PHP 4 То есть можно писать Вполне себе приличный объектно-ориентированный код плюс выросла инфраструктура вокруг него там тесты пожалуйста acceptance тест с битом пожалуйста dependency вот вам тон Тулы Ну куча всего на самом деле инфраструктура растёт это очень радует вот кусочек кода который к сожалению не влез в слайд там ПХП немножко обрезано который мог бы быть тестовым стратус приложением для конференции H которая там выводит конкретного партиси или там список участников на что тут стоило бы обратить внимание Две вещи Первое - это вот этот protected Property который является это в общем простейшая реализация dependency injection Я в двух словах расскажу об этом на следующем слайде И что самое интересное это как вы видите аннотации в комментарии То есть это наверное самая клёвая штука которой мы очень гордимся и которую мы очень любим практически на базе рефлекшн мы добавляем всю Мета информацию к обычному ПХП методу которая потом становится эндпоинт как вы видите который отвечает там J определённой версии Кстати версионирование у на но на базе ТТП протокола Ахра и где версия - это опциональный параметр Контент тайпа это кстати тоже очень интересная тема можно её обсудить если кому-то интересно аннотация Gateway говорит о том что конкретно этот endp должен находиться на API и нигде больше соответственно он там будет зарегистрирован ещё одна интересная штука это мы Деним все коды которые этот endp может вернуть в комментариях это обязательно если вдруг кто-то пропустил задефать вот это вот код то он получит Ну не там очень страшно эп в логах для чего для того чтобы получить для этого интерфейса адекватную документацию то есть из всех этих аннотаций Кроме того что они добавляют функционалы и у нас там их несметное количество для всего там для авторизации для каширование для всего на свете аци Шепот это будет Ревы на скажем не интересно тебе у тебя вот есть задача чтобы пользователь был авторизован и плюс к этому мы генерируем очень довольно красивую удобную документацию из всего этого то есть опять же мы не явно форм девелопера писать документацию хоть какую-то Ну кроме документации которую мы пишем добровольно оче про вот этото обра и суть его очень простая Мы дефнем в конфигурации какой класс должен сервис как сервис с этим именем вот видно сес Proper То есть если вдруг там скажем у вас используется кэш не знаю во всём коде используется там слово севиш а потом вы решили его заменить на что-то другое вы просто меняете в конфигурации и всё Я скорее всего очень быстро пройду по слайдам потому что информации много времени мало поэтому Если вдруг вопросы Давайте наконец оставим что ещё в этом фреймворке ратус то есть он состоит из многих компонентов самый основной компонент То есть это самое ядро фреймворка которое содержит минимальный функционал который нужен App В каком формате и так далее реализация которой я говорил базовые классы для кша Гера и так далее ну как бы просто вот самая минимально нужная часть Ну это единственная нужная часть для любого Application написана на PHP Ну а где всё остальное Да логичный вопрос всё остальное в версионирование очень просто мы решили что мы будем использовать maven для сборки наших приложений Это позволяет нам опять же иметь несколько библиотек но на этот раз уже версионирование с версией какой-то библиотеки 1.0 то мы просто будем её использовать И всё И мы знаем что она точно работает все зависимости управляются маном и Что делае у нас написан свой тус M плагин который в общем делает очень простые вещи он раскладывает там PHP файлы по нужной структуре скачивает все то есть скажем тур библиотеку для баз данных и так далее Всё это складывает определённую структуру плюс запускает PHP Unit запускает проверку качества кода в код сфере проверку там не знаю C детек детек и всего на свете и генерирует документацию то есть в нашем бил системе мы видим приблизительно такую картину Вот это из рандомного то есть мы видим что тесты Прошли мы видим что мы там накосячили где-то в чек стайле что нам это надо исправить чем мы скоро займёмся но тем не менее Вот это всё очень наглядно и всё очень понятно а два слова буквально о самых популярных библиотеках то есть не знаю дата Бей библиотека Как вы все наверное знаете мы используем постгрес одни из наверное самых крупных пользователей постгрес в мире может быть даже самые крупный Я честно говоря точно не знаю http Cent для работы в общем для мелике кокей и для работы со сторонними сервисами кэши и Jobs и кою библиотека это кстати тоже имеет интересную реализацию вчера вот баду рассказывали об этом У нас тоже интересный подход это динамически работает на базе нотаций то есть если нам нужно запустить какой-то ДБ в клауде то есть Back процес мы добавляем просто к этому PHP методу аннотацию что Джоб там название джоба И как часто его запускать И с какой изоляции то есть там на одной машине в пуле там на всех машинах в пуле и так далее То есть тоже довольно так динамично настраивает соответственно если Машина упала то При следующем запуске алике проверит так я должен сейчас запускать эти джобы должен запускаю не должен значит не запускаю Всё просто в м работает Нава таких центральных компонента в нашей системе разработки это бисер и менеджер репозиториев разных репозиториев там и мановский репозитории и для репозитории там для всего на свете то есть тако такая Центральная система которая имеет мно тут же сбил новы Snap Запусти на тесты и так далее ЕС про он это всё запл в env То есть это е до Q такой env там это всё авточе зап плюс в это варо постоянно бегают тест там и с селениум и просто API тест и совестно вы всегда можете зайти посмотре Так что там после моего комита всё хорошо или всё плохо там нужно исправлять и как бы в принципе точно такой же процесс повторяется несколько раз то есть Он повторяется там для продакшена в том числе то есть мы на этот раз уже пакет который там не содержит в себе какие-то тестовые денн такие как не знаю PHP и так далее которые в продакшене не имеют смысла и этот В итоге этот пакет попадает уста пару слов об игре тестах написано они на пайтоне есть у нас для них свой такой красивый UI который называется taffi Test Cas automation Framework Мне кажется это сокращение от этого в общем Просто красивый наглядный UI который показывает сколько в целом Наши тесты наших тестов зелёных и красных сколько их по конкретным командам по конкретным компонентам там вплоть до конкретных API всегда можно зайти посмотреть Какое состояние у нас вообще что там готово к Продакшен что не готово А тесты хранятся все integration тесты Несмотря на то что ими занимаются отдельные люди которые называются лити инженеры э Они находятся в одном репозитории с апликейшн то есть мы вот стараемся всё как-то хранить вместе для того чтобы это всё можно было одним разом получить и всё посмотреть То есть тот кто работает над каким-то приложением он может тут же запустить там Unit тесты integration тесты Получи посмотреть там какие-то ещё детали об этом приложении об этом дальше дальше Ну что что в итоге мы получили в итоге мы получили что у нас довольно изолированная система которую легко модифицировать которую легко улучшать и в общем у разработчиков нету никакого страха перед ней потому что ну скажем средний ратус Application там не больше 10п файлов в каждом В каждом из которых я не знаю там может быть пара тысяч строчек это максимум и они очень изолированные по скоу то есть там если это не знаю про р Аватар то это только про картинки и где их брать и как это всё работает то есть Очень просто разобраться Ну и очень легко масштабировать как я об этом говорил плюс особенность того как мы работаем Ну во-первых так как мы команда была разделена на много маленьких то у каждого появился свой скоп кто-то занимается платежами кто-то пользователя кто-то е чем-то Но есть же обе библиотеки ту или какие-то библиотеки баз данных тут вот мы используем подход очень похожий на Open sce То есть у нас внутри скапа есть скажем такой небольшой стратус комитет не очень официальный Если кто-то вдруг хочет что-то улучшить в Коре или Добавить новый функции он делает точно так же как вы делаете Это на гитхабе и члены этого комитета должны сделать ревью долж это принимается это выпускается в новой версии там с логом со всеми процедурами если кто если все посчитали что эта функция ненужная или нужная только каким-то определённым кейсам или определённым командам или компонентам то пожалуйста Там эта команда может выпустить свою библиотеку или свой форк и работать с ним тут всё очень логично и прямо организовано Ну и как сайд эффект от того как мы это делаем так как мы сами строим свои приложения на базе API которые мы предоставляем логично что что эти API хорошие То есть когда к нам приходят партнёры или ещё кто-то и просит Дайте нам API для того-то и того-то мы знаем что мы им отдаём точно качественный продукт потому что мы сами с этим работаем Мы едим свой гфд Что называется А ну да и добавить сервер так просто его в общем не добавить из того что я перед этим Рассказывал Ну на самом деле добавить Потому что потому что Шеф Кто пользуется шефом вот все остальные кто не пользуется пожалуйста пользуйтесь А Пользуйтесь потому что оно реально облегчает вам жизнь зна что такое шеф а система автоматизации инфраструктуры система которая позволяет к инфраструктуре В общем относиться как к коду это вот модное слово нынче devops оно на самом деле не только модное но ещё и реально полезное на практике то есть кто кто если не вы как разработчик приложения должны знать как настроить ваш сервер То есть если вы написали код и типа работает на моей машине выкинули админом дальше ваша проблема но это не работает потому что когда что-то случится админ скажет я вообще не знаю что он написал И это будет просто показывание пальцами друг на друга это не работает другой вариант Когда вы пишите документацию что вот мой Моё приложение надо установить так-то так-то там Впишите в тот конфигураций конфигурационный файл то-то то-то и так далее ну кто любит писать документацию Я думаю руки можно не поднимать тут вс всё понятно но а писать прикольный код на рубе там с красивым ДСМ это же прикольно хорошо и ты его запустил и ты проверил что оно работает что вот этот вот небольшой кусочек кода на один слайд который читается В общем и целом как английский язык что он реально установил ачу и запустился и вы можете использовать такой тул как н для того чтобы протестировать это всё локально и запустить в Виту боксе маленький истан вашего приложения и посмотреть как это работает затюнить что-то эту машину и посмотреть Ох ты работает классно что что интересно как бы я не буду даваться в детали Что такое Шеф и как работает поэтому этот слайд больше для тех кто немножко с ним уже работал Если кому-то интересно могу рассказать после доклада То есть все изменения в кбу ках это набор рецептов которые Шеф использует проходит абсолютно тот же путь что и приложение то есть точно такая же разработка точно такое же тестирование в той же самой би системе всё запаро тестировано попадает в тот же самый менеджер репозиториев и точно с таким же процессом деплоя то есть прозрачность деплой стопроцентная всё всё идёт одним путём всегда понятно где Что искать Тестируем мы кбу с помощью критика и текина это такие самые Ну критик - это просто Линт грубо говоря K позволяет поднимать реальные виртуальные машины в процессе тестирования запускать них рецепты и сверять там какие-то результаты то есть то ли мы получили что хотели Ну и для того чтобы работать с нашим репозиторием написан гин который в общем позволяет сбил артефакты этих кбв заливать на Шеф сервера то есть там команда что-то вроде kn название кубка он берёт там версию которую нужно из рери зава интересного мы делаем шефом версионирование то как какой-то апликейшн или тип сервера должен быть настроен и проблема в том что так как наши приложения они маленькие и компактные то их очень много То есть их ну реально сотни и версионирование о устанавливается набор конфигурации с которой он работает а мы к тому же должны иметь там старую версию и новую версию в лайве для во время деплой то есть Для нас это тоже очень важно поэтому роли в шефе не версию Мы в общем подумали не знаю Минут 10 наверное и пришли к самому лобовому решению добавлять версию просто в название роли очень просто соответственно мы получаем везирова роли которые могут сосуществовать то есть одно приложение может быть разных ролей совершенно и может работать одновременно Это позволяет нам делать то есть то что я сейчас объяснил мы выкатили скажем 20 инв одного алике в продакшене Мы выкатили один с новой ролью он работает точно также регистрируется в регистре и работает как предыдущая верси смотрим Что продирает нерата плохо работает не понравилось мы удалили этот истан или поменяли на НМ роль на предыдущую версию понравилось Ну окей оставляем выкатываем дальше Да и шеф автоматически добавляет каждую созданную машину в мониторинг но шеф - это круто но на самом деле круто когда это в Облаке у нас своё собственное облако мне тут показывает что у меня время просто истекает с бешеной скоростью Поэтому я буду очень быстр можно будет Я надеюсь потом почитать подробнее в слайде собственное Облако на базе Ксен мы пробовали openvz ноен нам понравился больше то есть мы не только пробовали Мы работали на нём сейчас насколько я знаю это облако переделывают на hyv потому что он ещё лучше по нашим экспериментам Что даёт облако всем понятно Я думаю То есть можно создавать сколько угодно контейнеров виртуальных и в общем не париться делать это одной командой а Шеф позволяет с использованием этих ролей их тут же настраивать запускать и всё работает Последний пункт база данных Да логичный вопрос Что интересного мы делаем с базой А с базой У нас есть такой тул называется от слова что это В общем это такая же тоже деплой система отдалённо напоминающая Шеф для баз данных скажем любое изменение в базе данных можно зать можно откатить соответственно мы делаем так называемые которые могут содержать в себе там дефиницию новых таблиц изменения функциях что угодно В общем любые и Что даёт во-первых он это депт то есть из Единого ю можно синхронно деплоить это на несколько если раньше когда фали какие-то функции или там я не знаю схему в таблицах то приходилось идти там на сервера смотреть что там сейчас запускать там ди какой-то сравнивать Ну это неудобно и это долго сейчас на каждую команду из ама который выглядит кстати вот так вот это для дефиниции таблиц то есть ну это обычны я который описывает Что за поля какие там индексы Какие и так далее И вот так вот приблизительно выглядит функция Ну так вот когда это депт он видит div То есть он видит что хорошо мы плом эту функцию он он смотрит div там поменялась вот эта строчка вот в таком контексте он может быстро посмотреть нажать дей И это всё автоматически там грубо говоря на дабах машинах бегают агенты которым которые получают по ssh задание от этого юя и просто их пят Что интересного в этой функции интересно её название Как вы видите там в кавычках написано H и переменная db SA version что это это опять же магия нашего маленького плагина Ман плагина которая позволяет нам делать версионирование схемы проблема ровно такая же как и с шефом и с версионирование ролями То есть как выкатить новые версии функции Ничего при этом не сломать и иметь возможность Дули выкатывать своё приложение с новыми функция самое простое решение добавьте версию в название схемы Ну работает стопроцентно Вы выкатили спокойно новую схему её ещё никто не использует всё Очень безопасно выкатили новую версию алике несколько инв он начал использовать новую схему вы смотрите работает не работает Не работает вернули ничего при этом не сломалось и этого нам было ело пото не бывает мы сделали штуку которая называется airic это наверное Одно из самых спорных наших решений потому что оно работает Это в общем система Ну всего всего который работает на базе тикет системы это очень странное решение Почему Потому что ну когда мы думали что нам вез надо ходить что-то нажимать нам это не нрави нам надо единый то что называется как бы единый источник Правды в который мы зашли и мы можем посмотреть Окей там когда что было за деплоя что тестировалось как тестировалось когда с какими результатами там ну всё Мы подумали Ну а где может быть этот источник писать там своё новое приложение для этого ну это как бы странно да ут система в которой так уже сеча Отт кто работа нам его пл кто его тестировал А почему бы не сделать на основании этого не автоматизировать весь процесс И вот тогда мы придумали ATC что он делает он следит за всеми изменениями в общем во всех наших системах То есть если вы за котили в git он идёт и создаёт новый релиз айм на то чтобы этот алике можно было задеплоить то есть ну если вы что-то за камили Вы наверняка точно хотите это задеплоить у вас уже сделана для вас вся бюрократия так как вы за комител у вас триггернуло на тестовый мент ATC запускает тесты он получает нофи и запускает тесты значит Окей мы задеплоил надо проверять он запускает все тесты получает Ну дожидается результатов добавляет результаты обратно в тикет систему то есть мы уже видим Окей Вот вот этот для приложения Вот его результа наши уже в общем не заморачиваюсь Ну хорошо всё зелёное отлично идём дальше что-то красное Оке идём разбираемся Что сломалось то есть что что там девелоперы наломали дальше если вдруг есть какие-то денн у этого например параллельно две команды работают над каким-то приложением и кто-то ещё не задеплоил а вторая команда делает assumption что Ну это уже в лайве Значит мы свою версию тоже можем деплоить э мониторить статус задания то есть самое важное и самая страшная часть которая Если быть честным ещё не до конца оттен и в лайве Но вот я расскажу так как будто это уже есть это именно автоматический деплоймент в Life это уже точнее Если точнее это работает для ба данных пока что это у нас есть тус у этих амов то есть есть там Production и так далее То есть в зависимости от статуса этого at делает соответствующие вещи есть если там статус Production грубо говоря и всего есть если кто-то зал в Кет систему это может быть я не знаю даже менеджер или менеджер неважно зал в т систему нажал produ мы Всё проверили всё нормально он там поставил что он хочет выкатить 10% например мы просто плом и благодаря тому что у нас версионирование са в той же самой тикет системе как комментарий или статус этого ама все получат уведомления на почту Ну и всё всё очень прозрачно как для как для девелоперов как для так и для менеджеров вот такие вот истории из библиотеки тусовкой или вы там приложили свою руку там не знаю к библиотеке для работы с базой данных и хотите всё знать что с ней происходит Подписывайтесь в скап чате на этого Бота он вам будет присылать все изменения пару слов о будущем будущее наше Скорее всего будет Windows потому что мы делали исследование о том что нам это Дат и это будет работать им йт почему потому что своё облако - это реально круто это позволяет там нам делать какие-то вещи именно так как мы хотим Но оно добавляет очень большие проблемы с тем что ну его нужно метени то есть надо постоянно создавать для этого облака имиджи всё равно надо постоянно там следить за ним А если нужны какие-то изменения это опять же ну занимает гораздо большее времени То есть если бы мы сейчас взялись разрабатывать все сервисы которые есть в Windows ager Я не знаю в этом ли десятилетии это случилось Ну и cpnet это опять же следствие из Windows потому что логично наверно на эту платформу работать именно с сипом но благодаря вот этой архитектуре которую мы используем У нас есть стопроцентная уверенность что это эта миграция пройдёт для нас очень плавно понятно предсказуемо и без больших пром выносить ихр и смотреть как это работает то есть и делать Этот плавный плавный переход и я считаю что это прекрасно на этом всё Отрара Ура Спасибо за внимание у нас есть Skype и мои контакты здесь Если есть вопросы Я не знаю есть у нас время на вопросы пару вопросов Можно я ве ш вот вас ба данных вы видел версионирование и определённые правила для работы с данными Скажем мы не удаляем данные то код код может испортить данные код может испортить Данные есть такая опасность и правильно понимаю что вы выкате вот когда выставите т вы катате в продакшн и у вас нету стейджинг получается нет У нас есть стейджинг я просто сократил Потому что если я буду рассказывать про каждое совсем то мы завтра утром бы закончили реально то есть Я когда узнал что 45 минут Мне и так пришлось вот так ужа и поэтому я таратор понятно да то есть есть на самом деле их два два тестовых энвайронмент Продакшен плюс есть ещё отдельный Sandbox мент который там партнёры используют плюс есть тестинг env который делает тесты то есть ну мы в процессы вложились основательно этим немножко даже гордимся и вот ещ последний вопрос Вот про упомянули какие-то особенности Вот вс-таки вот доклад был про организационный такой на самом деле процесс постро процес разработки А всё-таки вот допустим вот можете сказать за 15 секунд вот особенности допустим использования пог в лоде особенности вот для нашей команды особенности использования в том что мы используем его как серс есть Это опять же организационная ча серо в лайве нас не интересует У нас есть команда которая занимается именно db как сервис То есть вы баз данных не занимаетесь Вы не ну я делаю функции я делаю миграции я настраиваю индексы Но именно скейлинг настройка это предоставляется как сервис отдельной командой в Скайпе за которой я к сожалению не могу рассказывать вы упоминали Я здесь прямо вы упоминали версионирование через Котен ty заголовки Есть ли преимущество перед указанием Почему вы выбрали именно Ну очень простое во-первых указание в Уле - это не restful то есть это сразу рушит всю идею то есть ресурс - это указатель на реальный ресурс ваш V1 - это не ресурс То есть вы уже в принципе нарушения во-вторых Ну менять это сложно То есть если вы сделали новую версию всем вашим коню надо идти везде менять этот урол там скажем Ну это сложно Ну и плюс мы считаем что именно на АПТ храх и на вот есть на самом деле два что мы считаем правильных решения это на АПТ хедере с vender specific контент тайпа И вот так как мы сделали по этому поводу Очень много споров и это опит решение но мы считаем что так правильно я понял спасибо скажите пожалуйста вот в начале доклада вы сказали что у вас на вашем фреймворке используется он сразу нескольких языках PHP JS и Pon это ну вот как чем-то оправдано ведь администрировать такие вещи Ну сложнее или это исторически причи скажу так питоном пользуется Московский офис это бывший Кик они сейчас занимаются JS Это был наш эксперимент У нас есть определённые приложения которые оче имеют очень большую нагрузку и нам нужно было прокс в итоге мы скорее всего от него откажемся в пользу дот нета потому что dnet нам понравился больше но как бы факт в том что это работает и ещё такой вопрос Вот вы упомянули Шеф Да а пат как альтернативу вы рассматривали рассматривали более того наши админы начинали с папита и пытались что-то там сделать патом и что-то даже до сих пор работает но Шеф нам нам по больше возможностью в самом крайнем случае написать там чего насколько я знаю в пате сделать сложно Ну и как бы в общем и целом оно нам ближе Спасибо ка вы используете вы какой используете нальем Понятно спасибо Павел Спасибо спасибо вам"
}