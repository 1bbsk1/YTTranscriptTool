{
  "video_id": "8gZtNcbEaas",
  "channel": "HighLoadChannel",
  "title": "Как наладить CI-процесс в монорепозитории / Алина Власова (Лаборатория Касперского)",
  "views": 554,
  "duration": 1976,
  "published": "2023-01-19T05:55:16-08:00",
  "text": "всем привет меня зовут алина власова я из лаборатории касперского сегодня я расскажу о том как наладить процессу сей процесс моно репозитории и сохранить спокойствие разработчиков о чем будет мой рассказ ну во первых почему мы на репо вообще как мы к этому пришли при чем тут мы на репо где же в ней заканчиваются спокойствие разработчиков с какими проблемами они сталкиваются и как мы возвращаем их спокойствие для начала я немного расскажу как у нас компании была устроена модель разработки ранее как же мы все-таки пришли коммуна репе ранее у нас каждая команда желаю в собственную проекте собственном репозитории имела собственную систему контроля версий часто у команд были свои инфраструктуры некоторые даже разрабатывали свои собственные инфраструктуры решая часто схожие какие-то проблемы все бы конечно может и ничего может быть можно было бы жить так и дальше и может это и нормальная схема разработки но у нас компании есть такая особенность что между командами есть множество взаимных связей часто приходится вносить одинаковые правки во многие команды либо от изменений в одной команде зависит множество других команд и чем больше на становилась таких взаимных связей тем сложнее и дороже нам становилось носить такие изменения чтобы проблема было понятнее я немного не расскажу подробнее для допустим я разработчик я хочу я работаю в команде один на данном слайде представлена и хочу внести туда изменения какие то есть несколько условий которые собственно сопутствуют этим изменениям но во первых изменения из команды один поставляются бинарном там в какие-то другие команды 345 например я хочу сделать изменения без сохранения обратная совместимость это значит что мне в командах 345 тоже придется что-то поправить чтобы про интегрирует туда свои изменения по хорошему окон у-у-у команд которые от меня зависит имеются свои собственные ся и процессы в различных инфраструктурах и команды эти имеют различные системы контроля версий ну вот я разработчик что же мне делать хочу внести я вот такие изменения озвученные на прошлом слайде ну во первых я должна сначала найти всех своих клиентов возможно где то есть какой-то реестр возможно где то это записано возможно это кто-то знает и мне сказал возможно эта информация где-то устарела и я нашел там своих клиентов с горем пополам которые 345 однако никто не гарантирует что спустя пару недель когда я уже залью все правки закончу с этой задачей внезапно окажется что где-то есть клиент 7 который также зависит от моих правок и там тоже придется потом опять возвращаться к этой задачей что-то править ну ладно с этим я справилась нашла всех где нужно поправить что же дальше дальше мне нужно внести все таки правки в их команды а у них у всех разные системы контроля версий кто-то там в той сюжет который perforce и кто-то в гите в общем не надо под все это подстроиться вспомнить общей как как где работать потрачу немного лишнего времени на это ну дальше я справилась с тем что я все-таки внесла изменения в код в этих проектах у них там запустились какие-то собственные себя и например я где-то накосячил о плохой код написала там упали сборки тесты мне приходится с ними разбираться в разных инфраструктурах посмотреть где какие там ошибки к диалоги найти сложно непонятно но я разобралась потом поняла что мне нужно опять поправить что-то своей собственной команде один и синхронизировать эти правки все это заняло у меня достаточно много времени сил и мы подумали а что если взять и перевести все эти проекты в один общий репозиторий и сделать так что будет в общую репозитория сияет настраивался на общий инфраструктуре которые работают с этим репозитория что же тогда как выглядят мои проблемы ну во первых найти своих клиентов мне очень просто а него тут все можно найти поиском одному source control у все очень легко не по что не нужно подстраиваться в этой системе контроля версий я работаю каждый день пойду и повседневно поправлюсь и еще не только свой код но и код соседних команд ни под какую инфраструктуру мне подстраиваться не надо я с этой инфраструктуры работаю каждый день во всех своих ошибках разберусь все в принципе тоже достаточно просто ну и последняя проблема надо падает само собой потому что я может вообще все это изменю в одном pull request и поправлю несколько продуктов проектов и так далее ну и собственно мы поняли что данная схема в целом решает наши проблемы мы переехали в общий git репозиторий выбрали себе там перешли на транг без development сделали общую инфраструктуру этого репозитории что же мы получили на графике представлена время доставки изменений какой-то абстрактной команды один тут промежуток времени взят около двух лет до того как мы пашем перешли в моно репу и после но и получилось так что команды стали доставлять свои изменения реально многократно ускорившись так что же для нас такое моно репо немного расскажу о том что она у нас это git репозиторий размером порядка 50 гигабайт в него делает сок около 350 квестов в день имеется около 150 уникальных контрибьютором в день однако как я уже говорила у нас моно репо это не только общий репозиторий но это общая инфраструктура часть инфраструктуры в нашей компании разрабатывается она у нас самописная специальное и ввела на слайде красной рамкой наверное то почему мы стали делать эту тему отдельного доклада или даже докладов поэтому я тут просто упомяну об этом и пойду дальше у нас есть общий сборочный конвейер асгард общая система тестирования хаев распределенное хранилище артефактов air общая система сборки базиль система управления репозиториями pipeline ажурный вот и еще у нас есть отдельное окно поддержки для всей этой инфраструктуры ну собственно где же у разработчика возникает беспокойство перейдем к этой части моего доклада основной сценарий разработчик это внесение изменений в код при том при изменении кода у разраба разработчик создает пол request в публик вести у него запускается во льду ционный build вот немного о нем я и расскажу валидации он эй билл вот у нас есть мана репе такой общий pull request назад так называемый он перед тестирует все зависимости которые ранее там жили в разных проектах как яро я рассказывала вот это сейчас все столкнулась в одном мёде так при правках какого-то самого базового кода у нас есть базовые компоненты если разработчик поправит базовые компоненты они соберутся под все платформы на их основе соберутся продукты под windows маклин ос linux мобильники для этого всего запустятся тесты и вот такой вид имеет порядка ста пятидесяти шагов это джаббы мы называем это какие-то операции там сборки или тестирования 1 сборка 1 тестовой сессии это джабба вот таком билде порядка 150 таких гробов и вот таком самом длинном сценарии приправки какой-то базовые части компонентов нашей компании он длится порядка двух с половиной часов почему я об этом говорю для того чтобы дальше вам было более понятно почему разработчик так беспокоиться если же все же у него длится бил два с половиной часа однако все не так плохо если комитетом в какой-нибудь просто windows продукта конечно валидация проходит намного быстрее так какие же есть проблему эту у этого в лицо на вода до ну во первых как я уже говорил в нем есть большое количество зависимостей а чем больше зависимости тем скорее всего будет больше нестабильность этого вида ционного да да потому что каждая отдельная часть она может быть там очень даже стабильно иметь какой то маленький процент нестабильности когда все это вместе накладывается то получается такая нормальная нестабильность и инфраструктуры как внешняя какая-то которую мы используем так инфраструктура который у нас находится в процессе разработки также вносит свою нестабильность в результате суммарно это все для разработчика складывается просто в нестабильность в это ционного билда который у него запускается на по request ну и вот допустим я разработчик пользуясь своим основным сценарием правлю кот у меня запускается вальдо ционный билд и он упал для начала нет придется разобраться кто же все-таки виноват виноват я ли я написал плохой код и у меня упал во льду ционный бьет или вылета ционный build упал из-за ряда причин которые я озвучивала на прошлом слайде ну хорошо разработчик разобрался его кот не причем build упал по не зависящим от него причинам поможет и сейчас ему перезапуска если он возьмет перезапустит build он пройдет или нет непонятно ну разработчик перезапустил build он опять упал когда это все починиться кто-нибудь этим вообще занимается когда надо перезапускать непонятно разработчик начинает беспокоиться когда у него много таких миграционных билдов пол request of видео надо чего-то ждать и мы обеспокоились этой проблемы подумали как же нам все это решать как нам с этим жить мы посмотрели на пол request и разработчиков ну на данном графике по горизонтали это астрономическое время по вертикали это длительность долгов зеленые билды успешные красные неуспешные серые отмененные смотрим мы на неуспешные билды и думаем вот как отличить билды которые упали потому что разработчики плохой код к метели и как отличить билды которые упали по нашим внешним причинам нестабильность team различным мы подумали а что если нам взять и исключить вообще вероятность что это разработчик какой-то плохой код коми тела давайте попробуем возьмем и начнем запускать этот бил по мастеру просто как я уже говорила ранее у нас транг bass development кажется что мастер должен быть всегда зеленом билл должен быть всегда успешным мы попробовали его запустить по мастеру раз в час каждый час и получили что на самом деле берут не всегда зеленый не всегда успешно и он у нас падает периодически мы подумали ага ну значит вот на таком билде можно отслеживать вообще в принципе здоровью мы на рифы так называемое своеобразное какие в этом преимущество ну во первых мы можем предотвращать проблемы на ранней стадии то есть мы можем на таком билде найти какие-то проблемы раньше чем например они воспроизводятся в пол и квестах разработчиков его легко мониторить ну понятно каждый час запускается успешно и неуспешные неуспешные анализируя легко найти ответственных нам не надо сидеть и разбираться в том что возможно виноват виноваты какие-то изменения в каком-то пол request и разработчика скорее всего это реально какая-то проблема какая то нестабильность и ее нужно решать с ней разбираться видны глобальные проблемы например есть несколько таких за скиду льных билдов падает подряд то скорее всего там вообще уже все сломалось ничего невозможно запустить закомитить ничего не работает ну и можно заводить инцидент на каждую такую проблему сразу же не задумываясь и вот мы стали запускать вальта ционный build такой по мастеру каждый час я буду его потом называть часто за скинули на убил downfall request и собирать статистику из-за каких команд стали заводить инцидент на каждое падение такого вида ционного долго собирать статистику из-за кого в каком проценте случаев падает во льду ционный бил такой запущенный по мастер выставлять командам какие-то таргет и цели по достижению стабильности такого авиационного билда системно работать с каждой такой ошибкой там искать что что сделать чтобы следующий раз такое не воспроизвел ось и вот за несколько лет с тех пор когда мы впервые там начали запускать такой вальдо ционный бьют в 2018 году это было у нас я про процент прохождение было около 57 процентов у нас было таких успешных заки дурных долгов pull request of по мастеру что конечно очень печально это почти 50 на 50 вот и там к настоящему моменту он достиг порядка восьмидесяти двух процентов успеха что уже конечно можно сказать хороший результат однако проблема у разработчика они все равно остались разработчик как у него если упал вальдо ционный build не из-за его проблем в пури question как не знал что с этим делать так и не знает хотя падать он стал конечно реже поэтому нужно как-то уведомить разработчик которым что проблемой кто-то занимается статус решение этой проблемы как-то обозначить разработчику и по возможности ускорить перезапуск валит основного долга для того чтобы все это осуществить у нас появился робот top мы его назвали хранителем pull request a что он делает во-первых top отслеживает глобальные проблемы например и если несколько на нескольких пури квестах разработчиков воспроизводится одна и та же проблема боли до тонны build падает по одной и той же причине при этом нет никаких успешных билдов в этом промежутке времени the top понимает что скорее всего там уже вообще ничего не работает всё сломалось надо срочно эта чинить заводит на этой инцидент ставят пол request на паузу build валидации он эй билл туре квеста на паузу сообщает об этом в каждый пол request разработчика пишет об этом вот как представлена на слайде прикладывают ленку на инцидент разработчик приходят свой пыл request давай данный билд не работает но разработчик может кликнуть ссылку посмотреть вот кто-то этим занимается о проблеме все знают когда проблема решается top снимает традиционный бил с паузы и перезапускает билды которые упали по этой причине поэтому разработчик может быть даже уже придет свой пул request а у него там уже будет все перезапущена он и не заметил что какие-то проблемы вообще были но помимо того что бывают какие-то глобальные проблемы когда вообще ничего не работает как на прошлом слайде бывает еще и какие-то нестабильности когда скорее всего если во льду сонный build перезапустить после падения он пройдет это просто какая-то нестабильность с такими проблемами торт тоже работает ну во-первых он отслеживать что на нескольких паре квестах разработчиков падает одна и та же проблема заводит на это инцидент и потом при каждом падении эволюционного билда ищет среди всех инцидентов neatly уже заведенного инцидента на эту тему если есть инцидент он пишет об этом непосредственно в пул request разработчику то есть когда разработчик заходит и видят своем пол request упавший value ционный build ему не нужно тратить время на то чтобы решать не свои проблемы он может заниматься только своим кодом он понимать что это не проблема сразу и еще top сообщает о том что вальдо ционный бьет будет за поставлен в очередь на перезапуск мы не перезапускаем все сразу чтобы там не зовут осетин фру но однако порядка шестидесяти девяти процентов таких упавших вальта ционных билдов по причине стабильности мы успеваем перезапустите до того как это сделает разработчики то есть разработчики приходят свои пол request а то можно скорее всего все перезапущена помимо всего прочего top еще и вот его можно призвать пол request и на помощь если уж совсем непонятно что делать с проблемой при зовется специальная команда которая придет к тебе в пол request и поможет с чем-то разобраться он запускает расширенные сборки тесты также имеет еще ряд функций которые мы постоянно обновляем там разработчики нам пишут можно еще там top of a top этому научить вот этому мы обычно идем навстречу и добавляем однако помимо того чтобы находить какие-то проблемы нестабильности глобальные проблемы top еще и помогает разработчикам разбираться со своими собственными проблемами которые они внесли своими правками когда у разработчика падает вальдо ционный бил даже по причине его изменений тора сообщает ошибку пишет в пол request непосредственно и прикладывает прямую ссылку на артефакты сборки и тесты которые упали почему это важно почему я об этом говорю как я уже говорил ранее у нас был дедом 150 зависимости там куча сборок тестов и иногда разработчику может быть сложно найти вообще в чем разбираться top обо всем сообщает пишет что был разработчику было удобно разобраться с проблемой ну и такая минорная его особенность это мой запускаемых спаренные билды вместо разработчиков что такое экспо ириной dota но если валюта ционный build прошел и за 24 часа они за комп лечился он нас x появится и чтобы залить пол request необходимо перезапустить в редакционный build так ну поэтому круто когда это кто-то сделает за тебя когда ты пришел в пол request и там уже все перезапущена наш робот это делает и это особенно актуально по выходным однако помимо того чтобы находить какие-то проблемы перезапускать билды мы еще стараемся делать так чтобы билды в принципе не падали по для как можно реже у разработчиков именно поэтому у нас появился функционал флаке проблем любую проблему можно пометить например руками как как флаке если в вальдо ционом билде тест упадет по причине этой проблемы то это падение про игнорируется эволюционной бьет справа будет считаться успешным можно пометить проблему как флаги как руками так и у нас есть и флаке робот который ходит смотрит что если на нескольких пол request их разработчиков тест падает по одной и той же проблеме то скорее всего это какая-то флаке проблема ее нужно начать игнорировать она начинает игнорироваться и все билды начинают проходить так вот благодаря тому что у нас есть вот такой функционал флаке проблем около 4 процентов от всех эволюционных долгов которые проходят проходят благодаря тому что какие-то тест какие-то проблемы в них были помечены как флаке ну и скорее такая юзабилити фича для наших разработчиков чтобы им было спокойнее то в каждом пол request и у каждого разработчика есть timeline его упал request a в котором отображается какие мутационной dota у него запускались как они перри запускались руками автоматически какие глобальные проблемы были из-за чего падали сколько длилась коды review в его faure квестах все это может каждый разработчик зайти посмотреть своем upon request как я уже многое рассказывал своей презентации мы собираем различные статистике различные решения принимаем раз на примере различных статистик и так далее вот мы научились собирать статистику удовлетворенности разработчиков что оно значит мы считаем количество retrieve эволюционного в лицо ног билдов от последнего апдейта до completo пол request и кажется в идеальном кейси если мы написали хороший код нам нужно его залить в репозитории мы заливаем в репозитории там и в последний раз про обители пол request прошел валюта ционный build мы за completely по request однако если мы в последний раз проблем tele pole request вальдо ционный build упал потом мы ничего не делали сам парик у вас никаких апдейтов ничего перезапустили build он прошел и мы за completely пол request и скорее всего в первый раз во льду сонный bet упал потому что но по каким-то внешним причинам не связанным с изменениями в этом пол request и вот и таким образом мы считаем какое количество pull request of заливается без retrieve эволюционных годов с одним с двумя стремя и и так далее ретро яме и вот в данный момент с одним ретро с без ретро инволюционных билдов нас заливается в репозитории порядка 90 процентов pull request of что мы уже считаем неплохим результатам однако нам есть чему стремиться мы будем продолжать развивать свои инструменты и делать и повышать спокойствие наших разработчиков на этом у меня все всем спасибо за внимание спасибо за доклад давайте перейдём к вопросам из зала там можно микрофон как-нибудь передать спасибо за доклад такой вопрос насчет знаете когда какой-то один из тестов в часто падает и по статистике скорее всего проблема на уровне самого теста они там разработчика там есть этап когда сами разработчики подтверждаю что сильно проблемы с тестом они так скажем склон проблемой или все-таки здесь доверяется делался из сидишь чтобы она сама приняла решение о том что флаке тест ну вот именно в редакционном бил дел у нас все это помещается автоматически сразу чтобы если там эта проблема как теста и и как можно быстрее ликвидировать и эволюционные билды не падали однако на то что тест пометил новую проблема во первых там не даст помещается как флаке а проблема как я уже говорила то есть не факт что все падения этого теста начнут игнорироваться только с какой-то определенной ошибкой но тем не менее на эту ошибку заводится бага каждому разработчику там либо разработчику этого теста но скорее всего разработчику этого теста команде этой заводится бака и если команды разработчик считают что это на самом деле не флаке проблема там это ошибочно то это этот признак флаке можно снять обратно руками однако вешается он всегда автоматически а потом если рассмотрели и поняли что это не так его можно убрать и он будет как бы приводить к падениям в аду ционного туда спасибо вот давайте вот добрый день алексей за вот у меня такой вопрос для меня микро сервисе микро сервисная архитектура это или в принципе там когда кот разных модулей лежит в разных репозиториях это такая физическая преграда между зависимости модулей то есть ты сам определяешь контракт как один модуль общается с другим модулям а вот в когда вы переехали в моно репозитории как вы проверяете что у вас система продолжает быть модулей что у вас там не знаю не происходит какой-то от зависимости между модулями вы как-то это контролируете после переезда ну смотрите возможно тот стала сказать что у нас на самом деле не микро сервисы не микро сервисные архитектор нас на самом деле это все десктопное приложение нашей компании прошу я имею ввиду что просто из разных репозиториев водителя да да да да да да я просто уточнил этот момент от зависимости ну во первых у нас есть контракты между компонентами и продуктами между продуктами на это пишется тесты с помощью тестов это все контролируется ну то есть не знаю каких-то примемся ну вот когда вы типа 1 одно приложение лазить другое приложение посети например на ту там есть какой-нибудь убирают жир писи да и по другому кроме как через сеть ты не сходишь через определенный контракт в одном ману репозитории ты взял вызвал метод из другого модулей как никто это не заметил или как как это контролировать ну собственно ты можешь вызвать принципе метод из другого модулей в целом не могу сказать что нас это как-то контролируется сейчас но на самом деле без муна репозитария вы можете за вендрик библиотеку который вам не нужно и вызвать какой там лифт пеппы которые нас андре вы не хотели вызывать по сети и говорю специально если у вас разные репозитории это сделал достаточно сложно то есть это физическая преграда между физическая преграда в том чтобы сделать получить зависимость которую вы не хотели в этой мете но большинство систем управления пакетами он позволяет наступить на эти грабли с большим с большой скоростью и отдачей давайте перейдем к вопросам онлайн а если какие-то вопросы у ника тогда продолжим общение вот тут испытали то там там тоже был давайте танцевать там алина здравствуйте и спасибо за доклад меня интересует вопрос по поводу тора я так понимаю что это местная разработка лаборатории касперского которая как раз таки помогает учитывать зависимости которая существует у вас между всеми много разной зависимости в одной билде этом порядка 150 вы сказали как был написан торта есть это тоже какая-то команда разработки из лаборатории касперского написала то что он про все знает и дает советы разработчикам то что посмотри сюда у тебя здесь косяк или сюда то есть расскажите про принцип работы top of prince да я расскажу про принцип работы тора однако именно зависимости в эволюционном билде что именно запускать и тестировать сейчас по изменению там каких папок в коде это все-таки определяет не тоже другая система у нас есть сборочная сборочный конвейер сейчас асгард он сейчас это этим занимается в будущем там мы хотим чтобы это все дело только базе но сейчас это делает у нас сборочный конвейер top это робот который присоединяется уже после того как build запустился он как он дает советы разработчикам но он смотрит все облигационные беды постоянно собирают все падения если он понимает что на нескольких пол и квестах воспроизводится 1 это но по тексту имена ошибок он все это сравнивать например вальдо тронный build падает одной и той же ошибкой там сборки или тестов понимать что скорее всего она не может на различных пол request ах это происходить заводит на этой инцидент а если инцидент уже есть он просто в списке инцидентов ищет инцидент похожий ошибка если она находится именно по тексту сопоставляет он пишет об этом впал request разработчик вот смотри у нас есть инцидент в рамках которого уже решается эта проблема вот так он работает а у мне что такое предложение я не знаю мне кажется мы еще не пытались это узнать все разработчики кто уже живет в моно репозиторий видите их нас нас свыше и больше ственно так у кого есть вопрос вот привет меня такой вопрос а вот с таким общим количеством pull request of day не появляется или проблемы таких каскадных конфликтов то есть с учетом того что build идет несколько часов 2 бил запустился через пять минут после 1 этаже закончился через 2 часа и потом получается он не может вылиться потому что он как бы на другом коде и тестировался да это на самом деле вопрос вопрос не в бровь и в глаз простых такая проблема у нас реально есть и она но я реально monde нам как ее можно решить скорее всего и невозможно решить потому что уменьшая только время экспирации билда ножище и build expo ряд по 24 часа и да вот в том проценте нестабильности которые сейчас существуют когда доски дульный build падает билды разработчиков падают это вот одна из самых частых сейчас проблемы у нас когда параллельно заливаются 2 pull request a которых тестировались на разные кодовой базе они влились и все взорвалось в мастере это реально что самая большая проблема однако ну такая проблема на конечно существует наступает на сейчас оно у нас достаточно быстро решается потому что там появляется торг которые сразу все это детектив что в мастере все развалилось билды попадали стразы заводит на это инцидент все сто подговорить пауза и там менее часа требуется для того чтобы все разом разрулить и заново запустить и все будет работать что еще раз из мастера не сразу в продакшен едет нет у нас отрезаются релизные ветки из них уже release the продукта у меня возникло желание вот еще один вопрос а кто теперь хочет заехать мун репозиторий а вот нет вот все нормально есть позитивный эффект будем двигаться я видел вот вопрос чего здесь футбол спасибо большое за доклад а вопрос такой я понимаю что это приложение для windows тону linux не знаю то бишь экзешник можно ли сделать такую аналогию с микро сервисами чтобы приложение запускалась как бы изнутри нескольких компонентов которые между собой общаются там какими-то свяжем простым протоколом условном джейсоном да и тогда каждая команда разрабатывает свой микро sim micro программку и ловит все эти проблемы в гораздо меньшем масштабе то есть накосячил программист из команды а я из команды б и почему-то аффект чуть его упавшими тестами я не совсем поняла вопрос вопрос о чем можно ли разделить мы но депозитарий на много репозиторию соответственно микро сервисную такую штуку но у нас не микро сервисе точнее у вас микропрограммы условно которые вместе получается единый комплекс если мы разделим этот репозиторий на несколько у нас возникнет проблема с тем что нам но у нас будет проблема с внесением как раз таких изменений без обратной совместимости нам надо будет либо всегда сохранять обратную совместимость в своих комментах либо ну как-то одновременно выливать 2 pull request a чтобы ничего не взорвалось но будет очень сложно вносить такие изменения практически невозможно я бы сказал"
}