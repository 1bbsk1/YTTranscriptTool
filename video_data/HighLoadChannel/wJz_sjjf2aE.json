{
  "video_id": "wJz_sjjf2aE",
  "channel": "HighLoadChannel",
  "title": "Платежная система за год / Филипп Дельгядо (Информационные технологии и системы)",
  "views": 10027,
  "duration": 3322,
  "published": "2017-05-17T12:34:54-07:00",
  "text": "добрый день я разработчик различных не очень холодных на обычно сложных систем вот и последний собственно проект который мы занимался он достаточно был интересен потому что можно было сделать полноценную полную платежную систему уровня там яндекс денег или и так далее но в сжатые сроки взятой командой и в общем куча других проблем в этом докладе пытаясь рассказать это вообще что такое платежной системой какая там специфика при разработке при проектировании как вообще жить там с базами данных подобных ситуациях когда много конкурирующих транзакций сложный предметной области прочие радости жизни вот но сам проект был то есть где-то в начале прошу февраля меня сходили чтобы я начал его делать я буду первым сотрудникам который начал кто-то выяснять где-то там в середине 31 марта был первый камень 1 сотрудника разработчика но где-то к октябрю у нас уже появились на капусту появились нормальные хороший разумной постановки вот да и там из себя все придумывали ну и в октябре у нас уже прошла нормальная транзакция боевая и полностью подключился 1 контрагентах и феврале то есть был промышленный запуск основные проблемы были как раз в этом что нет команды в начале нет нахманид постановок полноценных вначале ну и при этом очень высокие требования по очень разным темам вот ну плюс секретность мы к сожалению не могли сразу громко кричать на рынке что вот мы такое делаем и контактировать нормально со всеми потенциальными клиентами потому что уже нужно будет им показать что то более менее готовая весь проект то есть там 8 программистов из них 5 бэккантри в контента и 8 не только программистов там сити а тестируя аналитики прочее прочее прочее но на самой сисадминов мы потом выгнали в отдельное помещение когда перестали влезать в одну большую комнату кто вообще делал биллинг ли платежной системы о как замечательно ну вообще когда начинаешь делать кажется очень просто там взять перекладывать с одного с одного счета на другой день ушки в общем каких проблем особых не возникает нарисовал красиво транзакции все но опаньки потом приходит юридические требования снится все гораздо гораздо тяжелее вот неполной такой краткий список федеральных законов который регулирует платеж систему российской федерации здесь нет то части федеральных законов которые устарели на все частично действует здесь нет у обычных рекомендаций которые зачастую гораздо важнее чем федеральные законы для платежной системы и нет еще много чего такого что приходится помнить и знать ну так общая ну и кроме всего прочего предпочел системах требуется интеграция с банковскими системами требуется интеграция с кучей контрагентов со всех сторон что тоже добавляет радости жизни вот и силуэта вылезают некоторые требования к архитектуре вот наше первое очевидность коды всех решений у нас команда приходится набирать 0 1 команда надо набирать быстро отбирать самых самых умных талантливых гениальных категорически никогда даже если на это есть бюджет поэтому любой новый сотрудник должен очень быстро начать писать код очень быстро забраться в предыдущем отсюда вытекает очевидность кода потом поскольку платежной системы code review обязателен потому что чтобы никто нигде ничего такого лишнего не написал либо просто не сажал чтобы code review делали все он должен быть выглядеть просто поэтому нужно думать о том как делать простой code review надежность решение просто-напросто нельзя терять денег вот никогда то есть мы можем там упасть при крайнем случае деньги могут где-нибудь временно зависнуть но всегда нужно понимать а где они лежат и когда что мы можем с ними сделать только доступность потому что бизнес который от нас зависит довольно специфически собственно мы делали платежной системы для российского букмекер ского бизнеса который начиная с этого года стал легально до этого весь любые ставки что интернет является нарушением закона как тех кто их ставить так и тех кто них принимает начиная с этого года появляется легальные первые варианты это сделать собственно для них тогда специальной поверхности тела по соответствующему закону и и мы реализуем да если что-то мы подошли уже там оля сколько ты месяцев ну и производительность по техническому заданию требовалось в пиках иметь 100 платежи в секунду что заметим заметно больше чем у киви ли у яндекс денег а некоторые варианты соответствующего tz предполагали что может быть пиков бы тысяч операций более простых чем пути же секунду но пока к счастью выяснилось что законодательство этого не требует мы пока это отложили на будущее и советовать как очевидный принцип а при разработке архитектуры ну первый самый главный вот все должно быть максимально простым если что-то сложно это подумать еще раз принципиально не доверяем решению по которым мы не понимаем как они работают то есть если я не понимаю как устроена какая-нибудь сложная мангой внутри как происходит там гарантия за хранение данных а читать код они обычно никогда почему не будем ее использовать это с одной стороны сильно ограничивает набор решений с другой стороны позволяет сделать сам систему целиком предсказуемой у нас очень мало ситуации когда вот что-то произошло а мы не понимаем в глубинах чего именно это возникает дальше это как раз пока treeview простоту и так далее если я не могу найти все методы использования конкретного коды нажав одну кнопочку выдает из-за того что используя какой-то фреймворк который очень любит reflections там настойки через xml я не буду использовать этот фреймворк поскольку к счастью и да и сейчас бывают очень крутые почти все которые нормальных языков они реально навороченное это позволяет в разы ускорить скорость и не чужого кода и в разы ускорить нахождения проблемных мест ну дальше лучше самый тестовый the compiler вот потому что мы гораздо сложнее обмануть поэтому статической типизации всюду где только можно вплоть до статической типизации на уровне интерфейсов между сервисами у нас все это сделано как нормальные честный типы с проверками ну кроме статичных собираться дает еще уже возможность куча дополнительных инспекции если у вас хорошая идея который вам показывает том числе и дыдыкин отрядах при необходимости многие другие прекрасные вещи ну и надо помнить что все всегда может упасть любой контрагент может упасть сеть может упасть либо серы может упасть база данных может пасть об этом всегда надо помнить то есть хоть у нас конечно далеко не хай-лоу то у нас нет и часов а там дай бог 510 тем не менее мы всегда должны понимать что любой из них должен упасть и мы должны спокойно работать дальше вот собственно из этого главной архитектурной решить но обычно 3 звонко 4 на сам литвинко вот в качестве основного языка java 8 я не буду рассказывать про почва технологии которые внутри если кого реально интересует просто подойдите спасите отдельно я там простых могу сказать довольно много что мы реально используем но вот spring как стандартный в каркас всем понятный популярны power джалла который обеспечивает на в том числе в puzzles как база данных почему-то java ну потому что на сомали проще всего найти вменяемых разработчиков за короткое время вот то есть всех то есть можно этим на их разработчиков на любом языке но на других дольше зачастую плюс нормальная производительность и очень большое количество для нас удачных готовых решений пост без потому что он бесплатно если бы у нас был один ограниченное число денег я бы наверно взял дебюту вот честно говорю поскольку денег у нас ограниченное найти сисадмина нади битум довольно сложно вот то есть она это будет космодемьянский в конечном итоге то в общем проще взять сразу после 1 и не париться тем более что него есть несколько очень правильно фишек по которой потому скажу и дисперсии это прекрасный вариант реализации в писе для java который гоняет между сервисами джейсон объекты стерилизуют вообще класс и в них очень прозрачно то есть у нас разработчик не думает о том как именно него происходит общение между сервисами он просто описывает как уноси реализуется или даже не описывают оси реализуется сама быстрый хорошие умеет exception-ы правильно прокидывать так и так далее как реализовать платеж собственно что потешишь давать их очень сложная вещь но реально мы должны для каждого потерял выяснить какие источники денег есть у клиента а те кто такой клиент как у него источнике денег когда он выбирает конкретный если в нем вообще какие-нибудь средства не убежали за это время покупатель и продавец там собственно букмекер может быть он решил жить не хочет ничего проводить взять эти деньги с одного места переводить в другое вот путь путь испросив собственно у пользователя разрешения отозвать нотификации всем участникам чем иногда все довольно давай сложными протоколами параллельно проверить несколько ограничений законодательных несколько ограничений по безопасности и множиться тут другое других вещей есть реально один платеж это порядка десяти от процесса в состоянии порядка десяти других систем с которым нужно взаимодействовать и самих процессов довольно много платеж может быть долгий какой-нибудь вывод денег в евросеть может или занимать примерно неделю вот поэтому никакой одной транзакции на операцию тут конечно речи быть не может надо все это разбивать на много маленьких шажков по той только быть надежной то есть все промежуточной стадии должны быть обязательно гарантированно записаны на диск чтобы если мне что-нибудь когда-нибудь упадет я точно знал где все концы как можно оттуда вылезти поделю должны быть разные то есть на самом начале 4 принципиально разных типа платежа каждый с довольно гибкой логикой внутри и дальше будет только больше вот ну особенности еще по тихо гарантии доставки если мы кому-то чего-то отправляем нотификацию сообщения мы должны доставить не смотря не на что то есть если у нас упадёт сеть упадет клеи получатель оно должно быть доставлено ничего не было бесконечным то есть любой платеж она любая стадия она конечно по времени если не удалось и за это время осуществить не считает до гарантий достала кто надо наверное что-нибудь сделать и через показать клиенту клиент в общем не должен очень очень очень долго сидеть и гадать и не понимать что происходит вот бывает все равно ситуации когда какие-то пути же зависают в странных стадиях обычно по проблемам взаимодействия с контрагентами в этом случае нужно ручная обработка потому что без ручной обработки зачастую ничего не сделать доступ к некоторым информации возможно только для живого человека для многих платежных систем с которым мы взаимодействуем ну и все можно поменять в акабе потому что реально бывают ситуации когда что то где то напутали и чтобы бухгалтере сходилось нужно аккуратненько с подписанными распоряжениями от руководства менять руками ну если не прямо в базе что плохо то каким нибудь другими способами знаете бывает ситуация когда там на тестовым еще режиме мы ничего неправильного комиссии указали ну вот чтобы все сходилось приходилось менять ручками вот основная идея понятное дело просто это стоит машина никуда особо не деваться просто есть платеж он приходит между состояниями переходы могут вызываться либо там предыдущем переходами какими-то нам мы приняли сообщение что-то сделали дальше надо еще что то сделать но это что-то другое надо сделать уже отдельно в отдельном треке по сути дела внешними событиями типа пользовательских или от контрагентов и срабатыванием таймеров и потом случился тайм-аут нам нужно все прекратите сказать что все дальше мы потешь проводить не будем ну каждого потерять понятно дело отдельные весьма богатый контекст который при этом меняется вот ну прихоти это меняет главная задача это сделать так чтоб все переходы были deep attempt и то есть они можно будет повторять сколько угодно раз для этого приходится довольно активно думать вот но есть некоторые вещи которые не гарантированы дым патентные типа например отправку эсэмэсок не всегда можно таковой сделать после за особенностей самой шлюзов ну значит крайнем случае какой нибудь пользователь получит 2 одинаковых эсэмэски но это не очень страшно вот хотя конечно стараемся этого избежать все остальное главное чтобы энди по темпам должны быть и операции пути хакк чтобы нечаянно повторив что-нибудь не списать деньги дважды но это можно сделать первый вариант реализации был написан быстренько практически на коленке потому что нужно было что-то сдавать то есть у нас по сути дела каждый переход выполняться синхронно вот разумеется в транзакции все переходы таймер они выстраиваются в очередь на пули нити который собственно обеспечивается отдохну и джалла то есть такая очередь при прям только в памяти вот после падения мы просто повторяемся последний переходом их сохраняем понятно дело в базу их список ну и заново смот по ним устанавливаем таймер и какие должны быть все это делается на стандартном дело конкуренции мы смотрели на некоторые библиотеки которые позволяют нам делать реакторные вещи но они не устают от нашим требованиям то есть там они не поддерживаются нормальные д.е. они не поддерживают нормально статическую типизацию что в общем для нас оказалось неприемлемым проще было взять написать что-то такое свое какие проблемы может работать только на одном сервере поскольку почти все в памяти долго восстанавливается после сбоя нужно использовать ручной синхронизации по некоторым специфическим вещам что всегда страшно неприятный легко ошибиться и код вообще довольно сложно модифицировать то есть там у нас не каждый сотрудник мог взять и поменять платеж а только там три человека что не всегда удачно удачно что хотелось бы хотелось бы чтобы все обработчики велено разных играх независимо на каждый платеж твой надёжный очередь переходов причем вызываемый пал вот для каждого пути к принципиально что только один переход выполняется одновременно не должно быть ситуации что там и одновременно обрабатываем тайм-аут и проводим какую-то платежную логику научили таймер с гарантии как доставки такой обработки ну каждый события опять-таки одна транзакция прекрасная идея то есть очень хотелось ее сделать но можно в канализацию делать можно этом безотказность высокая просто все менять но нужна надежная очередь задач с определенными блокировками гарантии доставки и гарантии обработки атакой очереди на рынке увы нет ну вот мы много перебирали и у всех некоторые проблемы с этим способность с гарантией обработки вменяемой вот но про то как мы эту задачу решили я расскажу чуть попозже теперь вообще про то что мы делаем с базой данных какие у нас базовой проблемы но я уже говорил что один платеж это болит к 10 отдельных транзакций приходов вот каждая транзакция это куча различных сущностей с которых самое интересное то глобальные лимита например там у нас не может быть больше чем сколько-то транзакция там какая-то сумма на каждого пользователя либо какая то сумма на какого-нибудь поставщика целиком за день или за месяц вот там при этом нельзя выходить за пределы там не карьерных счетов на очень много ограничений вот причем вот часто меняются как раз эти ограничение сразу для всех счетов для каждой транзакции то есть у нас там каждая транзакция затрагивает один счет например конкретный вот но и по т.д. нам нужно 100 пути в секунду этого реально если посчитать нам нужны тысячи iops of a самом деле ой потому что в нормальный диск эти тысячи up они пополняют никак вот и поэтому нужно что-то думать самое дешевое решение это купить создаешь q создать и часть дешевые как никогда вот и пойдем вот еще дешеветь и в общем решение которое нас устраивает 600 баксов а если у нас там будет 10 миллиардов пути же как у нас планируется но можно купить чем чуть чуть подороже вот тоже вполне разумные деньги все это к это дешевле чем пара недель работы разработчика который заставит все это работать на нормальном диски ssd вот сам и для нас грустно это всякие обновление конкурент конкурентом конкурентное обновление на мой товарищ это то есть когда мне нужно 100 раз в секунду или там 300 раз в секунду поменять состояние одного и того же счета например снять его деньги по вере в состоянии то мы упираемся не столько в диск сколько блокировки на базе данных попадает на самом деле вообще дорогая операция с блокировками особенно дорогая вот что мы делаем но стандартное решение мы заменяем апдейт концерт то есть мы не меняем счет а мы добавляем операцию изменение этого счета состоянии счета ханиф памяти если мы упали просто поднимаем список всех изменений накатываем и получаем корректно результата текущий момент ну и понятно раз сколько-то операции делают процедуру сборки чтобы нас не слишком длинный хвост образовывался это дает ускорение там в десятки раз на как раз операциях конкурентного апдейта с вами стандарты технология более тогда на позволяет даже не используется создаешь к спокойненько влезть просто в обычный диска в нормальный диск для многих операций вторая задача очень много табличек ну вот тут вот примерное описание объект платежа соблюдены до невозможности контекста платежа и это не самый большой наш объекту на самый несколько сущности порядка 10 разных сущностей haш миp а внутри списке списке hashmi пав и многие прочие радости жизни когда это начинаешь честно расписывать по табличкам получается их ну десятка три четыре наверно вот понятно что так работать невозможно нужно сразу делать какой-нибудь вам ставить вот менять структуру становится печальный печальный печальный вещью и жить так конечно не очень хочет от не самый сложный объект если что прекрасный объект конфигурации системы по которым надо еще wear санировать к тому же потому что на к в разное время должен быть разные и нужно помнить для каждого платежа с какой конфигурации тот запускался и там табличка подсохнет примерно нужны по моим подсчётам что мы делаем ну во-первых начиная все ходить просто в базе виде одного большого джейсона то есть я весь прекрасный джексон который позволяет очень красиво делать реализацию объектов java jazz джейсон работает очень быстро можно заставить работать еще быстро если вдруг нужно но я давно не не утыкался в производительность для джейсона а не понятно дело в клубе но если у нас postgres то там есть два прекрасных типа jason jason б я не буду сейчас рассказывать о разнице между ними мы используем просто джейсоном его хватает но для никто хит сценариев можно детям бы использовать это огромный приспособиться на самом деле поддержка джейсона в позе сейчас наверное лучше всех баз данных от на рынке которые есть за что им огромное спасибо вот вы кидаем на фиг вам ну а вообще надо было выкидывается в начало по что нормальные системы науками никто не делает платежной тем более потому что их шансов сделать что-нибудь не то опять таки то самой маги который надо убегать из тонкости нужны отдельные поля по которым мы ищем то есть для индексов для первичного ключа после чтобы не ходить за ними каждый раз джейсон и можно было нормально использовать всего базы данных что еще нужно делать помнить при таком хранении во-первых всегда хранить номер версии сериализации вашего объекта структуру вашего объекта точно будет меняться иногда она будет меняться необратимым способом и вам нужно будет точно понимать что вот этот вот объект вас реализован таким способом а это совершенно другим вот для этого надо в явном виде соответствие признак хранить без этого вы точно огребете огребете очень сильно вот заранее готовить код для обновления версии то есть вас должен быть код который пробегает по базе данных и все старые объекты с реализованы старым способом результ в новый это позволяет не хранить у себя в кодовой базе там 150 версий сериализации здесь реализации для разных версий ваших сущностей реально обычно в базе больше двух трех версий не живет поэтому помирить и аккуратненько потом мы вычищаем лишний код когда он уже не актуален 10 реализатор должен уметь поддерживать конфликты когда-то во что он реализует не совсем то что он ожидал вот джексон к счастью умеет это делать джексон даже умеет делать полиморфизм то есть вы можете наследника класса сохо нить он правильный в одессе реализует обратно это не поддерживается большей части и реализаторов которые я знаю в особенность реализаторов нет джейсон а в каких более эффективные способы хранения типа там 3 вт и так далее и вообще там с этим некоторые проблемы есть здесь реализации в случае конфликтов формально они version is поддерживают что google что google буфер все 3 вт но честно говоря пользоваться и категорически не удобно вот ну и нужно прописать в голове паритет например индексных полей на содержимом или наоборот на сам не принципиально так что рано или поздно вы выяснится что вас в индексных полях в табличке хранятся одни данные а внутрь удивительно почему то другие вот этот конфликт желательно всегда разрешать одним единственным способом иначе вы начал будет очень больно вот узнать на все хорошо у нас производительность высокая потому что сохранить один большой блок в десятки раз быстрее чем сделать 10 концертов либо апдейтов по куча разных табличек ну например для этого нужен только один сика не нужно много много много разных мелких сиков по разным для как де таблички свой легко делать оптимистические блокировки просто добавляем еще одна полис текущей версии и и все оптимистическую блокировку на объекте размазанным по 10 табличкам я даже не хочу представить как сделать корректно мощно вы можете легко делать истории изменений то есть тоже вы храните дня поста на каждый объект а мне одну запись а несколько всегда берете последние здесь это очень дешево легко делается товарности 2 небольшого объекта то есть там odzak все равно нужны но тут они получаются очевидными и самое главное вы можете легко защищать свои данные вы просто хранить и боб и целиком а например его как-нибудь crypt уйти либо средствами самого пожгли со либо средствами своими собственными тогда конечно вы внутри уже не сможете зайти средствами под колеса но при этом можно использовать хоть гостовский шифрования что заметим иногда оказывается важным с учетом юридических ограничений вот ну или просто закрепите так как вам хотите для подобных систем умение крипто воданы иногда оказывается самым главным вообще что вы делаете вот и проблема защиты по них все будут касаться они самые интересные какие проблемы атомарных изменений вам всегда нужно сохранять как раз весь ваш объект хотя бы поменяли там не знаю только одно поле вот иногда это очень не радует иногда это вызывает желание чего-нибудь подкрутить но с ним надо бороться честно сложность администрирования ну на самом деле не все гибель хорошо знают как работает с бабами их база данных например в некоторых базы данных на некоторых версиях бывают проблемы при репликации больших объектов в обувь но вот подписи с этим все хорошо на данный момент там на какой-нибудь дебету там например не все варианты репликации к и качественно работали для больших объектов там некоторые специфические настройки базы данных нужны хороший деби обычно все это знает не очень хороший тебе это может быть не знать и подумать что знает я искренне рекомендую каждый раз подряд по документации а так ли она на самом деле работает но и подобной схему не поддерживаться формами что хорошо моего и так выбросили но если вдруг он у вас все еще есть то вам будет грустно потому что заставить какой-нибудь стандарт норм понимать что сущность на самый живет в блоге который надо еще распаковать таким-то ключом довольно сложно бы да это выглядит очень просто там реально вот самая важная строчка последние говорит о том что у нас дата хранится в джейсоне который мы потом он остается индекса по которым мы можем быстро искать ну а вот это вот как можно использовать взрезать внутри наших данных с помощью под близ а я категорически не рекомендую так делать потому что в конечном итоге производительность таких запросов не очень велика прямо скажем потому что он реализует это все у себя поэтому чуток не пробовать луча так не пытаться но для каких-нибудь больших отчётных систем поверх вашей структуры это может оказаться полезным то есть заставить отчет людей которые пишут отчёты такого не делать мне удается все сложнее и сложнее потому что без того чтобы брать объектом напыщенного их там все веселье завывать вот и строить по нему какой-нибудь там стрим новый поиск они почему-то все пытаются делать прямо в базе вот ну какое-то время можно позволить беда в том что сама основная беда вот такого решения с на прямым прямым залезанием что если вы поменяете структуру то у вас упадут все ваши сказать запросы а структура вы хотите менять не думай ни о чем в том числе чужих запросах и один из основных плюсов использования общей работы с джейсоном в базе данных это вы меня и структура не думаете об иску или вообще на вас вообще никак не касается можно сказать что мы сделали новый ускорить по-хорошему до ночи мы проходим объекты целиком какие были по сути дела но мы активно используем join и у нас на сам немного табличек который гонится хотя в как везде внутри живет боб вот мы используем контакте и блокировки очень активный хорошо понимает что делаем мы используем все нормальные инструментов надежности которые представляют современные нормальные базы данных в первую очередь и сохранение на диск чего не дает пусть никакая новую scoin новую скорость нормальным валом ну немного но и главным и мы используем sequence и ну и самое главное мы думаем о базе данных в категориях отношения не в категории киева рио то есть я в своей голове когда думаю о базу данных сама думай про реляционной алгебры вот собственно главное что отличает полно узко или тоску или как вы придумаете так а теперь собственно то что обещал как мы решали проблему с надежной очереди с гарантии доставки обработки вот или о том как мы еще немножко попытаемся заплетать почти что на узко или велосипед используя postgres напомню что мы хотели мы хотели много обработчиков на разных серверах которые друг другу не мешают работать с общей очереди и при этом на каждый платеж то есть на каждый сущность у нас может быть много событий в эти очереди и мы должны обрабатывать последовательно для данного конкретного события для кого как этого платежа вот ну и все это должно быть очень хорошо эта музыка циона то есть вся обработка должна помещаться в одну транзакцию да кто значит aquasky пункт так вот где он в табличке табличка кью собственно маленькая в ней хранятся собственно но по сути дела наши платежи то есть очереди из которых мы последовательно выбираем и собственно табличка событие как для события кладется в какую-то очередь и никто жить какой-то порядковый номер дальше магия вот этот безумно сложный запрос обеспечивает надежное очередь гарантии доставки и обработки и прочим радостями жизни то есть ключевые места там выделены красным что такое селектор апдейт вообще кто знает замечательно так ну то есть что делать данный запрос он выбирает там очередь и самый первый в этой очереди события вот собственно выбирает и сразу накладывает на это место блокировку на собственно селектор апдейт именно это и делает когда мы запускаем его второй раз вот делают то же самое пропуская заблокированы и ранние записи те на которых сейчас есть блокировка вот этот запрос как раз выберет следующую очередь потому что альфа закрыт он выберет собственно бету и первый платеж в это самый бойцы тоже на них налоги блокировку вот в чем поскольку это блокировки это все происходит в памяти на самом деле реализованы в воздухе весьма и весьма эффективно поэтому работает это быстро реально вот на какой-нибудь угольникова ноутбуки у меня где-то 1000 там за чтений в секунду на нормальную разработчика машинки там порядка пяти тысяч и это вот все на виндах на стандартных настройках вообще без попытки чего хотите оптимизировать то есть реально нам взяв космодемьянского могу то бы 15 тыс получить на продакшен сервере вот но в общем не пока не нужно потому что если у меня там стол по тиви в секунду в 5000 это за глаза и за уши хватит что тут прекрасного да ну добавление события то есть новость вообще ничего не блокирует мы добыть и события независимы добавляем ни о чем не парис вот часа обработчиков на производительность не рабы не влияет то есть я играл с четырьмя обработчиками по числу ядах с двумя тысячами обработчиков чтобы уж точно было с запасом и реально она только съедает память на количество трендов но в общем 2000 священном ально работает опять таки на весьма сомнительным ноутбуки там на боевой машине там их можно бесконечное количество корректно работает во всех уровнях изоляции кто такой значит такой руни изоляции в базе данных ну вот да ну в общем те кто не знают почитайте вот полезный стиль если вы работать с базами данных что прекрасно потому что там лепетала говорит на сериала я бы может меняться любой момент вот это таком подходе еще на пофиг вот да надо удалять обработанные событий в той же транзакции я экспериментировал кажется что вместо удаления ивента прямой строчкой учусь делать там какой-то флажочек который удаляет сделать объект места делить на в данном случае она сохранится становится медленнее на выборках поэтому я советую делать просто deli ты не париться вот но вот вы обработали в той же транзакции там почитали сделали всю нужную вещь и в тоже транзакций удалили лишнее всем понятно почему она здесь гарантии обработки гарантия доставки кому непонятно а кому понятно как то вот этим но что перепад как ты плохо пересекает разница между ним и слишком большая у нас начинается транзакций в ней мы выбираем новое событие в ней мы проводим все операции с этим событием связаны и в конце удаляем это событие за очень если наша транзакция тем больным варианта прервалась то у нас это событие опять оказывается в очереди без блокировки и следующий же вафлях который пойдет за событием его опять заберет на исполнение поскольку событие у нас напоминают импотенция мы получим что мы можем эту масштабировать как угодно раз может любой обработчик падать сколько им угодно раз платеж правильно корректно пройдет причем ситуации что мы там начали делать что-то одно с пути желтом это за обработчик упал а мы уже начали делать что другой тоже невозможен что мы берем последовательно все события для одного платежа для одной очереди доставлю очень рекомендую из вас не какой-нибудь категорически high road to вас такая задача такое решение спасет ну там и создать хукаешь надо поставить над копейки вот до для события можно честно указать дату с которой это событие становится актуальным и другие таймера вам уже не нужны то есть вот все вам нормали честно таймер который отработает если он будет нужен да ты с ним будет не нужен то беремся дальше все будет прекрасно вот и в запросе нужно обязательно указывать время жизни транзакции это позволяет почти все драйверы работы с базы данных чтобы у вас автоматически там не знаю через 10 секунд случился хайбэк чтобы если ваша ним день за весла вас не сидел бесконечно пользователи ждал когда же наконец завершится как это зависит can за акция а она начал просто обрабатываться другим легким для особых затруднений так теперь несколько про вообще а база данных всем вот ну на подробности потом уже не обсуждаться как и вообще удачной практике про тестирования ну понятно что бесконечность это графин вообще ведь нельзя у нас в основном центр в тексте приходится на функциональные тесты в тестировании сильно их ускоряют наличие дампа базы данных которые постоянно подставляем чтобы не наполнять данными каждый раз с нуля для каждого теста мы там наполнили прогнали пачку выкинули все что наполнились опять восстановились до базового дампа погнали следующую пачку интеграционные тесты в основном используется для отладки и разработки но при этом все равно мы их подожжем запускать разумеется нести при тестировании потому что с ними поспокойнее и вообще они как то так и они отрабатывают и побыстрее какие-то вещи проверяя прямо там июне теста делаются в крайнем случае в сложных изолированных от всего остального окружения местах то есть том числе от базы данных и никаких мог of потому что с маками обычно мы тестируете насколько вы можете сделать мог для базы данных без базы данных ну назвали плохо вы это можете сделать почти всегда особенность вас транзакции и конкуренция поэтому мойки мы стараемся не использовать кроме редких опять-таки случаев когда там как левая платежная система которому даже интегрироваться а при этом она даже не дала свой тестовый доступ ну там делать нечего приходится ее мог ведь и так часто бывают подобные системы которые предлагают с ними интегрироваться только на продакшене это сплошь и рядом типа ну вы с реальными деньгами поиграть там чуть получится может быть вот все тесты должны запускаться на рабочей машине программистом то есть можно он мог собрать всю систему погадать пони все тесты и только после этого например закомитить что-нибудь мы это активно используем активно делаем но ибо зал решение тест лида мы в подаче ничего не выпускаем то есть отлит явно говорит вот этот вели вот эту версию вот это вот конкретно фича можно запускать оно готово ну тогда собственное попадает в продакшен вот не раньше как мы делаем безопасно обновление структурный продакшене понятно что нам останавливать ничего нельзя и мы всегда должны уметь откатиться каждую выкладку обратно то есть мы выложились выяснил что эти проблемы мы должны взять вам он сам предыдущей версии так что ничего не умирала поэтому изменение структуры почти всегда распадается на четыре шага то есть сначала мы кладем версию которая читает старая данных старом формате пишет и вставим и в новом потом выкладывать следует потом пора ли ну когда она выуживать работает мы выкладываем сервис который аккуратненько заменяет все старые данные в новый формат потом третий шаг мы читаем новый пишем новые на старые все еще живет ну и дальше четвертый шаг уже когда-нибудь сильно позже мы удаляем весь старый хлам вот это конечно несколько усложняет разработку но зато позволяет спокойно менять структуры базы данных структура объектов и не переживать что мы нечайно чин сломаем и не сможем потом откатиться и восстановить данные вот но вот от 4 шаговая штука приходится конечно очень долго учить всех но когда все научились начинают это делать становится жить гораздо легче проще и разумеется все эти шаги тестируются то есть мена версией нападок на тестироваться на либо данте продакшена либо на чем-то очень похоже на там продакшена вот так как все это организовать чтобы ну во-первых замечательный человек a list of combat который врёт о том что каждому проекту свои методология вот и даже не командир к проекту и надо его любит читать уважайте намотать ничего лучше все отдела методологии никто никогда не написал хотя он в общем кладем туда воде почти ничего не писал вот когда мы как вы начинали начинается поэт абсолютно вакууме постановок нормальных нет задачи почти все исследовательские то есть никто не может сказать когда оно закончится почти никто никогда такого раньше не делал продукт могут попросить показать вообще в любое время потому что пришел потенциальный там контрагенты надо с ним что то сделать или там не знаю пришел инвестор над ему что-то показать ну если цска задач при этом много понятно что классические какие-то дела методологии тут работает плохо реально мы сделали почти канбан на стадии по что основная задача на этой стадии это минимизирует чтобы чикаго не слишком много параллельных задач вот больше трех как-то уже не хорошо вот при этом на самом деле вот на этом этапе даже tracker особо не нужен по что средний размер задачи ведь человек недели при команде в пять человек в общем там и trucker них редко нужен там все нормально работает так потом мы доделав систему показав начинаем ее активненько внедрять тут очень много неожиданных требований потому что разумеется все контрагенты и заказчики по все начинают думать только когда видят все это дело на боевых вот тут надо каждый день обновлять продукт а то и несколько раз команда назовите маленькой у нас нет там 10 devops of выстроенной системы там непрерывны его запуска потому что просто но это нельзя успеть за маленькие деньги объемы знать вообще непредсказуемых можете свалится задача которой делается 10 минут а может быть за три дня ноги надо сделать все равно вчера у нас получился отдадим низком то есть ко мне один спринт один день то есть мы с утра собираемся планируем делаем вечером выкладываем наши вижу там собираемся планируем выкладываем backlog при этом тоже на три дня вперед не больше вот то есть это конечно совершенно низком надо понимать но ближе всего к нему тут без трекера уже не обойтись вот тут не обойтись да и как деньги при этом еще и делаем разумеется посмотрим да вот честно скромно за один день очень быстро посмотрим правда не всей команды зачастую отелит ребята досидели до 12 часов ночи вот ну потому что это выкладка в такого женщины жили примерно месяц чуть меньше но потому что за то за это время мы запустились на продакшен не потеряв ни одного пути к не потеряв в целостности базы данных не потеряв целостности бухгалтерии что ещё интереснее и сложнее и при этом как бы заказчики инвесторы оказались понесет довольны процессом дальше идет развитие развитие она вполне понятны то есть там можно делать нормальные уже планирование по две недели закрытым списком fitch объемы задача становится уже более менее предсказуем и выкладки регулярные хотя конечно 1 2 недели на нормальные системы выкладываться это как-то совсем медленно выкладываем кафе гораздо чаще вот то есть получается такой ну не скрам конечно не могу это назвать с храмом но многие из процессов скому мы активно используем то есть для внешнего наблюдателя который не понимать что происходит она выглядит как сказал вот но при этом правда выкладки каждые два дня ну а так все очень похоже какие основные практики есть при работе 3 главные то зачем на каждой фичи который нам приходит сверху мы спасет зачем она нужна в 90 процентов случаев во время заданный вопрос зачем позволяет объем разработки уменьшить на порядок то есть вам просит одно выясняется что это нужно совсем для другого и вместо того чтобы делать громоздить огромной огромной компонент скую сжечь и функциональности достаточно просто в одном вреде добавить одно поле на вывод и все вот поэтому зачем является главный наверное вот вообще практика работы с требованиями берегам свой труд очень часто будут менеджер плохо прикидывает стоимость работы чего одного программиста и вам могут прийти задачу с трудом человека неделю который экономит наверно там два часа бэк-офиса в неделю же прикидываем стоимость человека в бэк-офисе прикидываем стоимость туда разработчика и понимаем что за три года она не окупится совсем ну дальше это можно объяснить продакт-менеджер и не делать иногда обычно этот вполне себе эффективен потому что он дешевый мысли он дешевле чем тут программиста понятно что это работает для задач бэк-офиса клиентское время мы конечно экономию но время оператор call-центра стоит меньше чем время программиста опять-таки когда вас огромная команда и там в колл-центре 100 человек она конечно такой же не работает там уже и вас ресурса обычно какие то есть на эти задачи и 1 секунды умноженный на стол нужны на как день дает реальные какие-то существенные объемы но у нас пока все гораздо меньше вот до трех не обобщать если у вас пришла какая-то задача сразу решать ее в общем виде категорически вредно а сам не нужно иметь три частных решений чтобы сделать общее иначе вы будете постоянно делать не то что на самом деле переделывать общие решения вот последнее время для некоторых случаев я уже до 5 не обобщаю потому что и 5 точек не позволяют нарисовать какую-нибудь кривую там получается конце дня все таки заказчики клиенты контрагенты настолько разнообразна и что я не могу себе это представить даже с учетом такого не маленького опыта платежной системой dell вы уже не первый раз и не первый год вот слона есть по частям большие задачи которые туда емкость четыре человека месяца не надо брать целиком в разработку и надо бить на разумные кусочки ну радостные отделаны по которой много часто забывают любой задачи можно разбить на маленькие полезные кусочки ну и шашечки или ехать очень часто можно сделать быстро но не очень удобно для того же бэк-офис и может быть даже до клиента на вы уж это сегодня нежели сделать все красиво и идеально но через месяц может быть если у нас будут ресурсы ну вот всегда учу ехать нежели шашечки вот проблема с людьми никто не понимаю что такое транзакция вот кто почитаешь такая транзакция кто из вас знает при этом такой уровня изоляции не вот кто знает транзакции давайте книга что кроме задать опускайте руки кто из вас точно знает какие операции с диском происходят при ваши транзакции на вашей базе данных вот этот называется значит такой транзакция то есть читайте ну хотя бы базовые книжки потому что на самом деле там 1 100 страниц господи кейт оправа кого не применимы почти к любой базе данных вот их стоит почитать тащили все 2 том что не надо вот первый со страниц полезно почитать как устроена архитектура по сгрыз или мая вскоре тоже крайне полезно что без этого будете регулярно постоянно утыкаться в странные грабли не понимать что иногда там если ваш диск не создает а ему надо вообще говоря позиционироваться asic это дорого и не надо путать six фронт потом мы многие другие вещи люди любят сложный код я не понимаю почему люди любят написать сложные сложную сложную систему не важно на каком языке они это делают вот на добавить завахири говорит что простые вещи должна требовать простых решений почти всегда их легко найти все любят магии особенно чужую то есть только приходится постоянно бить по рукам и не давать использовать вот это вот чужую библиотечку где-то на данном найдено на гитхабе который все делает сама авто магическим способом вот я бы ты пойми как она это делает ужаснейшие кинь ее начисто и сделаю опять какое простое решение качественного кода который делает сложные вещи автоматически почти не бывает почти всегда они делают их просто плохо просто постые вещи всегда реализуется простыми способами но и доверие обещаниями брендов но нам рассказали что там эта база данных она надежно и все будет хорошо ну мало ли что он сказали почти всегда опять таки вот те кто думаю что mongo db надежная база данных мне надо вам делать платежной системы пожалуйста ну и верни делаете доделайте диана вы делаете делайте потерять система вот да какие задачи у нас так и не решены самое интересное как защитить данные вашей базе данных от системного администратора так чтобы при этом желательно можно было делать выкладку хотя бы быстро понятно чтобы вот то не мог поставить снифер ли не могу с ней фиром найти какие-то важные для вас существенную информацию чтобы не мог посмотреть ключик доступа к базе данных при выкладке вашего процесс собственно процессинга и многие другие подобные вещи я не знаю как решать эту задачу балета пока не знаю никого кто знает как решать эту задачу не безумно дорогими средствами есть довольно хитрые железные решения но они стоят там порядка 1000 баксов на сервер вот и работает тоже плохо нет тут беда в том что нет это решение административно еще не есть хочется но иногда на 3 приход писи формальные требования и dss а формальные да вот я вот то что них написано в бумажки нет а почему они сертифицирует а что они хотят предполагают что никто не может почитать к данные кредитной карточки понятно что в реале в реальности всем неизвестные решения это не соблюдают вот обеспечит какой-то допустим уровень защиты но при этом прикопаться могут а у нас такой рынок так там прикапывается будут вот к сожалению как не терять транзакции при падении дата-центра за разумные деньги то есть у нас понятно один дата центре у нас второй резервный дата-центр первый упал при этом у нас понятно дело репликации что-то не докатилось или и докатиться может довольно много поскольку канала между центрами та же вещь такая довольно странный не всегда идеальная как сделать это опять таки идеально я не знаю то есть у нас есть хитрая мысль пасовать параллельно все те к самой транзакции кафка потом смотрю что не добежала и поскольку все задачи и патентные догонять но мне они не нравятся вот вся магия типа вот у нас там такое то новое решение умеет к надежно работать на разных дата-центрах но вы внимательно посмотрите как она работает или работает медленно либо ненадежно сожалению тут сложно придумать этот пункт и ничего не говорить буду вот это боль но кстати тогда получается вот доклад на конференции помогают такие у нас были основные ошибки очень активно использование спринга который прекрасен гениален но магии в нем столько что иногда очень страшный главное он не всегда идеально поддерживает даже прекрасно не дает иногда нужно знать код чтобы найти ошибку то есть не тут нужное место и понятий по а как у нас происходит определение контекста секретик юного в данной точке а пойти читать конфиге из них вы снять собственно что происходит это не очень приятная особенность для это надо знать где читать вот если это сначала хочу прочитать документацию страшно данного разработчика читать все документации по всем технологиям вот так получилось что тесты у нас функциональный пишите на питоне я ничего не имею против питона но править теста java разработчика на питоне и наоборот довольно тяжело кстати получается довольно узкое место что сложные тесты приходится править собственно 2 тестеру и приходе поэтому иногда можем просто упираться в скорость его работы ну и найти на самом деле вменяемого пита низкого авто авто тест автомате zatarra довольно сложно вот докер нам погнали свои с автономных задач докер не подходят по что у нас очень много хитростей сетевым стеком вот и очень много работы с дисками таких немножко не про это инструмента который хорошо на не идеальная you track все-таки для сложных процессов не очень удобен там не хватает некоторых интересных вещей по автоматизации отображения вот gibt дает гораздо больше геморроя чем какой-нибудь чем чем многие другие распределенной системы но колдун самый популярный ну мэйвен очень и использоваться прийти сразу награду как мы в конечном итоге сделали все просто очень простой как как по каким техниками ты добиваешься того что у тебя операция товар но это примерно то есть какие головой и я понимаю то есть ты там как бы а тут и биржа дичь никита бы проще всего но айдишники какие-то беру сиену там где можно взять секунд беру sequence почти как ни странно вполне меня устраивает иногда берется псевдо случайное число от sequins особенно если мисси господа пятном не то что надо наружу наружу секунды передавать как вы знаете нехорошо ну как не люди мог понять сколько вас было операции это уже неправильно есть очень простая схема которая делает псевдослучайной длинные число на основании sequins а по которому обратную операцию сделать в общем то нельзя вот мы это активно используем плюс чё там security рандом активно используем длинный потому что там коллизия с вероятности один в триллион меня в общем среднем устраивает а там я ее боюсь я делаю честную проверку по базе данных хотя это конечно геморрой вот ну то есть вот такие стандартные там основная проблема не внутри система взаимодействие другими контрагентами которые не все позволяют пропихнуть свой уникальный ключ для операции поэтому иногда для конкретного платежа до конкретного шлюза с платежной системой другой приходится придумывать как ее разбить найди патентные кусочки вот она всегда удается пока ну и вроде бы если не удается то очень обычно удается придумать чтобы это было почти до патент на и может быть иногда ручка учить надо был в редких случаях почистить вообще насовали особых проблем разбитые допотопные куски нету надо просто об этом помнить и спасибо за доклад вас очень интересное решение с подписями очередями смотрели ли вы уже реализованы и аналоги допустим отпуск из киоска туз пока я смотрел на подрастет статус но там магия на магии магии погоняет я вот там нужно будет удалять tom brady диван то не смотрите вот тут для вся очередь реализовано в 6 строчках зачем мне любое решение чем она полностью устраивает по всем критериям чтобы понять работает ли в моем случае магия с подготовкой то на старые решение то есть вот ски польский борт появился в подписи в январе да она сделана года два или три назад использовать внутреннее понимание хитро блокировок пожгли со чтобы разобраться как она работает у меня уйдет на неделе три это решение со всеми тестами я написал за одну ночь вы вот он расширяемость когда у вас потом бы гораздо больше транзакций но она все равно не заработает она она упрется в dice когда будет много задач но никуда от этого не деться она мы прям сего опуса это решение упирается в лоб sopa что больше там не происходит ничего то есть она вот три вся вся проблема в скорости апдейта колени . мне надо будет отдать эти утолять нет не может не быть вас необходимости удалять либо оба эти чтобы ты не была явно нужно состояние очень и сохранить на диск сохранились они очень и на диск это явное vsync количество i've seen к в секунду у меня мягко говоря ограничено и никуда я от этого не удивлюсь но на чем записать вам очень сделать в финке иначе у меня не будет гарантией персис танца поэтому ну то есть можно был я смотрел на нее внимательно искал другие решения то есть я на поиск не велосипеда потратил много больше времени чем на написание велосипеда спасибо за доклад а можете уточнить насчет проблемы с докером и китом проблема с докером но на самом деле он просто для таких задач не нужен у нас реально вот вообще вся платёжная система со всей необходимой функциональностью нормально помещается на один компьютер на нем работает с нужной производительностью много серверов нам нужно только из-за требований законодательства то есть мы не можем там хранить на одном месте pcd с и персональные данные вот и все потому что на выходе что в россии мы не имеем права ничего хранить на зарубежных серверах поэтому реально нам нужно там ну и да еще нужно все дублировать поэтому реально нас ну 10 серверов распределение по 10 7 романсе бам делается легко и непонятно какой выигрышно даст докер где тестирование мне тоже проще все запустить на одной машине без докеров по что 10 докеров или 15 же мне с трудом влезает на разработчикам машины просто по памяти мы пытались сделать дочку честно пытались а то высох что количество проблем плюс у нас очень много там всевозможных развлечений фиксировались прокиды ванием go ставского туннеля точки в точку что уже не очень вообще много сетевых вещи у нас много проблем с дисками в каталоге мы пишем активно их все-таки надо писать рядышком почти их не нужно писать syslog в этом случае не очень удобен для наших целей поэтому поигрались поигрались и просто отказались ну сбитом он просто не очень удобен иногда приводит к странным решением при конфликтах при всяких рейсах и прочим реально я предпочел бы и общем может быть мы даже это сделал мы перейдем на вид baked это у нас кто там до номер перевода вот ну например этот на перфорированном денег станет жалко поэтому приемными вкурил вот если плюс у кита что идея гит поддерживает нормально всех остальных поддерживать странно и очень может оказаться что только из но реально выясняется что на и гит поддерживает странно или bass я бы вот в еде и активно бы не использовал поэтому в общем этот большой повод использовать git потихонечку отпадают но пост ранчо point of 12 идея например со свейном умудрялась глючит по страшному потому что внутри идеи jet боится используется гид поэтому она нормально работает с китом а со всем остальным как получится вот ну а прикида вот какое в итоге получилось количество таблицы в базе данных с учетом использования джейсон в сумме сейчас порядка по всем нашим база данных по что база данных мы тоже из башни законодательства должны делить 20 наверно и вот еще один вопрос я правильно понял что у вас получается избыточность то есть хранится более до джейсон и здесь же хранятся поля индексирования ну да да select для для select of отредактировать хранятся отдельно вы не пробовали от избыточность избавиться на самом деле джейсон адрес позволяет использование джейс надеяться и строить индексы по чешским полям я специально этого не делаю потому что я не хочу чтобы у меня база данных зависело на структуру данных которые приходится при конечно у аира вот поэтому я считаю что вот подобно избыточность которую я административное средством контролирует у меня всегда из превосходства одного поля но вот яндексе индексах полина содержимым джейсона важнее не важнее вот разделить решить эти проблемы как можно раньше но до этого синби может если более молодая технология постучи побаиваюсь немножко там вся эта магия по преобразование джейсона автоматически в какой-то бинарный формату miner сказать по нему индексы я боюсь вот-вот джейсон в этом случае просто на сам ли кого побольше ничего спасибо за ваш доклад было очень интересно не могли бы подсказать в условиях к вашей текущей задачи ограниченного времени уровне разработчиков какой код дизайну использовали пытались в их меры домен дриго ну прийти или там secures или обычные слои какие то ну на там нормальный 4 свинка то есть там понятно клиент там без javascript а кстати почти целиком на вот поскольку до целиком на сессии вот velocity собственно шаблонизатор которые вы делает стандартный спринга вай виси которому очень ограничено используем который все что умеет делать на самом деле это принять запрос и отдать наружу там объект который потом чтобы не завтра даст уже преобразует отдаст их тима или фонтанный слой потом слой бэг-энда который собственно логику все делают frontend свою он только преобразует данные для отображения ну собственно и содержит себе шаблоны и база данных все это поделено на сервису на сервис и делились исходя в первую очередь от не микро сервис классическом понимании сервисом нужны только чтобы например не выкладывать постоянно все если мне нужно обновить что-нибудь неважно и а processing и очень выкладывать буду пореже тем более что вот у нас далеко не сразу я могу выбрать processing там без остановок хотя бы на пять секунд 5 сюда час до некоторых задач к сожалению приходится на 5 секунд останавливают процесс платежей сейчас это приемлемо пользователь просто чуть дольше сидит ждет но понятно что чистом год уже это будет не приемлемо поэтому это делаются решение с параллельными запросами параллель то есть мне вот настала очередь нужна не для производительности не очень нужно чтобы у меня было три там одновременных процессинга я любой из них могу выключить вообще ни о чем не думай поменять версию поднять заново и остальные будут и никто ничего не заметит спасибо за доклад а можно вопрос вот да да я правильно понял что платежная система она полностью реализована автономно и представляется к любому пилингу и вот еще 2 вопроса реализовывали сверху реестров например там не разумеется вся из себя в к реестров и взаимодействия слюну и шлюзах платежным системам и интеграция с обрезкой но понятно что обрезка приходится интегрировать все таки нкао и там количества требований цб достаточно большое и их реализовать в полном объеме довольно дорого там банк-клиент какой-нибудь поднимать вот совершенно не хочется самим поэтому после травмируется существующей к счастью на повезло не есть актив им кушаешь лишена который позволяет это делать не очень очень сложно а просто сложно биллинг в каком смысле то есть мы свои проценты разумеется снимая внутри процессинга там закон за акцию вот мы проверяем все что только можно основные проблемы тут как раз ходить персональных данных с легкой идентификации пользователей вообще полный сток а вы подстраивались под интерфейсы каждой платежной системы в отдельности да спасибо за доклад"
}