{
  "video_id": "2psr2XKzeUg",
  "channel": "HighLoadChannel",
  "title": "Векторизуй это / Андрей Аксенов (Авито, Sphinx)",
  "views": 3373,
  "duration": 3356,
  "published": "2020-04-14T11:08:34-07:00",
  "text": "написано викторе зуи это все равно никто не читает abstract поэтому приходится abstract зачитывать вслух апстрак который был написан в не знаю где он был написан где-то за материал конференции должен был подготовить неё потому слушатели к тому что сейчас будут затирать какую-то дичь про эти ваши векторные операции так называемый сент как правильно работать с векторами на самом деле это рассказать за 45 невозможно поэтому можно только упомянуть примерно 170 разных ключевых слов интересно надо было посчитать 170 их или 250 вот но по ситуации внятный никакой tutorial в ограниченном нашем времени сделать не удастся поэтому попытаюсь просто пробежать по верхам потыкать пальцем в разное что знаю чего не знаю и буду надеяться что хотя бы один самый важный пункт из этого запомнится и во-первых и я как бы надеюсь что немного сниму так сказать страх перед решением о девственности в плане сент инструкции но подозреваю что будет ровно наоборот люди такие качающиеся выйдут с этой презентации матерь божья никогда в этот мир векторных оптимизацией не пойду специально обученных людей найму и вы знаете где их нанимать ok какое отношение это имеет к холоду ну наверно понятно это тот самый процент кода нет это даже не процент вот это наверно этот тот самый 1 10 одна сотая процента кода которая иногда как которую иногда имеет смысл переписать обычного человеческого кода скалярного на код векторный и становится внезапно и очень хорошо ну то есть ускорение бог бывает подчеркиваю не обязана быть но бывает такое что вот переписывание кровь но количество кода дает термоядерный эффект на всю программу ну ладно хватит для тех кто страдает что он как бы на питоне пишет исключительно в тензор плаву париться и как бы его все это не касается в принципе нет касается несмотря на то что основная масса библиотек все равно у нас будет как бы вам данного ощущения хорошо за оптимизируем и так далее некоторые расчеты скорее всего у вас будут не готовы возможно какие-то штуки все-таки будет более осмысленно если угодно более эффективно посчитать самим написать небольшой как какой-то кусок кода на этой богомерзкие шишечки воткнуть его ваш скриптовый язык либо спаси господи не совсем скриптовый язык типа роста или кошечки там мы возможно даже не нативные беники для оси есть есть спец модули которые позволяют как бы нативно векторный подписать вот и даже на мобильных приложениях которых понятное дело сейчас больше чем веба ха ха своя атмосфера но и там негодяи приносит какие-то векторные инструкции я правда буду петь про сервер и там вот про серверное одно про мобильные приложения и про армор я уверен ровно в одном то есть ни черта про него не знаю но уверен что в принципе все те же самые задачи решаются концепции общее те же самые мире больше кидай дальше и читай вот такой вот талмуд с набором инструкций все один benchmark который я делал я делал на прямом устаревшим железе и неправильно операционной системе компиляторы поэтому он у вас не вас произведется и поэтому я всё вру если вы пили бенчмарка эти вы обязаны перебить марковь именно поэтому я все так делал то у вас не получится так вот крэш курс simp будем прокачивать в те тачки на которых мы обычно едем ради того чтобы тачки более немного побыстрее единственно что какой нюанс сразу понятно что вот так вот не получится с места в карьер что вот взял и поехал а получится всегда вот так вариантов никаких но то есть мы будем некоторое время не тормозить потом все это кончится слезами как известно не тормози и тока клик house постоянно это на футболках пишут я считаю что это выглядит вот так вот но по ситуации до векторных инструкций я там искал хотел честно говоря вставить там сэмплы из клик хауса но не то чтобы плохо искал просто тут ту одну которую нашел не вставил потом в кулуарах расскажу немного к делу в этот момент надо было бы наверное 15 минут по уму рассказывать что прикиньте посоны а можно короче не по одному элементу читать за 1 из памяти апу 48 или 32 вот я вынес на слайд 4 и на этом пожалуй закончу потому что ну наверное так понятно что суть есть точнее так понятно что суть всех приседаний в том чтобы обсчитывать не по одному значению за раз там не считать какую-то одну операцию а умножить на b + c минус 2 делить на 12 за раз и считать большое количество операций в один поток ну вот кто декодируем когда nsync синглом страшно multiple дейта инструкция 1 данных многом масса мало телок стоит и конвейерным образом в гигантское количество потоков одновременно молотят ваши данные почему именно 4 штуки просто для края здесь в примерах везде и почему я типы в основном выбирал в своих простеньких примерах про такой канонический 128-битное с с е один из соске 2 регистр если 4 тоже в которой влазит 4 флота одновременно 4 32 битных значения за раз скорее только для кратце потому что в современном мире если вы занесет 20000 долларов сша за процессор оснащенного x 512 у вас влезет пол кило битов 1 долбанный регистр и регистров там по моему сделали 32 можно посчитать сколько это довольно много актуальные для нас на сегодня ну грубо говоря два на сервере точнее виноват на армию ниндзя актуален актуальна сегодня два варианта собственной соске 2 которая есть везде потому что во первых придумал 2004 году во вторых как только у тебя 64-битный сервер а так только у тебя не 64-битный серверы на нем еще centos 5 наверняка крутятся то тебя надо на кол и радика посадить на коне накалу прям сжечь вот потому что сервер должен быть 64 бит на у меня мобилу наверное 128 бит на я скоро уже будет не дай бог вот он есть вообще везде а то есть это в этом не какой-то не стандартный набор инструкции он есть собака вообще везде а вы x расширение но такое с учетом того что они придуманы в одиннадцатом там 13 м году начали появляться наверное в девятнадцатом году уже можно считать что на сервере везде есть но доступен не знаю надо конечно же смотреть steam сервера и конечно же unity сергей потому что домашние пользователь объявляя обновляет компьютер только тот момент когда он шпилится в игры во все остальные моменты моменты времени office 2003 и так прекрасно работает разрывы вот этих дат как раз связаны с тем что там за анонсировать intel может набор инструкций в одном date потом 2 года заниматься разработками исследования потом наконец начнем проц и продавать что получается можно вот тут ненаглядный текст что можно в этой вашей регистр воткнуть 16 байт всё 32 байта в с с е2 которой есть вообще везде вообще везде вообще везде vvx который есть ну наверно почти везде на сервере считаю почти везде слава богу ту серверов без секса не видел не видел давно может хорошо живу конечно надо виртуалку на хет snare купить за евро но там наверно тоже будет вот немного ненаглядная попытался сделать наглядно в этот момент у меня сломался сканер сегодня конечно же ночкой ровно в три утра в 3 утра мне сканер никто не починил получилось вот так так мычит обычная корова так устроен обычный 64 битный процессор с точки зрения компании in the вот у него есть как нетрудно видеть там видно хоть что-нибудь интересно то мне честно говоря на телекине видно я от неё не далеко 16 регистров по восемь байт в каждом кроме того два из них занято их просто так не попользуюсь потому что процессор xampp ацтек утилизирует и а регистров общего назначения есть вот ну который прям можно смело лизать 14 штук по восемь байт далее ситуация резко улучшается за исключением сломанного сканера и вот регистров совы xss е становится резко больше левой части the waves расширение регистры стали h200 56 и битами правая часть до левой и правой постоянно путаю куда повернуть правая часть этой сосне расширение пытливый пользователи конечно точнее пытливый программе заметят ошибку в этом как бы тех доходе и понятное дело что во-первых пробелы пропущено во вторых d8 это по два байта на одну русскую букву но мы ответим и решительно и гневно пацаны это кори 8 до значит половина крутизна от векторных операций заключается ровно вот в этом регистров становится не было регистров не становится больше это 16 дополнять их регистров они толстые обратите внимание каждая клеточка байтик каждая выпивка доллар каждый этот долбанный байтик можно одной инструкции точно отставить этот бантик можно обрабатывать одной инструкции мы инструкция подействует там на все 32 байта за 1 или на все восемь флотов of случае вы икса за 1 или или или и это половина крутизны сарай обыкновенном прорезаны заключается вот в этом аду это так я конечно же скопипастил с дизассемблер а строчки в латаем флота равно p на c буквально вот не шучу поскольку он я единственный видимо человек который пользуется visual studio то в нем порядок аргументов перепутан первое это destination второе это source но в принципе я программист и к этому все равно привыкли в дизо сам не смотрят поэтому нормально должно быть что происходит вместо того чтобы генерировать какие то понятно тоже непонятные человеку но не соске шины инструкции оказывается даже замшелый компилятор сегодня генерирует оса съешь на инструкции для того чтобы тупо числа поделить как же так а вот магические цифры 1416 345 кручу-верчу обмануть хочу они как бы должны намекать почему так происходит дело в том что если просто тупой отделе а простоя тупо и деление чисел выполнять на каноническом там в unity который наверное это не точно все равно эмулируется через саския логику в кавычках эмулируется то это внезапно занимает от 14 до 16 тактов процессора опять же езд вот в такой талмуд с расстановками смотреть а если на ssj то 11 более того вот еще одна интересная циферка который мы еще вернемся по рецепт рецепт реципрокной рецепт по три этапа то-то ну в общем 1 циферка это через сколько тактов у вас будут результаты готовы начал в одно число на другое делить не торопись подожди через одиннадцать тактов будет готова однако второе деление можно запустить в полет не дожидаясь результаты первого можно запустить второе деление в полет всего через три такта в случае с е либо четыре-пять тактов случае скалярного кода ну то есть этим пользуются компиляторы это не виню ручную написанный код это то что компилятор генерирует важный вывод и счас я как бы с с е2 есть везде компилятор его в скалярном режиме используют для того чтоб об абсолютно общей скажем так абсолютно какие-то общие вычисления на него перенести из оптимизировать очень интересно есть конечно же и 3 половина против знай потому что если это половину таким должно быть минимум три не можешь в плане быть 2 и это спец инструкции вот какие именно я вам сегодня не расскажу ну что не уложусь в тайминг но упомянул что есть особо наркоманские натурально там умножение в полях галуа и какая то еще операция там аффинное преобразование кажется но это я уже за счет в принципе вчера и забыл 1 2 есть растущее из натурально дебрей там дебри mmx и 97 года какие-то безумные операции про неизвестно что с маленькими 8 8 и 16 битным винтами это видимо для того чтобы ныне богом забытый кодек divx с хорошо декодировали или например какая то операция под названием а вот нам короче дуал 32 байта давайте для каждых четырех посчитаем сумму разности модулей и 8 таких сумм посчитаем на кой черт нужна такая операция я не знаю но я уверен что если ее идентифицировать а идентифицировать тоже не так просто там вот такое вот заклинание для что для intrinsic а что для названия инструкции если ее идентифицировать и внимательно погуглить на гитхабе то мы найдем ровно три проекта в которых она будет использоваться и все это будут видео кодеки и скорее всего это будет одна и та же copy-paste одной и той же библиотечки отлетал потому что вот эти вот странные наркоманские операции всегда заточены под какую-то конкретную задачу умножения в полях боя под криптографии и кажется про котэ коррекция ошибок и вот это все есть еще какие то такие специализированные инструкции достать их много достаточно их до 100 и их ни одна группа про там расчет а из шифрования непростые например инструкции почему бы нет обычному человеку хай или там хотя бы разработчику клик house и хоть сколько-то близ где из них с и съешь на и сравнения наверное crc32 какого черта этот самый клик hu-100 и поминаю а вот я как раз там смотрел где-то такое смотрю там слова из и съев презентации ну думаю ништяк сейчас вот так вот просто как вставлю себе и работать не надо и всех ринит залез в исходнике ищу ищу ищу ни хера не нахожу еще внимательно crc32 одну строчку переписали с какой вас вызов раньше расчета crc32 по табличке на вызов соответствующий с инструкцией всё нормально нормально в принципе в два раза быстрее стал мелочь а приятно это наркоманские специальные инструкции в котором за счет которых можно получить дичайше ускорение в особых случаях а есть инструкции и для простых людей как я тот самый с с е2 который есть везде это не только ценный мех и наркоманский инструкции это еще инструкция которая векторным образом считают довольно не хитрые штуки у может разделить сложить средние посчитать кстати о птичках ну и местами немножко такие штуки странные но например там случае 3d графики очень ходовые там посчитать квадратный корень посчитать особо быстро единицу делить на квадратный корень посчитать единицу деленную на x например единицу деленную на x между прочим у и относительно неточно считать не интересно у мисс того чтобы считать честно а делить на b всегда можно посчитать а умножить на единицу деленную на бы если у тебя определенных требований диких точности нет ни банковскими операциями занимаемся а я надеюсь мы в основном нет то вот все хорошо есть весь стандартный набор битовой операции конверсий из разного типа то 8-битные 32-битные так далее понятное дело что в 128-битный регистр можно какую угодно промежуточную степень давайте положить все есть давайте же наконец как бы это применим хоть как-нибудь и наш первый тупой пример посмотрим вот наш первый тупой пример я понимаю сейчас что как бы люди которые пишут на языке питон выходят из зала просто в шоке а потому что такие боже как не идиоматические вида на пенсии вертится в гробу вентилятором должно же быть как бы вот list comprehension и конь а никакой list comprehension боже что за замшелый человек спец функцию sum если я не ошибаюсь дернул и все в принципе хорошо вот но нет люди которые опылены знаменем си плюс плюс и они вот иногда вот и такую дрянь пишут или просто даже фишечки на си плюс плюс это такой парад невест да ну а это наш первый скучный код который императивным скалярным образом вот этим вот убогим у замшелым считает сумму чисел как but надо кому-то объяснять как вот этот ход устроен как бы надо или нет потому что пацаны немногочисленные дамы если надо вы лучше бегите за бутылкой сразу и мы вам до вечера будем это объяснять но уже к третьей бутылке пожалуй объясним а этот первый нехитрый скучный код который тупо складывает чист а с чего еще начинать то можно не хитро переписать вот подобным образом как мне трудно видеть что было три строчки и стало три строчки но два раза по три строчки мне лично кажется что в принципе не изменилась вообще ничего был идеально читаемый код который делал простую понятную ведь остался читаемый код идеально читаемый год который делал примитивную понятную вещь вот одновременно с этим возможно кому-то в зале это непонятно я понимаю что этот человек не признается кто это но специально для него одного специально для него одного мы этот пример разберем до что написано в первой строчке в первой строчке посоны написано не что-то очень страшно когда первый начальный шок проходит и сознание научается фильтровать вот эти удолбанные подчёркивания становится ясно что это всего-навсего написано шняга под названием вот у нас есть вектор из четырех компонент нулями в него по луже и все больше ничего обратите внимание если это написать рукой в псевдокоде получится немного длиннее то есть синтаксис чудовищные непривычные к нему надо привыкнуть это вот он такой нам как бы вот дан в ощущениях некоторые люди с ним борются прайд я тоже ничего не расскажу дальше цикл который считает обратите внимание по 4 обсчитывает по 4 флота за 1 ч делает он лот всего-то навсего грузит из памяти по данному нам учиться в ощущениях указателю ни один элемент не вот этот вот флот не просто вы от и оберет не то что начиная с вы от и дальше лежит коп грузит в регистр на самом деле когда вы пишете обычный кот нам без этих без и тут разврата компилятор то делать то же самое берет и все равно грузит в регистр только в одном случае вы пишете в ад или и он сам кладет в какой-то регистр это самое значение по индексу и в этом случае вот приходится явно за грузить вектор именно из четырёх элементов а это соответ или из восьми или из 2 а это уже контролируется конкретной долгим и псевдо функции которую вы вызываете это кстати не настоящая функция это так называемый intrinsic который скотина с транслируется грубо говоря в одной инструкцию процессора единственно что в отличие от ассемблером будь он проклят прикрученных инструкций компилятор вот эти интриги ки может ловко период по перекидывать попереставлять прибить к конкретным регистром и скорее всего сделать значительно лучшую работу чем мы с вами до после того как мы значение загрузили мы в аккумулятор который получается в четыре потока начинается суммировать все эти наши долбанные флот и просто берем и делаем сложение вот надо еще объяснить что такое ps ps это не процесс лист ппс пацаны это макет скала вот я не знаю почему 4 формата называется ps ну то есть почему пакет понятно это четыре значения упакованный в 1 регистр почему флот 32 называется scalar это понять невозможно это надо просто запомнить и привыкнуть последние четыре строчки соответственно тоже штук нехитрая пожалуй на них перемотаю щас вот эти вот начиная от q дело в том можно написать на visual key работает много- ценит или по меньшей мере не всегда можно написать вот к этим вот к этому мерзкому типу р обращение к отдельным компонентам на некоторых компиляторах работает но он более надежный портабельной метод после того как мы насчитали всякую шляпу записать его временную переменную бобра обратно в память вот в этот вот массив из четырех счетчиков и дальше руками в конце всё сложить то есть так что собственно происходит то вот в этом нашем первом скучном коде мы запускаем 4 счетчика вот кладем их в этот вектор р и в четыре потока вот раз вот так раз два три четыре в четыре колонны начинаем суммировать вместо одного сумматора запускаем 4 очень все как бы понятно примитивно 1 скучный кот у меня еще есть 40 минут вместе с секцией вопросы для того чтобы его об муса ливать именно этим мы будем каждый заниматься вот первый скучный код разобрали надеюсь было скучно а работает он как работает но вот как ни странно практически идеально суммируем по 4 числа за раз и получается 1 практически в 4 часа в четыре числа в четыре раза растет при этом если и талон на винтах пусть флоты теряют точность поэтому когда мы суммируем от единицы до миллиона ну как полагается программе снять единиц до миллиона а вот там от 0 до известно чего точность в любом случае получается кривая но что характерно когда мы начинаем в четыре колонны суммировать точность от чего-то растет я уверен что преподаватель по численным методам обязательно вам буквально за час объяснит почему так происходит мне лень до приятный эффект заключается в том что в данном случае точность возросла на это надеется нельзя точность может и упасть точность она такая необходимо отметить что точность то можно усилить потому что эти долбанные инструкции внутри они умеют не только выплаты и может сделать ловкий манёвр грузим одновременно пачку флотов не четыре тома 16 штук конвертируемых эти 16 флотов 16 до блафф суммируем дабл их результат держим в домах в самом конце суммируем обратно получили очень точный результат и он все равно конечно же будет отличаться от эталонного значения просто потому что там слишком много разрядов он во флот в тупо не влезет вот соответственно все приседания сделали а толку все равно нет но сделать это тем не менее можно очень интересная приседание можно ли лучше чем в 4 раза конечно же ответ наверное оказывается можно еще незначительно у сида упростить код то есть там буквально одну строчку добавить вот он по-прежнему я считаю читаем и там есть небольшая 1 опечатку возможно кто-то уже заметил вот на разворачиваем обработку этих наших долбанных лоток с 4 флотов за 1 по 4 регистр за раз соответственно аж по 16 флотов за раз загрузок лодку стало ни одна а4 сложений стала соответственно тоже там сколько ты тоже не одну а 4 ну вот как бы все усилилась четыре раза внутри одной итерации цикла мы теперь делаем в 4 конца операций но вроде бы эти операции исполняться должны примерно за такое же время и все должно быть хорошо и все равно как бы толку с этого никакого нет может быть небольшое дополнительное ускорение за счет избавления от поддержки и там мы счетчика цикла внезапно выясняется что нет но если этого скучного кота выжить и в четыре раза его развернуть после чего он конечно же вот вообще на шарик похоже так он начинает работать внезапно еще быстрее вместо четырёх концов имеем почти девятикратное ускорения что интересно точность опять чуть-чуть растет но это уже такой сайт эффекта как бы пока на которой подчеркиваю рассчитывать нельзя есть один нюанс с этим котиком которые я показала вам топ что на слайде никто не проорал и не кинул меня тухлым яйцом а зря а теперь неплохо бы сделать так чтобы этот кода работал правильно потому что я специально ошибся в смещениях и начал грузить свои флоты которых надо загрузить 16 штук по на автопилоте не с того смещение вместо цифр вместо значение номер ноль один два три четыре пять шесть и так далее я прочитал значения 0 1 2 3 1 2 3 4 3 4 5 6 и так далее сложил их сделал клёвый benchmark на миллиону элементов разницы не заметил никакой на этом бенчмарки тестируйте пацаны ну как бы разницу на этом вич марки было заметить не тяжело на каком-нибудь микро тесте который суммирует извините там действительно 16 флотов этот на он до 16 ровно или там от десяти до двадцати шести но надеюсь разница была бы знали на заметно наглядно пост понятное дело что после того как я ошибку исправил производительность в принципе не изменилось только чуть-чуть изменился результат вот в этот момент ровно к середине или даже двум третьим доклада и конечно же 1 3 слайдов должен выступать примерно трехкратное после просветления и вот третий глаз должен скрываться и я надеюсь что он откроется в основном спереди они где обычно троекратное просветление заключается в следующем мальчик просветления номер один вот эти ваши долбаные векторные операции с е2 скоро они уже с школу заканчивают им уже 15 лет они уже есть весь я на любом практически компьютеры они есть везде они довольно полезны попади плохо 9 концов я как понимаю что платы считали но 9 концов это 9 концов я бы свою зарплату удивить раз с удовольствием увеличил это раз просветления номер один просветление номер два а дедовские трюки про разворачивания циклов несколько раз в несколько раз до сих пор работают правда я вот хотел по привычке баллмера написать он roland roll n roll после этого 20 чиркнул если съешь на циклы нет смысла особого запредельно он ролики считать там я не знаю по одному килобайта вот за такой простой за раз это будет наоборот плохо почему кому интересно расскажу в этих ваших кулуарах ставьте галочки и самый важный вывод не имеющий никакого отношения к этим вашим виктором тестируйте то что вы понаписали потому что обратите внимание три строчки один небольшой простёр со смещением все мандиц и и как бы вот так вот картинка с горящим клика узам либо соответственно горящим нашим проектом другой стороны у нас проект постоянно так или иначе горит python серого до дальше вот это вот такую сумму можно двумя нехитрыми ходами доделать уже совсем по красоте и глупые и бросать на полпути эту дурацкие приседание надо его сделать первое вот эти вот последние три строчки которые мы там делала мы там дергаем а когда у нас 4 счетчика в регистре рен лежат для того чтобы получить финальный окончательный результат нам надо эти четыре счетчика в регистре просуммировать обратно есть смысл вынести эту штуку в отдельную маленькую функцию и код будет лучше читаться и дальше внезапно интересно сейчас из нее возникнет надо сделать вот это раз и вот собственно финальная версия нехитрой функция которая считает сумму энтов но делает это дико быстро должна выглядеть примерно вот так я понимаю что она как бы стала выглядеть сложнее чем две строки но во первых на мониторах у нас обычно и посложнее конструкции бывают особенно если это css селектор и вот с этим справится в принципе можно ради 9 концов перформанса ну наверное есть за что побороться что происходит происходит примерно то же самое только еще вдобавок она внезапно начинает обрабатывать блоки размером не кратное 16 байтом вот этот код в отличие от всех предыдущих приседаний может обсчитать 37 ментов виноват флотов 2 он считает блоками по 16 декабрь стро хвостик из последних пяти до считает вот в последних трех строчках перформанс на гигантском блоки от этого не изменился перформанс на маленьком размере но как бы в худшем случае будет такой там двоим-то будут такой на два флота будут суммироваться худшем случае столько же сколько суммировались скалярным кодом вот прям вот счастье наступило и идеальный нехитрый вариант сделан до слишком много времени правдами потратили ну ладно еще два момента пока готовился к презентации ну то есть гуглил все подряд слайды которые мог украсть раз 20 наверно натыкался на жупел под названием в терминах расенган их инструкций могу псм у вас в терминах intrinsic of вот так а суть такова есть ошибочное заблуждение что надо обязательно дик уравнять данные по границе 16 байт дико равнять код по границе 16 байт все дико выравнивать иначе как все взорвется это совершенно в жопу не так я провел 2 нехитрых эксперимента один взял вот этот код который сразу не не выровнены и чтение используют и подсунул ему не выровненные данные вот замедление вы сами можете видеть какой 213 делить на 205 наверное просто считать 3-4 процента то есть эффекта практически никакого нет от этого жупел а ну да узкой если вы выровняете данные подчеркивают данные вот в этот момент за счет выравнивания данных никода не переписывание кода у вас чуть-чуть может под я подъехать вверх перформанс это это код который судя по всему упирается в чтения из памяти а от того что я медленную в кавычках инструкцию лодку заменил на выровненный qnet лот ps который между прочим при попытке чтения по нечетным у адресата пан нахер падает сразу у меня перформанс на выровненных данных не изменился ни как короче равнять надо не верьте группе вам равняете как максимум данные с кодом можно не заморачиваться и на него и на выровненные данные его не затачивать но понятное дело я мог набрать этот бич парк быть сильно кривой момент тонкий смотрите внимательно до пуска что иногда может какой-то перформанс эффект случится еще два момента в этой нашей тупой сумме горизонтальная сумма это частого это частое важная операция и внезапно есть h 3 варианта ее реализовать есть специальная инструкция которую тоже 10 лет назад придумали можно векторной руками можно так как я сделал потому что это было просто любому у меня и маму человеку совершенно очевидно что чем новее вариант тем получается лучше и давайте посмотрим в какой яд превращается вот этот вариант у в лобные скалярно кажется что он должен превратиться в этом нечто такое склонен поэт регистрами на самом деле он превращается вот в такой вот дизассемблер на минутку вызывает шок но после этого становится ясно что происходит оказывается создал четыре раза наше значение копируется далее каким-то магическим образом делаются какие-то перестановки далее делаются несколько сложений вот пытливый опять же взгляд заметить что это довольно неэффективная реализация ее там действительно можно лучшим горизонтально и сложение на кой черт я на нем заостряем внимание это частая операция в момент когда вы векторным образом какой большой вектор ab считали его надо бы обратно флотов и обычный результат получить вот так вот делаете только в том случае как бы бабка говорит а только в том случае если вы обсчитывается ну натурально 2 миллиона элементов за раз и если малое количество надо как бы с оптимизировать но тут внезапно нюанс я вот когда попробовал на своем замшелым ком компьютере за бенчмарка то новое клёвое счас е3 инструкции у меня работала медленнее написав примерно тот же самый от руками вот как бы некий сниппет которой когда нет выложим получалось быстрее чем если все вот это вот делать в одну специально за точную инструкцию этот эффект будет преследовать значит желающих погрузиться в мир с с е еще не раз дизайн выглядит вот так собственно потратили полчаса на то чтобы сложить миллион чисел это совершенно потрясающее достижение я прям так и вижу как весь бизнес выстроился ко мне в очередь давай дорогой сделай нам дата-центр поставь туда 10 тысяч серверов и мы будем использовать эти сервера для чего для того чтоб числа складывать в принципе я знаю более эффективный метод и энергоэффективные как бы затраты топлива с честно меньше и конечно же с точки зрения бизнеса там дата центра дешевле и это детский труд просто 20000 малолетних детей загоняешь в ангар и складывая числа складывай числа сегодня ты hadoop индекс еще не инвертируем числа еще не сложен и конфетки не будет вот как бы на это понятное дело надо было на тракт по бизнесу во вот не на разработчики вот но энергии эффективно числа складывать вот так пример глупый откровенно но именно поэтому он вылезает на слайд но наверно можно же как-то еще вот мой может быть что то можно делать на этих долбаных эффектом и конструкциях на этом вашему соске кроме того чтоб числа складывать да конечно же на этом вашем долбаному с е можно сделать что-то еще они только числа складывать у нас есть еще какие то варианты как никакими как как какие-то штуки которые можно на них делать их много поэтому придется пробегаться по верхам в адском темпе ну как обычно не нужная классика не нужно потому что простому человеку как мне плохо значит она существует написать руками скорее всего не придется просто расчеты любую обычную арифметику можно переписать в свежем виде примерно как то самое сложение чисел но скорее всего это импортным пивом можно 3d графику но скорее всего это как бы баян реален джунгли бабой unity то есть есть всякие клёвые и инструкции и реализации для которые фотографии для годов коррекции для видео кодеков в конце концов просто для кодирования декодирования джипик и я уверен что vp и новые стандарты тоже как бы не проходят мимо и более того местами винтер in the light it up натурально смотрят на актуальные моменты и добавляют инструкции вот но понятное дело что вот это вот вообще редкий от где значительно проще взять библиотеку никогда ничего руками не писать то есть классика да умеет ложится на соске хорошо ну не только на стене в котором операции человеку на самом деле не нужна простая практика которая может человеку понадобится как ни странно я вот тут идентифицировал два больших варианта давыдович в момент в современной среде это во первых просто тупо перекладывание байт вместо того чтобы условным себе войны писать в том месте где вам надо скопировать там 8 16 32 байта зачастую выгодную натурально там протянуть руками через я регистр примеров нет хороших потому что они всегда сложные и мутные но эффект совершенно термоядерные местами от этого в тот момент когда вы там вместо копирования 1 2 3 или 7 buy через библиотечную функцию начинаете просто на туманном натуральных тупой данные через низкий регистр оболочкой булочками гонять 2 актуальный момент это внезапно наше старое доброе скалярное произведение вездесущей дот продукта он много где встречается в современной так сказать хайповой эпохи и карте ночные им бединге в не розетках и текстовые бединге вроде венера сетках и внезапно на векторных инструкциях там внутри много интересного а да можно считать менее точный год пробок чем обычной в готовый есть специальная инструкция которая считает его витиевато там учетом кручу-верчу обмануть хочу миксует несколько перемножаем их викторов делает это с адскими масками в общем если не можете погрузиться на пол штука то там довольно интересный от довольно интересные штуки с этим самым вездесущим дот продукта можно сделать а что ещё может потребоваться простому человеку сравнение строк натурально вы соске 42 добавили пару тройку инструкции для того чтобы было все строки сравнивать понятное дело что мы надеемся на системные библиотеки и они основном уже действительно обновлены иногда быстрее руками можно умудриться для хеширования применить те царство царство trees2 для хеширования в том числе старого доброго crc32 инструкций применить можно внезапно и вот это я считаю как бы ходовой задача потому что джейсон и на лопате каждый день перекладывают все мы их перекладываем на разном уровне кто-то их перекладывает из одного места база данных внутри базы данных в другое место база данных кто-то как бы как нормальный человек хоп мусорок google рпц пакетик все дела переслали джейсон моля переименовали все ништяк но тем не менее это вот ежедневная наша деятельность всякий парсинг валидация декодирования в этой деятельности постоянно поэтому вот эта вот штука ходовая в тот момент где надо дико быстро что-то декорировать во лидировать иногда числа конверте числа внезапной строчки конвертировать в int и как ни странно местами до сих пор быстрее написать рукой какой-то котик и еще и еще внезапно можно заюзать все это дело для имели интерес для того чтобы либо деревья обсчитывать градиент пустит 300 г dbt в общем короче вы поняли кроме того есть пара-тройка инструкции которая натурально изолируется как deeply орден инструкции которую сейчас сделаю дико круто на x 512 за 20000 долларов за камень я внимательно посмотрел там конечно же цифру 2 числа умножаются и третье прикладывается вот поэтому я внятно про них рассказать не смогу потому что как бы не вполне убежден но верю что для определенных задач будет хорошо можно применять для кода пожатия тоже местами пусто в три раза однако в последнее оставшуюся у нас три минуты и половину слайдов я хотел бы рассказать немного про некие общие техники из которых три мы уже знаем а еще одну нет который если вы нырнете в этот как бы от 7 до нам потребуется я их вспомнил не очень много потому что они очень много знаю три мы уже немного разобрали разберем оставшиеся 9 до для разминки за 15 секунд надо вот галочку просто поставить гештальт закрыть есть такая штука как пресечь и есть такая штука как нам tempra loadstar чуть такое есть поверье есть пресечь это спец инструкция которая асинхронно говорит пацаны они не пацаны пацаны отставить которая говорит процессору процесса короче когда то в будущем потребуется 8 байт вот оттуда в памяти они лежат очень далеко ты за ними сходить я пока почитаю я где-то 30 год наверно пытаюсь сделать бенчмарка это довольно удивительно потому что саске инструкции появились 15 лет как но у меня прям такой термоядерный письма чтоб пресечь а стала быстрее в 10 раз все эти 30 лет сделать не удается вот но иногда помогает поэтому галочку поставить надо и ещё один важный момент который тоже на три секунды есть пара-тройка инструкции и соответственно intrinsic of m&m стрим которые делают загрузку чтение в маме из памяти в память операций с памятью мимо кыша то есть в тот момент когда мы делаем как раз вот о сложении винтов например и ну iphone винтов готов даже такой ты конечно кливи складывать чем flat этот поганый на самом деле прикольно делать не м м лот ps а м м стрим что-то там что там конкретно честно говоря запомнить невозможно потому что вот такие вот заклинания не каждый раз ктулху призывают я всегда естественного репин смотрю или мне компилятор конечно же компресса нам помогает но в принципе все упомянули пресечь не нужен он темпорала от 100 операций с политиками маккихан напрочь нужны в тот момент когда вы делать большие операци ивашка существенно более важная штука под названием pipe лайнинг я упоминал что есть лайт нас есть reciprocal of руб от то есть задержка с которой у вас операция та или иная например то же самое сложение вы даст свой результат есть задержка через которую можно запускать эту операцию грубо говоря заново потому что современный процессор внутри мало того что многопоточный у него внутри одного потока еще много юнитов исполнения он вот эти вот 4 с а вон там не знаю восемь сложений может обсчитать грубо говоря за 11 тактов 1 запустит на следующем второе-третье так далее тому подобное более того даже он спаси господи как назвать супер скалярным что ли образом может запустить их совсем в параллель именно поэтому вот этот focuses on роллом и несколькими счетчиками дико люто зажигает но к несчастью у меня вот не удалось сделать так чтобы он зажег я как честный человек смотрел дизассемблер не могу ужаснулся потому что как предыдущий неверный опыт мне подсказывает что инструкция номер шесть например вот первые три нормально они запускаются по одной инструкции за раз все хорошо инструкция под номером 6 должна тормознуть потому что насчет грузит в регистр xml 0 далее следующий же инструкции после этого мы это загруженное значение из xml моль прикладываем xm вот строчка номер девять это xm1 плюс равно x м0 а xml 0 это если кто забыл сканер а те самые соски регистры а вот это вот штука должна вызвать стол сложение должно за ждать результатов чтения из памяти после этого 2 слаженно второе положение должно же надо ждать результатов первого сложение после этого 3 сложения должно ждать результатов 2 сложения и вот все вот эти вот строчки в конце начиная с номера 7 и дальше они все теоретически тормозят а практически у меня этот эффект как бы сегодня в 3 утра воспроизвести не удалось потому что я попробовал и у меня ничего не изменилось я сделал n roll там на 8-м давай на этом ну да там на 8 регистров и же насколько то скорость исполнения у меня не изменилось абсолютно я предполагаю что я возможно за счет того что это циклу уже достаточно простой уперся в скорость чтения из памяти но это неточно однако сам по себе вот этот фокус под названием и не запускаем даже не один счетчик в одном регистре опочку прям пачку аккумуляторов не по 4 плата за раз считаем а по 16 чё нам жалко что-ли и делаем это для того чтобы каждую очередную операцию с каждым конкретным аккумулятором с каждым конкретным регистром делать чуть попозже когда данные предыдущие инструкции уже до считаются он вот работает на самом деле хорошо просто у меня примера нет так я что-то нажала все пропало да я не понимаю куда нажал одну вот для это для протокола leithen цена этих инструкциях помечен как три именно поэтому через три такта процессора должны начинать появляется результат сложения так далее вот могут воспроизвести не удалось соответственно писать надо как бы еще немножко усложнить в идеале надо писать вот так вот этот вот код никакого эффекта ни черта не дал обратите внимание что опять поменялось в тупом сложение чисел я уже завел два аккумулятора и получается по 8 флотов за расу миру и делаю это вот таким вот пачками это и это почти и это наверное самый ну как бы большой вывод работаете с векторными операциями хотите гигантскими пачками за раз считать раз и каждый отдельные операции разносить 2 вот как бы грешен не смог здесь benchmark как был 95 микросекунд на этот миллион это в такой остался но в других простенках такой финт у меня эффект дает и этот эффект последний раз когда я продакшном наблюдал был где-то там 20 50 процентов там просто под простым вот такая после ondraw получается и на слайд не влезает суть такая же второй не менее важный момент современный процессор дико бешеного не любит в этой лени и поэтому в отличие от скалярного подхода когда мы начинаем постоянно ветвиться и сливками все писать в случае с векторными операциями особо дешево и особо эффективно зачастую обсчитать все варианты сразу и выкинуть на хрен не нужны на вариант это нередко выходит дешевле нам нужно грубо говоря просуммировать там все положительные числа из этого миллиона они все отрицательные вот выгодно просуммировать грубо говоря все а те которые отрицательные взять масками без ветвлений при помощи спец инструкции а их там несколько сотен натуральные почти на всей спиц инструкция при помощи спец инструкции cmp посчитать маску взять загрузить из памяти из небольшой табличке эту маску домножить на эту маску чтобы все отрицательные флот и у нас умножились на ноль и просуммировать вот так это будет выглядеть как от ядом и является но работать будет очень хорошо потому что ветвление нет иначе нам придется не иначе мы нам пришлось вытаскивать постоянно результаты сравнения еще и вдобавок из грубо говоря из якутска процессоров грубо говоря обычный кусок процессора в этом счастье нет еще один вариант тоже самое делать без масок выглядят примерно вот так там два варианта для из с е2 с е4 есть опять-таки с флотами здесь просто потому что так вот эти вот заклинания короче в чем суть был нас какой-то скалярный код который считал какое-то условие кондишен и в зависимости от этого конечно выбирала результата или б с векторными регистрами у нас будет минимум по 4 этих кондишен а в регистре минимум по 4 а и b и так далее и ветвится на каждую долбаную одну компоненту одного регистра нет нет ну никакой человеческой возможности значительно быстрее сделать вот так вместо того чтобы ветвится на каждую компоненту мы доблестно считаем ваще все вообще все варианты а потом натурально половину работы выкидываем потому что один из вариантов которой мы рассчитали нам не нужен его закроет кондишен амуре либо тем либо иным заклинанием его вот накроет и мы получается рассчитали его зря но мы заранее не знаем какой вариант мы рассчитали зазря тем не менее вот такая штука безбрачия работает очень хорошо следующий важный пункт вот это наверно 2 прим pure важные техники которые есть про остановочку инструкций разнесение i hope своей простыне и про избегании как черта лысого branch и условных переходов все остальное наверное менее важным есть часто важные опять-таки частый общий подход под названием связал shuffle кто когда-нибудь хоть видеокарточки программировала может быть помню что там практически за бесплатно можно в каждой операцией написать не просто дайте мне от вектора компоненты как богом за вещи на x y z 2 перес перри сортируем эти компоненты в любом порядке ли потом в обратном перестать либо отдай мне вектор из четырех компоненты x и либо там и вектор из четырех компонент y и это бесплатно на джипе и у них специальная логика специальные транзисторы прям для этого включены носить ее это почти бесплатно ну стоит не 0 естественно мало что стоит 0 тем не менее есть шафф на которой стоит один такт и более того во вот операция shuffle тоже крайне ходовая именно поэтому ее выношу несколько заостряют которая умеет мало того что компоненты вектор и переставить вот нас есть гигантский вектор моего переставляем она еще всякая умеет что интересно shuffle который на тентами работает сильно тупой вот у нас есть новый вектор с ним мы ничего не можем сделать кромка переставить местами компоненты а если у нас есть shuffle флотов то он может делать какую-то магию типа взять два вектора из флотов и вот так вот перепутать в них компоненты собрать при помощи какой-то маски надо еще на порядок кстати внимание обращать потому что в маске вот как бы опять таки богом нам в кавычках intel amt а есть спущена что порядок обратной в памяти она лежит по индексом 0 1 2 3 в регистре считается что то что в конце лежал это верхняя часть регистра и в маске она соответственно вот таким же образом выглядит вот соответственно shuffle который работает над флотами немного наркоманские умеет панда право вектора за раз shuffle которая работает над байтами умеет еще вдобавок подумайте подумать и не просто байты переставить а в некоторые байт и нолики записать а и внезапно вот этот вот момент что при перестановке отдельных байт мы в отдельные байты можем заставить в регистре появится нолики это штука довольно как ни странно важным вот сейчас через минус 2 минуты скажу почему пример с этими самыми шафф нами потому что уже наверно совсем не понятно о чем говорит он иностранец не нужная операция под названием у нас есть четыре винта в памяти вы в них порядок байт меняем но так наверно бывает как изредка никто правда даже уже сетевой код не пишет таким образом но можно в одну инструкцию бы тысяч за что-то типа двух тактов процессорах об в четырех винтах одновременно поменяли порядок байт вот он shuffle и вот видно порядок какой у относительно наглядно видно как раз порядок байт в маске от верхнего и нижнего они вышли просто по убыванию 15:14 и так далее здесь ведутся немного перепутал порядке можно их перепутать практически в любом порядке и там где мы напишем 128 на выходной вектор и пай появится 0 мелочь приятно почему это важно потому что с каторги там у нас сегодня как бы мир победившего opel нас данный не лежат удобным для с с е образом был новым для векторных операций образом они у нас лежат вот так есть какой-то класс в нем есть гигантский раз сыпуха полей эти поля надо собирать было бы клёво иметь спят с инструкцией которая умеет пробежаться по миллиону указателей и по каждому указателю собрать поле номеру 3 с этим самым балансом но и к несчастью этого дела нет операция gazers театр на самом деле эта штука с очень простой семантикой и бежим по одному вектору и по индексам собирает gazer бежим по какому-то вектору в кавычках указателей и по индексу собираем значение спектр соответственно то что насобирали в гигантский соски регистр он потенциально гигантский тридцать два значения если там по одному байту то что насобирали выписываем обратно в память черт знает куда вот внимание их нет то есть хорошо работающих катарские атр инструкции в природе пока нет они чуть-чуть начинают работать со skylake а но как бы ни чувствующего лет пять подождать придётся чтобы они появились собственно на этом как ни странно все основных мега техник таких глубоко теоретических вот наверное больше нет я про все рассказал не общее фокусы не общих фокусов можно придумать примерно миллион я как бы расскажу один пасе 3 который почему-то никто не знает он хорошо работает как привести нехитрые английское слово в нижний регистр праве на походите его с пробелом скаляре это выглядит вот так в обычном скалярном коде который символ не работает от выглядит вот так вектором вот так грубо говоря за один такт мы приводим в нижний регистр по 16 бать за раз очень интересно только не интересно вообще к чему этот пример был потому что такие глупости в природе немало и кроме того пример так бы символизирует переход в секцию с примерами потому что на самом деле типичный код с примерами вот не сложными примерами выглядит вот так значит я подозреваю что времени их разбирать подробно у нас уже там минус 30 минут поэтому опять таки кому интересно мы можем этим заняться но тем ни менее полки попытаюсь потыкать в каждый пример за раз точно пропускаем пробелы чё происходит в аду грузим 16 байт за раз 128 бит проверяем на несколько возможных пробельных символов переводы строк табуляции все дела считаем несколько масочек после этого нехитрой булевой операции все эти масочки сливаем вместе и считаем сколько нам байт надо пропустить в данный момент конечно и наш вот этот вот конечная строчка ппс равно индекс просто двигает указатель скалярный код выглядело бы как две строчки может быть три пока у нас следующий байт один из вот этих вот берем и двигаем указатель на единичку вперед только этот код не брань чуется на каждую долгому инструкцию и считает по 16 бать за раз за счет этого работает дико быстро даже в тех местах где на глаз работать быстро не должен то есть у тебя данные выглядят так что у них там не знает три пробела подряд этот 7 пробелов а здесь мы делаем относительно неэффективную штуку моей блин грузи им по 16 байт каждый из этих долбанных 16 байт отдельные струкции проверяем на совпадение со значением с одним из там 5 эталонных значений казалось бы дико неэффективно но нет наоборот оказывается это дико эффективно по сравнению с нормальным человеческим кодом который сделает 5 сравнений на каждый байт вот эта штука работает ощутимо быстрее такой полу практичный пример для всяких парсеров еще пробел предыдущий код выглядел страшно а вот этот код выглядит просто но на самом деле делает более интересную штуку частая операция в кодировании каких-нибудь до их пока логичных базах данных еще где-нибудь это взять поток дельт а тентов и этот поток дельт раскодировать в исходное значение вот некий внутренний цикл в хорошим годом кодеки который этим занимается выглядит на и саске инструкциях чтобы пригласишь бывает иногда и просто выглядит натурально вот так то есть в 3 инструкции делается какой-то интересный удар под названием мы читаем там от 4 до 16 значений за раз и в три строчки натурально от 4 до 16 значение дельты за раз дельт обратите внимание переменной длины который кодируется 1 1 в 1 байт 2 в три байта следующая в 2 байта и так далее тем не менее вот такими нехитрыми приседаниями буквально на в кои веки в 3s успешных строчки можно и где кодировать конечно наколка в том что это супер внутренний цикл а там вокруг еще две тысячи строк написано но тем ни менее супер внутренней среды циклон вот простой и эффективный так бывает боевой коды съешь не бывает простой я вот пытался подобрать максимально простую функцию подобрал вот такую получилось что это некая функция которая там натурально байт in a flat и перемножает нам иногда надо для векторных поисков байте на флот и перемножать и dot продукт считать вот выглядит понятное дело не в три строчки как выглядел бы в на виде наивного естественного цикла но зато работает в четыре раза быстрее мелочь а приятно вот близко погуглив в интернетов а я нагуглил репозиторий гугла и внезапно выкинув из него все комментарии выяснилось что не один я такой и вот в природе есть код от целого гугла а соответственно этот код соврать не может который например дико быстро считает некую специально заточенную под с с е хэш-функцию это же мясного кода вот это вот самого внутреннего цикла получается совсем мало но натурально пять строк ну понятное дело что если по-человечески написать они 20 для слайдов выйдет 10 строк но и так не плохо вот но не надо думать что все к несчастью просто на этом вашем дома на масса схем есть примеры и поинтереснее вот например частая операция которая наверное у многих 30 процентов всего времени работы программы жрет проверить на проверить utf-8 строчка на то что это корректная строка или соответ мне дай бог распарсить эту самую f8 строчку внезапно превращается вот в такой от это я скопипастил понятное дело из какой-то специальной библиотеки и более того из всех возможных семьи путей исполнения нашел там самую простую часть но честно говоря честно говоря если обратить внимание если в повнимательнее чуть бы смог присматриваться к этому аду станет ясно что там исходная версия которая блин utf-8 декодирует со всеми его вариантами значений она тоже не простая она тоже занимало бы примерно два слайда строчки там бы были покороче это факт поуже но строчек там какие с какими-то глупыми вариантами ровно столько же вот этот предыдущий код чуть менее чем невозможно читать потому что потому что автор к несчастью к нему комментарий написать забыл еще один важный тупой they caught не забывайте блин обильно комментировать свой сошествие со спешный код потому что вот по этим трем строчкам отдельно где-то в другом файле потом его довольно сложно де кодировать даже если ты знаешь все что декодирует с примерами наверно хватит их еще много мы не успеем уже не успели разобрать ни одного наверно да хорош а вывод по какой надо сделать из всего этого ада и набора случайных символов что как бы страшно страшно бабьего векторизация не пойду никогда и вот миллион каких-то общих техник миллион таких не общих техник страшно страшно в корне не полезем не такое писать не будем вот нет в коде как ни странно она выглядит существенно менее страшно чем на слайде но представьте себе что у вас 71 строчная функция заводится которая там ловко распаковывает байты умножает их на флот и внезапно вся программа начинает работали быстрее к вашему любимому языку наверняка этот небольшой относи можно либо прикрутить либо барабанная дробь есть нативная поддержка потому что я погуглил и после этого был вынужден похмеляться прямо на рабочем месте потому что я нашел simp джесс вот я в принципе до сих пор немного такой хожу как бы после того как нашел но он оказывается есть мутация рассказать как вот хорошо клёвый так далее писать векторный код я могу еще долго у меня сейчас выгонят поэтому просто ограничусь тем что с нимб код писать надо как ни странно это интересно когда ты пишешь какую-то мелкую штучку эзотерического видов семь строк которые внезапно работает в десять раз быстрее чем предыдущие мелкая строчка у тебя мелкая штучка в три строки работает и собственно на этом все почти уложился в тайминг за исключением того списка чего я не успел до вопросы спасть спасибо андрей но у нас к сожалению осталось времени все вопросы можете задать глазков дискуссионной зоне вам подарок за участие спасибо"
}