{
  "video_id": "YSyQb2BKW9I",
  "channel": "HighLoadChannel",
  "title": "CDN своими руками / Алексей Акулович (ВКонтакте)",
  "views": 8734,
  "duration": 2893,
  "published": "2020-04-27T12:11:47-07:00",
  "text": "ну да собственно меня зовут ли нет и и я подготовил сегодняшнему холоду доклад о том как работает силен не столько как работает он у нас это будем тоже будет но в целом как в принципе работает и дейэн вообще почему я об этом рассказываю во-первых исторически сложилось так что у нас в компании админы занимались селеном исключительно своими силами они не пускали разработку в эту область но все меняется и последнее время одной из моих задач является как раз таки помощь админом с точки зрения разработки по созданию седанов и подобных вещей второй момент как мне кажется более важный заключается в том что часто просите иен куча разной информации в интернете но она обычно либо уровня маркетингового усилены хлева покупаете у нас до либо она написана сетевикам для сетевиков и чек который является админом сетевиков может быть не все понятно что то вообще написано поэтому и постарался сделать что как-то громко постарался сделать материал который по шагам понемножку раскрывает для разработчиков как работает сидим ну и конечно немножко инсайдов и так что такое сиди инцидент я видел два понятия как он расшифровывается то либо content delivery not work либо контент дистрибьюшен network то есть некая сеть которая доставляет или предоставляет контент такой контент если мы говорим о в веб-разработке то наверное зарядки это файлы скорее всего файла а какие файлы самоочевидные варианты это наверное а статика сайта стиле картиночки java script и так далее то что составляет некое ядро нашего сайта который мы делаем то что не меняется очень часто а другой вариант это допустим обычные файлы которые загружаются владельцы сайта либо пользователей сайта это все что угодно это контент который не является ядром сайта едим на кого-то при полезная нагрузка и несколько менее очевидный вариант с контента который мы раздавать изъян это потоковые данные в случае аудио-видео стриминга hello сомали дышим это по сути тоже файлики там есть файл манифеста и файлы чанков но также мы можем через сидена раздавать tcp соединение допустим ртп streaming почему нет или даже quick который является просто или типичными пакетами потому что сидит это не просто раздача файлов это представлять не более качественного сервиса нашим пользователям и об этом я поговорю это все принципе можно раздавать весь идеям и так какой план вначале будет рассказ о том как это можно сделать без всяких этих ваших сезонов потом будет про переход в регионы и улучшение качества сервиса потом я поговорю про наполнение регионов потому что без них это нас нет ничего в регионе и в конце немножко будет о том как у нас внутри это на самом деле работает в к итак начнем с самого обычного решения у нас есть некий сервер замечательные сервера мы поставили где-нибудь это центре мой загрузили на него файл я даем его пользователям что может пойти не так в этой схеме если все это конечно же не и в принципе если мы просто сервером отдаем статические файлы то первых но закончится скорее это будет сеть у нас просто хочется сетевая карта на исходящий канал что здесь можно сделать наверное можно поставить больше сетевых карт можем их собратьев блонд купить более жирной сетевухи но так или иначе это вертикальное масштабирование которое все но мебель не бесконечна и она ограничивает нас одним нашим серым и рвота там 100 гигабит 209 сервер но возможному же процессор но не суть что можно сделать лучше тут стоит учесть такой особенность что у нас не все файлы одинаково горячи есть волей популярный контент есть более холодный контент всегда в любом сервисе поэтому если мы будем делать так что у нас все сервера будут куплены там у настроена так чтобы выдержать максимальную нагрузку от самому горячего файла а на этот сервер не придут такие файлы там и впустую растрачивать наши ресурсы зачем казалось бы другой стороны если мы положим горячий файлы на сервер где не хватило железо под его раздачу там и снова упираемся в сеть папаха проблема что это один из старых примеров анти когда вы к был более таким молодым и зеленым у нас была проблема что профиль павла durable столь популярен что тот сервер где хранилась и аватарка стоял в сети можно было сделать несколько копий каждого больше копин это было решение неправильная и в качестве такого решения мы решили разложить эту картинку как часть статике сайта там с иконкой и стилями на все наши фронты к слову эта ссылка все еще рабочие просто мои уже не используем уже научились до готовите без таких костылей но вот это реальный пример когда никакие там способы обычно решение не помогают и так даже если мы научились ставить наши сервера с кучей интерфейсов все классно замечательно мы скорее всего к нам придут люди которые чаются деньги скажут а ты в кустах денег стоит твой трафик который дает своих серверов докупил огромный кривой сетевухи там и отдаешь них трафика он стоит денег и тут мы ничего не можем сделать если мы эту схему не изменим знакомые лица а и так вот эти это проблема которые мы не можем решить данной схеме не как кроме того если мы отдаем наши какой-то контент наши файлы пользователя куда то далеко от нас то мы еще не должны забывать про то что пользователи не все сидят но кто волокне в метре от нашего дата-центра и получает контент напрямую у них очень разное качество соединения у них может быть очень плохой раунд reptile то есть время за которое пакет от сервера доходит а пользователи вращается обратно это могут быть сотни миллисекунд а то и выше кроме того есть понятие джиттер это насколько меняется раунд retype дело кого-то кошка носу как он не стабилен насколько соединения пользоваться к я плохой инскона skachat ну и конечно потеря пакетов это жизнь который приходится но как-то мириться и тут мы вообще ничего не можем сделать потому что у нас есть наша сервера где-то там какие бы они ни были классные мощные замечательные надежные какие бы количество денег мы не вкладывали подачу трафик из этих машин мы это не можем исправить этой схемой вообще никак и тут нужно понимать что если мы хотим сделать нашим пользователям хорошо мы должны быть ближе к нашим пользователям в прямом смысле физически находиться ближе к ним и так у нас есть наш сервер который стоит допустим в питере да у нас есть пользователь который живёт где-нибудь очень далеко очень далеко где угодно при этом как вы понимаете чек не подключен напрямую к этому серверу и скорее всего находит немножко более длинным путём до нашего сердца какие-то бегают и в каждой такая . пляжу что маршрута некий маршрутизатор добавляет нам во первых задержку а во-вторых возможность отказа или потеря этого пакета расстояние от сервера до пользователь измеряется в холопах это количество типа неудачных узлов либо сетевых соединений что можно сделать в этой схеме как можно уменьшить проблемы пользователя как избавить простой вариант уменьшить количество тех up of об этом еще поговорим кажется fob магия случилось на столкнуть короче в этом не став работает а другой вариант мы можем улучшить то ту часть маршрута на который можем повлиять очевидно что мы можем улучшить качество наших собственных серверов и каких-то ближайших на маршрутизаторов которые у нас есть договоренности но на остальное путь мы поверять ними не можем никак мы не можем получить весь интернет в мире все железо ву на планете чтобы хоть как-нибудь это изменить мы можем поставить наши железо которые можем контролировать максимально близко к нашим пользователям в идеале в пределах того же оператора связи которым пользуется нас пользователю тоже провайдер лака не получается что мы имеем какое-то конечное количество тихое место мы не будем их вставить в каждой каждый мелкий город село дерево там или да на каждый остров в океане мы вставим в крупные местах где есть много наших полете и которых большие проблемы мы контролируем это железо и мы можем контролировать или вы хотя бы договориться с промежуточными операторами связи о предоставлении более качественно и надежной связи от нас до этой точки их не так много это обозримое количество в принципе вполне мы можем справиться с тем чтобы гарантировать ему не творить качество этих каналов и что нам дает такая схема во-первых пользователь теперь ходит из своего устройства не в центральной на центр а он ходит в локальная точку присутствия сервиса и у него раунд reptile джиттер и к потеря пакетов снижаются поэтому на том же качестве соединения пользоваться последняя миля он получает более качественное соединение принципе для него кажется что сервис работает быстрее потому что он просто быстрее это сервиса при этом мы разгружаем свои каналы и центральные дата-центры потому что как только файл уезжает в регион мы зато регионов файл отдаем и об этом еще буду рассказывать обучая что мы больше не гоняем трафик из центрального это центров в эти регионы все файла силовых локально и мы даем ему из него при этом даже провайдеры локальные провайдеры получается то выгоду в том что они могут разместить это железо которые предоставляемый ним и вообще какой-то сервис да у себя в своей локальной сети и как только файл однократно скачался и они раздают его пользователям они восстают из своей сети они раздают не выкачиваю файл состоит вышестоящего провайдера и платья ему деньги за трафик им это больше не нужно получается что в принципе все стороны которые принимают участие в раздаче трафик и пользователям получается то выгоду и как можно вообще вот вот мы поставили две зоны допустим 1 2 зона как можно пустить пользователя в ту зону которые ему ближе на как выбрать какие варианты могут быть выбора самый наверное микаса простой очевидный вариант давайте мы прямо в коде будем отдавать пользователь ссылку на зону ну почему нет внимание следующие два слайда упоминают php и слабых духом и прошу выйти куда не будет надо как и наш основной заказа водки thp ну извините мой первый вариант что у нас есть а печник пользователя думают не проблема получить его просто пайпе шнюк используя его песчаную базу допустим макс mayn't который php прими есть вот расширение готовые по нему получаем код страны если наши точки присутствия расположены в разных странах то нам уже хватит сдать лишь код страны чтобы выбрать регион для пользователя в случае если мы имеем множество точек присутствия в пределах одной страны нам это уже не хватит куда послать пользоваться глаз есть только страна неизвестно для более точной детализации местоположения пользоваться им можно конечно взять более точную базу данных допустим по отдельным городу по почтовому год то есть пакует области в городе и легче по координатам но поэтому стоит понимать что чем более детализированную или точную базу мы используем тем выше шанс ошибки скорее если бы наша база говорит нам что живет допустим в россии пускай сил в россии вряд ли он ошибется но если мы выбираем какой то город или тем более регион этого города за шанс что мы выберем другой город соседняя область допустим или другой регион города очень высоко базы не актуальна она отстает в сам обновление она почти всегда не идеально у меня плохо слышно извините вот она он почти сюда отстаёт в развитии она имеет неполный данный и она может ошибаться допустим человек реальные примеры человек в питере оба за показы что где-то на урале человек находится в питере базовые что он хельсинки на какие-то пример которые не очень хорошо он вроде как а рядом ну вот немножко не совсем цитата мы получаем проблемы с этим и при этом что самое важное для нас что бизнес географическое даже если мы точно угадали диана ходи . плане географии это вообще не тоже самое что близости сетевая то есть как топология расположена то что человек находится рядом он может таки такими и маршрутами промежуточными в обход всего этого что диву даешься я об этом еще расскажу итак другой вариант как можно по-другому это сделать мы можем не указывать в доме не сайта какой-то конкретный регион а использовать dns для выбора этого региона мы просто даем ссылку на сайт ссылку на сайт и используем dns конфиг допустим нас есть два региона и нас в конфиге указанные два адреса кто думает что это будет работать а кто думаешь это не будет работать отлично остальные спят видимо да но ведь это что к работать не будет потому что dns он тупой ему сказали вот два адреса он дает клиентам два адреса клиентское заполучив 2 адрес какие-нибудь round robin на выберет один из адресов возьмет его нам повезет если он выберет ближайших себя печник но он может пойти по следующему из песка и чеку идет очень далеко это схему нерабочие вообще чтобы эта схема работала наш dns-сервер авторитарный должен уметь возможность выбора по айпишник у пользователя предоставлять ему тот айпи адрес той зоны которые ему ближе допустим у нас есть некая зона 10 20 32 4 сети и мы что эти пользователи это пользует из списка а.б. и теперь мы создаем зону где все пользуются из списка абэ получают а печника нашего сервера 10 20 30 40 для кого-то дефолтной зона когда мы не ограниченный какой-то конкретным регионом отсылаемых дефолтов это центр таким случае если у пользователя с соперником десять двадцать тридцать сорок два он приходит в днс dns видишь было находится в 1 city отдает ему о печник сервера в 1 city это работает так примерно будет делаю dns какие есть проблемы во первых мы все еще зависим от работы гнева песчаной базы она никуда не делась потому что у нас есть в конфиге все те же самые подсети для формирования списков пользователей и при этом вторая проблема dns а в том что когда мы публикуем изменения dns у этого записи есть некий то тель то есть время в течение которого все остальные dns сервера имеют полное право кэшировать и не перри запрашивает данные от нас это минимальное время они могут принципе делать и больше если хотят это делать редко но могут поэтому даже если мы делаем очень маленький трэвал время никто не гарантирует что после его истечении после нашего изменения конфига мгновенно все пользователи перестанут ходить по старым вопишь нику нет гарантий и кроме того если мы уменьшаем период и мы увеличим нагрузку на dns увеличиваем период мы уменьшаем нагрузка на наши dns сервера на поэтому мы увеличиваем период когда пользователь продолжают ходить на старой адреса участка либо хорошо либо либо плохо либо плохо такой вариант что можно еще сделать кто знает в чем отличие бэ бэ бэ бэ вэ гэ ну первое это просите 2 то пушка из doom вот я бы с радостью поговорил продукт давайте просить и итак смотрите интернет он такой он неоднородный он состоит из локальных авторитарных систем то есть это некие сети провайдеров и летит организаций которые каким-то образом сами у себя готовят машину зация в туре себя а интернет состоит из за связи этих отдельных авторитарных систем между собой так как мы сейчас раз как говорим о доставке пакет из одного региона в другой свели он такому глобальному доставки мы не будем рассматривать именно локальные сети оператора в каких-то провайдеров а поговорим именно о глобальной доставки к слову таких тоталитарных систем интернете в прошлом году было 60000 часа где-то 65 или 70 может быть это довольно небольшое количество нам нужно для каждого по сути пользователя выбрать через каких авторитарных системы должна править пакет как это работает каждый можете затар у знает своих соседей те знаю свои соседи и так далее то есть на мы имеем какую-то меж или какой-то сеть граф достижимости помашите зато рам из одной части в другую часть сети при этом каждый авторитарные сеть имеет свой список сетевых prix of и которые анонсирует то есть говорит соседям во мне есть какие-то префикса сети они у меня есть поэтому когда она постепенно распространяется по сети с помощью бага протокола то в принципе каждый маршрутизатор может знать где в какой автономной системе есть нужно ему подсеть а потом пробежаться по списке связи и получить путь допустим если мы хотим отправить пакет если вы автор мной сети в правую через среднюю то путь этот 3 автономных систем и почему нам не важно абсолютно неважно как пакет идет внутри системы это путь через той системы все этого хватит чтобы отправить пакет нужному пользователю и как это может нам помочь вот мы получили капитаны у bb есть несколько вариантов выбора оптимального пути об этом которые еще поговорю но наверно такой наиболее понятный простой способ это длина маршрута если полете находится какой-то точки и можете затар знает что у того а печника который нужен пользователь есть веточки присутствия и до 1 3 сети о да любой 5 сетей то он отправит пакет в той до которой то есть просто что он при этом получаем во-первых мы полностью отказываемся от дел dns бас потому что нам нет необходимости завязываться на место положения у нас есть топологии которые мы получаем сможете сатаров анонсирую щих свои префиксы при этом в отличие от dns а которые довольно таки медленно обновляется случае изменений bgp позволяет обновить топологию за десятки секунд или хотя бы в единице минут причем не скорее всего обновить а надежно обновить данные в принципе скорость реакции по изменений выше и это да это схема ближе к реальной клика реальному типа которому пакет ежи по сети это не какие-то может ложение городов или стран это реальный путь по сети итак вот мы настроили наши классные сервера в разных регионах в настройкам bgp либо dns лего даем ссылку из кода и что мы получаем секундочку подумаете наши пользователи получают ошибку почему а у нас сервера который стоит регионах они пусты и приходит запрос пользу это дай мне файл такое так что то им число нам нужно как-то наполнить наши сервера файлами так как можно наполнить самый простой вариант который мы можем сделать это проксирование контента который хочет пользователь через наш регион мы выдаем ссылку вот пользователи не на сервер в центре нашем станке центре она региональный сервер , ходит в регион видишь на файлика нету сервере идет до центральных хранилище забирает файл вкладывает себе в кэш и дает пользователю повторный запрос отдают файл уже есть кэша регионального сервера все хорошо это очень просто можно сделать на engine.exe прокси пасом прокси кэшем в принципе такой вариант делается очень просто и сложно но в этом случае у нас есть проблема в том что мы либо заворачиваем весь наш трафик через регион и тогда мы платим за каждое обращение либо мы не можем этого сделать в чем проблема потому что если мы будем каждый каждый запрос прогонять через локальный кэш там и даже в который однократно в просили в регионе все равно скачаем из центрального хранились в регион и заплатим за трафик и мы заплатили проводя заплатит быть не очень хотелось бы конечно как-то не гнать в регион тот файл он коту который нет смысла отдавать из него постоянно другой вариант такой схемы это у нас файла заранее когда мы уже по какой-то схеме я об этом скажу поняли что файл популярен в регионе и могут удава носим мы заранее мысли теперь подаем файл из региона в этой схеме так как мы асинхронно делаем у нас файл в регион то мы не можем использовать они не ксб г.п. потому что если пользователь придет в регион где-то файла еще нет по bgp то он получит ошибку мы должны указывать явно в ссылке тот регион где файл уже вынесен он там уже и доступен при этом мы получаем задержку но у нас файла связан с тем что мы не можем мгновенно отдать файлы в регионы при этом мы не можем у прокси ровать заодно скачивая файл в регион если пользователь был тем самым первым там еда качаем файл целиком и вернемся к первой проблем проксирование нам нужно делать заранее но несмотря на где проблемы мы получаем полный контроль над тем что мы можем выбрать какие файлы к прокси ровать регион когда это делать можем ограничить скорость выкачивание файла в регион не ограничивая пользователя скоростью получения этого файла уже к себе какие варианты могут быть потом как мы можем внести файл регион сам простой вариант что мы просто уносим файлы центрального хранилища с более-менее одновременно во все регионы где он нужен это плохая схема в том что мы как опять же многократно повторяем наш трафик из центрального хранилища в регионы и платим за него и загружаем наши сети которые не бесконечные более правильный вариант был бы в том что мы сначала носим файл в несколько ближайших регионов которые находятся графически близко из них дальше и так далее таким образом мы во-первых уменьшаем трафик центрального хранилища разрушая его во вторых мы уменьшаем стоимость трафика потому что он копируется не из одного региона в другой удаленный регион а всегда это небольшие локальные копирования в пределах соседних регионов рядышком находится это дешевле но это работает быстрее потому что мы можем быстрее расправлять изменения файлов некий комбинированный вариант первых двух и topperr topperr и торрент распространение файлов к сначала сервер наш источник файла раздает файл а потом когда первые региона до качали его к себе они тоже встают в раздачу файлов но когда мы только начинаем раздавать файл из региона по сути мы приходим к первому варианту когда все тянут файл из мастера мастеркопии и мы платим кучу денег за трафик а когда они до качали они также встают на раздачу получаем второй вариант по сути эта комбинация первых front of для ленивых которых сделается за нас какой вред использовать зависит уже от ваших решений и вот теперь когда у нас есть наши сервера в регионах мы научились каким-либо образом выбирать нужную сервера там днр ссылкой или bgp мы научились наполняете его проксирование были наполнением схема наконец-то заработала в таком виде как мы хотели сделать но маленькая ремарка смотрите у нас есть классный сервисе дейэн которые умеют отдавать пользуются com файлы они уменьшают round trip time джиттер и потерю пакетов и пользователь быстро получает контент а почему бы нам не использовать эту схему учили того чтобы пользователь мог загружать файлы к нам с теми же самые преимущества мечтай скачивание от нас и мы можем либо сразу файлик выносить к нам в регион такси ровать либо сохранить его локально а потом загрузить его к нам получается что мы ловим дух за это все стороны пользователей к ему кажется что загружает файл к нам быстрее из за того что находится ближе нам и конечно при этом не экономим денег на трафике в регионы тут не получится если футбол должны платить файл от пользователь нам придется его хотя бы один раз к себе получить но кроме первого варианта где мы грузим его к себе в этом случае мы можем уде дуплицировать и не гнать трафик в центральный дата-центр весь этот файл у нас уже есть и так как это работает у нас я даже быстро рассказываю классно у нас довольно много точек присутствие по всему не по всему миру но в россии снг некоторых странных кроме этого их больше двух десятков здесь на схеме представлены некоторые из них и так как это работает для наполнения мы используем комбинацию обоих вариантов потому что мы вынуждены или мы с оптимизировали это можно по-разному понимать зависимость от разного типа контента рады способ у носа наполнения файлов для тяжелого контента которые мы не можем подставить в регионы как тяжелое видео музыка мы носим его заранее а для легкого контент например картиночки мы можем проксирование в регионы пожалуйста не снижал к особо но мы по-разному понимаем когда файл нужно внести в регион для тяжелого контента мы используем диман демон нога который работает в регионах он имеет индекс файлов локально на себе с рейтингами этих файлов и у нас есть ответ от центрального офиса списком файлов которые хотелось бы не ты в этот регион и демон понимает что у нас есть файл с таким-то рейтингом есть файлы у нас таким-то рейтингом он удаляет самые ненужные уже имеющиеся файлы в регионе которые имеют рейтинг ниже чем файла которых хотел бы скопировать и копирует файлы которых не хватает в регион таким образом мы постоянно придерживаемся какого-то оптимального наполнения регионов потому что они имеют не бесконечное количество дисков нельзя заполнить регион целиком файлами там приходит постоянный его нос при копировании так далее в случае же если мы проектируем файлы типа картиночек напрямую там схема немножко другая мы при каждой выдачи ссылки пользователь когда он за ней приходит делаем инкремент ты же не простой инкремент случае наших объемов и количество запросов это немножко более сложная схема но в целом ситуация такая что мы инкрементом обращения за кем-то файлы каком-то регионе и если закрыто окно времени количество обращений превысила порог ты мы отмечаем его холодным на жку это понятие внутренние и все после этого на какое-то время все ссылки которые мы выдаем на этот файл в этот регион заворачивается формат с указанием зоны server with a file есть мы будем боксировать его там работы пасты джинс практикуешь на облился 1 просто гош не демон в плане выбора то есть как выбирать тот регион куда отправить пользователя к сожалению ни одна из описанных 3 ранее схем нормально не работает в чистом виде почему потому что принципе самый лучший вариант который используется для bgp он особенный тем что провайдер которые анонсирует свои подсети они анонсируют маршрут не через самый хороший качественный и надежный маршрут они используют самый дешевый маршрут который у них есть и поэтому если мы хотим предоставить качественного риме сервисов то мы не можем использовать bgp как первый источник данных потому что мы будем гонять трафик пользователям через самые дешевые маршруты в интернете это не очень хорошо а поэтому мы используем впп исключительно как первый источник информации о связанности и наличие вообще сетевых каналов где-либо и мы получаем вот эту полную таблицу где что у нас в интернете есть к этому примешивается дополнительная логика о нашем представлении о плохих провайдерах о некачественных соединениях а маршрутов которые имеют регулярные проблемы мы комбинируем в полную таблицу bbb с нашим дополнительными каким-то априори с видением и получаем наше собственное видение того как выбить интернет то есть наши региона представления именно уже эту отфильтрованы информацию мы используем у тебя должен больше людям она который вот при этом даже полная таблица bgp она не всегда полна то есть мы можем быть какие-то ситуации когда что то не получилось сделать у нас есть fall back на герой и хотя бы по герой фильма пользовались отправим скорее всего правильно регион целым можем ошибиться но это хоть что-то чем отправиться сразу в питер другой вариант который мы еще к сожалению не сделали но это очень важна для того чтобы предоставлять качественный сервис мы собираем метрики с клиентов о том как для них насколько для них качественные регионы то есть пользователь со своего устройства мобильного либо веб-браузера качает файлы милитари артрита и потерю пакетов и джиттер на себе да разных регионов и собирает информацию у нас поэтому можем с помощью наших пользователей собирать информацию на сколько из их локальной подсети из и там 24 10 качественная связь до кого там нет с нашего региона абстрактно да и благодаря этому можем выбирать воли лучший маршрут точнее чем есть на bgp при этом это одна другой не заменяет но чтобы обновляется быстрее если могут перестраиваться что-то сломалось минута 2 3 мы уже знаем новые данные bgp но пользователи возможно присылали данные которые уже не актуально ведь эта комбинация методов мы все очень процессе этого получение и таким образом когда у нас есть возможность выбора правильного региона с помощью такого модифицированного bgp и мы можем наполнять наши регионы с помощью проксирование либо выкачивания заранее мы наконец-то можем выдать пользу ссылочку на его файлы и она заработает все вопросы я прям очень быстро спасибо за доклад меня зовут дмитрий фандом король вы упустили один на мой взгляд немаловажный момент инвалида ции контента что что происходит тогда когда что происходит тогда когда пользовательский файл необходимо удалить что файл пользовательский файл необходимо удалить еще был причем в ряде случаев срочно вы понимаете срочно он пришел например роскомнадзор но мы мы ничего не удаляем срочно передать по поводу удаления там все просто если мы про ксеры поставляется с сша ну а мы забрасываем кэша и больше нет если речь идет про большой жирный контент хоть его видео то у нас просто есть так называемые желтый свет это время когда мы ссылка выжить и не взаимно файлик еще лежит регионе примерно сутки то есть те кто уже получил ссылку ничему года качать его спокойно и все в принципе довольны так а прям срочно удалять не делаем так чего серьезно спасибо пожалуйста серьезно вот к вам бежит девушка с микрофоном григорий компания тектоник такой вопрос пользователя загрузите будто говорили что пользователь сначала грузит в региональные дата-центр файлы и только потом они уже появляются в центральном хранилище то есть вот пользователь выкладывает картиночку оконч позы это были вариант реализации ну вот мне такой вопрос что пост уже в базе появился а на центральном хранилище еще нет этой картинке и из какого-нибудь другого региона человек читает этот пост и откуда он получит к этому прокси ru его загрузку центральный регион значит не работает из-за варианта можем использовать и получить файл вокальный регион оттуда вывести его в центральный а можем прокси ровать через прокси пасом или апстримом сразу в центр второй вариант сразу работает по завершился файл уже в центре а если первым что а если он через как вы рассказывали загружается то получите нет я как раз рассказывал про оба варианта вот вот второй вариант прокси руин сразу в центр этот вариант сразу имеет в картинку и локально мы можем отдать ему прям с локального кэша если мы не удалили и сразу и можем пульт из других о ребенке он загрузил 2 регион то если из другого региона человек заходит и смотрит этот пост если после пальцам первую схему да да да та да вчера пойдёт либо в регион его должен подождать два варианта а по-другому не получится но это плохой вариант пускать людей из одного региона в другой регион когда нет центрального но это же дороже и еще такой вопрос расскажите пожалуйста про вот этот счетчик как он работает горячих файлов которые наш собственно ниже куда там на каждый файл набор мун кашах счетчиков сортированы по популярности файлов ведь этим потому скажу кому интересно за это после не быстро как я не убегаю спасибо за доклад вопрос про ваше вы нас сидена в по регионам вот есть такие компании типа google а они свои сервера оставят прямо в провайдера вот в 1-х под клиента у вас это обычные дата центра или вы тоже пытаетесь как-то приблизиться по максимуму у нас есть железо которым станем сами самим обслуживаем есть сервера которая ставит провайдеры у себя то есть оба варианта есть спасибо просто яхтам понять сатурн и спасибо за доклад интересно был ты вопрос у вас сколько ну хотя бы по россии или как какой цифры владеете сколько этих сидел точек в россии примерно 20 россии 20 правильно понимаю что центральная база знает какой файлик на какой точке присутствуют да вот такой момент хорошо все это работает работает технически возможно же на каком-то сидение лежит картинка набиты а банально еще возможно бита они-то развилась может быть да вполне винтом вздохов и вот пользователь видит 404 вы об этом знаете ну и чтобы понимаете да у нас когда это система делали раньше еще времена старых админов на стыке проблему или регулярно и приходилось как бы перекачивать сейчас у нас при скачивании проверяется что в размерах ешь совпадает иначе это печально если она побилось смотрите на можно перекачать файл заново это не проблема мы просто отличаемся фото файлы нет и давай-ка ты снова ставим в очередь низко секунд он потом все правильно понимаю что клиент все-таки увидит вот этот значок что картинки нету ну да он ведь вы об этом узнаете что-то сделаете да и чтобы этого не был нас есть защита по размеру файла вы качанова ты определись и тщательно киев у меня два вопроса вопрос первые как вы болеете сиди да сами в случае не каста то есть я вот в прошлом на прошлом годе коллега из dropbox рассказывал как они это делают интересно как это делаете вы второй вопрос о том как вы определяете в случае не касты с каким сервером проблемы то есть объяснив вот допустим у или они рассказывали про свою систему не каста да у них там у каждой но да есть там специальный вот который есть в определенном месте страницы и специальный урок можно посмотреть и понять на какой именно ноду пришел каждый пользователь как вы понимаете вот нового не кажет куда вот пользователь именно какой сервер он пришел что его проблему по первым вопросы отвечу все-таки как мы сбудется да да сам говорит наш админ и все-таки стан разработки к сожалению во втором вопросов как вы проверяем куда пошел по здесь не была проблема правильного как вы понимаете на какую конкретно ноду вашу то есть мы случае не к стыда пользуйте приходит на 1 т джей-пи как вы понимаете что вот пользователь пришел именно нужный вам сервер а то и допустим там с этим сервером проблему в два варианта если мы проектируем трафик первый вариант спонсирования в регион то у нас несколько критических железок имеет общая печник и железка перед ними прокси и на кастом таза после может либо из них а если вот именно с они кастом проблема даже такая вот как и найти тот сервер конкретную железку на которую пользователь пришел тайне касту айпишник у них будет одинаковый как бы но вот конкретно я железка или вы не детализирует и такого мне кажется мы не рассматриваем проблемы со стороны пользователи у нас есть проблему на сервер начинаются серый выключается из раздачи то есть совсем понимаю проблемы но тут проблема обычно в том что случае не кажется очень сложно понять где проблема когда у пользователя там не 404 когда у него вот просто не загружается какой-то вот эта ссылка на не работает нарисовывается в один и тот же айпишник неважно где пользователь хабаровске в москве маниакально смотрите у нас в той схемы где мы используем выкачиванию заранее то есть там где нету там нету и не каста там в ссылке полностью казан сервер на котором находится файл понятно проблемы а там где мы именно прокси ruim санёк астана одинаковые печники куча проблем и серым и забьет на остальные машины с европе шнеком они стоят на рядом это нас нет и не костов регионах это на рядом находящейся машины понятности то есть проблем кого особо нет вот отлично вот так в кулуарах надо разговаривать не не задал вопрос выслушал сказал спасибо набросаю все время вот не не стеснять будь то время еще words друзья у кого есть поднимать у меня два вопроса один короткий 2 длинный короткий динамику тоже гоняете через этот сидя фиксируете для оптимизации какой-то или вся динамика идет на центральный дата-центр что по динамика поднимается но не статический запроса там залогиниться например там обновить что-нибудь ну вот допустим нас есть сервис который занимается рецептом картинок на виту он работает на отдельных бэндах афронт который не выходит это региональный сердце может быть то есть по сути для нас это просто другой формат url а это просто локейшн женщина фронте и никакой бы шанса нет а второй вопрос немножко философский почему собственно решили не покупать хороший покупную сидел филипп свое если можно с кем сравнивали вот not когда придумывалось это какие были варианты из покупных какие рассматривали до из кайа скажи фамилию того кто принял это решение но сами не работает смотрите пока такая компания который любит автобус без хлеба то есть вы понимаете да очень либо сделать свое и решение что мы будем делать свою сидел принималось не при мне и в принципе причина его будет не могу а теперь мы можем себе позволить поддерживает свою силен вас есть ресурсы деньги же по доделать полный контроль как то так а почему тогда не знаю снова я вот есть ну скажем между вашим ги анальным раздающим сервером и клиентом есть что-то что не дает ему скачать картинку ну допустим какой нибудь там корпоративный прокси который на котором запретили картинки отдавать ну и соответственно клиент получает 404 соответственно узнает ваш центральная база данных что вы будете делать на какой вывод вы из этого сделаете у нас клиенты в случае каких то проблем присылают статистику что у них были проблемы мы ее собираем во под сетям и мы принципе видим что у людей с этой подсети постоянной проблем за скачем такой-то регион и мы можем как раз таки вот сервисом о которой говорил вот типа своя логика идет есть фрукты как почему от нижних . своя логика такая стаки те ручные изменения которые мы накладываем поверх full view bb мужика что у людей с этого региона не нужно сайта да у них постоянно проблемы при этом польза или который прислал эту статистику нам что он не смог скачать файл который он хотел из этого региона у водоема ссылку на другой регион где то файл есть давайте по-другому задам хорошо сидит за каким-нибудь там лукойл ским firewall весь лукойл вот и админ обиделся на вас и запретил все картинки с контакта вы получите кучу кучу 404 что сделаете что какие выводы вы сделаете если он анонсировал нашу сеть или что нет вот смотрите стоит в офисе до 100 500 сотрудников лукойла сидят и решили полезть в вконтакт такой может теоретически быть они лезут через корпоративной прокси во внешку вот атом админ который отменит апраксину все картинки с контакта , все я понял нас вызывай страны пвх да да то есть вы там в итоге вы получите кучу статистике 404 то есть на самом деле у вас все хорошо вот ну прилетела такая порцию запаха что делать будете выводы какие сделаете я формулирую где деньги лебовски так что деньги то нет на самом деле интересно что вы техноген у вот как вы реагируете на это то есть это никак не среагирует этом не узнаю но наши админы часто связываются с провайдерами локальными это местечковым и как-то пытаются с них отрешить почему не работают когда у нас много жалоб от пользователя что скит проблемы будешь чтоб за штаны проблем нет то мы узнаем какой провайдер этих пользоваться если один и тот же уже идет связь с этим провайдером у или организации которые злой админ радиационные видимо кит решения купюры все еще вот еще вопрос алексей спасибо за доклад такой вопрос было как-то ошибками с файлами которые лежали на сервере и были времени доступны поделитесь опытом из-за чего была эта ошибка и как ее решили здесь долгое время он был то что сервер и якобы файлы дай оценку mazda да я понял раньше было для хранения файлов 3 это очень странное решение что мы храним две копии файлов на двух дисках одного сервера это никому не рекомендую так делать и общем те файлы которые еще не были перенесены в нормально но у систему хранения не случае миграции сервера его переезда ли проблема не выпадали на время ответ работы это была жизнь такая это и решение были приняты раньше скорее всего речь была именно об этом что fax server какое-то время уходило в обслуживании сейчас по-другому работает и ответил на просто просто может я не совсем понял вопрос правильно обслуживание сервера по старой схеме хранения не можем не греется все сервера разумных очень много поэтому бывает у меня наверное все таки коммерческий вопрос больше вот состоящие минуты общение становится платно позиционируйте свою седину систему как нечто уникально но не что созданная на базе чего-то но тем не менее с частичкой уникальностью чем все-таки отличается от стандартных сидений решений любой счас облачной платформы да это первое второе если все-таки она чем-то уникально почему она не предоставляется там на какой то пусть бесплатной основе пусть некой платной основе так далее тогда один вопрос из двух частей или понял и разработчика не маркетолог наверно да смотрите эта система же вы же могли бы ее вынести ну давайте его мы хотим кто бы и купил поднимите руки не постоит резкости ведь никто один человек есть смотрите она уникальна для нас тем что мы именно неполный абсолютный контроль любую проблему можем жить там за минуту или за час и ни одна другая страна жена ходи по доставит а так мы в первую очередь заботимся о качестве сервиса для пользователей а то мне стоимость трафика что покажет ваш заботимся на понятное дело до но имена для пользователей ни одна дуга система не позволит нам так быстро среагировать готовым или кому-то и предоставить наверное нет потому что это требует от нас обязательство поддерживать не только в наших кейса как мы ее используем в кейсах использования пользователями это не то что мы можем часто магаз размерах нашей команды сделать многие решения ну вот эти пару брошенных демонов и скрипты админский выложить в концерт без на никак не касается вообще у нас есть гораздо более интересны внутреннее решение которое он должен мне кладом потому что их нужно поддерживать к сожалению вот может изменить да вы понимаете что стандартные open source решения это такой противоречивый это выброшенная в помойку будет хобби которые забытое все мы так не хотим больше делать уже были прецеденты не надо можно потом пола уже потом поговорить если хотите мне кажется этого кто из вас будущий стажер друг вот кого я не приму такое хорошее еще вопросы надо же есть привет не вижу здесь здесь здесь здесь скажи пожалуйста по теперь видно если у вас какие-то оптимизации для превью к например для разных размеров картинок для связей например если человек грузит все днк увидела то очевидно что он захочет загрузить превью хуту даже что-нибудь такое вот и метаданные какие-нибудь совместно с картинками передаются или нет оптимизации для приют имеет свою при загрузка ну то есть да если человек грузится одну версию картинки то он набирает на захочет ее в меньшем размере загрузить или больно но быка не такого точно нет это может быть оптимизации на клиенте например истории мы груди ему заранее фоне еще парочку следующих ну просто как пример лизации с видео и превью например новое видео истории торгуется заранее видео в ленте которые мы скорее всего пользователь увидит они сразу отмечаются как холодный мы нашу может быть это авто чистки воспользуется вот здесь оптимизацию это все является на клиенте то есть на бэг-энде нет ничего что было бы ко мне на вы же говорите что вы грузите на локальные сервера которые ближе если вы грузите 1 видео и каким образом тогда вы достаете превью картинку для этого видео лезете в главный сервер если у вас видео холодное то всей сущности связанные с ним включая картинки тоже являются холодными то есть какие-то нынешних видео 7 это холодная лишних все все что с ним связано торнфилд хорошо собственно пола по поводу видео вы на одном из слайдов отметили что у вас отличаются собственно подходы по доставке видео и оно относительно другой статике типа картинок потому что видео тупо больше собственно вопрос то есть вы решили вопрос доставкой в регионы но как вы доставляете собственно видео до клиента то есть видео мягко говоря сложнее доставить для клиента потому что она больше и собственно каждый раз долбится файловую систему также когда пустимся картинки картинки можно закодировать можно накидать памяти успокоиться если мы отдаем видео допустим и каждый человек может начинать просмотр видео там с рандомного место и как какие-то дополнительные прослойки вы используете или нет или какой-то несколько стали какие-то свои собственные велосипеды сейчас три момента первое что мы видео уносим регион целиком это первый момент второй момент мы для видео которые сильно нагружены или кита холодной грузки мы можем раздать его пользователям через нашу сеть live-трансляции это двухслойной кассира которые могут быть регионе там их очень много сети вариант и третий вариант что мы сейчас переходим на хранение видео сразу в в стриминге то есть в хадисе танками вообще весах они необычных целиком файлов и тогда можем вносить отдельные фрагменты на регион но это пока все еще вы хотите конца года прошло вас выпустим но не получилось будет наверное пока 8 целиком и holod мы создаем через нашу сеть лайвов то есть у вас есть допустим видео в хорошем ну допустим грубая 4k качестве но при этом вы используете подходы которые уже сейчас опробовали на live трансляциях так что получается ну то есть это видео популярную нему носим 4k в регион целиком это не лучшее решение сразу говорю но пока нас так друзья но это было великолепно алексей поклонись всем спасибо да"
}