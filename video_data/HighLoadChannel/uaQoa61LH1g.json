{
  "video_id": "uaQoa61LH1g",
  "channel": "HighLoadChannel",
  "title": "Рутина администратора баз данных / Андрей Сальников (DataEgret)",
  "views": 10170,
  "duration": 3184,
  "published": "2019-12-05T08:29:07-08:00",
  "text": "здравствуйте здравствуйте радовать всех тут приветствовать небольших хочу представиться я обычно я администратор позволит скоро аромат очень компания дает и y и общем то я буду а вот свои обычно администраторской работе рассказывать кто из вас пользуется пост грессов так хорошо о тех кто за лампочкой я не вижу но достаточно много а давайте так вот у кого больше десяти баз данных отлично у кого больше 50 я вижу вижу на фоне а больше 300 ухты есть есть брат по разуму у меня более 300 монет мастеров в обслуживании сколько реплик я не скажу честно говоря потому что как бы неинтересно это было считать вот и я хотел у нас тут будет два технических докладов был до меня будет после меня а я буду так разбавлен вам просто обычным разговором о своей компании мы удаленный администраторы баз данных называется моя компания дельта y и мы один оказываем услуги поддержки как удаленные тбо позориться и услуги консалтинга ну и также так как у нас большое количество баров баз данных обслуживания нас накапливается какой-то опыт background знаний которым мы стараемся делиться на конференциях в этот раз я этого не буду делать но поделюсь просто процессом как мы работаем вполне возможно вам поможет как бы более организовать свою работу с базами данных потому что обслуживает более 300 баз данных это такая нетривиальная задача поэтому собственно говоря надеюсь что поможет вам структурировать свой рабочий процесс надеюсь что что-то будет полезно и и если вы не высыпаетесь то надеюсь что вы будете высыпаться и спать хорошо по ночам и вас не будут видеть эсэмэски звонки и это менеджеры технический директор директора инструменты которыми мы пользуемся на самом деле мы довольно как сказать ребята без изысков у нас все достаточно просто естественно мониторинг это наше все мониторингов у нас много разных потому что у нас разное количество клиентов и кто-то пользуется запись сам кто-то над мастер настраивает там экспортеры всевозможные кто-то пользуется от метром но в большинстве случаев у нас пользуется от метром вещь которая нам другая помогает работать это собственные вики в которой мы собираем знания и какие-то рецепты решения проблем это вики они я чуть позже поподробнее расскажу но эту штуку мегаполезно и потому что она позволяет быстро и league быстро находить решение той или иной проблемы если она уже случалось и это позволяет экономить время на починку базы данных есть также базы инцидентов которую мы ведем то есть если случилась какая-то авария на базе данных или не на базе данных с приложением когда нам пишет клиент у нас лежит все а глаза работает хорошо но какая то может быть промежуточная причина и любые любые вещи пишутся базу инцидентов и это нам помогает потом заполнять собственный вид вики потому что не всегда инцидент можно параллельно говоришь квалифицировать и понять с первого раза что там происходило а после фактом бывает не вернешься к этому но когда их набирается несколько одинаковых можно уже какие-то методики для себя вывести и формализовать для базы для то для дальнейшей работы и так же у нас есть огромный набор собственных скриптов и утилит которые нам позволяют оценивать состояние баз данных не тратьте время там на то чтобы посмотреть почему собственного ти лет и потому что но мы очень давно занимаемся под гриссом и когда начинали заниматься них никто ну особый много информации не был и многие вещи делались нами некоторыми вещами может быть вы даже и пользуетесь из нашего открытого репозитория в этом я тоже расскажу чуть чуть попозже подробнее собственно говоря рассказать я хотел своем обычном дне как он проходит рабочий день и как проходит рабочий процесс мониторинг от конечно хорошо но у нас есть дублирующая вещи мониторинга это то что как бы ступица письма и мы должны их анализировать цепляться ведь мы не только от и миль от мониторинга которые установлены там и следят за базами данных но и также на каждом сервере мы устанавливаем кроны с определенными заданиями в общем случае у нас три задания это прибивание длительных запросов которые всегда плохи для базы данных а длительность определяется конкретно нагрузкой на базу данных сам если это у вас web service to больше минуты это уже плохой запрос если у вас какая нибудь аналитическая база данных то там принципе три часа нормально а вот пять часов уже может быть плохо поэтому кроны еще это один крон который убивает задания другой крон проверяет флаг репликации между мастером репликой и эта вещь верующая основной мониторинг потому что мониторинге имеет тенденцию иногда ломаться и не всегда об этом узнаешь особенно когда он находится не в твоей власти и еще один крон это который собирает и отчеты ежедневные о выполняемых запросов на базе данных эти отчеты собираются на основе расширения пиджи стад statements есть другие решения к примеру b&g банкир который там позволяет вам пологом собрать какую-то аналитику по запросу но она более тяжеловесное неудобная и вам для этого нужно включать полное багирова не и выключать и g-100 of tanks дает вам оверхед там 23 процента на выполнение запроса но пользы которую несет она намного выше чем этот оверхед потому что благодаря ему вы и правильно написанному запросу анализа этих данных которые туда собрались вы можете активизировать свои запросы и уменьшить нагрузку на сервер за счет вот этих отчетов которые приходят и заодно и это нам является индикатором если отчет не пришел то как бы письма не пришли сервер это значит какая-то беда а мониторинг молчит и есть у нас ежедневные задачи которые накапливаются со временем то есть такие которые приходят от владельцев баз данных более детально чуть позже распишу что это за задачи и зачем они нужны так сейчас секундочку на тыкву не туда от систем мониторинга разные бывают при вас призывают довольно много параметров постах а по факту в нашей рабочей там около 40 50 работающих рабочих графиков которые нам интересны сервера базе данных но практика показывает что в основном полезные оливки следующего вида о том что у нас проблемы с местом на дисках в чем вроде бы эта такая детская вещь но блин кто-нибудь да всегда забывают про это и прошу кивают момент когда она у него закончилась места на дисках другая проблема это очереди g bouncer очереди в саму базу данных тоже соединений мониторится но большинстве инсталляции пузырится предпочитают использовать пиджи bouncer так как он позволяет экономить ресурсы сервера на поднятие бэндов когда вам нужно 10000 брендов их никогда не настраивают на стороне базы данных базы данных двести-триста коннектов все остальное через пул соединений данном случае решения проверены и работают работающих пиджи bouncer есть альтернатива который появляется но еще пока я не рекомендовал бы использовать этот десерт яндекса яндекс и не устраивал пиджи bouncer не устраивал причинам того что он работает в один поток и поэтому они решили пилить свою утилиту но пока она на мой взгляд не production реддит для всех хотя внутри у себя они ее используют и довольно эффективно и активно важный фактор это потери реплики его гариб ли кации он может говорить о многих вещах о том что у нас проблемы начались сетью или у нас звук сервер реплики который в принципе является нашей надежностью попал tolerance в общем это важный факт который приходит на который реагировать на да некоторые виды мониторингов нам шлют сообщение о том что в рейде отвалился диск большинстве своих инсталляцию мы используемые программные рейды и мониторить программной рейды в принципе удобно и хорошо и если там отвалился диск ну значит на проводе технические работы сервера мы менять эти диски до довольно важно ли это достаточно важное от количества долгих of the vacuum процессов потому что если у нас в of the vacuum не прекращаясь барабанит по все и все worker и заняты значит что-то с база опять-таки не то происходит и на это необходимо реагировать по кронам я уже сказал что мы там смотрим вата репликации отстрелянные забрался принудительно и оттуда же нам приходит из дел ежедневный отчет по 500 statements отчет я позже покажу какой ежедневные от тоски которые у нас есть почте это задача типы проведения миграции базы данных схемы потому что нельзя просто так взять сделать alter там на 10 гигабайтной таблички что мозга лишь на любой alter берет эксклюзивную блокировку если вы будете делать это просто через систему миграции не выставляют никакие таймс тайм-аут и то вы по 200 работала своего приложения с базы данных пока базы не проведет эти альтера высокие там архивирования и если база большие там есть исторические данные в общем такие тяжеловесные задачи которые не выполняются прямо в за пять минут которые нужно запланировать подготовить аккуратненько фоне выполнять выдачи прав создание новых баз данных и миграции баз данных но обновление на минорной версии но эти задачи мы обычно не клиента нам ставят а мы им самим сообщаем что ребята пора бы обновить то какие-то баги пофиксили минорное обновление или у вас старые очень мажорная версия позориться и необходимо обновиться на более новую потому что там учился движок и много новых прикольных фич появилась и вот этот кит кипы писем там у меня их было 300 чем-то штук это в принципе я как раз вот сюда когда приехал открыл и скриншотик сделал нужно приоритизировать как над чем работать понятное дело что там есть авария по звонку когда тебе нужно сразу включиться но вот когда вот такие лифты нужно как ты про ставить приоритеты чтобы не потерять деньги да и с одной задачи на другую аккуратненько по очереди их проделать поэтому приходится смог смотрим всю почту смотрится почту по некоторым а лифтом понятно какие критичны к некоторым непонятны но большинстве случаев любой over требует того более детального взгляды на него тайсон нам прислал сообщение допустим в месте на дисках то что что место стало меньше а почему как что мы не можем сказать может это нормально может это ненормально необходимости посмотрите и более детальную информацию получить а в этом месте на дисках что же там происходит и сейчас вот 4 примерчик а просто в подтверждение моих слов allure 1 alert то есть как бы том что места на дисках мало ну как бы почти ровная полоска как бы чего тут беспокоиться но его надо посмотреть разобрать другой alert такой печет когда куда это место делалось вернулась что такое что-то похожее тоже ну тот грибников тоже alert сожалению прямо от под полку java себя мониторинга нашел ду как бы это было бы плохо если бы я уехал на конкуренцию у меня там все стало alert поэтому прошу простить ей это допущение и третий вариант когда полета я пошел пацанов и четвертый вариант когда я полета пошел посмотрел что же там происходит на висках давайте разбираться попробуем классифицировать эту проблему по первому али рту но по первому ровный полосочки что там может быть ну скорее всего это просто естественный рост gd и она просто дошла до порога и это не критичная задача the us по графикам мы видим то что там нету каких-то таких скачков по 2 непонятно в принципе график посмотрели что там происходит но черт его знает что там происходит но вместо вернулся вроде как бы пока не критично 3 штук а то же самое то есть можем пока на это как бы не обращать внимание а вот 4 график который был и где у нас такая ровная горочкой gear это уже очень тревожная вещь потому что судя по тенденциям горочка не остановится пока не дойдет до самого верха и снега необходимо разбираться allison у нас попадаться самый главный приоритет а потом на самом деле я не занимаюсь тем что лезу прямо сразу этот сервер смотреть не нужно посмотреть другие амир ты потому что могут быть более критичны и какие-то проблемы тут просто как бы для упрощения примера привел по дискам я просматриваю все почту кай такое классифицирую вот так вот ситуации там с полу механик тов у вас будет ситуация следующего образа то что если тоже был пик и какое-то время все соединение были забиты а потом он пропал это можно отложить разобраться на потом а если у вас нам до сих пор забиты все соединение вам необходимо будет в первую очередь туда лезть ну и так далее поэтому с 4 необходимо разобраться здесь и сейчас один вообще совсем не критичен 2 и 3 это после всех критических ситуаций нужно заняться будет ими при разборе всех после разбора всех критичных операции и отличный план на ближайшее будущее у меня есть чем я буду заниматься соответственно приказу начинается разбираться с четвертым графиком нужно дополнительно еще больше информации получает соответственно ну как вместо девается надо посмотреть что же там на дисках реально сервере творится поэтому лезем на диск лезу на диск смотрю что там с папками происходит куда девается куда делась место центры размер d на уровне том же которые как бы до роста занимаемого места то есть там 2 1 терабайта на графике было значит это не б-г раз он еще дальше на нашел . у меня резко выросло количество лагов которые пишет позгалев вещь тоже абсолютно ни о чем не говорящая потому что ну растут ноги растут надо дальше копать но если ситуация критична и у нас место совсем не осталось но естественно необходимо принимать какие-то действия и можно удалить самый старый logs атом или хотя бы самый старый большой лог удалить потому что если их несколько понятное дело нам придется нам надо будет хватит одного чтобы посмотреть что произошло вот и занимайся занимаюсь изучением логов для извлечения логов у нас есть как бы linux утилиты прекрасные типы гриб гриб седые и так далее и работа с этими логами она именно в этом заключается также очень важные вещи это то что мы храним яуза об этом забыл упомянуть так как серверов очень много в памяти мы не держим считались информацию о том зачем эта база данных что задний процесса происходит поэтому не обязательно обязательно конечно посмотреть что это за базы данных и как и какие рабочие процессы там происходят там что это может быть не очень критично для клиента база данных вот и мы можем не особо сильно беспокоиться о ней и более спокойно работать ну разбираю дальнейшую ситуацию я нашел то что вроде стало поголодать очень много insert a fool причем и тортов там павел за строчках несколько мегабайт допустим и просмотр посмотрел отчётик свои по этой базе данных какие там запрос есть сколько их приходит какие они там никаких изменений не произошло то есть все те же самые запросы в том же количестве и нужно смотреть дальше дальше посмотрели а вот размера те концертов изменился очень сильно и размер изменился запроса у чуть дольше выполняться и он вывалился за лимит минимального багирова запроса вывалился за лимит и начал все запросы если раньше они отсеивались они сейчас начали все эти insert его лиц и влоги и по сути дела мы начали очень активно съедать все места отлично поняли в чем ситуация в чем дело и соответственно нужно эту ситуацию каким-то образом фиксить поэтому временно подкручиваем ручку варьирование запросов чтобы у нас логине росли так критично как бы определить длительность запросов которые возникают можно по водам и продолжаем работу мы тут ничем не поможем это какая-то проблема на стороне приложение если раньше было как маленькие размеры insert и укладывающийся в лимиты сейчас стали большого нам в этом должны сообщить разработчику сказать вот товарищ у тебя такая беда и если ты ничего не сделаешь то рано или поздно ты просто сможешь базу и не будет у тебя базы ну как бы некоторое время по крайней мере а как бы современные тенденции в бизнеса требует чтобы база работали сигна 24 и down time of у них никаких не было то есть это всегда будущее аварии очень критично и сообщаем разработчику в принципе наша работа на этом закончена единственное что если мы оба если эта ситуация у нас впервые то мы стараемся завести у себя инцидента подобную ситуацию расписать какие были симптомы что мы увидели какие приняли действия потому что при повторении подобные ситуации мы уже там где-то на подкорке если именно ты этой задачей занимался или наблюдал как коллега твой занимался такой задачей тэм он на подкорке помним что что-то такое было и вместо того чтобы напрягать память и спрашивать коллегу или себя что же я там делал прочими пойти и поискать свои записи что же то там на самом деле делу это очень и очень облегчает работу и если таких как бы казусов набирается некоторое количество то имеет смысл себе в вики написать какие-то характерные там чек-листам workflow какой-нибудь по действием который необходимо делать уже когда можно его более-менее формализовать в такой общий вид и как бы дальше ждём а тут решение от разработчика этой проблемы периодически мы напоминая и как бы говоря товарища ты сделал ты починил у тебя там как бы все плохо вот это тоже довольно важный этап потому что не напомнишь я заморочек он забудет ну ладно там подкрутили логирование всю базу же работает настолько распространенная ситуация что как бы ни грустно и невеселое просто рутинное и дачном эта проблема принципе не интересно мысли разобрались как бы пожар потушен в зародыше и просто оставили вот низком приоритете напоминать разработчика пока они почти как починит вернемся к этой проблеме поменяем обратно логирования и посмотрим стало ли у нас все хорошо с базы данных ну как бы действительно ли он подчинил или как бы просто думает что починил ситуации в жизни бывают разные aloft это хорошо то есть как бы по allure там мы находим самые горячие проблемы но на самом деле самые горячие проблемы могут быть не только валер так я уже как пока говорил эту систему как бы проспойлерю но если ежедневные отчеты по запросам эту штуку тоже достаточно вас в плане того что это тоже может быть начинающейся пожар и них нет необходимо тоже анализировать как мы это делаем у нас есть внутренняя сейчас оформляется внутренняя утилитка которая ищет аномалии по отчету в по базе данных потому что если у нас устоявшаяся база данных и приложений составлявший ся нагрузкой то у нас изо дня в день будет один и тот же набор запросов они одно и то же количество но это же время там с естественными просадками в зависимости от праздников танков или выходных но опять таки все зависит от на направленности базам данных но в любом случае есть какая-то такая стандартная нагрузка на которую мы можем опираться как на такую опорную точку и если мы скрыли ruim от этой точки там на сколько это процентов что-то нас выстрелила вот значит беда по отчетам от для отчетов у нас написан свой скриптик то есть многие говорят про пятиста statements какая-то клёвая штука как я хорошо пользоваться но если вы напишете телег звездочка своим 500 of tanks вы увидите кучу информации с которой неизвестно как разбираться у нас это оформлено скриптик который возвращает вот примерно такой результат там у нас топ позиций мы собираем по моим 50 запросов 49 запросов собираем и все остальное хлопаем возраст строчку others это все остальные запросов потому что как бы разбираться имеет смысл с первыми двумя десятками отчет выглядит следующим образом общее время базы данных которые она провела в выполнении запросов но тут я его как бы выдернул с реплики там только мониторинг приходит и смотрит поэтому вот мониторинга он всего полтары минутки скилл а в принципе там есть где там по 300 400 часов за сутки временно запрос и потому что этого боя драм масштабируется то есть по сути дела если вы у вас количество часов сопоставимо с тем что ну 24 на количество ядер то узнать что вас очень-очень загруженный сервер общее количество запросов зафиксированного пиджи stats to dance это не абсолютно все запросы которые приходят базу данных это ровно то что фиксирует 11 танец это строчки такие у для общей информации у количество уникальных запросов то есть это вещь такая общая информация которую обращаемся на самом деле сейчас редко смотрим следующие вещи это версия отчета и версии базы данных на который он был запущен версия базы данных она полезна потому что когда выходит новый мировых минорный ли релиз или мажорный место то вот вы бегать по всем серверам с базами данных и выяснять какие же там версии padre состоят стоят у нас все актуальные на данный момент поддерживаемые сообществом версии то это убийца просто тупо отчете q быстренько собрали и понятно какие базы как нужно обновлять вещь полезная ну как бы не очень часто и вот самые интересные вещи тут а что у нас отчётик делают по запросу как собирается быть 16 лет не спишь на запросы в различном виде то есть он все параметра оттуда убирает то есть как это отразить запрос купить жестов ты красивыми сможете но зато вы сможете с агрегировать одинаковые запросы в одну строчку и посчитать сколько этот запрос у вас noise медитация этот отчет собирается рассудке вот это в принципе нормально и период для вас данных и статистиков перестал statement скидывается рассудке потому что нам не нужно устаревшая там за неделю за месяц назад статистика и мы стараемся ее скидывать иисусу точна в общем что в этой строчке h20 у нас запросы отсортированы по количеству суммарной нагрузки которого они дали на базу данных то есть нагрузка от всех запросов базу данных считаются сто процентов и дальше вот это вот сто процентов мы перестали dance собираем именно для каждого запроса отдельно и тут на подсвеченной части вы можете видеть то что вот этот вот в первой позиции запрос жрет 61 процент процессора из всего того объема который живет базы данных это может быть как если небольшая нагрузка там с одного ядра если большая нагрузка то это как бы нагрузка именно от того сколько база берет у вас сервера и если у вас база очень сильно грузит сервер понятное дело что с этим запросам нужно что то делать если он столько много процессора вес значит вы что-то не оптимальна в нем ну какая то в нем есть не оптимальность или нужно пересмотреть свою идеологию работы с базы данных и как-то заменить этот запрос на что-то другое или добавить каким промежуточный table таблицы но это все очень зависима от контекста ситуации бывает ситуация когда забрался очень много операций ввода-вывода делает сожалению 5g list of tanks не даст вам информации были эти операции ввода-вывода действительно с диска или из файлового кошка операционной системы но в любом случае наличие большого количества операций ввода-вывода если это у вас не несет какого-нибудь каунта или каких-нибудь агрегацией а просто небольшой какой-то запасе который возвращает 2 3 строчки говорит о том что что то опять таки неправильное нужно с ним разбираться то есть это довольно полезная вещь так же как бы средние время запросы за сутки мы видим как как происходит дает отчет информацию количество вызовов это запрос этого запроса и процент этих вызовов от всего количества зафиксируем их g-100 танец чем хорош реджистанс пигмент к примеру от логирования длительных запросов в базу данных превалировать не длительных запросов базы данных влогер уйти только длительные запросов базу данных 5 16 трансформирует абсолютно все и бывает что у вас очень сильная нагрузка от маленьких коротеньких запросов и бывает то что это нагрузку может быть по табличке в которой весь ну там не 10 допустим 1000 записей но базе данных каждый раз приходится делать полу полные скан таблички и создание проб банального индекса там по условию какому нибудь допустим там по primary key не было ну там как по какому-нибудь ключу почему сознание какого-нибудь банального индекса которая позволит вам сразу точечно находились строчку в памяти резко может снизить вот эту вот нагрузку по процессору swagger а ванием медленных запросов вы никогда не найдете этой ситуации поэтому такие отчеты они достаточно важны следующая строчка это как бы количество строчек которые возвращалась с этим запросам суммарная вот и сам запрос ну пользователь и базы в которую входили но базу я тут затем подумал что это удачное название и дальше по степени того как запросы загружают базу данных они отсортированы то есть как бы разбираться надо по порядочку с позиции 1234 самая идеальная ситуация когда я вот говорил вначале если вы помните есть озер запрос с запросы которые не попали в топ схлопывается возраст и когда у нас others находится в полиция один это значит то что у нас вообще просто может сказать идеальной ситуации с базы данных и запросами в базу данных вот нагрузка по запросам размазана равномерно какие могут быть аномалий плачет у ну я в общем то и все перечислил не пришел отчет это значит то что у нас что-то с сетью или упал сервер и мать или кто ринг промолчал есть ситуация когда пришли новые запросы эту аномалию надо посмотреть то есть за тепло или разработчики что-то не предупредив нас это частенько происходит и с дипой или неудачный запрос который просто просаживает по ресурсам но вам сервер и вам необходимы с ним разобраться глубже потому что страдает как бы приложение базу данных ты работа этого приложение страдают другие всякие вещи то что запросу стало чуть больше там могло поломаться какой-нибудь конечно стороне приложения еще что угодно то есть эти ситуации нужно разбирать пар процессор диске я в принципе рассказал то есть это все аномалии который можно вычислить посмотреть по этим отчетом когда у вас собирается статистика равных таких отчетов и вы примерно понимаете среднюю нагрузку на базы данных любой скачок там на 20 30 процентов от этих усредненных данных это сразу говорит о том что что то не так в базе данных происходит со стороны приложений в самой базы данных это уже дело десятое но как бы отчеты они очень большая помощь мониторингу эти вещи мониторингом вы не поймаете собственно это я все проговорил забыв про свои 2 и получается самой критичной проблемы с местом на диске растущим травмы в небеса мы разобрались и как бы у нас есть другие проблемы с дисками с которыми мы я должен еще разобраться на сегодня вот и как бы ну допустим вот в отчетах я нашел что у меня есть аномалии по одна аномалия по загрузке процессора другая аномалия то загрузки дисков вот и соответственно уже после того как все пожары потушены можно спокойно про планировать другие вещи но они уже про планирование но можно заняться другими вещами то есть неожиданно аварии она всегда может случиться к этому нужно всегда готовым быть для этого помогает вики и как бы своей базы знания очень важная вещь полезная также есть задачи которые планировались заранее кора обновление базы данных она требует downtime у база данных на запись как минимум это если у вас есть реплики если нет реплик то у вас downtime будет полный и это работа требующей концентрации или если на нее за про них запланированное время вы должны ее делать именно время и соответственно то что было за план экстренная запланированная и дальше уже разбираем систему волн который набрался это у нас получается место на воле запроса ну еще иногда на консультационный вопросы задаешь но это как бы тоже вещь не прогнозируемая как там клиент там что-то новое разрабатывает напишет вопросом а как мне лучше написать запрос ему отвечаешь но это такая фоновые задачи который не требует особых такого пристального внимания большинстве случаев давайте размеры дальше давайте разберемся с моим задачами которые происходили номер два это такой пучок был у меня небольшой на графиках я просто пошел на сервер посмотрела в это время запускаются кроны которые бы как делают бы копирование базы данных и соответственно они складывают backup локально а потом сваливают посетить его куда-то прикидывают и удаляют место но опять-таки об этом я должен сообщить владельцу базу данных и сказать товарищ у вас мест уже подходит к предел потому что есть в момент когда мы снимем бэкапы и зальем все места на дисках то есть эту ситуацию примерно как первый график когда у нас место постепенно подходит к концу и мы об этом должны сообщить просто не все снимают бэкапы некоторым достаточно там бэкапы дамбами данном случае это быка в дампом был а некоторые делают себе бинарные бэкапы и выкопаем дампов не развлекаются а по третьему там такая города у меня было получается что коррелирует с поэтому же серверу я увидел аномалию в запросах и это становится уже интересно что же там произошло вот пологом я как бы увидел там обнаружил во время работы то что у меня создается много временных файлов сам запрос как бы не абрам не обнаружил никаких изменений посмотрел пологом там параметру этого запроса не меняются он как вызывалась так и вызывался вот и как бы но вспомнил что что-то такое было и вот как раз тут мне пригодилась майолики я полез в танце список инцидентов потом у википедию если есть и посмотрел что же там происходило чтобы просто освежить память вот и выяснилось то что как бы было миграция о друге очень не рубио у вас grease и есть такая особенность когда вы делаете alter колонкой меняете тип на самого себя разгрызть ничего не делает кроме того что удалять статистику по этой колонке а планировщик заданий по статистике по этой колонке у вас как бы он опирается на статистику и соответствии с этой статистикой решает какой план построить запросы когда нет статистики он начинает сходить с ума и данном случае смотря статистику до этого планы выбирались там с каким-нибудь индексами не связанными с этим столом а как только мы потеряли статистику базы данных решено что проще делать полной скан таблицы таблица огромное и соответственно для того чтобы там сможешь тюнить какие-нибудь данные места там word мимо не стало хватать и все это дело начало вписаться в во временный файл вот как бы не было бы у меня такой такого прецедента раньше я бы потратил там достаточно много времени на это ну то есть первый раз конечно такие инциденты тратятся довольно много времени второй раз уже как бы вспомнил где-то на подкорке что-то подобное было пошел просто она вайс таблички сделал все починил почему статистика не собиралась табличку просто данная особа не пишет то есть она большого на нее данная особа не пишу то она такой как огромный справочник другая проблема оставшегося последние то у меня проблема с количеством потребляемого циклу возросло также как бы classical смотришь мои гены как бы работала она всегда одинаковая и вспоминаю ну как бы влогах чисто посмотрел почту попасть как бы коллега у меня там стартовал сервер до этого были какие-то работы там допустим меняли диск который вылетел из рейда и для этого необходим был рестарт сервера не всегда это на горячие делаете и как бы логично понять но предположить что это случились какие-то потери настроек которые не были зафиксированы есть нас есть скриптик сервер аудит он в открытом доступе собирается характеристики операционные системы показывают нужные параметры подсвечивать красным цветом те которые неправильно на наш взгляд настроены он также проводит аудит конфигурации базы данных но часто показывая нам какие есть конфиге как какие параметры менялись отличаются от дефолтных там вон логе может пошерстить не такая удобная что-то запустил он как бы собрал сводный отчет это по нему смотришь еще ведь советском цветом подсветил и по этому скрипту сразу стало понятно что процессор приключился в энергосберегающий режим с этим с этим есть некоторая такая подставу когда у вас база нагружена маленькими запросе коми выполняющими со там несколько там 100 миллисекунд то вы что операционка не будет повышать приоритет на рога сбережения потому что запросить клуб у нас ушел выполнится ушел из них доставлен там повышается энергосбережение performance только когда тяжелое большое вот и мы по умолчанию включаем перформанс на всех серверах с базами данных соответственно и есть сервисы которые этим управляют по умолчанию они всегда в ковер сейф режим при старте операционки переключает процессор собственно говоря вики у нас есть информации какие где службы в какой с работой потому что зависимость этой позиционке у нас это разные службы ищем для нужен службы настраиваем все свобод спокойно так я сейчас у скорость немножечко потому что немного не укладывалось и остается свободное время потому что ну как бы я ни один администратор нас несколько и как задача раз проливаются когда у тебя есть вот информация информация ты можешь как бы в рабочее время она еще остается что-то свободное в свободное время мы обычно занимаемся изучением каких-нибудь новых технологий потому что в нашем мире по сбросу постоянно появится то какой-нибудь ability решения какой-нибудь там шарди раване это еще что-нибудь каждый день что то появляется и принципе полезно знать это так как мы все-таки позиционируем есть экспертную попов гольцу по вики когда у нас набирается информация которую можно оформить в виде доклады технического мы это делаем и оформляю в виде доклады пишем статьи я сам не пишу на у меня коллеги пишет статьи и делимся эту информацию уже публично вот и в принципе нас за это и любят то что мы как бы довольно часто даем толковый дал доклады и не так же как бы когда какая то не хватает какого-то скрипта там для более быстрых реакций как бы копаемся ковыряемся смотрим как лучше написать скрипты его тестируем вот соответственно и день инцидентов по каждой базе данных позволяют нам как бы иметь историю и в случае возникновения повторного инцидента просто посмотреть как разворачивались события и уже иметь какой-то шаблон действий примерные хотя бы который сокращает время реакции время просто обдумывания проблемы данной вот секущей и это очень-очень хорошая экономия времени другая вещь это внутреннее википедия потому что когда инциденты на накопились мы собрали эту всю вещь знание консолидировали уже каком-то таком обезличенным виде туда затолкали и у нас википедии есть внутренние почти все рецепты настроек любой мелочи под любую с потому что тот же самый пиджи балансер там мантий нир и пакетов в centos и собирают вам через систем д в debian и ubuntu он почему-то через инет д то же самое дело с пакетами по сгрыз а есть еще экзотические всякие но не так давно у нас еще и на везде были базы но сейчас уже как бы нету но год назад еще были на везде базы данных не забываем про windows где это как мир отдельных чудес вот и там тоже все свое от версии к версии кпа сгрыз со сменой движка цене на некоторых концепции меняются настройки меняются как бы приоритеты настраивания тех или иных параметров не сильно но меняется эти вещи мы тоже имеем потому что все в голове не удержишь чек-листы для всех операций то есть когда мы операцию повторяем на разово конечно откладывается на подкорке но лучше себя проверить чтобы не пропустить какой-нибудь пункт вашему все люди все устаем и бывают то что что то пропустишь и очень критично и вот ну и соответственно как бы выливается это все доклады технически именно доклады мне такой как мой а именно технически чем мы можем вам помочь конкретно вот как специалисты по базам данных и не за деньги вы можете набрать пользоваться нашими скриптами утилитами они находятся в открытом доступе гибели гите многие пользуются кто не знает пожалуйста как бы пользуетесь у нас есть там фактор баз данных от отдельные проблема когда у нас таблички раздувается есть несколько решений вакуум full пиджи репак и механизм через апдейты таблички вакуумирование и как лучше всего реализован у нас списка папок тайму но и обычно ей многие пользуются есть три три метода вакуум full пейджеры пак требует место ровно столько же сколько у вас табличка занимает компактор не требует и когда у вас место в притык на диске лучше медленно но иди компакты и вам обработать тоже пользуетесь что у нас есть пи джей ти вас есть хороший скрипт сервер аудит который вам даст прост представления о том что у вас неправильно вас настроена и какую-то такую справочную информацию просто сакцентировать внимание то что вам базе нужно поправить там же лежат отчет об api g-100 отстегнуться можете ими пользоваться вот тот что я показал рост и включить его себя это расширение пользуйтесь куча всяких скриптов которые ищут распухшие таблицы распухшие индексы и много всякого такого плохо используем индекса когда час переизбытком набрали я сейчас вижу время заканчивают и много сотки другой полезной мелочевки как бы всю ее перечислять довольно долго и другая вещь так как я вот упоминал то что мы делим с докладами открывается по и листы хороводы и ищите следующих людей которые докладывались в принципе почти каждый член нашей команды докладываться это списочек вот тут вот илья космодемьянский вам довольно известен максим бобок алексей лисовский в прошлом году у вас был за кладом алексей ермаков виктор егоров всех сил докладывать конференции которые выкладывают ахают выкладывают все вы можете найти и уже более технические вопросы там для себя найти ответы по полису у меня все спасибо за внимание единственной я воспользуюсь правом хотела сказать следующий доклад будет я просто все пообещал сказать павла рузанова это человек который инициировал перевод подрисовывать документации на русский язык за это ему нужно очень большое спасибо сказать и это человек который инициировала создание курсов по обучению администрированию баз данных и пользователь под гриссом так что очень и очень клёвый человек и рекомендую вам послушать его очень внимательно теперь у меня все спасибо ребята в формате автопати и будет интеллектуальная игра которая называется крис близ на нее надо записаться записаться там где выдают визитки помнить а вот а теперь вопрос разное так новый я думаю мало свои добавил образовалась делаешь за высева за доклад очень интересно было послушать про workflow у меня сразу вопрос вы упомянули что вы делаете миграции и вроде как упомянули проект креатив лоб мне вопросы как вы их делаете без эксклюзив плохо но смысл смысл эксклюзив флоком делом просто есть ситуацию допустим вы меняете тип столбцу да то такое вещи лучше делать создав новый столбец и залив его новыми данными интеджер back into джерс классической результатом миграции не хватило для primary кедами новый столбец заполняем данными там триггер работает который новой строчке заполняет мы аккуратненькими апдейтами переносим их конце просто переименовываем станции на переименование столбцов нам нужен тоже эксклюзивный лог но он краткосрочный то есть мы восстанавливаем переменное окружение spend my time out там допустим 20 миллисекунд или секунды зависимости от нагрузка на базы данных и долгом со пытаемся попасть вот в этот небольшой тайм-аут с эксклюзивным лаком то есть если мы в 10 секунд не получили эксклюзивную блокировку у нас alter отваливается с ошибкой назад они страдают приложение она продолжает работать с этой табличкой эксклюзивную блокировка к сожалению не дает вам там писать-читать из таблички пока она встанет в очередь блокировок и он сделан из они там очередь выстраиваться в нашем случае она тоже выстраивать но коротенькое только выстроилась учетом допустим 20 миллисекунд уста поставили time all и отвалилась наш альтер эго и попробуем пробуем до тех пор пока не внесенного то есть любой длительный alter который связан с миграции данных мы разбиваем на кусочки делаем что-то вручную и потом уже коротенькие альтеры которые позволяют там короткие блокировки брать моим спасибо еще такой вопрос а будет метан какой-нибудь на самом деле у меня есть некоторые вопросы по возрасту ну просто а я тут хожу вы меня пойми поймать ее а пока расскажу да кстати я вот смотрю тут не особо активно киперов мучают мучайте да вот молодому человеку сразу из какие-то подарки будут вот за этот можно сразу давать больше не за ционы было много панда со временем представьте себе день вас пришлось типичными пытайтесь их и некритичных плюс плановые работы и тут раз два три . и авария подряд я все вроде как пожарились починили но к вечеру есть понимание что вы не успеваете сделать не сочность задача и 2 при не знаем что то случилось в мире там 1 2 такой и на треть четвертый день накопилось много не срочно вот так медленно там всех теперь она заканчивается место главного штаба го данных что организационного этой ситуации вы делали по любому и ситуации в работе встречались до случаются такие ситуации ну да сознаюсь некоторые задачи пропахали просто оставались так ну то есть который совсем не критично и тут такое бывает но в нашем случае у нас получается вся команда это достаточно высоко квалифицированные 2 и мы не стесняемся если видим что кто-то из коллег не справляется забрать у него половину задачи сделать в этом отношении мне моя компания очень нравится потому что мы как бы друг у друга отнимаем работу по хорошему вот и это очень клёво я могу поэтому спокойно начать длительную задачу и допустим места она требует пристального присмотра передать его своему коллеге и спокойно заняться там за садик за детьми пойти ли спать лечь или что-то такое бывали такие случаи но сейчас их нету потому что в принципе когда 12 ну то есть приходит клиент горячий базу данных все плохо ты ему настроил по сути делают работу с гривцова д.б. ты настроил базу данных настроил некоторые из провел аудит наши узкие места починил эти узкие места и дальше принципе база данных работать без проблем не прогнозируемо то есть какой-то хаос может случиться при тепло и когда разработчики допустим у них нет нужного экспертизы спас гриссом и они ну по незнанию сделали какую-то дичь с базы данных но они обычно обучаются как бы один нам два раза сделать моим поможем быстро они даже понимаю что так не надо делать и как бы это все ну то есть это решается просто коммуникации внутри команды размером а мамы и квалификации да ну команда у нас небольшая на самом деле спасибо пожалуйста друзья еще вопросы отлично добрый день большое спасибо за доклад по скрыть пожалуйста по отчетам президентом каким образом вы пишете то есть иметь или когда форума либо несвобода варианте это у нас штука постоянно развивающейся поэтому как бы по инциденту получается там нужно три вещи первичные признаки то что там как бы пронаблюдал там мониторинговых письмам потом то что ты увидел но как бы как капнул и что там накопал и дальше уже решение проблемы то есть как бы первичные признаки потом более детальный разбор там какие еще проблемы нашел и дальше уже решения то есть вот три таких пунктов ну еще там дата этого инцидента бла за какая была там с каким профиль но это такая уже дополнительная информация вопрос на десерт вот отлично спасибо за доклад вопрос по инциденту номер четыре который здесь описывался когда большой insert отдали разработчика и сказали ну чё-то чинить большой инсульт может влиять на производительность ну собственно скорость ставки по многим причинам какую аналитику вы как депо проводите там наличие индексов лишних индексов потому что все это влияет нас нет а то там смотрите какая ситуация это insert как бы большой объем несколько мегабайт там просто по сети передача и база данных жанна не только выполним выполнении запроса на из нескольких частей царствовать получить запрос распарсить его построить план вставить сама вставка она миллисекунду а вот когда вы 2 мегабайт не запросы и даете распарсить это уже довольно трудное дело она может занимать большую часть времени или построить план у нас в сенсор там там нету построения планов выполнения как таковой там просто так вот распарсить большой объемный запрос ну реально несколько мегабайт это занимает время и поэтому они как бы стали сыпаться а как отловить нод по отчетам можно отловить то что время выполнения как бы запросы выросла тут я просто как бы таки эфемерные пример чеки привозил просто чтобы как бы показать как вот день проходит поэтому там дополнительно можно он возросшей нагрузки на диске да потому что мы стали стара записать и в базу и влоги вот то есть нагрузка возрастет как бы 2 мегабайта ежесекундно они бесследно не пройду хорошо спасибо я просто переживал за разработчиков что просто и течение дня мы ему рассказали что-то решит у тебя были коротенькие запросы они стали больше и они как бы поэтому стали валиться влоги давай выясним почему они у тебя встали больше ну там это реальная ситуация пример из реальной ситуации то есть у нас такая ситуация там просто приложение ходил на внешний сервис получая бинарные какие-то данные у тебя там хранит там сколько-то времени и просто внешне сервис начал там спамить дополнительную информацию там у них формат изменился разработчиков не предупредили вот и как бы вот так вот вышел разработчик дальше посмотрел и решил что вот этим не на даче и там допустим большие или просто давайте там не будем их писать но там уже зависит от логики бизнес хорошо спасибо так вот вопрос начал там спросить вы ребята не стесняйтесь докладчики приезжают не для того чтобы доклад вор считается знаний в на небольшой огонь мы поговорим о такой маленькую штуку просто ловите их вот там и как бы мучить вопрос а лучше всего на автопати кому книжку подарил вот там товарищ который 2 вопросы задавать сам первые вопросы задал человек питар да всё спасибо владимир тебе большое спасибо 3 этаже памятные призы"
}