{
  "video_id": "wMcWo2cT7Ck",
  "channel": "HighLoadChannel",
  "title": "Архитектура платежной системы: почти enterprise / Филипп Дельгядо",
  "views": 54596,
  "duration": 3246,
  "published": "2018-07-19T04:57:48-07:00",
  "text": "так ну давайте потихонечку буду начинать добрый день меня зовут ольга до филипп собственная уже третий год который год делаю платежную систему для российского легального букмекер ского бизнеса собственно по опыт в основном ошибки на некоторые достижение которые 3 вы были сегодня попытаюсь рассказать вот это мы делаем платежную систему мы это довольно маленькая команда 10 программистов из них в основном backend и только два человека на fontaine de четверо к ф и я ну и плюс там какой-то момент продуктов все так далее то есть три года мы делаем в нашей платежной системы из них два года уже в подарок шине сколько-то лет назад примерно рассказывал как сделать платежную систему за один год но с тех пор разумеется много что изменилось тем более рассказывая не здесь вообще по-хорошему то есть что у нас такой то есть маленькая команда денег в общем не очень много особенно в начале да и вообще пока команда маленькой денег не очень много вообще платежной системы это очень просто взять денежки приварить перевести записи с одной таблички вот в ту же самую табличка на к-минус в общем то и все реально так оно и есть платёжная система очень простая штука пока не пришли юристы платежной системы во всем мире облагаются огромным количеством всевозможных отягощения о том как именно правильно нужно переводить деньги с одной таблички в другую как именно взаимодействовать с пользователем что можно обещать чего им нельзя обещать за что отвечаем за что не отвечаем собственно поэтому приходится все время в разработке платежной системы балансировать на грани между enterprise им таким тяжелым и вполне нормальным мы ставим в приложением то есть что у нас от интер по разве что нас от больших корпораций ну во-первых мы работаем деньгами то есть у нас бухгалтерский учет вполне на полную у нас необходимо высокий уровень надежности высокие целый потому что простой не любят не мы не люди не пользователя и высокой ответственностью мы должны точно знать куда и какие деньги пользователи ушли что с ними в данный момент вообще происходит вот мы являемся нокаут из некоммерческой кредитные небанковской кредитной организации это почти банк ну на сале практически полностью банк только кредита не можем выдавать вот у нас отчетность при центробанком а сочетать вместе перед фильм мониторингом у нас много коллег собственно банковской части с банковским опытом и мы вынуждены взаимодействие с автоматической банковской системы те кто из них из вас значит это этот в общем понимают всю печаль и более этого процесса вот и разумеется у нас юристы вот тут только частях законы в которой регулируют поведение платежных систем в данный момент российской федерации чем каждый довольно сложно записать есть куча подзаконных актов реальных семейству истории использования как на самом деле все это выглядит со всем этим приходится работать при этом и кроме того что мы такой честный enterprise почти банк но при этом еще и вполне себе web компания у нас принципиально удобства пользователя потому что рынок высококонкурентный если мы не будем заботиться о нашем пользователи он от нас уйдет и денег у нас не будет совсем вот нам вынуждены делать часто и выкладки почти бизнес активно развивается и вот сейчас у нас там два-три раза в неделю идет выкладка платежной системы что в общем гораздо больше чем у некоторых крупных банков где говорят недавно наконец начали делать вас три месяца очень гордятся вот и минимальные там the market как только пришла какая-то идея нашла как можно быстрее и запустить в реальную жизнь посмотреть как это все выглядит желательно быстрее чем конкурента ну и у нас не очень много денег как в отличие от многих крупных банков взять и залить все деньгами нам не удается приходится как-то выкручиваться принимать какие-то решения вот как все это выглядит я бы + подогрев java потому что найти на рынке разработчиков примерно понимающих про надежность работы с базами данных в java несколько проще чем на других языках их просто там больше особенно санкт-петербурге пожгли реально я знаю три базы данных которым можно делать платежную систему но одна из них очень дорогая для второй мощность который деби тут можно найти поддержка но это не очень дешево для подвеса самый простой вариант найти по нормально в меня мою поддержку то есть обратиться вот коллегам который изрыта и в общем какие-то небольшие деньги вы можете вообще не думать о том что вас базы данных происходит вас все чистенько красивенько и гарантию на кто там сидит в зале вот немножко подлинно вот на это скорее для развлечения и для того чтобы смотреть в будущее пока этого сам как некоторые скриптовый язык внутренней плюс некоторые отдельные сервиса разумеется сервисной архитектура микро сервисами назвать от категорически нельзя микро сервис напоминает а то что проще приписать чем разбирать чем рефакторинг вот поэтому нас возьмётся не микро сервиса нормальный полноценный большие компоненты в редиска кэш англов для внутренних армов то есть базовый сайт видны массовому пользователю нас вообще начисто html + css минимум javascript и работает в общем час скрипта ну и понятное дело кафка ну и java использует продакшене в зале да но вот собственно тех кто то вы используете несколько слов каторга не буду активно рассказать что там внутри сами в общем знаете что мы как дела у нас разумеется сервис конечно я предпочел бы жить без сервисов баба один большой монолит там никаких проблем со связанности никакой проблемы совсе они раване им взял и написал вы уже никаких проблем но приходит требований безопасности у нас есть персональные данные в системе персональные данные должны храниться обрабатываться отдельно с отдельными правилами у нас есть карточная информация карточные данные они должны ведь тоже в отдельной части системы с соответствующими правилами 100 тысяч требований к аудиту каждого изменение кода поэтому она все должно жить отдельно приходится уже резать на компонента без требования надежности не хочется из за того что там какой-то шлюз каким-то из банков контрагентов почему-то поломался братья выкладывать платежную всего нику не дай бог там неправильно будет выкладка человеческий фактор все рухнет вот поэтому все равно приходится все делить на маленькие сервисы ну раз уж мы начинаем делить на 3 безопасности и надежности имеет смысл в отдельные сервиса выделять все то что требует собственного хранилища то есть когда какая-то часть база данных которые вообще не зависит от всех остальных но проще сделать отдельный сервис и не париться и главное для нас принцип выделения чего-то в отдельной семьи если можно придумать очевидный имя для этого самого сервиса то есть там processing или отчеты это более мне нормальное имя фигня которая работает с репликой базы данных и тоже плохой ими явно это не один сервиса либо несколько либо часть одного большого но вот собственно когда мы делим на сервис 4 требований нам совершенно достаточно для выделения разумеется у нас все еще остаются миком аналитики которые мы продолжаем резать потому что у них слишком много слов накапливается и слишком много имен для одного сервиса но это такой постоянно перманентный процесс так вот ну сами сервисы бегают через сенат писем по все теперь все так нормальный честно как любом в мире но только с наличием всевозможных полисе на ретро и на кэш чтобы можно было при падении сервиса тем не менее ждать пока он опять поднимется и в это время вся остальная система нормально работала поэтому нас там при времени перезапуска сервиса в несколько секунд в общем все высыпали запускаются без проблем что никто этого не замечает ну вот слева у нас как раз требования разделения на компонента такой совершенно нормальный интер правильный подход когда им их деле мне потому что нас прикольно и хочется чтоб все работали в отдельных на каком языке к вам хотят а просто потому что из требований безопасности надежности больше юридически ну такой enterprise style а собственно все остальное такой чисто выпуска этой джейс и никакого sopa никакого тяжелых методологий все вот быстренько простенько но немножко потолка отдельным компонентам которые мы используем кафка у нас это не очередь сообщение это только по сути дела транспортный уровень между сервисами с гарантия доставки и понятный нальешь всего стали зации то есть сервисов сервис б надо что-то перекинуть почте править в кафку из кафки сам заберет и покори не думать о все типа полисе по ретро и кэширования почту кавказа сильно упрощает сейчас мы пытаемся как можно больше приводить на кафка это точно такой понятный процесс что-то быстренько сделали потом перевели по-человечески вот но и кроме все прочего это резервный источник данных о всех наших операциях я конечно параноик поскольку paция работа способствует я видел в своей жизни как коммерческая база данных за кучу кучу денег некий момент начала писать фигню не только собственные файла базы данных на его все реплики и в backup и данный пришлось восстанавливать и залогов потому что это были данные о платежах и без этого компании пост оба вот на следующий могла спокойно уходить с рынка я не очень люблю вытаскивать эти данные залогов поэтому буду складывать с необходимую информацию в ту же кафку если вдруг у меня просят какая-нибудь невозможная ситуация пока не знаю откуда забирать резервные данные никак не связаны с хранилищем вообще для платежных систем иметь два независимых хранилища для данных это вчера стандартной вещь вот без нее жить просто страшно ну вот мне например вот блоге разработчиков разумеется система много разных ходе разработки мы собственно сейчас храним через кафку и дальше ганецкий house ну потому что так удобнее всего как из 20 пачек его но дешевле тем более заодно изучаем клик house бага полезно мониторинг сейчас у нас память и азагаров анной честно говоря я пометил сам очень недоволен в отличная над большей части присутствующих когда кто недоволен памяти о самом зале вот в чем проблема памяти вас требует памяти вас прекрасен когда вам надо собирать с как готовых стандартных компонент какие-то данные его скидка по нет очень много у нас довольно мало компонент нас 40 разных сервисов то есть примерно там порядка полутора сотен виртуалок ну на самом это не очень большое количество вот и когда и время мы хотим собирать в том числе в через prometheus и какой-то бизнес мониторинга в информацию типа там нагрузка количество платежей ведущих часть какой-то шлюз или там количество событий в какой-нибудь в нашей внутренней очереди для этого приходится писать довольно много кода на стороне клиента почему кот к сожалению не очень простой потому что приходится пользовать и вно разбираться разработчикам во внутреннем водите про метался и как именно что считает вот причем по металлу с нельзя использовать как честный when the rain that time series дебита есть пример чтобы я не могу взять сказать что вот есть событий начало пути к события конца платежей а это куда нибудь скинула там всякие прочие метрики он сам посчитает нет и вы должны на клиенте все нужные мне метрики заранее считать и не дай бог не надо какой-нибудь поменять это очередная выкладка вообще говорю продакшен компоненты что очень неудобно вот но и очень сложно делать интегрированной метрики то есть если не надо собрать метрику общую для некоторого количества сервисов ну например там пирсинг или времени отклика клиентам по всем серверам фронтэнда то честно говоря через помидор сделать это нереально вообще теоретически то есть я могу только делать какое-то непонятное средние суммирование уже на вне grove on и сам про митоз это сделать просто не может вот поэтому я всерьез думаю куда-нибудь уйти там может быть это агрегировать накатом на той же кафки из кафки отдавать уже в памяти вас готовы готовые метрики но вот покорить те у кого не очень много серверов мой момент для вас не является идеальным выходом вот и из вещей как я вообще буду рассказать несколько отдельных кейсов о том какие были у нас архитектурные вызовы как мы их решали чтобы вы хорошо что при этом было плохо по использование базы данных ну вообще платишь это довольно сложно вот это вот примерное описание столь контекста платежа то есть там множество кортежей списков кортежи кортежи списков каких-то параметров она постоит данные за бизнес-логики меняется то есть если это делать честно это будет много таблиц много связи между ними как следствие нужно уже сложной логикой миграции при добавлении колонки а в общем то в полисе напоминаю что даже просто добавление нового колонки может привести в некоторых специфических ситуациях потому что вас на долгое время данная табличка вообще не доступна то есть наса но это не та не настолько атомарный бесплатно операция как многие думают мы на это даже разочек наткнулись вот поэтому все это так и довольно неприятное грустно хочется все это избежать особенностью арма вот поэтому она сама все это выкидываем нафиг убираем все эти большие сложные существу джейсон просто потому что реально кроме как на севере приложения не где все это целиком не нужно то есть я вообще такой подход использую уже лет 10 и наконец радости вот на этом сам михайлова не заметил становится синим экстремум то по крайней мере общепризнанной практикой вчера будут как раз доклад говорящих что папе форму с вы при этом ничего не проиграете может быть даже временами выигрываете какие вообще основные практики работы когда у вас бизнес логика очень большие бизнес данные хранятся в базе данных джейсоне то вчера говорили о том как это производительность я расскажу как то сделать чтобы нечаянно не поставить себе ногу ну во первых сразу надо думать о возможных конфликтов то есть когда у вас была версия с одним набором полей данных выпустили новую версию где другой набор полей данных вам надо каким-то образом читать старджесс него преобразовывать удобный для вас там какой-то объект вот там позже в широком смысле этого слова для этого обычно нужно найти хороший сериале доктор до стерилизатор которым вы можете в явном виде сказать что пожалуйста вот это вот поле джейсона надо превратить в такой-то набор полей в каждом объекте эти вещи слизывать так то вот а если чего-то нет то заменить на над умолчанию значения по умолчанию так далее в джаве к счастью с такими с реализаторами проблем нету то есть это там мой любимый джексон вот и других языках на можете искать сами вот потом обязательно в базе данных надо хранить версию той самой структура которого пишите рядом с каждым полем где вас хранится джейсон должно быть еще одно поле где хранится версия в первое что нужно для чего вы выпустили новую версию вас появился новый структура данных чтобы не бесконечно поддерживать код понимание старой версии новый вы просто делаете skip миграции которые пробегают по всей базе находят всех старые версии структуры читает их записывать новом формате и вас там через какое-то довольно ограниченное время там от дней до недели зависит а сколько у вас данных мы снять вам показать что опять-таки в базе там максимум 1 2 3 4 различные версии данных и вы не паритесь поддержкой всего разнообразия что вас там за многие годы накопилось такое избавление себя от legacy избавление себя от технического долга у нас от скрипа этапе стали вот еще до того как у нас мы вышли на продакшн это вот у нас будущего reality разработки можно заранее писали скриппса versio нирования ну потому что вы куртка 24 на 7 изменить структуру базы данных сохранения всегда очень интересные развлечения для дальше по нему рассказывал ну и третье для подписи надо выбрать между честным 10б ну когда то в этом выборе еще был смысл то есть у нас а при расходится джейсон потому что мы начинали довольно давно напоминаю что джейсон это мы просто х нем есть по сути как текстовое поле и чтобы залезть куда нибудь внутрь нам его будет каждый раз по xid после соску эль по этому учил его внутрь в продакшне не лезть алис только в случае там каких-то поддержки лесу чьи-то бушу тинга есть inbi все аккуратненько разбирают внутри себя но не сохраняет оригинальное вид собственно джейсон файл когда мы например хотим входящих нам данные снаружи поступившим используем всегда джейсон нам сейчас не нужен но в данный момент судя по вашему доклада действительно по имеет смысл всегда использовать в снг и об этом уже не думать то есть там уже разница производителей со стола практически нулевой довольно простое чтение и запись следующий кейс вот как из простого сделать сочные и как веб становится энтерпрайза что-то вот был у нас на этапе еще понятно дело разработки до продакшена маленький простой сервис с данными карт ну есть номер карты которым разумеется и шифровали средствами пожгли со вот при этом теоретически руководитель эксплуатации мог наверно найти где-нибудь ключик этого шифрования найти что-нибудь узнать на моему вполне доверяли и поэтому особо не парились ногти в стендбай потому что сервис маленький при запускается быстро 35 секунд его всяко подождет поэтому зачем громоздить какую-то сложную кластерную систему потом мы начали проходить разумеется перед запуском аудит писать dss а вот и выяснилось что там есть довольно жесткие требования контроля доступа к данным котором случае нашего аудитора сводились к тому что не должны быть одного человека который может почесть вообще информацию из базы данных по нами это должна быть минимум несколько человек которые совместно должны как-то получать доступ вот плюс требуется регулярная смена ключей доступа не потому что нужно их менять а потом ну потому что тут их просто нужно регулярно менять плюс 50 с с требует что при любой обнаруженные уязвимости требовала и нужно обновлять собственно инфраструктуру вас как уязвимость в операционной системе находится довольно часто значит система надо тоже обновлять довольно часто так у нас понятно там services 100 строчек первоначальный обновлять его незачем потому что почти ничего не делает и не меняется годами у а то есть сначала мы представим доверять как водители эксплуатации и пытаемся придумать схему когда у нас нету одного человека который знает ключи ну логичным образом приходим к схеме шамира кто значит и такой схемы шамира это способ генерации ключа когда готовый ключ разбивается на несколько когда когда основание готового ключа генерится несколько ключей любое подмножество из которых может породить исходный ключ то есть например вы у вас есть какой-то длинные ключи вы разбиваете на 5 кусочков так чтобы любые три из них могли породить исходный почему раздаете эти там три вашим эксплуатации 2 храните в сейфе на всякий случай если кто-то заболеет попадет под в автобус и так далее так далее но и спокойно живете вот схема хаммера стандартной версии реализации почти нигде нету вообще потока км их этой схеме я могу как-нибудь скоро рассказать очень много рассматривали вариантов там с которыми ключами и к сожалению все они для это на в случае не подходят и часы вот понятно что у нас после этого появляется логика генерации смены ключей то есть генерация это отдельная virtual очка на который генерит этот ключ раздается админом отверточку убивается исходный ключ никто не может узнать потому что все это делается присутствует там из башни cove и изначально ключ + смена ключи то есть нас одновременно может быть два актуальных ключа в системе потому что один старый один новый часть данных зашифрованы старым и по садовой при шифровки со старого на новый вот плюс поскольку для того чтобы запустить компоненту требуется два или три человека это занимает уже не 30 секунд а несколько минут пусть им всем надо подсоеденить найти свой ключ его аккуратненько вести из них забрать готовый поэтому уже там простой будет начинает занимать несколько минут и приходится переходить на схему артефактов потому что нас должна быть одновременно всегда несколько экземпляров с таким образом простой очевидный сервис там несколько десятков строчек становится довольно сложной конструкции с логика из куста лизации с довольно сложными инструкциями запаса по вождению то есть так вот из нормального простого вы бы мы радостно пришли в enterprise action такое происходит довольно часто гораздо чаще чем хотелось бы мы тем более что топ-менеджмент посмотрев и бизнес посмотрев на все это дело сказал что он конечно хочет все данные на всякий случай шифровать примерно таким же образом и вот актив актив ему тоже всюду нравится давайте-ка вы можете быть сюда это сделаете что прямо скажем не всегда просто как наоборот и сложного сделать простое платеж и довольно срочно вот примерный набор стадии платежам далеко не все это мог шагов в процессе собственно перевода денег от пользователя к конечному контрагенту много зависимости от каких-то внешних сущность это примерная схема можете особенно не вчитываться вот то есть есть банки есть контрагента есть банковская система есть транзакции проводки и все это должно будет работать надежно главное в надежно это значит мы всегда знаем на чьей стороне деньги и что произошло если вот у нас вот сейчас все упало сковать деньги требовать они могут зависнуть любого из контрагентов главное чтобы не у нас вот если мы должны начинать у кого именно они зависли чтобы можно было с ним потом разобраться и что все это можно его подтвердить у кого какие есть мысли как можно реализовать подобную схему из большого количества шагов выкрикните с места если идеи правильно fsm начале у нас было разумеется fsm то есть нормальный стоит машина каждое событие обрабатывается в транзакции нам нужен надежный persistent поэтому все в транзакциях текущее состояние понятно дело тоже сохранился в суде сделали сами более-менее первая проблема у нас есть одновременно и событие то есть мы там обрабатываем события связанное там с концом платежа в это время приходит события от контрагента который нужно как-то тоже обработать то есть надо поэтому нас получаются какие-то блокировки по ресурсам потому что они происходят одновременно и но все части в начале буду на одной машине плюс у нас многие шаги имеют четкий тайм-аут типа мы не готовы ждать там больше чем 1 час по видео ответы пользователей вот его там данных на 3d сим они готовы ждать там больше суток еще что то мы не готовы ждать больше там минуты ответов от некоторых контрагентов то есть очень много таймаутов которые тоже нужно где-то хранить обрабатывать смотреть когда событие происходит они тоже иногда бывают одновременными все это реализовывалась через логику собстна блокировок внутри java машина почти базе данных это было делать очень нелегко вот такие таймеров опять-таки java машина но как следствие такой нормальный акте в стендбай плюс специальный логика восстановление контекстов и таймаутов у нас довольно маленькая нагрузка у нас там какие-то десятки сотни платежей в секунду там даже меньше сотни в случае вообще максимально потенциального пика но 10 платежей это у нас там несколько сотенных поясов в секунду ну то есть на самом деле очень небольшие нагрузки поэтому одной машины на почти всегда хватает вот все было замечательно но потребовался артефактов заметим не только из за того что давайте вы все зашифруйте и всюду будет использовать схему шамира вот появляются требования давайте мы выложим новую версию только там на 3 процента пользователей вот давайте у нас все таки нам нужно довольно часто менять то музыку потерял потому что он становится все более сложные все более развесистой и все больше появляется бизнес хотелок хочется ее выкладывать вообще без с нулевым настоем то есть даже 35 секунд как-то не очень удачно но и многие другие требования пришли что надо приходить на актив актив вот хранить блокировки распределенные это грустно вот делать таймер распределенный тоже грустным иначе смотри штука платеж это мой что событие которое надо столько последовательно обрабатывать это сложно изменяемое состоянии из этого делать параллельно кто узнал определения что нет там же звучало потише тактах до явно виде кто вообще значит аку акторы о как да тогда не буду рассказывать вот акта ровно модели акторов взяли много то есть реализация там прекрасные а.к. временами странный но прикольный вверх так гораздо менее используемый квазар они все замечательно у них всех есть ровно одна одна фундаментальная орех фонтана недостаток вот не только котором вы подумали у них недостаточно гарантия то есть ни один из них не гарантирует доставку сообщений между акторами ни один из них не грани там во всех из них проблемы с работы внутри стандартов транзакции в базе данных в общем и долгое дело на это смотрели думали не допилить ыль нам какую-нибудь а куда вменяемого состояния потом сделали су велосипед то есть очередь в подрезку или через select from детский блок кто значит такой select вам детский пакт то я расскажу все таки не так много вот то есть обработка событий в транзакции свои до покерные автоматы и официантки и все этот влезла в 1000 строчек кода 2 человека недели примерно на разработку две недели на тестирование доводки при этом многие наши внутренние потребности которые той же кино не реализуемо оказались реализуем плоский плохо это прекрасная штука в подписи на самой во всех базах данных кроме по моему mais quel а вот просто в пользуюсь она появилась последний для реализации очередей как это работает вот у нас есть две таблички табличка с нашими акторами flow и табличка событий для этих актеров собственно она связана как раз по колонке flow актеры все отсортированные по события отсортированные по ключу it все нормально пишем магический запрос то что выбираем самый первый событие в самом первом из flow указав то логического близкий плохо если никаких блокировок на табличке нету она работает ровно как нормальный ford то есть она берет и ставит блокировку на первую строчку которую мы выбрали все нормально классически запускаем второй раз второй раз она делает приди тоже самые пропускаю же заблокированной строчки до которой блокировка висит поэтому она выберет у меня первое событие во втором факторе в таком потоке вот 2 задачи вот и повесить него блокировку мы положим за это время мы закончили обработку 1 из них удалили его блокировка снялась потом следующий раз в если мы возим и опять поучим собственно опять получим второе событие надо тоже первое вы первым из актеров вот это все работает достаточно быстро и надежно то есть там на каком-то очень небольшом железе мы получаем порядка там тысячи подобных операций в секунду если каждый из них занимает там где-то по 10 миллисекунд вот это много раз тестировал пишется как вы видите буквально в 3 строчки плюс вокруг очень легко при делать всякие удобные вещи что мы кстати получаем с такой очереди у нас и строгой типизации сообщения на это мы делали джая у нас все сообщения традиционны то есть мы начнем транзакцию в ней что-то делаем с базы данных в ней посылаем куда-то сообщение в другие актеры после чего у нас там за акция откатывается и наше сообщение которое послали тоже будут не посланы потому что они в той же самой транзакции база данных у нас идет через нее что безумно удобно то есть ты можешь не думать там что надо что делать если надо не думать о посылке сообщения от меняющих предыдущие не думать о том что все сообщения пасовать пачкой только в конце обработки после коми то вообще многих вещах перестаешь думать ну плюс матом для удобно работы с контекстом вот не нужно думать о блокировках потому что вас все события обрабатываются последовательно собственно для чего и создана актах как таковые плюс мы добавили сложную политику обработки ошибок потому что 80 процентов логике платежа это на самом деле обработка возможных ошибок то есть пользователь куда-то ушел контрагента ответил какой-то фигней или там тем что пользователь нет денег или вообще контрагент не работает и надо выбрать другого там контрагента другой шлюз и так далее так далее там безумное количество разные сложные логике по обработке возможных ошибок ну и для нас это эффективно стоп у тебя в секунду примерно я получаю все замечательно мне это устраивает мы начали это делать начали внедрять получили простую машинку для реализации бизнес логики вообще но в основном бизнес уроки платежей вот но решили абсолютно ограничено применимость этой свой велосипед который можно применять очень мало где но главное что они очень жёсткие ограничения по коли по производительности то есть я вот коллегам из яндекс денег такой не посоветую потому что не бывает черной пятницы стоп а теперь секунду им явно мало у нас частью черной пятницы не бывает у нас очень конкретное рынок и поэтому очень спокойненько обойтись подобным решением и при этом такой при этом и такой совершенно спокойно свой велосипед из такой честный так правильный подход опыт собстна библиотеки нам не очень подходит мы не будем их допиливать мы сделаем свою все гладко было на бумаге но вот мы это внедрили запустили там у нас работает и тут приходит проблему упал один шлюзов ну шлюз это реализация патока взаимоотношения с кем-то из поставщиков денег ну pow pow это не проблема пользоваться ничего не заметили мы переключились на резервы и там другим контрагенту начали разбираться почему кончились сидение в публика на в пуля не понятно вроде бы там не такая большая нагрузка на нем была почему закончили соединение начинаем разбираться насколько агентство отвечать не за полсекунды как было до этого за одну минуту поскольку у нас обработка коммуникации то есть это некий шаг пути же происходит с транзакция то соответственно нас выстраивались все api запросы к нему это все как де раз транзакция которую долго ждут пока можно будет освободиться в летать коллекция заканчиваются такое нормальное поведение когда у вас очень много длинных транзакций вас почему-то соединение начинают заканчиваться начали думать что с этим делать самые первые можно увеличить число соединений к сожалению позволит и есть вполне вменяемые лимита на максимальное количество соединений на ядро и она не очень большое то есть там порядка там сотни наверно имеется потому что вы подали напоминаю каждое соединение это один процесс процесса все-таки совсем много десятки тысяч делать все таки ли сотни тысяч не получится а если нас там контрагенты начинает отвечать раз в минуту то там их может быть и больше можно попытаться сетевой вызов сделать асинхронным то есть каждый шаг разбить там как-то раз к нам нужно кого-то diagnosis контрагентов можно сохранить концерна сделать вызов сохранить там составе состоянии с контекстного базу данных вот получить от него ответ вам попадет на этот же актер мы поднимем состояний из базы данных сделаем что-нибудь но при этом у нас дико увеличивается количество шагов пути же и в наше требование бизнеса выступать и же в секунды мы уже не влезаем потому что у нас там получается что на наш примерно лимитом в 1000 2000 запроса в секунду на базу данных у нас каждый платеж стоит и сотни шагов и вот уже становится грустно что делать остается только только управлять гарантиями сохранение нам не всегда нужно жестко этом законность но мне всегда нужно жестко восстановление там при том в сетевом вызове мы почти всегда можем оба повторить поэтому нам нужно не все умеет делать через базу данных какие-то вещи надо уметь делать в обход база данных под транзакций вот к сожалению стандарта решение которое позволяет тонко управляет гарантии мы сохранили для конкретного события для конкретной ситуации нету сейчас собственно его пытаюсь писать но честно реализации реализовать apple оптом на каком-нибудь родись иного оказывается довольно нетривиальной задачей вот я думаю себя все это сделал я как-нибудь поэту расскажу это вот как раз у нас тут прямо сейчас идет работа собственный вывод если вас системе где-то появились фактор они рано или поздно поползут всюду в этом надо изначально если думать у нас будет так ты в отдельном кусочке производительности нам хватает это не так у вас в конечном итоге через год разработки выяснится что все хотят их использовать там где надо и там где не очень надо и они бывают всюду то есть под будьте готовы при включении actor на модели куда нибудь попробуем попробовать не удастся вот следующий кейс у нас платежная система то есть деньги деньги любят когда их считают поэтому очень быстро к нам пришел бизнес просьба давайте вы сделаете нам bio систему данных у нас не очень много какие-то сотни гигабайт нужно но только по сути дела топ-менеджментом то есть у нас не такая большая компании аналитиков потому в количестве сотен у нас не наличествует вот но и главное надо делать быстро и дешево ну быстро и дешево берем powerball это microsoft of sky решение то есть система генерит нужные данные видео со счётчика с вышки загружаются в облако из облака загружается в power bi и дешево быстро просто сделано на коленке там буквально без привлечения программистов почти совсем там отчетом написать все свои что это несложно но оказалось что дешево это если у нас мало данных и быстро если мало данных как только у нас объем данных превысил и гигабайт один гигабайт выяснилось что и обрабатывается довольно долго а главная некий момент microsoft изменил у спали условия использования сервиса и он стал очень платным как раз примерно 100 начиная с размером в 1 гигабайт и выяснил что вот это нам уже несколько не pakman по штатам реально очень платным начиная с больших объемов пошли смотреть что можно сделать но первая мысль у ракли house модно прикольно давайте сделаем там всем этим из кидаемся наши события в кафку кафка потом их перегружает crack house or не кликал сюда их вытаскивает вот учатся круто модно хайповой аналитика должна работать быстро все должно быть бесплатно вообще все прекрасно и замечательно и так далее но сколько услады где-то показывать клик house и нормально работает на данный момент звучу всех рядах сделали тестовый векторе дальше показали бизнес все сказали что они с этим работать не будут почти выглядит она мягко говоря уродливо вот и в общем некоторых милых бизнесу вещей типа там deep дэрил и так далее там просто нету грустненько начали расти то о чем вообще мечтает бизнес бизнес мечтает о чем-нибудь и потом табло где все красиво вот ну и например то там овощи светодиод с вертикаль и получайте прекрасная пойди системность мы все кидаем в каску сказки перекидывая верте q вертик работает быстро качественно надежно просто тобой сервы все это показывает красиво быстрый но стоимость лицензии верти ки официально не сообщается но мягко говоря не дешевая того в общем тоже не очень дешевый но выяснилось что на наших объемов все это на само дерево потому что до 1 терабайта vertica халявная кабинете edition и нас она абсолютно устраивает до терабайта нам еще далеко а поскольку нам нужна лицензия на то вот только по сути дела на одного разработчика и на небольшое количество топ-менеджеров это тоже стоит какие-то решения и копейки то есть это того что нам нужно было меньше чем минимальный пакет который продает тобол такое нормальное совершенно классическая такой тяжелый то правильное решение но верьте к с тобой там в сбербанке напомним используются и в подобных местах выяснил что для нас является чем нормальное выборгским решением она практически бесплатно ну там с реально копейки какие-то ставится вообще вот с нуля не задумываясь и версии к меня очень радует то есть немногие именно литические вещи решаются очень красиво то есть пока если у вас не очень много данных очень советую вот при этом я четко понимаю что если мы там час 35 лет перейдем на вырастим предела литра байта то к этому времени у нас как раз уже будет нормально экспертиза полевых клик хаоса если не умрет к тому времени того к этому времени явно по сделают адаптер к тому же клик house и мы аккуратненько перепал земной бесплатно crack house ну за какое то вполне разумное время поскольку в общем запросов сюда примерно одинаковое следующий кейс у нас довольно много контента то есть нас есть юридическая информация котором мы обязаны предоставлять всякие эффекты так далее у нас информации о контрагентах включая в том числе комиссии который мы берем с пользователь есть инструкция для пользователя есть собственный маленький блог есть информация об ошибках и прочее прочее прочее вот ошибка в этой информации довольно болезненно почти если мы на первые уже не те комиссии которым реально взимаем пользователи потом могут очень сильно на нас обидится годы нас могут обидеться на еще органы что гораздо грустнее по этому тексту на нас и тот же код нужно проверять его при публикации в его подготовке за действенно много людей ошибки дорого стоит в начале у нас текст бы просто частью нормальной fontaine да то есть у нас все тексты вверх стали северсталь щеками контейнерами потом это все шел в тестировании вычитывал ась показывалась на тема стенде потом уже шов production но текст меняется слишком часто и так делать было просто дорого и мы начали думать как бы все это автоматизировать как бы сделать cms q ну просто и cms не подходит потому что там сложно и с разделением тестовой среды продакшен и непонятно как вообще тестировать текст там сложно работать большому количеству пользователей сажень интегрировать все это с большой джалла системой не хочется непростые cms слишком дорогие во всех смыслах то есть они не стоит обычно большого денег их интеграция весьма не очевидно потому что там на придумано много всего идеальным решением был бы поставить у всех кто работы с текстами просто банальный guide вот пусть они все тексты пишут китом вот но мысль поставить гид там топ-менеджерами научить их пользоваться безопасным и копирайтером мы про нее подумали подумали в ужасе отказались потому что все таки гид пока не для нормальных людей вот сам идеальным решением было бы наверно редактор текста встроены прямо в итоге идею где в общем можно сложность гита аккуратненько скрыть на колени до сих пор его не сделали хотя давно им просил какой-нибудь markup едет так с кучей фенечек и внутренних связей что можно было дождь энергии рить ну пришлось сделать велосипед то есть очень простой редактор текста простой редактор html потому что вместо сложного редактор текста проще попросить нашего же fontaine диван описать все вышить имели нового но при этом выкладывать через систему cms через систему контроля простая концепция версии то есть пакеты изменений публикации идет целиком пакетами а становления восстановление всего контента сразу просто по одной кнопочки то есть нас вот и нормальный очень простой wakfu работы с текстами вот и разумеется категорический запрет то есть мысли просто нет такой кнопочки что-нибудь изменить прямо на продакшен все можно изменить только там через задача у двери вот дальше она попадает в тестовую версию из тестовой версии отдельно обычно люди умеет все что не увидел только приносить готовые пакеты с тестовой версии на продакшен после того как получена все подтверждения честно говоря если бы пришлось все это писать такой нормальный по сути дела my cup of танчик такой интерфейс стал если бы мог такое купить я предпочел бы это честно говоря купить но ни одной системы мвд cms дам для больших систем я просто не нашел на рынке по-моему до сих пор нету я честного реже который подпишу ее с нуля и очень жалко что до сих пор никто это не сделал за меня в общем если кому нечем заняться можете написать могу высказать кучу разных кейсов основной главный кейсы там нога польская работа с данными и четко отделение продакшена тестовых средств возможность публикации различных версий вот и в идеале привязки вверх по цеху выкладки и того что из всего этого можно сказать что жить на грани на самой довольно интересно когда вас задача одновременны ивановские и энтерпрайзе и можно много заимствовать разные идеи из мира корпорации из мира энтерпрайза у них довольно много вменяемых вещи продумано иногда можно заимствовать решение типа как vertica если они дешевые ну честно я нашел дешевую поддержку дебюту я бы честно вообще сидел бы на дебит уж нам стойки я ее очень люблю она очень дешевая надежно но вот найти дебюту поддержку за разумные деньги в россии сложно конечно можно ковать переманить почты россии но они привыкли настолько большим машинам вот что мы явно для них слишком мелкие ну и большие проблемы из мира энтерпрайза как раз можно решать совершенно выборгским стилем довольно просто чем стали занимаемся вот архитектура понять экономически не бывает хорошей архитектура вообще бывают архитектура который более-менее васу для тварей в данный конкретный момент времени вот время меняется архитектура меняется и надо постоянно быть готовым что она меняется это всегда в нее вкладывать вот поэтому ну и давай сколь это реально круто вот если вы умеете готовить вот мы это умеем готовить поэтому у нас все получается очень просто быстро не напряжена и в общем очень небольшой командой мы делаем довольно сложные вещи вопросам спасибо за доклад единственное что не услышал это методика для расчета балансов да то есть системе есть и у клиентов его поставщиков услуг правильно плюс какие-то динамические изменения то есть там поставили одну комиссию поняли что она не то надо пересчитать ему на это осуществляется но смотрите с балансом там разумеется ум ищет то есть там есть баланс считается много сразу где бухгалтерский баланс разумеется сводится vbs по итогам дня как во всех банках и положено разумеется кидайте конца дня для того чтобы считать баланс там для у контрагента мы не можем поэтому мы все это каширу ему себя сейчас это все делается ну есть набор проводок то есть каждый платеж в конце формирует набор соответствующих проводок вот эти проводки частично пишется в базу данных при этом разумеется мы сразу не обновляем размер счет а потому что тогда бы мы в лес влип влезли бы в блокировки у нас есть по кашированные значение остатка по основным контрагентам при каждом запросе мы смотрим не давал если что-нибудь новое в историю по этой операции с момента последней учи учтенной и если там их добавилось много то их всех своим суммируем очищаем кусок истории сохраняем если их там мало то просто аккуратненько прибавляем но я могу пропускать стандартная схема что делать если вам нужна очень часто менять остаток на одном счете и вы не хотите попадать на блокировки по базе данных реально вы храните там всегда какое-то промежуточное решение плюс до какого момента у вас все посчитано оставляя делаете маленьким select am суммированием во всем транзакциям позже чем после вот плюс разумеется у нас отдельно есть довольно сложная работа с лимитами то есть начали как ты операции мы должны посчитать кучу лимитов по пользователям мы считаем динамически по каждому пользователю храним разумеется в базе данных частично но на время исполнения иногда что-то копируем в одессе но тут в общем то нет никакой магии все очень просто ну то есть редиска кэш база данных как persistent хранилища вот в офисе потерять что-то обновляется с комиссиями комиссии не могут меняться легко комиссии не меняется распоряжением директора председатель правления банка отдельным приказом с юридическим оформлением вот где взять быстро поменять комиссию и попробовать это для тех кто работает в рамках российского правового поля довольно дорогая операция поэтому ситуации поменяли вернули обратно ну у нас можно так сделать но мы так не делаем технологически это делается через понятный диларам операционного отдела которая берет и меняет соответствующие цифры кино там это все попадает аудит сразу из башни спрашивает какой был номер приказа но и так далее так далее так далее то есть там довольно много контроля по этому поводу собственно sunglove используется именно для рабочих мест сотрудников потому что в каком-то смысле обеспечение потребностей внутренних сотрудников и зачастую требует больше ресурсов чем собственно проведении платежа и требования клиентов то есть ошибок каких-то ни разу не была не та щетки агафен у вас имеется у нас есть скрипт который умеет пересчитывать даже не ошибки бывают контрагенты у которых комиссии зависит от результатов месяца работы с ними ну тогда у нас специальный скрипт который берет делать стороне дующий проводки по за весь месяц но нельзя заменять задним числом банковский учет но стороне ваще проводки разумеется то есть пасе антов немного вопрос вы сказали парковку да как долго вы храните данные в кафки и логики сохраняйте какой объем маленький объем потому что нас никто мы три дня храним то есть у нас все равно в конечном итоге попадает в база данных и кафка меня интересует нас уже там тотального падения либо пока не пока мы не разберем это очередь пока трех дней нам более чем хватает реально там больше часто ничего не задерживается объем не знаю гигабайт какие-то гигабайт то есть там даже там сотни гигабайт не наберется то есть довольно маленькие вот там буковка у нас используется очень так для нее очень вольготно то есть настолько далеко до каких-то пределов производительности чтобы это даже не хочется рассказывать вообще конечно вот с точки зрения меня как архитектор идеальная технология то который ничего рассказывать на hail audi вот то есть вот в этом случае там кафка для нас идеально технология не знаю что они можно высказать hallowed власти каких нет проблем или там увидишь поэтому иногда думай что вот какой-то хайпа как технологии все начинает доклада делать и чем больше доходов тем больше сомнения стоит ли использовать почти следи пони рассказать что у них какая-то боль я не хочу этой боли вот интересно технологии то рассказали один раз и все и вот а потом просто используют вот радиус например ну что рассказывать paradise конце концов каждый год на хайло будет ничего здравствуйте я вот здесь хотел задать такой вопрос наша компания занимается изучением различных блокчейн технологии в качестве вот я изучал ripple вы слышали были технологию или нет но я про букчин понятный делу слышал про конкретную нет ну ка нам разумеется в некий момент приходили люди из бизнеса типа давайте будем использовать блокчейн это модные молодежно вот мы не смогли придумать ни одного кейса в реальной ситуации когда это имеет смысл ну просто потому что нам не консенсус для банковской системы проще сделать по другому то есть решение блокчейна вы проще сделать другими способами решать те же самые проблемы я знаю какие-то теоретические возможности где было бы интересно что-то типа блокчейна но пока непонятно как-то реализовать но очень не хочется верить воздух все блокчейн технологии предполагать что у меня очень много энергии уходит тепло понимаете дело в том что ripple как бы он уже интегрирован с многими банками в мире и позволяет делать переводы там в течение секунд понимаете мы работаем извините пашу очень и все равно мы пребывали между банками обязана девочки центробанк россии просто по законодательству вполне конкретным описанным в российском бухгалтерском учете методом блокчейна там нету вот на данный момент я же центра момент внедрение toyota сандра банк выдает нам напишет инструкцию об использовании блокчейн в миг банковских переводов и мы поймем что это нам экономит какие-то усилия разумеется материализуем ну чё там делать-то что центробанк не сбербанк но там у нас многие идет вообще через расчетный счет на центробанке взаимодействием plugin to me но пока у нас нет эти проблемы но у нас не так много тех проводок ты интегрированных за сутки с другими банками это платежной системы это не яндекс деньги у которых там несколько десятков тысяч наверно контрагентов и если правильно поручни самая большая время было 1с в россии по количеству операций у нас гораздо меньше контрагентов поэтому нас такой проблемы нет спасибо zdravstvuite спасибо большое за доклад очень интересно и здесь здесь вы рассказывали про криптографической решение уточните пожалуйста попадаете ли вы под какие-то требования со стороны банка россии но использование готовые криптографии и попадаете ли вы под требования банка россии я точно сейчас не вспомню там есть нормативные документы о хранении данных в течение определенного времени резервного копирования предоставление резервных копий тогда надо и как вы это решаете с учетом того что у вас на некий веб но к сожалению на сером заметим и подпадаем по все требования по хранение персональных данных подпадаем почти на полную катушку смысла ты хочешь немного но к счастью мы не для них они вероисповедания и прочих особенных тонкостей то есть мы там почти по самым максимуму ну отдельный instance в которой там есть доступ снаружи только через гостов ска и шифрование то есть пришлось покупать континенты контрагентов заставлять покупать континенты ну и начни как разумеется там никакой схемы шамира использовать нельзя потому что не хочется получить сертификацию перекатную разработку средств криптографии это сложно и дорого но 50s с к счастью и вообще сохранение panov центр таким образом не регулируется и поэтому вынуждены были отдельный сервер сделать вы заметили писей dss а отдельную зону внутри нашей сети который собственный проект их требованиям и у нас эти вещи просто не пересекаются все на разные части системы но это вот как раз и говорил что требуется иногда из требований безопасности хранить создавать разные сервис там где можно было бы обойтись одним персональный дано вообще очень интересная штука то есть это конечно такой доход не холодный но количество развлечений с работы с персональными данными в том числе сам с прекрасными базами данных потенциальных террористов и виновных в отмывании денег финансирование терроризма который в мягко говоря в странном формате приходят и который надо очень активно работает отдельную историю кому интересно могу порассказывать вот мы попытались купить готовые решения выяснил что проще сделать самим спасибо вообще под аудит безопасности банка россии вы подпадаете потом по стандарту bs то я не знаю как это работает но собственно то есть они отслеживают эти процедуры вот они знают все что у нас происходит пока они меня не просили что-то конкретно изменить кроме того что я так знаю поскольку в общем тоже опыт не первый раз делаю отпуску платежную систему вот не были меня в курсе поэтому пока идет специальных требований новых от них не приходил то есть старые текстуры которые вот сейчас есть он не устраивает всех и контролируешь спасибо здесь и вот там вот мальчик давно просил все выкладки но у меня нету микрофона потом я потом я бы тоже мегафон передайте просто да я справа внизу спасибо за доклад вопрос следующего рода я не видел презентации ничего касательно анти фродо мошенничество если вас что не такой как вы это делаете у нас к счастью то есть очень много про это думали вот но после тщательного анализа именно наш бизнес кейсов вы знал что на данный момент у нас риски понтифф воду строго равна нулю но потому что нас нет пир toupper платежей у нас некой специфика именно конкретно нашей платежной системы то есть не вообще любых именно у нас бизнес-процессы выстроены так что на данный момент сложный анти фрод нам не нужен есть требование там контроля поведения приходящими как раз от финн мониторинга им их реализуем то есть там типа если там кто-то был похож на террориста то дальше нельзя поезда слышать пользоваться теми же платежами ну там свои тонкости есть но они реализуют достаточно просто без специальных каких-то сложных нейронных сетей и прочего прочего прочего но нам все это предстоит конечно вот будем делать там много вариантов вот я хочу поэта помню почитать и нас уже делал ох столько вопросов и это из с подозревает что у вас также железки охраняются то есть как организована у вас то есть свои железки либо какой-то обычный провайдер совместимость cialis из нас разумеется никаких облачных провайдеров потому что в россии облачных провайдеров когда мы это начинали еще не было ни российские нам не подходят по российскому законодательству вот поэтому к сожалению у нас нет 1 2 это центра соединенных оптоволокном в питере вот который 50 сертифицированы поэтому там собственно есть железные комнаты и все размещена в них железки наши просто на документах судьба-то кладу прям сразу строится что это acab resistance всм и так далее zepter с куча куча всего вот модных слов почему отказались от ван сортинга и соответственно такие как фреймворк потому что по-моему подходит идеально принятия внимательно посмотрел на актах persistent вот посмотрел на кот посмотрел на то как это катя прикручивается и сказал что нет потому что это было там сколько-то лет назад она более того вакидзаси станет гарантией доставки сообщений между нотами нет внутри одной ноты есть ну вот нас уже интересовал актив актив то есть между нодами ну и плюс на самом деле доработки допил кимаки нам обошлись бы дороже чем текущий велосипед ну и надо понимать что архитектура сделать динамическое когда мы все это писали я не думаю про акторы я думаю по очереди produto гряды почему только я не думаю в каких только концепция платежи не рассматривал то есть то что это актара это не такое это результат длительных экспериментов которые разумеется отражались в архитектуре и в общем то что это надо было делать actor на систему наверно если бы сейчас делал с нуля я бы сделала вторую систему там добавив в какую тягу подложив и из последней кафка где появились транзакции для сообщений и каким-нибудь образом сделал пенсов но опять-таки я подозреваешь нашу текущую версию довести до этого ума буста не будет проще выше давайте много смотришь лень и минусов там проблемы из типизации нормально взяла скакки сообщений там и проблемы не очень удобно делать и традиционность там делать криво и сложно и неудобно поэтому вот 1000 строчек 2 человека месяц работы это настолько маленькая цена за решение которое вы можете дорабатывать как угодно не глядя ни на кого что я в общем считаю что это случай когда за ключевую часть вашей логике отвечает ваш собственный велосипед нормально это ключевая часть нашего бизнеса мы за нее отвечаем что процент а сами и наверно после вопрос а что с базами вы садитесь и элиас один большой мастер нет у нас несколько баз там порядка десятка собственно каждый сервис большой примерно одна база нам хватом с дочка нам хватает ее то есть sharding там просто не нужен то есть понятно что рассматривается как только у нас появится необходимость на реально сейчас нет тем более что все данные двигаем разумеется от сразу выкидываем собственных бейлиш не нам ходить не нужно поэтому никаких особых проблем я не вижу то есть с нашим максимальным пределом по рынку ну вот у нас не будет черной пятницы а для всего остального может обойтись beach or king добрый день распаковки вы думали о том как вы будете масштабироваться пределы одной площадке с кафкой и второй вопрос какая глубина хранение у вас данных кафки но я уже говорил что в кафки три дня у нас она масштабе но нас не масштабирования репликации на 2 до центра уже сейчас есть конечно вот масштабирование как таковой по кафке нам не нужно мы настолько на настолько с запасом хватает 1 инстанции что да мне нужно customization кроме как для высокой безопасности а такой операционной орех как исчезновение рядом кидать центра вы рассматриваете ну да разумеется но это как раз сказки с этим все нормально то есть там она стоит собственно там 3 пиво на специально в третьем дата-центре площадка связанное с этим связаны с двумя разными способами чтобы все диша через один канал для того чтобы когда свет от следовать блогов кафки это стандартное решение разумеется по него мы думаем это довольно большая проблема найти третью точку связаны разными к нам с двумя нужными дата центрами она не всегда очевидно решается иногда 10 что вы думали что разным оставлялись его найдут через одно в одном месте где-нибудь но приходится решать вот тут не говорит что время уже заканчивается в общем вопросы в кулуарах 1 ч 5 минут раз не все вот ну тогда если есть вопросы я в общем на конференц сегодня весь день можете подходить"
}