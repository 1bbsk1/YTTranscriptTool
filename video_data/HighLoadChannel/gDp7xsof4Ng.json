{
  "video_id": "gDp7xsof4Ng",
  "channel": "HighLoadChannel",
  "title": "Производительность WebGL-приложений / Кирилл Дмитренко (Яндекс)",
  "views": 470,
  "duration": 1788,
  "published": "2017-04-10T02:52:53-07:00",
  "text": "так давайте продолжим всем привет меня зовут янка последние четыре с половиной года своей жизни работу в яндексе пырнет разработчикам и все это время меня преследуют панорамы когда я пришел в компанию я делал визируется для панорам после этого я решил задачи по панораму на больших яндекс картах недавно сделал в плеер панорамно canvas 2d и чем ну его джел и сегодня я хочу поговорить с вами его производительности у джилл приложение для начала мы посмотрим что же такое джейл после этого мы обсудим как можно измерять производительность угол приложение и закончим обсуждение которых оптимизации в приложении и того как мне удалось применить в плеере панорам так что же такого джилл jill это и пей который дает в платформе доступ к ресурсам графической карты то есть он позволяет рисовать аппарату ускоренную графику том числе трехмерный аппаратно ускоренных графику прямо в браузере прямо из вашего скрипта структуру в приложении в некотором смысле можно сравнить с тем как наши предки видели вселенную ну покрайней с одним из таких видений то есть это некий такой мир который опирается на слонов и тех свой через стоят на большой черепахи и в этой картине миром будет наше приложение в котором вся логика весь смысл так сказать все происходит как и всегда в мире и наше приложение будет опираться на три основных вида ресурсов бюджет это буфер и такие большие блоки байт куда мы укладываем наша geometry которые мы хотим показывать пользователю наши модели это текстура это картинки которые мы хотим накладывать на наши модели чтобы не увидели красивее естественнее были похожи на объекты реального мира и шейдеры это небольшие программы которые запускаются прямо на джипе и рассказывают о том как мы хотим показывать нашу геометрию как мы хотим на нее накладывать накладывать наши текстуры и так далее и все эти ресурсы они живут рождаются и умирают в рамках jal контекста джо контекст такая большая черепаха в нашей картине жизнью мы получаем доступ как раз ко всем ресурсам мы их создаем и кроме того в нём ещё есть большое состояние которое рассказывает о том как мы связываем эти ресурсы между собой как мы связываем месте буфера и шейдеры текстуры и как мы используем результаты вычисления шейдеров то есть большой сцене который влияет на рендеринг ну и конечно круто бы чтобы наше приложение работало быстро побыстрее но перед тем как говорить об оптимизация сначала нужно научиться измерять а невозможно улучшить то что мы не можем измерить и самым простым инструментом которые позволяют нам это делать является счетчик кадров в секунду он доступен кроме его несложно сделать самому из не в общем все вроде бы понятно то есть если у нас много кадров в секунду то это хорошо мало кадров плохо но надо помнить одну тонкость что фпс в приложении он ограничен ограничить что ты обновления экрана пользователя до в большинства пользователи в дикой природе это 60 герц и 60 кадров в секунду и поэтому неважно guilherme либо наш кадр за 5 миллисекунд или за десять миллисекунд всегда больше десятка драфта есть как бы щечку выручку надо относиться с определенной толика и скепсиса но все-таки если у нас мало кадра в секунду приложения тормозит мы начинаем искать ним узкие места мы начинаем путаться и оптимизировать и я обычно таких случаях думаю каковы включая профайлер начиная профилировать приложение смотреть в каких функциях мой java script роет больше всего времени рассматривать эти функции под микроскопом и пытаться что-то с ними делать однако в случае с джилл приложениями профайлер сталкивается с проблемой дело в том что в жалобе она частично синхронная то есть все вызовы отрисовки они синхронные некоторые другие вызваны тоже синхронное что это значит например с визами отрисовки что когда вызов вернул управление наши java script that i saw к этому моменту не закончилась она закончится когда-то позже более того она может начаться даже позже чем навернулась управление то есть что делат вызов рисовки он генерирует какую-то команду складывает их в буфер и и возвращается к там где говорит вперед дальше секса в профайле такие вызывание на верх не вылезут да и если у нас тормозит прессовка мы этого не увидим но не все так плохо некоторые вызова не все таки синхронная и перескочил да и некоторые вызова не только синхронно и они еще и зловредным образом синхронизирует наш весь контекст то есть и не только выполняют работу которую мы на их возложили синхронно они еще и блокируя наше приложение при этом дожидаются конца исполнение всех задач которые возложили на контекст до этого то есть тех 340 всех каких-то изменений состояние и так далее и вот как раз таки и проблемы профайлы нам поможет отловить отрисовка нам поможет помочь другой инструмент который называется режим таймер клэри это расширение для jail она еще жутко экспериментальная то есть это еще драфт расширения она пока доступна только но мне удалось его за стоит только в chrome canary самым последним за флагом причем только на моем компьютере почему-то она позволяет нам как раз измерять время исполнения наших команд на джипе you при этом что очень круто она это делает асинхронно то есть оно не синхронизирует наш контекст каким-то личным образом она не добавляет много runtime оверхедов то есть весь код который мы напишем для измерения производительности приложения можно будет шипеть прямо в продакшн прямо пользователям и например собирать статистику или что еще лучше на основании этих данных на самом этих измерений подстраивать качество картинки под оборудование пользователя то есть на смартфонах показывать пользователям одну картинку на планшетах более качественно page там обычно мощнее железо а на десктопах там где бывает совсем мощное железо показывать самую крутую картинку с самыми крутыми эффектами но при этом как уже колонна писать какой-то код вокруг этого это такой небольшой минус 9 мир клэри как я уже сказал она позволяет исполнить время исполнение одного или нескольких вызовов прямо на джипе you ищем позволяет ставить точные временные метки в конвейере то есть она позволяет например измерить сколько времени наши команды джел идут от нашего java script а г б ю то есть какие-то задержки в конвейере давайте посмотрим мультики сожалений живые демки завести не удалось я взял выведешь ки и они не работают друзья теле слайды меня включили можно ли это исправить быстро что я точно сегодня приносил правильно повыше да так лучше давайте пока там вадим быстро проверяет я чуть-чуть раскрою ещё прадед на миг верим то есть это как раз асинхронный pain он позволяет создавать объекты каире к к драйверу к реализации в jail который как раз позволяют тысяч забег так вере идиотским работу вы создаете объект кайри говорить нет я хочу измерить поставить на этом объекте точную временную метку или поставить на нем или начать much него измеряет время исполнении группы команд после этого построим заканчивать и по стране кадры обычно следующий кадр про возможно позже вам становится доступным результаты измерения в на на секундах довольно точные при этом и как раз эти измерения можно использовать получается ли починить мои слайды ребят скажите мне что-нибудь не получается давайте я пока это дема пропущу продолжу вот вот на собственно давайте подведем краткие выводы по измерения у нас есть счетчик кадров в секунду как я к качестве характеристика приложение которое позволяет нам сказать о том тормозим и или нет и если мы тормозим то профайлер java script она поможет с поиском узких мест насыпью в нашем java скриптов какой-то математики каком-то поддерживающим кори держать таймер клэри поможет нам с поиском узких мест на джипе you окей мы научились измерять производительность мы научились искать и узкие места теперь надо понять что делать с ними дальше здесь мы обсудим лишь некоторые оптимизации гораздо больше графика компьютерные вообще такая большая область хаков обманов и оптимизации странных мы обсудим лишь некоторые общие оптимизации только кейт применил плеере панорам и первое правило которое нужно взять на вооружение на пути к быстрому жил приложению это аккуратно работать обжал состоянием как и сказал сам начале в вокзал контексте есть большой кусок состояние которое влияет на рендеринг и работа с ним нужно аккуратно в частности нужно не делать вызовов get rid то есть вызов который запрашивает текущее состояние контекста и читают данная видеокарта если нам это крайне необходимо почему то что эти вызовы мало того что синхронно они еще могут вызвать синхронизацию всего контекста тем самым затормозив наше приложение частности метод гитлера который проверяет не возникло ли у нас ошибка в работе чтобы жил контекстом его стоит вызывать только девелопменте никогда в разработке но нужно конечно минимизировать приключение состояния не делать это слишком часто потому что каждое переключение нам чего-то стоит трубочки тоже может вызывать синхронизация контекстов полезно какой-то работа ну вообще говорите делает как это может выглядеть нашем коде части как может выглядеть как то так то есть вложены друг друга циклы где внешних циклах мы переключаем более дорогие состояния почему приучаем их реже а в более в вложенных циклов мы переключаем состояние которое переключать дешевле час например попечение from буферов или приключение шейдерных программа довольно дорогие переключения они практически гарантированно вызовут синхронизации ну и вообще проходит довольно долго а переключение текстурных у текстуры и вообще параметров шейдеров они быстрее их можно делать почаще но и в этом замечательным в этой замечательно конструкции можно оптимизироваться дальше можно все сломалось можно сделать поменьше вузов отрисовки и побольше работы за каждой то есть каждый вызов прессовки он добавляет какой то вверх от на валидации состояния на отправку этих данных на видеокарту и хорошо бы ты то вверх от разбивать размахе можно лишь одним способом то есть в дело этих вызовов поменьше то есть подвале бы поменьше оверхедов и при этом делая побольше работы за каждый вызов в частности можно уложить несколько объектов несколько моделей которые мы хотим нарисовать в один буфер с данными а если они используют текстур это все эти текстуры уложить в одну большую картинку который обычно зовут текстурным атласом и таким образом приема несколько объектов к тому что для не будет требоваться одинаковое состояние для отрисовки и мы сможем рисовать их за один вызов и в частности есть такой хороший техника называется instansing который раз позволяет рисовать несколько копий одного и того же объекта с разными параметрами за один вызов подчинись интерес у меня дымке делаем ставки не подчинились если какие-то не выходит каменный цветок так ну ладно я кратко расскажу тогда здесь было потом желающим покажу все вживую в частности хорошим примером применения оптимизации стан sing является система частиц я вам хотел как раз показать логотип нашей изначальной конференция на которой мы здесь находимся нарисованы с помощью системы частиц то есть это небольшие объекты небольшие миши большие модельки которых очень много там их было 50000 вот и в первом случае рисовал каждый них отдельно ну как бы наивным так сказать подходом во втором случае я использовал специальное расширение и вообще использовать расширение это хорошая практика в них часто заложен очень крутые фичи без которых сложно или невозможно делать какие-то вещи на правда использую их аккуратно да то есть надо всегда оставлять запасной путь в коде который будет работать без расширений так вот я использую там энгл instance the races который как раз реализует instansing для рук дело то есть я уложил все свои параметры для всех копий объекта большой буфер рассказал вокзал о том что это буфер с параметрами копий их опыт рисовался ну и там дальше был красивый эффект в том что у меня здесь это 60 fps все поднялось но к сожалению пришел какой-то факап мы этого не увидим вот что у нас была с ним дело в панорамах в панорамах минимизации причине контекста мы получили фактически бесплатно почему так получилось потому что у нас как бы сама задача так стояла то есть мы рисуем в плеере сначала панораму потом подписи объектов а потом элемента управления а стрелочки переходов и шайбу быстрого перехода и как бы сразу из-за этого формулировки вытекала что одинаково объекта мы рисуем ну как бы рядом в коде при этом мы применили стасик для маркеров все маркеры все подпись объектов мы рисуем за один вызов отрисовки и еще мы не генерируем вызова отрисовки для секторов панорама для кусков панорама которые не видно то есть зачем генерировать вызов для того чего все равно не увидим на экране до тус техника который обычно называется viewport calling или froom calling и в этом месте важно сказать что у нас в яндексе сферические панорамы то есть это какая-то картинка наложенная на сферу когда открываете player вы стоите в центре этой картинке смотрите наружу вот так вот это выглядит если посмотреть снаружи сферы они изнутри и ну так выглядит панорамная текстура панорамная картинка приезжающей сервера то есть она равна прямоугольная проекция мы так и храним еще мы разрезаем на небольшие сектора для того чтобы было с неудобно работать в джелли ролл там нельзя создать сильно большие текстуры и для каждого такого сектора мы можем вычислить вообще говоря попадает он у нас на экран или нет если не попадает мы не только его исключаем из списка на отрисовку мы еще и удаляем те ресурсы которые он занимает таким самым таким образом экономии памяти как только она снова становится виден мы выделяем людям пустую текстуру и данная для данное изображение мы перезагружаем из кеша браузеров да когда так это выглядит геометрии то есть каждому сектору текстуры соответствуют сектор в геометрии сферы и так это все и рисуется другим большим и страшным грехом вокзал приложениях является умер дро что такое wear драйвер дроиды когда мы считаем пикселы по нескольку раз например как на схеме приведена на слайде если мы сначала нарисуем прямоугольник потом круг а потом треугольник то получится как бы часть прямоугольника а после этого часть круга мы считали зря мы все равно не видим а ресурс уже на них потрачено на то и хорошо бы конечно этого избегать существуют разные техники для этого первая самая простая но это посчитать как мы наподобие того как мы делаем секторами текстуры не видим объекты то есть объекты которые закрываются другими объектами от нас на носить ее в нашем же вас крипте и не рисовать их не генерал для них вызова отрисовки эта техника называется клюшин calling не всегда правда это просто сделал java скрипте java script не очень быстро с математикой и можно применить более простые техники например сортировать объекты по глубине то есть рисовать их от ближнего к дальнему и тогда видеокарта сама сможет исключите за счет эти пикселы которые она уже будет точно знать что они не попадут на экран что они дальше чем те которые уже есть в кадре ну и если это сделал сложен например потому что если объекты протяженная или хитро сама пересекаются можно сделать дпс припас то есть с помощью очень простых шейдеров наполнить буфер глубины тем самым рассказать видео карте расстояние каждого пиксела так рано и тогда видео кажется может принять ровно ту же самую темизация что и в предыдущем случае вот то дальше снова неработающая днк в панорамах мы столкнулись с overdraw решая вообще говоря другую проблему дел том что панорамно картинка на пелены на сервере в нескольких размерах нескольких лишь разрешениях и конечно же мы хотим отображать пользователю размер картинки наиболее подходящий для текущего зума player ликующего зума панорама однако при этом мы хотим показывать ему наилучшее качество которые у нас уже есть то есть наилучший tylo которые у нас уже есть что не всегда оптимальный они могут быть меньше качества как это выглядит сначала мы рисуем самое плохое качество картинки самая размытая самое мыльная потому что быстрее всего приезжает после этого мы рисуем поверх него все что у нас есть качество получше и тут видно что не все участки картинки у нас есть некоторые отсутствуют и они прозрачные через них видно меньше и качество и после этого мы рисуем самое лучшее качество нас есть которая тоже может быть частично прозрачная но потому что не приехали еще детали картинки вот и снова у нас да есть как бы просвет из которой видно предыдущий слой то есть таким образом мы за четыре прохода генерируем картинку панорама на экране для пользователя почему так получилось потому что нового первых как уже понятно часть текстуру может быть прозрачной и было не очень тривиально вычислять какие вообще говоря прозрачно то есть какие части текстуры менее качественной закрыты частями текстуры более качественными поэтому приходилось вот так вот мучиться и на рите на экранах это очень сильно тормозила потому что там много пикселов и в общем я очень хорошо работал на мобильных как мы это обошли как я это обошел если внимательно посмотреть на эту схему которая чуть показывал то можно предположить а там что вообще в эту операцию живет один раз то есть один раз хлопнуть все эти слои в один какой-то промежуточный буфер кэш его можно назвать и уже рисовать потом только его в кадре особенно ровно это мы и сделали допустим у нас прилетели данная плохого качества то есть справа у нас данная слева слева текстура панорамная кусочки и у нас прилетели данное хорошим качеством и отрисовали текстуру прилетели данные по лучшим отрисовали в текстуру поверх имеющихся плохих данных при деле совсем хорошие данные долетели наконец до нас и мы их тоже нарисовали поверхностями одна картинка которая как бы оффлайнового собирается из прилетающих данных ну конечно не всегда все так хорошо сеть штука непредсказуемые да накажи могут прийти не в том порядке на проблема решилась довольно просто то есть нового сплетает плохая картинка потом прилетает самая лучшая картинка мы рисуем поверх а потом rytp летает картинка меньшего качественным кончине выводим мы оставляем лучшие качества которые у нас уже есть таким образом мы сводим несколько проходов рендеринга панорама к одному и это ускорило нас на разных девайсов том числе на retina девайсах вот нередко наш код рендеринга который написано в джилл он работает очень быстро он способен выдавать там 60fps нам на смартфонах планшетах disturb на компьютерах а вот всякий код вокруг который ну неизбежно присутствует нашим в приложении код который обновляет дом код который загружает ресурсы и код который обрабатывает события пользователь событий ей он начинает нас тормозить еще надолго забирает управление вызывая задержки в анимациях задержки в рендеринге и таким образом тормозит наше приложение с таким кодом в общем кажется ничего не сделать кроме того чтобы разбить его на небольшие части дадут если у нас грузить 100 картинок я уже грузить сразу 100 нагрузить там по 10 дюжинами пятаками в общем как удобно и написать планировщик который будет исполнять этот код только тогда когда у него реальность время когда они затормозит анимацию для нас в панорамах таким кодом стала загрузка видимых тайлов и как раз вытеснение невидимых частей панорамы про который говорил в самом начале зимы поступили очень просто мы никогда не делаем это пока панорама движется ведь если нас картинка статична и не важно какое у нас fps сколько кадров секунду мы показываем может быть один может быть 60 пользователей не заметит разницы картинка не движется ничего не меняется на экране поэтому мы дожидаемся пока закончить текущие анимация и пересчитываем видимые таяла пересчитываем видимый сектора текстуры создаем запросы и там управляем ресурсами и кроме того источником проблем стали события программного интерфейса player player ты виджет который встраивается в большие карты и большие карты используют какие-то внешние события для того чтобы показывать какие дополнительные элементы интерфейса событиями поступили тоже довольно просто во-первых мы затратили то есть те события которые должны генерироваться постоянно например пока меняется направление обзора пользователя направления взгляда в панораме мэтти событий затратили то есть мы понизили частоту генерации значительно и но этого оказалось недостаточно например много проблем и нам по создавал этом месте history api браузера то есть мы пытались по каждому событие изменения взгляда обновлять ссылку в адресной строке и это жутко тормозило все и поэтому было сделано специально события которое рассказывала уже внешнему коду о том что панорама остановилась и можно поделать тяжелую работу такая система времена вопи яндекс карт то есть там есть стали события по которым можно делать какую-то более тяжелую работу вот давайте подведем выводы по оптимизации первое самое важно это нужно аккуратно работать состоянием потому что самом неожиданном месте может возникнуть зловредной синхронизации тормозить наше приложение не вызывать чтение состояния не читать если крайне нет крайней необходимости читать данная видеокарта и не вызывать к террору в продакшене это самое важное делать поменьше вызовов отрисовки побольше работы за каждый из них таким образом разбивай оверхеды которые они добавляют избегайте ведро самыми разными техниками любыми которые подойдут вашему приложению и планировщик для кода вокруг то есть планировщик для кода который поддерживает рендеринг и для того чтобы он не забирал долго управление не тормозил ну и и за неработающих дамаг я закончил раньше нужного спасибо вот у нас есть да это неправильный слайда ребят но это не та версия если у тебя есть с собой ноутбук можно будет показать людям после да я обязательно покажу после расскажу честно подробнее как это все работает там есть код на гитхабе я дам ссылки и все остальное и до какой-то случилась накладочка ссоре но все равно можно сейчас позадавать вопросы есть есть в принципе время так что желающие поднимать руда времени кучу поэтому давайте любой вопрос проклял не только по производительность рост здрасьте драсьте крил у меня так а образ если различие между рендерингом в апрелем и обычным co2 сам с точки зрения расхода батареи нет однозначно ответ на ваш вопрос все зависит от того что вы делаете с канва сам что вы делаете суп делом теоретически за счет того что вокзал может как бы быть быстрее да то есть вы можете за меньшее время строить кадр на вокзал чем на канвасе таким образом конечно можете экономить батарею на потому что он будет дольше спать код дольше спать браузер дольше спать видеокарта но в общем случае это конечно не так то есть от нас смотреть надо брать как как какие-то вещи которые похожи на верно ваше приложение и посмотреть как они расходуют батарейку спасибо за доклад скажите пожалуйста вы оптимизировали каким-то образом ваше приложение отрывки под какие-то артефакты которые постоянно появляются вот например простая задача у вас есть просто белый кал на ней есть какая-нибудь spite небольшой и вот он движется из точки а в точку б такая тишина простая задача вот и сделать так чтобы она работала везде ну постарайтесь то есть это фактически элементарная вообще вещь казалось бы то есть там идет там всякие альфа буфер это мы тут все что угодно там шейдеры все что угодно вот такая простая задача чтобы она работала везде без рывков ну например почему я спрошу не такой вопрос потому что например нашей компании любой любой рывок объекта если он движется рывками пол это все уже нельзя в продакшен никак вообще вот таким образом написать какую игру динамическую которая будет главный герой который это не похода в их к не стратегия frost ну понимаете это ведь он по-своему движется то это очень непростая задача чтобы это работало потом и чего везде включая там например make различно где там есть учет сафари и у которого есть различное состояние браузеров где все по-разному вы разные фпс у них совершенно всё скачет вот такой вопрос можно вообще так сделать можно сделать простой вот такой вот такой task то есть чтобы просто объект двигался плавно можно написать хороший код если вы строите кадр ну то есть вы джел вы опускаетесь на такой низкий уровень например если нужно плавно анимация до вам нужно плавно интерполировать позицию вашего спрайта от а до б нет инструментов придется написать самому плеере панар написан собственный движок анимации движок это громко сказано полтора класса которое как раз занимается тем что они аккуратно перебирают кадры в правах анимация да там где у нас покадрово тренды рена какая-то анимация и они аккуратно интерполирует состояние на основании текущего времени то есть они запрашивают время сколько сейчас они знают сколько прошло времени с момента начала анимации они плавно интерполирует эти позиции вы говорите сейчас на просто дарите времени на сколько я понимаю также в том числе вот то что просто умножать на дельту времени при изменении позиции объекта так то вот это тоже не помогает сожалению этого и этого конечно же мало ну и конечно же нужно типа за очень короткое время в request занимают время строить кадр то есть все говорят 16 миллисекунд даже надо строить кадр из нас ни секунды и правда на самом деле у вас гораздо меньше времени потому что браузеру тоже на чем заниматься во время построения кадра хорошие ну типа надо ретируется примерно 10 миллисекунд если вы успеваете строить кадр за 10 или меньше миллисекунд значит что вы хорошо нагружаете браузеров при этом вы оставляете время на обработку ей событий и при этом вы как бы даете нормально браузер узком посетить картинку и показать ее пользователю то есть если выкладывайте родрик 10 миллисекунд если у вас написан если вы не страдаете от куда вокруг вас внезапно не врезается какой-то код который там грузится пройти сервера или занимается еще какой-нибудь странно работает в рендеринг и вас ну типа приличный уже пониматься которые ну нормально интерполирует на основании времени позицию спрайта то у вас все должно работать хорошо плавно и красиво спасибо еще вопросе и тогда я воспользуюсь служебным положением как еще используя вокзал в яндексе есть какие то еще применения кроме панорам насколько знаю во всем яндексе в том яндексе который не карты он вроде бы не используется ни где вот хотя возможно удастся исправить эту ситуацию в рамках карт движок панорам и движок карту потихонечку туда идет ну то есть canvas нас не вполне устраивают по производительности мы хотим возможно в хорошем светлом будущем вектор 3d сейчас мы растровых движок переводим на воду l1 чтобы показывать всякой трехмерное на картах высоту здания подобные вещи начали стран дрина в той лак статические трехмерные модельки и высота здании есть такая голубая мечта у меня еще пачки людей прийти к этому надеемся мы придем то есть прям какой-то такой 3d картинки то есть конечно google глазок тронет меня тоже но есть и джорджер по-моему на картах до угла щас векторного джел полностью макей да то есть у них они очень круто используют эту технику очень их прямо динамическая подложка у них меняются метки тех пор это есть метки каких-то интересных меня зависимости от контекста и и то есть если выпускали кафешке вам подсветит кафешке то есть ну кажется что это принципиально более мощный вещь чем обычный растра движок которые там из дивов имидже собирает вам плоскую карту из раз строк картинок и можно эту штуку пушить дальше плане юзер экспириенс а в плане каких-то продуктовых фич спасибо но если нет больше вопросов тогда поблагодарим спасибо"
}