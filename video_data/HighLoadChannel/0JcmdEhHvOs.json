{
  "video_id": "0JcmdEhHvOs",
  "channel": "HighLoadChannel",
  "title": "Как мы интегрировали платежные системы, не пользуясь собственным биллингом / Антон Русаков (Badoo)",
  "views": 2357,
  "duration": 1762,
  "published": "2019-01-14T00:13:07-08:00",
  "text": "привет в первом слове игра конечно ударений начнем с того что я расскажу что такое буду много раз уже все слышали вдруг это не знает это самый большой рейтинг в мире 390 миллионов зарегистрированных пользователей три тысячи серверов 350 тысяч запросов на backhand и около 600 серверов баз данных просто чтобы понимать это это хайло да но мы будем говорить не проходила то как платить деньги за что буду в принципе выплачивает деньги основная модель монетизации это собирать деньги с пользователей ну а буду также из выплачивает деньги по партнерской программе есть программа поиска уязвимостей оплата работы модераторов также недавно совершенно новый сервис который появился баду live и там мы вознаграждаем стримеров а также существует маленькие другие проекты в рамках которых баду выплачивает деньги и в рамках появилась задача что нас попросили как-то автоматизировать эту выплаты для начала на одном из небольших проектов и вот тут надо рассказать как раз задача попала почему на ко мне попала не в биллинг я работаю в буду уже 9 лет из них 7 лет в основном я занимаюсь проверкой концепции всяческих то есть я вас нам занимаюсь задачами в которых скорость намного важнее качество бывает такое и соответственно этот проект удовлетворял всем этим требованиям то есть мы не знали насколько этот проект будет востребован и поэтому решили делать отдельного не большим отделом биллинга а непосредственно маленькой командой которая занимается вот этим всем пруфов концептами когда мы начали изучать рынок выплат мы обнаружили то что огромна существует огромное количество агрегаторов которые позволяют принимать деньги различными способами но два года назад не было a greek именно агрегаторов который выплачивать то есть были агрегаторы которые выплачивали в платежные системы но нам нужно было выплачивать нам нужно было выплачивать фиатные деньги то есть реальные деньги пользователям на банковский счет и все да и такой поэтому решили делать свой велосипед и так условия здесь написано три пункта как что это должна быть популярная платежная система должна быть возможность выплаты на банковский счет или на карту пользователю также возможность делать внутренние переводы в россии потому что в россии перевода из-за рубежа это очень большая головная боль для пользователей и я подчеркнул эти три у слой этим трем условиям должна ни одна система была соответствовать а нам нужно было интегрировать как можно меньше платежных систем чтобы все эти 3 условия нашей системы уже обеспечивала и остановили выбор свой на этих трех системах сейчас я расскажу почему 1 система это paypal с их паял трест step2 здесь все понятно было первый пункт это была самая популярная платежная система в которой можно выплачивать 2 два года назад это был совершенно совершенно новый стартап который позволял бы делать переводы karon sea клауд они позволяли делать банковские переводы почти по всем странам и почти во всех валютах сейчас они расширяются и третье это был яндекс деньги их массовые выплаты москве man's которые позволяли делать переводы на банковский счет карту а также внутри системы яндекс денег теперь поговорим про каждую систему в отдельности вот начнем с paypal рассмотрим плюсы paypal а это очень хорошая документация хорошо написана документация за исключением маленьких там дальше я в минусах обращайтесь к расскажу огромное количество примеров просто огромное везде существуют и библиотеки существуют как от самого вендора от paypal а так и на гитхабе огромное количество тоже существует очень много вы можете воспользоваться ими легко также у paypal а один из лучших сэндбокс of которые я видел там вас есть возможность протестировать негатив кейси то есть когда вы должны вы хотите протестировать как вы обрабатываете ошибки вы можете заранее в sandboxie сказать что вот следующий запрос должен упасть такой то ошибка и протестировать как это все будет работать нигде больше я таких сын баксов не видел из минусов поскольку paypal один одна из самых старых систем то видать это издревле пошло что у них разные 5 то есть у них и 5 для авторизации и 5 для выплат и опять для получения количество денег на кошельках это все три разные мне показалось это очень странно то есть это не даже не просто разные and point и на который вы делаете запрос и они работают по разным там для кошельков там вообще sol по моему чтоб протоколу soup надо общаться у них прекрасная документация в которой описаны ошибки но не сказано что с ними делать то есть половину h может много ошибок которые проходили мы писали мы говорим что это за ошибка они нам объясняют объясняют в отдельном письме и мы уже там дальше получаем мы уже дальше работаем с этой ошибкой также как как я уже сказал что paypal это все же не прямые деньги пользователи это деньги в системе в какой-то находятся и ну некоторым это не нравится потому что надо еще чтобы их получить надо еще какое-то действие сделать чтобы вывести какие можно дать советы для работы с paypal email это основной идентификатор в пейпале давайте пользователю вводить его просто попросить у пользователя авторизоваться с помощью paypal вы получите за точно корректный e-mail который существует системе который привязан пользователю на которой возможность делать выплаты сейчас paypal переключился и они асинхронная обработка платежей что это значит вы добавляете платеж делаете запрос добавляете платёж и систему и он находится в каком-то статус систему просто приняла и потом выплате там с помощью запросов узнаете что статус изменился и как-то отслеживаете то есть просто надо они недавно это переключили для всех жестко сделали надо это помнить когда вы работаете с paypal вы не сможете от с помощью paypal это американской системы вы не сможете отправить деньги все внука рею судан по-моему в крым нельзя еще отправляется и как я уже говорил про ошибки вы должны должны будете их обрабатывать вручную то есть старайтесь всегда автоматизировать все ошибки старайтесь автоматизировать и но при палец в припали будут все равно ручные очень странные ошибки который у них даже не описано бывают таким вот так перейдем к следующей системы кэрнсе клауд это английский стартап который как я уже сказал примерно 2 года назад стал более менее известным на на основе этого старт-апа работают несколько систем которые переводят который для пользователей конечных переводят деньги например а зима пользуются под капотом у него коран стекла у плюс и карен цикла ада это очень хорошая документация много опять же как примеров собственных так и людьми написанных сторонних так и библиотеки я честно не изучал вопрос сторонних библиотек но внутренний виндовский отлично библиотеки поэтому я мы даже не смотрели его и самый главный его плюс в пейпале нет различия юридическое лицо или частное лицо это просто аккаунт который тариф который ты переводишь деньги здесь же поскольку это банковские переводы переводы банковским банковские переводы частным лицам и юридическим лицам во многих странах отличаются и сделать просто перевод на юридическое достаточно проблематично но перевод денег на улицу достаточно проблематично но кэрнсе клауд это позволяет это было в огромным плюсом потому что нам надо было их делать из минусов можно отметить то что очень долгая регистрация для продакшена у нас заняло мы зарегистрировались получили доступ дыма доступ и два месяца нас проверяли о том что мы хорошая компания крупная компания бодун у нас очень долго проверяли что не отмываем ли мы деньги два месяца у них тоже узко рамси клауда тоже есть sandbox но например в нем не происходит до конца платеж то есть либо ты можешь только отправить платеж и все и он остается в этом статусе что принят системой он не двигается дальше у них есть планы что они вода делают все таки два года и молода еще компания может быть доведут и у них нельзя негатив кейс с проверить в sandbox это же просто платеж принимается и на этом все из советов работы с карен цикла адам что можно выделить можно выделить у них хорошая система хуков то есть в поймали уже они тоже появились поскольку асинхронным платежей а robot koch платежей в paypal то у них есть хуки когда ваш платеж меня меняет статус когда он переходит статус выйдет у сын меняет статус и внутри системы они могут руками к вам обращаться но у paypal а огромный огромный рейд лимит на запросы в минуту и там его очень сложно достичь в отличие от кэрнсе кладу которого 100 запросов в минуту лимиты и поэтому по возможности желательно использовать руки для получения статусов когда вас платеж меняет статус и чтобы получать основных переводов кэрнсе клауда 2 regular это внутреннего платеж внутри страны и priority это обычный свифт слив перевод regular перевод они диши дешевые но во всех странах разные разные реквизиты по которым вы можете посылать ну например для россии это big аккаунт намбер big номер счета и фамилия имя отчество это минимальное что-то надо отправить в великобритании это сорт caught и аккаунт нам также фамилию надо отправить в америке это оба надо свифт и аккаунт нам бы то есть они везде разные понадобятся больше работы для того чтобы их реализовать но зато они намного дешевле как я сказал приварить это обычный свифт переводы у которых стандартно вам нужен свифт и аккаунт нам бы и фамилия пользователей вы можете перевести еще поскольку я уже сказал что почти во всех валютах но базовых валют в кэрнсе клауда 5 но в основном все пользуются тремя это английский фунт евро и доллар но выплачивать можно вам нового многим во много количество во множество количеств множество валют для этого надо идти валюта купить или обменять и тут они почему-то реализовали очень странную вещь если вы запрашиваете без дополнительных параметров просто я хочу обменять the data обмена у вас будет послезавтра всегда и соответственно ваш платеж уйдет после завтра что достаточно долго но если перед этим сделать запрос на отдай мне ближайшую дату обмена то скорее всего это будет не скорее всего этот 99 процентах случаев это будет сегодня и вы отправите это намного быстрее если вы будете этим пользоваться рассмотрим яндекс деньги систему в россии которая была которое нам нужно было это возможно плюсы яндекс денег это выплаты в рублях на банковский счет карту которая нам надо было сделать и самый главный плюс почему мы не смогли работать с тиньковым и в точкой два года назад они не могли работать с иностранными компаниями с индексом тоже было забавно не всегда требовали печать для английской фирмы печать не обязательно достаточно росписи руководителя и поэтому мы мы каждый раз им пытались объяснить у нас нету печати мы не оставим печати мы можем достаточно росписи но они требовали приходилось добавлять и минусы яндекс яндекс деньгами были самые большие проблемы с интеграцией во первых у них очень-очень плохо написанная документация нету никаких примеров кода библиотек я пример кода работы с маской man's именно то есть не яндекс деньги которые принимают или там позволяют принимать оплата который именно вот выводы я первый пример кода нашел это была статья на хабре в сенд в песочнице 2013 года у которой там шесть прочтений было то есть случайно абсолютно что еще очень сильно удивило какие-то непонятные маленькие по дефолту маленькие лимиты в тестовом окружению нас был лимит около 10000 который мы первыми тремя транзакциями сразу у нас закончился и после этого надо было писать писать письмо договариваться с ними мы уже сделали лимиты меньше чтобы выводы были все такое но каждый раз когда достигаете лимитов только письмо в поддержку они увеличивают еще у них можно только со строго определенных айпи обращаться как ним бэг-энда и так это во всех системах есть такая возможность но она опционально то есть ты можешь это настроить но яндекс денег это было сделано по дефолту опять же только с определенных айпи и этот доставь доставила некоторые проблемы в том смысле что у нас была забавная ситуация при начальном свой проект размещали на не в ладу инфраструктуре на другой инфраструктуре и у нас переклюк переключался стретчинг мы переключили на болеешь и на более крупный и случайно упустили айпишник и мы там два дня переписывались с индексом чтобы поставить новый для тестового кружения могли бы сделать без этого ну ладно и переводы в этой системе можно сделать переводы только для физических лиц на крайний случай индивидуальных предпринимателей но этот предприниматель у них даже нету ничего в документации это после переписки с ними выяснилось что у них есть какое-то дополнительное поле в которой можно передать и н.н. и тогда индивидуальному предпринимателю придут эти деньги на счет кто знает в чем проблема этой картинке так точно в бердске но по моему это улицу же переименовали насчет стартовая называется но это вот здесь рядышком было в этом в этом адресе 106 символов название улицы в яндексе максиму можно стоя не требуют точное написание как в документе соответственно ты никак не попадаешь вы какие вы ходы-выходы выход только единственный это опять же вы заранее идентифицируйте что у пользователя больше 100 символов заранее успею можете заранее написать в яндекс письмо но скорее всего они попросят вас провести сначала транзакцию которая упадет потом вы им еще раз напишите и после этого не скажет все мы поправили там не знаю а не и верности это себя что-либо и все можно вот а кто скажет чем проблема вот этого паспорта ну кроме того что это жерар депардье н француз и держит российский паспорт так точно здесь нет отчества это очень большая проблема в российской банковской системе очень сложно завести пользователя без отчества у нас на работе есть сотрудник more какие вот он даже выступал у него нет а отчество он у него сербский паспорт и два месяца и в альфа-банке ему не могли завести счет просто его них система так написано что надо молча это за как как-то вставлять о простые минусы не стали у нас тоже были проблемой но опять же это не проблема индекс это банковской системы потому что мысль мы с переписки с индексом у нас был была девушка без отчества мы пытались выплатить вместе с индексом ставили минус составили пробелы неразрывный пробел и все время то система назад возвращала и на и единственный выход который мы нашли у нее был муж и мы вывели деньги на паспорт мужа вот другого мы не нашли способы как это сделать а иногда бывает что вообще все правильно заполненный паспорт не проходит совершенно какое можно дать совет опять же тут только переписка с индексом вы переписываетесь янык сам говорите они добавляют их наверное если паспорт начинает проходить в отличие от первых двух систем где стандартный вес ты пей который стандартный 1 35 и общение с and point идет по протоколу https и этого достаточно для защиты в яндексе они дополнительно сказали что нет тела за тело запросы надо тоже шифровать и они выдают сертификаты проблема всех сертификатов чем бывает в том что вы не следите когда они могут заек спорится поэтому всегда надо следить у нас у нас тестовый тестовый сертификат за x парился хорошо что production новый был дольше после этого мы все написали все было отлично и у них гораздо у яндекс денег гораздо гораздо гораздо меньше лимита на пересылку например внутри яндекс денег там 15000 перевод но это опять же связано с банковским законодательством что не авторизированным пользователям больше 15 тысяч приводить нельзя вот у них что была забавная система до этого если ты переводишь на яндекс кошелек и ты приводишь больше 15 тысяч то они 15000 принимают добивают кошелек до максимума остальные деньги где-то вот повисают в их системе и они висят до тех пор пока пользователь не снимет 15 эти 15 тысяч и они вроде как да ну должны дальше им удалить насчет но почему-то эта система не очень корректно работала не обижая яндекс деньги вот мы несколько несколько раз и мы с ними переписывались несколько раз в конце концов они изменили эту систему они сделали так что если вы пытаетесь привести больше 15 тысяч вам просто придет ошибка это это лучше чем ждать не понятные деньги потом пытаться их возвращать от общей от частных платежных систем я расскажу с каким еще ошибками мы столкнулись когда ошибками или полезными советами когда мы эти системы интегрировали и так не стоит не знаю сделайте так что не запускайте тесты с продакшен окружением это не значит что не запускаете теста на продакшен не только это production окружение может быть наделили просто как можно себя обезопасить во-первых договориться о том что только сабрину поставить на стройку что только с определенных айпи и на продакшн окружении можно ходить дополнительно поставить в июне тестах какой-нибудь iv что если если он приходит такие кредит шел и не выполняют ничего в третьих тесты для тестов не нужны огромные огромные суммы уменьшить их как можно больше само собой это написана красным потому что мы за мы запустили мы запустили тесты слава богу один аккаунт это был аккаунт разработчика и разработчик себе купил денег но вернул спокойно в компанию 2 2 нам нужен был какой-то зарубежный счет мы начали гуглите что 1 ну кто реквизиты в первую очередь пишут благотворительные компании году сказала что мы по участок в благотворительности отдали деньги наши конференции называется highload я рассказываю в абсолютно не про холодные вещи и когда мы переключились с хайло да на наши платежные системы где 10 в 10 минут один запрос человек генерит на вывод денег иногда мозг начинает лениться и ты забываешь что возможно рейс кондишен и и чтобы один пользователь может нажать кнопку два раза нужно защищаться от этого нужно не забывать про этом расставляйте локи спали использовали используйте локи для когда человек работаете когда работаете с деньгами это полезно когда пользователь запрашивает деньги на вывод он он ожидает что платеж уже пройдет но перед этим он вводит какие-то свои данные паспортные все так все системы практически кроме яндекса опять же позволяют проверить за валиде ровать данные до того как вы начнете вывод поэтому самый лучший вариант пользователю сообщить об ошибке не когда он выводит деньги а когда он вводит данные постараюсь это надо делать заранее еще тоже одна из проблем в том что обычно в системе одна какая-то валюта ну максимум 2 3 но пользователь часто запрашивают деньги в разных валютах выводить поэтому нужно каким-то нужно держать внутренние курсы валют у себя от крупных доставать по возможности конвертировать и самое главное что вы должны показывать пользователю именно ту сумму которую он получит насчет точно показываете что он выводит 100 долларов по курсу 62 рубля и получит 6200 то есть он должен это понимать что потом это не возникало вопросов что такое почему так произошло так же вы должны мониторить свои кошельки всей системы опять же позволяют получить остаток денег на счету самое главное что если вы пишите систему которая выплачивает пользователям деньги обычно деньги лежат на счете какое то время то есть вы знаете что вы этому пользователю через две недели должны будете заплатить какую-то сумму нужно уметь прогнозировать это чтобы чтобы чтобы пользователи всегда могли могли снять прогнозируете это будет замечательно еще учитывайте что деньги во всей системы зачисляются задержка то есть два-три дня даже если вы сегодня перевели то скорее всего это послезавтра будет на счету соответственно это тоже надо учитывать когда вы пишите систему для того чтобы защищаться для того чтобы пользователи могли нормально выводить и не расстраиваться любой платеж любой платеж всегда может вернуться даже если система написала что он успешно проведен он может вернуться поэтому нужно всегда следить никогда не бросать следить за платежами всегда нужно всегда за ними следить до конца до самого проблема в том что у тебя нету как так называемого конца ты не знаешь когда пользователь физически забрал эти деньги ну то есть когда они вот ему упали на счет у тебя нету финального статуса поэтому ты мониторе всегда и с этими статусами транзакции самое долгое у нас например paypal один счет вернулся через два месяца мы удивились почему пользователю как бы не волновался и не писал но вот через два месяца навернулся платеж в кэрнсе клауд было две недели через две недели вернуться из индексов самый долгий был неделя вот вот здесь индекс выиграл к тому же вы должны как я уже писал вы должны быть готовы к разбором ошибок и сообщать пользователю в чем была ошибка то есть что эта ошибка была в написание чего-то или он неправильно я ебан указал или он где-то описался чем вы информативней сообщите пользователя тем он меньше будет нервничать тем он лучше получит больше больше будет радость получить эти деньги и в вашей системе будет рад самый главный кадр дружите с бухгалтерией эти люди выплачивают деньги уже очень долгое время очень долго и они знают об этом очень много когда мы через полгода сидели радостные что у нас все работает к нам пришли бухгалтера и город отдайте к нам пожалуйста выписку как вычел все проходили все платежи мы поняли что что-то мы делали не так когда когда мы начали реализовывать выгрузку для них данных тем вы раньше начать работать с бухгалтерия тем лучше вот они вам могут многое чего подсказать это одни из немногих пунктов и конечно последний пункт это это очень веселые люди на всех вечеринках бухгалтера очень веселые люди в принципе это был такой рассказ выжившего который что-то сделано проекте никаких сил и больших и ладов здесь не было я уже показал что этот я могу отвечать на вопросы для начала могу сказать что как как вы думаете легко ли перевести деньги греку в норвежский банк а в норвегии кроны в евро на самом деле ничего сложного в этом нет ну просто вы должны были году должны быть готовы к таким запросам а теперь я готов ответить на вопросы вот пожалуйста а где микрофон спасибо за доклад у меня немножко провокационного опроса вчера на 2017 год нет ли у вас желание как бы забыть про банки паспорта фамилии греков яндекс и добавить опцию оплаты крипты там не знаю лайткоин нам где крышу это было первое решение которое которое мы хотели реализовать это великолепно но на том конкретном проекте конечные пользователи которые получали они не могли банковские данные ввести свои и не только банковские данные не могли ввести они не по не понимали как вообще заполнять поэтому объяснять их как завести крипто кошелек и как на него получать это было намного намного сложней первое что мы рассмотрели то был и выплата в криптовалютах но начальство сказало что нет это тот контингент пользователь которым нельзя вот это было пожалуйста там сзади самый последний ряд спасибо за замечательный доклад очень приятно было слушать вот предыдущему товарищу замечу жил с криптовалютами ровно то же самое вот и хочу поинтересоваться а на какой платформе все это реализовали потому что реализовать ее нужно надежно и без ошибок бесбаев спасибо как я уже говорил что я вас нам работаю над пруфов концептами и платформой у нас это был даже не движок году это был даже не на инфраструктуре году мы делали на наверное это можно сказать мы делали первоначальной на аверсе на amazon amazon русских серверах под капотом был php обычный стандарт на то что мы в в году используем то есть это был php mais quel если кому интересно это было фреймворк laravel даже конкретно то есть там не было такого у нас основная задача была в том что нужно было скорость нам нужно это было сделать мы этот проект за за по моему за два месяца нет за месяц сделали и через два месяца он в продакшене был то есть месяц мы его тестировали выплат вот если если вы это имели в виду на первом ряду молодой человек юрий насретдинов докладчик или спасибо за доклад был тоже интересный здравствуйте антон спасибо большое за доклад скрыть просто если сервис куклы на благотворительность в итоге привели этой вот этот самый провокационный вопрос эта сумма была больше 100 фунтов но меньше тысячи ну это было благотворительности как бы я так понял что году смог это провести сумму как благотворительности наверное да на нашем проекте еще вопросы если что я могу я здесь в кулуарах могу подойти прошу пошутить шутки рассказать про буду все такое то без проблем но можно на 15 минут пораньше на обед пройти без перерыва спасибо прекрасная публика"
}