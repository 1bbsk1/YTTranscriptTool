{
  "video_id": "ppPRiZu8Hus",
  "channel": "HighLoadChannel",
  "title": "От алгоритма до прода: как подойти к верификации распределенных систем / Никита Галушко",
  "views": 343,
  "duration": 3158,
  "published": "2024-04-17T01:10:23-07:00",
  "text": "доклад которого вы ждали горячий пирожок из ВК Никита Галушка погнали друзья Готовьте вопросы Всем привет как сказали меня как уже сказали Меня зовут Никита Я работаю ВКонтакте в команде Вот инфры и сегодня я вам расскажу о том как мы подходим к вопросу верификации нашей распространенной системы сам доклад и все что я буду рассказывать основана на живом опыте то что мы используем на под практикой потому что в какой-то момент команда была поставлена задача разработать систему которая умеет выбирать мастер узел автоматически умеет распределять между движками и вся эта система очевидно распределенная поэтому стал задача не просто её сделать но и понять что она работает корректно потому что в ВК очень много вот данных и понятно что найти проблему на фото начальном этапе куда проще и дешевле чем на вот этапе Когда уже система внедрена а вы возможно часто слышали от спикеров из ВК и от меня сейчас слов движок если по простому потому что возможно я буду это слово часто использовать это такая самописная очень специализированная база данных Сегодня мы пройдемся по следующим темам Сначала мы поговорим о том как можно верифицировать идею затем перейдем к тестированию реализации и закончим доклад внедрение этой системы и тестирование в целом как черного ящика и так идея Вот вы хотите сделать какую-то распределенную систему вы взяли какой-то научный Пейпер или вы такой умный что сами придумали свой алгоритм консенсуса Как понять что идея это вообще жизнеспособна что это не какой-то ну шлак который надо выкинуть А самое простое что приходит в голову взять первого попавшегося коллегу взять маркер и вот постоять тоски покрутить все варианты которые возможны все краевые случаи Но это вот работает только в случае если вы на собеседовании проходите этап или если тривиален и вы можете уместить у себя в голове все а кто-то может сейчас подумать что я говорю про июне тестирование но нет потому что еще нет кода есть лишь вот идея есть лишь какой-то набросок от алгоритма а вообще в целом идея там консенсуса это конец 80-х прошлого века поэтому потомные люди уже за нас все придумали кто-то знает кто это почти это Лесли Лэмпард он придумал столько всего в контексте распиленных систем что и не перечесть но нас интересует его работа в рамках и TLC где то лаплюс Это такой язык верификации вашей системы его ведро его ядро это темпоральная логика а TLC к нему это такой Ну не знаю его можно сравнить с компилятором для вот обычных языков программирования он проверяет что та модель которую вы описали на плюс она не содержит там дата рейсов или в целом корректно именно эта связка позволяет нам проверить нашу идею на корректность и верифицировать ее самый простой базовый пример кода на плюс выглядит примерно так и мне кажется что для тех кто с этим языком не знаком у вас сейчас примерно Вот такая какая-то реакция потому что все эти палочки вверх какие-то Но на самом деле это достаточно простой код а где мы в начале инициализируем наше общее состояние всей системы а затем просто описываем все стейты из нашей стейт машины и то как они взаимодействуют между собой вот в Next а в конце мы вот просто описали нашу спецификацию Но это достаточно сложно простым работягам Вот как я какие-то вот скобочки какие-то стрелочки это все очень сложно Я так не один подумал Если тоже решил что это так и поэтому появился такая история как ласкал для это как знаете свое время Да какой я старый Вот потому что полоскал это подмножество Толо плюс и тот код который я показывал пару слайдов до этого на плацкале выглядит Вот так это та же самая система которая делает то же самое она проверяет что там процесс по 1 Может отправить сообщение процессу P2 и все но синтаксические Это куда ближе простому программисту который не знает или не привык и логике ну по Скала есть ряд от особенностей и это вытекает конечно из его преимущества Да что это лишь подмножество пила плюс во-первых напаскали нельзя выразить все те формулы которые мы можем вырастить на ТВ плюс и что более важно мы не можем проверить что одна модель это просто усовершенствование какой-то вот иной модели Поэтому если мы говорим про верификацию нашего алгоритма в нашей идее то скорее всего без знания дала плюс в итоге не обойтись но можно лишь начать ласкала Потому что его код все равно будет переведен в плюс а это значит что те элементы которые мы не смогли сделать с помощью него мы можем сами уже написать на плюс есть инструменты то ТВ плюс два официальных первый это тыла плюс тулбокс он используется во всех учебных материалах книжках Вот лекциях но мне он не очень понравится потому что это Ну привет из нулевых потому что он основан на этой клипсе мне больше нравится плагин для Исхода он имеет все то же самое что бокс только у него приятный Если говорить о том куда копать дальше этой теме то есть лекции от самого лэмпорта мне больше эту тему где он Вот разбирает именно на вот практике не просто о том что такое тла плюс К Что такое тембральное логика какие там есть операторы или что-то такое он именно на вот практики показывает как это использовать при этом есть еще и книжка на вот эту тему и у книжки тоже есть преимущество что там небольшая часть выделены на Погружение в вот язык но под основная часть как раз таки направлена на практику а если про нас то нас все сложно в этом плане потому что да правильнее было бы сначала сделать верифицировать уже потом писать код но у нас не было в начале экспертизы в этом плане сейчас она ребят поэтому модель есть модель нашла ряд проблем поэтому наверное если бы мы обладали товар плюс в начале разработки мы бы конечно сделали сначала модель Окей взяли идею правы проаализировали ее узнали что окей она может что-то показать взяли свой любимый язык программирования у меня и того и реализовали отворит Как понять что реализация верна что она не содержит багов Ну вот естественно есть Юнит тесты Но это скучно и мало продуктивно потому что мы говорим не про какой-то базовый от алгоритм его краевые случаи мы говорим про алгоритм кроковые случаи в котором спустя месяца после того как вы его используете поэтому я сейчас хочу поговорить про фаст-тесты кто-то в курсе что это Отлично я тогда пропущу часть часть слайдов для тех кто не в курсе Fast Test это такой ваш кода случайными параметрами это наверное все что вам сейчас надо знать чтобы понять следующий слайды и если вы вот как-то потрогали до фазе то вы скачали отходы о том как с ним работать но они слишком простые и наивные случаи когда мы хотим поговорить про Вот например про раз да как можем пофасить сразу скажу что в нашей системе используется не рафт но я думаю что ребята об этом расскажет а если представить вообще вот рафт не в контексте там какой-то консенсусы из природной системы а в целом просто как от логарифм то его можно представить как Тейт машину в котором есть ряд состояний и мы четко знаем как из одного состояния мы можем перейти в другое Поэтому давайте это использовать а мы представим Да что переходы из одного состояния в другое как некий глагол или действие которое мы можем произвести над нашей стоит машины и Для этого просто возьмем первый байты последовательности тех которые нам дал Фазер и его основе будем определять то действие которое хотим сделать над все системы Ну например там не знаю если первый байт равен там двум пришел сопрос такой-то если трем то Например у нас работал какой-то таймер и тут важно понимать что не бойтесь менять немного код под то как вы пишете потому что например сложно себе представить как в этом случае тестировать например работу с таймером Ну окей если представить Это виде какого-то псевдо-кода да то мы можем даже брать не просто конкретные значения мы можем брать условно если попадает значение от одного до 64 то это там будет у нас пришел запрос на голосование что это даст это даст возможность быстрее сойтись быстрее по всем вашим условиям и циклом пройтись если говорить про сам тест он там бы наверное выглядел примерно так это тоже какой-то псевдоход а-ля там го плюс Rust Мы создали узел мы получили по первому байту наш действие над системой и просто его произвели а все бы ничего но в этом тесте У нас есть только один Узел это как бы не то потому что у нас же система из нескольких узлов Мы хотим проверить что в целом вся система работает хорошо что у нас не знает Например Нет двух мастеров да или что у нас есть мастер системе поэтому есть вопрос Да как в этом случае построить свой Фаст первым поэтому уже определились его оставляем так же как и есть а вторым просто будем выбирать жертву вот так просто а мы создадим наш кластер из нескольких узлов а затем просто делением по фотомодулю будем выбирать тот узел все достаточно просто ну фастестов есть ряд есть вот особенностей я уже вскользь так упомянул про сходимость И самое главное их фотосходность в том что запуск их на непродолжительное время там на пару минут до или на 20 минут она может ничего не даст потому что Фазер просто не сможет зайти во все ваши случаи подобрать такие случайные параметры Да при которых ваша система будет думать что все хорошо а на самом деле Поэтому если вы и пишите Фаст тесты то запускайте их на длительное время и я говорю не про часы Даже если мы говорим про какую-то крупный а для по достаточно много всяких туториалов о том как работать с фазером Причем сейчас в боях 2 один в эстеделия другой отдельный от вьюкова мы используем второй Потому что есть если это особенностей в том как работает Фазер и при этом если Вы посмотрите есть есть ссылочка о том как именно он это делает мы поговорили про идею Отлично она работает взяли все хорошо но наша система не работает вакууме поэтому давайте сейчас быстро пробежимся о том что может пойти не так от самого потоочевидного до не самого очевидного ну с под узлом тут наверное все вот ясно он может и по питанию с ним что-то может случиться Просто может его отопить он может просто сгореть сосетью наверное тоже все Ясно мы можем потерять доступность всю мы можем ее потерять частичную например когда не знаю ваши пакеты доходят до вот остальных узлов а от остальных узлов до этого узла нет у сети есть история с потерями когда могут теряется часть пакетов есть история с когда она может скакать нескольких а есть еще проблема с диском Да потому что я вот напомню что наша система не просто должна выбирать какой-то мастер узел она должна уметь там правильно правильно реплицировать поэтому она обязана уметь работать с диском и там тоже может пойти все не так потому что любой там врать запрос любой может вернуть ошибку но даже если вы сделали это не означает что те данные с которых будете восстанавливаться что они не покорочены и что наверное самое не очевидное про что наверное все забывают а может быть и не знают Это то что системные часы тоже могут подавать сбой то есть на вот разных узлах вашей системы время может идти по-разному при этом стены могут как отставать так и спешить так Как так и какое-то время сначала спешить потом возвращаться в норму Ну там очень много комбинаций и мы поговорим про то как это все тестировать Да я напомню нас узел у нас сеть у нас диск у нас темное время самый Наверное очевидный вариант это взять и все протестировать руками Конечно я просто вставил этот слайд для Flat мемов Мне кажется самое прикольное выступление это то что ты можешь устроить мемы но я вообще в целом хотел поговорить про джебсон кто-то что-то слышал про него но при этом он умеет и проверять инварианты что вы ему показали но его главная идея это проверка на линия реализуемость если в тексте пытаться это выразить то ли реализуемость это очень простое но строгое правило все вот операции которые начались после операции изменения обязаны видеть систему А в консистентном состоянии и б в состоянии которое не предшествовало тому той операции которая изменила нашу систему но словах это очень сложно и непонятно поэтому у меня есть я понятное диаграмма где по оси X у нас время А ABCD это те операция которые мы пытаемся и вот в самом верху в самом начале операция а меняет нашу систему и условно пишет в значение X 1 и это значит что начиная с соленой линии до синей Когда у нас есть операция C которая меняет систему любой чтение системы то что возвращать именно значение 1 но вот операция е уже обязаны вернуть нам значение 2 если вот если такой подход наша система обеспечивает Это означает что она линия реализуема вообще популярная история в тестировании распределенных систем есть тесты для монги для но у джебсона есть ряд проблем Первое это скорость он не он недостаточно производительный чтобы нагрузить ваше ваш тестовый какой-то кластер или ваш тестовую систему чтобы отловить все все варианты все какие-то проблемные участки и его проблема со скоростью она вызвана тем что он описан на глажуре и это вторая его главная проблема потому что я фото помню это не просто система которая вы натравливаете на свой код вывод обязаны будете писать тесты и писать их на Как бы как бы не вот обидеть тех кто любит популярном языке так скажем это большая проблема для команд потому что даже если вы потратите время разберетесь и сможете писать тесты то никто больше в вашей команде этого делать не сможет и поэтому всё плохо Но это даже не самое то главная история А у джебсона достаточно плохая документация а точнее ее от отсутствия И вам придется не просто выучить калошар вам придется читать Вот исходники джебсона читать те тесты которые уже написаны чтобы чтобы написать свой то есть нельзя просто открыть какой-то сайт документацией прочитать уже что-то свое делать поэтому мы взяли и написали свое И сейчас я хочу с вами поделиться теми инструментами которые мы вот использовали для этого Потому что это не какой-то не может сделать это все сможете тоже повторить на своем любимом а если говорить Да что у нас вообще есть еще раз напомню У нас есть узел с ним проблемы с сетью нам ее надо как-то подымулировать сбой с буддийском и системные часы если говорить про узел тут наверное все более или менее просто вам надо уметь посылать вашему процессу разные сигналы при этом важно знать то Как ваша система устроена то есть нельзя прийти Извне такой О сейчас я это всё протестирую потому что узел может по-разному реагировать на разные сигналы не только Например у нас еще есть такая история про Макс например сеть тут то что достаточно Все просто потому что у нас есть который нам представляет все Все инструменты для того чтобы пытаться как-то взаимодействовать Например если мы хотим входящий трафик исходящий У нас есть простое правило для iptables если мы хотим там потерю потерю пакетов в нашей сети от эмулировать или замедлять ее у нас есть командочка TC Окей со злом с сетью все понятно Это достаточно тривиальная история у нас есть диск а как нам эмулировать вот ошибки в нем да то есть чтобы условно на какой-нибудь там в рай вернулся ошибка Или например на врать Мы записали не все данные или проблема совсем да Когда не все системы проверяют то что сработал корректно Если кто-то хочет узнать можете после доклада спросить я вам расскажу но мы не Обращаемся к напрямую а нам операционная система дает некоторое под абстракцию Да видя там врайта вот Рида на достаточно простых команд под реализацию которых на себя берет файловую систему поэтому что мы взяли написали свои файловую систему и тут тоже быть крутой слайд о том как мы выложили ее венцор что вы можете это использовать тоже но я хочу вот извиниться перед вами у меня не получилось успеть все хорошо сделать чтобы это было не стыдно показать Поэтому сейчас я просто хочу поговорить о том на чем она основана и как с ней потому что ее точно будет просто следите за обновлениями на хабре Она позволяет нам писать свою систему Ну так вышло и она почти но отработать с ней достаточно просто вам достаточно включить модуль Fuse в ядре создать пару территорий и запустить все теперь любой процесс который вы запустите там в этой Монте Да FS он будет использовать он будет ходить Через наш файловую систему и что важно у нее есть простой htp интерфейс который позволяет вам водить любую ошибку для практической любой операции это простой вопрос которым мы хотим сказать что на любой вероятностью система должна давать ошибку Но на вот любой файл Это конечно не так круто поэтому мы можем указать Рекс по которому система будет выбирать файл и уже для него применять правила при этом напомню что не только для Write Но для кучи других системных вызовов но в какой-то момент мы хотим например остановить наш тест и попытаться поставить систему в от исходное состояние Для этого просто есть отдельная командочка которая чистит все эти файлы которые вы до этого ей назначили если говорить есть Очень интересный инструмент который называется и Он позволяет строить ваш код проблемы на основе некоторой от логики То есть вы просто описываете декларативно Что вы хотите А как на себе берет кофе а если вы еще вот помните что такое линеаризуемость то для кого есть очень крутая библиотека которая может проверять по моделизм она или нет она быстрее чем та что используется в например данных что вот у меня например есть быстрее в разы то есть проверка тех же самых данных занимает десятки минут в том случае когда это занимает секунды с джебсоном все плохо Как я уже сказал в плане документации Но если вы знаете кого Шур то мне кажется для вас это самый идеальный от инструмент потому что очень много тестов для уже существующих систем которые вы можете взять и адаптировать под себя и я не сказал про время Да я сказал про диск сказал про сеть А про время нет про время есть такая штучка как которая умеет Мне кажется все что угодно с делать с темными часами она может и ускорять их и замедлять поэтому вы можете просто взять и использовать она написана на си это простой который Соберется любой системе выводы если у вас идея какая-то есть или взяли то не ленитесь и потратьте время на изучение потому что а в конечном итоге вам все равно придется это сделать все те вот компании которые я перечислял там it CD сцилла и вот прочее Они все в итоге приходят именно к тому что им нужна четкая математическая модель которая доказывает корректность системы Если вы еще не пишите а с тесты я иду к Вам потому что кажется что это то будущее которое нас ждет это хорошо но система все вот усложняются и осложняются и поместить в себя все краевые случаи становятся все сложнее ну и сейчас это наверное единственный инструмент который вы можете просто взять и использовать для тестирования своей системы как черного ящика но я надеюсь что мы за не только который мы используем Он написан на куда более приятном языке Могу конечно же на этом все Никита Спасибо большое друзья я вам напомню что у нас вот этот qr-код для вопросов из зала для тех вопросов на которые мы не успеем ответить вслух Но в том числе дирел и следят чтобы на все вопросы по отвечали А теперь давайте начнем давать правильные ответы на сложные вопросы Привет Спасибо за доклад много вопросов первый хоть пример немножко не хватило чего верифицировали на самом деле если был пример был прикольно послушать второй вопрос удивлен потому что кажется более одной собственной есть вообще ничего не подошло и отсылы есть вроде и другие есть проблемы Первое это то что там используется как протокол tript вот такое себе и второе что их история не умеет хараптить данные она умеет лишь возвращать ошибки на то там наврать или не всем Но не Но не умеет Да повторюсь То есть ты его Сохранил на диск Потом пытаешься восстановиться а там у тебя не то что ты ожидаешь Вот она так не умеет не умеет статистику то есть условно ты не ну ты мог там забыть ты создаешь директорию и мне достаточно ее просто создать Нужно позвать чтобы она точно была И вот например ты можешь просто про это забыть но наша штука тебе скажет что вот ты вызвал столько-то в рай Вот и вызвал столько ты это и в ней ты можешь посмотреть что там что-то создаю какой-то файл не позвал это на первый вопрос да примеры порой примеров чего Можно повторить что валидировали в ВК при помощи адаме полетели систему под кодовым названием Барсик она умеет такое автоматический фейловер я сейчас не буду вдаваться сильно в подробности потому что я очень надеюсь настят Вот ребята в зале которые Надеюсь выступят На осеннем с этой темой я их это вот поэтому очень надеюсь Привет Ну вот ответ нет потому что я сказал это отличная идея я себе это записал в отлично это студентами тема такая пока один выступает остальные конспектирует вопросы и рекомендации быстро Привет Никита Спасибо за доклад У меня вопрос про тело и плюс подскажи может быть ты когда его изучал Я пробировал столкнулся ли с какими-то ограничениями в его работе может быть чего-то он не умеет например доказать не доказуемую теорему математическую либо что-то в таком духе Спасибо Смотри я с этим не сталкивался Потому что те вот истории которые я пробовал на нём Ну например это там доказательство что каналы в его корректные да или там какой-нибудь он с этим справляется и он Именно для этого и предназначен То есть наверное типа любую какую-то математическую модель доказать Я не уверен в этом но именно практике то что там вот Обычный Спасибо будьте добры Привет Спасибо за крутой доклад ты упомянул про fast-тесты А если какое-то Понимание Вот после нескольких дней запусков На твоей системе если понимание кавереджа то есть сколько примерно кривых случаев ты покрыл Ну насколько ты уверен в том что действительно fastest и сошлись да Он позволяет это Ну то есть вы Спасибо я об этом не сказал что он не просто говорит что типа Коли Не ОК но вы можете узнать какой процент покрыть сейчас я наверное не могу когда не отвечу сейчас но знаю где посмотреть можно вот знаю куда сходить Да вот пожалуйста Здравствуйте баиров тимуртиков Это битва доставок короче очень интересный сложный узкоспециализированный доклад там был сайт согласованностью Я вроде как понимаю модели согласованности но вы так быстро пробежали по этой диаграмме что она мне кажется вводит заблуждение можно к ней вернуться и подробнее рассказать там когда второй врать был не совсем Было очевидно Почему произошло не произошло смена значения есть вероятность что я понимаю в конце концов Ой вот это был второй враг Но он не перезаписал значение для следующего ряда У нас есть Нет ну ладно вот у нас есть а который записала в X1 и завершилось на Зеленой линии Б начинает читать из икс один получает потому что C вот начинается здесь а заканчивается на синей линии врать заканчивается на синий да тогда что это за пунктирная линия которая по бокам от Рида в райда все теперь понятно спасибо за такой обширный интересный доклад вот для систем которые только-только появляются кажется звучит все достаточно оптимистично Но для больших систем в эксплуатации уже не кажется таким все радужным поскольку страшно представить как переписывать не переписывать а транслировать большие системы например там процессинговые фреймворки на тело и плюс вот есть какая-то надежда на развитие туллингов Вот таких вот языков трансляторов как паскал для уже существующих систем Что повышает доступность формальная верификации а вопрос был вопрос был Простите меня Повторите суть Да подожди отвлекаешь меня А вопрос был про то что есть плакал Да Почему бы нам не использовать его вместо этого плюс Ну как да Как вариант Но я больше про развитие Вот в этой в эту сторону то есть чтобы такие инструменты не знаю больше были доступны для больших систем потому что даже описать все формулы логике и что может есть может появится инструменты которые позволят это сделать я могу вот рассказать в двух словах о том куда смотрит Сейчас наша команда Она смотрит в сторону того чтобы описать модель и с помощью условно там аннотации в коде сделать связь код модель чтобы ты мог просто написав модель на плюс не вот изучать код но правильно его аннотировать и понять сходятся ли она но это пока только в зачаточном состоянии Правильно же вот мне друзья на этом наше стекло но дискуссионная зона у нас здесь на солнышке на свежем воздухе Подожди а за лучший вопрос конечно а теперь лучший вопрос сколько мы Два подарка Друзья помогите пожалуйста Магните рукой кто сдавал вопросы а мне вот понравился вопрос потому что я прошел достаточно быстро по ней Спасибо тебе тоже памятные призы от конференции Спасибо огромное Господа у меня к вам один вопрос Почему вы говорите про чтение в Райд как будто бы у Вас немецкий акцент не сметные врать Говорите Как фильмах Гая Ричи там же дабл я не читается друзья здесь дальше сначала Сначала видосик с одним банкиром потом выступление другого следите за расписанием"
}