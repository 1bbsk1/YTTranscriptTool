{
  "video_id": "Ua5nfQWboBo",
  "channel": "HighLoadChannel",
  "title": "Эндогенные угрозы физической целостности СУБД / Андрей Бородин (Yandex Cloud)",
  "views": 250,
  "duration": 3044,
  "published": "2024-04-17T01:10:20-07:00",
  "text": "Андрей Бородин из Яндекс клауда Вот это хоть Я попробую на самом деле Попробуй вот да всем еще раз привет Меня зовут Андрей тема с эндогенными угрозами на самом деле подал доклад для того чтобы систематизировать знания которые у меня есть для того чтобы был повод все сложившиеся кейсы сложить в какую-то ментальную модель чтобы хорошо понимать о чем с чем я сталкиваюсь на самом деле ментальные модели не очень сложилось поэтому на этом докладе я больше обозначаю проблему с которой нам надо что-то делать Давайте поговорим немножко про терминологию есть формальная до выражение эндогенной угрозу физической целостности нарушение физической целостности иногда называют коррупцией данных Это не имеет никакого отношения не к экономике экономической терминологии не к уголовной ни тем более политической на жаргоне иногда называют караптами кораллами и другими словами нарушение физической целостности звучит как что-то из области информационной безопасности но к сожалению напряженная серьезная формальная формальный подход к этой теме он не дает проанализировать все что все что происходит поэтому ребята которые этим занимаются довольно просто выглядят Вот это моя команда эти ребята занимаются контрибьютом в открытые базы данных в интересах Яндекса и клиентов Яндекс облака У нас сейчас есть экспертиза в разработке psgress форков агресса многие маски или мы немножко хотим зайти в пока Руки не доходят вот и ближе к теме Я бы хотел провести такую аналогию базы данных с физическим объектом который известен как капля принца руперта это капля жидкой жидкого стекла которая капнула в воду при этом нашла некоторые стабильное состояние при котором она затвердела и остаточная поверхностное напряжение может составлять 1000 атмосфер либо сотни мегапаскалей из-за внутренней связности объект получается супер прочный если мы пытаемся раздавить каплю принца рупорта при помощи гидравлического пресса с большой вероятностью мы ломаем пресса ни каплю просто потому что материал из которого изготовлен пресс не имеет такого поверхностного натяжения с другой стороны если все-таки находится слабое место в этой капле И в этом месте начинается разрушение она взрывается из-за сил внутренней связанности на мелкие кусочки разлетаются почти мгновенно с выделением огромного количества энергии которое было запасено во внутреннем напряжении абсолютно аналогичная ситуация у нас складывается с системами управления базами данных я бы сказал что это класс программных систем которые сравним по сложности с компиляторами с операционными системами играми вероятно сравним с самолетами или двигательными машин но у нас есть одна характерная особенность операционную систему можно перезапустить и в принципе она должна работать база данных занимается тем что данные путешествуют сквозь время и желательно их не потерять У вас такая религия не терять ни одного байта данных Вот это внутренняя связность характерна именно для баз данных если мы посмотрим на сообщество linuxurnal Мы увидим что какие-то кометы отвечают за файловые системы какие-то кометы отвечают за там page cash tilbe за скидываешь другие подсистемы комиттеры пазгресса отвечают за все к сожалению для того чтобы внести изменения в любую небольшую систему необходимо понимание всей картины это классический не поддерживаемый код но он не поддерживаемый не из-за того что он плохо написан модулярность прекрас ная мы можем выделить все подсистемы они описаны в любом учебнике и у них прекрасные понятные API но этот API имеет множество Corner кейсов которые обязательно случатся на практике Если вы эксплуатируете что-то в масштабе Давайте посмотрим на то что обычно мы предоставляем Но это позволитный кластер который обычно отказоустойчивый состоит из множества нот У нас есть входящие запросы и это единственный способ для данных попасть в кластер вот наша религия состоит в том что любой байт пришедший к нам через пишущий запрос и подтвержден получивший подтверждение комита должен оставаться в целостности в целости и сохранности до его удаления плюс окно восстановление из резервных копий внутри довольно много стрелок как этот байт может обращаться через систему резервных копий как он перемещается между центрами как он уходит в какие-то аналитические системы за которые не отвечаю но тем не менее Вот до выхода в Читающий запросы либо полного удаления и окончания окна восстановления за этот байт вот эти ребята которых вы видели Еще довольно большая команда отвечает нужно чтобы с ним не было проблем тем не менее Ну сейчас у нас несколько десятков тысяч таких кластеров примерно Раза три в год мы наблюдаем аномальное состояние когда состояние разных подсистем противоречит друг другу мы называем это нарушением физической целостности то есть где-то произошла потеря данных Что значит что мы наблюдаем что-то три раза в год любимый вопрос в Яндексе Угадайте какое-то любимый вопрос по моему мнению я не проводил опроса тогда наверное Никто не знает даже мое мнение в общем этот вопрос звучит так что будет если ваш сервис сто раз в данном случае это означает буквально следующее что работать с коррупцией нужно будет ежедневно что в пиках эти инциденты могут произойти синхронно по какой-то причине тысячу раз в день и так далее готовность к нагрузке вызывает необходимость анализа и классификации проблем с которыми мы имеем дело тут есть особенность вот форков погресса что почти всегда их отказа устойчивость построена на физической репликации физическая репликация близка к оптимуму в том плане что она передает минимум байт который необходимо передать для того чтобы создать копию данных логическая репликация почти всегда передает немножко больше чем надо с другой стороны физическая репликация у нее много плюсов плюс в том что она передает данные например плавно у вас не случается большой транзакции которая внезапно надо передать вас есть множество инкрементальных изменений которые плавно доезжают до реплики комитятся и данные транзакции мгновенно материализовались на реплике даже если транзакция писала терабайты но с точки зрения борьбы с коррупцией эта технология вообще никак не помогает передавая отдельные байты Без учета семантики этих байтов мы Передаем разрушение реплики на реплику Поэтому в этом докладе мы Я фокусируюсь в основном на разрушении систем на основе физической репликации логической репликация это неплохая защита страдающая от некоторых видов разрушения но тем не менее пожалуй все что я хотел сказать на этом слайде есть множество форков погресса И к сожалению они страдают от всех тех же самых проблем среди них например гринплан который точно так же используют физическую репликацию но добавляет туда новые сообщения новые то что называется restrus Manager и новые способы интерпретировать байты репликации соответственно добавляет новые способы карапть данные прекрасно еще интереснее еще веселее к счастью погресса у нас пока что больше чем гренланма Поэтому в основном самое сложность сосредоточена в ванильном подгрессе но надо понимать что любой форк содержит баги пазгресса плюс свои баги так процессная модель погресса для изоляции отдельных запросов и возможно отдельных потенциальных угроз постгресс используют процессную модель если мы посмотрим на любом сервере мы увидим множество процессов запущенных от имени пользователя posgros они имеют часть разделяемой памяти общую часть разделяемой памяти часть памяти собственную и иногда это проблема в том плане что многие каши Например у нас то есть сессионное состояние очень большое с другой стороны при нарушении каких-то данных внутри одного бэкенда достаточно убить часть базы данных часть процесса база данных чтобы изолировать от ошибок всю систему в целом К сожалению многие форки эту технологию реализуют не совсем правильно И если вы делаете что-то на основе постгресса то первое с чем надо вам разобраться с идеей критических секций и способом как Прогресс падает процесс падения погресса это тот момент когда ваш код начинается спасать данные на диске От данных в памяти схема довольно сложная к счастью в ванильном пазгрессе Она работает более-менее замечательно есть отдельный случай про которые не буду говорить сегодня но в целом я наблюдал много форков которые имели с этим проблемы опять же слайд про то что у нас есть некоторая разделяемая память в которой у нас крупнейшие частью является шерет буферс то есть страница с данными если какой-то из бэкэндов изменил страницу данных начинает изменять страницу данных он сигнализирует остальным что он находится в критической секции при его падении необходимо срочно спасать данные на диске Вот то же самое происходит при любой работе с шириной давно пинают за то что мы используем процессную модель и не используем трендовую с другой стороны это та часть системы которая защищает от множества ошибок которые могли бы привести к записи некорректных данных на диск с точки зрения коррупции Я считаю что если базу можно починить перезапуском то эта проблема другого класса и я принес сегодня не говорю самое первое структура борьбы с коррупциями это контрольные суммы которые предотвращают ошибки системы хранения система хранения может вернуть вам случайные числа или вашу страницу в том же виде но с небольшим количеством бит-флипов или то что называется сингл ивент в результате разных причин короче странички снабжаются контрольными суммами К сожалению контрольные суммы часто выключены контрольные суммы в прогрессе надо включать если они вдруг еще не включены сейчас погресс умеет включать контрольные суммы онлайн без необходимости остановки кластера правда процесс довольно нетривиальный но к сожалению эти контрольные суммы есть не везде если мы посмотрим на содержимое внутренности кластера мы увидим что у нас есть вот Папочка Base с данными основного табличного пространства есть Global системным каталогом есть вал эти места страничные и хорошо защищены контрольными суммами есть у нас то что хранится в так называемых slru Simple risently use акроним который ничего не говорит о сути охраняет хранящихся там данных по сути это данные о том какие транзакции были законы и какие транзакции являются под транзакциями других транзакций это самое критически важные данные постмоса которые Не защищены контрольными сонными суммами на данный момент по множеству причин паче написанные в 2017 году до сих пор не заклимечен и соловью это очень маленькая часть данных в классе но точное попадание ошибки исходя в это место базу может сложить Насовсем И к сожалению странички с ларью довольно быстро разъедутся репликацией вот над этим сообществом сообщество понимает эту проблему но мы сейчас видим ее так что нужно отказаться от ради совсем хранить комит-лог внутри Base и shared buffer то есть страничек в шее буферс и тогда у них будет контрольная сумма тогда проблема будет решена тогда будет решено на самом деле много смежных проблем Ну про них сейчас не будем все остальные папки которые не отмечены здесь стрелочками в принципе не страничные и Не защищены контрольными суммами э-э в большинстве случаев файлы находящиеся в них имеют размер меньше сектора меньше 512 байт означает что вероятность того что у нас будет э попадут сектора с из разных версии она относительно низкая тем не менее самая критические вещи здесь это наверное Control в Global Ну что такое важное там тоже ещё было дальше скажу давайте рассмотрим пример инцидента с экзогенной угрозой то есть базу сломались наружу Это довольно сложный случай могут быть вот здесь вот у нас пример реализации экзогенной угрозы когда мы неправильно использовали базу при апгрейде базы погресс использует систему сим-линков те файлы которые не нужно менять при апгрейде просто линкуются из старой инсталляции Это позволяет за считанные секунды проводить апгрейды очень больших баз в отказоустойчивом кластере после того как мы провели Апгрейд на Мастере база находится режиме то есть читающая нагрузка работает на репликах Но нам нужно по одной реплике отключать синхронизировать синхронизировать картинкам с мастером но Росинка понимает что происходили изменения сим-линков и те файлы которые Просто подлинковались он не пересинхронизирует Но для того чтобы база корректно взлетела на реплике на реплике нужна статистика без статистики планировщиков показывает погоду и тривиальные запросы базу кладут наглухо поэтому собирается статистика вызовом вакуум db на lizen Stage Вот на этом слайде присутствует бак который привел коррупции данных можете попробовать его увидеть Но нетривиально хотя куда бетоне написано Ну давайте сразу покажу Да здесь не хватало пробела коррупции привело то что вакуум db в до 14 версии склеены неправильные аргументы не распознавал как ошибочные он выходил ничего не делая но возвращал exitcode не нулевой возвращал и система думала что у нас произошел аналайз А по факту у нас произошел вакуум То есть те файлы которые мы симбинками передавали на реплики были фактически некоторые изменения в них не были переданы то есть на самом деле допустить ошибку при эксплуатации прогресса в масштабе довольно легко и она будет очень сложно обнаружимый к счастью Production данных в этом не пострадало То есть это баг который был создан просто форматированием кода в результате применения какого-то почти автоматического форматирования мы получили коррупцию данных Давайте все-таки проговорим более систематично про газогенные угрозы самые невероятное тем не менее случающиеся случаи это ошибки в микрокодах ошибки в компиляции и ошибки прошедшие сквозь сквозь Error Creation colds оперативной памяти на своей практике все три я наблюдал по одному разу вот более вероятные вещи это ошибки в файловой системе ошибки в либо ошибки в Linux Linux я наблюдал ошибку связанную с page cation на некоторых дистрибутивах Ну наблюдал ее чаще чем предыдущие частые проблемы угрожающие часто газогенные угрозы целостности данных они значительно проще это просто неправильное использование конфигурации прогресса не включены в Синг fing включены в неправильном режиме Например если вы делаете базу на своем макбуке у вас в singing просто операционная система игнорирует этот системный вызов сейчас рассчитывая на батарею к счастью мы не эксплуатируем базы на ноутбуках и на macos вообще встречаются ошибки в системах резервного копирования может показаться что резервное копирование это что-то что наоборот способствует безопасности вместе с тем подкозоустойчивом кластере регулярно после разрушения оборудования После отказа оборудования нужно восстановить Часть системы и почти всегда это делается из резервной копии для того чтобы не нагружать праймери узел база данных частый случай когда встречаются ошибки в микрокодах системы хранения данных про это я уже говорил и не то чтобы частый но регулярный случай когда у нас есть ошибки в базе данных которые приводят к нарушению но это уже как раз те самые эндогенные угрозы Вот пример Мисс конфигурации одна из базы у нас была с выключенными контрольными суммами И основная проблема межконфигурации в том что такие коррупции происходят незамеченными они остаются в базе и обнаруживаются тогда когда восстанавливать что-то уже поздно то есть тут нас дежурный отреагировал на проблемы с полкой стал исследовать систему обнаружил что Праймари не стартует из-за одной коррупции а реплика не стартует из-за другой коррупции к счастью это даже Они конечно всё починил но при этом ему пришлось использовать разбираться в битах базой и чинить их э буквально руками э восстанавливая отдельные строчки в таблице э восстанавливая соответствие отдельных строчек в таблице другим подсистемам индексом и село как защититься от экзогенных угроз к счастью защита от того что мы что-то сломали или несколько конфигурировали довольно простая Ну настраивается в соответствии с гайдами это понятно и наверное обсуждать здесь мы не будем другая важная вещь Это мониторинг который помогает в защите даже если вы что-то неправильно настроили хороший мониторинг ваш Вас должен предупредить о том что в базе происходит процесс который в ней происходить не должны специально для мониторинга коррупции данных мы написали экстеншн который называется loggerrarс который позволяет нам в реальном времени в каждой из наших баз наблюдать ошибки которые мы видим в различных бэкендах ошибки размечены кодом коррупции и при возникновении коррупции данных Мы зажигаем мониторинг и в течение минут нескольких минут дежурный получает уведомление о том что база требует вмешательства и исследования но этого оказывается обычно недостаточно для мониторинга состояния и хотелось бы также иметь и профилактическое сканирование зачастую под профилактическим сканированием имеют в виду снятие резервных копий потому что снятие резервных копий уже наблюдает файлы данных каждый байт который лежит на файловой системе придется прочитать Почему бы не проверить К сожалению мы не можем проверить Ту самую связанность системы то есть каждую отдельную страничку проверяя делая резервную копию мы проверим на ней контрольную сумму но вот соответствие двух строчек проверить мы не можем например в девятнадцатом году мы добавляли в проверке коррупции случаи когда у нас в дереве одна страничка показывает на вторую страничку а вторая страничка обратным указателем не показывает Ту же самую страничку такие коррупции тоже случаются И их нужно мониторить поэтому нам необходимо профилактическое сканирование и наиболее понятными поводами для проведения профилактического сканирования является восстановление узла кластера из бэкапа либо проведение апгрейда кластеру при этих двух случаях чаще всего возникают случаи повреждения данных Ну тут какие-то другие способы какие-то другие случаи перечислены Но вот просто перезагрузки физической машины Сейчас почему-то мы кажется не делаем сканирования что в тебя включает профилактическое сканирование в случае с пасбрасом и форками passgress А у нас есть инструменты которые в состоянии провести проверить некоторые инварианты между подсистемами хранения данных сейчас умеет пройтись по битре индексом и проверить ссылки между страницами я это написал там чек был написан Питером гейгеном А я лично реализовал кросс-пейджин вариант чек также человек имеет пройтись по хиппу и проверить соответствие строчек данных в хиппи силогу Ну то есть Ладно в детали сейчас не пойду к сожалению для старых версий необходимо использовать хип-чек не ванильный А выложенные нами в каким-то из разработчиков Яндекс облака кажется георгием рыловым Вера хип-чека которая совместима со старыми версиями по gress в случае с исправлением ошибок типичные ошибки можно исправить при помощи модулей serger и PG ody Hans Если у вас есть свободное время я знаю что у вас есть свободное время когда вы хотите почитать сикод Пожалуйста приходите на комитест почитайте мой патч про добавление профилактического сканирования в Джин индексы в апреле буквально Питер гейген сказал что он готов это кометить но чуть-чуть мы не успели попасть 16 подгресс Надеюсь в семнадцатом у нас это функциональность по проверке индексов будет проверки Джин индекса откровенно не готов его писал Мой студент он работает что-то находит но мы боимся что он может заблочиться продуктовой нагрузкой можно использовать нагруженной базе это безопасно это не вызовет во-первых мы гарантируем что нет Используйте если человек сработал проблему точно есть во-вторых мы гарантируем что он не не остановит вашу базу данных самое страшное что случится он уменьшит пропускную способность для того чтобы прочитать все файлы Давайте поговорим про эндогенные угрозы это то что случилось внутри базы данных из-за ошибки рассмотрим пример последней в котором Я участвовал фикс это фикс очень простой был мы отреагировали фичу В чем состояла фича pasgress страдает Да наверное текст очень мелкий получился Ну да ладно я расскажу о словах passgress страдает из-за длительных транзакций потому что необходимо хранить в базе старые версии строчек которые могли быть видны старым транзакциям которые долго длятся есть очень много сервисных транзакций которые тоже являются длинными одна из них это перестроение индекса индекса накопился bloat или по какой-то причине вы хотите его перестроить или просто вы хотите создать новый индекс к счастью в системе есть которые позволяют создать индекс под нагрузкой то есть не блокировать таблицу от изменений сначала создать индекс как-нибудь сосканировав таблицу и потом сделать индекс валидным просканировал в таблицу второй раз И найдя Что изменилось пока мы создавали индекс первый раз в шестнадцатом подгрессе в пятнадцатом воскресе одно из фич было то что валидация индекса и создания индекса не держат Горизонт сидов То есть те строчки которые они видят при необходимости можно удалить потому что мы же все равно удаляем зачем добавлять индекс но к сожалению после эксплуатации этого кода в течение года Выяснилось что существует ситуация когда при создании индекса одна и та же строчка претерпевает без изменений индекса и при определенной комбинации обстоятельств Это строчка в индекс может не попасть теоретически такое случилось у одного человека в Яндекс облаке этого вообще не было у одного человека из всех пользователей прогресса тех кто может умеет отправлять репорты пиджеские Аль бакс с другой стороны мы понимаем что любой любое конкурентное создание индекса в 15 версии могло привести к созданию индекса который не содержит какой-то из строчки в таблице что по сути тоже является коррупцией данных потому что читающие запросы могут не увидеть какую-то строчек и дать некорректный результат ответ вот рекомендация была такая что-либо всем пользователям необходимо перевалидировать все индексы которые подвергались конкурентному созданию в метаданных индекса выяснить Был ли он создан конкретно невозможно поэтому рекомендация просто пересоздайте все индексы прекрасно или перепроверьте все индексы при помощи анчека Почему перепроверьте все индексы потому что чек до сих пор поддерживает только B3 и не поддерживает жизнь Хеш Брин Блум рам водку не потеряли водка тоже есть короче много чего он не поддерживает сеть индекс надо было создавать вот основной Поинт этого основная мысль которую можно вынести из этого этой эндогенной угрозы что чтение листа кель бакс Очень полезная штука Но более полезная штука это чтение релизнулся иногда возникает ситуации когда для того чтобы быть гарантированно уверенным в корректности данных нужно выполнить какие-то действия из реализован при апгрейде с 15 или на 15 2 рекомендовали всем обновить все индексы кроме деревьев проверить при помощи типичные проблемы эндогенных угроз вызваны чем-то одним либо внесением новых оптимизаций которые оказались слишком амбициозными систему и появляются соответственно с апгрейдом обычно с мажорным апгрейдом либо комбинация каких-то очень редких вещей которые предсказать в принципе невозможно то есть что-то за 30 лет эксплуатации прогресса случилось у вас впервые в большом масштабе это достижимо что-то действительно Иногда случается у нас впервые почти всегда в случае расследования наших инцидентов мне удавалось найти что-то похожее в рассылках Или настолько Слоу конечно без рекомендаций что делать и сейчас я тоже никаких рекомендаций не давал Просто бывает иногда надо к этому Быть готовым и обе причины по сути являются следствием внутренней связанности системы и подсистемы Если у вас есть какие-то истории о том как вы коррупцию в базе которая связана именно с внутренними ошибками либо может быть какой-то нетривиальный Мисс конфигурацией Найдите меня в биографии есть Telegram Я буду очень рад услышать ваши истории хотя бы для того чтобы систематизировать Какие инциденты бывают и постараться может быть в следующий раз какие-то рекомендации дать что делать Хотя как бы это как способы лечения транслировать на аудиторию я пока такой ответственности наверное не готов дальше я могу классификации сказать что почти всегда внутренняя ошибка обнаруживается Как рассинхронизация чего-то из систем хранения я здесь не упоминаю встретил штуки штуки в оперативной памяти типа они тоже сталкиваются с коррупцией перезагруженная база чаще всего имеет проблему с тем что не соответствует индексы данного хипе либо данные в хиппи не соответствуют карте видимости это приводит к тому что мы не можем прочитать строчку либо как-то не соответствует тому что у нас физически находится в таблице тогда мы наблюдаем неограниченный рост таблицы при вставке следующих строчек либо у нас есть несоответствие хипповыми таблицам тогда у нас Интересная ситуация возникает что в этом случае коррупции мы ничего не можем прочитать на праймери с другой стороны все запросы успешно выполняются на репликах Интересная ситуация когда можно просто восстановить данные в новый кластеры через пиджи дам с реплики проведя валидацию всех Прайм реки одна из проблем коррупции индексов индексы всегда можно просто реиндексировать но проблема в том что коррумпированный Прайма реки дает вставку конфликтных данных если строчка отсутствовала в Прайма реки индексе Вы можете вставить строчку с таким же ключом после чего вылечить коррупцию можно только обратившись к разработчикам сервиса и спросив что они думают что вас образовалось для строчки с одинаковым первичным ключом без понимания логики данных это не восстанавливается хотя и звучит как что-то что чинится или индексом к счастью индекс скажет что-то ситуация наступила и Тогда придётся идти к людям и спрашивать их Что за данные у вас там в базе были вот ну и некоторые относительно редкие баги про не страничные вещи на моей практике я сталкивался в двадцатом году с багами в двухфазных транзакциях и в восемнадцатом году с которой хранит копию признаки того что что-то внутри пошло не так упавший в корку погресс гарантированно проблема любая корка прогресса повод написать редко это Ну то есть вот у нас есть дежурные за гринплан типа упал Green Plan Ну типа Упал Упал пойдем посмотрим упал Да это короче это классная ситуация потому что это повод что-то починить по агрессия фиксгрессе дает 5 коммитов во всей ветки то есть что-то интересное всегда уникальное с другой стороны Ну иногда этим заниматься страшно из-за возникающие ответственности за данные если запросы повисают на чтение Вы почти всегда можете посмотреть бэктрейсом какие блоки Они читали Если вы видите одни и те же блоки в круг по кругу вероятно в цикле индекса вероятно в дереве индекса возникла ЦИК воздейкал и это больше не дерево Это теперь просто Граф граф Граф и короче не очень хорошо работает вот of memory при выделении одного до Тома почти всегда коррупция но коррупция отдельная ячейки коррупция связана с тем что типа какой-то типа в данных записал неправильно Неправильно себя либо в сетевое представление либо в дисковые утечки локов тоже случаются Ну в утечка логов как утечки не связанные с коррупцией данных Я никогда не наблюдал Ну и разные результаты на Прайма и реплики тоже зачастую проблема связанная с коррупцией данных подозрительные логи это наш основная моя надежда на в мониторинге все подозрительные строчки мы стараемся размечать кодами Если вы делаете просто это Internal Error К сожалению ничего не говорит системе мониторинга и соответственно не триггерит внимание он Call дежурного все случаи повреждения все случаи когда в ходе очевидно нарушение инвариантов между различными системами мы стараемся размещать либо кодом 001 либо кодом 002 индекс карапет и регулярно приносим эти изменения в сообщество они обычно относительно легко относительно легко крепится потому что это просто изменение кодов ошибок в коде там особо ревьюить нечего кроме того что удостовериться что не Фолз позитив Последний раз я это делал 16 июня получается 10 назад на самом деле история с тем что мы чего-то дорабатываем в системе мониторинга это наша основная надежда и мы этим регулярно занимаемся тем не менее все не так страшно как может показаться что база рассыпаются в щепки Если Вы посмотрите за 23 год ввести бакс было порядка 10 тредов с подозрением На ситуацию приводящую проблемам по факту эксплуатируя десятки тысяч кластеров Мы наблюдаем единицы случаев единицы инцидента в год То есть ситуация редкая Но каждый случай заслуживает внимания систематизации и работы над этим Если у вас есть какая-то информация приносите информацию приносить эту информацию Мне так да не разбудит вас мониторинг Обычно говорят в Яндексе но не будет потому что я очень крепко сплю поэтому я переформулировал Пусть он не пытается вас будить что будет хорошо с вашими данными Я буду рад услышать какие-нибудь вопросы Сейчас самые лучшие вопросы Я дам железный мозг с Алисой Давайте перейдем к вопросам Спасибо поднимайте руки вам принесут микрофон и в него вы сможете задать свой вопрос так вот первая рука по центру Спасибо за доклад Меня зовут Александр не могу сказать что было просто но хочется простого тоже услышать А с чего начать вообще чтобы ну вот там Понятно в Яндексе десятки тысяч кластеров а там когда у тебя их десятки или или десятки понятно что все равно когда-нибудь может тоже произойти с маленькой вероятностью но все равно первое что стоит сделать это ну проверить что у вас есть валидация резервных копий Если вы восстанавливаете резервную копию после чего прогоняете на ней Чек и Вы почти гарантированно исключаете себя из первой волны проблем потому что у вас есть Point and Time Recovery и есть валидные бэкапы Вы не потеряете чего-то больше чем несколько часов без бэкапа вот когда у вас есть верификация бэкапа Неплохо бы настроить мониторинг того чтобы как проверяет Если вы используете нашу быка пилку в LG либо крест в метаданных бэкапа есть информация о том сколько страниц получила код получила некорректное контрольные суммы контрольные суммы страницы снятого бэкапа имеют право расходиться То есть когда мы читаем страницу база данных Может ее записать мы считаем половину старой страницы половину новой нормальная ситуация но ошибок должны быть единицы в базе на терабайт не должно быть сотен тысяч ошибок вот мониторинг целых страниц в базе данных тоже полезная штука после того как у вас есть этот мониторинг Я бы рекомендовал сделать мониторинг ошибок то есть разделить фаталы worlding и нарисовать график на них и может быть даже настроить какие-то пороги уведомлений после этого фильтровать Ну то есть это делается при помощи вот этого extensionals где-то там он был написал этот Хабиба все что делает мое подразделение самого первого байта присутствует в виде открытого кода вот этот экшен позволяет видеть без нагрузки на чтение логов видите Какие ошибки случались статистику по ошибкам Вот соответственно настроить мониторинги на коды ошибок которые являются достаточно подозрительными примерно все что у нас есть спасибо Вот у нас еще вопрос есть первом ряду Андрей прием Андрей Спасибо за доклад вопрос прям по вот этому слайду Вот делаешь коммиты в мозгресс добавляешь коды ошибок но админы других организаций могли завязаться на те коды ошибок которые там были раньше или не могли Что ты делаешь сто процентов случаев комета мы заменяем код 0 то есть неизвестное внутренняя ошибка которая случается в тысячи разных случаев А вот of memory за extention пель прокси вообще бросает просто так потому что ну типа что-то у нас там не знаю тайм-аут 00 выбрасывает мы заменяли только дженерик коды которые ничего не значили на семантическая нагрузкой коды которые говорят о том что у нас случилась коррупция других ошибок мы не вводили и при этом собираешься они хранятся Спасибо спасибо Еще вопросы второй ряд по центру Спасибо за доклад У меня достаточно глупый вопрос тут нет глупых вопросов вы говорили что писали модуль mчек для киста Ну и для гимн и для гиста писал студент ваш для джина писал студент писал я ну писал по дороге в аэропорт поэтому может получился не очень хорошо тогда я немного перепутаю Просто мне было интересно зачем вы так издеваетесь на студентом Он хотел диплом он сам виноват у него в принципе очень много сложная кодовая база ну как бы он сам захотел у него был выбор вообще у нас довольно давно традиция что мы берем много студентов на дипломы США из Уральского Федерального Университета и даем какие-нибудь задачи которые должны были бы сделать сами у них всегда хорошее меню учебы Они могли выбрать из этого например в системе резервного копирования У нас сейчас 150 контрибьюторов то есть многие люди приходили чтобы сделать какую-то конкретную фичу Мы всегда ревью ими код Кроме того после того как Георгий написал Георгий сейчас даже не в Яндексе работает он кажется в тиктоке сейчас я могу ошибаться после того как он написал откуда он отправил в хакеров И после этого хейтеринг зарабатывал его в течение года пытаясь расследовать один из репортов который пришел то есть там уже далеко не только код студента студент создал первую версию которая иногда давала Используйте Теперь мы вас есть версия которая не дает Позитив но у нас нету случай когда мы проверяем соответствие что те строчки которые есть в таблице есть также в индексе эту штуку надо еще Дописать это именно то чего половина этого патча нотка Мида был нас в течение реализовано Есть что написать приходите если хотите этим заняться в личку Если хотите диплом тоже приходите больше большинство универов я не смогу договориться вот не понял Спасибо тебе у нас два вопроса один по центру в конце и один посередине здесь же по центру там Спасибо за доклад Какие параметры ядра операционной системы и настроек файловой системы Вы могли бы подсказать Чтобы избежать коррекции данных при падении сервера Хороший вопрос к сожалению у нас этим занимается другая группа и вот настройки оси и файловой системы я не смогу подсказать Но это отличная идея пожалуй прошу дойду до людей из железной части и спрошу у них Что добавить в презентацию в следующий раз я не могу ответить на этот вопрос Здравствуйте Очень интересно наивный вопрос А вы как тестируете это все дело там жить как-то Ошибочки создаете какие-то вертолочки в которых наводите страх ужас на шальной странице памяти тестирование чека Сделано в стриме это перловый скрипт который вносит несколько типов типичных коррупции в небольшие таблицы и проверяет что они находятся для того чтобы посмотреть как это сделано надо посмотреть чек Папочка T там перловый скрипт который выполняет проверку того что это функциональность действительно работает правда что там немножко свой первый что там немножко свой первый ну нет я ну вот просто типа я последние две вещи которые проверил что купленный из магазина MacBook и установленный из интернета Faster Linux на обоих собирается psgress и работает с теми программами которые стояла из коробки Возможно там надо написать брюйн стал или оптин стал первым ничего сложнее А еще надо зайти в Степан и сказать installipc Run Кроме этого ничего делать не надо кастомного чтобы все тесты поиграться там тесты завелись спасибо спасибо то Подойдите прямо ко мне Я прямо чувствую себе желание сделать больше по грязистов Если вы хотите писать носи или наперле то давайте это сделаем устроим клуб красноглазников да да ваш вопрос я не смог ответить потому что я больше про базы было много экзогенных угроз про CPU про файловую систему пробит флипы из-за космических лучей если что-нибудь сетью у на докладе Алексея миловидова был пример когда он расследовал карапшен в клик-хаусе и Нашел в сети Яндекса один Switch который бил пакет определенным образом Так что они проходили через суммы в случае спазгрессом у нас два уровня защиты первый у нас это понятно типичный суммы второй это чик сумма Волга и вот комбинация этих сумм пока делает коррупцией достаточно редкими чтобы мы их никогда не видели то есть когда вал ресивер столкнется с битым с битой контрольной суммой вал Рекорда он запросит его заново второй раз на придет корректно если она была корректно записана если она не была корректно записана то база упадет в корку и вы заметите это очень интересно спасибо огромное спасибо Давайте последний вопрос Спасибо вот от погресса как конечного продукта хотелось бы иметь набор законченных операций операция восстановления бэкапа она Ну как бы ее нужно сопровождать проверкой Омчак химчака не нужно Если вы как это сказать не выиграли в лотерею коррупцию это очень маленькая вероятность вы выиграете Вот соответственно Ну как бы если вести разговор с менеджерами на менеджерском они скажут Ну как бинарная логика либо ты играешь в лотерею либо не играешь даже если не выиграл то есть ну из этого следует чтобы защититься от этих ошибок нужно при восстановлении бэкапа проверять чеки если какие-то готовые скрипты рецепты вот скриптик как бы расширение точка Который запускаем у нас все хорошо а или может быть и следует и вправду добавить к самому восстановление с бэкапа и эти процедуры Дело в том что у нас нет такого вещи как восстановление из онлайн бэкапа Ну то есть у нас есть PG backupg Store который логически не подвержены коррупции Если Вы только там в самом бэкапе что-то не намухливали вот э-э а физический бэка под такой конструктор Когда у вас есть Операция С одной стороны принести не консистентную базу с другой стороны догнать её до точки консистентности с третьей стороны докатите её до нужной точки во времени с четвёртой её за промоутить для пишущей нагрузки из пятой а м чек для того чтобы проверить То есть у вас уже конструктор это не Делай раз делай два это Делай раз два три четыре пять шесть семь восемь девять десять и то что вы добавляете ещё один шаг в этот скрипт Ну вроде как небольшая проблема вот а другую часть вопросы было на что я не ответил а это один вопрос про то что как бы как никогда не играть в лотерею Как подготовить себе рецепт вот как бы я делаю операцию одну Вот одна кнопка нажала она сделала мне хорошо вот если бы посольством все было так просто облака бы в принципе не существовать если бы можно было настроить в один клик по грязь или в один клик не знаю там другие базы Oracle в Microsoft сиквел сервер Там те же самые проблемы если бы это можно было бы сделать тривиально без использования экспертов в этой области наверное жизнь была бы существенно проще и дешевле надёжнее Но к несчастью мир не такой все сделано людьми это хорошо потому что это было весело и будет весело и плохо потому что люди делают ошибки как производстве оборудования так и при производстве софта Я предлагаю на этой прекрасной мысли остановиться поблагодарить нашего спикера Мне нужно подарить мы должны выбрать вопрос да лучший вопрос был про список в каком порядке защищаться вот я хотел бы станцию подарить и вопрос на который не смог ответить я книжку хотел бы подарить Может там что-то полезное будет написано подходите за своим подарками так вот спикер Не уходи от нас Вот человек с книжкой Андрей Вернись потому что для тебя у нас тоже есть подарок подходите за своими подарками хорошо Спасибо Давайте еще раз поблагодарим Андрея за его прекрасно рассказ и благодарим вас за ваши вопросы за ваше внимание"
}