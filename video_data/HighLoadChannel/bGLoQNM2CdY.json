{
  "video_id": "bGLoQNM2CdY",
  "channel": "HighLoadChannel",
  "title": "В ногу со временем, или как делать upgrade PostgreSQL / Андрей Сальников (Data Egret)",
  "views": 2002,
  "duration": 2932,
  "published": "2018-08-16T04:07:57-07:00",
  "text": "добрый день меня зовут сальников андрее я работаю в компании datagrid мы занимаемся сопровождением вас близко возле скал разнообразных клиентов и данный доклад это как бы сбор нашего опыта по апгрейду по сгрыз узкую методикам которые существуют и разбор так сказать проблемных ситуаций потому что у обычных компаний когда две три базы всего лишь в подписи процедура апгрейда она довольно проблематично у нас же это ежедневная работа по факту вот и сразу начну какие обычно проблемы чтобы обновить пожгли сыскал людей это же ты такси работает то есть зачем нам что-то менять мы сервисе на 24 это тоже понятно что мы не можем остановиться что бы нам нужно все время работать у нас слишком сложную систему то есть если мы обновимся то у нас приложение там начнут или некорректно работать или вообще бегут и вдруг мы потеряем данные при обновлении но о чем это все в основном отговорки чтобы не делать сделать апгрейды надо и надо их по причине того что это новые фичи и bug fix причем иногда очень критичный я чуть позже покажу ну в общем то зачем обновляться вот это сказал это баг фиксы и новые фичи которые могут быть вам интересны и также улучшение производительности что немаловажно я расскажу о тех методиках обновлений возраста которые есть которые мы используем в той или иной мере расскажу о проблемах при каждой на каждую методику обновления какие там проблемы есть и как окно необходимо решать и так же расскажу как избежать или минимизировать простои ваше вашего приложения и у левашев в общем системы чтобы или downtime не было совсем или он был минимальный и в общем то после этого доклада снова цель то что посмотрев на методике какие они есть какие есть проблемы после некоторых тренировок вы сможете это делать самостоятельно и быстро немного вводная информация о том как у нас делится версию после со скал до десятой версии который вот сейчас высшего недавно у нас за мажорную версию отвечали 1 2 циферки разделенной . и минорной это последняя цифра к мажорной версии у нас как правило несет какие-то новые фичи и но в основном это новые фичи виновная версия это как правило баг фиксы которые со временем приходят при монтируется вернее с десятки было решено изменить нумерацию версией десятки теперь как бы одно число это мажорная версии второе число это минорная версия далее какие типы обновлений бывают у вас груз sql минорное обновление минорное обновление она у нас идет в рамках только одной мажорной версии то есть если у вас версия 96 то у вас минорное обновление именно в рамках версии 96 из 96 2 на 96 594 также 942 на 94 сколько-то там до десятки это уже будет здесь нужно 10 1 но когда 10 1 выпустят пока его еще нету мажорное обновление это у нас соответственно обновление мажорной версия поисках искал который вызывает как правило больше всего проблем и вопросов и на этом будет тому очень много всего мажорное обновление мы можем обновляться прыгает через несколько версий то есть как вот тут вот показан из 92 мы можем обновиться на 10 на 10 версию минорную в данном случае не играет роли потому что минорную ту-ту куда мы обновляемся мы будем брать максимальным я рекомендую брать и максимальная и наш компаний актуальная версия на сегодня это 93 19 видеть как много bug fixes тому же выкатили где 414 959 965 и десять ноль версия 92 ушла из поддержке сообщества потому что есть соглашению то что сообщество поддерживает только пять версий по взгляд скурил поэтому если вы на 92 того как бы надо обновляться если вы на 93 вам тоже надо обновлять потому что de witt приема ужасен подготовка обновлению это общее общие шаги которые необходимо делать во время любого минорного или мажорного обновления до самого обновления прочитайте полностью все релиз но зато действительно очень важные вещи это я чуть чуть позже покажу прямо на примере почему это важная вещь прочитать нужно по всем минорным и мажорным версиям зачем чуть позже будет прям показательный очень пример в найдите на тестовом окружении потому что если у вас используются какие-то специфические функции базы данных вам необходимо свое приложение будет погонять на новой версии базы данных установив там схему который вы используете чтобы быть уверенным что ваше приложение будет работать в общем случае пожгли со склона обратно совместимы и особых проблем не должно возникнуть но это если вы не работаете с iq старшинами iq старшины могут принести вам сюрпризы в этом плане поэтому если вы активно используете extensions of all зависит пользователи после событий на активно используют то это просто необходимый шаг синхронизируйтесь с разработчиком эта часть относящиеся к обновитесь на тестовом окружении потому что разработчики если вы используете какую-то опять-таки специфическую фичу которая изменилась и вы об этом узнали прочитав релиз нос вы должны это рассказать своим разработчикам и они должны поправить свое приложение иначе как бы обновление у вас будет с ошибкой то есть приложение не будет работать и самая важная вещь которую нужно делать всегда везде независимое обновление это не обновление когда вы работаете с базами данных это сделать бэкап базы и не просто его сделать потому что лежащий где-то файлы это еще не быков баз данных а нужно проверить его проверить следующим способом запустив ну в общем восстановив из него базу данных запустив убедившись что у вас там есть все данные штука вы к ним имеете доступ и что все все там так как вы ожидаете без этого быка база не считается что он сделанный как бы правильно на начну по методикам обновление с минорного обновления тут методика 1 она довольно простая устанавливаем пакеты с новой версии минорные папа сгрыз а тут есть нюанс ну я буду рассматривать linux версии если вы устанавливаете на линуксе то в большинстве случаев установки пакета повлечет за собой restart сервиса который управляет поскольку сказал и вам соответственно необходимо будет как-то в этом позаботиться в ubuntu для этого есть файлик старт конце где вы можете поставить необходимый параметр в расход ветки там скорее всего сервису нужно как-то будет сказать чтобы не ресторатора волс при установке пакетов у нас мы для редко то у нас у клиента собственной сборки как правило исключающий restart обновите все пол из вас грейс пул зависимые пакеты что сюда входит сюда входят клиент сюда входят и extensions который вам необходим и потому что некоторые баг фиксы которые несет минорное обновление они могут влиять на extensions и соответственно те кто выпускает extensions тоже могут обновить свою версию иначе у вас возникнет просто проблема с работой к старшему check point check point для минорного обновления необходим перед операцией перед стартом базы данных потому что пакета вы установили у вас база работает и вам необходимо всего лишь юри стартануть чтобы у вас запустились новые бинарники ни каких изменениях в структуре там внутри нее пожгли не происходит при минорных обновлениях но чтобы аристарх базы прошел достаточно быстро вам необходимо все изменения которые позже хранит память и скинуть на диск и если вы не сделаете check point до рестарта база данных база данных в любом случае делают чекпоинт при рестарте но просто при этом она еще закрывает вас един соединение к себе возможность соединений к себе и у вас этот чек-поинт может затянуться на несколько минут там на полчаса может затянуться зависит от того какого объема у вас оперативная память если вы сделаете предварительно чекпоинт у вас приложение также работает вы потом просто ри стартуете сервис у вас всё хорошо банальный restart база данных получается несколько секунд как бы недоступности базы как сделать это незаметно для приложения если вы используете bouncer bouncer сделает позволяет это сделать вам для приложений незаметно то есть вы в балансире заставить и все соединения базе данных на паузу и стартуете ее для приложений это выглядит как просто долгий ответ от базы данных если вы предварительно сделали check point вот это вот паузы когда соединение подвезли она у вас будет всего несколько секунд ну и в общем то как бы перезапуск базы она у вас стартует после сна новых бинарник ах вы получаете в существенные баг фиксы иногда эти баг фиксы улучшают производительность . как бы все становится хорошо и последний шаг после того как вы стартовали базу данных extensions необходимо обновить потому что если был bug fix завязан и на этот баг фиг завязано была работа какого-то extension а то просто перезапуск база данных у вас extensions никак не обновит и вам необходимо будет сделать актер extensions микстона апдейт я рекомендую это сделать для всех extension of которые у вас есть во всех базах данных и также пункт дополнительные процедуры из релизнуться то есть некоторые баг фиксы требует от вас дополнительных действий которые необходимо выполнить как правило там после рестарта база данных потому что уже появляется новый исполняемый код который безошибочный и вам нужно исправить ошибки предыдущей версии которая работала и вот пример к примеру миграции на версию 962 из релизу нос в данном пункте написано что поправлен баг с индексами и вам необходимо прочитать прямо первый пункт за релиз нос которые идут идет после этого абзаца и собственно говоря и первым пунктом о чем он говорит данном случае горят что в до версии 6 962 если вы создавали конкурентный индекс на какой-нибудь столбец у которого до этого не было индексов то у вас индекс будет некорректный и он не будет никак полечим что он не корректный внутри просто будут как бы неправильные ссылки на строки и какие эффекты это даст ну как бы или неправильные данные выборки или упадет просто backend у вас запросам и собственно говоря рекомендуется что если вы подозреваете что у вас есть подобные индексы пересоздать их после минорного обновления то есть этот пример который может коснуться любого ну кто работал допустим на дверь 61 и обновился туда дальше выше вот пример того к примеру моя у себя просто для примера привел подключился как 961 postgresql проверил что у меня версии 961 посмотрел какие есть extensions потом проделать эти операции которые на предыдущем слайде были и проверяю и вот о чем я говорил зависимых пакетах я не обновил клиент явно вилл только серверный пакет это я на ubuntu делал ubuntu там как бы когда вы установите пол с вас по зависимостям 5 пакет еще четыре пакета тянется случае когда вы обновляете просто один пакет по зависимостям другие не обновляется поэтому тут нужно быть внимательным и получается что я работаю с клиента 961 на базе версии 965 убеждаюсь что у меня действительно сервер 965 версии и собственно говоря делаю апдейт extension он в данном случае у меня extension никак не изменился о чем не базы сообщают и как бы обновление готовы все работаем на новый бар базе что минорное обновление нам дает какие плюсы и хороший она делается достаточно легко установили пакет грубо говоря ли стартовали базу все работается на новые версии по сгрыз несет исправление существенных ошибок случае с индексом но я думаю понятно что достаточно важные важно устанавливать минорные обновления когда они выходят их просто так не выпуск сообщество как дополнительный эффект то есть некоторые баг фиксы они несут улучшения производительности минимальной простой системы это вот те несколько секунд которые вам необходимо на ресторан базу данных все все отлично получается как бы мы избежали возможных проблем которые могли у нас возникнуть из-за багов которые естественно всегда есть в любом приложении а мажорных обновлениях мажорное обновление есть несколько методик для важных обновлений старый добрый пиджи дамп restore и он самой надежной по сути дела пиджея апгрейт который появился несколько лет назад и он самый быстрый и 1 1 2 требует downtime а база данных то есть у вас база данных будет недоступна на какой-то промежуток времени а если у вас но вот совсем никак нельзя и нужно чтобы база всегда был работала тогда основанная на логических репликаций вот обновление они позволяют сделать мажорное обновление базы данных без downtime но вот те кто ребята завета слушал наверное это понимаешь что с логические репликации не все так просто будет начнем с пиджи дам пуск как старого проверенного методы которые мы иногда иногда очень иногда его используем , нам нужно установить пакет с новой мажорной версии по сгрыз а они как правило кантри биться в отдельными пакетами то есть не затирают пакета со старой мажорной версии нам нужно создать новый класс ну то есть нужно запустить создать новый кластер в той же локали что у нас созданном старые старая база данных и запустить его как сервис соответственно конфигурационный файл и нужно соответственно поменяется причем изменения параметров конвекционных файлах помимо памяти там ну базовых вещей периодически у нас там происходит или изменение значения у какого-нибудь параметры вот к примеру с репликации и там какой-то момент сделали убрали хостинга и аджику сделали просто реплика иногда разбивает один конфигурационный параметр на 2 то есть это вся информация она в релиз нос описано и как бы еще раз напоминаю что нужно читать очень внимательно релиз нос создание дампа базы вот это вот строчка как раз принесет нам длительные болезненный downtime потому что если мы делаем просто дам база на работающий то мы делаем срез на момент когда мы запустили дам нам же нужно мигрировать и нам нужны перенести все данные по этому нам необходимо будет закрыть соединение к базе данных что для приложения принципе означает downtime базы данных и начать снимать дам базы и тут все зависит от того насколько она у вас большая если оно у вас уже сотни гигабайт то это будет довольно длительный процесс во времени как мы его сняли бомон дам базы мы восстанавливаем это дампу на новую версию по вкусу скрыл тут как бы никаких проблем нет останавливается все это обычным без проблем на вот да не всегда я отдельно скажу что там будет полезного чтобы вот не было проблем между этими двумя пунктами на следующем слайде я об этом упомянул и запускаем приложение на новой версии по згрлс и все у нас хорошо как бы мы сделали мажорное обновление но при этом имели довольно длительный downtime а вот теперь от детали опять же дампа и как раз сложности с нагруженными базовый но понятно у нас длительный дал time чем у нас нагруженные база ну чем не позвали чем больше базы тем дольше downtime будет если нам нельзя чтобы в downtime базу ходил вообще никак не подходит этот метод вот то есть время прямо пропорционально размеру баз данных обязательная остановка база данных ну то есть не остановка запрещение соединений со старым кластером требует дополнительного дискового пространства зависимости от того каким методом вы делаете это может быть как бы еще плюс такой же размер а если вы промежуточный дамп храните на диске то вам еще больше чем в два раза нужен дисковое пространство и случаях больших баз данных это тем более недопустимо становится некоторые фишки которые помогают передам можно запустить сразу с жучком компрессии данных то есть он будет писать на диск и сразу как-то пытаться упаковать это все дело можно запустить в параллельном режиме пиджи дам то есть это ускорит снятия дампа со старой базы насколько вам позволяет диски и процессоры можно сразу снимать дамб и заливать снимать дам со старой версии по сгрыз ее заливать в новую версию под gresso это избавит вас от хранения промежуточной информации на диске и есть такая такой хороший флажочек при запуске пиджи дам эл схема он ли зачем он нужен прежде чем делать дамп на реальных данных всегда необходимо сначала снять сидом схемы и попытаться его восстановить в новой версии и если у вас там есть какие то проблемы то они как правило возникнут на уровне вот как раз схемы базы данных и так как схема базы небольшая вы сможете отловить бы вы большую часть ошибок и проблем просто сняв такой дамп накатившего посмотрев ага мне нужно допустим пост гис предварительно обновить или еще что-то тут у каждого как бы индивидуально будет это все дело идем дальше пиджак great да конечно ну да в принципе вы правы но как как от сказать не указал об этом потому что почти не используем используемые в основном пиджи дам по узким only и эта вещь действительно нужно и важно которую необходимо делать независимо от того делом мы об греет с помощью пиджи дамп restore или с других методов об этом чуть дальше более подробно скажу теперь опять же апгрейде сейчас секундочку пейджер braids принципе сам немного хакерский метод но зато он дает наибольшую скорость при апгрейде был вальса довольно сложная предварительная подготовка потому что там необходимо сделать довольно много шагов до самой процедуры чтобы избежать проблем во время процедуры эти шаги я на следующем слайде они будут расписаны возможно потерю базы это возможно в режиме когда мы линкуем файлы там есть два режима с копированием файлов данных из ленка ванием файлов данных и есть некоторые сценарии когда можно потерять базу данных при таком апгрейде он самый быстрый он самый быстрый как раз именно в режиме ленка вания файлов поэтому мы его любимым его используем в девяносто девяти процентов случаев вероятные проблемы после обновления эти проблемы почти целиком и полностью связаны с extension нами вот потому что пиджи upgrade он не обновляет extend о том как работает пиджак греет на на входе мы имеем два кластера старый которые у нас данными которые рабочие и новый созданный то есть как мы установили базу новые пакеты создали пустой кластер что делает пиджак great в первую очередь он убирает чувак ну в десятке будет видимым пиджи exact выбирать замораживает и по сути дела выбирает снова с новой базы данных информацию о транзакции о счетчике транзакции потому что нам его нужно будет перенести и старый глаз данных чтобы когда мы стартанем на новой версии по сгрыз у нас счетчик транзакций начался с того места и все было хорошо не было бы побочных эффектов собственно говоря он копирует информацию от пи джей си логе со старого кластера в новый и последним шагом он делает дамп restore схемы но это не совсем то джедом restore схемы как в предыдущем случае он немного другой а информацию так как у нас блоки данных пол грехи не меняется с версией там 84 по моему то файлы табличек индексов о он мы можем или просто скопировать и лис линковать новую базу данных схема там у нас уже создано им и к ней просто при ленкова им данные копирование она естественно займет у нас время время пропорционально тому как много у нас информации ленка вание файлов эту процедуру нескольких секунд все что делается до этого перенес счетчика транзакция это тоже делать мгновение а вот с дампом restore с дампом у восстановлением схемы может возникнуть проблема к примеру если у вас на одном кластере тысячи баз данных и создать тысяч его ну как бы баз данных новом костери может занять длительное время как правило или у вас там сотнями тысяч таблицы как правило нас такой ситуации нет все достаточно как это в разумных пределах и при должной сноровке downtime при таком апгрейде через две на кого не и он будет занимать пять минут у базы данных собственно говоря подготовка пиджи апгрейду это когда вы уже погоняли на тестах изменили все что нужно в приложении но перед самой операции на продакшне когда вы собираетесь все это делается на продуктовой базе данных обязательно проделайте вот эти действия чтобы избежать возможных ошибок возможных проблем при апгрейде и не откатываться на старую версию базы данных проделав эти шаги вы можете стакнуть операцию апгрейды базы данных и как бы но только потерять время начать и подготовиться лучше как как бы кг апгрейды и не устроить себе лишнюю головную боль ну собственно необходимо установить пакет это стандартно создать базу новой версии той же локодо есть апгрейды флажочек чек то есть вы запускаете ту команду прижав great которую хотели планировали запустить указав флажок чек она проделывает принципе почти все при этом не изменив новый кластеры если у вас возникнут проблемы к примеру с каким-то типом данных с какой-то структуру непонятно или еще чем-то у вас пиджак great ругнется и вы сможете остановить свой обратно продакшене и поправить эти ошибки о которых скажет 50 grit они бывают довольно разнообразны и там чего только не вылезает у нас практике но это но это не полный список ошибок дает мы после если человек у нас прошел удачно после этого дела обязательно делаем пиджи дам схему only старого кластера и восстанавливаем схему в новый кластер опять-таки потому что там могут вылезти какие-то ошибки несовместимости между версиями и мы хотим а мы о них знать если они вылезли мы смотрим конкретно по каждой ошибки и пытаемся ее исправить там обычно как бы белым по черному написано в чем проблема и понятно что делать проверьте extension это относится в большей части капот гису как самому распространенному расширению который необходимо обновлять до обновления палласовского футбол grease ql потому что как правило в новой мажорной версии к новой мажорной версии ребята используется выпускает новую версию под гиса и на старую мажорную версию они тоже выпускают обновления а вот старых версий позади сам в новой версии по запас grease и может не оказаться но я так думаю эта ситуация характерна не только для подвеса он просто самой распространенной дума есть некоторые виды station которые тоже потребует каких-то действий до операции апгрейда на самого полиса и если у вас там случился затык на каком-то из этих этапов собственно говоря об их станешь самых ругнется или апгрейт или дам по аулам если у вас возник какой-то затык вы можете прерывать операцию апгрейды потому что самой базы который у вас продакшене вы ещё ничего не сделали и соответственно горят дров наломать не еще не успели но и слилась всё прошло хорошо вы уверены что там great пойдет дальше без проблем собственно говоря основные шаги jab грейды как это сидел происходит после тех предыдущих шагов когда если вы использовали пиджи дом дамб и восстанавливали в новую версию данные то перри создайте кластер в новой версии пузырится потому что он будет там требуется чистый который создается а ты не ты кластер для операции пейджа блэйда остановиться старую вас данных чтобы уменьшить downtime у нас кстати большинстве случаев достаточно на bouncer поставить на паузу то есть у большинства наших клиентов приложения минутный downtime ну реально вот база в этом тайме вот реально остановка включения новой версии от минуты до пяти минут занимает очень редких случаях это бывает длиннее как правило какой-нибудь обслуживание серверов от ваших обменов downtime вам принесет нам в час 25 минут раз в год на мажорной апгрейт я думаю можно позволить downtime а на любом сервисе сделайте check point перед остановкой базы данных потому что те кто and скинет рамс освободит память и избавит от проблем с остановкой базы данных иначе вас она будет останавливаться вечность запустите обновление команды пиджи апгрейт который вы предварительно проверили на этапах из прошлого слайда подождите буквально там несколько минут пока она отработает несколько минут это случай когда вы используете флаг а для линковки старых файлов данных в новый кластер если вы копируете базы данных то у вас downtime будет естественным длительный потому что вам необходимо скопировать будет все эти файлы из старого кластер его новый но как бы если это быстрее зачем использовать копирование и запустите новую версию базы под греческой вот между остановите старую базу и запустите новые случаи линковки в файлов данных пять минут это максимум downtime а который будет есть проблему апгрейда то что при таком так как он является немного как методом апгрейда пожгли соску л то он к сожалению не переносится статистику а таблицах и так как мы запустили новую версию базы данных клиентов мы туда не можем пускать мы должны немного собрать статистики и начал нас просто запроса будут работать еще неизвестно как чудовищные планы будут выполнения по статистике который как ее собирают поступить же апгрейда стандартно там запускается вакуум дебиана lays in strangers и запускается в трёх стадиях по одной цели 10 и полноценный некоторых случаях вполне возможно там генерирует пиджак great скриптик он так и называется она лайс точкой sage его обычно запускает они и не заморачиваются ну если в первый раз делают апгрейды в некоторых случаях можно запустить она was only то есть сразу полный волны статистика по таблицам собирать это если у вас допустим немного таблиц базы данных то наверное это будет более выгодным методам и не большая база данных начиная с версии 9 5 поз grease можно запускать вакуум в параллельных заданиях вакуум baby что ускорит сбор статистики мы используем стандартный скрип ждем стадию с одной целью 10 целями после 10 целей мы разрешаем приложению уходите в базу данных потому что уже минимальная статистика собрано планировщик будет строить более менее адекватные планы выполнения запросов и сбор полноценной статистики на то довольно длительная операциям и как бы стремимся сократить don t 1 по 1 10 целям сбор статистики почти моментальный а уже полноценный сбору статистики мы следим за блокировками потому что приложение пишет базу данных какой-то момент на таблицу вас работает счетчик то что нужно запустить of the vacuum или она лайс по этой табличке и он соответственно заблокирует вакуум и нужно просто на момент сбора полноценной статистике следите блокировками и прибивать of the vacuum процесса как только соберется вся статистика все мы принципе как бы уже не беспокоимся об great собственно говоря завершён и как бы ну соединение разрешаем с базой данных я уже озвучил на каком этапе можно дождаться полного сбора статистики но тут как бы допустимые размеры downtime для вас то есть те этапы на которых акцентировал ся они дают 5 минут вот такого вот простое для приложения которые в принципе удовлетворяет в большинстве случаев многих пользователей по списку r1a бэкстер sense 5 дамп restore вам делает по сути дела команды sql то есть когда extension дампом д'ампеццо у вас создается строчка кредит extension когда вы устанавливаете а создается extension в актуальной версии сбежав грейдим это не так пиджи апгрейт вообще ничего не делается с расширениями то есть запустив базу после пейджа апгрейда вы получите устаревшие версии расширений и обязательно необходимо будет пройтись по каждой по каждому расширению сделать ему alter extension имя апдейт а иначе у вас может быть какой-нибудь старый перестань statements использовался допустим не хватать каких нибудь строчка статистике вот к примеру или еще какой-нибудь эффект неизвестный выльется все зависит от того какие расширения используйте если вы будете если вы сделаете alterac station вы не встретите этих проблем релиз носа для расширения если вы действительно какие-то большие серьезные расширения используете типа того же полос гиса и пиджи statement к примеру тоже неважно почитать перед тем как обновлять базу данных это опять о том самом подписи то есть некоторые надо до апгрейда обновить иначе вы не сможете после апгрейда их с ними вообще ничего сделать а вот как бы то что я говорил это вот самый важный посыл делается alter extend sun sand после каждого обновления независимо мажорное минорное обновление hots тумба я или реплики как мы ее называем как как это все дело делаем мы то есть мы считаем что мы делаем это правильно многие могут не согласиться с нами сначала обновляем мастер сервер естественно потому что как бы с ним основная работа идет о реплику мы оставляем так как мы часто пользуемся методом линковки файлов на оставляем реплику на случай если мы где-то да пусть ну где-то у нас что то не так пошло при мажорном обновлением мастера и в этом случае мы можем всегда сделать про mode ход стендбай у который сейчас подвижном состоянии находится а и прик и как бы переключиться на старую версию по сгрыз и тем самым избежав боль длительного простоя случае ошибки какой-нибудь при обновлении о который вообще никак не догадывались приложение допустим недостаточно протестировали а нос новую версию базы данных ты работать придется его на старую собственно говоря она их мастер мы какое-то время со своей стороны наблюдаем запас гриссом смотря в его логе лезут ли какие-то ошибки какие-то проблемы клиенты смотрят vogue своих приложений когда мы убеждаемся что у нас все хорошо и новые мажорная версия работает тогда мы просто она стендбай сервере устанавливаем тоже пакетом новой версии фон риса и копируем команду быть backup копируем команды быть backup тут в общем то длительность зависит от времени размера базы данных и рекомендуем делать всем так как копирование закончил запускаем как бы реплику на новую версию пожгли скрыл и не рекомендуем использовать и расинг потому что используя пирсинг он по идее вам должен сэкономить время потому что файл с данными у вас не изменились новом и кажется что versin к мы просто изменения нальем который необходимо и запустим базу в новой версии но таким методом мы можем получить сломанный стендбай о котором мы не узнаем о том что он словно и до тех пор пока ему не сделаем про mode не переведем режим мастера и это будет может быть крайне неприятным сюрпризом для вас в случае аварии или по плану ул переключения ролей у серверов использование репликации для обновления пожгли со обычно потоковую репликация не работать между разными версиями и мы никак не можем использовать фишки и и для обновления зато у нас есть куча логических репликаций начиная от лаги встроена логической репликация которая появилась 94 и также всякие триггерные сторонние там вот sony лол он dist одни самых известных собственно говоря логическую рипли catia для обновления используют только в одном случае когда downtime никак не допустим но трудно на самом деле представить такой случай что он совсем никак не допустим то есть всегда она как бы закладывается какое-то временное техническое обновление собственно говоря как выглядит процедура обновления при логической репликации мы настраиваем новую версию по сгрыз sql каким-то образом переносим туда данные настраиваем логическую репликация со старой версию новую это довольно длительный геморойный процесс ребята и заветы вот как раз там мастер-класс показывали я думаю вы согласитесь со мной и после чего делаем файвер и переключаем роли то есть новую версию мажорный по олдскулу который у нас было реплика говорим ты теперь мастера про старую версию забываем какие проблемы когда у вас сложные схемы бы дэвы замучаетесь настраивать логическую репликацию если у вас там 200 схем в каждой схеме по 10 таблиц но это уже будет проблем настраивать как правило логически когда мы настраивали ческая публикацию нас интересуют только данные в таблицах нас не интересуют ни детей у нас не переносится секвенции как правило мы не приносим только данных таблиц это как правило ну бывают конечно исключения из правил и естественно если мы это делаем в рамках одного сервера то нам нужно дополнительно места на дисках что провернуть такое апгрейт и в общем-то это крайний случай когда ну совсем никак нельзя downtime а но тут как бы мучаться каждому как он как ему нравится сводная табличка о том какие методы вот мы предпочитаем пейджа бред через link потому что простую простой система у нас кратковременный там получается места на дисках не нужно с большими дал базами данных а у нас есть клиент у которых базы данных терабайт нее там десятки терабайт это экономит время очень сильно сложность подготовки довольно высокой и риски высокие но мы всегда работаем со стенда то есть у всех есть имбой сервера случай проблемой переходим на стендбай сервера логическая репликация она выглядит вроде как интересом с точки зрения что нету никакого downtime а база данных но на самом деле вот в рисках я написал средний но это все зависит от вашей схемы базы данных они могут быть как низкими так и крайне высокими эти риски пиджи дамфрис top это старый старый метод который когда еще ничего не было в общем то на этом как бы это обзор всех каких методик на этом я все вот несколько ссылок но это как бы презентацию сайта возьмете полезных о том как делается апгрейды уже более детально с командами и вопросы если есть сдавать друзья если у вас есть вопросы поднимите руку пожалуйста ну можно и тоже включен да нет вроде нет а вот так да вот вы отметили что при переносе через пирсинг были проблемы с разрушением это же с этим столкнулись действительно у нас разрушилась реплика но мы так и не выяснили за нехватки времени из-за чего можете прокомментировать может вы знаете из-за чего на секс наверное в том что вы пирсинг отработав по файлу какого-нибудь скорее сил к нему уже не вернется в этом файле могут произойти изменения откуда мы отключили естественно засушенный был я знаю точно вот недавно был митап с николаем сама home ребята песни и завита рассказывали как они с росинками удачно это сделали я не знаю насколько они это проверили что них удачные реплика но суть в том что даже трудно сказать вот мы так и не поняли откуда продолжить изменение ну он выглядит хорошо да по факту эта проблема а да конечно да конечно низко режиму дома даже не проверки факта изменю насти файл данных на источнике самый простой из них это просто изменение даты модификации если мне указать вещей файлик который будет пачек сумму считать могло так случиться что у вас не был указан соответствующий ключик ну сейчас уже сложно вспомнить вообще мы несколько режимов пробовали точно не потому что у нас бросала ворсинки есть такая вещь на которые выступают обычно неофита да если не включить там контроль изменений пачек сумме около не смотрит только на м дейт а это чем он может быть скале сел возникала ситуация когда что-то не было все таки перенесена чтобы дать ему данному так и не разобрались ладно спасибо за теорию хотя бы просто ребята и совета вот они когда я рынком пользовались они свою методику раз рассказали если они сделали апгрейт мастера потом запустили его дали пройти каким-то процессом там которые запускаются при этом в эту базу нельзя было писать мастера то есть соединение к базе мастер были запрещены у них то есть как бы никаких внешних соединений остановили мастер и после этого делали расинг и вроде бы у них все хорошо но нужно спросить проверили они это что них решительно хорошо реплика сделал вот тут еще вопрос с просто этот третий подход и так понимаю если у тебя только одна база и без приказа ничего тогда его не сделать трети вы имеете ввиду приступят не у вы можете настроить на все базы данных которые у вас есть просто у вас никогда просто одна база и все больше ничего там не было продумано безначально что приказ мастерской просто одна база старая версия да и новые да они лобби по факту мастерами являются то есть вы просто сначала вас приложение работает с гриссом старой версии как вы убедительно как только вы достигаете уверенности что у вас логическая репликация переливался данные старой версии в новую версию позволь составила просто переключается приложение на работу снова версий дать вам тобой в старой базе включить это надо ведь ну там можно какой-то из методов использовать зависимости от того если вы там на 93 работать это у вас за 44 но в любом случае вам как-то придется парсить логе вот эти логически репликации валы и ну как ты и настраивать есть возможность ну да ну просто это займет очень много времени если посудить да сколько человеко-часов потратите на настройка это репликации и допустим да он там пять минут согрей нам пять минут спасибо и к маме в как бы в чистом виде и чего тут вопрос друзья у нас во время выпрашивать сожалению закончилась вне зала уже после вы подходите к нам на ставку до дата игры этого в общем-то вопрос там любые из людей которые представят на стойке он ответит на вопросы то может как бы каждый из нас это делать из действительно но на самом деле как исков горячие часы когда выходит релиз мы делаем это ежедневно с десяточки мы пока не торопимся потому что как бы ее со скрипом выпускали ждем первого патча спасибо"
}