{
  "video_id": "ZXDeYrUV7SI",
  "channel": "HighLoadChannel",
  "title": "NodeJS в HighLoad проекте / Владимир Акрицкий (iAge Engineering)",
  "views": 12782,
  "duration": 1982,
  "published": "2017-04-22T14:47:46-07:00",
  "text": "Всем привет слышно Меня хорошо Так ну по традиции с предыдущими докладчика поспрашиваю есть знакомые с nos так хорошо почти все А у кого уже есть проект на NS так Чуть поменьше но тоже есть Это хорошо Так сегодня расскажу я проекте который мы делали в течение последнего года на а так для начала немножко о себе сейчас куда кликер что там а во аэ кликер В какую сторону надо Ладно так а для начала немного о себе Я являюсь тимлидом в компании ih engineering А ого разогнался Сейчас секунду пока не совсем понятно являюсь м компания на высоконагруженных проектах в основном также являюсь с основателем с основателем городе где я также преподаю так есть а там был этот PT который чтобы по этим по пунктам которые появлялось PT файли был Ну ладно В принципе так всё также являюсь основателем в городе льн где также преподаю и являюсь некоторым таким еванг в городе далее о Проекте компания занимается разработками в сфере интернет-маркетинга И большинство из этих проектов являются высоконагруженные Один из таких проектов был наш проект dmp если коротко то это своеобразная база данных интересов пользователей то есть там где собираются все интересы пользователя что интересно и использовать дальше при показе рекламы таргетированной А как же мы получаем этих пользователей мы их помечать партнёров которые размещают на своей странице небольшой пиксель с этого пикселя происходит Запрос к нам на сервер мы помечает этот пользователь он как бы вот нам Мы его уже видели в случае если мы его ранее видели то мы просто обновляем Куку чтобы чтобы она там раньше времени не пропала вот а далее мы получаем тех же партнёров логи и сортируем их Ну проходим по логам смотрим наши метки ки и сортируем их по интересам то есть какие страницы Они посещали что на них интересного было о Проекте на данный момент на данный момент он обрабатывает около 10.000 запросов в секунду это как раз те самые время ответа ограничивается в 10 миллисекунд так как мы являемся не единственными партнёрами у там той или иной страницы Вот и есть некоторая цепочка редиректов для обмена этими данными Поэтому чтобы не задерживать эту цепочку есть строгое ограничение в 10 миллисекунд и обрабатываем файл логов более ой из более 100 гиб логов в сутки но данный модуль уже переписан на другой в данном случае на вот так как с этим не совсем справлялась в сутки оно могло обработать примерно не более 50 гиб архитектура из чего Сотри находится не буду углубляться конкретно какие это уже специфика самого сервиса и большая часть кода осталась на но JS Так а как же всё это начиналось пришёл к нам заказчик попросил Написать ему соответственно dnp То есть это а не что-то новое то есть такие dnp уже есть понятно было что она делает но не совсем понятно как её делать ни заказчик толком не мог адекватно объяснить ни мы сами не совсем понимали и А долго как бы вникай в тему и с самого начала было понятно что м требования к продукту будут часто меняться вот в Ну по мере понимания что это такое А поэтому мы начали смотреть на языки на на чём его писать на dnet пишет большинство наших разработчиков но данная технология не устраивала клиента из-за дороговизны Windows решений также мы смотрели в сторону го но большинство разработчиков которые его у нас узнали а они перешли в проект который там параллельно с нами стартанул А и писали его Наго также поэтому у нас адекватных кадров не было на тот момент а также рассмотрели ХП Python и rubi это как языки которые также знали наши разработчики Но из них нам больше всего понравился Python но в какой-то момент мы вспомнили про Java скрипт который знает как бы каждый второй разработчик вот и решили что на нём будет проще и также у него есть уже встроенная асинхрон событийная модель что как бы даст скорее всего достаточно хорошие результаты а Примерно вот по такому вот у нас получилось сценарию начала разработка шла быстро потому что язык интерпретируемый с ним проще работать можно быстро писать а буквально две недели хватало для того чтобы уже давать какие-то результаты клиенту чтобы он мог что-то увидеть вот клиент доволен всё хорошо до определённого момента То есть хорошо хорошо Да не очень-то а примерно 3 месяца длилось как бы наша разработка в начале пока мы не встретились с проблемами первая проблема - Это то что а клиент начал думать что такая разработка она Ну до такая скорость разработки она так и будет продолжаться дальше не понимая что система усложняется и с ней становится сложнее работать а какие же у нас проблемы появились после Увеличение количества задач от клиента так первая проблема всем известна - это спагетти код он же с ней мы бились Достаточно долго но в конце выработали некоторую методику работы чтобы его как минимум хотя бы уменьшить также мы встретились с проблемы в сторонних модулях сча когда можем сделать это проблема не в нашем коде третья также была утечка и совсем недолго мы разбирались с нехваткой памяти начну с конца так как быстрее всего решили эту проблему по поводу нехватки памяти Как же так получилось что мы с ней встретились мы разрабатывали один из функционалов и проверяли ВС было хорошо после его выкатки на сервер оно начало падать с Ну там получилось более реальные данные запросов чуть побольше и соответственно мы этого не успели протестировать конкретно мы посмотрели на сервер на нём 32 ГБ оперативной памяти как может упасть Ну какм завещал Великий 2 ГБ Хватит все ограничение стоит по умолчанию в насе все наши поиски Нашли только увеличение до 8 Гб И соответственно решением было только учитывать тот факт при разработки то есть нам пришлось откатиться на шаг назад и доработать систему чтобы она могла распределять всё на процессы на отдельные свою работу и соответственно работать уже как многопоточный приложение далее утечка утечка у нас появилась почти с самого начала проявлялась она на графиках в виде увеличивающийся запрос ответ Прошу прощения увеличи ответ на запрос вот нам ничего не выдавал то есть в НМ эта утечка была не замет и время утечки было очень длинное растянутое поэтому отлаживать было очень сложно то есть в течение недели мы там сначала переваливает надо было срочно от неё избавляться это перезапуск приложения каждую ночь то есть раз в день у нас перезагружать приложение для того чтобы сбросить Вот эту вот накопленную память далее проблема со сторонними модулями оказалась для нас наиболее критичной и она задержала нашу разработку почти на месяц как же она проявлялась проявлялась она в виде краха базы то есть есть модуль работы с базой данных который в какой-то момент при определённой нагрузке стал в разных вариациях либо ронять базу данных либо ронять скрипт который работает с ней естественно скрипт нам был более комфортный если он будет Роня вот покарали что проходит в случай момен мог появиться Как через 3 секунды после старта скрипта так и через несколько часов эта проблема была в модуле который отвечал за обработку логов поэтому мы просто разбили логи на более маленькие файлы и просто по несколько раз их обрабатывали пока он там не обработает полностью откат версии также нам не помогал по неизвестным причинам суд по всему проявлялась именно при определённых данных и под определённой нагрузкой и с разработчиками была очень долгая переписка потому что проблема появилась перед самым Новым годом то есть на новогодний праздник Никто особо работать не хочет и отклик нам приходил Примерно там м не более раза в неделю какой-то то есть мы писали какой-то скрипт чтобы разработчики могли его воспроизвести у себя проблемы но у них она не воспроизводилось они запускали его на несколько суток но у них никаких падений не происходило а ближе к концу января у нас появились А сопереживают так сказать а у которых была подобная проблема но появлялось немного в другом месте и там разработчики более проще смогли его воспроизвести и фикс у нас пришёл где-то спустя полтора месяца уже ближе к кон середине февраля А сними сюрприз у нас пропала утечка то есть эти две проблемы были как минимум либо взаимосвязаны либо были исправлены вместе один момент так спагетти код у нас получается проблема длилась почти месяц у нас появилось время немного бы разбра в свом коде откатиться назад посмотреть что мы сделали не так такую технологию которую можно охарактеризовать такими тремя буквами м и подразумевает под собой модуль модель и микросервис первый этап который предстоит для того чтобы переходить на такой логии это разбивать большие функциональности на микросервисы и назначать на каждый микросервис человека ответственного микросервисы должны быть не очень большие чтобы один человек вполне понимал полностью структуру это работы этого сервиса и мог им как-то манипулировать Из плюсов это нам дало что из одной свалки мы получили несколько поменьше и у ответственности появились границы Из минусов увеличилось время отклика то есть у нас появилась коммуникация между сервисами которая прибавила некоторые миллисекунды при отте послед врем технология для многих Она кажется Серебряной пулей но мы переходили на эту технологию более осознанно понимая что она для нас действительно даст и получили То есть то что было у нас было одно большое приложение Каждый занимался каким-то своим куском но не было оден нибо ВПО сказать чтоэто дела несть часть вот не совсем было понятно Вот И соответственно приложение работало как-то с базой данных было какое-то время отклика у базы данных а и вот что стало Стало несколько сервисов у каждого сервиса есть человек который за него отвечает и любое любая проблема в этом сервисе естественно падает на этого человека работать над сервисом могут несколько человек также перекрёст но отвечает всегда один какой-то человек также появилась Лишнее Время на передачу данных между микросервисами как мы добились вот передача данных меньше чем в 1 миллисекунду К сожалению в nots это бы не совсем тривиальная задача мы рассматривали ТТП Как вариант изначально но нас не совсем устроило его производительность то есть он нам давал в районе 103к запросов в секунду на один поток То есть если у нас идёт большой быстрый обмен данными мы как бы заполняем этот канал и с трудом управляем с другими сервисами время ответа соответственно чем больше запросов тем дольше врем варьировался от 1но до 3 миллисекунд тогда мы решили просто сделать какой-то небольшой прототип накидать для связи микросервисов по сокета то есть подумали что может быть проще чем просто подключиться напрямую к сокету этого приложения и отправлять ему данные результат нам нас устроили более 100 сся запросов в секунду мы вполне могли передавать передавались они пакетно но при этом ответ не превышал в 1 миллисекунду Даже при 100000 сразу скажу что мы в это как бы этот модуль не открыли ничего сверх нового просто нам было проще действительно написать его самим сделать его максимально простым и также вписать в него балансировку по серверам То есть туда можно вписать несколько серверов и он будет балансировать по рону по ним и выложили его в паблик если кому интересно будет можно ознакомиться посмотреть далее второй этап Как улучшить нашу архитектуру сду Что нужно сделать это выносить всё в модели оставляя в основных исполняемых файлах Только бизнес логику но при этом обязательно не углубляться далеко в ооп так как у нас тогда при этом увеличивается порог хождения и мы более более сложно внедрять нового человека в проект так как ему приходится уже больше знать но большим плюсом даётся то что код становится намного читальне в качестве примера покажу что была например ну это грубый пример была такая вот какая-то структура запрос в базы данных Это не совсем то что у нас было просто как бы наш вариант было сложно вместить в слайд и привёл такой более простой вариант здесь мы видим во-первых иерархию во-вторых у нас несколько методов которые могут скорее всего могут быть даже также разбросаны по этому же файлу в большинстве и для того чтобы както это отлаживать приходится онь много бегать по файлу И вообще разбираться Вот в такой вот лесенки и что становится при использовании моделей то есть мы выносим в отдельные файлы модель и в них реализовало которая относится только к ним логика то есть мы понимаем что мы хотим сделать И куда это передать нету никакой иерархии вот этих вот промежуточных моментов А в моделях проще намного проще разобраться потому что модель становится более ограниченная есть понимание за что она отвечает и как она должна работать в ней ориентироваться становится намного проще а также не стал в слайд прикладывать потому что это может быть такая ну большая просянка кода А так как при этом а варианте у нас немного увеличивается количество кода но читабельность также растёт следующее Что необходимо предпринять Это несколько моделей имеющих какую-то общую логику надо оборачивать в I некоторое своё и превращать их в модели в npm модели для носа конкретно тогда у нас код становится переносимый и Из минусов нам приходится поддерживать отдельные версии для каждого микросервиса А вот покажу на примере если у нас было предположим два сервиса один поменьше другой побольше это и какой-то модуль у него есть какая-то определённая своя версия и в какой-то момент нам понадобилось для например модуля поменьше обновить этот модуль для того чтобы с ним было комфортнее работать получается у нас такая система для модуля побольше обновления происходит более трудоёмкая и нам приходится в этот момент поддерживать Две версии и соответственно править баги в обоих версиях Как нам немного упрощает в этом плане жизнь то что воз все мова репозитория откуда качать и в конце после речки указать тег То есть это версия Которую мы должны скачать То есть когда мы делаем какой-то свой модуль лучше всего сразу же закрепить за ним какую-то версию и при обновлении и изменения в модуле обновлять те сервисы в которых действительно требуется это обновление Да как выд хотелось бы всех попросить дальше при разработке стремиться к тому чтобы все э весь функционал по максимуму дробить Чем меньше э ячейка с которой вы работаете тем с ней работать проще а при поиске проблем если у вас появляется В первую очередь лучше отсекать все сторонние библиотеки А тогда А если проблема не в вашем коде вы просто сэкономите время и можно будет сразу же обращаться куда-то в техподдержку к разработчикам этих модулей и при если при этом проблема сохраняется то тогда уже можно искать её в своём коде так как на это уходит очень много времени и самое главное не забывать про лимиты которые есть в nodejs самое основное что хотелось бы подчеркнуть то что nos лучше всего воспринимать как прототип то есть прототип который вполне дееспособен то есть его можно сделать показать клиенту всё работает и далее если этот кусочек работать не так как хотелось бы если его можно улучшить то тогда уже есть смысл переделывать на какой-то другой язык переписывать но до этого момента не стоит этого делать потому что очень экономит время и нет смысла делать лишнюю оптимизацию на этом мой доклад закончился вопросы есть Владимир Спасибо за доклад У меня вопрос вот те проблемы о которых вы сказали то есть то что например у нас база данных ложилась да под нагрузкой а под какой-то там не ложилась и так далее скажите вы как бы тесты это вообще использовали в проекте То есть он был покрыт тестами и как так получилось тогда что у вас то есть на это не вылезло просто ситуация Особенно с 2 и8 гиба да то есть получается что тесты были не до конца повторяли продакшн Да как бы или что то есть В чём разница как я говорил это проблема Возникала только при определённой нагрузке и при определённых данных то есть в тестах у нас изначально не были заложены конкретные данные которые на начали приходить от партнёра естественно после появления этой проблемы мы это внесли в тесты и бы у нас эти тесты воспроизводили то что на этом падает но при этом мы ничего не могли поделать пока разработчики это не исправить потому что это было написано на более низко уровнем языке в данном случае на Вот и тот жем он не видел потому что это уже находится не в кругу это не там было Да понятно и ещ вопрос У вас очень странно выглядела вот э борьба за оптимизацию в миллисекундах бы Почему Потому понимаете что общий Ну то есть ваш ваш кусок кода загружается в браузер вместе со всеми остальными Да и ваш выигрыш там нескольких миллисекунд Да за который бились он будет благополучно потерян потому что у пользователя там старая версия Хрома или фаерфоксе затормозит там парсинг страницы Там на большее количество миллисекунд то есть нужно ли было общем так убиваться для того чтобы держать время ответа То есть вы получается вы внесли нестандартный механизм взаимодействие при помощи сокетов да то есть отошли от HP получили Профит безусловно Понятно Потому что это всегда так но вопрос В чём вам не кажется что тут оптимизация была ради оптимизации потому что ещё раз говорю в браузере потом когда посмотреть на клиенте что в финале Получилось Да Сколько в какой момент произошло дом рейди событие А явно Вы там не главная проблема то есть собственно скорее всего Спасибо здесь есть проблема того что мы как я говорил не единственные в цепочке и если клиент открывает практически сразу её закрывает надо чтобы цепочка максимально больше прошла то есть насколько это возможно и есть как бы просто у нас внутренняя договорённость была что мы ограничиваемся в 10 миллисекунд и нам просто в них Надо было уложиться если мы делаем больше 10 миллисекунд мы начинаем оптимизировать Чтобы в них уложиться ещ Владимир Спасибо большое за доклад очень было интересно у меня небольшой Вопросик я сначала расскажу предысторию Да его вот сейчас идёт 2015 год вы так удачно прям справлялись со всеми проблемами там Call утечки памяти и тому подобное Скажите пожалуйста вы уволили потом архитектора за выбор этого решения нет Мы также остались на JS и в принципе им довольны Потому что эти проблемы Они могли более существенно сыграть если мыра друго язык кото менее нам знаком са бы все эти проблемы ещё на самом зачаточном уро к сожалению у нас не было разработчиков вообще на jav и как бы с нуля учить кого-то было бы более трудоёмкость как бы вы Note JS использовали просто потому что это круто И вот эти все проблемы потратили миллион человека часов решая callback Hell вы изобрели ооп назвав его м да то есть у вас был процедурный стиль Как вы показывали на скриншоте а потом сказали смотрите как мы можем использовать объекты и у нас код становится чище но Простите пожалуйста это было написано в 2005 году Да но это к сожалению редко используется в К сожалению Именно поэтому как бы моя задача Вот именно призывать к тому чтобы не ограничиваться всё в написании именно вот функционального как-то немножко структурировать А можете тогда оценить как бы успен проект с точки зрения не использования технологий А с точки зрения отношения производительности разработчика к решению конкретной задачи то есть от заказчика приходит задача её решают а не то что мы столкнулись с проблемой колла Но мы её сейчас тоже решим а заказчику всё равно на это на самом деле Ну то есть выбра технологии себя оправдал тем чтот быст То есть например наши коллеги на они выпустили проект там немного другой был проект но его выпустили на порядок дольше то есть позже и поэтому в нашем случае клиент был доволен тем что он видел развитие проекта и уже на ранних этапах Мог уже его кому-то предлагать инв JS подняты Ну судя по тому что там 32 гига 8 ГИГ лимит как Вы балансирует решение носовское балансировка в плане установки ки на нсе остальное по сервисам через вот библиотеку которую мы написали модули Здравствуйте спасибо Скажите пожалуйста сколько серверов у вас использовалось для обслуживания клиентов и какие у них характеристики примерно а в общем не считая базы данных а менее дети серверов а то есть это порядка девяти э но с переездом а Аро Спайка с там in Memory вариант на SSD нам пришлось немножко увеличить там на один сервер для того чтобы ну время немного сократить То есть у вас 30к запросов http - это на девяти серверах а нет это это на всю систему на конкретно систему которая работает с куками четыре сервера Понятно спасибо Владимир скажите вот вы получается до сих пор остались на жесе но при этом написали что его использовать Ну исключительно в виде Ну некого исследовательского инструмента для выявления Ну работоспособности алгоритмов там и прочего то есть ну так как доклад именно использование J в лоде насколько эффективен он и Ну я так понимаю у вас были какие-то разработчики которые знали dnet тот же самый и насколько он ну хуже лучше насколько он отличается от дот нета именно по производительности по производительности конечно Он немного уступает дот нету конкретных бенчмарком присти не могу не сравнивали Но это было очевидно Вот но он даёт более выгодное в ресурса в плане денежных ресурсов то есть разработка происходит быстрее тратится меньше человека часов и даёт достаточно приемлемые результаты в отличие от например Пана или ХП А вот то что именно это JS как-то вы вот этот именно момент использовали Что именно взаимодействие с браузерами нет тиче было пла кайто страни была единстве токо например админ панель в которой клиент мог пользоваться но так как она делалась для своих Вот то она делалась максимально просто То есть у нас больше было к тому что проще найти кадры то есть этот язык знают большинство людей владими Здравствуйте ня зовут Але раскажите пожалуста про GS потому что это такой Краеугольный Камень Как у вас он был построен процесс дебага Ну в первую очередь естественно это если это связано было там с утечкой или памятью то это просмотр через Да использована память и как бы просматривается в остальном дебаг происходит как обычно через то есть понимание стави какие-то точки контрольные Вот и замеряется время там их прохождение например То есть если по времени а модули для Хрома не использовали какие-то которые устанавливают сот иба как бы исследования того же хип дампа Да ну сейчас не могу точно назвать какие именно потому что там перебирали разные варианты смотрели как бы разными инструментами большинством Вот и просто там в одних одно увидели в других другое увидели поэтому Понятно нет ничего конкретного Спасибо что а да я хотел бы вот предыдущему вопрошающий к анализу логов и каким-то образом пытаться дебажить отдельные ноды Ну обычно не имеют смысла то есть в любом случае на любом языке обычно всё сводится к тому что анализируются логи если недостаточно то да то ничего не получится так Есть ещё вопросы так Ну тогда на этом всё всем спасибо ва"
}