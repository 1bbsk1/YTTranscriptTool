{
  "video_id": "DllZX8D3RqU",
  "channel": "HighLoadChannel",
  "title": "Как работать с поставщиками на примере поиска доступных отелей / Иван Чернов (Островок!)",
  "views": 277,
  "duration": 2737,
  "published": "2025-01-17T02:21:39-08:00",
  "text": "Всем привет Меня зовут рфн сегодня буду рассказывать о том как работать с поставщиками но у меня есть небольшой дисклеймер в презентации будет много текста много контекста мало картинок и ноль мемов поэтому сразу предупреждаю Надо будет как бы подготовиться Для начала я о себе немножко расскажу вот я значит у меня такой разнообразный опыт я был и админом и эндером потом резко стал cto Вот Потом снова вернулся в Кэн потому что я подумал что писать код приятнее чем управлять людьми А сейчас я мутируют А в свободное время я веду Подкасты есть подкаст Два Ивана название обсуждается Он про it и вечерний датам Он про настолки и где как не на Хай лоде рассказывать про настолки если вам нужно что-то порекомендовать Найдите меня на стенде вот я обязательно Вам что-то посоветую в общей сложности Я примерно 12 лет в it и половину из них в островке если вы не знаете что такое Островок то Островок - это сайт для бронирования отелей и не только вот мы тут недавно запустили трансферы скоро будет ещё чего-нибудь и если зайти на него и вбить Москву и даты осеннего хайлоу Да в Москве то вы можете увидеть что там есть порядка сейчас тысячи или пары тысяч свободных отелей которые вы можете выбрать для своего проживания чтобы это всё работало у нас больше 350 сотрудников больше половины из них пришло в прошлом году и это всё нужно для того чтобы обеспечивать теку нагруженную систему мы получаем десятки тысяч бронирований в день 210.000 поисков отелей в секунду и это всё работает поверх 2 С5 млн отелей доступных на нашем сайте и тут я хочу задать вам вопрос А как получить столько отелей и если заходить к этому вопросу издалека то например в авиакомпаниях в авиабилетах 50 лет назад сели все коммерческие аэропорты все авиалинии и таки подумали нам было бы неплохо иметь единую базу Вот они её спроектировали всё хорошо и вы теперь пользуетесь благами этих штуки есть сайт Flight Radar Вы можете вбить туда соответственно номер своего перелёта и видеть как самолётик летит так вот в отелях так не работает нету какой-то единой базы всех отелей на всём мире Потому что их тупо много вот на островке их например 2,5 млн Я думаю что их на порядок больше то есть их какие-то десятки миллионов и соответственно просто люди не могут Договориться с с другом Да есть какие-то крупные сетки типа mariota или holid in которые ведут у себя единую базу Но это скорее исключение и более того там филиалы тоже могут свою эльку вести без какой-либо привязки как мы как it можем помочь отелю Ну очень просто давайте сделаем площадку скажем смотрите теперь можно в онлайне получать бронирование вот таким образом появился букингем образом работает Островок если подойти к решению этой проблемы и вбить типа booking System Design interview то вы увидите Примерно вот такую картинку вот там много всего но я вам сейчас разобью это аналогичен говоря система для менеджмента отеля где ты регистрируешься говоришь вот у меня такой-то отель по такому-то адресу загружают картинки и всё остальное дальше оно через кафку попадает в какой-то elastic Search и это поисковый кластер на который вы как раз Приходите типа в Москве доступны вот эти отели дальше нам Остаётся только это забронировать списать с вас деньги и как будто бы всё работает всё хорошо на самом деле нехорошо тем что букинге только в конце 90х и до этого естественно отельеры сами тоже вели у себя эту инвентарную базу как-то свой отель менеджере для этого они либо купили какой-то софт либо написали свой софт и в общем они как бы ну не появляются как-то автоматом на букинге и более того не хотят туда идти тогда появляются другие компании они приходят к таким отельера и говорят Хорошо давайте мы за вас сделаем интеграцию будем как-то у вас выкачивать данные получать с этого комиссию и соответственно Если вдруг в онлайне будет приходить больше брони чем вот к вам просто так то Вы ещё будете давать нам более хорошие цены Ну скидка оптом вот это вот всё вот таким образом у нас появляются поставщики И как только их становится несколько и у них есть одни и те же отели то мы хотим сделать другие компании Мы хотим взять всех поставщиков найти самые хорошие цены и отдать это пользователю Вот и Островок является такой компанией они в отельной индустрии называются консолидатор вот и Давайте подумаем о том как выглядела бы принципиальная архитектура такого решения она напоминает предыдущее То есть у нас есть что-то для управления отелями поисковый кластер и сервис для бронирования непосредственно но появляется новый Кубик это кубик который называется поставщики которые отдают вам данные во-первых там мы Тим выст Law для того чтобы у нас не пересекались как бы наши внутренние бизнес логика и то как работает поставщик и мы начинаем по кубикам повторять зеркалить эти сервисы Первое - это собственно говоря скачать данные про отель вот адрес фотки названия это штука которая меняется довольно редко Ну то есть её можно скачать раз в неделю и всё такое основных сложностей Там две Первое - это какой-нибудь поставщик Может вам отдать терабайт архив с и разбирай его сам как знаешь второе - это то что мы берём от разных поставщиков такие ЗИП архив и надо вот понять что отель космос и космос отель это на самом деле один отель и он как бы его как-то привести к единому контенту второе - это собственно говоря поиск при этом это делается по запросу типа Дай мне АНО майские даты отель космос и как бы нам вываливается информация о том какие цены доступны Ну и собственно говоря этап бронирования но он становится более сложным потому что в случае бронирования букинга мы просто должны следить за консистентность между нашими внутренними сервисами А здесь мы должны это сделать И с учётом того что мы сходим куда-то вовне так вот из этой всей схемы Сегодня я буду рассказывать только о маленьком кусочке который непосредственно работает с поставщиками на поиске потому что это самая нагруженная часть и там естественно возникают наибольшая проблемы хайлоу Вот напомню Что делаем мы Это для того чтобы Вы получили хорошие цены вот и с ними есть беда во-первых это игра с закрытой информацией То есть вы только можете отправить запрос вот отель Космос на Майский и вам дадут отель Космос на Майский нету такого что вам отдают тоже какой-то ЗИП архив со всеми ценами на как календарик и всё остальное Вы можете сказать О'кей Давайте будем просто скрепить типа вот возьмём Значит все отели 365 дней и будем Значит посылать запросы не так-то просто в договор включено что есть соотношение между просмотрами и бронирования и вы должны его выдерживать Если вы не выдерживается вам начинают Ну либо цены подкручивать либо вообще в принципе вас отключать поэтому как бы Задача В таком простом виде не решается и э самоя как бы плохая корреляция во всей этой индустрии что чем лучше цены Вы хотите тем как правило более а технологически не развит партнёр то есть есть какие-нибудь пятизвёздочные отели all inclusive в Турции они рады то что они продаются через туро операторов просто по запросу номер телефона и не хотят никуда подключаться у них стоит какой-то сервачок вот конкретно в их в офисе он выдерживает 10 запросов в минуту и Ну больше ничего ты не можешь с ним сделать а подключать надо Ну как-то пользователям хочется ценность донести примерно такой сетап у нас проблемы То есть большое количество подключений большое количество отелей большое количество поисков и нужно придумать какую-то схему Ну какое может быть решение у этой проблемы кажется что Она довольно Типовая и звучит как Давайте вотк просто кэш то есть вся наша архитектура сводится к тому что к нам пришёл поиск от пользователя Мы сначала сходим в свой кэш Потом сходим к поставщику если не попали в кэш и всё работает хорошо когда мы Слим слышим слово кэш как правило у людей в голове возникает Ну не знаю Может у разных людей по-разному Вот Но я думаю про рес Вот это понятное решение туда можно оно in Memory оно быстро туда можно засунуть ВС что угодно там есть много разных нестандартных структур Если вдруг потребуется поэтому Давайте же его вотк запустим это впт и увидим что Всё горит кэш не выдерживает наш внутренний сервис запрос не выдерживает поставщики запрос не выдерживают и приходится потихоньку разруливает ключ понятно что туда уже входит отель и даты Вот но ещё Туда входит например количество гостей с гостями очень смешно значит во-первых два по одному не то же самое что один вдвоём заехал в номер Ну потому что Понятно отелю надо типа чаще убирать номер и всё остальное И особняком ещё стоят дети Потому что дети когда заезжают они могут спать с родителями могут быть детская трава кроватка она может быть бесплатной А может быть платной начинают различаться цены в общем это эти все состояние надо различать второе - это собственно говоря про календарик я вам сказал Давайте просто выгрузить значит цены по одному Дню И начнём их складывать так не работает тут то же самое что в кока-коле двухлитровые подешевле чем по два по одному литру вот поэтому Когда вы ищете на 7 дней Ну и более того как бы сами ательер они стимулируют они хотят чтобы люди не заезжали на один день У них вообще такой как бы регламент что минимум на 3 дня а Чем дольше тем лучше Вот потому что ну меньше каких-то операционных расходов на на уборку и на всё остальное Ну и последнее - Это поиск в глубину Если вы будете искать майские праздники в феврале и майские праздники в апреле Это будет ну совершенно разная доступность и совершенно разные цены Да там нету такого динамического ценообразования как в такси Где вы пару раз поиска и вам уже пишут высокий спрос теперь точно на 300 руб дороже и всё остальное Вот Но он есть именно с позиции того как кэш должен работать если вы поили на полгода вперёд Окей эти цены Скорее всего в ближайшую неделю меняться Не будут Но если вы ищете день в день нужно делать постоянно записи обновления То есть это приводит к тому что у нас есть определённое соотношение между тем сколько мы читаем и сколько мы пишем в общем вывод из этих всех ключей Довольно простой У нас их много и Один в один какой-то большой вертикальный редис они не воткнут давайте думать как мы можем сделать эту систему распределённой А в редис можно пойти читать мануал Вот то есть типа как масштабировать дис И вам скажется есть дефолтное масштабирование мастер реплика Вот вы можете соответственно поставить дис поставить к ней N реплик и всё хорошо Проблема в том что эта схема она масштабируется только чтение Ну понятное дело вы воткнули 10 реплик с них читаете вы в 10 раз можете больше читать они замедляют запись потому что вы скорее всего захотите чтобы везде были консистентные данные но как бы это не наш вариант Хорошо давайте делать это с бизне точки зрения шардирование это отдельный вопрос этого просто много более того в случае редиса к этому встаёт дополнительный софт в виде се Проси потому что вы хотите В общем как бы много софта много ресурсов много инженеров которые этот кластер должны обслуживать нас в тот момент как компания не устраивал cost of ownership этого решения слишком как бы много подвижных частей и они могут упасть поэтому мы решили что надо поискать какое-то другое решение прежде чем его искать нужно определиться Какие вообще у нас есть требования у нас много ключей у нас толстые данные Потому что когда ты спрашиваешь что отель Космос на майски то тебе отдаётся не только цена но ещё и количество номеров вот делюкс с кроватями в разных конфигурация короче там тоже комбинаторный взрыв такой идёт сколько данных лежит У нас они достаточно часто обновляются Мы хотим чтобы когда что-то вытаскивала весь кластер не разваливался и автоматом что-то делал Ну и самое главное мы хотим это дёшево вот типа Почему Почему нет Почему никто за этим параметром не следит вот чтобы хотя бы сузить область то есть мы судили область проблем теперь область решений Давайте попробуем сузить для этого пойдём на сайт db eng вот увидим топ-10 на первом месте естественно дис вот дальше идёт Динамо db и космос db для меня они сразу как бы в одной категории Да они там по-разному устроены внутри но у них основной Смысл в том чтобы вы платили больше денег за больше производительности то есть оно не подходит по критерию того что мы хотим что-то дёшево вот оно только и надо было бы выстраивать какой-то пайплайн а вот etcd и Айки это уже что-то более интересное Ну в тот момент когда мы смотрели tcd не было но мне кажется что здесь оно на седьмом месте Просто потому что оно в кубе используется и все раскатали к себе куберы поэтому как бы вот поэтому мы обратили сво внимание на osik пошли читать их официальные отчёты и они сказали вот мы как раз как бы Если сравнивать нас с редиской то Вам нужно будет в 10 раз Мень для чтобы обслуживать тот же самый поток То есть у них там был типа 300.000 как бы вот диски нужно 120 серверов и нам нужно всего 12 и они аналогичной конфигурации вы сэкономите миллионы долларов Давайте смотреть за счёт чего вот во-первых есть клиентский слой он устанавливает конект с кластером с одной нодом кластере и держит ко всем ном это нужно для того чтобы какая-то выбивание ноды то у вас уже автоматом был бы конект другой ноде и приложение беспрерывно работало более того чеки встроенные в Spike они есть как внутри кластера так и внутри клиента то есть он сам это информацию держит и если нету сетевой доступности конкретно клиенту то он просто как бы через Другой путь заро Ути и запишет и как раз про запись мы берм чит внутри Айка 496 партий мы берём хэши от ключика и начинаем их раскидывать при этом партиции дальше мап на разные сервера и если например у вас партиции 1 - это э мастер который попадает на ноду о то он точно также может выступать репликой для каких-то Других данных то есть мы данные раскидываю прямо по всему кластеру где-то они являются мастером и в них можно писать где-то они являются только репликой их можно только читать и это помогает в случае каких-то проблем с конкретной то мы выставили там replication Factor 3 У нас есть одна Мастер и три реплики и у нас выпадает эта нода при этом у нас сам кластер по себе больше и какие-то просто не использовались она автоматом получает информацию о том что ну то есть понятно там алгоритм консенсуса выяснили что Всё реально упало Вот она главное что она дальше встаёт этой недостающей репликой и начинается миграция данных Вот они все скопированы успешно мы говорим о том что реплика Up и начинаем с неё тоже читать Вот и модель этих штук То есть у нас много ключей и сами данные они толстые она впаке гибридная То есть она ключ хранит в памяти А запись идёт уже непосредственно на диск при этом у эро Спайка своя модель хранения как она блоки раскатывается поэтому они рекомендуют либо вот прям dda типа отдать и тогда мы сами знаем как там будет что лежать либо какую-нибудь файловую систему с Direct Access вот поэтому смотрите если используете aike Попробуйте поменять производительность прямо сильно возрастает и в итоге мы получили те момен у на все серверов которые держат весь наш поиск туда прилетает примерно 30 при этом это суммарно и запись чтения и хранит это всё 400 мл ключей на каждый чик Вот это с учётом фактора то есть ключей реально немножко поменьше Вот но в целом гораздо годно чем потенциальные 750 поменялась то есть что мы сделали мы взяли и воткнули в качестве ша и стали этим довольны но в один день мы пришли и увидели что к тоже взорвался вот решили ну как это изучать Пошли смотреть графики вот кластер просто перестал принимать новые записи он сказал всё Ты можешь читать с меня сколько угодно но записать Я в себя ничего не могу мы пошли смотреть C и процент на диске ВС было в порядке а вот память была близко к толку Мы подумали Почему так а оказывается что вот этот ключ который лежит только в оперативке он перестал помещаться То есть у нас много ключей Надо подумать вообще откуда Ну какие там Ключи откуда они берутся ключей всего на самом деле два во-первых есть доступные отели вот где у нас есть цена комната тарифы вот с завтраком без завтрака бесплатная платна и всё остальное и есть второй тип очень таких странных ключей когда отель просто на эти даты недоступен То есть вы сходили к поставщику сказали Дай мне отель Космос на майске и всё что они вам сказали его нет вот Ну в смысле он недоступен там нету ничего единственную информацию которую вы получили от поставщика о том что вот вы не знаете какие там были номера вы не знали вообще по каким ценам они могут быть и когда мы посмотрели на свои графики мы увидели что в целом поставщики СО сплитом 50 на 50% отвечают что вот половина отелей доступна А половина нет вот и посмотрев в оперативку в сам primary Икс мы увидели что а у нас вот эти половина ключей они порожние Ну то есть там типа просто лежит информация о том что отель недоступен и не используется как это мы попали в минус Аро Спайка того что они вот используют 64 байти на в оперативке на то чтобы пометить что в базе есть этот ключик и упёрлись в предел Вот что же делать Ну наверное подумать о том как это хранить по-другому Мы хотим чтобы наша новая структура умела проверять вхождение элемента чтобы она это делала быстро и чтобы она была эффективно по памяти потому что вот просто так вй мы не можем это положить наверное кою Science 101 нам говорит о том что это хэш Таблица вот но AOS Spike и был такой хш таблице мы не можем Ну если только какое-то другое решение не вставить можно подумать что выделим один ключ он будет множеством Вот и как будто бы тогда будет быстрая проверка но это не так хорошо по памяти потому что ключи-то тоже самые большие они формируются Из большого количества параметров здесь мы вспомнили про фильтр Блума вот если вы не знаете Что такое фильтр Блума то это такая вероятностная структура которая состоит из битовой Маски набора хэшей и когда мы хотим записать туда элементи он прогоняет через набор хэшей мы обновляем соответственно в битовой маске соответствующей позиции и потом когда хотим проверить мы проходим тем же самым алгоритмом и если видим что во всех позициях У нас есть единички то считаем что этот ключик есть Понятное дело что здесь может происходить коллизия Вот потому что может быть какой-то другой ключик который на этих же Шаг в эту же позицию даёт единички и мы получим что О'кей вот этот ключ на самом деле которого здесь нет он там есть Слава Богу это близко к математике Вот и люди посчитали как эту вероятность нам контролировать в данном случае н им - это в зависимости от того насколько у вас большая битовая маска сколько вставок вы предполагаете туда и какой набор хэшей будет Поэтому можно просто как бы посмотреть что я хочу 0 за 0,1% ошибок и вычислить эти параметры исходя из того сколько вставок мы ожидали вот осталось понять как вообще сам ключ формировать Я уже сказал что туда входит отель количество гостей и поставщиков но речь заходит про даты потому что даты как бы каждый день меняются Мы записали что вот отель он недоступен только с 24 июня по 26 вот мы не но может быть эта информация не сильно меняется Может быть он просто недоступен по каким-то другим причинам здесь стоит посмотреть на то как вообще ще ательеро ведут у себя э эту доступность у них есть такая штука называется шахматка там Соответственно по строчкам это номер и тариф А по вертикали - это даты и здесь есть вот такой попап небольшой который называется ограничения и там два вида ограничений Первое - это За какое время можно в принципе найти этот тариф То есть вы можете это туда заехать Только если поиска минимум за неделю а вторые ограничение - Это насколько вы должны оставаться то есть типа я вот готов тебе продать По такой цене только если ты заехал на минимум на 5 дней и соответственно наш как бы ключ из Дат превращается в то что на самом деле нам нужно хранить у себя дней до заезда и дней проживания потому что эта информация между стыками Дат она как бы не будет обновляться и мы чуть подольше можем эту информацию нить у себя в общем разобрались с тем Где хранить как формировать ключ осталось выбрать решение наверное можно это ни оперативки потому что это просто битовая маска Она довольно компактная у нас эти сервисы написаны на го вот для го есть готовые либы при этом в Go очень любят делать бенчмарки по локациям вот чтобы всё работало быстро гладко и так далее но мы получаем минус того что эта информация не будет шариться между нодами То есть у нас какой-то кластер на 40 тачек каждый хранит информацию недоступных отелях у себе И это не очень хорошо и здесь к нам возвращается дис вот имеет встроенную структуру При этом она заводится как БМ фильтр такое-то название такой-то процент ошибок такое-то количество вставок и дальше она сама раскидаю сколько Ну какого объёма И чего нужно ей хранить она соответственно таким образом когда мы его втыкание о недоступных отелях и единственное На что мы это торгуем - этон на сеть вот поэтому наша схема улучшилась у нас теперь два кша для того чтобы всё работало в два раза быстрее Вот соответственно у на используется толь как для недоступных отелей а aik для доступных номеров и тарифов потому что это толстые данные вот в целом всё что мы делали до этого это мы построили эффективный кэш А я говорил о том что есть ещё Беда с запросами и приходится переходить на то как В целом с ними управляться запросов поставщики приходят говорят запросов у вас как-то многовато и мы начинаем думать А как это вообще происходит вот у нас есть один экземпляр из кластера второй экземпляр из кластера один человек поискал на Майский отель оди второй человек поискал на Майский Отель 2 и мы получаем что мы к поставщику отправили два запроса как будто бы можно что-то с этим сделать если мы представим что у нас есть ноды и вместо парадигмы того что мы делаем по микросервис на поставщика У нас есть такой Библиотечный подход где у нас есть ноды которые умеют обрабатывать любые запросы и мы эти начинаем как-то распределять равномерно вот оно будет выглядеть как-то так то есть мы отправляем Каждый раз когда пришёл запрос Мы вычисляем в какую ноду его отправить и соответственно отправляем Выглядит как будто мы не решили проблему с предыдущих слайдов Вот Но если выкинуть из этого логоритм отель то можно понять что там на первую ноду у нас попадёт один и тот же поставщик одни и те же даты два разных отеля и их можно будет как объединить Вот наверное догадались что я говорю про консистентные хеширование Вот но здесь сразу же видно её Минус У нас есть нода которая вообще ничего не обрабатывает а мы хотим чтобы это было как-то более-менее равномерно Вот как это сделать оказывается есть алгоритм нву вот он является улучшением консистентной и выглядит он следующим образом у нас есть какой-то набор клиентов набор серверов мы начинаем вычислять хш по Не только отключа но и передавая как Т сервер и выбирая самый большой вес мы начинаем отсылать запросы туда чем эта схема лучше тем что мы можем собственно говоря в зависимости от того какие какой сервер пришёл проставить ему вес мы можем распределять как бы поставщиков у нас единый кластер он с точки зрения operations как бы мется как один и с точки зрения разработки он мется как один но при этом мы имеем какой-то конфиг что вот у нас там вот эта десятка это под какого-то поставщика который умеет но запросов держать а вот здесь два У нас под какого-то не очень хорошего потому что мы хотим чтобы все запросы максимально объединялись второе мы получаем фичу по автоматическому пере направлению из-за того что мы вычисляем хэши если у нас выпала какая-то тачка то мы просто выбираем следующую и всё хорошо но естественно всё идёт с какими-то кастами а именно в данном случае из-за того что мы вычисляем хэш от каждого сервера то у нас как бы условно говоря алгоритм о отн вот там есть улучшение чтобы был логарифм и соответственно в целом если у вас там меньше чем 50 серверов и это логарифм как будто бы с консистентных хеширования они начинают работать примерно за одну и ту же точность соответственно всё что мы сделали это перенаправить вот эти два запроса к поставщика на два запроса к одному нашему серверу мы добавляем буфер и начинаем отправлять к поставщику один запрос поставщик доволен потому что бач запросы всегда работают лучше чем единичные вот кажется что всё хорошо вот улучшили запросы но сами поставщики тоже горят и рано или поздно надо как-то автоматизировать ситуация когда Надо отключать поставщиков Вот для этого я вам покажу график Мне кажется всё всё очевидно вот есть график проблем какие-то столбики идут ошибки на что есть решение Давайте поставим сет Breaker Пусть он короче отключает этих поставщиков всё будет хорошо А что если я вам скажу что график на самом деле это вот если только ошибки тыкнуть в фане а весь график выглядит Вот так и там красные точечки вообще не видно вот э при этом алерты срабатывают всё говорят плохо и так далее Хорошо давайте пере считаем в проценты типа всё будет нормально вот у нас типа как бы там три девятки и мы на это не алертом и всё остальное Но если Мы возвращаемся к тому что у нас 250 поставщиков и проценты поставщиков выглядят как месиво вот где непонятно что есть Хорошо А что есть плохо Надо подумать об этом Как следить в автоматическим способом вот в приходится вспоминать статистику вот есть такая штука Как скользящее среднее Я пробовал в Гугле вбивать типа скользящее среднее мониторинг и всё остальное мне только инвестиционные каналы почему-то выходили Вот хотелось бы знать что это в мониторинге применяется и мы соответственно в нём берём какую-то срез типа 15 минут усреднять линию на которой выброса нет дальше мы считаем в каждой конкретной точки что если мы там отошли на несколько отклонений то считаем что это плохо более того на этот же график мы можем меди от прошлых значений чтобы видеть высокоуровневые тренды А вообще в принципе поставщик деградирует или работает нормально чтобы у нас это всё работало автоматизированным образом мы используем Вот это inf Граф и капар соответственно в Иксе хранятся метрики в кронофер и дальше что-то с ними дела вот осталось Поня зачем сди та Буки золотые сигналы Если вы о них не знаете то это там процент ошибок avab lcy и всё остальное И здесь соответственно самый базовый банальный пример вот мы получили что у нас процент ошибок вышел за какое-то критично мы отключили этого поставщика и сразу здесь на графике видно что мы ещё экспоненциально его как бы обратно включаем то есть мы посылаем какое-то количество запросив Если ещё плохо то отключаем обратно и там от 5 минут до 2 часов оно растёт но в как бы с точки зрения бизнес логики есть гораздо более интересные кейсы например поставщики могут не упасть типа О у меня 504 Timeout и всё остальное они могут у себя включать режим Типа все отели недоступны А у нас как бы кэш который Закаев как бы сказать что если поставщик отдаёт около стопроцентную недоступность наверное у него всё не то они там и все что-то отключили вообще ничего не ищут и к нам приходить такие запросы не нужны А ещё может быть что поставщик отда доступность но потом пользователь приходит пытается это забронировать но оно не бронируется типа на самом деле этого номера нет он уже ушёл и с этим тоже что-то надо делать и Здесь начинается вот это вы знаете мы пытаемся этот пирожок поделить вот каждый раз давайте сделаем там UI Data ler БД Или давайте вот так типа фичи вот эти делить и как бы ты не поделил у тебя всё равно связей вот этих фидбек лупов как бы больше и в данном случае он образуется между сервисом бронирования и сервисом поиска то есть сервис бронирования должен складывать метрики должен Капа посчитать suc и как бы в сервис поиска отдать информацию о том что Да он работает но нельзя забронировать и нам это не нужно вот более того за этим надо как-то следить поэтому у нас есть бо в слаке вот которая пишет О том что вот значит мы увидели что suc Rate упал меньше 65% Наверно я его отключу на 2 часа Вот при этом он Понятно называется Капа ситор но здесь не видно у него на аватарке конденсатор в руке Вот кроме того что он Тор Мне кажется важно Это подметить таким образом как будто бы мы порешали все проблемы я напомню мы спроектировали кэш мы сделали буфер для того чтобы бачить наши запросы мы поставили cit Breaker Вот и пора Наверное закругляться что бы я хотел сказать в качестве выводов наверное я вот здесь нашёл цитат из мифического человека месяца Она довольно длинная Вы наверное пошли её читать Вот Но я подсвет вот стратегические изменения достигаются за счёт того что вы изменили представление данных и вообще то как Вы у себя складывается данные много говорит о том над чем вы работаете И будет это эффективно или нет мы эту проблему решали во всех наших шагах то есть мы выбирали решение исходя из того Какие данные Нам отдают выбирали Как нам фильтровать Это правильно с эффективной структурой решали Как нам распределять запросы в нашем кластере а не просто Рон делать поэтому как бы Думайте о том какие у вас бизнесов данные и как их можно разложить на этом У меня наверное всё но прежде чем перейти к вопросам пожалуйста проголосуйте за мой доклад Вы можете подписаться на Telegram канал Чернов шарит и можете найти меня на стендах чтобы обсудить со мной настолке напомню Всем спасибо а Спасибо огромное Я бы ещё хотела добавить что по QR коду можно не просто проголосовать но и оставить развёрнутый комментарий что было хорошо что было не очень что можно улучшить Прости я не со зла вот на самом деле комментарии действительно очень приятно Интересно читать а как серийный спикер и серийная ведущая вот прямо всеми руками и ногами за Итак А теперь мы переходим к сессии вопросов и ответов А вы можете писать вопросы в чат если стесняетесь задавать их лично либо если слушаете нас онлайн всё ещё с нами на что я очень надеюсь либо поднимать руки и говорить их Лично я вижу уже первую руку Можно пожалуйста микрофон уже отдали супер прошу Иван Добрый день спасибо за доклад было интересно Судя по всему у вас сложная доменная модель подскажите пожалуйста Может быть вы какие-то подходы использовали типа ddd или ещё что-то Ну в целом Да как будто бы я Я в принципиальной архитектуре как раз э мапи но смотрите меня при проектировании архитектуры больше волнуют характеристики когда я их разделял это было это с одной стороны с точки зрения пользователя доменная область потому что это типа статичные данные динамичные данные и транзакционные Но с другой стороны это Разница в том что тебе обрабатывать те обрабатывать много данных быстро или типа гарантировано консистентной Обычно я ну как бы мы подходим к архитектуре с этой точки зрения а не с точки зрения доменной области Вот как раз продолжение этого вопроса А вот границы транзакционный целостности вы как выделяли Ну в смысле имеется в виду того что у тебя Э сейчас я в голове прокручування как бы мы придумать не смогли Ну то есть мы не делаем так что мы бронируем у себя потом там как-то ходим к поставщику нам к сожалению надо к нему сходить убедиться и при этом у некоторых поставщиков это опять вовлекает в себя Процесс поиска то есть типа мы ещё раз ищем и ещё раз бронируем благодарю мы сейчас Обязательно передадим микрофон следующему участнику но я должна напомнить что мы уже потом будем выбирать Два лучших вопроса из все вопросы прекрасны но к сожалению придётся выбрать Два лучших а одному участнику мы подарим подарок от онтика Ту самую уникальную матрёшку и можно будет начинать собирать свою коллекцию супе уникальных матрёшек и второй А подарок будет собственно от а компании так прошу Добрый день спасибо за доклад подняли очень интересные вопросы Ну и собственно наверняка поставщики хотят ограничиваться в РПС Как вы эту проблему решали Какими средствами и какая там тоже проблематика была Значит те поставщики ещё раз у нас большее количество поставщиков Простите я заново буду отвечать на этот вопрос значит на самом деле поставщики не хотят ограничивать ПС они хотят получать бронирование Вот и соответственно как бы общее условия заключаются в том что давайте мы проведём столько бронирования А вы будете давать стокос но если есть на какой-то плохой поставщик который ходит только в нужном количестве то во-первых мы вот делаем эти батчи объединяем и делаем у них немножко длинный буфер для того чтобы сам rps снизить А во-вторых мы на уровне выходящего ха прокси ставим свои Рей лимиты для того чтобы ну не ходить точно не до досить своих партнёров благодарю Следующий вопрос пожалуйста здравствуйте Угу Здравствуйте Ну мой главный вопрос только что задали поэтому я задам тогда вспомогательный вопрос для поиска вы как-то пытались обдумывать применение ма моделей для Ну не контекстный а именно смысловой поиск Спасибо смотрите у нас точно подключена моделька с позицией того Сколько хранить вше Вот то есть вот этот о котором я говорил который типа простой мы ищем далеко мы храним типа можем хранить это несколько дней а близко мы храним типа Ну можем хранить несколько часов условно говоря мы вот эту штуку вычисляем более сложным образом и у нас там подключена Илька То есть у нас есть исторические данные насколько на самом деле Часто у каких поставщиков Какие отели обновляются и мы пытаемся эти данные не просто статистически экстраполировать но ещё на это натравлю модельку это наверное из смыслового что я могу рассказать благодарю следущий вопрос пожалуста Здравствуйте меня зовут Алексей компания это бывший туроператор ту нас много общего очень интересно как происходит Чинг отелей с разных поставщиков сказали оте Космос он в пяти врс у пяти поставщиков с разными модификаторами разными названиями и если маппинг Ну то есть первый вопрос Это про оную историю ите вы номе две темы на два доклада Я надеюсь что я с ними выйду во-первых да у нас есть внутренний матчинг отелей Он написан сам Он написан сначала на статистике потом самым последним образом идёт и mail и потом ещё самым последним образом идут ручные редактора вот поэтому там в целом Ну в отелях более-менее понятно Там статическая информация ты можешь сравнить точки сравнить названи в три граммах и как бы ну то есть там типа достаточно методов а вот с номерами Ну у нас такое немножко мы типа это тоже Разбираем но мы типа делаем дерево тегов Вот и у нас есть правило такой граф в виде дерева который говорит о том что насколько это эти номера близкие к друг другу и можно ли их выдавать за один вот это тоже как бы поймайте меня лучше я буду рассказывать об этом чуть больше Можно например продолжить в дискуссионной зоне у нас будет время Спасибо я ещё не знаю таких предложений выучу в следующий раз заманчивое Заманчиво предложение от которого невозможно отказаться Ну что друзья у нас а ещё есть вопросы прошу с с оголовьем привык Да Паш Да так комфортнее А тогда я за задам вопрос вот очень понравилось луковичный рассказ о том как с какими вы проблемами сталкивались потому что поставщики имеют свои ограничения Вот и очевидно что возможно поставщики имеют разные ответы для разных отелей возможно Вот и нам в идеальном варианте хотелось бы ну обслужить всех их и принять какое-то решение и из этого я вопрос не об этом из этого рождается мысль они могут ведь ухудшать ответы и у них нету критерия Почему они должны отвечать одинаково хорошо И вот вопрос всё-таки в том не пытаются ли не подойти к одному единому подходу всё-таки к тому примеру который ты рассказал в случае с отелями с с полётами Да авиабилетами и нет ли какой-то наказую ей петли или возможно обратной связи в том что э какие-то поставщики уходят или какие-то отели показывают противоречивую информацию и их выбрасывают из этого Из этого Пула Возможно не пойдя к новой системе к единой они остаются на обочине вот цивилизации и вам Возможно не нужно будет столько математики вносить в разработку и они сами будут вынуждены перейти на ва на ваши требования Ну это про такой maret Power Который больше у букинга чем чем у нас вот Но вообще Отвечая на твой вопрос ещё раз мы хотим это делать для того чтобы типа человек получил хорошие цены и поэтому обычно сравнение прямое идёт в рамках Именно этого параметра ну и плюс там опции тарифа Вот и здесь на помощь приходит стриминг то есть мы на самом деле медленные поставщики то есть вот эти все сервисы написаны на го там РПЦ на гпц мы используем стриминг И поэтому ты типа открываешь страницу видишь уже какую-то тарифную сетку Но на самом деле тебе как бы на фронт прилетает ещё что-то более хорошее Поэтому если хотите хорошие цены подольше сидите на сайте вот так что как-то так о'кей О'кей а есть вообще какое-то предвидение в российском сегменте рынка к приходу к чего-то подобного как единого стандарта Это я озвучил в букинге не знаю Ну в смысле я думаю если Ростуризм что-то сделает Нет там точно есть спецификация протоколов давай так то есть отельеры на самом деле не любят сидеть в админке островка админке букинга и всего остального и у них появляются инструменты и вот эти инструменты уже на самом деле сделали ну типа уже Достаточно давно есть спецификация как обмениваться этими данными если мы говорим про апартаменты Они вообще там Ай калом перекидываются вот типа когда заборонено какой Какая квартира у них и всё остальное поэтому там такой стандарт Вот но единого прямо чтобы вот ты пришёл в любой отель и он сказал я работаю по 1С двоеточие отель и у меня такой формат такого скорее всего не будет просто потому что тупо много вот и всё спасибо Так благодарю Ну что есть ли у нас ещё вопросы если вопросов пока А ещё вижу отлично Пожалуйста слушайте как мне нравится сегодня аудитория такая живая очень много вопросов причём знаете вопросов Таких хороших классных добрых вот прямо от ведущего большое человеческое спасибо спикера тоже ты как-то дистанцирования заднюю и такие мы тут подумали цена теперь выше А вы начали бронировать ведёте ли вы какой-то историю для того чтобы потом с пруфами приходить и всё-таки отстаивать своё мнение в общем третий доклад вы ловите меня на том что я короче должен о чём-то ещё рассказать мы построили свою систему логов где мы храним сырые респонс от поставщиков и на поиск вот вот это вот всё то что идёт в OS Spike особым образом чтобы в момент бронирования Ну короче мы передаём информацию что вот это нужно хранить дольше и потом когда соответственно поставщик к нам приходит и как Ну идут какие-то диспуты мы им прямо даём там их икэм подписанную их секретом и они точно знают что это их как бы ответ А не какой-то который мы там в нотпаде закастомить предвидели сразу Следующий вопрос с подписанием чтобы они не дали ещё раз задню класс спасибо Так ну ещё рука Ну давайте наверное вот прямо уже последний или предпоследний вопрос потому что время так начинает потихоньку заканчиваться а нам сейчас ещё подарки дарить тоже занимает время Итак прошу Спасибо за доклад простой вопрос А какой процент попадания в кэш потому что на протяжении доклада было ощущение что очень много возни с кэшем хотя там дальше запросы Могут просто отвалиться там ещё что-то поменяться куча параметров для формирования ключа в итоге Какой процент именно эффективности этого кэша тебе ответить на этот вопрос потому что я тебе должен сказать Ну типа А когда то есть вот если мы говорим о длинном промежутке то у нас типа хирейд близко к 95% если мы говорим о том что день в день мы ищем то нас Трейд ну что-то выше Ну типа от 60 до 6 3% то есть да это как будто бы с одной стороны не так много а а со стороны поставщиков это чуть больше чем в два раза меньше запросов к ним приходит понимаешь да ну чуть больше чем в два раза да да ну не в смысле в в случае если это вот день в день а как бы запросы тоже имеют какое-то распределение и в итоге эффективно как бы ты ну О'кей ты типа на считаешь что это число лежит в районе типа 67% или 68 Отвечает ли это на вопрос нужно это решение или нет Ну как будто бы нет потому что разные люди с разным в разное время приходят по разным паттернам спасибо Ну что супер Спасибо всем огромное за классные вопросы пришла пора выбирать Итак первой Наверное от островка Что будешь дарить А вот про мачин я про мачин буду дарить поднимите пожалуйста руку Спасибо огромное подарочек от островка здорово и второй вопрос подарочка антика второй вопрос про консистентность вот от че поднимите руку кто задавал вопрос про консистентность прошу Спасибо огромное спасибо всем за классные вопросы и спасибо тебе ива выступление тоже подарок антика благодарю Спасибо"
}