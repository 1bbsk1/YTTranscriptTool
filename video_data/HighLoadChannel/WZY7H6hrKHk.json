{
  "video_id": "WZY7H6hrKHk",
  "channel": "HighLoadChannel",
  "title": "C++: темная сторона / Сергей Козлов (Лаборатория Касперского)",
  "views": 989,
  "duration": 1834,
  "published": "2021-10-04T02:45:36-07:00",
  "text": "каллен сегодня я хотел бы поговорить с вами об ошибках о том как мы их собираем и что потом с ними делали мы обеспечиваем безопасность для миллионов пользователей всему миру но как и у всех у нас разумеется тоже бывают ошибки поскольку речь идёт о безопасности то наша принципиальная позиция в том что любые инциденты с нашими программными продуктами должны быть рассматривается и анализируется даже единичные по мере падения у любого пользователя она в принципе может указывать на какую-то брешь в программном продукцию и ей могут воспользоваться теперь когда у нас еще появилась собственная операционная система kaspersky ос у нас цена этих ошибок она возрастает вообще многократно вот поэтому у нас сделано так что любые вообще инциденты с нашими продуктами а не в виде дампов памяти отправляются на сервера для сбора дампов на нашу инфраструктуру поток там достаточно большой и в случае ну таких критичных каких-то и поломок он может легко достигать там сотен тысяч дампов и больше в сутки ну естественно вручную это все не обработаешь поэтому у нас вот серверная инфраструктура она проводит автоматически pride анализ дампов и по выделенным характеристикам там стек исключения сами характеристики он класса рисует эти дампы в группы и уже по ним заводится отдельные проблемы ну дальше эти проблемы отправляются за работником для анализа тоже автоматически значит начнем немножко с того как у нас собираются эти дампы у пользователей в принципе windows достаточно много разных а пищик для того чтобы можно было перехватить различные неожиданные ситуации и есть отдельная песка для того чтобы из этого сделать дам память и дальше уже его отправить для анализа куда угодно но есть ряд нюансов которыми хотелось бы с вами поделиться во первых во первых дам желательно писатель другого процесса причина очевидна тот процесс который испытываю сейчас проблема может быть не в состоянии ничего записать может вообще ничего не будь состоянии сделать вот в принципе но самое такое прямое решение прямо в исключении запускать этот отдельный процесс но даже это может не сработать поэтому мы вот в большинстве случаев все таки используем отдельный процесс и watch dog которому после сигнализировать о том что вот в этом процессе произошла проблема и нужно с него с ним дам дальше второй нюанс проблемы могут быть таковы что в принципе в исключении не будет просто стыка для того чтобы что-то вообще сделать ну в первую очередь это очевидно исключение то что у нас закончился strix такого слова она еще коварно тем что далеко не всегда его можно корректно определить она может прийти как виде stack overflow так и в виде поста access violation более редки случаи бывают и другие ошибки а бывает и наоборот бывает приходится такое flow хотя проблем со стеком вообще-то вот именно явных проблем с исчерпанием стека действительно нету у нас была такая неприятная очень не ошибка редко но регулярно у нас значит на стыках иногда пропадали странички с плеч году точнее сами по из города со страничек дело в том что он на windows стык потока не выделяется целиком он резервируется место под него резервируется и зам обливается там пару страничек чтобы можно было начать работу а дальше ставится на последнюю за мобильную страничку . и когда на нее наступают поток любой операции выкидывается соответственно притч карт violation и система сама по нему зама плевать дополнительную страничку следующую стек и ставит ужин июне . итак дальше и дальше так вот у нас собственно приходили там из где этот . счас т.к. был че блин и поток собственно доходя до конца зама плена уже в пространство просто поддался причем со stack overflow или нападу ну собственно как как именно это происходило как как именно такая ситуация вообще возникает было понятную то есть какой-то другой поток взял и коснулся этой страничке получил приезжает revelations и подарил его и ушел и все а этот поток остался без возможности продолжить работу вот но не удавалось очень долго не удавалось поймать того кто так делает и только когда поставили безусловную запись дампов на вот эти пачкают violation удалось найти что проблема собственно вот вызывая бешеной функции где-то твиче и некоторых наших продуктах она используется для мониторинга зависаний она пробегает по всем критическим секция в процессе и смотрит в каком они сейчас состояние если они залочены таким залочены и таким образом позволяет мониторить ниве землю мы где-то слишком долго так вот сами критические секции в винде я вообще немножко поясню они устроены так у них видимая часть основная это сама критической секция и 2 скрытая часть а там по большей части вспомогательной информации находится и она и вот эти вот скрытой части они объединены в цепь в список и у собственный трать его очень пойду по этому списку бежит и у каждой вот скрытые скрытого кусочка идет критической секции и дальше смотрит кем она залочены так вот что получается если у нас некий поток создал критическую секцию поработал с ней а потом не удалив корректный ушел то вот это вот скрытый выделенный блок для критические секции в списке останется и будет жив а сама критической секции вместе со стыком например удалиться и если на этом месте потом создадут еще один поток и на этом месте окажется по изгот то при пробеге hydra извращений она соответственно коснется эту страничку получит как раз . от violation но у нее вот оказалось очень неприятная особенность все исключения при своей работе она просто давит и у нас получалась вот такая ситуация нас шибало эту бричка с потока мы оставались потенциально подучим состоянием дальше уже потом было несложно найти компонент который собственно забывал эту критическую секцию удалить так вот возвращаясь собственно к исходной проблеме для того чтобы защититься от этих проблем со стеком мы вообще переводим обработку исключения когда нам происходит на отдельные блок памяти в хеппи я делать через bus контекст приключение и в случае если это если потом можно продолжить работу то точно так же возвращаемся от туда обратно и работаем как ни в чем не бывало и третий нюанс относительно новый построил исключения это отдельный класс исключение которые используются и системы библиотеками и что тоже важно runtime omsa у студии они не ловятся обычными хендлера me up разбрасываются сразу в ядро системам морозе этот процесс поднимает windows или ботинка и дальше уже уже он решает что с ним делать вот в принципе мы сначала тоже не очень понимали что с этим делать но вообще оказалась есть а фишка для того чтобы и сюда подключиться для обработки дампов здесь есть возможность зарегистрировать отдельный модуль в виде плагина для windows reporting и появилась возникновении собственно проблем в нашем процессе windows error reporting грузию этот плагин и обработку можно сделать в нем практически какую угодно вот поскольку все абсолютно все исключения могут ну точнее проходят вот именно таким образом то если сейчас вот начинать делать какую-то систему для сбора проблем то наверное имеет смысл начинать вот именно с этого все остальное добавлять только по мере необходимости так это было лекционная часть теперь немножко пока поговорим пока я покажу некоторые практические вещи значит как я уже говорил у нас обработка входящих данков она делается автоматическом режиме и очень важно чтобы стек который мы получаем в программе он был максимально корректным максимальным максимально точно указывал на того кто является источником данной проблемы но вот в случае например но except of дебаггер зачастую не могут корректно показать стек самого исключения вот у меня здесь примерчик реального дампа с нашего продукции но вот вот что он показывает в качестве стек а вот вот как можно видеть вместо реального источника проблемы он нам показывает какой-то мусор можно даже посмотреть что там что там на самом деле вот так здесь просто вызов и ну собственно видно что выбросы исключения здесь нету но можно попытаться восстановить стек просто вручную пробежавшись вот по тем фреймы начиная с тех фреймов которые у нас имеются такие вот давайте попробуем пройтись вручную так вот это экзо кит хэндлер с которым начнем и пойдем дальше смотрите так погоста рециклинга дальше вот здесь у нас идет using совсем dispatch а это уже не видно что мы приближаемся к источнику исключения а вот собственно runtime выбросил это то самое исключение вот теперь посмотрим кто же реально какой модуль его бросил вот-вот все прекрасно видно вот этот модуль на самом деле выбросил исключение хотя вот при анализе автоматическом отладчик нам просто не показал как источник проблемы опять же можно удостовериться что действительно она не какая-то го года так это вот он на этом вызове стоит так jump таблички и у нас в этой табличке и у нас вот она в этой табличке как раз ну то есть действительно именно отсюда был вызван the exception и это действительно правильное место которой вы нашли собственно если пройдемся немножко дальше полен фреймом то вот мы выходим как раз на тот модуль который нам дебаггер показывал в качестве источника проблемы вот собственно как раз вышли на тосты который у нас был вот и ну да вот у нас в том числе при автоматическом анализе такие ситуации учитываются разумеется для того чтобы этим можно было пользоваться не вручную у нас есть небольшой несколько скриптик of выложены гитхабе вот есть ссылочка и они собственно вот в том что один один из критиков здесь он как раз то что я сделал делает автоматически вот собственно это он вставил и вот модуль собственный источник проблем на который был так далее а немножко поговорим про такую вещь как а съем оси у мы the hands вообще-то для оптимизатора которые есть visual studio и он позволяет сказать оптимизатор что мы железобетонно уверены что вот условия которые мы в нем поставим она будет истинно и соответственно компилятор может не не генерировать код который обрабатывает дальше ситуацию с нарушением этого условия так то вещь хорошая но он не недавно пришлось с коллегами тоже обсуждать их желание добавить россию вот этот кассир там-то слойка такая привет лотки приди багет во время тестов мы на сетах ловим эти нарушения а дальше в релизе у нас asylum все лишнее порежет и код будет супер оптимальный супер хороший беда в том что по-настоящему гарантировать что у нас условия какой-то в программе железобетонно не нарушится вообще вот никогда в жизни вот вообще но это крайне проблематично даже не учитывая то что ну и сами мы совершаем ошибки мог бывают уже еще такие вещи как банальную побился файле конфигурации из которых вычет его ли там значение и это значение получила не допустимый вариант например больше вариантов на глушить это в большинстве случаев имеются такие варианты и собственно чем опасен asylum вот в такой ситуации когда мы его ставим как сторожок он опасен тем что он делает поведение программа при нарушении условия абсолютно непредсказуемым вот давайте опять же посмотрим в живую здесь у меня такая реальная функция которую каждый за свою жизнь тысячу раз писал принимаем некоторые значения и по нему делаем какие-то действия все остальное считаем недопустимым вот в таком виде вот мы и тут вызываем один раз с корректным условием второе с некорректным вот что посмотреть что будет вот в нормальном состоянии вот так вот она собственно делает то что мы ожидаем в первый раз она корректно отрабатывает опцию второй раз она говорит janity я с этим не работаю что будет если мы сюда поставим вот оси у как она себя будет вести он там сюда поставим и будет у нас такой в программе никогда и посмотрим что он теперь сделает она выдала один из существующих вариантов хорошо но это даже полбеды то есть да она куда-то пошла выбрала то что было то есть кот был сбит ли он так что при как бы всех остальных какого значения х на скидывал на какой то один из вариантов вот но дело в том что это еще есть нестабильный такое поведение вот если мы добавим еще одну что будет теперь она выдает другую опцию то есть это еще сборки сборки поведение вот этой ошибки она будет меняться она еще и воспроизводиться будет очень плохо и проблематично посмотрим еще один пример тоже ну такой очень примитивный вот мы здесь выделили некие блок памяти что-то сделали и освободили все хорошо все замечательно вот он отрабатывает вас сейчас я покажу один раз сейчас размером 6 с размером 100 ну казалось бы вот выделил освободил выделился возьмем теперь мы заявляем что у нас программе не может быть не может он вызывается с блоками размеры больше чем 9 и что теперь он сделает в этой ситуации родить внимания он мало того что выдал ошибку он еще и этот блок выделил все-таки выделил и бросил он рос обождать не стал вот можно собственно посмотреть код который в этом случае генерируется так вот тут как раз пора наших функций и вот так которая нарушает условия и вот в дизо сми то мы видим аллоцировать а дальше ошибка и все безо всяких условий хотя хотя проверка условия на общаться стояла duasi то есть на самом деле когда мы ставим вот эту опцию вы получать не можем доверять даже тому коду который написан ранее он тоже может быть изменен компилятором для того для своих целей поэтому я бы все-таки советовал очень осторожно пользоваться опцией и уж тем более не пользоваться ей проверки разных условий в программе и еще один моментик картинки картинки штука модно интересная опусти их у нас пара штук стандарт пошел толицей но пока ним под пустого и кустовых интересней потому что они у нас степу и выглядит это гораздо веселее вот опять же давайте посмотрим простенькую программку у меня тут тестовая на boost оси у и картинках она просто тестик который запускает вот этот серый сервера с сокетом он там что-то слушает на поступающие соединение запускает вот эту вот картинку которая будет вычитывать и то же самое отправлять обратно просто хотя простой и точно так же в коротенькие у нас клиент который к нему обращается вот он подключается пишет туда что то обратно читает и проявляет что ему вернули то же самое значит для того чтобы просто посмотреть вот что мы увидим когда у нас в самой картинки произойдет какая-то проблема какое-то падение и нам придет с нее дам вот что как это будет вообще выглядеть вот как раз дам пик у меня с этого дела и собственно вот что мы видим в качестве стека до картинку мы видим вот оно но вот дальше ничего остального у нас к сожалению не видно ну а счастью сама эта картинка естественно знает какие дальше переключаться в своих товарок и собственно мы можем просто посмотреть куда нам дальше идти вот смотрите у нас в параметрам туда идет и лт в он соответственно и содержит информацию о том куда ж ему дальше двигаться если тут посмотреть так секундочку этому туда залезли сюда не думаете вот вообщем туда попали вот вот melt и вот у него есть блок управляющий где собственные границы информации о том кто вызвало и кого вызвали вот коли в данном случае это эта функция acura это у нас контекст того откуда на ее позвали собственно если мы еще посмотрим что там в этом контексте лежит ну да видите что-то лежит а вот что это можно посмотреть в самом busty гус контекст вам выключает это османскими ставочками и в контексте сохраняет вот такую информацию то есть нас здесь конкретно интересует его приятель что вы нам вернуться на исходный стек вы собственно давайте посмотрим вот это должен быть как раз и bb здесь какой-то вызов ну да похоже на вызов поэтому мы можем попробовать переключиться туда и посмотреть что там у нас будет в качестве стыка но если это пикировать это как стриг именно так ну вот вот теперь мы видим что это у вас действительно похоже на исходный стек нашего теста собственно вот он запущен вот у таси отрабатывает и вот в конце у нас был jump на эту картинку в которой мы оказались вот дальше там можно тоже по другим контекстом побегать если нужно вот надеюсь это эта информация как-то поможет вам разборе ваших проблем спасибо за внимание у меня все раз так премию вопросов если кто-то хочет что-то спросить поднимайте руки если есть кто-то у нас в онлайне я тоже принципе сейчас есть время на то чтобы пообщаться нажимайте на кнопку возле player вы сможете подключиться специальную комнату и задать свой вопрос так а и лучший вопрос запоминай выберешь к да к 2 ряд атак сейчас у нас вас куда-то убежали хелперы давай давай я тебе дам микрофон раз буду ходить так вопрос на самом деле простой короткий про windows целом все понятно как с другими платформами дела обстоят с другими платформами быть с другими платформами ситуации несколько похуже потому что на том же линуксе на mac os зачастую чтобы каким коку можно собрать но для того чтобы корректно проинициализировать нужно по сути восстановить то окружение которые там была и вот так как на windows когда у тебя просто приходит любой танк и ты у себя по спокойно смотришь совсем что там было так уже не получается это во-первых ну и второй момент то что средства для работы вообще скобками они несколько более бедные на других системах вот по сравнению с тем же винда bgn ум не дотягивают"
}