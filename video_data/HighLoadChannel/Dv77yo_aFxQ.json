{
  "video_id": "Dv77yo_aFxQ",
  "channel": "HighLoadChannel",
  "title": "Измеряем энергопотребление с помощью Arduino / Алексей Лавренюк (Яндекс)",
  "views": 589,
  "duration": 2231,
  "published": "2017-04-22T14:48:15-07:00",
  "text": "ok всем привет я зовут алексей занимаюсь яндексе нагрузочным тестированием обычно мы обстреливаем backend ну вот современные тенденции побудили нас заняться мобильными приложениями мы начали это делать примерно полгода назад и одна из метрик на мобильных телефонах которые мы не мере вообще никак на mackenzie это потребление батарейки это очень важная метрика для мобильных потому что от этого зависит сколько живет ваш девайс и как я потом покажу это по этой метрики также косвенно можно судить о производительности приложения начали мы с того что вообще посмотрели как вообще люди снимают метрики софт варна чтобы не городить огород раньше времени в андроиде можно прочитать просто проц как у на любом unix и в айсе можно использовать их скот и собирать метрики с помощью стандартных средств но этих двух подходов есть огромные минусы настолько огромное что нам они в принципе не подходят андроидов ские метрики во-первых собираются на разных телефонах по-разному лежат в разных местах куда я их положил производитель там они лежат насколько они точны и опять же не понятно кроме того на некоторых телефонах вот это метрика собранная с nexus 5 метрика меняется раз 20 секунд понятно что внутри то что то происходит но мы этого никак не видим на некоторых телефонах типа самсунга вообще эта метрика собрать нельзя программным способом случае с ios все еще хуже вот здесь вот стрелочка отмечено то как выглядит эта метрика в x коде единицы измерения них очень странная здесь уровень употребления батарейки 1 21 20 означает что если продолжать использовать телефон том же режиме то он проработает 20 часов очень не подробная метрика и непонятно как с ней работать и вот здесь вот три было запуска теста во всех трех запусках хотя вот видно что процессор там по-разному употреблялся видно что не видно что потребление электроэнергии как-то менялась после нас так airflow тоже не внушали оптимизм а человек искал год способ сбора метрик на телефонах с помощью софт war и в конце вот такой вот ответ сам себе же и написал что ничего не нашел чипов в некоторых телефонов которые измеряют потребление тока вообще нет то есть собрать software на эту метрику не получится он пишет что нужно строить мультиметр ну окей мы решили построить мультиметр мультиметр и понятно тоже на рынке существует уже это не новая какая-то не чудо техники есть какие-то цифровые измерительные приборы которые нам нам нужен именно правый мультиметр чтобы собирать метрику в автоматическом режиме и сохранять из нашей системе анализа тестов на стоят они примерно там по 200 тысяч одна штука то есть вам нужно померить один телефон 200000 еще один телефон еще 200000 вот есть проект который специально предназначен для измерения потребления батарейки телефоном он называется power монитор стоит меньше где-то около 500 долларов но это тоже как-то ну сравнимы с телефоном плюс power монитор работает хорошо под виндой под линуксом наверное нет и нам было бы сложно автоматизировать процессы с если мы взяли паузу монитор еще есть проект батор это разработка стэнфордского университета и других университетов вместе с ними но поговаривают что ее команду купил google с тех пор они на связь не выходит вот это частности подтверждается тем что у меня недавно опубликовал статью на хабре про измерения потребления батарейки томи ссылочки на эту статью про батор вот я ее ты кто эту ссылочку спустя некоторое время после публикации статьи уже нет вот интересно что с ней случилось уже вот теории заговора в голове начинают такие появляться но я стать его время скачал ее там есть описание устройства мы примерно тоже самое делаем с некоторыми отличиями эта схема просто найдено в интернете это просто измерял каток а здесь есть здесь есть нагрузка последовательно с ней включен шунт резистор и на этом резисторе мы измеряем напряжение но мы не можем его напрямую подать на вход ардуинки контроллеру мы должны его усилий для этого применяется микросхемка инструментальный усилитель мы решили посетить наш прототип собрать чтобы почистить нашу концепцию трупа в концепт выглядел она вот так вот этот шунт вот эта микросхемка это инструментальный усилитель и вот arduino nano стописят рублей стоят всего съемка стоит примерно рублей 600 это и мере ли мы в разрыв юизби чтобы просто посмотреть вообще мы будем что-то видеть или нет после нескольких танцы с бубном нам удалось получить графики вот кстати здесь еще power монитор стоит вот график по armani дарова плохо видно но примерно соответствует тому что от нашего девайса мы получили и вот этот девайс мой замечая заверяем просто удобно если разрезать все что нужно это просто разрезать провод избив ставит до резистор имелись на нём напряжение плохо то что нам это не подходит во первых устройство по юсби потреблять больше 500 перебор не будет потому что по стандарту usb нельзя потреблять больше 500 миллиампер и устройство когда заряжается но может потреблять больше 500 миллиампер но для этого она договаривается с блоком питания если он родной от этого устройства на его определяет какие я буду с него жать 500 больше 500 миллиампер но если взять туда строится еще там блок питания не родной то вот придется какой-то дженерик дело для того чтобы заставить устройство кушать больше вот во вторых устройстве есть батарейка и она использует все измерения мы закачиваем энергию батарейку сначала из батарейки уже устройство потребляет и мы не видим were all to me как устройство потребляет мы видим как заряжается батарейка нам в принципе не интересно как заряжается батарейка мы не не этими вещами занимаемся нам нужен посмотреть как употреблять наше приложение поэтому мы решили вытащить батарейку и использовать внешнее питание вот когда мы экспериментировали с внешним питанием вот небольшое отступление вот есть две ардуинки кто видит чем разница между ними вот тут дырка дело в том что на школе обманули на самом деле никаких электронных не существует и вся электроника нарва вот это белым деми и вот мы экспериментировали с разными блоками питания и белый дым вышел из ардуинки и мы ее потеряли оказалось что не все блоки питания одинаково нам подходят у некоторых блоков питания между бизнесом на выходе и нулем на входе 88 вольт и когда я воткнул usb провод себе в macbook у меня вышел белый дым из ардуинки я могу потух очень было неприятно мгновение когда пока он не перезагрузился macbook надежная техника но мы все-таки нашли блок питания которые нам подходят это вот вот такой вот lenovo от ноутбука вот и мы решили использовать еще место шунта микросхемку с уже встроенным шунтом она называется нас 471 и вот она продается на алиэкспрессе вот в виде таких маленьких плат сюда нужно просто подключить провода подключить ее к arduino и получишь на 1 ампер тока 1 вольт напряжение очень удобно вот мы это дело подключили дальше встал вопрос как подключаться к телефону мы стали разбирать телефон и смотреть что там вообще внутри есть и поняли что подключаться место батарейки сложно там разъем маленький коннектор его нужно где-то заказать и мы разобрали батарейку и поняли что а батарейки выходит два вывода питания они проходят через контроллер и уже контроллер с разъемом можно подключить телефону что мы и сделали вот эти два провода которым мы отрезали от батарей мы отрезали от батарейки вот этот контроллер сейчас я его на отдельно слайде покажу вот коннектор подключен к телефону и два провода идут нашу коробочку внутри которой dc-dc преобразователь 120 вольт который выдает вот это обычный блок питания в 4 и 8 вольт которые идут вот сюда на контроллер питания контроллер выглядит вот так вот в этом месте мы его отрезали это кстати контроллер от нексусу если кстати сравнить контроллер от нексуса и контроллер от айфона кажется что-то iphone это вообще к космической технология потому что там еще все в два раза меньше чем здесь очень прикольно следующий вопрос как вывести провода из корпусов проект батор о котором я уже говорил используют гибкие печатные платы в них получились такие проводочки аккуратненькие красивые по сорок два бакса каждый мы подумали что это какой-то overkill и вообще такие проводочки нам все равно не помогут случае с айфоном потому что ты его просто не соберешь с торчащим хоть и плоским проводом поэтому мы нашли другое более дешевое решение вот такое ветер или iphone этот просто вот какое-то садистское удовольствие вот такие аккуратненькие телефоны нас получаются вот просверленный iphone 6 или даже 6 + nexus huawei разные телефон acer лили самая большая сложность возникало с пятыми айфонами потому что как выяснилось на в сервисе потом сказали что там крана одноразовые то есть ты собрал iphone один раз и все больше его не надо разбирать и собирать обратно если вы так наук ранд его обратно не воткнешь ну то есть воткнешь но 50 50 процентов что он заработает и где заработает вот интересная история вот и вот так выглядит наша коробочка с подключенным телефоном вот она у меня на столе лежит сейчас я надеюсь не еще тут белый дым и ничего не выйдет вот коробочка подключена кленового блока питания там внутри dc-dc ардуинка imax 471 микросхемка измерительная и два провода идёт телефон здесь разъём который нельзя вставить неправильно мы планировали коробочки такие отдавать в сервис и чтобы они сами тестируется поэтому нам было важно чтобы вот этот разъем нельзя было ставить неправильно ну понятно что там белый дым может выйти что мы с помощью этого можем померить мы можем собирать с помощью ардуинки 500 сэмплов в секунду и строить вот такие замечательные графики синенькое то ток по нижней оси это число измерений получается этот не приводил к секундам а по вертикальной оси слева миллиампера и справа миллиампер час и красненькое линия этого сколько миллиампер часов мы на ели кумулятивная метрика вот это первое что можно замерить и еще если мы несколько раз запустим нашу приложению разные релизы или разные приложение положение конкурентов например то мы же можем померить среднем потребление тока и сравнить их вот здесь видно что вконтакте музыка есть меньше всех где тут яндекс музыка я не могу подать вот ну да да вы там где то не скажу где вот когда когда я опубликовал статью про это на хабре я ожидал комментариях про то что отчитывают удар дэнг вообще используйте там вообще любит роль троллить на эту тему вы используете ардуинка в рабочем проекте ой боже мой вот поэтому я хочу сразу сказать что бы не только рынку используем на самом деле и не только в таком виде как я показал от висящий на проволочках наша коробочка внутри выглядит примерно вот так это вот мы скитается в пример взяли и приклеили идет на термо все компоненты на термо клей и развили проводочки снаружи выглядит хорошо внутри не очень поэтому мы решили еще поэкспериментировать с печатными платами у нас сейчас эксперимент продолжается но мы вот такую печатную плату вы травили в офисе прямо за один день буквально и разместили на ней компоненты очень удобно и ускорит процесс производства наших коробочек и увеличить их надежность еще мы экспериментируем с есть t8 266 микросхем кой она быстрее чем ардуинка ардуинка 16 мегагерц это микросхемка 80 мегагерц у нее встроенный вайфай то есть можно метрики по беспроводной сети снимать не знаю пока хорошо или или плох мы не пробовали про вот этим работать мы поэтому и лепим разные прототипы чтобы посмотреть вообще как удобно с вайфаем удобно через юсб может быть удобно через bluetooth или ethernet вот разные эксперименты проводим и здесь встроенный отсек и не очень удобен потому что там диапазон измерений от 0 до 1 вольта и а у нас ток до 3 ампер бывает с батарейки и макс 471 вот он кстати он выдает от 0 до 3 вольт и нам придется культа съемку городить чтобы уровне согласовать поэтому мы взяли внешней ацп ацп кстати тоже разного принципа действия бывают если кому интересно я потом расскажу и этот конкретный оцепила может снимать 820 сэмплы в секунду и мы можем можем их прямо по вайфай и деби пакетами слать любому получившемуся клиенту теперь дальше что еще интересно было проекте батор они брали логе потребления и синхронизировали их с лагами a trace a trace это очень подробный лог с телефона то можно снять очень много всего есть еще логе батареек история но кажется не менее подробно здесь вот буквально до секунд есть милисекундные точность можно там снимать когда начался началась отрисовка фрейма много всего вот конкретный пока не очень с этим разбирался синхронизации это первая интересная идея а вторая интересная идея что мы можем посмотреть потребление энергии за время отрисовки фрейма и они так делали для браузера для браузеров для разных для разных ревизий браузеров они смотрели как отрисовываются фрейм и нашли проблему в хроме вами связано с повышенным энергопотреблением вот это да после исправления бага получается а это долго исправления бага вот и сафари меньше сожрал всегда вот мы подумали что нам это тоже интересно и поэтому нужно больше сопла в секунду собирать потому что один фрейм отрисовывается 16 миллисекунд при наших пятистах сэмплах секунду это всего там вы получается 2 сэмпла один simple две миллисекунды то есть его 88 сэмпл была такой графику получилось это мало мы решили попробовать под разогнаться покопавшись в ардуинки удалось разогнать ее примерно до 50 тысяч сэмпл в секунду но я это дело забросила потому что потому что я вспомнил что у меня есть arduino дуй в который arm-процессор там 84 мегагерца и у него сэмплрейт 1 герц то есть он может сыграть один миллион сэмплы в секунду и потом эти сэмплы можно отсылать по usb очень быстрого потому что там нативный usb используется ордынке используется избитую serial он медленнее и там еще проблемы с com портом возникает то есть нужна скорость com-порта как-то повышать мака там на маке это не очень получается на линуксе там танцы с бога нужны в общем нативный избил работает в этом плане лучше вот и есть еще ну поскольку arduino все-таки довольно большая и дорогая там полторы тыщи стоит по сравнению с arduino nano мы еще смотрим вот на такую платку маленькую с stm32 процессором и той же архитектуре соответственно возможности те же но стоит вот эта маленькая платка 300 рублей поэтому на ней вообще собрать девайс который имеет 1 миллион сэмплы в секунду будет проще там правда программировать на них сложнее вот и покопавшись в интернете я нашел практически готовый код для сбора вот этого одного миллиона сэмплов там кстати еще в stm32 еще дома есть когда вы можете сетевой ацп сказать пиши мне в память вот такое место следующий буфер у тебя такой она сама пишет о процессор она при этом не трогает процессор занимается отправкой данных по этому еще быстрее можно работать чем ардуинка вот и к отцу на питоне который отрисовывать в реальном графики миллион сэмплов на экране это просто поражает воображение там внутри конечно нумбани qt но сам факт что код на питоне может а быстро работать это круто я люблю бетон за такие вещи вот так вот выглядит одна миллисекунда с разрешением 1 миллион сэмплы в секунду то здесь вот 1000 сэмплов получается вот и естественно на 16 миллисекунд будут выглядеть очень подробно таких графиках дальше синхронизация доктор делает синхронизацию по работе вспышки я должен попробуем пока в ручном режиме я помогал вспышкой на телефоне примат рукой потыкал фонарик помигал влогах отложились события включения вспышки выключения вспышки я их и слоган огре пол посмотрел на графике синхронизировал графиком и соответственно все остальные события излагал у меня встали на мой график например события клик на ссылочку это началась загрузка файлов это она закончилась и можно прямо так разбивать по этапам и смотреть на каком этапе сколько сколько батарейки живет наше приложение к вот мотор это научился делать в автоматическом режиме они даже написали конец и сделали и мы тоже собираемся это сделать делается вот так они тыкают мигать фонариком псевдо рандомной последовательности то есть вот эти промежутки времени между импульсами фонарика и продолжительность горения фонарика она постоянно потом они моделируют сигнал соответствии с записями влогах и ищет кросс корреляцию между графиком потребления и сигналом которые не сгенерили и в том месте где совпадение идеально на графике кросс кавитации выпек соответственно в этом месте у нас и происходит синхронизация вот и теперь я хочу продемонстрировать работу приложений нашей если получится конечно била-била дым если у нас сегодня не накроет так сейчас я пытаюсь перетащить браузер чтобы всем было видно у меня подключена подключен телефон коробочке коробочка подключены по usb к ноутбуку и мы сейчас находимся на десктопе то есть ничего не запущена просто экран горит наживаю кнопочку снять показание из коробки 30000 сэмплов это будет топ поехали пока снимают приложения понятно дело недопиленный это небольшой питания чей сервер на торнадо плюс bootstrap и даже по моему java script а тут нет а уже лежит в области можно скачать и попробовать если вы рискуете просверлить телефон конечно вот но мы планируем эту штуку развивать в курсе вот там будут возникают некоторые интересные возможности типа синхронизации пока мы собирает данные я должен еще что-то сказать наверное за кажется что ничего не происходит на самом деле она усердно работает гоняет данные по юсби баллады молока не видно вот собрала один блок так теперь построим я еще вчера собирал влоги вот они есть вчерашние логии сегодняшний по сегодняшнему построим квантили потребление за секунду и вот видим что есть какой-то периодический процесс есть какое-то фоновое потребление есть пике максимально вот это колотили посекундно можно там еще другие графики строить и можно сравнительные графики построить что вы не ждали я покажу сразу если вы не против графики вчера собранная вот 1106 1106 это график собранные на десктопе как сейчас мы собирали а это график я просто ткнул приложению здоровья которую мы сегодня зарелизили сегодня он был вот и оставил ее просто лежать и оказывается что приложение к здоровья просто лежащие живет меньше чем телефон лежащим с доступом кто мне ответить почему еще варианты нет я не выключал кран кран оставался то же самое если ответ ok google он постоянно слушаю это живет батарейку вот собственно вот так примерно на шаровой невест теперь выглядит нагрузочного тестирования провода там хлорное железо где-то стоит перчатки антистатические респираторы вот давайте ваши вопросы спасибо большое за доклад у меня такой вопрос а вы не думали использовать в качестве обратной связи как раз подключение по избе от телефона к ардуинки а передача по вайфаю на компьютер не стал что вспышки использовать для синхронизации логирования а но там могут возникнуть еще проблемы с задержками по избе и и так далее и вообще сложно там контролировать сложно подключиться к телефону с ардуинки будет сложно будет контролировать что она не живет телефон se usb не живет одна из проблем сейчас это запустить автоматизированные сценарии на таком телефоне без подключения к usb потому что подключение к избе сразу нам все портят а наоборот вайфай или bluetooth использовали подключение крутым с телефона bluetooth к телефону чтобы синхронизировать не пробовали но мне кажется что проще помигать лампочкой потому что любая приложения может помогать лампочкой прикручивать bluetooth это опять же потребление энергии лишние вайфая тоже потребление энергии и там тоже могут быть задержки могут быть помехи по мигает лампочка это надежно и проверено мотором до нас спасибо то есть мне тоже на первый взгляд казалось что это какое-то вообще странное решение телефон есть провод есть телефону но потом поразмыслив я понял что вообще это интересно автоматически можно круз корреляцию построить вспышку напрямую на контакт орды типа выход со вспышки можно фотодиод поставить не придется дырка сверлить кстати эта хорошая идея эти микро записывается еще ты упомянула system32 не сказал что там какие-то сложности возникли с программированием можешь рассказать подробнее о нет не то что возникли я просто их предрекаю для себя потому что состоим 32 до этого я не работал там стек свой программный там нужно либо ставить себе виду и использовать фреймворк для stm32 в котором там можно при configure свои устройства либо нужно arduino вский фреймворк тащить на stm32 что самом деле не очень либо писать вручную прикручивать какие-то собственные библиотеки что я и хочу сделать но мне кажется что это довольно непросто будет может быть может быть это не так кажется is the link вполне нормально работает на линухе ну значит это будет просто это хорошо мы просто еще не пробовали stm32 заводи потому что у нас есть ду и мы пока с ним экспериментируем т.к. спасибо но тем ни менее центре цена уже приехал можно потыкать zdravstvuite спасибо за доклад скажите а почему бы не использовать с.п. она слабее s3mki есть п я говорю там встроенный ацп он с другим диапазоном если стоянки тоже от 0 до 3 вольт измерения у этой от 0 до 1 вольт и нам нужно будет придумать схему согласования которые лишние лишние элементы на оплату нам понять нужно будет а тут просто проволочек подключил и все это проще это удобнее вот поэтому если мы будем делать что-то уже вот прямо в полностью на плате разрисовано в заранее в каком-то со все который для проектирования плат тогда мы уже подумаем о том чтобы использовать там разные варианты определит просто обычный делитель ставится и все ну не знаю керала даже обычный делитель это все равно лишний резистор там по которой нужно на печатной плате место предусмотреть ну а тут получается ты к платки проводочек подключил и тебе больше ничего не надо делать это просто удобнее тебе не нужно даже печатная плата то наделать зачем нужна если тебе просто про дочь подключить занят а у меня такой вопрос а нет прямой зависимости потребления тока от там потреблению себе она не совсем прямая там есть еще яркость экрана есть еще работа с сетью работа с gps все это влияет на потребление тока есть у меня вообще была идея взять вообще собрать эти метрики которые можно софтовое то есть потребление циpкa и так далее так далее замере правильный ток и попробовать методами машинного обучения сделать регрессию и посмотреть как это будет вообще ну можно ли спрогнозировать потребление по этим метрикам но я слышал что люди пробовали у них не очень получилась сами еще не пробовал такое делать но нужно будет все равно смотреть на все метрики во первых во вторых любую софтовой метрику нельзя собирать частотой 1 миллион раз секунду потому что мы таким образом нагрузим телефон еще больше зато можно по метрике собранной метрики потребления собраны миллионы раз в секунду можно наоборот смотреть профилировать код по сути то есть если у нас код разбейтесь потреблением будет видно где наш код больше потреблял значит вероятно там грибы циpкa больше либо там сеть живется или что-то еще и можно искать такими образом узкие места в коде то есть она может быть и в коде может быть где то она может быть воя сна может дать этот надо несколько всяких вот этих до слоев и на них на все эти ну и пока зал с мы пока еще не научились толком следить но средства какие то есть вот тот же a profile он подробно собирает есть логе андроидов ски есть better их история это проект которым там прям отслеживать сказать что включалась когда что работало мы хотим это все прикручивать вообще под твоим каким-то наблюдением и тут сколько там процентов даст ну например сохранять батарейку если ты узнаешь что-то мутят gps там чуть большую ну то есть как разработчик положения что могу потом сделать если получит эти все данные ну можно просто взять найти проблему в коде конкретно конкретное место и там почистить я не знаю конкретно сколько процентов это может дать но вот я даже не помню сколько у гугла получилось в кроме у меня вот этот баг поправили с потреблением то есть там на одном графике был вначале пик потом все внизу а на втором графике постоянное потребление они насколько я помню просто сменили функцию отрисовки и у них это поправилась а чтобы найти эту функцию они использовали как раз метрику потребления то есть атом профилировщика каким-нибудь именно процессор этого не было видно или они там ни говорили ну вот то что я читал это было право ток может быть они по-другому искали я не знала бы статьи не то написано и потом профилировщика они тоже влияют на результаты тестов чем чаще собирать статистику тем больше по аффектами результата а тут получается такая косвенная метрика которая никак не влияет на то что в телефоне происходит собрали мой итог померили скажите пожалуйста вы каким-то образом пытались оценить размер тока утечки в зависимости от температуры телефона потому что чем дольше работать приложение тем больше греется телефон тем больше только утечек не пытались это наверно будет еще одна проблема в организации наших тестов мы когда мы когда-то еще начинали думать о том когда делать думали о том что есть батарейка в телефоне она разряжается она деградирует со временем поэтому повторяемости тестов возникнут вопросы батарейка исключили окей теперь телефон нагревается и он может и на физическом уровне это может влиять на телефон и наса в тварном уровне это может влиять на телефон потому что телефон может отключать устройства если чувствует себя перегретом вот и это мы пока еще не мерили не знаем как лечить не знаю твой телефон холодильник пихать до все спасибо докладчика спасибо"
}