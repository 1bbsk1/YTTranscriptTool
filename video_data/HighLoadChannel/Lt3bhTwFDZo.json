{
  "video_id": "Lt3bhTwFDZo",
  "channel": "HighLoadChannel",
  "title": "Полнотекстовый поиск в Couchbase Server / Дмитрий Калугин-Балашов (Couchbase Inc.)",
  "views": 1013,
  "duration": 2028,
  "published": "2020-04-14T11:40:01-07:00",
  "text": "спасибо поднимите руки кто меня знает зато половина обалдеть расскажу для тех кто не знает а тут же сводиться не переключили кто я такой я больше свою жизнь и писал поиск сперва где-то с 11 года писал в мыле поиск попочки потом уехал штаты чуть-чуть поработать над какой-то там сторонний работе и опять пришел к учебе и списать поиск и с какого-то момента конечно переключился на другие части на вторичные индексы которые рассказать не могу потом уже закрыта но могу еще рассказать про поиск опять же это не сразу вопрос а зачем в базе данных поиск нужен кто знает ну но ездить винкс есть сфинкса причине искать сфинкса чем его в базе данных там искать там люциана какой-то souls и ластик search зачем его вообще внутрь баз данных власть о консистентной когда давным-давно от когда писал поиск для почтовых ящиках mail а я писал движок сам поиском я из доклад еще у нас так как он старухой логе очень классный доклад можно посмотреть места я на хабре как и как это сделано в мою румбу и тогда примерно в тоже время и люди которые пишут под гаррис олег и команда они рассказывали про план тексты поиск по сгрызть они рассказывали что вот все что снаружи то ерунда в плоскость хорошо я сидел и думал зачем если же подзадачу пишем специальный пояс под явно лучше чем какой-то общий в базе данных и я так вы наверное лет 5 ну зачем зачем писать внутри база данных из мой специальный поисковый движок сделать и не трогайте какой-то не делай какой там курсе комбайн а оказалось что не все компании миру и многим компаниям в общем-то не обязательно нужно самое удобное то есть но самое быстрое самая им нужно не париться и когда за них решена проблема тоже консистентной первую очередь им это удобнее не то покупают это вообще одно из кстати первых вещей что я понял когда переехала в сша авто не всегда покупает самое эффективное решение иногда покупает там где меньше слуги малый произносить можно там да там где меньше геморроя потому запекайте вот и как тот момент я стал работать над поиском еще один расскажу самый кишки счет того что последние ним делать самую жизнь выкинул и оставил так чтобы хватило до конца до дома доехать и него не уснуть на самом деле в какого-либо из пальца немножко сторон не движок и движок булавин называется он open source на гитхабе нотой создавалась начально внутри каждый зону щетки немного отдельный проект то есть очень создатель самый первый час каждый день не работает это просто реализация поиска нога это библиотека и немного истории изначально плыви был это простой монолитный индекс вы знаете что если у вас есть просто хранилища ключ-значение туна не он сделать полнотекстовый поиск а очень просто то есть берем слова слева вы видите ключей в виде значение ставим документы все у нас есть к полной тексту поиск работает она хреново он очень большой становится и в общем-то обычные хранилище килы но под поезд не оптимизирована нагрузка по поиску частично особенно из у нас апдейты какие-нибудь и она начинает тупить поэтому в какой-то момент при не было принято решение создать специальные хранилища под поисковые данные это было сегментированный индекс ее суть вот такая что есть сегменты они имеют обл к сожалению знаю как по-русски быть иную это было думал долго не так не придумал неизменяемые мне кажется не совсем точно ну пусть будет неизменяемые сегменты readonly сегмент ужин глич английская и они оптимизированы под поиск сейчас покажу как кто знаешь кто не знаешь такой обратно индекс монологи учит oxpahу есть кто не знает обалдеть и раз суть о отлично есть выйдет только та книга нету давайте представишься на есть вот мне руках я ее открою найду специально вам расскажу да на эту а сейчас то есть вот есть книга я хочу чет найти по какому-то слова этой книги как сделать открывай последней странице там обычно есть указатель тут его кстати не так зря а он быть начали а и вначале нету ну есть указатель там слова и страниц на каких местах и там термин встречается это она есть то есть обратный индекс сопоставления слова со списком ну в книге это страницы у нас и какие документы в базе у нас база хранит этот документ ориентирована базы данных там две сумки хранятся вот ссылочки на эти документы есть все это это вот это все что нужно поиск и как это сделать то есть ну самое простое как хранить список слов давайте хранить в map кто владеет готской знает что-то хэш-таблица ну это не очень хорошо потому что слова они в общем то очень но вообще иногда на детали руется по словам то есть мы хотим там если у нас не точный поиск но мы начинаем считать расстояние левенштейн а и прочее и нам надо немножко интегрируется местами и похож на по нельзя мог сделать дерево деле она здоровая то тоже не годится потому что займет ну мы делаем хранилища под поиск это не годится под поиск это какое-то общее хранились какой в базах данных а есть префикс на дерево-то и вот это уже хорошая штука она довольно компактный может через два массива построить ну можно ли сделать учу кто кто знает хоть один способ хранить список слов лучше чем трой какой близко пачки да возможно одно и тоже кстати вот такая штука есть финиста это жусай это автомат его написали тоже в рамках овощебазе сами он есть у других языках реализация вот называется двум и в нем есть всего лишь три процедуры и у может построить один с ним можно искать по ним можно и тренироваться чтобы построить нам нужен список слов он должен быть алфавитном порядке то есть мы должны заранее список слов чтобы ту штуку построить но у нас сегментированные индукции сегменты неизменяемые то есть мы его построили забыли там отлично подходит и давайте просто построим у нас мы должны хранить парик слова и какое там число пусть будет этот потом вот указатель у нас мы хотим хранить павел слова число если мы делаем слова а первое слово из через на чьи-нибудь 4 то у нас будет четыре состоянии автомата не просто нумеруются числами а на каждом ребре есть буква и число и вот по сумме этих чисел мы считаем конечное число то есть солаар дает в конце и четверку мы добавляем второй слой получается вот так двойка двойка то есть слово орды четверку два плюс два по верхней линии так часто попробовать эту фичу вот по верхней линии два плюс два вот у двоечка и тут это 4а на эйд у нас просто 2 и тут ничего нет добавляем 3 слова так получается то есть там внизу . а потом мы еще делом одну операцию его так компактен и получается автомат я то есть не буду прям влезать как это делается глубоко то есть нам код читаешь довольно легко вы сразу поймете и очень легко читабельный год ну а вообще у нас там просто два объекта в одном случае the builder мы строим то вот эту операцию делом а второй случай лидер мы читаем и делаем либо поиск либо итерацию открыть и мы можем либо из файла либо из какого-то массива байт это вам очень нужно будет 100 подковать из массива байт дальше и дальше просто вполне какой поиск вот так вот например а дальше вот это первая часть на список слов о к списку слов у нас список страниц книги вот в этой и как хранить вот парсинг леса как раз тот самый список документов пиза какая страниц как его хранить кто знает как можно хранить просто список чисел массив отлично вот это про список чисел и есть массив как еще давайте представим что число от нуля и до конца книги то есть они вот прямо с нуля точно начинаясь подряд есть такое да у меня нет флаги да действительно можно бывает от это дельта кодировании будет да есть такое вот фильм фиксатив когда-то было по моему еще вот так можно согласитесь удобно то есть мы храним на список и мы знаем что это вообще не повторяемый список то есть там не будет повторяемый элемент потому что список документов просто то есть зачем нам повторяться убитого массив a massive битвы еще и звать можно иногда не загрузки рангсан кабин джеки она не всегда сжимает поэтому то есть на тоже знать можно ли сделать лучше как думаете ну вопрос подвохом если спросил значит можем можно есть такая штука уровень bitmap библиотеки пачки добавляющих языков есть работает так мы берем просто последовательность наших этих чисел и разбиваем на куски начинки каждый чанг кодируем отдельным способом вот одним из трех которые учатся возьмет тот и будет итак мы получаем какую-то минимизацию там есть ряд проблем например бинарная операция and ours про очень и очень и очень понят как делать но именно как хранение она получается более эффективно чем какой-нибудь способ отдельность и свой осознанно было специально для полнотекстового поиска и теперь давайте попробуем сделать это поиску все что надо рассказал и мы сделаем у просто моим alain le вот у нас есть snapshot это наш индекс в общем-то на какой-то на какое-то единицу времени и там есть вот эти вот сегменты про которые сказал то есть у нас несколько сегментов них данные по ним вне внутренних ведь эти обратные индексы мы там ищем и они все аведон ли у нас есть такое приложение которое будет нашим поиском и мы пытаемся что не туда добавить мы создаем мы хотим сделать вот так новый сегмент еще один добавить какие-то данные но понятное сумму что добавляем возможно там будет удаление какие-то данные в виду сегментах инвалиде руются сами сегмент нам не нужны то есть мы их скопировали поскольку они скопировали так под имеют иксом и мы добавили новые сегменты есть такие вот маленькие вот эти штучки это вот эти вот маленькие штучки это просто битовые bitmap и битовым битовые массивы есть что-то удаляется мы просто там выставляем биты то есть как бы snapshot и сам сегменту на редон ли он имеют обл а удалить что-то может выставить и бита если вот в ном ном сегменте to france пришла и вот вот эта штука называется сегмент introduction то есть я сегментик новый и есть by то есть грудь и на интервью со который просто ее задача добавить этот сегмент наш snapshot и по канал это посылаем она еще раз уже под эксклюзивный блокировка выставляет эти биты потому что за время пока мы передавали кто-то могло измениться то есть пирло мы делаем так opti оптимистично выставляем скопировали выставили под опа а теперь мы делаем точно это время на короткий промежуток мы делаем эксклюзивную блокировку и потом делаем раз и готово и добавили сразу то есть вот это вот эта операция под эксклюзивно блокировка происходит и все им и дальше ищем уже нас 4 snapshot вот нас 7 млн для решения как с ним фото устроенному чуть позже рассмотрим хотим сохранить на диск есть еще одного выйти на пир и сестра и у нас есть какие-то номера эпох то есть есть реально и вот мы пронумеруем еще тут белый они очень заметно baby сидит это на пронумеруем сегменты и если нас времени пенсии вещества на цикл for время ты меня пробуждается смотрит о появился новый сегмент давайте сохраним и у нас есть для этого сегмента база данных маленькой куда он сохраняется есть корневая гко него это просто пи записывает все вот эта девчата конструкцию им это про сохраняем на диск для геи там был кто-то за базу данных вообще изначально был был потом создателю решил нас всех нафиг я устал я ухожу было тебе закрылся его формуле теперь bible деби какой то есть ну в общем она работала все равно плохо то есть мы тут меняем дальше номер эпохи когда мы записали но я баттона плохо потому все таки это вернулись той же проблеме что базы данных вообще не очень подходит для хранения поисковых индексов и мы заменили то на формат zip это уже самописная штука я принес к концу а корневая база осталась был body by там ничего особого хранить не надо а есть нам нужно меньше сегментов то есть вот мой они растут и растут растут они все неизменяемый когда-то мы хотим их склеивать каким-то образом для этого есть ночью кстати да вот важный момент когда появился zip-файл когда мы записали на диск мы сегмент закрываем и тут же обратно открываем уже как-никак in memory сегмент а как сегмент на диске то есть у них одинаково интерфейс но не по-разному устроены сегмент на диске это он просто проецируется в память через map и он устроен так чтобы легко проецируются в памяти так работать то есть мы его закрыли открыли он стал оси к другу другим объектам если мы хотим склеить создает какой-то мертв плен менеджеры это третья грудь и на также есть номер эпохи когда мы можем и мы делаем какие-то операции и вот этот вот мертв introduction точно такой же как обычный сегмент introduction самом попадает об этом и продюсер по сути создает новый сегмент а скоро какие два склеивают и под и удаляются туда данным им ему то есть удаляем че сегментов таким образом и теперь что же такое за формат zip это про сегмент на диске и мы его не читаем ридми он сделан так чтобы читать тем этом то есть мы полагаемся на персону систему что она довольно правильно это все буферы живут и то есть и данные внутри создали максимально работы ммм и так сейчас посмотрим достаточно ли видного так вот а вот отлично это сам формат zip выглядит страшно попробуем объяснить 1 самый интересный вот здесь начинается это наши индексы и вот весь то есть внизу есть футов это просто а писатель где что искать и вот поэтому указатель мы находим индекс полей выглядеть тоже вот так что там есть то есть у нас есть сколько то при индексированных полей в документах ты документы джонсон документами из поля они как пронумерованы и они проиндексированы и вот это от нуля до f с решеткой столько тополей сюда указы указатель вас только полей мы знаем заранее сколько их если нам надо найти название поля то но там есть то есть мы сходили в fields индекс нашли указатель сходили fields нашли место это и прочитали название поля что это такое есть ну ка еще один указатель показатель вот сюда очень грамотная штука указывает он смотрите куда он тонов туда вот верхнюю часть то есть мы пропускаем кусок 1 и там будет храниться конец хранится вот наш словарь и dictionaries под каждое поле вообще свой словарь вот и вот тут вот эту указатель он показ показывает где вот на это целом данные а мы помним что вам он может хранить дома читать данный promise памяти мы провели память нашли нужно указать или просто из целой со вот взяли кусок данных и начали как в ломом в нем искать то есть нам даже не надо мне виды ничего ты еще естественно берется уиллом это просто к списку слов мы делаем список авторов куда эти овцы ведут они ведут вот сюда смотрите а тут у нас фарингит над есть это то есть ровно те данные то есть номера документов на которые найдут по этому слову в этом поле и еще есть немного это позиции у нас то есть если мы хотим подсветочку сделать у нас есть позиции вхождения вот вас длинная строка какой то мы знаем в каком месте это строке за находится и есть определенные там статический частоты встречаемости прочие нужен для ранжирования вот смотрите осталось много на самом деле вот эта штука это даг wheels это вспомогательное штука на не обязательно это список полей и там хранится какие значения полей они нужны для ранжирования то есть мы просто дублируем по номеру поле какие значения которые там хранятся по для каждого документа то есть для каждого кумин то мы знаем значение поля а это набор для каждого то есть для каждого документа - пюре о список полей их значений что самое важное тут есть искусственное поле это аиде дело в том что внутри за файла все документы нумеруются с нуля и до скольки хотим о самой базе данных по другому там номера вообще-то мы и текстовые имена и вот тут как раз и происходит сопоставление между номера внутри zip файла и номером внешним или имени внешним сохранится и остаются какие-то мелочи то есть это чанг фактор это на какие кусочки бьем когда мы делаем и чанки данных верующие контрольная сумма и число документов и вот и вещь собственно zip файл далее кто еще есть то есть как искать я думаю то есть уже понятным это право им память находимся как по какому нужно фил думающим находим до слова ну и в общем-то и идем по вот этой вот длинной цепочке сейчас вот поэтому длинной цепочке идем мы находимся результату дальше есть такая интересная пиратскую крубик больше данных принципе нужен rollback всегда и мы вот нагородили огород вот это все и что внезапно казалось нужно откатываться иногда кто догадаюсь как это сделать ну серьёзно откат очень просто делается есть да это звучит как как откатить смотрите у нас есть эпохи вот мы храним от в этой базе вот в этом вот корневой мы храним вот эту конфигурацию почему не храните предыдущие 0 не все несколько предыдущий которые можно откатиться состоят находим откатиться на предыдущую эпоху мы достаем просто конфигурацию за от этого индекса и стираем все лишние вот получаем просто откат на предыдущую эпоху эпоха это сегмент мы добавляем по dance операции как это происходит группа операция бы что есть мы вставляем группой большой команды ну под эксклюзивом сделаем это олдаг то есть как был убит под заключим сделать это не зашквар идем дальше да то есть и это вот как работает само ядро но то есть как работает поиск более менее очевидно то есть нас поиск идет по точно совпадение то тут прочитали прошли по цепочке нашли если у нас не точный поиск там добавляется автомат левенштейн а начиная с какие-то итерации поэтому вам еще равно примерно то же самое происходит то есть она достать дальше то есть это самая такой не низкой и нам это всё на как-то интегрировать в большую инфраструктуру как бы сервера как сделать но есть отдельный демон он не то чтобы интересен просто внешне умер ну интересно да просто почитать как он устроен по сути это оберточка вокруг плыви того чтобы связать с одной стороны всю структуру кожи с другой стороны вот эти движок то есть вот такая прослойка между кейси были у нее есть отдельный уай иногда не работает иногда работает то есть как бы он не то чтобы он час использован он в каких-то версиях точно есть у нее есть 1 и 5 то есть помощи неё помощь это тебе в тех уже можно делайте поисковые запросы через веб но это часть цепи по сути из другой страны он связывает bucket и в коуч безе с поисковыми експрес он просто обеспечивает поток данных из хранилища в яндекс а еще очень важно что у нас как хранилища так и и всей и поисково яндекса не разбита на разделы то есть они могут должны разных машинах быть и за это тоже днем отвечает тайсон то есть обеспечивает разбиение индекса на разделы еще интересная штука в то из этого понятно что написал никол кто сказал никол работали сквозь призму просто обычно это редко правильно прочитать назвать никол это мог сказать такая настройка на диск уиллом для джейсона то есть а все кому не лень и делают свой запрос джейсона кого есть в общем тоже претендует на какое-то создание языка да да да да вот прям передо мной были это смотрел удивлялась право заснул потом ну потому что устала и в тесто фу так search как можно вообще в костеле выполнить полный текст запроса по тексту поиску ну понятно может сделать через консоль в то есть из кто никогда не ставил как бы все это вообще очень удобно консоль просто даже выпускники гуманитарного факультета сразу спокойно разбирается что там делать там очень проста и понятна и там можно просто в окошке ввести поисковый запрос и найти что-нибудь все документы есть раса этой есть к из детей который в общем-то то есть библиотечка для любого языка то есть тоже можно но кажется не всегда это этого хватает в чем проблема потому что у нас если есть из нас есть простые запросы это в базу есть полнотекстовый мы идем про с двумя разными путями на самом деле то есть простые запросы но есть некие well это мы идем через nikol а поисковый отдельно и хочется как-то просто сделать поисковый запрос через никол просто из и это теперь мог сделать то есть появилось это то есть вот описание сникла есть описание фтс как как вообще выглядит не повод просто я даже объяснять не буду просто примерно приста представить то есть она сама сама читается сделаем запрос он очень похож на сквер ну иди запрос под а нам еще вот так выглядит вещь есть пять она вот-вот выйдет есть полноценно интеграция они контекст поиска вникал но дело в том что раньше тоже можно было это делать но выглядел это немножко вообще знакомы с патроном проектирование костыль вот выглядел это так смотрите я не знаю видно нет а у него есть функция куру и обращаемся крестный перейти к поиску ведь индекс беркли и просто делаем запрос это поисковый запрос и скверы вот в буковки все и да вы вот users пасха давно указать но она работала это делать можно было и ну понятно эталонный противника ст и делаем что дальше хочется что-то вот такого вот так и сделали в общем-то то есть my toyota то есть на база киев ул your то есть well это наш сон документ таки это просто . и метод метода тайге это просто вот как раз ключ и хочется вот так просто поиск и хочется как-то вот не ходить через кулам даже под капотом а сделать внутри что сделали сделали в топ engine который обеспечит и на некую там сделали клиент поиску которая просто твои расспрашивала запроса входит поиск уже по внутренним каналам и берет от туда данные а в общем то у меня всё на этот момент давайте вопросы здесь немножко сон сказать то есть как бы раньше был джиджи said a global hawk андрей yandex это вторичный индексы все то есть когда мы исполняем процесс и по сути мы просто добавили источник данных для полнотекстовых данных если есть какие-то плана текста запроса на самом деле то просто функция search я не могу сказать если там что-то типа like функции то есть я на самом деле не знаю сделали или не сделали но пока мере планировали есть не сделали то сделают чтобы распознавать те куски запрос которые полнотекстовые ходить и не гэпом это делать а ходить в поиск но это просто на самом деле доработка angel чтобы определять те куски и запрос который она имеет наверно финик поиск в первую очередь функция search да давайте вопросам собственного ретро полнотекстовый поиск у него важные свойства это качество поиск и ранжирования честного хотелось бы узнать как у вас дела на ранжирование и сортировка результатов по релевантности они на самом деле там просто плагины может любой функции ранджы меня сделать и вот самый интерес часа отмотаю в то есть для ранжирования то есть насчет оранжевым делать такое что вы знаете что указывает человек вообще свое понятие качестве поиска то есть объективные метрики качества поиска не существует дайте микрофон давайте мы договорим да конечно как бы и субъективные критерии допустим полнота совпадения кризиса павших слов совпало по опечатки ли совпало потом полному совпало как остановить ну как бы есть стандартные функции ранжирования типа там ddf те же самые а нельзя не жди существуют и все эти варианты да просто мы вопросах как правильно почему почему то есть стандарт не значит когда еще мере дел поиск как вы не доживете найдут с недовольны бесспорно да ну собственно политика есть инструментарий у вас дает до инструментарий на самом деле это просто pagina которую нога в ногу можно писать и свои вставить какие есть стандартные ясная точный df есть остальные на самом деле не очень помню на путь подглядеть и покажу вам скажу какие параметры подаются на вход плагин могут они понять допустим позицию слова в документе часа полистаю потому что не дав хранятся смотрите во первых у нас есть дак вот это вот значение то есть если нам нужны а именно текстовые который легко достать по и полю есть смотрите вот эта штука частота и норма а то есть исков сколько слово встретилось она есть есть позиции все то есть можешь по позициям а что это начало конец и прочая фразы и и так ну вроде всё остальное под гляжу скажу точнее то есть накоплен частота она под документу или вообще по всему datasette просто ты с кем не совсем понятно по моему по документу и льда с папой был фил да ну а ти такие задавайте давайте глянем на это там одену спасибо за ответ тогда еще вопросы по какому принципу за файлы разделяются а вот мы делаем когда добавление добавление делается бичами сразу группами сколько-то инсайтов объекта по одной штуке добавляя не добавляется и когда мы делаем бичер сразу за файл внезапно сегмент я имею ввиду что как понять в каком запалили искать вообще до него не просто вот когда вот эта страничка идет сейчас я отвернусь надела 110 слайдов key + 3d вот когда у нас вот сегменты продакшен идет вот тут у нас и навели вот эти каз . у нас и на январь одеваются значения то есть если мы добавляем то что и отменяет как у нас законодателю все законы diframe врач из федерации выходит вот то самое мы просто отменяем предыдущие какие-то элементы запале и добавляем новые соответственно в любом всегда где-то в одном месте будет но искать надо везде фнаф мы не знаем где то будет понял сюда более того это не zip файл на самом деле потому что они часть из них in memory то есть есть по вещества это важно на самом деле важно забыл уточнить есть переезд и он иногда сохраняет на бетон не всегда мог сохранять это сколько может быть in memory имиджа он может сливать еще склеивать шейн мимо сегмента даже не особо не знает чон чон склеивает да еще вопросы наверное вопросы закончились но дальше интриги не будет подарками ладно будет будет интрига с подарком во-первых 1 интрига с подарками это здесь твое имя фамилия подогреваю вещи можно куда-нибудь сюда можно самолете да и соответственно сумка не знают на спорте такие используются да да используется в ней это надувные шины с гипсовым которые в семье вот но у нас есть для тех кто сдал вопросы два подарка 1 книга другой кружка подарки от варгейминга соответственно для для тебя вот такая вот задача выбрать кому книжку кому овладеть им сложно давайте монету кинем у нас нет монетки и даже приложения которым эмулирует монетки нет как нет вот сейчас найду нечетный да давайте четный нечетный это книжку разыгрываем так нечетный книжка и 102 кружка кружка кружка а так спасибо тебе огромное мой дрожать не за что"
}