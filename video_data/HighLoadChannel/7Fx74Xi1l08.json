{
  "video_id": "7Fx74Xi1l08",
  "channel": "HighLoadChannel",
  "title": "Многокритериальная оптимизация поисковой выдачи в Авито / Андрей Дроздов (Avito)",
  "views": 1728,
  "duration": 2975,
  "published": "2019-05-15T04:47:11-07:00",
  "text": "всем привет меня за дроздов и я расскажу поисковой выдаче а название доклада точно сложным но это было сделано намеренно чтобы пришли только люди которые хотят хардкора и разобраться в этом о чем вообще речь как мы знаем авито это классе fight где люди выкладывают свои объявления продают какие-то товары и счетах и так далее и так получается что у нас есть несколько сторон у каждой из которых есть совершенно разные интересы они могут быть разнонаправленные то есть например покупатель в чем он заинтересован что как можно скорее быстрее найти свой товар чтобы сделать минимальное количество действий чтобы все было релевантно красивой классно продавец может быть заинтересован в том чтобы именно его объявлений учителя или вообще монетизация может иметь какие-то требования к количеству платных на выдаче и так далее при этом иногда бывает так что у компании может быть какой-то свой дополнительный интерес ну предположим мы хотим на поисковой выдаче показывать какое-то количество дополнительных услуг об этом я позже буду рассказывать так или иначе получается что у нас есть проблема интересов и просто так без ущерба какой-то из сторон эту проблему решить нельзя соответственно нужно найти решение которое позволит ударить максимум пользователей и о том как эту задачу решали в авито я расскажу о чем конкретно идет речь значит у нас будет несколько примеров некоторые совершенно такие абстрактные как например за запрос ягуар есть вы вводите в поиск скажем в поисковике слово ягуар кто-то будет ожидать увидеть машину кто-то будет ожидать видеть животное кто-то не дай бог алкоголь есть совершенно конкретный пример про платные услуги собственно об этом и доклад как я уже говорил покупатели хотят органическую релевантную выдачу амортизация хочет какое-то количество платных или возможно ранжирование вообще подругой формуле и так далее также и третий случай когда мы хотим подмешивать кита услуги например в маленьких регионах люди могут захотеть заказать запчасти из больших городов и об этом мы тоже поговорим тем не менее я специально старался показывать разные примеры потому что не все не все только про платные услуги и если вы у себя будете пробовать внедряется или строить такую технологию так будет проще понять теперь проиллюстрируем то что я говорил предположим мы ввели с авито слова пианино и мы бояр и мы хотим купить пианино страстно что мы увидим мы увидим мы хотим увидеть хорошую климат ную выдачу возможно кто-то со мной поспорить какое пианино лучше но будем считать что выдачи здесь отсортировано в порядке релевантности как мы видим некоторые объявления могут быть свежие некоторые нет но самое важное что они самые релевантные что же хочет от такой выдачи монетизация может получиться совершенно иначе и отсортированы эти объявления могут быть тоже совершенно иначе предположим держаться будет интереснее чтобы выдача было отсортировано по времени вообще почему так классе fight изначально как и любой сайт с объявлениями живет именно тем что люди постоянно что-то новое passed и людям интересно смотреть все самое новое поэтому свежесть в классе fight проектах самое пожалуй актуальное понятие тем не менее если мы посмотрим на две эти выдачи мы видим что в выдаче монетизация объявление отсортированы практически в обратном порядке по релевантности именно здесь мы видим вот некое несоответствие требований то есть монетизация хочет одно опоры могут хотеть другое однако так бывает не всегда и бывает очень удачный случай например если мы в объем в поиск слова finder и у нас появится какая-то раритетная гитара как он 1970 года и например за нее заплатили чтобы она выдачи там было где-то высоко такое объявление понравится и покупателю потому что это хорошее релевантное объявление и продавцу потому что итоге мне и посмотрят вот много крита реальная оптимизация это поиск вот таких вот случаев или смешивания выдачи с для удовлетворения тех или иных сторон значит так мы понимаем в итоге мы построим какой-то оптимальный вариант и нанесем пользователем максим участие как можно меньше пользователей уйдут выдачи ни с чем ничего не найдя какие вообще подходы возможно мы посмотрим как варит и решали эту задачу изначально и к чему пришли период 2007 по 2012 год это было сортировка по времени не было релевантности и выглядело это примерно так то есть мы просто смотрим объявление в естественном порядке но при этом если было какое то объявление проплаченная она поднималась просто в это выдачи наверх тем самым все счастливы и все работает и монетизация и пользователя однако поскольку хотят в целом пальца релевантность это была не самая удобно хоть и самое простое решение значит какие плюсы как я уже сказал это очень простое решение если для вашего продукта этого достаточно то лучше так и оставить однако очевидно есть большие минусы что поскольку у нас строк заданный порядок выдачи то ничего оптимизировать просто не получится соответственно поскольку у нас есть опять же монетизация мы не можем добавить релевантность потому что эта вся мотивация упадет и про всякое добавление новых услуг приводил пример вначале тоже никаких механизмов нет вот тем не менее вот я хотел отдельно отметить это очень простое решение и оно очень много лет прожил о и все было отлично значит период с 2017 по 2018 год поиск стал релевантным и как раз байера стали видеть ту самую выдачу отсортированные прилива насти которые все хотели при этом разумеется возникла проблема как же нам спасти монетизацию и не уронить в этот период проблема поднятия платного объявления решалась внутри формула ранжирования при помощи некой эвристики таким образом мы смогли не просадить монетизацию но отображать все объявления в порядке релевантности и здесь плюс и первых явно бояр и порадовались поиск стал релевантным вторых самый главный плюс оптимизации возможно раз нас есть формула у нее какие-то коэффициента мы можем их тюнить крутить и улучшать поиск и вот в предыдущем докладе рассказывалось как это делается вот все эти процессы были добавлены однако есть и минусы что поскольку задачу поднятие платного объявления мы решаем внутри формула ранжирования у нас абсолютно слабая управляемость то есть если мы хоть что-нибудь поменяем внутри формула ранжирования мы рискуем уронить всю монетизацию это очень плохо значит из этого следует что нельзя менять формулу сильно нельзя использовать сильные методы оптимизации например машинное обучение руки некоторым образом связаны и опять же нельзя добавлять какие-то новые услуги легко просто для этого нет механизма то есть можно было бы как-то подкасты лить но общего решения тоже нет соответственно после того как столкнулись с этой проблемой период с 2018 года возникла необходимость отвязать друг от друга ранжирования и добавление платных услуг мы составили список требования переход ну мы хотим независимость от алгоритма ранжирования чтобы не бояться уронить монетизацию во-вторых мы хотим открыть себя как бы дорожку в машины обучения и сделать полностью управляемую выдачу платных в разных категориях для разных товаров чтобы все услуги платные тарифы и так далее имели физические ручки которые любой продукт менеджер сможет покрутить и сделать продукт таким каким он хочет ну естественно неплохо было бы иметь возможность делать любые подмешивания дополнительных услуг и запускать какие-то продукты на поисковой выдаче соответственно проблемы которые мы видели когда планировали мы думали что это будет просто немножко сложнее реализовать и сложнее интегрировать в целом такой оказалось но мы встретили еще ряд подводных камней которых я расскажу далее значит технологию мы назвали словом блендер и потому что он смешивает 1 типа объявлений и другой и давайте попробуем разобраться как это все устроено сначала мы ведем понятие интента запроса вот у нас будет два персонажа они периодически будут встречаться один будет бизнесмен его заслоняет немножко даже борт но я думаю всем видно и 2 дрессировщик так вот такой intent это то с чем вы приходите с поиском с тем что вы хотите найти но предположим вот мы явно хотим найти машину это наша intent-а дрессировщик например хочет явно найти животное однако совсем корректно будет говорить не про интента про вероятность поскольку мы точно не знаем что именно хочет пальцы можно только предположить какой-то формуле это рассчитать соответственно наши персонажи за такое объявление с машины проголосовали бы следующим образом бизнес бизнесмен который хотел купить машину скорее всего ему она понравится а дрессировщику скорее всего нет соответственно как это получить такую выдачу чтобы творить всех мы просто можем взять и сделал два запроса один идеальный для того кто хочет только автомобили другой идеальна для тех кто хочет только животные и после того как мы получим все объявления и тех и других пользователей мы можем просто просто летим по нашим каким-то формулам вероятности интентов и как мы видим у нас здесь есть два животных ручной домашний ягуар они понравятся любителям животных машины ягуар 2017 и до 16 года понравится любителям машин но ли здесь проставлена специально что показать что другим странам эти объявления могут не понравиться чтобы явно как бы показать конфликт но я напоминаю что это совершенно синтетический пример и в реальности они могут быть не нулевыми тесно поскольку мы говорим о синтетическом примере о платных и бесплатных объявлений охта в реальности мы будем подавать органическую выдачу то есть релевантную и только платные и заполнять ту самую таблицу и смешивать значит прежде чем решить как по какому алгоритму мы будем смешивать неплохо бы разобраться как пользователь вообще смотрит выдачу поэтому посмотрим следующую анимацию вот мы ввели запросы ягуар представим что пока никакого смешивания нет все достаточно просто и пользователь вот смотрят на первую позицию битка это объявление и очевидно что он либо рано или поздно что-то найдет и порадуются либо уйдет с выдачей закроет браузеры расстроится и пока он не перешел в одно из этих двух состояний он начал смотреть соответственно вот мы смотрим на первую позицию например нам оно не понравилось смотрим на вторую позицию смотрим на третью и в итоге мы нашли то что мы хотели теперь попробуем записать это немножко более формально чем просто виде мультика мы приходим начала выдачи смотрим на первое объявление и с некоторой вероятностью мы значит нашли то что хотели сосны единица минус эта вероятность это вероятность того что мы не удовлетворены и мы возможно будем еще смотреть дальше все по делится на две ветки либо мы с никой вероятностью уйдем с выдача либо с некой вероятностью будем смотреть дальше предположим вот как в нашем мультике первое объявление просмотрели на не ушли с выдачи начали смотреть второе точно также исследующие какая-то вероятность мы либо удовлетворяемся либо переходим дальше или можем уйти и так мы доходим до 3 объявления и наконец находим то что мы хотим если все это свернуть в такой алгоритмическую записи получается следующее следуя картинка по сути мы просто на каждом этом объявлении имеем вероятностью для творится или уйти и самое интересное у нас есть вероятность плуг это верность того что мы придем дальше по выдаче и тогда мы плюсуем на счетчик и смотрим следующее объявление соответственно три этих состояния тех кто смотрят те кто нашел и те кто расстроился мы можем посчитать за состояние блендера и мы будем как бы моделировать процесс просмотра выдачи таким образом во время моделирования мы будем стремиться запихнуть как можно больше пользователей во второй контейнер чтобы было как можно меньше ушедших и не на тех кто не нашел то что хотел теперь посмотрим как это будет работать с двумя пользователями сначала у нас не будет смешивания будет обычная выдача опять наши персонажи дрессировщик и бизнесмен смотрят и выдача состоит только из машины предположим они оба посмотрели на первое объявление и перешли к следующим на втором и объявление дрессировщик подумал что то одни машины вообще очень все скучно как мы видим в таблице интентов не все по нулям он расстроился и ушел а соответственно бизнесмен видят что машина ему нравится он идет по вытащу это же находят то что хотел как мы видим вот совершенно наглядно насыщать пользователи расстроилась и не получил то что хотел а мы теряем байеров и плохая ситуация что будет если выдачи будет смешанная предположим мы получили ответ на наш запрос из двух источников и смешали выдачу каким-то образом соответственно у нас есть и животные и машины и теперь те же самые персонажи пройдут по выдаче еще раз значит предположим наш дрессировщик увидел какого-то крутого ягуара и решила купить сразу и он сразу стал счастливым бизнесмен посмотрев на это решил что ему это вообще не подходит но увидев машину продолжим смотреть выдачу ну с какой-то вероятностью и дальше он дошел до той машины который хотел в итоге оба типа пользователя казались счастливыми соответственно внутри блендера мы будем стремится максимизировать части каждый из сторон и уменьшить вероятность to break откуда все это вообще пришло если найти работу индекса про метрики качества выдачи есть такая метрика в found том что качество можно оценить как сумму произведений вероятности посмотреть на объявление на вероятность ему дали творится но нас именно для блендера здесь интересует вероятность просмотра а именно плуг где по сути вот про эти 3 баки то про который я говорил формула из этих компонента состоит во первых эта вероятность просмотра предыдущего объявления вторых это вероятность того что человек не удовлетворён просмотром предыдущего объявления и при этом он должен быть не только не удовлетворен но еще должен не учи то есть единица минус по break то что он при этом останется на выдаче однако формула рекурсивная и как то что то по ней оценить может быть сходу сложно особенно если вот вы сидите в зале первый раз это видеть и соответственно можно попробовать при помощи никого приближении представить что это такое предположим приблизим наш плуг виде формула 098 степени позиция вот мы видим график с 1 по 200 позицию выдачи что чем дальше тем меньше вероятность того что пользователь посмотрит на нужное объявление то скорее всего просто устанет и уйдет если в зале вдруг есть люди которые занимаются поиском а я помню на прошлом докладе в руки поднимали кто-то сейчас может захотеть задать мне вопросы почему 0 детства 8 будет совершенно логично дело в том что вероятность удовлетвориться и вероятность уйти в разных продуктах будет разное то есть на поисковом в поисковой машине в гугле или в яндексе зачастую человек будет смотреть только то что вот уместил с ним в экран пусть он конечно может скролить но он не будет смотреть сильно глубоко в классе файтах когда люди заинтересованы в том чтобы смотреть найти какое-то не знаю одежду или какой-то очень желанный для них предмет они будут смотреть долго и вот как такой пример один из самых моих близких пользователей авито чтобы найти платье может просмотреть тысячи объявлений это достаточно часто и поведение для классе фондов именно поэтому есть общем разница между классе файлами и поисковых машин поэтому на 98 значит теперь как мы будем смешивать здесь написано сложные слова мы сейчас по рассмотрим анимацию в которой все это объясняется но в общем смысл в чем что мы получим все выдача заполним таблицу как в предыдущих мультиках с вероятностями интентов и на каждом шаге будем брать такое объявление которое в максимальной степени удовлетворит каждый тип пользовали который мы хотим после этого мы поставим блендеру некие состояния состоящий из этих трех пакетов те кто смотрят те кто удовлетворён ли те кто ушел и так будем ходить до тех пор пока не заполним всю выдачу и самый сложный здесь момент пожалуй это начальное состояние то есть очевидно что если мы говорим о платных и бесплатных то нужно как-то определить в какой пропорции мы будем смешивать наше объявление ну так сразу в голову приходит наверно пополам но в реальности это все не так и чуть позже мы вернемся как именно это делать значит пример смешивания с точки зрения блендера мы получили две выдать и для наглядности я выделил три группы выдачи одни хорошие объявления это релевантно и хорошие платные те которые платили но они тоже на самом деле были в релевантные выдачи просто возможно где-то ниже тянем их отдельно как-то выделили и просто топ-50 платных объявлений которые тоже оказались релевантно этому запросу стресса что мы делаем первым шагом когда получили выдачи мы берем по н объявление с каждой но в данном случае одно и получаем вот такой набор ну поскольку здесь пример с гитары у нас есть stratocaster например завода fender 1970 года какое-то необычное интересно и объявление про обучение гитаре наверное в данном случае раритетная гитара победит и мы поставим ее на первое место выдачи далее соответственно нам нужно посчитать сколько счастья мы нанесли каждый из групп наших нашей аудитории очевидно что поскольку это хорошая и платная мы порадовали и тех и других и дальше мы начинаем крутить этот алгоритм до тех пор пока не составим выдачу ну предположим мы взяли дальше просто органическое объявление прибавили боярам некий score теперь надо как-то уравновесить поставить платное объявление соответственно ставим платная но предположим но менее релевантно падшему искали гитару fender соответственно монетизация получила больше очков и теперь как-то надо это уравновесить поставим еще релевантно еще одно очень хорошее платная предположим что hand-made гитара очень много части bayru принесет таким образом в равных пропорциях мы смешали нашу выдачу однако все не так просто есть масса подводных камней касательно этого алгоритма и о том как мы с ними столкнулись и как решали проблемы значит я дальше расскажу во первых наверное логичный вопрос а как же считать то самое счастья очевидно что на это вопрос отвечать нельзя потому что это некая тайна коммерческая вот но здесь приведены примеры самых простых формул без каких-либо классификаторов без какого-то емеля как это можно сделать простым способом например представим что мы ничего не знаем о ранжирование в первом случае и боярской части будет просто оцениваться по позиции то есть какая-то линейная зависимость и как бы чем дальше по позиция тем меньше будет счастье а для монетизации поскольку им важен возраст объявления то мы попробуем сделать такой эвристику с 0 до 100 8 в степени возраст и зависимости от вашего продукта это может быть в часах в днях или вдруг в годах ну все зависит от конкретного случая тем не менее что самое важное для форма участия они должны быть убывающими чтобы чем ниже по позиции или просто по выдаче тем меньше они были 2 более продвинутый вариант мы можем как-то использовать score is ранжирования для бояров например вот нормировать и строить формул таким образом опять же здесь важно напомнить что мы максимизируем интересы каждой стороны всех сразу что все были счастливы теперь вернёмся к вопросу про начальное состояние то в каких пропорциях мы смешиваем 1 идея вот в лоб как это можно решить то мы скажем что монетизация хотим дать какой-то параметр альфа средства все что останется кроме него та единица минус альфа это будет органика и вроде бы как все просто и хорошо давайте попробуем посмотреть вот представим что нас есть такая ручка мы сейчас будем крутить крутим в сторону байеров то есть должно быть больше органики меньше монетизации ну типа 0703 и велим их запрос слову пианино соответственно нас есть пианино разных марок какие-то хорошие платные с раритетными пианино это 50 платных где всякие грузчики и так далее значит очевидно что мы возьмем сначала хорошие платная потом возьмем релевантная и тут мы начинаем замечать что у нас количество релевантных ну становится больше чем количество платных тех которые могут меньше понравится байрам естественно и вот так мы смешали в той пропорции которые мы сказали теперь для понимания процесса попробуем повернуть ручку строгого обратную сторону и сделать абсолютно коммерческую перегруженную рекламы выдачу естественно байрам в данном примере достанется 01 а монетизации 09 в этом случае мы берем опять хорошая плотная по тому же алгоритму но вот на этом понимаем что бояр и уже настолько насколько мы хотели выглядеть вареные и дальше мы должны добавлять платных соответственно дальше мы возьмем одно объявление 150 платных потом еще и поскольку у нас их 50 то все будет перегружена соответственно в таком варианте тоже можно смешивать однако все не так просто когда мы провели тесты на оффлайн приемки такого алгоритма увидели интересную ситуацию вот мы начинаем заполнять нашу выдачу это мультик ровно из предыдущего примера с теми же настройками вот мы заполняем заполняем все вроде пока правильно и по идее дальше должны быть только платной потому что buyers уже л для тв рен и настолько насколько мы хотели и тем не менее мы видим что почему-то добавились хорошее объявление то есть мы хуже контролируем выдачу почему так происходит потому что ошибка в состоянии накапливает свой уравнивается и блендер как бы начинает забывать о том в каком вообще соотношение мы хотели смешать получилась такая некоторая логическая бага нужно было поправить как это сделать значит мы можем ввести такое понятие как протекание то есть мы на каждом шаге когда получаем новое состояние будем к нему примешивать начальное чтобы ну словно блендер не забывал как мы вообще хотим смешивать и тут тоже очень простая формула у нас есть просто новое состояние мы умножаем на единицу минус п вот наш параметр и прибавляем к этому на начальное значит в итоге получается если мы закрутим протекание на максимум все время будет начальное состояние если опустим в ноль будет как на предыдущем мультики в реальности от значения где-то от 01 до 0 3 для нашего продукта теперь вопрос в зал ну как мы знаем на вид очень много разных категорий товаров кто-то продает не знаю мобильный телефон и бытовую электронику кто-то продает машины а кто-то недвижимость а если мы просто возьмем и для всех категорий будем использовать вот такой вот flow формулу с альфа единица минус альфа у нас во всех категориях все будет хорошо какие мысли есть дали нет вот говорят нет совершенно верно и вот там где написано top secret эта диаграмма распределения платных объявлений в разных категориях нельзя подписывать что где-то как мы видим совершенно разное количество и вообще горя методика применения платных тоже разная поэтому просто по такой формуле смешивать нельзя нужно было придумать что-то поинтереснее и очень более подходящее что то что мы сделали мы вели некий коэффициент к который зависит от выдачи и от того сколько всего было найдено то есть он сразу начинает воспринимать широкие узкие запрос и сразу начинает устранить категорию и формулу мы чуть-чуть усложнились это смазка на k + альфа и альфано к + альфа в чем минус все немножко усложнилось но плюс в том что мы можем подстраиваться под конкретные запросы категории еще минус в том что это не число от нуля до единицы поэтому получается что пре-альфа равном нулю у нас будет только органика чтобы было только реклама как в предыдущих примерах нужно этот параметр закрутить как можно больше то есть там 10 15 так далее тем не менее это тоже работает второй вопрос как это выкатить в продакшн да кстати прежде чем greed for production то формула которая была несколько слайдов назад с счастьем с линейной зависимостью использовалась в первых экспериментах и дала действительно результат то есть понятно что не все можно рассказывать но если вы вот примерно так же сделаете у вас тоже получится теперь предположим что вы решили такое построить что нужно чтобы это выкатить в продакшен мы задались целью во-первых воспроизвести эвристику которая была с пиф период с 17 по 18 год через блендер тем чтобы во первых не уронить все наши монетизацию и как раз и отрезать 2 мы должны были доказать возможность контроля платных и по сути провести такой эксперимент вот как я мультики показывал что мы крутим ручку в одну сторону увеличиваем количество платных крутя в другую увеличим количество органики во вторых поскольку количество запросов возрастет потому что мы на каждый запрос был спрашивать идеально выдачу для них а для других то в каком случае будет два запроса в каком-то 3 может вообще проверить что это все не упадет и все будет хорошо и самое важное поскольку это касается монетизацией и денег то мы должны как можно меньше затрагивать реальных пользователей естественно монетизацию во время оба тестов то есть вообще говоря желательно было бы сделать с охоту правильное решение но так не бывает поэтому нужно было что-то придумать чтобы запустить минимума б тестов и при этом уже что-то по хорошие при этом получить что у нас была у нас была хорошая поисковая инфраструктура которая позволяла настраивать сколько угодно алгоритмов ранжирования рядом с продакшен безусловно нас есть продавая инфраструктура и прямо туда можно выбрать какой-то алгоритм просто трафик на него не пускать и вот представим что у нас есть текущий продакшен и наш нами созданный блендер мы его поместили прямо рядом но ничего не происходит пользой пока они идут дальше нужно было написать никакой дополнительной инфраструктуру замотай инфраструктуры качество поиска замутили то flutter которая будет обстреливать и то и другое то есть наш поиск для того чтобы посмотреть как именно каждый вид поиск отвечает нательные запросы поскольку речь идёт о метриках и запросах очевидно что мы собрали какую-то набор тестовых запросов по которому мы хотим это проверять это называется словом пул и об этом дальше еще много будет сказано и очевидно что когда у нас есть пул запросов мым обстреляли наш нашу текущую формулу и вариант с блендером мы должны все эти данные сыр и собрать по ним что-то посчитать после этого принимать решение о том хорошо или плохо и проведя допустим 20 таких операций мы запустим один обед с тем самым у нас есть некоторый процесс приемки всего поиска да оба теста и мы снизим количество проблем с монетизацией во время тестов какие метрики и срезы мы вообще хотим считать при таком обстреле поскольку нас интересуют основу позиции очевидно нас есть срез по странице то есть мы берем то 200 объявлений делим их условно по 50 и считаем что на первой странице у нас только то платных на 2 столько-то и так далее потом поскольку я как я говорил про проблемы с разными категориями то есть есть отдельно недвижимость авто личные вещи есть такой же средства категории где странице нам уже неважно но важно сколько вообще в этой категории платных услуг и поскольку еще нам очень важно свежесть очевидно нас есть средств по дням чтобы посмотреть объявление какой свежести у нас в каком порядке встречаются также есть достаточно большой набор метрик я привел только четыре самые критичные понятные значит очевидно это количество платных просто количество объявлений потому что если выбирать что-то подмешиваем то у нас выдача будет увеличиваться средний возраст объявления потому что как по свежесть нам важно и я говорил про пример заставка еще количество подвешенной доставки тоже измерялось что значит количества тех или иных объявлений если мы просто по всем серпом возьмем среднее то мы получим не совсем то что мы хотим поэтому надо брать в количество с учетом позиции и тут мы как раз вернемся к той самой формуле 098 степени полиция внизу для любителей питона написано как-то реализовать то есть по сути мы считаем не просто среднее количество платных а среднее количество платных которые могли посмотреть и вот письмо это формула используем и внизу написано важный такой момент про здравый смысл представим что у вас сто метрик вы все это крутите смотрите и вроде все хорошо но иногда и чуть позже буквально через три слайда я расскажу историю подробнее в общем если глазами не смотреть то можно пропустить кучу ошибок теперь попробуем представить что мы с вами прямо сейчас обстреливаем блендер и вот у нас слева продакшен справа блендер циферки это странице то есть это количество платных объявлений которые скорее всего увидит человек посмотрев на 1 2 3 4 страницу и вот мы смотрим на первой странице 10 платных на 2 на первой странице с блендером тоже 10 вопрос зал правильно мы настроили наш блендер предположим что остальные метрики нас пока не интересуют уж это просто пример для презентации и там и там вроде одинаково считает что правильно хорошо а если вот так везде сидя здесь 9 ну вы вероятно кажется что неправильно на самом деле все интереснее если мы посмотрим по всем четырем страницам то в первом случае мы перельем платных объявлений а во-вторых во втором случае сделаем ровно так как нужно и это на самом деле позволяет намного точнее настраивать блендер и дальше расскажу как мы все это запускали значит вот тут как раз надо рассказать историю про здравый смысл настраивая один из алгоритмов ранжирования смотрели на метрики все было хорошо и уже были готовы запускать об тест и обычно все-таки надо бы посмотреть глазами открываешь и вдруг видишь на топ-200 в товарах для дома и дачи то есть в самый верх верха категории просто топ-200 вот таких объявлений только раки щебень вот и смотришь и думаешь наверное что то не так взялись за голову стали думать очень нашли проблему пофиксили какой вывод из этого можно сделать во первых мы добавили в нашу утилиту обстрела метрику разнообразия выдача и во-вторых в процессе приемки обязательно нужно делать осмотр выдач сайд бай сайд ведь мы смотрим с одной стороны то что в продакшн а с другой стороны то что мы выдали и обязательно смотрим глазами на сами объявление потому что какие бы классно метрики инфраструктуры не было мы можем попасть в ситуацию когда у нас одни сплошные раки это не очень прикольно и такими темпами мы начали запускать оба тесты эксперименты значит сначала мы собрали пул запросов то есть это набор каких-то тестовых запросов с фильтрами может быть с текстом по репрезентативного потоку что это значит чтобы просто взяли и стали записывать все что сейчас спрашивают алавиты в течение какого-то времени на записали так например 10000 или 50 тысяч запросов по нему настроили наш блендер и попробовали запустить оба тест запустили причем смотрим оффлайна ошибка вроде хорошая там плюс-минус пять процентов и вдруг мы видим что мы перелили на 25 процентов платных думаем что же такое оказывается этот тот самый случай который был на предыдущих слайдах что мы смотрели по первой странице а на самом деле нужно было смотреть по всем потому что так настраивается точнее пофиксили эту проблему попробовали запустить еще один оба тест тот же самый пул ошибка уменьшилась а при этом на b тесте перевели платных на 14 процентов с одной стороны кажется что стало лучше но вообще говоря нас от не устраивал в чем была проблема проблема была в том что это очень большой продукт пользуется им в разных городах в моих больших и маленьких и совершенно по-разному распределена количество платных не только по категориям но и вообще говоря по городам поэтому настраивать нужно более тщательно и мы собрали отдельно полы в разных регионах увеличили репрезентативной пупа репрезентативном у потоку и цели все таким образом из 3 раза нам удалось получить более точный результат то есть мы на самом деле там практически ничего не перелили при этом все результаты that значимые и на самом деле в некоторых категориях у нас могло быть в районе нуля в некоторых там -05 то есть ну в общем это уже попадании в цель какой дополнительный профит мы из этого получили помимо того что мы смогли контролировать платное объявление поскольку у нас теперь есть классный механизм который может в поиск подмешать все что угодно то мы составили такой чек-лист что нужно чтобы запустить какой-то продукт на выдаче то есть по сути мы просто должны придумать как именно мы оценим вот этот intent то счастье пользователя какой-то новый катер ария ну очевидно мы про бросим какие-то необходимые нам флаги параметры в базовый поиск очевидно в мета поиски мы добавим новый сербка смеешь мне вот у нас была картинка была только 2 а теперь допустим будет 3 больше и после этого ну обновляем настройки делаем ту самую приемку по метрикам оба теста и deploy что из этого вышло была проблема что маленьких регионах люди не могли найти запчасти для машин и была такая продуктовая идея что если мы просто в поиск будем подмешивать запчасти то людям маленьких городах будет очень радостно и так и получилось то есть мы получили плюс три процента просмотров выдачах в регионах потому что серпы там просто стали быстрее больше сами выдачи и что здесь изменилась блендер первых вы добавили новую выдачу смешивание во-вторых мы добавили две ручки 1 так называемая сила то есть условно если человек смотрит на выдачу в своем регионе то логично что ему приятнее бы смотреть сначала на объявление своего региона потом уже доставку например из москвы и мы можем этой ручкой вот это положение достаточно крутить соответственно если мы ручку ослабим то как ты сейчас в продакшене получится что объявления с доставкой из регионов будут только только ниже чем объявление из родного города и очевидно вторая ручка это просто количество то есть мы можем подмешивать 30 можем подмешивать 50 а можно подмешивать 100 в итоге пользователю было нанесено добро и этот эксперимент также прошел успешно теперь наверно такой более прагматичный вопрос сколько это стоит в разрезе инфраструктуры циpкa и всего прочего здесь мы видим график запуска никого эксперимента и мы видим ступеньку между старой нагрузкой новый на самом деле цифры спринт такие был там 85 86 миллисекунд стала порядка 106 108 это при том что мы делаем сразу несколько запросов то есть общее нагружаем все сильнее но очевидно late россии это именно метод поиска какой вывод в итоге мы пришли к такому трудов и что контроль платных на выдаче возможность запускать новые продукты улучшить качество поиска нам обойдется в 20 процентов циpкa верхней части поиска ну мы очевидно были согласны на такой трейдов и обменяли значит какие выводы мы можем сделать во первых мы как качество поиска смогли получить независимость от платных и оптимизировать поиск сколько хотим и теперь мы можем запускать всевозможные эксперименты второе поскольку вообще говоря счастье монетизации и пользователь это все равно что сравнивать горячие с красном они вообще из разных размерностей поскольку все мы переводим в поле вероятностей и это synth and of the мы имеем абсолютно четкие физические ручки который имеет физический смысл и таким образом нас не может быть ситуация когда мы что-то покрутили произошло что-то неведомое мы понимаем что мы делаем значит 3 очевидно мы поняли что любая настройкам модели должна не должно прилагаться пул потому что от того какой на каком пули мы настроим наш продукт такой продукт и получится если полу нас смещенный и не правильный продукт тоже получится смещенная неправильно это очень важный момент мне кажется что вот если что-то из этой презентации надо запомнить то это то что вот блендер работает это что пол надо правильно собирать вот значит 4 что даже на простых формул их даже на тех которые были показаны здесь без всякого емеля можно получить ощутимый результат и значительно нанести пользу и пятое что нужно не забывать про здравый смысл и всегда смотреть глазами значит какие выводы по инфраструктуре во первых для того чтобы такую систему построить нам нужно уметь делать параллельные запросы с разным intent ами и быть готовым нагрузить наш базовый поиск сильнее вторых мы должны будем построить какой-то ещё дополнительную инфраструктуру для анализа того что мы делаем то есть как вот тут тот самый флудер написать должны научиться считать метрики возможно кит утилита для сбора плоскость это тоже какие-то дополнительные затраты также поскольку мы будем запускать много разных экспериментов пробовать время что-то выкатывать нужно иметь возможность очень быстро менять алгоритма ранжирования прямо в продакшене иметь возможность в ту же самую инфраструктуру выкатывать новый алгоритм а не опуская на них трафик и что-то экспериментировать короче нам нужна возможность гибко настраивать алгоритмы и скорее всего без вот этой возможности будет очень сложно что-то запускать и очевидно последний вывод что нужно быть готовым платить циpкa конечно можно что все оптимизировать и мы так и делали но каким-то количеством железо и лице пауза платить все равно придется и в итоге профит и которые все это дало компании продукту первых мы открыли себе путь к сильным оптимизация и машинному обучению вторых у нас теперь есть такой большой как этот пульт управления платными объявлениями которые мы отнесли в монетизацию продакт менеджером в третьих мы можем легко на выдаче запускать новые продукты и как следствие сделали подвешивание запчасти с доставкой в регионах и в общем 2018 года блендер в продакшен это была такая очень интересная необычная история вот возможно доклад показался слишком сложным а может быть и нет вот на этом все спасибо большое что послушали я готов на вопрос ответить спасибо за доклад вопрос какие метрики вы используете для вы настроили вашу систему до погоняли посмотрели что реклама у вас нам в итоге на 5 страниц примерно в те же этот пример тоже количество рекламы показали как вы определяете ну какие метрики вы используете при оба тестированию ну очевидно не про всю из этого я могу сказать но такая же метрика просмотра платных истина оба тестах и ну мы тоже можем посмотреть насколько все это изменилось назовем еще есть еще одна метрика которая связана с тем насколько пользователям это нравится я не могу сказать как она определяется но тем не менее тоже можно посмотреть нравится полисом то что происходит или нет с по-хорошему вот эта вторая метрика не должна покраснеть и при этом метрика платных не должна вообще ни в какую сторону идти понятно спасибо за бы вопрос здравствуйте на графике с watenshi который боготоле видно что до релиза и после релиза вот после релиза у вас появились в байки совершенно верно я как раз забыл предсказать видно что график более волосатой вот вы в этом смысле что в принципе стал больше качаться или спайки ну очевидно что это был некий тест и мы просто на той же in free на которые запускали обычный тест попробовали запустить блендером то есть в реальности это назначил от монет посмотрели посчитали сколько нам нужно еще там реплик в купер найти и после этого отмасштабировать система так чтобы никаких спайк of не был то есть это чисто из-за перегрузки и всей системы ну не то чтобы перегрузки но по сути да это честная график ну сейчас он в суровом да сейчас ровный добрый день спасибо за доклад я хочу сказать там в начале восемнадцатого года например lavita вышла статья на хабре что для ранжирования выдачи они используют на всякие многорукий бандиты которые ну скажем так учитывают фичи отдельного пользователя соответственно вопрос ну вот этот алгоритм условно он работает как ну в композиции с кем алгоритмом например либо он работает вообще не зависимо либо не работают как-то параллельно там в в тесте и прочее очень хороший вопрос на самом деле надо разделять которых поиска рекомендации и это две разные задачи алгоритмы работают независимо но идея про многорукий бандитов у нас как бы тоже в планах я понимаю я просто говорю что многорукий бандит фоне и для серпа тоже используют смысле для поиска тоже они просто веками рекомендациях в данном случае в весит алгоритмы использовать исключительно для платных и пока мы смогли выстроить всю эту систему проверить что это работает и запустится и дальнейшая оптимизация возможно мы к этому тоже придём то сейчас они не связан еще маленькие вопросе я правильно понимаю что в своем докладе вы просто не касались ну отдельно ранжирование в рамках отдельно бесплатных объявлений платно ну то есть говорили что не условно ранжируется на основе дать то создания но вы там ни говорили про остальные фичи такие как цена там конверсия шерпа шар осмотр и прочее вы просто не затрагивает разумеется я не затрагивал этот вопрос потому что формула ранжирования мне кажется ни одна компания раскрывать не станет то есть и идея была рассказать именно про смешивание и мы на момент смешивание считаем что мы уже получили выдачу от ранжирования тем или или иным алгоритмом я понял спасибо вот вопрос на спасибо за презентацию клево презентация хотел вот что спросить вот интуитивно кажется что ну то есть будут есть две категории объявлений это те которые продаются за деньги и просто хорошие и кажется что то есть вот метрика которые говорят про то что пользователю стало лучше от выдачи и метрики которые говорят про то что мы не уронили долю объявления с деньгами ну именно не уронили в том смысле что пользователь продолжает покупать объявления они немножко разные то есть последнее это такие long-term то есть реакция отложенная у человека 1 вроде как мы сразу мы можем и видим реакцию стало хуже вот у вас то есть правда ли вы что такое заметили если заметили то чего с этим делали и так далее опять же не все здесь могу рассказать но я могу сказать следующее что у нас в определенном объеме покрыта метриками как бы сам production мы можем смотреть такие пунктиром изменения вот уже по мере запуска у нас есть оффлайн приемка до всяких оба тестов есть сами apts ты в каких-то случаях может быть мы сделаем bts по длине и в каких как в каком-то если мы видим что явных проблем нет наверное мы можем раз катить и максимально быстро среагировать на какие-то вон фирмы а вот вообще этот эффект замещали ну то есть или и вот отложен оси отложено сть эффекта им наденешь но денежного или нет скорее нет добрый день извините спасибо за доклад первое что меня заинтересовало это почему вы считаете что вероятность того что человек уйдет со страницы выдачи не зависит от количества объявлений которые он посмотрел совершенным может быть вы не так поняли как раз она зависит и если мы посмотрим формулу плуг то она ровно от него зависит сейчас я прокручу всю презентацию и я понял что именно в чем вопрос значит у нас формула 2 сверху плуг она зависит от вероятности посмотреть на предыдущие вероятности того что мы не удовлетворены просмотренным вероятность того что еще оно не ушло что человек не ушел но когда для примера для иллюстрации я приводил формулу 028 степени позиции есть действительно не зависит просто для того чтобы на графике показать как это выглядит да да на давайте вернемся вот на слайд назад вот у вас везде стоят индексы up a break не зависит от яндекса то есть вы считаете что если пользователь дошел до 100 объявления вероятность его уйти от такая же как если он посмотрел 200 объявлений ну кстати скорее всего вы правы нужно посмотреть в спецификацию от яндекса возможно там стоит индекс класс хорошо спасибо и второй вопрос во всем все ваши истории мне показалось очень любопытно место когда вы выяснили что в разных регионах по-разному распределены что то да и вот мне просто очень важно и мне хочется узнать как вы поняли что надо смотреть именно на регионы как вы выявили этот критерий потому что и же там очень много у вас да безусловно но представим такую ситуацию что мы у нас есть некий промежуточный сервер но за него бета на котором мы можем ну глазами посмотреть что происходит и вот у нас есть уже как кандидат для того чтобы разложить но пока еще мы катим в bts и открываем бету смотрим глазами и вот предположим мы смотрим по умолчанию там по всей россии или по москве и все очень прилично а потом открываем маленький город и вдруг мы можем увидеть что что-то перегружена или наоборот недостаточно платных и в этой ситуации но соответственно мы увидели что для регионов нужно смотреть отдельные внимательнее давайте я задам вопрос по точнее а почему вообще поняли что регион это крайне важный для вас критерий ведь они могут быть какой-то другой критерий не обязательно географическая совершенно верно но во первых когда мы условно что-то предпринимаем любой формула ранжирования мы смотрим на то как продукт будет видеть люди в разных регионах но не только в больших городах вот и соответственно увидев это мы так решили хорошо спасибо большое спасибо все тогда"
}