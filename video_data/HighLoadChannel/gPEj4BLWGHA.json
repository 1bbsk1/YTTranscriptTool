{
  "video_id": "gPEj4BLWGHA",
  "channel": "HighLoadChannel",
  "title": "Контейнеры мертвы. Да здравствуют виртуальные машины! / Виктор Попов (НЛМК)",
  "views": 8841,
  "duration": 2717,
  "published": "2023-04-28T06:11:31-07:00",
  "text": "Привет слышно меня нормально всё Ура это штука работает поправлюсь Я люблю новые добрые виртуальные машины они старые добрые так есть кликер Давайте с вами начнем Посмотрите кто Я вообще такой чтобы что-то вам рассказывать Меня Виктор Попов зовут работаю в НЛМК новолипецке металлургический комбинат дивопс инженер в команде централизованной платформы мы делаем там портал платформу сервисы предоставляем в общем классненькие все занимаюсь коммуникациями между DF и опсом рассказываю людям чем мы занимаемся Чем они занимаются всякие там комьюнити внутренние строя Ну в общем вот такая вот дивопс штука так и Пару слов про компанию собственно Пару слов про компанию мы вопреки того что металлургические комбинат во-первых Мы большие у нас там европейские офисы металлургические полный цикл вообще прямо в космос куча eml куча it там под 2.000 сотрудников своя разработка То есть если вы думали что на заводе по-прежнему станки работают там и люди в касках то не только еще и эти тоже есть но у нас есть интересная работа Добро пожаловать на борт при случае ну и хочу отдельно сказать спасибо там ребятам из нашей команды потому что пока они работают я здесь вот этой ерундой занимаюсь на самом деле Давайте пойдем ближе к сути собственно Что такое вообще контейнер Давайте немножко интерактивщика Кто считает что он прям хорошо знает что такое контейнеры Я надеялся на большее количество рук О'кей губернатизскому что-нибудь Говорит нормально а как эти два факта у вас в голове сочетается интересно а-а и собственно Кто считает что губернете сможет управлять виртуальными машинами вместо контейнеров смотрите вы на нормальные доклады еще успеваете вам не интересно будет скорее всего ну или нет поехали да кратенький экскурс Для тех кто не поднял руки прям бегала Что такое контейнер вообще это процесс там есть какие-то слова типа группы name Space и cobility что-то там происходит с этими процессами у нас краткости группы штука которая ну это механизм ядралинус они штука вообще-то он ограничивает процессы по потреблению ресурсов там есть память цпу диск сеть и о и прочее всякая магия там много на самом деле с игрушек Ну и собственно Вот именно вот вот в этом вся контейнерализации кроется что мы берём процессы изолируем его всеми этими механизмами есть штука на импс это абстракция над ресурсами операционной системы Ну то есть у нас процессы которые находятся в одном спейсе они соответствующие ресурсы сидели Да чтоб у нас всего семь штук Ну и например э-э процессы которые находятся в одном Пит на имейспейсе Они видят одинаковые номера процессов до внутри себя Вот соответственно именно благодаря там питным спейс у нас получается что в докере есть первый процесс Ну в контейнере и на хостовой системе есть первый процесс и никаких противоречий это не вызывает всем классно к побилитисят разрешения процесса на выполнение определенных системных вызовов их там штук 40 на самом деле Ну и вот например captchall это как бы право процесса менять уиты гуиту какого-то файла если Поделитесь нет то соответственно делать так нельзя Ну вот коптила Аналогично отправлять Kill сигнал на bin сервис - это право бендицина порты меньше 1024 номера потому что они типа сервисные зарезервированы и кому попало нельзя Ну в общем их там дофига и они ограничивают ваш процесс чтобы он всякую дичь не творил и другое Куда без него что вообще происходит когда Мы выполняем вот допустим здесь докер докер вообще давно все похоронили он старый прям совсем ну короче внизу просто для примера У нас есть докер клиент вы в нем набираете вот эту командочку докер клиент идет в докер демон докер демон идет в контейнер D контейнер D это высокоуровневый runtime эта штука которая ну как бы отвечает запуск контейнера уже непосредственно того самого процесса и собственно он отвечает там зайкал за то чтобы вот и мыши с которого вы запускаетесь у вас вообще был потом он распаковывает это всё Иран таймбал потому что то что вы скачали с докер хаба докерпулом Это не то что вам надо чтобы запустить контейнер на самом деле там несколько слоёв Вот и потом Он передаёт это всё ниже и ниже запускается такая штука Как контейнер для ШИМ Что такое Шима чуть позже расскажу кратко это такой легковесный демон который Ну непосредственно следит за вашим контейнером и процессом а контейнер для ШИМ запускает уже ран си Россия это привожу Ника которая использует lip контейнер для того чтобы вот запустить процесс навесить на не нужно создать себе группу запустить в ней процесс навесить на нее определенные копобелить из в определенном спейсе чтобы все было изолировано ну и соответственно потом у вас контейнер для ШИМ остаётся следить за процессом контейнера и собственно ваш enging запустился Всё очень классно Ну собственно рамси - это низкоуровневая runtime и эта штука которая непосредственно отвечает запуск Ну того что мы считаем контейнером вот что ещё ну я как бы говорил что это да ШИМ - это как раз вот легковесная демон он контролирует процесс контейнера Ну там родительский А все коммуникации между контейнером и его менеджером Ну в нашем случае там этот докер допустим проходят Ну непосредственно через ШИМ транслирует и стадии Да вот ну и СДР тоже конечно же контейнеры там вверх и собственно там не знаю Это позволяет подключиться к контейнеру Если вы делаете докер exec то у вас поднимается еще один ШИМ рядом И в нем Вот ваша терминал сессия пробрасывается в контейнеры и собственно это так работает Ну и экзиткоды отслеживать таким образом если в контейнер внутри скончался то ШИМ там может вверх ранта ему отдать что у вас все с контейнером плохо там по рестартить его допустим какую-то логику сделать как-то так Что такое лося и вообще да я говорю какая-то аббревиатура странная это Open контейнер шейки это проект стандарта хранение и запуска контейнеров под крылом как вообще ну там у нас контейнером много лет совсем но потом появился докер который стал стандартом потом докер монолиты развалился на куски там появился как раз вот этот контейнер drancy сам докер демон и где-то там же сформировалась штука которая говорит что А давайте мы вот эти вот компоненты стандартизируем и сделаем так чтобы ну как-то кто-нибудь мог пользоваться кроме Докера Ну и собственно там есть две две инициативы две спецификации точнее это runtime это то как мы запускаем контейнер то есть вот это вот Магия что мы берём процесс боксе сверху группы там побилитиз вот это всё про runtime там это описано Какие вызовы Там прям Ну типа есть там не знаю о себе Старт условно команды и там прямо написано что должен уметь runtime чтобы вот соответствовать этой магией Ну и есть Тима специфично история про то как мы эти контейнеры храним То есть у нас вот есть контейнер на докер хабия мы его в там осиаи мышь потом можем распаковать потом это То есть а и мы же распаковываем в Оси бандоу внутри бандура лежит допустим Корневая файловая система вашего контейнера там лежит классный Файлик конфиг Джейсон в котором такая Огромная портянка в которой Ну на самом деле описано Что происходит в контейнере Там какие-то побилити сдать какой процесс запустить там что-то ещё вот э Ну и собственно всё это стандартизировано да ну зачем нам это вообще ценное знание мы узнаем чуть позже что там по виртуальным машинам а-а потому что про контейнер про контейнеры пока не хороним ну короче мы посмотрели вот на вот это всё поняли что контейнеры - это сложно а переехали на КВН антибум диплом отказались от губернатиса доклад окончен Спасибо за внимание а нет Ах если бы есть такая прикольная штука Как кота контейнер в общем ребята подумали что контейнеры вот изоляция которую я описал она на самом деле мы дальше посмотрим но она такая довольно условная местами У нас есть очень много способов одного из одного контейнера как-то навредить другому хостовой системе ещё чему-то есть способы всё предотвращать но всё больно и мучительно и в общем ребята из Kata контейнер с э-э Да Лазер Лазер не видно конечно же на экране сделали следующее Они сказали что отдавайте Мы подумаем как бы это всё немножко делать по-другому и по секьюрнее и они пришли к прикольной идее что мы можем каждый контейнер Ну пот на самом деле вот можем несколько контейнер запускать в виртуальной машине то есть мы буквально поднимаем вертовочку а в ней поднимаем Ну вот всё то что я описывал буквально то есть ну без рамси но просто тот же самый лип-контейнер поднимает наш процесс также его обтягивает и все это внутри виртуалки и каждая виртуалка собственно такая отдельная управляемая и в целом идея это не Нова Ну что мешало так делать Раньше мешало то что теперь это все осяй совместимо это прям очень важный тезис соответственно оно соответствует вот этой спецификации хранения контейнеров То есть вы можете контейнер с докер хаба просто взять и запустить в Кате вообще ничего не переделывая ну и собственно runtime speco оно тоже соответствует поэтому как бы понятно как это всё запускать этим всем занимаются довольно солидные ребята там есть вот хайперы Саша это какое-то облако там из интела кто-то это всё инициировал когда-то ребята из openstek Foundation следят чтобы это было по-прежнему классно и великолепно То есть это не часть openstack Но они там где-то рядом вот пользователи у этой штуки довольно много интересных там Alibaba э-э ещё кто-то Huawei в общем Ну довольно большая AMD довольно большой список довольно уважаемых людей у них есть Прямо список вейпейперов типа мы любим карта контейнерс в общем как будто бы это довольно зрелое уже технология на самом деле вот здесь вот да видно что у нас есть гипервизор какой-то какой гипервизор вообще Давайте посмотрим гиповизор У нас есть на выбор мы можем использовать разные телевизоры естественно Мы берем Ну там не дефолтный Q потому что это медленно там не хайперы Ой не хайперы Конечно же да у нас есть сейчас в поддержке 4 гипервизора на самом деле 5 про это позже первый от CRM Я честно говоря о нем узнал когда только доклад готовил Я не знаю как это правильно произносится это штука для МВД и от систем это такой супер лёгкий гипервизор для того чтобы у вас там не знаю смарт-часах что-то запускать Наверное он про Крис про очень критичные нагрузки к безопасности Он про Real Time во многом и он типа супер быстрый у него очень маленький оверхает по памяти но соответственно Он супер обрезанный и такая прям штука для тех кто понимает что он делает есть клаудский телевизор тоже Ну достаточно известная штука он мало что умеет относительно Здесь всё в сравнении друг с дружкой конечно же он довольно быстрый молодец и в целом Ну как бы в облаках вот им пользуется есть Far Cracker эта штука которую изобрёл Amazon кажется изначально Под свою лямбду То есть это микро-вирталки amazon-овские ну вот для того чтобы в них крутить изолированные какие-то сервисы Он супер минималистичный он как гипервизор не умеет практически ничего и слава Богу например он не умеет в динамическое изменение размеров э памяти и проца Ну что умеют современные Телевизоры можно просто виртуалки на горячую докинуть памяти Far Cracker этого делать нельзя Ну и не надо как будто бы ну и вот сфера применения Да это сервер или там фаз и собственно Q старый добрый quemo Прошу прощения он относительно много чего умеет но у него собственно в сравнении там перформансы Memory dancity Good any Excellent и в целом это выбор по умолчанию именно в Kata контейнер Ну и что же там вообще завернул как бы заверток это поднимается там есть специально подготовленный образ который тоже очень минималистичный он на основе Clear Linux а внутри тупо систем D который стартует коттеджмент мы посмотрим позже что это такое и всё прямо прямо всё очень маленькое Ну и Кема мы здесь тоже как я сказал очень сильно выпиленный А по содержимым собственно мы посмотрели что происходит когда мы делаем доки ран Ну в классическом докере Давайте посмотрим что происходит когда мы это делаем в Kata контейнер у нас здесь допустим есть губернатор для примера у нас есть вот каташин э-э здесь может быть между губернатисом и каташим даже не может быть а скорее всего какой-то высокоуровневый Run Ну типа контейнер D на самом деле либо крио может быть Вот и собственно что происходит Мы говорим создай нам пот пожалуйста cubernet из дорогой он идет там в контейнер D контейнеры D идет в капошин котошим идет в вирту машин менеджер говорит Подними мне эту виртуалочку пожалуйста вертовочка поднимается в ней стартует Агент Агент слушает высок сокет собственно каташин цепляется к этому Агенту и говорит а теперь Подними мне просто обычный контейнер методом либо Ну вот либо контейнер библиотекой фактически Ну в случае с кубером соответственно Там сначала стартует вот этот паузу с контейнер он создаётся инкбокс потом в этом сандбоксе в ходе создаются уже какие-то рабочие нагрузки Ну и собственно он за всем этим следит там вот grpc используется вот высок используется если у вас 4 18 ядро и модуль соответствующие есть Если нет то это имитация серийного порта используется она медленнее хуже Но вот типа тоже работает Если вы стартуете соответственно не знаю какой-то ну там консоль который подключается к этому контейнер у вас поднимается соответственно еще один ШИМ проваливается В контейнер все это работает Ну Вот такая вот довольно простая картинка еще есть непростая картинка её нифига не видно но так и задумано мы по ней сильно не будем проходиться допустим просто в документации есть крутейшая схема в которой прямо на уровне вызовов на уровне вот там Все хронтаймов расписано что вообще происходит Какие технологии используются э и так далее для сети для всего прочего Но это такая просто хвастаюсь то есть больше для самостоятельного изучения можно её 40 минут обсуждать а там вот был ШИМ V2 где-то в каком-то моменте соответственно наверное ищем V1 что это вообще такое Почему Ну и собственно кота есть v1v2 в какой-то момент ну как бы в Оси Ну там совместно с ребятами скаты поняли что вот традиционный вот это вот Айран таймспек он не очень подходит для вот этой всей магии с виртуальными машинами там очень много оверхеда получается такого довольно странного Ну как бы не изящно скажем так всё это работает и появился ШИМ V2 который Ну просто причесали шин перевели в порядок и в целом шин V2 это ну актуальная версия на нём там по умолчанию работает контейнер D даже если вы используете рамси там крио тоже то есть ну в общем золотая классика шин V1 - это как будто бы легасе сейчас но допустим вот докер до сих пор не мигрировал на шин V1 причём соответственно э первая версия карты работает на первом фильме вторая версия карты работает на втором шиме и например вторая версия поэтому сейчас не дружат с докером То есть если вы хотите самую простую песочницу поднять у себя локально то вам нужна Ну старая версия карты чтобы подключить это под докер все дело Вот и собственно У нас тут буквально на днях релизнулась третья версия карты в варианте релиз кандидат и еще вообще интересного Ну шиндом второй остался шин не менялся третья версия каты говорит что давайте мы ещё и гипервизор Ну во-первых всё переписали Насте э-э потому что это это мем И куда же безраста а-а соответственно во-вторых там используется в качестве virtum машин менеджера такая штука Как Dragon Ball Я честно говоря про него тоже мало что знаю я знаю что он тоже на Расте и его прикол в том что он интегрирован вот в шин фактически То есть раньше как бы было у вас шин вызывал отдельное э-э вирту машин-менеджер это интерпрета с коммунитейшен это как бы относительно долго а здесь мы вот эту часть затащили прямо в шин и она получается процесс внутри себя создает виртуальную машину стало быстрее сексуалов и как будто бы это важное изменение но пока пока релиз кандидатом вот да ну и здесь вот собственно сравнение Katy в первом шиме и во втором То есть у нас в первом шиме был такой компонент как катапрокси который там какую-то странную сетевой проброс имитировал у нас поднимался сначала контейнер дэшный шин потом из него катовский ШИМ их надо было минимум два штуки а на самом деле их надо было там 2n + 1 вот а во втором шиме просто у нас напрямую Ну вот контейнер для ШИМ катовский вызывается из контейнер Да и собственно он напрямую вот через э-э высок умеет ходить в Агент стало сильно проще за счёт этого банально вверх это уменьшился потому что у нас вот этих контролирующих процессов стало меньше Тут мегабайт памяти там мегабайт памяти плотность увеличили классно Зачем вообще все это да естественно что там напридумывали честно изоляция Ну то есть это первоочередная фича все это исключительно ради секьюри типа большому счету то есть у нас изоляция уровня VM там вот всякие механизмы ципуринг применяются Но вот вообще в другом месте всё работает Ну и пара таких примеров более насущных айноды кому о чём-нибудь говорят вот смотрите у вас Ну можно этого избежать Но скажем так в среднем по больнице губернатором кластере что происходит Я поднимаю свой контейнер и в нём фигачу себе под ноги бесконечное количество файлов по ноль байт Ну просто много у меня кончается айды Поздравляю не один контейнер больше который использует эту же файловую систему не создаст ни один файл ещё изоляция пацаны классно работает вот дальше есть более прикольные штуки У нас есть допустим энтропия которая вообще-то конечный ресурс она там как-то накапливается Да Таким образом мы внутри контейнера фигачим в диафрам дом очень много у вас кончается энтропия и у нас вот эти вот Рандом который генерируют другие контейнер он становится сильно менее рандомным это такой очень узкий кейс но в целом то есть вот внезапно это тоже расходуемый ресурс который у нас шарятся ну потому что у нас шарится всё что использует ядро ядро у нас общее оставалось В контейнере вот ну и более такие прагматичные штуки смотрите у нас есть там куча уязвимости Linux гидра Linux вот у нас список за семнадцатого года Ну не знаю в прошлом году 38 ой 202 уязвимости в этом году уже найдено в ядре 161 в прошлом из них вот не знаю 11 это код excution соответственно Когда у вас в контейнере есть уязвимость которая позволяет ремонт execution какое-то сделать это эффективно код execution на ноги то есть Ну в любом другом соседнем контейнере то есть Поздравляю всё очень плохо Kata контейнер с эту проблему решает тем что когда у вас происходит ремонт Cold execution он происходит внутри виртуальной машины А задача выбраться из виртуальной машины Ну после того как ты нашел уязвимость ядра еще до кучи Да напомним она Ну так чуть-чуть посложнее как будто бы как минимум это ещё одна задача и в целом поэтому Ну вот у нас есть вот такой слайдик да то есть вот для примера количество уязвимости в кюэму то есть понятно что это так и средняя по больнице там надо смотреть скорые лёгкость воспроизводства и прочее но в целом просто как будто бы их чуточку меньше и снизу количество уязвимости именно по катарантайму их там вообще какой-то штучное количество с другой стороны Ну вот из них половина - это Код экшено как раз я видел довольно прикольный доклад про то как в 2020 году на какого-то Black какого-то цвета конь шляпа Конфи ломали собственноту и там был очень важный Point про то что смотрите точка а точка как бы атаки смеща на поиск именно нативных уязвимостей там ну катарантаема то есть никто не говорит что это решение идеально Понятно везде есть какие-то проблемы уязвимости Но вот как бы классические вот эти штуки что вот мы нашли дырку в ядре линуксе ее фигачим Она уже не работает надо искать специализированную уязвимость именно вот под Вот эту вот всю абстракцию что довольно прикольно На мой взгляд еще есть вот такая вот прикольная возможность так как мы запускаем каждый контейнер В отдельной виртуальной машине можем запускать его в разные виртуальной машине например ну там мечта безопасности мы используем строго те модули ядра которые нужны вашему приложению ни больше ни меньше вот у нас три виртуалочки разные версии ядра потому что у вас сатаны А вот в левом контейнере мы еще и ГПУ модуль подключили а в остальных не подключили потому что Ну вдруг он уязвимый А нам больше нигде не надо а вот здесь вот только мы его используем Ну и ГПУ ещё и пробросили туда напрямую в контейнер вот такие вот чудные штуки можно творить а естественно если бы все было совершенно классно и здорово то контейнеры Мы бы уже похоронили совсем Но конечно есть некоторое количество но есть такая архитектурные ограничения они довольно как специфичные во-первых нельзя проходит пробросить Host Network Ну знаете вот это вот доки ран минус networkhost Поздравляю все удобно не работает вообще просто на базе архитектуры так сделать нельзя никак и не будет не то чтобы это супер важно но я не знаю какие-нибудь любимый плагин в кубе ли вы в Кате не запустите в принципе Никогда потому что ему нужен networkhost Ну либо не чего-нибудь изобретут другое вторая история привели Джет контейнеры работают по-другому прям заметно Они получают привели Джет они вот но только внутри виртуальной машины соответственно запуская контейнер как обычно с ключом привиледжет вы не получаете доступ ко всем хастовым устройствам Как вы привыкли если вы крутите какой-нибудь со вкупере допустим да то вот мы запустили мы получили доступ к дискам Поздравляю Вы великолепны Но это именно ограничение такое умеренное потому что проброс устройств есть он настраивается он настраивается гранулировано можно пробрасывать в конкретные контейнеры конкретные устройства Но это точка менеджмента как бы дополнительно Ну Безопасность это всегда сложно простите И последнее управление ресурсами отличается оно работает прям сильно сложнее сильно по-другому но с другой стороны я тут Конфи рассказывал про кого-то в кубе не то чтобы там это очень просто честно говоря выглядит просто как только чуть-чуть Копаешь кровь кишки шпионка собственно если не указать квоты контейнер то он запустится в виртуалке с ресурсами по умолчанию ресурса по умолчанию Это один вспу и два два ядра памяти понятно что это всё там переписывается и прочее но в целом у вас вот контейнер в эти ресурсы упрётся если не указать никакие квоты если указать кого-то что произойдёт Ну логичное предположение что виртуалка запустится с квотами которые вы указали на под нет виртуалка запустится вот с этими дефолтными ресурсами которым То есть она стартанёт с ними в ней стартанёт Агент потом там запустится ну либо контейнером ваш контейнер и к виртуалке сверху Накинут то количество ресурсов которые выдали это тоже важно понимать таким образом если у вас дефолты какие-нибудь космические то вы будете хоронить довольно много ресурсов и в целом вот как бы главная проблема На мой взгляд карты в том что это много менеджмента ресурсов которые Довольно простой про который надо думать ой довольно сложный и про который надо думать ну такая цена у этой все штуки что поделать там есть допустим ограничения с со сторожем некоторые например Ката сейчас не умеет в ресайз дисков в принципе то есть если вы даже монтируете через сайт драйвер диск И вы его ресайзите то у вас вот за счёт того что там в абстракции гипервизора Он увидит размер диска изменённый только после рестарта контейнера Ну такие вот всякие штуки есть но пожалуй вот это вот прям самые ключевые понятно что есть всякие мелочи Ну и вот у меня есть такой дурацкий слайд я взял на нашем довольно старом кубировом кластеере и просто поменял дефолтран-тайм прямо на Живую у нас ещё докер там э джокеру поменял урон тайм по умолчанию именно на капу стартанул стартанули системные компоненты и мы видим что стартануло типа три контейнера из всего этого да потому что это какой-то тестовый инженкс промтэо которому ничего не надо и кто третий и какой-то ранчовый логинг все остальное системное контейнеры которым нужны либо привилегии либо Host Network ничего не стартануло то есть как бы для инфровых компонентов того же кластера эта штука пока подходит очень умеренно с другой стороны как будто бы люди которые запускают инфровые компоненты мы им доверяем чаще всего и тому что они запускают Ну условно тоже доверяем Да здесь история больше про то что у нас есть какой-то мультитенанси в котором у вас запускают вообще непонятно что но а это понятно что вот такое разделение а про поддержку в кубе ре еще немножко хочется поговорить как это все вообще Со стороны кубера выглядит у нас есть такая прикольная сущность как рантайм класс появилась Она довольно давно и в целом мы просто конфигурируем тайм-класс а потом говорим поду используя runtime Класс вот такой-то и все и вы запускаете часть контейнеров в Кате часть контейнеров в рамси по умолчанию в России допустим с аннотацией соответствующей в Кате Причем так как это все лося и компания был как я и говорил в целом Вы можете для системных компонентов допустим оставить рамси а для всех пользовательских компонентов перевести все на карту и Ну так с натяжечкой немножко ваши пользователи ничего не заметят просто их контейнеры будут запускаться Ну именно в Кате более того условно у вас на одной ноге они в Кате запускается Ну это дурацкое решение не делайте Так а на другой в России и всё это вот совершенно спокойно мирно сосуществует просто вызов идёт в разные с 1.14 в бете с 1.26 был что как бы ну немножко доказывает взрослость там да подобных решений и у нас появилась такая штука Как потолверхэд это специальная аннотация я чуть позже расскажу где она нужна но в целом Она позволяет некоторые фиксированные значения выдать в вашем контейнерам именно на оверхед вот виртуализации чтобы правильно правильно шадулил и понимал утилизацию ресурсов эта штука stables 1,24 в бете с 1.18 Ну тоже как бы сейчас 1,25 то есть уже не первую версию чего с производительностью то в этой штуки Да насколько все этим пользоваться-то можно нормально но по-разному время запуска собственно смотрите это бенчмарки картинки не мои но я их перепроверял Вот и у меня получились на моих стендах значения Ну похоже на все что я сейчас буду рассказывать про производительности там плюс-минус в целом вот катана кюэму стартует примерно 1.5 секунды э-э до кировый контейнер стартует примерно 0,8 секунды Но на самом деле вот допустим в контейнер Дэв чистом у меня контейнер стартовал за пол секунды в среднем на самом деле то есть да дольше но как будто бы вот в этапе шедоулинга губернатиса плюс секунду на запуск контейнера это ерунда по большому счёту не самая большая проблема голый кюэму для примера стартует виртуалку 8 секунд вот без вот этих всех допиливания и выпиливание но это уже как будто бы неприемлемо много а следующий слайдик производительность CPU У нас все нормально Ну разница на уровне какой-то статистической погрешности что на голом Хосте что в Кате Все работает примерно одинаково и здесь появляется такая штука как бы визар еще в описании В общем Ревизор это еще один подход к безопасности контейнеров который говорит нам что А давайте мы все системные вызовы от контейнера к ядру будем через специальную про Ксю делать которая это всё э проверяет за нас Можно ли нельзя вот на мой взгляд скорее жив чем мёртв сейчас мы дальше увидим почему но вроде как проект развивается что-то происходит про живых людей которые пользуются гильзором Я не слышал по памяти по памяти Ну сопоставимо где-то 10 процентов теряем на память но как будто бы не драматически Да все работает все равно у нас есть какая-то абстракция Ну вот она немножко отжирает вас ресурсов по сети по сети тоже вот у нас десятка на ней примерно та же перформанс та же производительность и здесь мы видим собственный Визор который примерно вообще никак не работает по сети потому что вот все системные вызовы к сети которые у нас идут в устройства мы идём через какую-то свой абстракции всё очень плохо очень медленно может быть что-то изменилось с того момента Ну вот вот примерно такая история по сторожу по сторожу картинок красивых не будет потому что сторож это типа сложно разные кейсы разные профили нагрузки прям магия в целом просто немножко расскажу Вообще как сторож работает кота использует verty ufs в современных версиях То есть это ну виртуальная система там монтирование она использует его для того чтобы там эфемерку свою отремонтировать Хоста но в целом как бы проброс на самом деле файловой системы Виртуал тоже такая тема болезненная и вертел FS работает ну типа не супер быстро с другой стороны до этого был вертило 9п такой протокол То есть 9п - это протокол сетевого файлового чего-то там вот коллега фейс э-э То есть это было прямо медленно с вертилус стало лучше э с другой стороны допустим есть магия которая говорит что у нас есть проброс блочников Прямо напрямую виртуалку и он работает уже ну сопоставимо с хвостом потому что ну очень крутого пробросили Всё нормально никаких абстракций всё классно с третьей стороны сейчас в работе такая такой механизм как runtime Assistant mounce то есть смотрите у нас Какой пример у нас есть допустим цефовый булочник где-то там И сейчас мы его когда через сайт Driver в кубе ремонтируем мы его совершает драйвером монтируем на ноду Ну именно булочным протоколом а потом мы его через virtill FS монтируем виртуалку Ну то есть лишний слой Почему сразу нельзя монтировать его виртуалку именно как бычник потому что сейчас Side драйверы Ну так не умеют и надо вот чтобы цеса и подружились с рантаймом чтобы была вот эта обратная связь про то что CSI фактически управляет некоторые магией внутри виртуальной машины внутри контейнера чтобы он умел общаться с контейнером работает идут пропасал висит э-э Я надеюсь что примут примут станет лучше в остальном Короче если хотите пользоваться на диск Heavy приложение лучше понять и Понять насколько это вам подходит немножко про практически приложение взяли Engine с запостили на нем какую-то статику апач-бенчан жахнули посмотрели что получилось вязали все довольно плохо в катаранси разницы примерно нет runcy как будто бы даже выиграл но я думаю что это ошибка просто там округление статистики и прочего а-а а вот с Radisson всё не так гладко Да по радиусу видим заметное падение производительности но опять же с гвизором всё ещё хуже Поэтому Ну подходит не для всех нагрузок сорян есть ограничения Ну и самое больной наверное слайд это Memory foodprint у нас довольно много памяти и уходит на то чтобы вот эту вот виртуальную машину запустить в ней там керного какой-то поднимается он что-то весьма свертовал машин менеджер есть он тоже какую-то память вот памяти надо дофига грустно печально надеемся что это изменится в среднем Ката жрет примерно 150 мегабайт но по моим тестам даже под 200 получалось на самом деле на каждый контейнер чистого оверхеда просто вот на то чтобы это всё работало но при этом вот кюэму просто на запуск там аналогичного контейнера запускает тратит больше памяти а-а и для сравнения тот же докер который Ну на уровне статистической погрешности потому что в докере Ну просто нечему Жрать есть контейнер для шин который ничего не весит есть докер демон который Один на всех Вот соответственно по Memory Food принту есть еще один неприятный эффект который заключается в том что у нас эта штука про нее кубер не знает то есть смотрите у нас есть не знаю 10 гигов памяти на ноги мы запускаем 5 контейнеров каждому из которых даем лимитрий квест 2 гига Ну все складно получается математика сходится Что дуллер работает отлично А дальше у нас на каждый контейнер ещё оверхед 200 м и получается что у нас на самом деле Ну условно в Пике на Всё может быть утилизировано там 10 11 гигов памяти а их по факту 10 и можно ловить очень Рандомные омы на выходе А чтобы этого ну не было так больно появилось вот та сущность Как под оверхед как раз то есть мы можем для контейнера указать вот этот вот оверхед статистический ну как-то его там проверив предварительно либо с запасом его выставив чтобы шудуллер понимал что у нас какая-то часть ресурсов на самом деле занята и не шатурил туда реальные контейнеры и вот эту ситуацию оно упрощает то есть эта штука появилась Ну вот там stable прям недавно летом а до этого это было прям большая проблема потому что менеджер вот эти вот ресурсы которые непонятно как и непонятно где довольно сложно Ну и главное главное что это очень непредсказуемая история Что с этим делать-то вообще да как каким выводом мы пришли здесь немножко поправлюсь что я на самом деле большая часть материала готовил на предыдущем месте работы Я тут недавно поменял её и поэтому выводы больше применительные там к другому месту но это не суть эта штука идеально для недоверенных контров То есть если у вас какой-то мультитенант где Вы прям не доверяете людям то запускать их нагрузки в Кате Хорошая идея потому что шансов что они вам что-то там сломают сильно меньше прямо сильно-сильно вторая история что мы хотели внедрить Кату в дмз как пользовательский runtime по умолчанию потому что в дмз Мы боимся мы боимся сердцеех у нас там что-то опубликовано вольно-робили эти менеджмент не на самом высоком уровне поэтому то есть не знаю мы идея того что rc-ехе вы попадают в виртуалку они на хост у меня в душе вызывает просто какой-то Восторг Честно говоря у безопасников когда я с ними говорю тоже поэтому Ну вот идея для дмз На мой взгляд Прямо супер реалистичная потому что там не часто бывают какие-то Ну вот условно редисменты обязательно редко кто-то ставит engines как мы видим работает нормально Ну очень грубый пример вот поэтому сходите к безопасникам Поговорите Проведите исследование может даже денег дадут на это дело мало ли кому-то когда-то разве безопасники давали деньги Так на самом деле все Краткость сестра смотрите здесь моя фотография Если вы забыли как я выгляжу здесь qr-код по которому можно оценить доклад вот там понравилось не понравилось комментарии Буду очень признателен и здесь есть моя тележка Можно мне что-нибудь написать спросить там называть какие-нибудь Вопросы Спасибо коллеги за внимание Виктор спасибо за доклад рассказал для меня лично странную магию Я даже знаю где её проверю тебе приз от организаторов Мы ждем вопрос у нас прям лес рук и мы наверное напомним за лучший вопрос будет приз от спикера Спасибо за доклад Можно ли узнать как это все работает смешно смотрите а на самом деле какая разница Ну у вас есть какие-то абстракты у вас на уровне виртуалки поднимается виртуальный интерфейс который там куда-то брижуется в конечном счете ему какая разница будет он там ваш мир переживаться работает в общем Единственное что ну как я сказал ограничение что там какие-нибудь короче компоненты Миша не заработают в Катя с высокой вероятностью самого хорошо спасибо а Спасибо за вопрос Мы ждем следующий Спасибо огромное за доклад У меня вопрос по поводу Memory Print А и функция сервис у нас получается 200 метров javascriptury строчку 300 байт Ну то есть для одной функции нам будет 200 мегабайт оверхеда Да ну как бы это не Панацея и я тут заголовок откровенно кликбейтно я понимаю это не бака фича и в целом это не серебряная пуля смотрите как немножко лирике Почему я вообще про все это хочу рассказывать потому что я верю что контейнеры сдохнут и виртуализация вот в этом виде их вытеснит потому что проблемы Security в контейнерах но на мой взгляд Они то прям страшные штуки и собственно возвращаясь к вашему вопросу я думаю что это когда-нибудь так или иначе запилен но прямо сейчас если вы хотите запустить функцию на 3 килобайта вам не подходит Слушай мне кажется будет придут новые виртуалки потом придет контейнеры и мы снова уйдем в рекурсию и у нас как раз следующий вопрос Подскажите я правильно понимаю что в итоге это решение оно больше для каких-то крупных cloud-провайдеров которые предоставляют услуги своим пользователям которым они не доверяют и соответственно разворачивать себе подобный сервис с таким ресурсом имеет смысл только если обрабатывается что-то очень критичное типа финансовых данных и прочего но Да эта история про безопасность правда то есть если у вас там нет какой-то модели угроз которую эта штука ложится то наверное вам и правда не надо можно вообще все запускать от Рута и никак не делить ресурсы Я утрирую понятно но суть примерно в этом Да оверхед большеват но вот история про дмз На мой взгляд Она довольно практически для всех применимо в той или иной мере Да потому что это недоверенный контур и это в целом защита от рце понятно что можно натянуть какой-нибудь а пар сверху на вот эти контейнеры Да там настроить какие-то парк профиле чтобы тоже там не дать какие-то лишние вызовы и прочее Но это просто дополнительный такой свой защиты Так что да Если вам нужно Security это все подходит и с игра стоит свечи если вам в самом не критично Вы доверяете вашим пользователям там и они у вас лапочки и квалифицированные скорее всего вам это не надо Слушай мне кажется Доверяй но проверяй но больших вентиляция которые используются в интерфейсе все-таки не доверяют но мы плавно катимся очень медленно очень лениво но все в эту сторону лежат кажется да у нас нет вариантов И как у нас нет вариантов значит Следующий вопрос Добрый день Виктор спасибо за доклад очень интересно как карта контейнер будут работать привычно нам паттерны и контейнеры сайдкары и как это будет выглядеть с точки зрения управления с cubernets Будет ли нам доступны диплоинты и прочее ресурсы смотрите с точки зрения губернации не знает что там происходит смысле знает за счёт runtime класса и есть некоторые специфика но в общем случае ему всё равно какой ран используется работает это ровно также у вас пот внутри одной виртуальной машины Вот именно под поэтому несколько контейнеров соответственно вы вот поднялась виртуалка в ней поднялся пауз контент то есть смотрите у нас в кубе всегда есть сайт карма про это забываем но у нас всегда два контейнера в поди Вот соответственно мы подняли вот эту полосу боксом он поднялся наша нагрузка рядом поднялся сайт Car они внутри на одном Керн Или как обычно взаимодействует и Отлично себя чувствуют а-а вот в остальном Ну вот я говорю что есть допустим с CS некоторые специфика работы клубе что утрясающе у вас работать не будет А в остальном это просто работает кубер ничего не замечает в этом и смысл о себе вот этой всей магии чтобы оно просто работало Вы можете даже просто там допустим разные слои То есть если у вас там не знаю куберы ещё на докере Вы можете прямо под докером runtime поменять ещё ниже и тогда даже кубер ничего знать не будет Ну вот тогда Немного непонятно Как всё-таки коллеги я предлагаю дискуссию перевести и в зоне мы все все это радостно обсудим и у нас есть следующий вопрос Виктор правда Спасибо очень большое за презентацию реально было очень интересно Вопрос такой А вот вы говорите О том что у нас контейнер резерву Траст А если у нас хост не тратит вот мы дипломимся в среду которая ну не тратит могут на это вот перехватить могут диск перехватить мемри под принц снять Ката или вот эти вот подходы они позволяют как-то сделать runtime шифрование и обезопасить этот от такого уровня перехвата смотрите Я не знаю Я не сталкивался с ситуациями когда я запускаю что-то на недоверенном Хосте Ну просто не доводилось А я думаю что нет Я даже врать не буду на самом деле я просто не знаю простите но мне кажется как раз вопрос для отдельного исследования и для отдельного доклада и с радостью ждем возможно еще конференции Я к тому что я могу пример я могу принимать привести пример привести Да вот есть заказчики которые например не доверяют амазону Вот они говорят вот мы конечно запустим но там вот данные могут Могут утечь могут перехватить Вот наши Security не разрешает я понял я понимаю вас смотрите в эту сторону есть я вот буквально сегодня узнал от коллег которых был здесь предыдущий доклад что есть сейчас движение у амазона ой у мдн то ещё кого-то про там какой-то механизм изоляции уровня процессора железно Когда мы можем в процессоре создавать там скажем так некие области недоступные другому правой части процессора и это прямо гарантированно работает то есть вот индустрия в эту сторону идёт и говорят что это всё поменяет а прямо сегодня как будто бы если у вас есть Ну не знаю подменять там вызовы не знаю сетевые процессор произвольной железке то чтобы не крутилась внутри может быть скомпрометированной даже не узнает об этом то есть это вот Большая история про какой-то там Secure computing вот эти все штуки Мне кажется что карта в чистом виде здесь никакого отношения имеет потому что она абстракционно ниже лежит уровня там где у нас уязвимость фактически и вот на этом уровне всё меняется и всё понятно то есть на этом уровне просто не работает да спасибо и мы переходим к следующему вопросу на первых в их рядах Слушая пока идут а какая у вас принципе у самих инсоляция размером на мкать у нас нет какого-то супер провода пока вино особенно тем больше места работы я это все делал потестировал я вкатил этот стащил это там рантаймом в кластер погонял какие-то нагрузки понял что там условно часть пользовательских вещей которые мы запускаем она правда не как будто бы не замечает разницы им нормально На этом успокоился Вот я говорю у меня был проект этот тащить в дмз как по умолчанию но я Поменял работу я понял Я думаю в следующем году ты с нами поделишься ли она нагрузки в принципе А нас уже готов вопрос Виктор спасибо за доклад очень интересно вот возник вопрос как это дело всё ложится на nested виртуализацию то есть допустим если мы развернули Виртуал на том же например ну и соответственно поехали в историю нормально Если у вас есть собственность она поддерживается то она просто работает соответственно у вас не знаю опыт шифтовые ноды на виртуалках внутри вы поднимаете виртуалки соответственно современные процессоры умеют примерно все надо чтобы было включено на этот виртуализации ну там в Биосе допустим есть некоторые траблы с amd-шными процессорами Ну допустим домашними короче сейчас очень дурацкий кейс У меня просто винда основная система и там в ssl который работает как бы виртуалки вот на AMD в с или карта контейнер с не работает потому что есть какой-то там ишью не самый популярный кейс Но вот магия несёт виртуализации всё прекрасно себя чувствует Ну вот по перформансу а по перформансу не скажу честно говоря Спасибо не пробовал в какие еще запустить А я же говорю что у меня не работает потому что"
}