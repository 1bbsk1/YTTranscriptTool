{
  "video_id": "zq9IDngR5pk",
  "channel": "HighLoadChannel",
  "title": "njs - родной javascript-скриптинг в nginx / Дмитрий Волынцев (Nginx)",
  "views": 2267,
  "duration": 2919,
  "published": "2019-01-14T00:12:20-08:00",
  "text": "всем добрый день я буду рассказывать о таком проекте который называется с который мы создаем в компании если двух словах то нгс позволяет вам создавать переменные новые внутри engine со и обработчики стадии запроса на java script совсем немного обо мне я работаю в компании 2015 года за это время я успел поучаствовать в разработке самого engine со его расширенной версии которые мы делаем для наших наших клиентов из 2017 года я активно занимаюсь вот этим проектом которыми я сегодня буду вам рассказывать сейчас пройдусь немного по план своего доклада по структуре что по основным темам и моментом которые я буду вам рассказывать итак сначала немножко расскажу предысторию каковы были предпосылки для развития и появление этого проекта потом я немножко расскажу зачем вообще нужен в anjing скриптинг и почему его там допустим не было раньше и почему нужно именно сейчас потом немного расскажу о целях проекта каковы были основные цели при создании на что мы что мы пытались сделать и что мы сделать не пытались зачем как контексте цели я расскажу подробнее зачем понадобилось нам написать свой собственный интерпретатор с нуля носи почему я расскажу почему мы решили не использовать lua который тоже часто используют для эмбоссинга для imposing стрип скриптинга потом я немножко покажу примеров что уже сейчас можно делать она джесс в яндексе и чуть-чуть остановлюсь на возможностях интерпретатора самого по себе то что уже сейчас реализовано что нет это все я расскажу итак немного предысторию наверняка не многие из вас знают из тех кто пользуются активно индексом может быть в повести что игорь пытался сысоев создатель этого проекта уже добавить скриптинг в далеком тысяча учетом восьмом году на перле однако эта история не очень взлетела по некоторым причинам о котором сейчас я расскажу то сейчас уже в перле есть такой модуль который позволяет вам делать какие-то вещи скриптовые внутри индекса однако он не пошел что из плюсов из плюсов можно ему поставить этому модуль который уже я сейчас что можно использовать готовые какие-то библиотеки на перле и уже можно сейчас для этого модуля писать какие-то кусочки прям кода внутри прям конфигов джинса однако есть большое количество недостатков один из них и основное это то что если бы какой напишите внутри этого interpret а ну три кода который попытаетесь запустить внутри этого модуля какой-то блокирующий код который попытается допустим зарисовывать допустим доменное имя ли что то еще то весь worker ужасов станет то есть этот модуль никак не рассчитан на то что он он может рабби работать в асинхронном режиме второй момент который можно отнести к недостаткам текущего модуль который существовал ли существует то что по архитектуре на построен так что у вас есть один глобальный контекст это первый интерпретатора который существует все время жизни маркера и в этом месте очень сложно бороться с утечкам памяти и они периодически и проявляются и последний момент который можно отнести к негативным моментом в текущем моды это то что обработчики не изолированы и допустим один из вопросов который пришел и допустим код для него исполнится так что он сломал какой-то глобальный объект то другие другие запросы на это же логично который обрабатывается этим скриптом они сломаются потому что у вас одна виртуальная машина теперь я немножко расскажу про чего нам не хватает в яндекс зачем вообще нужен яндексе скриптинг немножко зайду издалека что должен уметь вообще делать современные прокси-сервер что от него ждут это дача статике veloster минирования балансировка нагрузки кэширование это все все есть уже давно в яндексе однако сейчас времена и веяния несколько меняется теперь теперь нас бэкон такой становится разношерстный если раньше в в яндексе могли написать несколько прокси посла кечинов на ваш backend то на этом в этой части настройка яндекс у вас заканчивалась то теперь когда у нас большое количество микро сервисов разношёрстных например в области авторизации либо вы должны это авторизацию реплицировать в каждом из этих сервисов либо вы должны либо вы должны авторизацию сделать в самом на самом прокси здесь я привожу в качестве примера об и найди connect я не буду подробно углубляться в детали однако скажу что конкретно нам в этом месте понадобилось для ре зация канаде конёк скриптинг на стороне индекса нам нужно там работать с содержимому ров какие-то извлекать токины все это хочется сделать прям на на стороне прокси никакой букин там не отправлять чтобы сделать это относительно эффективно и быстро и 2 2 термин который сейчас появляется в сиротой и текста по микро сервисом это опять битвой если у вас на стороне бэг-энда теперь огромное количество каких-то микро сервисов то хочется иметь какую-то одну единую точку входа куда приходят все ваши клиентские запросы вот таким таким опять горит в м то есть это можно назвать опять и твой это современно такой продвинутый прокси он должен уметь делать какую-то именно своей стране про какую-то логику не нетривиальную причем эту логику не хочется делать на хищных модулях вот второй момент это то что здесь опять-таки если аудиторию такая которых я считал что если вы когда-нибудь писали конфетка конфиги для индекса то вы знаете что большинство директив индекс они принимают в качестве аргументов не какие-то реферальные строки они принимают принимает целое выражение из переменных и причем эти переменные они вычисляются эти выражения вычисляются динамические для каждого запроса и это позволяет гибко там включать и выключать для каких-то какие-то запросов там кэш для каких то что другое включать в качестве примера здесь привожу у нас есть такая директива практикуешь байпас который позволяет отключить обращение кашу и если допустим в аргументы запросы или в куках запросы есть переменная не пустая наук ешь то есть у нас это выражение которые у нас в качестве директив это в качестве аргументов принимает эти вычисляться для этого запроса она будет не пустая в итоге то директивы сработает и мы пойдем на обед второй пример здесь показываю опять-таки просто иллюстрирую сам механизм сам механизм выражений с переменами то что все что она позволяет это склеивать перемены друг с другом и с реальными сроками собственно про это я рассказывал здесь на этом слайде то что то что этот встроенный сейчас механизм переменах вам дает это конкатенация переменных друг с другом и с федеральными строками все если вы хотите что-нибудь поинтересней а если вы там хотите какой-нибудь хэш посчитает для какого-нибудь одра авторизации если вы еще что-нибудь хотите там допустим нормализовать какой-то хедер потому что с какой то очень странный backend который допустим принимает только вот там не на верхнем регистре или нижний регистр то вы этого делать сейчас стандартными средствами nginx не можете ну допустим с числовыми данными нужно поработать все этого сейчас стандартных средств средствах анджелеса нет однако понятно что индексом существует достаточно давно и люди как-то пытаются эту проблему обойти в данном примере я показываю как при помощи модуля сет миск стороннего модуля люди пытаются решить проблему того что встроенный механизм достаточно ограничен и в данном примере мы пытаемся запроектировать в с3 bucket наши запросы которые бы приходить на яндекс то есть основная цель кода который будет выполняться строчками выше которые потом покажу в том что будешь ли тут вот этот вот хедер авторизации соответственно как это делается сейчас мы создаем первую переменную который нам понадобится через директиву сэр байла а потом мы создаем при помощи опять-таки директивы сет новую переменную ту сайт который будет основная задача нам была подпись отправить в качестве от этого ходы авторизации потом этот этот туссан передаем в другую псевдо директиву да . дикси вы не чего-то делает в яндексе она просто работает как функция потом опять таки то что мы получили на предыдущем этапе мы еще и боишься 4 encoding делаем делаем то есть такая то есть мы по сути при помощи этих псевдо директив позволили вызывать какие-то функции однако мне кажется что подход он достаточно ограничен как минимум тем что если что-то делать и ждать лево шаг вправо какой-то уже директивы такой подобный нет вам нужно либо и снова писать носить чего делать не хочется ее там отнесем я бы отнес это к минусам этого подхода и мы переходим к целям проекта что мы собственно хотели создать и основной целью было создать механизм для создания новых переменных обработчиков стадии запроса на java script сейчас я подробнее остановлюсь что что я под этим имею ввиду первый момент наверняка многие 2 знает про опен-рейз те о конгрессе тоже принципе позволяет много кое-какие вещи делать что то есть о понравится это ванильный индекс сверху куча патчей и несколько на несколько модулей в модуле вот как раз один из модулей сет миск который приводил пример использования в предыдущем примере однако у нас есть несколько именно вас работа разработчиков с мало индекса большое количество претензий к тому как все это сделано это сделано во многих местах пересекается с не пересекается конфликту с тем как реализован сама jigs то есть многие механизмы которые дает вам в руки о подрасти они не не очень хорошо согласуются с тем как сам яндекс работает второй момент второй момент это то что мы не хотим в руки давать такие вещи которые в яндексе они уже есть потому что есть опять-таки посмотреть на сам на сам то что дает вам руки об адресе он дает вам допустим возможность прямо напрямую ходить и давать эти писаки ты там реализовать какую-то логику прям на на lua мы мы не думаем что это хорошая идея снова повторять внутри джинкс а еще один еще один слой который делает примерно то же самое только на скриптовом языке потому что индекс все-таки не для этого мы его рассматриваем как такой легковесной прокси-сервер поэтому мы в этом модуле даем вам только в руки те механизмы которые прям хорошо ложатся на архитектуру самого яндекса дальше следующий пункт после того как мы решили что мы хотим сделать какой-то полноценный скриптинг мы мы стали обдумывать какой-то до язык использовать и на этом слайде я вам расскажу почему мы выбрали java-script они не в первый момент про java скрипта что это очень популярный особенно 2017 году из-за даже если вы на нем не пишите то как минимум вы где-то видели встречали там какие-то куски кода видели и это ему безусловно идет в плюс второй момент это си подобный стиль тут естественно есть немного вкусовщины скажем это так однако здесь есть и прагматичный вопрос аспект в том что мы планируем будущем добавить для этого модуля возможности прим м bazinga кода на java script в конфиг андерса и этот синтаксис с фигурными скобочками он нам очень пригодится и последний пункт это то что модели языка модель java script она очень хорошо ложится на на сам архитектуру yandex потому что что что такое java script изнутри это по сути у вас какая-то очередь событий и обработчики этих событий то же самое что яндекс яндекс просить обработчики написано no se но это хорошо сочетается с тем как самсе как самый jacks реализован следующий пункт здесь я расскажу что у нас несколько отталкивает от использования мина языка lua который часто тоже используют для эмбоссинга и основной данный момент в том что мы не хотим пересекаться с экосистема подрасти это от огромная уже развитой достаточно здесь и кодовой базы и много пользователей однако у нас опеки есть много претензий к тому как все это реализовано мы бы не хотели в этом месте пересекаться и быть именно чтобы людей был какой-то конфликт голове что они собственно используют и многие вещи которые сделаны по подрезке мы бы хотели сделать по-другому в итоге мы это один основной момент они использовать зло дальше по стилю то есть из миров минус можно отнести очень нетипичной для хищных программистов и вообще всех псих подобных языков это pascal pascal pascal подобный синтаксис максим индексируется с нуля это тоже очень достаточно редкое явление по крамер для для тех языков на которых мы пишем и последний момент это то что в минус ну а то что достаточно нишевый язык если я недавно смотрел статистику статистику языков программирования популярности то где-то java script у нас на пятом седьмом месте тогда как ну это примерно 40 40 место там 38 40 следующий момент среди целей тоже основной момент это легковесная реализация здесь я перейду зачем нам понадобилось писать свой собственный интерпретатор основной ответ который достаточно простой стоит том что существующий вот развиты интерпретаторы которые уже есть например и 8 который google chrome есть или спайдер марки в mozilla firefox они неэффективны что это значит эти движки они приносят совершенно другой ситуации они предназначены для работы браузере где у вас есть там несколько десятков вкладок каждая вкладка ешь существует достаточно долго в каждой кладки у вас каждый раз новый код то есть это сильно отличается от того что у нас есть в яндексе в джинсе у вас совершенно типичная ситуация когда у вас там на один горки рыб может приходить там сто тысяч запросов в секунду и мы не можем себе позволить там создавать какие-то большие контекст и для и 8 для spider марки просто потому что иначе мы индекс превратим не в яндекс и на этом в apache либо но джесс недоделанный но джеймс мы этого не хотим соответственно это первое первый момент и на этом слайде я показываю сколько вот если взять прям взять движок и 8 взять движок spider-man конгресс и заставить их создать чистый контекст чистый контект даже без кода то вот в 8 можно создать в секунду примерно 2000 к пустых контекстов тогда к spider-man ки примерно 8000 его джесс больше миллиона то есть прошу обратить внимание что здесь здесь у нас логарифмическая шкала то есть разница примерно в 100 раз ну понятно от чего конечно это зависит от никакой есть магии здесь нет просто это очень тяжеловесное достаточно движки там много всяких 3d создается много создается всяких вещей которых в общем то нам в в джинсе не нужны мы не хотим их тянуть и это первый первый аргумент второй аргумент это то что даже если мы закроем глаза на то что в 8 и spider-man к не не очень не очень быстро работает второй момент это что они еще и быстро эволюционируют как как движки может быть кто-то из вас знает что был конфликт в проекте not же с 2014 году тогда произошел форк но джесс от от ford нулся проект и он же с ясной проблема была в том что разработчики 8 они просто резко поменяли тогда свой api для внешних разработчиков так что куча кода которой было написано на джейсона просто перестала работать и надо было бы переписывать и часть разработчиков не захотели этим заниматься часть захотели и мы предвидели это не хотим себе таких проблем говоря про spider марки они вообще даже не заявляют что никакого публичного по пьяни поддерживать вообще не собираются и в общем то так так в общем то и говорят и последний момент это третий пункт это возможность эффективно выстраивания яндекс яндекс это очень достаточно предъявляет высокие требования к тому что к тем функциям этим методом библиотекам который вызывает в особенности папа по работе под нагрузкой в особенности пудра по работе в условиях нехватки памяти и стандартные обычно движки интерпретаторов они не умеют вообще работать такой ситуации они могут там либо не за там аборт сделать какой то вообще эксепшен кинуть либо очень просто завершится у вас есть процесс мы хотим чтобы индекс весь так написано что если вас случилась какая ситуация нехватки памяти индекс все равно и обработает просто в этом вернется там 100 ошибка но ничего не сломается и здесь я отдельно хотела подробно чуть-чуть уточнить до чем ндс не является что мы не пишем мы не пытаемся заменить но джесс если вы хотите там писать какие-то большие развернуты приложения стране бэг-энда то пишите их продолжайте писать на ночь с то есть основной мотив в том чтобы дать вам скриптинг на стороне прокси дальше и джеймс плюс ндс это не applications сервер тоже не надо пытаться в этом какие-то большие именно приложение если вы хотите вам нужны какие-то приложения какая-то запускал к предложений которую мы сейчас в рамках индекс разрабатываем проект называется индекс unit он позволяет вам запускать ваше приложение там на питоне на многих современных скриптовых языках единообразным образом и последний момент зачем мы пока не гонимся это полноценно лизации стандартов и acme скрипт это понятно что сейчас сейчас java script развивается с огромной скоростью это просто каждый год выходят новые стандарты мы за этим не гонимся мы больше у нас прагматичный подход мы хотим я знать какой то sap сет который позволяет нам решать какие-то практики практические задачи хорошо теперь я закончил мотивировочная часть теперь немножко покажу что можно сейчас уже делать при помощи этого модуля есть сейчас относительно простой способ уже этот модуль поставить мы уже этот модуль наверно год наверное распространяя виде пакетов его можно поставить из нашего официального сайта если подключить эта вода сюда linux я предполагаю что мы поставили уже этот этот пакет с нашим снг с и теперь я буду показывать несколько примеров которые уже сейчас можно использовать соответственно если мы написали если мы подключили поставили наш модуль из пакетов мы просто подгружаем сейчас стандартным образом этот модуль при помощи директива лорд модуль потом у нас появляется новый директива который мы пишем на уровне здесь мы в качестве аргумента на принимает имя файла который будет содержать код на и и появляется еще одна директива которым зывается джесс контент она в качестве аргумента принимает имя функции на java скрипте который лежит в нашем файле который будет вызываться теперь посмотрим на право здесь у нас есть пишем стандартную java script узкую функцию она принимает в качестве аргумента один объект это тонкий объект обертка над самим объектом внутри индекса объекта request a и мы в нем используем метод return который очень похож на директиву return который если нужен она принимает код ответа и текст и тело ответ так мы написали минимальный хлор чуть более сложный пример тут будет немножко посложнее что мы здесь хотим сделать представим такую ситуацию что допустим вас есть два бэг-энда а мы хотим которая дает одинаковый для избыточности мы хотим допустим минимальным задержку дать на клиенте и у нас есть какая-то избыточность у нас есть два бэг-энда которые дают одинаковый ответ и на яндексе мы хотим отдавать ответ 1 из 2 из двух брендов который ответит первым соответственно мы снова пишем наши директиву джесс контент мы создаем два пробки ппс логично в наши два бэг-энда здесь функции контент в самом конце кусочек кода я покажу выше который выше я покажу чуть позже здесь мы создаем два под запроса в качестве первого аргумента мы передаем uri запроса который будет выполнен в качеств второй аргумент нас передается аргументы входящего запроса и в качестве 3 аргументы продается функции до которые я сейчас покажу то есть она выполнится в тот момент когда это за подзапрос завершится и так описано функция на java скрипте даже не функция замыкания потому что используют переменную из внешнего контекста что он а здесь написано да эта функция выполняться в тот момент когда объект когда под запросы завершится и мы получим объект ответа от бэг-энда соответственно когда мы сюда попадем первый раз то мы пойдем внутрь условия потому что н будет не равно нулю и отдадим тело ответа тело ответа 1 бэг-энда когда мы сюда пойдем во второй раз это условие уже не сработает и мы внутри не попадем так мы получили на стороне клиента быстрейший ответа 2 сервер опять-таки это простой пример просто показать какие можно делать git асинхронные вещи внутри ндс и здесь я покажу как можно повторить тот самый пример который я вначале показывал s3 опять-таки мы хотим основной цели нашего кода будет в том чтобы создать два прокси кедра один называется x amazon дейт и авторизация то есть в первом для первого для каждого из них мы просто создаем при помощи двух новых директив jet set мы создаем новые перемены на java скрипте в качестве первого аргумента jet set принимает имя новые переменные в качестве второго аргумента ими функции которая должна быть объявлена нашем файле которая должна реализовать тело этой переменной вот значит теперь мы переходим уже в значит в наш файл ндс первая функция здесь мы используем просто стандартные объекты стандартные объекты java script а здесь получается немножко длиннее потому что тот метод который мы используем в lua он нестандартно его нужно как-то было догадаться что вообще существует там он называется cookies time почему он называется cookies time мы используем его для вас не очень понятно здесь мы если мы знаем почитали куют спецификацию там что какие каких игр и принимает бэкон наш backend на амазоне мы можем сами это написать если мы знаем java script то мы используем стандартный объект дейт от него используем стандартный объекту ту is a string и дальше так как опять-таки этот backend ожидает какому-то полном формате мы приводим там убираем некоторые вещи которые нам не нужны и строчки и мы их заменяем так мы получили переменную nam для первой для первого кадра здесь мы пытаемся повторить то же самое что мы пытаемся вычислить подпись в этом кусочки кода мы получаем ту строку который мы собираемся подписать и при помощи этой строчке мы вычисляем от нее сша и вычисляем от нее большая 4 наконец то есть мы повторили то что уже было сделано можно тут несколько сказать что в предыдущем примере было как-то короче однако да это короче здесь можно привести такую аналогию что какие-то вещи можно начинать писать на баш скрипта который вначале будут казаться простыми однако потом выбрать быстро поймете что то что вначале казалось хорошей идеей при усложнении ты хороший день перестает быть и тут я немного пробегусь по этому объекту request что он сейчас умеет что что уже не умеет то есть сейчас можно получать вполне достаточно естественным образом доступ ко всем аргументом этого запроса можно пройтись по всем переменным который вообще даже есть существует у 3 engine свои никак не связаны с снг с пройтись по всем фидером чем проецироваться по ним можно достаточно естественным образом с правой стороны показываю как можно тренировать ответ опять и все до относительно естественно этот кусочек показывает как можно отправлять тело ответа можно по кусочкам и отправлять его используя methods and либо в конце завершать либо можно ответить его разум если какой-то допустим ошибочную случай выходить там вернуть там ошибку какую-то то можно использовать метод 3 тур дальше можно делать внутренние redirect и допустим как это за процессить ваш запрос потом его направить уже внутри нее там именованы локейшн здесь здесь я показываю уже сам request просто опять health иллюстрация и немного сагирова нее есть можно отлаживать там вот писать этот лог который мы будем есть этот текст которым он передавать в эти две функции он будет попадать к нам в лоб и джинсы отдельно остановлюсь немного по модели выполнения то есть вот когда мы написали какой-то кусок кода куски кода внутри нашего файла что и в какой момент будет выполняться тот код который написано с на глобальном уровне он будет выполнен при первом обращении для каждого запроса он будет выполнен при первом обращении либо к переменной либо контент либо кндр у какого-то какой-то стадии которые мы написали соответственно здесь я иллюстрирую тот факт что от этих яндере фендеры они существуют в едином таком глобальном контексте они могут обращаться глобальным переменам и этот глобальный контекст он изолирован изолирован для каждого под запрос для каждого запроса мы имеем такую маленькую виртуальную машину чистую дальше здесь я немножко расскажу про сам интерпретатор то есть что что уже сейчас реализовано что уже сейчас написано интерпретатор это написано на чистом си минимальному уровню количеством зависимостей а если вы поставили пакет из исходников пакет с нашим модулем то вместе с ним также идет com онлайн программа к маленькой чтобы посмотреть принципе потыкать что сейчас уже есть то чего нет она как раз предназначена для в основном отладки и ознакомления и так эта программка называется нгс здесь мы просто падаем в ком его интерфейс здесь опять-таки вот эти кусочки кода это для иллюстрации того что что что уже сейчас есть реализовано есть работает джейсоном есть стандартные объекты java script в частности дейт есть работа с немножко с криптографией что достаточно часто приходится делать на в джинсе работают можно писать различные замыкание анонимные функции есть полноценный бег trace если там что-то у вас неправильно неожиданно работает и даже объект консоли который позволяет вам какой-то писать отладочную осло отладочный вывод это все доступно теперь немножко расскажу про сам функциональность именно что что есть какие элементы ecmascript реализованы резонно такие элементы как стандартный этом скрипте 5.1 это стандартный объем стандартные классы типа риггс по типу джейсона и так далее есть поддержка исключения можно писать какие-то в рабочих и исключений и бросать исключение реализованные замыкание рисованные анонимные функции как я уже упоминал есть немножко работа с криптографией в данном случае есть работа с хэшами пока только и маками на мой будущем наверное это расширим есть работа с файлами можно писать и и читать файлы однако это работает блокирующим режиме в принципе это не всегда страшно потому что например тот же самый cash cash к который использует engine если вы специально не включили асинхронный режим то он тоже отдается в асинхронном в синхронном блокирующим режиме соответственно если вы какие-то открываете это маленькие файлы которые за кашированная ничего страшного не произойдет оно понятно что какому-то высоком трафике наверное достаточно рискованно дальше чего не реализовано не реализован вал нереализованные вещи которые появились относительно этом несколько лет назад это все вещи такие как типичное для более современных программистов нажала скрипте это лет и концы стрелочные функции все это пока не реализовано нет пока поддержки модулей и мы на отдайте мы работаем мы думаем в каком виде это реализовать нет интерполяции строк вот это как раз пример который вам показывал где пришлось использовать плюсики это наверно скоро мы исправим можно будет просто писать какие-то готовые выражения из из переменных и они будут у вас просто вычисляться красиво без специального каких-то приседаний и собственно все вещи которые есть в этом скрипте 6 и выше это куча куча разного года появилась уже java скрипте куча интерфейс вещей пока мы за этим не гонимся мы хотим в первую очередь научиться писать какой-то полезный код под яндекс и уже потом мы будем добавлять какие-то элементы которые упрощает жизнь на этом слайде я немножко остановлюсь про что позволяет нам стартовать достаточно быстро то есть что позволяет интерпретатору не мешает не стоять на пути индекса даже когда он работает с высокой интенсивным трафиком первый момент это то что в принципе это логично идея это компилируете все заранее в байт-код на этапе конфигурации в этот же момент можно отловить какие-то ошибки и в этот же момент создается материнская виртуальная машина тогда как для каждого последующего под запросы которые уже у нас существуют в арке ли эта виртуальная машина клонируется что нам это дает во-первых это даёт нам очень дешевый носить на дешевый старт потому что те вещи которые они уже существуют виртуальной машины и и мы можем как-то эффективным образом шарить между этой материнской виртуальной машиной и клонируй виртуальная машина не шарится в итоге мы вообще немного хотела движение делаем при старте это позволяет достаточно быстро стартовать отдельной еще остановлюсь специально на пункте со сборкой мусора понятно что все современные движки на java скрипте они так или иначе не только же вас крики на любом интерпретируем языке высокого уровня они реализуют сборку мусора однако всегда стоит понимать что все это абсолютно не бесплатно мы это специально не реализуем пока мере пока потому что ситуация мужик совершенно другая у вас объект существуют какие-то доли секунды ну типичный объем типичный request и в этом в этой ситуации совершенно нет никакого смысла запускать какую-то какую-то сборку мусора тогда как у нас есть другой механизм который это быстро позволяет делать этим пользуются все модули внутри engine ксане какой модуль никогда память не освобождает все модули выделяют память из общего пула который общего пула памяти который привязан к объекту запроса и как только объект запросу нас уничтожается также уничтожается и целиком вся эта память и таким же образом у нас это реализовано для ндс от виртуальной машины которой вы спланировали и можно разом всю просто убить без каких-либо лишних телодвижений понятно что такой подход имеет какие-то приемы ограничения его нельзя использовать каких-то долгоиграющих запросах если там вы пытаетесь написать какую-то обработчик для этом websocket of или для чего-то еще то возможно пока этого делать не стоит дальше она в общем то же тема что для каких то целей где запрос возможность существовать достаточно долго и либо выделяют небольшое количество объектов использовать пока не джез не стоит мы думаем над над над сборкой мусора что скорее всего и рисуем в виде отключения что можно будет ее отключать о каких-то режима включать соответственно по умолчанию будет выключено и какого-то верха до на создавать не будет тогда как если вам очень прям хочется то мой вам включим я подхожу уже ближе к концу по планам на то что мы собираемся дальше делать в первую очередь мы будем дальше развивать именно интеграцию с самим яндексом в первую очередь нас интересует хочется добавить imposing кода прям на и джесс прямо внутрь конфигов чтобы допустить обработчики переменных либо какие такие маленькие кусочки кода вам не пришлось писать в отдельном файле второй момент это то что мы будем заниматься именно развитием самих модулей которые существуют в джеймс именно которые используют ндс в области интеграции сэм джинкс чтобы можно было делать какие-то вещи которые можно делать в яндекс иным способом делать это делать это более простым и удобным способом через ндс и вторым приоритетом мы будем заниматься развитием стандартных ecmascript мы будем добавлять какие-то вещи которые привычны и там же вас крепить программистом больше и которые более просто более современные мы будем дадим тоже работать здесь я уже подхожу концу у нас есть весь этот код доступен на git hub можно там создавать и мы принимаем и потери квесты и и принимаем это фичи request и вопросы можно тоже задавать все это можно сделать через гид хоп это мой моя почта если хочет со мной связаться можно написать опеки может со мной связаться и через хип-хоп понятное дело и еще последний момент самый последний за то что в данный момент я един со человек который занимается этим проектом а если вам если вам интересно писать носи интересно писать высокоэффективное приложения интересно писать еще интерпретаторы вы работать и вы живете в москве даже важный момент потому что мы с важно что мы работаем всегда точно мы не работаем удален нашей команде никто не работает удаленно вот это можно прислать свое резюме к нам на адрес указанной мы тогда с удовольствием поговорим все на этом я закончил и готов отвечать на вопрос так вот можно впереди да спасибо за доклад у меня несколько вопросов 1 ты сказал что на слайде был написано что нет поддержки модулей но тем ни менее там был рик флэр крипто это формат кум angeles да это но это пока внутри скажем этот модуль замбези внутрь прямо интерпретатора но какого-то внешнего интерфейса для этого нет и еще вопрос почему он же с почему неджериз криптид интерпретатор для встраиваемых систем джесс и он довольно таки легкий там по моему не более восьми гигабайт памяти есть в общем кажется что для вашего случая очень походит на можно мне рассказать о про такое не слышал на самом деле мы несколько видели какие существуют те который существует именно маленьких anges что нам нем ничего не понравилось но вот прожили скрипт не видим и паз последний вопрос забыл спасибо давайте можно дать все еще слева тогда привет спасибо за доклад вопрос такой вам контекст живет на в в рамках одного запроса или в рамках одной стадии выполнения в рамках одного запроса то есть какие-то обработчики могут создавать какие-то объекты для последующих стадий соответственно если вызвало собой квест который тоже ндс внутри я могу там я понял про этот момент наверно нет в тот который вызывается в запросе он будет уже сам по себе и вопрос немного более общий а на каких стадиях выполнения запроса можно использовать он же пока можно использовать в дтп модули пока только в контент фазе но вот прям ближайшее время мы хотим добавить access фазу тогда как для tcp типе прокси для вот у нас мы надеюсь маги 2 знают не только хтб прокси теперь уже несколько лет но и это c pdp там тоже есть второй модуль называется стрим модуль в нем уже есть можно писать обработчики то в access фазе в и на стороне фильтра то есть можно работать фильтр у audi привит фазе при дет еще в раза гель его нее обед не влогеры сейчас нельзя ну может быть подумаем хорошо а что именно факела германии хотите сделать что вам что не может не можете сделать с текущими средствами что хотелось там делать зависимый ну операции со строками как если вы там пишете какой-то пример какой-то хороший вечерика забабахать а где объясните где прям вот тут напрашивается то мы добавим пока у меня есть да вот тоже пожалуйста спасибо за доклад ладно с джерри скрипт или там с teenagers но все-таки как минимум adac т.п. я думаю вы слышали я все-таки вопрос почему место чтобы взять вот проектом три тысячи звезд и хорошо протестированы проверен и где реализован и вся эта функциональность почему не доработать его а вот заново писать заново проходить все эти круги с богами и так далее а doctype от именно java-script да это движок след не могу ничего сказать product id не ну просто когда вы решали что давайте джесс у нас будет надо наверное движок вы же выбирались чего-то правильно ну да вот и doctype это самый известный и легковесный job поэтому ну как-то product id не могу сказать ну окей привет спасибо за доклад у меня пара вопросов правильно ли я понял что этот функционал уже считается стабильным и вы рекомендуете его использовать продакшене мы рекомендуем начать с ним работать то есть в принципе на него уже мы покрыли тестами он можно и наверно его отнести него пеппа первых вопрос готов для продакшна не готов у нас он такое уже очень сложные у нас есть модули которые там на просьбах этот модуль который hd2 модулем 2 года считался экспериментальным хотя он на самом деле был по качеству не хуже а даже лучше чем те которые были не названы экспериментально вот здесь наверное такая же история пока пока мы развиваемся то есть мы какие-то пока вещи либо в какой-то момент переделываем либо но какие-то вещи мы уже сейчас нашим платным каста мировым делаем на и джесси и они это депорт production то есть вы ожидаете что интерфейс этой птицы будут сильно меняться да то есть в стадии активной разработки на спасибо второй вопрос это сравнивали ли вы производительность ынджи из слов сравнивали все сильно зависит пока по нашим тестом по сильно зависит от того что мы какие теста мы проводим то есть если мы проводим тесты которые типично для индекса то есть когда код который мы пишем на на лугу либо на java script он на самом деле не какое-то вычисление да там какие-то сложные там не знаю там тоже самый хеш мы не считаем внутри java скрипта и налогу тоже не что-то в таком такой ситуации разница на спам даже на 10 процентов быстрее чем это талула но понятно что это все это сильно условно потому что jit а у нас нет поэтому ну принципе мы и не пишет не пишем этот код чтобы на нем нгс не для того чтобы днем считать какую-то математику если хотите стать математику то опять таки для этого есть какие другие вещи мы да да и какого-то гибкого конфигурирования и скрипченко дано стране прокси вот для таких целей разница вообще не незначительно даже даже превышает спасибо давайте еще раз да у меня несколько небольших вопросов 1 нет jetta окей это понятно но вы показывали функцию там внутри вы использовали регулярное выражение на диммер контроллер и она будет интерпретироваться нет а не компьютер оперировали пиджак регулируется каждый накажу запрос нет нет тогда экспорт хорошо там есть всякие сложности типа указатель на последний индекс который смачный это все учитывается да но да это все учитывается то есть тот тот объект request и который создается лайнере costa riddex по то он однократно копировать то есть так вот этот который приточному строчку с с регулярным выражением она капилляр за накрутку хорошо второй вопрос можно ли использовать нгс как но отдельно от engine со да как отлично то есть он как рассказал десятком онлайн интерфейс можно потыкаться в него и посмотреть отлично таковая у меня-то объектов от которые привязаны к самому yandex хорошо и последний вопрос алла у вас тоже свой смысле свой интерпретатор для ло у нас это у кого ну в джинсе у нас нет у нас нет своего то есть проект это не имеет отношение да да да нет вопроса мужчины финал описать просто мне не понять почему все-таки 2 джесса решили написать свой для нет ну у нас никогда не было мне мне как они писали тот проект который который модуль lua который есть это вообще сторонние люди он никакого отношения к yandex к компании и к разработчикам джек снимет так он дает человек ест спасибо за доклад очень интересно а можно как-нибудь кратенько свод правил и за чтоб вы будете бить по рукам когда ты начинаешь использовать javascript уже в качестве написание веб-сервисов то есть супер первое что он пошел вон сейчас подключим как-нибудь радистом и простенькие процедуры на чтение будем немножко predator аббат его вот когда нельзя когда нельзя на то есть ну раз это опять-таки подразумевает что вам нужно так сказать о соединении до сделать этого пока пока нет мы даже вообще подумаем что работу среди сделать каким-то сторонним модулем не сторонним а модулем на яндексе вот по поводу теперь сокетов мы точно не хотим давать именно с прессой китов возможно мы вроде сделаем просто какую-то свою обертку наверно так то есть нам нам на мне нравится с ситуацией когда внутри индекса пытается запускать какой-то код какой-то код который собственно повторяет логику но особенно может быть строительс это не так имеет какое то отношение но повторяет особенно в области ftp то что уже написано в яндексе но прогрелись мы мы думаем как его добавить какие интерфейса в этом месте сделать но пока именно вам это написать мне удастся либо то что вы сможете сделать какой-то под запрос с ндс в какой-то другой сервис но это не очень удобно на это наверное закончим вас время закончилось можно ко мне подходить спрашивать мы благодарим вас за очень интересный доклад и вручаем благодарность и маленький президент организации"
}