{
  "video_id": "yoibd58aPf0",
  "channel": "HighLoadChannel",
  "title": "Совместное использование Lua-кода игровой логики на сервере и клиенте / Андрей Трифанов",
  "views": 428,
  "duration": 3139,
  "published": "2019-05-14T14:43:19-07:00",
  "text": "так меня зовут трифонов андрей да я люблю программе быть игры долгое этим занимался и занимаюсь программистов и вершину разработчиков игр бывших не бывает я сегодня буду рассказывать про совместное использование кода на сервере и клиенте вот и в общем вот зачем да зачем мы решили об этом поговорить да вот знаете подумайте вот налода статочно много клиентских программистов да вот там вот про дефолт про корону да вот что-то пробовали там свои игры делали вот и вот представьте себе вот вы так засну ли там клиентским фонтан программистом этот раз так смогли перенести на сервер и а по вы уже full stack вот вы такие fall стыке красивые по моему по моему круто меньше усилий быстрее результат это все очень спорно но тем не менее в каких-то монеток действительно требуется меньше усилий вот мы на это посмотрим вот и еще если вы в игровых кампаниях работали бывают еще странные мысли передайте гейм-дизайнером некоторую часть логике чтобы они разрабатывали да и то есть иначе гейм-дизайнер вот там просто задергивать программиста а вот вот тут тут вот добавь мне констант очка вот тут вот там вот множитель добавь а вот тут вот я хочу немножко по-другому функцию сделать вот и вот в таком случае если мы ему даем возможность на ложь что-то писать вот там обе очки на лоб то вот это освобождает программистов на некоторое время вот вот этой мороки вот но у нас программист становится там хорошие гейм-дизайнеры тоже некоторое время становятся довольны потому что им лучше они почувствуйте а программисты в этот момент вот и ну вот сейчас модно на китайских хакеров программистов вот про них говорить давайте про них тоже немножко как только у вас появляется успешная игра действительно успешная игра которая взлетает где-то в топ там на оси андроиде все топа отслеживаются и но реальность такова что игру скопируют скопируют очень быстро китайцы которые там 60 80 часов в неделю работают и сидят ну простите надо широки даник скопирует реально очень быстро и поэтому но у реальность такова что вам необходим быстрый инструмент для итерации обновлений вот то что он просто и быстро для разработки прототип мы знаем и вот мы хотим попробовать слова на сервере от посмотреть что нам это стоит да вот какую часть кода мы сможем запустить на сервере вот и что что из этого получится то вообще вот те вас приглашаю в путешествие давайте смотреть вот ну естественно и за машинный код это не только лода вот java script вообще там миллион движков но джесс взяли и там на движке на клиентской стороне и вроде запустили дров скриптовый кот очень легко все sharp с unity playfoam фотоном манану тоже легко java android но без комментариев но если вы там такой человек старой закалки вот та си плюс плюс ребятушки тоже можно до старые движки на си плюс плюс делались самые быстрые сервера наверное на си плюс плюс самые сложные тоже на си плюс плюс поэтому от них отказываются в пользу чего-то но почему бы нет а мы переходим вот вот исследовать дефолту upon расти то есть ну просто потому что я написал соответственно свой прототип на дефолте точно также можно попробовать сделать со короны вот но какие-то вещи специфичные для дефолты я буду рассказывать вот у нас у нас есть прототип да вот как он в общем случае выглядит у нас есть некоторая игровая модель да вот когда игра запускается да вот как оно выглядит у нас есть игровая модель игровой состоянии это чем отличаются игровая модель это вот константное что-то да это описание наши игры да там вот такие есть предметы да как они выглядят там если это там допустим мечта какое какие у него повреждения ну то есть все характеристики то они не меняются вот-вот игровое состоянии это вот там вот там персонажи ки какие мне конкретно выпали да вот что у меня с предметами там насколько износился к там вот конкретные меч и и так далее вот и вот игровой состоянии давайте думать о нем как но для простоты а джейсон чеки вот у которого есть там допустим характеристики предметы там вот контейнеры или лут боксы то мы от миссии вот у нас уже есть прототип да мы не пишем прототип у нас уже есть прототип и наша основная задача вот посмотреть как мой прототип вот в клиент-сервер сможем разложить да и вот какую часть собственно важные лайки который исполняет клиент сможет вспомнить сервер и какая будет цена собственно вот и если мы посмотрим вот на этот слайдик то смотрите вот игровое состоянии вот она очень похожие вот вот вопрос как мы будем обновлять игровое состоянии да вот в как наш клиент будет давать знать серверу что что-то изменилось причем давайте сразу исключим вот некоторые делают такую маргинальную штуку как вот есть клиент я на флеше например это часто встречал когда клиент берет вот он вот джейсон чека тот состояние своего и он берет и вот пушки у все roo'ra говорит сохрани мне его вот у нас тоже клиент-сервер получился формально давно но это же но это глупость да вот понимаете что в общем это не про клиент-сервер это про то что клиент научился сохранить что-то в базу через вот через наш серверный and point вот мы мы так не делаем да мы делаем вот настоящий stateless сервер что значит stateless это значит что в момент исполнения команды в памяти ничего нет он поднимает состоянии из базы выполняет команду который просит его исполнить клиент а потом это состояние и обратно вот в жетончик и в базу сохраняет вот и так у нас каждая команда на сервере исполняется вот нот в качестве базы данных вот ну сервер у нас будет upon расти с ложечкой баз данных но я буду использовать редис но в принципе точно так же джейсон можете сохранить куда угодно вплоть до того что даже даже в мускуле в общем можно сохранить мы так работали не очень красиво но рабочий вариант вот игра давайте я вам немножко покажу вот собственно наш прототип чик с которого мы начнем так вот значит месси у нас есть вот ну некоторые количество персонажей должен извиниться перед вами смотрите в общем вы можете узнать что арт принадлежит одной очень известной игре вот я должен заявить что взял его из открытых источников я не использую его в в коммерческих целях исключительно для академических целей в общем взял так вот у нас видите у нас есть значит список персонажей у нас вот есть инвентарь это вот наши предмете key вот у нас есть лут боксы контейнеры вот и вот вот персонаж допустим ведь у него есть два слова того каждого персонажа мы можем вот так вот взять там вот суда оружие там суда лазерное оружие там суда армор поставить вот открыть контейнер вот он там нам выдал тут кучу всего и у нас еще контейнеры появились ой 0 нет ничего не выдал так вот и у нас в общем ей можно отправлять персонажей на миссии из которых они приносят новые контейнеры вот там вот там собрать какое-то количество персонажей в общем там отправить на миссию ладно вернемся к нашему вот то есть игровой цикл в терминах игрового цикла это выглядит так у нас есть герою мы их отправляем на миссию они приносят нам контейнер с призами открываем контейнер с призами получаем либо новую экипировку экипируем ей героев ли получаем новых героев и снова нанесет вот ну вот в этом цикле крутимся вот то есть по планам и сначала посмотрим на реализацию на диване и снятия предмет а потом на на реализацию открытия контейнера и на реализации начала окончания миссии я честно говоря надеюсь что вот к моменту реализация в начало окончания миссии мы уже будем с вами иметь все инструменты на руках для того чтобы уже вы смогли это сделать в общем понимали как это сделать сами как выглядит надеть снять предмет да вот в демонстрации это было да вот у нас вот есть список персонажей первый экран вот мы тапаем на слот вот первая стрелочка это идет сообщение на там ладно сейчас про сообщение чуть попозже обращается список наших предметов оружий вот дальше мы тапаем на каком-то оружие и оружие попадает в слот и отображаются новые эти на новые наши персонажи вот что мы видим что между первым и третьим экраном до произошло изменение нашей игровой модели да то есть вот между первым и вторым экраном ничего не произошло до мы можем на крестик нажать закрыть и состоянии осталось тем же а между первым и третьим произошло изменение то есть это вот как раз тот самый момент вот это наш сигнал тадам когда вот собственно мы должны что то дать сервер уши что-то сказать серверу сервер у нас что-то поменялось вот и реализовать команду да вот давайте посмотрим что делает дефолт вот тут вот дефолт сначала вот отображает нам вот первый кранчик это gui мы по тапу дефолт прячет гу и отправляет сообщение после этого отображает экран с предметами после этого после этапа отправляет второе сообщение что предмет выбран мы еще вот через эти сообщения прокидываем айди персонажи для которого мы хотим это сделать и от перед тем как показать третий экран где уже у персонажа в салате предметом вот вызывается метод из логики установить предмет с этим айтишником этому персонажу вот то есть вот вот то что я сейчас описал ведь изменение состояния вот тут в самом конце самом конце вот тут вот чуть-чуть она вот это вот то что мы должны преобразовать нашу серверную команду да вот а кто кстати на дефолте программируют можете поднять руки никто кто кто против он слышал ну хорошо вот те кто программирует на дефолте узнают в общем вот метод обработки сообщений да вот мы вот как раз то о чем мы говорили что мы получаем сообщение от одного gui в другой gui что предмет выбрал и собственно два параметра у нас есть там что для какого персонажа и собственно иди предмета который выбран вот и тут мы берем и вот вместо вот плеер и квипа этим вводим дополнительно уровень абстракции у нас появляется команда или экшену как хотите я на за назвал этой командой это будет как раз код который мы попытаемся запил запустить на сервере вот то есть вот команды клип и смотрите что что она делает она вот-вот ровно вызывает вот этот метод плеер и квипа этим вот а дальше ну что он должна сделать теперь и квест в наш сервер пихнуть да вот вам предоставляем обработчик и купайте пост и там вот собственно вот эти параметры она должна в этот пост прокинуть артстрой deselect стоите вот окей так что что со стороны upon расти до вот это тыкве по этим мы предоставляем прежде всего предоставляю мы заводим вот обработчик на ложечки который называется он клипа этим ло вот что в обработчике но вот смотрите да мы там пост параметры получили посмотрели что они там что они есть что они не null вот если ну то там ошибочка от после этого у нас вот works есть наши три параметра ну я опустил в данном случае важный момент но не критичный то что мы берем из редиса поднимаем состояния из жетончик а зло и конвертом и после этого вы видите мы вызываем у команды клип а этим вот вот ту же самую функцию которую бойцы на клиенте у нас и после этого саксэс вот возвращаем что все все окей как думаете победа вот победили мы запустили одну функцию или нет слушайте ну я вам отвечу я не не не это это одна и та же функция в одном и том же файлики вот на я вас обманул смотрите мы вот вернемся к этой функции вот на клиенте то функция нормально отработает доводка ттп request на сервере то вот она в себя снова там request request request начнет себя там досить про зациклились вот но чтобы такого не было введено понятие среды среды клиента среды сервера вот и вот в клиентской сирия посмотрите маму вернем функцию из клиент который будет true вращать из server files ну так вот м простой вариант а вот совсем простой и пост команд и send request команду вот а с другой стороны смотрите серверная функция вот если клиентской фуст функция пост команд она вызывает к тета п request to серверная функция она вызывает ready set то есть она вот собственно по ключик у редиса будет есть параметров это джейсон чик который мы и про кинули будет его в базу сохранять вот и вот тогда уже похоже на победу вот это вот у нас вот наша функция common такое пойти вторая версия смотрите один вариант у нас если in warm and is клиент мы отправляем request да то есть с клиентом и отправляем request а если январем сервер там и редис сейф вызываем да то есть вот мы вот чуть-чуть назад вернемся вот у нас есть две функции вот вот вот тут вот я их нету к сожалению лазерные указки есть то есть а вот вот точно есть спасибо вот-вот центре квест и редис ф-мы но я для простоты сейчас ее обозвал также на самом деле они чуть чуть отличаются они отличаются прежде всего набором параметров то есть я всё упаковал в params для того чтобы пост команд вызвать одинаково там на самом деле вот как минимум в request и есть and point вот этот вот и квипа этим в одессе есть юзера иди и вот мы их в парам то есть пара мтс на самом деле разные наборы параметров содержит когда мы вызываем пост команд вот но в принципе общем вот у нас есть один вариант функции и вы можете вот так написать он вполне рабочий есть второй вариант вот такой вот он но то тут вот параметры удалил надо было собственно написать что мы тут вот параметр это отправляем по передаем функцию а вот вот если вы вот на этот вариант смотрите но вот по ассоциации мне кажется что вот это вот кто кто на си си плюс плюс программировал то вот и в дев linux в дев windows это вот вот этот вариант вот в и как когда это разрастается неконтролируемо выглядеть не очень красиво но тем не менее рабочее вот и вам решать что что как использовать вот первый или второй вариант но мне кажется что второй вариант чуть более изящен вот и в принципе вот тут вот мы можем сказать что вот это первый вариант мы получили рабочий наконец-то да то есть вот у нас есть наконец-то код который экипируют этим да и в зависимости от того сервер или клиент он соответственно там вот он будет в базу сохранять или там на сервер стучаться вот победили но с небольшими оговорками да пожалуй то есть одна оговорка я тут вот не проверял что и cry пойти можно сделать до на клиенте у нас наша логика гарантирует что мы можем это сделать а вот server service что говорит сервер говорит никому не верю поэтому вот и у него должна быть там проверочка продублирована и вот отсюда должна быть ну вернуться хорошо или плохо да завершилась операция и соответственно команды клипа этим тоже вот в следующей итерации должна бы вернуть и вернуть на клиент тоже соответственно вот это вот что сервер со лидировал или не свой лидировал но тем не менее мы как бы своей цели добились и мы вот ком на такое пойти мы запустили то есть все у нас хорошо я думаю что в общем таким образом мы первый этап закрыли и приступаем ко второму этапу к открытию контейнера да то есть вот у нас вот там вот есть несколько контейнеров вот и мы капаем на контейнер и соответственно у нас то вот вот вываливаются там персонажи или новое том новое оружие новые предметы о чем тут хочется сказать но мы уже знаем да что вот-вот в конце концов мы доходим до вот это вот функции нашей о полубокс вот и мы ее хотим обернуть в этот в команду которая пойдет на сервер вот собственно обвязка команды уже у нас есть потому что собственно вот тот же метод post команд мы можем вызвать и в общем вот этот кирпичик у нас есть который отправляет на сервер или сохраняет базу со стороны сервера да вот вот тут о чем хочется сказать предыдущий пример помните мы использовали айдишник мы использовали айдишник персонажа идиш ник предмета если у нас есть одесских персонажей айтишник предмета то соответственно на сервере и на клиенте он должен генерится одинаково вот и поэтому есть есть этим проблема как думаете есть ну похоже что есть но честно говоря нам подойдет вообще и достаточно простой вариант в общем у просто вот-вот каунтер заводим наши просто его у увеличиваем нам главное его сохранить нам надо его в jessica сохранить вот там в в рейде си и соответственно на клиенте его можно сохранить вот и все тогда хорошо вот но тут мы смотрите воткнулись в первую нашу рассинхронизацию причем вот откуда рассинхронизация взялась мы открываем вот наш лут бокс лут боксы то что такое да это вот много-много монеток который мы кидаем а что тут выпадет выпадет персонаж там оружие там armor там там другой лут бокс более там более мощные там или наоборот более слабый да вот и вот собственно рандом генератор случайных чисел вот вот наши проблему которая тут есть вот естественно как бы мы а зная о том что мы используем random мы взяли и в стандартном рандоме вот взяли и вот поставили random seed мы сохранили вот но смотрите какая штука получилось вот такой простой примерчик на упал reste на андроиде выдал вообще совершенно разной последовательности когда это увидели руки опустились вот та что ж такое то то есть вот у нас была как раз вот и и это объяснение нашего провала и нашей рассинхронизации у нас был с вероятностью 05 выпадал оружие с вероятностью 05 выпадал броня выпадало вот и 20 снова фон расти 05 кинул и получила оружие а этот кинул и вместо оружия получил броню и вот и все наша синхронизация то есть в чем в чем оказалась проблема да в проблема оказалась в том что а вот это и его рандом он на стандартную сильную библиотеку рандома зависит от стандартной session и библиотеки полагается на нее через нее реализован она никаких гарантий вообще не дает вот это есть она вот в зависимости от платформы вообще ведет себя по-разному вот поэтому ну естественно если мы хотим запускать у себя вот открывать лут боксы чтобы они одинаково открывались на клиенте и на сервере нам нужен свой random и домой переходим к тому что мы начинаем генератор псевдослучайных чисел вот свой реализовывать вот и вот какие у нас есть варианты у нас есть запрос к серверу запрос к серверу одного элемента до одного случайного числа когда нам нужно мы на сервер скажи какое следующее сервер говорит тогда мы когда мы отправляем нашу команду серверу себя тоже случайное число применит которые у нас но тут в общем понятно естественно плохо когда нужно много случайных чисел у нас вот при открытии одного лут бокс а может двадцать монет кидаться тридцать монет 50 даже ну то есть это вот в одну единицу времени получается сразу 50 запрос к серверу полетит вот понятно что это надо мочить надо все вот сбивать в одну команду с точки зрения оптимизации у одной и вообще вот открыть контейнер можно было бы или там открыть лут бокс реализовать одним серверным запросам но это не наш вариант да вот мы же хотим чтобы у нас клиент и сервер один и тот же код запускал поэтому дальше переходим вот у нас есть генератор псевдослучайных чисел такой как функции сид вот например в вихре mercy надо в мерсин твистов или подобный или если мерсом для вас слишком сложные есть ли мир итеративный тоже тоже очень простой главное там индекс подобрать какие у него плюсы и минусы вот у него произвольная глубина последовательности получается то есть но это что значит что сколько угодно вот ну все это случайных чисел мы получаем к серверу обращаться не надо сервер главное чтобы у нас последовательность та же самая было да вот вот когда последовательность то же самое на клиенте и на сервер и все исполняется одинаково вот ну-ка трафике а че в трафике очевидно что мы экономим вот и смотрите вот интересно что мы можем стартовать без сервера да то есть в принципе без сервера играть нам грустно и мы хотим чтоб пользователь играл сервером но например вот такой кейс как tutorial в играх да вот это вот самое начало который вот у всех одинаково практически вот tutorial мы можем инициализировать нашу функцию вот одним значением у всех и собственно tutorial проскочить без подключения к интернету вот у меня например бесит у меня есть несколько игр на андроиде я в метро еду у меня есть возможность 20 минут поиграть я запуска игры меня половины игра запускается черный экран то есть я понимаю что в этот момент игра лезет к серверу сервера нет и я в общем не удел я как злой пользователь беру и удаляю игру в таком случае книжки я тоже читаю из тетрадка я тоже я жду но раз на раз не приходится sage вот но у минус у вот этой штуки вот он один пожалуй сложность или непрозрачность в отладке да то есть нам нужно вот тот функция там что она следующим выдаст там вот ну нужно каким-то образом вы при отладке там выписать там несколько значений которые она будет следующий выдавать потом снова ее отмотать начала да то есть этого там этот снова random seed ей подсовывать и запустить не то чтобы не решаемая штука ну сложно но вот но такая вот заносов шило в попе да вот вот эта штука знаете она она на самом деле она практически незаменим а вот в играх кто в warcraft 3 играл в starcraft 2 до старкрафта играла вот реплеи когда записываем да там вот я практически уверен что там вот там есть функция вот она рандом щекам инициализировал ась вот и там же ну там миллион рандомов замочи там а то и десять миллионов нужно будет генерить вот вот вот функция тогда наш выбор прям вот но у на нос все попроще поэтому мы вот третий вариант смотрим да вот вам time and одноразовый блокнот практически уверен каждый но там вот многие из вас подумали а почему если вот мы у сервер спрашиваем одну псевдо случайную величину дату почему бы не спросить сразу там их сто пятьсот можно можно и это вот как раз третий вариант который мы спойлер и реализовали но когда у вас есть вот такая вот последователь которую вы получили у сервера да вот но в отладке просто все потому что у вас по сути есть массив у вас есть яндекс который там следующий элемент показывает вот он все прозрачно вот на сервере не нужно реализовывать новый алгоритм до запросили следующий там 500 элементов да он сервер взял и через стандартный вес генератор псевдослучайных чисел сгенерирует на вот записал к себе точно также как клиенту вот ну то есть ну не нужен алгоритм понимаем что вот в данном случае так мы синхронизируем вот этот вектор то у нас нет нет проблем синхронизации вот но минусом является фиксированной грубо глубина последовательности а минус ли это вообще говоря это такой плюс-минус да потому что может быть гейм-дизайнер он нам скажет о знаете ребят вот мы не хотим чтобы игрок все время мог играть offline нам нужно же чтобы он появлялся да вот нам видел новые акции да там видел обновление контента поэтому вывод говорю что у нас есть вот 500 элементов по нашим расчетам эти 500 элементов дают ему два часа игры оффлайна то есть вот вот это вот как раз для меня я сел в метро я там вот полчаса проехал потом еще полчаса допустим на автобусе вот после там но там не интернет появился там я не знаю дома вот и я снова получил новый там этот вот там вектор и дальше играю ее вообще атому онлайн начал играть вот то есть в принципе вот вот фиксированная глубина это требование которое от геймдизайна идет на самом деле это не не от нас от программистов пошло да вот это от от геймдизайна вот ну и вот момент собственно для старта нужен сервер но это вот как раз вот по поводу туториалы и вот варианта с предыдущим что мы можем без туториала запустить в принципе но это можно тоже решить можно за хардкоре вот там что для туториала вот такой вот генератор а потом собственно мы лезем за не на сервер в принципе тоже решаемо вот что что и что еще нужно добавить но вот что последовательность вызовов критично это тоже было вот такое больное решение которое мы пока что не до конца побороли вот вот смотрите вот персы и персы вот как раз последний вызов помните да что prs гарантирует последовательность фрс это у нас перебор массива да и он собственно по индексам бежит а и и п р а п р не гарантирует последовать и это вот как раз тот самый момент когда мы можем ну все запороть да то есть если у клиента будет 1 последовать у сервера будет другая но очевидный рассинхрон вот поэтому собственно пирс ну вот в те моменты когда мы используем генератор именно в тех функциях где используется генератор или ниже по стыку приходится пожертвовать но согласитесь что достаточно большая цена да вот потому что мы иногда не можем понять что ниже по стыку будет рандом вот мой вот вроде как делаем апдейт а вам дайте есть рандом а мы не ожидали этого вот и это вот сложные вещи сложные для отладки но вот вот это вот большая цена которую да вот сейчас пришлось заплатить то есть в prs принципе как мы можем это обойти мы можем перс перебирать отсортировать и перебирать с фиксированной последовательно сервере и клиенте вот но это вот performance penalty у нас получается да там это вот на производительность влияет вот как вот выдачи наград наших защитить кроме всего прочего но это больше game дизайнерский честно говоря вопрос но не забываем что вообще говоря мы вот когда мы ложку на клиент принесли ну здравствуйте боты да то есть вот не составляет труда в общем эту ложку открыть и увидеть протокол сервера а если достаточно умный игрок видит протокол ser un bateau тоже напишет поэтому в общем но гейм дизайнер должен построить гейм-дизайн так чтобы вот вот вот даже если игрок сидит все время в онлайне вот сидит в онлайне игра не ломается то есть я могу сказать вам что в принципе выглядит страшно но вот эту проблему в rear было у такого бешеного хита как clash of clans и там там не из потом была проблема они там сделали немножко по другому там был планшет и механически ручка двигалась и собирала эти деньги то есть могли видеть это в интернете вот может кто-то видел прямо берет собирает в деньги созданий и вот так постоянно онлайн находится человек постоянно находится человек онлайн и за счет этого на него нельзя напасть игра предполагает что можно подать чтобы в общем чтобы игрок платил чтобы у него боль появлялась да понимаете то есть это вот про более про вот ну в общем чтобы чтобы онлайн не это не прошел критичные награды на сервер любом случае выносим то есть вот все таки у нас клиент-серверная игра есть моменты когда вот это обоснованно остановимся на этом вот и номер 2 мы тоже закрыли вот и вот теперь у нас есть клиент сервер начала окончания миссии да вот это то что я вам показывал там тапаем миссия открывается потом вот мы выбираем персонажа одного или нескольких вот нажимаем старт миссии но честно говоря тут я вам ничего нового уже рассказать-то общем не могу потому что у вас уже есть ну то есть вот собственно команду определить вы можете apple reste настроить да вот локацию но вы определите там этот вы можете и соответственно и вызвать там точно так же этот метод поэтому в общем вот вот это вот вы сможете сделать у нас все хорошо да вот и в заключении немножко про офлайн-режим хотелось рассказать это вот небольшая вишенка на торте которую мы вот получили от нашей реализации да вот нам ничего не мешает что такое офлайн-режим это вот как раз вот то про что я рассказывал в метро поиграть то есть в нашей реализации мы сначала вот делали хаттаб и request сразу вот вот мы отправляли на сервер что если могут возьмем и очередь команд сделаем вот взяли очередь команд туда команды пихаем пихаем пихаем а когда наконец-то появился соединением и бери отправляем для сервера же нет проблем ни одну команду сразу там одну вторую третью применить вот неё даже честно говоря с точки зрения производительности лучше потому что он после каждого этого там он делает три deskjet потом команду применил ready set вот при этом еще там вот но там джейсон чик декодировали дикой джейсон чик потом закодировал вот это там со строками операций тоже в общем такая не быстрая штук по этому общему офлайн-режим мы на этом выигрываем и сервер на этом выигрываем отлично вот единственная только сохраняем очередь вместе с состоянием вот и единственный вопрос вот который остается в общем как вот нам softline режимом версия обновлять вот те самые статические данные которые у нас были в начале чтобы понятно о чем говорим было но представьте себе что вот гейм-дизайнер ошибся выпустил версию у него там была в миссии два персонажа игрок поиграл и у него оффлайн режиме видео висит команда вот это вот которым мы должны потом применить да там миссия с двумя персонажами а тут гейм-дизайнер выпускает новую версию до выкладывают вот эти вот новую игровую модель atom миссия с одним персонажем вот ну то есть сервер при попытке сво лидировать вот эти данные да он естественно он скажут плохо и отвалится вот ну это вот рассинхронизация да и потери прогресс игроком плохо вот что что можем сделать но самый простой вариант забыть кажется кажется плохим вариантом но он вполне рабочий если вы будете обновлять версию как вот упомянутый выше clash of clans в одно время всегда там вот раз в две недели в понедельник в 21 часа не обновляют версию то есть таком случае игроки привыкают что вот в это время вот ну команда потеряются и вот но мы мы минимизируем таким образом вот эти вот потери ладно я если все-таки хотите чтобы оффлайн команды применялись что можно сделать вот вот самый такой простой и красивый вариант несколько версий сервера то есть вот у нас есть одна версия сервера со старыми данными она висит вот дальше у нас выходит новая версия мы берём и старую версию говорим все ты новые команды вот папа по времени новые не применяешь вот применяешь только старый и соответственно вот он применил старой команды когда после этого дает клиенту команду коннекте сика на новый сервер вот это вообще можно поддержать это но не сложно новая версия соответственно все у кого нет оффлайн команд они сразу на новый сервер на новую версию конектится и там у них в этом играют с новой версии с новыми данными вот и самый ну сложный вариант но самый такой джедайские и смотрите сервер знает про все модели данных может выполнить оффлайн команд любой старых версий это вот как раз если мы вот про реплеи старкрафта вспомним дата вот в варкрафте 3 вот цвет если помните была такая проблема реплей от старой версии в новый не проигрывался он потому что данные изменились и все а starcraft 2 решил эту проблему он собственно он каждую новую версию он кладет и в папочке можно посмотреть там есть данные от каждой версии и соответственно когда в старкрафте запускается риплейс старый реплей он идет все в старые данные видят а ну вот вот они мои данные на этих данных собственно запускается то есть и вот в принципе это вот то то что вы можете сделать чтобы вот оффлайн команды заработали но это если вот вы собираетесь сделать какой-нибудь сервер вот у нас есть с там эксперименты по tower defense вот на на lua вот вот думаем о том что может быть там вот реплей как раз появится и тому что то подобное надо будет сделать вот ну и вот заключение да вот напомню что что получилось да в принципе код мы не сильно ордер банили down as the mod in warm and появился да у нас там пара методов туда-сюда сохранять в простом варианте в более сложном варианте там появляется на самом деле это вот очередь команд которую нужно каким-то образом обрабатывать но там тоже не не сильно усложняется вот очень сложный момент в персы последовательности вызовов рандом вот с этим с этим приходится жить с этим приходится жить да это прям вот больно и дисциплина в написании кода но вот что про дисциплин в написании кода может сказать это вот нужно помнить просто вам что вот давайте мы сейчас пролистаем вот вот тут вот сюда да вот представьте себе что я возьму и вы квип айтем ну например дефолтных вызовов напихают туда вот что сервера ты делать с этим у то есть вот нам вот в проектировании очень важно очень важно чтобы все таки вот этот код который общей он не полагался нот на дефолт то есть вот мы мы смогли его выделить таким образом и в общем молодцы да вот когда не получается вот так выделить но приходится больше времени тратить на соответственно на проектирование на написание кода вот и вот это вот вот то что я понимаю под дисциплину в написании кода вот-вот хочет спасибо спасибо сказать лону клевого фонарей steady фалду и kingdom rush у ребят кентавров отличный tower defence 22 числа выходит новая версия вот все радуются вот давайте их прорекламируем поддерживал вот они молодцы слышен они дадут да к сожалению вот вот если будут вопросы да вот пишите на email спрашивайте ура спасибо андрей вопрос андрей не забывай про при звучишь за лучший вопрос а лучше вопрос за лучший вопрос так он работает ли не работает а так проработает спасибо за доклад у меня скорее дополнения что такая схема когда клиент знает заранее случайные числа она позволяет клиенту читерить потому что он может заранее знать результат действий или там принимать решение открывать что сундук либо сделать другое действие чтобы сдвинуть но в принтере слов то есть надо это учитывать да да да согласен это и то есть такой момент но поэтому как раз вот говорится что самые критичные награды да мы все таки на сервер вот оставляем их за сервером чтобы сервер их открывал вот здравствуйте у меня собственно вопрос по поводу ботов как вы можете можете ли вкратце рассказать как вы боретесь с ботами и вообще актуальна ли это для вас то есть ли у вас крупный проект в котором действительно много ботоводов спасибо но в данном случае мы находимся на взлете мы смотрим что что с этим будет происходить с ботами но прежде всего все-таки надо сессию скидывать то есть вот clash of clans собственно борется именно таким образом они там мы по крайней мере в самом начале когда это началось они это на некоторые времени реагировали а потом собственно начали скидывать сессию то есть получилось что в игре там больше чем там три часа например нельзя находиться там после этого полчаса обязательно перерыв а за полчаса тебя вырезать над атакует вот в общем ног примерно так то есть мысль вот именно в этом направлении меня воды и сюда вопрос на в онлайновой игрушки иметь и сам делать из клиент-сервис серверное приложение если можно серверов доверять и все задания по генератор n дома по будущее лута всего и вся делать именно на на сервере спустя ну спасибо за вопрос нужен ли сервер вопрос зачем в клео зачем клиенту нужен зачем клиенту знать о уже старым путем но это если мы хотим допустим вот офлайн-режим сделать да если нас устраивает что мы должны быть всегда онлайн то в принципе вот но всегда онлайн делаем и тогда открытие контейнеров всегда делается на сервере тогда не нужно знать рандоме да но это решение принимается гейм-дизайнерами знаете вот и у нас был момент когда собственно гейм-дизайнеров сцепились и сказали офлайн-режим это обязаловка вот прям и все ее что с этим сделать еще воду вопрос а если есть в игре офлайн-режим что в том мне мешает скажем измените эти риски для того чтобы сгенерировать себе результате ей получить определенные там но ничего не мешает до тех пор пока вы собственно но то есть гулял выбью все и я передам мужик я так и кучу интернет запущу игрушку он не дают локально тем они такого но он не сгенерирует он это он же чтобы сгенерировал cd когда у него седые закончится он на сервер полезет интернета нет все он скажет извините здесь важно наверное отметить что в таких играх андрей про это говорил но можно еще раз подчеркнуть очень важно иметь закладываться на то что у вас клиент игрок в данном случае или bot может все время выбирать оптимальную стратегию но если он все время выбирает это очевидно вот либо очень везучий везучий клиент и делать уже гейм-дизайн на том уровне чтобы это не ему не давала особо много плюс фильтровать таких удачливых товарищей их нещадно банить да так много вопросов ну спасибо за доклад такой вопрос в самом начале у вас прям был такой список про китайских хакеров собственно а как это все помогает обойти вот cleanse рваная вот такой подход обойти скажем вот копирование до защит защиту от клеща как и нет не помогает то есть там там массаж скорее про то что скорость разработка скорость разработки спасибо то есть я про знаю что вот со многими общался у кого-то например версия выпускается раз в три месяца ну то есть очевидно что они конкуренты ну или конкуренты ну то есть это должна быть большая компания как mail которые под эту каждую версию льет себе трафика вот ну там вот тоннами просто да и ну в маленькой компании мы так сделать не можем спасибо за доклад здравствуйте хотелось узнать работает ли схема с командами если часть команд должна создаваться по инициативе сервер когда даже запроса нет и как она должна выглядеть эта схема в этом случае там ну если что-то хотим от сервера получать то надо рассмотреть конечно это надо рассмотреть чтобы сокетом появился вот и по сути то тогда отрабатывать то что сервер говорит но если мы в оффлайне если в оффлайне но извините тут уж ничего не поделать это вот вот нет ну да у тебя же этот самый код на клиенте так логике такой же что вы у сервера значит клиент тоже знает что возникнет какое-то событие не событий я думаю скорее будут я правильно понимаю что событие сервер какие-то там внешние события например вот а у нас использовались события да там вот что например обновилась версия данных перриконе катитесь пожалуйста да вот это вот про это окей так 1 1 здравствует доклад мне такой вопрос есть у вас вы говорили что если к ситуация что сервер может знать по предыдущей стоит и ой домов про предыдущий стоит и игровой логики да а вот так вопрос если у вас предыдущей версии было кат ошибками на в логике допустим но что то и не доработали что не готова не досмотрели и была возможность чтить то есть игроки нашли ситуацию и путь от в оффлайне и они собрали вот видно batch который и но вы уже накатить на сервере ну новую версию с фиксом ну и к вам прилетает starbuck открыт кента банить нещадно таких игроков вот этого понять играет сразу или как-то и левых каких-то я не знаю куда ставить и типа ну но в принципе ковер-то запустим их можно допустим знать играть друг с собой в мир собой тасс 10 таро подельники дать конь но честно говоря я в таком случае за то чтобы выпустить патч который у них отнимает вот то что они нечестным путём нажили вот но если это наша действительно ошибка то все-таки дать им что-то взамен вот но то есть там кристаль чиков насыпи да вот премиум валюты сказать что у ребят ok вы молодцы получить успели вот вам хоть какая-то компенсация да но вопрос про то что этот мы уже вышел новый патч как я помогаю допустимо вышел новый патч но вот допустим при выпустили патч ему он вами уже там запустим два часа и вот прилетай допустим роста рыбачу со старой версии ну вот в случае если у нас два сервера подняты до вот это один из вариантов то но собственно сервер старый сгенерировала этот сэндвич момент только в нем дырка ну хорошо но после этого он коннектится на новые сервера на новом сервере у нас вот zara . которая возбудил равен предел теплицы кристаллики и слепцы кристального обратно ему отдается буду чуть чуть до мрак моя но чем чем то его надо наградить ваня-то спасибо еще вопросы так хорошо уже много времени поэтому спасибо спасибо андрей спасибо за вопросы осип за вопросы пасибо слушали спасибо кому книжку преломление наука увидеть иначе наука видеть иначе ребят но хорошие вопросы были кого нужно преломить кого нужно преломить честно говоря ну давайте вот коллегия сюда да да спасибо аплодисменты"
}