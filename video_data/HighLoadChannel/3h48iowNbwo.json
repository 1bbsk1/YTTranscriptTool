{
  "video_id": "3h48iowNbwo",
  "channel": "HighLoadChannel",
  "title": "Длинная транзакция или когда размер имеет значение / Михаил Балаян (Odin — Ingram Micro)",
  "views": 1227,
  "duration": 3121,
  "published": "2018-08-16T04:08:22-07:00",
  "text": "отлично всем привет ой жарковато нормально меня зовут миша я работаю в компании игра maker клауд где мы разработали и развиваем платформу для дистрибуции облачных сервисов одна из частей платформы занимается расчетам объема потребленных сервисов тех самых облаках и в этот момент с этой под системой стали происходить некоторые аномалии производительности то есть она стала падать но они очень предсказуемо они регулярно не очень востанавливаем а и мне . алиса ответственному за отвечающим за архитектуру архитектуру данных баз данных вообще за про длительность за производительный слой данных предстояло разобраться с чем связана проблема в чем в чем суть проблемы как понятно из доклада причину то мы нашли причину мы нашли да это длина транзакция но в этом рассказе я бы хотел акцент сделать не на том что интуитивно многие из нас и так понимаю чувствую это может быть коллеги какие-то рассказывали что длинный транзакции это плохо я бы хотел докопаться до сути почему это плохо чтобы зная причину реальную причину да на физическом команда уровня мы могли планировать архитектуру так чтобы существовать с длинным транзакциями ну либо принять решение что мы не можем не можем в этой системе существовать еще небольшое такое отступление от основной темы в процессе подготовки вернее процессе исследования я узнал намного больше в возрасте чем смогу сегодня рассказать а после сюда изначально хотел как только как только до истины докопался и как только мы придумали решение я на самом деле хотел со всеми своими исследованием поделиться но к сожалению время выступления ограничено и пришлось часть часть того что чем я хотел бы с вами поделиться выкинуть вырезать поэтому в частности вот если кому то интересно тамахин биты которая которые были заявлены или уровне изолированности как они пользуюсь реализованы подойдите позже но после об этом расскажу быть и в в отложенное выделенное время и здесь я просто не успею вам это рассказать ну поехали в общем то вот это функционал который рассчитывает объемы до работает ну достаточно просто он выбирает у нас в базе выбирает объема подписок которые есть на какие-то облачные сервисы ну на конкретный облачный сервис примеру дропбокс может быть потом вот это объем подписок допустимых 205 тысяч разбрасывает наши от потоков и каждый из этих 16 потоков делает следующее он обращается к сервису в интернете но если вы ждали дай бог пример то его его смотрим никто никому и пиарю там спрашивает а сколько было использовано таким-то такой подпиской сервисного отвечает мы это сохраняем таблица сохраняем есть такой нюанс значит сохранение происходит для каждой подписки для каждого подписки три раза первый раз ну обычно три раза вот так скажем потому что цепочка продажи сервиса обычно она многоступенчатая у нас есть сам покупатель который купил тоже подписку дро бокса есть тот кто ему продал и есть скажем главный вендор реселлер там нулевого уровня который продал тому реселлера поэтому у нас и мы нам необходимо это все учитывается три слоя поэтому мы обновляем три раза чем особенность и она потом выстрелит просто поэтому я сейчас об этом расскажу сразу чтобы как бы контекст говори держался особенность в том что обычно а реселлер вот этого 0 главного есть несколько рестлеров следующего уровня ну не так много как бы 10 и у каких-то из реселлером следующего уровня есть огромное количество покупателей ну потому что это же либо физики и либо какие-то юрлиц иное как будет конечно потребителя и хлам может быть десятки сотни тысяч то есть такая получается как звезда огромное некоторые числа от таблицы в которые мы обновляем там разные поломки по-разному бывают ну пускай бы есть установки где больше 12 миллионов записей из них обновляются не так много 250000 вот за 1 то есть мы обкатываем потребление какого-то приложения где-то 200000 апдейтов обновление вот сыр архив я рассказала там есть некоторые безусловно проверка потому что мы накажем слой можем выставить если мы там потребили такой то покупатель потребил больше чем ему можно то там школярам рассылка и так далее то есть некая другая подходит другая логика нами все ушли от потоков плюс к этому у нас используется hibernate значит как выглядит если переводить уже в код до кратенько опять же я часть кода выкидываю самое интересное выбираем подписки запрашиваем уже многопоточных запрашиваем сколько покажи подписки подписки было на южные ресурсов блокируем запись который мы хотим обновить блокируем причем три раза ну для каждой для каждого из уровней и обновляем проверяем если не превышен лимит обновляем все вроде просто select воров да это апдейт сделан но так работали р-н тут как бы никуда не денешься не только супер нет любое время практически так работает функционал важный на один из таких ключевых и у нас происходит его регулярно тестирование тестирование фантазировала это все графики красиво выглядит она обычно так здесь не так важно абсолютное значение здесь важен именно характер то есть она про смелость как бы стабильно нет никакой деградации но в какой-то из дней вот колени ко мне подходит словами мишу нас есть проблемы графика стала принимать другой вид вот синий график это вот как как как бы стала по цифрам видно что там мы за час обработали 200 тыс ресурсов обычно но это тестовый стенд но как бы но плюс-минус характер такой же значит на проблемном графике у нас 106 а ты че ресурс обработаны за три часа и при этом рейд уже там что-то типа не знаю 200 подписок в минуту это поминутный срез и так если дайте как бы здесь я не дождался но у нас были прогоны когда я дождался не до конца до того момента когда было 0 0 1 подписка секунду то есть там вообще можно было ждать наверно несколько дней за десять минут просадка 44 процента такая вот проблема значит нужно было разобраться как разбираемся первые но как бы стали набрасывать идеи что это может быть проблемы сервера проблемы настройка базы of the vacuum отбросили потому что сразу попытались воспроизвести проблему не воспроизвела то есть база тоже сервер тоже все тоже of the vacuum не запускался пологом посмотрел то есть все как бы та же самая проблема не воспроизводится у ребят воспроизвел ось потом значит еще один вариант это фоновая нагрузка но одна из версий была фоновая нагрузка частично подтвердилось потому что самой фоновые нагрузки не было то есть проблема не в том что фоновая нагрузка создает эту нагрузку проблема в том что есть открытая транзакция как воспроизвели открываем транзакцию явным образом говорим с адой таблицу и все и оставляемой транзакцию нетронутой прям вот так вот в сессии до в по иску или оставили в чем в чем особенность этой конструкции оно не создаёт никакой нагрузки и она не блокирует без особой таблицы специальный такой выраженный случай то есть новый объект в базе бизнес за ним бизнес-приложения они мне об этой таблице не знает и таблице не знают ничего ничего приложения и именно эта конструкция дала нам такой вот такой же график выводы как бы очевидно и да вроде как сразу соли набрасывать коллеги давайте не использую 30 раз длинной транзакции но слишком просто слишком очевидно с одной стороны с другой стороны мы не можем гарантировать что у каста мира этих транзакций не будет и потом что подлинная транзакция у нас там за 10 минут уже деградация вперед почти 50 процентов было поэтому хотелось понять в чем в чем как у проблема где корень 2 вот и стали разбираться значит что мы ими имели на тот момент у вас разводили воспроизводимость проблемы моя начались воспроизводить у нас был на тот момент последний пузырь с и был подробный лог приложения по которым мы можем хотя бы понять что это за функционал из того что она мешает это некая фоновая активность приложения там есть таймер и своих задания это java и hibernate возможно там конь сборщик мусора запускается горбач коллектор да и что то там как-то влияет или hibernate омг это фокус своего раз вы для того чтобы исключить вот эти вот там то что нам мешает гарантирует что проблема в базе либо все таки нет где-то сбоку весь код вот этот счет и ресурсов был написан в базе значит так такая конструкция такой конструкции я имитировал эмулировать вызов типа ebay и получение цифры каких-то делаю за девочку который варьирует можем но и там рандомом генерим числа нам не принципиально само число потому что нам принципиально сделать этот апдейт дальше делаем цикле вот этот силе for a blade блокируя строчки три раза три раза почему три раза я вот уже объяснил плюс к этому вся эта процедура было понатыкано такими ipad time клиентами для того чтобы потом построить график прохождения по этой процедуре понять где мы теряем время и вот собственно что получилось 200000 апдейтов то есть к этому моменту построения этого графика произошло уже 200 тысяч объектов на таблице графика имела такой характер это читаете как время прохождения по процедуре да я начали зной с 0 миллисекунд но и концу там уже полторы миллисекунды причем видим что с 5 на 6 шаг а мы теряем большего времени ну 95 процентов времени наверно там а потеряно стали разбираться что это нужная цифра вот эти компоненты мы понимаем что это в процедуре в процедуре это вот этот второй казалось бы странно но но как вот эта процедура ну запрос и что есть что здесь как бы смущает у нас шаг до помню да что здесь три раза три раза проходит секса работает шаг с 4 4 на 5 из 6 на 7 это тоже select for апдейт по той же таблицы но теряем время почему-то только на втором на втором селектором дети вопрос но мне очень понятно выборка по первичному ключу причем стали копаться дальше новый на самом деле дальше начинается такое плавное погружение в адрес и лишь такой транзакции именно в реализации под колеса это для того чтобы понять какую проблему до нам нужно будет залезть глубоко под вот и начнем про какой транзакция рассказывать не буду все есть вроде взрослые люди но расскажу но вернее не расскажу а вот нам интересно интересен тот набор требований и сид основная бор требования и к традиционным системам который который принцип предоставляя как это предъявляется к транзакционному систему значит нам здесь интересно будет то как позлить реализует товарность целостность и изолированности изолирует он смысле реализует он это через и миссис не как и многие другие лесовики в частности там тот же oracle тоже использую сессии вам весь вопрос в том весь вопрос в имплементации канализации сам и в чем прелесть вообще имя сети а в том что мы одновременно по сути имеем несколько версий строк это позволяет читателям не блокировать читатели и писатели писателя не блокировать читателей это же писателей если только не возникает конфликт за одни и те же ресурсы то есть все хорошо все параллельно вообще шикарно все работает но за это приходится платить и что мы за это платим для того чтобы понять что мы какую цену за это платим сейчас разберем как ваш ip-адрес устроен внутри значит там при любой таблице это по сути файл файл файл файловой системе каждый файл состоит из страниц страницы по 8 килобайт каждая страница это ну каждой странице себя представляет заголовок набор указателей сами данные not apply пока что-то выпуска буду дальше каждый the pale это заголовок там битовая карта назначение uid если у нас таблиц создан с аидом и некоему некоторые пользовательские данные ну собственно те данные которые мы и считываем за голу нам интересен заголовок больше потому что там есть важная информация для того для того чтобы понимать как а реализовано традиционность моими сиси значит есть информация о том какая то номер транзакции который создал эту строчку этот опал и номер транзакции которую я удалил причем важный момент по сгрыз апдейты интерпретирует как по сути создание вернее удаление создания прописывать просто tx макс и создает новый это пол записи о то x-men сейчас на примере это рассмотрим значит смотрите если мы ну вот мы создаем таблицу какое для примера дыма вставляем туда строчку видим to examine прописался 406 это xmax 0 то есть когда подвес считаю эту строчку он увидит что она судну создал строчка не удалена а вот этим эту строчку у нас появляется еще один то пол старый то по 2 таб табло прописался xmax то есть строчка удалена у нового the paper прописался прописалась x-men xmax не прописаны все бы хорошо но есть нюанс с откатами если мы открываем транзакцию и прописываем удаление строчки и потом делаем ромбик то у нас остается запись о том что эта строчка удалена хотя на самом деле мы видим что она не удалена на этот случай того что при 5 мин такие ситуации в подписи реализован так называемый к метлу что делает к митлаг кормить лог хранит это представьте себе массив в котором 1 запись это номер транзакции 2 это ее статус статус может быть committed a board at in progress но еще из апнуть это софтом за компом ну как бы если не разбирался поэтому опустим его он особо и не используется вроде как значит вот эти операции которым до этого проговорили значит insert мухаммед лот падает информации о том что эта транзакция за комичен а потом мы делали апдейт ставит вот попадает информация о том что и это транзакции за комичен а потом открыли транзакцию сделали далит накормит вот попадая записывается гранита что подай дано записывать информацию о том что эта транзакция вам прогресс сейчас потом мы делаем ромбик и вот для той транзакции прописывается флаг аборт это все классно все хорошо теперь у нас теперь у нас есть вся информация о том как мы можем мы можем понять да какой то пол в каком состоянии сейчас находится и какой нам нужно читать как транзакция но этого опять же недостаточно почему потому что у нас все таки многопользовательская параллельная система и нам недостаточно иметь и последнюю версию то по нам нужно знать как бы наш снимок данных мы за этой дальтоники потому что у нас есть согласно целой целостности и согласованность для того чтобы реализовать вот эту целостность в подписи ведь он так называемая сниму транзакций о чем он говорит ну сначала вообще как он как вы получить любая транзак я не так давайте расскажу смысл и а потом уже расскажу что значит все остальное как вы получите что значит значит снимок транзакций говорит нам конкретно нашей транзакции о состоянии всех остальных транзакций которые есть системе получить его можно ну открыл транзакцию выполнив их один selected track среди карен snapshot вызова функция вызывается текстовый текст в ее представлении о чем он будет от них свои представления первое но это три числа разделена это двоеточием может быть два числа зависит от системы но как бы общий случай 3 первое число говорит нам о том что все транзакции до этой уже в системе не активны то есть они либо за комичны либо трубы чины но мы их мы можем читать игру говоря to play у которых вот это вот эти номера и ниже ночь этой смысле чтобы анализировать там транзакция откачано или закончена следующие знаю второе значение говорит нам о том что все транзакции начиная с этого числа включая это число еще активны могли бы еще не начались соответствие для нас это как бы будущее для нашей транзакции конкретной и мы не видим эти значения ну и третий блок это список транзакций между вот этой x-men xmax который тоже активно ну и соответственно их их изменение мы тоже не видим это значит ранга какое-то рядом что там делаешь обрушит мы пока не видим эти изменения ну то есть примеру для нашей транзакции изменение 406 транзакции еще недоступна если мы прочитаем the pale в котором будет там то x-men нарита x 466 то нам это значение еще неизвестно недоступна соответственно 455 нам знать что же известные доступна здесь кстати вот мне поставкой а вот этим разобрался с этим с ним кадра за акцией мне намного понятнее стало чем отличается уровни изоляции транзакций сирила и забыл рядками ted и к какой-то 3 у нас рядками тот едет это было рида как бы до этого читаешь докуда вроде все понятно написано но как то как то все равно что то нет а вот не укладывается в душе разработчика как как в чем в чем отличие вот когда вот это понял сразу стало понятно значит что такое кипит и бурлит и сериала и забыл когда мы открываем транзакцию вот этот снимок снимается самом начале и все потом больше не меняется на протяжении жизни нашей транзакции мы получили снимок и мы с ним работаем другие данные мы не видим случае с рядками that при каждом открыли транзакцию но прикажи на выполнение запроса мы сперва спрашиваем снимок транзакций а потом выполняем таким образом мы каждый раз по сути можем видеть на момент выполнения запроса свой то за акции изменение которые совершены были параллельны и с ее сессии которая закончилась там все отлично разобрались но нам что-то не хватает а не хватает чего вот у нас проблемный запрос в котором была выборка по первичному ключу по индексу мы вроде как представили всю всю внутрянку под колеса как он реализует нам виси но пока нигде не играет индекс давайте рассмотрим как с этим всем работает индекса значит индекс ссылается на указатель если мы помним да структур утопла то яндекс ссылаясь на указатели в то плятта посылается на наверняка зале ссылается на само содержимое есть у нас появляется новая строчка в таблице появляется новая запись в яндексе которая ссылаясь на другой указатель но и так далее но у нас запрос по сути обновляет одно и то же поле и она не проиндексирована на этот случай у пузырится есть придуманная оптимизация которая называется хип only keep on late to paul blade ну вот народе в чем ее суть индекс самый первый случай даже у нас индекс ссылается на указатель указателя ссылается на то пол версия 1 мы делаем апдейт появляется новый тапов при этом индекс смотрим да он не перестроился он как указывал на тот об этот указатель так и указывает все прекрасно а вот уже то по в этом самом the player указания смотри в другой то пол еще один апдейт опять указатель да теперь вот так вот у нас указатели есть есть есть а что будет если у нас заполнится блок данных полностью те же самые 8 килобайт на самом деле функционал не очень документирован поэтому он я немножко смутил когда я с ним столкнулся происходит следующее так называемый сингл . о котором я уже когда узнала что это такое и просматривал потом уже презентации брюсом жанна я понял о чем он говорил но до этого как бы я проскакивал эти пункты мимо потому что не понимал о чем речь речь вот о чем когда у нас забивается полностью блог следующее что происходит при следующем следующая blade который породит должен бы породить новый блок как давайте помогу им что у нас там по времени давайте то есть время кто считает что выделить новый блок поднимите руку новый патч так окей у нас верующих мало кто считает что после сна это случай придумал что-то хитрое ну на самом деле про вытяните такого разных пусть еще рассмотрим оба спокойно всему свое время значит да что происходит позже станут происходит приходит новый апдейт адрес понимает что сейчас я должен выделить новый блок у меня об этом закончилось место он начинают проверять а есть ли что-то в этом tab ли ну в этом блоке вернее что уже никому не нужна ни какой то надо кто не нужно то есть то что по сути ниже того уровня который мне там текущему мы с ним куда ступин ниже x-men а если и то есть он все просто чистят оставляет только последнюю версию которую я сейчас обновляя потому что я не могу удалить малая мои транзакции откатиться до вальтами делается redirect на alt ну на другой указатель но и в общем то все у нас блок чистой и понеслось на 5 заполнение поной так может быть до бесконечности мы можем ну почему то бесконечное количество раз обновлять один одну и ту же запись и она вся будет проходить в одном блоке есть у нас таблица не будет расти вроде как мы все боимся разбухания да ну на самом деле такой вот мини оптимизация есть очень помогает в больших таблицах здесь у нас многомиллионные таблицы какой бы низкий метро школ для авто вакуум не ставили все равно будет срабатывать там допустим когда обновятся миллион записей сотни 100 тысяч записей именно вот это решение позволяет решать такую задачу когда возобновляется какие-то конкретные записи в большой таблицы она позволяет избежать разбухания но все они так правил ну как бы не все так дешево проблемы начинаются когда у нас есть в системе длины транзакция самое злобная закрывая седина транзакция любая то вот та вода которая ничего не делает и в этот функционал который чистит mini vacuum который чистит тапу чистит блок он уже не можно почистить потому что в системе есть транзакции который как будто бы вроде как эти данные еще нужны хотя хотя на самом деле не нужны что тогда происходит это реально выделяюсь новый блок в этом-то пли прописывается ссылка на попала в новом блоке и вынуть и появляется новая запись заполняют новый блок где там у нас выделяюсь новый новый блок новый новый но и так далее то есть нас по факту получается мы обращаемся к одной записи хотим вытащить одну запись даже если первичный ключ а по факту мы получаем из индекса только в этой картинке 16 ссылок сейчас я приведу пример вы увидите как это может произвести и вы поймете что количество ссылок растет очень быстро ну и еще из по двадцать восемь этапов и каждый из них мы помним да надо проанализировать на придет видимости видим не видим там что мы видим и так далее вот собственно вот она проблема вот проблема длины транзакции и как воспроизвести такое да смотрите их можно провести мы создаем таблицу вставляем туда запись выключаем для нее принудительно of the vacuum чтобы нам не мешал рядом хуaн транзакции открываем открываем сессию вернетесь открываем транзакцию оставляемой открытый и запускаем цикл while чтобы он просто быстрее работал можно было в писк вели в о чем запустить но там дискретизации 1 секунду лень было ждать поэтому она баши просто написан такой скрипте который шарашит апдейты полетит облит по этой таблице делаем их слой новый она лайс select каунда именно аккаунт это важно потому что аккаунт нам покажет ну во-первых он сделает индекс английском и он нам покажет то количество ссылок который индекс передал и чтоб к которым потом извлечем из таблицы здесь мы видим выделил толстым специально happy час это гора 100 количество блоков которые мы извлекли из таблицы там дал индексы мы извлекли и время выполнения на моей тестовой машине просто скрипт гонял я на самом деле не такая быть не такой обгонял этому немножко наворотил чтобы он мне показывал количество обновленных за количество раз которые много обновлял чтобы можно было отследить его что мы видим уже через пять минут вас время почти две миллисекунды при том что первый раз там она измеряется стотысячных миллисекунда деградация колоссальная через десять минут это уже три с половиной секунды но и так далее через полчаса мы имеем уже 8 миллисекунд вот собственно какие выводы мы делаем из того что мы исследовали если у вас системе данные не особо меняются то общем-то для вас длинный транзакции от не проблема она ни на что не влияет да если они меняются активно но при этом как-то вот равномерно мы не долго не какие-то там несколько записей постоянно а вы так вот так равномерно и то есть то опять же для вас это не баня небольшая проблема потому что на извлечение самое то будет влиять не сильно да будет разбухание но опять же здесь вопрос уже весь конкретной системы рассматривать скорее всего не проблема если меняется одни и те же данные то как раз вот в этом случае мы имеем проблему с длинным транзакциями их нужно стараться избегать если не получается то их то что длинные транзакции надо вводить на асинхронной реплики об этом в этом же зале недавно рассказывала лице лисовский о своих проблемах и граблях с этим но как бы это как вариант а если хочется потому побороться другими проблемами но не всем от вариант подходят и опять же вам вопрос в том в интенсивности до нарастание этих проблем то есть у нас например там 10 минут и уже писят процентов падение производительности ну щетку один транзакция вопрос как бы такой очень очень спорная и тогда можно стараться уменьшить влияние вот этим вот эти побочные явления как это сделали мы мы сгруппировали обновления то есть чтобы мы вторую строчку то есть помним да у нас есть реселлер нулевого уровня риска для первого уровня и там покупатель сам юзер проблема была именно с тайлером второго уровня первого уровня первого уровня значит что нужно сделать нужно уменьшить количество битов которым него пролетают дальше это все зависит от системы можем можно ли это сделать или нельзя у нас это можно было сделать мы реализовали называемое понятие пачки для того чтобы уменьшить количество вылетов уменьшаем количество байтов уменьшаем конечно указатель который вращает индекс ну и количество тапов вообще и вот результаты которые мы получили да когда у нас нету ну полчаса из 1 то есть не не оптимизируем не округляем в пачке деградация сколько там у нас полный 50 процентов даже больше до 5 процентов уже но что если это считается что все 70000 подписок обработаны то есть вот все подпишем отыскав работа на 60 подписок минуту нет секунду ждет подписок в секунду и ночью до 3 года стакая при этом если мы увеличим размер пачки видим что деградации присутствует некая деградация когда мы не используем транзакция когда нет пример системе длинных транзакций и она связана с тем что мы для того чтобы то есть мы берем больше записей мы чуть дольше держим заблокированы вот это конкурентный ресурс нас все хотят все шанс потоку хотят обновить там вот это реселлер нулевого уровня если мы делаем очень большую пачку значит это ресурс будет какой-то из транзакции держаться дольше они как бы ждут но зато когда ездили на транзакции у нас деградации практически нету если там вот пачку делаем размером 10 записей если там 5 то тоже не такая большая деградация но и если мы делаем разные пачке 100 то тут уже есть опять же у нас почти нет и градации если есть bento длинной транзакция до 102 и 100 но есть деградация относительно той ситуации когда нет один транзакций и здесь нужно искать баланс с одной стороны чем больше пачка тем больше мы блокируем ресурс тему дольшее время блокируем ресурс потому что жена почитать все остальные с другой стороны если мы вообще исключаем этого размер пачки то мы упираемся вот в этот проблемы индекса поэтому здесь нужно были взяты дискретные значения там 15 10100 можно конечно построить более точный график там взять еще кипром женщины наверняка будет на одинаковые значения золотой этому 16 или ещё что-нить вот такая вот такие исследования которым я хотел поделиться сейчас ещё чё там по моему еще есть время у меня бонус для вас есть отлично вообще вложил сукарно даже быстрее чем планировал значит помним да что вот я там разбирал и когда им вестись и полностью то мою подноготную все раскопали я своего время когда разбирал это все представил это все в виде диаграммы того как puzzles определяет а строчка ему доступно или нет получилось вот такого диаграмм к то есть это те правила по которым пользовались определяет видно яму строчка или нет она не очень относится к нашему рассказу поэтому я ни вставил в основное тело но она очень относится к рассказу о том что такой же будет принимать решения что что он видит лишь что нет ну для примера допустим первые две строчки можем разобрать тут один из сценариев основные сценарии но не все допустим вот и мы читаем тапов вспоминаем дар как у нас the pale устроен того дать enix min max макс зачитали the pool проверяем а статус транзакции которая прописала x-men какой но если аборт от но понятно не видим сразу не видим потому что значит строчка даже не создалось если статус транзакция в in прогрессе то значит она прямо сейчас выполняется до дальше мы проверяем а это наша текущая транзакция может мы сами создаем нет тогда мы не видим да тогда проверяем xmarks а не прописан или нет если прописан то мы опять же не видим это значит что мы эту строчку создали и сами же удалили все это в рамках наших транзакции если xmax не прописан то мы увидим мы это создали я укладываю нормально спасибо ну да видим строчку но и так о чем все остальные snare можно рассмотреть все всем спасибо кто хочет задать вопрос никто спасибо мишка сейчас превратив имени конференцию инграма а ты вот это все разбирал по документации или по коду исходному поскорей но смотря что разные вещи по-разному что-то источники какие множеством примером парочку документация в меньшей степени это все разбиралась прямо либо по поведению под колеса устанавливать пакеты пиджин спект который очень помогает кстати вот сплетен спектром до забавная вещь вообще как я наткнулся на этот mini vacuum он же как я сказал он не документирован ну если в код смотреть он отлично документирован в коде там вообще шикарно за комментариями все канада а вот в документации в официальные дупленко как это выглядело я сижу так вооружившись конспектом жду сейчас у меня там чё-то я увижу такое интересное у меня значит этот 8 килобайт на и блок забивается сбивает забивается добивается все отлично тут я жду что сейчас наверно будет аллоцировать новый блок и все шикарно бах у меня в боки еще пусто в этом же блоке все пусто хотя я сразу ли ну я как научные документации я знаю что of the vacuum отвечает за очистку блоков смотрю логе смотрю там статей balls нет автомаг он не запускался еще раз запускаю тоже самое опять у меня чистится блок который не должен очиститься я там коллег собираю смотрите да такие странно вроде не должно быть такого окей и тут должен сказать спасибо нашему российскому после сообщества она вообще кстати очень отзывчивая отлично я гуляю в facebook сам что вопрос и по ребята кто еще может очень чистите кроме кто вакуум и мне алексей ермаков и федор сигаев далее наводки посмотрела здесь скорее все вот это похоже по крайнее по описанию на вот это вот это явление но и тут я уже начал копать дальше уже собственно по коду по исходникам этот же вопрос я пульс запулил а в международное сообщество но мэри глиста ответ получил счет нам через две недели что летом как то я уже не помню но было не по теме уча то есть в этом плане вот наше сообщество прям прям четкую исходу буквально в течении пары часов недавно наводки спасибо да конечно целый год я не все понял каким образом вам удалось воспроизвести эту проблему путем открытия транзакции создания креативу после делаю тоже никак не влияло в этом вся фишка в этом в этом весь фокус и я так же сидел и думал как же так-то то вас смущает incredible то есть не было да да именно так именно так то есть вы просто открываете транзакцию просто 1 1 записи бегин недостаточно когда вы пишете begins to еще не открыто транзакция с точки зрения позы риса с точки зрения там transaction snapshot а с точки зрения от этого всего вы просто типа высказали намерение открыть транзакции грубо говоря ну это же не может привести к накоплению топов может даже несмотря на то что в той транзакции они никак не участвуют да так в этом весь в этом вся проблема и вся не знаю головная боль по адрес то есть вы просто просто открыли транзакцию которой вообще к вашему приложение имеет никакого отношения она просто в системе есть она может ничего не делать вот как в этом примере я не зря код привел прямо потом вас разберете увидите еда у вас как бы есть проблема а кстати здесь на что еще имеет смысл обратить внимание на не сказал ну не обратил на грани внимание да вот я говорил про количество извлекаемых указателей вот они через пять минут у нас уже двести восемь девять указателей то есть индекс нам мы у первичного ключа допрашиваем select там такой-то записи таблицы с таким поедешь ником а нам яндекс и вращает 200 89 указателей мы должны обратиться к 289 и блоком из мечах проанализировать и тогда мы счастливы ну и так далее там уже через полчаса у нас там больше тысячи и указателей то есть вот вы использовать этот пример можете сами все увидеть и если если у вас есть интенсивное обновление какой то да здесь вообще как бы чисто логически чисто логически нам ее вроде понимаем что на самом деле можно определить нужны транзакции эти данные или нет то есть вот так вот подумать да она открылась а вот момент времени я же не нужна вся цепочка вот там от apple которая расписывал вся цепочка данных ей нужен по идее зависит от того какому на режиме работает если она рядками то то ей нужен только текущей средств данных если она рик это было ride the male сирила и забыл то ей нужен только те данные которые были на момент ее открытия все остальное я не нужны вроде бы мы тоже можем это почистить я тоже давала этим вопросом почему ребятах не сделали но в коде есть упоминания того что это операция даже ли быстрый сама апдейт и cert дэвид операция не даже быть максимально быстрыми и анализировать состояние других транзакций дороговато поэтому проверяются просто если есть то плыву которых который ну скажем так старее чем x-men моей транзакции там их чистим все больше не к проверке нету т.е. здесь какой-то баланс типа должно быть быстро но при этом что можем чистим и меня обруч убивать его не надо убивать вы как только закрываете и либо прибиваете этот транзакцию длинную скорее мы видим хоть и спросили как очень этих проблем да это вопрос спасибо ну все слышали вопрос да я вот хотел спросить по поводу того то что мы нашли длинную транзакцию из-за которого нас происходит деградация мы в дальнейшем ее просто руби мы все вместе вы понимаете что из-за нее деградация то ее надо ну и вы можете пожертвовать до рубите с данными самими ничего делать не нужно у вас только произойдет еще один скажем апдейт какой-то да вот эти вот этих же горячих данных у которых нам уже тысяча с лишним указателей то система почистит все предыдущие блоки до первый раз это будет долго но потом все нормально у вас уже все все чистые блоки известно что сами блоки не почесаться они так и останутся пустыми потому что них есть указатели из индексов и тут мы как бы по здесь не можно удалить но ему не нужно будет учитывать так много и так много блоков да он из яндекс в он из индекса сразу обратиться уже к нужному блоку спасибо того места не почиститься воскресли уже к этому моменту выделилась там 1000 блоков да по 8 кило боится папа там 8 мегабайт таблица так останется весит 8 мегабайт и от этого же спасает of the vacuum 0 к вручную но производительность как бы становится понял спасибо спасибо за доклад а скажите есть какая-то возможность обнаружить вот эти таблицы на которой вход апдейты у нас идут то есть если у нас есть подозрение скажем на какие-то транзакции да но ну то есть проблема еще не случилось да но чтобы как-то проактивное и увидеть что вот есть большое количество таких такой активности да но она еще не критично да но у нас существует то есть можно ли как то ну прямо так явно нет система мне скажет об этом здесь вообще диагностика каталогу может диагностика проблем а вот этой она непростая то есть нет никаких системных представления чтобы увидеть что здесь у нас выделяется много блоков и на это может выстрелить здесь какой-то компромисс с одной стороны вы должны дать свою систему хорошо и семья не знала что это ну что вот фунта у нас до подтупливает я бы вряд ли смог докопаться до истины здесь надо знать что вот есть такой функционал нужно понимать что у открылась какая транзакция что в это время была отдельная транзакция как увидели транзакцию мы знаем да погасят activity в помощь либо в крайнем случае лакировать вот то есть это можем увидеть и дальше мы можем сопоставить например а вот в этом в это время владимир транзакции не смотри у нас просело вот такая какая-то функция только так и мы знаем что в этой функции происходит большое количество апдейтов там либо insert и литов как угодно суть одна но только так скажите пожалуйста вот в этой ситуации на репликах это как-то отражалось или не проверяли у нас на тестовых стартах реплик не было то есть сказать прямо именно фактически не могу могу только гипотетически предположить не должно было сказаться по идее то есть не должно было мешает возвращаясь от предыдущего я и куда смотрите для возвращать предыдущему вопросу а поскольку происходит что у нас делаем апдейты и количество попав начинает расти вопросы диагностики а не будет в этом случае таблиц разбухать точно по размеру таблицы аномально гербе первый критерий то есть если мы ожидаем там не знаю у нас там там 1000 записей размер таблицы уже в несколько гигабайтов тут наверное что то вот вот она около этого ну если тебя таблицы из к записи до расходов донецке гигабайт ты проблему обнаружишь каким-то другим уже я у нас будет расти тогда я просто куда утрирую при наличии нет ни она ну вот смотри у нас самого себя таблицы большая да наши 12 миллионов записями уже лежат и у нас проблема только в одной из записей конкретной но обновили и и 150 раз сто пятьдесят тысяч раз 205 тысяч раз не суть мы не увидим мы как бы в этом масштабе не увидим что что-то изменилось а еще такая просто когда начинает отрастать этих обновления увеличиваться количество получается по идее да индекс начинает расти до индекс начинает расти тоже вот в этом то проблема конечно но это как бы еще одна след на я проблема нам 4 тяжелее читать yandex потому что он больше иных она выражает большее количество указателей который мы должны взять мы должны обратиться к большему количеству страниц в ну в файле таблицы который тоже должны считать который должен проанализировать видимых или нет но то есть тут как бы прям такая лавина бима размеру индекса тоже получается ничего не видно ну в нашем случае нет опять же яндекс будь большой но индекс большой это как бы нормально вас таблица большая поэтому индекс большой а здесь проблема в одной записи то есть это на самом деле эта проблема даже of the vacuum не лечится 1 опять же что на проси чтобы предложено там до одним из коллег из повествовал чувство выставьте ниже порог для авто вакома но он не отловят это изменение на сколько ниже ну там не знаю 0 5 процента но он будет шаоррашей поэта большие таблицы просто у нас будет убираю сыч ради одной записи этой как бы много дороговато запускать а если у нас допустим такая ситуация депо прошляпили моменты или вообще неправильно настраивали of the vacuum и вообще не было и таблицы просто вот с какого момента они созданы так они ну испачканы в общем старыми данными не они никуда не удалены при таком условии когда у нас есть реплики там допустим ход стендбай для чтения например на них вот эти вот огромные p&g не передаются то есть получается что наряду с они будут чистыми ну тогда получается что реплики у нас тоже просядут основательно до этого их предыдущему да я тоже подумала что скорее всего реплики даже пройдя да потому что реплика если мы говорим о физическое или плите то это же а физическая копия и собственно и за this чего и вытекает многие проблемы которых лёша лисовский рассказывал это физическая копия и поэтому она физически повторяет всю структуру особенно если это поток основном они и говорим я считала гической реплика ну тут так тут проблема проблема это не воспроизводится другие будут прекрасно извините можно вопросик скажет пожалуйста здесь дмитрий скажите вот эта ваша ситуация с длинной транзакции она не порождало создание большого количества нулевых файлов как раз в папке bass сейчас ещё раз может повторить а вот это вот ваша ситуация нос не порождало случайно большого количества нулевых файлов создания песка до бара создают большое количество любых файлов вот это вот механизм чистки выговорить он просто очищает но файл то остается получается мы медиа и дома их это вот много уже их создалось когда их дофига но создает не сам файл до в в файле не только файле только страницу файла станет сафари но есть и очень долго подождать чтобы до гигабайта доросла размер то будет создан до новый файл но я просто дождался просто у нас вот есть какая-то ситуация мы пока не совсем разобрались никогда вот лавинообразно растёт количество нулевых именно файлах в одной из баз данных то есть там 30000 40000 как только кластер остановить все там сразу пища становится все замечательно как это так подождите тридцать тысяч нулевых файлов ладно я францию понял что это не к вам все хорошо что решили вопрос приятно помочь пожалуйста вопрос вы утверждать ситуация по идее когда длинная транзакция завершается у вас должна возобновляться про производительность ну по идеям о вашем первых первичном графики бывало какой-то момент там вроде должно скакать обратно вверх у нас на этом графике длина транзакция не завершалась все это время была она все дальше дальше дальше еда без когда да да просто я не дожидался но слишком долго спасибо там 3 часа и так как бы прождал на обед успел сходить сколько всего надо ну очень до колен и ждали дольше но тогда я еще не успел привинтить вот этот механизм который нам отобразит график поэтому там были реальные цифры 0.01 или 0.00 в зависимости от секунды транзакций в секунду nitro зайцы вернее ресурсы в секунду бесконечно которая система сделала ну там вера может ждать очень долго есть у нас по 0 0 1 секунду а нам нужно обновить там тысячи я просто не ждал столько я увидела что-то педали производится мне тут достаточно дальше начали копать"
}