{
  "video_id": "qwcnDBeDVg0",
  "channel": "HighLoadChannel",
  "title": "Не так страшен терабит / Вячеслав Ольховченков (Integros)",
  "views": 1307,
  "duration": 2865,
  "published": "2018-08-16T03:55:57-07:00",
  "text": "доброе утро меня зовут вячеслав ольховский как я представляю компанию интеграл как он кликает а вот так мы компании интеграл предоставляет платформу для доставки видео контента пользователям мы реализовываем полный цикл от заливки клиентам видят а наши сервера и вплоть до видео плеера который работает на практически всех клиентских устройствах плеер у нас поддержит ну тебе trade проигрывает формата hls даша b4 в разрешении до 1080 p для работы требуется только браузера никаких плагинов дополнительного софта ничего не требуется также плеер поддерживает показ рекламы в основных форматах и как я уже сказала работает и на десктопах на мобильных устройствах на приставках и на smart tv возможно встраиванию приложение которое требуется клиенту основные регионы нашего интересы это снг европа штаты и южная америка контент не наш контент пользовательский можно реклама там или какой-то профессиональный кантату за последние пару лет мы немножко подросли суммарной трафик у нас достиг уже 1 год рабиты в секунду в пике в пике с одного эджа мы умеем снимать уже 74 гигабита это в сутки дает примерно 6 терабайт трафика в общем-то даже побольше 40 миллионов просмотров в сутки суммарный объем хранения у нас сейчас может достигать 1 и 3 5 это заняты из них только 07 мы рады новым клиентам у нас имеется для них мощности из нового за последние пару лет мы полностью перешли на html5 технологию плеер у нас полностью на html5 мы полностью отказались от флэша и убираем поддержку hds теперь мы также можем проигрывать видео пояс с то есть на сайтах которые почти теперь наш плеер спокойно показывает видео и мы стали применять продакшене пир toupper технологию про последние два пункта чуть попозже будет рассказано подробнее архитектура наша цель нашего сервиса достаточно стандартная примерно как и у любого другого видеосервиса единственное что мы отличаем клиента и пользователя клиент для нас это тот кто предоставляет контент тот кто его к нам заливает можно не интерактивно то есть мы не youtube нам нет мы не считаем что клиенты обязательно должен быть браузер он должен мышкой кликать чтобы что-то будто со своим видео сделать а пользователи о нас это тот кто это видео потом будет смотреть пользователь как на ее не заливают чтобы предоставлять качественный сервис на таких скоростях мы нам требуется эффективное бюджетное решение и от один из основных компонентов для которых такие решения требуется это сервер доставки контента опять же основные задачи этого сервера это хранения контента и доставка контента пользователю также он проверяет подписи на уралах для того чтобы исключить не авторизированный просмотр видео собирается статистика по клиентам и статистика по просмотренным стримом наши g способна держать 60 тысяч одновременных подключений и больше и как было сказано это происходит на скорости 74 гигабит в секунду в общих чертах edge это компьютер установлен операционных операционная система free bsd версии 11 на котором организована заитов с пол емкостью 32 гигабайта дальше контент с этого пула nginx он и в котором имеется модули и бизнес лом и канала через до квартала 40 гигабит ную карту отправляется интернет и доставляется пользователю в процесс ки процессе доставки весь контент проходит через этот ctfs арк то что из-за tfs арка вытесняется она попадает назад fs 2 арк емкостью но примерно три с половиной терабит трогайте это накладывает определенные требования к используемым с сдвг tfs эдварг чуть попозже опять-таки про это будет сказано подробнее за последние несколько лет как это мы начали свою деятельность у нас не менялась несколько поколений джей от самого первого который мог доставлять контент на скорости только 20 гигабит в секунду до 4 который мы стали использовать в прошлом году и которые вот как раз и может доставлять контент на скорость 74 гигабита в секунду когда мы в прошлом году получили этот edge с новыми процессорами intel скими мы обнаружили что у нас имеется избыток процесс она не мощности на 40 гигабитного канале процессор у нас был занят ну примерно на 50 процентов ну сразу возникло желание попробовать подключить второй порт и посмотреть чего же мы сможем достигнуть мы подключили второй порт нагрузили реальным трафиком edge и обнаружили что больше чем вся 4 гигабита уж не выдает процесса при этом ну почти на 3 свободен стали исследовать никаких явных затыков мы впервые момент не обнаружили емкость по процессора имеется дисковая система не нагружена лаков в системе перегруженных тоже не находятся в общем полная непонятка стали снимай статистику с intel performed скутеров опять никакого криминала нагрузка на память ну примерно как на других биржах нагрузка на пися экспресс в общем-то тоже не показывает какого-то криминала но тут оказался тот момент форман скутеры показывает полную нагрузку на пир на пися экспресс они не показывают как нагружен каждый один конкретный писяй экспресс порт только весь писяй экспресс слот так сказать в процессоре я правда уже сталкивался с подобной ситуации когда разрабатывал собственно для киллеры и утиль эры для питья экспресс версии 2 для которые тогда делал были рекомендации что не следует нагружать писяй экспресс больше чем на 60 процентов я стала искать информацию о том а что же для версии 3 все же там немножко другая характер архитектуру другое кодирование все проще может протокол поменялся и мне удалось найти документ от фирмы и killings по расчету пропускной способности и вся экспресс и в это же примерно время мы обратили внимание что сетевая карта которую мы используем несмотря на то что она выполнена форм-фактор писяй экспресс 16 на самом деле писяй экспресс 8 нигде ни в каких dodge и тах рекламных проспектах и так далее это на тот момент крупными буквами не акцентировалась вот пишется вести вас два порта по 40 мегабит давайте используете все хорошо а пися экспресс 8 даже если у нас нету никакого дополнительного орхета это всего 64 гигабита это далеко не 80 но это не те 54 на которой в которой мы наткнулись даже если учесть кодирование 128 на 130 на 130 которая для версии 3 писяй экспресса это все равно 63 это все равно больше а у нас куда-то пропадает еще 10 gigabit эти 10 гигабит уходит на overheat транспортного уровня в нашей машине писяй экспресса данные передаются небольшими блоками размер блока он согласовывается во время пост и зависит от всех устройств которые вот тут и пися экспресс хоп и согласуется по нижнему краю если там у нас какое-то устройство может только там 128 байт придавать то все устройства будут передавать 128 байт пакет и даже есть они могут передавать там килобайт или два в нашем случае получается 256 байт если мы теперь перемножим 8 линий 8 бит в байте кодирование и overheat то получим что у нас теоретически пропускная способность в нашем случае это 56 гигабит это уже практически точно то предел в которой мы воткнулись отлично мы выяснить причину и раз мы знаем причину мы уже знаем в общем-то путь идею решению нам нужно стива карта пися экспресс 16 который всегда быть вся экспресс 16 5x плюс восемь форм факторе 16 идем на рынок и обнаружил что все двух портов и 40 гигабитные карты пища и спрос 8 intel mellanox челси а они все 5 экспресс 8 только-только стало доступно к заказу steve я карта 9 200-от салафи мы ее заказали через пару месяцев получили следует думать что на западе срок заказа сильно отличается от привычных нам шесть-восемь недель на европе те же самые сроки выполнения заказов мы и получили поставили в сервер и обнаружили что продукт сырой он несовместим с нашими оптические модулями а если зайти в bios и что-нибудь поменять беру сетевой карты то второй раз в bios уже просто не попадешь началась переписка с вендором winter's tale исправлять баги и тут челси наконец разродилась своим продуктом терминатор шесть раз такое дело мы общем его тоже заказали тоже там через некоторое время получили поставили другой сервер продукта пить сырой чтобы удивлялся тоже несовместимой с оптическими модулями просто корма какая-то и жуткая неравномерность распределения прерываний по ядрам процессора они решили почему то что в новой сетевой карте которая там более мощное что такое по умолчанию надо иметь в несколько раз меньше очередей для балансировки трафика а у нас количество процессоров они степень двойки все часть процессоров получает часть лидер получает гораздо большую нагрузку ну опять-таки перед переписка с вендором исправление багов это все занимает время но в конце концов и тот и другой вендоры свои недостатки исправили и мы немножко под к подкорректировали параллельно конфигурацию сервера добавили туда памяти вас клиентов больше и добавили туда я создаю раз снова требуется давать ssd побольше трафика о прошу прощения перепутал кнопки отлично мы сумели достичь семье есть 4 гигабит в секунду и в на этой скорости у нас процессор уже занят практически на 100 процентов если повышать скорость выше то требуется в нашем случае или какие-то гораздо более серьёзной оптимизации софта или просто более мощные и более дорогие как уже было сказано у нас бизнес у нас требуется следить за бюджетом за расходами в общем мы довольны тем что нас 74 гигабита сервера за еще шестью забитыми ценой там процессоров тому полтора раза дороже мы гнаться не хотим за время эксплуатации в 2012 года мы столкнулись с тем что у нас с нектаром момента но вы и джея стали деградировать деградировать они стали так что они не могут выдавать свои 40 гигабит трафика это в общем то началось еще до эпопеи с преодолением 54 gigabyte рубежа как это выяснилось самого начала когда мы еще только все начинали мы исследовали рынок нам советовали модели и вейдера мы посмотрели характеристики против хорошо все замечательно vendor имеет хорошие отзывы и стали ставить в наше ssd x100 все было замечательно скоростные характеристики хорошая надежность хорошие все замечательно никаких замечаний но время идёт вендору снимает данная модель с производства по заказам нам вместо этой модели в дата-центре ставят другую не mxpx то в общем то разница никакой в общем тоже не замечаем характеристики у них практически одинаковые время продолжает идти вентр и эту модель снимает производства там-то центре продолжаю ставить это уже вендора но уже mx200 там bass 200 mx300 сначала мы ничего не замечаем пока edge только установлен трафик на нем ой не трафик контент на нем достаточно горячей и он почти весь сначала почти есть помещается в оперативную память с течением времени он остывает он туда весь перестает помещаться и начинается запись 02 арк как на предыдущем было слова хотя показано сначала не очень интенсивно и потом интенсивнее еще интенсивнее и в некоторый момент мы увидим что у нас ssd утилизируется на сто процентов по сравнению с другими джами ssd больше утилизируется на запись начинаем разбираться и видим что вентр тоже модель другая ну ладно раз модель другого надо бы найти детальные характеристики на нее у вендора естественно просто так ничего не найдешь в обзорах но в общем то же мало чего пишут в конце концов нам удалось найти сайт с пользовательскими бенчмарками на самые разнообразные ssd и эти бич марки они достаточно детальны и если с этого сайта собрать в одну табличку информация по тем ssd который мы использовали то можно увидеть что вот те ssd на которых у нас начались проблемы они почти нет вообще достаточно замечательное практически как тот ssd который мы стали использовать самого начала но естественно vendor как раз именно эту цифру и пишет в своих рекламных проспектах а по записи у нас жуткий прасад просто нереальный такой подставы мы не нет у не ожидали они как еще чем интересен этот сайт с мяч марками там имеется отдельно бич марки на случайную запись и случайно чтение мелкими блоками этот нижней таблице и вы можете обратить внимание что на случайном доступе ssd тоже очень сильно просаживается если кто то думает что он поставить ssd и до случайно доступе он будет работать также эффективно как его память это иллюзия прасад очень существенный это табличка у меня заполнена данными на примерно 2016 год если вы сейчас ее будете заполнять данными актуальными сайтами цифры будут чуть чуть другие пользователи продолжают делать бенчмарки на своих экземплярах устройств и данные на сайте постоянно немножко меняются ну раз такое дело у нас есть сайт с детальными чем арками и мы знаем что эти создает нас не батареи мы можем на этом сайте попытаться найти те модели которые нас могли бы удовлетворить мы выбрали там две модели это samsung 850 пропасть и samsung 850 evo один чуть чуть побыстрее 2 почти в два раза дешевле очевидна бабло победила мы теперь ставим своей же его 750 его производительность нас полностью устраивает так вот раз бабло победила жажду производительности я наверное заметили что последние пару лет google но очень активно проталкивает идея что весь трафик должен тип sl но при этом он очень активно приговаривает ставка включаетесь с или это бесплатно сертификаты бесплатно падение производительности не будет никакого вы ничего не заметите все хорошо все замечательно безопасность удобства пользователей довольны все такое замечание в общем то для кого ни секрет почему google это дело проталкивает у нас интерес свои собственные и мы провели тестирование цели на раздаче видео в общем то как и ожидалось падение производительности имеется и в нашем случае на наших объемов трафика она существенно у нас повышается нагрузка на про один процент загрузки цпу на каждый гигабит трафика который мы раздаём бсср ну или более удобные цифры для расчета без с эля нам требуется но и 72 гигагерца на раздаче 1 гигабита с элем 122 гигагерца процессор наемники мощность это довольно существенное падение где-то почти полтора раза очень процентов 40 еще при этом у нас было замечено что изменяется распределение между потреблением процессора в пользовательском процессоре и в ядре мы детально это не исследовали скорее всего это связано с тем что при кодировании по https существенно больше информации помещается в альтере кэш и это уже позволяет и другу проживать блок данных быстрее в общем-то это просто наблюдения каких-то существенных последствий мы адам на миг не обнаружили в процессе тестирования наш тестовый edge был нагружен на 33 гигабита и общая загрузка циpкa достигла 72 процентов то есть принципе при полной загрузке процессора данный edge мог бы отдавать 45 gigabit это конечно не 74 гигабита но в общем приемлемо в наш бюджет это в общем то укладывается тем более что пока не смотря на всю рекламного компания google а не далеко не весь трафик идет псс или на нашем выборки у нас пока только 10 процентов с или трафика опять-таки мы всеми силами стараемся в свои издержки сократить и при этом стараемся улучшить качество сервиса предоставляемая клиенту и пользователю и один из таких трюков которые мы в последнее время стали применять это раздача видя трафика с помощью пера toupper это как уже было сказано позволяет нам сэкономить наши расходы и улучшить предоставление качества для тех клиентов которые находятся долек далеко от наших точек присутствия для этого мы используем технологии наших партнеров стрим root мы отдаем им часть нашего трафика части манифестов для наиболее акте активных наиболее от горящих стримов это позволяет для отданного трафика охладить 70 процентов для топ-50 стримов это дает даже 90 процентную экономия как это работает клиент очень пользователь подключаясь к нашему видео балансиру и получая video player после этого обращается к серверам стрим рута стрим root с помощью своих алгоритмов динамически формируют список перов и передают его клиенту после этого клиент открывает веба we part i see a direct канал до тех пользователей у которых мог бы быть нужно ему контент получает его если он его не получает он его все равно получится нашего sd на то есть эта технология с прозрачным файл беком и проигрывать своем видео плееры здесь данный алгоритм чуть более подробно расписан технология на данный момент достаточно хорошо отлажена она у нас уже в продакшене активно используется как уже было сказано 70 процентов экономится от отданного трафика слайд уже чуть-чуть устарел тут сказано что в пике of law достигал 80 семье гигабит на самом деле в прошедшие выходные было уже 363 технология от очень хорошо подходит для live stream of но и для video on demand она на самом деле тоже довольно хорошо подходит если у нас есть 23 одновременных зрителя на какой-то stream то с этого момента у нас уже есть 50 процентов рода дальше больше но вот уже двадцать три одновременных просмотра нам позволяют экономить 50 процентов трафика было произведено тестирование качества качество обслуживания счастью качество обслуживания улучшается буферизация уменьшается на 20 процентов чуть-чуть увеличивается битрейт с которым пользователь скачивает видео и опять-таки чуть-чуть увеличивается то время которое пользователь просматривает video stream то есть от данной технологии в нашем случае одни плюсы расходы уменьшается качество обслуживания улучшается для пользователя это вообще прозрачно просто он получает лучшее качество на данный момент технология работает на 80 90 процентов пользовательского устройств поддержанное практически все доступные браузеры chrome firefox opera индекс safaris 11 версии работает с сентября microsoft edge также поддержан мобильные устройства chrome на андроиде поддержан ближайшее время будет поддержана safaris на один сами оси на самом деле там уже работает идут просто последнее от лапки на мобильных устройствах также поддержана sdk для встраивания в приложении на мобильных устройствах android и ios sdk работают с приставками и телевидением чуть чуть хуже ситуация android tv работает apple tv будет поддержана в четвертом квартале есть проблема со smarttv но со smarttv обещают разобраться это в планах на будущее опять так обед обещает улучшить совместимость приставками улучшить алгоритмы по выбору первых и еще увели улучшить качество предоставления сервиса со всеми вот этими трюками у нас суммарный трафик уже достигает 1 то рабита и даже немножко больше серая часть на данном графике это доля appear to pure трафика как видите она более чем существенна особенно в пиках ссылки на сайт с вич марками ssd и на статью healing с детальным разбором производительности писяй экспресс слотов я готов ответить на ваши вопросы добрый день samsung 850 evo отличается от в первую очередь не скоростью а ресурсам как часто вы меняете диски судя по всему у вас бешеная записи достаточно умеренно меняем не могу сказать что это на данный момент какая-то проблема спасибо 2 в момент в 11 free bsd есть версии поддержка для tls на уровне ядра а вы что-нибудь оптимизировали там или нет насколько мне известно в май лай нее и нету это приватный face починит флекса который они в мы онлайн не отдавали здрасте спасибо за доклад а вопрос такой вы говорили об у верхотина транспортный протокол а вы не пробовали будут бороться с именно с этим оверхендом или это не разработчики железа это транспортный протокол писяй экспресса то есть с ним никак тюнингом каким-то кручением ручек нельзя бороться до но вы можете выкинуть лишнее устройство из пися экспресс хаба чтобы можно было сконфигурировать там не 256 байт на посылку а скажем 512 и 1024 но в нашем случае это не возможно у нас там еще и другие сетевой карты стоят подскажите как вы собираете статистику здесь статистику отдачи engine so are still оге или null отправляете стату по завершении в хуки собирает статистику и дальше по углу с хуком контент и и забирает уже сборщик статистики и еще вопрос а как организуется балансировка unicast блокировка организуется балансиром вот вот на схеме у пользователя обращается к медиа менеджер а он же балансер и он этот медиа менеджер отдает ему уже информацию о том на какой ешь следует обратиться ясно спасибо спасибо за год планируется ли у вас начала работы с multicast онлайн стримы каким-то то есть это право телевидением который заливается там с со спутников я еще как-нибудь раз кодированием в лайве и отдачей контента пользователям multicast me to life это наша ближайшая цель спасибо здравствуйте меня зовут евгений спасибо за доклад у меня два вопроса чем обусловлена выбор операционной системы freebsd сиди и второй вопрос сейчас в последнем в ядре linux 413 facebook вместе с откатом активно запиливаю обработку с соединений в ядре будете ли вы пробовать какие-то проводить тесты если дату где можно будет посмотреть результаты вашего тестирования очень интересно было бы это увидеть выбор free бийские очередь и а обусловлено случаем я в проект пришел не на самой ранней стадии через где-то три месяца по всего начала но free везде является достаточно качественная операционная система с хорошим сетевым стеком и им планирующие мне культуры разработке также я очень хорошо разбираюсь в собственно говоря freebie езде в том как и тюните отлаживать и так далее по второму вопросу скорее всего нет я смотрела краем глаза аналогичные работы touch и отчеты netflix а в принципе netflix омском случае это не дает каких-то существенных выигрышей добавок случае нет случае linux я еще не смотрел я не помню тесак доклады по моему уже были на этой конференции но я смотрел другие и собираюсь их посмотреть уже в записи в случае netflix а это требовало еще применение пары технологий которые нам не подходят по стальному в ядре в пользовательском процессе с или в общем все равно потребляет существенную часть процесса времени с о спасибо большое здравствуйте я в доме нам здесь не большое спасибо за доклад очень интересный кейс подскажите пожалуйста какие непосредственно оптимизации и настройки для в рамках этого кейса вы использовали как для самой бы без да да там те же ядерные параметры так и например дзт фазу которые то что песок параметров и много чего можно подергать вопрос хороший я 2 года назад майя тоже конференцию делал доклад это понимаю сейчас его можно найти и в записи и там как раз более подробно по это рассказано в принципе чтобы нет и мотивы у стальных время я могу в перерыве рассказать да я подойду спасибо спасибо за доклад вы на следующем слайде показывали схему дачи live traffic или также это включает и статику а именно из памяти у нас на данный момент life не раздается все из памяти статика все спасибо life у нас еще только в планах но ближайших добрый день подскажите насколько я понял у вас 2 соки тные сервера и в этом случае сетевая будет на пися экспрессии одного из процессоров и если у вас проблемы с перекосом нагрузки на них из shinee копия между ними нет таких проблем у нас нету я про это подозреваю знаю слежу но проблем нету я не знаю как посмотрите нормально счетчики но вот пока мы укладываемся в нужные нам бюджет и все хорошо слов скажи пожалуйста вот в связи с тем что у вас нагрузка здорово возросла с с элем вы не рассматривали но другие аппаратные платформы то есть но другие процессоры грубо говоря вообще другие мы провели на коленочки расчет стоимость процессоров растет ну не знаю будем говорить x потенциально нет имеется ввиду не rental скую архитектура вообще архитектуру сменить то есть взять например обе омские процессе там они стоят как паровоз то нет полон совмещено примерно такие же цифры на круг будет провоз у нас используется supermicro русские сервера коробка меняется на ибее мужское тоже согласен согласен мы используем вот если вы посмотрите этот процессор стоит которым мы используем 1200 что ли в розницу я не думаю что объем будет последний эти power 8 power 9 они такие не очень дорогие какая у них производительность не знаю точно сейчас но там не маленькая весьма надо отдельно исследовать но вы вряд ли все же это уже отлажена и решение ну согласен да насколько активно вы переписывались разработчиками сетевых карт и сколько времени у вас заняло исправлю вернее у них заняло исправление этих багов где то 2 3 месяца переписка ну написали ответили написали ответили один из разработчиков собственного соловский он собственно в питере проживает спасибо здравствуйте вот вы показали картинку что у вас на сервере находится там кэш-памяти кэш на ssd cache на жестком диске обычно каков процент эффективности этой этой система каширования сколько вы забираете из основала хранилище сколько дисков с память о треть из памяти примерно в зависимости от сервера и контента который там находится где-то 60 70 процентов из едва арка то есть где-то 70 80 процентов то есть суммарно в районе 70 процентов становимся забирайте сторож да где то так так и второй вопрос вы показывали что вас 700 терабайт данных как овцы рипли конечно фактор ну смотря как считать по маркетингу или по чистому давайте по маркетинговым не зная тогда 2 честного 1 то есть да ну вот записи в мир да хорошо и тогда с этим тоже вопрос вот вы раздаете файлы в душе вы чавес и видим там еще им по 4 умеете у вас каждый из этих форматов он отдельным файлом храниться до и на каждый петрий тоже отдельно а сколько вас битрейтов точно сказать не могу потому что just на горя все равно на это делаю я видел 4 если звуковая дорожка отдельно это опять их отдельный файл понял спасибо еще один вопрос скажите а как вы резервируйте отказоустойчивость дисков то есть районе рейд зеркала и а вот на картинке is it offers мира остались ли еще вопросы вы сказали что у вас где-то многие плита байт трафика а сколько у вас и джей потому что на игры лежит ну так навскидку несколько терабайтов где-то должно хранить жать всех all остальное в холодном каши все на ушах лишит а сколько их тогда примерный порядок 25 спасибо за внимание спасибо большое часов за доклад"
}