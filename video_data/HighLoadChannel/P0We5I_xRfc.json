{
  "video_id": "P0We5I_xRfc",
  "channel": "HighLoadChannel",
  "title": "Что делать, когда у вас 100 партнеров / Иван Потапов (Lamoda)",
  "views": 726,
  "duration": 2117,
  "published": "2018-01-16T13:43:01-08:00",
  "text": "и первый докладчик на сегодня у нас это иван потапов 1 раз на отлично всем привет сегодня хочу обсудить с вами проблему с которой так или иначе сталкивался каждый фонтан разработчик а именно подключение партнерского или стороннего кода на сайт и почему эта проблема именно близко-близко именно мне как разработчику в моде и и вот почему почему ежемесячно на наш сайт заходят 11 миллионов уникальных пользователей и каждый из этих пользователей очень ценен для нас каждый из них разумеется может стать перспективе нашим покупателям и поэтому нам жизни необходимо знать что хотят эти все пользователя что нужно предлагать им а максим максимально полезные сервисы для каждого из них и для этого всего нашим сталь сайте спориться более более 100 различных сторонних скриптов для чего не нужны прессе они нужны для просчета какой-либо статистике аналитики что кому нравится кроме того на основании того чего что хотят пользователи мы строим наши рекомендации персональные скидки у нас есть собственно баннерная система и многое другое и даже если вы один раз зашли на сайт la моды когда вы уйдете с него наши баннер будет преследовать вас абсолютно везде то есть это сто процентов и почему так так их много еще спрашивает почему си не делайте сами разрабатывать подобные системы это всегда очень дорого долго и безумно сложно у нас есть конечно маленькая командой ранди но она не справляется с тем всем сама и все эти скрипты и выполняет около 70 запросов к партнерским сервисом на каждой странице и кажется на самом деле что все счастливы то есть нам пришла задачка взяли закупить постели код вставили себе куда-то в шаблончик прям и и все готовы быстро там задачка на 10 минут до пользователем вроде как удобно у них там все самое эффективное там самый последний мой подняв взяли тому поменяли скрипт 1 партнер на другого если нам не понравился capcom production ну как понимать на самом деле все не так просто и подобный подход порождает ряд проблем первое это бардак в коде то есть как то обычно выглядит у вас есть несколько шаблонов один подсоединяется входят другой в базе вы туда capacity вот эти куски java скрипта а эндо дублируются потом у нас какой-то момент продаж начинает тормозить что-то отваливается и каждое добавление такого скрипта это риск сломать вообще все потому что иногда бывает такая ситуация что скрыть работает только в продакшене то есть диплом такую бомбу что произойдет в итоге вообще непонятно и мы решили для себя ответить на это вопросов как быть с этим сторонним входом 1 когда его стоит загружать исполнять и вообще что этот код может делать куда может лазить как-то можно контролировать какие забора построить кроме того как сделать так чтоб всем этим кодом было удобно управлять чтобы мы могли как-то вот продакшене посмотреть по человечески были всякие разные идеи там что-то в какие-то свои велосипеда написать ее кроме того как это интегрировать с кодом сайта так чтобы нам было максимально удобно чтобы наша собственная cost кодовая база не засорялась там каким-то сторонний мусором и я мы начали самого главного ну сама начала вернее я ждал такой популярный пример google аналитика даму у кого есть на сайте она на ну почти практически всех ну вот открываем документацию читаем вставьте код перед всем жесткой в том css ом при мхат ну вроде здорово атрибута sender стоит ну по аналогии делают практически все сторонние скрипты образец вроде хороший но решили копать дальше почему так станем теорию обычный скриптер src происходит ешьте мой парсинг как только появляется включение этого скрипта парсер останавливается происходит загрузка скрипта скрипт исполняется ешьте мой праздник продолжается ну в общем для стороннего кол так вот эта штука точно не нужна скрипта сил который пользуется гуглом и многими другими ситуация намного лучше потому что загрузка происходит фоне но опять же нам непонятно когда этот скрипт будет исполняться мы не понимаем вообще когда он будет исполняться и когда эта бомба взорвётся то есть если в хоть напихать их целый куча то вообще не помню что будет и скрип de fer уже лучше и без подозрения что это то что нам нужно загрузка происходит фоне сами скрипты исполняются после дом can't live и после того как мы провели это исследование что-то как-то не поверила что она так то есть может начать не понимаем оказалось что не мы одни озадачились это проблемы и вот в этой статейки потом совета очень посчитать эти государства он исследовал как раз производительность различных просто скриптов там диффе расинг сравнивал и там он смог показать что после того как instagram избавился от скрипта осинка входи они выиграли нашей секунды загрузки страниц и как только мы начали сравнивать differ и а sing мы для сравнения взяли самую сложную страницу страницу нашего каталога где абсолютно очень много различных фотографий много java скрипта постоянно что-то обсчитывается есть прилипающее элементы очень куча всего и решили по профилировать это графики загрузки цпу именно жара скриптом html css там более-менее все предсказуемо и одинаковые не так сильно влияет 10 в ситуацию намного выражений то есть видим что мы выиграли целую секунду просто из-за того что поменяли атрибуту тегов но наши изыскания на самом деле продолжились и как казалось пост после эфира особенно на слабых машинах мы видели вот этот вроде бы маленький незначительный пик который наверное может быть даже никак не должен повлиять на отрисовку но влиял тормозило будь здоров надо было что-то делать и нужно был какой-то события который бы нам помогло мы долго искали взяли и попробовали винду он лот и что удивительно взлетела вот заработало как надо то есть мы получили там еще добивались интерфейс работы даже на 5 10 раз мы замедляли стандартного ноутбука скоро режиме троттлинга в общем все зашибись было и что итоге мы делали там мы действительно меж и время загрузки страницы пользователи уже могут с ней взаимодействовать даже когда вас к java script код еще 2 не не загрузился то есть мы впереди и но стало действительно стать стала жить намного лучше но мы до сих пор не понимали что нас вообще в продакшене что там за бомбы живет и решили разобраться решили разбираться и же жили понять что вообще загружаем что этот код может делать что может не делать и что это вообще и первый раз чего мы начали мы создали документик который мы сейчас даем всем нашим партнёрам в котором мы описываем какие данные могут куда собираться куда отправляться и так далее но этот пункт что уже сейчас здорово мы можем контролировать можем контролировать через content security policy это механизм обеспечение безопасности которые был придуман для защиты от xss атак то защита от атак спортсмены контента и вот как он работает вы на страница в заголовках можете прописать прописываете контактике люди полисе и описывайте правила по умолчанию сам этот механизм работает так все что не разрешено все запрещено то есть по молчанию блокируются онлайн java script вал java скрипте и вообще любая загрузка любой сыр еще ресурсов и вот какие директиву существуют content security policy дефолта сердце позволяет загружать ресурсов с того же домена что его что его страниц находится скрипта сердце то есть вот мы указали какую-то регулярку под домена со всех поддоменов можем загружать вот такой скрипт сердце говорю что можно испорить понятен line онлайновый java script и вот эта штука очень интересная это report ури как только политика нарушается браузер сам отправляет json на определенный url с форматом ошибки для экспериментов можете себя использовать content security policy report a ли эта штука не прерывает запросы к сторонним ресурсам она только отправляет само сообщение сам report вот пример леопард а то есть видим документа реферера то есть откуда пришли заблокированный руку до произошло обращение директива к которой его запретила и вот параметр с нижней диспозиция он как раз отвечает что-либо режим report а когда мы просто не стали блокировать запрос либо может быть значение nforce когда запрос заблокирован мы сейчас находится в таком состоянии что очень хотим внедрить у себя эту штуку но есть 2 проблемы первое непонятно как оперативно тепло и тех же потому что нас этих партнеров очень много и 2 что заголовки будут очень длинная в общем итак следующее следующее ограничение которые мы стали описывать нашем документе это ограничение на размер кода и время ответа партнерских сервисов и эту штуку что удивительно совсем недавно стало возможно тоже контролировать контролирует стала возможности serviceworker наверно многие сейчас читали уже в последнее время стали популярны статьи про offline first про и про все такое там именно как раз таки средств worker герой этих статей то есть всем сколько это отдельный поток который работает отдельно от страница не было ни блокирующий и как раз таки сейчас уже есть наработки чтобы всю аналитику вообще держать там полностью но для себя пока мы решили что мы будем использовать serviceworker как программируя сетевой прокси что это значит это значит что serviceworker штука очень мощный крутая нам может прихватывать абсолютно все запросы которые у вас происходит на страницу и она работает только почтить и без у краски из за этого и что еще интересно она внутри себя использует фичи 5 и вот с этим фичи 5 как раз сейчас токов фаерфоксе печек нормально реализован это в тестовом сборках чтобы можно было нормально запроса прерывать однако уже сейчас можно через serviceworker разумеется читать вину запроса ограничивать как-то по времени то есть уже какие-то данные собирать и следующее требование которое у нас сама човид самоочевидно мы согласовываем именно в коде то есть имеется ввиду что мы согласованными на классов название глобальных java script переменных если они есть ключи local storage cookies ну даже для формально спрашивает о взаимодействии с микро с микрофоном там с камерой и так далее ну обычно все это под запретом нормально причин и после всего этого мы действительно стали понимать что наш код работает и быстро и вроде мы разобрались в партнерском коде но до сих пор у нас был бардак то есть надо что то делать и решение оказалось рядом и пришло от туда откуда мы совсем не ожидали вообще из отдела маркетинга оказывается они уже там давно тот момент тестировали и даже хотели использовать один из таких сервисов для организации скриптов как назвал или их называть надо диспетчерами тегов пример примерами может быть inside анти allium и google так ножи который мы используем использован ну на том что он бесплатен единственный из них и вообще что это за сервис и зачем они нужны и что они делают начну в краткой словарика с терминологии во-первых так в терминах этого сервиса и так раз-таки тот кусочек стороннего джаваскрипт кода то есть в этом сервисе существует специальная админка куда вы вставляете причем что интересно сервис может вырезать документ в рай то падме подменяет их на на синхронную и вызова кроме того используется так называемый контейнер контейнер это загрузчик тегов то есть как только вы добавили несколько скриптов через вашу админ очку после этого вы нажимаете опубликовать и публикуется контейнер то есть эта сборка но контейнер нет не собирает внутри себя он просто занимается тем что вызывает каждый из этих скриптов в зависимости от отправила ну правило это условия проката восполняется так обычно это событие в интерфейсе которую на котором могут накладываться различные ограничение например этот стек может полагаться только на определенной страницы либо там даже можно на какую-либо переменную посмотреть какое значение имеет и возникает вопрос как вся вот эта штука может общаться с самим сайтом там со страницей опять же все принципе дольки сделано просто то есть у нас появится до taller tr это как и называет уровень данных или что нам разработчикам принципе проще поэтому это обычно сжал скрытого массив который вы создаете сами и в тот случай в тот момент когда у вас происходит какое-либо событие в интерфейсе вы делаете добавление в этот массив после чего уже сервис самостоятельно разбирает все эти ивенты и вызывают соответствующие теги о чем в итоге добились там мы смогли обновлять вот этих скриптов сторонних без релизов сайта на минуту деплоить кроме того у нас есть предпросмотр изменений все они представляют посмотреть как тот или иной squid ведет себя в продакшене и что еще нам очень понравилось это все штук у нас поддерживают не разработчики нас поддерживает сами маркетологи и сами описывают правило даже мы их немножко на джейсен учили писать но все разумеется эту штуку мы контролируем сами каждый диплом контейнера осуществляется под контролем java script разработчика который советуют исправляет контролирует этот процесс стал действительно лучше жить но весь наш код стал пора стать постоянной вызове вызовы мы вид вида dvr push и данные для всей этой аналитики который ставил все больше и больше собираюсь вообще из разных мест где то не догадывались брендом где-то они выбирались из html прям где-то еще как то в общем полный бардак опять же и нужно было что-то с этим делать начали с того что сделали appy appy сделали вообще очень по простому у нас обычные поставки скрипта прям онлайновые в шаблонах со всей информации по тому или иному метод в пиаре то есть после после чего этапе мы вообще открыли даже наружу то есть глобальную переменную можно было посмотреть что куда и тут мы опять даже за ленились как на какой-то момент мы вообще по договорились с нашими маркетологами что давайте мы вот у нас есть api вы сами там через вашу google tag manager lad ладить и в него мы будем только именно его поцеловать ну продолжалось это где-то полгода и потом они к нам пришли и сказали что не ребята ноги лайки очень много тяжело давайте вы у себя все таки не взлетела и после этого мы подумали и код нас принципе обычный сайт не сингл пэйдж и просто во все в вместо data layer пусть мы и решили использовать глобальный шину события обычно то есть глобальный фонд и метр в воланда и вас к темп например это одно из глобальных событий которые происходят на всем сайте то есть у нас есть список констант которые так или иначе могут происходить в интерфейсе лэнс и как только какое-либо глобальное событие происходит одним из его подписчиков является модуль нашей статистике который разгребает оттуда нужные данные их как-то преобразуют так так как от нет необходимо и опять же все заканчивается тоже то же самые операции товар push что можно всего это сделать вывод вывода какие то есть всего осторожностью относитесь ко всему тому что к вам приходит когда вы это добавляете куда-то вставляете старайтесь еще поизучать хорошенько все что приходит и жить в итоге стать намного лучше что касается сторонних сервисов стараюсь расширять свой кругозор как ты интересуетесь что у кого есть надорваться сразу сделать изобретать какие-то велосипеды возможно тот за вас уже давно это сделалось с этим на перфоманс а то я привел такой пример самый наверно простой явный я считаю что если вы хотите заниматься оптимизацией своего сайта то вы должны заняться именно вот с того что разобраться что вы загружаете куда-куда загружаете они сразу там рваться там подвигает оптимизировать какую-то фигню которую он 50 секунд даст всем спасибо ответь на вопрос у кого есть вопросы можете задать по подойдет добрый день он спасибо большое за доклад вопрос по поводу gtm да вы сказали вначале что в правилах аналитики написано что его нужно грузить до того head это так и есть на самом деле новым правилам ведь тоже самое у них такие же собственные условия решили это прям работает без проблем мы в windows с именем data- же сам тема работает но в windows год сразу это вот наша у нас-то завелось может вас не завестись может быть зефир подойдет потому что этот надо мерить и у меня вопрос производительность а про то что не теряем ли мы какие-то занятии вы вы можете заранее со быть напихать data layer а потом ему скормите он их разберет уже сможете заранее создать массив чтобы что интересует этот брак седан lada да да да да да ну чего ранее добрый день я хотел спросить успели сказать что проводите review кода который и шва штаты талаги да но review это конечно здорово но не полный как бы процесс разработки наверняка когда ламода непосредственного оказывается ваш код вы его еще тестируйте ну смотрите зубы можно вопрос как как вы относитесь водка кодовым написанному маркетологу в этом в этом плане проводите ли вы тестирование и глаз у нас есть притом уме как описал есть предпросмотра всех этих системах то есть там просто ставится кука определенная и можно рассылкам угодно расшарить и ты можешь посмотреть что там творится то есть на этом уровне да я понимаю что технически есть такая как это организационно устроено так скажем они проходят также задачами как этой вашу основную систему нет у нас все попроще сделал нас просто обычный в скайпе чатик есть они напишут опубликуйте контейнер вот кто цель стала жесткой от разработчика кто-то из них смотрят что они написали что сделали там дает к свои комментарии либо сам исправляет и сам публикуют вот и предпросмотр включаете даже то есть никакой магии спасибо за доклад наедине зовут хотел бы вопрос задать а вот когда сторонником загружайте быть может что-то разломаться вы как прокликивайте получается ключевые разделы сайтов автотесты какие то есть еще чтобы можно познать есть автор на автомате проверять что страниц произошел какой-то эксперт у которого раньше не было на нашествии обычно не запускаются уже как-то они отдельно то есть мы их то есть маркетологи могут выложить такой проект а вот мы запустим но у нас кроме всего прочего всю эту штуку обычно если она реально к это взрывная мы вообще в бета-тестировании обернем системы тестирования мы покажем там на какой то маленький процент пользователей посмотрим какие у них ошибки если надо их соберем так понятно то есть вот еще повод этим заголовком которые content security policy как курсы поддержка браузеров по-моему ей 10 или 9 выше то есть хлеб фокусов отчет все хорошо все отлично да то есть за счет может 3 последнего сброса вот вы говорите тому а скоттом требования все там то есть партнером к чтобы там кении глобальные перемены в этот код еще делать какой-то там review то есть вот обрезают шкодник потому что не могут ошибиться собрать я не знаю там когда да мы изучаем и вот спасибо хороший вопрос у нас есть на самом деле боль одна нас есть одни ребяток с которыми нужно навоюем у них там здоровенный куски кода вы валя и не нам очень нужны итоге мы воевали воевали сейчас еще собираемся есть свой сервис писать потому что потому что они не соглашаются наш условия и как только они включают свою штуку у нас центром она начинается на новый год а сторона ли сделать пытаясь смогла да да разумеется фото любви руки как раз таки да с валом что еще проблему что там все эксепшен которую них падает но и даже собрать не можем мы не поймать что там происходит вот спасибо спасибо здравствуйте спасибо за доклад вот вы показывали графики потом контент loaded да и сказали что на каких-то типах медленных клиентов у вас там медленная загрузка точнее медленная генерация происходило как бы поняли что это медленные клиенты как вы это исследовали как вы воспроизводили воспроизводили мы по простому то есть и есть frame можете замедлить произвести циpкa просто а именно заметили у нас есть mentoring не время то есть мы там можем отфильтровать кто откуда пришел принципе нет ну кто откуда пришел устройства например а то есть речь идет о мобильном устройстве нибудь стараюсь например мы смотрим какой нибудь но у нас это не знаю хорошо смотреть на примерку and android планшет то есть мы на нем показываем полноценную версию и там что-то плохо макси максимально то есть большинстве своем речь идет о медленных клиентах отдельных ли ну да да да все носим себя понял спасибо большое вот говорит что вас банеры везде показывается ваши потом вы fingerprint индикацию полете делайте или только ретаргетинг только ретаргетинг носит примат не до такой степени следите за пользователями мы начать fingerprint а пока там есть еще пока сам не разбирался нужны гипотетический или морально нет есть просто драться со стороны менеджмента же там есть к индийским движение что такое хотят но пока еще мы за не получали еще не обсуждали то есть открыться что-то слышь мотором у кого хотите внедрить его ну возможно это будет еще у меня вот такой вопрос я вначале в самом первом слайде видел цифру 70 получается 70 скриптов для запросов запросов а сколько партнеров у вас но смысл от сторонних скриптов всего сотня где-то но они разбросаны по всем страницам среднем на 1 страницу ходит нужно лишь штук 15 суток а вот эти все партнера не как типа как google analytics работать до в основном такие но кроме этого как я говорил там есть партнеру которые довольно дополнительный сервис то фигня собирает множко какое поведение пользователя на могут предсказать какой ему размер подойдет вот это мои под после кроме того у нас скоро будет мой поиск персонализированные например построить для него то есть лично подруг товаров еще каких-то сет основном такие вещи которые очень сложно разрабатывать как раз таки вот на их сторонним сервисом а то есть это какие-то специфичные сервисы короля не отслеживают допустим статистику по переходам то нет нет они она именно поведение анализируют именно на сайте то есть что он был в корзину что посмотрел вот этот тогда вот такой вопрос следующий неужели недостаточно там одного двух партнеров которые допустим 1 google analytics будет собирать статистику по переходам чтобы делать аналитику по сайту и допустим 1 который будет ну вот например отслеживать ну предлагать какие-то как вы сказали размеры то есть мне кажется здесь проблема больше не в у вас а менеджер вот маркетинга воде подбрасывает головное больно мы с ним воюем как можем потому что вот например у нас на проекте используется только google analytics и мы когда нам что там наш отдел маркетинга нам пытается подбросить мы больше радеем как разработчики как те кто пишет код больше родин за скорость то есть такие вот моменты и мне кажется здесь больше проблема вашего маркетингового отдела который не может построить просто к подходу еще немножко разные у нас ну давай потом поговорим о ружье спросила сюда еще один вопрос по поводу партнеров а почему вы решили что вот именно партнер представить вам на java script вы же можете ты кафтаны бэг-энде данные получить да там работать и уже через себя все это протащить это всё логику тяжелую пекину на клиенты там учитесь вот тут очень интересная ситуация выходит да мы перекидываем backend у нас из того что они нам дает мы опять же с этим экспериментируем раскатываем это там оба тестированию какой-то процент пользователя потом это не взлетает и за процессом постоянно пришлось партнеры сопоставляют просто скрипты проще работать потому что так просто целую цепочку тот разработки вести и в итоге она уходит в тупик этого 5 выпиливать сейчас понят спасибо добрый день спасибо за доклад скажите а вот про ваши java скрипта вояки получается час вся логика уже унесено именно вот сама обе и на google tag manager тогда что делает google tag manager пока он как раз и все лампы нам прописаны к именно правило то есть то есть там например на ваши события завязан до идеями виду провела там могут быть определенные url и какие то такие вещи которые мы даже сну себе себя держать не очень хорошо на самом деле там a matching но какой-то рига с какой-то на культуру ну как-то это а то есть получается вы когда подключаете код нового партнера соответственно они могут просить какие-то дополнительные параметры передавать которые не передаются да то есть это вы получается по цепочке api и сразу править аки ну да если этого api необходимо но сейчас а пьют уже давно не провели то есть все и все все есть а сестре это редкие доработки спасибо еще вопрос всем спасибо 704 так же если у вас"
}