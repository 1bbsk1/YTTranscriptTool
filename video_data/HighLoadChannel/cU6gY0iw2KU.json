{
  "video_id": "cU6gY0iw2KU",
  "channel": "HighLoadChannel",
  "title": "Фича — это объект! Сокращаем диффы, снижаем каплинг, продлеваем жизнь / Иван Лещёв (ВКонтакте)",
  "views": 319,
  "duration": 2022,
  "published": "2023-10-06T07:24:17-07:00",
  "text": "всем приятнее с вами вместе здесь пообщаться и вместе поразмышлять Меня зовут Иван и я по разработчик Я сижу на этой дряни уже 13 лет Хотя это наверное и мне это нравится Хотя это наверное для другого собрания вот я в PHP Боярин Я был в PHP бою Я санитар философии то что я вам расскажу будет иметь претензию на некую целостность осмысленность но все равно мне за это ничего не будет еще я работаю в контакте и мои коллеги помогали мне оформлять эти слайды Итак за время своей работы за эти долгие годы я видел много плохого кода как и все вы наверное Я учился писать хороший код Я смотрел разные обучающие видео подписанные на разные чаты я задавал вопросы чатах я отвечал на вопросы в чатах Я даже купил книгу фаулера Черт побери и подписался на одноименный канал тарасак отель чистый кот ну плохого кода меньше не становилось Почему так Ведь этот код пишут не только не менее квалифицированные коллеги что Что мы делаем не так в общем этому нужно дать философское осмысление то есть и очевидные вещи они в общем-то очевидны кажется мы все еще не умеем писать хороший код Ну не всегда по крайней мере мы мы возможно мы не знаем даже иногда что именно будет хорошим кодом вот ну определенно что хороший кто-то неплохой код Ну это точно да все умеют строить отрицание Наверное нужно было более строгое равно поставить а если не трогать код то Плохой кот ну где-то он там работает даже приносит деньги и он все еще кажется хорошим Ну по крайней мере мы не оставляем себе они не строимся оценок оценочных К сожалению Но вот если его начинаем трогать то он бесит Бесит настолько что хочется убить убить коллегу человека которого давно уволили или про себя в прошлом просто прийти увидеть потому что поэтому писать Нужно код Так что вот чтобы вас не хотелось убить хотя бы знаете чтобы вы спали спокойно Собственно как это все как это получается что именно бесит вот не самая сложная фича Да вот не самый сложный случай наверное не самый плохой но это уже маленький шаги не туда в общем-то вот мы сделали небольшую фичу там небольшой кусочек маленький кусочек маленькой фичи вот мы чуть-чуть доделали вот такой получается коммита вот мы сделали ещё другую фичу и вот мы хоп наш коллега пришел и мы получаем такими такие конфликты Почему как так получилось при этом знаете если у вас компания размеров ВКонтакте или чуть-чуть поменьше Да это может быть тяжелый день мастер закрыли Вы долго собрали опробы и в понедельник вы видите вот такой вот и вам сразу срочно нужно там тяжелой головой опять бегать по личкам выпрашивать чтобы вам заправили ваш код А если это еще и большой там несколько прозеров которые очень сильно заняты Это история Может еще на два дня а за эти два дня нужно опять не попасть в эту же в эту же историю собственно и этот И даже это вот как не самый плохой случай Да вот мы хотя бы видимо конфликты да Потому что если мы не видим конфликты мы можем поймать их на этапе отправки на staging хотя бы если вы же у вас есть Инга вот за дублировали ли Уют или потеряли легко Я видел оба случая прямо почему потому что вместе работаем в одном файле а вот плохой код но его нельзя показывать вот слышала безопасности подменила слайд ну выглядит он скорее всего примерно так я думаю Вот такая схема Да вот когда непонятно что Откуда начинается где кого кто вызывает вещи вот как бы они одного цвета потому что значит одинаково Ну последовательность Нет вообще то есть к чему это приводит Представьте B2B Аспект и продукт Да как какой-нибудь или часть просто которая относится к B2B То есть это про деньги всегда про деньги и вот какой-то код обрабатывает какой-то кусочек Да валидация мы получили данные мы что-то там извлекли отвалидировали мы еще получили данные и опять отвалили Мы потом опять что-то получаем валидируем мы складываем статистический кэш Мы достаем из статического конечно что-то там Непонятно происходит сохраняется инициализация какая-то происходит не явно а потом вам говорят что надо чуть-чуть что-то поменять и вот в этом случае что-то поменять означает поездку на по горячему полю на велосипеде без руля и без колес вы там упадете и сгорите обязательно в чем проблема основная что проблема даже небольшие плохой код это когда даже небольшие правки требуют больших изменений изменений во многих файлах изменениях многих директориях получается непонятно структура получается конфликт слияния это все сложно понимать это сложно исправлять это даже сложно удалять удалить фичу которая срок жизни которая закончился вы будете Потом ходить а годами наверное по коду и находить непонятные вещи артефакты от предыдущего Почему Потому что так получилось Да вынести микросервис Ну тут тоже это невозможно то есть Ну а как же тогда делать хороший Код Да как запомните это человек ждет стоит у вас за спиной Возможно вы все слышали Это слово да может даже отвечали у нас собеседовании солят солит в принципе означает в там Пять букв да Ну на самом деле назначает в целиком вот декомпозицию сохранения единой ответственности единственное ответственность открыто закрытость это декомпозиция Потому что если у вас код не достаточно декомпозирован его нельзя его нельзя расширить не влезая в Исходный код потому что не был правильно декомпозирован Да в принципе это сохранение ответственности Наследник всегда должен сохранять ответственность родителя и ни в коем случае ее не ломать не только при этом не только на уровне языка Но и на уровне э-э логики действия логики то есть нельзя например сделать блогер который будет переключать лампочки в коридоре Хотя можно но делать этого нельзя маленький интерфейсы тоже принципе единая ответственности и внедрение зависимости это это тоже сохранение на ответственности потому что создание зависимости Это другая ответственность объекта Ну как бы сервис не должен понимать кто ему создает ответственность откуда они получают и все то есть солят мы должны писать чтобы избегать массы проблем да иди композировать получается то есть как бы везде композиция все понятно как бы что-то хотя бы что с композицией как в принципе к чему Мы должны прийти Вот данные Мы работаем с данными У нас есть код данные плюс код это как pineapple ну это объект получается вот а что такое объект Если вы погуглите до Упы какой-нибудь для чайников там будут такие объяснения которые я бы еще на этапе их написания просто отстрелил руку там там отрезал бы там Мачете отрубил Да потому что там бывает объяснение на уровне что полиморфизм это вот собачка мяучи это котик лает и это нормально и сейчас Вы обязательно найдете таких статей свежих в которых вот объясняется вот так вот ну это не так на самом деле реальный полиморфизм в наших реальных проектах когда мы вот тот же самый блогер просто заменяем логируем по-другому и в принципе вот этому бы неплохо было бы получить но учат не этом Так что же тогда объект Ну если открыть собственно оп Википедии Да там есть принципала на Kia Многие из них ну как бы если кто из них вообще вы их читали да Поднимите руки кто читал вот не все кто может все их произнести к тому 6 Нет ну вот я тоже наверное сейчас не скажу все но я скажу вот самый главный все есть объект А что все число массив кортежей массивов всё это тоже объект объекты общаются с сообщениями число с кем-то общается сообщениями вот настолько тяжело мне это было понять да Я размышлял Да может быть какие-то вырожденные случаи Да экземпляры классов принимают к себе вызовы методом отвечать на вызов метода это общение с сообщениями это так что ли Наверное не знаю потом в там есть про наследование что объекты наследуют поведение Ну это хотя бы понятно да от родительских классов есть то что объекта есть внутренняя память Ну логично Да с этим вопросом Нет а что есть такая вещь что у всех объектов в приложении единственное дерево наследование что Тем более что многие вообще считают что никакого наследования не нужно Ну там максимум от абстрактного класса это хорошая мысль что такое наследования не нужно Ну не надо ее доводить до абсурда Ну в общем-то то есть не все принципы вообще можно применить для того чтобы понять что такое объект но все-таки Давайте хоть пример А вот объектно-ориентированный код Но объективно разве это жизнь кота объективная нет здесь кота выглядит вот так вот то есть объектом скорее всего тогда будет являться вот это все это неразрывно связано все что окружает собственно объект тоже объект при этом объекте это объект в общем-то и собирая практики Да вот Анализируя хорошие практики про которые вы уже у других докладчиков слышали обязательно там может быть в прошлом году может быть на видео когда смотрели до если все это скомпондировать и применить сказать что все это объект то вот фича в общем-то это объект ребят На самом деле во-первых она по-любому попадает кванто всё потому что всё попадает всё во-вторых а-а это точно композиция данных кода никогда не денетесь вот этого да у неё есть Э да ещё фича общается вот фича общается сообщение по-настоящему Вот это вот железно а выдохнули то есть Если так подумать то хороший код был бы выглядел бы вот так вот да вместо вспоминайте вот этот график где все перепутано А вот у нас получается слой приложения и две фичи Вот они общаются внутри сообщениями друг друга вызывают Все нормально да Через если что-то нужно в фиче для Рогов и что-то сделать приложение можно это сделать в общем-то Ну и логичные выводы что группировка по фиче это в принципе законно абсолютно законно по слоям Нет по фиче Да а внутри фичи данные инкапсулированы вот securies это база вот мы не общаемся С сущностями мы общаемся сообщениями и сообщения там команды мы отправляем мы получаем статусы виде сообщения Да и мы уведомление отправляем для других вещей или для приложения или еще что-то делаем вот что происходит и и кажется знаете я послушал Дакар в общем-то она свечу Да где-то на слое когда мы сейчас я вернусь назад когда мы на слое приложения знаем то есть так Нет не получается Ладно неважно сюда вот у нас есть свое приложение которое в принципе знает Ладно он знает про фичи он знает контракты узнать то как они общаются и этот слой приложения Вполне логично может надеть на эти контракты из синтаксиса график комбинировать обращение в одну фичу а потом комментирует обращение за обогащение в другую фичу это получается прямо из коробки легко тогда когда вы сделали свой код сгруппировали относитесь к фича как К объекту а так капсуляция если у нас инкапсуляция внутри фичи да то доступ данные К данным внутри самой фичи он может уже быть проще то есть в сущности уже не нужно писать этот приват Да приватный тайтл и вот эти дурацкие сеттер и Гетеры зачем они нужны Это лишний код который в принципе вы кстати еще должны его затестировать по-хорошему да иначе у вас покрытие будет какие у вас У кого какие метрики там 70 процентов да Представьте что 70 процентов будет Вот из этого кода состоять разве этот показатель вообще что-либо будет значить после этого по-моему вообще ничего не будет значить поэтому публичное поле и фича обращается к внутри фичи мы Обращаемся к сущности к полям ее напрямую Да в этом есть спорный момент например когда мы должны проверить это поле но Подождите Давайте дальше механизм-пулятов пабликов получается нам не хватает потому что мы все-таки должны ограничить доступ к этому к этому полю в общем-то опять же доклад вчерашний с вашей Кирсанова про модулей Офигенная штука Я когда это у меня бы не было ответа что же делать но сейчас у меня ей появился ответ что делать надо Light решает все ваши задачи Вот в этом случае вот статистический анализаторы решают и все все становится значительно лучше обработка команд это по сути единственный способ должен быть обязан единственный быть единственным способом доступа нашей вечер Да и модуль в этом в общем-то поможет команды должны нужно обрабатывать Строго по сценарию чтобы четко определить разные ответственности по порядку Да не смешивая их и одна команда один обработчик тогда вы никогда не столкнётесь в коллизии со своей коллегой потому что э кстати э в тикетах тоже должна быть единая ответственность единственная ответственность один тикет один человек а один Аспект э ну один Аспект того что должно исправиться вот фича вот сейчас отсказка это должно быть и одна вещь не пересекайся с другими вещами а-а как же может это выглядеть Ну как-то вот так вот то есть строгой строгость сценарий его проще код декомпозиция уже получилась лучше да как а проще ревью Ну проще обязательно нужно проверить что все эти пункты есть а или Пользуясь аспектами кстати отсылает вас яичко еще Одному докладу можно выделить что это аспекты вообще-то на самом деле были Вот видите вот это все это аспекты а Пользуясь аспектами подходом вынося аспекты в генерацию кода входа генераторы вынося аспекты в мессенджер в басс в стекле мы получаем код который просто что-то делает это прекрасно по-моему жизнь сообщения довольно проста сообщение мы его создаем из каких-то входных данных мы его никогда не меняем и мы его если это сообщение Мы отправляем на клиенту то мы с реализуем так черт возьми Давайте делать это вот так как оно есть в Конструктор передали параметры публичные и отдали в лесу кстати редонли абсолютно не важно на самом деле в каком на каком этапе языка на каком этапе ваш код написанный эти ритуал ли реализуют на самом деле если это может быть статический анализатор который проверяет что Вы на самом деле не Обращайтесь к этому полю даже если вы сами просто договорились с собой они обращаются к этим полям они останутся и жизненный цикл не изменится Вот Но все равно желательно Когда вы четко видите что то что вы хотите от того что вы будете писать явно записано вот паблик конструктор и все и преобразованный собственно На мой взгляд подход когда для этих целей используется серия лазер он странный сериал лазер тут тащит какие-то странные вещи Да знаете просто из коробки поставь сериал лазер окажется что поле которое я объявил Как camelcase превращается в Снейк Ничего себе То есть я делал минимальное движение Да и получил отлично Еще результат А тут приходит какой-то чужой пакет ломает не все и требует чтобы я полез в конфиге и его переисправил на все деньги улучшил блин улучшил работу в общем сообщение выглядит как-то так ну оснащение сообщения команда Вот наверное выглядит вот так вот то есть мы просто получили схода данные передали их в конструктор расширили идентификатором соответственно команда будет либо команда может быть не создана потому что у нас плохой Вот либо по валидации либо дойдет куда надо и все произойдет так как мы хотели В общем и того фичи это полноценные объекты цинкопсуляции и интерфейсами сценариями интерфейсы не в том смысле когда знаете класс у класса есть специальное слово implement какой-то интерфейс нет Интерфейс это то это обещанные взаимодействия фичи на самом деле общаются сообщениями и инкапсуляция сокрытие требует какого-то дополнительного средства Но мы сюда в этом нуждались в общем-то Так некоторые знаете зачем все это вообще может там спросить Да я вот хочу еще раз зайти философской точки зрения там провести книги анализ и доказать все-таки что это важно не просто следовать этим рекомендациям А понимать Почему мы хотим этого закон канвея кто-нибудь знает что это поднимите руку Кто знает что такое закон канвея А это хороший закон или плохой Он про хороший или про плохое Ну кто считает что это про хорошие законы сомнительно Да в общем закон канвея Он про то что организации в своем коде воспроизводят то как они общаются между отделами в реальности происходит когнитивная происходит зеркалирование какое-то поведение Почему Потому что это снижает когнитивную сложность а снижать когнитивную сложность это означает становится понятнее То есть когда мы не выполняем закон конвейя у нас получается вот такое видите разные вещи которые мы хотим думать про код в реальности наползают друг на друга становится перемешанными не выглядят так как мы хотели а когда Мы выполняем у каждого момента наша разработки для каждого ставки фичи или еще чего-нибудь у нас находится свое место в ней и у нас находится на или внутри кода в общем-то сейчас сценарий зафиксированы четко зафиксированный сценарий Который невозможно обойти сообщение сообщения аспекты и цикл разработки Что такое цикл разработки может быть кто-то скажет да спросит Ну в общем-то мы пишем тесты Надеюсь мы пишем тесты вот значит должен быть в принципе Тестируем код который я показывал Раньше он не тестируемый в принципе невозможно было выделить один одну бизнес правила от другого чтобы протестировать их отдельно невозможно было написать новая бизнес-правила не затронув всё это да и не свалиться куда-то там в эту самую в поездку на велосипеде а-а Поэтому если невозможно написать тест совершенно точно не композирован ну мы не меняем мы меняем или не меняем реализации Да вот поэтому знаете когда мы не меняем реализации иногда думаешь А зачем нам интерфейс Черт побери Ну мы когда мы внедряем где-то в зависимости по интерфейсу такие А почему зачем нам здесь интерфейс мы что будем менять реализации а внутри фичи когда цельная с хорошими связанностью внутри когда мы точно знаем что этот элемент этот сервис будет обращаться к этому под сервису и никуда дальше не пойдёт нам не нужен интерфейс Не всегда нужно интерфейсы потому что и интерфейсы Да будут вам поражать плюс один файл с дифом есть возможным к конфликтам мы собираем статистику Да и добавляем тесты вот это вот тоже мы делаем как размышления об этом нам помогут правильный код написать до готовность к этому Ну или хотя бы тот код который не будет бесить в процессе его модификации Давайте Опять какой-нибудь вроде как хороший сервис Да все нормально там три публичных метода один два из них фасада к первому Да и какая-то какой-то внутреннее вычисление полностью закрыта от всех нормально да сюда Нужно влезть что мы сделали не так если у нас реальная возможность сюда влезть мы уже нарушили принцип открытости закрытости нас наш код невозможно расширять Почему А при этом мы почему-то посчитали что нас наш кот был хорош Ну может все-таки будем использовать наследования по-моему сделать наследника Да в котором в котором бы будет реализовано исключительно Техническая часть новая ответственность не меняющая родителя было бы неплохой идеей ну наверное все поэтому всем хорошего кода Спите спокойно И пусть жизнь как вам не приходит относитесь к фиче как К объекту общайтесь сообщениями полноценно понимаете Какой ваш реальный жизненный цикл разработки для того чтобы не создавать лишних файлов или создавать их тогда когда они не нужны когда они нужны что Валентина отличные были твои замечания во время предпоследнего бизнеса Линча Когда нам нужно внедряться расширять код в каких-то пакетах нам обязательно нужны и интерфейсы и точка расширения Но когда у нас внутри фичи что-то происходит у нас все Прямо хорошо нам этого ну мы в этом уже не нуждаемся И если мы будем действовать так же как и дело а-а пакет для папки Вента мы просто генерируем лишних файлов и лишних потенциально лишних конфликтов ну всем спасибо задавайте вопросы Спасибо Иван напоминаю Да что мы оцениваем доклады по qr-коду А теперь давайте перейдем к вашим вопросам Иван Спасибо за бодрый доклад У меня два вопроса Первый ты так скольз сказал про это Ну хотелось бы слышать более конкретно Каковы измеряемые Ну Каковы есть измеряемые критерии того с помощью которых мы можем узнать краткосрочные среднесрочной перспективе что мы делаем декомпозицию на фиче правильно Это первый вопрос второй а что делать со сквозной функциональностью познав функциональность в виде аспектов Ну вот и скажи когда она фиксируется либо с помощью кодогенерации можно зафиксировать логирование например виде атрибута перед методом мы пишем что эта штука должна логировать и в моменты Да я сейчас могу отослать вас к метапу ростовскому который был в конце прошлого месяца выложено видео если поискать получается предлагал там эти вещи фиксируем мы фиксируем такие штуки в качестве атрибутов подключая сервис мы генерируем класс заместитель либо классный следник либо уже подмешиваем хода генерации один из способов еще способ в middless в шине сообщений Каким образом заранее Быть готовым к тому что будет в жизни фичи Напишите человеческим языком что будет происходить каждая буквально каждое слово фраза будет означать то что нужно сделать мы не знаем будущее если мы не знаем будущее мы не ну как бы мы любой подход любое планирование невозможно Почему статистика есть предсказания Теория вероятности если мы не знаем мы должны поговорить о фичеров в том виде в котором мое бизнес ддд и сама аргументация DD что мы должны называть бизнес-сущности в код их отражать Да и собственно процессы тоже там должны туда попадать мы сделали завтра приходит на менеджер говорит вот делаете вообще не то что нам нужно я даже не знаю как вообще на это ответить Ну блин ну как вы если мы делаем не то что мы как-то можем вообще посчитать это или понять про предсказание очень интересное у нас скоро будет анконференции Как раз там можно будет я дисплей про это похали варить про вот предсказание того что мы спроектировали фичу неправильно но найти или правильно или неправильно 50%, понятно Давайте следующий вопрос Так кстати зрители трансляции то что задавайте Спасибо за доклад мне вот это вот идея с обменом сообщениями и командами очень понравилось а как бы ты отнёс если бы мы пилили Монолит а внутри вместо Кафки использовали какую-то там свою внутреннюю шину данных вот прямо вот внутреннее не внешнее в самом монолите шина да Ну в принципе чтобы нет потому что то как выглядит стык миндалы да это только выглядит генерируемый Код Да например просто больше ходогенерации ребята вас все спасет Потому что когда мы занимаемся рефлексией в реально А в ранены означает что два варианта либо мы э упустили момент когда могли сгенерировать код который мы инстанцию сделать всё что нужно Либо мы пытаемся что-то что-то страшное захачить и соответственно Мы тоже не декомпозировали верно Мы неправильно учли наши э-э Ну открыть закрытость нашу То есть если ты вот мне кажется да Если ты хочешь Мне кажется Иван Извини пожалуйста ты какой-то другой вопрос отвечаешь ну тут скорее вопрос велосипед или внешняя Готовое решение но заходил готовые заложиться на этот нарезке велосипеда вот ответ будет Спасибо короче сам Ответишь когда так кто еще хочет спросить Давайте хотя бы поспорим про наследование не получится и финалы хочу спросить Так у нас вроде бы и в чате нет вопросов Почему так настаиваешь валидатор чем рефлексия пытаться все его правила вытащить Да но мы можем рефлексии вытащить правила все равно в компайл тайме Ну условно там симфония собирается Да вот именно потом уже проверили Я просто не очень понимаю ты имеешь в виду кодогенерации позволит нам что-то оптимизировать Ну да да Вполне некоторые вещи которые мы хотим опять же Да Если нам сложно э-э мыха там нам придётся лезть в рефлексию нам ещё какие-то штуки нужно сделать Да вот если нам это тяжело то можно генерировать э-э Ну понятно Ну да просто какой-то генерирование - это не то что я бы назвал лёгким программированием Потому что ты должен написать код который сгенерирует абстракт точнее абстрактно написать код который сгенерирует потом конкретно это не самая простая задача как правило Вот но О'кей э-э у кого-то ещё есть вопросы или мы выбираем лучшего автора вопроса Ну тогда вот вопрос про или правильно или неправильно 50% вероятности да да так хорошо тогда вот вручаем подарок а это это тебе Иван от конференции Всем спасибо всем спасибо Так ребят смотрите какой у нас план У нас сейчас идет будет анконференс его будет возглавлять Кирилл несмеянов на нем Мы будем обсуждать все что захочется можно похали варить можно ну главное чтобы до драки не доходило так в принципе любую тему Без проблем которая была на конференции которая наоборот не было вам так хотелось обсудить В принципе я так понимаю каждому будет Дана возможность высказаться так или иначе а еще у нас если я не ошибаюсь в 7 официально закрытие конференции в главном зале вот туда тоже обязательно Приходите и если анконференс прервётся закрытием можно потом будет вернуться вот так вот Кирилл мы прямо сейчас начинаем или чуть-чуть еще у нас какой-то перерыв будет Я просто сориентируюсь всех по расписанию я тут свою бумажку забыл Ну в общем Наверное минут через 10-20 где-нибудь подходить сюда"
}